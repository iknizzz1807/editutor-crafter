title: Agent Core State Machine
direction: right

classes: {
  state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.font-size: 16
  }
  final_state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.stroke-width: 4
    style.double-border: true
    style.font-color: "#e6edf3"
    style.font-size: 16
  }
  initial_marker: {
    shape: circle
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    label: ""
    width: 16
    height: 16
  }
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#8b949e"
    style.font-size: 14
  }
}

init: {
  class: initial_marker
}

IDLE: {
  class: state
  label: "IDLE"
}

PLANNING: {
  class: state
  label: "PLANNING"
}

EXECUTING_TASK: {
  class: state
  label: "EXECUTING_TASK"
  THINKING: {
    class: state
    label: "THINKING"
  }
  ACTING: {
    class: state
    label: "ACTING"
  }
  OBSERVING: {
    class: state
    label: "OBSERVING"
  }
}

REPLANNING: {
  class: state
  label: "REPLANNING"
}

FINISHED: {
  class: final_state
  label: "FINISHED"
}

init -> IDLE
IDLE -> PLANNING: "task_received" {class: transition}
PLANNING -> EXECUTING_TASK.THINKING: "plan_ready" {class: transition}

EXECUTING_TASK.THINKING -> EXECUTING_TASK.ACTING: "thought_complete" {class: transition}
EXECUTING_TASK.ACTING -> EXECUTING_TASK.OBSERVING: "action_complete" {class: transition}
EXECUTING_TASK.ACTING -> REPLANNING: "tool_error" {class: transition}
EXECUTING_TASK.OBSERVING -> EXECUTING_TASK.THINKING: "observation_complete" {class: transition}
EXECUTING_TASK.OBSERVING -> REPLANNING: "subtask_complete\n(requires replanning)" {class: transition}
EXECUTING_TASK.OBSERVING -> FINISHED: "task_complete\n(no more subtasks)" {class: transition}

REPLANNING -> PLANNING: "replan_ready" {class: transition}
REPLANNING -> IDLE: "replanning_failed" {class: transition}