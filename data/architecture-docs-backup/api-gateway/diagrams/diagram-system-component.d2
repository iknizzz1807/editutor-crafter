title: API Gateway System Component Diagram

# Define named styles for consistency
classes: {
  external: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    style.double-border: true
  }
  gateway_component: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  pipeline_flow: {
    style.stroke: "#3fb950"
    style.stroke-width: 2
  }
  data_flow: {
    style.stroke: "#8b949e"
    style.stroke-dash: 2
  }
}

# External entities
client: Client {
  class: external
  label: "Client (Mobile App / Browser)"
}

backend: Backend Services {
  class: external
  label: "Backend Services (User Profile, Orders, etc.)"
}

auth_server: Auth Server {
  class: external
  label: "Auth Server (JWT Validation)"
}

# API Gateway container
api_gateway: API Gateway {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.double-border: true
  style.font-color: "#e6edf3"

  # Gateway components
  auth_middleware: Auth Middleware {
    class: gateway_component
    label: "1. Auth Middleware\n- Validates JWT tokens\n- Checks permissions"
  }

  plugin_manager: Plugin Manager {
    class: gateway_component
    label: "4. Plugin Manager\n- Observability (logs/metrics)\n- Rate limiting\n- Caching"
  }

  router: Router {
    class: gateway_component
    label: "2. Router\n- Route matching\n- Load balancing\n- Service discovery"
  }

  transformer: Transformer {
    class: gateway_component
    label: "3. Transformer\n- Request/response modification\n- Protocol conversion\n- Data format transformation"
  }

  # Pipeline flow inside gateway
  auth_middleware -> router: "validated request" {
    class: pipeline_flow
    source-arrowhead: "filled triangle"
  }
  router -> transformer: "routed request" {
    class: pipeline_flow
    source-arrowhead: "filled triangle"
  }
  transformer -> backend: "transformed request" {
    class: pipeline_flow
    source-arrowhead: "filled triangle"
  }
  backend -> transformer: "backend response" {
    class: pipeline_flow
    source-arrowhead: "filled triangle"
    style.stroke-dash: 1
  }
  transformer -> plugin_manager: "response for processing" {
    class: pipeline_flow
    source-arrowhead: "filled triangle"
    style.stroke-dash: 1
  }
  plugin_manager -> client: "final response" {
    class: pipeline_flow
    source-arrowhead: "filled triangle"
    style.stroke-dash: 1
  }
}

# External connections
client -> api_gateway.auth_middleware: "HTTP request with JWT" {
  class: data_flow
  source-arrowhead: "filled triangle"
}

api_gateway.auth_middleware -> auth_server: "validate token" {
  class: data_flow
  source-arrowhead: "filled triangle"
  target-arrowhead: "filled diamond"
}

auth_server -> api_gateway.auth_middleware: "token validation result" {
  class: data_flow
  source-arrowhead: "filled diamond"
  target-arrowhead: "filled triangle"
  style.stroke-dash: 2
}

# Annotations for pipeline stages
pre_process: "Pre-Processing\n(Security & Validation)" {
  shape: text
  style.font-color: "#3fb950"
  style.bold: true
  near: top-center
}

core_process: "Core Processing\n(Routing & Forwarding)" {
  shape: text
  style.font-color: "#3fb950"
  style.bold: true
  near: center-right
}

post_process: "Post-Processing\n(Observability & Cleanup)" {
  shape: text
  style.font-color: "#3fb950"
  style.bold: true
  near: bottom-center
}

# Legend note
note: |md
  ## Request Processing Pipeline Flow
  1. **Pre-Processing**: Auth Middleware validates the request
  2. **Core Processing**: Router directs, Transformer modifies
  3. **Forwarding**: Transformed request sent to backend
  4. **Response Flow**: Back through pipeline (post-processing)
  5. **Post-Processing**: Plugin Manager adds observability
| {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  near: bottom-left
}