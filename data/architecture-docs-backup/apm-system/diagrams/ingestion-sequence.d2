shape: sequence_diagram

direction: down

title: {
  shape: text
  width: 600
  text: |md
    # Sequence: Trace Ingestion and Processing
    A sequence diagram showing the flow of a trace span through the APM system
  |
}

app: Application (via SDK) {
  class: participant_style
}
collector: Collector {
  class: participant_style
}
buffer: Buffer {
  class: participant_style
}
sampler: Sampler {
  class: participant_style
}
storage: Storage {
  class: participant_style
  shape: cylinder
}
trace_assembly: Trace Assembly Service {
  class: participant_style
}

app -> collector: 1. send span (HTTP/gRPC)
collector -> collector: 2. validate format and headers
collector -> buffer: 3. buffer span in memory queue
buffer -> sampler: 4. request sampling decision
sampler -> buffer: 5. return decision (sample/drop)
note: Sampling based on rate limits, trace importance, and configuration {
  shape: text
  width: 250
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  near: bottom-right
}
buffer -> storage: 6. write span to storage (if sampled)
storage -> buffer: 7. write acknowledgment
buffer -> trace_assembly: 8. notify new span available
trace_assembly -> trace_assembly: 9. assemble trace from related spans

classes: {
  participant_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}