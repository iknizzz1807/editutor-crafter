direction: right

title: APM System Component Diagram

classes: {
  container_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  component_style: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  highlight_path: {
    style.stroke: "#3fb950"
    style.stroke-width: 3
  }
  ingestion_path: {
    style.stroke: "#ffa657"
  }
  query_path: {
    style.stroke: "#58a6ff"
  }
}

application_env: Monitored Applications {
  class: container_style
  shape: rectangle
  
  service_a: "Service A" {
    class: component_style
  }
  service_b: "Service B" {
    class: component_style
  }
  service_c: "Service C" {
    class: component_style
  }
  
  service_a -> service_b: "HTTP call"
  service_b -> service_c: "RPC"
  
  note: "Instrumented with APM Agents" {
    shape: page
    class: component_style
  }
}

apm_backend: APM Backend System {
  class: container_style
  shape: rectangle
  
  collector: Collector {
    class: component_style
    note: |md
      - Receives spans from agents
      - Validates & batches data
      - Routes to storage
    | {
      shape: page
      class: component_style
    }
  }
  
  storage: Storage Layer {
    class: component_style
    span_store: "Span Store" {
      class: component_style
    }
    trace_index: "Trace Index" {
      class: component_style
    }
    service_map_store: "Service Map Store" {
      class: component_style
    }
  }
  
  query_service: Query Service {
    class: component_style
    note: |md
      - Handles trace queries
      - Generates service maps
      - Aggregates performance data
    | {
      shape: page
      class: component_style
    }
  }
  
  web_ui: Web UI {
    class: component_style
    note: |md
      - Visualize traces
      - Show service maps
      - Performance dashboards
    | {
      shape: page
      class: component_style
    }
  }
}

# Data flows - Span Ingestion Path
application_env.service_a.agent -> collector: "spans" {
  class: ingestion_path
  label: "1. Span Ingestion"
  style.stroke-dash: 2
}
application_env.service_b.agent -> collector: "spans" {
  class: ingestion_path
  style.stroke-dash: 2
}
application_env.service_c.agent -> collector: "spans" {
  class: ingestion_path
  style.stroke-dash: 2
}

collector -> storage.span_store: "store spans" {
  class: ingestion_path
}
collector -> storage.trace_index: "index trace IDs" {
  class: ingestion_path
}

# Data flows - Trace Query Path
web_ui -> query_service: "trace query request" {
  class: query_path
  label: "2. Trace Queries"
}
query_service -> storage.trace_index: "lookup trace IDs" {
  class: query_path
}
storage.trace_index -> query_service: "trace IDs" {
  class: query_path
}
query_service -> storage.span_store: "fetch spans" {
  class: query_path
}
storage.span_store -> query_service: "span data" {
  class: query_path
}
query_service -> web_ui: "trace visualization" {
  class: query_path
}

# Data flows - Service Map Updates
query_service -> storage.span_store: "read recent spans" {
  label: "3. Service Map Updates"
  class: highlight_path
}
storage.span_store -> query_service: "span relationships" {
  class: highlight_path
}
query_service -> storage.service_map_store: "update service map" {
  class: highlight_path
}
query_service -> web_ui: "service map data" {
  class: highlight_path
}
web_ui -> storage.service_map_store: "fetch service map" {
  class: highlight_path
}