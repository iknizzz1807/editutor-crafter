title: Worker Process State Machine
description: "States: Starting → Idle → Processing → ShuttingDown → Stopped. Include transitions for job assignment, completion, shutdown signal, and crash detection."

classes: {
  default_state: {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  terminal_state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.double-border: true
    style.font-color: "#e6edf3"
    style.bold: true
  }
  active_state: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

init: {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  label: ""
}

# States
Starting: Worker process starting up {
  class: active_state
  shape: rectangle
}

Idle: Waiting for jobs in queue {
  class: default_state
  shape: rectangle
}

Processing: Executing job handler {
  class: active_state
  shape: rectangle
}

ShuttingDown: Gracefully finishing current job {
  class: default_state
  shape: rectangle
}

Stopped: Process terminated {
  class: terminal_state
  shape: rectangle
}

# Transitions
init -> Starting: Process spawned
Starting -> Idle: "✓ Initialization complete"
Idle -> Processing: "Job assigned from queue"
Processing -> Idle: "✓ Job completed successfully"
Idle -> ShuttingDown: "Shutdown signal received"
Processing -> ShuttingDown: "Shutdown signal received (finish current job)"
ShuttingDown -> Stopped: "Cleanup complete"
Processing -> Stopped: "✗ Crash detected (timeout/exception)" {
  style.stroke: "#ff7b72"
  style.stroke-dash: 2
}

# System context note
note: |md
  **Worker Process Behavior:**
  - Monitors configured queues (email, reports, default)
  - Executes jobs concurrently up to concurrency limit
  - Reports liveness via heartbeat to Redis
  - Graceful shutdown: finishes current job before stopping
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}