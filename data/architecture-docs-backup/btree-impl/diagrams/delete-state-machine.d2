title: Node State During Deletion

init: {
  shape: circle
  style.fill: "#3fb950"
  label: ""
}

Underfull: Node Underfull (< t-1 keys) {
  style.fill: "#1a1a2e"
  style.stroke: "#f85149"
  style.font-color: "#e6edf3"
  style.bold: true
}

Valid: Node Valid (t-1 to 2t-1 keys) {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

Overfull: Node Overfull (> 2t-1 keys) {
  style.fill: "#1a1a2e"
  style.stroke: "#f0883e"
  style.font-color: "#e6edf3"
  style.bold: true
}

# Initial transition
init -> Valid: "B-tree initialization"

# Transitions from Valid state
Valid -> Underfull: "Direct key removal\n(when at minimum t-1 keys)"
Valid -> Valid: "Direct key removal\n(when above minimum)"
Valid -> Underfull: "Lend key to child\nvia borrow operation"
Valid -> Underfull: "Merge children\n(loses separator key)"

# Transitions from Underfull state
Underfull -> Valid: "Borrow from sibling\n(gains key from parent/sibling)"
Underfull -> Valid: "Merge with sibling\n(gains keys from sibling & parent)"
Underfull -> Underfull: "Propagate merge up\n(parent becomes underfull)" {
  style.stroke-dash: 3
}

# Transitions from Overfull state (error condition)
Overfull -> Valid: "Key removal\n(should not occur)"
Overfull -> Overfull: "No direct transition\n(invariant violation)" {
  style.stroke: "#f85149"
  style.stroke-dash: 3
}

# Context note
note: |md
  **State Machine Context:**
  - During B-tree deletion operations
  - Node degree: t (minimum children)
  - Key count determines state
  - Transitions triggered by:
    - Direct key removal
    - Borrow from sibling
    - Merge with sibling
  - Overfull state indicates bug
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  near: bottom-right
}

classes: {
  error_note: {
    style.fill: "#0f3460"
    style.stroke: "#f85149"
    style.font-color: "#f85149"
    style.italic: true
  }
}

Overfull.note: Should never occur in correct B-tree {
  class: error_note
}