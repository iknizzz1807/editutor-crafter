title: DNS Server System Components

# Styling for dark theme
*.style.fill: "#1a1a2e"
*.style.stroke: "#3fb950"
*.style.font-color: "#e6edf3"

# UDP Server - Entry point
udp_server: UDP Server {
  style.bold: true
  style.stroke: "#3fb950"
}

# Message Parser - Protocol handling
parser: Message Parser {
  decode: Decode DNS Packet
  validate: Validate Query
  decode -> validate
}

# Recursive Resolver - Core resolution logic
resolver: Recursive Resolver {
  query_engine: Query Engine
  state_tracker: State Tracker
  referral_handler: Referral Handler
  
  query_engine -> state_tracker: track query
  query_engine -> referral_handler: follow referrals
  referral_handler -> query_engine: next query
}

# Cache Manager - Performance optimization
cache: Cache Manager {
  shape: cylinder
  lookup: Cache Lookup
  store: Cache Store
  ttl_manager: TTL Manager
  
  lookup -> ttl_manager: check expiry
  store -> ttl_manager: set expiry
}

# Zone Data Manager - Local authority
zone_mgr: Zone Data Manager {
  shape: cylinder
  zone_files: Zone Files {
    shape: page
  }
  authority_check: Authority Check
  record_lookup: Record Lookup
  
  authority_check -> record_lookup: if authoritative
}

# Main data flow - UDP packets through the system
udp_server -> parser: 1. Raw UDP packet
parser -> resolver: 2. Parsed DNS query
resolver -> cache: 3. Check cache first
cache -> resolver: 4. Cache hit/miss

# Resolution path
resolver -> zone_mgr: 5a. Check local zones
zone_mgr -> resolver: 5b. Local response (if auth)
resolver -> resolver: 5c. Recursive lookup (if needed)

# Response construction
resolver -> cache: 6. Store result
cache -> parser: 7. Response data
parser -> udp_server: 8. Encoded response
udp_server -> udp_server: 9. Send UDP response

# External connections
external_dns: External DNS Servers {
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
}

resolver <-> external_dns: Recursive queries

# Flow annotations
flow_note: |md
  **Data Flow:**
  1. UDP packet received
  2. Parse & validate query
  3. Check cache for answer
  4. If miss, resolve recursively
  5. Store result & respond
| {
  shape: page
  style.fill: "#16213e"
}