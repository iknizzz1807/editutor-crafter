title: Data Model Relationships

direction: right

# Color palette
classes: {
  container_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  kernel_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  map_style: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    style.italic: true
  }
  user_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  class_style: {
    shape: class
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

kernel_space: {
  style: {
    fill: "#1a1a2e"
    stroke: "#3fb950"
    font-color: "#e6edf3"
  }
  label: "Kernel Space Event Structs"

  event_header: {
    class: class_style
    label: |md
      event_header
      - timestamp_ns: "uint64_t"
      - pid: "uint32_t"
      - ppid: "uint32_t"
      - uid: "uint32_t"
      - gid: "uint32_t"
      - comm: "char[16]"
      - event_type: "uint32_t"
    |
  }
  
  syscall_event: {
    class: class_style
    label: |md
      syscall_event
      - event_header: event_header
      - syscall_nr: "int32_t"
      - args: "uint64_t[6]"
      - ret: "int64_t"
    |
  }
  
  tcp_event: {
    class: class_style
    label: |md
      tcp_event
      - event_header: event_header
      - saddr: "__be32"
      - daddr: "__be32"
      - sport: "__be16"
      - dport: "__be16"
      - old_state: "int"
      - new_state: "int"
    |
  }
}

bpf_maps: {
  style: {
    fill: "#1a1a2e"
    stroke: "#3fb950"
    font-color: "#e6edf3"
  }
  label: "BPF Map Types"

  hash_map: {
    shape: class
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    style.italic: true
    label: "hash_map\nevent_type: uint32_t {constraint: primary_key}\ncount: uint64_t"
    description: |md
      **Hash map** for counting
      events by type
    |
  }
  
  per_cpu_array: {
    shape: class
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    style.italic: true
    label: "per_cpu_array\ncpu_id: uint32_t {constraint: primary_key}\nlocal_count: uint64_t"
    description: |md
      **Per-CPU array** for
      lock-free statistics
    |
  }
  
  ringbuf: {
    shape: queue
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    style.italic: true
    label: "ring_buffer"
    description: |md
      **Ring buffer** for streaming
      events to user-space
    |
  }
}

user_space: {
  style: {
    fill: "#1a1a2e"
    stroke: "#3fb950"
    font-color: "#e6edf3"
  }
  label: "User-Space Aggregate Structs"

  histogram: {
    class: class_style
    label: |md
      histogram
      - buckets: "uint64_t[64]"
      - min: "uint64_t"
      - max: "uint64_t"
      - sum: "uint64_t"
      - count: "uint64_t"
      + add_sample(value: "uint64_t"): "void"
      + clear(): "void"
    |
  }
  
  connection_track: {
    class: class_style
    label: |md
      connection_track
      - src_ip: "uint32_t"
      - dst_ip: "uint32_t"
      - src_port: "uint16_t"
      - dst_port: "uint16_t"
      - start_time: "uint64_t"
      - last_seen: "uint64_t"
      - bytes_sent: "uint64_t"
      - bytes_recv: "uint64_t"
      - state: "uint8_t"
      + update(event: tcp_event): "void"
      + is_expired(now: "uint64_t"): "bool"
    |
  }
}

# Relationships
# Composition (containment)
syscall_event -> event_header: contains {style.stroke-width: 3}
tcp_event -> event_header: contains {style.stroke-width: 3}

# References
syscall_event -> ringbuf: "writes to" {style.stroke-dash: 3}
tcp_event -> ringbuf: "writes to" {style.stroke-dash: 3}

syscall_event -> hash_map: "updates" {style.stroke-dash: 3}
tcp_event -> hash_map: "updates" {style.stroke-dash: 3}

syscall_event -> per_cpu_array: "updates" {style.stroke-dash: 3}
tcp_event -> per_cpu_array: "updates" {style.stroke-dash: 3}

ringbuf -> histogram: "feeds" {style.stroke-dash: 3}
hash_map -> histogram: "aggregates" {style.stroke-dash: 3}
per_cpu_array -> histogram: "aggregates" {style.stroke-dash: 3}

ringbuf -> connection_track: "updates" {style.stroke-dash: 3}

# Layout improvements
kernel_space -> bpf_maps: "uses" {style.stroke: "#8b949e"; style.stroke-dash: 2}
bpf_maps -> user_space: "populates" {style.stroke: "#8b949e"; style.stroke-dash: 2}