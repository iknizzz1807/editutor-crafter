title: TCP State Machine for Connection Tracking
desc: State machine diagram showing TCP states (LISTEN, SYN_SENT, ESTABLISHED, etc.) and the transitions tracked by the tracepoint. Highlights the transitions we care about for measuring connection lifetime.

# Define colors for the dark theme
classes: {
  dark_theme: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.font-size: 16
  }
  highlight_state: {
    style.stroke: "#fca311"
    style.stroke-width: 3
    style.bold: true
  }
  normal_state: {
    style.stroke: "#8b949e"
    style.stroke-width: 2
  }
  initial_state: {
    shape: circle
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    label: ""
    width: 20
    height: 20
  }
  final_state: {
    style.double-border: true
  }
  transition_label: {
    style.font-size: 14
    style.font-color: "#c9d1d9"
  }
}

# Initial state marker
init: {
  shape: circle
  style.fill: "#3fb950"
  label: ""
  width: 20
  height: 20
}

# TCP Connection States
CLOSED: "CLOSED" {
  class: dark_theme
  style.font-size: 18
}

LISTEN: "LISTEN" {
  class: dark_theme
  class: highlight_state
  style.fill: "#0f3460"
}

SYN_SENT: "SYN_SENT" {
  class: dark_theme
  class: highlight_state
  style.fill: "#0f3460"
}

SYN_RECEIVED: "SYN_RECEIVED" {
  class: dark_theme
  class: normal_state
}

ESTABLISHED: "ESTABLISHED" {
  class: dark_theme
  class: highlight_state
  style.fill: "#0f3460"
}

FIN_WAIT_1: "FIN_WAIT_1" {
  class: dark_theme
  class: highlight_state
  style.fill: "#0f3460"
}

FIN_WAIT_2: "FIN_WAIT_2" {
  class: dark_theme
  class: normal_state
}

CLOSE_WAIT: "CLOSE_WAIT" {
  class: dark_theme
  class: normal_state
}

CLOSING: "CLOSING" {
  class: dark_theme
  class: normal_state
}

LAST_ACK: "LAST_ACK" {
  class: dark_theme
  class: normal_state
}

TIME_WAIT: "TIME_WAIT" {
  class: dark_theme
  class: highlight_state
  style.fill: "#0f3460"
}

# Initial transition
init -> CLOSED: "Start"

# Connection Establishment (Passive Open)
CLOSED -> LISTEN: "Passive Open\n(application listen)" {
  class: transition_label
  style.stroke: "#3fb950"
}

LISTEN -> SYN_RECEIVED: "Receive SYN\nSend SYN+ACK" {
  class: transition_label
}

SYN_RECEIVED -> ESTABLISHED: "Receive ACK" {
  class: transition_label
}

# Connection Establishment (Active Open)
CLOSED -> SYN_SENT: "Active Open\n(send SYN)" {
  class: transition_label
  style.stroke: "#3fb950"
}

SYN_SENT -> ESTABLISHED: "Receive SYN+ACK\nSend ACK" {
  class: transition_label
}

SYN_SENT -> CLOSED: "Timeout/Reset" {
  class: transition_label
}

# Simultaneous Open (rare case)
SYN_SENT -> SYN_RECEIVED: "Receive SYN\nSend SYN+ACK" {
  class: transition_label
}

# Connection Termination (Normal - Client initiates)
ESTABLISHED -> FIN_WAIT_1: "Send FIN (close)" {
  class: transition_label
  style.stroke: "#3fb950"
}

FIN_WAIT_1 -> FIN_WAIT_2: "Receive ACK" {
  class: transition_label
}

FIN_WAIT_2 -> TIME_WAIT: "Receive FIN\nSend ACK" {
  class: transition_label
}

TIME_WAIT -> CLOSED: "2MSL Timeout" {
  class: transition_label
  style.stroke: "#3fb950"
}

# Connection Termination (Normal - Server receives close)
ESTABLISHED -> CLOSE_WAIT: "Receive FIN\nSend ACK" {
  class: transition_label
}

CLOSE_WAIT -> LAST_ACK: "Send FIN (close)" {
  class: transition_label
}

LAST_ACK -> CLOSED: "Receive ACK" {
  class: transition_label
}

# Simultaneous Close
FIN_WAIT_1 -> CLOSING: "Receive FIN\nSend ACK" {
  class: transition_label
}

CLOSING -> TIME_WAIT: "Receive ACK" {
  class: transition_label
}

# Reset transitions
LISTEN -> CLOSED: "Send RST" {
  class: transition_label
}

SYN_RECEIVED -> CLOSED: "Timeout/Reset" {
  class: transition_label
}

ESTABLISHED -> CLOSED: "Receive RST" {
  class: transition_label
}

# Highlighted path for connection lifetime measurement
note: |md
  ## Connection Lifetime Measurement
  **Highlighted path** shows transitions tracked for measuring connection lifetime:
  
  1. **LISTEN** (server accepts)
  2. **SYN_SENT** (client initiates)  
  3. **ESTABLISHED** (connection active)
  4. **FIN_WAIT_1** (close initiated)
  5. **TIME_WAIT** (wait for cleanup)
  6. **CLOSED** (connection ended)
| {
  shape: page
  style.fill: "#16213e"
  style.stroke: "#fca311"
  style.font-color: "#e6edf3"
  near: bottom-right
}