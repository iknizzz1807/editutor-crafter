vars: {
  d2-config: {
    dark-theme-id: 200
  }
}

title: Memory Address Space Layout {
  near: top-center
  style.font-size: 20
  style.bold: true
  style.fill: "#3fb950"
}

address_space: Memory Address Space {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  rom: ROM {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    
    prg_rom: PRG-ROM
    chr_rom: CHR-ROM
    
    address_range: "8000-FFFF" {
      shape: page
      style.fill: "#0f3460"
    }
  }

  ram: RAM {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    
    internal_ram: Internal RAM
    work_ram: Work RAM
    
    address_range: "0000-07FF" {
      shape: page
      style.fill: "#0f3460"
    }
  }

  ppu_registers: PPU Registers {
    style.fill: "#16213e"
    style.stroke: "#d63031"
    style.font-color: "#e6edf3"
    
    ctrl: "PPUCTRL (2000)"
    mask: "PPUMASK (2001)"
    status: "PPUSTATUS (2002)"
    scroll: "PPUSCROLL (2005)"
    addr: "PPUADDR (2006)"
    data: "PPUDATA (2007)"
    
    address_range: "2000-2007" {
      shape: page
      style.fill: "#0f3460"
    }
  }

  apu_registers: APU Registers {
    style.fill: "#16213e"
    style.stroke: "#74b9ff"
    style.font-color: "#e6edf3"
    
    pulse1: "Pulse 1 (4000-4003)"
    pulse2: "Pulse 2 (4004-4007)"
    triangle: "Triangle (4008-400B)"
    noise: "Noise (400C-400F)"
    dmc: "DMC (4010-4013)"
    
    address_range: "4000-4017" {
      shape: page
      style.fill: "#0f3460"
    }
  }

  io_registers: I/O Registers {
    style.fill: "#16213e"
    style.stroke: "#fdcb6e"
    style.font-color: "#e6edf3"
    
    controller1: "Controller 1 (4016)"
    controller2: "Controller 2 (4017)"
    
    address_range: "4016-4017" {
      shape: page
      style.fill: "#0f3460"
    }
  }
}

bank_switching: Bank Switching Overlay {
  style.fill: "#2d3436"
  style.stroke: "#e17055"
  style.font-color: "#e6edf3"
  style.stroke-dash: 5
  
  mapper: Mapper Logic {
    style.fill: "#636e72"
    style.stroke: "#e17055"
    style.bold: true
  }
  
  bank_select: Bank Select Register {
    shape: hexagon
    style.fill: "#74b9ff"
    style.stroke: "#0984e3"
  }
  
  switchable_banks: Switchable Banks {
    bank0: Bank 0
    bank1: Bank 1
    bank2: Bank 2
    bank3: Bank 3
  }
}

cpu: CPU {
  shape: hexagon
  style.fill: "#00b894"
  style.stroke: "#00a085"
  style.font-color: "#ffffff"
  style.bold: true
}

memory_note: |md
  ## Address Mirroring
  - RAM: 0000-07FF mirrors at 0800, 1000, 1800
  - PPU: 2000-2007 mirrors every 8 bytes up to 3FFF
  - Some mappers provide additional RAM at 6000-7FFF
| {
  shape: page
  style.fill: "#2d3436"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  near: bottom-right
}

cpu -> address_space.ram: "Read/Write 0000-07FF"
cpu -> address_space.ppu_registers: "MMIO 2000-2007"
cpu -> address_space.apu_registers: "MMIO 4000-4017"
cpu -> address_space.io_registers: "Controller Input"
cpu -> address_space.rom: "Fetch Instructions 8000-FFFF"

bank_switching.mapper -> address_space.rom: "Controls Bank Selection"
bank_switching.bank_select -> bank_switching.mapper: "Configure Banks"
bank_switching.switchable_banks -> address_space.rom: "Map to Address Range"