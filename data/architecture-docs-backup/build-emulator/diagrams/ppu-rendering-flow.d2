title: PPU Rendering Pipeline {
  style.font-size: 24
  style.bold: true
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
}

# Timing and control
scanline_start: Scanline Start {
  shape: circle
  style.fill: "#3fb950"
  style.font-color: "#000000"
  style.bold: true
}

timing_controller: Timing Controller {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Background rendering pipeline
bg_pipeline: Background Pipeline {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  nametable_fetch: Fetch Nametable {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  attribute_fetch: Fetch Attribute {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  pattern_fetch: Fetch Pattern Data {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  shift_registers: Load Shift Registers {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  nametable_fetch -> attribute_fetch: "2 cycles"
  attribute_fetch -> pattern_fetch: "4 cycles"
  pattern_fetch -> shift_registers: "2 cycles"
}

# Sprite processing
sprite_pipeline: Sprite Pipeline {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  sprite_eval: Sprite Evaluation {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  sprite_fetch: Sprite Pattern Fetch {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  sprite_buffer: Sprite Line Buffer {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
    shape: queue
  }
  
  sprite_eval -> sprite_fetch: "8 sprites max"
  sprite_fetch -> sprite_buffer
}

# Pixel composition
compositor: Pixel Compositor {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
  
  priority_logic: Priority Logic {
    shape: diamond
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
  
  palette_lookup: Palette Lookup {
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
}

# Output
pixel_output: Pixel Output {
  style.fill: "#3fb950"
  style.font-color: "#000000"
  style.bold: true
}

# Timing checkpoints
cycle_dot: Cycle 0 {
  shape: circle
  style.fill: "#8b949e"
  style.font-color: "#000000"
}

cycle_256: Cycle 256 {
  shape: circle
  style.fill: "#8b949e"
  style.font-color: "#000000"
}

cycle_340: Cycle 340 {
  shape: circle
  style.fill: "#8b949e"
  style.font-color: "#000000"
}

# Main flow connections
scanline_start -> timing_controller
timing_controller -> bg_pipeline.nametable_fetch: "Start BG fetch"
timing_controller -> sprite_pipeline.sprite_eval: "Cycles 64-256"

bg_pipeline.shift_registers -> compositor.priority_logic: "BG pixel"
sprite_pipeline.sprite_buffer -> compositor.priority_logic: "Sprite pixel"

compositor.priority_logic -> compositor.palette_lookup: "Winner"
compositor.palette_lookup -> pixel_output: "RGB"

# Timing flow
scanline_start -> cycle_dot: "Cycle 0"
cycle_dot -> cycle_256: "Visible pixels"
cycle_256 -> cycle_340: "HBlank"
cycle_340 -> scanline_start: "Next line"

# Timing annotations
timing_controller -> cycle_dot: "Start"
timing_controller -> cycle_256: "End visible"
timing_controller -> cycle_340: "End scanline"