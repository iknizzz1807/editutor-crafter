shape: sequence_diagram

mutator1: Mutator Thread 1 {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

mutator2: Mutator Thread 2 {
  style.fill: "#1a1a2e"  
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

gc: GC Thread {
  style.fill: "#16213e"
  style.stroke: "#3fb950" 
  style.font-color: "#e6edf3"
  style.bold: true
}

heap: Heap {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

gc -> gc: initiate concurrent marking
gc -> heap: snapshot heap state (SATB)
gc -> mutator1: safepoint handshake request
gc -> mutator2: safepoint handshake request

mutator1 -> mutator1: reach safepoint
mutator2 -> mutator2: reach safepoint

mutator1 -> gc: safepoint ack
mutator2 -> gc: safepoint ack

gc -> gc: setup root scan
gc -> mutator1: resume execution
gc -> mutator2: resume execution

mutator1 -> heap: allocate object
mutator2 -> heap: update reference

mutator2 -> mutator2: SATB write barrier triggered
mutator2 -> gc: enqueue old reference value

gc -> heap: concurrent marking scan
mutator1 -> heap: allocate in TLAB
mutator1 -> mutator1: SATB barrier check
mutator1 -> gc: report reference update

gc -> gc: process SATB queue
gc -> heap: mark reachable objects

mutator2 -> heap: object allocation
gc -> heap: continue marking traversal

gc -> mutator1: final safepoint request  
gc -> mutator2: final safepoint request

mutator1 -> gc: final safepoint ack
mutator2 -> gc: final safepoint ack

gc -> heap: complete marking phase
gc -> gc: prepare for sweep
gc -> mutator1: resume normal execution
gc -> mutator2: resume normal execution