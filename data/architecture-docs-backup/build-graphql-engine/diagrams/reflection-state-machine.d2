shape: sequence_diagram

# States
states: {
  disconnected: Disconnected {
    style.fill: "#0f3460"
  }
  
  connecting: Connecting {
    style.fill: "#16213e"
  }
  
  introspecting_tables: Introspecting Tables {
    style.fill: "#16213e"
  }
  
  detecting_relationships: Detecting Relationships {
    style.fill: "#16213e"
  }
  
  building_types: Building Types {
    style.fill: "#16213e"
  }
  
  ready: Ready {
    style.stroke: "#3fb950"
    style.stroke-width: 3
    style.bold: true
  }
}

# Error States
error_states: {
  connection_error: Connection Error {
    shape: diamond
    style.fill: "#2d1a1a"
    style.stroke: "#f85149"
    style.font-color: "#ffffff"
  }
  
  introspection_error: Introspection Error {
    shape: diamond
    style.fill: "#2d1a1a"
    style.stroke: "#f85149"
    style.font-color: "#ffffff"
  }
  
  relationship_error: Relationship Error {
    shape: diamond
    style.fill: "#2d1a1a"
    style.stroke: "#f85149"
    style.font-color: "#ffffff"
  }
  
  type_building_error: Type Building Error {
    shape: diamond
    style.fill: "#2d1a1a"
    style.stroke: "#f85149"
    style.font-color: "#ffffff"
  }
}

# Initial transition
initial -> disconnected: start

# Normal flow
disconnected -> connecting: connect()
connecting -> introspecting_tables: connection successful
introspecting_tables -> detecting_relationships: tables fetched
detecting_relationships -> building_types: relationships detected
building_types -> ready: types generated

# Error transitions
connecting -> connection_error: connection failed
introspecting_tables -> introspection_error: table introspection failed
detecting_relationships -> relationship_error: relationship detection failed
building_types -> type_building_error: type generation failed

# Recovery from errors
connection_error -> connecting: retry
connection_error -> disconnected: cancel
introspection_error -> introspecting_tables: retry
introspection_error -> disconnected: reset
relationship_error -> detecting_relationships: retry
relationship_error -> introspecting_tables: restart
type_building_error -> building_types: retry
type_building_error -> detecting_relationships: restart

# Styling
style {
  font-color: "#e6edf3"
  stroke: "#8b949e"
}

# Title
title: Schema Reflection State Machine