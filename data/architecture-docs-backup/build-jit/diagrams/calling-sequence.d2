shape: sequence_diagram

interpreter: Bytecode Interpreter {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

trampoline_in: Nativeâ†’Interpreter Trampoline {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

jit_function: JIT-Compiled Function {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

trampoline_out: Interpreterâ†’Native Trampoline {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

callee_function: Native Callee Function {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

interpreter -> trampoline_out: call native function\n(bytecode args on stack)
trampoline_out -> trampoline_out: marshal args to\nSystem V registers\n(RDI, RSI, RDX...)
trampoline_out -> trampoline_out: save interpreter state\n(stack pointer, registers)
trampoline_out -> jit_function: native call\n(System V ABI)
jit_function -> jit_function: prologue: save\ncallee-saved registers\n(RBX, RBP, R12-R15)
jit_function -> jit_function: execute native code
jit_function -> trampoline_in: call interpreter function\n(need bytecode execution)
trampoline_in -> trampoline_in: save native registers\n(caller-saved: RAX, RCX, RDX...)
trampoline_in -> trampoline_in: marshal args to\nbytecode format
trampoline_in -> interpreter: invoke bytecode\ninterpreter
interpreter -> interpreter: execute bytecode\nfunction
interpreter -> trampoline_in: return result\n(on bytecode stack)
trampoline_in -> trampoline_in: restore native registers
trampoline_in -> trampoline_in: marshal result to\nnative format (RAX)
trampoline_in -> jit_function: return to native\n(System V ABI)
jit_function -> jit_function: epilogue: restore\ncallee-saved registers
jit_function -> trampoline_out: return result\n(in RAX)
trampoline_out -> trampoline_out: restore interpreter state
trampoline_out -> trampoline_out: marshal result to\nbytecode stack
trampoline_out -> interpreter: return to interpreter\n(result on stack)