title: Register Allocation Strategy {
  style.font-size: 24
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
}

start: Start {
  shape: circle
  style.fill: "#3fb950"
  style.font-color: "#000000"
}

analyze_bytecode: Analyze Bytecode\nOperation {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

stack_depth_check: Stack Depth\n< Available Regs? {
  shape: diamond
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

direct_mapping: Direct Stack-to-Register\nMapping {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

spill_required: Spill Analysis\nRequired {
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

lru_selection: Select LRU Stack\nSlot for Spill {
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

emit_spill: Emit MOV reg->mem\n(Stack Spill) {
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

allocate_reg: Allocate Register\nto New Value {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

needs_reload: Operand Needs\nReload from Memory? {
  shape: diamond
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

emit_reload: Emit MOV mem->reg\n(Reload) {
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

emit_instruction: Emit x86-64\nInstruction {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

update_tracking: Update Register\nTracking State {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

more_ops: More Bytecode\nOperations? {
  shape: diamond
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

end: End {
  shape: circle
  style.fill: "#3fb950"
  style.font-color: "#000000"
}

register_state: |md
  **Register State**
  - RAX, RCX, RDX: Working regs
  - Stack mapping tracker
  - LRU timestamp counter
| {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

start -> analyze_bytecode
analyze_bytecode -> stack_depth_check
stack_depth_check -> direct_mapping: Yes
stack_depth_check -> spill_required: No
direct_mapping -> needs_reload
spill_required -> lru_selection
lru_selection -> emit_spill
emit_spill -> allocate_reg
allocate_reg -> needs_reload
needs_reload -> emit_reload: Yes
needs_reload -> emit_instruction: No
emit_reload -> emit_instruction
emit_instruction -> update_tracking
update_tracking -> more_ops
more_ops -> analyze_bytecode: Yes
more_ops -> end: No

register_state -> stack_depth_check: tracks
register_state -> lru_selection: guides
update_tracking -> register_state: updates