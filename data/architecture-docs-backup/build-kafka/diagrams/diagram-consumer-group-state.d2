title: Consumer Group State Machine
direction: right

style: {
  fill: "#0f3460"
  stroke: "#3fb950"
  font-color: "#e6edf3"
  bold: false
}

# Initial state indicator
init: {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  width: 20
  height: 20
}

# States
STARTING: {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

AWAITING_ASSIGNMENT: {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

STABLE: {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  label: "STABLE\n(sending heartbeats)"
}

DEAD: {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  style.multiple: true
}

# Transitions
init -> STARTING

STARTING -> AWAITING_ASSIGNMENT: "JoinGroup request\n(member joins)"

AWAITING_ASSIGNMENT -> STABLE: "SyncGroup request\n(coordinator assigns)"

STABLE -> AWAITING_ASSIGNMENT: "rebalance triggered"

STABLE -> DEAD: "heartbeat fails"
AWAITING_ASSIGNMENT -> DEAD: "heartbeat fails"
STARTING -> DEAD: "heartbeat fails"

# Note about heartbeats
heartbeat_note: |md
  **Heartbeat Mechanism:**
  - In STABLE state, member sends periodic heartbeats
  - Coordinator responds with heartbeat response
  - If response fails/timeout, member transitions to DEAD
| {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Connect note to STABLE state
STABLE -> heartbeat_note: "periodic" {
  style.stroke-dash: 2
  style.stroke: "#8b949e"
}
