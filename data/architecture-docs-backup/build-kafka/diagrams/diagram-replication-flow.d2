title: Leader-Follower Replication Flow {
  near: top-center
}

Leader: {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.bold: true

  check_hwm: 2. Check High Watermark {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
  }

  isr_check: 6. ISR check - follower caught up? {
    shape: diamond
    style.fill: "#1a1a2e"
    style.stroke: "#e6edf3"
  }

  update_isr: 7. Update In-Sync Replicas (ISR) {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.bold: true
  }
}

Follower: {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.bold: true

  append_records: 4. Append records to local log {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
  }

  update_leo: 5. Update Local End Offset (LEO) {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
  }
}

# Start of loop
Follower -> Leader: 1. Send Fetch request {
  style.stroke-dash: 3
  style.animated: true
}

Leader -> Follower: 3. Return new records

Leader.check_hwm -> Leader.isr_check: next

Leader.isr_check -> Leader.update_isr: Yes
Leader.isr_check -> Follower: No (wait) {
  style.stroke-dash: 3
}

Follower.append_records -> Follower.update_leo: next

note: {
  shape: page
  label: Follower repeats this loop
  near: bottom-center
}

# Styling
style: {
  stroke: "#8b949e"
  fill: "#0d1117"
  font-color: "#e6edf3"
  opacity: 0.9
}
