shape: sequence_diagram
title: Boot Sequence Diagram: Power-On to Kernel main()

# Actors
bios: BIOS
bootloader: Bootloader
cpu: CPU
kernel: Kernel

# Mode indicators as separate columns
real_mode: Real Mode {
  shape: text
  style.bold: true
}
protected_mode: Protected Mode {
  shape: text
  style.bold: true
}
real_mode -> protected_mode: Switch

# Power On
bios -> cpu: Power On | RESET
cpu -> bios: Execute POST & Hardware Init
cpu.style.stroke: "#3fb950"
cpu.style.bold: true
note: CPU starts in Real Mode (16-bit, 1MB addressable) {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
}

# Bootloader loading
bios -> bootloader: Load Sector 0 (MBR) at 0x7C00
bootloader: {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
bios -> cpu: FAR JMP to 0x7C00

# Bootloader execution
cpu -> bootloader: Execute Bootloader Code
bootloader -> cpu: Disable Interrupts (CLI)
bootloader -> cpu: Enable A20 Line
bootloader -> cpu: Load GDT (lgdt)

# Mode transition
bootloader -> cpu: Set PE bit in CR0 (mov cr0, ...)
cpu -> cpu: CR0.PE = 1
cpu.style.stroke-dash: 3
note: CPU enters Protected Mode (32-bit, 4GB addressable) {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
}
bootloader -> cpu: Far Jump to Protected Mode Segment

# Kernel loading
bootloader -> kernel: Load Kernel from Disk to 0x100000 (1MB)
kernel: {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}
bootloader -> cpu: Jump to Kernel Entry Point

# Kernel initialization
cpu -> kernel: Execute Kernel Entry (kmain)
kernel -> cpu: Setup GDT with Kernel Segments
kernel -> cpu: Setup IDT with ISR Stubs
kernel -> cpu: Remap PIC (Programmable Interrupt Controller)
kernel -> kernel: Initialize Memory Manager
kernel -> kernel: Initialize Scheduler
kernel -> kernel: Call main() - System Running

# Final state
kernel -> kernel: OS Kernel Initialized