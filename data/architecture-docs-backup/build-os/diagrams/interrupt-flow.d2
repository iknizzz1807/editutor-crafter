title: Interrupt Handling Flowchart

direction: down

interrupt_handling: Interrupt Handling Flowchart {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  irq_start: {
    label: "Hardware IRQ Occurs"
    shape: oval
    style.fill: "#0f3460"
    style.bold: true
  }

  exc_start: {
    label: "Exception Triggered"
    shape: oval
    style.fill: "#0f3460"
    style.bold: true
  }

  pic_stage: {
    pic_receives: {
      label: "PIC Receives IRQ"
      style.bold: true
    }
    
    spurious_check: {
      label: "Spurious IRQ?"
      shape: diamond
      style.stroke: "#e17055"
    }
    
    pic_sends: "PIC Sends Vector to CPU"
  }

  cpu_stage: {
    cpu_receives: "CPU Receives Vector"
    save_state: "Save Context (Push Registers, CS:EIP, EFLAGS)"
    
    privilege_check: {
      label: "Privilege Level Change?"
      shape: diamond
      style.stroke: "#e17055"
    }
    
    stack_switch: "Switch to Kernel Stack"
    clear_if: "Clear IF Flag (Disable Interrupts)"
  }

  idt_stage: {
    idt_lookup: "Lookup Handler in IDT"
    segment_checks: "Validate Segment Selector & Descriptor"
    load_cs_eip: "Load CS:EIP from Gate Descriptor"
  }

  handler_stage: {
    handler_exec: "Execute Interrupt Handler"
    handler_type: {
      label: "Handler Type?"
      shape: diamond
      style.stroke: "#e17055"
    }
    
    exception_logic: "Exception-Specific Logic"
    device_handler: "Device Driver Handler"
  }

  eoi_stage: {
    label: "Send EOI to PIC"
    style.bold: true
  }

  return_stage: {
    restore_state: "Restore Saved Context"
    iret_exec: {
      label: "Execute IRET Instruction"
      style.bold: true
    }
  }

  return_node: {
    label: "Return to Interrupted Code"
    shape: oval
    style.fill: "#0f3460"
    style.bold: true
  }

  # Main flow connections
  irq_start -> pic_stage.pic_receives: "IRQ Line Asserted"
  exc_start -> cpu_stage.cpu_receives: "CPU Internal Fault/Trap"

  pic_stage.pic_receives -> pic_stage.spurious_check
  pic_stage.spurious_check -> pic_stage.pic_sends: "No (Valid IRQ)" {
    style.stroke-dash: 0
  }
  pic_stage.spurious_check -> return_stage.iret_exec: "Yes (Ignore)" {
    style.stroke-dash: 3
  }

  pic_stage.pic_sends -> cpu_stage.cpu_receives: "Vector on Data Bus"

  cpu_stage.cpu_receives -> cpu_stage.save_state
  cpu_stage.save_state -> cpu_stage.privilege_check
  cpu_stage.privilege_check -> cpu_stage.stack_switch: "Yes (Userâ†’Kernel)"
  cpu_stage.privilege_check -> cpu_stage.clear_if: "No (Same Privilege)"
  cpu_stage.stack_switch -> cpu_stage.clear_if
  cpu_stage.clear_if -> idt_stage.idt_lookup

  idt_stage.idt_lookup -> idt_stage.segment_checks
  idt_stage.segment_checks -> idt_stage.load_cs_eip: "Checks Pass"
  idt_stage.segment_checks -> handler_stage.exception_logic: "Checks Fail (GPF)" {
    style.stroke-dash: 3
  }

  idt_stage.load_cs_eip -> handler_stage.handler_exec
  handler_stage.handler_exec -> handler_stage.handler_type

  handler_stage.handler_type -> handler_stage.exception_logic: "Exception"
  handler_stage.handler_type -> handler_stage.device_handler: "Hardware Interrupt"

  handler_stage.exception_logic -> eoi_stage: "Exception (No EOI)" {
    style.stroke-dash: 3
  }
  handler_stage.device_handler -> eoi_stage: "Interrupt Handler Done"

  eoi_stage -> return_stage.restore_state
  return_stage.restore_state -> return_stage.iret_exec
  return_stage.iret_exec -> return_node
}