shape: sequence_diagram
title: Sequence Diagram: The Figure 8 Safety Issue

S1: S1 (Leader, Term 2) {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.bold: true
}
S2: S2 (Follower)
S3: S3 (Follower)
S4: S4 (Follower)
S5: S5 (Leader, Term 3) {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.bold: true
}

# Term 2 - S1 replicates entry
S1 -> S2: AppendEntries (Term:2, Index:2)
S1 -> S3: AppendEntries (Term:2, Index:2)
S2 -> S1: Success
S3 -> S1: No Response/Timeout

note: S1 has replicated entry (Term:2, Index:2) to only S2. Lacks majority quorum. {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

# S1 crashes, new election
S1 -> S1: Crashes {
  style.stroke-dash: 3
}
S5 -> S5: Elected Leader (Term:3)

# Term 3 - S5 overwrites with new entry
S5 -> S1: AppendEntries (Term:3, Index:2)
S5 -> S2: AppendEntries (Term:3, Index:2)
S5 -> S3: AppendEntries (Term:3, Index:2)
S5 -> S4: AppendEntries (Term:3, Index:2)

S2 -> S5: Success (Overwrites Term:2 entry)
S3 -> S5: Success
S4 -> S5: Success

note: S5 replicates entry (Term:3, Index:2) to S2,S3,S4 â†’ Majority achieved. {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

# Safety rule prevents incorrect commit
S5 -> S5: Checks commit rule

note: |md
  **Safety Rule in Action:**
  Leader only commits entries from its *current term* (Term 3) after they are on majority.
  The old Term 2 entry at Index:2 is **not committed** by S5.
  It is safely overwritten by the Term 3 entry.
| {
  shape: page
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.italic: true
}