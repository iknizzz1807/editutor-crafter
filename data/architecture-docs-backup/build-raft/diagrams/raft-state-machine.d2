title: Raft Node State Machine Diagram

style: {
  # Dark theme
  fill: "#0f3460"
  stroke: "#3fb950"
  font-color: "#e6edf3"
}

states: {
  # Initial state
  start: "" {
    shape: circle
    style: {
      fill: "#3fb950"
      stroke: "#3fb950"
    }
  }

  # Raft states
  follower: Follower {
    shape: oval
    style: {
      stroke-width: 3
      bold: true
    }
  }

  candidate: Candidate {
    shape: oval
    style: {
      stroke-width: 3
      bold: true
    }
  }

  leader: Leader {
    shape: oval
    style: {
      stroke-width: 3
      bold: true
    }
  }
}

# Transitions
start -> follower

follower -> candidate: Election timeout {
  style: {
    stroke-dash: 2
  }
  label: "1. Increment currentTerm\n2. Vote for self\n3. Reset election timer\n4. Send RequestVote RPCs"
}

candidate -> candidate: Election timeout {
  style: {
    stroke-dash: 2
  }
  label: "Start new election\n1. Increment currentTerm\n2. Reset election timer\n3. Send RequestVote RPCs"
}

candidate -> follower: "Discover higher term" {
  label: "1. Update currentTerm\n2. Convert to follower\n3. Reset election timer"
}

candidate -> leader: "Receive votes from majority" {
  style: {
    stroke: "#ffd700"
    stroke-width: 2
  }
  label: "1. Become leader\n2. Send initial heartbeat\n3. Start sending heartbeats periodically"
}

leader -> follower: "Discover higher term" {
  label: "1. Update currentTerm\n2. Convert to follower\n3. Reset election timer"
}

# Internal transitions/actions
follower -> follower: "Receive valid AppendEntries" {
  style: {
    stroke-dash: 3
  }
  label: "Reset election timer"
}

candidate -> follower: "Grant vote to other candidate" {
  style: {
    stroke-dash: 3
  }
  label: "1. Vote for other candidate\n2. Reset election timer"
}

leader -> leader: "Heartbeat interval" {
  style: {
    stroke-dash: 3
  }
  label: "Send AppendEntries RPCs"
}

# Legend
legend: {
  shape: sql_table
  style: {
    fill: "#1a1a2e"
  }
  
  "Solid line": "State transition"
  "Dashed line": "Internal action"
  "Gold arrow": "Election victory"
  "Filled circle start": "Initial state"
}
