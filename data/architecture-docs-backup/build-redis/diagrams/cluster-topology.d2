title: Cluster Node Topology and Communication

cluster: Redis Cluster {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  node1: "Node 1\n:7001" {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
    
    slots1: "Hash Slots\n0-5460" {
      shape: page
      style.fill: "#0f3460"
      style.font-color: "#e6edf3"
    }
  }

  node2: "Node 2\n:7002" {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
    
    slots2: "Hash Slots\n5461-10922" {
      shape: page
      style.fill: "#0f3460"
      style.font-color: "#e6edf3"
    }
  }

  node3: "Node 3\n:7003" {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
    
    slots3: "Hash Slots\n10923-16383" {
      shape: page
      style.fill: "#0f3460"
      style.font-color: "#e6edf3"
    }
  }

  node1 <-> node2: "Gossip Protocol\n(Cluster State)" {
    style.stroke: "#8b949e"
    style.stroke-dash: 5
  }
  node2 <-> node3: "Gossip Protocol\n(Cluster State)" {
    style.stroke: "#8b949e"
    style.stroke-dash: 5
  }
  node1 <-> node3: "Gossip Protocol\n(Cluster State)" {
    style.stroke: "#8b949e"
    style.stroke-dash: 5
  }
}

client: Redis Client {
  shape: package
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

hash_function: CRC16 Hash Function {
  shape: hexagon
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

client -> cluster.node2: "GET user:123\n(initially contacts wrong node)" {
  style.stroke: "#8b949e"
}

cluster.node2 -> client: "MOVED 1234 127.0.0.1:7001\n(redirects to correct node)" {
  style.stroke: "#d63031"
  style.bold: true
}

client -> cluster.node1: "GET user:123\n(redirected request)" {
  style.stroke: "#3fb950"
  style.bold: true
}

cluster.node1 -> client: "john_doe\n(successful response)" {
  style.stroke: "#3fb950"
}

client -> hash_function: "key user:123" {
  style.stroke: "#8b949e"
}
hash_function -> cluster.node1: "maps to slot 1234\n(owned by Node 1)" {
  style.stroke: "#8b949e"
}

legend: "Legend:\n- Solid lines: Direct requests/responses\n- Dashed lines: Gossip protocol communication\n- Red lines: MOVED redirections\n- Green lines: Successful operations" {
  shape: page
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
  style.stroke: "#8b949e"
}