title: Persistence Architecture Components {
  style.font-color: "#e6edf3"
}

main_storage: Main Storage Layer {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  memory: In-Memory Data {
    shape: cylinder
    style.fill: "#16213e"
    style.stroke: "#3fb950"
  }
  
  keyspace: Key-Value Store {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
  }
  
  memory -> keyspace: stores
}

rdb_system: RDB Persistence {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  rdb_engine: RDB Engine {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
  }
  
  snapshot: Snapshot Process {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
  }
  
  rdb_engine -> snapshot: creates
}

aof_system: AOF Persistence {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  aof_engine: AOF Engine {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
  }
  
  write_buffer: Write Buffer {
    shape: queue
    style.fill: "#16213e"
    style.stroke: "#8b949e"
  }
  
  aof_rewrite: AOF Rewrite {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
  }
  
  aof_engine -> write_buffer: buffers
  aof_engine -> aof_rewrite: triggers
}

background: Background Processes {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  bgsave: BGSAVE Process {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.bold: true
  }
  
  bg_aof: Background AOF {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
  }
  
  scheduler: Save Scheduler {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
  }
  
  scheduler -> bgsave: spawns
  scheduler -> bg_aof: manages
}

filesystem: File System {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  rdb_file: dump.rdb {
    shape: page
    style.fill: "#16213e"
    style.stroke: "#8b949e"
  }
  
  aof_file: appendonly.aof {
    shape: page
    style.fill: "#16213e"
    style.stroke: "#8b949e"
  }
  
  temp_files: Temp Files {
    shape: page
    style.fill: "#16213e"
    style.stroke: "#8b949e"
  }
}

# Main connections
main_storage.memory -> rdb_system.rdb_engine: SAVE command
main_storage.memory -> background.bgsave: BGSAVE command
main_storage.keyspace -> aof_system.aof_engine: write operations

# Background process flows
background.bgsave -> rdb_system.snapshot: forks process
rdb_system.snapshot -> filesystem.rdb_file: writes snapshot
background.bg_aof -> aof_system.aof_rewrite: compacts log

# AOF flows
aof_system.write_buffer -> filesystem.aof_file: fsync
aof_system.aof_rewrite -> filesystem.temp_files: creates temp

# Recovery flows
filesystem.rdb_file -> main_storage.memory: startup restore {style.stroke: "#d63031"}
filesystem.aof_file -> main_storage.memory: replay commands {style.stroke: "#d63031"}

# File system operations
rdb_system.rdb_engine -> filesystem.rdb_file: synchronous write
background.scheduler -> filesystem: monitors disk space