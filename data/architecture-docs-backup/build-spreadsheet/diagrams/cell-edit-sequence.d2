shape: sequence_diagram

# Define participants
user: "User" {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
}
grid: "VirtualGrid" {
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
}
parser: "FormulaParser" {
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
}
graph: "DependencyGraph" {
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
}
engine: "Recalculation Engine" {
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
}
ui: "UI Renderer" {
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
}

# Title
note: |md
  ## Cell Edit and Recalculation Sequence
  The complete reactive dataflow when editing a cell with formulas
| {
  style.fill: "#0f3460"
  style.font-color: "#e6edf3"
  style.bold: true
  style.stroke: "#3fb950"
}

# Main sequence flow
user -> grid: "1. Edits cell (types formula)"
grid -> grid: "2. Updates raw value in data model"
grid -> parser: "3. Sends formula text for parsing"
parser -> parser: "4. Builds AST from formula"
parser -> grid: "5. Returns AST with cell references"
grid -> graph: "6. Updates dependencies for edited cell"
graph -> graph: "7. Validates graph (no cycles)"
graph -> engine: "8. Notifies changes, requests recalculation"
engine -> engine: "9. Performs topological sort on affected cells"
engine -> engine: "10. Evaluates cells in dependency order"
engine -> grid: "11. Updates computed values in data model"
grid -> ui: "12. Notifies UI of changed cells"
ui -> ui: "13. Re-renders affected cell views"

# Highlight critical path
note: {
  style.fill: "#0f3460"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
  shape: page
}
graph.note: "Detects circular references" {
  style.fill: "#0f3460"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}
engine.note: "Ensures correct evaluation order" {
  style.fill: "#0f3460"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}

# Styling for connections
style {
  stroke: "#8b949e"
  stroke-width: 2
}