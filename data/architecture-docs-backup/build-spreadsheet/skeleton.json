{
  "title": "Build Your Own Spreadsheet: Design Document",
  "overview": "This document outlines the architecture for an Excel-like spreadsheet application built with TypeScript/JavaScript in the browser. The core challenge is designing an efficient recalculation engine that maintains consistency across cell dependencies while providing responsive UI interactions. Key architectural decisions include a virtualized grid for rendering, a directed acyclic graph for dependency tracking, and a command pattern for undo/redo operations.",
  "sections": [
    {
      "id": "context",
      "title": "Context and Problem Statement",
      "summary": "Explains the fundamental challenge of spreadsheet engines: maintaining consistency between cells with formula dependencies while providing real-time interaction. Compares different approaches to dependency management.",
      "subsections": [
        {
          "id": "mental-model",
          "title": "Mental Model: The Spreadsheet as a Reactive Calculator"
        },
        {
          "id": "problem-depth",
          "title": "Why Building a Spreadsheet is Hard"
        },
        {
          "id": "existing-approaches",
          "title": "Comparison of Existing Approaches"
        }
      ]
    },
    {
      "id": "goals",
      "title": "Goals and Non-Goals",
      "summary": "Clearly defines what the spreadsheet must achieve (core functionality) and what is explicitly out of scope (advanced features). Helps scope the project for educational purposes.",
      "subsections": [
        {
          "id": "must-have",
          "title": "Must Have Features (Core Requirements)"
        },
        {
          "id": "explicit-out-of-scope",
          "title": "Explicitly Out of Scope"
        }
      ]
    },
    {
      "id": "architecture",
      "title": "High-Level Architecture",
      "summary": "Presents the three-layer architecture: Presentation Layer (grid UI), Business Logic Layer (data model, parser, graph), and Storage/State Layer. Describes component responsibilities and interactions.",
      "subsections": [
        {
          "id": "arch-overview",
          "title": "Three-Layer Architecture Overview"
        },
        {
          "id": "component-map",
          "title": "Component Map and Responsibilities"
        },
        {
          "id": "file-structure",
          "title": "Recommended File and Module Structure"
        }
      ]
    },
    {
      "id": "data-model",
      "title": "Data Model",
      "summary": "Defines the core data structures that represent cells, formulas, the dependency graph, and application state. Uses TypeScript-like type definitions for clarity.",
      "subsections": [
        {
          "id": "cell-data",
          "title": "Cell Data Structure: Value, Formula, and Metadata"
        },
        {
          "id": "graph-data",
          "title": "Dependency Graph: Nodes, Edges, and Adjacency"
        },
        {
          "id": "app-state",
          "title": "Application State: Grid, Selection, and History"
        }
      ]
    },
    {
      "id": "component-grid",
      "title": "Component Design: Virtualized Grid",
      "summary": "Details the grid rendering component that manages efficient display of thousands of cells using viewport virtualization. Covers DOM recycling, cell addressing, and selection management.",
      "subsections": [
        {
          "id": "grid-mental-model",
          "title": "Mental Model: A Movable Viewport Over a Large Canvas"
        },
        {
          "id": "grid-interface",
          "title": "Grid Interface and Methods"
        },
        {
          "id": "virtualization-algorithm",
          "title": "Virtual Scrolling Algorithm"
        },
        {
          "id": "grid-adrs",
          "title": "Architecture Decision Records for Grid"
        },
        {
          "id": "grid-pitfalls",
          "title": "Common Pitfalls: Grid Rendering"
        },
        {
          "id": "grid-implementation",
          "title": "Implementation Guidance: Grid Component"
        }
      ]
    },
    {
      "id": "component-parser",
      "title": "Component Design: Formula Parser and Evaluator",
      "summary": "Explains the formula parsing pipeline from raw string to evaluated result. Covers tokenization, AST construction, cell reference resolution, and built-in functions.",
      "subsections": [
        {
          "id": "parser-mental-model",
          "title": "Mental Model: A Calculator That Understands Spreadsheet Addresses"
        },
        {
          "id": "parser-interface",
          "title": "Parser/Evaluator Interface"
        },
        {
          "id": "parsing-steps",
          "title": "Parsing and Evaluation Steps"
        },
        {
          "id": "parser-adrs",
          "title": "Architecture Decision Records for Parser"
        },
        {
          "id": "parser-pitfalls",
          "title": "Common Pitfalls: Formula Parsing"
        },
        {
          "id": "parser-implementation",
          "title": "Implementation Guidance: Parser Component"
        }
      ]
    },
    {
      "id": "component-graph",
      "title": "Component Design: Dependency Graph and Recalculation Engine",
      "summary": "Describes the directed graph that tracks cell dependencies and the topological sort algorithm for correct recalculation order. Includes circular reference detection.",
      "subsections": [
        {
          "id": "graph-mental-model",
          "title": "Mental Model: A Network of Data Dependencies"
        },
        {
          "id": "graph-interface",
          "title": "Dependency Graph Interface"
        },
        {
          "id": "recalc-algorithm",
          "title": "Recalculation Algorithm with Topological Sort"
        },
        {
          "id": "graph-adrs",
          "title": "Architecture Decision Records for Dependency Graph"
        },
        {
          "id": "graph-pitfalls",
          "title": "Common Pitfalls: Dependency Management"
        },
        {
          "id": "graph-implementation",
          "title": "Implementation Guidance: Graph Component"
        }
      ]
    },
    {
      "id": "component-advanced",
      "title": "Component Design: Advanced Features Manager",
      "summary": "Covers the implementation of copy/paste with reference adjustment, undo/redo using command pattern, CSV import/export, and cell formatting.",
      "subsections": [
        {
          "id": "advanced-mental-model",
          "title": "Mental Model: Time Travel for Spreadsheet Actions"
        },
        {
          "id": "advanced-interface",
          "title": "Advanced Features Interfaces"
        },
        {
          "id": "undo-redo-algorithm",
          "title": "Undo/Redo Algorithm with Command Pattern"
        },
        {
          "id": "reference-adjustment",
          "title": "Relative/Absolute Reference Adjustment"
        },
        {
          "id": "advanced-adrs",
          "title": "Architecture Decision Records for Advanced Features"
        },
        {
          "id": "advanced-pitfalls",
          "title": "Common Pitfalls: Advanced Features"
        },
        {
          "id": "advanced-implementation",
          "title": "Implementation Guidance: Advanced Features"
        }
      ]
    },
    {
      "id": "interactions",
      "title": "Interactions and Data Flow",
      "summary": "Traces the complete flow from user input (typing a formula) through parsing, dependency graph update, recalculation, and UI update. Includes message sequence charts.",
      "subsections": [
        {
          "id": "edit-flow",
          "title": "Cell Edit and Recalculation Flow"
        },
        {
          "id": "copy-paste-flow",
          "title": "Copy/Paste with Reference Adjustment Flow"
        },
        {
          "id": "undo-redo-flow",
          "title": "Undo/Redo State Management Flow"
        }
      ]
    },
    {
      "id": "error-handling",
      "title": "Error Handling and Edge Cases",
      "summary": "Documents expected failure modes: circular references, parse errors, invalid references, and out-of-bounds errors. Provides recovery strategies for each.",
      "subsections": [
        {
          "id": "error-types",
          "title": "Error Type Catalog and Detection"
        },
        {
          "id": "recovery-strategies",
          "title": "Recovery and User Feedback Strategies"
        },
        {
          "id": "edge-cases",
          "title": "Edge Cases: Empty Cells, Ranges, and Formula Variants"
        }
      ]
    },
    {
      "id": "testing",
      "title": "Testing Strategy",
      "summary": "Provides a testing approach for each component and milestone. Includes unit tests for parsers and graphs, integration tests for recalculation, and manual verification checkpoints.",
      "subsections": [
        {
          "id": "testing-approach",
          "title": "Testing Approach by Component"
        },
        {
          "id": "milestone-checkpoints",
          "title": "Milestone Verification Checkpoints"
        }
      ]
    },
    {
      "id": "debugging",
      "title": "Debugging Guide",
      "summary": "Symptom-cause-fix table for common implementation bugs. Provides techniques for visualizing the dependency graph and tracing formula evaluation.",
      "subsections": [
        {
          "id": "symptom-table",
          "title": "Common Bug Symptoms and Fixes"
        },
        {
          "id": "debug-techniques",
          "title": "Spreadsheet-Specific Debugging Techniques"
        }
      ]
    },
    {
      "id": "future",
      "title": "Future Extensions",
      "summary": "Suggests potential enhancements that the current architecture enables: multi-sheet support, collaborative editing, more functions, charts, and performance optimizations.",
      "subsections": [
        {
          "id": "extension-ideas",
          "title": "Extension Ideas and Design Accommodations"
        }
      ]
    },
    {
      "id": "glossary",
      "title": "Glossary",
      "summary": "Definitions of key terms used throughout the document: AST, topological sort, viewport virtualization, command pattern, and spreadsheet-specific vocabulary.",
      "subsections": [
        {
          "id": "terms",
          "title": "Term Definitions and References"
        }
      ]
    }
  ],
  "diagrams": [
    {
      "id": "sys-component",
      "title": "System Component Diagram",
      "description": "Shows the three-layer architecture with components: Virtual Grid UI, Cell Data Model, Formula Parser, Dependency Graph Engine, and Undo Manager. Arrows show data flow between components.",
      "type": "component",
      "relevant_sections": [
        "architecture",
        "interactions"
      ]
    },
    {
      "id": "data-model-diagram",
      "title": "Data Model Class Diagram",
      "description": "Shows the relationship between core data types: Spreadsheet (contains Grid), Grid (2D array of Cell), Cell (has value, formula, format), DependencyGraph (has Node and Edge).",
      "type": "class",
      "relevant_sections": [
        "data-model"
      ]
    },
    {
      "id": "cell-edit-sequence",
      "title": "Cell Edit and Recalculation Sequence",
      "description": "Sequence diagram showing: User edits cell \u2192 Grid updates raw value \u2192 Parser builds AST \u2192 Graph updates dependencies \u2192 Topological sort \u2192 Evaluate cells in order \u2192 Update UI.",
      "type": "sequence",
      "relevant_sections": [
        "interactions",
        "component-graph"
      ]
    },
    {
      "id": "formula-parsing-flow",
      "title": "Formula Parsing Flowchart",
      "description": "Flowchart showing formula evaluation: Start with string \u2192 Tokenize \u2192 Parse to AST \u2192 Resolve references \u2192 Evaluate nodes \u2192 Return result. Include error branches for parse errors and circular refs.",
      "type": "flowchart",
      "relevant_sections": [
        "component-parser",
        "error-handling"
      ]
    },
    {
      "id": "dependency-graph-state",
      "title": "Dependency Graph State Transitions",
      "description": "State machine for the dependency graph: Normal \u2192 Adding Edge (check for cycle) \u2192 Cycle Detected (error state) \u2192 Recalculating (topological sort in progress) \u2192 Updated.",
      "type": "state-machine",
      "relevant_sections": [
        "component-graph"
      ]
    },
    {
      "id": "undo-redo-flow",
      "title": "Undo/Redo Command Flow",
      "description": "Flowchart for command pattern: Execute Command \u2192 Push to undo stack \u2192 Clear redo stack. Undo: Pop from undo stack, execute inverse, push to redo stack. Redo: Pop from redo stack, execute, push to undo.",
      "type": "flowchart",
      "relevant_sections": [
        "component-advanced",
        "interactions"
      ]
    },
    {
      "id": "virtual-grid-viewport",
      "title": "Virtual Grid Viewport Model",
      "description": "Diagram showing the viewport concept: Large logical grid (e.g., 1000x1000 cells) with small visible viewport (e.g., 20x10 cells). Shows how DOM nodes are recycled as the user scrolls.",
      "type": "component",
      "relevant_sections": [
        "component-grid"
      ]
    }
  ]
}