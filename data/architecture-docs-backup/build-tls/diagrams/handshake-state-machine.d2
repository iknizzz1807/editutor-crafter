# TLS Handshake State Machine

# Initial and final states
start: {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  label: "START"
}

closed: {
  shape: circle
  style.fill: "#d63031"
  style.stroke: "#d63031"
  label: "CLOSED"
}

connected: {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  style.stroke-width: 3
  label: "CONNECTED"
}

# Client states
client_states: Client States {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  
  wait_sh: WAIT_SH {
    shape: circle
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
  }
  
  wait_ee: WAIT_EE {
    shape: circle
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
  }
  
  wait_cert_cr: WAIT_CERT_CR {
    shape: circle
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
  }
  
  wait_cv: WAIT_CV {
    shape: circle
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
  }
  
  wait_finished: WAIT_FINISHED {
    shape: circle
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
  }
}

# Server states
server_states: Server States {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  
  wait_ch: WAIT_CH {
    shape: circle
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
  }
  
  wait_eoed: WAIT_EOED {
    shape: circle
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
  }
  
  wait_flight2: WAIT_FLIGHT2 {
    shape: circle
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
  }
}

# Error states
error_states: Error States {
  style.fill: "#2d1b1b"
  style.stroke: "#d63031"
  
  alert_sent: ALERT_SENT {
    shape: circle
    style.fill: "#d63031"
    style.stroke: "#ff6b6b"
  }
  
  alert_received: ALERT_RECEIVED {
    shape: circle
    style.fill: "#d63031"
    style.stroke: "#ff6b6b"
  }
}

# Initial transitions
start -> server_states.wait_ch: "Server: Listen"
start -> client_states.wait_sh: "Client: Send ClientHello"

# Client flow transitions
client_states.wait_sh -> client_states.wait_ee: "Receive ServerHello"
client_states.wait_ee -> client_states.wait_cert_cr: "Receive EncryptedExtensions"
client_states.wait_cert_cr -> client_states.wait_cv: "Receive Certificate + CertificateRequest"
client_states.wait_cv -> client_states.wait_finished: "Receive CertificateVerify"
client_states.wait_finished -> connected: "Receive Finished"

# Server flow transitions  
server_states.wait_ch -> server_states.wait_eoed: "Receive ClientHello\nSend ServerHello + EE + Cert + CV + Finished"
server_states.wait_eoed -> server_states.wait_flight2: "Receive EndOfEarlyData"
server_states.wait_flight2 -> connected: "Receive Certificate + CV + Finished"

# Error transitions
client_states.wait_sh -> error_states.alert_sent: "Protocol violation\nCertificate error\nCrypto failure"
client_states.wait_ee -> error_states.alert_sent: "Invalid extensions\nDecryption failure"
client_states.wait_cert_cr -> error_states.alert_sent: "Certificate validation failed\nUnsupported certificate"
client_states.wait_cv -> error_states.alert_sent: "Signature verification failed\nInvalid CertificateVerify"
client_states.wait_finished -> error_states.alert_sent: "MAC verification failed\nInvalid Finished"

server_states.wait_ch -> error_states.alert_sent: "Invalid ClientHello\nUnsupported version\nNo common cipher"
server_states.wait_eoed -> error_states.alert_sent: "Unexpected message\nDecryption failure"
server_states.wait_flight2 -> error_states.alert_sent: "Client auth failed\nInvalid client certificate"

# Alert handling
error_states.alert_sent -> closed: "Send Alert"
error_states.alert_received -> closed: "Process Alert"

# Connection termination
connected -> error_states.alert_sent: "close_notify\nUser requested"
connected -> closed: "Normal close"

# Styling for arrows
client_states.wait_sh -> client_states.wait_ee: {
  style.stroke: "#3fb950"
}
client_states.wait_ee -> client_states.wait_cert_cr: {
  style.stroke: "#3fb950"  
}
server_states.wait_ch -> server_states.wait_eoed: {
  style.stroke: "#3fb950"
}