direction: right

vars: {
  d2-config: {
    dark-theme-id: 200
  }
}

initial: "" {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  width: 20
  height: 20
}

input_embeddings: "Input Embeddings\n(batch, seq_len, d_model)" {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

qkv_computation: "Q/K/V Computation\nLinear Transformations" {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

attention_scores: "Attention Scores\nQ @ K^T / sqrt(d_k)" {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

masking: "Apply Causal Mask\n(optional)" {
  shape: diamond
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

softmax: "Softmax Normalization\nAttention Weights" {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

weighted_output: "Weighted Output\nAttention @ V" {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

final_output: "Final Output\n(batch, seq_len, d_model)" {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

final: "" {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  width: 20
  height: 20
}

# State transitions
initial -> input_embeddings: "start"
input_embeddings -> qkv_computation: "transform to\nQ, K, V matrices"
qkv_computation -> attention_scores: "compute\ndot products"
attention_scores -> masking: "raw scores"
masking -> softmax: "masked\n(if causal)"
masking -> softmax: "unmasked\n(if bidirectional)" {
  style.stroke-dash: 5
}
softmax -> weighted_output: "normalized\nweights"
weighted_output -> final_output: "aggregate\nvalues"
final_output -> final: "complete"

# Style arrows
*.style.stroke: "#8b949e"
*.style.font-color: "#8b949e"