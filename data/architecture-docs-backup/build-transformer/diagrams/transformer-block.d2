title: Transformer Block Internal Structure

input: Input Embeddings {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

block: Transformer Block {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true

  ln1: Layer Norm 1 {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }

  attention: Multi-Head Self-Attention {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true

    q: Query
    k: Key
    v: Value
    heads: Multiple Heads
    
    q -> heads
    k -> heads
    v -> heads
  }

  add1: Add & Residual 1 {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    shape: circle
  }

  ln2: Layer Norm 2 {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }

  ffn: Feed-Forward Network {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true

    linear1: Linear Layer 1
    relu: ReLU/GELU
    linear2: Linear Layer 2
    
    linear1 -> relu
    relu -> linear2
  }

  add2: Add & Residual 2 {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    shape: circle
  }
}

output: Output Embeddings {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Main flow
input -> block.ln1: "x"
block.ln1 -> block.attention: "normalized x"
block.attention -> block.add1: "attention output"
block.add1 -> block.ln2: "x + attention"
block.ln2 -> block.ffn: "normalized"
block.ffn -> block.add2: "ffn output"
block.add2 -> output: "final output"

# Residual connections
input -> block.add1: "residual" {
  style.stroke: "#e17055"
  style.stroke-dash: 5
}

block.add1 -> block.add2: "residual" {
  style.stroke: "#e17055"
  style.stroke-dash: 5
}

note: |md
  **Key Components:**
  - Layer Norm applied before sublayers
  - Residual connections preserve information
  - Self-attention enables token communication
  - FFN processes each position independently
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}