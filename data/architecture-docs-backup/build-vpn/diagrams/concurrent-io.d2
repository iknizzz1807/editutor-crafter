direction: down

title: Concurrent I/O Multiplexing Event Loop {
  style.font-size: 20
  style.bold: true
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
}

event_loop: Event Loop {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  wait: Wait for Events\n(select/poll) {
    shape: oval
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  tun_ready: TUN Readable? {
    shape: diamond
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  udp_ready: UDP Readable? {
    shape: diamond
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  wait -> tun_ready: Events Available
  wait -> udp_ready: Events Available
}

tun_path: TUN Processing Path {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  read_packet: Read Packet\nfrom TUN {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  encrypt: Encrypt\nPacket {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  send_udp: Send UDP\nto Peer {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  read_packet -> encrypt: Success
  encrypt -> send_udp: Success
}

udp_path: UDP Processing Path {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  receive_udp: Receive UDP\nfrom Peer {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  decrypt: Decrypt\nPacket {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  write_tun: Write to\nTUN Interface {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  receive_udp -> decrypt: Success
  decrypt -> write_tun: Success
}

error_handler: Error Handling {
  style.fill: "#16213e"
  style.stroke: "#d63031"
  style.font-color: "#e6edf3"
  
  log_error: Log Error\n& Cleanup {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  
  retry_logic: Retry Logic {
    shape: diamond
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
  }
  
  log_error -> retry_logic
}

# Main flow connections
event_loop.wait -> event_loop.tun_ready
event_loop.wait -> event_loop.udp_ready

event_loop.tun_ready -> tun_path.read_packet: Yes
tun_path.send_udp -> event_loop.wait: Continue

event_loop.udp_ready -> udp_path.receive_udp: Yes
udp_path.write_tun -> event_loop.wait: Continue

# Error handling connections
tun_path.read_packet -> error_handler.log_error: Read Error {
  style.stroke: "#d63031"
  style.stroke-dash: 5
}
tun_path.encrypt -> error_handler.log_error: Encryption Error {
  style.stroke: "#d63031"
  style.stroke-dash: 5
}
tun_path.send_udp -> error_handler.log_error: Send Error {
  style.stroke: "#d63031"
  style.stroke-dash: 5
}

udp_path.receive_udp -> error_handler.log_error: Receive Error {
  style.stroke: "#d63031"
  style.stroke-dash: 5
}
udp_path.decrypt -> error_handler.log_error: Decryption Error {
  style.stroke: "#d63031"
  style.stroke-dash: 5
}
udp_path.write_tun -> error_handler.log_error: Write Error {
  style.stroke: "#d63031"
  style.stroke-dash: 5
}

error_handler.retry_logic -> event_loop.wait: Recoverable {
  style.stroke: "#8b949e"
}
error_handler.retry_logic -> error_handler.log_error: Fatal Error {
  style.stroke: "#d63031"
}

# No events path
event_loop.tun_ready -> event_loop.wait: No {
  style.stroke: "#8b949e"
}
event_loop.udp_ready -> event_loop.wait: No {
  style.stroke: "#8b949e"
}