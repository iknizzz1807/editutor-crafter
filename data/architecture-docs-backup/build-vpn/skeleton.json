{
  "title": "Build Your Own VPN: Design Document",
  "overview": "A custom VPN implementation that creates secure encrypted tunnels between clients and servers using TUN/TAP virtual interfaces, UDP transport, and authenticated encryption. The key architectural challenge is orchestrating low-level networking primitives (virtual interfaces, raw packet handling, routing tables) with cryptographic protocols to provide transparent network-level security.",
  "sections": [
    {
      "id": "context-problem",
      "title": "Context and Problem Statement",
      "summary": "Establishes the need for VPNs, explains how they work conceptually, and compares different VPN architectures and protocols.",
      "subsections": [
        {
          "id": "mental-model",
          "title": "Mental Model: The Secure Tunnel",
          "summary": "Uses the analogy of a secure underground tunnel between buildings to explain VPN concepts."
        },
        {
          "id": "existing-approaches",
          "title": "Existing VPN Approaches",
          "summary": "Compares IPSec, OpenVPN, WireGuard, and PPTP architectures with trade-offs analysis."
        },
        {
          "id": "technical-challenges",
          "title": "Core Technical Challenges",
          "summary": "Identifies the key problems: packet interception, encryption at scale, key management, and routing complexity."
        }
      ]
    },
    {
      "id": "goals-non-goals",
      "title": "Goals and Non-Goals",
      "summary": "Defines the scope of our VPN implementation, what features it includes and explicitly excludes.",
      "subsections": [
        {
          "id": "functional-goals",
          "title": "Functional Goals",
          "summary": "Core VPN functionality: secure tunneling, encryption, authentication, and routing."
        },
        {
          "id": "non-goals",
          "title": "Non-Goals",
          "summary": "Advanced features we won't implement: GUI clients, certificate authorities, enterprise management."
        }
      ]
    },
    {
      "id": "architecture-overview",
      "title": "High-Level Architecture",
      "summary": "Component overview showing how TUN interface, encryption engine, transport layer, and routing work together.",
      "subsections": [
        {
          "id": "component-responsibilities",
          "title": "Component Responsibilities",
          "summary": "Breaks down the system into TUN Manager, Crypto Engine, Transport Layer, and Route Manager."
        },
        {
          "id": "file-structure",
          "title": "Recommended File Structure",
          "summary": "Organizes the codebase into packages: tun, crypto, transport, routing, and main."
        },
        {
          "id": "data-flow",
          "title": "Packet Flow Overview",
          "summary": "Traces how packets flow from application through TUN interface, encryption, UDP transport, and back."
        }
      ]
    },
    {
      "id": "data-model",
      "title": "Data Model",
      "summary": "Defines all key data structures: packets, peers, sessions, encryption keys, and configuration.",
      "subsections": [
        {
          "id": "packet-structures",
          "title": "Packet Structures",
          "summary": "IP packets, encrypted packets, handshake messages, and their wire formats."
        },
        {
          "id": "session-state",
          "title": "Session and Peer State",
          "summary": "Connection state, peer information, encryption keys, and anti-replay windows."
        },
        {
          "id": "configuration",
          "title": "Configuration Model",
          "summary": "Server/client config, network settings, crypto parameters, and routing rules."
        }
      ]
    },
    {
      "id": "tun-interface",
      "title": "TUN Interface Management",
      "summary": "Creates and manages TUN virtual network interfaces for intercepting IP packets at the network layer.",
      "subsections": [
        {
          "id": "tun-mental-model",
          "title": "Mental Model: The Network Tap",
          "summary": "Explains TUN interfaces as a 'wiretap' on the network stack that lets us intercept packets."
        },
        {
          "id": "tun-operations",
          "title": "TUN Device Operations",
          "summary": "Creating TUN devices, configuring IP addresses, reading/writing packets, and cleanup."
        },
        {
          "id": "tun-pitfalls",
          "title": "Common TUN Pitfalls",
          "summary": "Root privileges, IFF_NO_PI flag, MTU considerations, and file descriptor lifecycle."
        }
      ]
    },
    {
      "id": "transport-layer",
      "title": "UDP Transport Layer",
      "summary": "Implements UDP-based transport for tunneling encrypted packets between VPN endpoints.",
      "subsections": [
        {
          "id": "transport-mental-model",
          "title": "Mental Model: The Delivery Service",
          "summary": "UDP transport as a delivery service that moves encrypted packages between VPN endpoints."
        },
        {
          "id": "peer-management",
          "title": "Peer Connection Management",
          "summary": "Tracking multiple peers, handling NAT traversal, and managing connection state."
        },
        {
          "id": "io-multiplexing",
          "title": "I/O Multiplexing",
          "summary": "Using select/poll to handle TUN and UDP sockets concurrently without blocking."
        }
      ]
    },
    {
      "id": "encryption-layer",
      "title": "Encryption and Authentication",
      "summary": "Implements AES-GCM authenticated encryption with proper nonce management and anti-replay protection.",
      "subsections": [
        {
          "id": "crypto-mental-model",
          "title": "Mental Model: The Secure Envelope",
          "summary": "Encryption as sealing packets in tamper-evident envelopes with unique serial numbers."
        },
        {
          "id": "aes-gcm-implementation",
          "title": "AES-GCM Implementation",
          "summary": "Authenticated encryption, nonce generation, and authentication tag verification."
        },
        {
          "id": "anti-replay",
          "title": "Anti-Replay Protection",
          "summary": "Sliding window algorithm to detect and reject replayed or out-of-order packets."
        },
        {
          "id": "crypto-pitfalls",
          "title": "Cryptographic Pitfalls",
          "summary": "Nonce reuse vulnerabilities, authentication tag verification, and key material handling."
        }
      ]
    },
    {
      "id": "key-exchange",
      "title": "Key Exchange and Session Management",
      "summary": "Implements Diffie-Hellman key exchange for establishing shared secrets and deriving session keys.",
      "subsections": [
        {
          "id": "keyexchange-mental-model",
          "title": "Mental Model: The Secret Handshake",
          "summary": "Key exchange as a secret handshake that establishes trust without revealing secrets."
        },
        {
          "id": "diffie-hellman",
          "title": "Diffie-Hellman Protocol",
          "summary": "Ephemeral key generation, public key exchange, and shared secret computation."
        },
        {
          "id": "key-derivation",
          "title": "Key Derivation and Management",
          "summary": "HKDF for deriving session keys, separate keys per direction, and key rotation."
        },
        {
          "id": "perfect-forward-secrecy",
          "title": "Perfect Forward Secrecy",
          "summary": "Ensuring past communications remain secure even if long-term keys are compromised."
        }
      ]
    },
    {
      "id": "routing-nat",
      "title": "Routing and Network Address Translation",
      "summary": "Configures system routing tables and NAT rules to route traffic through the VPN tunnel.",
      "subsections": [
        {
          "id": "routing-mental-model",
          "title": "Mental Model: The Traffic Director",
          "summary": "Routing as a traffic director that decides which road (interface) packets should take."
        },
        {
          "id": "route-table-manipulation",
          "title": "Route Table Manipulation",
          "summary": "Adding VPN routes, preserving server routes, and implementing split tunneling."
        },
        {
          "id": "nat-masquerading",
          "title": "NAT and Masquerading",
          "summary": "Server-side NAT configuration to allow VPN clients to access the internet."
        },
        {
          "id": "routing-pitfalls",
          "title": "Routing Pitfalls",
          "summary": "Avoiding lockouts, DNS leaks, IPv6 bypasses, and route table restoration."
        }
      ]
    },
    {
      "id": "interactions-flow",
      "title": "Component Interactions and Data Flow",
      "summary": "Describes how all components work together, message formats, and the complete packet journey.",
      "subsections": [
        {
          "id": "connection-establishment",
          "title": "Connection Establishment Flow",
          "summary": "Step-by-step process from initial handshake to established tunnel."
        },
        {
          "id": "packet-processing",
          "title": "Packet Processing Pipeline",
          "summary": "How packets flow through TUN \u2192 encrypt \u2192 UDP \u2192 decrypt \u2192 TUN on both sides."
        },
        {
          "id": "message-formats",
          "title": "Wire Protocol and Message Formats",
          "summary": "Binary formats for handshake messages, encrypted packets, and control messages."
        }
      ]
    },
    {
      "id": "error-handling",
      "title": "Error Handling and Edge Cases",
      "summary": "Covers failure modes, error detection, recovery strategies, and graceful degradation.",
      "subsections": [
        {
          "id": "network-failures",
          "title": "Network Failure Handling",
          "summary": "Connection timeouts, packet loss, network changes, and reconnection logic."
        },
        {
          "id": "crypto-failures",
          "title": "Cryptographic Failure Handling",
          "summary": "Authentication failures, key exchange errors, and nonce exhaustion."
        },
        {
          "id": "system-failures",
          "title": "System-Level Failures",
          "summary": "TUN interface errors, routing failures, and privilege escalation issues."
        }
      ]
    },
    {
      "id": "testing-strategy",
      "title": "Testing Strategy and Milestone Checkpoints",
      "summary": "Testing approaches for each component and milestone validation criteria.",
      "subsections": [
        {
          "id": "milestone-checkpoints",
          "title": "Milestone Validation",
          "summary": "How to verify each milestone is working correctly with specific commands and expected outputs."
        },
        {
          "id": "unit-testing",
          "title": "Unit Testing Strategy",
          "summary": "Testing individual components: crypto functions, packet parsing, routing logic."
        },
        {
          "id": "integration-testing",
          "title": "Integration Testing",
          "summary": "End-to-end testing with real network traffic, performance testing, and security validation."
        }
      ]
    },
    {
      "id": "debugging-guide",
      "title": "Debugging Guide",
      "summary": "Common problems, debugging techniques, and tools for troubleshooting VPN issues.",
      "subsections": [
        {
          "id": "common-symptoms",
          "title": "Common Symptoms and Diagnoses",
          "summary": "Symptom-cause-fix table for typical problems learners encounter."
        },
        {
          "id": "debugging-techniques",
          "title": "Debugging Techniques",
          "summary": "Using tcpdump, examining logs, testing crypto functions, and network diagnostics."
        },
        {
          "id": "troubleshooting-tools",
          "title": "Troubleshooting Tools",
          "summary": "Network tools (ping, traceroute, netstat) and VPN-specific debugging approaches."
        }
      ]
    },
    {
      "id": "future-extensions",
      "title": "Future Extensions",
      "summary": "Potential enhancements and how the current design accommodates them.",
      "subsections": [
        {
          "id": "performance-optimizations",
          "title": "Performance Optimizations",
          "summary": "Multi-threading, zero-copy packet processing, and hardware acceleration."
        },
        {
          "id": "protocol-enhancements",
          "title": "Protocol Enhancements",
          "summary": "Certificate-based authentication, advanced key exchange, and congestion control."
        },
        {
          "id": "operational-features",
          "title": "Operational Features",
          "summary": "Configuration management, monitoring, logging, and client management interfaces."
        }
      ]
    },
    {
      "id": "glossary",
      "title": "Glossary",
      "summary": "Definitions of technical terms, acronyms, and domain-specific vocabulary.",
      "subsections": []
    }
  ],
  "diagrams": [
    {
      "id": "system-architecture",
      "title": "VPN System Architecture",
      "description": "High-level component diagram showing TUN Manager, Crypto Engine, Transport Layer, Route Manager, and their connections. Include external entities like Operating System, Network Stack, and Remote Peers.",
      "type": "component",
      "relevant_sections": [
        "architecture-overview",
        "interactions-flow"
      ]
    },
    {
      "id": "packet-flow",
      "title": "Packet Processing Flow",
      "description": "Flowchart showing how packets move through the system: Application \u2192 Network Stack \u2192 TUN Interface \u2192 Encryption \u2192 UDP Socket \u2192 Network \u2192 Remote VPN \u2192 Decryption \u2192 Remote TUN \u2192 Remote Network Stack \u2192 Remote Application.",
      "type": "flowchart",
      "relevant_sections": [
        "interactions-flow",
        "tun-interface",
        "transport-layer"
      ]
    },
    {
      "id": "data-model",
      "title": "Data Model Relationships",
      "description": "Class diagram showing key data structures: VPNSession, Peer, EncryptedPacket, HandshakeMessage, RouteEntry, and their relationships. Include fields and associations between classes.",
      "type": "class",
      "relevant_sections": [
        "data-model"
      ]
    },
    {
      "id": "key-exchange-sequence",
      "title": "Key Exchange Protocol Sequence",
      "description": "Sequence diagram for Diffie-Hellman key exchange between VPN client and server. Shows ephemeral key generation, public key exchange, shared secret computation, and session key derivation.",
      "type": "sequence",
      "relevant_sections": [
        "key-exchange",
        "interactions-flow"
      ]
    },
    {
      "id": "session-state-machine",
      "title": "VPN Session State Machine",
      "description": "State machine diagram showing session states: Disconnected \u2192 Handshaking \u2192 Connected \u2192 Rekeying \u2192 Disconnected. Include events like Start Handshake, Receive Public Key, Authentication Success/Failure, Key Rotation Timer.",
      "type": "state-machine",
      "relevant_sections": [
        "key-exchange",
        "error-handling"
      ]
    },
    {
      "id": "encryption-flow",
      "title": "Packet Encryption/Decryption Flow",
      "description": "Flowchart showing encryption process: IP Packet \u2192 Generate Nonce \u2192 AES-GCM Encrypt \u2192 Add Headers \u2192 UDP Send, and reverse for decryption with authentication tag verification and anti-replay check.",
      "type": "flowchart",
      "relevant_sections": [
        "encryption-layer",
        "interactions-flow"
      ]
    },
    {
      "id": "routing-setup",
      "title": "Routing Table Configuration",
      "description": "Component diagram showing routing changes: Original Routes, VPN Routes, NAT Rules, and how they interact with Network Interfaces (eth0, tun0), Default Gateway, and VPN Server.",
      "type": "component",
      "relevant_sections": [
        "routing-nat"
      ]
    },
    {
      "id": "concurrent-io",
      "title": "Concurrent I/O Multiplexing",
      "description": "Flowchart showing select/poll event loop: Wait for Events \u2192 TUN Readable \u2192 Read Packet \u2192 Encrypt \u2192 Send UDP \u2192 UDP Readable \u2192 Receive \u2192 Decrypt \u2192 Write TUN, with error handling paths.",
      "type": "flowchart",
      "relevant_sections": [
        "transport-layer",
        "tun-interface"
      ]
    }
  ]
}