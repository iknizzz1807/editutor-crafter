title: Error Handling: State Machine

direction: right

# States
states: {
  Receiving {
    style: {
      fill: "#0f3460"
      stroke: "#3fb950"
      font-color: "#e6edf3"
      bold: true
    }
  }

  In_Middleware: In Middleware {
    style: {
      fill: "#0f3460"
      stroke: "#3fb950"
      font-color: "#e6edf3"
    }
  }

  Routing {
    style: {
      fill: "#0f3460"
      stroke: "#3fb950"
      font-color: "#e6edf3"
    }
  }

  In_Handler: In Handler {
    style: {
      fill: "#0f3460"
      stroke: "#3fb950"
      font-color: "#e6edf3"
    }
  }

  Rendering {
    style: {
      fill: "#0f3460"
      stroke: "#3fb950"
      font-color: "#e6edf3"
    }
  }

  Sending {
    shape: circle
    style: {
      fill: "#0f3460"
      stroke: "#3fb950"
      font-color: "#e6edf3"
      double-border: true
    }
  }

  Error {
    style: {
      fill: "#1a1a2e"
      stroke: "#ff7b72"
      font-color: "#e6edf3"
      bold: true
    }
  }
}

# Initial and final states
start: {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
}
end: {
  shape: circle
  style.double-border: true
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
}

# Transitions
start -> Receiving

Receiving -> In_Middleware: "request received"
In_Middleware -> Routing: "next()"
Routing -> In_Handler: "route matched"
In_Handler -> Rendering: "send response"
Rendering -> Sending: "response ready"

# Error transitions
In_Middleware -> Error: "throw error"
Routing -> Error: "throw error" {style.stroke: "#ff7b72"}
In_Handler -> Error: "throw error" {style.stroke: "#ff7b72"}
Rendering -> Error: "throw error" {style.stroke: "#ff7b72"}

# Error recovery
Error -> Rendering: "error response ready" {style.stroke: "#ff7b72"}

# Early exit transitions
In_Middleware -> Rendering: "send response"
In_Handler -> Sending: "direct send" {style.stroke-dash: 3}
Error -> Sending: "send error" {style.stroke: "#ff7b72"}

# Notes
note: |md
  ## Request Processing Flow
  - Normal flow follows solid green arrows
  - Error flow follows red arrows
  - Dashed arrows indicate bypass paths
| {
  style: {
    fill: "#1a1a2e"
    stroke: "#8b949e"
    font-color: "#e6edf3"
  }
}