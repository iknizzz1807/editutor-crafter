Title: Stack and Frame Memory Layout
Stack and Frame Memory Layout: Diagram showing how the single Value array is partitioned between the operand stack and local variable slots for multiple active call frames.

classes: {
  memory_cell: {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.stroke-width: 1
    style.font-color: "#e6edf3"
  }
  frame_header: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.stroke-width: 2
    style.bold: true
  }
  pointer: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    shape: circle
    width: 20
    height: 20
    style.bold: true
  }
  array_container: {
    style.stroke: "#8b949e"
    style.stroke-width: 2
    style.double-border: true
  }
  current_frame: {
    style.stroke: "#ff7de9"
    style.stroke-width: 2
  }
}

vm_memory: VM Memory (Single Value Array) {
  class: array_container
  shape: rectangle

  index_labels: {
    shape: text
    index_0: "Index 0"
    index_dots: "..."
    index_n: "Index N-1"
  }

  entire_array: Entire Value Array {
    shape: rectangle
    style.fill: "#1a1a2e"
    style.stroke-dash: 3
    style.stroke: "#8b949e"
  }

  frame_0: Call Frame 0 (Previous) {
    shape: rectangle
    class: frame_header
    label: "Call Frame 0 (Previous)"

    frame_0_locals: {
      shape: rectangle
      label: "Local Variables"
      class: memory_cell
      style.fill: "#0f3460"

      local_0: "Local[0]" {class: memory_cell}
      local_1: "Local[1]" {class: memory_cell}
      local_2: "..." {class: memory_cell; style.fill: transparent}
      local_n: "Local[n]" {class: memory_cell}
    }

    frame_0_stack: {
      shape: rectangle
      label: "Operand Stack (Fixed Size)"
      class: memory_cell
      style.fill: "#1e3a5f"

      stack_slot_0: "Stack[0]" {class: memory_cell}
      stack_slot_1: "Stack[1]" {class: memory_cell}
      stack_slot_2: "..." {class: memory_cell; style.fill: transparent}
      stack_slot_m: "Stack[m]" {class: memory_cell}
    }

    frame_0_locals -> frame_0_stack: "Frame allocation" {
      style.stroke: "#8b949e"
      style.stroke-dash: 2
    }
  }

  frame_1: Call Frame 1 (Current) {
    shape: rectangle
    class: frame_header
    class: current_frame
    label: "Call Frame 1 (Current)"

    frame_1_locals: {
      shape: rectangle
      label: "Local Variables"
      class: memory_cell
      style.fill: "#0f3460"

      local_0_current: "Local[0]" {class: memory_cell}
      local_1_current: "Local[1]" {class: memory_cell}
      local_2_current: "..." {class: memory_cell; style.fill: transparent}
      local_k_current: "Local[k]" {class: memory_cell}
    }

    frame_1_stack: {
      shape: rectangle
      label: "Operand Stack (Active/Growing)"
      class: memory_cell
      style.fill: "#1e3a5f"

      stack_slot_0_current: "Stack[0]" {class: memory_cell}
      stack_slot_1_current: "Stack[1]" {class: memory_cell}
      stack_slot_2_current: "..." {class: memory_cell; style.fill: transparent}
      stack_top: "Top (SP)" {
        class: memory_cell
        style.fill: "#3fb950"
        style.stroke: "#3fb950"
        style.bold: true
      }
      stack_growth_zone: "Unused (Growth)" {
        class: memory_cell
        style.fill: transparent
        style.stroke-dash: 2
        style.stroke: "#8b949e"
      }
    }

    frame_1_locals -> frame_1_stack: "Frame allocation" {
      style.stroke: "#ff7de9"
      style.stroke-dash: 2
    }
  }

  sp: Stack Pointer {
    class: pointer
    label: "SP"
  }

  fp: Frame Pointer {
    class: pointer
    label: "FP"
  }

  sp_arrow: sp -> frame_1.frame_1_stack.stack_top: "points to"
  fp_arrow: fp -> frame_1.frame_1_locals.local_0_current: "points to"

  growth_arrow: "Stack grows this direction" {
    shape: text
  }
}

note: |md
  ## Memory Layout Key Points
  - **Single contiguous array** of Value objects
  - **Frames allocated sequentially** in array
  - Each frame: **Locals (fixed)** + **Operand Stack (variable)**
  - **SP (Stack Pointer)**: Tracks top of current operand stack
  - **FP (Frame Pointer)**: Points to start of current frame's locals
  - Previous frames' stacks become **inactive/fixed size**
| {
  shape: page
  style.fill: "#16213e"
  style.stroke: "#3fb950"
}
