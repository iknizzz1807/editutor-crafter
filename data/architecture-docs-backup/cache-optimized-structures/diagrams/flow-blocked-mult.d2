title: Blocked Matrix Multiplication Loop Flow

# Main container
flowchart: {
  # Start node
  start: Start {
    shape: circle
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }

  # Outer loop (i_block)
  i_loop: "For i_block = 0 to rows with step BLOCK_SIZE" {
    shape: diamond
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }

  # Middle loop (j_block)
  j_loop: "For j_block = 0 to columns with step BLOCK_SIZE" {
    shape: diamond
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }

  # Inner loop (k_block)
  k_loop: "For k_block = 0 to depth with step BLOCK_SIZE" {
    shape: diamond
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }

  # Extract submatrices
  extract: "Extract submatrices:\nA_block = A[i_block:i_block+BLOCK, k_block:k_block+BLOCK]\nB_block = B[k_block:k_block+BLOCK, j_block:j_block+BLOCK]\nC_block = C[i_block:i_block+BLOCK, j_block:j_block+BLOCK]" {
    shape: rectangle
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }

  # Naive multiplication
  multiply: "Perform naive multiplication:\nC_block += A_block × B_block" {
    shape: rectangle
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }

  # Store result
  store: "Store C_block back to C matrix" {
    shape: rectangle
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }

  # End node
  end: End {
    shape: circle
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }

  # Loop increment labels
  i_increment: "i_block += BLOCK_SIZE" {
    style.font-color: "#8b949e"
  }

  j_increment: "j_block += BLOCK_SIZE" {
    style.font-color: "#8b949e"
  }

  k_increment: "k_block += BLOCK_SIZE" {
    style.font-color: "#8b949e"
  }

  # Note explaining block access
  note: |md
    **Blocked Multiplication Benefits:**
    - Accesses A by rows within block (temporal locality)
    - Accesses B by columns within block (spatial locality)
    - C block stays in cache (temporal locality)
  | {
    shape: page
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

# Connections with labels
start -> i_loop

# Outer loop flow
i_loop -> j_loop: "i_block < rows"
i_loop -> end: "i_block ≥ rows"

# Middle loop flow
j_loop -> k_loop: "j_block < columns"
j_loop -> i_increment: "j_block ≥ columns"
i_increment -> i_loop

# Inner loop flow
k_loop -> extract: "k_block < depth"
k_loop -> j_increment: "k_block ≥ depth"
j_increment -> j_loop

# Inner block operations
extract -> multiply
multiply -> k_increment
k_increment -> k_loop

# Store after inner k_loop completes
k_loop -> store: "After k_loop (via j_increment path)"
store -> j_increment: "Indirectly through j_increment"

# Style the arrows
direction: right
connections.style.stroke: "#8b949e"
connections.style.font-color: "#8b949e"
