direction: down

volcano_iterator_pipeline: {
  shape: rectangle
  label: "Volcano Iterator Model Pipeline (Pull-Based Execution)"
  style: {
    fill: "#1a1a2e"
    stroke: "#3fb950"
    font-color: "#e6edf3"
  }

  projection: {
    shape: class
    label: "Projection\n- open()\n- next()\n- close()"
    style: {
      bold: true
      stroke-width: 3
      stroke: "#3fb950"
    }
  }

  hash_join: {
    shape: class
    label: "HashJoin\n- open()\n- next()\n- close()"
    style.bold: true
  }

  seq_scan: {
    shape: class
    label: "SeqScan\n- open()\n- next()\n- close()"
  }

  index_scan: {
    shape: class
    label: "IndexScan\n- open()\n- next()\n- close()"
  }

  physical_op_interface: {
    shape: class
    label: "PhysicalOp Trait"
    style: {
      fill: "#0f3460"
      stroke: "#8b949e"
    }
    
    methods: {
      shape: text
      label: "open(&mut self, context: &QueryContext) -> Result<()>\nnext(&mut self) -> Result<Option<Row>>\nclose(&mut self) -> Result<()>"
    }
  }

  projection -> hash_join: "next() call (pull)"
  hash_join -> seq_scan: "next() call (pull left)"
  hash_join -> index_scan: "next() call (pull right)"

  seq_scan -> hash_join: "rows" {
    style.stroke-dash: 3
    style.stroke: "#8b949e"
  }
  index_scan -> hash_join: "rows" {
    style.stroke-dash: 3
    style.stroke: "#8b949e"
  }
  hash_join -> projection: "joined rows" {
    style.stroke-dash: 3
    style.stroke: "#8b949e"
  }

  projection -> physical_op_interface: "implements" {
    style.stroke: "#8b949e"
  }
}

notes: {
  shape: text
  width: 400
  label: "## How It Works\n\n1. **Pull-Based Model**: Each operator implements the PhysicalOp trait\n2. **Lazy Execution**: Root (Projection) drives execution by calling next()\n3. **Pipeline Flow**: Data flows upward as operators pull from children\n4. **Memory Efficient**: Only processes what's needed, when needed\n5. **Natural Backpressure**: No operator produces more than parent consumes"
  style: {
    fill: "#16213e"
    stroke: "#8b949e"
    font-color: "#e6edf3"
  }
}