direction: right

# Title
title: CI/CD Pipeline and Deployment Flow {
  near: top-center
  style.font-size: 24
  style.bold: true
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
}

# Source Control
git: Git Repository {
  shape: package
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Independent Service Pipelines
pipeline: CI/CD Pipeline {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  trigger: Trigger {
    shape: diamond
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }

  services: Service Builds {
    users: Users Service
    products: Products Service
    orders: Orders Service
    payments: Payments Service
    
    users.style.fill: "#1a1a2e"
    users.style.stroke: "#8b949e"
    users.style.font-color: "#e6edf3"
    
    products.style.fill: "#1a1a2e"
    products.style.stroke: "#8b949e"
    products.style.font-color: "#e6edf3"
    
    orders.style.fill: "#1a1a2e"
    orders.style.stroke: "#8b949e"
    orders.style.font-color: "#e6edf3"
    
    payments.style.fill: "#1a1a2e"
    payments.style.stroke: "#8b949e"
    payments.style.font-color: "#e6edf3"
  }

  test: Test & Build {
    shape: hexagon
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }

  trigger -> services.users: changed
  trigger -> services.products: changed
  trigger -> services.orders: changed
  trigger -> services.payments: changed
  
  services.users -> test
  services.products -> test
  services.orders -> test
  services.payments -> test
}

# Blue-Green Deployment
deployment: Blue-Green Deployment {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  blue: Blue Environment {
    shape: cloud
    style.fill: "#0066cc"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
  }

  green: Green Environment {
    shape: cloud
    style.fill: "#009900"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
  }

  switch: Traffic Switch {
    shape: diamond
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }

  lb: Load Balancer {
    shape: hexagon
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }

  green -> switch: ready
  switch -> lb: route traffic
  lb -> blue: 0% traffic
  lb -> green: 100% traffic
}

# Canary Release
canary: Canary Release {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  stage1: 5% Traffic {
    shape: circle
    style.fill: "#ff6b35"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
  }

  stage2: 25% Traffic {
    shape: circle
    style.fill: "#ff6b35"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
  }

  stage3: 50% Traffic {
    shape: circle
    style.fill: "#ff6b35"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
  }

  stage4: 100% Traffic {
    shape: circle
    style.fill: "#00cc66"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
  }

  monitor: Health Monitor {
    shape: page
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }

  stage1 -> stage2: healthy
  stage2 -> stage3: healthy
  stage3 -> stage4: healthy
  monitor -> stage1: check
  monitor -> stage2: check
  monitor -> stage3: check
}

# Rollback System
rollback: Automatic Rollback {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  alerts: Alert Triggers {
    error: Error Rate > 5%
    latency: Latency > 2s
    health: Health Check Fail
    
    error.style.fill: "#d63031"
    error.style.stroke: "#3fb950"
    error.style.font-color: "#ffffff"
    
    latency.style.fill: "#d63031"
    latency.style.stroke: "#3fb950"
    latency.style.font-color: "#ffffff"
    
    health.style.fill: "#d63031"
    health.style.stroke: "#3fb950"
    health.style.font-color: "#ffffff"
  }

  decision: Rollback? {
    shape: diamond
    style.fill: "#d63031"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
    style.bold: true
  }

  restore: Restore Previous {
    shape: hexagon
    style.fill: "#00cc66"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
  }

  alerts.error -> decision: trigger
  alerts.latency -> decision: trigger
  alerts.health -> decision: trigger
  decision -> restore: yes
}

# Main Flow Connections
git -> pipeline.trigger: push/PR
pipeline.test -> deployment.green: deploy
deployment.lb -> canary.stage1: or canary
canary.monitor -> rollback.alerts.error: metrics
canary.monitor -> rollback.alerts.latency: metrics
canary.monitor -> rollback.alerts.health: metrics
rollback.restore -> deployment.blue: revert