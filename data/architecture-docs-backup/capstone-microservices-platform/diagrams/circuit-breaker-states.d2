direction: right

# Initial state
initial: "" {
  shape: circle
  style.fill: "#e6edf3"
  style.stroke: "#3fb950"
  style.font-color: "#1a1a2e"
  width: 20
  height: 20
}

# States
closed: "CLOSED\n(Normal Operation)" {
  shape: oval
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

open: "OPEN\n(Failing Fast)" {
  shape: oval
  style.fill: "#d63031"
  style.stroke: "#e17055"
  style.font-color: "#ffffff"
  style.bold: true
}

half_open: "HALF-OPEN\n(Testing Recovery)" {
  shape: oval
  style.fill: "#fdcb6e"
  style.stroke: "#e17055"
  style.font-color: "#1a1a2e"
  style.bold: true
}

# Transitions
initial -> closed: "Initialize"

closed -> open: "Failure count ≥ threshold\n(consecutive failures)"
open -> half_open: "Timeout expired\n(recovery attempt)"
half_open -> closed: "Success\n(reset failure count)"
half_open -> open: "Failure detected\n(restart timer)"

# Self loops for maintaining state
closed -> closed: "Request success\n(reset failure count)" {
  style.stroke: "#3fb950"
  style.stroke-dash: 5
}

closed -> closed: "Request failure\n(increment count < threshold)" {
  style.stroke: "#e17055"
  style.stroke-dash: 5
}

open -> open: "Request blocked\n(fail fast)" {
  style.stroke: "#d63031"
  style.stroke-dash: 5
}

# Legend
legend: "Circuit Breaker State Machine" {
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  style.font-size: 16
  style.bold: true
  
  notes: |md
    **State Behaviors:**
    • CLOSED: Normal operation, counts failures
    • OPEN: All requests fail immediately
    • HALF-OPEN: Single test request allowed
    
    **Key Parameters:**
    • Failure threshold (e.g., 5 failures)
    • Timeout duration (e.g., 60 seconds)
  | {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}