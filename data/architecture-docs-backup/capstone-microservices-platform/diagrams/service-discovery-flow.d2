title: Service Discovery Registration and Lookup {
  style.font-size: 18
  style.bold: true
}

# Service instances
service_a: Service A Instance {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

service_b: Service B Instance {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

client_service: Client Service {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

# Service Registry
registry: Service Registry {
  shape: cylinder
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

# Decision points
health_check: Health Check OK? {
  shape: diamond
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

service_available: Service Available? {
  shape: diamond
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

# Actions
startup: Service Startup {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

register: Register with Registry {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

heartbeat: Send Heartbeat {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

deregister: Deregister Service {
  shape: rectangle
  style.fill: "#d63031"
  style.stroke: "#e17055"
  style.font-color: "#ffffff"
}

lookup: Lookup Service {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

call_service: Call Service Instance {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

# Registration flow
startup -> register: 1
register -> registry: POST /services {
  style.stroke: "#3fb950"
}
registry -> heartbeat: 2

# Health check loop
heartbeat -> registry: PUT /health {
  style.stroke: "#3fb950"
}
registry -> health_check: 3
health_check -> heartbeat: Yes (continue) {
  style.stroke: "#3fb950"
}
health_check -> deregister: No (timeout/failure) {
  style.stroke: "#d63031"
}

# Service lookup flow
client_service -> lookup: Need Service B
lookup -> registry: GET /services/B {
  style.stroke: "#8b949e"
}
registry -> service_available: 4
service_available -> call_service: Yes (return instances) {
  style.stroke: "#3fb950"
}
call_service -> service_b: HTTP request {
  style.stroke: "#3fb950"
}

# Service instances connect to registry
service_a -> registry: register & heartbeat {
  style.stroke: "#3fb950"
  style.stroke-dash: 3
}
service_b -> registry: register & heartbeat {
  style.stroke: "#3fb950"
  style.stroke-dash: 3
}

# Notes
registration_note: |md
  **Registration Process:**
  1. Service starts up
  2. Registers with service registry
  3. Begins sending heartbeats
  4. Auto-deregistered on failure
| {
  shape: page
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

lookup_note: |md
  **Lookup Process:**
  1. Client needs to call service
  2. Queries registry for instances
  3. Gets healthy endpoint list
  4. Makes direct service call
| {
  shape: page
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}