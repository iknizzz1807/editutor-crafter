direction: right

vm_cycle: VM Instruction Execution Cycle {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  start: Start {
    shape: circle
    style.fill: "#3fb950"
    style.font-color: "#1a1a2e"
  }
  
  fetch: Fetch Instruction {
    shape: oval
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  decode: Decode Instruction {
    shape: oval
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  execute: Execute Operation {
    shape: oval
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  update_stack: Update Stack {
    shape: oval
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  gc_check: Check GC Trigger {
    shape: diamond
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  gc_run: Run Garbage Collector {
    shape: oval
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  
  halt_check: Program Halt? {
    shape: diamond
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  end: End {
    shape: circle
    style.fill: "#8b949e"
    style.stroke: "#3fb950"
    style.font-color: "#1a1a2e"
  }
  
  start -> fetch: "IP -> current instruction"
  fetch -> decode: "parse opcode & operands"
  decode -> execute: "perform operation"
  execute -> update_stack: "push/pop results"
  update_stack -> gc_check: "check heap usage"
  gc_check -> gc_run: "threshold exceeded" {
    style.stroke: "#d63031"
    style.font-color: "#d63031"
  }
  gc_check -> halt_check: "under threshold" {
    style.stroke: "#3fb950"
    style.font-color: "#3fb950"
  }
  gc_run -> halt_check: "collection complete"
  halt_check -> fetch: "continue execution" {
    style.stroke: "#8b949e"
  }
  halt_check -> end: "HALT instruction" {
    style.stroke: "#e17055"
    style.font-color: "#e17055"
  }
}