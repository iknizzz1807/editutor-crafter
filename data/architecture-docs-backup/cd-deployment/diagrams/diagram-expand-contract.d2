direction: right

title: Flowchart: Expand-Contract Database Migration

# Define styling classes
classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.stroke-width: 2
  }
  decision: {
    shape: diamond
    style.fill: "#16213e"
    style.stroke: "#e17055"
    style.font-color: "#e6edf3"
    style.stroke-width: 2
  }
  phase: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.stroke-width: 3
    style.bold: true
  }
  note: {
    shape: page
    style.fill: "#2d3436"
    style.stroke: "#fd79a8"
    style.font-color: "#dfe6e9"
  }
}

# Start
start: Start {
  shape: circle
  style.fill: "#3fb950"
  label: ""
}

# Phase 1: Expand
phase_1: "Phase 1: Expand" {
  class: phase

  expand: Add nullable new column to table {
    class: process
  }

  note_1: "Backward compatible: old code continues to work\nNew column is nullable, so writes from old code don't break" {
    class: note
  }
}

# Phase 2: Deploy
phase_2: "Phase 2: Deploy New Code" {
  class: phase

  deploy: Deploy application update that uses new column {
    class: process
  }

  write_both: "New code writes to both columns\n(optional but recommended)" {
    class: process
  }

  read_new: "New code reads from new column" {
    class: process
  }

  note_2: "Backward compatibility window:\nBoth old and new columns exist\nCode can operate with either schema" {
    class: note
  }
}

# Phase 3: Contract
phase_3: "Phase 3: Contract" {
  class: phase

  backfill: Backfill data from old to new column {
    class: process
  }

  verify: Verify data migration completed successfully {
    class: decision
  }

  drop: Drop old column from table {
    class: process
  }

  note_3: "Backward compatibility ends:\nOld column removed, only new schema remains" {
    class: note
  }
}

# End
end: End {
  shape: circle
  style.fill: "#ff6b6b"
  label: ""
}

# Connections
start -> phase_1.expand

phase_1.expand -> phase_2.deploy
phase_2.deploy -> phase_2.write_both
phase_2.write_both -> phase_2.read_new
phase_2.read_new -> phase_3.backfill

phase_3.backfill -> phase_3.verify
phase_3.verify -> phase_3.drop: "Yes"
phase_3.verify -> phase_3.backfill: "No" {
  style.stroke-dash: 3
}
phase_3.drop -> end

# Timeline indicator
timeline: {
  backward_compat_start: "Backward Compatible Period Starts" {
    style.font-color: "#81ecec"
    style.italic: true
  }

  backward_compat_end: "Backward Compatible Period Ends" {
    style.font-color: "#fab1a0"
    style.italic: true
  }

  backward_compat_start -> backward_compat_end: "Migration Safety Window" {
    style.stroke: "#fd79a8"
    style.stroke-dash: 5
    style.font-color: "#fd79a8"
  }
}

# Timeline shapes are positioned automatically
