title: "Data Model: Cache Entry & Relationships"

classes: {
  dark_theme: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  class_style: {
    shape: class
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

"Data Model: Cache Entry & Relationships": {
  class: dark_theme
  style.stroke-width: 3

  cache_entry: CacheEntry {
    class: class_style
    - "key: string (primary_key)"
    - "headers: Dictionary of string to string"
    - "body: byte list"
    - "expires_at: datetime"
    - "tags: string list"
    - "created_at: datetime"
    - "last_accessed_at: datetime"
    - "access_count: int"
    + "is_expired(): bool"
    + "should_evict(max_age: int): bool"
  }

  surrogate_key_index: SurrogateKeyIndex {
    class: class_style
    - "surrogate_key: string (primary_key)"
    - "cache_entry_keys: string list"
    - "created_at: datetime"
    + "add_entry(key: string): void"
    + "remove_entry(key: string): void"
    + "get_entries(): string list"
  }

  ban_rule: BanRule {
    class: class_style
    - "id: int (primary_key)"
    - "pattern: string"
    - "created_at: datetime"
    - "expires_at: datetime or null"
    - "created_by: string"
    - "reason: string"
    + "matches(url: string): bool"
    + "is_active(): bool"
  }

  cache_entry -> surrogate_key_index: "tags (many-to-many)" {
    style.stroke: "#8b949e"
    style.stroke-dash: 3
    style.animated: true
  }

  ban_rule -> cache_entry: "invalidates matching entries" {
    style.stroke: "#8b949e"
    style.stroke-dash: 2
  }

  note: "**Relationships:**\n- Each `CacheEntry` has 0 or more `tags` (surrogate keys)\n- Each `SurrogateKeyIndex` entry tracks all cache entries with that tag\n- `BanRule` patterns invalidate matching cache entries" {
    shape: page
    style.fill: "#1a1a2e"
    style.font-color: "#e6edf3"
  }
}