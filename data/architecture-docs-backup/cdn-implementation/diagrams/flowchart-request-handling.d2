title: Flowchart: Edge Node Request Handling

direction: right

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    shape: diamond
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  terminal: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

incoming_request: "Incoming HTTP Request" {
  shape: circle
  class: terminal
}

parse_request: "1. Parse Request" {
  class: process
}
incoming_request -> parse_request

generate_cache_key: "2. Generate Cache Key" {
  class: process
}
parse_request -> generate_cache_key

check_cache: "3. Check Cache" {
  class: process
}
generate_cache_key -> check_cache

cache_hit_decision: "Cache Hit?" {
  class: decision
}
check_cache -> cache_hit_decision

cache_hit_decision -> validate_cache: "Yes (Hit)" {
  style.stroke-dash: 0
}
cache_hit_decision -> fetch_miss: "No (Miss)" {
  style.stroke-dash: 3
}

validate_cache: "4. Validate (304 Logic)" {
  class: process
}
validate_cache -> conditional_request_check: "Check Conditional Headers\n(If-None-Match, If-Modified-Since)"

conditional_request_check: "Conditional Request?" {
  class: decision
}

conditional_request_check -> fresh_check: "Yes" {
  label: "Validate with Origin"
}
conditional_request_check -> apply_compression: "No" {
  label: "Use Cached Response"
}

fresh_check: "Cached Copy Fresh?" {
  class: decision
}
fresh_check -> respond_304: "Yes" {
  label: "Return 304 Not Modified"
}
fresh_check -> fetch_miss: "No (Stale)" {
  label: "Requires Revalidation"
}

fetch_miss: "5. Fetch from Shield/Origin" {
  class: process
}
fetch_miss -> origin_response_check: "Fetch Response"

origin_response_check: "Origin Response OK?" {
  class: decision
}
origin_response_check -> store_in_cache: "Yes (200 OK)" {
  label: "Cacheable Response"
}
origin_response_check -> respond_error: "No" {
  label: "Error (4xx/5xx)"
}

store_in_cache: "6. Store in Cache" {
  class: process
}
origin_response_check -> store_in_cache

store_in_cache -> apply_compression

apply_compression: "7. Apply Compression" {
  class: process
}
apply_compression -> compression_check: "Check Accept-Encoding"

compression_check: "Compressible & Supported?" {
  class: decision
}
compression_check -> compress_response: "Yes"
compression_check -> final_response: "No"

compress_response: "Compress (gzip/brotli)" {
  class: process
}
compress_response -> final_response

final_response: "8. Final Response" {
  class: process
}

respond_304: "Respond 304 Not Modified" {
  class: terminal
}
respond_304 -> send_response

respond_error: "Respond Error" {
  class: terminal
}
respond_error -> send_response

send_response: "Send HTTP Response to Client" {
  shape: circle
  class: terminal
}
final_response -> send_response