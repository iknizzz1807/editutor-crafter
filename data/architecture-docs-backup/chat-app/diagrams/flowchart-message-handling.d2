title: "Flowchart: Server Message Handling"

classes: {
  process: {
    shape: rectangle
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    shape: diamond
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  error_node: {
    style.fill: "#1a1a2e"
    style.stroke: "#ff6b6b"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  end_node: {
    shape: circle
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

start: Receive raw message from socket {
  class: end_node
}

parse_json: Parse JSON {
  class: process
}

parse_ok: Valid JSON? {
  class: decision
}

parse_error: Send error response {
  class: error_node
}

validate_fields: Validate required fields (type, payload) {
  class: process
}

fields_ok: Fields valid? {
  class: decision
}

validation_error: Send error response {
  class: error_node
}

lookup_handler: Look up handler for message type {
  class: process
}

handler_found: Handler exists? {
  class: decision
}

lookup_error: Send error response {
  class: error_node
}

execute_handler: Execute handler (e.g., broadcast, join) {
  class: process
}

execution_ok: Execution successful? {
  class: decision
}

handler_error: Log and send error {
  class: error_node
}

end_success: End {
  class: end_node
}

# Flow connections
start -> parse_json
parse_json -> parse_ok
parse_ok -> parse_error: No (invalid JSON)
parse_ok -> validate_fields: Yes (valid JSON)
parse_error -> end_success

validate_fields -> fields_ok
fields_ok -> validation_error: No (missing/invalid)
fields_ok -> lookup_handler: Yes (valid)
validation_error -> end_success

lookup_handler -> handler_found
handler_found -> lookup_error: No (not found)
handler_found -> execute_handler: Yes (found)
lookup_error -> end_success

execute_handler -> execution_ok
execution_ok -> handler_error: No (error)
execution_ok -> end_success: Yes (success)
handler_error -> end_success