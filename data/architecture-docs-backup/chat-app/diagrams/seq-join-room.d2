shape: sequence_diagram

title: Sequence: User Joining a Room

New Client: {
  label: "New Client\n(WebSocket Client)"
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
WebSocket Server: {
  label: "WebSocket Server"
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
Room Manager: {
  label: "Room Manager\n(in-memory state)"
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
Persistence: {
  label: "Persistence\n(Message Store)"
  shape: cylinder
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

New Client -> WebSocket Server: "join {room: room_name}"

WebSocket Server -> WebSocket Server: Validate user session

WebSocket Server -> Room Manager: "joinRoom(room_name, user_id)"

Room Manager -> Room Manager: Add user to room member list

Room Manager -> Persistence: "fetchLastNMessages(room_name, N=50)"

Persistence -> Room Manager: "[messages]"

Room Manager -> WebSocket Server: "broadcast(user_joined, {user_id, room_name})"

WebSocket Server -> New Client: "room_joined {success: true, messages}"
