shape: sequence_diagram

Client: {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

CircuitBreaker: {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

DownstreamService: {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

MetricsCollector: {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

Client -> CircuitBreaker: request (CLOSED state)
CircuitBreaker -> DownstreamService: forward request
DownstreamService -> CircuitBreaker: success response
CircuitBreaker -> MetricsCollector: record success
CircuitBreaker -> Client: return response

Client -> CircuitBreaker: request (CLOSED state)
CircuitBreaker -> DownstreamService: forward request
DownstreamService -> CircuitBreaker: error response
CircuitBreaker -> MetricsCollector: record failure
CircuitBreaker -> CircuitBreaker: check failure threshold
CircuitBreaker -> Client: return error

Client -> CircuitBreaker: request (failure threshold exceeded)
CircuitBreaker -> CircuitBreaker: transition to OPEN
CircuitBreaker -> MetricsCollector: record state change
CircuitBreaker -> Client: fail fast (circuit open)

Client -> CircuitBreaker: request (OPEN state)
CircuitBreaker -> MetricsCollector: record rejected request
CircuitBreaker -> Client: fail fast (circuit open)

Client -> CircuitBreaker: request (timeout period elapsed)
CircuitBreaker -> CircuitBreaker: transition to HALF_OPEN
CircuitBreaker -> DownstreamService: test request
DownstreamService -> CircuitBreaker: success response
CircuitBreaker -> CircuitBreaker: transition to CLOSED
CircuitBreaker -> MetricsCollector: record state change
CircuitBreaker -> Client: return response