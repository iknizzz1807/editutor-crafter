shape: sequence_diagram

classes: {
  process_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  error_style: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  success_style: {
    style.fill: "#00b894"
    style.stroke: "#00cec9"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

parent: Parent Process {
  class: process_style
}
kernel: Linux Kernel {
  class: process_style
}
child: Child Process {
  class: process_style
}
cgroup: Cgroup Subsystem {
  class: process_style
}

parent -> kernel: clone(CLONE_NEWPID | CLONE_NEWNS | CLONE_NEWUTS)
kernel -> parent: new_pid (host PID)
parent -> cgroup: create cgroup hierarchy
cgroup -> parent: cgroup created
parent -> cgroup: set memory/cpu limits
cgroup -> parent: limits configured
parent -> cgroup: add process to cgroup
cgroup -> parent: process added

kernel -> child: fork() - PID namespace active
child -> child: PID = 1 (in namespace)
child -> kernel: mount new /proc
kernel -> child: /proc mounted
child -> kernel: setup hostname (UTS namespace)
kernel -> child: hostname configured
child -> kernel: chroot to container rootfs
kernel -> child: filesystem root changed

child -> parent: signal ready (pipe/socket)
parent -> child: exec container command
child -> kernel: execve("/bin/sh", ...)
kernel -> child: process replaced

child -> parent: running normally
parent -> child: monitor via waitpid()

child -> kernel: exit(0)
kernel -> parent: SIGCHLD
parent -> cgroup: cleanup cgroup
cgroup -> parent: cgroup removed
parent -> parent: container shutdown complete

kernel -> parent: namespace creation failed {
  class: error_style
}
parent -> parent: cleanup and exit {
  class: error_style
}

cgroup -> parent: cgroup setup failed {
  class: error_style
}
parent -> kernel: kill child process {
  class: error_style
}
parent -> parent: cleanup and exit {
  class: error_style
}

child -> parent: setup failed {
  class: error_style
}
child -> kernel: exit(1) {
  class: error_style
}
kernel -> parent: SIGCHLD (error) {
  class: error_style
}
parent -> parent: cleanup and report error {
  class: error_style
}