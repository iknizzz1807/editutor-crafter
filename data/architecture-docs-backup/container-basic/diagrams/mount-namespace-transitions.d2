title: Mount Namespace and Pivot Root Process

classes: {
  filesystem: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  process: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  mount_point: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  transition: {
    style.stroke: "#3fb950"
    style.font-color: "#3fb950"
    style.bold: true
  }
}

initial_state: Initial Process View {
  class: filesystem
  
  host_root: Host Root (/) {
    class: mount_point
  }
  
  host_proc: /proc {
    class: mount_point
  }
  
  host_sys: /sys {
    class: mount_point
  }
  
  container_image: Container Image {
    class: mount_point
  }
  
  host_root -> host_proc
  host_root -> host_sys
}

namespace_creation: Mount Namespace Created {
  class: filesystem
  
  copied_mounts: Copied Mount Table {
    class: mount_point
  }
  
  isolated_proc: Process in New Namespace {
    class: process
  }
  
  copied_mounts -> isolated_proc: "isolated view"
}

pivot_operation: Pivot Root Operation {
  shape: diamond
  class: transition
}

final_state: Container View After Pivot {
  class: filesystem
  
  new_root: Container Root (/) {
    class: mount_point
    style.fill: "#3fb950"
  }
  
  new_proc: /proc {
    class: mount_point
  }
  
  old_root: /old_root {
    class: mount_point
    style.stroke: "#8b949e"
    style.stroke-dash: 3
  }
  
  container_proc: Container Process {
    class: process
  }
  
  new_root -> new_proc
  new_root -> old_root: "hidden host filesystem"
  new_root -> container_proc: "sees only container view"
}

cleanup: Unmount Old Root {
  shape: diamond
  class: transition
}

isolated_view: Final Isolated Container {
  class: filesystem
  
  container_root: Container Root (/) {
    class: mount_point
    style.fill: "#3fb950"
  }
  
  container_proc_final: /proc {
    class: mount_point
  }
  
  final_process: Fully Isolated Process {
    class: process
  }
  
  container_root -> container_proc_final
  container_root -> final_process: "complete isolation"
}

initial_state -> namespace_creation: "clone(CLONE_NEWNS)"
namespace_creation -> pivot_operation: "prepare new root"
pivot_operation -> final_state: "pivot_root(new, old)"
final_state -> cleanup: "umount old root"
cleanup -> isolated_view: "complete isolation"

note: |md
  ## Mount Namespace Process
  
  1. **Initial State**: Process sees host filesystem
  2. **Namespace Creation**: New mount namespace with copied mount table
  3. **Pivot Root**: Swap old and new root filesystems
  4. **Cleanup**: Remove access to old host filesystem
  5. **Isolation**: Process sees only container filesystem
| {
  shape: page
  class: mount_point
  near: bottom-right
}