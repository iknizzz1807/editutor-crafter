title: OverlayFS Layer Structure {
  near: top-center
  style.font-size: 18
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  layer: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  directory: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  mount: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.double-border: true
  }
  file: {
    style.fill: "#2d3748"
    style.stroke: "#a0aec0"
    style.font-color: "#e6edf3"
    shape: page
  }
}

image_layers: Image Layers (Read-Only) {
  class: layer
  
  base_layer: Base Layer\n/var/lib/containers/layers/base {
    class: directory
    base_files: |md
      **Files:**
      - /bin/sh
      - /lib/libc.so
      - /etc/passwd
    | {
      class: file
    }
  }
  
  app_layer: App Layer\n/var/lib/containers/layers/app {
    class: directory
    app_files: |md
      **Files:**
      - /usr/bin/myapp
      - /etc/myapp.conf
    | {
      class: file
    }
  }
}

container_dirs: Container Directories {
  class: layer
  
  upper_dir: Upper Directory (Writable)\n/var/lib/containers/overlay/upper {
    class: directory
    modified_files: |md
      **Modified Files:**
      - /etc/passwd (copy-on-write)
      - /tmp/newfile.txt (new)
    | {
      class: file
    }
  }
  
  work_dir: Work Directory\n/var/lib/containers/overlay/work {
    class: directory
    temp_note: Temporary files during\ncopy-on-write operations {
      style.fill: "#4a5568"
      style.font-color: "#e6edf3"
      style.stroke: "#8b949e"
      shape: page
    }
  }
}

overlayfs_mount: OverlayFS Mount {
  class: mount
  
  merged_view: Merged View\n/var/lib/containers/overlay/merged {
    class: directory
    final_files: |md
      **Container sees:**
      - /bin/sh (from base)
      - /usr/bin/myapp (from app)
      - /etc/passwd (from upper)
      - /tmp/newfile.txt (from upper)
    | {
      class: file
    }
  }
}

mount_process: mount -t overlay overlay\n-o lowerdir=base:app,upperdir=upper,workdir=work\nmerged {
  shape: page
  style.fill: "#2d3748"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

image_layers.base_layer -> overlayfs_mount: lower layer 1
image_layers.app_layer -> overlayfs_mount: lower layer 2
container_dirs.upper_dir -> overlayfs_mount: upper layer
container_dirs.work_dir -> overlayfs_mount: work dir
mount_process -> overlayfs_mount.merged_view: creates

cow_flow: Copy-on-Write Flow {
  style.fill: "#1a1a2e"
  style.stroke: "#ffa500"
  style.font-color: "#e6edf3"
  
  read_op: Read Operation {
    class: directory
  }
  
  write_op: Write Operation {
    class: directory
  }
  
  read_op -> image_layers: 1. Check lower layers
  image_layers -> overlayfs_mount.merged_view: 2. Return file content
  
  write_op -> container_dirs.upper_dir: 1. Copy file to upper
  container_dirs.upper_dir -> overlayfs_mount.merged_view: 2. Modify in upper
}