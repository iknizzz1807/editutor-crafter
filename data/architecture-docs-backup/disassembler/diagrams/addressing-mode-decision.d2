title: "ModRM and SIB Addressing Mode Decision Tree" {
  style.font-size: 20
  style.bold: true
  near: top-center
}

classes: {
  decision: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950" 
    style.font-color: "#e6edf3"
    style.bold: true
  }
  process: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  important: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

start: Start ModRM Decode {
  shape: circle
  class: important
}

mod_check: "Check MOD Field\n(bits 7-6)" {
  shape: diamond
  class: decision
}

mod_00: "MOD = 00\nMemory Reference\nNo Displacement" {
  class: process
}

mod_01: "MOD = 01\nMemory Reference\n8-bit Displacement" {
  class: process
}

mod_10: "MOD = 10\nMemory Reference\n32-bit Displacement" {
  class: process
}

mod_11: "MOD = 11\nDirect Register\nReference" {
  class: process
}

rm_check: "Check R/M Field\n(bits 2-0)" {
  shape: diamond
  class: decision
}

rm_100: "R/M = 100\nSIB Byte Required" {
  class: important
}

rm_101_special: "R/M = 101\nSpecial Case" {
  class: important
}

direct_memory: "Direct Memory\nReference\n\"[reg]\"" {
  class: process
}

disp8_memory: "Memory + Disp8\n\"[reg + disp8]\"" {
  class: process
}

disp32_memory: "Memory + Disp32\n\"[reg + disp32]\"" {
  class: process
}

register_direct: "Register Direct\nreg" {
  class: process
}

rip_relative: "RIP Relative\n\"[RIP + disp32]\"" {
  class: important
}

sib_decode: SIB Byte Decode {
  shape: diamond
  class: decision
}

scale_check: "Check Scale\n(bits 7-6)" {
  shape: diamond
  class: decision
}

index_check: "Check Index\n(bits 5-3)" {
  shape: diamond
  class: decision
}

base_check: "Check Base\n(bits 2-0)" {
  shape: diamond
  class: decision
}

sib_result: "\"[base + index*scale + disp]\"" {
  class: important
}

no_index: "Index = 100\nNo Index Register" {
  class: process
}

no_base: "Base = 101\nNo Base Register" {
  class: process
}

start -> mod_check

mod_check -> mod_00: "00"
mod_check -> mod_01: "01"
mod_check -> mod_10: "10"
mod_check -> mod_11: "11"

mod_00 -> rm_check
mod_01 -> rm_check
mod_10 -> rm_check

rm_check -> rm_100: "100"
rm_check -> rm_101_special: "101 & MOD=00"
rm_check -> direct_memory: other

mod_01 -> disp8_memory: non-SIB
mod_10 -> disp32_memory: non-SIB
mod_11 -> register_direct

rm_101_special -> rip_relative: 64-bit mode

rm_100 -> sib_decode
sib_decode -> scale_check
scale_check -> index_check: "1/2/4/8"
index_check -> base_check: valid index
index_check -> no_index: "100"
base_check -> sib_result: valid base
base_check -> no_base: "101"

no_index -> sib_result
no_base -> sib_result