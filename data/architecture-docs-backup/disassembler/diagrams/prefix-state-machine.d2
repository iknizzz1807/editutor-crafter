title: Prefix Processing State Machine

classes: {
  state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  final_state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
    style.double-border: true
  }
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

init: {
  shape: circle
  style.fill: "#3fb950"
  label: ""
}

start: Start {
  shape: circle
  class: state
}

group1: Group 1\n(Lock/Rep) {
  shape: circle
  class: state
}

group2: Group 2\n(Segment) {
  shape: circle
  class: state
}

group3: Group 3\n(Op Size) {
  shape: circle
  class: state
}

group4: Group 4\n(Addr Size) {
  shape: circle
  class: state
}

rex: REX\nPrefix {
  shape: circle
  class: state
}

vex: VEX/EVEX\nPrefix {
  shape: circle
  class: state
}

ready: Ready for\nOpcode {
  shape: circle
  class: final_state
}

error: Invalid\nSequence {
  shape: circle
  style.fill: "#d63031"
  style.stroke: "#e17055"
  style.font-color: "#ffffff"
  style.bold: true
}

init -> start: Begin {
  class: transition
}

start -> group1: F0,F2,F3\n(Lock/Rep) {
  class: transition
}

start -> group2: 2E,36,3E,26\n64,65 (Segment) {
  class: transition
}

start -> group3: 66 (Op Size) {
  class: transition
}

start -> group4: 67 (Addr Size) {
  class: transition
}

start -> rex: 40-4F (REX) {
  class: transition
}

start -> vex: C4,C5,62 (VEX) {
  class: transition
}

start -> ready: Opcode Byte {
  class: transition
}

group1 -> group2: 2E,36,3E,26\n64,65 (Segment) {
  class: transition
}

group1 -> group3: 66 (Op Size) {
  class: transition
}

group1 -> group4: 67 (Addr Size) {
  class: transition
}

group1 -> rex: 40-4F (REX) {
  class: transition
}

group1 -> ready: Opcode Byte {
  class: transition
}

group2 -> group3: 66 (Op Size) {
  class: transition
}

group2 -> group4: 67 (Addr Size) {
  class: transition
}

group2 -> rex: 40-4F (REX) {
  class: transition
}

group2 -> ready: Opcode Byte {
  class: transition
}

group3 -> group4: 67 (Addr Size) {
  class: transition
}

group3 -> rex: 40-4F (REX) {
  class: transition
}

group3 -> ready: Opcode Byte {
  class: transition
}

group4 -> rex: 40-4F (REX) {
  class: transition
}

group4 -> ready: Opcode Byte {
  class: transition
}

rex -> ready: Opcode Byte {
  class: transition
}

vex -> ready: Multi-byte\nSequence {
  class: transition
}

group1 -> error: F0,F2,F3\n(Duplicate) {
  class: transition
  style.stroke: "#d63031"
}

group2 -> error: 2E,36,3E,26\n64,65 (Duplicate) {
  class: transition
  style.stroke: "#d63031"
}

group3 -> error: 66 (Duplicate) {
  class: transition
  style.stroke: "#d63031"
}

group4 -> error: 67 (Duplicate) {
  class: transition
  style.stroke: "#d63031"
}

rex -> error: REX/VEX\nAfter REX {
  class: transition
  style.stroke: "#d63031"
}

vex -> error: Any Prefix\nAfter VEX {
  class: transition
  style.stroke: "#d63031"
}