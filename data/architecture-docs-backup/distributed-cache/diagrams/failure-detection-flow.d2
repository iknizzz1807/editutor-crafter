title: Failure Detection and Recovery Process {
  style.font-size: 18
  style.bold: true
  style.font-color: "#e6edf3"
  near: top-center
}

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  critical: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  timeout: {
    style.fill: "#fdcb6e"
    style.stroke: "#e17055"
    style.font-color: "#2d3436"
  }
}

detection: Detection Phase {
  class: process
  
  heartbeat_miss: Missing Heartbeat {
    class: process
  }
  
  request_timeout: Request Timeout {
    class: timeout
  }
  
  gossip_report: Gossip Failure Report {
    class: process
  }
  
  health_check: Health Check Failure {
    class: process
  }
}

verification: Verification {
  shape: diamond
  class: decision
  label: "Multiple\nReports?"
}

timeout_check: Timeout Check {
  shape: diamond
  class: decision
  label: "Grace Period\nExpired?"
}

mark_failed: Mark Node as Failed {
  class: critical
}

gossip_propagation: Gossip Propagation {
  class: process
  
  spread_failure: Spread Failure News {
    class: process
  }
  
  update_membership: Update Membership View {
    class: process
  }
  
  consensus_check: Consensus Check {
    shape: diamond
    class: decision
    label: "Cluster\nConsensus?"
  }
}

ring_rebalancing: Ring Rebalancing {
  class: process
  
  calculate_new_ranges: Calculate New Key Ranges {
    class: process
  }
  
  update_hash_ring: Update Hash Ring {
    class: process
  }
  
  notify_clients: Notify Clients of Changes {
    class: process
  }
}

data_recovery: Data Recovery {
  class: process
  
  identify_replicas: Identify Available Replicas {
    class: process
  }
  
  replica_check: Replica Check {
    shape: diamond
    class: decision
    label: "Replicas\nAvailable?"
  }
  
  restore_data: Restore from Replicas {
    class: process
  }
  
  data_loss: Data Loss Event {
    class: critical
  }
  
  rebuild_replicas: Rebuild Missing Replicas {
    class: process
  }
}

complete: Recovery Complete {
  class: process
  style.double-border: true
}

wait_retry: Wait and Retry {
  class: timeout
}

# Detection flows
detection.heartbeat_miss -> verification: report
detection.request_timeout -> verification: report
detection.gossip_report -> verification: report
detection.health_check -> verification: report

# Verification flows
verification -> timeout_check: Yes
verification -> wait_retry: No
timeout_check -> mark_failed: Yes
timeout_check -> wait_retry: No
wait_retry -> detection: retry

# Main process flow
mark_failed -> gossip_propagation: propagate

# Gossip flows
gossip_propagation.spread_failure -> gossip_propagation.update_membership: update
gossip_propagation.update_membership -> gossip_propagation.consensus_check: check
gossip_propagation.consensus_check -> ring_rebalancing: Yes
gossip_propagation.consensus_check -> wait_retry: No

# Ring rebalancing flows
ring_rebalancing.calculate_new_ranges -> ring_rebalancing.update_hash_ring: apply
ring_rebalancing.update_hash_ring -> ring_rebalancing.notify_clients: notify
ring_rebalancing.notify_clients -> data_recovery: proceed

# Data recovery flows
data_recovery.identify_replicas -> data_recovery.replica_check: check
data_recovery.replica_check -> data_recovery.restore_data: Yes
data_recovery.replica_check -> data_recovery.data_loss: No
data_recovery.restore_data -> data_recovery.rebuild_replicas: rebuild
data_recovery.data_loss -> data_recovery.rebuild_replicas: rebuild
data_recovery.rebuild_replicas -> complete: done