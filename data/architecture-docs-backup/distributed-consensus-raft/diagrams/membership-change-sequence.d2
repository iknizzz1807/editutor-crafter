title: Joint Consensus Membership Change {
  style.font-color: "#e6edf3"
  near: top-center
}

shape: sequence_diagram

client: Client
leader: Leader
node1: Node 1
node2: Node 2
node3: Node 3
node4: Node 4 (new)
node5: Node 5 (new)

client -> leader: "Membership change request\n[Remove Node 3, Add Nodes 4,5]"
leader -> leader: "Create C_old,new entry\n[Nodes 1,2,3 + Nodes 1,2,4,5]"

leader -> node1: "AppendEntries(C_old,new)"
leader -> node2: "AppendEntries(C_old,new)"
leader -> node3: "AppendEntries(C_old,new)"
leader -> node4: "AppendEntries(C_old,new)"
leader -> node5: "AppendEntries(C_old,new)"

node1 -> leader: Success
node2 -> leader: Success
node3 -> leader: Success
node4 -> leader: Success

leader -> leader: "Joint consensus achieved\n(majority in both configs)"

leader -> node1: "AppendEntries(C_new only)"
leader -> node2: "AppendEntries(C_new only)"
leader -> node4: "AppendEntries(C_new only)"
leader -> node5: "AppendEntries(C_new only)"

node1 -> leader: Success
node2 -> leader: Success
node4 -> leader: Success
node5 -> leader: Success

leader -> leader: "Transition complete\nNode 3 removed"

leader -> client: Membership change successful

classes: {
  phase_marker: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

phase1: "Phase 1: Joint Consensus\n[C_old,new: both configs active]" {
  shape: text
  class: phase_marker
  near: center-left
}

phase2: "Phase 2: New Configuration\n[C_new: old config removed]" {
  shape: text
  class: phase_marker
  near: bottom-left
}