title: Raft Node State Machine

classes: {
  state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  initial: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#1a1a2e"
  }
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

init: {
  shape: circle
  class: initial
  label: ""
}

follower: Follower {
  shape: circle
  class: state
}

candidate: Candidate {
  shape: circle
  class: state
}

leader: Leader {
  shape: circle
  class: state
}

init -> follower: Start {
  class: transition
}

follower -> candidate: Election timeout {
  class: transition
}

follower -> follower: Receive valid heartbeat\nReset election timer {
  class: transition
}

follower -> follower: Receive vote request\nwith higher term {
  class: transition
}

candidate -> follower: Receive message\nwith higher term {
  class: transition
}

candidate -> leader: Receive majority\nof votes {
  class: transition
}

candidate -> candidate: Election timeout\nStart new election {
  class: transition
}

candidate -> follower: Discover current leader\nor new term {
  class: transition
}

leader -> follower: Discover server\nwith higher term {
  class: transition
}

leader -> leader: Send heartbeats\nto all followers {
  class: transition
}

leader -> leader: Receive client request\nAppend to log {
  class: transition
}

actions: Actions {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  follower_actions: |md
    **Follower Actions:**
    • Reset election timer on heartbeat
    • Vote for candidate if criteria met
    • Reject stale requests
    • Apply committed entries
  | {
    shape: page
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
  
  candidate_actions: |md
    **Candidate Actions:**
    • Increment term and vote for self
    • Send vote requests to all nodes
    • Count votes received
    • Reset election timer
  | {
    shape: page
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
  
  leader_actions: |md
    **Leader Actions:**
    • Send periodic heartbeats
    • Accept client requests
    • Replicate log entries
    • Commit entries when safe
  | {
    shape: page
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
}