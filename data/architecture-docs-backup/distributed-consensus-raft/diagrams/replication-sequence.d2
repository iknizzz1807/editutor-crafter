direction: down

title: Log Replication Sequence

# Participants
client: Client {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

leader: Leader {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

follower1: Follower 1 {
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

follower2: Follower 2 {
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

# Request flow
client -> leader: |md
  1. Client Request
  
  command: "SET x=5"
|

# Leader processing
leader -> leader: |md
  2. Append to local log
  
  index: 10, term: 3
|

# Replication to followers
leader -> follower1: |md
  3a. AppendEntries RPC
  
  prevLogIndex: 9
  prevLogTerm: 3
  entry: "SET x=5"
|

leader -> follower2: |md
  3b. AppendEntries RPC
  
  prevLogIndex: 9
  prevLogTerm: 3
  entry: "SET x=5"
|

# Follower responses
follower1 -> follower1: |md
  4a. Verify log consistency
  
  Append entry to log
|

follower2 -> follower2: |md
  4b. Verify log consistency
  
  Append entry to log
|

follower1 -> leader: |md
  5a. AppendEntries Response
  
  success: true
  matchIndex: 10
|

follower2 -> leader: |md
  5b. AppendEntries Response
  
  success: true
  matchIndex: 10
|

# Leader commits
leader -> leader: |md
  6. Commit entry
  
  commitIndex: 10
  Apply to state machine
|

# Notify followers
leader -> follower1: |md
  7a. Next AppendEntries
  
  leaderCommit: 10
|

leader -> follower2: |md
  7b. Next AppendEntries
  
  leaderCommit: 10
|

# Followers commit
follower1 -> follower1: |md
  8a. Update commitIndex
  
  Apply to state machine
|

follower2 -> follower2: |md
  8b. Update commitIndex
  
  Apply to state machine
|

# Final response
leader -> client: |md
  9. Response
  
  success: true
|

# Legend
legend: |md
  ## Legend

  - **RPC**: Remote Procedure Call
  - **Commit**: Entry is considered committed by majority
  - **Apply**: Entry is applied to state machine
| {
  shape: page
  near: top-right
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}
