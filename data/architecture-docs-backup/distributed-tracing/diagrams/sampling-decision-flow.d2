title: Sampling Decision Flow

classes: {
  decision: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  endpoint: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

start: Incoming Span {
  shape: circle
  class: process
}

head_check: Head-based Sampling? {
  shape: diamond
  class: decision
}

rate_check: Rate Limit Check {
  shape: diamond
  class: decision
}

error_check: Error Present? {
  shape: diamond
  class: decision
}

service_check: Critical Service? {
  shape: diamond
  class: decision
}

keep_head: Keep Span {
  class: process
}

buffer_span: Buffer for Tail {
  class: process
}

tail_complete: Trace Complete? {
  shape: diamond
  class: decision
}

tail_error: Has Errors? {
  shape: diamond
  class: decision
}

tail_latency: High Latency? {
  shape: diamond
  class: decision
}

tail_rare: Rare Operation? {
  shape: diamond
  class: decision
}

keep_tail: Keep Trace {
  class: process
}

drop: Drop {
  class: endpoint
  style.fill: "#d63031"
  style.font-color: "#ffffff"
}

store: Store in Backend {
  class: endpoint
  style.fill: "#00b894"
  style.font-color: "#ffffff"
}

start -> head_check

head_check -> rate_check: Yes
head_check -> buffer_span: No

rate_check -> error_check: Within Rate
rate_check -> drop: Exceeded

error_check -> keep_head: Yes
error_check -> service_check: No

service_check -> keep_head: Yes
service_check -> drop: No

keep_head -> store

buffer_span -> tail_complete

tail_complete -> tail_error: Yes
tail_complete -> buffer_span: No (wait)

tail_error -> keep_tail: Yes
tail_error -> tail_latency: No

tail_latency -> keep_tail: Yes
tail_latency -> tail_rare: No

tail_rare -> keep_tail: Yes
tail_rare -> drop: No

keep_tail -> store