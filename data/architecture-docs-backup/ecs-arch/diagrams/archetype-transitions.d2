shape: sequence_diagram

classes: {
  ecs_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  action_style: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  data_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

Entity: Entity {
  class: ecs_style
}

World: World {
  class: ecs_style
}

SourceArchetype: Source Archetype {
  class: action_style
}

TargetArchetype: Target Archetype {
  class: action_style
}

ComponentStorage: Component Storage {
  class: data_style
}

EntityIndex: Entity Index {
  class: data_style
}

Entity -> World: add_component(entity, component)
World -> EntityIndex: get_archetype(entity)
EntityIndex -> World: current_archetype_id
World -> SourceArchetype: get_entity_data(entity)
SourceArchetype -> World: component_data
World -> TargetArchetype: find_or_create_archetype(new_signature)
TargetArchetype -> World: target_archetype_id
World -> ComponentStorage: allocate_space(target_archetype)
ComponentStorage -> World: new_storage_location
World -> TargetArchetype: move_entity_data(entity, component_data)
TargetArchetype -> ComponentStorage: store_components(entity, data)
World -> SourceArchetype: remove_entity(entity)
SourceArchetype -> ComponentStorage: compact_storage()
World -> EntityIndex: update_mapping(entity, target_archetype)
EntityIndex -> World: mapping_updated
World -> Entity: component_added