direction: right

classes: {
  decision: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  process: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  storage: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  optimized: {
    style.fill: "#2d5016"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

start: Start {
  shape: circle
  class: process
}

check_threshold: Check Event Count\nThreshold? {
  shape: diamond
  class: decision
}

load_request: Load Aggregate\nRequest {
  shape: rectangle
  class: process
}

snapshot_exists: Snapshot\nExists? {
  shape: diamond
  class: decision
}

create_snapshot: Create New\nSnapshot {
  shape: rectangle
  class: process
}

load_from_events: Load from\nEvent Store\n(Full Replay) {
  shape: rectangle
  class: process
}

load_from_snapshot: Load from\nSnapshot {
  shape: rectangle
  class: optimized
}

load_recent_events: Load Events\nAfter Snapshot {
  shape: rectangle
  class: optimized
}

apply_events: Apply Events\nto Snapshot State {
  shape: rectangle
  class: optimized
}

save_snapshot: Save New\nSnapshot {
  shape: rectangle
  class: storage
}

return_aggregate: Return Loaded\nAggregate {
  shape: rectangle
  class: process
}

event_store: Event Store {
  shape: cylinder
  class: storage
}

snapshot_store: Snapshot Store {
  shape: cylinder
  class: storage
}

start -> load_request
load_request -> snapshot_exists
snapshot_exists -> load_from_snapshot: "Yes"
snapshot_exists -> load_from_events: "No"

load_from_snapshot -> load_recent_events
load_recent_events -> apply_events
apply_events -> check_threshold

load_from_events -> check_threshold

check_threshold -> create_snapshot: "Threshold\nReached"
check_threshold -> return_aggregate: "Below\nThreshold"

create_snapshot -> save_snapshot
save_snapshot -> return_aggregate

return_aggregate

event_store -> load_from_events: replay all
event_store -> load_recent_events: recent events
snapshot_store -> load_from_snapshot: latest state
save_snapshot -> snapshot_store: store