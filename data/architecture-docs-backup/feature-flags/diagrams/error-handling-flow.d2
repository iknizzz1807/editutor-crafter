title: Error Handling and Fallback Flow {
  near: top-center
  style.font-size: 18
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#f39c12"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  fallback: {
    style.fill: "#0f3460"
    style.stroke: "#e74c3c"
    style.font-color: "#e6edf3"
  }
  success: {
    style.fill: "#27ae60"
    style.stroke: "#2ecc71"
    style.font-color: "#ffffff"
  }
}

start: Start {
  shape: circle
  class: success
}

evaluate: Evaluate Flag Request {
  class: process
}

service_check: Service Available? {
  shape: diamond
  class: decision
}

network_check: Network Accessible? {
  shape: diamond
  class: decision
}

rules_check: Rules Valid? {
  shape: diamond
  class: decision
}

cache_check: Cache Available? {
  shape: diamond
  class: decision
}

fallback_container: Fallback Strategies {
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  
  use_cache: Use Cached Values {
    class: fallback
  }
  
  default_values: Apply Default Values {
    class: fallback
  }
  
  retry_logic: Retry with Backoff {
    class: fallback
  }
  
  circuit_breaker: Circuit Breaker Active {
    class: fallback
  }
}

error_scenarios: Error Scenarios {
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  
  service_down: Service Unavailable {
    class: fallback
  }
  
  network_fail: Network Timeout {
    class: fallback
  }
  
  malformed: Malformed Rules {
    class: fallback
  }
  
  cache_miss: Cache Miss {
    class: fallback
  }
}

success_response: Return Flag Value {
  class: success
}

degraded_response: Return Degraded Response {
  class: fallback
}

log_error: Log Error & Metrics {
  class: process
}

# Main flow
start -> evaluate
evaluate -> service_check

# Service availability path
service_check -> network_check: Yes
service_check -> fallback_container.circuit_breaker: No

# Network check path
network_check -> rules_check: Yes
network_check -> fallback_container.retry_logic: No

# Rules validation path
rules_check -> success_response: Valid
rules_check -> cache_check: Invalid

# Cache fallback path
cache_check -> fallback_container.use_cache: Yes
cache_check -> fallback_container.default_values: No

# Error scenario connections
error_scenarios.service_down -> fallback_container.circuit_breaker
error_scenarios.network_fail -> fallback_container.retry_logic
error_scenarios.malformed -> fallback_container.default_values
error_scenarios.cache_miss -> fallback_container.default_values

# Fallback outcomes
fallback_container.use_cache -> degraded_response
fallback_container.default_values -> degraded_response
fallback_container.retry_logic -> evaluate: Retry
fallback_container.circuit_breaker -> degraded_response

# Error logging
degraded_response -> log_error
success_response -> log_error: Success metrics