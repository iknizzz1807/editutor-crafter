shape: sequence_diagram

client: Client
upload_manager: Upload Manager
session_store: Session Store
storage_backend: Storage Backend

client -> upload_manager: "POST /files (create upload session)"
upload_manager -> session_store: "create_session(file_info)"
session_store -> upload_manager: "session_id, upload_url"
upload_manager -> client: "201 Created (Location: upload_url)"

client -> upload_manager: "PATCH /files/{id} (upload chunk)"
upload_manager -> session_store: "get_session(id)"
session_store -> upload_manager: session_info
upload_manager -> upload_manager: "validate_chunk_offset()"
upload_manager -> storage_backend: "write_chunk(data, offset)"
storage_backend -> upload_manager: chunk_written
upload_manager -> session_store: "update_offset(new_offset)"
session_store -> upload_manager: updated
upload_manager -> client: "204 No Content (Upload-Offset: bytes)"

client -> upload_manager: "HEAD /files/{id} (check progress)"
upload_manager -> session_store: "get_session(id)"
session_store -> upload_manager: session_info
upload_manager -> client: "200 OK (Upload-Offset: bytes)"

client -> upload_manager: "PATCH /files/{id} (final chunk)"
upload_manager -> session_store: "get_session(id)"
session_store -> upload_manager: session_info
upload_manager -> storage_backend: "write_chunk(data, offset)"
storage_backend -> upload_manager: chunk_written
upload_manager -> upload_manager: "verify_file_complete()"
upload_manager -> storage_backend: "finalize_file()"
storage_backend -> upload_manager: file_ready
upload_manager -> session_store: "mark_completed(id)"
session_store -> upload_manager: session_completed
upload_manager -> client: "204 No Content (file complete)"