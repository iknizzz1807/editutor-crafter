title: File Validation and Scanning Pipeline {
  near: top-center
  style.font-size: 18
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  start_end: {
    style.fill: "#3fb950"
    style.stroke: "#2d8f47"
    style.font-color: "#ffffff"
    style.bold: true
  }
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#ffd32a"
    style.font-color: "#e6edf3"
  }
  storage: {
    style.fill: "#0f3460"
    style.stroke: "#58a6ff"
    style.font-color: "#e6edf3"
  }
  alert: {
    style.fill: "#da3633"
    style.stroke: "#f85149"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

upload_complete: Upload Complete {
  shape: oval
  class: start_end
}

extract_metadata: Extract File Metadata {
  class: process
}

detect_file_type: File Type Detection {
  class: process
}

type_allowed: File Type\nAllowed? {
  shape: diamond
  class: decision
}

size_check: File Size\nWithin Limits? {
  shape: diamond
  class: decision
}

virus_scan: Virus Scanning {
  class: process
}

scan_result: Scan Result\nClean? {
  shape: diamond
  class: decision
}

validate_integrity: Validate File\nIntegrity {
  class: process
}

integrity_check: Integrity\nValid? {
  shape: diamond
  class: decision
}

move_to_storage: Move to\nFinal Storage {
  class: storage
  shape: cylinder
}

quarantine: Quarantine\nSuspicious File {
  class: alert
  shape: cylinder
}

reject_file: Reject File\n& Notify User {
  class: alert
}

success_notify: Notify User\nSuccess {
  shape: oval
  class: start_end
}

upload_complete -> extract_metadata: Start validation
extract_metadata -> detect_file_type: Get MIME type
detect_file_type -> type_allowed: Check against whitelist

type_allowed -> size_check: Yes
type_allowed -> reject_file: No - Forbidden type

size_check -> virus_scan: Yes
size_check -> reject_file: No - Too large

virus_scan -> scan_result: ClamAV scan
scan_result -> validate_integrity: Clean
scan_result -> quarantine: Virus detected

validate_integrity -> integrity_check: Hash verification
integrity_check -> move_to_storage: Valid
integrity_check -> quarantine: Corrupted

move_to_storage -> success_notify: File stored
quarantine -> reject_file: Security alert
reject_file -> upload_complete: User retry {style.stroke-dash: 5}