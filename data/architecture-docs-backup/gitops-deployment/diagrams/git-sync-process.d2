title: Git Repository Sync Process {
  style.font-size: 20
  style.bold: true
  near: top-center
}

classes: {
  trigger: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  decision: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  action: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  storage: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

start: Start {
  shape: circle
  class: trigger
}

triggers: Sync Triggers {
  class: process
  
  polling: Polling Timer {
    class: trigger
  }
  
  webhook: Webhook Event {
    class: trigger
  }
}

validate_creds: Validate Credentials {
  shape: diamond
  class: decision
}

cred_fail: Authentication Failed {
  class: action
  style.fill: "#d63031"
  style.font-color: "#ffffff"
}

check_local: Check Local Repository {
  shape: diamond
  class: decision
}

clone_decision: Clone or Fetch? {
  shape: diamond
  class: decision
}

clone_repo: Clone Repository {
  class: action
}

fetch_updates: Fetch Updates {
  class: action
}

detect_changes: Detect Changes {
  class: process
  
  branch_check: Check Branches {
    class: action
  }
  
  tag_check: Check Tags {
    class: action
  }
  
  commit_check: Check Commits {
    class: action
  }
}

update_cache: Update Local Cache {
  class: action
}

notify_components: Notify Other Components {
  class: action
}

local_store: Local Repository Cache {
  shape: cylinder
  class: storage
}

complete: Sync Complete {
  shape: circle
  class: trigger
  style.double-border: true
}

# Flow connections
start -> triggers
triggers.polling -> validate_creds: scheduled
triggers.webhook -> validate_creds: triggered

validate_creds -> cred_fail: invalid {
  style.stroke: "#d63031"
}
validate_creds -> check_local: valid

check_local -> clone_decision: exists
check_local -> clone_repo: not found

clone_decision -> clone_repo: first time
clone_decision -> fetch_updates: update only

clone_repo -> detect_changes
fetch_updates -> detect_changes

detect_changes.branch_check -> detect_changes.tag_check
detect_changes.tag_check -> detect_changes.commit_check

detect_changes -> update_cache: changes found
detect_changes -> complete: no changes {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}

update_cache -> local_store
local_store -> notify_components
notify_components -> complete

cred_fail -> complete: retry later {
  style.stroke: "#d63031"
  style.stroke-dash: 3
}