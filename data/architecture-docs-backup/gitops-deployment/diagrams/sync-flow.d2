shape: sequence_diagram

git: Git Repository {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

repo_mgr: Repository Manager {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

manifest_gen: Manifest Generator {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

sync_engine: Sync Engine {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

k8s: Kubernetes Cluster {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

health_monitor: Health Monitor {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

git -> repo_mgr: Git webhook/polling detects change
repo_mgr -> repo_mgr: Clone/pull latest changes
repo_mgr -> manifest_gen: Repository change event
manifest_gen -> manifest_gen: Parse configuration files
manifest_gen -> manifest_gen: Generate K8s manifests
manifest_gen -> sync_engine: Manifests ready event
sync_engine -> k8s: Get current cluster state
k8s -> sync_engine: Current resource state
sync_engine -> sync_engine: Three-way merge comparison
sync_engine -> k8s: Apply pre-sync hooks
sync_engine -> k8s: Apply resource changes
k8s -> sync_engine: Apply results
sync_engine -> k8s: Apply post-sync hooks
sync_engine -> health_monitor: Trigger health check
health_monitor -> k8s: Check resource status
k8s -> health_monitor: Resource health data
health_monitor -> sync_engine: Health assessment
sync_engine -> repo_mgr: Sync completion status

git -> repo_mgr: "Error: Invalid configuration"
repo_mgr -> manifest_gen: Invalid config event
manifest_gen -> sync_engine: Generation failed
sync_engine -> repo_mgr: Sync failed - invalid config

sync_engine -> k8s: "Error: Apply failed resource"
k8s -> sync_engine: Apply error response
sync_engine -> k8s: Rollback to previous state
sync_engine -> repo_mgr: Sync failed - rollback completed