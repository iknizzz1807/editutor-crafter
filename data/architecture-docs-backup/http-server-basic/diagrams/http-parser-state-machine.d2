direction: right

title: HTTP Parser State Machine {
  style.font-size: 18
  style.bold: true
  style.font-color: "#e6edf3"
  near: top-center
}

classes: {
  state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.stroke-width: 2
  }
  final_state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.double-border: true
    style.stroke-width: 2
  }
  error_state: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.stroke-width: 2
  }
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  error_transition: {
    style.stroke: "#d63031"
    style.font-color: "#ff6b6b"
  }
}

init: {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  label: ""
}

reading_request: Reading Request Line {
  shape: circle
  class: state
}

reading_headers: Reading Headers {
  shape: circle  
  class: state
}

reading_body: Reading Body {
  shape: circle
  class: state
}

complete: Complete {
  shape: circle
  class: final_state
}

parse_error: Parse Error {
  shape: circle
  class: error_state
}

protocol_error: Protocol Error {
  shape: circle
  class: error_state
}

init -> reading_request: Start parsing {
  class: transition
}

reading_request -> reading_headers: Request line complete {
  class: transition
}

reading_headers -> reading_body: Headers complete\n& Content-Length > 0 {
  class: transition
}

reading_headers -> complete: Headers complete\n& no body {
  class: transition
}

reading_body -> complete: Body complete {
  class: transition
}

reading_request -> parse_error: Invalid method/URI/version {
  class: error_transition
}

reading_headers -> parse_error: Malformed header {
  class: error_transition
}

reading_headers -> protocol_error: Header too large {
  class: error_transition
}

reading_body -> protocol_error: Body too large {
  class: error_transition
}

reading_body -> parse_error: Invalid chunk encoding {
  class: error_transition
}

notes: |md
  **Key Transitions:**
  • Start → Reading Request Line
  • Valid request line → Reading Headers  
  • Headers done + body → Reading Body
  • Headers done + no body → Complete
  • Body complete → Complete
  
  **Error Conditions:**
  • Invalid HTTP syntax → Parse Error
  • Size limits exceeded → Protocol Error
  • Malformed encoding → Parse Error
| {
  shape: page
  style.fill: "#16213e"
  style.stroke: "#3fb950" 
  style.font-color: "#e6edf3"
  near: bottom-right
}