title: Error Handling and Recovery Flow {
  style.font-size: 20
  style.bold: true
  near: top-center
}

classes: {
  error_node: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  
  decision_node: {
    style.fill: "#fdcb6e"
    style.stroke: "#e17055"
    style.font-color: "#2d3436"
    style.bold: true
  }
  
  action_node: {
    style.fill: "#0984e3"
    style.stroke: "#74b9ff"
    style.font-color: "#ffffff"
  }
  
  recovery_node: {
    style.fill: "#00b894"
    style.stroke: "#00cec9"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

error_detected: Error Detected {
  shape: circle
  class: error_node
}

classify_error: Classify Error Type {
  shape: diamond
  class: decision_node
}

connection_errors: Connection Level {
  frame_parsing: Frame Parsing Error {
    class: error_node
  }
  
  protocol_violation: Protocol Violation {
    class: error_node
  }
  
  hpack_corruption: HPACK Context Corruption {
    class: error_node
  }
  
  goaway_action: Send GOAWAY Frame {
    class: recovery_node
  }
  
  close_connection: Close Connection {
    class: recovery_node
  }
  
  frame_parsing -> goaway_action
  protocol_violation -> goaway_action
  hpack_corruption -> goaway_action
  goaway_action -> close_connection
}

stream_errors: Stream Level {
  state_violation: Stream State Violation {
    class: error_node
  }
  
  flow_control: Flow Control Error {
    class: error_node
  }
  
  invalid_headers: Invalid Headers {
    class: error_node
  }
  
  rst_stream: Send RST_STREAM {
    class: recovery_node
  }
  
  cleanup_stream: Clean Up Stream State {
    class: action_node
  }
  
  continue_connection: Continue Other Streams {
    class: action_node
  }
  
  state_violation -> rst_stream
  flow_control -> rst_stream
  invalid_headers -> rst_stream
  rst_stream -> cleanup_stream
  cleanup_stream -> continue_connection
}

monitoring: {
  log_error: Log Error Details {
    class: action_node
  }
  
  update_metrics: Update Error Metrics {
    class: action_node
  }
  
  alert_system: Alert if Threshold Exceeded {
    class: action_node
  }
  
  log_error -> update_metrics
  update_metrics -> alert_system
}

# Main flow
error_detected -> classify_error

classify_error -> connection_errors.frame_parsing: Connection Error
classify_error -> stream_errors.state_violation: Stream Error

# Monitoring connections
connection_errors.goaway_action -> monitoring.log_error
stream_errors.rst_stream -> monitoring.log_error

# Error types note
error_types: |md
  **Connection Errors:**
  - Malformed frames
  - HPACK decompression failures
  - Protocol violations
  
  **Stream Errors:**
  - Invalid stream states
  - Flow control violations
  - Malformed headers
| {
  shape: page
  near: bottom-left
  style.fill: "#2d3436"
  style.font-color: "#ddd"
}