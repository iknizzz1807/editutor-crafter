title: TLS Connection State Machine

classes: {
  state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  final_state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
    style.double-border: true
  }
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  error_transition: {
    style.stroke: "#d63031"
    style.font-color: "#d63031"
  }
}

init: {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  label: ""
}

START: {
  shape: circle
  class: state
}

WAIT_SH: {
  shape: circle
  class: state
  label: "WAIT_SH\n(Server Hello)"
}

WAIT_EE: {
  shape: circle
  class: state
  label: "WAIT_EE\n(Encrypted Extensions)"
}

WAIT_CERT_CR: {
  shape: circle
  class: state
  label: "WAIT_CERT_CR\n(Certificate/\nCert Request)"
}

WAIT_CV: {
  shape: circle
  class: state
  label: "WAIT_CV\n(Certificate Verify)"
}

WAIT_FINISHED: {
  shape: circle
  class: state
  label: "WAIT_FINISHED\n(Server Finished)"
}

CONNECTED: {
  shape: circle
  class: state
  style.fill: "#00b894"
}

CLOSED: {
  shape: circle
  class: final_state
  style.fill: "#d63031"
}

init -> START: {
  class: transition
}

START -> WAIT_SH: {
  label: "ClientHello"
  class: transition
}

WAIT_SH -> WAIT_EE: {
  label: "ServerHello"
  class: transition
}

WAIT_EE -> WAIT_CERT_CR: {
  label: "EncryptedExtensions"
  class: transition
}

WAIT_CERT_CR -> WAIT_CV: {
  label: "Certificate"
  class: transition
}

WAIT_CV -> WAIT_FINISHED: {
  label: "CertificateVerify"
  class: transition
}

WAIT_FINISHED -> CONNECTED: {
  label: "Finished"
  class: transition
}

CONNECTED -> CLOSED: {
  label: "close_notify"
  class: transition
}

START -> CLOSED: {
  label: "timeout/error"
  class: error_transition
}

WAIT_SH -> CLOSED: {
  label: "alert/timeout"
  class: error_transition
}

WAIT_EE -> CLOSED: {
  label: "alert/error"
  class: error_transition
}

WAIT_CERT_CR -> CLOSED: {
  label: "cert validation fail"
  class: error_transition
}

WAIT_CV -> CLOSED: {
  label: "signature fail"
  class: error_transition
}

WAIT_FINISHED -> CLOSED: {
  label: "handshake fail"
  class: error_transition
}

CONNECTED -> CLOSED: {
  label: "fatal alert"
  class: error_transition
}