title: AEAD Encryption/Decryption Process {
  style.font-size: 20
  style.bold: true
  near: top-center
}

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  data: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  error: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
  }
  success: {
    style.fill: "#00b894"
    style.stroke: "#00a085"
    style.font-color: "#ffffff"
  }
}

encryption_flow: Encryption Flow {
  class: data
  
  start_enc: Start Encryption {
    shape: circle
    class: process
    style.fill: "#3fb950"
    label: ""
  }
  
  app_data: Application Data Record {
    class: data
  }
  
  get_seq: Get Sequence Number {
    class: process
  }
  
  construct_nonce: Construct 12-byte Nonce\n(4 bytes IV + 8 bytes seq) {
    class: process
  }
  
  aes_gcm_enc: AES-GCM Encryption {
    class: process
    style.bold: true
  }
  
  encrypted_record: Encrypted Record +\nAuthentication Tag {
    class: success
  }
  
  start_enc -> app_data
  app_data -> get_seq
  get_seq -> construct_nonce
  construct_nonce -> aes_gcm_enc
  aes_gcm_enc -> encrypted_record
}

decryption_flow: Decryption Flow {
  class: data
  
  start_dec: Start Decryption {
    shape: circle
    class: process
    style.fill: "#3fb950"
    label: ""
  }
  
  enc_record: Encrypted Record {
    class: data
  }
  
  extract_seq: Extract Sequence Number {
    class: process
  }
  
  construct_nonce_dec: Construct 12-byte Nonce\n(4 bytes IV + 8 bytes seq) {
    class: process
  }
  
  aes_gcm_dec: AES-GCM Decryption {
    class: process
    style.bold: true
  }
  
  verify_tag: Verify Authentication Tag {
    shape: diamond
    class: decision
  }
  
  auth_fail: Authentication Failed\nDiscard Record {
    class: error
  }
  
  decrypt_success: Decrypted Application Data {
    class: success
  }
  
  reconstruct: Reconstruct Record {
    class: process
  }
  
  final_data: Application Data Record {
    class: success
  }
  
  start_dec -> enc_record
  enc_record -> extract_seq
  extract_seq -> construct_nonce_dec
  construct_nonce_dec -> aes_gcm_dec
  aes_gcm_dec -> verify_tag
  verify_tag -> auth_fail: Tag Invalid
  verify_tag -> decrypt_success: Tag Valid
  decrypt_success -> reconstruct
  reconstruct -> final_data
}

sequence_handling: Sequence Number Handling {
  class: data
  
  seq_counter: Sequence Counter\n(64-bit) {
    class: data
  }
  
  increment: Increment Counter\nfor Each Record {
    class: process
  }
  
  overflow_check: Counter Overflow? {
    shape: diamond
    class: decision
  }
  
  rekey: Rekey Connection {
    class: error
  }
  
  continue: Continue Processing {
    class: process
  }
  
  seq_counter -> increment
  increment -> overflow_check
  overflow_check -> rekey: Yes
  overflow_check -> continue: No
}

nonce_details: Nonce Construction Details {
  class: data
  
  write_iv: Write IV\n(4 bytes) {
    class: data
  }
  
  read_iv: Read IV\n(4 bytes) {
    class: data
  }
  
  seq_bytes: Sequence Number\n(8 bytes, big-endian) {
    class: data
  }
  
  xor_op: XOR Operation\n(IV XOR seq for GCM) {
    class: process
  }
  
  final_nonce: 12-byte Nonce {
    class: success
  }
  
  write_iv -> xor_op
  seq_bytes -> xor_op
  xor_op -> final_nonce
  
  read_iv -> xor_op
}

encryption_flow -> sequence_handling: Uses
decryption_flow -> sequence_handling: Uses
sequence_handling -> nonce_details: Constructs
encryption_flow.construct_nonce -> nonce_details: Details
decryption_flow.construct_nonce_dec -> nonce_details: Details