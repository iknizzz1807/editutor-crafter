title: External Service Mocking Flow

classes: {
  container_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  process_style: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  decision_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  error_style: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  
  success_style: {
    style.fill: "#00b894"
    style.stroke: "#00cec9"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

application: Application {
  class: container_style
}

outbound_request: Outbound API Request {
  class: process_style
}

interceptor: Request Interceptor {
  class: process_style
}

matcher: Stub Matcher {
  shape: diamond
  class: decision_style
}

stub_registry: Stub Registry {
  class: container_style
}

request_verifier: Request Verifier {
  class: process_style
}

error_simulator: Error Simulator {
  shape: diamond
  class: decision_style
}

response_builder: Response Builder {
  class: process_style
}

mock_response: Mock Response {
  class: success_style
}

error_response: Error Response {
  class: error_style
}

no_match_error: No Stub Match Error {
  class: error_style
}

verification_log: Verification Log {
  class: container_style
}

application -> outbound_request: makes API call

outbound_request -> interceptor: intercepts HTTP request

interceptor -> matcher: find matching stub

matcher -> stub_registry: query stubs

matcher -> mock_response: stub found {
  style.stroke: "#00b894"
}

matcher -> no_match_error: no stub found {
  style.stroke: "#d63031"
}

mock_response -> request_verifier: verify request params

request_verifier -> verification_log: log verification

request_verifier -> error_simulator: check error conditions

error_simulator -> response_builder: normal response {
  style.stroke: "#00b894"
}

error_simulator -> error_response: simulate error {
  style.stroke: "#d63031"
}

response_builder -> application: return mock response {
  style.stroke: "#00b894"
}

error_response -> application: return error response {
  style.stroke: "#d63031"
}

no_match_error -> application: return 404/error {
  style.stroke: "#d63031"
}