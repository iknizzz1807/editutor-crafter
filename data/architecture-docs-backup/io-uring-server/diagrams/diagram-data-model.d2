direction: right

title: Data Model Relationships {
  style: {
    font-size: 24
    bold: true
    font-color: "#e6edf3"
  }
}

kernel_structures: Kernel API Structures {
  style: {
    fill: "#0f3460"
    stroke: "#3fb950"
    stroke-width: 2
  }
  
  io_uring: struct io_uring {
    shape: class
    style: {
      fill: "#1a1a2e"
      stroke: "#3fb950"
      bold: true
    }
    
    sq_ring: submission_queue_ring
    cq_ring: completion_queue_ring
  }
  
  io_uring_sqe: struct io_uring_sqe {
    shape: class
    style: {
      fill: "#1a1a2e"
      stroke: "#8b949e"
    }
    
    opcode: u8
    flags: u8
    fd: i32
    addr: u64
    len: u32
    offset: u64
    user_data: u64
    buf_index: u16
  }
  
  io_uring_cqe: struct io_uring_cqe {
    shape: class
    style: {
      fill: "#1a1a2e"
      stroke: "#8b949e"
    }
    
    user_data: u64
    res: i32
    flags: u32
  }
}

server_structures: Server Data Structures {
  style: {
    fill: "#0f3460"
    stroke: "#3fb950"
    stroke-width: 2
  }
  
  connection_state: struct connection_state {
    shape: class
    style: {
      fill: "#1a1a2e"
      stroke: "#3fb950"
      bold: true
    }
    
    fd: i32
    state: enum
    read_op: "*io_op_context"
    write_op: "*io_op_context"
    buffer_pool: "*io_buffer[]"
  }
  
  io_op_context: struct io_op_context {
    shape: class
    style: {
      fill: "#1a1a2e"
      stroke: "#8b949e"
    }
    
    op_type: enum
    connection: "*connection_state"
    buffer: "*io_buffer"
    user_data: u64
    result: i32
  }
  
  io_buffer: struct io_buffer {
    shape: class
    style: {
      fill: "#1a1a2e"
      stroke: "#8b949e"
    }
    
    data: "*u8"
    capacity: usize
    length: usize
    in_use: bool
    next: "*io_buffer"
  }
}

# Relationships
kernel_structures.io_uring.sq_ring -> kernel_structures.io_uring_sqe: contains {
  style.stroke-dash: 2
}
kernel_structures.io_uring.cq_ring -> kernel_structures.io_uring_cqe: contains {
  style.stroke-dash: 2
}

server_structures.connection_state -> server_structures.io_op_context: "has multiple" {
  style.stroke-dash: 2
}
server_structures.io_op_context -> server_structures.io_buffer {
  style.stroke-dash: 2
}

# Connection between kernel and server
server_structures.io_op_context.user_data -> kernel_structures.io_uring_sqe.user_data {
  style: {
    stroke: "#8b949e"
    stroke-dash: 3
  }
}
server_structures.io_op_context.user_data <- kernel_structures.io_uring_cqe.user_data {
  style: {
    stroke: "#8b949e"
    stroke-dash: 3
  }
}

# Legend
legend: {
  contains: "contains (composition)"
  points_to: "points-to (reference)"
  correlates: "correlates (user_data)"
}