title: Main Event Loop Flowchart
desc: Flowchart of the core event loop logic: Initialize -> While(running) -> Check for new events (e.g., inbound signals) -> Prepare & Submit SQEs -> Enter kernel (io_uring_enter) -> Harvest CQEs -> For each CQE: find context, handle based on opcode, clean up or resubmit -> Loop.

direction: down

io_uring_event_loop: {
  start: Initialize {
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
  
  running_decision: Loop Active? {
    shape: diamond
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
    style.stroke: "#3fb950"
  }
  
  check_events: Check for New Events {
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
  
  prepare_sqes: Prepare & Submit SQEs {
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
  
  enter_kernel: Enter Kernel (io_uring_enter) {
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  harvest_cqes: Harvest CQEs {
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
  
  process_cqes: For Each CQE {
    shape: diamond
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
    style.stroke: "#3fb950"
  }
  
  find_context: Find Request Context {
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
  
  handle_opcode: Handle Based on Opcode {
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
  
  cleanup_resubmit: Clean Up or Resubmit {
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
  
  end: Shutdown {
    style.fill: "#0f3460"
    style.font-color: "#e6edf3"
  }
  
  start -> running_decision
  
  running_decision -> check_events: Yes {
    style.stroke-dash: 0
  }
  running_decision -> end: No
  
  check_events -> prepare_sqes
  prepare_sqes -> enter_kernel
  enter_kernel -> harvest_cqes
  harvest_cqes -> process_cqes
  
  process_cqes -> find_context: More CQEs? {
    style.stroke-dash: 0
  }
  process_cqes -> running_decision: Done {
    target-arrowhead.shape: triangle
  }
  
  find_context -> handle_opcode
  handle_opcode -> cleanup_resubmit
  cleanup_resubmit -> process_cqes: Next CQE {
    target-arrowhead.shape: triangle
  }
}

style: {
  stroke: "#3fb950"
  font-color: "#e6edf3"
  fill: "#8b949e"
}