shape: sequence_diagram

Client: Client {
  style.fill: "#0f3460"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}
ServerApp: Server Application {
  style.fill: "#0f3460"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}
SQ: Submission Queue (SQ) {
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
  style.stroke: "#8b949e"
}
Kernel: Kernel (io_uring) {
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
  style.stroke: "#8b949e"
}
CQ: Completion Queue (CQ) {
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
  style.stroke: "#8b949e"
}

note: |md
  ## Network Echo with Linked SQEs
  - **ACCEPT** (multishot): Listens for new connections
  - **READ** (linked): Reads data from accepted socket
  - **WRITE** (linked): Echoes data back to client
  - **Dependencies**: WRITE linked to READ, READ linked to ACCEPT
  - **Out-of-order CQEs**: Kernel may complete in any order, but dependencies enforce execution order
| {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}

ServerApp -> SQ: Submit batch with 3 linked SQEs
note: {
  shape: page
  style.fill: "#1a1a2e"
  style.font-color: "#8b949e"
  text: |md
    **SQEs in batch:**
    1. ACCEPT (multishot, fd=listen_sock)
    2. READ (linked to #1, fd=accepted_fd)
    3. WRITE (linked to #2, fd=accepted_fd)
  |
}

SQ -> Kernel: Process SQEs (respecting links)
Kernel -> Kernel: Execute ACCEPT → get new connection
Kernel -> Kernel: Execute READ → wait for client data
Client -> Kernel: Send data over network
Kernel -> Kernel: Execute WRITE → echo data back

Kernel -> CQ: CQE for WRITE (may arrive first)
Kernel -> CQ: CQE for ACCEPT (may arrive second)
Kernel -> CQ: CQE for READ (may arrive third)

note: |md
  **Key Insight:**
  CQEs can complete in any order, but linked
  dependencies ensure execution order:
  ACCEPT → READ → WRITE
| {
  style.fill: "#1a1a2e"
  style.font-color: "#3fb950"
  style.stroke: "#3fb950"
  style.bold: true
}

ServerApp <- CQ: Poll for completions
ServerApp -> ServerApp: Match CQEs using user_data
ServerApp -> SQ: Resubmit ACCEPT (multishot) for next connection