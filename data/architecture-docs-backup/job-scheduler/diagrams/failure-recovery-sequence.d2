direction: right

# Title
title: |md
  # Worker Failure Recovery
  Sequence diagram showing worker failure detection through missed heartbeats, job reassignment to healthy workers, and cleanup of failed worker state.
| {
  shape: text
  style.font-color: "#e6edf3"
  style.bold: true
  near: top-center
}

# Sequence diagram
shape: sequence_diagram

# Actors
coordinator: Coordinator {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950" 
  style.font-color: "#e6edf3"
}

worker1: Worker-1 {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

worker2: Worker-2 {
  style.fill: "#1a1a2e" 
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

worker3: Worker-3 {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950" 
  style.font-color: "#e6edf3"
}

# Normal heartbeat sequence
coordinator -> worker1: assign job-123
worker1 -> coordinator: heartbeat (healthy)
worker2 -> coordinator: heartbeat (healthy)
worker3 -> coordinator: heartbeat (healthy)

# Worker failure begins
coordinator -> worker1: expecting heartbeat
coordinator -> worker1: heartbeat timeout
coordinator -> worker1: heartbeat timeout (2nd miss)

# Failure detection
coordinator -> coordinator: detect worker-1 failure\n(missed 3 consecutive heartbeats)

# Job reassignment
coordinator -> worker2: reassign job-123 from failed worker-1
worker2 -> coordinator: ack job assignment

# Cleanup failed worker state
coordinator -> coordinator: mark worker-1 as failed
coordinator -> coordinator: remove worker-1 from active pool
coordinator -> coordinator: cleanup pending jobs for worker-1

# Continue with healthy workers
worker2 -> coordinator: heartbeat + job progress
worker3 -> coordinator: heartbeat (healthy)
worker2 -> coordinator: job-123 completed

# Recovery attempt
worker1 -> coordinator: reconnect attempt
coordinator -> worker1: reject (cleanup in progress)
coordinator -> coordinator: complete worker-1 cleanup
worker1 -> coordinator: re-register as new worker
coordinator -> worker1: registration accepted