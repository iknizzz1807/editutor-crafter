# Token Validation State Machine

classes: {
  state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  error_state: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  success_state: {
    style.fill: "#00b894"
    style.stroke: "#00cec9"
    style.font-color: "#ffffff"
    style.bold: true
  }
  initial_state: {
    style.fill: "#3fb950"
    style.stroke: "#00b894"
    style.font-color: "#ffffff"
    style.font-size: 10
  }
}

init: {
  shape: circle
  class: initial_state
  label: ""
}

received: Token Received {
  shape: circle
  class: state
}

parsing: Parsing Structure {
  shape: circle
  class: state
}

signature_check: Signature Verification {
  shape: circle
  class: state
}

claims_validation: Claims Validation {
  shape: circle
  class: state
}

temporal_check: Temporal Validation {
  shape: circle
  class: state
}

issuer_check: Issuer Validation {
  shape: circle
  class: state
}

audience_check: Audience Validation {
  shape: circle
  class: state
}

custom_claims: Custom Claims Check {
  shape: circle
  class: state
}

validated: Token Validated {
  shape: circle
  class: success_state
  style.double-border: true
}

malformed_error: Malformed Token {
  shape: circle
  class: error_state
}

signature_error: Invalid Signature {
  shape: circle
  class: error_state
}

expired_error: Token Expired {
  shape: circle
  class: error_state
}

not_before_error: Not Yet Valid {
  shape: circle
  class: error_state
}

issuer_error: Invalid Issuer {
  shape: circle
  class: error_state
}

audience_error: Wrong Audience {
  shape: circle
  class: error_state
}

claims_error: Custom Claims Failed {
  shape: circle
  class: error_state
}

# Main flow transitions
init -> received: Start validation
received -> parsing: Begin processing
parsing -> signature_check: Structure valid
signature_check -> claims_validation: Signature valid
claims_validation -> temporal_check: Begin claims check
temporal_check -> issuer_check: Time valid
issuer_check -> audience_check: Issuer valid
audience_check -> custom_claims: Audience valid
custom_claims -> validated: All checks passed

# Error transitions
parsing -> malformed_error: Invalid JWT structure
signature_check -> signature_error: Signature mismatch
temporal_check -> expired_error: exp < now
temporal_check -> not_before_error: nbf > now
issuer_check -> issuer_error: Untrusted issuer
audience_check -> audience_error: aud mismatch
custom_claims -> claims_error: Business rules failed

# Style arrows
init -> received: { style.stroke: "#8b949e" }
received -> parsing: { style.stroke: "#8b949e" }
parsing -> signature_check: { style.stroke: "#8b949e" }
signature_check -> claims_validation: { style.stroke: "#8b949e" }
claims_validation -> temporal_check: { style.stroke: "#8b949e" }
temporal_check -> issuer_check: { style.stroke: "#8b949e" }
issuer_check -> audience_check: { style.stroke: "#8b949e" }
audience_check -> custom_claims: { style.stroke: "#8b949e" }
custom_claims -> validated: { style.stroke: "#00b894" }

parsing -> malformed_error: { style.stroke: "#d63031" }
signature_check -> signature_error: { style.stroke: "#d63031" }
temporal_check -> expired_error: { style.stroke: "#d63031" }
temporal_check -> not_before_error: { style.stroke: "#d63031" }
issuer_check -> issuer_error: { style.stroke: "#d63031" }
audience_check -> audience_error: { style.stroke: "#d63031" }
custom_claims -> claims_error: { style.stroke: "#d63031" }