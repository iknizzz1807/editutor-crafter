title: Production Deployment Architecture {
  near: top-center
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  container: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  pod: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  service: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  leader: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  webhook: {
    style.fill: "#6c5ce7"
    style.stroke: "#a29bfe"
    style.font-color: "#ffffff"
  }
  monitoring: {
    style.fill: "#fd79a8"
    style.stroke: "#e84393"
    style.font-color: "#ffffff"
  }
}

k8s_cluster: Kubernetes Cluster {
  class: container

  operator_namespace: Operator Namespace {
    class: container

    operator_pods: Operator Pods {
      class: container
      
      manager_1: Manager Pod 1 {
        class: leader
        shape: package
        label: "Manager Pod 1\n(Leader)"
      }
      
      manager_2: Manager Pod 2 {
        class: pod
        shape: package
        label: "Manager Pod 2\n(Standby)"
      }
      
      manager_3: Manager Pod 3 {
        class: pod
        shape: package
        label: "Manager Pod 3\n(Standby)"
      }
    }
    
    webhook_service: Webhook Service {
      class: service
      shape: hexagon
    }
    
    webhook_pods: Webhook Pods {
      class: container
      
      webhook_1: Webhook Pod 1 {
        class: webhook
        shape: package
      }
      
      webhook_2: Webhook Pod 2 {
        class: webhook
        shape: package
      }
    }
    
    tls_secrets: TLS Secrets {
      class: service
      shape: page
      label: "TLS Certificates\n& Keys"
    }
  }
  
  rbac_config: RBAC Configuration {
    class: container
    
    service_account: Service Account {
      class: service
      shape: oval
    }
    
    cluster_role: Cluster Role {
      class: service
      shape: oval
    }
    
    role_binding: Role Binding {
      class: service
      shape: oval
    }
  }
  
  monitoring_stack: Monitoring & Observability {
    class: container
    
    prometheus: Prometheus {
      class: monitoring
      shape: cylinder
    }
    
    grafana: Grafana {
      class: monitoring
      shape: rectangle
    }
    
    jaeger: Jaeger {
      class: monitoring
      shape: rectangle
    }
    
    metrics_service: Metrics Service {
      class: monitoring
      shape: hexagon
    }
  }
  
  api_server: Kubernetes API Server {
    class: service
    shape: cloud
  }
  
  etcd: etcd Cluster {
    class: service
    shape: cylinder
  }
}

manager_1 -> manager_2: Leader Election
manager_1 -> manager_3: Leader Election
manager_2 -> manager_1: Health Check
manager_3 -> manager_1: Health Check

operator_pods -> api_server: Watch CRDs\n& Resources
api_server -> operator_pods: Events & Updates

webhook_service -> webhook_1: Route Admission\nRequests
webhook_service -> webhook_2: Route Admission\nRequests

api_server -> webhook_service: Admission\nWebhook Calls

webhook_pods -> tls_secrets: Mount TLS\nCertificates

service_account -> operator_pods: Pod Identity
cluster_role -> role_binding: Permissions
role_binding -> service_account: Bind Permissions

prometheus -> metrics_service: Scrape Metrics
metrics_service -> operator_pods: Expose Metrics
metrics_service -> webhook_pods: Expose Metrics

grafana -> prometheus: Query Metrics
jaeger -> operator_pods: Collect Traces
jaeger -> webhook_pods: Collect Traces

api_server -> etcd: Store Cluster State
operator_pods -> etcd: Read/Write Custom Resources

election_note: |md
  **Leader Election**
  Only one manager pod actively
  reconciles resources at a time
| {
  shape: page
  near: top-right
  style.fill: "#2d3748"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

tls_note: |md
  **TLS Security**
  Webhook endpoints secured
  with mutual TLS authentication
| {
  shape: page
  near: bottom-left
  style.fill: "#2d3748"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}