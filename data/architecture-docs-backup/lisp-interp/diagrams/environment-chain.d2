title: Environment Scope Chain {
  near: top-center
  shape: text
  style.font-size: 18
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  env_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  binding_style: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  lookup_style: {
    style.stroke: "#e17055"
    style.stroke-width: 2
    style.font-color: "#e17055"
    style.bold: true
  }
  
  closure_style: {
    style.fill: "#0f3460"
    style.stroke: "#f39c12"
    style.font-color: "#e6edf3"
    style.stroke-dash: 3
  }
}

global_env: Global Environment {
  class: env_style
  
  global_bindings: Variable Bindings {
    class: binding_style
    shape: page
    label: |md
      **+ (function)**
      **car (function)**
      **cdr (function)**
      **list (function)**
    |
  }
}

outer_env: Function Environment {
  class: env_style
  
  outer_bindings: Variable Bindings {
    class: binding_style
    shape: page
    label: |md
      **x = 10**
      **y = 20**
      **helper (function)**
    |
  }
}

inner_env: Inner Block Environment {
  class: env_style
  
  inner_bindings: Variable Bindings {
    class: binding_style
    shape: page
    label: |md
      **z = 30**
      **temp = 5**
    |
  }
}

closure_env: Closure Environment {
  class: closure_style
  
  captured_bindings: Captured Bindings {
    class: binding_style
    shape: page
    label: |md
      **x = 10** (captured)
      **helper (function)** (captured)
    |
  }
}

# Parent-child chain
inner_env -> outer_env: parent {
  style.stroke: "#3fb950"
  style.stroke-width: 2
}

outer_env -> global_env: parent {
  style.stroke: "#3fb950"
  style.stroke-width: 2
}

# Variable lookup traversal
lookup_start: Variable Lookup: 'x' {
  shape: circle
  style.fill: "#e17055"
  style.font-color: "#ffffff"
  style.bold: true
}

lookup_start -> inner_env: 1. Check local {
  class: lookup_style
  style.stroke-dash: 5
}

inner_env -> outer_env: 2. Not found, traverse parent {
  class: lookup_style
  style.stroke-dash: 5
}

lookup_result: Found: x = 10 {
  shape: hexagon
  style.fill: "#27ae60"
  style.font-color: "#ffffff"
  style.bold: true
}

outer_env -> lookup_result: 3. Found in parent scope {
  class: lookup_style
}

# Closure capture
closure_creation: Function Definition {
  shape: diamond
  style.fill: "#f39c12"
  style.font-color: "#000000"
  style.bold: true
}

closure_creation -> closure_env: captures environment {
  style.stroke: "#f39c12"
  style.stroke-width: 2
  style.stroke-dash: 3
}

outer_env -> closure_env: lexical scope reference {
  style.stroke: "#f39c12"
  style.stroke-dash: 3
}

# Notes
scope_note: |md
  ## Lexical Scoping Rules
  
  **Variable Resolution:**
  1. Search current environment
  2. If not found, search parent
  3. Continue up the chain
  4. Error if not found in global
  
  **Closure Capture:**
  - Functions capture their defining environment
  - Maintains reference to lexical scope
  - Enables access to non-local variables
| {
  shape: page
  near: bottom-left
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}