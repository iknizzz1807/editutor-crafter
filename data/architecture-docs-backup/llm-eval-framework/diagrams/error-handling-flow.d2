classes: {
  start: {
    style.fill: "#3fb950"
    style.font-color: "#ffffff"
    style.bold: true
  }
  error: {
    style.fill: "#d63031"
    style.font-color: "#ffffff"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  recovery: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  success: {
    style.fill: "#00b894"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

title: Error Handling and Recovery Flow {
  shape: text
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
  near: top-center
}

start: Error Detected {
  shape: oval
  class: start
}

classify: Classify Error Type {
  shape: diamond
  class: decision
}

api_error: API Error? {
  shape: diamond
  class: decision
}

validation_error: Validation Error? {
  shape: diamond
  class: decision
}

timeout_error: Timeout Error? {
  shape: diamond
  class: decision
}

check_retry: Check Retry Count {
  shape: diamond
  class: decision
}

rate_limit: Rate Limit Check {
  shape: diamond
  class: decision
}

validation_fix: Attempt Data Correction {
  shape: rectangle
  class: recovery
}

exponential_backoff: Exponential Backoff {
  shape: rectangle
  class: recovery
}

circuit_breaker: Activate Circuit Breaker {
  shape: rectangle
  class: recovery
}

checkpoint_restore: Restore Last Checkpoint {
  shape: rectangle
  class: recovery
}

partial_results: Save Partial Results {
  shape: rectangle
  class: recovery
}

retry_logic: Retry with Backoff {
  shape: rectangle
  class: recovery
}

queue_request: Queue for Later {
  shape: rectangle
  class: recovery
}

fail_gracefully: Fail Gracefully {
  shape: rectangle
  class: error
}

log_error: Log Error Details {
  shape: rectangle
  class: recovery
}

notify_monitoring: Notify Monitoring {
  shape: rectangle
  class: recovery
}

success: Recovery Successful {
  shape: oval
  class: success
}

terminal_failure: Terminal Failure {
  shape: oval
  class: error
}

start -> classify: Error occurs

classify -> api_error: Analyze error

api_error -> rate_limit: Yes
api_error -> validation_error: No

rate_limit -> exponential_backoff: Rate limited
rate_limit -> check_retry: Not rate limited

exponential_backoff -> queue_request: Wait period
queue_request -> retry_logic: Resume

check_retry -> retry_logic: < Max retries
check_retry -> circuit_breaker: Max retries reached

validation_error -> validation_fix: Yes
validation_error -> timeout_error: No

validation_fix -> success: Fixed
validation_fix -> fail_gracefully: Cannot fix

timeout_error -> checkpoint_restore: Yes
timeout_error -> log_error: No

checkpoint_restore -> partial_results: Restore state
partial_results -> retry_logic: Continue

retry_logic -> success: Success
retry_logic -> classify: Retry failed

circuit_breaker -> notify_monitoring: Circuit open
fail_gracefully -> log_error: Record failure

log_error -> notify_monitoring: Send alerts
notify_monitoring -> terminal_failure: Critical error

success -> start: {
  style.stroke-dash: 3
  label: New request
}