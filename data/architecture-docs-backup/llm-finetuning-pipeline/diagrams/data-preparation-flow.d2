# Data Preparation Pipeline

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  data: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  output: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.double-border: true
  }
}

raw_data: Raw Data {
  shape: cylinder
  class: data
}

format_validation: Format Validation {
  class: process
}

format_check: Valid Format? {
  shape: diamond
  class: decision
}

format_conversion: Format Conversion {
  class: process
}

chat_template: Chat Template Application {
  class: process
}

tokenization: Tokenization {
  class: process
}

length_filter: Length Filtering {
  class: process
}

quality_check: Quality Check {
  shape: diamond
  class: decision
}

train_val_split: Train/Val Split {
  class: process
}

dataloader: DataLoader {
  class: output
}

# Main flow
raw_data -> format_validation
format_validation -> format_check
format_check -> format_conversion: No
format_check -> chat_template: Yes
format_conversion -> chat_template
chat_template -> tokenization
tokenization -> length_filter
length_filter -> quality_check
quality_check -> train_val_split: Pass
quality_check -> format_validation: Reject (retry)
train_val_split -> dataloader

# Edge styling
raw_data -> format_validation: {
  style.stroke: "#8b949e"
}
format_validation -> format_check: {
  style.stroke: "#8b949e"
}
format_check -> format_conversion: {
  style.stroke: "#e17055"
}
format_check -> chat_template: {
  style.stroke: "#3fb950"
}
format_conversion -> chat_template: {
  style.stroke: "#8b949e"
}
chat_template -> tokenization: {
  style.stroke: "#8b949e"
}
tokenization -> length_filter: {
  style.stroke: "#8b949e"
}
length_filter -> quality_check: {
  style.stroke: "#8b949e"
}
quality_check -> train_val_split: {
  style.stroke: "#3fb950"
}
quality_check -> format_validation: {
  style.stroke: "#e17055"
  style.stroke-dash: 3
}
train_val_split -> dataloader: {
  style.stroke: "#3fb950"
  style.bold: true
}