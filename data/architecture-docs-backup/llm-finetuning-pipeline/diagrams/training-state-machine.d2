classes: {
  state_active: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  state_terminal: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.double-border: true
  }
  state_init: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#000000"
  }
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

title: Training Loop State Machine {
  near: top-center
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
}

init: {
  shape: circle
  class: state_init
  label: ""
}

initialization: Initialization {
  shape: circle
  class: state_active
}

forward_pass: Forward Pass {
  shape: circle
  class: state_active
}

gradient_accumulation: Gradient\nAccumulation {
  shape: circle
  class: state_active
}

optimizer_step: Optimizer Step {
  shape: circle
  class: state_active
}

evaluation: Evaluation {
  shape: circle
  class: state_active
}

checkpointing: Checkpointing {
  shape: circle
  class: state_active
}

completed: Completed {
  shape: circle
  class: state_terminal
}

early_stopped: Early Stopped {
  shape: circle
  class: state_terminal
}

failed: Failed {
  shape: circle
  class: state_terminal
}

init -> initialization: start training {
  class: transition
}

initialization -> forward_pass: model loaded {
  class: transition
}

initialization -> failed: init error {
  class: transition
}

forward_pass -> gradient_accumulation: forward complete {
  class: transition
}

forward_pass -> failed: forward error {
  class: transition
}

gradient_accumulation -> optimizer_step: gradients ready {
  class: transition
}

gradient_accumulation -> forward_pass: accumulate more {
  class: transition
}

gradient_accumulation -> failed: gradient error {
  class: transition
}

optimizer_step -> evaluation: step complete {
  class: transition
}

optimizer_step -> forward_pass: next batch {
  class: transition
}

optimizer_step -> failed: optimizer error {
  class: transition
}

evaluation -> checkpointing: eval complete {
  class: transition
}

evaluation -> early_stopped: early stop criteria {
  class: transition
}

evaluation -> failed: eval error {
  class: transition
}

checkpointing -> forward_pass: continue training {
  class: transition
}

checkpointing -> completed: max epochs reached {
  class: transition
}

checkpointing -> failed: checkpoint error {
  class: transition
}