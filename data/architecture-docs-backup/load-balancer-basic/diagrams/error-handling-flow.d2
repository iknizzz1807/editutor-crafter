direction: down

classes: {
  error_node: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  
  decision_node: {
    style.fill: "#fdcb6e"
    style.stroke: "#e17055"
    style.font-color: "#2d3436"
    style.bold: true
  }
  
  action_node: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  success_node: {
    style.fill: "#00b894"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

error_detected: Error Detected {
  shape: rectangle
  class: error_node
}

classify_error: Classify Error Type {
  shape: diamond
  class: decision_node
}

connection_failure: Connection\nFailure? {
  shape: diamond
  class: decision_node
}

timeout_check: Request\nTimeout? {
  shape: diamond
  class: decision_node
}

backend_health: Check Backend\nHealth Status {
  shape: diamond
  class: decision_node
}

mark_unhealthy: Mark Backend\nUnhealthy {
  shape: rectangle
  class: action_node
}

retry_different: Retry with\nDifferent Backend {
  shape: rectangle
  class: action_node
}

circuit_breaker: Circuit Breaker\nTriggered? {
  shape: diamond
  class: decision_node
}

open_circuit: Open Circuit\nBreaker {
  shape: rectangle
  class: action_node
}

fallback_response: Return 503\nService Unavailable {
  shape: rectangle
  class: error_node
}

log_error: Log Error\nDetails {
  shape: rectangle
  class: action_node
}

graceful_degradation: Graceful\nDegradation {
  shape: rectangle
  class: action_node
}

healthy_backends: Any Healthy\nBackends Available? {
  shape: diamond
  class: decision_node
}

queue_request: Queue Request\nfor Retry {
  shape: rectangle
  class: action_node
}

success_response: Forward Response\nto Client {
  shape: rectangle
  class: success_node
}

error_detected -> classify_error

classify_error -> connection_failure: Connection Issue
classify_error -> timeout_check: Timeout Issue  
classify_error -> backend_health: Health Check

connection_failure -> mark_unhealthy: Yes
connection_failure -> log_error: No

timeout_check -> mark_unhealthy: Yes
timeout_check -> retry_different: No

backend_health -> mark_unhealthy: Unhealthy
backend_health -> success_response: Healthy

mark_unhealthy -> circuit_breaker

circuit_breaker -> open_circuit: Yes
circuit_breaker -> healthy_backends: No

open_circuit -> fallback_response

healthy_backends -> retry_different: Yes
healthy_backends -> graceful_degradation: No

retry_different -> success_response: Success
retry_different -> queue_request: All Failed

graceful_degradation -> fallback_response

queue_request -> log_error

log_error -> fallback_response