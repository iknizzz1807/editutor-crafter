title: Round Robin Selection Flow

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  success: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  error: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
  }
}

start: Start Request {
  shape: circle
  class: success
}

increment: Increment Counter {
  shape: rectangle
  class: process
}

modulo: Index = Counter % Server Count {
  shape: rectangle
  class: process
}

health_check: Server Healthy? {
  shape: diamond
  class: decision
}

select_server: Select Backend Server {
  shape: rectangle
  class: success
}

try_next: Try Next Server {
  shape: rectangle
  class: process
}

all_checked: All Servers Checked? {
  shape: diamond
  class: decision
}

no_servers: No Healthy Servers {
  shape: rectangle
  class: error
}

forward_request: Forward Request {
  shape: rectangle
  class: success
}

start -> increment: New request
increment -> modulo: Update counter
modulo -> health_check: Calculate index
health_check -> select_server: Yes
health_check -> try_next: No
try_next -> all_checked: Check next
all_checked -> health_check: No
all_checked -> no_servers: Yes
select_server -> forward_request: Server ready
no_servers -> forward_request: Return error

counter_note: |md
  **Counter State**
  - Global counter increments on each request
  - Modulo operation ensures cycling through servers
  - Thread-safe increment required
| {
  shape: page
  near: top-right
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}