direction: right

title: CAS Retry Loop State Machine

# Initial state
init: {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  label: ""
}

# Main states
load: Load Value {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

compare: Compare {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

cas_attempt: CAS Attempt {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

backoff: Backoff {
  shape: circle
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

success: Success {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.double-border: true
}

failure: Failure {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#d63031"
  style.font-color: "#e6edf3"
  style.double-border: true
}

# State transitions
init -> load: start
load -> compare: value loaded
compare -> cas_attempt: prepare swap
cas_attempt -> success: CAS succeeded {
  style.stroke: "#3fb950"
  style.font-color: "#3fb950"
}
cas_attempt -> backoff: CAS failed {
  style.stroke: "#d63031"
  style.font-color: "#d63031"
}
cas_attempt -> failure: max retries exceeded {
  style.stroke: "#d63031"
  style.font-color: "#d63031"
}
backoff -> load: retry after delay {
  style.stroke: "#8b949e"
  style.font-color: "#8b949e"
}

# Notes
retry_note: |md
  **Exponential Backoff**
  - Linear: delay = attempt Ã— base
  - Exponential: delay = base^attempt
  - Random jitter to avoid thundering herd
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  near: bottom-left
}

cas_note: |md
  **Compare-And-Swap**
  1. Compare current with expected
  2. If equal, swap with new value
  3. Return success/failure atomically
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  near: top-right
}