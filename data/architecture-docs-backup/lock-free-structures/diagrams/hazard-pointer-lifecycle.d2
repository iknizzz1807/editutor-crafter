title: Hazard Pointer Memory Lifecycle

classes: {
  allocation: {
    style.fill: "#2d3748"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  protection: {
    style.fill: "#1a365d"
    style.stroke: "#4299e1"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  retirement: {
    style.fill: "#742a2a"
    style.stroke: "#f56565"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  scanning: {
    style.fill: "#44337a"
    style.stroke: "#9f7aea"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  reclamation: {
    style.fill: "#22543d"
    style.stroke: "#48bb78"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  decision: {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  memory: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

start: Start {
  shape: circle
  class: allocation
  style.fill: "#3fb950"
  label: ""
}

allocate_node: Allocate Node {
  class: allocation
}

set_hazard: Set Hazard Pointer {
  class: protection
}

access_node: Access Node Safely {
  class: protection
}

clear_hazard: Clear Hazard Pointer {
  class: protection
}

retire_node: Add to Retire List {
  class: retirement
}

check_threshold: Retire List Full? {
  shape: diamond
  class: decision
}

scan_hazards: Scan All Hazard Pointers {
  class: scanning
}

check_protected: Node Protected? {
  shape: diamond
  class: decision
}

defer_node: Keep in Retire List {
  class: retirement
}

reclaim_memory: Free Memory {
  class: reclamation
}

finish: Complete {
  shape: circle
  style.double-border: true
  class: reclamation
}

memory_pool: Available Memory {
  shape: cylinder
  class: memory
}

hazard_array: Hazard Pointer Array {
  shape: cylinder
  class: memory
}

retire_list: Retirement List {
  shape: cylinder
  class: memory
}

start -> allocate_node: Thread requests node

allocate_node -> memory_pool: Get memory
memory_pool -> allocate_node: Return pointer

allocate_node -> set_hazard: Before access

set_hazard -> hazard_array: Record pointer
hazard_array -> set_hazard: Protect node

set_hazard -> access_node: Node protected

access_node -> clear_hazard: Work complete

clear_hazard -> hazard_array: Remove protection

clear_hazard -> retire_node: Ready to retire

retire_node -> retire_list: Add node

retire_list -> check_threshold: Check size

check_threshold -> scan_hazards: Yes (threshold reached)
check_threshold -> finish: No (continue)

scan_hazards -> hazard_array: Read all pointers

scan_hazards -> check_protected: For each retired node

check_protected -> defer_node: Yes (still referenced)
check_protected -> reclaim_memory: No (safe to free)

defer_node -> retire_list: Keep for later

reclaim_memory -> memory_pool: Return to pool

reclaim_memory -> finish: Cleanup complete

retire_node -> finish: Node queued