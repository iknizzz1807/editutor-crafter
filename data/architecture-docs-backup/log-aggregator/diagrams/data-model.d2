title: Data Model Relationships

classes: {
  data_model: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  key_type: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  storage_type: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

LogEntry: {
  shape: class
  class: key_type
  - "timestamp: time.Time"
  - "labels: Labels"
  - "message: string"
  - "stream_id: string"
  + "get_stream_id(): string"
  + "marshal(): []byte"
}

Labels: {
  shape: class
  class: data_model
  - "data: Map<string, string>"
  - "hash: uint64"
  + "get(key: string): string"
  + "set(key: string, value: string)"
  + "hash(): uint64"
  + "to_string(): string"
}

IndexStructures: {
  class: storage_type
  
  StreamIndex: {
    shape: class
    class: data_model
    - "stream_id: string"
    - "labels_hash: uint64"
    - "first_entry: time.Time"
    - "last_entry: time.Time"
    - "chunk_refs: ChunkRef[]"
    + "add_chunk_ref(ref: ChunkRef)"
    + "find_chunks(start: time.Time, end: time.Time): ChunkRef[]"
  }

  LabelIndex: {
    shape: class
    class: data_model
    - "label_key: string"
    - "values: Map<string, string[]>"
    + "add_stream(value: string, stream_id: string)"
    + "find_streams(value: string): string[]"
  }

  TimeIndex: {
    shape: class
    class: data_model
    - "time_bucket: time.Time"
    - "stream_ids: string[]"
    + "add_stream(stream_id: string)"
    + "get_streams(): string[]"
  }
}

ChunkStructures: {
  class: storage_type

  Chunk: {
    shape: class
    class: key_type
    - "chunk_id: string"
    - "stream_id: string"
    - "start_time: time.Time"
    - "end_time: time.Time"
    - "entries: LogEntry[]"
    - "compressed_data: byte[]"
    - "encoding: CompressionType"
    + "add_entry(entry: LogEntry)"
    + "compress(): error"
    + "decompress(): (LogEntry[], error)"
  }

  ChunkRef: {
    shape: class
    class: data_model
    - "chunk_id: string"
    - "start_time: time.Time"
    - "end_time: time.Time"
    - "size_bytes: int64"
    - "entry_count: int"
    + "overlaps(start: time.Time, end: time.Time): bool"
  }
}

LogEntry -> Labels: contains {
  style.stroke: "#8b949e"
}

LogEntry -> IndexStructures.StreamIndex: "indexed by" {
  style.stroke: "#8b949e"
}

Labels -> IndexStructures.LabelIndex: "indexed by" {
  style.stroke: "#8b949e"
}

IndexStructures.StreamIndex -> ChunkStructures.ChunkRef: "references (1:N)" {
  style.stroke: "#8b949e"
}

IndexStructures.TimeIndex -> IndexStructures.StreamIndex: "groups (1:N)" {
  style.stroke: "#8b949e"
}

ChunkStructures.ChunkRef -> ChunkStructures.Chunk: "points to (1:1)" {
  style.stroke: "#8b949e"
}

ChunkStructures.Chunk -> LogEntry: "stores (1:N)" {
  style.stroke: "#8b949e"
}

cardinality_note: |md
  **Key Relationships:**
  • LogEntry : Labels = 1:1 (each entry has one label set)
  • StreamIndex : ChunkRef = 1:N (stream spans multiple chunks)
  • Chunk : LogEntry = 1:N (chunk contains multiple entries)
  • LabelIndex : StreamID = 1:N (label value maps to multiple streams)
| {
  shape: page
  class: data_model
  near: bottom-center
}