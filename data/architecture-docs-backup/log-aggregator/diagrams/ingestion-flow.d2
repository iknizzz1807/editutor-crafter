shape: sequence_diagram

# Actors
http_source: HTTP Source
tcp_source: TCP Source
udp_source: UDP Source
load_balancer: Load Balancer
parser: Parser Engine
buffer_manager: Buffer Manager
indexer: Indexer
storage: Storage Engine
error_handler: Error Handler

# Style definitions
classes: {
  source_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  engine_style: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  error_style: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
  }
}

# Apply styles
http_source.class: source_style
tcp_source.class: source_style
udp_source.class: source_style
load_balancer.class: engine_style
parser.class: engine_style
buffer_manager.class: engine_style
indexer.class: engine_style
storage.class: engine_style
error_handler.class: error_style

# Main ingestion flow
http_source -> load_balancer: POST /logs (JSON)
tcp_source -> load_balancer: TCP stream
udp_source -> load_balancer: UDP packets

load_balancer -> parser: route by format
parser -> parser: validate & parse
parser -> buffer_manager: parsed log entries
buffer_manager -> buffer_manager: memory buffer

# Normal path
buffer_manager -> indexer: batch of entries
indexer -> indexer: extract labels
indexer -> storage: indexed entries
storage -> buffer_manager: ACK

# Error handling path
parser -> error_handler: invalid format
error_handler -> buffer_manager: log to error stream

# Backpressure handling
indexer -> buffer_manager: BUSY signal
buffer_manager -> buffer_manager: spill to disk
buffer_manager -> load_balancer: throttle signal
load_balancer -> http_source: 429 Too Many Requests

# Recovery flow
storage -> buffer_manager: ready for more
buffer_manager -> indexer: resume from disk buffer
indexer -> storage: cached entries
buffer_manager -> load_balancer: resume normal rate