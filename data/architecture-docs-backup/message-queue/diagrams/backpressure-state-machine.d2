title: Backpressure Control States

classes: {
  state_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  warning_style: {
    style.fill: "#16213e"
    style.stroke: "#f39c12"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  throttled_style: {
    style.fill: "#16213e"
    style.stroke: "#d63031"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  transition_style: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

init: {
  shape: circle
  style.fill: "#3fb950"
  label: ""
  style.stroke: "#3fb950"
}

normal: Normal {
  shape: circle
  class: state_style
}

warning: Warning {
  shape: circle
  class: warning_style
}

throttled: Throttled {
  shape: circle
  class: throttled_style
}

init -> normal: Start {
  class: transition_style
}

normal -> warning: lag > warning_threshold {
  class: transition_style
}

warning -> throttled: lag > critical_threshold {
  class: transition_style
}

throttled -> warning: lag < critical_threshold {
  class: transition_style
}

warning -> normal: lag < warning_threshold {
  class: transition_style
}

normal -> normal: publish accepted {
  class: transition_style
}

warning -> warning: publish rate limited {
  class: transition_style
}

throttled -> throttled: publish rejected {
  class: transition_style
}

legend: State Behaviors {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  normal_desc: "• Accept all publishes\n• No rate limiting\n• Monitor consumer lag"
  warning_desc: "• Apply rate limiting\n• Send warnings to publishers\n• Increase monitoring frequency"
  throttled_desc: "• Reject new publishes\n• Force backpressure\n• Alert system operators"
  
  normal_desc: {
    style.font-color: "#e6edf3"
    near: top-left
  }
  warning_desc: {
    style.font-color: "#e6edf3"
    near: center-left
  }
  throttled_desc: {
    style.font-color: "#e6edf3"
    near: bottom-left
  }
}