title: Message Lifecycle State Machine

classes: {
  state_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  initial_state: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#1a1a2e"
    style.bold: true
  }
  
  final_state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.double-border: true
    style.bold: true
  }
  
  transition_label: {
    style.font-color: "#8b949e"
    style.italic: true
  }
}

init: {
  shape: circle
  class: initial_state
  label: ""
}

created: Created {
  shape: circle
  class: state_style
}

queued: Queued {
  shape: circle
  class: state_style
}

pending: Pending {
  shape: circle
  class: state_style
}

acknowledged: Acknowledged {
  shape: circle
  class: final_state
}

dead_letter: Dead Letter {
  shape: circle
  class: final_state
}

failed: Failed {
  shape: circle
  class: state_style
}

redelivery: Redelivery {
  shape: circle
  class: state_style
}

init -> created: "message.publish()"

created -> queued: "enqueue"

queued -> pending: "consumer.receive()"

pending -> acknowledged: "ack()"

pending -> failed: "nack() | timeout"

failed -> redelivery: "retry_count < max_retries"

failed -> dead_letter: "retry_count >= max_retries"

redelivery -> pending: "redeliver"

pending -> pending: "processing..." {
  class: transition_label
}

notes: |md
  ## Message States
  - **Created**: Message instantiated by producer
  - **Queued**: Message stored in topic/queue
  - **Pending**: Message delivered, awaiting acknowledgment
  - **Acknowledged**: Message successfully processed
  - **Failed**: Processing failed or timed out
  - **Redelivery**: Message queued for retry
  - **Dead Letter**: Maximum retries exceeded
| {
  shape: page
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: top-right
}