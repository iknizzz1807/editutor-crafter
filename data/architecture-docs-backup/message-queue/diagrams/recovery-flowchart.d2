title: Crash Recovery Process {
  near: top-center
  style.font-size: 24
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  start_node: {
    style.fill: "#3fb950"
    style.stroke: "#2ea043"
    style.font-color: "#ffffff"
    style.bold: true
  }
  process_node: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision_node: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  end_node: {
    style.fill: "#2ea043"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
    style.bold: true
  }
  error_node: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
  }
}

start: Broker Startup {
  shape: circle
  class: start_node
}

check_wal: Check WAL File {
  shape: diamond
  class: decision_node
}

wal_exists: WAL Exists? {
  shape: diamond
  class: decision_node
}

read_wal: Read WAL Entries\nSequentially {
  class: process_node
}

parse_entry: Parse Log Entry {
  class: process_node
}

entry_type: Entry Type? {
  shape: diamond
  class: decision_node
}

restore_message: Restore Message\nto Topic {
  class: process_node
}

restore_ack: Process Consumer\nAcknowledgment {
  class: process_node
}

restore_group: Restore Consumer\nGroup State {
  class: process_node
}

more_entries: More Entries? {
  shape: diamond
  class: decision_node
}

rebuild_topics: Rebuild Topic\nState & Indexes {
  class: process_node
}

rebuild_consumers: Rebuild Consumer\nGroup Assignments {
  class: process_node
}

validate_state: Validate\nRecovered State {
  shape: diamond
  class: decision_node
}

resume_ops: Resume Normal\nOperations {
  class: end_node
}

clean_start: Initialize Empty\nBroker State {
  class: process_node
}

recovery_error: Recovery Failed\nExit with Error {
  class: error_node
}

start -> check_wal
check_wal -> wal_exists
wal_exists -> read_wal: Yes
wal_exists -> clean_start: No

read_wal -> parse_entry
parse_entry -> entry_type

entry_type -> restore_message: Message
entry_type -> restore_ack: Acknowledgment
entry_type -> restore_group: Group Change

restore_message -> more_entries
restore_ack -> more_entries
restore_group -> more_entries

more_entries -> parse_entry: Yes
more_entries -> rebuild_topics: No

rebuild_topics -> rebuild_consumers
rebuild_consumers -> validate_state

validate_state -> resume_ops: Valid
validate_state -> recovery_error: Invalid

clean_start -> resume_ops