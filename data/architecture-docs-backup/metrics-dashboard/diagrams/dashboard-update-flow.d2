shape: sequence_diagram

client: Dashboard Client
gateway: WebSocket Gateway
metrics_api: Metrics API
tsdb: Time Series DB
cache: Redis Cache

client -> gateway: Connect WebSocket
gateway -> client: Connection established

client -> gateway: "Subscribe to metrics\n{dashboard_id, metrics[]}"
gateway -> metrics_api: Register subscription
metrics_api -> cache: Cache subscription
cache -> metrics_api: Subscription stored
metrics_api -> gateway: Subscription confirmed
gateway -> client: Subscription active

metrics_api -> tsdb: "Query latest metrics\n(30s interval)"
tsdb -> metrics_api: Metric data
metrics_api -> cache: Update cached values
cache -> metrics_api: Cache updated

metrics_api -> gateway: "Push metric updates\n{timestamp, values}"
gateway -> client: "WebSocket message\n{type: metrics, data}"

client -> gateway: "Request historical data\n{metric_id, time_range}"
gateway -> metrics_api: Historical query
metrics_api -> tsdb: Query time range
tsdb -> metrics_api: Historical data points
metrics_api -> gateway: Historical response
gateway -> client: Historical data

metrics_api -> tsdb: "Periodic refresh query\n(10s interval)"
tsdb -> metrics_api: Fresh metric values
metrics_api -> cache: Batch update cache
metrics_api -> gateway: Broadcast updates
gateway -> client: Live data push

client -> gateway: Disconnect
gateway -> metrics_api: Cleanup subscription
metrics_api -> cache: Remove subscription
cache -> metrics_api: Cleaned up