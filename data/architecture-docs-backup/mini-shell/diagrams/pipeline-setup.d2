classes: {
  shell_component: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  process_node: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  pipe_flow: {
    style.stroke: "#3fb950"
    style.stroke-width: 2
  }
  fd_manipulation: {
    style.stroke: "#f39c12"
    style.stroke-dash: 3
  }
}

title: "Pipeline Creation Process" {
  style.font-size: 20
  style.font-color: "#e6edf3"
  style.bold: true
}

input: "Command Input\ncat file.txt | grep pattern | wc -l" {
  shape: oval
  class: shell_component
}

parser: "Command Parser" {
  class: shell_component
}

pipeline_manager: "Pipeline Manager" {
  class: shell_component
  
  pipe_creation: "Pipe Creation\npipe()" {
    class: process_node
  }
  
  fd_setup: "File Descriptor\nSetup" {
    class: process_node
  }
  
  process_spawn: "Process Spawning\nfork() + exec()" {
    class: process_node
  }
}

processes: "Process Execution" {
  class: shell_component
  
  proc1: "Process 1\ncat file.txt" {
    class: process_node
    stdout_desc: "stdout → pipe[1]"
  }
  
  proc2: "Process 2\ngrep pattern" {
    class: process_node
    stdin_desc: "stdin ← pipe[0]"
    stdout_desc: "stdout → pipe[1]"
  }
  
  proc3: "Process 3\nwc -l" {
    class: process_node
    stdin_desc: "stdin ← pipe[0]"
  }
}

pipe1: "Pipe 1\nfd[0], fd[1]" {
  shape: cylinder
  class: process_node
}

pipe2: "Pipe 2\nfd[0], fd[1]" {
  shape: cylinder
  class: process_node
}

wait_collect: "Wait & Collect\nExit Status" {
  class: shell_component
}

input -> parser: "parse command"
parser -> pipeline_manager: "create pipeline"
pipeline_manager.pipe_creation -> pipe1: "create pipe()"
pipeline_manager.pipe_creation -> pipe2: "create pipe()"
pipeline_manager.fd_setup -> processes.proc1: "setup stdout" {class: fd_manipulation}
pipeline_manager.fd_setup -> processes.proc2: "setup stdin/stdout" {class: fd_manipulation}
pipeline_manager.fd_setup -> processes.proc3: "setup stdin" {class: fd_manipulation}
pipeline_manager.process_spawn -> processes.proc1: "fork + exec"
pipeline_manager.process_spawn -> processes.proc2: "fork + exec"
pipeline_manager.process_spawn -> processes.proc3: "fork + exec"

processes.proc1 -> pipe1: "write data" {class: pipe_flow}
pipe1 -> processes.proc2: "read data" {class: pipe_flow}
processes.proc2 -> pipe2: "write filtered" {class: pipe_flow}
pipe2 -> processes.proc3: "read filtered" {class: pipe_flow}

processes -> wait_collect: "all processes created"
wait_collect -> input: "return result"

note: "**Key Steps:**\n1. Parse pipeline command\n2. Create pipes with pipe()\n3. Fork processes in sequence\n4. Set up file descriptors (dup2)\n5. Close unused pipe ends\n6. Wait for all processes" {
  shape: page
  near: bottom-right
  style.fill: "#0f3460"
  style.font-color: "#e6edf3"
}