title: Batching System State Machine

classes: {
  state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  initial: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#1a1a2e"
    style.bold: true
  }
  final: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.double-border: true
    style.bold: true
  }
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

init: {
  shape: circle
  class: initial
  label: ""
}

empty: Empty {
  shape: circle
  class: state
}

collecting: Collecting {
  shape: circle
  class: state
}

ready: Ready {
  shape: circle
  class: state
}

processing: Processing {
  shape: circle
  class: state
}

completed: Completed {
  shape: circle
  class: final
}

init -> empty: {
  class: transition
  label: "System Start"
}

empty -> collecting: {
  class: transition
  label: "First Request\nArrives"
}

collecting -> collecting: {
  class: transition
  label: "Additional\nRequest"
}

collecting -> ready: {
  class: transition
  label: "Batch Full\n(max_batch_size)"
}

collecting -> ready: {
  class: transition
  label: "Timeout Expired\n(max_wait_time)"
}

ready -> processing: {
  class: transition
  label: "Model Engine\nAvailable"
}

processing -> completed: {
  class: transition
  label: "Inference\nComplete"
}

completed -> empty: {
  class: transition
  label: "Results Sent\nto Clients"
}

timeout_note: |md
  **Timeout Triggers:**
  - max_wait_time: Prevents request starvation
  - max_batch_size: Optimizes GPU utilization
  
  **Bus Analogy:**
  Departs when full OR time limit reached
| {
  shape: page
  near: top-right
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}