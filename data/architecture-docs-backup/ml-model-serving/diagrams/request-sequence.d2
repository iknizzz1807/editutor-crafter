shape: sequence_diagram

client: Client
gateway: "API Gateway"  
validator: "Request Validator"
batcher: "Dynamic Batcher"
ab_router: "A/B Router"
model_a: "Model A (v1.2)"
model_b: "Model B (v1.3)"
response_handler: "Response Handler"

client -> gateway: "HTTP POST /predict"
gateway -> validator: "validate_request()"
validator -> gateway: validation_result
gateway -> batcher: "queue_request(request_id, payload)"
batcher -> batcher: "wait_for_batch(max_size=8, timeout=50ms)"
batcher -> ab_router: "process_batch([req1, req2, ...])"
ab_router -> ab_router: "determine_routing(user_id, experiment_config)"
ab_router -> model_a: "infer_batch(requests_group_a)"
ab_router -> model_b: "infer_batch(requests_group_b)"
model_a -> ab_router: predictions_a
model_b -> ab_router: predictions_b
ab_router -> response_handler: "combined_results(predictions, routing_info)"
response_handler -> response_handler: "route_responses_to_requests()"
response_handler -> gateway: individual_responses
gateway -> client: "HTTP 200 {prediction: 0.87, model_version: 1.2}"

classes: {
  timing: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

client.class: process
gateway.class: process
validator.class: process
batcher.class: timing
ab_router.class: process
model_a.class: timing
model_b.class: timing
response_handler.class: process