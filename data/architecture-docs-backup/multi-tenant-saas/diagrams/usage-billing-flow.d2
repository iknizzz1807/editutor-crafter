title: Usage Tracking and Billing Flow

classes: {
  container: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  process: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  data: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#d63031"
    style.font-color: "#ffffff"
    style.stroke: "#e17055"
    style.bold: true
  }
  external: {
    style.fill: "#2d3748"
    style.stroke: "#4a5568"
    style.font-color: "#e6edf3"
  }
}

app_layer: Application Layer {
  class: container
  
  api: API Endpoints {
    class: process
  }
  
  service: Service Logic {
    class: process
  }
  
  tracker: Usage Tracker {
    class: process
  }
}

event_capture: Event Capture {
  class: container
  
  events: Usage Events {
    shape: queue
    class: data
  }
  
  validator: Event Validator {
    class: process
  }
  
  deduplicator: Deduplication {
    class: process
  }
}

aggregation: Aggregation Pipeline {
  class: container
  
  processor: Event Processor {
    class: process
  }
  
  aggregator: Usage Aggregator {
    class: process
  }
  
  scheduler: Batch Scheduler {
    class: process
  }
}

quota_system: Quota System {
  class: container
  
  checker: Quota Checker {
    shape: diamond
    class: decision
  }
  
  limits: Usage Limits {
    shape: cylinder
    class: data
  }
  
  enforcer: Limit Enforcer {
    class: process
  }
}

billing: Billing Integration {
  class: container
  
  calculator: Usage Calculator {
    class: process
  }
  
  sync: Stripe Sync {
    class: process
  }
  
  invoice: Invoice Generator {
    class: process
  }
}

storage: Data Storage {
  class: container
  
  raw_events: Raw Events DB {
    shape: cylinder
    class: data
  }
  
  aggregated: Aggregated Usage DB {
    shape: cylinder
    class: data
  }
  
  tenant_data: Tenant Config DB {
    shape: cylinder
    class: data
  }
}

stripe: Stripe API {
  shape: cloud
  class: external
}

overage: Overage Handler {
  class: process
}

# Main flow
app_layer.api -> app_layer.service: request
app_layer.service -> app_layer.tracker: emit usage event
app_layer.tracker -> event_capture.events: publish event

event_capture.events -> event_capture.validator: consume
event_capture.validator -> event_capture.deduplicator: validate
event_capture.deduplicator -> storage.raw_events: store event

storage.raw_events -> aggregation.processor: batch read
aggregation.processor -> aggregation.aggregator: process events
aggregation.scheduler -> aggregation.aggregator: trigger batch
aggregation.aggregator -> storage.aggregated: store usage

# Quota checking
app_layer.service -> quota_system.checker: check quota
quota_system.checker -> storage.tenant_data: get limits
quota_system.limits -> quota_system.checker: current usage
quota_system.checker -> quota_system.enforcer: within limits?
quota_system.checker -> overage: exceeded limits
quota_system.enforcer -> app_layer.service: allow/deny

# Billing flow
storage.aggregated -> billing.calculator: usage data
billing.calculator -> billing.sync: calculated charges
billing.sync -> stripe: create usage records
billing.sync -> billing.invoice: billing data
billing.invoice -> stripe: generate invoice

# Overage handling
overage -> storage.tenant_data: update usage
overage -> billing.sync: immediate billing
overage -> app_layer.service: throttle/block

# Data relationships
storage.tenant_data -> quota_system.limits: tenant configs
storage.aggregated -> billing.calculator: usage metrics
stripe -> billing.sync: webhooks

app_layer.api.label: "Tenant API Requests"
event_capture.events.label: "Event Queue"
quota_system.checker.label: "Within Quota?"
storage.raw_events.label: "Time-series Events"
storage.aggregated.label: "Billing Periods"
billing.sync.label: "Stripe Integration"