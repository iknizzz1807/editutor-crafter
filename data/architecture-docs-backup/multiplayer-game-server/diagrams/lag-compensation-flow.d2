direction: down

title: Lag Compensation Hit Detection Flow {
  style.font-size: 24
  style.font-color: "#e6edf3"
}

# Start
start: Start {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
}

# Main process flow
receive_hit: Receive Hit Request {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

measure_latency: Measure Client Latency {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

calc_rewind: Calculate Rewind Time {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

rewind_check: Rewind Time Valid? {
  shape: diamond
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Rewind buffer management
buffer_system: Rewind Buffer System {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  get_snapshot: Get Historical Snapshot {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  restore_state: Restore Game State {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

# Hit validation
validate_hit: Validate Hit {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

hit_valid: Hit Valid? {
  shape: diamond
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Responses
apply_damage: Apply Damage {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

reject_hit: Reject Hit {
  style.fill: "#1a1a2e"
  style.stroke: "#d63031"
  style.font-color: "#e6edf3"
}

send_response: Send Response to Client {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# End
end: End {
  shape: circle
  style.fill: "#8b949e"
  style.stroke: "#8b949e"
}

# Flow connections
start -> receive_hit

receive_hit -> measure_latency

measure_latency -> calc_rewind

calc_rewind -> rewind_check

rewind_check -> reject_hit: No / Too Old {
  style.stroke: "#d63031"
}

rewind_check -> buffer_system.get_snapshot: Yes {
  style.stroke: "#3fb950"
}

buffer_system.get_snapshot -> buffer_system.restore_state

buffer_system.restore_state -> validate_hit

validate_hit -> hit_valid

hit_valid -> apply_damage: Yes {
  style.stroke: "#3fb950"
}

hit_valid -> reject_hit: No {
  style.stroke: "#d63031"
}

apply_damage -> send_response

reject_hit -> send_response

send_response -> end