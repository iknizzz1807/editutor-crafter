title: Operation Dispatch Mechanism

classes: {
  container_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  operation_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  backward_style: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  registry_style: {
    style.fill: "#2d1b69"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

operation_registry: Operation Registry {
  class: registry_style
  shape: cylinder
}

operations: Mathematical Operations {
  class: container_style
  
  add_op: Add Operation {
    class: operation_style
  }
  
  mul_op: Multiply Operation {
    class: operation_style
  }
  
  tanh_op: Tanh Operation {
    class: operation_style
  }
  
  relu_op: ReLU Operation {
    class: operation_style
  }
}

backward_functions: Backward Functions {
  class: container_style
  
  add_backward: "def add_backward(out)" {
    class: backward_style
    shape: page
  }
  
  mul_backward: "def mul_backward(out)" {
    class: backward_style
    shape: page
  }
  
  tanh_backward: "def tanh_backward(out)" {
    class: backward_style
    shape: page
  }
  
  relu_backward: "def relu_backward(out)" {
    class: backward_style
    shape: page
  }
}

backprop_engine: Backpropagation Engine {
  class: container_style
  
  dispatcher: Operation Dispatcher {
    class: operation_style
  }
  
  gradient_computer: Gradient Computer {
    class: operation_style
  }
}

# Registration phase
operations.add_op -> operation_registry: register backward function {
  style.stroke: "#3fb950"
  style.bold: true
}
operations.mul_op -> operation_registry: register backward function {
  style.stroke: "#3fb950"
}
operations.tanh_op -> operation_registry: register backward function {
  style.stroke: "#3fb950"
}
operations.relu_op -> operation_registry: register backward function {
  style.stroke: "#3fb950"
}

# Backward function association
backward_functions.add_backward -> operation_registry: stored as add_backward {
  style.stroke: "#8b949e"
}
backward_functions.mul_backward -> operation_registry: stored as mul_backward {
  style.stroke: "#8b949e"
}
backward_functions.tanh_backward -> operation_registry: stored as tanh_backward {
  style.stroke: "#8b949e"
}
backward_functions.relu_backward -> operation_registry: stored as relu_backward {
  style.stroke: "#8b949e"
}

# Backpropagation dispatch
backprop_engine.dispatcher -> operation_registry: lookup backward function {
  style.stroke: "#e17055"
  style.bold: true
}

operation_registry -> backprop_engine.gradient_computer: dispatch appropriate backward function {
  style.stroke: "#e17055"
  style.bold: true
}

# Note explaining the mechanism
dispatch_note: |md
  **Operation Dispatch Flow:**
  1. Operations register their backward functions
  2. Registry maps operation types to functions
  3. During backprop, dispatcher looks up function
  4. Appropriate backward function is called
| {
  shape: page
  class: backward_style
  near: bottom-center
}