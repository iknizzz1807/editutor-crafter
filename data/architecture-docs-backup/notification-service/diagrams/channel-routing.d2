title: Channel Routing Decision Flow

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  failure: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  success: {
    style.fill: "#00b894"
    style.stroke: "#00a085"
    style.font-color: "#ffffff"
  }
}

start: Start {
  shape: circle
  class: success
  label: ""
}

check_prefs: Check User\nPreferences {
  class: process
}

validate_channel: Validate Channel\nAvailability {
  shape: diamond
  class: decision
}

quiet_hours: Apply Quiet\nHours Rules {
  shape: diamond
  class: decision
}

rate_limits: Check Rate\nLimits {
  shape: diamond
  class: decision
}

select_primary: Select Primary\nChannel {
  class: process
}

send_primary: Send via\nPrimary Channel {
  class: process
}

primary_success: Primary\nSuccess? {
  shape: diamond
  class: decision
}

try_fallback: Try Fallback\nChannel {
  class: process
}

fallback_success: Fallback\nSuccess? {
  shape: diamond
  class: decision
}

update_breaker: Update Circuit\nBreaker State {
  class: process
}

complete: Complete {
  shape: circle
  class: success
  label: ""
}

failed: Failed {
  shape: circle
  class: failure
  label: ""
}

start -> check_prefs
check_prefs -> validate_channel
validate_channel -> quiet_hours: Available
validate_channel -> failed: Not Available
quiet_hours -> rate_limits: Within Hours
quiet_hours -> failed: Quiet Hours
rate_limits -> select_primary: Within Limits
rate_limits -> failed: Rate Limited
select_primary -> send_primary
send_primary -> primary_success
primary_success -> complete: Success
primary_success -> try_fallback: Failure
try_fallback -> fallback_success
fallback_success -> update_breaker: Success
fallback_success -> update_breaker: Failure
update_breaker -> complete
update_breaker -> failed