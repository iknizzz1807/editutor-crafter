direction: right

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  safety: {
    style.fill: "#0f3460"
    style.stroke: "#e17055"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  data: {
    style.fill: "#2d3748"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

start: Load Template {
  class: process
}

detect_locale: Detect User Locale {
  class: process
}

locale_check: Locale Available? {
  shape: diamond
  class: decision
}

apply_fallback: Apply Fallback Locale {
  class: process
}

substitute: Substitute Variables {
  class: process
}

sanitize: Sanitize Content {
  class: safety
}

format_check: Output Format? {
  shape: diamond
  class: decision
}

html_format: Format as HTML {
  class: process
}

text_format: Format as Plain Text {
  class: process
}

sms_format: Format for SMS {
  class: process
}

template_data: Template Store {
  shape: cylinder
  class: data
}

locale_data: Locale Repository {
  shape: cylinder
  class: data
}

output: Formatted Message {
  class: process
  style.fill: "#3fb950"
  style.font-color: "#000"
}

start -> detect_locale
start -> template_data: "fetch by\nname/version"
detect_locale -> locale_check
locale_check -> apply_fallback: No
locale_check -> substitute: Yes
apply_fallback -> locale_data: "get fallback"
apply_fallback -> substitute
substitute -> sanitize: "XSS protection"
sanitize -> format_check
format_check -> html_format: HTML Email
format_check -> text_format: Plain Text
format_check -> sms_format: SMS
html_format -> output
text_format -> output
sms_format -> output

localization_note: |md
  **Localization & Safety**
  - Fallback chain prevents missing content
  - XSS sanitization for all channels
  - Channel-specific formatting rules
| {
  shape: page
  class: data
  near: bottom-right
}