title: Concurrency and Threading Model {
  near: top-center
  style.font-size: 18
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  thread_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  data_structure: {
    style.fill: "#16213e"
    style.stroke: "#58a6ff"
    style.font-color: "#e6edf3"
  }
  lock_free: {
    style.fill: "#0d1117"
    style.stroke: "#f85149"
    style.font-color: "#e6edf3"
  }
  shared_memory: {
    style.fill: "#0f3460"
    style.stroke: "#ffa657"
    style.font-color: "#e6edf3"
  }
}

matching_thread: Matching Engine Thread {
  class: thread_style
  shape: rectangle
}

io_threads: I/O Threads {
  class: thread_style
  
  order_receiver: Order Receiver Thread {
    class: thread_style
  }
  
  market_data: Market Data Thread {
    class: thread_style
  }
  
  trade_publisher: Trade Publisher Thread {
    class: thread_style
  }
}

shared_data: Shared Data Structures {
  class: shared_memory
  
  order_book: Order Book {
    class: data_structure
    shape: cylinder
  }
  
  order_queue: Incoming Order Queue {
    class: lock_free
    shape: queue
  }
  
  trade_queue: Trade Output Queue {
    class: lock_free
    shape: queue
  }
  
  position_cache: Position Cache {
    class: data_structure
    shape: cylinder
  }
}

lock_free_zone: Lock-Free Section {
  class: lock_free
  
  spsc_queues: SPSC Queues {
    class: lock_free
    shape: queue
  }
  
  atomic_counters: Atomic Counters {
    class: lock_free
  }
}

rw_section: Reader-Writer Section {
  class: shared_memory
  
  price_levels: Price Level Map {
    class: data_structure
    shape: cylinder
  }
  
  symbol_index: Symbol Index {
    class: data_structure
    shape: cylinder
  }
}

io_threads.order_receiver -> shared_data.order_queue: enqueue orders {
  style.stroke: "#3fb950"
}

matching_thread -> shared_data.order_queue: dequeue orders {
  style.stroke: "#3fb950"
}

matching_thread -> shared_data.order_book: read/write {
  style.stroke: "#58a6ff"
}

matching_thread -> shared_data.trade_queue: publish trades {
  style.stroke: "#3fb950"
}

io_threads.trade_publisher -> shared_data.trade_queue: consume trades {
  style.stroke: "#3fb950"
}

io_threads.market_data -> rw_section.price_levels: read prices {
  style.stroke: "#ffa657"
}

matching_thread -> rw_section.price_levels: write prices {
  style.stroke: "#ffa657"
}

matching_thread -> lock_free_zone.spsc_queues: lock-free ops {
  style.stroke: "#f85149"
}

io_threads.order_receiver -> lock_free_zone.atomic_counters: increment stats {
  style.stroke: "#f85149"
}

matching_thread <-> shared_data.position_cache: update positions {
  style.stroke: "#58a6ff"
}

rw_lock_note: |md
  **Reader-Writer Locks**
  Multiple readers, single writer
  Used for reference data
| {
  shape: page
  near: bottom-left
  style.fill: "#0f3460"
  style.font-color: "#e6edf3"
}

lock_free_note: |md
  **Lock-Free Design**
  SPSC queues, atomic operations
  Critical path optimization
| {
  shape: page
  near: bottom-right
  style.fill: "#0d1117"
  style.font-color: "#e6edf3"
}