title: Market Data Publication Flow

classes: {
  container_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  process_style: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  decision_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  storage_style: {
    style.fill: "#2d3748"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  subscriber_style: {
    style.fill: "#1a202c"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

order_book: Order Book {
  class: storage_style
  shape: cylinder
}

trade_exec: Trade Execution {
  class: process_style
}

md_publisher: Market Data Publisher {
  class: container_style
  
  change_detector: Change Detector {
    class: process_style
  }
  
  conflation_engine: Conflation Engine {
    class: process_style
  }
  
  rate_limiter: Rate Limiter {
    class: decision_style
    shape: diamond
  }
  
  distributor: Message Distributor {
    class: process_style
  }
}

pending_updates: Pending Updates {
  class: storage_style
  shape: queue
}

subscribers: Subscribers {
  class: container_style
  
  trader_a: Trader A {
    class: subscriber_style
  }
  
  trader_b: Trader B {
    class: subscriber_style
  }
  
  analytics: Analytics Feed {
    class: subscriber_style
  }
  
  market_maker: Market Maker {
    class: subscriber_style
  }
}

order_book -> md_publisher.change_detector: Order Book\nChange Event

trade_exec -> md_publisher.change_detector: Trade\nExecution Event

md_publisher.change_detector -> md_publisher.conflation_engine: Raw Update

md_publisher.conflation_engine -> pending_updates: Store Update

pending_updates -> md_publisher.rate_limiter: Batch Updates

md_publisher.rate_limiter -> md_publisher.conflation_engine: Rate Exceeded {
  style.stroke: "#e55039"
  style.font-color: "#e55039"
}

md_publisher.rate_limiter -> md_publisher.distributor: Send Updates

md_publisher.distributor -> subscribers.trader_a: L1 Data

md_publisher.distributor -> subscribers.trader_b: L2 Data

md_publisher.distributor -> subscribers.analytics: Full Book

md_publisher.distributor -> subscribers.market_maker: Priority Feed

conflation_note: |md
  **Conflation Logic:**
  • Merge duplicate price levels
  • Drop stale updates
  • Batch by time window
| {
  shape: page
  class: container_style
  near: top-right
}