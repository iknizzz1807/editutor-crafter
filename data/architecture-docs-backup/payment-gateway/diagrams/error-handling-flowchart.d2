classes: {
  error: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  decision: {
    style.fill: "#fdcb6e"
    style.stroke: "#e17055"
    style.font-color: "#2d3436"
    style.bold: true
  }
  success: {
    style.fill: "#00b894"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
    style.bold: true
  }
  process: {
    style.fill: "#0984e3"
    style.stroke: "#74b9ff"
    style.font-color: "#ffffff"
  }
  fallback: {
    style.fill: "#a29bfe"
    style.stroke: "#6c5ce7"
    style.font-color: "#ffffff"
  }
}

start: Payment Error Detected {
  shape: circle
  class: error
}

classify: Classify Error Type {
  shape: diamond
  class: decision
}

network_error: Network/Timeout Error? {
  shape: diamond
  class: decision
}

retry_count: Retry Count < Max? {
  shape: diamond
  class: decision
}

exponential_backoff: Apply Exponential Backoff {
  class: process
}

retry_payment: Retry Payment {
  class: process
}

card_error: Card/Auth Error? {
  shape: diamond
  class: decision
}

decline_reason: Check Decline Reason {
  class: process
}

insufficient_funds: Insufficient Funds? {
  shape: diamond
  class: decision
}

invalid_card: Invalid Card Data? {
  shape: diamond
  class: decision
}

provider_error: Provider Error? {
  shape: diamond
  class: decision
}

provider_status: Check Provider Status {
  class: process
}

provider_down: Provider Down? {
  shape: diamond
  class: decision
}

fallback_provider: Switch to Fallback Provider {
  class: fallback
}

rate_limit: Rate Limited? {
  shape: diamond
  class: decision
}

wait_retry: Wait and Retry {
  class: process
}

validation_error: Validation Error? {
  shape: diamond
  class: decision
}

fix_request: Fix Request Data {
  class: process
}

unknown_error: Unknown Error {
  class: error
}

log_monitor: Log for Monitoring {
  class: process
}

user_friendly: Return User-Friendly Error {
  class: error
}

payment_success: Payment Successful {
  shape: circle
  class: success
}

permanent_failure: Permanent Failure {
  shape: circle
  class: error
}

start -> classify

classify -> network_error: Network/Timeout
classify -> card_error: Card/Auth
classify -> provider_error: Provider
classify -> validation_error: Validation
classify -> unknown_error: Other

network_error -> retry_count: Yes
network_error -> card_error: No

retry_count -> exponential_backoff: Yes
retry_count -> permanent_failure: No

exponential_backoff -> retry_payment
retry_payment -> payment_success: Success
retry_payment -> classify: Still Fails

card_error -> decline_reason: Yes
card_error -> provider_error: No

decline_reason -> insufficient_funds: Check Type
decline_reason -> invalid_card: Check Type

insufficient_funds -> user_friendly: Yes
invalid_card -> user_friendly: Yes

provider_error -> provider_status: Yes
provider_error -> validation_error: No

provider_status -> provider_down
provider_down -> fallback_provider: Yes
provider_down -> rate_limit: No

fallback_provider -> retry_payment

rate_limit -> wait_retry: Yes
rate_limit -> validation_error: No

wait_retry -> retry_payment

validation_error -> fix_request: Yes
validation_error -> unknown_error: No

fix_request -> retry_payment: Auto-fix
fix_request -> user_friendly: Manual Fix

unknown_error -> log_monitor
log_monitor -> user_friendly