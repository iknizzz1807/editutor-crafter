direction: right

classes: {
  state_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  initial_state: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#1a1a2e"
    style.bold: true
  }
  error_state: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  final_state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
    style.double-border: true
  }
}

init: {
  shape: circle
  class: initial_state
  label: ""
}

normal: Normal Operation {
  shape: circle
  class: state_style
}

fork_error: Fork Failed {
  shape: circle
  class: error_state
}

exec_error: Exec Failed {
  shape: circle
  class: error_state
}

pipe_error: Pipe Broken {
  shape: circle
  class: error_state
}

worker_crash: Worker Crashed {
  shape: circle
  class: error_state
}

retry_backoff: Retry Backoff {
  shape: circle
  class: state_style
}

cleanup: Cleanup Resources {
  shape: circle
  class: state_style
}

respawn: Respawn Worker {
  shape: circle
  class: state_style
}

terminated: Terminated {
  shape: circle
  class: final_state
}

init -> normal: startup

normal -> fork_error: fork() fails
normal -> exec_error: exec() fails
normal -> pipe_error: pipe write/read fails
normal -> worker_crash: SIGCHLD received

fork_error -> retry_backoff: retry limit not reached
fork_error -> terminated: retry limit exceeded

exec_error -> cleanup: clean zombie process
exec_error -> terminated: fatal error

pipe_error -> cleanup: close broken pipes
pipe_error -> respawn: recreate communication

worker_crash -> cleanup: reap child process
worker_crash -> respawn: replace worker

retry_backoff -> normal: backoff timer expires

cleanup -> normal: resources freed
cleanup -> respawn: ready for replacement
cleanup -> terminated: shutdown requested

respawn -> normal: worker successfully created
respawn -> fork_error: respawn fork fails

normal -> terminated: shutdown signal

title: Error Recovery State Machine {
  near: top-center
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
}