direction: right

title: Query Processing Sequence

shape: sequence_diagram

user: User
api: API Gateway
embed: Embedding Service
vector: Vector Store
llm: LLM Service
stream: Response Stream

user -> api: "POST /query\nWhat is machine learning?"
api -> embed: Generate query embedding
embed -> api: "embedding_vector[768]"
api -> vector: "Similarity search\n(embedding, top_k=10)"
vector -> api: "Retrieved chunks\n+ metadata + scores"

api -> llm: "Generate response\n(query + context chunks)"
llm -> stream: Start streaming
stream -> api: Token chunk 1
api -> user: "Machine learning is..."

stream -> api: Token chunk 2
api -> user: "a method of data analysis..."

stream -> api: Token chunk 3
api -> user: "that automates analytical..."

llm -> stream: Complete response
stream -> api: Final tokens + sources
api -> user: "Complete response\n+ source citations"

user -> api: "Query timeout (30s)" {class: timeout_style}
api -> user: 408 Request Timeout {class: timeout_style}

api -> embed: Service unavailable {class: error_style}
embed -> api: 503 Service Error {class: error_style}
api -> user: Embedding generation failed {class: error_style}

api -> vector: Connection timeout {class: timeout_style}
vector -> api: Database timeout {class: timeout_style}
api -> user: Search temporarily unavailable {class: timeout_style}

llm -> stream: Model overloaded {class: error_style}
stream -> api: 503 Service Error {class: error_style}
api -> user: "Generation service busy\nPlease retry" {class: error_style}

classes: {
  error_style: {
    style.stroke: "#d63031"
    style.font-color: "#ff6b6b"
  }
  success_style: {
    style.stroke: "#00b894"
    style.font-color: "#00cec9"
  }
  timeout_style: {
    style.stroke: "#fdcb6e"
    style.font-color: "#e17055"
  }
}