title: Hybrid Retrieval Architecture {
  near: top-center
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  container: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  component: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  storage: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  flow: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  important: {
    style.stroke: "#3fb950"
    style.bold: true
    style.font-color: "#e6edf3"
  }
}

query: User Query {
  shape: oval
  class: component
}

retrieval: Hybrid Retrieval System {
  class: container
  
  vector_search: Vector Similarity Search {
    class: component
    
    embedder: Query Embedder {
      class: component
    }
    
    vector_index: Vector Index {
      shape: cylinder
      class: storage
    }
    
    similarity: Similarity Calculator {
      class: component
    }
    
    embedder -> vector_index: search vectors
    vector_index -> similarity: candidate vectors
  }
  
  keyword_search: Keyword Search (BM25) {
    class: component
    
    tokenizer: Query Tokenizer {
      class: component
    }
    
    inverted_index: Inverted Index {
      shape: cylinder
      class: storage
    }
    
    bm25: BM25 Scorer {
      class: component
    }
    
    tokenizer -> inverted_index: term lookup
    inverted_index -> bm25: term frequencies
  }
  
  metadata_filter: Metadata Filtering {
    class: component
    
    filter_parser: Filter Parser {
      class: component
    }
    
    metadata_store: Metadata Store {
      shape: cylinder
      class: storage
    }
    
    filter_engine: Filter Engine {
      class: component
    }
    
    filter_parser -> metadata_store: query conditions
    metadata_store -> filter_engine: matching documents
  }
}

fusion: Result Fusion & Ranking {
  class: container
  
  scorer: Multi-Score Calculator {
    class: component
  }
  
  ranker: Hybrid Ranker {
    class: component
  }
  
  reranker: Neural Reranker {
    class: component
  }
  
  scorer -> ranker: weighted scores
  ranker -> reranker: candidate results
}

results: Ranked Results {
  shape: oval
  class: component
}

# Main flow
query -> retrieval.vector_search.embedder: semantic query {
  class: important
}

query -> retrieval.keyword_search.tokenizer: lexical query {
  class: important
}

query -> retrieval.metadata_filter.filter_parser: filters {
  class: important
}

# Scoring flows
retrieval.vector_search.similarity -> fusion.scorer: cosine scores {
  class: flow
}

retrieval.keyword_search.bm25 -> fusion.scorer: BM25 scores {
  class: flow
}

retrieval.metadata_filter.filter_engine -> fusion.scorer: filtered candidates {
  class: flow
}

# Final ranking
fusion.reranker -> results: top-k results {
  class: important
}

# Score combination note
score_note: |md
  **Hybrid Scoring:**
  - Vector: cosine similarity
  - Keyword: BM25 relevance
  - Combined: weighted fusion
  - Reranking: cross-encoder
| {
  shape: page
  near: bottom-right
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}