classes: {
  state: {
    shape: circle
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.stroke-width: 2
  }
  
  initial_state: {
    shape: circle
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#1a1a2e"
    style.stroke-width: 2
    label: ""
  }
  
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    style.stroke-width: 2
  }
  
  refill_transition: {
    style.stroke: "#3fb950"
    style.font-color: "#3fb950"
    style.stroke-width: 2
  }
  
  request_transition: {
    style.stroke: "#e17055"
    style.font-color: "#e17055"
    style.stroke-width: 2
  }
}

title: Token Bucket State Machine {
  near: top-center
  style.font-size: 24
  style.font-color: "#e6edf3"
  style.bold: true
}

# Initial state
init: {
  class: initial_state
}

# States
empty: Empty {
  class: state
}

partial: Partial {
  class: state
}

full: Full {
  class: state
}

# Initial transition
init -> empty: {
  class: transition
}

# Refill transitions (token addition)
empty -> partial: Refill Event\n(tokens < capacity) {
  class: refill_transition
}

empty -> full: Refill Event\n(tokens = capacity) {
  class: refill_transition
}

partial -> full: Refill Event\n(tokens = capacity) {
  class: refill_transition
}

partial -> partial: Refill Event\n(tokens < capacity) {
  class: refill_transition
}

# Self-loop for full state on refill
full -> full: Refill Event\n(tokens = capacity) {
  class: refill_transition
}

# Request transitions (token consumption)
full -> partial: Request\n(tokens > 0) {
  class: request_transition
}

full -> empty: Request\n(tokens = 0) {
  class: request_transition
}

partial -> empty: Request\n(tokens = 0) {
  class: request_transition
}

partial -> partial: Request\n(tokens > 0) {
  class: request_transition
}

# Denied requests (no state change)
empty -> empty: Request Denied\n(tokens = 0) {
  class: request_transition
  style.stroke-dash: 5
}

# Legend
legend: Legend {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: bottom-right
  
  refill_line: Refill Events {
    style.stroke: "#3fb950"
    style.font-color: "#3fb950"
    style.stroke-width: 3
  }
  
  request_line: Request Events {
    style.stroke: "#e17055"
    style.font-color: "#e17055"
    style.stroke-width: 3
  }
  
  denied_line: Denied Requests {
    style.stroke: "#e17055"
    style.font-color: "#e17055"
    style.stroke-dash: 5
    style.stroke-width: 3
  }
}