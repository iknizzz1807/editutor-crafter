direction: down

classes: {
  entity: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  rule: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  redis: {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

rate_limit_rule: RateLimitRule {
  shape: class
  class: rule
  - "id: string"
  - "name: string"
  - "algorithm: AlgorithmType"
  - "limit: int"
  - "window_ms: int"
  - "priority: int"
  - "matchers: RuleMatcher[]"
  - "actions: RuleAction[]"
  + "matches(context: RequestContext): bool"
  + "evaluate(state: LimitState): Decision"
}

rule_matcher: RuleMatcher {
  shape: class
  class: rule
  - "match_type: MatcherType"
  - "field: string"
  - "operator: Operator"
  - "values: string[]"
  + "matches(request: HttpRequest): bool"
}

rule_action: RuleAction {
  shape: class
  class: rule
  - "action_type: ActionType"
  - "config: ActionConfig"
  + "execute(decision: Decision): void"
}

user_entity: User {
  shape: class
  class: entity
  - "id: string"
  - "tier: string"
  - "limits: UserLimit[]"
  - "created_at: timestamp"
  + "get_effective_limit(endpoint: string): UserLimit"
}

ip_entity: IPAddress {
  shape: class
  class: entity
  - "address: string"
  - "location: GeoLocation"
  - "reputation_score: float"
  - "blocked: bool"
  + "is_trusted(): bool"
  + "get_risk_level(): RiskLevel"
}

api_key_entity: APIKey {
  shape: class
  class: entity
  - "key: string"
  - "user_id: string"
  - "scopes: string[]"
  - "rate_limits: KeyLimit[]"
  - "expires_at: timestamp"
  + "is_valid(): bool"
  + "has_scope(scope: string): bool"
}

redis_container: Redis Backend {
  class: redis
}

sliding_window: SlidingWindowLog {
  shape: class
  class: redis
  - "key: string"
  - "entries: TimestampEntry[]"
  - "ttl: int"
  + "add_request(timestamp: long): int"
  + "count_in_window(window_ms: int): int"
  + "cleanup_expired(): void"
}

token_bucket: TokenBucket {
  shape: class
  class: redis
  - "key: string"
  - "tokens: float"
  - "last_refill: long"
  - "capacity: int"
  - "refill_rate: float"
  + "consume(tokens: int): bool"
  + "refill(): void"
}

fixed_window: FixedWindowCounter {
  shape: class
  class: redis
  - "key: string"
  - "count: int"
  - "window_start: long"
  - "window_size: int"
  + "increment(): int"
  + "reset_if_expired(): void"
}

rate_state: RateState {
  shape: class
  class: redis
  - "entity_id: string"
  - "rule_id: string"
  - "current_count: int"
  - "window_start: long"
  - "remaining: int"
  - "reset_time: long"
  + "update(decision: Decision): void"
  + "is_exceeded(): bool"
}

request_context: RequestContext {
  shape: class
  class: entity
  - "user_id: string"
  - "api_key: string"
  - "source_ip: string"
  - "endpoint: string"
  - "method: string"
  - "headers: Map<string, string>"
  - "timestamp: long"
  + "extract_entities(): Entity[]"
  + "build_cache_keys(): string[]"
}

rate_limit_rule -> user_entity: "applies to" {
  style.stroke: "#8b949e"
}
rate_limit_rule -> ip_entity: "applies to" {
  style.stroke: "#8b949e"
}
rate_limit_rule -> api_key_entity: "applies to" {
  style.stroke: "#8b949e"
}

rate_limit_rule -> rule_matcher: "contains" {
  style.stroke: "#3fb950"
}
rate_limit_rule -> rule_action: "contains" {
  style.stroke: "#3fb950"
}

request_context -> user_entity: "identifies" {
  style.stroke: "#8b949e"
}
request_context -> ip_entity: "originates from" {
  style.stroke: "#8b949e"
}
request_context -> api_key_entity: "authenticated by" {
  style.stroke: "#8b949e"
}

user_entity -> rate_state: "tracked by" {
  style.stroke: "#8b949e"
}
ip_entity -> rate_state: "tracked by" {
  style.stroke: "#8b949e"
}
api_key_entity -> rate_state: "tracked by" {
  style.stroke: "#8b949e"
}

rate_limit_rule -> sliding_window: "sliding window" {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}
rate_limit_rule -> token_bucket: "token bucket" {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}
rate_limit_rule -> fixed_window: "fixed window" {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}

redis_container -> sliding_window: "contains" {
  style.stroke: "#8b949e"
}
redis_container -> token_bucket: "contains" {
  style.stroke: "#8b949e"
}
redis_container -> fixed_window: "contains" {
  style.stroke: "#8b949e"
}
redis_container -> rate_state: "contains" {
  style.stroke: "#8b949e"
}