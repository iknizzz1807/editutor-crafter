title: Audit Logging Pipeline

classes: {
  event_source: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  storage: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  process: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

capture: Event Capture {
  class: event_source
  
  auth_events: Auth Events {
    class: event_source
  }
  
  policy_events: Policy Changes {
    class: event_source
  }
  
  access_events: Access Attempts {
    class: event_source
  }
}

queue: Event Queue {
  shape: queue
  class: process
}

processor: Audit Processor {
  class: process
  
  validator: Event Validator {
    class: process
  }
  
  enricher: Context Enricher {
    class: process
  }
  
  formatter: Event Formatter {
    class: process
  }
}

integrity: Integrity Layer {
  class: storage
  
  hasher: Event Hasher {
    class: process
  }
  
  merkle: Merkle Tree Builder {
    class: process
  }
  
  signer: Digital Signer {
    class: process
  }
}

storage: Immutable Storage {
  class: storage
  
  primary: Primary Store {
    shape: cylinder
    class: storage
  }
  
  backup: Backup Store {
    shape: cylinder
    class: storage
  }
}

verification: Verification Service {
  class: process
  
  check: Integrity Check {
    shape: diamond
    class: decision
  }
  
  alert: Alert System {
    class: process
  }
}

compliance: Compliance Reports {
  class: storage
  
  generator: Report Generator {
    class: process
  }
  
  export: Export Service {
    class: process
  }
}

capture.auth_events -> queue: stream
capture.policy_events -> queue: stream
capture.access_events -> queue: stream

queue -> processor.validator: consume
processor.validator -> processor.enricher: validate
processor.enricher -> processor.formatter: enrich
processor.formatter -> integrity.hasher: format

integrity.hasher -> integrity.merkle: hash events
integrity.merkle -> integrity.signer: build tree
integrity.signer -> storage.primary: signed batch

storage.primary -> storage.backup: replicate
storage.primary -> verification.check: periodic verify

verification.check -> verification.alert: if tampered {
  style.stroke: "#d63031"
  style.font-color: "#d63031"
}

verification.check -> compliance.generator: if valid {
  style.stroke: "#3fb950"
  style.font-color: "#3fb950"
}

storage.primary -> compliance.generator: query logs
compliance.generator -> compliance.export: generate
compliance.export -> external_auditors: compliance reports {
  class: event_source
}