classes: {
  container: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  middleware: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  manager: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  database: {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  context_flow: {
    style.stroke: "#ffd700"
    style.bold: true
  }
  
  data_flow: {
    style.stroke: "#8b949e"
  }
}

title: Multi-Tenant Resource Isolation {
  near: top-center
  style.font-size: 18
  style.font-color: "#e6edf3"
  style.bold: true
}

client_request: Client Request {
  class: container
}

middleware_layer: Middleware Layer {
  class: container
  
  tenant_context: Tenant Context Middleware {
    class: middleware
  }
  
  auth_middleware: Authorization Middleware {
    class: middleware
  }
  
  isolation_filter: Isolation Filter {
    class: middleware
  }
}

resource_managers: Resource Managers {
  class: container
  
  user_manager: User Manager {
    class: manager
  }
  
  policy_manager: Policy Manager {
    class: manager
  }
  
  audit_manager: Audit Manager {
    class: manager
  }
}

database_layer: Database Layer {
  class: container
  
  tenant_db_a: Tenant A Schema {
    shape: cylinder
    class: database
  }
  
  tenant_db_b: Tenant B Schema {
    shape: cylinder
    class: database
  }
  
  shared_db: Shared Tables {
    shape: cylinder
    class: database
  }
}

tenant_context_store: Tenant Context {
  shape: page
  style.fill: "#ffd700"
  style.font-color: "#000"
  style.stroke: "#3fb950"
}

client_request -> middleware_layer.tenant_context: 1. Extract tenant ID {
  class: context_flow
}

middleware_layer.tenant_context -> tenant_context_store: 2. Create context {
  class: context_flow
}

middleware_layer.tenant_context -> middleware_layer.auth_middleware: 3. Pass context {
  class: context_flow
}

middleware_layer.auth_middleware -> middleware_layer.isolation_filter: 4. Validate & forward {
  class: context_flow
}

middleware_layer.isolation_filter -> resource_managers.user_manager: 5. Inject tenant context {
  class: context_flow
}

middleware_layer.isolation_filter -> resource_managers.policy_manager: 5. Inject tenant context {
  class: context_flow
}

middleware_layer.isolation_filter -> resource_managers.audit_manager: 5. Inject tenant context {
  class: context_flow
}

resource_managers.user_manager -> database_layer.tenant_db_a: Query with tenant filter {
  class: data_flow
}

resource_managers.policy_manager -> database_layer.tenant_db_b: Query with tenant filter {
  class: data_flow
}

resource_managers.audit_manager -> database_layer.shared_db: Insert with tenant ID {
  class: data_flow
}

isolation_note: |md
  **Isolation Boundaries:**
  - Context propagates through all layers
  - Database queries auto-filtered by tenant
  - Cross-tenant access blocked at middleware
  - Audit trails maintain tenant attribution
| {
  shape: page
  near: bottom-right
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}