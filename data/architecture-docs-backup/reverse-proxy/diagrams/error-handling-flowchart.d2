title: Error Handling and Recovery Flow {
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  container_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  process_style: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  error_style: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
  }
  success_style: {
    style.fill: "#00b894"
    style.stroke: "#55a3ff"
    style.font-color: "#ffffff"
  }
}

request_start: Client Request {
  shape: oval
  class: process_style
}

error_detection: Error Detection {
  shape: rectangle
  class: container_style
  
  monitor: Request Monitor {
    class: process_style
  }
  timeout: Timeout Detection {
    class: process_style
  }
  connection: Connection Failure {
    class: process_style
  }
  response: Response Validation {
    class: process_style
  }
}

error_classify: Error Classification {
  shape: diamond
  class: decision_style
}

client_errors: Client Errors (4xx) {
  shape: rectangle
  class: container_style
  
  bad_request: Bad Request (400) {
    class: error_style
  }
  unauthorized: Unauthorized (401) {
    class: error_style
  }
  not_found: Not Found (404) {
    class: error_style
  }
  rate_limit: Rate Limited (429) {
    class: error_style
  }
}

backend_failures: Backend Failures (5xx) {
  shape: rectangle
  class: container_style
  
  server_error: Internal Error (500) {
    class: error_style
  }
  bad_gateway: Bad Gateway (502) {
    class: error_style
  }
  unavailable: Service Unavailable (503) {
    class: error_style
  }
  timeout_error: Gateway Timeout (504) {
    class: error_style
  }
}

network_issues: Network Issues {
  shape: rectangle
  class: container_style
  
  conn_refused: Connection Refused {
    class: error_style
  }
  dns_failure: DNS Resolution Failed {
    class: error_style
  }
  ssl_error: SSL/TLS Error {
    class: error_style
  }
  network_timeout: Network Timeout {
    class: error_style
  }
}

recovery_strategies: Recovery Strategies {
  shape: rectangle
  class: container_style
  
  retry_logic: Retry with Backoff {
    class: process_style
  }
  failover: Backend Failover {
    class: process_style
  }
  circuit_breaker: Circuit Breaker {
    class: process_style
  }
  health_check: Health Check Recovery {
    class: process_style
  }
}

fallback_mechanisms: Fallback Mechanisms {
  shape: rectangle
  class: container_style
  
  cached_response: Serve Cached Response {
    class: process_style
  }
  static_response: Static Error Page {
    class: process_style
  }
  backup_server: Backup Server {
    class: process_style
  }
  degraded_service: Degraded Service Mode {
    class: process_style
  }
}

response_generation: Error Response Generation {
  shape: rectangle
  class: container_style
  
  log_error: Log Error Details {
    class: process_style
  }
  metrics: Update Metrics {
    class: process_style
  }
  format_response: Format Client Response {
    class: process_style
  }
  add_headers: Add Error Headers {
    class: process_style
  }
}

client_response: Client Response {
  shape: oval
  class: success_style
}

recovery_check: Recovery Successful? {
  shape: diamond
  class: decision_style
}

request_start -> error_detection: Process Request

error_detection.monitor -> error_classify: Error Detected
error_detection.timeout -> error_classify
error_detection.connection -> error_classify
error_detection.response -> error_classify

error_classify -> client_errors: 4xx Errors
error_classify -> backend_failures: Backend Down
error_classify -> network_issues: Network Failure

client_errors -> response_generation: Direct Response
backend_failures -> recovery_strategies: Attempt Recovery
network_issues -> recovery_strategies: Attempt Recovery

recovery_strategies.retry_logic -> recovery_check: Retry Request
recovery_strategies.failover -> recovery_check: Switch Backend
recovery_strategies.circuit_breaker -> fallback_mechanisms: Circuit Open
recovery_strategies.health_check -> recovery_check: Backend Recovered

recovery_check -> client_response: Yes - Success
recovery_check -> fallback_mechanisms: No - Use Fallback

fallback_mechanisms.cached_response -> response_generation: Serve Cache
fallback_mechanisms.static_response -> response_generation: Error Page
fallback_mechanisms.backup_server -> recovery_check: Try Backup
fallback_mechanisms.degraded_service -> response_generation: Limited Function

response_generation.log_error -> response_generation.metrics
response_generation.metrics -> response_generation.format_response
response_generation.format_response -> response_generation.add_headers
response_generation.add_headers -> client_response