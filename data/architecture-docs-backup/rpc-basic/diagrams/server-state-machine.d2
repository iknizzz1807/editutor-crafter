# Server Connection State Machine

classes: {
  state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  error_state: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  final_state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.double-border: true
    style.bold: true
  }
  initial_state: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
  }
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

init: {
  shape: circle
  label: ""
  class: initial_state
}

listening: {
  shape: circle
  label: "Listening"
  class: state
}

connected: {
  shape: circle
  label: "Connected"
  class: state
}

processing: {
  shape: circle
  label: "Processing\nRequest"
  class: state
}

sending: {
  shape: circle
  label: "Sending\nResponse"
  class: state
}

connection_error: {
  shape: circle
  label: "Connection\nError"
  class: error_state
}

processing_error: {
  shape: circle
  label: "Processing\nError"
  class: error_state
}

timeout_error: {
  shape: circle
  label: "Timeout\nError"
  class: error_state
}

closed: {
  shape: circle
  label: "Closed"
  class: final_state
}

init -> listening: "Start server" { class: transition }
listening -> connected: "Client connects" { class: transition }
connected -> processing: "Request received" { class: transition }
processing -> sending: "Request processed" { class: transition }
sending -> connected: "Response sent" { class: transition }

connected -> connection_error: "Connection lost" { class: transition }
processing -> processing_error: "RPC error" { class: transition }
processing -> timeout_error: "Request timeout" { class: transition }
sending -> connection_error: "Send failure" { class: transition }

connection_error -> listening: "Reset connection" { class: transition }
processing_error -> sending: "Send error response" { class: transition }
timeout_error -> connection_error: "Close connection" { class: transition }

connected -> closed: "Client disconnects" { class: transition }
listening -> closed: "Server shutdown" { class: transition }
connection_error -> closed: "Fatal error" { class: transition }