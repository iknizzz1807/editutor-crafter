title: Step Execution State Machine

classes: {
  state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  initial_state: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#1a1a2e"
  }
  final_state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.double-border: true
    style.bold: true
  }
  error_state: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  timeout_transition: {
    style.stroke: "#ff7675"
    style.stroke-dash: 3
    style.font-color: "#ff7675"
  }
  compensation_transition: {
    style.stroke: "#fdcb6e"
    style.font-color: "#fdcb6e"
  }
}

init: {
  shape: circle
  label: ""
  class: initial_state
}

pending: Pending {
  shape: circle
  class: state
}

running: Running {
  shape: circle
  class: state
}

completed: Completed {
  shape: circle
  class: final_state
}

failed: Failed {
  shape: circle
  class: error_state
}

compensating: Compensating {
  shape: circle
  class: state
}

compensated: Compensated {
  shape: circle
  class: final_state
}

timeout_handler: Timeout Handler {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#ff7675"
  style.font-color: "#e6edf3"
}

retry_handler: Retry Handler {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#74b9ff"
  style.font-color: "#e6edf3"
}

init -> pending: Create Step {
  class: transition
}

pending -> running: Start Execution {
  class: transition
}

running -> completed: Success {
  class: transition
}

running -> failed: Error {
  class: transition
}

running -> timeout_handler: Timeout {
  class: timeout_transition
}

timeout_handler -> failed: Max Retries Exceeded {
  class: timeout_transition
}

timeout_handler -> retry_handler: Retry Available {
  class: timeout_transition
}

retry_handler -> running: Restart {
  class: transition
}

completed -> compensating: Compensation Required {
  class: compensation_transition
}

compensating -> compensated: Compensation Success {
  class: compensation_transition
}

compensating -> failed: Compensation Failed {
  class: compensation_transition
}

compensating -> timeout_handler: Compensation Timeout {
  class: timeout_transition
}

failed -> retry_handler: Retry Policy Active {
  class: transition
}

legend: |md
  ## State Transitions
  - **Solid lines**: Normal flow
  - **Dashed lines**: Timeout handling
  - **Yellow lines**: Compensation flow
  - **Double border**: Final states
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: bottom-right
}