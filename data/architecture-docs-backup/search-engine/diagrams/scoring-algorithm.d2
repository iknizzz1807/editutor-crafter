# BM25 Score Calculation Flow
direction: down

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  data: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  final: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

start: Query Terms {
  shape: oval
  class: data
}

tf_calc: |md
  Calculate TF
  (Term Frequency)
|
tf_calc: {
  shape: rectangle
  class: process
}

idf_lookup: |md
  Lookup IDF
  (Inverse Document Frequency)
|
idf_lookup: {
  shape: rectangle
  class: process
}

field_boost: Apply Field Boosting {
  shape: rectangle
  class: process
}

has_boost: |md
  Field Boost
  Available?
|
has_boost: {
  shape: diamond
  class: decision
}

doc_length: |md
  Get Document
  Length
|
doc_length: {
  shape: rectangle
  class: process
}

avg_length: |md
  Get Average
  Document Length
|
avg_length: {
  shape: rectangle
  class: process
}

bm25_formula: |md
  Apply BM25 Formula
  Score = IDF × (tf × (k1 + 1)) /
  (tf + k1 × (1 - b + b × |d|/avgdl))
|
bm25_formula: {
  shape: rectangle
  class: process
}

combine_scores: |md
  Sum Scores
  for All Terms
|
combine_scores: {
  shape: rectangle
  class: process
}

final_score: Final BM25 Score {
  shape: oval
  class: final
}

# Flow connections
start -> tf_calc: For each term
start -> idf_lookup: For each term
start -> doc_length: Get document stats
start -> avg_length: Get collection stats

tf_calc -> has_boost: TF calculated
has_boost -> field_boost: Yes
has_boost -> bm25_formula: No

field_boost -> bm25_formula: Boosted TF

idf_lookup -> bm25_formula: IDF value
doc_length -> bm25_formula: "|d|"
avg_length -> bm25_formula: avgdl

bm25_formula -> combine_scores: Term score
combine_scores -> final_score: Sum all terms

# Style arrows
(start -> tf_calc).style.stroke: "#8b949e"
(start -> idf_lookup).style.stroke: "#8b949e"
(start -> doc_length).style.stroke: "#8b949e"
(start -> avg_length).style.stroke: "#8b949e"
(tf_calc -> has_boost).style.stroke: "#8b949e"
(has_boost -> field_boost).style.stroke: "#3fb950"
(has_boost -> bm25_formula).style.stroke: "#8b949e"
(field_boost -> bm25_formula).style.stroke: "#8b949e"
(idf_lookup -> bm25_formula).style.stroke: "#8b949e"
(doc_length -> bm25_formula).style.stroke: "#8b949e"
(avg_length -> bm25_formula).style.stroke: "#8b949e"
(bm25_formula -> combine_scores).style.stroke: "#8b949e"
(combine_scores -> final_score).style.stroke: "#3fb950"