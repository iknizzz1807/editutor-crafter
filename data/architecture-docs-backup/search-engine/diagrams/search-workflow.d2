classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  data: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  result: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

title: Query Processing Pipeline {
  near: top-center
  style.font-size: 18
  style.font-color: "#e6edf3"
  style.bold: true
}

input: Raw Query String {
  shape: oval
  class: data
}

parser: Query Parser {
  class: process
}

parsed_query: Parsed Query Object {
  class: data
}

has_filters: Has Field Filters? {
  shape: diamond
  class: decision
}

candidate_matcher: Candidate Matching {
  class: process
}

initial_candidates: Initial Candidates {
  class: data
}

filter_processor: Apply Filters {
  class: process
}

filtered_candidates: Filtered Candidates {
  class: data
}

fuzzy_check: Enable Fuzzy? {
  shape: diamond
  class: decision
}

fuzzy_expander: Fuzzy Expansion {
  class: process
}

expanded_terms: Expanded Query Terms {
  class: data
}

scoring_engine: Scoring Engine {
  class: process
}

tf_idf: TF-IDF Calculator {
  class: process
}

bm25: BM25 Calculator {
  class: process
}

field_boosts: Field Boosting {
  class: process
}

scored_results: Scored Results {
  class: data
}

result_ranker: Result Ranking {
  class: process
}

final_results: Ranked Results {
  shape: oval
  class: result
}

# Main flow
input -> parser: parse
parser -> parsed_query: structured query
parsed_query -> has_filters

has_filters -> candidate_matcher: No
has_filters -> filter_processor: Yes

filter_processor -> filtered_candidates
filtered_candidates -> fuzzy_check

candidate_matcher -> initial_candidates
initial_candidates -> fuzzy_check

fuzzy_check -> fuzzy_expander: Yes
fuzzy_check -> scoring_engine: No

fuzzy_expander -> expanded_terms
expanded_terms -> scoring_engine

scoring_engine -> tf_idf
scoring_engine -> bm25
scoring_engine -> field_boosts

tf_idf -> scored_results
bm25 -> scored_results
field_boosts -> scored_results

scored_results -> result_ranker: sort by score
result_ranker -> final_results