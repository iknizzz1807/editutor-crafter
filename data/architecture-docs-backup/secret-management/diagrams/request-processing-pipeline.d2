# Request Processing Pipeline

classes: {
  endpoint: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  process: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  error: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

client: HTTP Client {
  class: endpoint
}

http_endpoint: HTTP Endpoint {
  class: endpoint
}

auth_gate: Authentication {
  shape: diamond
  class: decision
}

authz_gate: Authorization {
  shape: diamond
  class: decision
}

pipeline: Request Processing Pipeline {
  request_parser: Request Parser {
    class: process
  }
  
  validator: Input Validator {
    class: process
  }
  
  encryption: Encryption/Decryption {
    decrypt: Decrypt Request Data {
      class: process
    }
    encrypt: Encrypt Response Data {
      class: process
    }
  }
  
  secret_engine: Secret Engine {
    class: process
  }
}

response_gen: Response Generator {
  class: process
}

audit_logger: Audit Logger {
  class: process
}

error_handler: Error Handler {
  class: error
}

# Main request flow
client -> http_endpoint: HTTP Request
http_endpoint -> auth_gate: Extract credentials

# Authentication flow
auth_gate -> pipeline.request_parser: Valid {
  style.stroke: "#3fb950"
}
auth_gate -> error_handler: Invalid {
  style.stroke: "#d63031"
}

# Request processing
pipeline.request_parser -> pipeline.validator: Parse JSON/Headers
pipeline.validator -> authz_gate: Validate input

# Authorization flow  
authz_gate -> pipeline.encryption.decrypt: Authorized {
  style.stroke: "#3fb950"
}
authz_gate -> error_handler: Forbidden {
  style.stroke: "#d63031"
}

# Core processing
pipeline.encryption.decrypt -> pipeline.secret_engine: Decrypt if needed
pipeline.secret_engine -> pipeline.encryption.encrypt: Process secret operation
pipeline.encryption.encrypt -> response_gen: Encrypt if needed

# Response flow
response_gen -> audit_logger: Generate response
audit_logger -> client: Log & return response

# Error handling
error_handler -> audit_logger: Log error
audit_logger -> client: Error response {
  style.stroke: "#d63031"
}

# Audit logging connections
auth_gate -> audit_logger: Log auth attempt {
  style.stroke-dash: 3
  style.stroke: "#8b949e"
}
authz_gate -> audit_logger: Log authz check {
  style.stroke-dash: 3
  style.stroke: "#8b949e"
}
pipeline.secret_engine -> audit_logger: Log secret access {
  style.stroke-dash: 3
  style.stroke: "#8b949e"
}