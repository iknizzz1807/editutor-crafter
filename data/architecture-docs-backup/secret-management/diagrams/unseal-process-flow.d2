title: Unseal Process Flow

classes: {
  sealed_state: {
    style.fill: "#d63031"
    style.font-color: "#ffffff"
    style.stroke: "#e17055"
    style.bold: true
  }
  active_state: {
    style.fill: "#00b894"
    style.font-color: "#ffffff"
    style.stroke: "#00a085"
    style.bold: true
  }
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#0984e3"
    style.font-color: "#ffffff"
    style.stroke: "#74b9ff"
    style.bold: true
  }
  auto_process: {
    style.fill: "#6c5ce7"
    style.stroke: "#a29bfe"
    style.font-color: "#ffffff"
  }
}

sealed: Sealed State {
  shape: circle
  class: sealed_state
}

unseal_request: Unseal Request {
  class: process
}

check_mode: Auto-unseal\nEnabled? {
  shape: diamond
  class: decision
}

manual_path: Manual Unseal Path {
  class: process
  
  collect_shares: Collect Shares {
    class: process
  }
  
  validate_share: Validate Share {
    class: process
  }
  
  threshold_check: Threshold\nReached? {
    shape: diamond
    class: decision
  }
  
  reconstruct_key: Reconstruct\nMaster Key {
    class: process
  }
}

auto_path: Auto-unseal Path {
  class: auto_process
  
  fetch_kek: Fetch KEK from\nCloud KMS {
    class: auto_process
  }
  
  decrypt_master: Decrypt\nMaster Key {
    class: auto_process
  }
}

verify_key: Verify Master Key {
  class: process
}

initialize_crypto: Initialize\nCrypto Engine {
  class: process
}

load_policies: Load Access\nPolicies {
  class: process
}

active: Active State {
  shape: circle
  class: active_state
}

sealed -> unseal_request: Operator initiates
unseal_request -> check_mode

check_mode -> manual_path.collect_shares: No
check_mode -> auto_path.fetch_kek: Yes

manual_path.collect_shares -> manual_path.validate_share
manual_path.validate_share -> manual_path.threshold_check
manual_path.threshold_check -> manual_path.collect_shares: No (wait for more)
manual_path.threshold_check -> manual_path.reconstruct_key: Yes

auto_path.fetch_kek -> auto_path.decrypt_master

manual_path.reconstruct_key -> verify_key
auto_path.decrypt_master -> verify_key

verify_key -> initialize_crypto
initialize_crypto -> load_policies
load_policies -> active