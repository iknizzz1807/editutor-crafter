shape: sequence_diagram

classes: {
  primary_actor: {
    style.fill: "#3fb950"
    style.font-color: "#1a1a2e"
    style.bold: true
  }
  system: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  storage: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  success: {
    style.stroke: "#3fb950"
    style.font-color: "#3fb950"
  }
  failure: {
    style.stroke: "#d63031"
    style.font-color: "#d63031"
  }
}

client: Client {
  class: primary_actor
}
session_manager: Session Manager {
  class: system
}
cookie_security: Cookie Security {
  class: system
}
storage: Storage Backend {
  class: storage
}

client -> session_manager: HTTP Request with Session Cookie {
  class: success
}
session_manager -> cookie_security: Extract & Validate Cookie {
  class: success
}
cookie_security -> cookie_security: Decrypt Cookie Payload {
  class: success
}
cookie_security -> session_manager: Return Session ID & CSRF Token {
  class: success
}
session_manager -> storage: Lookup Session Data {
  class: success
}
storage -> session_manager: Return Session Record {
  class: success
}
session_manager -> session_manager: Check Timeout & Expiry {
  class: success
}
session_manager -> session_manager: Validate CSRF Token {
  class: success
}
session_manager -> storage: Update Last Access Time {
  class: success
}
session_manager -> cookie_security: Renew Cookie if Needed {
  class: success
}
cookie_security -> session_manager: New Encrypted Cookie {
  class: success
}
session_manager -> client: Valid Session Response + Renewed Cookie {
  class: success
}

client -> session_manager: HTTP Request with Invalid Cookie {
  class: failure
}
session_manager -> cookie_security: Extract & Validate Cookie {
  class: failure
}
cookie_security -> session_manager: Decryption Failed {
  class: failure
}
session_manager -> client: 401 Unauthorized + Clear Cookie {
  class: failure
}

client -> session_manager: HTTP Request with Expired Session {
  class: failure
}
session_manager -> cookie_security: Extract & Validate Cookie {
  class: success
}
cookie_security -> session_manager: Session ID Extracted {
  class: success
}
session_manager -> storage: Lookup Session Data {
  class: success
}
storage -> session_manager: Session Not Found / Expired {
  class: failure
}
session_manager -> storage: Clean Up Expired Session {
  class: failure
}
session_manager -> client: 401 Unauthorized + Clear Cookie {
  class: failure
}