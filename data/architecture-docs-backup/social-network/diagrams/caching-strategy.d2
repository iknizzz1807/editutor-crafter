title: Multi-layer Caching Strategy {
  style.font-size: 24
  style.bold: true
  style.font-color: "#e6edf3"
  near: top-center
}

classes: {
  cache_layer: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  data_flow: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  invalidation: {
    style.stroke: "#d63031"
    style.stroke-dash: 3
    style.font-color: "#d63031"
  }
  app_component: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

client: Client App {
  class: app_component
}

cdn: CDN Layer {
  class: cache_layer
  media_cache: Media Cache {
    shape: cylinder
    class: cache_layer
  }
  static_assets: Static Assets {
    shape: cylinder
    class: cache_layer
  }
}

app_layer: Application Layer {
  class: cache_layer
  api: API Server {
    class: app_component
  }
  app_cache: Memory Cache {
    shape: cylinder
    class: cache_layer
  }
}

redis_layer: Redis Layer {
  class: cache_layer
  feeds: Feed Cache {
    shape: cylinder
    class: cache_layer
  }
  profiles: Profile Cache {
    shape: cylinder
    class: cache_layer
  }
  sessions: Session Cache {
    shape: cylinder
    class: cache_layer
  }
}

db_layer: Database Layer {
  class: cache_layer
  query_cache: Query Cache {
    shape: cylinder
    class: cache_layer
  }
  primary_db: Primary Database {
    shape: cylinder
    class: app_component
  }
}

cache_manager: Cache Manager {
  class: app_component
  shape: diamond
}

# Data flow paths
client -> cdn.media_cache: Request media {
  class: data_flow
}
client -> app_layer.api: API requests {
  class: data_flow
}

app_layer.api -> app_layer.app_cache: Check cache {
  class: data_flow
}
app_layer.api -> redis_layer.feeds: Get feeds {
  class: data_flow
}
app_layer.api -> redis_layer.profiles: Get profiles {
  class: data_flow
}

redis_layer.feeds -> db_layer.query_cache: Cache miss {
  class: data_flow
}
redis_layer.profiles -> db_layer.query_cache: Cache miss {
  class: data_flow
}

db_layer.query_cache -> db_layer.primary_db: Query data {
  class: data_flow
}

# Cache invalidation paths
cache_manager -> cdn.media_cache: Invalidate media {
  class: invalidation
}
cache_manager -> app_layer.app_cache: Clear app cache {
  class: invalidation
}
cache_manager -> redis_layer.feeds: Update feeds {
  class: invalidation
}
cache_manager -> redis_layer.profiles: Update profiles {
  class: invalidation
}
cache_manager -> db_layer.query_cache: Flush queries {
  class: invalidation
}

db_layer.primary_db -> cache_manager: Data changes {
  class: invalidation
}

# Cache hit flows
cdn.media_cache -> client: Media response {
  class: data_flow
}
app_layer.app_cache -> client: Cached response {
  class: data_flow
}
redis_layer.feeds -> app_layer.api: Feed data {
  class: data_flow
}
redis_layer.profiles -> app_layer.api: Profile data {
  class: data_flow
}