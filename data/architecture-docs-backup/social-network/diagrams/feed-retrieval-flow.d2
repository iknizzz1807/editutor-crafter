title: Feed Retrieval Process

direction: down

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  storage: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  arrow: {
    style.stroke: "#8b949e"
  }
}

start: Start {
  shape: circle
  class: process
}

check_cache: Check Cache {
  class: process
}

cache_hit: Cache Hit? {
  shape: diamond
  class: decision
}

return_cached: Return Cached Data {
  class: process
  style.bold: true
}

query_db: Query Database {
  class: process
}

merge_posts: Merge Posts from Followed Users {
  class: process
}

apply_pagination: Apply Cursor Pagination {
  class: process
}

cache_result: Cache Result {
  class: process
}

return_data: Return to User {
  class: process
  style.bold: true
}

cache: Redis Cache {
  shape: cylinder
  class: storage
}

database: Database {
  shape: cylinder
  class: storage
}

start -> check_cache: {class: arrow}
check_cache -> cache_hit: {class: arrow}
cache_hit -> return_cached: Yes {class: arrow}
cache_hit -> query_db: No {class: arrow}
query_db -> merge_posts: {class: arrow}
merge_posts -> apply_pagination: {class: arrow}
apply_pagination -> cache_result: {class: arrow}
cache_result -> return_data: {class: arrow}

check_cache <-> cache: read {class: arrow}
query_db <-> database: fetch posts {class: arrow}
cache_result -> cache: store {class: arrow}

pagination_note: |md
  **Cursor Pagination Logic:**
  - Use last post ID as cursor
  - Fetch posts after cursor
  - Include cursor in cached result
| {
  shape: page
  near: bottom-right
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}