title: Social Interaction Data Flow

classes: {
  service: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  database: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  queue: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  atomic: {
    style.fill: "#1a1a2e"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

client: Client App {
  class: service
}

gateway: API Gateway {
  class: service
}

interaction_service: Interaction Service {
  class: atomic
  
  like_handler: Like Handler {
    class: atomic
  }
  comment_handler: Comment Handler {
    class: atomic  
  }
  share_handler: Share Handler {
    class: atomic
  }
  race_guard: Race Condition Guard {
    class: atomic
  }
}

aggregation: Count Aggregation Service {
  class: service
  
  counter: Atomic Counter {
    class: atomic
  }
  batch_processor: Batch Processor {
    class: service
  }
}

broadcaster: Real-time Update Broadcaster {
  class: service
  
  websocket: WebSocket Manager {
    class: service
  }
  redis_pub: Redis Publisher {
    class: service
  }
}

notification: Notification Triggers {
  class: service
  
  like_notifier: Like Notifier {
    class: service
  }
  comment_notifier: Comment Notifier {
    class: service
  }
}

interaction_db: Interaction DB {
  shape: cylinder
  class: database
}

cache: Redis Cache {
  shape: cylinder
  class: database
}

event_queue: Event Queue {
  shape: queue
  class: queue
}

atomic_note: "Atomic Operations\n- Database writes use transactions\n- Redis counters use INCR/DECR\n- Race conditions prevented by locks" {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#e17055"
  style.font-color: "#ffffff"
  near: bottom-right
}

client -> gateway: POST /posts/{id}/like
gateway -> interaction_service: process interaction
interaction_service.race_guard -> interaction_service.like_handler: validate & execute
interaction_service.like_handler -> interaction_db: atomic write
interaction_service.like_handler -> event_queue: publish event
event_queue -> aggregation: update counts
aggregation.counter -> cache: increment counter
aggregation.batch_processor -> interaction_db: batch update
event_queue -> broadcaster: real-time update
broadcaster.redis_pub -> broadcaster.websocket: push to clients
event_queue -> notification: trigger notification
notification.like_notifier -> gateway: send notification
broadcaster -> client: live update
gateway -> client: 200 OK