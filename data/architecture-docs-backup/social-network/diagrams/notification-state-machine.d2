# Notification Lifecycle States

classes: {
  state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  initial_state: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#000000"
  }
  
  final_state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.double-border: true
    style.bold: true
  }
  
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  retry_transition: {
    style.stroke: "#d63031"
    style.font-color: "#d63031"
    style.stroke-dash: 3
  }
  
  user_action: {
    style.stroke: "#74b9ff"
    style.font-color: "#74b9ff"
  }
}

init: {
  shape: circle
  class: initial_state
  label: ""
}

created: Created {
  shape: circle
  class: state
}

queued: Queued {
  shape: circle
  class: state
}

batched: Batched {
  shape: circle
  class: state
}

sent: Sent {
  shape: circle
  class: state
}

delivered: Delivered {
  shape: circle
  class: state
}

failed: Failed {
  shape: circle
  class: state
}

read: Read {
  shape: circle
  class: final_state
}

dismissed: Dismissed {
  shape: circle
  class: final_state
}

expired: Expired {
  shape: circle
  class: final_state
}

# Main flow transitions
init -> created: "Event triggered" {
  class: transition
}

created -> queued: "Enqueue for processing" {
  class: transition
}

queued -> batched: "Batching decision" {
  class: transition
}

queued -> sent: "Send immediately" {
  class: transition
}

batched -> sent: "Batch timer expires" {
  class: transition
}

sent -> delivered: "Delivery confirmed" {
  class: transition
}

sent -> failed: "Delivery failed" {
  class: retry_transition
}

# Retry logic
failed -> queued: "Retry attempt" {
  class: retry_transition
}

failed -> expired: "Max retries exceeded" {
  class: retry_transition
}

# User actions
delivered -> read: "User opens notification" {
  class: user_action
}

delivered -> dismissed: "User dismisses" {
  class: user_action
}

queued -> dismissed: "User dismisses before delivery" {
  class: user_action
}

batched -> dismissed: "User dismisses batched notification" {
  class: user_action
}

# Cleanup transitions
delivered -> expired: "TTL expired unread" {
  class: transition
}

# Retry counter annotation
retry_note: |md
  **Retry Logic:**
  - Failed notifications re-enter queue
  - Exponential backoff between attempts
  - Max 3 retry attempts before expiration
| {
  shape: page
  near: top-right
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Batching decision annotation  
batch_note: |md
  **Batching Rules:**
  - Similar notifications grouped
  - Time window: 5-15 minutes
  - User preference controls
| {
  shape: page
  near: bottom-left
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}