direction: right

# Style classes
classes: {
  main_process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  data_structure: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  pixel_op: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

# Main rasterization pipeline
pipeline: Triangle Rasterization Pipeline {
  class: main_process

  # Input stage
  vertices: Triangle Vertices {
    shape: class
    class: data_structure
    - "v0: (x0, y0, attributes)"
    - "v1: (x1, y1, attributes)"
    - "v2: (x2, y2, attributes)"
  }

  # Bounding box calculation
  bbox: Bounding Box Calc {
    class: main_process
    shape: rectangle
  }

  # Edge function setup
  edges: Edge Function Setup {
    class: main_process
    shape: rectangle
  }

  # Pixel traversal
  traverse: Pixel Traversal {
    class: main_process
    shape: rectangle
  }

  # Inside test
  inside_test: Inside Triangle Test {
    class: pixel_op
    shape: diamond
  }

  # Barycentric calculation
  bary_calc: Barycentric Coordinates {
    class: pixel_op
    shape: rectangle
  }

  # Attribute interpolation
  interp: Attribute Interpolation {
    class: pixel_op
    shape: rectangle
  }

  # Final pixel write
  pixel_write: Write Pixel {
    class: pixel_op
    shape: rectangle
  }

  # Flow connections
  vertices -> bbox: compute bounds
  bbox -> edges: setup edge equations
  edges -> traverse: for each pixel in bbox
  traverse -> inside_test: test pixel (x,y)
  inside_test -> bary_calc: if inside
  bary_calc -> interp: calculate weights
  interp -> pixel_write: interpolate color/depth
  inside_test -> traverse: if outside, next pixel {
    style.stroke-dash: 3
    style.stroke: "#8b949e"
  }
  pixel_write -> traverse: next pixel {
    style.stroke-dash: 3
  }
}

# Data structures used
data_structs: Supporting Data {
  class: data_structure

  edge_eq: Edge Equations {
    shape: class
    class: data_structure
    - "A, B, C: edge coefficients"
    - "evaluate(x, y): float"
  }

  bary_coords: Barycentric Result {
    shape: class
    class: data_structure
    - "w0, w1, w2: weights"
    - "valid: boolean"
  }

  pixel_data: Pixel Data {
    shape: class
    class: data_structure
    - "color: RGB"
    - "depth: float"
    - "position: (x, y)"
  }
}

# Algorithm details
details: Algorithm Details {
  class: main_process

  edge_test: |md
    **Edge Test Formula:**
    E(x,y) = (y0-y1)x + (x1-x0)y + x0*y1-x1*y0
    
    Inside if: E0≥0 && E1≥0 && E2≥0
  | {
    shape: page
    class: data_structure
  }

  bary_formula: |md
    **Barycentric Weights:**
    w0 = E1(x,y) / E1(x2,y2)
    w1 = E2(x,y) / E2(x0,y0) 
    w2 = E0(x,y) / E0(x1,y1)
    
    Interpolated = w0*attr0 + w1*attr1 + w2*attr2
  | {
    shape: page
    class: data_structure
  }
}

# Connect supporting elements
pipeline.edges -> data_structs.edge_eq: creates
pipeline.bary_calc -> data_structs.bary_coords: produces
pipeline.pixel_write -> data_structs.pixel_data: outputs
details.edge_test -> pipeline.inside_test: implements
details.bary_formula -> pipeline.bary_calc: implements