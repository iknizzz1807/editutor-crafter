title: Window Assignment and Triggering Flowchart

direction: down

# Flowchart shapes with dark theme styling
incoming_element: "Incoming Element\n{timestamp, value, ...}" {
  style: {
    fill: "#0f3460"
    stroke: "#3fb950"
    font-color: "#e6edf3"
    bold: true
  }
}

extract_timestamp: Extract Timestamp {
  shape: rectangle
  style: {
    fill: "#16213e"
    stroke: "#8b949e"
    font-color: "#e6edf3"
  }
}

window_assigner: WindowAssigner {
  shape: diamond
  style: {
    fill: "#1a1a2e"
    stroke: "#8b949e"
    font-color: "#e6edf3"
  }
}

window_state: WindowState {
  shape: rectangle
  style: {
    fill: "#16213e"
    stroke: "#8b949e"
    font-color: "#e6edf3"
  }
}

evaluate_trigger: Evaluate Trigger {
  shape: diamond
  style: {
    fill: "#1a1a2e"
    stroke: "#8b949e"
    font-color: "#e6edf3"
  }
}

trigger_fires: Trigger Fires? {
  shape: diamond
  style: {
    fill: "#1a1a2e"
    stroke: "#3fb950"
    font-color: "#e6edf3"
    bold: true
  }
}

invoke_window_function: "Invoke Window Function\n(process window)" {
  shape: rectangle
  style: {
    fill: "#16213e"
    stroke: "#3fb950"
    font-color: "#e6edf3"
    bold: true
  }
}

emit_results: Emit Results {
  shape: rectangle
  style: {
    fill: "#0f3460"
    stroke: "#3fb950"
    font-color: "#e6edf3"
    bold: true
  }
}

continue_processing: Continue Processing {
  shape: rectangle
  style: {
    fill: "#16213e"
    stroke: "#8b949e"
    font-color: "#e6edf3"
  }
}

# Connections
incoming_element -> extract_timestamp: "extract timestamp"
extract_timestamp -> window_assigner: "with timestamp"

window_assigner -> window_state: "assign to windows"
window_state -> evaluate_trigger: "element added"

evaluate_trigger -> trigger_fires: "check conditions"
trigger_fires -> invoke_window_function: "Yes"
trigger_fires -> continue_processing: "No"

invoke_window_function -> emit_results: "compute result"
continue_processing -> window_assigner: "next element" {
  style: {
    stroke-dash: 3
  }
}

# Notes
note1: |md
  ### Window Assignment
  - Based on timestamp and window policy
  - Can assign to zero or more windows
  - Windows may be overlapping
| {
  style: {
    fill: "#1a1a2e"
    stroke: "#8b949e"
    font-color: "#e6edf3"
  }
  shape: page
}

note2: |md
  ### Window State
  - Maintains aggregated state per window
  - Supports incremental updates
  - Persisted for fault tolerance
| {
  style: {
    fill: "#1a1a2e"
    stroke: "#8b949e"
    font-color: "#e6edf3"
  }
  shape: page
}

note3: |md
  ### Trigger Evaluation
  - Checks window completeness conditions
  - May fire early (e.g., on-time arrival)
  - May fire late (e.g., allowed lateness)
  - May fire multiple times
| {
  style: {
    fill: "#1a1a2e"
    stroke: "#8b949e"
    font-color: "#e6edf3"
  }
  shape: page
}

# Position notes
note1.near: top-right
note2.near: center-right
note3.near: bottom-right