classes: {
  decision: {
    shape: diamond
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  calculation: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  endpoint: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

start: Plan Change Request {
  class: process
}

validate_plan: Valid Plan Change? {
  class: decision
}

determine_type: Upgrade or Downgrade? {
  class: decision
}

upgrade_path: Upgrade Processing {
  class: process
  style.fill: "#1a4d2e"
}

downgrade_path: Downgrade Processing {
  class: process
  style.fill: "#4d1a2e"
}

calc_upgrade: Calculate Upgrade Proration {
  class: calculation
}

calc_downgrade: Calculate Downgrade Credit {
  class: calculation
}

immediate_upgrade: Apply Immediate Upgrade {
  class: process
}

schedule_downgrade: Schedule for Next Cycle? {
  class: decision
}

apply_credit: Apply Credit to Account {
  class: process
}

immediate_downgrade: Apply Immediate Downgrade {
  class: process
}

update_billing: Update Billing Schedule {
  class: process
}

send_confirmation: Send Confirmation {
  class: process
}

error_response: Return Error {
  class: endpoint
  style.fill: "#d63031"
}

success_response: Plan Change Complete {
  class: endpoint
}

proration_details: |md
  **Proration Calculation:**
  - Unused days in current cycle
  - Price difference
  - Tax adjustments
  - Credit application
| {
  shape: page
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

start -> validate_plan
validate_plan -> determine_type: Yes
validate_plan -> error_response: No

determine_type -> upgrade_path: Upgrade
determine_type -> downgrade_path: Downgrade

upgrade_path -> calc_upgrade
calc_upgrade -> immediate_upgrade
immediate_upgrade -> update_billing

downgrade_path -> calc_downgrade
calc_downgrade -> schedule_downgrade

schedule_downgrade -> update_billing: End of Cycle
schedule_downgrade -> apply_credit: Immediate

apply_credit -> immediate_downgrade
immediate_downgrade -> update_billing

update_billing -> send_confirmation
send_confirmation -> success_response

calc_upgrade -> proration_details
calc_downgrade -> proration_details