title: Compaction Tier State Machine
direction: down

states: {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  initial: {
    shape: circle
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
  }
  
  final: {
    shape: circle
    shape: circle
    style.stroke-width: 3
  }
}

# Initial state
initial -> Active

# Main compaction pipeline
Active: "Active (Writable)" {
  style.bold: true
  style.fill: "#16213e"
}

Level0: "Level 0 (Immutable)" {
  style.fill: "#1a1a2e"
}

Level1: "Level 1" {
  style.fill: "#1a1a2e"
}

Level2: "Level 2" {
  style.fill: "#1a1a2e"
}

Level3: "Level 3+" {
  style.fill: "#1a1a2e"
}

Rollup: "Rollup (Downsampled)" {
  shape: hexagon
  style.fill: "#1a1a2e"
  style.stroke: "#e6a700"
}

Deleted: "Deleted" {
  shape: circle
  style.fill: "#2d1a2d"
  style.stroke: "#da3633"
  style.bold: true
}

# Transitions
Active -> Level0: File full / sealed
Level0 -> Level1: Level 0 compaction
Level1 -> Level2: Level 1 compaction
Level2 -> Level3: Level 2+ compaction
Level3 -> Rollup: Downsampling trigger
Rollup -> Deleted: Retention expired

# TTL direct paths
Level0 -> Deleted: TTL expiration
Level1 -> Deleted: TTL expiration  
Level2 -> Deleted: TTL expiration
Level3 -> Deleted: TTL expiration

# Styling for transitions
style Active->Level0 { style.stroke-dash: 3 }
style Rollup->Deleted { style.stroke: "#da3633" }
style Level0->Deleted { style.stroke: "#da3633" }
style Level1->Deleted { style.stroke: "#da3633" }
style Level2->Deleted { style.stroke: "#da3633" }
style Level3->Deleted { style.stroke: "#da3633" }

# Container for tiers
tiers: Compaction Tiers {
  Level0
  Level1
  Level2
  Level3
  
  style.stroke: "#8b949e"
  style.stroke-dash: 2
  style.font-color: "#8b949e"
  style.fill: transparent
}