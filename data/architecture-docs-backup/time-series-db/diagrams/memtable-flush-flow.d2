title: Memtable Flush Decision Flowchart

direction: right

# Styling
classes: {
  all: {
    style.font-color: "#e6edf3"
  }
  container: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
  }
  diamond: {
    shape: diamond
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.bold: true
  }
  process: {
    shape: rectangle
    style.fill: "#16213e"
    style.stroke: "#3fb950"
  }
  start_end: {
    shape: oval
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.bold: true
  }
  event: {
    shape: rectangle
    style.fill: "#0a2647"
    style.stroke: "#8b949e"
    style.font-color: "#8b949e"
    style.italic: true
  }
}

flowchart: {
  # Start
  start: Start of Write Operation {
    class: start_end
  }

  # Check Conditions
  check_conditions: Check Memtable Status {
    class: diamond
  }

  # Events/Triggers
  write_event: Write Received {
    class: event
  }
  timer_event: Periodic Timer Fired {
    class: event
  }

  # Conditions
  size_condition: Memtable Size > Threshold? {
    class: diamond
  }
  timer_condition: Timer Expired? {
    class: diamond
  }

  # Flush Process
  mark_immutable: Mark Current Memtable as Immutable {
    class: process
  }
  create_new: Create New Active Memtable {
    class: process
  }
  schedule_flush: Schedule Background Flush to TSM File {
    class: process
  }

  # Return Path
  continue_ops: Continue Normal Operations {
    class: process
  }

  # End
  end: Return to Normal Write Flow {
    class: start_end
  }

  # Flow Connections
  start -> write_event
  start -> timer_event
  
  write_event -> check_conditions
  timer_event -> check_conditions
  
  check_conditions -> size_condition: Check Size
  check_conditions -> timer_condition: Check Timer
  
  size_condition -> mark_immutable: Yes
  size_condition -> continue_ops: No
  
  timer_condition -> mark_immutable: Yes
  timer_condition -> continue_ops: No
  
  mark_immutable -> create_new
  create_new -> schedule_flush
  schedule_flush -> end
  
  continue_ops -> end
}

# Connection Styling
connections: {
  style: {
    stroke: "#8b949e"
    font-color: "#8b949e"
  }
}