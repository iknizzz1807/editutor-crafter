title: Conflict Detection Sequence
shape: sequence_diagram

node_a: Node A
node_b: Node B
node_c: Node C
client1: Client 1
client2: Client 2

client1 -> node_a: "WRITE key=X, value=A, VC=[1,0,0]"
node_a -> node_a: "Store version with VC=[1,0,0]"
node_a -> client1: ACK

client2 -> node_b: "WRITE key=X, value=B, VC=[0,1,0]"
node_b -> node_b: "Store version with VC=[0,1,0]"
node_b -> client2: ACK

node_a -> node_b: "Replicate: key=X, value=A, VC=[1,0,0]"
node_b -> node_b: "Compare VCs: [1,0,0] vs [0,1,0]"
node_b -> node_b: "Detect CONFLICT: incomparable vectors"
node_b -> node_b: Store both versions
node_b -> node_a: "CONFLICT_DETECTED: concurrent writes"

node_b -> node_c: "Replicate: key=X, values=[A,B], VCs=[[1,0,0],[0,1,0]]"
node_c -> node_c: Store conflicted versions
node_c -> node_b: ACK

node_a -> node_c: "Replicate: key=X, value=A, VC=[1,0,0]"
node_c -> node_c: "Already has version [1,0,0]"
node_c -> node_a: "CONFLICT_INFO: multiple versions exist"

node_a -> node_a: Update local state with conflict info
node_a -> node_a: Apply resolution strategy
node_a -> node_a: "Create merged version VC=[2,1,1]"

node_a -> node_b: "Resolved: key=X, value=merged, VC=[2,1,1]"
node_a -> node_c: "Resolved: key=X, value=merged, VC=[2,1,1]"

node_b -> node_a: ACK resolution
node_c -> node_a: ACK resolution