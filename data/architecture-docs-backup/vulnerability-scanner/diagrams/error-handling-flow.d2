title: Error Handling and Recovery Flow

classes: {
  error_style: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  process_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  recovery_style: {
    style.fill: "#00b894"
    style.stroke: "#00a085"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

error_detected: Error Detected {
  shape: circle
  class: error_style
}

classify_error: Classify Error Type {
  shape: diamond
  class: decision_style
}

network_timeout: Network Timeout {
  shape: rectangle
  class: error_style
}

privilege_failure: Privilege Failure {
  shape: rectangle
  class: error_style
}

rate_limit: API Rate Limit {
  shape: rectangle
  class: error_style
}

scan_interrupt: Scan Interruption {
  shape: rectangle
  class: error_style
}

timeout_recovery: Timeout Recovery {
  retry_with_backoff: Retry with Exponential Backoff {
    class: recovery_style
  }
  adjust_timeout: Adjust Timeout Values {
    class: recovery_style
  }
  check_connectivity: Check Network Connectivity {
    class: process_style
  }
  
  retry_with_backoff -> adjust_timeout: Failed retries
  check_connectivity -> retry_with_backoff: Connectivity OK
}

privilege_recovery: Privilege Recovery {
  check_perms: Check Required Permissions {
    class: process_style
  }
  request_elevation: Request Privilege Elevation {
    class: recovery_style
  }
  fallback_mode: Switch to Unprivileged Mode {
    class: recovery_style
  }
  
  check_perms -> request_elevation: Missing permissions
  check_perms -> fallback_mode: Cannot elevate
}

rate_limit_recovery: Rate Limit Recovery {
  wait_period: Wait for Reset Period {
    class: recovery_style
  }
  reduce_rate: Reduce Request Rate {
    class: recovery_style
  }
  queue_requests: Queue Pending Requests {
    class: process_style
  }
  
  wait_period -> reduce_rate: Reset complete
  queue_requests -> wait_period: Buffering
}

interrupt_recovery: Interrupt Recovery {
  save_state: Save Current Scan State {
    class: process_style
  }
  graceful_shutdown: Perform Graceful Shutdown {
    class: recovery_style
  }
  resume_scan: Resume from Last State {
    class: recovery_style
  }
  
  save_state -> graceful_shutdown: State saved
  save_state -> resume_scan: On restart
}

log_error: Log Error Details {
  class: process_style
}

retry_decision: Retry Scan? {
  shape: diamond
  class: decision_style
}

scan_complete: Scan Complete {
  shape: circle
  class: recovery_style
}

scan_failed: Scan Failed {
  shape: circle
  class: error_style
}

error_detected -> classify_error

classify_error -> network_timeout: Timeout
classify_error -> privilege_failure: Permissions
classify_error -> rate_limit: Rate limited
classify_error -> scan_interrupt: Interrupted

network_timeout -> timeout_recovery
privilege_failure -> privilege_recovery
rate_limit -> rate_limit_recovery
scan_interrupt -> interrupt_recovery

timeout_recovery -> log_error
privilege_recovery -> log_error
rate_limit_recovery -> log_error
interrupt_recovery -> log_error

log_error -> retry_decision

retry_decision -> scan_complete: Success/Max retries
retry_decision -> scan_failed: Permanent failure
retry_decision -> classify_error: Retry scan