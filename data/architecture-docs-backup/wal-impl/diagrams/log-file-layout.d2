title: Log File Layout

classes: {
  log_file: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  segment: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  record: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  mapping: {
    style.fill: "#2d3748"
    style.stroke: "#ffd700"
    style.font-color: "#e6edf3"
    style.stroke-dash: 3
  }
}

physical_structure: Physical Log Structure {
  class: log_file
  
  master_record: Master Record {
    class: record
    shape: page
    label: |md
      **Master Record**
      - Current active segment
      - Next LSN to assign
      - Checkpoint LSN
    |
  }
  
  segment_0: log_segment_0000.wal {
    class: segment
    shape: cylinder
    label: |md
      **Segment 0**
      LSN 0-999
      Status: Archived
    |
  }
  
  segment_1: log_segment_0001.wal {
    class: segment
    shape: cylinder
    label: |md
      **Segment 1**
      LSN 1000-1999
      Status: Archived
    |
  }
  
  segment_2: log_segment_0002.wal {
    class: segment
    shape: cylinder
    label: |md
      **Segment 2**
      LSN 2000-2999
      Status: Active
    |
  }
  
  master_record -> segment_2: points to active
}

logical_view: Logical LSN Sequence {
  class: log_file
  
  lsn_space: LSN Address Space {
    class: mapping
    shape: rectangle
    label: |md
      **Logical LSNs**
      0, 1, 2, 3, ... 2047, 2048, 2049
      Continuous sequence
    |
  }
}

segment_internals: Segment Internal Structure {
  class: log_file
  
  active_segment: Active Segment (log_segment_0002.wal) {
    class: segment
    
    header: Segment Header {
      class: record
      shape: page
      label: |md
        **Header**
        - Segment ID: 2
        - Start LSN: 2000
        - Creation time
        - Checksum
      |
    }
    
    log_records: Log Records {
      class: record
      shape: rectangle
      label: |md
        **Record Area**
        LSN 2000: BEGIN TX1
        LSN 2001: UPDATE page=5
        LSN 2002: COMMIT TX1
        LSN 2003: CHECKPOINT
        ...
      |
    }
    
    write_position: Write Position {
      class: mapping
      shape: diamond
      label: |md
        **Next Write**
        Offset: 8192
        Next LSN: 2048
      |
    }
    
    header -> log_records
    log_records -> write_position
  }
}

rotation_process: Log Rotation Process {
  class: log_file
  
  size_trigger: Size Threshold {
    class: mapping
    shape: diamond
    label: "Segment > 64MB?"
  }
  
  create_new: Create New Segment {
    class: record
    shape: rectangle
    label: |md
      **Rotation Steps**
      1. Flush current segment
      2. Create new segment file
      3. Update master record
      4. Switch active pointer
    |
  }
  
  archive_old: Archive Previous {
    class: segment
    shape: rectangle
    label: |md
      **Archive**
      Mark segment as read-only
      Available for truncation
    |
  }
  
  size_trigger -> create_new: Yes
  create_new -> archive_old
}

checkpoint_records: Checkpoint Record Layout {
  class: log_file
  
  checkpoint_lsn: Checkpoint at LSN 2003 {
    class: record
    shape: page
    label: |md
      **Checkpoint Record**
      - Active transactions: []
      - Dirty page table
      - Flushed LSN: 2002
      - Recovery start point
    |
  }
}

lsn_mapping: LSN to File Position Mapping {
  class: mapping
  
  mapping_table: Address Translation {
    class: mapping
    shape: rectangle
    label: |md
      **LSN → File Position**
      LSN 2000 → seg_0002.wal:64
      LSN 2001 → seg_0002.wal:128
      LSN 2002 → seg_0002.wal:192
      LSN 2003 → seg_0002.wal:256
    |
  }
}

# Relationships
physical_structure.segment_0 -> logical_view.lsn_space: "LSNs 0-999" {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}

physical_structure.segment_1 -> logical_view.lsn_space: "LSNs 1000-1999" {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}

physical_structure.segment_2 -> logical_view.lsn_space: "LSNs 2000+" {
  style.stroke: "#3fb950"
  style.bold: true
}

physical_structure.segment_2 -> segment_internals.active_segment: "detailed view" {
  style.stroke: "#ffd700"
}

segment_internals.active_segment -> rotation_process.size_trigger: "monitors size" {
  style.stroke: "#8b949e"
}

segment_internals.active_segment.log_records -> checkpoint_records.checkpoint_lsn: "contains" {
  style.stroke: "#3fb950"
}

logical_view.lsn_space -> lsn_mapping.mapping_table: "translates to" {
  style.stroke: "#ffd700"
  style.bold: true
}

lsn_mapping.mapping_table -> physical_structure: "resolves to files" {
  style.stroke: "#ffd700"
}