classes: {
  primary_entity: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  secondary_entity: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  relationship: {
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

title: Data Model Relationships {
  near: top-center
  style.font-size: 20
  style.font-color: "#e6edf3"
  style.bold: true
}

webhook_registrations: WebhookRegistrations {
  shape: sql_table
  class: primary_entity
  id: "UUID (PK)"
  tenant_id: "UUID"
  endpoint_url: "VARCHAR(2048)"
  secret_key: "VARCHAR(255)"
  is_active: "BOOLEAN"
  event_types: "TEXT[]"
  retry_policy: "JSONB"
  circuit_breaker_config: "JSONB"
  created_at: "TIMESTAMP"
  updated_at: "TIMESTAMP"
}

webhook_events: WebhookEvents {
  shape: sql_table
  class: primary_entity
  id: "UUID (PK)"
  event_type: "VARCHAR(255)"
  payload: "JSONB"
  source_id: "UUID"
  idempotency_key: "VARCHAR(255)"
  priority: "INTEGER"
  scheduled_at: "TIMESTAMP"
  expires_at: "TIMESTAMP"
  created_at: "TIMESTAMP"
}

delivery_attempts: DeliveryAttempts {
  shape: sql_table
  class: primary_entity
  id: "UUID (PK)"
  webhook_registration_id: "UUID (FK)"
  webhook_event_id: "UUID (FK)"
  attempt_number: "INTEGER"
  status: "VARCHAR(50)"
  http_status_code: "INTEGER"
  response_body: "TEXT"
  error_message: "TEXT"
  delivery_duration_ms: "INTEGER"
  attempted_at: "TIMESTAMP"
  next_retry_at: "TIMESTAMP"
}

circuit_breaker_state: CircuitBreakerState {
  shape: sql_table
  class: secondary_entity
  webhook_registration_id: "UUID (PK, FK)"
  state: "VARCHAR(20)"
  failure_count: "INTEGER"
  success_count: "INTEGER"
  last_failure_at: "TIMESTAMP"
  next_attempt_at: "TIMESTAMP"
  updated_at: "TIMESTAMP"
}

event_subscriptions: EventSubscriptions {
  shape: sql_table
  class: secondary_entity
  id: "UUID (PK)"
  webhook_registration_id: "UUID (FK)"
  event_type: "VARCHAR(255)"
  filter_conditions: "JSONB"
  is_active: "BOOLEAN"
  created_at: "TIMESTAMP"
}

# Primary Relationships
webhook_registrations -> delivery_attempts: "1:N" {
  class: relationship
}

webhook_events -> delivery_attempts: "1:N" {
  class: relationship
}

webhook_registrations -> circuit_breaker_state: "1:1" {
  class: relationship
}

webhook_registrations -> event_subscriptions: "1:N" {
  class: relationship
}

# Composite relationship
delivery_composite: "" {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  width: 8
  height: 8
  near: center-right
}

webhook_registrations -> delivery_composite {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}

webhook_events -> delivery_composite {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}

delivery_composite -> delivery_attempts {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}

# Indexes note
indexes_note: |md
  ## Key Indexes
  - delivery_attempts(webhook_registration_id, status)
  - delivery_attempts(webhook_event_id, attempt_number)
  - webhook_events(event_type, scheduled_at)
  - circuit_breaker_state(state, next_attempt_at)
| {
  shape: page
  near: bottom-left
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}