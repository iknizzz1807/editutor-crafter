# Message Processing Flow

tcp_data: TCP Data Stream {
  shape: cylinder
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

frame_parser: Frame Parser {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

header_decoder: Header Decoder {
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

payload_extractor: Payload Extractor {
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

mask_check: Client Data? {
  shape: diamond
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

unmasker: Payload Unmasker {
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

fragment_check: Fragmented? {
  shape: diamond
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

fragment_buffer: Fragment Buffer {
  shape: cylinder
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

assembler: Message Assembler {
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

complete_message: Complete Message {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

router: Message Router {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

app_handlers: Application Handlers {
  text_handler: Text Handler
  binary_handler: Binary Handler
  ping_handler: Ping Handler
  pong_handler: Pong Handler
  close_handler: Close Handler
  
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Main flow
tcp_data -> frame_parser: Raw bytes

frame_parser -> header_decoder: Parse frame header
frame_parser -> payload_extractor: Extract payload

header_decoder -> mask_check: Check mask bit
payload_extractor -> mask_check

mask_check -> unmasker: Yes (masked)
mask_check -> fragment_check: No (server data)

unmasker -> fragment_check: Unmasked payload

fragment_check -> fragment_buffer: Yes (fragmented)
fragment_check -> complete_message: No (complete frame)

fragment_buffer -> assembler: Store fragment
assembler -> complete_message: All fragments received

complete_message -> router: Route by opcode

router -> app_handlers.text_handler: Text frames
router -> app_handlers.binary_handler: Binary frames
router -> app_handlers.ping_handler: Ping frames
router -> app_handlers.pong_handler: Pong frames
router -> app_handlers.close_handler: Close frames