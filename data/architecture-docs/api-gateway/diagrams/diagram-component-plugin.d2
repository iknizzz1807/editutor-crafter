title: Plugin Architecture Component Diagram

classes: {
  container_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.stroke-width: 2
  }
  component_style: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    style.stroke-width: 1
  }
  interface_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.stroke-dash: 3
  }
  plugin_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#e3b341"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

api_gateway: API Gateway {
  class: container_style
  
  plugin_manager: Plugin Manager {
    class: component_style
    
    config_loader: Configuration Loader {
      class: component_style
      - "loads YAML/JSON configs"
      - "validates plugin metadata"
      - "parses execution order"
    }
    
    plugin_registry: Plugin Registry {
      class: component_style
      - "maintains plugin instances"
      - "tracks execution phases"
      - "stores initialization state"
    }
    
    orchestrator: Plugin Orchestrator {
      class: component_style
      - "invokes plugins in order"
      - "manages request/response flow"
      - "handles plugin errors"
    }
  }
  
  plugins: Plugin Container {
    class: container_style
    shape: rectangle
    
    request_phase: Request Phase {
      class: interface_style
      shape: rectangle
      label: "Request Phase Plugins"
    }
    
    logger: Logger Plugin {
      class: plugin_style
      - "logs incoming requests"
      - "captures request metadata"
      - "adds correlation IDs"
    }
    
    rate_limiter: RateLimiter Plugin {
      class: plugin_style
      - "checks rate limits"
      - "enforces quotas"
      - "returns 429 when exceeded"
    }
    
    auth: Authentication Plugin {
      class: plugin_style
      - "validates API keys"
      - "verifies JWT tokens"
      - "checks permissions"
    }
    
    response_phase: Response Phase {
      class: interface_style
      shape: rectangle
      label: "Response Phase Plugins"
    }
    
    metrics: Metrics Plugin {
      class: plugin_style
      - "collects performance data"
      - "records response times"
      - "tracks error rates"
    }
    
    transformer: Transformer Plugin {
      class: plugin_style
      - "modifies response format"
      - "filters sensitive data"
      - "adds standard headers"
    }
  }
}

config_source: Config Source {
  class: component_style
  shape: cylinder
  - "plugin definitions"
  - "ordering configuration"
  - "plugin settings"
}

client: External Client {
  class: component_style
}

backend: Backend Service {
  class: component_style
}

# Configuration loading flow
config_source -> plugin_manager.config_loader: "reads plugin configs"
plugin_manager.config_loader -> plugin_manager.plugin_registry: "registers plugins"
plugin_manager.plugin_registry -> plugin_manager.orchestrator: "provides execution order"

# Request flow
client -> api_gateway: "HTTP Request"
api_gateway -> plugin_manager.orchestrator: "passes to plugin chain"

# Request phase execution
plugin_manager.orchestrator -> plugins.request_phase: "invokes request plugins"
plugins.request_phase -> plugins.logger: "1. Logger"
plugins.logger -> plugins.rate_limiter: "2. RateLimiter"
plugins.rate_limiter -> plugins.auth: "3. Authentication"

# Forward to backend
plugins.auth -> backend: "authenticated request"

# Response phase execution
backend -> plugin_manager.orchestrator: "backend response"
plugin_manager.orchestrator -> plugins.response_phase: "invokes response plugins"
plugins.response_phase -> plugins.metrics: "1. Metrics"
plugins.metrics -> plugins.transformer: "2. Transformer"

# Final response
plugins.transformer -> api_gateway: "transformed response"
api_gateway -> client: "HTTP Response"

# Plugin registry interactions
plugin_manager.plugin_registry -> plugins.logger: "manages lifecycle"
plugin_manager.plugin_registry -> plugins.rate_limiter: "manages lifecycle"
plugin_manager.plugin_registry -> plugins.auth: "manages lifecycle"
plugin_manager.plugin_registry -> plugins.metrics: "manages lifecycle"
plugin_manager.plugin_registry -> plugins.transformer: "manages lifecycle"

# Execution order notes
note: |md
  **Plugin Execution Order:**
  1. Request Phase (sequential):
     - Logger → RateLimiter → Authentication
  2. Backend Processing
  3. Response Phase (sequential):
     - Metrics → Transformer
| {
  shape: page
  class: component_style
  near: bottom-right
}