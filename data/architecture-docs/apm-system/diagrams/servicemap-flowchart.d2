title: "Flowchart: Service Map Construction"

direction: down

classes: {
  start_end: {
    shape: oval
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  process: {
    shape: rectangle
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  data: {
    shape: parallelogram
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    style.italic: true
  }
  note: {
    shape: page
    style.fill: "#0d1117"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

start: "Start" {
  class: start_end
}

raw_spans: "Raw Spans Input" {
  class: data
}

group_trace: "Group Spans by Trace ID" {
  class: process
}

extract_edges: "Extract Service Call Edges" {
  class: process
}

aggregate: "Aggregate Edge Metrics" {
  class: process
  label: "Aggregate Edge Metrics:\n- Call Count\n- Error Rate\n- Latency (p50, p95, p99)"
}

update_graph: "Update In-Memory Service Graph" {
  class: process
}

render: "Render Visualization" {
  class: process
}

end: "End" {
  class: start_end
}

note1: "Each span contains:\n- Trace ID\n- Service Name\n- Parent Span ID\n- Operation Name\n- Start/End Time\n- Status Code" {
  class: note
  near: top-right
}

note2: "Service graph is updated incrementally:\n- Add new edges\n- Update metrics for existing edges\n- Evict stale edges" {
  class: note
  near: bottom-right
}

start -> raw_spans
raw_spans -> group_trace
group_trace -> extract_edges
extract_edges -> aggregate
aggregate -> update_graph
update_graph -> render
render -> end

