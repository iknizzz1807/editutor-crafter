title: Visitor Pattern Class Diagram

classes: {
  node_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  visitor_style: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  abstract_style: {
    style.double-border: true
    style.stroke-dash: 3
  }
}

ast_hierarchy: {
  shape: rectangle
  label: "AST Node Hierarchy"
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  node: Node {
    shape: class
    class: node_style
    class: abstract_style
    + "location: SourceLocation"
    + "accept(visitor: Visitor): void"
  }

  expr: Expr {
    shape: class
    class: node_style
    class: abstract_style
    + "accept(visitor: Visitor): void"
  }

  stmt: Stmt {
    shape: class
    class: node_style
    class: abstract_style
    + "accept(visitor: Visitor): void"
  }

  binary_expr: BinaryExpr {
    shape: class
    class: node_style
    - "left: Expr"
    - "operator: Token"
    - "right: Expr"
    + "accept(visitor: Visitor): void"
  }

  unary_expr: UnaryExpr {
    shape: class
    class: node_style
    - "operator: Token"
    - "operand: Expr"
    + "accept(visitor: Visitor): void"
  }

  literal: Literal {
    shape: class
    class: node_style
    - "value: any"
    + "accept(visitor: Visitor): void"
  }

  if_stmt: IfStmt {
    shape: class
    class: node_style
    - "condition: Expr"
    - "then_branch: Stmt"
    - "else_branch: Stmt?"
    + "accept(visitor: Visitor): void"
  }

  while_stmt: WhileStmt {
    shape: class
    class: node_style
    - "condition: Expr"
    - "body: Stmt"
    + "accept(visitor: Visitor): void"
  }

  print_stmt: PrintStmt {
    shape: class
    class: node_style
    - "expression: Expr"
    + "accept(visitor: Visitor): void"
  }

  node -> expr: "inherits"
  node -> stmt: "inherits"
  expr -> binary_expr: "inherits"
  expr -> unary_expr: "inherits"
  expr -> literal: "inherits"
  stmt -> if_stmt: "inherits"
  stmt -> while_stmt: "inherits"
  stmt -> print_stmt: "inherits"
}

visitor_hierarchy: {
  shape: rectangle
  label: "Visitor Hierarchy"
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  visitor: Visitor {
    shape: class
    class: visitor_style
    class: abstract_style
    + "visitBinaryExpr(expr: BinaryExpr): void"
    + "visitUnaryExpr(expr: UnaryExpr): void"
    + "visitLiteral(expr: Literal): void"
    + "visitIfStmt(stmt: IfStmt): void"
    + "visitWhileStmt(stmt: WhileStmt): void"
    + "visitPrintStmt(stmt: PrintStmt): void"
  }

  pretty_printer: PrettyPrinter {
    shape: class
    class: visitor_style
    - "output: string"
    + "visitBinaryExpr(expr: BinaryExpr): void"
    + "visitUnaryExpr(expr: UnaryExpr): void"
    + "visitLiteral(expr: Literal): void"
    + "visitIfStmt(stmt: IfStmt): void"
    + "visitWhileStmt(stmt: WhileStmt): void"
    + "visitPrintStmt(stmt: PrintStmt): void"
    + "getResult(): string"
  }

  evaluator: Evaluator {
    shape: class
    class: visitor_style
    - "environment: Map<string, any>"
    - "result: any"
    + "visitBinaryExpr(expr: BinaryExpr): void"
    + "visitUnaryExpr(expr: UnaryExpr): void"
    + "visitLiteral(expr: Literal): void"
    + "visitIfStmt(stmt: IfStmt): void"
    + "visitWhileStmt(stmt: WhileStmt): void"
    + "visitPrintStmt(stmt: PrintStmt): void"
    + "getResult(): any"
  }

  visitor -> pretty_printer: "implements"
  visitor -> evaluator: "implements"
}

interaction_note: |md
  ## Double Dispatch Mechanism
  Each AST node's `accept` method calls the visitor's corresponding `visit` method:
  
  ```typescript
  class BinaryExpr extends Expr {
    accept(visitor: Visitor): void {
      visitor.visitBinaryExpr(this); // Static dispatch
    }
  }
  ```
  
  This enables type-safe traversal without instanceof checks.
| {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  near: top-center
}

binary_expr -> visitor: "accept(visitor)" {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}

visitor -> binary_expr: "visitBinaryExpr(this)" {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}

ast_hierarchy -> visitor_hierarchy: "accepts" {
  style.stroke: "#3fb950"
  style.bold: true
}