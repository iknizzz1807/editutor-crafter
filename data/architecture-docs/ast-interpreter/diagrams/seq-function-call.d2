shape: sequence_diagram

# Title and note
title: "Sequence Diagram: Function Call with Closure" {
  near: top-center
  style.bold: true
  style.font-size: 28
  style.font-color: "#3fb950"
}

note: |md
  **Traces the steps:**
  1. Evaluator encounters Call node
  2. Evaluates callee (Function value)
  3. Creates new Environment with callee's closure_environment as parent
  4. Binds arguments
  5. Evaluates body in new environment
  6. Returns result
| {
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  style.italic: true
}

# Actors (participants)
evaluator: "Caller's Evaluator" {
  class: actor_style
}
callee_func: "Callee (Function Value)" {
  class: actor_style
}
caller_env: "Caller Environment" {
  class: actor_style
}
closure_env: "Closure Environment" {
  class: actor_style
}
new_env: "New Environment" {
  class: actor_style
}

# Messages/Steps
evaluator -> callee_func: "1. evaluate(CallNode)"
callee_func -> evaluator: "2. returns Function value\n(contains closure_environment ref)"
evaluator -> new_env: "3. Environment.create(parent=closure_env)"
new_env -> closure_env: "sets parent reference"
evaluator -> new_env: "4. bind_arguments(args)"
evaluator -> callee_func: "5. evaluate_body(new_env)"
callee_func -> new_env: "lookup variables during evaluation"
new_env -> closure_env: "delegated lookups (if needed)"
callee_func -> evaluator: "6. returns result"
evaluator -> caller_env: "result propagates back"

# Styling classes
classes: {
  actor_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}