title: "Flowchart: Trampoline Execution Flow"

# Define styling classes
classes: {
  trampoline_box: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.stroke-width: 2
    style.font-color: "#e6edf3"
  }
  step_box: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  start_end: {
    shape: oval
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.stroke-width: 3
    style.font-color: "#e6edf3"
    style.bold: true
  }
  connection: {
    style.stroke: "#8b949e"
    style.stroke-dash: 0
  }
}

# Main flow
original_function_called: "Original Function Called (Hooked)" {
  class: start_end
}

trampoline_jump: "1. Jump to Trampoline" {
  class: step_box
}

trampoline_code: Trampoline Code Area {
  class: trampoline_box
  
  save_regs: "2. Save CPU Registers" {
    class: step_box
  }
  
  call_hook: "3. Call Hook Function" {
    class: step_box
  }
  
  restore_regs: "4. Restore Registers" {
    class: step_box
  }
  
  exec_prologue: "5. Execute Relocated Original Prologue" {
    class: step_box
  }
  
  jump_back: "6. Jump to Original Function Body" {
    class: step_box
  }
}

original_function_body: "Original Function Body" {
  class: start_end
}

# Connect the flow
original_function_called -> trampoline_jump: "Patched instruction redirects execution"
trampoline_jump -> trampoline_code.save_regs: "Execution lands in trampoline"

# Internal trampoline flow
trampoline_code.save_regs -> trampoline_code.call_hook: "Preserve CPU state"
trampoline_code.call_hook -> trampoline_code.restore_regs: "Run custom monitoring logic"
trampoline_code.restore_regs -> trampoline_code.exec_prologue: "Restore original state"
trampoline_code.exec_prologue -> trampoline_code.jump_back: "Run displaced instructions"

# Return to original flow
trampoline_code.jump_back -> original_function_body: "Continue normal execution"

# Apply connection styles to all edges
edges: {
  class: connection
}

# Add explanatory notes
note: |md
  ## How the Trampoline Works
  
  1. **Initial Redirection**: First few bytes of original function are replaced with a jump to trampoline
  2. **State Preservation**: Trampoline saves all CPU registers to stack
  3. **Hook Execution**: Custom monitoring/analysis function is called
  4. **State Restoration**: Original register values are restored
  5. **Original Prologue**: Displaced instructions from original function are executed
  6. **Return to Normal**: Execution continues in original function body
  
  **Key Property**: The trampoline is **transparent** - original function behavior is preserved.
| {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}