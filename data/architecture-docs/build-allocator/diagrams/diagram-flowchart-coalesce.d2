title: Flowchart: Coalescing Adjacent Free Blocks

direction: down

# Start
start: Start coalesce_block(block_ptr) {
  shape: oval
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Check next block
check_next: Is next block free? {
  shape: diamond
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

# Next block operations
merge_next: Merge with next block {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
update_next_header: Update combined block header {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
update_next_footer: Update combined block footer {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
remove_next_from_freelist: Remove next block from free list {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Check previous block
check_prev: Is previous block free? {
  shape: diamond
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

# Previous block operations
merge_prev: Merge with previous block {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
update_prev_header: Update previous block header (now larger) {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
update_prev_footer: Update new combined footer {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
remove_prev_from_freelist: Remove previous block from free list {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Final updates and return
finalize_updates: Update free list pointers {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
return_block: Return coalesced block pointer {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
end: End {
  shape: oval
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Connections
start -> check_next

# Next block flow
check_next -> merge_next: Yes {
  style.stroke: "#3fb950"
}
check_next -> check_prev: No {
  style.stroke: "#8b949e"
}

merge_next -> update_next_header
update_next_header -> update_next_footer
update_next_footer -> remove_next_from_freelist
remove_next_from_freelist -> check_prev

# Previous block flow
check_prev -> merge_prev: Yes {
  style.stroke: "#3fb950"
}
check_prev -> finalize_updates: No {
  style.stroke: "#8b949e"
}

merge_prev -> update_prev_header
update_prev_header -> update_prev_footer
update_prev_footer -> remove_prev_from_freelist
remove_prev_from_freelist -> finalize_updates

# Final steps
finalize_updates -> return_block
return_block -> end