title: Block State Machine

direction: right

# States
start: {
  shape: circle
  style.fill: "#3fb950"
}
allocated: ALLOCATED {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
free: FREE {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
wilderness: WILDERNESS {
  style.fill: "#1a1a2e"
  style.stroke: "#ff7b72"
  style.font-color: "#e6edf3"
}

# Initial state
start -> wilderness: "heap init"

# Transitions
allocated -> free: free
free -> allocated: malloc (no split)
free -> allocated: malloc (split) {
  style.stroke-dash: 2
}

wilderness -> allocated: malloc (no split)
wilderness -> allocated: malloc (split) {
  style.stroke-dash: 2
}

free -> wilderness: coalesce (with wilderness) {
  style.stroke: "#ff7b72"
}
allocated -> wilderness: free (at heap end) {
  style.stroke: "#ff7b72"
}

# Note about split/coalesce
note: |md
  **Split**: When a free/wilderness block
  is larger than requested, it can be
  split into allocated + free parts

  **Coalesce**: Adjacent free blocks
  can merge into one larger free block
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}