title: Complete Download Flow

shape: sequence_diagram

client: BitTorrent Client {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}

tracker: Tracker {
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}

peer1: Peer 1 {
  style.fill: "#0f3460"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}

peer2: Peer 2 {
  style.fill: "#0f3460"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}

client -> client: Parse torrent file\nExtract info_hash & tracker URL
client -> tracker: Announce request\n(info_hash, peer_id, port, uploaded=0, downloaded=0)
tracker -> client: Peer list response\n(peers with IP:port)
client -> peer1: TCP connection + BitTorrent handshake\n(protocol, info_hash, peer_id)
peer1 -> client: Handshake response
client -> peer2: TCP connection + BitTorrent handshake
peer2 -> client: Handshake response
peer1 -> client: Bitfield message\n(pieces available)
peer2 -> client: Bitfield message
client -> peer1: Interested message
client -> peer2: Interested message
peer1 -> client: Unchoke message
peer2 -> client: Unchoke message
client -> peer1: Request message\n(piece index, block offset, length)
client -> peer2: Request message\n(different piece/block)
peer1 -> client: Piece message\n(block data)
peer2 -> client: Piece message\n(block data)
client -> client: Verify piece hash\nWrite to file
client -> peer1: Have message\n(completed piece)
client -> peer2: Have message
client -> tracker: Announce update\n(uploaded, downloaded, left)
client -> client: Continue until\nall pieces downloaded
client -> tracker: Announce complete\n(event=completed, left=0)