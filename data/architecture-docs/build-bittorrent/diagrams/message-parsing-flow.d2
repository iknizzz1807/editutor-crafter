title: Peer Message Parsing {
  style.font-size: 24
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
}

start: Start {
  shape: circle
  style.fill: "#3fb950"
  style.font-color: "#000000"
}

read_length: Read 4-byte\nLength Prefix {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

check_length: Length = 0? {
  shape: diamond
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

keepalive: Keep-alive\nMessage {
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

read_type: Read Message\nType Byte {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

read_payload: Read Payload\n(length - 1 bytes) {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

dispatch: Message Type\nDispatch {
  shape: diamond
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

msg_types: Message Handlers {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  choke: Choke (0) {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  unchoke: Unchoke (1) {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  interested: Interested (2) {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  bitfield: Bitfield (5) {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  request: Request (6) {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  piece: Piece (7) {
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

process_complete: Processing\nComplete {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

error: Parse Error {
  shape: circle
  style.fill: "#d63031"
  style.font-color: "#ffffff"
}

start -> read_length

read_length -> check_length

check_length -> keepalive: Yes
check_length -> read_type: No

keepalive -> process_complete

read_type -> read_payload

read_payload -> dispatch

dispatch -> msg_types.choke: 0
dispatch -> msg_types.unchoke: 1  
dispatch -> msg_types.interested: 2
dispatch -> msg_types.bitfield: 5
dispatch -> msg_types.request: 6
dispatch -> msg_types.piece: 7
dispatch -> error: Unknown

msg_types.choke -> process_complete
msg_types.unchoke -> process_complete
msg_types.interested -> process_complete
msg_types.bitfield -> process_complete
msg_types.request -> process_complete
msg_types.piece -> process_complete

read_length -> error: Invalid
read_payload -> error: Timeout
process_complete -> start: Next Message