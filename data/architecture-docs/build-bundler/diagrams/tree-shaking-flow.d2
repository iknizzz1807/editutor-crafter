title: Tree Shaking Process Flowchart
desc: A flowchart illustrating the mark-and-sweep algorithm for tree shaking.

direction: down

# Theme - inline all color values instead of using vars references
# since vars with style.X keys cause issues

style: {
  font-color: "#e2e8f0"
  stroke: "#3fb950"
  fill: "#0f172a"
}

# Process Flow
start: Start {
  shape: oval
  style.fill: "#fbbf24"
  style.font-color: "#0f172a"
}

parse_entry: Parse Entry Module
collect_exports: Collect All Exports
collect_imports: Collect All Imports
initialize_graph: Initialize Dependency Graph

mark_used_exports: Mark Used Exports {
  style.stroke-width: 3
  style.bold: true
}

mark_phase: {
  shape: rectangle
  style.stroke: "#fbbf24"
  style.fill: "#1e293b"
  label: "Mark Phase"
}

traverse_imports: Traverse Imports Recursively
check_side_effects: Check for Side Effects?
already_visited: Already Visited?
add_to_used: Add to Used Set

sweep_phase: {
  shape: rectangle
  style.stroke: "#ef4444"
  style.fill: "#1e293b"
  label: "Sweep Phase"
}

prune_unmarked: Prune Unmarked Nodes
remove_dead_code: Remove Dead Code
rewrite_references: Rewrite Remaining References
generate_output: Generate Optimized Bundle
end: End {
  shape: oval
  style.fill: "#fbbf24"
  style.font-color: "#0f172a"
}

# Decision Nodes
decision_side_effects: Side Effects Detected? {
  shape: diamond
}

decision_visited: Already in Used Set? {
  shape: diamond
}

decision_more_imports: More Imports to Process? {
  shape: diamond
}

# Connections
start -> parse_entry
parse_entry -> collect_exports
collect_exports -> collect_imports
collect_imports -> initialize_graph
initialize_graph -> mark_phase

mark_phase -> mark_used_exports
mark_used_exports -> traverse_imports
traverse_imports -> decision_more_imports

decision_more_imports -> check_side_effects: Yes
decision_more_imports -> sweep_phase: No

check_side_effects -> decision_side_effects
decision_side_effects -> add_to_used: Yes {style.stroke: "#ef4444"}
decision_side_effects -> decision_visited: No

decision_visited -> add_to_used: No
decision_visited -> traverse_imports: Yes {style.stroke-dash: 3}

add_to_used -> traverse_imports

sweep_phase -> prune_unmarked
prune_unmarked -> remove_dead_code
remove_dead_code -> rewrite_references
rewrite_references -> generate_output
generate_output -> end

# Notes
note: |md
  **Key Concepts:**
  - Starts from entry point
  - Marks used exports via import traversal
  - Recursively processes entire dependency graph
  - Removes unmarked (dead) code
  - Preserves modules with side effects
| {
  shape: page
  style.fill: "#1e293b"
  style.stroke: "#fbbf24"
  style.stroke-dash: 2
}
