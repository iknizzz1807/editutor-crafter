title: Two-Phase Commit Flowchart
description: Shows the flowchart for 2PC with coordinator and participants, including prepare, commit, abort states and decision paths. Include failure recovery paths.

direction: down

# Theme
colors: {
  background: "#0d1117"
  root: {
    style.fill: "#0d1117"
    style.stroke: "#30363d"
  }
  container: {
    style.fill: "#161b22"
    style.stroke: "#3fb950"
  }
  node: {
    style.fill: "#21262d"
    style.stroke: "#8b949e"
  }
  text: {
    style.fill: "#e6edf3"
  }
  edge: {
    style.stroke: "#8b949e"
  }
}

# Coordinator Section
coordinator: {
  shape: rectangle
  label: "Coordinator"
  style: {
    fill: "#1a1a2e"
    stroke: "#3fb950"
    font-color: "#e6edf3"
  }

  start: {
    shape: circle
    style.fill: "#3fb950"
    label: "Start TX"
  }
  
  send_prepare: {
    label: "Send PREPARE to all participants"
  }
  
  wait_votes: {
    label: "Wait for votes (timeout)"
    shape: diamond
  }
  
  collect_all_yes: {
    label: "All votes YES?"
    shape: diamond
  }
  
  send_commit: {
    label: "Send COMMIT to all"
  }
  
  send_abort: {
    label: "Send ABORT to all"
  }
  
  wait_acks: {
    label: "Wait for ACKs (timeout)"
  }
  
  end_commit: {
    shape: circle
    label: "TX Committed"
    style.stroke-width: 3
  }
  
  end_abort: {
    shape: circle
    label: "TX Aborted"
  }

  # Coordinator Flow
  start -> send_prepare
  send_prepare -> wait_votes
  wait_votes -> collect_all_yes: "Votes received"
  wait_votes -> send_abort: "Timeout"
  collect_all_yes -> send_commit: "Yes"
  collect_all_yes -> send_abort: "No"
  send_commit -> wait_acks
  send_abort -> wait_acks
  wait_acks -> end_commit: "All ACKs"
  wait_acks -> end_abort: "Timeout"
}

# Participant Section
participant: {
  shape: rectangle
  label: "Participant"
  style: {
    fill: "#1a1a2e"
    stroke: "#3fb950"
    font-color: "#e6edf3"
  }

  p_start: {
    shape: circle
    style.fill: "#3fb950"
    label: "Idle"
  }
  
  receive_prepare: {
    label: "Receive PREPARE"
  }
  
  can_prepare: {
    label: "Can prepare?"
    shape: diamond
  }
  
  write_wal: {
    label: "Write WAL (Prepared)"
    shape: cylinder
  }
  
  send_no: {
    label: "Send NO vote"
  }
  
  send_yes: {
    label: "Send YES vote"
  }
  
  wait_decision: {
    label: "Wait for decision (timeout)"
    shape: diamond
  }
  
  receive_commit: {
    label: "Receive COMMIT"
  }
  
  receive_abort: {
    label: "Receive ABORT"
  }
  
  commit_tx: {
    label: "Commit transaction"
  }
  
  abort_tx: {
    label: "Abort transaction"
  }
  
  send_ack: {
    label: "Send ACK"
  }
  
  p_end: {
    shape: circle
    label: "Done"
  }

  # Participant Flow
  p_start -> receive_prepare
  receive_prepare -> can_prepare
  can_prepare -> write_wal: "Yes"
  can_prepare -> send_no: "No"
  write_wal -> send_yes
  send_yes -> wait_decision
  send_no -> abort_tx
  abort_tx -> send_ack
  send_ack -> p_end
  
  wait_decision -> receive_commit: "COMMIT received"
  wait_decision -> receive_abort: "ABORT received"
  wait_decision -> abort_tx: "Timeout (Recovery)"
  
  receive_commit -> commit_tx
  commit_tx -> send_ack
  receive_abort -> abort_tx
}

# Failure Recovery Paths
recovery_paths: {
  shape: rectangle
  label: "Failure Recovery Paths"
  style: {
    fill: "#0f3460"
    stroke: "#ff7b72"
    font-color: "#e6edf3"
  }

  coordinator_fails: {
    label: "Coordinator fails after sending PREPARE"
  }
  
  participant_timeout: {
    label: "Participant timeout waiting for decision"
  }
  
  query_others: {
    label: "Query other participants"
    shape: diamond
  }
  
  global_commit: {
    label: "Any participant committed?"
    shape: diamond
  }
  
  global_abort: {
    label: "Any participant aborted?"
    shape: diamond
  }
  
  recover_commit: {
    label: "Recover: Commit"
  }
  
  recover_abort: {
    label: "Recover: Abort"
  }

  # Recovery Flow
  participant_timeout -> query_others
  query_others -> global_commit
  global_commit -> recover_commit: "Yes"
  global_commit -> global_abort: "No"
  global_abort -> recover_abort: "Yes"
}

# Connections between sections
coordinator.send_prepare -> participant.receive_prepare: "PREPARE"
participant.send_yes -> coordinator.wait_votes: "VOTE YES"
participant.send_no -> coordinator.wait_votes: "VOTE NO"
coordinator.send_commit -> participant.receive_commit: "COMMIT"
coordinator.send_abort -> participant.receive_abort: "ABORT"
participant.send_ack -> coordinator.wait_acks: "ACK"

# Styling for important nodes
participant.write_wal.style.stroke: "#3fb950"
participant.write_wal.style.stroke-width: 2

participant.wait_decision.style.stroke: "#ff7b72"
participant.wait_decision.style.stroke-width: 2

participant.can_prepare.style.stroke: "#ff7b72"
participant.can_prepare.style.stroke-width: 2

coordinator.collect_all_yes.style.stroke: "#ff7b72"
coordinator.collect_all_yes.style.stroke-width: 2
