hash_ring: Consistent Hashing Ring {
  shape: circle
  style.fill: "transparent"
  style.stroke: "#3fb950"
  style.stroke-width: 4
  style.font-color: "#e6edf3"

  ring_labels: {
    shape: circle
    style.fill: "transparent"
    style.stroke: "transparent"
    style.font-color: "#8b949e"
    
    0: "0"
    90: "2^32 / 4"
    180: "2^32 / 2"
    270: "3 * 2^32 / 4"
  }

  node_a: Node A {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.bold: true
    
    vnodes: {
      a1: {
        shape: circle
        label: "A₁"
        style.fill: "#0f3460"
        style.stroke: "#3fb950"
      }
      a2: {
        shape: circle
        label: "A₂"
        style.fill: "#0f3460"
        style.stroke: "#3fb950"
      }
      a3: {
        shape: circle
        label: "A₃"
        style.fill: "#0f3460"
        style.stroke: "#3fb950"
      }
    }
  }

  node_b: Node B {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.bold: true
    
    vnodes: {
      b1: {
        shape: circle
        label: "B₁"
        style.fill: "#0f3460"
        style.stroke: "#3fb950"
      }
      b2: {
        shape: circle
        label: "B₂"
        style.fill: "#0f3460"
        style.stroke: "#3fb950"
      }
      b3: {
        shape: circle
        label: "B₃"
        style.fill: "#0f3460"
        style.stroke: "#3fb950"
      }
    }
  }

  node_c: Node C {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.bold: true
    
    vnodes: {
      c1: {
        shape: circle
        label: "C₁"
        style.fill: "#0f3460"
        style.stroke: "#3fb950"
      }
      c2: {
        shape: circle
        label: "C₂"
        style.fill: "#0f3460"
        style.stroke: "#3fb950"
      }
      c3: {
        shape: circle
        label: "C₃"
        style.fill: "#0f3460"
        style.stroke: "#3fb950"
      }
    }
  }

  keys: {
    key1: {
      shape: diamond
      label: "user:123"
      style.fill: "#16213e"
      style.stroke: "#ff7b72"
      style.font-color: "#ff7b72"
    }
    key2: {
      shape: diamond
      label: "session:abc"
      style.fill: "#16213e"
      style.stroke: "#ff7b72"
      style.font-color: "#ff7b72"
    }
    key3: {
      shape: diamond
      label: "config:rate_limit"
      style.fill: "#16213e"
      style.stroke: "#ff7b72"
      style.font-color: "#ff7b72"
    }
    key4: {
      shape: diamond
      label: "cache:item_xyz"
      style.fill: "#16213e"
      style.stroke: "#ff7b72"
      style.font-color: "#ff7b72"
    }
  }

  # Key to vnode assignments
  key1 -> node_a.vnodes.a2: "hash → A₂"
  key2 -> node_b.vnodes.b1: "hash → B₁"
  key3 -> node_c.vnodes.c3: "hash → C₃"
  key4 -> node_a.vnodes.a1: "hash → A₁"

  # Replica placements (next 2 nodes clockwise)
  node_a.vnodes.a2 -> node_b.vnodes.b3: "replica 1"
  node_a.vnodes.a2 -> node_c.vnodes.c1: "replica 2"
}

# Node join scenario
node_join_scenario: {
  node_d: New Node D {
    style.fill: "#1a1a2e"
    style.stroke: "#58a6ff"
    style.bold: true
    
    vnodes: {
      d1: {
        shape: circle
        label: "D₁"
        style.fill: "#0a3069"
        style.stroke: "#58a6ff"
      }
      d2: {
        shape: circle
        label: "D₂"
        style.fill: "#0a3069"
        style.stroke: "#58a6ff"
      }
    }
  }

  # Keys that move when D joins
  redistributed_keys: {
    key_moved: {
      shape: diamond
      label: "migrated key"
      style.fill: "#16213e"
      style.stroke: "#58a6ff"
      style.font-color: "#58a6ff"
    }
  }

  key_moved -> node_d.vnodes.d1: "now hashes → D₁"
  key_moved -- hash_ring.keys.key4: "was on A₁"
  
  note: |md
  ## Node Join Impact
  - Keys between D₁ and next vnode clockwise
    get reassigned to D
  - Only local redistribution needed
  - Minimal data movement
  | {
    shape: page
    style.fill: "#0d1117"
    style.stroke: "#58a6ff"
  }
}

# Node leave scenario
node_leave_scenario: {
  node_b_gone: Node B (Left) {
    style.fill: "#1a1a2e"
    style.stroke: "#f85149"
    style.stroke-dash: 3
    style.opacity: 0.5
    
    vnodes: {
      b_gone: {
        shape: circle
        label: "B₁, B₂, B₃"
        style.fill: "transparent"
        style.stroke: "#f85149"
        style.stroke-dash: 2
      }
    }
  }

  # Keys that move when B leaves
  redistributed_keys_leave: {
    key_reassigned: {
      shape: diamond
      label: "reassigned key"
      style.fill: "#16213e"
      style.stroke: "#f85149"
      style.font-color: "#f85149"
    }
  }

  key_reassigned -> hash_ring.node_c.vnodes.c1: "now hashes → C₁"
  key_reassigned -- node_b_gone.vnodes.b_gone: "was on B"
  
  note: |md
  ## Node Leave Impact
  - Keys from departed node B
    go to next node clockwise (C)
  - Replicas become primary copies
  - Replication factor maintained
  | {
    shape: page
    style.fill: "#0d1117"
    style.stroke: "#f85149"
  }
}

# Legend
legend: {
  shape: rectangle
  style.fill: "#0d1117"
  style.stroke: "#30363d"
  label: "Legend"
  
  vnode_example: VNode {
    shape: circle
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
  }
  
  key_example: Key {
    shape: diamond
    style.fill: "#16213e"
    style.stroke: "#ff7b72"
  }
  
  primary_assignment: "hash →" {
    style.font-color: "#3fb950"
  }
  
  replica_assignment: "replica N" {
    style.font-color: "#8b949e"
  }
  
  join_impact: "Join impact" {
    style.font-color: "#58a6ff"
  }
  
  leave_impact: "Leave impact" {
    style.font-color: "#f85149"
  }
}

# Layout relationships
hash_ring.ring_labels -> hash_ring: "positions"
hash_ring.node_a.vnodes -> hash_ring.node_a: "virtual nodes"
hash_ring.node_b.vnodes -> hash_ring.node_b: "virtual nodes"
hash_ring.node_c.vnodes -> hash_ring.node_c: "virtual nodes"