shape: sequence_diagram

title: Node Join and Rebalance Sequence
desc: Shows sequence of events when a new node joins: gossip propagation, hash ring update, data transfer between old and new nodes, and replica synchronization.

new_node: New Node {
  style.fill: "#0f3460"
  style.font-color: "#e6edf3"
}
existing_node_1: Existing Node 1 {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
}
existing_node_2: Existing Node 2 {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
}
existing_node_3: Existing Node 3 {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
}
hash_ring: Hash Ring {
  shape: circle
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}

note: Node Discovery and Initial Contact {
  shape: page
  style.fill: "#1a1a2e"
  style.font-color: "#8b949e"
}

new_node -> existing_node_1: 1. JOIN_REQUEST
existing_node_1 -> new_node: 2. MEMBERSHIP_LIST (current cluster state)

note: Gossip Propagation Phase {
  shape: page
  style.fill: "#1a1a2e"
  style.font-color: "#8b949e"
}

existing_node_1 -> existing_node_2: 3. GOSSIP (new node joined)
existing_node_2 -> existing_node_3: 4. GOSSIP (new node joined)
existing_node_3 -> existing_node_1: 5. GOSSIP_ACK

note: Hash Ring Update {
  shape: page
  style.fill: "#1a1a2e"
  style.font-color: "#8b949e"
}

existing_node_1 -> hash_ring: 6. ADD_NODE(new_node)
existing_node_2 -> hash_ring: 7. ADD_NODE(new_node)
existing_node_3 -> hash_ring: 8. ADD_NODE(new_node)
new_node -> hash_ring: 9. ADD_SELF

note: Data Transfer (Rebalancing) {
  shape: page
  style.fill: "#1a1a2e"
  style.font-color: "#8b949e"
}

hash_ring -> existing_node_1: 10. CALCULATE_SHARDS_TO_TRANSFER(new_node)
hash_ring -> existing_node_2: 11. CALCULATE_SHARDS_TO_TRANSFER(new_node)
existing_node_1 -> new_node: 12. TRANSFER_SHARD_DATA(range A-B)
existing_node_2 -> new_node: 13. TRANSFER_SHARD_DATA(range C-D)
new_node -> existing_node_1: 14. TRANSFER_ACK
new_node -> existing_node_2: 15. TRANSFER_ACK

note: Replica Synchronization {
  shape: page
  style.fill: "#1a1a2e"
  style.font-color: "#8b949e"
}

existing_node_1 -> new_node: 16. SYNC_REPLICA_DATA (for neighbor ranges)
new_node -> existing_node_1: 17. REPLICA_SYNC_COMPLETE
existing_node_1 -> existing_node_2: 18. GOSSIP (rebalance complete)
existing_node_1 -> existing_node_3: 19. GOSSIP (rebalance complete)

note: Final State {
  shape: page
  style.fill: "#1a1a2e"
  style.font-color: "#8b949e"
}

new_node -> hash_ring: 20. READY_TO_SERVE_REQUESTS
existing_node_1 -> new_node: 21. WELCOME_TO_CLUSTER