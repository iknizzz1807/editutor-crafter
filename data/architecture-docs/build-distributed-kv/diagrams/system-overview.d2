title: System Component Diagram

d2_theme: {
  theme_variables: {
    container-background-fill: "#16213e"
    container-stroke: "#3fb950"
    text-fill: "#e6edf3"
    style.stroke: "#8b949e"
  }
}

global_components: {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

hashing_ring: Hashing Ring {
  shape: circle
  style.multiple: true
  style.stroke-dash: 2
  style.stroke: "#f778ba"
  
  ring_mapping: Ring Mapping {
    shape: sql_table
    style.fill: "#0f3460"
  }
  
  virtual_nodes: Virtual Nodes {
    shape: diamond
    style.fill: "#0f3460"
  }
}

replication_manager: Replication Manager {
  shape: rectangle
  style.stroke: "#58a6ff"
  
  replica_coordinator: Replica Coordinator
  quorum_manager: Quorum Manager {
    style.fill: "#0f3460"
  }
  wal: Write-Ahead Log {
    shape: page
    style.fill: "#0f3460"
  }
  
  replica_coordinator -> quorum_manager: check quorum
  replica_coordinator -> wal: append writes
}

cluster_manager: Cluster Manager {
  shape: cloud
  style.stroke: "#ff7b72"
  
  membership: Membership Service
  failure_detector: Failure Detector {
    shape: oval
    style.fill: "#0f3460"
  }
  gossip: Gossip Protocol
  
  membership -> gossip: propagate updates
  failure_detector -> membership: report failures
}

transaction_manager: Transaction Manager {
  shape: hexagon
  style.stroke: "#f0883e"
  
  coordinator: Transaction Coordinator {
    style.fill: "#0f3460"
  }
  2pc: Two-Phase Commit
  lock_manager: Lock Manager
  
  coordinator -> 2pc: orchestrate phases
  coordinator -> lock_manager: acquire locks
}

storage_engine: Storage Engine {
  shape: cylinder
  style.stroke: "#3fb950"
  
  memtable: MemTable
  sstables: SSTables {
    shape: package
    style.fill: "#0f3460"
  }
  compaction: Compaction Engine
  
  memtable -> sstables: flush
  compaction -> sstables: compact
}

clients: {
  client1: Client 1
  client2: Client 2
  client3: Client 3
  style.fill: transparent
}

# Data flow relationships
client1 -> hashing_ring: key lookup (RPC)
client2 -> hashing_ring: key lookup (RPC)
client3 -> hashing_ring: key lookup (RPC)

hashing_ring -> replication_manager: replica set locations
replication_manager -> storage_engine: read/write operations
replication_manager -> cluster_manager: node health status

cluster_manager -> hashing_ring: ring rebalancing
cluster_manager -> replication_manager: replica reassignment

transaction_manager -> hashing_ring: find all involved shards
transaction_manager -> replication_manager: replicate transaction state
transaction_manager -> storage_engine: transactional reads/writes

storage_engine -> replication_manager: replication log entries

# Replication between nodes
replication_manager.replica_coordinator -> replication_manager.replica_coordinator: {
  style.stroke-dash: 3
  label: sync replicas
}

# Heartbeat and gossip
cluster_manager.gossip -> cluster_manager.gossip: {
  style.stroke-dash: 3
  label: propagate state
}