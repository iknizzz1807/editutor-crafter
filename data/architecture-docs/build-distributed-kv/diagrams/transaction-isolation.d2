shape: rectangle

# States represent different MVCC snapshot states
initial_snapshot: Initial Snapshot (Start TX) {
  style: {
    stroke: "#3fb950"
    fill: "#0f3460"
    font-color: "#e6edf3"
    bold: true
  }
}

# Read Committed Level
rc_snapshot: {
  state: Read Committed Snapshot {
    shape: oval
    style.fill: "#1a1a2e"
  }
  note: {
    text: |md
**Read Committed:**
- Takes new snapshot for EACH statement
- Sees latest committed data at statement start
- No repeatable reads
|
    style: {
      fill: "#16213e"
      stroke: "#8b949e"
    }
  }
}

# Repeatable Read Level
rr_snapshot: {
  state: Repeatable Read Snapshot {
    shape: oval
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.bold: true
  }
  note: {
    text: |md
**Repeatable Read:**
- Single snapshot at TX start
- Sees data as of TX begin time
- Repeatable reads guaranteed
- Prevents non-repeatable reads
|
    style: {
      fill: "#16213e"
      stroke: "#8b949e"
    }
  }
}

# Serializable Level
serializable_snapshot: {
  state: Serializable Snapshot {
    shape: oval
    style.fill: "#1a1a2e"
    style.stroke: "#ff7b72"
    style.bold: true
  }
  note: {
    text: |md
**Serializable:**
- Single snapshot at TX start
- Detects write-write conflicts
- Detects read-write conflicts
- Ensures serial execution
|
    style: {
      fill: "#16213e"
      stroke: "#8b949e"
    }
  }
}

# MVCC Storage
versions: MVCC Version Storage {
  shape: sql_table
  style: {
    fill: "#16213e"
    stroke: "#8b949e"
  }
  data: "| Key | Value | TX_ID | Created | Expired |\n|-----|-------|-------|---------|---------|\n| A | 100 | 101 | 10 | 20 |\n| A | 150 | 102 | 20 | 30 |\n| A | 200 | 103 | 30 | ∞ |\n| B | X | 101 | 15 | ∞ |"
}

# Conflicts
write_conflict: Write-Write Conflict {
  shape: diamond
  style: {
    fill: "#30162e"
    stroke: "#ff7b72"
  }
}

read_conflict: Read-Write Conflict {
  shape: diamond
  style: {
    fill: "#30162e"
    stroke: "#ffa657"
  }
}

# Final states
committed: Committed {
  shape: circle
  style: {
    double-border: true
    fill: "#0f3460"
    stroke: "#3fb950"
  }
}

aborted: Aborted (Rollback) {
  shape: circle
  style: {
    fill: "#30162e"
    stroke: "#ff7b72"
  }
}

# Transitions - Snapshot creation
initial_snapshot -> rc_snapshot.state: "SET TX ISOLATION READ COMMITTED" {
  style.stroke: "#8b949e"
}
initial_snapshot -> rr_snapshot.state: "SET TX ISOLATION REPEATABLE READ" {
  style.stroke: "#8b949e"
}
initial_snapshot -> serializable_snapshot.state: "SET TX ISOLATION SERIALIZABLE" {
  style.stroke: "#8b949e"
}

# RC behavior
rc_snapshot.state -> versions: "READ query (new snapshot)"
rc_snapshot.state -> write_conflict: "UPDATE (write lock)"
versions -> rc_snapshot.state: "Return data visible to snapshot"

# RR behavior
rr_snapshot.state -> versions: "READ (single snapshot)"
versions -> rr_snapshot.state: "Return data visible to snapshot"
rr_snapshot.state -> write_conflict: "UPDATE (check visibility)"

# Serializable behavior
serializable_snapshot.state -> versions: "READ (single snapshot + track reads)"
versions -> serializable_snapshot.state: "Return data visible to snapshot"
serializable_snapshot.state -> write_conflict: "UPDATE (full conflict detection)"

# Conflict resolution
write_conflict -> aborted: "Another TX committed write to same key"
write_conflict -> committed: "No conflicting writes" {
  style.stroke: "#3fb950"
}

# Serializable specific conflicts
serializable_snapshot.state -> read_conflict: "Track read sets"
read_conflict -> aborted: "Another TX modified read data" {
  style.stroke: "#ff7b72"
}
read_conflict -> committed: "Read set unchanged" {
  style.stroke: "#3fb950"
}

# Version chain visualization
version_chain: {
  shape: sequence_diagram
  v1: "Version 1 (TX101)"
  v2: "Version 2 (TX102)"
  v3: "Version 3 (TX103)"
  
  v1 -> v2: "update"
  v2 -> v3: "update"
  
  snapshot: "TX104 Snapshot"
  snapshot -> v2: "RC sees latest committed"
  snapshot -> v1: "RR sees based on start time"
  
  active_tx: "Active TX105"
  active_tx -> v3: "Uncommitted write"
}

# Styling connections
connections: {
  style: {
    stroke: "#8b949e"
    font-color: "#e6edf3"
  }
}