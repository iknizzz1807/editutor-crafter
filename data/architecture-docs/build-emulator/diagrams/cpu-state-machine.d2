# CPU Instruction Execution State Machine

# Initial state
init: {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  style.font-color: "#1a1a2e"
  width: 20
  height: 20
}

# Main states
fetch: FETCH\nRead instruction\nfrom memory {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

decode: DECODE\nParse instruction\nDetermine operation {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

execute: EXECUTE\nPerform operation\nUpdate registers {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

writeback: WRITE-BACK\nStore results\nUpdate memory {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

# Interrupt/Exception state
interrupt: INTERRUPT\nHandle exception\nor interrupt {
  shape: circle
  style.fill: "#16213e"
  style.stroke: "#d63031"
  style.font-color: "#e6edf3"
  style.bold: true
}

# State transitions
init -> fetch: CPU Reset\nPC = 0x0000 {
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

fetch -> decode: Instruction loaded\nIncrement PC {
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

decode -> execute: Opcode identified\nOperands resolved {
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

execute -> writeback: Operation complete\nResults ready {
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

writeback -> fetch: Memory updated\nNext instruction {
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

# Exception/interrupt transitions
fetch -> interrupt: IRQ/NMI triggered\nInvalid memory {
  style.stroke: "#d63031"
  style.font-color: "#e6edf3"
  style.stroke-dash: 5
}

decode -> interrupt: Invalid opcode\nIllegal instruction {
  style.stroke: "#d63031"
  style.font-color: "#e6edf3"
  style.stroke-dash: 5
}

execute -> interrupt: Division by zero\nMemory fault {
  style.stroke: "#d63031"
  style.font-color: "#e6edf3"
  style.stroke-dash: 5
}

interrupt -> fetch: Exception handled\nRestore state {
  style.stroke: "#d63031"
  style.font-color: "#e6edf3"
  style.stroke-dash: 5
}

# Branch/Jump special case
execute -> fetch: Branch/Jump taken\nPC modified {
  style.stroke: "#f39c12"
  style.font-color: "#e6edf3"
  style.stroke-dash: 3
}

# Halt state
halt: HALT\nCPU stopped {
  shape: circle
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#8b949e"
}

execute -> halt: HALT instruction\nSTOP opcode {
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

halt -> fetch: External interrupt\nReset signal {
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  style.stroke-dash: 5
}