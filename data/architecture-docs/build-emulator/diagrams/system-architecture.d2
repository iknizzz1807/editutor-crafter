vars: {
  d2-config: {
    theme-id: 300
  }
}

title: Emulator System Architecture

emulator: Emulator System {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.stroke-width: 2

  cpu: CPU Core {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    
    registers: Registers {
      shape: cylinder
      style.fill: "#0f3460"
    }
    alu: ALU {
      shape: hexagon
      style.fill: "#0f3460"
    }
    decoder: Instruction Decoder {
      style.fill: "#0f3460"
    }
  }

  memory: Memory Manager {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    
    ram: RAM {
      shape: cylinder
      style.fill: "#0f3460"
    }
    rom: ROM {
      shape: cylinder
      style.fill: "#0f3460"
    }
    mapper: Memory Mapper {
      style.fill: "#0f3460"
    }
  }

  ppu: PPU (Graphics) {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    
    vram: VRAM {
      shape: cylinder
      style.fill: "#0f3460"
    }
    renderer: Tile Renderer {
      style.fill: "#0f3460"
    }
    palette: Palette Memory {
      shape: cylinder
      style.fill: "#0f3460"
    }
  }

  input: Input Handler {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    
    controller: Controller State {
      shape: cylinder
      style.fill: "#0f3460"
    }
    polling: Input Polling {
      style.fill: "#0f3460"
    }
  }

  timer: Timing Controller {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
    
    scheduler: Cycle Scheduler {
      style.fill: "#0f3460"
    }
  }
}

display: Display Output {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

audio: Audio Output {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# CPU to Memory connections
emulator.cpu -> emulator.memory: read/write operations {
  style.stroke: "#8b949e"
}
emulator.memory -> emulator.cpu: data/instructions {
  style.stroke: "#8b949e"
}

# CPU to PPU connections
emulator.cpu -> emulator.ppu: register writes {
  style.stroke: "#8b949e"
}
emulator.ppu -> emulator.cpu: status reads {
  style.stroke: "#8b949e"
}

# PPU to Memory connections
emulator.ppu <-> emulator.memory: VRAM access {
  style.stroke: "#8b949e"
}

# Input to CPU connections
emulator.input -> emulator.cpu: controller data {
  style.stroke: "#8b949e"
}

# Timer coordination
emulator.timer -> emulator.cpu: cycle sync {
  style.stroke: "#ffd43b"
  style.stroke-width: 2
}
emulator.timer -> emulator.ppu: frame sync {
  style.stroke: "#ffd43b"
  style.stroke-width: 2
}
emulator.timer -> emulator.memory: timing control {
  style.stroke: "#ffd43b"
}

# Interrupt signals
emulator.ppu -> emulator.cpu: VBlank interrupt {
  style.stroke: "#fd79a8"
  style.stroke-dash: 5
}
emulator.input -> emulator.cpu: input interrupt {
  style.stroke: "#fd79a8"
  style.stroke-dash: 5
}

# Output connections
emulator.ppu -> display: video frames {
  style.stroke: "#00b894"
  style.stroke-width: 2
}
emulator.cpu -> audio: audio samples {
  style.stroke: "#00b894"
}