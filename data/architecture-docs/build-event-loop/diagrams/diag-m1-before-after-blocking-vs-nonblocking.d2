direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# -----------------------------------------------------------------------------
# BEFORE: THREAD-PER-CONNECTION MODEL
# -----------------------------------------------------------------------------
traditional_model: {
  label: "BEFORE: Thread-per-Connection (Traditional)"
  direction: down

  user_space: {
    label: "USER SPACE"
    style: {
      stroke-dash: 3
    }

    threads: {
      direction: right
      t1: {
        shape: sql_table
        label: "pthread_t #1 (worker.c)"
        row1: "0x00 | void*    | stack_ptr"
        row2: "0x08 | uint64_t | thread_id"
        row3: "0x10 | sigset_t | signal_mask"
        row4: "0x40 | char[8MB]| stack_mem"
        label_bottom: "Status: BLOCKING (read) | Total: 8MB+ stack"
      }
      t2: {
        shape: sql_table
        label: "pthread_t #2 (worker.c)"
        row1: "0x00 | void*    | stack_ptr"
        row2: "0x08 | uint64_t | thread_id"
        row3: "0x10 | sigset_t | signal_mask"
        row4: "0x40 | char[8MB]| stack_mem"
        label_bottom: "Status: BLOCKING (read) | Total: 8MB+ stack"
        style.multiple: true
      }
    }
  }

  kernel_space: {
    label: "KERNEL SPACE (Linux)"
    
    scheduler: {
      shape: circle
      label: "CFS Scheduler"
    }

    wait_queues: {
      shape: cylinder
      label: "Socket Wait Queues"
    }

    scheduler -> user_space.threads: "Context Switch | ~2-5Î¼s | TLB Flush / Register Restore"
    user_space.threads -> wait_queues: "read(fd) | SYSCALL | Thread context into WaitQueue"
  }

  metrics: {
    shape: rectangle
    label: |md
      ### Resource Analysis (C10K)
      - **Memory**: 10,000 * 8MB = **80GB Virtual RAM**
      - **CPU**: High overhead (context switching, TLB misses)
      - **Complexity**: $O(N)$ scheduling overhead for kernel
    |
    style.fill: "#ffdddd"
    style.border-radius: 5
  }
}

# -----------------------------------------------------------------------------
# AFTER: EPOLL EVENT LOOP MODEL
# -----------------------------------------------------------------------------
reactor_model: {
  label: "AFTER: epoll Reactor (Event-Driven)"
  direction: down

  user_space: {
    label: "USER SPACE"
    style: {
      stroke-dash: 3
    }

    event_loop: {
      shape: class
      label: "Single Thread (event_loop.c)"
      
      logic: |md
        c
        while (running) {
            // Block until event or timeout
            n = epoll_wait(epoll_fd, events, 1024, -1);
            for (i=0; i<n; i++) {
                // Non-blocking dispatch
                dispatch(events[i].data.fd);
            }
        }
        
      |
    }

    state_array: {
      shape: sql_table
      label: "struct conn_state connections[65536]"
      row1: "0x00 | int      | fd"
      row2: "0x04 | uint32_t | events"
      row3: "0x08 | char[4KB]| read_buf"
      label_bottom: "Total: ~4.1KB per conn (Heap Resident)"
    }
    
    event_loop -> state_array: "Index by FD | O(1) State Retrieval"
  }

  kernel_space: {
    label: "KERNEL SPACE (Linux)"

    epoll_instance: {
      shape: sql_table
      label: "struct eventpoll (Kernel Object)"
      row1: "rbr | struct rb_root | interest_list (RB-Tree)"
      row2: "rdllist | struct list_head | ready_list (Linked List)"
    }

    nic_driver: {
      shape: rectangle
      label: "NIC Driver / SoftIRQ"
    }

    nic_driver -> epoll_instance: "Packet Received | SoftIRQ -> epoll_callback | O(1) Notify"
    user_space.event_loop -> epoll_instance: "epoll_wait() | SYSCALL | Drain Ready List"
  }

  metrics: {
    shape: rectangle
    label: |md
      ### Resource Analysis (C10K)
      - **Memory**: 10,000 * 4.1KB = **~41MB Resident RAM**
      - **CPU**: Efficient (No context switches between conns)
      - **Complexity**: $O(1)$ relative to total connection count
    |
    style.fill: "#ddffdd"
    style.border-radius: 5
  }
}

# -----------------------------------------------------------------------------
# FLOW BETWEEN MODELS
# -----------------------------------------------------------------------------
traditional_model -> reactor_model: "Optimization: I/O Multiplexing (Event Loop)" {
  style: {
    stroke-width: 4
    animated: true
    stroke: "#2b6cb0"
  }
}