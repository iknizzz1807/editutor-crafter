direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# GLOBAL RUNTIME CONTEXT
runtime_memory: {
  direction: down
  label: "Global Memory Space (reactor.c)"

  fd_table: {
    grid-columns: 1
    label: "struct connection_t connections[MAX_FDS]"

    slot_0: "Index 0: NULL"
    slot_1: "Index 1: STDOUT"
    slot_2: "Index 2: STDERR"
    slot_3: "Index 3: Listen Socket"
    slot_active: "Index [fd]: connection_t target" {
      style: {
        fill: "#C7F1FF"
        stroke-width: 3
      }
    }
    slot_n: "Index 65535"
    
    label_bottom: "O(1) Lookup | Sparse Array"
  }

  stats: {
    label: "Density Analysis"
    style: {
      stroke-dash: 3
    }
    content: |md
      - **Struct Size**: 48 Bytes
      - **C10K Footprint**: 480,000 Bytes (~468 KiB)
      - **Cache Target**: Fits in L2 Cache (512KB boundary)
      - **Alignment**: 8-byte boundary enforced
    |
  }
}

# MICROSCOPIC VIEW: MEMORY ALIGNMENT
connection_struct: {
  shape: sql_table
  label: "struct connection_t (reactor.h)"
  
  row_0: "0x00 | int32_t   | fd"
  row_1: "0x04 | uint32_t  | state (enum)"
  row_2: "0x08 | void*     | read_buf_ptr"
  row_3: "0x10 | uint32_t  | read_buf_len"
  row_4: "0x14 | uint32_t  | read_buf_cap"
  row_5: "0x18 | void*     | write_buf_ptr"
  row_6: "0x20 | uint32_t  | write_buf_len"
  row_7: "0x24 | uint32_t  | write_buf_cap"
  row_8: "0x28 | int32_t   | timer_id"
  row_9: "0x2C | uint32_t  | padding / reserved"
  
  label_bottom: "Total: 48 Bytes (Fixed Size)"
}

# LOGICAL MAPPING
runtime_memory.fd_table.slot_active -> connection_struct: "Pointer Access | 8-byte alignment" {
  style: {
    stroke-width: 2
    animated: true
  }
}

# CODE IMPLEMENTATION REFERENCE
# Fixed: changed relative 'near' to constant 'bottom-right' for ELK compatibility
implementation: {
  near: bottom-right
  label: "connection.c"
  code: |md
    c
    typedef struct {
        int fd;
        conn_state_t state;
        char *read_buf;
        uint32_t read_len;
        uint32_t read_cap;
        char *write_buf;
        uint32_t write_len;
        uint32_t write_cap;
        int timer_id;
        uint32_t _pad;
    } connection_t;

    // Direct O(1) access pattern
    connection_t *conn = &connections[fd];
    
  |
}

# Supplemental visual hint for the implementation
connection_struct -> implementation: "Source Definition" {
  style: {
    stroke-dash: 5
    opacity: 0.5
  }
}