direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# LEGEND & METADATA
legend: {
  shape: package
  label: "Protocol: TCP | Buffer: 1KB | Input: 3KB"
  near: top-left
  
  color_codes: {
    shape: sql_table
    lt: "Level-Triggered" {style.fill: "#D0E7FF"}
    et_fail: "Edge-Triggered (Broken)" {style.fill: "#FFD0D0"}
    et_ok: "Edge-Triggered (Correct)" {style.fill: "#D0FFD0"}
    kernel: "Kernel Space (rdllist)" {style.stroke: "#707070"; style.stroke-dash: 3}
  }
}

# -----------------------------------------------------------------------------
# COLUMN 1: LEVEL-TRIGGERED (LT)
# -----------------------------------------------------------------------------
lt_path: {
  label: "LEVEL-TRIGGERED (LT)\nBehavior: Continuous Notification"
  direction: down

  t0: "T=0: Data Arrives" {
    shape: class
    status: "Kernel Buffer: 3072 bytes"
    rdllist: "rdllist: [fd_42]"
  }

  t1: "T=1: epoll_wait()" {
    shape: code
    label: "|md\nc\n// Returns fd_42\nn = epoll_wait(ep_fd, ev, 1, -1);\n\n|"
  }

  t2: "T=2: user read()" {
    shape: class
    action: "read(fd, buf, 1024)"
    result: "Received: 1024 bytes"
    kernel: "Remaining: 2048 bytes"
  }

  t3: "T=3: LT Re-arm" {
    shape: circle
    label: "Kernel checks buf > 0\nRe-adds fd_42 to rdllist"
    style.fill: "#D0E7FF"
  }

  t4: "T=4: epoll_wait()" {
    shape: code
    label: "|md\nc\n// Returns fd_42 immediately\nn = epoll_wait(ep_fd, ev, 1, -1);\n\n|"
  }

  t5: "T=5: user read()" {
    shape: class
    action: "read(fd, buf, 1024)"
    kernel: "Remaining: 1024 bytes"
  }

  t6: "T=6: LT Re-arm" {
    shape: circle
    label: "Kernel re-adds fd_42"
  }

  t7: "T=7: Final Wait/Read" {
    shape: class
    step: "epoll_wait() -> fd_42"
    action: "read(fd, buf, 1024)"
    kernel: "Remaining: 0 bytes"
  }

  t0 -> t1 -> t2 -> t3 -> t4 -> t5 -> t6 -> t7
}

# -----------------------------------------------------------------------------
# COLUMN 2: EDGE-TRIGGERED (BROKEN)
# -----------------------------------------------------------------------------
et_broken: {
  label: "EDGE-TRIGGERED (BROKEN)\nBehavior: Single Notification (Data Loss)"
  direction: down
  style.fill: "#FFF0F0"

  t0: "T=0: Data Arrives" {
    shape: class
    status: "Kernel Buffer: 3072 bytes"
    rdllist: "rdllist: [fd_42]"
  }

  t1: "T=1: epoll_wait()" {
    shape: code
    label: "|md\nc\n// Returns fd_42\nn = epoll_wait(ep_fd, ev, 1, -1);\n\n|"
  }

  t2: "T=2: Naive read()" {
    shape: class
    action: "read(fd, buf, 1024)"
    result: "Received: 1024 bytes"
    kernel: "Remaining: 2048 bytes"
    style.stroke: red
  }

  t3: "T=3: ET Logic" {
    shape: circle
    label: "No 0->N transition\nrdllist: [] (EMPTY)"
    style.fill: "#FFD0D0"
  }

  t4: "T=4: epoll_wait()" {
    shape: code
    label: "|md\nc\n// BLOCKS INDEFINITELY\nn = epoll_wait(ep_fd, ev, 1, -1);\n\n|"
    style.stroke: red
  }

  stuck: "DEADLOCK" {
    shape: diamond
    label: "2048 bytes stuck in kernel\nClient waits for response\nServer waits for new edge"
    style.fill: red
    style.font-color: white
  }

  t0 -> t1 -> t2 -> t3 -> t4 -> stuck
}

# -----------------------------------------------------------------------------
# COLUMN 3: EDGE-TRIGGERED (CORRECT)
# -----------------------------------------------------------------------------
et_correct: {
  label: "EDGE-TRIGGERED (CORRECT)\nBehavior: Drain Until EAGAIN"
  direction: down
  style.fill: "#F0FFF0"

  t0: "T=0: Data Arrives" {
    shape: class
    status: "Kernel Buffer: 3072 bytes"
    rdllist: "rdllist: [fd_42]"
  }

  t1: "T=1: epoll_wait()" {
    shape: code
    label: "Returns fd_42"
  }

  t2: "T=2: Drain Loop" {
    shape: code
    label: "|md\nc\nwhile(1) {\n  n = read(fd, b, 1024);\n  if (n < 0) break; \n}\n\n|"
    style.stroke: green
  }

  t2_iterations: {
    direction: right
    iter1: "Read 1024 (2048 left)"
    iter2: "Read 1024 (1024 left)"
    iter3: "Read 1024 (0 left)"
    iter4: "read() -> EAGAIN" {style.stroke: green}
    
    iter1 -> iter2 -> iter3 -> iter4
  }

  t3: "T=3: Clean Return" {
    shape: circle
    label: "Loop exits on EAGAIN\nAll data consumed"
    style.fill: "#D0FFD0"
  }

  t4: "T=4: epoll_wait()" {
    shape: code
    label: "Blocks safely\nKernel Ready List empty"
  }

  t0 -> t1 -> t2 -> t2_iterations -> t3 -> t4
}

# -----------------------------------------------------------------------------
# CROSS-COLUMN COMPARISON ANNOTATIONS
# -----------------------------------------------------------------------------
lt_path.t3 -> et_broken.t3: "DIFFERENCE: LT Re-arms if buffer > 0" {
  style.stroke: grey
  style.stroke-dash: 5
}

et_broken.stuck -> et_correct.t2: "FIX: Loop until EAGAIN" {
  style.stroke: green
  style.stroke-width: 2
}

# FILE REFERENCES
footer: {
  shape: text
  label: "Implementation Ref: epoll_basics.c | Kernel: fs/eventpoll.c"
  near: bottom-right
}