direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# L0 - CALCULATION LAYER
calculation_layer: {
  label: "TIMER CALCULATION LAYER (timer.c)"
  direction: down

  timer_heap: {
    shape: sql_table
    label: "struct timer_entry (timer.h)"
    
    row1: "0x00 | uint64_t | expiry_ms"
    row2: "0x08 | int      | fd"
    label_bottom: "Min-Heap Node: 12 bytes + padding"
  }

  logic_peek: {
    shape: code
    label: "timer_next_ms() Logic"
    language: c
    content: |md
      c
      if (heap_size == 0) return -1;
      uint64_t now = now_ms();
      uint64_t expiry = heap[0].expiry_ms;
      if (expiry <= now) return 0;
      return (int)(expiry - now);
      
    |
  }

  timer_heap -> logic_peek: "heap[0] | 8 bytes | expiry_ms"
}

# L0 - KERNEL INTERFACE
kernel_layer: {
  label: "KERNEL INTERFACE"
  direction: down

  epoll_syscall: {
    shape: code
    label: "epoll_wait(2)"
    language: c
    content: |md
      c
      int n = epoll_wait(
        epoll_fd, 
        events, 
        MAX_EVENTS, 
        timeout_ms  // <-- Calculated Value
      );
      
    |
  }
}

# L0 - DISPATCH LAYER
dispatch_layer: {
  label: "EVENT DISPATCH LAYER (reactor.c)"
  direction: down

  timer_processor: {
    shape: class
    label: "timer_process_expired(reactor* r)"
    
    definition: |md
      c
      uint64_t now = now_ms();
      while (heap_size > 0 && heap[0].exp <= now) {
          int fd = heap[0].fd;
          conn_close(r->epoll_fd, fd);
          // heap_sift_down() triggered
      }
      
    |
  }

  io_dispatch: {
    shape: class
    label: "I/O Event Dispatch"
    
    definition: |md
      c
      for (int i = 0; i < n; i++) {
          fd_handler *h = events[i].ptr;
          h->callback(fd, ev, h->user_data);
      }
      
    |
  }

  timer_processor -> io_dispatch: "Sequential Execution"
}

# COORDINATION FLOWS
calculation_layer.logic_peek -> kernel_layer.epoll_syscall: "int | 4 bytes | timeout_ms"
kernel_layer.epoll_syscall -> dispatch_layer: "int | 4 bytes | n_ready"

# STYLING
calculation_layer.style.fill: "#f0f7ff"
kernel_layer.style.fill: "#fff0f0"
dispatch_layer.style.fill: "#f0fff0"

(calculation_layer.logic_peek -> kernel_layer.epoll_syscall).style: {
  stroke: blue
  animated: true
}

(kernel_layer.epoll_syscall -> dispatch_layer).style: {
  stroke: purple
  stroke-width: 2
}