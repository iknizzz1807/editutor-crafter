direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- STYLES & CLASSES ---
classes: {
  api_box: {
    style: {
      fill: "#E4DBFE"
      stroke: "#6772E5"
      stroke-width: 2
      border-radius: 8
    }
  }
  internal_struct: {
    shape: sql_table
    style: {
      fill: "#F6F9FC"
      stroke: "#44C7B1"
    }
  }
  kernel_layer: {
    style: {
      fill: "#DEE1EB"
      stroke: "#306a4a"
      stroke-dash: 5
    }
  }
}

# --- PUBLIC INTERFACE ---
public_interface: {
  label: "Public API (reactor.h)"
  class: api_box
  
  methods: |md
    c
    reactor* reactor_create(void);
    int  reactor_register(reactor* r, int fd, uint32_t events, 
                          io_callback_fn cb, void* user_data);
    void reactor_deregister(reactor* r, int fd);
    int  reactor_set_timeout(reactor* r, uint32_t ms, 
                             timer_callback_fn cb, void* user_data);
    void reactor_defer(reactor* r, task_fn fn, void* user_data);
    void reactor_run(reactor* r);
    void reactor_stop(reactor* r);
    
  |
}

# --- CORE REACTOR ENGINE ---
reactor_engine: {
  label: "Reactor Engine (reactor.c)"
  direction: down

  # --- MAIN STATE OBJECT ---
  reactor_struct: {
    shape: sql_table
    label: "struct reactor (opaque)"
    
    row1: "0x00 | int      | epoll_fd"
    row2: "0x04 | bool     | running"
    row3: "0x05 | bool     | dispatching"
    row4: "0x08 | handler* | handlers (size: MAX_FDS * 24)"
    row5: "0x10 | timer*   | timer_heap (min-priority queue)"
    row6: "0x18 | mod*     | mods (deferred epoll_ctl list)"
    row7: "0x20 | task*    | defer_queue (FIFO task list)"
    label_bottom: "Total Table Size: ~1.5MB for 65k FDs"
  }

  # --- COMPONENT DATA STRUCTURES ---
  data_structures: {
    direction: right
    
    fd_handler: {
      class: internal_struct
      label: "struct fd_handler (24 bytes)"
      
      f1: "0x00 | io_callback_fn | callback"
      f2: "0x08 | void*          | user_data"
      f3: "0x10 | uint32_t       | events_mask"
      f4: "0x14 | bool           | registered"
      f5: "0x15 | bool           | zombie_flag"
    }

    timer_record: {
      class: internal_struct
      label: "struct timer_record (32 bytes)"
      
      t1: "0x00 | uint64_t       | expiry_ms"
      t2: "0x08 | uint32_t       | interval_ms"
      t3: "0x0C | int            | timer_id"
      t4: "0x10 | timer_cb       | callback"
      t5: "0x18 | void*          | user_data"
    }
  }
}

# --- KERNEL SUBSYSTEM ---
kernel_space: {
  label: "Linux Kernel"
  class: kernel_layer
  
  epoll_instance: {
    shape: cylinder
    label: "Epoll Instance\n(Interest List + Ready List)"
  }
}

# --- DATA FLOW & CONTROL PATHS ---

# Application registering interest
public_interface.methods -> reactor_engine.reactor_struct: "1. Register Handler"
reactor_engine.reactor_struct -> reactor_engine.data_structures.fd_handler: "2. Update Table"

# Reactor core interaction with kernel
reactor_engine.reactor_struct -> kernel_space.epoll_instance: "epoll_ctl(ADD/MOD/DEL)\nO(1) Interest List Sync"

# The Event Loop Wakeup
kernel_space.epoll_instance -> reactor_engine.reactor_struct: "epoll_wait()\nReady List Transfer\n(O(N) where N=ready)"

# Dispatch Path
reactor_engine.reactor_struct -> public_interface.methods: "4. Dispatch Callbacks\nh->callback(fd, events, ctx)"

# Deferred Logic
public_interface.methods -> reactor_engine.reactor_struct: "5. Defer Task / Deregister\n(Appends to mods/defer_queue)"

# Annotations
public_interface: {
  tooltip: "Pure interface hiding implementation details"
}

reactor_engine.data_structures.fd_handler.f5: {
  tooltip: "Crucial for preventing use-after-free during dispatch iterations"
}

reactor_engine.reactor_struct.row5: {
  tooltip: "Min-Heap root used to calculate next epoll_wait(timeout)"
}

# Layout constraints for the 2D Grid
reactor_engine.reactor_struct -> reactor_engine.data_structures: "defines memory layout" {
  style.stroke-dash: 3
}