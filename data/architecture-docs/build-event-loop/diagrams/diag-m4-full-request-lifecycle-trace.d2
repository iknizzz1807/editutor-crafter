direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- SATELLITE VIEW / LAYERS ---

ingress: {
  label: "INGRESS & CONNECTION (M1/M3)"
  direction: down

  listener: {
    shape: class
    label: "Socket Listener (server.c)"
    definition: |`c
int listen_fd = socket(AF_INET, SOCK_STREAM | SOCK_NONBLOCK, 0);
bind(listen_fd, &addr, sizeof(addr));
listen(listen_fd, 128);
    `|
  }

  acceptor: {
    shape: sql_table
    label: "http_accept_cb (M4)"
    row1: "1. accept4() -> client_fd"
    row2: "2. malloc(sizeof(http_conn))"
    row3: "3. reactor_register(r, client_fd, READABLE, ...)"
    row4: "4. reactor_set_timeout(r, 30s, ...)"
  }

  listener -> acceptor: "TCP SYN/ACK | New Connection"
}

logic: {
  label: "PROTOCOL & STATE MACHINE (M4)"
  direction: down

  state_struct: {
    shape: sql_table
    label: "struct http_conn (http.h)"
    row1: "0x0000 | char[16384]      | read_buf"
    row2: "0x4000 | struct write_buf  | wbuf"
    row3: "0x4018 | struct http_req   | req"
    row4: "0x4438 | uint32_t          | read_len"
    row5: "0x443C | int               | fd"
    row6: "0x4440 | conn_http_state   | state"
    label_bottom: "Total: ~17.5 KB (M4)"
  }

  parser: {
    shape: class
    label: "Incremental Parser (parser.c)"
    methods: |md
      c
      parse_result http_parse_headers(char* buf, uint32_t len, ...);
      // Returns: COMPLETE, INCOMPLETE, or ERROR
      
    |
  }

  state_machine: {
    shape: class
    label: "conn_http_state Transitions"
    states: "READING_HEADERS -> PROCESSING -> WRITING -> READING_HEADERS (Keep-Alive)"
  }
}

egress: {
  label: "BUFFERING & BACKPRESSURE (M2/M3)"
  direction: down

  write_logic: {
    shape: sql_table
    label: "conn_write_buffered (M2)"
    row1: "1. write(fd, buf, len) -> returns -1/EAGAIN"
    row2: "2. wbuf_append(&c->wbuf, data, remaining)"
    row3: "3. reactor_register(r, fd, READABLE | WRITABLE, ...)"
  }

  wbuf_struct: {
    shape: sql_table
    label: "struct write_buf (M2)"
    row1: "0x00 | char*    | data"
    row2: "0x08 | uint32_t | len"
    row3: "0x0C | uint32_t | cap"
    row4: "0x10 | uint32_t | offset"
    label_bottom: "24 bytes + heap allocation"
  }

  flusher: {
    shape: class
    label: "EPOLLOUT Handler (M2)"
    logic: "When socket ready -> write() from wbuf -> if empty: epoll_ctl(MOD, READ_ONLY)"
  }
}

cleanup: {
  label: "TIMERS & DEFERRED CLEANUP (M2/M3)"
  direction: down

  timer_system: {
    shape: sql_table
    label: "Min-Heap Timer (M2)"
    row1: "timer_heap[0] = Soonest Expiry"
    row2: "epoll_wait(..., timeout = timer_next_ms())"
  }

  deferred_queue: {
    shape: class
    label: "Reactor Task Queue (M3)"
    logic: |md
      c
      // Safe cleanup during loop iteration
      reactor_defer(r, http_conn_close_deferred, conn);
      
    |
  }
}

# --- CROSS-LAYER DATA FLOW (THE LIFECYCLE) ---

ingress.acceptor -> logic.state_struct: "1. Init Context | 17.5 KB"
logic.state_struct -> logic.parser: "2. Incremental Read | read(fd, read_buf, ...)"
logic.parser -> logic.state_machine: "3. Header Complete | Transition: PROCESSING"
logic.state_machine -> egress.write_logic: "4. Response Gen | conn_write_buffered()"
egress.write_logic -> egress.wbuf_struct: "5. EAGAIN | Buffer Unsent Bytes"
cleanup.timer_system -> cleanup.deferred_queue: "6. Idle (30s) | timer_process_expired()"
cleanup.deferred_queue -> ingress.acceptor: "7. Deferred Close | reactor_deregister(fd)"

# --- ANNOTATIONS ---

ingress: { style: { fill: "#e1f5fe"; stroke: "#01579b" } }
logic: { style: { fill: "#f3e5f5"; stroke: "#4a148c" } }
egress: { style: { fill: "#fff3e0"; stroke: "#e65100" } }
cleanup: { style: { fill: "#f1f8e9"; stroke: "#1b5e20" } }

(logic.state_struct -> logic.parser)[0].label: "DataType: char[] | Size: READ_BUF_SIZE (16KB)"
(egress.write_logic -> egress.wbuf_struct)[0].label: "DataType: Byte stream | Buffer Cap: 256KB Max (M2)"
(cleanup.timer_system -> cleanup.deferred_queue)[0].label: "Event: Timeout | Callback: task_fn"

# --- SYSTEM FOOTPRINT ---
footer: {
  shape: text
  near: bottom-right
  label: "Standard: C10K Ready | Memory: ~170MB/10k Conns | IO: Edge-Triggered epoll (M1)"
}