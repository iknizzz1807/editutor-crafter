# Event Loop State Machine
direction: right

classes: {
  state_style: {
    style.stroke: "#3fb950"
    style.fill: "#1a1a2e"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  final_state: {
    style.stroke-width: 2
    style.double-border: true
  }
  initial_state: {
    shape: circle
    style.fill: "#3fb950"
    label: ""
  }
  timeout_style: {
    style.stroke: "#ff7b72"
    style.font-color: "#ff7b72"
    style.stroke-dash: 3
  }
  io_event_style: {
    style.stroke: "#79c0ff"
    style.font-color: "#79c0ff"
  }
  error_style: {
    style.stroke: "#ff7b72"
    style.font-color: "#ff7b72"
    style.bold: true
  }
}

# Initial state marker
init: {
  class: initial_state
}

# TCP Connection States
listening: "Listening\n(Server Socket)" {
  class: state_style
  shape: rectangle
}

accepted: Accepted {
  class: state_style
  shape: rectangle
}

reading: Reading {
  class: state_style
  shape: rectangle
}

writing: Writing {
  class: state_style
  shape: rectangle
}

closing: Closing {
  class: state_style
  class: final_state
  shape: rectangle
}

# Transitions from initial state
init -> listening

# Normal flow transitions
listening -> accepted: "accept()\nreturns new socket" {
  class: io_event_style
}

accepted -> reading: "EPOLLIN\nread event" {
  class: io_event_style
}

reading -> writing: "Data received\nprocess request" {
  class: io_event_style
}

writing -> closing: "Write complete\nclose connection" {
  class: io_event_style
}

# Timeout transitions
accepted -> closing: "Accept timeout\n(no EPOLLIN)" {
  class: timeout_style
}

reading -> closing: "Read timeout\n(no data)" {
  class: timeout_style
}

writing -> closing: "Write timeout\n(can't send)" {
  class: timeout_style
}

# Error transitions
listening -> closing: "accept() error" {
  class: error_style
}

accepted -> closing: "Socket error" {
  class: error_style
}

reading -> closing: "read() error\nor peer closed" {
  class: error_style
}

writing -> closing: "write() error" {
  class: error_style
}

# Non-blocking I/O transitions
reading -> reading: "EPOLLIN\nmore data" {
  class: io_event_style
}

writing -> writing: "EPOLLOUT\nmore to send" {
  class: io_event_style
}

writing -> reading: "Response sent\nwait for next request" {
  class: io_event_style
  label: "Keep-alive connection"
}