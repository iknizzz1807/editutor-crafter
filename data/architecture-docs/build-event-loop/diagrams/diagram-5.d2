title: HTTP Request Handling Flowchart

direction: right

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    shape: diamond
    style.fill: "#16213e"
    style.stroke: "#ff7b72"
    style.font-color: "#e6edf3"
  }
  start_end: {
    shape: circle
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#1a1a2e"
    label: ""
  }
}

start: "Start of HTTP Request" {
  class: start_end
  near: top-left
}

socket_readable: "Socket Becomes Readable (EPOLLIN)" {
  class: process
}

read_available: "Read Available Data (non-blocking)" {
  class: process
}

feed_parser: "Feed Data to HTTP Parser" {
  class: process
}

check_header: "Header Complete?" {
  class: decision
}

generate_response: "Generate Response" {
  class: process
}

check_write: "Write Buffer Full?" {
  class: decision
}

register_out: "Register for EPOLLOUT" {
  class: process
}

write_response: "Write Response to Socket" {
  class: process
}

response_sent: "Response Sent" {
  class: process
  style.fill: "#0f3460"
}

end: "Request Complete" {
  class: start_end
  near: bottom-right
}

start -> socket_readable: "Event Loop"
socket_readable -> read_available: "Handle read event"
read_available -> feed_parser: "Data received"
feed_parser -> check_header: "Parse incrementally"

check_header -> read_available: "No (need more data)" {
  style.stroke-dash: 2
  label: Wait for next EPOLLIN
}

check_header -> generate_response: "Yes" {
  style.stroke: "#3fb950"
}

generate_response -> write_response: "Write immediately"
write_response -> check_write: "Non-blocking write"

check_write -> response_sent: "No (all data written)"
check_write -> register_out: "Yes (EAGAIN)"

register_out -> socket_readable: "Continue event loop" {
  style.stroke-dash: 3
  label: Will be notified via EPOLLOUT
}

response_sent -> end: "Complete handling"

// Connections from socket_writable event
socket_writable: "Socket Becomes Writable (EPOLLOUT)" {
  class: process
  style.fill: "#0f3460"
  near: bottom-left
}

socket_writable -> write_response: "Handle write event" {
  style.stroke: "#ff7b72"
}