direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# -----------------------------------------------------------------------------
# 1. HEAP TREE & ARRAY MAPPING
# -----------------------------------------------------------------------------
Heap_Structure: {
  label: "MIN-HEAP DATA STRUCTURE & ARRAY MAPPING"
  style.fill: "#F3E5F5" # Header Color: Purple tint
  
  Logical_Tree: {
    shape: rectangle
    style.stroke-dash: 3
    
    Node0: "(1000ms, fd:10)" {shape: circle; tooltip: "Root (Min)"; style.fill: "#D1E8FF"}
    Node1: "(2000ms, fd:11)" {shape: circle; style.fill: "#D1E8FF"}
    Node2: "(3000ms, fd:12)" {shape: circle; style.fill: "#D1E8FF"}
    Node3: "(4000ms, fd:13)" {shape: circle; style.fill: "#D1E8FF"}
    Node4: "(5000ms, fd:14)" {shape: circle; style.fill: "#D1E8FF"}
    Node5: "(6000ms, fd:15)" {shape: circle; style.fill: "#D1E8FF"}
    Node6: "(7000ms, fd:16)" {shape: circle; style.fill: "#D1E8FF"}

    Node0 -> Node1: "Left"
    Node0 -> Node2: "Right"
    Node1 -> Node3
    Node1 -> Node4
    Node2 -> Node5
    Node2 -> Node6
  }

  Memory_Layout: {
    grid-rows: 1
    grid-gap: 0
    
    Index0: "0\n(1000, 10)" {style.fill: "#D1E8FF"}
    Index1: "1\n(2000, 11)" {style.fill: "#D1E8FF"}
    Index2: "2\n(3000, 12)" {style.fill: "#D1E8FF"}
    Index3: "3\n(4000, 13)" {style.fill: "#D1E8FF"}
    Index4: "4\n(5000, 14)" {style.fill: "#D1E8FF"}
    Index5: "5\n(6000, 15)" {style.fill: "#D1E8FF"}
    Index6: "6\n(7000, 16)" {style.fill: "#D1E8FF"}
  }

  Formula: |md
    ### Binary Heap Arithmetic
    - **Parent(i)**: `(i - 1) / 2`
    - **Left(i)**: `2i + 1`
    - **Right(i)**: `2i + 2`
  |

  Logical_Tree.Node0 -> Memory_Layout.Index0: "Maps to" {
    style: {
      stroke-dash: 5
      stroke: orange # Pointer Color
    }
  }
}

# -----------------------------------------------------------------------------
# 2. SIFT UP OPERATION (INSERT)
# -----------------------------------------------------------------------------
Sift_Up_Insert: {
  label: "ALGORITHM: SIFT_UP (INSERT 800ms, fd:17)"

  Step1: {
    label: "Step 1: Append to End"
    Tree: {
      N0: "(1000, 10)"
      N1: "(2000, 11)"
      N3: "(4000, 13)"
      New: "**(800, 17)**" {style.stroke: red; style.font-color: red}
      
      N0 -> N1
      N1 -> N3
      N3 -> New: "Index 7"
    }
    Annotation: "800 < 4000? True. SWAP."
  }

  Step2: {
    label: "Step 2: Bubble Up"
    Tree: {
      N0: "(1000, 10)"
      New: "**(800, 17)**" {style.stroke: red; style.font-color: red}
      N1: "(2000, 11)"
      N3: "(4000, 13)"
      
      N0 -> New
      New -> N1
      N1 -> N3
    }
    Annotation: "800 < 1000? True. SWAP to ROOT."
  }

  Step1 -> Step2: "Sift Up"
}

# -----------------------------------------------------------------------------
# 3. SIFT DOWN OPERATION (EXTRACT-MIN)
# -----------------------------------------------------------------------------
Sift_Down_Extract: {
  label: "ALGORITHM: SIFT_DOWN (EXTRACT MIN)"

  Before: {
    label: "Step 1: Replace Root with Last"
    Tree: {
      Root: "**(7000, 16)**" {style.stroke: red; style.font-color: red}
      L: "(2000, 11)"
      R: "(3000, 12)"
      
      Root -> L
      Root -> R
    }
    Annotation: "Root removed. Index 6 moved to Index 0."
  }

  After: {
    label: "Step 2: Sift Down (Min-Child Swap)"
    Tree: {
      Root: "(2000, 11)"
      L: "**(7000, 16)**" {style.stroke: red; style.font-color: red}
      R: "(3000, 12)"
      Child: "(4000, 13)"
      
      Root -> L
      Root -> R
      L -> Child
    }
    Annotation: "7000 > min(2000, 3000). Swap with 2000."
  }

  Before -> After: "Compare children"
}

# -----------------------------------------------------------------------------
# ANNOTATIONS
# -----------------------------------------------------------------------------
Metadata: |md
  ## Implementation Constraints
  1. **timer_idx Preservation**: `connections[fd].timer_idx` must be updated on every `heap_swap`.
  2. **Monotonic Clock**: `expiry_ms` is derived from `CLOCK_MONOTONIC` to prevent NTP drift.
  3. **Complexity**: 
     - Insert: **O(log N)**
     - Delete-Min: **O(log N)**
     - Peek-Min: **O(1)**
| {near: bottom-center}