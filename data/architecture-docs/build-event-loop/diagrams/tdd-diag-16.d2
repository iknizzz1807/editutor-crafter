direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

classes: {
  app_layer: {
    style: {
      fill: "#B6DDF6"
      stroke: "#2B5797"
      stroke-width: 2
    }
  }
  kernel_layer: {
    style: {
      fill: "#E1D5E7"
      stroke: "#9673A6"
      stroke-width: 2
    }
  }
  hw_layer: {
    style: {
      fill: "#F5F5F5"
      stroke: "#666666"
      stroke-width: 2
    }
  }
  data_flow: {
    style: {
      stroke: "#0000FF"
      stroke-width: 2
      animated: true
    }
  }
}

Application: "APPLICATION SPACE" {
  class: app_layer
  
  event_loop: "Event Loop (epoll_wait)" {
    shape: parallelogram
  }
  
  dispatch: "conn_flush(fd=42)" {
    shape: rectangle
    style: {
      bold: true
    }
  }

  wbuf: "Write Buffer (wbuf)" {
    shape: queue
  }

  event_loop -> dispatch: "1. Return EPOLLOUT"
  dispatch -> wbuf: "2. Drain bytes"
}

Kernel: "KERNEL SPACE" {
  class: kernel_layer

  syscall: "Syscall Interface" {
    shape: cloud
  }

  epoll_subsystem: "epoll Subsystem" {
    rdllist: "Ready List (rdllist)" {
      shape: queue
    }
  }

  tcp_stack: "TCP/IP Stack" {
    socket_buffer: "Socket Send Buffer\n(sk_write_queue)" {
      shape: cylinder
    }
  }

  vfs: "VFS / Socket Layer"

  # Interaction paths
  syscall -> epoll_subsystem: "epoll_ctl(MOD, -EPOLLOUT)"
  tcp_stack -> epoll_subsystem: "sock_def_write_space()"
  epoll_subsystem -> syscall: "unblock wait"
}

Hardware: "HARDWARE LAYER" {
  class: hw_layer

  nic: "NIC (Network Interface Card)" {
    shape: rectangle
  }

  dma: "DMA Engine" {
    shape: diamond
  }

  tx_ring: "TX Descriptor Ring" {
    shape: circle
  }

  nic -> dma: "TCP ACK Received"
  dma -> tx_ring: "Advance sk_send_head"
}

# Core Event Flow
Hardware.tx_ring -> Kernel.tcp_stack: "Space available in SNDBUF"
Kernel.tcp_stack -> Kernel.epoll_subsystem.rdllist: "Move epitem to ready"
Kernel.epoll_subsystem -> Application.event_loop: "Syscall Exit (events[i])"
Application.dispatch -> Kernel.syscall: "3. write(fd, buf, len)"
Kernel.syscall -> Kernel.tcp_stack.socket_buffer: "copy_from_user()"
Application.dispatch -> Kernel.syscall: "4. epoll_ctl(MOD, ~EPOLLOUT)"

# Annotations
latency_note: |md
  ### TIMING CRITICAL PATH
  **NIC ACK to conn_flush**
  - Avg Latency: **1-5Âµs**
  - Includes: Hardware DMA, Kernel SoftIRQ (NAPI), epoll state transition, context switch.
| {
  near: bottom-center
  style: {
    stroke: "#FF0000"
    fill: "#FFF2CC"
  }
}

# Connections styling
(Hardware.tx_ring -> Kernel.tcp_stack)[0].class: data_flow
(Kernel.epoll_subsystem -> Application.event_loop)[0].class: data_flow
(Application.dispatch -> Kernel.syscall)[0].class: data_flow