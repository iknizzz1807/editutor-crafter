direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# -----------------------------------------------------------------------------
# ZONE 1: PUBLIC API (reactor.h)
# -----------------------------------------------------------------------------
Public_API: {
  label: "Public Interface: reactor.h"
  style.fill: "#f8f9fa"
  
  Opaque_Pointer: "typedef struct reactor reactor;" {
    shape: parallelogram
    style.stroke-dash: 3
    style.fill: "#FFE5D1" # Orange-tint for pointers/opaque
    tooltip: "Users handle only the opaque pointer to prevent internal state corruption."
  }

  Lifecycle: {
    "reactor* reactor_create(void)"
    "void reactor_destroy(reactor *r)"
    "void reactor_run(reactor *r)"
    "void reactor_stop(reactor *r)"
  }

  IO_Management: {
    "int reactor_register(reactor *r, int fd, uint32_t events, io_callback_fn cb, void *user_data)"
    "void reactor_deregister(reactor *r, int fd)"
  }

  Timers: {
    "int reactor_set_timeout(reactor *r, uint32_t ms, timer_callback_fn cb, void *user_data)"
    "int reactor_set_interval(reactor *r, uint32_t ms, timer_callback_fn cb, void *user_data)"
    "void reactor_cancel_timer(reactor *r, int timer_id)"
  }

  Tasks: {
    "void reactor_defer(reactor *r, task_fn fn, void *user_data)"
  }
}

# -----------------------------------------------------------------------------
# ZONE 2: INTERNAL DATA STRUCTURES (reactor_internal.h)
# -----------------------------------------------------------------------------
Internal_Structures: {
  label: "Internal Implementation Detail"

  reactor: {
    shape: sql_table
    label: "struct reactor | sizeof â‰ˆ 2.6 MB"
    style.fill: "#D0BCFF" # Header Purple
    epoll_fd: "int | 4 bytes" {style.fill: "#D1E4FF"} # Data Blue
    running: "bool | 1 byte" {style.fill: "#D1E4FF"}
    dispatching: "bool | 1 byte" {style.fill: "#D1E4FF"}
    handlers: "fd_handler[65536] | 1.5 MB" {style.fill: "#D1E4FF"}
    timer_heap: "timer_entry[65536] | 1.0 MB" {style.fill: "#D1E4FF"}
    mods: "deferred_mod* | 8 bytes" {style.fill: "#FFE5D1"} # Pointer Orange
    mods_len: "int | 4 bytes" {style.fill: "#D1E4FF"}
    mods_cap: "int | 4 bytes" {style.fill: "#D1E4FF"}
    defer_queue: "deferred_task* | 8 bytes" {style.fill: "#FFE5D1"}
    defer_len: "int | 4 bytes" {style.fill: "#D1E4FF"}
    defer_cap: "int | 4 bytes" {style.fill: "#D1E4FF"}
  }

  fd_handler: {
    shape: sql_table
    label: "struct fd_handler | sizeof = 24 bytes"
    style.fill: "#D0BCFF"
    callback: "io_callback_fn | 8 bytes" {style.fill: "#FFE5D1"}
    user_data: "void* | 8 bytes" {style.fill: "#FFE5D1"}
    events: "uint32_t | 4 bytes" {style.fill: "#D1E4FF"}
    registered: "bool | 1 byte" {style.fill: "#D1E4FF"}
    zombie: "bool | 1 byte" {style.fill: "#D1E4FF"}
  }

  deferred_mod: {
    shape: sql_table
    label: "struct deferred_mod | sizeof = 16 bytes"
    style.fill: "#D0BCFF"
    op: "mod_op (enum) | 4 bytes" {style.fill: "#D1E4FF"}
    fd: "int | 4 bytes" {style.fill: "#D1E4FF"}
    events: "uint32_t | 4 bytes" {style.fill: "#D1E4FF"}
  }

  deferred_task: {
    shape: sql_table
    label: "struct deferred_task | sizeof = 16 bytes"
    style.fill: "#D0BCFF"
    fn: "task_fn | 8 bytes" {style.fill: "#FFE5D1"}
    user_data: "void* | 8 bytes" {style.fill: "#FFE5D1"}
  }

  mod_op: {
    shape: sql_table
    label: "enum mod_op"
    style.fill: "#D0BCFF"
    MOD_ADD: 0 {style.fill: "#D1E4FF"}
    MOD_MOD: 1 {style.fill: "#D1E4FF"}
    MOD_DEL: 2 {style.fill: "#D1E4FF"}
  }
}

# -----------------------------------------------------------------------------
# ZONE 3: CALLBACK SIGNATURES
# -----------------------------------------------------------------------------
Callbacks: {
  label: "Callback Typedefs"
  io_callback_fn: "void (*)(int fd, uint32_t events, void *user_data)"
  timer_callback_fn: "void (*)(reactor *r, void *user_data)"
  task_fn: "void (*)(reactor *r, void *user_data)"
}

# -----------------------------------------------------------------------------
# RELATIONSHIPS
# -----------------------------------------------------------------------------

# Ownership relationships (Solid)
Internal_Structures.reactor -> Internal_Structures.fd_handler: "contains array[65536]"
Internal_Structures.reactor -> Internal_Structures.deferred_mod: "owns pointer (heap)"
Internal_Structures.reactor -> Internal_Structures.deferred_task: "owns pointer (heap)"
Internal_Structures.deferred_mod -> Internal_Structures.mod_op: "uses"

# Reference relationships (Dashed)
Internal_Structures.fd_handler -> Callbacks.io_callback_fn: "references" {
  style.stroke-dash: 5
}
Internal_Structures.deferred_task -> Callbacks.task_fn: "references" {
  style.stroke-dash: 5
}

# Public to Internal link (Implements/Hollow Triangle)
Public_API.Opaque_Pointer -> Internal_Structures.reactor: "Implementation" {
  style.stroke-dash: 5
  target-arrowhead: triangle {
    style.filled: false
  }
}

# Legend/Annotation - FIXED: ELK requires constant near values
Annotation: |md
  ### Implementation Notes
  - **Opaque Pointers**: The `reactor` struct is defined only in `reactor.c`, hiding members from the compiler at the API level.
  - **Deferred Modifications**: Interest set changes during `reactor_run` are queued in `mods[]` to prevent corruption of the active epoll result batch.
  - **Memory Impact**: The handler table consumes ~1.5MB upfront. The timer heap consumes ~1.0MB. Total RSS is dominated by these tables.
| {
  near: bottom-center
}