layout-engine: elk
theme-id: 0

fd_handler_struct_analysis: {
  fd_handler_memory_layout: {
    grid-columns: 3
    grid-gap: 0

    # Header Definition
    offset_h: "Offset" {
      style: {
        fill: "#9b59b6"
        font-color: "#ffffff"
        bold: true
      }
    }
    field_h: "fd_handler Struct Definition (24 Bytes)" {
      style: {
        fill: "#9b59b6"
        font-color: "#ffffff"
        bold: true
      }
    }
    size_h: "Size" {
      style: {
        fill: "#9b59b6"
        font-color: "#ffffff"
        bold: true
      }
    }

    # callback (Offset 0) - Pointer
    off0: "0x00"
    callback: "callback (io_cb_fn)" {
      tooltip: "Function pointer for event dispatch"
      style: {
        fill: "#f39c12"
        font-color: "#ffffff"
      }
      width: 350
    }
    sz0: "8 bytes"

    # user_data (Offset 8) - Pointer
    off8: "0x08"
    user_data: "user_data (void*)" {
      tooltip: "Opaque application context"
      style: {
        fill: "#f39c12"
        font-color: "#ffffff"
      }
      width: 350
    }
    sz8: "8 bytes"

    # events (Offset 16) - Data
    off16: "0x10"
    events: "events (uint32_t)" {
      tooltip: "Bitmask: READABLE | WRITABLE | ERROR | HANGUP"
      style: {
        fill: "#3498db"
        font-color: "#ffffff"
      }
      width: 350
    }
    sz16: "4 bytes"

    # flags (Offset 20 & 21) - Data
    off20: "0x14"
    flags: {
      grid-columns: 2
      grid-gap: 0
      reg: "registered (bool)" {
        style: {
          fill: "#3498db"
          font-color: "#ffffff"
        }
        width: 175
      }
      zom: "zombie (bool)" {
        style: {
          fill: "#3498db"
          font-color: "#ffffff"
        }
        width: 175
      }
    }
    sz20: "2 bytes"

    # padding (Offset 22) - Padding
    off22: "0x16"
    padding: "Padding (Alignment)" {
      style: {
        fill: "#bdc3c7"
      }
      width: 350
    }
    sz22: "2 bytes"
  }

  table_metrics: |md
    ### Registration Table Metrics
    - **sizeof(fd_handler)**: 24 bytes
    - **MAX_FDS**: 65,536 (Fixed array size)
    - **Total Table Footprint**: 65,536 * 24B = **1,572,864 bytes (~1.5 MB)**
    - **Cache Locality**: Table fits easily in L2/L3 cache of modern server CPUs.
  |
}

cache_line_analysis: {
  shape: package
  label: "Cache Line Alignment (64B)"
  style: {
    stroke: "#e74c3c"
    stroke-dash: 5
  }

  cl_viz: {
    grid-columns: 1
    struct_0: "Entry N [0-23]" {style.fill: "#ecf0f1"}
    struct_1: "Entry N+1 [24-47]" {style.fill: "#ecf0f1"}
    boundary: "---------------- 64B BOUNDARY ----------------" {
      shape: text
      style: {
        font-color: "#e74c3c"
        bold: true
      }
    }
    struct_2: "Entry N+2 [48-71] (Straddles Boundary)" {
      style.fill: "#f8d7da"
      style.stroke: "#e74c3c"
    }
  }

  note: "Sequential FD access spans 3 cache lines due to 24B stride." {
    shape: text
  }
}

fd_handler_struct_analysis.fd_handler_memory_layout -> cache_line_analysis: "Mapping Strategy" {
  style.stroke-dash: 3
}