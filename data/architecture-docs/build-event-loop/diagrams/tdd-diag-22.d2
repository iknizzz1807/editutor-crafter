layout-engine: elk

vars: {
  d2-config: {
    theme-id: 0
  }
}

# --- REACTOR CALLBACK SIGNATURE DESIGN ---

definitions: {
  label: "Function Pointer Definitions (reactor.h)"
  style.stroke: "#6a1b9a"
  style.stroke-width: 2
  
  io_cb: {
    label: |md
    ### io_callback_fn
    `typedef void (*io_callback_fn)(int fd, uint32_t events, void *user_data);`
    * **fd**: Event source file descriptor
    * **events**: REACTOR_READ | REACTOR_WRITE
    * **user_data**: Application context tunnel
    |
    style.fill: "#e3f2fd"
  }
  
  timer_cb: {
    label: |md
    ### timer_callback_fn
    `typedef void (*timer_callback_fn)(reactor *r, void *user_data);`
    * **r**: Event loop instance for re-scheduling
    * **user_data**: Per-timer state (e.g., expiry logic)
    |
    style.fill: "#e3f2fd"
  }
}

app_context: {
  label: "Application Layer (Managed Heap Memory)"
  
  conn_struct: {
    shape: sql_table
    label: "struct http_conn (Offset-Base Layout) - sizeof=64B"
    fd: "int" {constraint: "0x00"}
    state: "http_state_t" {constraint: "0x04"}
    wbuf: "write_buf_t" {constraint: "0x08"}
    reactor_ref: "reactor_t*" {constraint: "0x10"}
    
    style.fill: "#bbdefb"
    # Header Purple
    style.stroke: "#6a1b9a"
    
    fd.style.fill: "#e3f2fd"
    state.style.fill: "#e3f2fd"
    wbuf.style.fill: "#e3f2fd"
    reactor_ref.style.fill: "#fff3e0" # Orange for pointers
  }
}

registration: {
  label: "Phase 1: Registration (Casting to Opaque)"
  
  call_site: {
    label: |md
    ### Setup Call Site
    c
    http_conn *conn = create_conn(fd);
    
    // Pointer is cast to void* automatically
    // Reactor stores this address blindly
    reactor_register(r, fd, READ, &on_readable, conn);
    
    |
    style.stroke: "#ff9800"
    style.stroke-width: 2
  }
}

reactor_internals: {
  label: "Phase 2: Storage (reactor_t Memory Map)"
  
  handler_table: {
    shape: sql_table
    label: "fd_handler_t [MAX_FDS] - size=24B per entry"
    callback: "io_callback_fn" {constraint: "8B"}
    user_data: "void*" {constraint: "8B"}
    events: "uint32_t" {constraint: "4B"}
    pad: "uint32_t" {constraint: "4B"}
    
    style.fill: "#f3e5f5"
    callback.style.font-color: "#e65100"
    user_data.style.font-color: "#e65100"
    pad.style.fill: "#eeeeee" # Gray padding
  }
}

execution: {
  label: "Phase 3: Dispatch & Restoration"
  
  dispatch_logic: {
    label: |md
    ### IO Loop (Wait)
    1. `epoll_wait` returns triggered `fd`
    2. Lookup `handler = table[fd]`
    3. `handler->callback(fd, ev, handler->user_data)`
    |
    style.stroke-dash: 3
  }
  
  callback_implementation: {
    label: |md
    ### Application Callback (on_readable)
    c
    void on_readable(int fd, uint32_t ev, void *user_data) {
        // RESTORE TYPE SAFETY
        http_conn *conn = (http_conn*)user_data;
        
        // Use struct fields
        process_request(conn->wbuf);
    }
    
    |
    style.fill: "#fff9c4"
    style.stroke: "#f44336"
    style.stroke-width: 3
  }
}

# --- Connections & Data Flow ---

app_context.conn_struct -> registration.call_site: "Passed as context (void*)" {
  style.stroke: "#ff9800"
}

registration.call_site -> reactor_internals.handler_table: "Store pointer address" {
  style.stroke-dash: 5
  style.stroke: "#ff9800"
}

reactor_internals.handler_table -> execution.dispatch_logic: "Retrieve callback + user_data"

execution.dispatch_logic -> execution.callback_implementation: "INVERSION OF CONTROL" {
  style: {
    stroke: "#f44336"
    stroke-width: 4
    animated: true
  }
}

execution.callback_implementation -> app_context.conn_struct: "Restore Pointer & Access" {
  style.stroke: "#ff9800"
  target-arrowhead: {
    shape: diamond
    style.filled: true
  }
}

# Legend Annotation
annotation: {
  label: |md
  ### The `void* user_data` Pattern
  **Mechanism**: The Reactor (Library) provides the infrastructure but is decoupled from the Application Data. 
  The opaque pointer allows state to survive across the `epoll_wait` boundary without the library knowing the specific struct layouts of the caller.
  |
  near: bottom-center
  style.stroke: "#4caf50"
  style.fill: "#f1f8e9"
}