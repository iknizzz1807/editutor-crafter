layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  # DEFERRED TASK QUEUE: SWAP-BUFFER RE-ENTRANCY
  **Pattern:** Generation Isolation via Double-Buffering
  **Constraint:** Tasks scheduled during dispatch must not execute until the next event loop tick.
| {near: top-center}

# Global Classes for Intel-Manual Quality
classes: {
  header_purple: { style: { fill: "#DDA0DD"; bold: true } }
  data_blue: { style: { fill: "#ADD8E6" } }
  free_green: { style: { fill: "#90EE90"; stroke-dash: 3 } }
  padding_gray: { style: { fill: "#D3D3D3" } }
  pointer_orange: { style: { fill: "#FF8C00" } }
  changed_red: { style: { font-color: "#FF0000"; bold: true; stroke: "#FF0000"; stroke-width: 3 } }
}

step_1: "STEP 1: Snapshot and Pointer Swap" {
  before: "INITIAL STATE (At Tick End)" {
    reactor: {
      shape: sql_table
      class: header_purple
      "0x00": "defer_queue" {constraint: "Pointer (Buf A)"; class: pointer_orange}
      "0x08": "defer_len" {constraint: "3"; class: data_blue}
      "0x0C": "defer_cap" {constraint: "64"; class: data_blue}
    }
    buffer_a: "BUFFER A (Heap)" {
      t1: "Task 1" {class: data_blue}
      t2: "Task 2" {class: data_blue}
      t3: "Task 3" {class: data_blue}
      f: "Free" {class: free_green}
    }
    reactor."0x00" -> buffer_a: "points to" {style.stroke: orange}
  }

  after: "SWAP EXECUTED" {
    reactor: {
      shape: sql_table
      class: header_purple
      "0x00": "defer_queue" {constraint: "Ptr (Buf B)"; class: [pointer_orange; changed_red] }
      "0x08": "defer_len" {constraint: "0"; class: [data_blue; changed_red] }
      "0x0C": "defer_cap" {constraint: "64"; class: data_blue}
    }
    local_tasks: "local snapshot ptr" {class: pointer_orange}
    buffer_a: "BUFFER A (Snapshot)" {
      t1: "Task 1"
      t2: "Task 2"
      t3: "Task 3"
    }
    buffer_b: "BUFFER B (New Active)" { class: changed_red; style.fill: "#90EE90" }
    
    local_tasks -> buffer_a: "captures T1-T3" {style.stroke: orange}
    reactor."0x00" -> buffer_b: "Redirected" {class: changed_red}
    
    annotation: |md
      1. `int count = r->defer_len` (3)
      2. `r->defer_len = 0`
      3. `r->defer_queue = malloc(...)` (Buffer B)
    |
  }
}

step_2: "STEP 2: Re-entrant Execution (Task 2 Defers New)" {
  before: "DISPATCHING SNAPSHOT" {
    reactor: {
      shape: sql_table
      class: header_purple
      "0x00": "defer_queue" {constraint: "Ptr (Buf B)"}
      "0x08": "defer_len" {constraint: "0"}
    }
    snapshot_view: "Executing Buffer A" {
      t1: "COMPLETED" {style.opacity: 0.5}
      t2: "RUNNING" {style.fill: "#fff176"; style.stroke-width: 3}
      t3: "PENDING"
    }
    buffer_b: "BUFFER B (Empty)" {class: padding_gray}
    reactor."0x00" -> buffer_b
  }

  after: "RE-ENTRANCY TRIGGERED" {
    reactor: {
      shape: sql_table
      class: header_purple
      "0x00": "defer_queue" {constraint: "Ptr (Buf B)"}
      "0x08": "defer_len" {constraint: "1"; class: changed_red }
    }
    snapshot_view: "Executing Buffer A" {
      t1: "COMPLETED"
      t2: "COMPLETED" {style.opacity: 0.5}
      t3: "PENDING"
    }
    buffer_b: "BUFFER B" {
      t_new: "T_NEW" { class: changed_red; style.fill: "#ffcdd2" }
    }
    
    reactor."0x00" -> buffer_b
    snapshot_view.t2 -> buffer_b.t_new: "reactor_defer(T_new)" { class: changed_red; style.animated: true }
    
    logic_note: |md
      **Isolation Proof:** 
      Dispatch loop uses `count=3`. 
      `T_new` is in `defer_queue`, but 
      the active loop won't see it.
    |
  }
}

step_3: "STEP 3: Final Cleanup & Transition" {
  before: "TICK END" {
    reactor: {
      shape: sql_table
      class: header_purple
      "0x08": "defer_len" {constraint: "1"}
    }
    snapshot_view: "Buffer A (All Done)" {style.fill: gray}
    buffer_b: "Buffer B" { t_new: "T_NEW" }
  }

  after: "READY FOR NEXT TICK" {
    reactor: {
      shape: sql_table
      style.stroke: "#00FF00"
      class: header_purple
      "0x00": "defer_queue" {constraint: "Ptr (Buf B)"; class: pointer_orange}
      "0x08": "defer_len" {constraint: "1"; class: data_blue}
    }
    buffer_b: "BUFFER B (Primary Queue)" {
      t_new: "T_NEW (Ready to run)" {class: data_blue}
    }
    
    reactor."0x00" -> buffer_b
    
    cleanup_info: |md
      **Freeing Snapshot:**
      `free(snapshot_ptr)` 
      Buffer A destroyed.
      T_new leads next tick.
    | {style.fill: "#e8f5e9"}
  }
}

# Corrected Phase Connections
step_1.after -> step_2.before: "Next Phase"
step_2.after -> step_3.before: "Next Phase"