layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

reactor_vs_proactor: {
  grid-columns: 2
  grid-gap: 50

  # ---------------------------------------------------------------------------
  # COLUMN 1: REACTOR (epoll)
  # ---------------------------------------------------------------------------
  reactor: "REACTOR PATTERN (epoll)" {
    style: {
      stroke: "#333333"
      fill: "#f8f9fa"
      stroke-width: 2
    }

    app: "Application Space" {
      style.fill: "#e7f3ff"
      
      wait_call: "1. epoll_wait()" {
        shape: parallelogram
      }
      
      io_dispatch: "3. read(fd, buf, len)" {
        shape: parallelogram
        style.stroke: "#ff8c00"
        style.stroke-width: 3
      }
      
      process: "4. Process Data" {
        style.bold: true
      }

      wait_call -> io_dispatch: "Event: fd 7 Readable"
      io_dispatch -> process
    }

    kernel: "Kernel Space" {
      style.fill: "#fff3e0"
      
      readiness: "Readiness Notification" {
        tooltip: "fd 7 is added to ready list (rdllist)"
      }
      
      copy_op: "Data Copy (sk_buf -> user_buf)" {
        style.stroke-dash: 3
      }
    }

    # Internal connections with absolute paths
    kernel.readiness -> app.wait_call: "Return: {fd: 7, ev: EPOLLIN}"
    app.io_dispatch -> kernel.copy_op: "Syscall"

    annotation: |md
      **Reactor Characteristics**
      - **Readiness-Based**: Kernel tells you *when* you can do I/O.
      - **App-Driven I/O**: The application is responsible for calling `read()` or `write()`.
      - **EAGAIN Handling**: Mandatory. Must drain buffers to `EAGAIN` in ET mode.
      - **Double Copy**: Data moves from hardware to kernel buffer, then kernel to user buffer.
    | {
      style.font-size: 12
    }
  }

  # ---------------------------------------------------------------------------
  # COLUMN 2: PROACTOR (io_uring)
  # ---------------------------------------------------------------------------
  proactor: "PROACTOR PATTERN (io_uring)" {
    style: {
      stroke: "#333333"
      fill: "#f8f9fa"
      stroke-width: 2
    }

    app: "Application Space" {
      style.fill: "#e7f3ff"
      
      submit: "1. IORING_OP_READ\n(fd=7, buf, len)" {
        shape: parallelogram
        style.stroke: "#4caf50"
        style.stroke-width: 3
      }
      
      process: "4. Process Data" {
        style.bold: true
      }

      submit -> process: "Completion: res=4096"
    }

    kernel: "Kernel Space" {
      style.fill: "#fff3e0"
      
      sq_ring: "Submission Queue (SQ)" {
        shape: queue
      }
      
      io_worker: "Kernel performs I/O\n(Background)" {
        style.stroke-dash: 5
      }
      
      cq_ring: "Completion Queue (CQ)" {
        shape: queue
      }
    }

    # Internal connections with absolute paths
    app.submit -> kernel.sq_ring: "Entry Push"
    kernel.sq_ring -> kernel.io_worker: "Consume"
    kernel.io_worker -> kernel.cq_ring: "Post Result"
    kernel.cq_ring -> app.process: "User Polls CQ"

    annotation: |md
      **Proactor Characteristics**
      - **Completion-Based**: Kernel tells you *after* I/O is finished.
      - **Kernel-Driven I/O**: The kernel performs the transfer into user buffer.
      - **NO EAGAIN**: Result is delivered with actual bytes read; I/O is already complete.
      - **Zero User-Space I/O**: Application logic never calls `read()`. It only polls completions.
    | {
      style.font-size: 12
    }
  }
}

# ---------------------------------------------------------------------------
# GLOBAL COMPARISON LABELS
# ---------------------------------------------------------------------------
legend: {
  near: bottom-center
  
  reactor_summary: "Reactor: App performs I/O" {
    style.fill: "#ff8c00"
    style.font-color: white
  }
  
  proactor_summary: "Proactor: Kernel performs I/O" {
    style.fill: "#4caf50"
    style.font-color: white
  }
}

# Define arrows representing the fundamental architectural shift
reactor_vs_proactor.reactor.app.io_dispatch -> reactor_vs_proactor.proactor.app.submit: "Evolution: Move I/O from App to Kernel" {
  style.stroke-dash: 5
  style.font-size: 14
}