layout-engine: elk
theme-id: 4

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

http_conn: {
  shape: sql_table
  label: "struct http_conn (Total: 17,492 bytes)"
  style: {
    stroke: "#333333"
    stroke-width: 2
    shadow: true
    fill: "#E1D5E7" # Purple Header
  }

  # Offset (Key) | Field Name (Value) | Size (Constraint)
  0: "read_buf[16384]" {
    constraint: "16384 B"
    style.fill: "#DAE8FC" # Blue (Data)
  }
  
  16384: "wbuf (write_buf struct)" {
    constraint: "24 B"
    style.fill: "#DAE8FC" # Blue
  }

  16408: "req.method[8]" {
    constraint: "8 B"
    style.fill: "#DAE8FC" # Blue
  }

  16416: "req.path[1024]" {
    constraint: "1024 B"
    style.fill: "#DAE8FC" # Blue
  }

  17440: "req.content_length" {
    constraint: "8 B"
    style.fill: "#DAE8FC" # Blue
  }

  17448: "req.body_received" {
    constraint: "8 B"
    style.fill: "#DAE8FC" # Blue
  }

  17456: "req.keep_alive" {
    constraint: "1 B"
    style.fill: "#DAE8FC" # Blue
  }

  17457: "req.has_content_length" {
    constraint: "1 B"
    style.fill: "#DAE8FC" # Blue
  }

  17458: "req.padding_1 (Alignment)" {
    constraint: "6 B"
    style.fill: "#F5F5F5" # Gray (Padding)
  }

  17464: "read_len" {
    constraint: "4 B"
    style.fill: "#DAE8FC" # Blue
  }

  17468: "fd" {
    constraint: "4 B"
    style.fill: "#DAE8FC" # Blue
  }

  17472: "timer_id" {
    constraint: "4 B"
    style.fill: "#DAE8FC" # Blue
  }

  17476: "state (conn_http_state)" {
    constraint: "4 B"
    style.fill: "#DAE8FC" # Blue
  }

  17480: "padding_2 (Alignment)" {
    constraint: "4 B"
    style.fill: "#F5F5F5" # Gray
  }

  17484: "reactor_ref*" {
    constraint: "8 B"
    style.fill: "#FFE6CC" # Orange (Pointer)
  }
}

legend: {
  near: center-right
  
  title: "Memory Analysis" {
    shape: text
    style.bold: true
  }
  
  stats: |md
    ### Footprint
    - **Total size:** 17,492 bytes (~17 KB)
    - **C10K Load:** ~171 MB Resident RAM
    
    ### Hardware
    - **Cache Lines:** 273.3 (64B each)
    - **read_buf:** 93.6% of footprint
    - **Alignment:** 8-byte boundary enforced for pointers
  |
}

# 64B Cache Line Visualization
# Note: Positioned near the start of the write-path members
cl_marker: "--- 64B Cache Line Boundary ---" {
  shape: text
  near: bottom-left
  style: {
    font-color: red
    italic: true
    bold: true
  }
}

cl_marker -> http_conn."16384": {
  style: {
    stroke: red
    stroke-dash: 5
    opacity: 0.6
  }
}