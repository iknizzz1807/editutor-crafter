direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ---------------------------------------------------------------------------------
# STEP 1: INITIAL PARTIAL READ
# ---------------------------------------------------------------------------------
Step_1: "STEP 1: FIRST PACKET ARRIVAL" {
  Memory_Layout: {
    shape: sql_table
    0x0000: "GET /index.html HTTP/1.1\\r\\nHost: exa" {style.fill: "#dae8fc"}
    0x0026: " [ UNUSED SPACE ] " {style.fill: "#d5e8d4"}
  }

  Parser_State: {
    shape: class
    read_len: "38 bytes" {style: {font-color: red; bold: true}}
    find_header_end: "-1 (NOT FOUND)"
    status: "PARSE_INCOMPLETE"
    action: "Return to epoll_wait"
  }
  
  Memory_Layout.0x0000 -> Parser_State.find_header_end: "Scan for \\r\\n\\r\\n"
}

# ---------------------------------------------------------------------------------
# STEP 2: SECOND FRAGMENT ACCUMULATION
# ---------------------------------------------------------------------------------
Step_2: "STEP 2: BUFFER ACCUMULATION" {
  Memory_Layout: {
    shape: sql_table
    0x0000: "GET /index.html HTTP/1.1\\r\\nHost: exa" {style.fill: "#dae8fc"}
    0x0026: "mple.com\\r\\nConnection: keep-alive\\r\\n" {style: {fill: "#dae8fc"; font-color: red; bold: true}}
    0x0048: " [ UNUSED SPACE ] " {style.fill: "#d5e8d4"}
  }

  Parser_State: {
    shape: class
    read_len: "72 bytes" {style: {font-color: red; bold: true}}
    find_header_end: "-1 (NOT FOUND)"
    status: "PARSE_INCOMPLETE"
    action: "Append and Sleep"
  }

  Memory_Layout.0x0026 -> Parser_State.read_len: "read_pos += 34"
}

# ---------------------------------------------------------------------------------
# STEP 3: DELIMITER FOUND & EXTRACTION
# ---------------------------------------------------------------------------------
Step_3: "STEP 3: PARSE COMPLETE" {
  Memory_Layout: {
    shape: sql_table
    0x0000: "GET /index.html HTTP/1.1\\r\\nHost: example.com\\r\\nConnection: keep-alive\\r\\n" {style.fill: "#dae8fc"}
    0x0048: "\\r\\n" {style: {fill: "#e1d5e7"; font-color: red; bold: true}}
    0x004A: " [ UNUSED SPACE ] " {style.fill: "#d5e8d4"}
  }

  Parser_State: {
    shape: class
    read_len: "74 bytes"
    find_header_end: "74" {style: {font-color: red; bold: true}}
    req_method: "GET" {style: {font-color: red; bold: true}}
    req_path: "/index.html" {style: {font-color: red; bold: true}}
    status: "PARSE_COMPLETE"
    action: "Transition to HTTP_PROCESSING"
  }

  Memory_Layout.0x0048 -> Parser_State.find_header_end: "Delimiter Detected"
}

# Transitions between steps
Step_1 -> Step_2: "New Data (34 bytes)"
Step_2 -> Step_3: "Final Fragment (2 bytes)"

# Annotations
Step_1.Memory_Layout.0x0000: |md
  **Offset 0x00**: Headers truncated mid-hostname.
|
Step_3.Memory_Layout.0x0048: |md
  **End of Headers**: \r\n\r\n sequence confirmed.
|

legend: {
  near: bottom-right
  header_data: "Header Bytes" {
    style.fill: "#dae8fc"
  }
  delimiter: "Delimiter (\r\n\r\n)" {
    style.fill: "#e1d5e7"
  }
  free_space: "Available Buffer" {
    style.fill: "#d5e8d4"
  }
}