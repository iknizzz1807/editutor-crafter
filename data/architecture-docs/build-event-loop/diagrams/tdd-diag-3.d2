layout-engine: elk
theme-id: 4

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

conn_state_layout: {
  shape: sql_table
  label: "Struct: conn_state (Memory Layout) | Total: 4112B"
  style.fill: "#E4DBFE" # Header=Purple
  
  # Offset | Field Name | Size
  0: "read_buf[0..63] (Cache Line 1)" {
    constraint: "64B"
    style.fill: "#B6DDF6" # Data=Blue
    style.stroke-dash: 5 # Cache Line Boundary
  }
  
  64: "read_buf[64..4031] (Internal)" {
    constraint: "3968B"
    style.fill: "#B6DDF6"
  }

  4032: "read_buf[4032..4095] (End of Buffer)" {
    constraint: "64B"
    style.fill: "#B6DDF6"
    style.stroke-dash: 5 # Cache Line Boundary
  }

  4096: "read_len (uint32_t)" {
    constraint: "4B"
    style.fill: "#B6DDF6"
    style.stroke-width: 4 # Page Boundary (4096B) Bold Line
  }

  4100: "fd (int)" {
    constraint: "4B"
    style.fill: "#B6DDF6"
  }

  4104: "active (bool)" {
    constraint: "1B"
    style.fill: "#ACE1AF" # Free/Status=Green
  }

  4105: "padding" {
    constraint: "7B"
    style.fill: "#DEE1EB" # Padding=Gray
  }

  4112: "[End of Struct]" {
    constraint: "4112B"
    style.fill: "#E4DBFE"
    style.bold: true
  }
}

annotations: {
  # FIXED: ELK layout engine requires constant values (top/bottom/etc) for 'near'
  near: bottom-center
  
  prefetch_note: |md
    ### Prefetch Efficiency
    - `read_buf[0..63]` is aligned to cache line 1.
    - Sequential access triggers hardware prefetchers.
  |
  
  sharing_note: |md
    ### Cache Locality
    - `active` flag shares cache line 65 with `fd` and `read_len`.
    - Updates to `active` may cause false sharing invalidation.
  |
  
  scale_note: |md
    ### Scale at C10K
    - **Total size:** 4,112 Bytes
    - **10K Connections:** ~40.15 MB Resident Memory
  |
}