layout-engine: elk
theme-id: 4

# Algorithm: http_on_readable state transitions
# This diagram tracks the state of http_conn_t during the ET read loop.

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

classes: {
  state_node: {
    style: {
      border-radius: 5
      stroke-width: 2
    }
  }
  terminal: {
    style: {
      fill: "#ffcfcf"
      stroke: red
    }
  }
  process: {
    style: {
      fill: "#e1f5fe"
    }
  }
  changed: {
    style: {
      stroke: red
      stroke-width: 4
    }
  }
}

direction: down

"0: Entry" -> "1: Event Validation"
"1: Event Validation" -> "1a: Error/HUP Handler": "events & (ERR|HUP)"
"1a: Error/HUP Handler" -> "9: Defer Close": "reactor_defer"

"1: Event Validation" -> "2: State Guard": "Normal I/O"
"2: State Guard" -> "3: ET Drain Loop": "state in {HEADERS, BODY}"
"2: State Guard" -> "Exit": "Invalid state"

"3: ET Drain Loop" -> "4: read() Syscall"

"4: read() Syscall" -> "5: Process Bytes": "n > 0"
"4: read() Syscall" -> "9: Defer Close": "n == 0 (EOF)"
"4: read() Syscall" -> "3a: EAGAIN Handler": "n < 0 && EAGAIN"
"4: read() Syscall" -> "9: Defer Close": "n < 0 (Real Error)"

"3a: EAGAIN Handler" -> "Exit": "Return to Reactor"

"5: Process Bytes" -> "6: Header Parse": "state == READING_HEADERS"
"5: Process Bytes" -> "7: Body Accumulation": "state == READING_BODY"

"6: Header Parse" -> "6a: Bad Request": "PARSE_ERROR"
"6a: Bad Request" -> "3: ET Drain Loop": "state = **CLOSING**"

"6: Header Parse" -> "6b: Partial Header": "PARSE_INCOMPLETE"
"6b: Partial Header" -> "3: ET Drain Loop": "Wait for next read"

"6: Header Parse" -> "6c: Complete Header": "PARSE_COMPLETE"
"6c: Complete Header" -> "8: Request Dispatch": "Body length == 0"
"6c: Complete Header" -> "5: Process Bytes": "Body length > 0\nmemmove() data"

"7: Body Accumulation" -> "8: Request Dispatch": "body_received == content_length"
"7: Body Accumulation" -> "3: ET Drain Loop": "body_received < content_length"

"8: Request Dispatch" -> "3: ET Drain Loop": "state = **PROCESSING**\nhttp_process_request()"

# State Details
"9: Defer Close".class: terminal
"6a: Bad Request".class: state_node
"6c: Complete Header".class: state_node
"8: Request Dispatch".class: state_node

"1a: Error/HUP Handler".class: process
"3a: EAGAIN Handler".class: process

"0: Entry" {
  shape: package
  label: "Initial State"
  info: |md
    - state: **READING_HEADERS**
    - read_pos: N
    - timer_id: ID
  |
}

"6c: Complete Header" {
  info: |md
    - state: **READING_BODY**
    - **req** is now populated
    - read_pos: **remaining**
  |
}

"8: Request Dispatch" {
  info: |md
    - state: **PROCESSING**
    - Timer: **Canceled**
    - Action: **Resolve File Path**
  |
}

"3a: EAGAIN Handler" {
  label: "EAGAIN: Loop Exit"
  info: |md
    - FD Drained
    - Interrupt safe
    - Returning control
  |
}

# Legend
Legend: {
  near: bottom-right
  note: "Step numbering follows TDD M4 spec"
  red_bold: "**RED BOLD** = State Mutation" {
    style.font-color: red
  }
}