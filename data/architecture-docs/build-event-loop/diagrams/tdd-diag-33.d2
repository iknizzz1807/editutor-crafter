direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --------------------------------------------------------------------------------
# Slow Loris Attack and Defense: Accumulation Window vs Timeout Enforcement
# --------------------------------------------------------------------------------

Step_1: "1. Connection Initiation (T=0s)" {
  state: {
    conn: "http_conn struct (fd=12)" {
      state: "HTTP_READING_HEADERS"
      idle_timer: "30000ms (T+30s)"
      header_deadline: "60000ms (T+60s)"
    }
  }
  annotation: |md
    **Invariants:**
    - `idle_timer` (T1): Resets on every `read() > 0`.
    - `header_deadline` (T2): Hard limit for M4 parser.
  |
}

Step_2: "2. Malicious Activity (T=29s)" {
  state: {
    conn: "http_conn struct (fd=12)" {
      state: "HTTP_READING_HEADERS"
      read_buf: "GET / [1 byte payload]..."
      idle_timer: "**59000ms (T+29+30s)**" {
        style: {
          font-color: red
          bold: true
        }
      }
      header_deadline: "60000ms (T+60s)"
    }
  }
  annotation: |md
    **Action:**
    - Client sends 1 byte.
    - `reactor_cancel_timer(T1)`
    - `reactor_set_timeout(T1, 30000)`
    - **T2 remains unchanged.**
  |
}

Step_3: "3. Absolute Timeout (T=60s)" {
  state: {
    conn: "http_conn struct (fd=12)" {
      state: "**HTTP_CLOSING**" {
        style: {
          font-color: red
          bold: true
        }
      }
      idle_timer: "89000ms (T+59+30s)"
      header_deadline: "**EXPIRED**" {
        style: {
          font-color: red
          bold: true
        }
      }
    }
  }
  annotation: |md
    **Result:**
    - T2 (Header Deadline) fires.
    - `reactor_defer(http_conn_close)`
    - 17.5KB heap + FD released.
  |
}

Step_1 -> Step_2: "Client sends 1 byte\nat T=29s"
Step_2 -> Step_3: "T=60 reached\nNo headers complete"

# --------------------------------------------------------------------------------
# Memory Layout: The Accumulation Cost (http_conn: ~17.5 KB)
# --------------------------------------------------------------------------------

Memory_Map: "Memory Layout: http_conn_t (sizeof=17492B)" {
  near: top-right
  
  0000: "0x0000 | read_buf | 16384B" {
    style: {
      fill: "#B6DDF6"
      stroke: "#0000FF"
    }
  }
  4000: "0x4000 | wbuf | 24B" {
    style: {
      fill: "#E1D5E7"
      stroke: "#800080"
    }
  }
  4018: "0x4018 | http_request_t | 1056B" {
    style: {
      fill: "#B6DDF6"
      stroke: "#0000FF"
    }
  }
  443C: "0x443C | fd | 4B" { style.fill: gray }
  4440: "0x4440 | state | 4B" { style.fill: gray }
  4444: "0x4444 | timer_id | 4B" { style.fill: gray }
  4450: "0x4450 | reactor_ref | 8B" {
    style: {
      fill: "#FCE7C6"
      stroke: "#FFA500"
    }
  }
  
  Page_Boundary: "--- Page Boundary (4096B Alignment) ---" {
    style: {
      stroke-width: 4
      stroke: black
      bold: true
    }
  }
}

Legend: {
  near: bottom-right
  Header_Col: "Header Metadata" {
    style: { fill: "#E1D5E7"; stroke: "#800080" }
  }
  Data_Col: "Data Buffer" {
    style: { fill: "#B6DDF6"; stroke: "#0000FF" }
  }
  Pointer_Col: "Pointers/Refs" {
    style: { fill: "#FCE7C6"; stroke: "#FFA500" }
  }
  Change_Col: "State Transition" {
    style: { font-color: red; bold: true; stroke: red }
  }
}

Step_1.state.conn -> Memory_Map: "Context" {
  style.stroke-dash: 5
}