layout-engine: elk
theme-id: 0

# C10K BENCHMARK ARCHITECTURE: wrk -> KERNEL -> SERVER
direction: right

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# Prerequisites and System Configuration
config: "System Configuration & Limits" {
  near: top-center
  style: {
    stroke: "#666666"
    stroke-dash: 5
    fill: "#F5F5F5"
  }
  limits: |md
    ### OS Tuning
    - **ulimit -n**: 65536
    - **net.core.somaxconn**: 65535
    - **tcp_max_syn_backlog**: 65535
    - **tcp_tw_reuse**: 1
    - **ip_local_port_range**: 1024 65535
  |
}

# Load Generation Layer
wrk: "wrk Load Generator" {
  shape: package
  style.fill: "#E1D5E7" # Purple Header

  threads: "12 Worker Threads" {
    shape: person
    style.multiple: true
    label: "Thread Pool\nsize=12"
  }

  connections: "TCP Connection Pool" {
    label: "Concurrent Streams\nsize=10,008 total\n(834 conns/thread)"
    style.fill: "#DAE8FC"
  }

  threads -> connections: "owns" {style.stroke-width: 2}
}

# Linux Kernel Boundary
kernel: "Linux Kernel 5.1+" {
  style.fill: "#F8CECC" # Reddish for Kernel

  subsurface: "Kernel TCP Stack" {
    syn_backlog: "SYN Backlog" {
      label: "Handshake queue\ncapacity: 65,535"
    }

    accept_queue: "Accept Queue" {
      label: "somaxconn queue\ncapacity: 65,535\nready for accept4()"
    }

    sk_receive_queue: "Socket Buffers (sk_buff)" {
      label: "sk_receive_queue [x10,000]"
      style.multiple: true
      style.fill: "#D5E8D4" # Green for Data
    }
  }
}

# HTTP Server Application
server: "HTTP Server (Single-Threaded)" {
  style.fill: "#FFF2CC" # Yellow for App

  epoll_instance: "epoll Facility" {
    fd_interest_list: "Interest List"
    fd_ready_list: "Ready List"
    fds: "10,001 monitored FDs"
    batch_size: "MAX_EVENTS=1024"
  }

  reactor: "Reactor Pattern Dispatcher" {
    label: "run_event_loop()\n80,000 req/sec\np99 < 100ms"
  }

  # Connection Data Model Detail
  # Fixed: size metadata moved into the type string to avoid nested children error
  http_conn_t: "struct http_conn" {
    shape: sql_table
    style.fill: "#DAE8FC"
    read_buf: "char[16384] (16 KB)"
    wbuf: "write_buf_t (24 B)"
    req: "http_request_t (1 KB)"
    state: "http_state_t (4 B)"
    sizeof: "Total Size: ~17.5 KB"
  }

  reactor -> epoll_instance: "owns"
  reactor -> http_conn_t: "manages [x10,000]"
}

# Component Interconnects
wrk.connections -> kernel.subsurface.syn_backlog: "SYN / Handshake"
kernel.subsurface.accept_queue -> server.reactor: "readiness trigger" {
  style.stroke-dash: 3
}
server.reactor -> kernel.subsurface.sk_receive_queue: "accept4() / read()" {
  style.stroke: "#EA6B66"
}
kernel.subsurface.sk_receive_queue -> server.http_conn_t.read_buf: "copy_to_user" {
  style.animated: true
}

# Metrics Legend
legend: "Performance Metadata" {
  near: bottom-right
  avg_lat: "Avg Latency: ~2.1ms" {shape: text}
  throughput: "BW: ~3.38 GB read / 30s" {shape: text}
}