layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

write_buf_struct: {
  label: "write_buf Struct Memory Layout"
  
  header: {
    shape: sql_table
    style.fill: "#9b59b6"
    
    "Offset": "Field" {constraint: "Size"}
    "0x00": "char *data (Heap Pointer)" {constraint: "8B"}
    "0x08": "uint32_t len (Active Bytes)" {constraint: "4B"}
    "0x0C": "uint32_t cap (Total Capacity)" {constraint: "4B"}
    "0x10": "uint32_t offset (Drain Index)" {constraint: "4B"}
    "0x14": "Padding / Alignment" {constraint: "4B"}
  }

  header."0x00".style.fill: "#f39c12"
  header."0x08".style.fill: "#3498db"
  header."0x0C".style.fill: "#3498db"
  header."0x10".style.fill: "#3498db"
  header."0x14".style.fill: "#95a5a6"

  footer: |md
    **Total Size:** 24 bytes (Aligned to 8B boundary)
  |
  footer.shape: text
}

compaction_mechanics: {
  label: "Compaction State Transitions"
  
  state_a: "State (A): Initial Fill" {
    grid-columns: 2
    data: "Active Data (len=100)" {
      width: 100
      style.fill: "#3498db"
    }
    free: "Free Space (cap-len)" {
      width: 300
      style.fill: "#2ecc71"
    }
    label.near: top-center
  }

  state_b: "State (B): Partial Drain" {
    grid-columns: 3
    drained: "Drained (offset=60)" {
      width: 60
      style.fill: "#95a5a6"
    }
    data: "Data (len=40)" {
      width: 40
      style.fill: "#3498db"
    }
    free: "Free Space" {
      width: 300
      style.fill: "#2ecc71"
    }
    label.near: top-center
  }

  state_c: "State (C): Post-Compaction" {
    grid-columns: 2
    data: "Data (len=40)" {
      width: 40
      style.fill: "#3498db"
    }
    free: "Free Space (cap-len)" {
      width: 360
      style.fill: "#2ecc71"
    }
    label.near: top-center
  }

  annotation: |md
    ### memmove() Logic
    Trigger: `offset > (cap / 2)`
    Action: `memmove(data, data + offset, len)`
  | {
    shape: text
  }

  state_b.data -> state_c.data: "memmove slides data to index 0" {
    style: {
      stroke-dash: 3
      animated: true
      stroke: orange
    }
  }
}

write_buf_struct -> compaction_mechanics: "Manages Heap Array" {
  style.stroke-width: 2
}