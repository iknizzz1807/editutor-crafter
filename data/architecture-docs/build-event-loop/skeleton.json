{
  "title": "Event Loop with epoll: Design Document",
  "overview": "This document designs a single-threaded event loop server capable of handling 10,000+ concurrent connections using Linux's epoll mechanism. It solves the C10K problem by implementing the Reactor pattern with non-blocking I/O, efficient timer management via a hierarchical timer wheel, and asynchronous task scheduling. The key architectural challenge is managing massive concurrency with low overhead and predictable latency without using threads.",
  "sections": [
    {
      "id": "section-1",
      "title": "Context and Problem Statement",
      "summary": "Explains the limitations of thread-per-connection servers and introduces the event-driven architecture as a solution for high concurrency.",
      "subsections": [
        {
          "id": "subsection-1-1",
          "title": "The C10K Problem and the Threading Bottleneck",
          "summary": "Describes why traditional blocking I/O with threads fails at scale due to resource overhead and context-switching costs."
        },
        {
          "id": "subsection-1-2",
          "title": "Event-Driven Architecture: The Postal System Analogy",
          "summary": "Uses the analogy of a single postal worker (event loop) efficiently sorting and dispatching mail (events) to explain the reactor pattern."
        },
        {
          "id": "subsection-1-3",
          "title": "Comparison of I/O Multiplexing Approaches",
          "summary": "Compares select, poll, epoll, and kqueue in a table, highlighting why epoll is chosen for Linux."
        }
      ]
    },
    {
      "id": "section-2",
      "title": "Goals and Non-Goals",
      "summary": "Defines the core capabilities and explicit boundaries of the system.",
      "subsections": [
        {
          "id": "subsection-2-1",
          "title": "Goals",
          "summary": "Must handle 10K+ concurrent connections, support idle timeouts, provide a callback API, and include an HTTP server example."
        },
        {
          "id": "subsection-2-2",
          "title": "Non-Goals",
          "summary": "Does not implement multi-threading, a full HTTP/2 protocol, SSL/TLS, or a production-grade connection pool."
        }
      ]
    },
    {
      "id": "section-3",
      "title": "High-Level Architecture",
      "summary": "Overview of the system's components, their responsibilities, and how they connect.",
      "subsections": [
        {
          "id": "subsection-3-1",
          "title": "Component Diagram and Data Flow",
          "summary": "Shows the Event Loop core, Timer Wheel, Async Task Queue, and Protocol Handlers (like HTTP) interacting."
        },
        {
          "id": "subsection-3-2",
          "title": "Recommended File/Module Structure",
          "summary": "Provides a skeleton directory layout for organizing the C codebase (event_loop.c, timer_wheel.c, http_parser.c, etc.)."
        }
      ]
    },
    {
      "id": "section-4",
      "title": "Data Model",
      "summary": "Describes the key data structures, their fields, and relationships.",
      "subsections": [
        {
          "id": "subsection-4-1",
          "title": "Core Types: Connection, Timer, Callback",
          "summary": "Tables defining the structures for a connection context, a timer entry, and a registered callback."
        },
        {
          "id": "subsection-4-2",
          "title": "Event Loop State and Timer Wheel Slots",
          "summary": "Describes the main event loop state structure and the hierarchical timer wheel data layout."
        }
      ]
    },
    {
      "id": "section-5",
      "title": "Component Design",
      "summary": "Detailed design of each major component, following the project milestones.",
      "subsections": [
        {
          "id": "subsection-5-1",
          "title": "Event Loop (epoll Basics) - Milestone 1",
          "summary": "The core reactor: manages epoll instance, registers file descriptors, and dispatches I/O events."
        },
        {
          "id": "subsection-5-2",
          "title": "Timer Wheel (Timer Wheel and Timeouts) - Milestone 2",
          "summary": "Hierarchical wheel for O(1) timeout management, integrated with the event loop's wait timeout."
        },
        {
          "id": "subsection-5-3",
          "title": "Async Task Scheduling - Milestone 3",
          "summary": "Manages callback registration and a deferred task queue, providing the Reactor pattern API."
        },
        {
          "id": "subsection-5-4",
          "title": "HTTP Server on Event Loop - Milestone 4",
          "summary": "An HTTP/1.1 protocol handler built on the event loop, featuring incremental parsing and buffer management."
        }
      ]
    },
    {
      "id": "section-6",
      "title": "Interactions and Data Flow",
      "summary": "Sequence of operations for key scenarios: new connection, data read, timer expiration.",
      "subsections": [
        {
          "id": "subsection-6-1",
          "title": "Sequence: Connection Lifecycle",
          "summary": "Step-by-step flow from accept() to read/write events to timeout or close."
        },
        {
          "id": "subsection-6-2",
          "title": "Flow: Event Loop Tick",
          "summary": "Detailed flowchart of a single event loop iteration, including epoll_wait, I/O processing, timer tick, and task queue."
        }
      ]
    },
    {
      "id": "section-7",
      "title": "Error Handling and Edge Cases",
      "summary": "Strategies for handling common I/O errors, partial reads/writes, and resource exhaustion.",
      "subsections": [
        {
          "id": "subsection-7-1",
          "title": "Non-Blocking I/O Error Patterns",
          "summary": "How to handle EAGAIN/EWOULDBLOCK, ECONNRESET, and EPIPE correctly."
        },
        {
          "id": "subsection-7-2",
          "title": "Edge Cases: Slow Clients and Backpressure",
          "summary": "Managing write buffers when a client cannot keep up, and handling half-closed connections."
        }
      ]
    },
    {
      "id": "section-8",
      "title": "Testing Strategy",
      "summary": "Approaches to verify correctness and performance at each milestone.",
      "subsections": [
        {
          "id": "subsection-8-1",
          "title": "Unit and Integration Tests",
          "summary": "Testing components like the timer wheel and HTTP parser in isolation."
        },
        {
          "id": "subsection-8-2",
          "title": "Milestone Checkpoints and Verification",
          "summary": "For each milestone, provides commands to run and expected output to confirm progress (e.g., using `telnet` or `ab`)."
        }
      ]
    },
    {
      "id": "section-9",
      "title": "Debugging Guide",
      "summary": "Common symptoms, their causes, and how to fix them.",
      "subsections": [
        {
          "id": "subsection-9-1",
          "title": "Symptom-Cause-Fix Table",
          "summary": "Table listing issues like 'CPU at 100%', 'connections stuck', or 'timer not firing' with diagnosis steps."
        },
        {
          "id": "subsection-9-2",
          "title": "Tools and Techniques",
          "summary": "Using `strace`, `perf`, and logging to inspect epoll events and timer wheel state."
        }
      ]
    },
    {
      "id": "section-10",
      "title": "Future Extensions",
      "summary": "Potential enhancements the architecture can accommodate.",
      "subsections": [
        {
          "id": "subsection-10-1",
          "title": "Multi-threaded Reactor and Protocol Upgrades",
          "summary": "Adding worker threads, supporting WebSockets, or integrating TLS."
        }
      ]
    },
    {
      "id": "section-11",
      "title": "Glossary",
      "summary": "Definitions of key terms like epoll, Reactor pattern, non-blocking I/O, and timer wheel.",
      "subsections": [
        {
          "id": "subsection-11-1",
          "title": "Terminology Table",
          "summary": "Alphabetical list of terms with definitions and references to where they are first explained."
        }
      ]
    }
  ],
  "diagrams": [
    {
      "id": "diagram-1",
      "title": "System Component Overview",
      "description": "Shows the main components: Event Loop (with epoll fd), Timer Wheel, Async Task Queue, and HTTP Handler. Arrows indicate data flow and callbacks.",
      "type": "component",
      "relevant_sections": [
        "section-3",
        "section-5"
      ]
    },
    {
      "id": "diagram-2",
      "title": "Event Loop State Machine",
      "description": "A state machine for a TCP connection within the event loop: Listening -> Accepted -> Reading -> Writing -> Closing. Includes transitions for timeouts and read/write events.",
      "type": "state-machine",
      "relevant_sections": [
        "subsection-5-1",
        "section-6"
      ]
    },
    {
      "id": "diagram-3",
      "title": "Hierarchical Timer Wheel Data Structure",
      "description": "Visual representation of the timer wheel with multiple levels (e.g., 64ms, 4s, 4min slots). Shows timer entries chained in slots and the cascade operation.",
      "type": "class",
      "relevant_sections": [
        "subsection-5-2",
        "section-4"
      ]
    },
    {
      "id": "diagram-4",
      "title": "Sequence Diagram: Event Loop Tick",
      "description": "Sequence of actions in one loop iteration: epoll_wait returns events, process read callbacks, process write callbacks, tick timer wheel, execute deferred tasks.",
      "type": "sequence",
      "relevant_sections": [
        "subsection-5-1",
        "subsection-5-3",
        "section-6"
      ]
    },
    {
      "id": "diagram-5",
      "title": "HTTP Request Handling Flowchart",
      "description": "Flowchart for incremental HTTP parsing on a non-blocking socket. Steps: read available data -> feed parser -> check if header complete -> generate response -> register for EPOLLOUT if write buffer full.",
      "type": "flowchart",
      "relevant_sections": [
        "subsection-5-4",
        "section-6"
      ]
    }
  ]
}