direction: right

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 300
  }
}

Entity Management: {
  entity_id: Entity ID {
    shape: class
    id: u32
    generation: u16
    index: u16
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  entity_manager: Entity Manager {
    free_list: Vec<u32>
    generations: Vec<u16>
    alive_count: usize
    
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  entity_manager -> entity_id: creates/validates
}

Component Storage: {
  transform_array: Transform Components {
    shape: sql_table
    entity_id: u32
    position: Vec3
    rotation: Quat
    scale: Vec3
    
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  render_array: Render Components {
    shape: sql_table
    entity_id: u32
    mesh: MeshHandle
    material: MaterialHandle
    visible: bool
    
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  physics_array: Physics Components {
    shape: sql_table
    entity_id: u32
    velocity: Vec3
    mass: f32
    collision_shape: CollisionShape
    
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  component_manager: Component Manager {
    type_map: HashMap<TypeId>
    sparse_sets: Vec<SparseSet>
    
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  component_manager -> transform_array: manages
  component_manager -> render_array: manages
  component_manager -> physics_array: manages
}

System Queries: {
  render_system: Render System {
    query: Query<Transform, Render>
    
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  physics_system: Physics System {
    query: Query<Transform, Physics>
    
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  archetype: Archetype {
    signature: ComponentSet
    entities: Vec<EntityId>
    chunks: Vec<ChunkPtr>
    
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  render_system -> archetype: queries matching
  physics_system -> archetype: queries matching
}

Entity Management.entity_manager -> Component Storage.component_manager: entity lifecycle

Component Storage.transform_array -> System Queries.archetype: indexed by
Component Storage.render_array -> System Queries.archetype: indexed by
Component Storage.physics_array -> System Queries.archetype: indexed by

System Queries.render_system -> Component Storage.transform_array: reads {style.stroke: "#8b949e"}
System Queries.render_system -> Component Storage.render_array: reads {style.stroke: "#8b949e"}

System Queries.physics_system -> Component Storage.transform_array: writes {style.stroke: "#d63031"}
System Queries.physics_system -> Component Storage.physics_array: reads {style.stroke: "#8b949e"}
