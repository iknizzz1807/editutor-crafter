global_environment: Global Environment {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  outer: null {
    style.stroke: "#8b949e"
    style.stroke-dash: 3
  }
  
  variables: {
    x: 10
    closure_func: function_ref
  }
}

definition_environment: Function Definition Environment {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  outer: Global Environment {
    style.stroke: "#8b949e"
  }
  
  variables: {
    captured: "value"
    function_code: closure_func
  }
}

call_environment: Function Call Environment {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  outer: Function Definition Environment {
    style.stroke: "#8b949e"
  }
  
  variables: {
    local_param: 5
    temp: result
  }
}

closure_object: {
  shape: package
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  label: "Closure Object"
  
  code: Function AST
  env: Captured Definition Environment {
    style.bold: true
    style.font-color: "#3fb950"
  }
}

# Connections
global_environment.outer -> null
definition_environment.outer -> global_environment
call_environment.outer -> definition_environment

closure_object.env -> definition_environment: "captures at definition" {
  style.stroke: "#3fb950"
  style.stroke-dash: 2
}

closure_object -> global_environment.variables.closure_func: "bound to variable"

# Annotations
note: |md
  ### Closure Mechanism
  1. **Definition Environment** is created when function is declared
  2. **Closure object** captures this environment
  3. **Call Environment** uses captured environment as parent
| {
  shape: page
  style.fill: "#16213e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

# Chain visualization arrows
chain: {
  style.stroke: "#8b949e"
  style.stroke-dash: 2
}

chain_start: {
  shape: circle
  style.fill: "#3fb950"
  width: 10
  height: 10
}

chain_end: {
  shape: circle
  style.fill: "#3fb950"
  width: 10
  height: 10
}

chain_start -> call_environment: "parent chain"
call_environment -> definition_environment: "parent chain"
definition_environment -> global_environment: "parent chain"
global_environment -> chain_end: "parent chain"