direction: down

title: Executable Memory Layout {
  near: top-center
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
}

# Operating System Memory Management
os_memory: Operating System Memory {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  heap: Heap Memory {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    
    vm_objects: VM Objects
    bytecode: Bytecode Storage {
      shape: page
    }
  }
  
  executable: Executable Memory {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
    
    code_cache: Code Cache {
      style.stroke: "#3fb950"
    }
    trampolines: Trampoline Functions {
      style.stroke: "#3fb950"
    }
  }
}

# JIT Compiler Components
jit_system: JIT Compiler System {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  compiler: Machine Code Emitter {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.bold: true
  }
  
  address_map: Address Translation Map {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    shape: sql_table
  }
}

# Code Buffer Management
code_buffer: Code Buffer Structure {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  header: Buffer Header {
    metadata: Function Metadata
    entry_point: Entry Point Address {
      style.stroke: "#3fb950"
    }
  }
  
  prologue: Function Prologue {
    stack_setup: Stack Frame Setup
    reg_save: Register Preservation
  }
  
  body: Native Instructions {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.bold: true
    x86_code: x86-64 Machine Code
  }
  
  epilogue: Function Epilogue {
    reg_restore: Register Restoration  
    stack_cleanup: Stack Cleanup
  }
}

# Memory Protection States
protection: Memory Protection (W^X) {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  write_phase: Write Phase {
    style.fill: "#d63031"
    style.font-color: "#ffffff"
    writable: "PROT_WRITE"
  }
  
  exec_phase: Execute Phase {
    style.fill: "#00b894"
    style.font-color: "#ffffff"  
    executable: "PROT_EXEC"
  }
}

# Connections - Compilation Flow
os_memory.heap.bytecode -> jit_system.compiler: bytecode input
jit_system.compiler -> code_buffer.body: emit instructions
code_buffer -> os_memory.executable.code_cache: allocate buffer

# Address Translation
os_memory.heap.bytecode <-> jit_system.address_map: bytecode addresses
os_memory.executable.code_cache <-> jit_system.address_map: native addresses

# Memory Protection Flow  
protection.write_phase -> code_buffer: generate code
code_buffer -> protection.exec_phase: mprotect() call
protection.exec_phase -> os_memory.executable: execute native code

# Runtime Execution
os_memory.executable.trampolines -> os_memory.heap.vm_objects: interpreter callbacks
os_memory.executable.code_cache -> os_memory.executable.trampolines: function calls