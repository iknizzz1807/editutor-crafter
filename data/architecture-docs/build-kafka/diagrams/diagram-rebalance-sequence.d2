shape: sequence_diagram
title: Consumer Group Rebalance Sequence

GroupCoordinator: Group Coordinator {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
}

Consumer1: Consumer 1 {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

Consumer2: Consumer 2 {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

Broker: Kafka Broker {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Initial state - Consumer 1 is already in group
Consumer1 -> GroupCoordinator: Heartbeat (regular)
GroupCoordinator -> Consumer1: Heartbeat ACK

# Consumer 2 joins
Consumer2 -> GroupCoordinator: JoinGroup Request
note: |md
  **New member joins**
  Consumer 2 sends JoinGroup request
  with member.id = null (new member)
| {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

GroupCoordinator -> GroupCoordinator: Detects new member
GroupCoordinator -> Consumer1: Heartbeat Response (REBALANCE_IN_PROGRESS)
note: |md
  **Rebalance triggered**
  Coordinator tells all existing members
  to rejoin the group
| {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# All members rejoin
Consumer1 -> GroupCoordinator: JoinGroup Request (rejoin)
Consumer2 -> GroupCoordinator: JoinGroup Request

GroupCoordinator -> GroupCoordinator: |md
  **Collects JoinGroup responses**
  - Elects group leader (Consumer 1)
  - Collects partition assignments
  from leader member
| {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

GroupCoordinator -> Consumer1: JoinGroup Response (as leader)
GroupCoordinator -> Consumer2: JoinGroup Response (as follower)

# Leader sends assignment
Consumer1 -> GroupCoordinator: SyncGroup Request (with assignments)
GroupCoordinator -> GroupCoordinator: Collects assignments

# New assignments distributed
GroupCoordinator -> Consumer1: SyncGroup Response (new assignment)
GroupCoordinator -> Consumer2: SyncGroup Response (new assignment)

note: |md
  **Assignment complete**
  Both consumers acknowledge
  and start fetching from
  their assigned partitions
| {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Consumers start fetching
Consumer1 -> Broker: Fetch (from assigned partitions)
Consumer2 -> Broker: Fetch (from assigned partitions)

Broker -> Consumer1: Fetch Response (messages)
Broker -> Consumer2: Fetch Response (messages)

# Regular operation resumes
Consumer1 -> GroupCoordinator: Heartbeat
Consumer2 -> GroupCoordinator: Heartbeat
GroupCoordinator -> Consumer1: Heartbeat ACK
GroupCoordinator -> Consumer2: Heartbeat ACK