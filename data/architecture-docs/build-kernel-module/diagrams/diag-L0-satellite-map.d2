direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 3
  }
}

# ─── USER SPACE (RING 3) ─────────────────────────────────────────────
userspace: {
  label: "User Space (Ring 3) — Isolated Contexts"
  direction: right

  app: {
    shape: class
    label: "test_mydevice.c (Milestone 3/4)"
    methods: |'c
      int fd = open("/dev/mydevice", O_RDWR);
      ioctl(fd, MYDEV_STATUS, &status);
      poll(&pfd, 1, 5000);
      write(fd, "hello", 5);
    '|
  }

  cli: {
    label: "Shell Utilities (Milestone 1/2)"
    echo: "echo 'data' > /dev/mydevice"
    cat: "cat /proc/mydevice"
    modinfo: "modinfo mydevice.ko"
  }

  filesystem_view: {
    label: "VFS Virtual Nodes"
    dev_node: "/dev/mydevice (C 240:0)" {style.fill: "#C7F1FF"}
    proc_node: "/proc/mydevice" {style.fill: "#E4DBFE"}
    sys_node: "/sys/module/mydevice/parameters" {style.fill: "#DEE1EB"}
  }
}

# ─── THE BOUNDARY (SYSCALL INTERFACE) ───────────────────────────────
boundary: {
  label: "Kernel/Userspace Boundary (Exception Table Guarded)"
  style.stroke-dash: 5
  
  copy_ops: {
    shape: class
    label: "uaccess.h (Milestone 2)"
    methods: |'c
      unsigned long copy_from_user(void *to, const void __user *from, unsigned long n);
      unsigned long copy_to_user(void __user *to, const void *from, unsigned long n);
    '|
  }
}

# ─── KERNEL SPACE (RING 0) ──────────────────────────────────────────
kernelspace: {
  label: "Kernel Space (Ring 0) — Privileged Execution"
  direction: right

  driver_core: {
    label: "mydevice.ko (Driver Logic)"
    
    fops: {
      shape: sql_table
      label: "struct file_operations (mydevice.c)"
      o: ".owner          = THIS_MODULE"
      r: ".read           = mydev_read"
      w: ".write          = mydev_write"
      i: ".unlocked_ioctl = mydev_ioctl"
      p: ".poll           = mydev_poll"
    }

    ioctl_logic: {
      shape: class
      label: "Control Plane (M3)"
      code: |'c
        switch(cmd) {
          case MYDEV_RESIZE: kzalloc(new);
          case MYDEV_STATUS: copy_to_user();
          case MYDEV_CLEAR:  memset(0);
        }
      '|
    }
  }

  state_mgmt: {
    label: "Device State & Memory"
    
    mem_buffer: {
      shape: sql_table
      label: "Internal State (M2/M4)"
      f0: "0x00 | char*  | kernel_buffer (kmalloc)"
      f1: "0x08 | size_t | buffer_size_bytes"
      f2: "0x10 | size_t | buffer_used"
      f3: "0x18 | atomic | read_count"
      sz: "Total: ~32 bytes + Heap Buffer"
    }

    sync_primitives: {
      label: "Concurrency (M4)"
      mutex: "struct mutex dev_mutex" {style.fill: "#FE7070"}
      read_q: "wait_queue_head_t read_queue" {style.fill: "#A7CC9E"}
      write_q: "wait_queue_head_t write_queue" {style.fill: "#A7CC9E"}
    }
  }

  proc_subsystem: {
    shape: class
    label: "seq_file (M3)"
    methods: |'c
      static int mydev_proc_show(struct seq_file *m, void *v) {
        seq_printf(m, "used: %zu\n", buffer_used);
      }
    '|
  }
}

# ─── SHARED CONTRACT ────────────────────────────────────────────────
shared_header: {
  shape: sql_table
  label: "mydevice_ioctl.h (ABI Contract)"
  row1: "0x00 | __u32 | buffer_size"
  row2: "0x04 | __u32 | bytes_used"
  row3: "0x08 | __u32 | open_count"
  row4: "0x0C | __u32 | read_count"
  row5: "0x10 | __u32 | write_count"
  row6: "0x14 | __u32 | _reserved"
  total: "Size: 24 bytes"
  near: top-right
}

# ─── CONNECTIONS (DATA & CONTROL FLOW) ──────────────────────────────

userspace.app -> userspace.filesystem_view.dev_node: "open/read/write/ioctl"
userspace.cli -> userspace.filesystem_view.proc_node: "cat /proc"

userspace.filesystem_view.dev_node -> kernelspace.driver_core.fops: "VFS Lookup | major 240 | dispatch"
kernelspace.driver_core.fops -> boundary.copy_ops: "uaccess calls | - | copy_to_user"

boundary.copy_ops -> userspace.app: "Data Return | N bytes | struct mydev_status"
boundary.copy_ops -> kernelspace.state_mgmt.mem_buffer: "Data Input | N bytes | char*"

kernelspace.driver_core.ioctl_logic -> kernelspace.state_mgmt.mem_buffer: "Modify State | - | buffer_size"
kernelspace.state_mgmt.mem_buffer <-> kernelspace.state_mgmt.sync_primitives.mutex: "Serialization | 1 CPU | lock/unlock"

kernelspace.driver_core.fops -> kernelspace.state_mgmt.sync_primitives.read_q: "Sleep/Wake | - | wait_event"
kernelspace.proc_subsystem -> userspace.filesystem_view.proc_node: "Human-readable Text | 4KB Page | seq_printf"

# ─── LEGEND ──────────────────────────────────────────────────────────
legend: {
  near: bottom-right
  m1: "Milestone 1: Lifecycle" {style.fill: "#DEE1EB"}
  m2: "Milestone 2: Char Dev" {style.fill: "#C7F1FF"}
  m3: "Milestone 3: ioctl/proc" {style.fill: "#E4DBFE"}
  m4: "Milestone 4: Concurrency" {style.fill: "#A7CC9E"}
}