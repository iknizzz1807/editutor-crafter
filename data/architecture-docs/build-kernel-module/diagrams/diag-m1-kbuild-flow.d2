direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- STAGE 1: USER WORKSPACE ---
workspace: {
  label: "User Workspace ($PWD)"
  direction: down
  style: {
    fill: "#f8f9fa"
    stroke: "#dee2e6"
    stroke-width: 2
  }

  source_file: {
    shape: document
    label: "hello.c (Source)"
    code: |'c
      #include <linux/module.h>
      static int __init hello_init(void) {
          pr_info("Hello Kernel\n");
          return 0;
      }
      module_init(hello_init);
    '|
  }

  local_makefile: {
    shape: code
    label: "Makefile (Out-of-tree)"
    code: |'makefile
      obj-m += hello.o
      KDIR := /lib/modules/$(shell uname -r)/build
      all:
          $(MAKE) -C $(KDIR) M=$(PWD) modules
    '|
  }
}

# --- STAGE 2: KBUILD INFRASTRUCTURE ---
kbuild_system: {
  label: "Kernel Build System (Kbuild)"
  direction: down
  style: {
    fill: "#e7f5ff"
    stroke: "#74c0fc"
    stroke-width: 2
  }

  kernel_headers: {
    shape: package
    label: "/lib/modules/$(uname -r)/build"
    content: |'text
      include/linux/*.h (Headers)
      scripts/Makefile.build (Rules)
      .config (Kernel Options)
    '|
  }

  compiler_logic: {
    shape: code
    label: "GCC Kernel CFLAGS"
    code: |'bash
      -mno-red-zone        # No stack-frame optimization
      -mcmodel=kernel      # Address space constraints
      -fno-stack-protector # Avoid userspace libs
      -ffreestanding       # No standard library
    '|
  }
}

# --- STAGE 3: INTERMEDIATE PROCESSING ---
intermediates: {
  label: "Intermediate Artifacts"
  direction: down
  style: {
    fill: "#fff4e6"
    stroke: "#ffa94d"
    stroke-width: 2
  }

  object_file: {
    shape: circle
    label: "hello.o"
  }

  modpost_tool: {
    shape: step
    label: "scripts/mod/modpost"
  }

  metadata_source: {
    shape: document
    label: "hello.mod.c"
  }

  object_file -> modpost_tool: "ELF Object | 40KB | hello.o"
  modpost_tool -> metadata_source: "C Source | 5KB | hello.mod.c"
}

# --- STAGE 4: FINAL LINKING ---
final_output: {
  label: "Final Build Product"
  style: {
    fill: "#fff"
    stroke: "#2f9e44"
    stroke-width: 2
  }
  
  hello_ko: {
    shape: sql_table
    label: "hello.ko (ELF Relocatable)"
    row1: "0x00 | ELF Header | Module Metadata"
    row2: "0x40 | .text      | Init/Exit code"
    row3: "0x500| .modinfo   | License, Vermagic"
    row4: "0x600| __ksymtab  | Exported Symbols"
    row5: "0x800| .rela.text | Relocation Fixups"
    sz: "Total: ~45KB (Target Binary)"
  }
}

# --- STAGE 5: RUNTIME ---
kernel_runtime: {
  label: "Linux Kernel Memory"
  style: {
    fill: "#f3f0ff"
    stroke: "#845ef7"
    stroke-width: 2
  }
  
  module_loader: {
    shape: class
    label: "Kernel Module Loader (kernel/module.c)"
    methods: |'c
      int load_module(struct load_info *info);
      int apply_relocations(struct module *mod);
      int post_relocation(struct module *mod);
    '|
  }
}

# --- CONNECTIONS (IMPLEMENTATION-READY) ---

workspace.local_makefile -> kbuild_system: "Control | - | make -C KDIR"
workspace.source_file -> intermediates.object_file: "C Code | 2KB | hello.c"
kbuild_system.compiler_logic -> intermediates.object_file: "Flags | - | -mcmodel=kernel"

intermediates.object_file -> final_output.hello_ko: "ELF Object | 40KB | ld -r"
intermediates.metadata_source -> final_output.hello_ko: "C Object | 5KB | hello.mod.o"

final_output.hello_ko -> kernel_runtime.module_loader: "Binary | 45KB | sys_finit_module()"