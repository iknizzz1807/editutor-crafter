direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- SOURCE LAYER ---
source_layer: {
  label: "Source Implementation (hello.c)"
  direction: down

  macro_usage: {
    label: "Module Metadata Macros"
    code: |'c
      MODULE_LICENSE("GPL");
      MODULE_AUTHOR("Engineer");
      MODULE_DESCRIPTION("LKM M1");
    '|
  }

  expansion_logic: {
    label: "C Preprocessor / Compiler Expansion"
    code: |'c
      static const char __mod_lic[]
        __attribute__((section(".modinfo"), used))
        = "license=GPL";
    '|
  }
  macro_usage -> expansion_logic: "C Macro | N/A | expansion"
}

# --- BINARY LAYER ---
binary_layer: {
  label: "Binary Object (hello.ko)"
  direction: down

  elf_structure: {
    shape: sql_table
    label: "ELF64 Layout"
    h: "0x00 | Elf64_Ehdr | ELF Header"
    s1: "0x40 | .text      | Machine Instructions"
    s2: ".... | .data       | Initialized Globals"
    modinfo_sec: "0x1A0 | .modinfo   | Metadata Strings"
    s4: ".... | .symtab     | Symbol Table"
    total: "Total Size: 16.4 KB"
  }

  modinfo_content: {
    shape: sql_table
    label: "Section: .modinfo (Null-Terminated Strings)"
    r0: "0x00 | 'license=GPL\\0'"
    r1: "0x0C | 'author=Engineer\\0'"
    r2: "0x1C | 'description=LKM M1\\0'"
    r3: "0x2F | 'vermagic=6.8.0-47-generic...'"
    padding: "0x.. | [Padding to 8-byte boundary]"
  }

  elf_structure.modinfo_sec -> modinfo_content: "Section Link | 128 bytes | .modinfo"
}

# --- KERNEL LAYER ---
kernel_layer: {
  label: "Linux Kernel Loader (kernel/module/main.c)"
  direction: down

  loader_logic: {
    shape: class
    label: "module_loader"
    fields: |'c
      struct module *mod;
      unsigned int taint_mask;
    '|
    methods: |'c
      int load_module(void *data);
      void check_modinfo(struct module *mod);
      int resolve_symbols(struct module *mod);
    '|
  }

  taint_gate: {
    shape: diamond
    label: "Is License GPL?"
  }

  taint_active: {
    label: "Kernel Tainted"
    style: {
      fill: "#ffcccc"
      stroke: red
    }
    tooltip: "TAINT_PROPRIETARY_MODULE"
  }

  symbol_resolver: {
    label: "Symbol Resolver"
    code: |'c
      if (sym->is_gpl_only && !mod->gpl_compatible) {
          pr_err("Symbol %s is GPL-only\n", name);
          return -EACCES;
      }
    '|
  }
}

# --- USER TOOL LAYER ---
user_tools: {
  label: "Userspace Utility"
  modinfo_bin: {
    label: "modinfo hello.ko"
    code: |'bash
      license:     GPL
      author:      Engineer
      description: LKM M1
      vermagic:    6.8.0-47-generic
    '|
  }
}

# --- CONNECTIONS ---
source_layer.expansion_logic -> binary_layer.elf_structure: "ld | ~16KB | .modinfo section"

binary_layer.modinfo_content -> kernel_layer.loader_logic: "finit_module() | buf_ptr | ELF Stream"

kernel_layer.loader_logic -> kernel_layer.taint_gate: "Parse .modinfo | 12 bytes | 'license=GPL'"

kernel_layer.taint_gate -> kernel_layer.symbol_resolver: "Yes | bool | gpl_compatible = true" {
  style.stroke: green
}

kernel_layer.taint_gate -> kernel_layer.taint_active: "No | enum | TAINT_P" {
  style.stroke: red
  style.stroke-dash: 4
}

kernel_layer.taint_active -> kernel_layer.symbol_resolver: "Restrict | bitmask | EXPORT_SYMBOL_GPL blocked" {
  style.stroke: red
}

binary_layer.modinfo_content -> user_tools.modinfo_bin: "libelf | string_table | k:v pairs"

# Legend
legend: {
  shape: sql_table
  label: "Color Semantics"
  r1: "Blue   | Standard Data Flow"
  r2: "Red    | Taint / Access Restriction"
  r3: "Purple | Metadata Handling"
}
legend.near: bottom-right