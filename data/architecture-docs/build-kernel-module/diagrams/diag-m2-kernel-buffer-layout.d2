direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- Internal Device State Struct ---
device_struct: {
  shape: sql_table
  label: "struct my_device (mydevice.c)"
  f0: "0x00 | char*     | kernel_buffer     // Points to SLAB memory"
  f1: "0x08 | size_t    | buffer_size_bytes // Capacity: 4096"
  f2: "0x10 | size_t    | buffer_used       // Current data length"
  f3: "0x18 | atomic_t  | open_count        // Ref counter"
  f4: "0x1C | [4 bytes] | padding           // Alignment padding"
  sz: "Total: 32 bytes"
}

# --- The Allocator Logic ---
allocation_logic: {
  label: "Memory Allocation Path"
  direction: down
  
  call_kzalloc: {
    label: "kzalloc(4096, GFP_KERNEL)"
    code: |'c
      // GFP_KERNEL: Can sleep, can reclaim.
      // kzalloc: kmalloc + memset(0).
      kernel_buffer = kzalloc(4096, GFP_KERNEL);
      if (!kernel_buffer)
          return -ENOMEM;
    '|
  }

  gfp_annotation: {
    label: "GFP_KERNEL Semantic"
    content: |'md
      - **Can Sleep**: May block if memory is tight.
      - **Context**: Must be in process context (init/syscall).
      - **Zones**: Access to all memory zones.
    '|
  }

  slab_cache: {
    shape: package
    label: "SLUB Allocator (kmalloc-4096 cache)"
    
    slab_obj: "4KB Object Slot" {
      style.fill: "#E4DBFE"
    }
  }
}

# --- Physical Memory Layout ---
kernel_memory_layout: {
  label: "Kernel Virtual Address Space (Direct Map)"
  
  buffer_page: {
    direction: right
    label: "4096 Bytes (1 Physical Page)"
    style.stroke-width: 2

    used_data: "Data Content (buffer_used bytes)" {
      style.fill: "#C7F1FF"
      width: 200
    }
    
    unused_gap: "Unused Capacity" {
      style.fill: "#DEE1EB"
      style.stroke-dash: 3
      width: 150
    }
  }
}

# --- Error Path ---
error_handler: {
  shape: callout
  label: "Failure Path"
  content: "If kmalloc returns NULL, init fails and returns -ENOMEM to insmod."
  style.stroke: red
}

# --- Connections and Data Flow ---
allocation_logic.call_kzalloc -> allocation_logic.slab_cache: "size_t | 8 bytes | 4096"
allocation_logic.slab_cache -> kernel_memory_layout.buffer_page: "Map | 4KB | Physically Contiguous"

device_struct.f0 -> kernel_memory_layout.buffer_page: "void* | 8 bytes | 0xFFFF8880..."
device_struct.f2 -> kernel_memory_layout.buffer_page.used_data: "size_t | 8 bytes | Tracks Offset"

allocation_logic.call_kzalloc -> error_handler: "Status | 8 bytes | NULL" {
  style.stroke-dash: 4
}

# Legend placed at root using constant near
legend: {
  shape: package
  label: "Legend"
  red: "Error / Fail" { style.stroke: red }
  blue: "Data / Pointers" { style.stroke: "#88DCF7" }
}
legend.near: bottom-right