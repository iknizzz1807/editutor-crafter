direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 3
  }
}

# --- LAYERS ---

userspace: {
  label: "USERSPACE (Ring 3)"
  direction: down
  
  shell: {
    shape: class
    label: "Process: bash (PID: 1234)"
    definition: |'c
      // echo "hello" > /dev/mydevice
      int fd = open("/dev/mydevice", O_WRONLY);
      write(fd, "hello\n", 6);
    '|
  }

  user_mem: {
    shape: sql_table
    label: "Process Stack/Heap"
    row1: "0x7fff1234 | char[6] | \"hello\\n\""
    row2: "0x7fff123a | padding | 0x00"
  }
}

cpu_gateway: {
  label: "CPU BOUNDARY"
  style.stroke-dash: 5
  
  registers: {
    shape: sql_table
    label: "Register State (x86_64)"
    rax: "RAX | 1 | syscall_nr (write)"
    rdi: "RDI | 3 | file_descriptor (fd)"
    rsi: "RSI | 0x7fff1234 | *buf_ptr"
    rdx: "RDX | 6 | count_bytes"
    rip: "RIP | 0xffffffff... | entry_SYSCALL_64"
  }
}

kernel_vfs: {
  label: "KERNEL VFS (Ring 0)"
  direction: down

  sys_call_table: {
    shape: sql_table
    label: "sys_call_table[] (arch/x86/entry/syscall_64.c)"
    entry1: "1 | void* | sys_write"
  }

  struct_file: {
    shape: sql_table
    label: "struct file (include/linux/fs.h)"
    f0: "0x00 | struct file_operations* | f_op"
    f1: "0x08 | loff_t                   | f_pos"
    f2: "0x10 | fmode_t                  | f_mode"
    f3: "0x18 | void*                    | private_data"
  }
}

driver_logic: {
  label: "DRIVER: mydevice.ko"
  direction: down

  fops: {
    shape: sql_table
    label: "struct file_operations (mydevice.c)"
    o: "0x00 | struct module* | .owner = THIS_MODULE"
    r: "0x18 | ssize_t (*)()  | .read  = mydev_read"
    w: "0x20 | ssize_t (*)()  | .write = mydev_write"
  }

  handler: {
    label: "mydev_write (mydevice.c)"
    width: 380
    code: |'c
      ssize_t mydev_write(struct file *filp, const char __user *buf, 
                          size_t count, loff_t *f_pos) {
        // Trap-and-recover exception handler setup
        res = copy_from_user(kernel_buffer + buffer_used, buf, count);
        if (res != 0) return -EFAULT;
        buffer_used += count;
        return count;
      }
    '|
  }
}

physical_mem: {
  label: "PHYSICAL RAM / SLAB"
  
  kbuf: {
    shape: cylinder
    label: "kernel_buffer (kmalloc'd)"
    content: "['h','e','l','l','o','\\n']"
    size: "4096 bytes"
  }
}

# --- DATA FLOW ---

userspace.shell -> cpu_gateway.registers: "SYSCALL | 0 bytes | CPU Interrupt"
cpu_gateway.registers -> kernel_vfs.sys_call_table: "Dispatch | 8 bytes | sys_write" {
  style.stroke: blue
}

kernel_vfs.sys_call_table -> kernel_vfs.struct_file: "Lookup fd | 4 bytes | current->files[3]"
kernel_vfs.struct_file:f0 -> driver_logic.fops: "VTable Pointer | 8 bytes | &mydev_fops" {
  style.stroke: purple
}

driver_logic.fops:w -> driver_logic.handler: "Indirect Call | 0 bytes | f_op->write()"

userspace.user_mem -> driver_logic.handler: "User Pointer | 6 bytes | 0x7fff1234" {
  style.stroke: red
  style.stroke-width: 2
}

driver_logic.handler -> physical_mem.kbuf: "copy_from_user() | 6 bytes | safe_memcpy" {
  style.stroke: red
  style.stroke-width: 4
}

# --- RETURN PATH ---

driver_logic.handler -> cpu_gateway.registers: "return count | 8 bytes | RAX=6" {
  style.stroke-dash: 3
}

cpu_gateway.registers -> userspace.shell: "SYSRET | 8 bytes | return 6" {
  style.stroke-dash: 3
}

# --- LEGEND ---
legend: {
  shape: sql_table
  near: bottom-right
  path: "Red Path | High Privilege Memory Copy"
  control: "Purple Path | Function Dispatch (vtable)"
  flow: "Blue Path | Syscall Routing"
}