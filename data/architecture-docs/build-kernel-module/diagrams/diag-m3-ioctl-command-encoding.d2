direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ──────────────────────────────────────────────────────────────────────
# 1. 32-BIT ENCODING LAYOUT
# ──────────────────────────────────────────────────────────────────────
ioctl_layout: {
  shape: sql_table
  label: "ioctl Command Number (asm-generic/ioctl.h)"
  
  header: "Bits | Field | Description | Constraints"
  f1: "31:30 | DIR | Data Direction | 2 bits (None, R, W, R+W)"
  f2: "29:16 | SIZE | Argument Size | 14 bits (sizeof(type), Max 16KB)"
  f3: "15:08 | TYPE | Magic/Type | 8 bits (Unique ASCII or Hex)"
  f4: "07:00 | NR | Sequence NR | 8 bits (Command Index 0-255)"
  
  footer: "Total: 32 bits (unsigned int)"
}

# ──────────────────────────────────────────────────────────────────────
# 2. DIRECTION BITMAP (DIR)
# ──────────────────────────────────────────────────────────────────────
dir_lookup: {
  shape: sql_table
  label: "Direction Encoding (DIR)"
  
  v0: "00 | _IOC_NONE | No data transfer (simple trigger)"
  v1: "01 | _IOC_WRITE | User -> Kernel (Input)"
  v2: "10 | _IOC_READ | Kernel -> User (Output)"
  v3: "11 | _IOC_READ|_IOC_WRITE | Bidirectional"
}

# ──────────────────────────────────────────────────────────────────────
# 3. MACRO DEFINITIONS (C API)
# ──────────────────────────────────────────────────────────────────────
macros: {
  label: "Kernel Command Macros"
  code: |'c
    #define _IO(type,nr)          _IOC(_IOC_NONE,(type),(nr),0)
    #define _IOR(type,nr,size)    _IOC(_IOC_READ,(type),(nr),sizeof(size))
    #define _IOW(type,nr,size)    _IOC(_IOC_WRITE,(type),(nr),sizeof(size))
    #define _IOWR(type,nr,size)   _IOC(_IOC_READ|_IOC_WRITE,(type),(nr),sizeof(size))
  '|
}

# ──────────────────────────────────────────────────────────────────────
# 4. CONCRETE EXAMPLES (CALCULATION)
# ──────────────────────────────────────────────────────────────────────
examples: {
  direction: down
  
  iow_ex: {
    label: "Example: _IOW('M', 1, __u32)"
    calculation: |'md
      - DIR  (01) << 30  = 0x40000000
      - SIZE (04) << 16  = 0x00040000
      - TYPE (4D) << 08  = 0x00004D00
      - NR   (01) << 00  = 0x00000001
      -------------------------------
      Result HEX: 0x40044D01
    '|
  }

  ior_ex: {
    label: "Example: _IOR('M', 2, struct status)"
    calculation: |'md
      - DIR  (10) << 30  = 0x80000000
      - SIZE (18) << 16  = 0x00180000  (24 bytes)
      - TYPE (4D) << 08  = 0x00004D00
      - NR   (02) << 00  = 0x00000002
      -------------------------------
      Result HEX: 0x80184D02
    '|
  }
}

# ──────────────────────────────────────────────────────────────────────
# 5. ANNOTATIONS & FLOW
# ──────────────────────────────────────────────────────────────────────

ioctl_layout.f1 -> dir_lookup: "Determines access_ok() check"
macros -> ioctl_layout: "Constructs bitfield"
ioctl_layout -> examples: "Bitfield application"

note_size: {
  label: "Why _IO size = 0?"
  content: "For commands like _IO(M, 0), no pointer is passed. The size field is 0 because sizeof(void) is not used; the kernel treats the 'arg' parameter as a raw scalar value rather than a pointer to be dereferenced."
}

note_size.near: bottom-right