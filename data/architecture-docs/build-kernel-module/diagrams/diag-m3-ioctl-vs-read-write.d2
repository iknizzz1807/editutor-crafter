direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

userspace: "USERSPACE (Ring 3)" {
  app: "Application Context" {
    shape: class
    methods: |'c
      write(fd, "payload", 7);
      ioctl(fd, MYDEV_RESIZE, &new_sz);
      cat /proc/mydevice;
    '|
  }
}

kernel: "KERNEL SPACE (Ring 0)" {
  vfs: "Virtual File System (VFS)" {
    f_op: {
      shape: sql_table
      label: "struct file_operations (fs.h)"
      f1: ".read | ssize_t (*)(struct file*, char __user*, size_t, loff_t*)"
      f2: ".write | ssize_t (*)(struct file*, const char __user*, size_t, loff_t*)"
      f3: ".unlocked_ioctl | long (*)(struct file*, unsigned int, unsigned long)"
    }
  }

  driver: "MyDevice Driver (mydevice.c)" {
    direction: down
    
    data_plane: "DATA PLANE (In-Band)" {
      style.stroke: "#007bff"
      style.fill: "#e7f3ff"
      
      handler: "mydev_write()" {
        shape: code
        code: |'c
          // Process stream of bytes
          copy_from_user(kernel_buf + pos, buf, count);
          buffer_used += count;
        '|
      }
      
      characteristics: {
        shape: sql_table
        label: "Properties"
        p1: "Type | Byte Stream (FIFO/Pipe)"
        p2: "State | Sequential (f_pos)"
        p3: "Unit | buffer_used"
      }
    }

    control_plane: "CONTROL PLANE (Out-of-Band)" {
      style.stroke: "#6f42c1"
      style.fill: "#f3effb"
      
      handler: "mydev_ioctl()" {
        shape: code
        code: |'c
          // Process discrete commands
          switch(cmd) {
            case MYDEV_RESIZE: krealloc(...);
            case MYDEV_CLEAR:  memset(...);
          }
        '|
      }

      encoding: {
        shape: sql_table
        label: "Command Encoding (32-bit)"
        b1: "31:16 | NR   | Sequence Number"
        b2: "15:08 | TYPE | Magic Number ('M')"
        b3: "13:02 | SIZE | sizeof(arg_type)"
        b4: "01:00 | DIR  | _IOC_READ / _IOC_WRITE"
      }
    }
  }

  storage: "Device Memory" {
    state: {
      shape: sql_table
      label: "Internal State"
      s1: "0x00 | char*  | kernel_buffer (Data)"
      s2: "0x08 | size_t | buffer_size   (Metadata)"
      s3: "0x10 | size_t | buffer_used   (Metadata)"
    }
  }
}

parallels: "Industry Parallels" {
  near: bottom-right
  tcp: "TCP: Stream (payload) vs. Options (window/MSS)"
  http: "HTTP: Body (data) vs. Headers (metadata)"
  serial: "UART: TX/RX (bytes) vs. Termios (baud/parity)"
}

# Connections
userspace.app -> kernel.vfs.f_op.f2: "DATA | size_t | 64 bytes" {
  style.stroke: "#007bff"
  style.animated: true
}
userspace.app -> kernel.vfs.f_op.f3: "CONTROL | uint32_t | 0x40044D01" {
  style.stroke: "#6f42c1"
  style.animated: true
}

kernel.vfs.f_op.f2 -> kernel.driver.data_plane.handler: "dispatch"
kernel.vfs.f_op.f3 -> kernel.driver.control_plane.handler: "dispatch"

kernel.driver.data_plane.handler -> kernel.storage.state.s1: "modify content" {
  style.stroke: "#007bff"
}
kernel.driver.control_plane.handler -> kernel.storage.state.s2: "modify structure" {
  style.stroke: "#6f42c1"
}

# Annotation container
note: "Architectural Separation" {
  shape: callout
  label: "The ioctl channel allows device reconfiguration without interrupting or polluting the raw data stream."
}
note.near: top-right