direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- CENTRAL ABI CONTRACT ---
shared_header: {
  label: "mydevice_ioctl.h (ABI Definition)"
  direction: down
  
  logic_guards: {
    label: "Kernel/User Logic Guards"
    width: 320
    code: |'c
      #ifdef __KERNEL__
        #include <linux/ioctl.h>
        #include <linux/types.h>
      #else
        #include <sys/ioctl.h>
        #include <stdint.h>
        typedef uint32_t __u32;
      #endif
    '|
  }

  magic_definitions: {
    label: "IOCTL Magic & Command Encoding"
    width: 320
    code: |'c
      #define MYDEV_MAGIC 'M'
      
      #define MYDEV_RESIZE _IOW(MYDEV_MAGIC, 1, __u32)
      #define MYDEV_STATUS _IOR(MYDEV_MAGIC, 2, struct mydev_status)
    '|
  }

  status_struct: {
    shape: sql_table
    label: "struct mydev_status (Fixed ABI Layout)"
    row1: "0x00 | __u32 | buffer_size"
    row2: "0x04 | __u32 | bytes_used"
    row3: "0x08 | __u32 | open_count"
    row4: "0x0C | __u32 | read_count"
    row5: "0x10 | __u32 | write_count"
    row6: "0x14 | __u32 | _reserved // padding"
    total: "Total: 24 bytes (Arch-Independent)"
  }
}

# --- KERNEL SIDE ---
kernel_space: {
  label: "Kernel World (Ring 0)"
  direction: down
  
  source: {
    label: "mydevice.c"
    width: 350
    code: |'c
      #include "mydevice_ioctl.h"
      
      long mydev_ioctl(struct file *f, 
                       unsigned int cmd, 
                       unsigned long arg) {
        // ABI-Compliant Implementation
      }
    '|
  }

  compiler: {
    label: "Kbuild System"
    icon: https://icons.terrastruct.com/tech/022-server.svg
    tooltip: "Uses Kernel Header Search Paths"
  }
}

# --- USERSPACE SIDE ---
user_space: {
  label: "Userspace World (Ring 3)"
  direction: down

  source: {
    label: "test_app.c"
    width: 350
    code: |'c
      #include "mydevice_ioctl.h"
      
      int main() {
        struct mydev_status s;
        ioctl(fd, MYDEV_STATUS, &s);
      }
    '|
  }

  compiler: {
    label: "Toolchain / GCC"
    icon: https://icons.terrastruct.com/tech/022-server.svg
    tooltip: "Uses standard libc paths"
  }
}

# --- CONNECTIONS ---

# Compile-time header inclusions
kernel_space.source -> shared_header: "Local Include | 0 bytes | #include \"mydevice_ioctl.h\"" {
  style: {
    stroke: "#2196f3"
    stroke-width: 2
  }
}

user_space.source -> shared_header: "Local Include | 0 bytes | #include \"mydevice_ioctl.h\"" {
  style: {
    stroke: "#2196f3"
    stroke-width: 2
  }
}

# ABI constraints on binary layout
shared_header.status_struct -> kernel_space.compiler: "ABI Layout | 24 bytes | struct offset mapping" {
  style: {
    stroke: "#9c27b0"
  }
}
shared_header.status_struct -> user_space.compiler: "ABI Layout | 24 bytes | struct offset mapping" {
  style: {
    stroke: "#9c27b0"
  }
}

# Runtime execution path
user_space.source -> kernel_space.source: "ioctl syscall | 32-bit CMD | cmd=0x80184d02" {
  style: {
    stroke: "#f44336"
    stroke-width: 3
    animated: true
  }
}

# --- ANNOTATIONS & LEGEND ---
abi_warning: {
  label: "ABI STABILITY RULE"
  shape: callout
  tooltip: "Changing this layout requires recompiling BOTH kernel and userspace."
  style: {
    fill: "#ffeb3b"
    stroke: "#fbc02d"
  }
}
abi_warning.near: top-center

legend: {
  shape: package
  label: "Diagram Legend"
  
  abi: "Blue: Static Compile-time Inclusion"
  layout: "Purple: ABI Memory Constraints"
  syscall: "Red: Runtime Syscall Path"
}
legend.near: bottom-right