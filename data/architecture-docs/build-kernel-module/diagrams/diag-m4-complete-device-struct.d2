direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 1
  }
}

# ─── Final Device Structure: Memory Layout & Cache Alignment ───
my_device_struct: {
  shape: sql_table
  label: "struct my_device (mydevice.c)"
  
  # Cache Line 1 (0-63)
  line1: "OFFSET | TYPE | NAME | ATTRIBUTES / ACCESS" {style.font-color: "#777777"}
  f1: "0x00 | struct cdev | cdev | [COLD] VFS Entry Point (Part 1/2)"
  
  # Cache Line 2 (64-127)
  sep1: "--- Cache Line Boundary (64 Bytes) ---" {style.stroke-dash: 3}
  f1_2: "0x40 | struct cdev | cdev | [COLD] VFS Entry Point (Part 2/2)"
  f2: "0x68 | char* | buffer | [HOT] Pointer to 4KB ring buffer" {style.font-color: "#d73a49"}
  f3: "0x70 | size_t | buffer_size | [COLD] Total capacity (Fixed/ioctl)"
  f4: "0x78 | size_t | data_len | [HOT] Current utilization" {style.font-color: "#d73a49"}
  
  # Cache Line 3 (128-191)
  sep2: "--- Cache Line Boundary (128 Bytes) ---" {style.stroke-dash: 3}
  f5: "0x80 | atomic_t | open_count | [COLD] Instance tracker (4 bytes)"
  f_pad1: "0x84 | uint32_t | [padding] | Internal alignment" {style.font-color: "#999999"}
  f6: "0x88 | unsigned long | read_count | [HOT] Global statistics counter" {style.font-color: "#d73a49"}
  f7: "0x90 | unsigned long | write_count | [HOT] Global statistics counter" {style.font-color: "#d73a49"}
  f8: "0x98 | struct mutex | lock | [HOT] Serialization (40 bytes)" {style.font-color: "#d73a49"}
  
  # Cache Line 4 (192-255)
  sep3: "--- Cache Line Boundary (192 Bytes) ---" {style.stroke-dash: 3}
  f9: "0xC0 | wait_queue_head_t | read_wq | [HOT] Reader wait queue (24 bytes)" {style.font-color: "#d73a49"}
  f10: "0xD8 | wait_queue_head_t | write_wq | [HOT] Writer wait queue (24 bytes)" {style.font-color: "#d73a49"}
  
  total: "Size: 240 bytes (Occupies 4 full L1 Cache Lines)" {style.bold: true}
}

# ─── Documentation Legend ───
legend: {
  near: bottom-right
  hot: "Red = Hot Path (Read/Write/Poll)" {
    style: {
      font-color: "#d73a49"
      bold: true
    }
  }
  cold: "Black = Cold Path (Init/Open/Ioctl)"
  note: "Wait queues & Mutex contain internal spinlocks/lists."
}

# ─── Data & Control Path Mapping ───
VFS_Dispatch: {
  label: "VFS vtable (.read / .write)"
  shape: package
}

VFS_Dispatch -> my_device_struct.f1: "major/minor lookup"
my_device_struct.f8 -> my_device_struct.f4: "protects"
my_device_struct.f9 -> my_device_struct.f2: "signals readiness"
my_device_struct.f10 -> my_device_struct.f2: "signals space"