direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

userspace_writers: {
  label: "Userspace: 4 Concurrent Writers"
  direction: down
  
  w1: "Writer 1 (PID: 1001)" {
    shape: person
    tooltip: "Writes 'W1:chunkN...'"
  }
  w2: "Writer 2 (PID: 1002)" {
    shape: person
    tooltip: "Writes 'W2:chunkN...'"
  }
  w3: "Writer 3 (PID: 1003)" {
    shape: person
    tooltip: "Writes 'W3:chunkN...'"
  }
  w4: "Writer 4 (PID: 1004)" {
    shape: person
    tooltip: "Writes 'W4:chunkN...'"
  }
}

kernel_driver: {
  label: "Kernel Space: mydevice.ko"
  
  state: {
    shape: sql_table
    label: "struct mydev_data (internal)"
    f0: "0x00 | struct mutex | dev_mutex // Primary Sync"
    f1: "0x20 | char*          | kernel_buffer // 4KB Page"
    f2: "0x28 | size_t         | buffer_size // 4096"
    f3: "0x30 | size_t         | buffer_used // Atomic/Sync"
    f4: "0x38 | wait_queue_head_t | read_queue // Readers"
    f5: "0x58 | wait_queue_head_t | write_queue // Writers"
    sz: "Total: 120 bytes"
  }

  write_op: {
    label: "ssize_t mydev_write()"
    code: |'c
      mutex_lock_interruptible(&dev_mutex);
      while (buffer_used == buffer_size) {
          mutex_unlock(&dev_mutex);
          wait_event_interruptible(write_queue, ...);
          mutex_lock(&dev_mutex);
      }
      copy_from_user(kernel_buffer + buffer_used, buf, n);
      buffer_used += n;
      wake_up_interruptible(&read_queue);
      mutex_unlock(&dev_mutex);
    '|
    style.stroke: red
  }

  read_op: {
    label: "ssize_t mydev_read()"
    code: |'c
      mutex_lock_interruptible(&dev_mutex);
      while (buffer_used == 0) {
          mutex_unlock(&dev_mutex);
          wait_event_interruptible(read_queue, ...);
          mutex_lock(&dev_mutex);
      }
      copy_to_user(buf, kernel_buffer + f_pos, n);
      wake_up_interruptible(&write_queue);
      mutex_unlock(&dev_mutex);
    '|
    style.stroke: blue
  }
}

userspace_readers: {
  label: "Userspace: 4 Concurrent Readers"
  direction: down

  r1: "Reader 1 (PID: 2001)" {
    shape: person
  }
  r2: "Reader 2 (PID: 2002)" {
    shape: person
  }
  r3: "Reader 3 (PID: 2003)" {
    shape: person
  }
  r4: "Reader 4 (PID: 2004)" {
    shape: person
  }
}

verification: {
  label: "Integrity Verification (stress_test.sh)"
  
  chk_write: {
    shape: parallelogram
    label: "Aggregate MD5 (Writers)"
    style.fill: "#DEE1EB"
  }

  chk_read: {
    shape: parallelogram
    label: "Aggregate MD5 (Readers)"
    style.fill: "#DEE1EB"
  }

  compare: {
    shape: diamond
    label: "MD5_W == MD5_R?"
    style.fill: green
  }
}

# Connections
userspace_writers.w1 -> kernel_driver.write_op: "char[64] | 64B | 'W1:chunk1...'"
userspace_writers.w2 -> kernel_driver.write_op: "char[64] | 64B | 'W2:chunk1...'"
userspace_writers.w3 -> kernel_driver.write_op: "char[64] | 64B | 'W3:chunk1...'"
userspace_writers.w4 -> kernel_driver.write_op: "char[64] | 64B | 'W4:chunk1...'"

kernel_driver.write_op -> kernel_driver.state: "mutex_lock() + memcpy" {
  style.stroke: red
}

kernel_driver.state -> kernel_driver.read_op: "mutex_lock() + fetch" {
  style.stroke: blue
}

kernel_driver.read_op -> userspace_readers.r1: "char[64] | 64B | 'W1:chunk1...'"
kernel_driver.read_op -> userspace_readers.r2: "char[64] | 64B | 'W3:chunk1...'"
kernel_driver.read_op -> userspace_readers.r3: "char[64] | 64B | 'W2:chunk1...'"
kernel_driver.read_op -> userspace_readers.r4: "char[64] | 64B | 'W4:chunk1...'"

userspace_writers -> verification.chk_write: "Pipe to md5sum"
userspace_readers -> verification.chk_read: "Pipe to md5sum"

verification.chk_write -> verification.compare
verification.chk_read -> verification.compare

# Failure Scenarios Annotated
failure_modes: {
  near: bottom-right
  deadlock: "Failure: Deadlock" {
    shape: callout
    label: "Impossible via single mutex;\nDetected by lockdep."
    style.stroke: red
  }
  corruption: "Failure: Corruption" {
    shape: callout
    label: "Interleaved writes if mutex\nis removed or bypassed."
    style.stroke: red
  }
  starvation: "Failure: Starvation" {
    shape: callout
    label: "Large read (1MB) could hog\nmutex, blocking writers."
    style.stroke: orange
  }
}

legend: {
  near: top-right
  direction: down
  mutex_lock: "Red Arrow = Mutex Contention Path" {
    style.stroke: red
  }
  data_flow: "Blue Arrow = Data Transfer Path" {
    style.stroke: blue
  }
}