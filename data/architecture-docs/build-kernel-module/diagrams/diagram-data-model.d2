mydevice_data: {
  shape: class
  "buffer: void*"
  "size: size_t"
  "mutex: struct mutex"
  "wait_queue: wait_queue_head_t"
  "cdev: struct cdev"
  style.stroke: "#3fb950"
  style.bold: true
}

kernel_objects: {
  label: "Kernel Objects"
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"

  cdev: {
    label: "struct cdev"
    shape: class
    "owner: struct module*"
    "ops: const struct file_operations*"
    "dev: dev_t"
    "..."
    style.fill: "#0f3460"
  }

  file_operations: {
    label: "struct file_operations"
    shape: class
    "open: int (*)(struct inode*, struct file*)"
    "release: int (*)(struct inode*, struct file*)"
    "read: ssize_t (*)(struct file*, char __user*, size_t, loff_t*)"
    "write: ssize_t (*)(struct file*, const char __user*, size_t, loff_t*)"
    "unlocked_ioctl: long (*)(struct file*, unsigned int, unsigned long)"
  }

  mutex: {
    label: "struct mutex"
    shape: class
    "owner: void*"
    "wait_lock: spinlock_t"
    "wait_list: list_head"
    style.stroke: "#e17055"
  }

  wait_queue_head_t: {
    label: "wait_queue_head_t"
    shape: class
    "lock: spinlock_t"
    "head: list_head"
    style.stroke: "#e17055"
  }

  inode: {
    label: "struct inode"
    shape: class
    "i_cdev: struct cdev*"
    "i_rdev: dev_t"
    "..."
  }

  file: {
    label: "struct file"
    shape: class
    "private_data: void*"
    "f_op: const struct file_operations*"
    "..."
  }
}

data_flow: {
  label: "Data Flow and Relationships"
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"

  note: {
    label: |md
      ## Key Relationships
      1. **Singleton Pattern**: Single global `mydevice_data` instance
      2. **Buffer Management**: User-space data stored in kernel buffer
      3. **Concurrency**: Mutex protects buffer access
      4. **Blocking I/O**: Wait queue for read/write synchronization
    |
    shape: page
    style.fill: "#16213e"
    style.stroke: "#3fb950"
  }

  singleton_instance: {
    label: "Global mydevice_data instance"
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }

  user_space: {
    label: "User Space"
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.stroke-dash: 3

    app: {
      label: "User Application"
      style.fill: "#16213e"
    }
  }
}

mydevice_data.cdev -> kernel_objects.cdev: contains
kernel_objects.cdev.ops -> kernel_objects.file_operations: references
mydevice_data.mutex -> kernel_objects.mutex: protects buffer access
mydevice_data.wait_queue -> kernel_objects.wait_queue_head_t: blocks processes
kernel_objects.file -> kernel_objects.file_operations: via f_op
kernel_objects.file -> mydevice_data: private_data points to instance
kernel_objects.inode -> kernel_objects.cdev: via i_cdev
singleton_instance -> mydevice_data: instance of
user_space.app -> kernel_objects.file_operations: system calls
user_space.app -> singleton_instance: read/write data
user_space.app -> mydevice_data.buffer: writes data
mydevice_data.buffer -> user_space.app: reads data
kernel_objects.cdev -> kernel_objects.inode: kernel associates
kernel_objects.file_operations -> kernel_objects.cdev: operations registered