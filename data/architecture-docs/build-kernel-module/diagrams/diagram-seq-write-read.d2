shape: sequence_diagram
title: Sequence Diagram: Write then Read

userspace_write: "Writer Process (Userspace)"
userspace_read: "Reader Process (Userspace)"
vfs: "VFS (Virtual File System)"
driver: "mydevice Driver"
kernel_utils: "Kernel Utils"

userspace_write -> vfs: write() syscall
vfs -> driver: mydevice_write()
driver -> driver: mutex_lock(&dev->lock)
driver -> kernel_utils: copy_from_user(dev->buffer, buf, count)
kernel_utils --> driver: returns bytes copied
driver -> driver: dev->data_available = true
driver -> driver: wake_up_interruptible(&dev->read_queue)
driver -> driver: mutex_unlock(&dev->lock)
driver --> vfs: return bytes_written
vfs --> userspace_write: return

userspace_read -> vfs: read() syscall
vfs -> driver: mydevice_read()
driver -> driver: mutex_lock(&dev->lock)
driver -> driver: "while (!dev->data_available) { wait_event_interruptible(...) }"
driver -> kernel_utils: copy_to_user(buf, dev->buffer, count)
kernel_utils --> driver: returns bytes copied
driver -> driver: dev->data_available = false
driver -> driver: mutex_unlock(&dev->lock)
driver --> vfs: return bytes_read
vfs --> userspace_read: return