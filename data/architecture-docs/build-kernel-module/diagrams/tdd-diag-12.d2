direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

title: |md
  ### f_pos State Machine: Sequential Read & EOF Contract
  **Context:** buffer_used = 6 ("hello\n")
| {
  near: top-center
  shape: text
}

# --- States ---

INIT: "â—" {
  shape: circle
  tooltip: "Initial State"
}

STATE_0: "f_pos = 0\n(Initial Open)" {
  tooltip: "Fresh struct file instance"
  style.stroke-width: 2
}

STATE_6: "f_pos = 6\n(Data Consumed)" {
  tooltip: "f_pos advanced by bytes_to_copy"
}

EOF: "EOF State\n(Returns 0)" {
  shape: circle
  style.double-border: true
  tooltip: "if (*f_pos >= buffer_used) return 0;"
}

BUG_LOOP: "INFINITE LOOP BUG\n**f_pos = 0**" {
  style: {
    fill: "#ffcccc"
    stroke: red
    stroke-width: 4
  }
  tooltip: "Logic failed to update *f_pos"
}

ILLEGAL_OVERRUN: "ILLEGAL OVERRUN\nf_pos > 6" {
  style: {
    fill: "#ffcccc"
    stroke: red
    stroke-dash: 5
  }
}

# --- Transitions ---

INIT -> STATE_0: "open('/dev/mydevice')"

STATE_0 -> STATE_6: "read(fd, buf, 4096)\nret = 6" {
  style: {
    stroke: blue
    bold: true
  }
}

STATE_6 -> EOF: "read(fd, buf, 4096)\nret = 0" {
  style.stroke: blue
}

EOF -> STATE_0: "NEW open(fd)\n(Independent f_pos)" {
  style.stroke-dash: 3
}

# --- Error/Illegal Paths ---

STATE_0 -> BUG_LOOP: "read() succeeds but\n*f_pos NOT updated" {
  style: {
    stroke: red
    stroke-width: 2
  }
}

BUG_LOOP -> STATE_0: "cat repeats read()\n(Infinite Data Stream)" {
  style: {
    stroke: red
    animated: true
  }
}

STATE_6 -> ILLEGAL_OVERRUN: "ILLEGAL: read() without\nmin() guard" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

# --- Annotations ---

legend: {
  shape: package
  near: bottom-right
  
  invariant_1: "Invariant: f_pos >= 0" {
    shape: text
  }
  invariant_2: "Invariant: f_pos is per-file-desc" {
    shape: text
  }
  logic: |md
  c
  if (*f_pos >= buffer_used) 
      return 0; // EOF
  bytes = min(count, used - *f_pos);
  *f_pos += bytes;
  
  | {
    shape: text
  }
}

# Styling transition labels for consistency
(STATE_0 -> STATE_6)[0].style.font-color: blue
(STATE_6 -> EOF)[0].style.font-color: blue
(STATE_0 -> BUG_LOOP)[0].style.font-color: red
(STATE_6 -> ILLEGAL_OVERRUN)[0].style.font-color: red