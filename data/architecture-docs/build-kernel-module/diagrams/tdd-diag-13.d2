layout-engine: elk
theme-id: 0

# SYSCALL EXECUTION TRACE: write(2) to Character Device
# CONTEXT: Milestone 2 Implementation

write_trace: {
  shape: sequence_diagram

  user_task: "Userspace Process\n(echo hello > /dev/mydevice)" {
    style: {
      fill: "#E3F2FD"
      stroke: "#1565C0"
    }
  }

  vfs_layer: "Virtual File System\n(VFS)" {
    style: {
      fill: "#F3E5F5"
      stroke: "#4A148C"
    }
  }

  mydevice_driver: "mydevice Driver\n(Kernel Module)" {
    style: {
      fill: "#E8F5E9"
      stroke: "#2E7D32"
    }
  }

  # 1. Syscall Entry
  user_task -> vfs_layer: write(fd=1, buf, count=6) {
    label: "SYSCALL (RAX=1)\nPrivilege: Ring 3 -> Ring 0"
    style.stroke: "#1565C0"
  }

  # 2. VFS Lookup & Validation
  vfs_layer -> vfs_layer: ksys_write(fd, buf, count) {
    label: "1. Lookup fd in current->files->fdt[1]\n2. Extract struct file *f\n3. Verify f->f_mode & FMODE_WRITE"
  }

  # 3. VFS Dispatch
  vfs_layer -> mydevice_driver: f->f_op->write(f, buf, 6, &f->f_pos) {
    label: "vfs_write() dispatch to .write handler"
    style.stroke: "#1565C0"
  }

  # 4. Driver Internal Logic
  mydevice_driver -> mydevice_driver: mydev_write(filp, buf, 6, f_pos) {
    label: |md
      **Internal Logic:**
      1. space_avail = 4096 - 0 = 4096
      2. bytes_to_copy = min(6, 4096) = 6
    |
  }

  # 5. Data Crossing (The "Trap and Recover" Bridge)
  mydevice_driver -> user_task: copy_from_user(kernel_buf, buf, 6) {
    label: "Exception Table Bridge"
    style.stroke-dash: 5
  }

  # 6. Memory Details Annotation (Note on mydevice_driver)
  mydevice_driver.note_mem: |md
    **Memory State during copy:**
    - **Source (buf):** `0x7FFFC3450000` (User Stack)
    - **Dest (k_buf):** `0xFFFF888012340000` (Direct Map)
    - **Mechanism:** CPU `#PF` handler consults `.ex_table`
  |

  # 7. Finalize State
  mydevice_driver -> mydevice_driver: update state {
    label: "buffer_used = 6\nnot_copied = 0"
  }

  # 8. Return Path
  mydevice_driver -> vfs_layer: return 6 {
    style.stroke: "#1565C0"
  }

  vfs_layer -> user_task: return 6 (errno=0) {
    label: "Syscall Exit\nIRETQ instruction"
    style.stroke: "#1565C0"
  }
}