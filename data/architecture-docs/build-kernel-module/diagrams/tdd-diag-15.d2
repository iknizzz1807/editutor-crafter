direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# IOCTL COMMAND ENCODING DIAGRAM
# 32-bit Word Definition for mydevice.ko ABI

ioctl_command_layout: {
  shape: sql_table
  style: {
    stroke: black
    stroke-width: 2
    shadow: true
  }

  header: "ioctl Command Encoding (32-bit Bitfield)" {
    style.fill: "#6a0dad"
    style.font-color: white
    style.bold: true
  }

  # Bit Offsets : Field Name { constraint: Macro Definition }
  "31:30": "DIR" {
    constraint: "_IOC_DIR (00=N, 01=W, 10=R)"
    style.fill: "#add8e6"
  }
  "29:16": "SIZE" {
    constraint: "_IOC_SIZE (sizeof argument)"
    style.fill: "#add8e6"
  }
  "15:08": "TYPE" {
    constraint: "_IOC_TYPE (Magic Number)"
    style.fill: "#add8e6"
  }
  "07:00": "NR" {
    constraint: "_IOC_NR (Sequence Number)"
    style.fill: "#add8e6"
  }
}

# Implementation Values Table
commands_table: {
  shape: sql_table
  style.stroke: black

  header: "Concrete ABI Implementation (Magic 'M' = 0x4D)" {
    style.fill: "#6a0dad"
    style.font-color: white
  }

  "MYDEV_CLEAR": "_IO('M', 0)" {
    constraint: "0x00004D00"
    style.fill: "#add8e6"
  }
  "MYDEV_RESIZE": "_IOW('M', 1, __u32)" {
    constraint: "0x40044D01"
    style.fill: "#add8e6"
  }
  "MYDEV_STATUS": "_IOR('M', 2, struct status)" {
    constraint: "0x80184D02"
    style.fill: "#add8e6"
  }
}

# Visual bit-strip for Intel-manual style alignment
bit_strip_container: "Register Map (32-bit Word Visual)" {
  grid-rows: 2
  grid-columns: 5
  grid-gap: 0

  # Row 1: Bit offsets
  b31: "31" { style.font: mono }
  b30: "30" { style.font: mono }
  b29: "29:16" { style.font: mono }
  b15: "15:8" { style.font: mono }
  b7: "7:0" { style.font: mono }

  # Row 2: Field labels
  f1: "DIR" { style.fill: "#add8e6" }
  f2: "DIR" { style.fill: "#add8e6" }
  f3: "SIZE" { style.fill: "#add8e6" }
  f4: "TYPE" { style.fill: "#add8e6" }
  f5: "NR" { style.fill: "#add8e6" }
}

# Implementation-Grade Technical Notes
annotations: |md
  ### Technical Specifications
  - **Word Size**: 32 bits (4 bytes).
  - **Direction Bits**: `_IOC_READ` (2) = Kernel to User. `_IOC_WRITE` (1) = User to Kernel.
  - **Macro Logic**: `_IOC_SIZE` is calculated via `sizeof()` at compile time.
  - **Safety**: Return `-ENOTTY` if magic number (`TYPE`) != `0x4D`.
|

# Legend and Growth markers
msb_marker: "High Bit (MSB)" {
  shape: text
}
lsb_marker: "Low Bit (LSB)" {
  shape: text
}

msb_marker -> ioctl_command_layout."31:30": "Bit 31"
lsb_marker -> ioctl_command_layout."07:00": "Bit 0"

# Growth direction annotation
growth: "Memory Growth/Bit Indexing" {
  shape: text
}

# Use connection to show growth direction
ioctl_command_layout -> growth: "Increasing Significance" {
  style.stroke-dash: 3
}

# Layout grouping to replace object-near positioning
bit_strip_container -> commands_table: "Encoded Command" { style.stroke-width: 0 }
commands_table -> annotations: "Notes" { style.stroke-width: 0 }