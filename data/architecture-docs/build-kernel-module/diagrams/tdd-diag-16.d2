direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# Participants
User: "Userspace Process" {
  shape: person
}
VFS: "Kernel: VFS Layer" {
  style.fill: "#DEE1EB"
}
Driver: "Driver: mydevice" {
  style.fill: "#E4DBFE"
}
Memory: "Memory: User Space" {
  style.fill: "#C7F1FF"
}

# Sequence
shape: sequence_diagram

User -> VFS: "ioctl(fd, MYDEV_STATUS, &status)"
VFS."Syscall Entry (Ring 3 -> Ring 0)"

VFS -> VFS: "sys_ioctl()"
VFS -> VFS: "do_vfs_ioctl()"
VFS."Check known VFS-level commands\n(FIOCLEX, FIONREAD, etc.)"

VFS -> VFS: "Match Found? NO"

VFS -> Driver: "unlocked_ioctl(filp, cmd, arg)"
Driver."Called WITHOUT the Big Kernel Lock (BKL).\nBKL was removed in 2.6.39.\nDriver must handle its own locking (M4)."

Driver -> Driver: "Validate _IOC_TYPE(cmd) == 'M'"
Driver -> Driver: "Validate _IOC_NR(cmd) <= 2"

Driver -> Driver: "Switch(cmd) -> case MYDEV_STATUS"

Driver -> Driver: "Fetch counters via atomic_read()"
Driver."buffer_size, bytes_used, open_count,\nread_count, write_count"

Driver -> Memory: "copy_to_user(arg, &status, 24)"
Memory."ABI: 24 bytes (struct mydev_status)"

Memory -> Driver: "0 (Success)"

Driver -> User: "Return 0"

# Compatibility Path
32BitUser: "32-bit Process\n(on 64-bit Kernel)" {
  shape: person
  style.stroke-dash: 5
}

32BitUser -> VFS: "ioctl(fd, MYDEV_STATUS, &status)" {
  style.stroke-dash: 5
}
VFS -> Driver: "compat_ioctl(filp, cmd, arg)" {
  style.stroke-dash: 5
}
Driver."Required if pointers or long types\ndiffer in layout between 32/64 bit."