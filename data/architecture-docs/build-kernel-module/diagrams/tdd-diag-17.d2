layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

MemoryAtlas: {
  label: "MEMORY LAYOUT: struct mydev_status (ABI Contract)"

  Legend: {
    shape: sql_table
    Header: "Purple" {style.fill: "#D2B4DE"}
    Data: "Blue" {style.fill: "#AED6F1"}
    Free: "Green" {style.fill: "#ABEBC6"}
    Padding: "Gray" {style.fill: "#D5D8DC"}
  }

  Layout: {
    grid-columns: 1
    grid-gap: 0

    Header: "struct mydev_status" {
      style.fill: "#D2B4DE"
      style.bold: true
      width: 400
    }

    Field0: "0x00 | buffer_size (u32) | 4 Bytes" {
      style.fill: "#AED6F1"
    }
    Field1: "0x04 | bytes_used   (u32) | 4 Bytes" {
      style.fill: "#AED6F1"
    }
    Field2: "0x08 | open_count   (u32) | 4 Bytes" {
      style.fill: "#AED6F1"
    }
    Field3: "0x0C | read_count   (u32) | 4 Bytes" {
      style.fill: "#AED6F1"
    }
    Field4: "0x10 | write_count  (u32) | 4 Bytes" {
      style.fill: "#AED6F1"
    }
    Field5: "0x14 | _reserved    (u32) | 4 Bytes" {
      style.fill: "#AED6F1"
    }

    Slack: "0x18 | [Slack Space] | 40 Bytes" {
      style.fill: "#ABEBC6"
      style.stroke-dash: 2
    }
  }

  Annotations: {
    TotalSize: "Total Size: 24 Bytes (0x18)" {
      shape: text
      style.font-size: 18
      style.bold: true
    }

    CacheLine: "--- 64B Cache Line Boundary (1 line fits all) ---" {
      shape: text
      style.font-color: "#7F8C8D"
      style.italic: true
    }

    ABI_Contract: |md
      ### ABI Stability Rules
      - **Binary Compatibility**: This layout is baked into the ioctl command:
        `_IOR(MYDEV_MAGIC, 2, struct mydev_status)`
      - **Size Check**: The `SIZE` field (24 bytes) is hardcoded in bits [16:29] of the `cmd` arg.
      - **Violations**: Changing field order, resizing `__u32`, or adding fields without `_reserved` replacement breaks all existing userspace binaries.
    |

    Memory_Physics: |md
      ### Physical Characteristics
      - **Alignment**: Naturally aligned on 4-byte boundaries. No compiler padding added.
      - **Atomicity**: `read_count` and `write_count` are `atomic_t` (int). `atomic_read` performs a single 32-bit load (instruction `mov`).
      - **Cache**: Entire struct resides in one L1 Cache Line (64B). Inter-CPU contention on counters triggers MESI RFO (Request For Ownership).
    |
  }

  # Connections for positioning
  Layout.Field5 -> Annotations.CacheLine: {style.stroke-dash: 5}
  Annotations.TotalSize -> Layout.Field5
  Layout -> Annotations.ABI_Contract
  Layout -> Annotations.Memory_Physics
}