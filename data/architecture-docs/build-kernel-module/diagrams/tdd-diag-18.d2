direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- STYLES & CLASSES ---
classes: {
  state_node: {
    style: {
      stroke-width: 2
      border-radius: 4
    }
  }
  danger: {
    style: {
      fill: "#ffeef0"
      stroke: "#d73a49"
    }
  }
  success: {
    style: {
      fill: "#e6ffed"
      stroke: "#22863a"
    }
  }
}

# --- SAFE PATH: ALLOCATE-THEN-SWAP ---
SAFE_ALGO: "SAFE: ALLOCATE-THEN-SWAP (Atomic-Like)" {
  style.stroke: "#22863a"
  style.stroke-width: 4

  BEFORE: {
    shape: sql_table
    label: "1. Initial State (Size=4096)"
    kernel_buffer: "0xFFFF888001234000"
    buffer_size: "4096"
    buffer_used: "2000"
    content: "Valid Data"
  }

  STEP_3: {
    shape: sql_table
    label: "2. New Allocation (Size=12288)"
    kernel_buffer: "0xFFFF888001234000"
    new_buffer: "0xFFFF888002345000" {
      style.font-color: red
      style.bold: true
    }
    buffer_size: "4096"
    status: "Original data still safe"
  }

  STEP_5: {
    shape: sql_table
    label: "3. Content Migration (Size=12288)"
    kernel_buffer: "0xFFFF888001234000"
    new_buffer: "0xFFFF888002345000"
    buffer_used: "2000"
    action: "memcpy(new, old, 2000)" {
      style.font-color: red
      style.bold: true
    }
  }

  AFTER: {
    shape: sql_table
    label: "4. Final State (Size=8192)"
    kernel_buffer: "0xFFFF888002345000" {
      style.font-color: red
      style.bold: true
    }
    buffer_size: "8192" {
      style.font-color: red
      style.bold: true
    }
    buffer_used: "2000"
    old_ptr: "0x0 (FREED)" {
      style.font-color: red
      style.bold: true
    }
  }

  BEFORE -> STEP_3: "kzalloc(8192)"
  STEP_3 -> STEP_5: "Success"
  STEP_5 -> AFTER: "Swap Pointers"
}

# --- UNSAFE PATH: FREE-THEN-ALLOC ---
UNSAFE_ALGO: "UNSAFE: FREE-THEN-ALLOC (Data Loss Risk)" {
  style.stroke: "#d73a49"
  style.stroke-width: 4

  U_BEFORE: {
    shape: sql_table
    label: "1. Initial State (Size=4096)"
    kernel_buffer: "0xFFFF888001234000"
    content: "Valid Data"
  }

  U_STEP_1: {
    shape: sql_table
    label: "2. Immediate Free (Size=0)"
    kernel_buffer: "0x0000000000000000" {
      style.font-color: red
      style.bold: true
    }
    data: "DEALLOCATED" {
      style.font-color: red
      style.bold: true
    }
    risk: "No backup exists"
  }

  U_FAILURE: {
    shape: sql_table
    label: "3. Allocation Failure (CRITICAL)"
    kernel_buffer: "NULL" {
      style.font-color: red
      style.bold: true
    }
    status: "DATA LOSS" {
      style.font-color: red
      style.bold: true
    }
    errno: "-ENOMEM"
  }

  U_BEFORE -> U_STEP_1: "kfree(kernel_buffer)"
  U_STEP_1 -> U_FAILURE: "kmalloc(8192) FAILS" {
    style.stroke: red
    style.animated: true
  }
}

# --- DOCUMENTATION ---
RESIZE_DOCS: |md
  ### Memory Invariant: Atomic-like Failure
  **Safe Path (Allocate-Then-Swap):**
  - Allocate new memory *first*.
  - Migration occurs while the old pointer is still valid.
  - If allocation fails at Step 2, the function returns `-ENOMEM`, but the original buffer remains untouched.
  
  **Unsafe Path (Free-Then-Alloc):**
  - Destroying the original buffer before securing a replacement.
  - An allocation failure at Step 3 leads to a **Panic or Data Loss** as the original data is already unmapped.
| {
  near: top-center
}

# Apply global styles for algorithm steps
SAFE_ALGO.STEP_3.new_buffer -> SAFE_ALGO.STEP_5.new_buffer: "Migration" {style.stroke: orange}
UNSAFE_ALGO.U_FAILURE.style.fill: "#ffeef0"
SAFE_ALGO.AFTER.style.fill: "#e6ffed"