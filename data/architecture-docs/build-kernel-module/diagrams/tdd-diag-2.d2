direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# State Definitions
UNLOADED: "â— UNLOADED" {
  shape: circle
  tooltip: "Module resides as .ko file on disk. No kernel memory allocated."
}

LOADING: "LOADING" {
  tooltip: |md
    ### Invariants
    - Memory allocated via `module_alloc()`
    - ELF sections mapped
    - Vermagic & CRCs verified
  |
}

LIVE: "LIVE" {
  style: {
    stroke-width: 4
    double-border: true
  }
  tooltip: |md
    ### Invariants
    - `module_init()` returned 0
    - `.init.text` has been freed
    - Symbols visible in `/proc/kallsyms`
    - Refcount (f_op->owner) tracking active
  |
}

UNLOADING: "UNLOADING" {
  tooltip: |md
    ### Invariants
    - `module_exit()` executing
    - New `open()` calls blocked by VFS
  |
}

ERROR: "LOAD_FAILURE" {
  style.fill: "#ffcccc"
  style.stroke: red
  style.font-color: red
}

# Transitions
UNLOADED -> LOADING: "insmod / finit_module" {
  label: "1. sys_init_module()\n2. load_module()"
}

LOADING -> LIVE: "do_init_module()" {
  label: "module_init() == 0\nFree .init.text"
  style.font-color: "#228b22"
  style.bold: true
}

LOADING -> ERROR: "Validation Error" {
  label: "vermagic mismatch OR\nUnknown symbols OR\nmodule_init() < 0"
  style.stroke: red
  style.font-color: red
}

ERROR -> UNLOADED: "free_module()" {
  style.stroke: red
  style.stroke-dash: 3
}

LIVE -> UNLOADING: "rmmod / delete_module" {
  label: "Guard: refcount == 0\nExec: module_exit()"
}

UNLOADING -> UNLOADED: "free_module()" {
  label: "Unmap pages\nRemove sysfs/proc entries"
}

# Illegal Transitions
LIVE -> UNLOADING: "ILLEGAL: rmmod while busy" {
  style: {
    stroke: red
    stroke-dash: 5
  }
  source-arrowhead: cross
  label: "Guard: refcount > 0\n(Open file descriptors)"
}

LOADING -> LOADING: "ILLEGAL: Double Init" {
  style: {
    stroke: red
    stroke-dash: 5
  }
  label: "Module already in 'coming' state"
}

# Annotations
legend: {
  shape: package
  near: top-right
  label: |md
    ### Kernel Lifecycle Annotations
    - **load_module()**: Handles ELF parsing, relocation, and param population.
    - **do_init_module()**: Finalizes state to `MODULE_STATE_LIVE`.
    - **Refcount**: Incremented on `open()`, decremented on `release()`. 
    - **.init.text**: High-efficiency memory; freed immediately after successful `LIVE` transition.
  |
}