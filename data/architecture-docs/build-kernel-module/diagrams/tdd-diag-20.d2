direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# --- Shared Header Source ---
source: "mydevice_ioctl.h" {
  shape: package
  style: {
    stroke: "#6c5ce7"
    stroke-width: 4
    fill: "#f3f0ff"
  }
  content: |md
    c
    #ifdef __KERNEL__
      /* Kernel Path */
    #else
      /* Userspace Path */
    #endif
    
  |
}

# --- Compilation Contexts ---
kernel_ctx: "Kernel Environment\n(Kbuild System)" {
  style.fill: "#e3f2fd"
  compiler: "gcc (Kernel Internal)" {
    style.fill: "#0984e3"
    style.font-color: white
  }
  flag: "CCFLAGS += -D__KERNEL__" {
    style.stroke-dash: 3
  }
}

user_ctx: "Userspace Environment\n(Standard Build)" {
  style.fill: "#f1f2f6"
  compiler: "gcc -I." {
    style.fill: "#0984e3"
    style.font-color: white
  }
  flag: "__KERNEL__ Undefined" {
    style.stroke-dash: 3
  }
}

# --- Branching Logic ---
source -> kernel_ctx.compiler: "Injected into\nKbuild flow"
source -> user_ctx.compiler: "Included by\ntest_mydevice.c"

# --- Preprocessor Paths ---
kernel_logic: "Path: #ifdef __KERNEL__" {
  style.fill: "#dfe6e9"
  inc1: "include <linux/ioctl.h>"
  inc2: "include <linux/types.h>"
  type_def: "__u32 is native kernel type" {
    style.font: mono
  }
}

user_logic: "Path: #else" {
  style.fill: "#dfe6e9"
  inc1: "include <sys/ioctl.h>"
  inc2: "include <stdint.h>"
  type_def: "typedef uint32_t __u32" {
    style.font: mono
  }
}

kernel_ctx.compiler -> kernel_logic
user_ctx.compiler -> user_logic

# --- Convergence on ABI ---
abi_definition: "Resulting ABI Constants" {
  shape: rectangle
  style.fill: "#f3f0ff"
  style.stroke: "#6c5ce7"
  
  magic: "#define MYDEV_MAGIC 'M'"
  cmd: "#define MYDEV_STATUS _IOR('M', 2, struct mydev_status)"
  
  struct_layout: "struct mydev_status" {
    style.font: mono
    content: |md
      - buffer_size: 4B
      - bytes_used:  4B
      - open_count:  4B
      - read_count:  4B
      - write_count: 4B
      - _reserved:   4B
    |
  }
}

kernel_logic -> abi_definition
user_logic -> abi_definition

# --- Final Binary Result ---
binary_constant: "Identical 32-bit Command" {
  shape: oval
  style.fill: "#e17055"
  style.font-color: white
  label: "0x80184d02"
}

abi_definition -> binary_constant: "Evaluates to"

# --- Annotations ---
note: |md
  ### ABI Synchronization Logic
  1. **Type Parity**: The `__u32` cross-definition ensures 4-byte fields on both 32-bit and 64-bit architectures. Using `unsigned int` would be ambiguous.
  2. **Struct Padding**: Explicit `_reserved` field ensures the struct size (24B) doesn't change if the compiler applies different alignment rules across environments.
  3. **Direction Bits**: `_IOR` encodes the 'Read' direction (Kernel -> User) identically because `<linux/ioctl.h>` and `<sys/ioctl.h>` share the same bit-shifting macros.
| {
  near: bottom-center
  style.stroke: "#636e72"
}