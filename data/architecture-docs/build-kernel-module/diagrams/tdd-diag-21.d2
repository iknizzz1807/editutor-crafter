direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
  colors: {
    header: "#6c5ce7"
    data: "#0984e3"
    free: "#00b894"
    padding: "#b2bec3"
    pointer: "#e17055"
    text: "#ffffff"
  }
}

memory_map: {
  shape: sql_table
  style: {
    stroke: black
    stroke-width: 2
  }

  header: "Linux Kernel Module: Global Device State (x86_64)" {
    style.fill: ${colors.header}
    style.font-color: ${colors.text}
    style.bold: true
  }

  # --- Cache Line 0 (0x00 - 0x3F) ---
  cl0_sep: "--- CACHE LINE 0 (64B) ---" {
    style: {
      stroke-dash: 5
      fill: "#dfe6e9"
      font-size: 10
    }
  }
  
  row_0: "0x00 | dev_num [dev_t] | 4B" {
    style.fill: ${colors.data}
    style.font-color: ${colors.text}
  }
  
  row_1: "0x04 | my_cdev (Struct Start) [struct cdev] | 60B" {
    style.fill: ${colors.data}
    style.font-color: ${colors.text}
  }

  # --- Cache Line 1 (0x40 - 0x7F) ---
  cl1_sep: "--- CACHE LINE 1 (64B) ---" {
    style: {
      stroke-dash: 5
      fill: "#dfe6e9"
      font-size: 10
    }
  }

  row_2: "0x40 | my_cdev (Continued) | 44B" {
    style.fill: ${colors.data}
    style.font-color: ${colors.text}
  }

  row_3: "0x6C | my_class [struct class *] | 8B" {
    style.fill: ${colors.pointer}
    style.font-color: ${colors.text}
  }

  row_4: "0x74 | my_device [struct device *] | 8B" {
    style.fill: ${colors.pointer}
    style.font-color: ${colors.text}
  }

  row_5: "0x7C | proc_entry (Partial) [struct proc_dir_entry *] | 4B" {
    style.fill: ${colors.pointer}
    style.font-color: ${colors.text}
  }

  # --- Cache Line 2 (0x80 - 0xBF) ---
  cl2_sep: "--- CACHE LINE 2 (64B) : BUFFER STATE [HOT] ---" {
    style: {
      stroke-dash: 5
      fill: "#ffeaa7"
      font-size: 10
      bold: true
    }
  }

  row_6: "0x80 | proc_entry (Remainder) | 4B" {
    style.fill: ${colors.pointer}
    style.font-color: ${colors.text}
  }

  row_7: "0x84 | kernel_buffer [char *] | 8B" {
    style.fill: ${colors.pointer}
    style.font-color: ${colors.text}
  }

  row_8: "0x8C | buffer_size_bytes [size_t] | 8B" {
    style.fill: ${colors.data}
    style.font-color: ${colors.text}
  }

  row_9: "0x94 | buffer_used [size_t] | 8B" {
    style.fill: "#d63031" # Red for HOT
    style.font-color: ${colors.text}
    style.bold: true
  }

  row_10: "0x9C | Padding | 36B" {
    style.fill: ${colors.padding}
  }

  # --- Cache Line 3 (0xC0 - 0xFF) ---
  cl3_sep: "--- CACHE LINE 3 (64B) : LOCK STATE ---" {
    style: {
      stroke-dash: 5
      fill: "#dfe6e9"
      font-size: 10
    }
  }

  row_11: "0xC0 | dev_mutex [struct mutex] | 32B" {
    style.fill: ${colors.data}
    style.font-color: ${colors.text}
  }

  row_12: "0xE0 | read_queue (Partial) [wait_queue_head_t] | 32B" {
    style.fill: ${colors.data}
    style.font-color: ${colors.text}
  }

  # --- Cache Line 4 (0x100 - 0x13F) ---
  cl4_sep: "--- CACHE LINE 4 (64B) : WAIT QUEUES ---" {
    style: {
      stroke-dash: 5
      fill: "#dfe6e9"
      font-size: 10
    }
  }

  row_13: "0x100 | write_queue [wait_queue_head_t] | 24B" {
    style.fill: ${colors.data}
    style.font-color: ${colors.text}
  }

  row_14: "0x118 | open_count [atomic_t] | 4B" {
    style.fill: ${colors.data}
    style.font-color: ${colors.text}
  }

  row_15: "0x11C | Padding | 36B" {
    style.fill: ${colors.padding}
  }

  # --- Cache Line 5 (0x140 - 0x17F) ---
  cl5_sep: "--- CACHE LINE 5 (64B) : COUNTERS ---" {
    style: {
      stroke-dash: 5
      fill: "#dfe6e9"
      font-size: 10
    }
  }

  row_16: "0x140 | read_count [atomic_t] | 4B" {
    style.fill: ${colors.data}
    style.font-color: ${colors.text}
  }

  row_17: "0x144 | write_count [atomic_t] | 4B" {
    style.fill: ${colors.data}
    style.font-color: ${colors.text}
  }

  row_18: "0x148 | Padding/Alignment | 56B" {
    style.fill: ${colors.padding}
  }
}

annotations: |md
  ### Technical Design Notes
  - **Total Static Size**: ~328 Bytes (approx. 6 cache lines).
  - **Memory Alignment**: `struct my_device_data` is 8-byte aligned on x86_64.
  - **False Sharing Mitigation**: `buffer_used` (HOT) is isolated from `dev_mutex` and `counters` by cache line boundaries.
  - **Performance**: `read_count` and `write_count` sharing a cache line is acceptable for low-concurrency statistics; high-concurrency would require `percpu_counter`.
| {
  near: bottom-center
  style.font-size: 12
}