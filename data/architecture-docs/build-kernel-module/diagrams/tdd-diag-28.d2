direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# State Definitions
States: {
  START: "â—" {
    shape: circle
    width: 30
    height: 30
    style.fill: black
  }

  R: "TASK_RUNNING\n(ps: R)" {
    shape: rectangle
    style.border-radius: 10
    tooltip: "Executing on CPU or in run-queue waiting for slice."
    style: {
      stroke-width: 4
      fill: "#3498db"
    }
  }

  S: "TASK_INTERRUPTIBLE\n(ps: S)" {
    shape: rectangle
    style.border-radius: 10
    tooltip: "Interruptible sleep. Wakes on event or signals."
    style.fill: "#2ecc71"
  }

  D: "TASK_UNINTERRUPTIBLE\n(ps: D)" {
    shape: rectangle
    style.border-radius: 10
    tooltip: "Uninterruptible sleep (I/O). Signals ignored."
    style: {
      fill: "#e74c3c"
      bold: true
      double-border: true
    }
  }

  T: "TASK_STOPPED\n(ps: T)" {
    shape: rectangle
    style.border-radius: 10
    tooltip: "Suspended by SIGSTOP or debugger."
    style.fill: "#f1c40f"
  }

  Z: "EXIT_ZOMBIE\n(ps: Z)" {
    shape: rectangle
    style.border-radius: 10
    tooltip: "Terminated; waiting for parent wait()."
    style.fill: "#95a5a6"
  }
}

# Transitions
States.START -> States.R: "execve() / fork()"

# Path: Standard Interruptible Sleep (e.g., milestone 4 driver)
States.R -> States.S: "wait_event_interruptible()\nschedule()" {
  style.stroke: "#2980b9"
  style.stroke-width: 2
}
States.S -> States.R: "wake_up_interruptible()\nOR signal (SIGINT)" {
  style.stroke: "#2980b9"
  style.stroke-width: 2
}

# Path: Uninterruptible Sleep (Disk/NFS/Critical I/O)
States.R -> States.D: "wait_event()\nDisk I/O Wait" {
  style.stroke: "#c0392b"
  style.stroke-width: 4
}
States.D -> States.R: "wake_up()\n(Signals Ignored)" {
  style.stroke: "#c0392b"
  style.stroke-width: 4
}

# Control & Exit
States.R -> States.T: "SIGSTOP / ptrace"
States.T -> States.R: "SIGCONT"
States.R -> States.Z: "do_exit()"

# Illegal Transitions
States.D -> States.S: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

# Technical Annotations
Legend: {
  shape: rectangle
  style: {
    fill: "#fffce0"
    stroke: "#e8d67d"
    stroke-dash: 2
  }
  near: top-right
}
Legend.label: |md
### Linux Scheduler Invariants
- **Load Average** = `count(TASK_RUNNING + TASK_UNINTERRUPTIBLE)`
- **TASK_INTERRUPTIBLE (S)** does NOT contribute to load.
- **High Load + 0% CPU** = System bottlenecked in **D** state.
|

DriverAnnotation: {
  near: States.S
  style: {
    fill: "#eef9f3"
    stroke: "#2ecc71"
  }
}
DriverAnnotation.label: |md
### Driver Context (Milestone 4)
- Readers blocking on empty buffers use `wait_event_interruptible`.
- Verification: `ps aux` shows state **S**.
|

LoadAvgAnnotation: {
  near: States.D
  style: {
    fill: "#fff5f5"
    stroke: "#e74c3c"
  }
}
LoadAvgAnnotation.label: |md
**In-Kernel Constraint:**
TASK_UNINTERRUPTIBLE 
contributes to 
**system load.**
|

# Layout Overrides
States.D.style.stroke: "#c0392b"
States.S.style.stroke: "#27ae60"