direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# --- STYLING DEFINITIONS ---
classes: {
  source_code: {
    shape: page
    style: {
      fill: "#B6DDF6" # Blue (Data)
      stroke: "#2B5797"
    }
  }
  tool: {
    shape: parallelogram
    style: {
      fill: "#E1D5E7" # Purple (Header/Process)
      stroke: "#9673A6"
      font-color: "#000000"
    }
  }
  binary_obj: {
    shape: square
    style: {
      fill: "#D5E8D4" # Green (Result)
      stroke: "#82B366"
    }
  }
  kernel_env: {
    style: {
      stroke-dash: 5
      fill: "#F5F5F5"
      font-size: 14
    }
  }
}

# --- PIPELINE COMPONENTS ---

User_Space: "Userspace Development Directory" {
  style.fill: transparent
  
  Source: "hello.c" {class: source_code}
  Makefile: "Makefile" {
    shape: page
    label: |md
      **Makefile**
      `obj-m += hello.o`
      `make -C $(KDIR) M=$(PWD) modules`
    |
  }
}

# Using single quotes to bypass the substitution logic for shell-like variables
KDIR: '/lib/modules/$(uname -r)/build' {
  class: kernel_env
  
  Symvers: "Module.symvers" {
    shape: cylinder
    label: "Module.symvers\n(Exported Symbol CRCs)"
  }
  
  Kbuild_Logic: "Kbuild Core Infrastructure" {
    shape: rectangle
    style.fill: "#FFF2CC"
  }
}

Pipeline: "Compilation Pipeline" {
  
  GCC_Phase1: "GCC (Kernel Context)" {
    class: tool
    label: |md
      **Compiler (Stage 1)**
      Flags:
      -D__KERNEL__
      -DMODULE
      -mcmodel=kernel
      -fno-stack-protector
      -mno-mmx -mno-sse
      -fno-pic
    |
  }

  hello_o: "hello.o" {
    class: binary_obj
    label: "hello.o\n(Relocatable Object)"
  }

  Modpost: "modpost tool" {
    class: tool
    label: |md
      **Modpost**
      1. Inspects hello.o symbols
      2. Matches CRCs in symvers
      3. Validates vermagic
    |
  }

  hello_mod_c: "hello.mod.c" {
    class: source_code
    label: |md
      **hello.mod.c**
      - .modinfo section
      - vermagic string
      - module_layout dependency
      - __this_module struct
    |
  }

  GCC_Phase2: "GCC (Metadata)" {
    class: tool
  }

  hello_mod_o: "hello.mod.o" {
    class: binary_obj
  }

  Linker: "LD (Linker)" {
    class: tool
    label: "ld -r"
  }

  Final_KO: "hello.ko" {
    shape: page
    style: {
      fill: "#FF8C00" # Orange (Pointers/Final Output)
      stroke: "#B45F06"
      bold: true
    }
    label: "hello.ko\n(Kernel Object)"
  }
}

# --- FLOW CONNECTIONS ---

User_Space.Makefile -> KDIR.Kbuild_Logic: "Delegates Execution" {
  style.stroke: "#B85450"
  style.stroke-width: 2
}

User_Space.Source -> Pipeline.GCC_Phase1
KDIR.Kbuild_Logic -> Pipeline.GCC_Phase1: "Injects CFLAGS"

Pipeline.GCC_Phase1 -> Pipeline.hello_o

Pipeline.hello_o -> Pipeline.Modpost
KDIR.Symvers -> Pipeline.Modpost: "Symbol CRC Verification"

Pipeline.Modpost -> Pipeline.hello_mod_c

Pipeline.hello_mod_c -> Pipeline.GCC_Phase2
Pipeline.GCC_Phase2 -> Pipeline.hello_mod_o

Pipeline.hello_o -> Pipeline.Linker
Pipeline.hello_mod_o -> Pipeline.Linker

Pipeline.Linker -> Pipeline.Final_KO: "Partial Linking"

# Annotations: Using constant value for 'near' to satisfy ELK requirements
Annotations: {
  near: bottom-right
  info: |md
    ### Intel Manual Quality Spec:
    - **Linking**: The `.ko` file is a result of a partial link (`ld -r`).
    - **Symbol Resolution**: Done at runtime by the kernel's `load_module()`.
    - **Address Space**: Code is relocated into the `vmalloc` area.
  |
}