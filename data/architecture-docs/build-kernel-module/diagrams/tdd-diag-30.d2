layout-engine: elk
theme-id: 4

classes: {
  writer: {
    shape: person
    style: {
      fill: "#E1F5FE"
      stroke: "#01579B"
    }
  }
  reader: {
    shape: person
    style: {
      fill: "#E8F5E9"
      stroke: "#1B5E20"
    }
  }
  kernel_component: {
    style: {
      stroke-width: 2
      border-radius: 4
    }
  }
  assertion: {
    style: {
      fill: "#FFF3E0"
      stroke: "#E65100"
      font-size: 12
    }
  }
}

title: "Stress Test Architecture: 4 Writers x 4 Readers Data Flow" {
  shape: text
  near: top-center
  style: {
    font-size: 24
    bold: true
  }
}

Writers: {
  label: "Userspace Writer Threads"
  W0: "Writer 0\n(0x41 'A')" {class: writer}
  W1: "Writer 1\n(0x42 'B')" {class: writer}
  W2: "Writer 2\n(0x43 'C')" {class: writer}
  W3: "Writer 3\n(0x44 'D')" {class: writer}

  style: {
    fill: transparent
    stroke: "#01579B"
    stroke-dash: 3
  }
}

Device: "/dev/mydevice (Kernel Space)" {
  class: kernel_component
  style: {
    fill: "#F3E5F5"
    stroke: "#4A148C"
  }

  sync: {
    mutex: "dev_mutex" {
      shape: parallelogram
      style: {
        fill: "#FFE0B2"
        stroke: "#E65100"
      }
    }
    rq: "read_queue" {
      shape: queue
      style: {
        fill: "#C8E6C9"
      }
    }
    wq: "write_queue" {
      shape: queue
      style: {
        fill: "#FFCDD2"
      }
    }
  }

  buffer: "Kernel Buffer\n[4096 Bytes]" {
    shape: cylinder
    style: {
      fill: "#BBDEFB"
      stroke: "#0D47A1"
    }
  }
}

Readers: {
  label: "Userspace Reader Threads"
  R0: "Reader 0" {class: reader}
  R1: "Reader 1" {class: reader}
  R2: "Reader 2" {class: reader}
  R3: "Reader 3" {class: reader}

  style: {
    fill: transparent
    stroke: "#1B5E20"
    stroke-dash: 3
  }
}

# Data Flow Connections
Writers.W0 -> Device.sync.mutex: "write(CHUNK_SIZE)" {style.stroke: blue; style.animated: true}
Writers.W1 -> Device.sync.mutex
Writers.W2 -> Device.sync.mutex
Writers.W3 -> Device.sync.mutex

Device.sync.mutex -> Device.buffer: "Critical Section"
Device.buffer -> Device.sync.rq: "wake_up_interruptible"

Device.buffer -> Readers.R0: "read(1..BUFSIZ)" {style.stroke: green; style.animated: true}
Device.buffer -> Readers.R1
Device.buffer -> Readers.R2
Device.buffer -> Readers.R3

Readers.R0 -> Device.sync.wq: "wake_up_interruptible"

# Monitoring & Verification
Monitoring: {
  dmesg: "dmesg -w --level=err,warn" {
    style: {
      fill: "#212121"
      font-color: "#00FF00"
    }
  }
  
  verify: "Verification Phase" {
    A0: "assert(W0.bytes == R_stats['A'])" {class: assertion}
    A1: "assert(W1.bytes == R_stats['B'])" {class: assertion}
    A2: "assert(W2.bytes == R_stats['C'])" {class: assertion}
    A3: "assert(W3.bytes == R_stats['D'])" {class: assertion}
  }
}

Readers -> Monitoring.verify: "Aggregate Stats"

Properties: |md
  ### Concurrency Properties Proven
  1. **No Bytes Lost**: `Σ In == Σ Out`
  2. **No Corruption**: Header/Fill byte integrity verified
  3. **No Deadlock**: Mutex-Release-Before-Sleep pattern validated
  4. **Kernel Stability**: `dmesg` clean of BUG/WARNING/OOPS
| {
  near: bottom-right
  style: {
    stroke: "#388E3C"
    fill: "#F1F8E9"
  }
}

# Positioning
Writers -> Device -> Readers
Monitoring.dmesg -> Monitoring.verify: "Health Check"
Device -> Monitoring.dmesg: "Klog Stream" {style.stroke-dash: 3}