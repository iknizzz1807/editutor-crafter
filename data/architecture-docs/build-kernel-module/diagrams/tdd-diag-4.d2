layout-engine: elk
theme-id: 0

# ELF Section Layout of hello.ko (Intel Manual Quality Spec)
# Scale: 1 unit = 1 Byte (Logical Mapping)

direction: down

# Section definitions and Metadata
sections: {
  # ELF Header (0x00 - 0x40)
  elf_header: "ELF64_Header" {
    tooltip: "Standard ELF header (Magic, Class, Type, Machine)"
    style: {
      fill: "#9b59b6"
      stroke-width: 2
    }
    label: "0x0000 | ELF64 Header | 64B"
  }

  # modinfo (0x40 - 0x140)
  modinfo: ".modinfo" {
    tooltip: "Tool: modinfo reads this for License, Author, and Params"
    style.fill: "#3498db"
    label: "0x0040 | .modinfo (license=GPL, author=..., parm=...) | 256B"
  }

  # rodata (0x140 - 0x200)
  rodata: ".rodata.str" {
    tooltip: "String literals for printk() informational messages"
    style.fill: "#3498db"
    label: "0x0140 | .rodata.str (Log messages) | 192B"
  }

  # data (0x200 - 0x240)
  data: ".data" {
    tooltip: "buffer_size variable (RW state)"
    style.fill: "#3498db"
    label: "0x0200 | .data (int buffer_size) | 64B"
  }

  # bss (0x240 - 0x280)
  bss: ".bss" {
    tooltip: "Zero-initialized static variables"
    style.fill: "#95a5a6"
    label: "0x0240 | .bss (Zero-init data) | 64B"
  }

  # text (0x280 - 0x480)
  text: ".text" {
    tooltip: "Resident module code"
    style.fill: "#3498db"
    label: "0x0280 | .text (Helper logic & exit stubs) | 512B"
  }

  # init.text (0x480 - 0x680)
  init_text: ".init.text" {
    tooltip: "hello_init function. Lifecycle: FREED after module_init returns 0"
    style.fill: "#3498db"
    style.stroke-dash: 3
    label: "0x0480 | .init.text (hello_init) | 512B"
  }

  # exit.text (0x680 - 0x780)
  exit_text: ".exit.text" {
    tooltip: "hello_exit function. Discarded if CONFIG_MODULE_UNLOAD=n"
    style.fill: "#3498db"
    label: "0x0680 | .exit.text (hello_exit) | 256B"
  }

  # this_module (0x780 - 0xA00)
  this_module: ".gnu.linkonce.this_module" {
    tooltip: "Tool: Kernel Loader. Contains 'struct module' for live tracking"
    style.fill: "#f39c12"
    label: "0x0780 | .gnu.linkonce.this_module (struct module) | 640B"
  }

  # relocations (0xA00 - 0x1000)
  relocations: ".rel.text / .rel.init" {
    tooltip: "Relocation tables for symbol patching at load-time"
    style.fill: "#f39c12"
    label: "0x0A00 | .rel.* (Symbol patch tables) | 1536B"
  }
}

# Boundary Lines
page_start: "" {
  shape: text
  label: "---------------- PAGE BOUNDARY (Start 0x0000) ----------------"
  style.font-size: 14
  style.bold: true
}

cache_line_1: "" {
  shape: text
  label: " - - - - - - Cache Line Boundary (64B) - - - - - - "
  style.stroke-dash: 5
}

page_end: "" {
  shape: text
  label: "---------------- PAGE BOUNDARY (End 0x1000) ----------------"
  style.font-size: 14
  style.bold: true
}

# Layout constraints
page_start -> sections.elf_header
sections.elf_header -> cache_line_1
cache_line_1 -> sections.modinfo
sections.modinfo -> sections.rodata
sections.rodata -> sections.data
sections.data -> sections.bss
sections.bss -> sections.text
sections.text -> sections.init_text
sections.init_text -> sections.exit_text
sections.exit_text -> sections.this_module
sections.this_module -> sections.relocations
sections.relocations -> page_end

# Annotations
legend: {
  near: center-right
  
  header: "Header/Table" { style.fill: "#9b59b6" }
  code_data: "Code/Data Sections" { style.fill: "#3498db" }
  padding: "BSS/Padding" { style.fill: "#95a5a6" }
  metadata: "Kernel Metadata/Relocs" { style.fill: "#f39c12" }
  
  info: |md
    ### Memory Constraints
    - **Total Size**: 4096 Bytes (1 Page)
    - **Alignment**: 64B Cache Line Aligned
    - **Growth**: Offset Increasing (Top to Bottom)
    - **Discard**: .init.text is unmapped after loading
  |
}

# Styling global rules
sections.*.width: 600
sections.*.height: 50
sections.this_module.height: 80
sections.relocations.height: 100
sections.modinfo.height: 60