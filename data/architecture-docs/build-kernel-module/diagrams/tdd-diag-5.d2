direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- STYLES & CLASSES ---
classes: {
  kernel_fn: {
    style: {
      fill: "#E6E6FA"
      stroke: "#5D3FD3"
      stroke-width: 2
    }
  }
  data_struct: {
    style: {
      fill: "#E1F5FE"
      stroke: "#01579B"
      stroke-width: 2
    }
  }
  hardware: {
    style: {
      fill: "#ECEFF1"
      stroke: "#37474F"
      stroke-dash: 3
    }
  }
}

# --- PARTICIPANTS ---
module: "Kernel Module" {
  style.fill: "#DDA0DD"
  source_code: |md
    printk(KERN_INFO "msg\n");
  |
}

printk_internal: "vprintk_emit()" {
  class: kernel_fn
  tooltip: "Formats string with log-level prefix: \\001\\006"
}

lock: "logbuf_lock" {
  shape: circle
  style.fill: "#FFA500"
  label: "spin_lock_irqsave()"
}

ring_buffer: "__log_buf[]" {
  shape: cylinder
  style.fill: "#E1F5FE"
  description: |md
    **Circular Buffer**
    - Size: 512KB - 4MB
    - CONFIG_LOG_BUF_SHIFT
    - FIFO Overwrite Logic
  |
}

console_path: "Console Path" {
  loglevel_check: "msg_level < console_loglevel" {
    shape: diamond
    style.fill: "#FFF9C4"
  }
  driver: "Console Driver" {
    class: kernel_fn
    label: "console_write()"
  }
  hw: "Physical Console" {
    class: hardware
    label: "VGA / Serial / TTY"
  }
}

user_path: "dmesg Read Path" {
  dev_kmsg: "/dev/kmsg" {
    shape: rectangle
    style.double-border: true
  }
  kmsg_read: "devkmsg_read()" {
    class: kernel_fn
    label: "copy_to_user()"
  }
  bin: "User: dmesg" {
    shape: person
  }
}

# --- CONNECTIONS & DATA FLOW ---

module -> printk_internal: "KERN_INFO + \"msg\""
printk_internal -> lock: "Acquire ▼" {style.stroke: "#01579B"}
lock -> ring_buffer: "Write Formatted Entry"
ring_buffer -> lock: "Release ▲" {style.stroke: "#01579B"}

# Console Branch
ring_buffer -> console_path.loglevel_check: "Wakeup Irq"
console_path.loglevel_check -> console_path.driver: "Yes"
console_path.driver -> console_path.hw: "MMIO / Port I/O"

# Userspace Branch
user_path.bin -> user_path.dev_kmsg: "open() / read()"
user_path.dev_kmsg -> user_path.kmsg_read: "vfs_read dispatch"
user_path.kmsg_read -> ring_buffer: "Iterate records"
ring_buffer -> user_path.kmsg_read: "Binary Log Records"
user_path.kmsg_read -> user_path.bin: "Text + Metadata"

# --- ANNOTATIONS ---
note_circular: |md
  ### Ring Buffer Policy
  - Fixed-size memory region.
  - Head/Tail pointers manage wrap-around.
  - Newest messages overwrite oldest.
| {
  near: top-right
  style.fill: "#E8F5E9"
}

note_dmesg: |md
  ### Utility Flags
  - `dmesg -T`: Human readable clock.
  - `dmesg -w`: Polls `/dev/kmsg` for real-time updates.
  - `dmesg -n`: Set `console_loglevel`.
| {
  near: bottom-right
  style.fill: "#E8F5E9"
}

# --- LAYOUT HINTS ---
module -> printk_internal -> ring_buffer
ring_buffer -> console_path.loglevel_check
ring_buffer -> user_path.kmsg_read