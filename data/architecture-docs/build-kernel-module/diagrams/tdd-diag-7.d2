direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

insmod_sequence: {
  shape: sequence_diagram
  
  shell: "Shell Process\n(Ring 3)"
  insmod: "insmod (User Utility)\n(Ring 3)"
  kernel: "Kernel VFS / Syscall\n(Ring 0 transition)"
  loader: "Module Loader\n(kernel/module/main.c)"
  hello: "hello_module (LKM)\n(Ring 0)"

  shell -> insmod: "1. fork() + execve('/usr/bin/insmod')"
  insmod -> insmod: "2. read('hello.ko') into userspace memory"
  
  insmod -> kernel: "3. finit_module(fd, params, flags) [SYSCALL]" {
    style: {
      stroke: blue
      stroke-width: 4
      bold: true
    }
  }
  
  kernel -> loader: "4. load_module(raw_data)"
  
  linking_phase: {
    loader -> loader: "5. vmalloc_module()\nallocate kernel-mode executable memory"
    loader -> loader: "6. layout_and_allocate()\ncopy sections and apply relocations"
    loader -> loader: "7. resolve_symbols()\nlink vs kernel symbol table"
    loader -> loader: "8. check_modstruct_version()\nverify vermagic string match"
  }

  loader -> hello: "9. do_init_module() → hello_init()" {
    style.stroke: "#A020F0"
    style.stroke-width: 3
  }
  
  hello."RUNS IN PROCESS CONTEXT\nof insmod (can sleep/fault)": {
    style: {
      italic: true
      font-color: "#A020F0"
    }
  }

  hello -> loader: "return 0 (Success)"
  
  loader -> loader: "10. add_to_list()\nvisible in /proc/modules and lsmod"
  
  loader -> kernel: "return 0"
  kernel -> insmod: "return 0"
  insmod -> shell: "11. exit(0)"
  
  loader."ERROR PATH:\nAny step fails → call free_module()\ninsmod exits non-zero": {
    style: {
      stroke: red
      font-color: red
    }
  }
}

annotation: |md
  ### Sequence Implementation Logic
  1. **Privilege Elevation**: The `finit_module` syscall transitions the CPU context from Ring 3 to Ring 0 via `int 0x80` or `syscall` instruction.
  2. **Relocation**: The kernel loader performs the work a dynamic linker (`ld.so`) would usually do in userspace, resolving GOT/PLT entries within kernel space.
  3. **Symbol Table**: External dependencies (e.g., `printk`) are resolved against the `vmlinux` global exported symbol table (`EXPORT_SYMBOL`).
  4. **Memory Management**: The module's memory is initially `RW-`, then transitioned to `R-X` (Non-Writable and Executable) after initialization to satisfy security (W^X) requirements.
| {
  near: bottom-center
}