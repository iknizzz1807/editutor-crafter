title: Gradient Backpropagation Flow {
  style.font-size: 24
  style.bold: true
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
}

start: Start Backward Pass {
  shape: circle
  style.fill: "#3fb950"
  style.font-color: "#000000"
}

topo_sort: Topological Sort {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

comp_graph: Computation Graph {
  shape: hexagon
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

init_grad: Initialize Output Gradient {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

processing: Node Processing {
  current_node: Current Node {
    shape: rectangle
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  chain_rule: Apply Chain Rule {
    shape: rectangle
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  compute_grads: Compute Local Gradients {
    shape: rectangle
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  current_node -> chain_rule: process
  chain_rule -> compute_grads: compute
  
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
}

shared_check: Shared Tensor {
  shape: diamond
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

accumulate: Accumulate Gradients {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

store_grad: Store Gradient {
  shape: rectangle
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

more_nodes: More Nodes {
  shape: diamond
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

complete: Backprop Complete {
  shape: circle
  style.fill: "#3fb950"
  style.font-color: "#000000"
}

note: |md
  **Chain Rule Application:**
  ∂L/∂x = (∂L/∂y) × (∂y/∂x)
  
  **Gradient Accumulation:**
  grad[tensor] += new_gradient
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
}

start -> topo_sort
topo_sort -> comp_graph: analyze
comp_graph -> init_grad: set output grad
init_grad -> processing.current_node
processing.compute_grads -> shared_check
shared_check -> accumulate: Yes
shared_check -> store_grad: No
accumulate -> more_nodes: accumulate grad
store_grad -> more_nodes: store grad
more_nodes -> processing.current_node: Yes next node
more_nodes -> complete: No
note -> processing.chain_rule: explains