vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # IDT Gate Descriptor: Interrupt Gate vs Trap Gate
  **8-byte hardware structure â€” CPU reads this on every interrupt/exception dispatch**
| {near: top-center}

# â”€â”€â”€ COLOR LEGEND â”€â”€â”€
legend: {
  near: bottom-center
  style: {
    fill: "#1a1a2e"
    stroke: "#444"
    border-radius: 8
  }
  label: |md
    ðŸ”´ **Red** = Hot path / danger    ðŸŸ¢ **Green** = Safe / success
    ðŸ”µ **Blue** = Data flow / fields  ðŸŸ£ **Purple** = Metadata / control bits
    ðŸŸ¡ **Yellow** = Caution / waiting  âš« **Gray** = Unused / reserved
  |
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTION A: BYTE-LEVEL MEMORY LAYOUT (8 bytes total)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
byte_layout: "IDT Gate Descriptor â€” 8 Bytes in Memory (little-endian layout)" {
  style: {
    fill: "#0d1117"
    stroke: "#30363d"
    border-radius: 8
    font-size: 14
    bold: true
  }

  b01: "Bytes 0â€“1\n(16 bits)\nOffset [15:0]\nHandler addr low" {
    style: { fill: "#0d4f3c"; stroke: "#2ea043"; font-color: "#7ee787"; font-size: 12 }
  }
  b23: "Bytes 2â€“3\n(16 bits)\nSegment Selector\nKernel CS = 0x0008" {
    style: { fill: "#1a3a5c"; stroke: "#388bfd"; font-color: "#79c0ff"; font-size: 12 }
  }
  b4: "Byte 4\n(8 bits)\nReserved\n= 0x00 always" {
    style: { fill: "#2d2d2d"; stroke: "#6e7681"; font-color: "#8b949e"; font-size: 12 }
  }
  b5: "Byte 5\n(8 bits)\nType+Attr\nP|DPL|S|Type|A" {
    style: { fill: "#3d1f6e"; stroke: "#8b5cf6"; font-color: "#c084fc"; font-size: 12; bold: true }
  }
  b67: "Bytes 6â€“7\n(16 bits)\nOffset [31:16]\nHandler addr high" {
    style: { fill: "#0d4f3c"; stroke: "#2ea043"; font-color: "#7ee787"; font-size: 12 }
  }

  b01 -> b23: "â†’" { style: { stroke: "#444"; font-size: 10 } }
  b23 -> b4: "â†’" { style: { stroke: "#444"; font-size: 10 } }
  b4 -> b5: "â†’" { style: { stroke: "#444"; font-size: 10 } }
  b5 -> b67: "â†’" { style: { stroke: "#444"; font-size: 10 } }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTION B: TYPE+ATTR BYTE EXPLOSION (Byte 5)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
type_attr_byte: "Byte 5 â€” Type/Attribute Byte: Bit-Field Breakdown" {
  style: {
    fill: "#0d1117"
    stroke: "#8b5cf6"
    border-radius: 8
    font-size: 14
    bold: true
  }

  bit7: "Bit 7\nP\nPresent\n1=valid gate\n0=raises #GP" {
    style: { fill: "#0d4f3c"; stroke: "#2ea043"; font-color: "#7ee787"; font-size: 11; bold: true }
  }
  bit65: "Bits 6:5\nDPL\nDescriptor\nPrivilege\nLevel\n00=ring0\n11=ring3" {
    style: { fill: "#1a3a5c"; stroke: "#388bfd"; font-color: "#79c0ff"; font-size: 11; bold: true }
  }
  bit4: "Bit 4\nS\nDescriptor\nType\nMUST=0\n(system seg)" {
    style: { fill: "#2d2d2d"; stroke: "#6e7681"; font-color: "#8b949e"; font-size: 11 }
  }
  bit321: "Bits 3:1\nType\n(3 bits)\n110=INT gate\n111=TRAP gate" {
    style: { fill: "#4a1a1a"; stroke: "#f85149"; font-color: "#ff7b72"; font-size: 11; bold: true }
  }
  bit0: "Bit 0\nD\n32-bit flag\n1=32-bit gate\n0=16-bit (legacy)" {
    style: { fill: "#3d1f6e"; stroke: "#8b5cf6"; font-color: "#c084fc"; font-size: 11 }
  }

  bit7 -> bit65: "bits 7â†’6:5"  { style: { stroke: "#8b5cf6"; font-size: 10 } }
  bit65 -> bit4: "bits 6:5â†’4" { style: { stroke: "#8b5cf6"; font-size: 10 } }
  bit4 -> bit321: "bits 4â†’3:1" { style: { stroke: "#8b5cf6"; font-size: 10 } }
  bit321 -> bit0: "bits 3:1â†’0" { style: { stroke: "#8b5cf6"; font-size: 10 } }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTION C: INTERRUPT GATE â€” type 0xE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
interrupt_gate: "INTERRUPT GATE  [type = 0xE = 1110b]" {
  style: {
    fill: "#1a0a00"
    stroke: "#f85149"
    border-radius: 8
    font-size: 15
    font-color: "#ff7b72"
    bold: true
  }

  ig_byte5: "Byte 5 value = 0x8E\nP=1 | DPL=00 | S=0 | D=1 | type=110\n= 1_00_0_1_110b" {
    style: { fill: "#2d1a00"; stroke: "#f0883e"; font-color: "#ffa657"; font-size: 12; font: mono }
  }

  ig_syscall_gate: "DPL=0 version â†’ 0x8E\nOnly ring-0 can trigger via 'int N'\nHardware can always deliver" {
    style: { fill: "#1a0d00"; stroke: "#f0883e"; font-color: "#ffa657"; font-size: 11 }
  }

  ig_if_behavior: "ðŸ”´ IF FLAG BEHAVIOR\nCPU clears IF (bit 9 of EFLAGS)\non entry to handler.\nHardware IRQs MASKED\nfor duration of handler." {
    style: { fill: "#2d0a0a"; stroke: "#f85149"; font-color: "#ff7b72"; font-size: 12; bold: true }
  }

  ig_why: "WHY clear IF?\nPrevents timer IRQ from\ninterrupting the timer handler.\nNo re-entrancy risk.\nSafe for non-reentrant drivers." {
    style: { fill: "#1a0505"; stroke: "#da3633"; font-color: "#ffa198"; font-size: 11 }
  }

  ig_cost: "âš ï¸  COST: If handler is slow,\nall IRQs stall â†’ higher\ninterrupt latency for ALL devices.\nKeep IRQ handlers short!" {
    style: { fill: "#2d2000"; stroke: "#e3b341"; font-color: "#f0c843"; font-size: 11 }
  }

  ig_used_for: "âœ… USED FOR:\nâ€¢ IRQ0 (PIT timer, vector 32)\nâ€¢ IRQ1 (keyboard, vector 33)\nâ€¢ IRQ14/15 (ATA disk)\nâ€¢ All hardware IRQ handlers\n  (vectors 32â€“47)" {
    style: { fill: "#0a1f0a"; stroke: "#2ea043"; font-color: "#7ee787"; font-size: 12 }
  }

  ig_byte5 -> ig_if_behavior: "S=0,D=1,type=110\nâ†’ interrupt gate semantics" {
    style: { stroke: "#f85149"; animated: true; font-size: 10 }
  }
  ig_if_behavior -> ig_why: "IF=0 on entry means..." { style: { stroke: "#f85149"; font-size: 10 } }
  ig_why -> ig_cost: "trade-off" { style: { stroke: "#e3b341"; stroke-dash: 4; font-size: 10 } }
  ig_byte5 -> ig_syscall_gate: "DPL field" { style: { stroke: "#f0883e"; font-size: 10 } }
  ig_if_behavior -> ig_used_for: "correct for non-reentrant\nhardware handlers" {
    style: { stroke: "#2ea043"; font-size: 10 }
  }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTION D: TRAP GATE â€” type 0xF
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
trap_gate: "TRAP GATE  [type = 0xF = 1111b]" {
  style: {
    fill: "#0a1a0a"
    stroke: "#2ea043"
    border-radius: 8
    font-size: 15
    font-color: "#7ee787"
    bold: true
  }

  tg_byte5_ring0: "DPL=0 â†’ Byte 5 = 0x8F\nP=1 | DPL=00 | S=0 | D=1 | type=111\nOnly ring-0 code / CPU exceptions" {
    style: { fill: "#0d2e0d"; stroke: "#2ea043"; font-color: "#7ee787"; font-size: 12; font: mono }
  }

  tg_byte5_ring3: "DPL=3 â†’ Byte 5 = 0xEF\nP=1 | DPL=11 | S=0 | D=1 | type=111\nUser-callable (e.g. INT 0x80)" {
    style: { fill: "#1a3a5c"; stroke: "#388bfd"; font-color: "#79c0ff"; font-size: 12; font: mono }
  }

  tg_if_behavior: "ðŸŸ¢ IF FLAG BEHAVIOR\nCPU does NOT clear IF.\nHardware IRQs remain ENABLED\nduring handler execution." {
    style: { fill: "#0a2e0a"; stroke: "#2ea043"; font-color: "#7ee787"; font-size: 12; bold: true }
  }

  tg_why: "WHY keep IF set?\nException handlers may do I/O\n(page fault loading a page from disk).\nTimer IRQ must still fire so\nother processes get scheduled\nduring blocking syscalls." {
    style: { fill: "#051505"; stroke: "#2ea043"; font-color: "#56d364"; font-size: 11 }
  }

  tg_used_for: "âœ… USED FOR:\nâ€¢ CPU exceptions (vectors 0â€“31)\n  â€” #DE, #GP, #PF, #DF\nâ€¢ INT 0x80 syscall gate (DPL=3)\nâ€¢ Breakpoints (INT 3, vector 3)" {
    style: { fill: "#0a1f0a"; stroke: "#2ea043"; font-color: "#7ee787"; font-size: 12 }
  }

  tg_reentrant_warn: "âš ï¸  REENTRANCY RISK:\nIf handler is slow AND another\nIRQ fires, handler is interrupted.\nMust be written reentrant-safe\nor use cli/sti carefully." {
    style: { fill: "#2d2000"; stroke: "#e3b341"; font-color: "#f0c843"; font-size: 11 }
  }

  tg_byte5_ring0 -> tg_if_behavior: "type=111 â†’ trap semantics" {
    style: { stroke: "#2ea043"; animated: true; font-size: 10 }
  }
  tg_byte5_ring3 -> tg_if_behavior: "DPL=3 + type=111\nâ†’ user-callable trap" {
    style: { stroke: "#388bfd"; animated: true; font-size: 10 }
  }
  tg_if_behavior -> tg_why: "IF=1 during handler means..." { style: { stroke: "#2ea043"; font-size: 10 } }
  tg_why -> tg_reentrant_warn: "consequence" { style: { stroke: "#e3b341"; stroke-dash: 4; font-size: 10 } }
  tg_if_behavior -> tg_used_for: "required for blocking\nsyscalls & exception handlers" {
    style: { stroke: "#2ea043"; font-size: 10 }
  }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTION E: SIDE-BY-SIDE COMPARISON TABLE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
comparison: "Side-by-Side: Interrupt Gate vs Trap Gate" {
  style: {
    fill: "#0d1117"
    stroke: "#444"
    border-radius: 8
    font-size: 14
    bold: true
  }

  header_prop: "Property" {
    style: { fill: "#21262d"; stroke: "#444"; font-color: "#e6edf3"; font-size: 12; bold: true }
  }
  header_int: "Interrupt Gate (0x8E)" {
    style: { fill: "#2d1a00"; stroke: "#f85149"; font-color: "#ff7b72"; font-size: 12; bold: true }
  }
  header_trap: "Trap Gate (0x8F / 0xEF)" {
    style: { fill: "#0d2e0d"; stroke: "#2ea043"; font-color: "#7ee787"; font-size: 12; bold: true }
  }

  row1_prop: "Type field bits [3:1]" { style: { fill: "#161b22"; stroke: "#444"; font-color: "#c9d1d9"; font-size: 11 } }
  row1_int: "110 (hex D without D-bit)" { style: { fill: "#1a0a00"; stroke: "#f85149"; font-color: "#ffa198"; font-size: 11; font: mono } }
  row1_trap: "111 (hex F without D-bit)" { style: { fill: "#0a1a0a"; stroke: "#2ea043"; font-color: "#56d364"; font-size: 11; font: mono } }

  row2_prop: "Full byte5 (DPL=0, 32-bit)" { style: { fill: "#161b22"; stroke: "#444"; font-color: "#c9d1d9"; font-size: 11 } }
  row2_int: "0x8E\n(P=1|DPL=0|S=0|D=1|110)" { style: { fill: "#1a0a00"; stroke: "#f85149"; font-color: "#ffa198"; font-size: 11; font: mono } }
  row2_trap: "0x8F\n(P=1|DPL=0|S=0|D=1|111)" { style: { fill: "#0a1a0a"; stroke: "#2ea043"; font-color: "#56d364"; font-size: 11; font: mono } }

  row3_prop: "User-callable variant byte5" { style: { fill: "#161b22"; stroke: "#444"; font-color: "#c9d1d9"; font-size: 11 } }
  row3_int: "N/A â€” user cannot trigger\nvia 'int N' (DPL=0 only)" { style: { fill: "#1a0a00"; stroke: "#f85149"; font-color: "#ffa198"; font-size: 11 } }
  row3_trap: "0xEF\n(P=1|DPL=3|S=0|D=1|111)\nâ†’ INT 0x80 syscall gate" { style: { fill: "#1a3a5c"; stroke: "#388bfd"; font-color: "#79c0ff"; font-size: 11; font: mono } }

  row4_prop: "EFLAGS.IF on entry" { style: { fill: "#161b22"; stroke: "#444"; font-color: "#c9d1d9"; font-size: 11 } }
  row4_int: "ðŸ”´ CLEARED (IF=0)\nHardware IRQs disabled" { style: { fill: "#2d0a0a"; stroke: "#f85149"; font-color: "#ff7b72"; font-size: 11; bold: true } }
  row4_trap: "ðŸŸ¢ PRESERVED (IF unchanged)\nHardware IRQs stay enabled" { style: { fill: "#0a2e0a"; stroke: "#2ea043"; font-color: "#7ee787"; font-size: 11; bold: true } }

  row5_prop: "Hardware IRQs during handler" { style: { fill: "#161b22"; stroke: "#444"; font-color: "#c9d1d9"; font-size: 11 } }
  row5_int: "BLOCKED until iret restores\nEFLAGS with original IF bit" { style: { fill: "#1a0a00"; stroke: "#f85149"; font-color: "#ffa198"; font-size: 11 } }
  row5_trap: "ALLOWED â€” timer still fires,\nscheduler still preempts" { style: { fill: "#0a1a0a"; stroke: "#2ea043"; font-color: "#56d364"; font-size: 11 } }

  row6_prop: "Primary use cases" { style: { fill: "#161b22"; stroke: "#444"; font-color: "#c9d1d9"; font-size: 11 } }
  row6_int: "Hardware IRQ handlers\n(vectors 32â€“47)\nPIC remapped IRQs" { style: { fill: "#1a0a00"; stroke: "#f85149"; font-color: "#ffa198"; font-size: 11 } }
  row6_trap: "CPU exceptions (0â€“31)\nINT 0x80 syscall (DPL=3)\nSoftware breakpoints" { style: { fill: "#0a1a0a"; stroke: "#2ea043"; font-color: "#56d364"; font-size: 11 } }

  row7_prop: "Re-entrancy concern" { style: { fill: "#161b22"; stroke: "#444"; font-color: "#c9d1d9"; font-size: 11 } }
  row7_int: "NONE â€” nested IRQs blocked\nHandler cannot be preempted" { style: { fill: "#1a0a00"; stroke: "#f85149"; font-color: "#ffa198"; font-size: 11 } }
  row7_trap: "YES â€” must be reentrant-safe\nor explicitly re-disable IRQs" { style: { fill: "#2d2000"; stroke: "#e3b341"; font-color: "#f0c843"; font-size: 11 } }

  header_prop -> header_int: "" { style: { stroke: "#444" } }
  header_prop -> header_trap: "" { style: { stroke: "#444" } }
  header_int -> row1_int: "" { style: { stroke: "#f85149"; stroke-dash: 3 } }
  header_trap -> row1_trap: "" { style: { stroke: "#2ea043"; stroke-dash: 3 } }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTION F: IDT VECTOR MAP â€” which gate type per vector
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
vector_map: "IDT Vector Assignment & Gate Type for Your Kernel" {
  style: {
    fill: "#0d1117"
    stroke: "#444"
    border-radius: 8
    font-size: 14
    bold: true
  }

  exc_range: "Vectors 0â€“31\nCPU Exceptions\n(Intel reserved)" {
    style: { fill: "#1a0d2e"; stroke: "#8b5cf6"; font-color: "#c084fc"; font-size: 13; bold: true }
  }

  exc_trap: "Gate type: TRAP GATE 0x8F\nDPL=0 (ring-0 only)\nIF preserved on entry\n\nReason: exception handlers may\ncall I/O or sleep â€” they need\ntimer IRQs to keep firing\nso other processes run." {
    style: { fill: "#0a1a0a"; stroke: "#2ea043"; font-color: "#7ee787"; font-size: 11 }
  }

  exc_examples: "Examples:\nv0 = #DE Divide Error â†’ trap 0x8F\nv8 = #DF Double Fault â†’ trap 0x8F\nv13 = #GP General Protection â†’ trap 0x8F\nv14 = #PF Page Fault â†’ trap 0x8F" {
    style: { fill: "#0d1117"; stroke: "#8b5cf6"; font-color: "#c084fc"; font-size: 11; font: mono }
  }

  irq_range: "Vectors 32â€“47\nHardware IRQs\n(PIC remapped)" {
    style: { fill: "#2d1a00"; stroke: "#f0883e"; font-color: "#ffa657"; font-size: 13; bold: true }
  }

  irq_int: "Gate type: INTERRUPT GATE 0x8E\nDPL=0 (hardware only, not user)\nIF cleared on entry\n\nReason: non-reentrant handlers\n(keyboard buffer, disk DMA).\nMust complete atomically.\nEOI sent before iret." {
    style: { fill: "#2d0a0a"; stroke: "#f85149"; font-color: "#ff7b72"; font-size: 11 }
  }

  irq_examples: "Examples:\nv32 = IRQ0 PIT Timer â†’ int 0x8E\nv33 = IRQ1 PS/2 Keyboard â†’ int 0x8E\nv40 = IRQ8 RTC Clock â†’ int 0x8E\nv46 = IRQ14 Primary ATA â†’ int 0x8E" {
    style: { fill: "#0d1117"; stroke: "#f0883e"; font-color: "#ffa657"; font-size: 11; font: mono }
  }

  syscall_range: "Vector 0x80 (128)\nINT 0x80 Syscall Gate" {
    style: { fill: "#1a3a5c"; stroke: "#388bfd"; font-color: "#79c0ff"; font-size: 13; bold: true }
  }

  syscall_trap: "Gate type: TRAP GATE 0xEF\nDPL=3 (user-callable!)\nIF preserved on entry\n\nDPL=3 allows 'int 0x80' from\nring-3 without #GP fault.\nTrap gate so timer IRQ fires\nduring blocking read/write calls." {
    style: { fill: "#1a3a5c"; stroke: "#388bfd"; font-color: "#79c0ff"; font-size: 11 }
  }

  syscall_code: "idt_set_gate(0x80,\n  (uint32_t)isr128,\n  0x08,\n  0xEF);  // DPL=3 trap" {
    style: { fill: "#0d1117"; stroke: "#388bfd"; font-color: "#79c0ff"; font-size: 11; font: mono }
  }

  exc_range -> exc_trap: "assigned gate type" { style: { stroke: "#2ea043"; animated: true } }
  exc_trap -> exc_examples: "concrete vectors" { style: { stroke: "#8b5cf6"; stroke-dash: 3 } }
  irq_range -> irq_int: "assigned gate type" { style: { stroke: "#f85149"; animated: true } }
  irq_int -> irq_examples: "concrete vectors" { style: { stroke: "#f0883e"; stroke-dash: 3 } }
  syscall_range -> syscall_trap: "special DPL=3 assignment" { style: { stroke: "#388bfd"; animated: true } }
  syscall_trap -> syscall_code: "C kernel code" { style: { stroke: "#388bfd"; stroke-dash: 3 } }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTION G: IF FLAG LIFECYCLE DIAGRAM
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if_lifecycle: "EFLAGS.IF Lifecycle: Interrupt Gate vs Trap Gate" {
  style: {
    fill: "#0d1117"
    stroke: "#444"
    border-radius: 8
    font-size: 14
    bold: true
  }

  normal_exec: "Normal Execution\nIF=1 (interrupts enabled)\nProcess running in ring-3 or ring-0" {
    style: { fill: "#0d2e0d"; stroke: "#2ea043"; font-color: "#7ee787"; font-size: 12 }
  }

  irq_fires: "Hardware IRQ fires\n(e.g. PIT timer tick)\nor 'int N' executed" {
    style: { fill: "#2d2000"; stroke: "#e3b341"; font-color: "#f0c843"; font-size: 12 }
  }

  cpu_saves: "CPU pushes to kernel stack:\nEFLAGS (with IF=1 preserved!)\nCS\nEIP\n[SS, ESP if ring-3â†’ring-0]" {
    style: { fill: "#1a1a3a"; stroke: "#8b5cf6"; font-color: "#c084fc"; font-size: 11; font: mono }
  }

  int_gate_path: "ðŸ”´ INTERRUPT GATE PATH\nCPU clears IF automatically\nIF=0 during entire handler\n'sti' optional for nested IRQs\nEOI â†’ iret restores EFLAGS" {
    style: { fill: "#2d0a0a"; stroke: "#f85149"; font-color: "#ff7b72"; font-size: 12; bold: true }
  }

  trap_gate_path: "ðŸŸ¢ TRAP GATE PATH\nIF unchanged (still =1)\nOther IRQs can fire\nduring this handler!\nTimer continues ticking\nScheduler can preempt handler" {
    style: { fill: "#0a2e0a"; stroke: "#2ea043"; font-color: "#7ee787"; font-size: 12; bold: true }
  }

  iret_restore: "iret instruction executes:\nRestores EIP, CS, EFLAGS from stack\nIF bit from SAVED EFLAGS is restored\nBoth paths: IF=1 after iret\n(original state recovered)" {
    style: { fill: "#0d2e3a"; stroke: "#388bfd"; font-color: "#79c0ff"; font-size: 12 }
  }

  normal_exec -> irq_fires: "interrupt event\n(async or sync)" {
    style: { stroke: "#e3b341"; animated: true; font-size: 11 }
  }
  irq_fires -> cpu_saves: "CPU automatically\npushes context" {
    style: { stroke: "#8b5cf6"; font-size: 11 }
  }
  cpu_saves -> int_gate_path: "IDT entry type=0xE\nâ†’ CPU clears IF" {
    style: { stroke: "#f85149"; font-size: 11; font-color: "#f85149" }
  }
  cpu_saves -> trap_gate_path: "IDT entry type=0xF\nâ†’ CPU leaves IF alone" {
    style: { stroke: "#2ea043"; font-size: 11; font-color: "#2ea043" }
  }
  int_gate_path -> iret_restore: "handler completes\niret pops saved EFLAGS" {
    style: { stroke: "#388bfd"; font-size: 11 }
  }
  trap_gate_path -> iret_restore: "handler completes\niret pops saved EFLAGS" {
    style: { stroke: "#388bfd"; font-size: 11 }
  }
  iret_restore -> normal_exec: "execution resumes\nIF=1 restored\nnormal operation" {
    style: { stroke: "#2ea043"; animated: true; font-size: 11 }
  }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTION H: COMPLETE 8-BYTE BINARY ENCODING EXAMPLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
binary_examples: "Concrete 8-Byte Encodings for Your Kernel" {
  style: {
    fill: "#0d1117"
    stroke: "#444"
    border-radius: 8
    font-size: 14
    bold: true
  }

  ex_irq_timer: |md
    **IRQ0 Timer Handler â€” Interrupt Gate (0x8E, DPL=0)**
    
    Byte: [7]    [6]    [5]    [4]    [3]    [2]    [1]    [0]
    Hex:   XX     XX    0x8E   0x00   0x08   0x00   lo(handler) lo(handler)
          ^^^^         ^^^^          ^^^^
        offset[31:16] type+attr   selector    offset[15:0]
    
    Byte 5 = 0x8E = 1000_1110b
                    ^ present
                     ^^ DPL=0 (ring-0 only, hardware delivers)
                        ^ S=0 (system descriptor)
                          ^ D=1 (32-bit gate)
                           ^^^ type=110 = INTERRUPT gate â†’ clears IF
    
  | {
    style: { fill: "#1a0505"; stroke: "#f85149"; font-size: 11; font-color: "#ff7b72" }
  }

  ex_pf_handler: |md
    **#PF Page Fault Handler â€” Trap Gate (0x8F, DPL=0)**
    
    Byte: [7]    [6]    [5]    [4]    [3]    [2]    [1]    [0]
    Hex:   XX     XX    0x8F   0x00   0x08   0x00   lo(handler) lo(handler)
                  ^^^^
              type+attr = 0x8F
    
    Byte 5 = 0x8F = 1000_1111b
                    ^ present
                     ^^ DPL=0 (ring-0 only, CPU exceptions self-deliver)
                        ^ S=0
                          ^ D=1 (32-bit)
                           ^^^ type=111 = TRAP gate â†’ preserves IF
    
  | {
    style: { fill: "#051505"; stroke: "#2ea043"; font-size: 11; font-color: "#7ee787" }
  }

  ex_syscall: |md
    **INT 0x80 Syscall â€” Trap Gate (0xEF, DPL=3)**
    
    Byte: [7]    [6]    [5]    [4]    [3]    [2]    [1]    [0]
    Hex:   XX     XX    0xEF   0x00   0x08   0x00   lo(handler) lo(handler)
                  ^^^^
              type+attr = 0xEF  â† THE CRITICAL DIFFERENCE
    
    Byte 5 = 0xEF = 1110_1111b
                    ^ present
                     ^^ DPL=3 â† user-mode CAN invoke via 'int 0x80'
                        ^ S=0       without triggering #GP!
                          ^ D=1 (32-bit)
                           ^^^ type=111 = TRAP gate â†’ IF preserved
                                (timer fires during blocking syscalls)
    
  | {
    style: { fill: "#051a2e"; stroke: "#388bfd"; font-size: 11; font-color: "#79c0ff" }
  }

  ex_irq_timer -> ex_pf_handler: "only bit differs:\ntype 110â†’111\n(INTâ†’TRAP)" {
    style: { stroke: "#8b5cf6"; stroke-dash: 4; font-size: 10 }
  }
  ex_pf_handler -> ex_syscall: "DPL changes:\n0â†’3\n(ring0â†’user-callable)" {
    style: { stroke: "#388bfd"; stroke-dash: 4; font-size: 10 }
  }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CROSS-SECTION CONNECTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
byte_layout -> type_attr_byte: "Byte 5 exploded\ninto bit fields" {
  style: { stroke: "#8b5cf6"; animated: true; font-size: 11 }
}
type_attr_byte -> interrupt_gate: "type bits 3:1 = 110\nâ†’ interrupt gate" {
  style: { stroke: "#f85149"; font-size: 11; font-color: "#f85149" }
}
type_attr_byte -> trap_gate: "type bits 3:1 = 111\nâ†’ trap gate" {
  style: { stroke: "#2ea043"; font-size: 11; font-color: "#2ea043" }
}
interrupt_gate -> comparison: "INT gate column" {
  style: { stroke: "#f85149"; stroke-dash: 3; font-size: 10 }
}
trap_gate -> comparison: "TRAP gate column" {
  style: { stroke: "#2ea043"; stroke-dash: 3; font-size: 10 }
}
comparison -> vector_map: "which gate for\nwhich vector range" {
  style: { stroke: "#e3b341"; font-size: 10 }
}
vector_map -> if_lifecycle: "IF behavior\nper gate type" {
  style: { stroke: "#388bfd"; font-size: 10 }
}
if_lifecycle -> binary_examples: "concrete byte5\nencodings" {
  style: { stroke: "#8b5cf6"; font-size: 10 }
}