vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # PIC Default Mapping vs CPU Exception Vectors
  ## The Vector Collision Problem and the ICW Remapping Fix
| {near: top-center}

before: "BEFORE: Default PIC State (Factory Reset)" {
  style: {
    fill: "#1a0000"
    stroke: "#cc0000"
    stroke-width: 3
    border-radius: 8
  }

  cpu_exc: "CPU Exception Vector Table (Intel 286 Spec, 1982)" {
    style: {
      fill: "#2a0a0a"
      stroke: "#ff4444"
      stroke-width: 2
      border-radius: 6
    }

    v0: "Vector 0 — Divide Error #DE" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v1: "Vector 1 — Debug #DB" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v2: "Vector 2 — NMI Non-Maskable Interrupt" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v3: "Vector 3 — Breakpoint #BP" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v4: "Vector 4 — Overflow #OF" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v5: "Vector 5 — Bound Range #BR" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v6: "Vector 6 — Invalid Opcode #UD" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v7: "Vector 7 — Device Not Available #NM" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v8_df: "Vector 8 — DOUBLE FAULT #DF ← COLLISION TARGET" {
      style.fill: "#3d0000"
      style.stroke: "#ff0000"
      style.stroke-width: 4
      style.bold: true
      style.border-radius: 4
    }
    v9: "Vector 9 — Coprocessor Overrun (legacy)" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v10: "Vector 10 — Invalid TSS #TS" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v11: "Vector 11 — Segment Not Present #NP" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v12: "Vector 12 — Stack-Segment Fault #SS" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v13_gpf: "Vector 13 — GENERAL PROTECTION FAULT #GP ← COLLISION TARGET" {
      style.fill: "#3d0000"
      style.stroke: "#ff0000"
      style.stroke-width: 4
      style.bold: true
      style.border-radius: 4
    }
    v14_pf: "Vector 14 — PAGE FAULT #PF ← COLLISION TARGET" {
      style.fill: "#3d0000"
      style.stroke: "#ff0000"
      style.stroke-width: 4
      style.bold: true
      style.border-radius: 4
    }
    v15: "Vector 15 — Reserved" {style.fill: "#1e1e1e"; style.stroke: "#555"; style.border-radius: 4}
    v16_31: "Vectors 16-31 — FPU, SIMD, Reserved CPU Exceptions" {style.fill: "#222"; style.stroke: "#444"; style.border-radius: 4}
  }

  pic_default: "8259 PIC Default Mapping (Intel 8259 Chip, 1976)" {
    style: {
      fill: "#0a1a2a"
      stroke: "#ff8800"
      stroke-width: 2
      border-radius: 6
    }

    master_lbl: "MASTER PIC (ports 0x20/0x21) — IRQ0-7 maps to Vectors 8-15 by default" {
      style.fill: "#1a2a3a"
      style.stroke: "#ff8800"
      style.bold: true
      style.border-radius: 4
    }

    irq0_def: "IRQ0  PIT Timer    →  Vector 8   ← DEADLY COLLISION" {
      style.fill: "#3d1500"
      style.stroke: "#ff0000"
      style.stroke-width: 4
      style.bold: true
      style.border-radius: 4
    }
    irq1_def: "IRQ1  Keyboard    →  Vector 9   (collision: Coprocessor Overrun)" {
      style.fill: "#3d1a00"
      style.stroke: "#ff6600"
      style.stroke-width: 2
      style.border-radius: 4
    }
    irq2_def: "IRQ2  Cascade     →  Vector 10  (collision: Invalid TSS)" {style.fill: "#2a1a00"; style.stroke: "#aa5500"; style.border-radius: 4}
    irq3_def: "IRQ3  COM2        →  Vector 11  (collision: Segment Not Present)" {style.fill: "#2a1a00"; style.stroke: "#aa5500"; style.border-radius: 4}
    irq4_def: "IRQ4  COM1        →  Vector 12  (collision: Stack-Segment Fault)" {style.fill: "#2a1a00"; style.stroke: "#aa5500"; style.border-radius: 4}
    irq5_def: "IRQ5  LPT2/Sound  →  Vector 13  ← DEADLY COLLISION (GPF)" {
      style.fill: "#3d1500"
      style.stroke: "#ff4400"
      style.stroke-width: 3
      style.bold: true
      style.border-radius: 4
    }
    irq6_def: "IRQ6  Floppy      →  Vector 14  ← DEADLY COLLISION (Page Fault)" {
      style.fill: "#3d1500"
      style.stroke: "#ff4400"
      style.stroke-width: 3
      style.bold: true
      style.border-radius: 4
    }
    irq7_def: "IRQ7  LPT1/Spur.  →  Vector 15  (collision: Reserved)" {
      style.fill: "#3d1a00"
      style.stroke: "#ff6600"
      style.stroke-width: 2
      style.border-radius: 4
    }

    slave_lbl: "SLAVE PIC (ports 0xA0/0xA1) — IRQ8-15 maps to Vectors 112-119 (no collision here)" {
      style.fill: "#1a2a3a"
      style.stroke: "#558855"
      style.bold: true
      style.border-radius: 4
    }
    irq8_15_def: "IRQ8-15  →  Vectors 112-119 (0x70-0x77)  safe by accident" {style.fill: "#1a2a1a"; style.stroke: "#558855"; style.border-radius: 4}
  }

  pic_default.irq0_def -> cpu_exc.v8_df: "IRQ0 timer tick hits #DF handler → triple fault → instant reboot at 55ms" {
    style.stroke: "#ff0000"
    style.stroke-width: 4
    style.font-color: "#ff4444"
    style.bold: true
    style.animated: true
  }

  pic_default.irq5_def -> cpu_exc.v13_gpf: "IRQ5 sound hits #GP handler — spurious interrupt looks like kernel GPF" {
    style.stroke: "#ff4400"
    style.stroke-width: 3
    style.stroke-dash: 3
    style.font-color: "#ff8844"
    style.bold: true
  }

  pic_default.irq6_def -> cpu_exc.v14_pf: "IRQ6 floppy hits #PF handler — disk interrupt misidentified as page fault" {
    style.stroke: "#ff4400"
    style.stroke-width: 3
    style.stroke-dash: 3
    style.font-color: "#ff8844"
    style.bold: true
  }
}

collision_panel: "COLLISION ANALYSIS — Why Default PIC Kills Protected Mode" {
  style: {
    fill: "#1a0a00"
    stroke: "#ff6600"
    stroke-width: 3
    border-radius: 8
  }

  fatal: "FATAL: The First Timer Tick (IRQ0 hits Vector 8)" {
    style: {
      fill: "#2a0000"
      stroke: "#ff0000"
      stroke-width: 4
      bold: true
      border-radius: 6
    }

    step1: "1. sti enables interrupts after IDT setup" {style.fill: "#1a0000"; style.stroke: "#aa2200"; style.border-radius: 4}
    step2: "2. PIT fires IRQ0 after ~55ms (default 18.2 Hz)" {style.fill: "#1a0000"; style.stroke: "#aa2200"; style.border-radius: 4}
    step3: "3. PIC sends vector 8 to CPU (default mapping)" {style.fill: "#2a0000"; style.stroke: "#ff2200"; style.border-radius: 4}
    step4: "4. CPU invokes Double Fault handler — NOT timer handler!" {style.fill: "#3a0000"; style.stroke: "#ff0000"; style.stroke-width: 3; style.bold: true; style.border-radius: 4}
    step5: "5. Double fault handler faults again inside itself" {style.fill: "#3a0000"; style.stroke: "#ff0000"; style.stroke-width: 3; style.bold: true; style.border-radius: 4}
    step6: "6. CPU cannot re-invoke #DF handler → TRIPLE FAULT" {style.fill: "#4a0000"; style.stroke: "#ff0000"; style.stroke-width: 4; style.bold: true; style.border-radius: 4}
    step7: "7. Machine resets. Zero error message. Zero diagnostic." {style.fill: "#4a0000"; style.stroke: "#ff2200"; style.stroke-width: 3; style.bold: true; style.border-radius: 4}

    step1 -> step2 -> step3 -> step4 -> step5 -> step6 -> step7
  }

  collision_table: "All Active Collisions — Vectors 8-15" {
    style: {
      fill: "#1a0000"
      stroke: "#cc4400"
      stroke-width: 2
      border-radius: 4
    }

    row_irq0: "IRQ0  PIT Timer       default vec 8    hits Double Fault #DF      ← LETHAL" {
      style.fill: "#3d0000"; style.stroke: "#ff0000"; style.stroke-width: 3; style.bold: true; style.border-radius: 4
    }
    row_irq1: "IRQ1  PS/2 Keyboard   default vec 9    hits Coprocessor Overrun   ← WRONG" {
      style.fill: "#2a1000"; style.stroke: "#cc6600"; style.border-radius: 4
    }
    row_irq2: "IRQ2  PIC Cascade     default vec 10   hits Invalid TSS #TS       ← WRONG" {
      style.fill: "#2a1000"; style.stroke: "#cc6600"; style.border-radius: 4
    }
    row_irq3: "IRQ3  COM2 Serial     default vec 11   hits Segment Not Present   ← WRONG" {
      style.fill: "#2a1000"; style.stroke: "#cc6600"; style.border-radius: 4
    }
    row_irq4: "IRQ4  COM1 Serial     default vec 12   hits Stack-Segment Fault   ← WRONG" {
      style.fill: "#2a1000"; style.stroke: "#cc6600"; style.border-radius: 4
    }
    row_irq5: "IRQ5  LPT2/Sound      default vec 13   hits General Protection #GP ← LETHAL" {
      style.fill: "#3d0000"; style.stroke: "#ff4400"; style.stroke-width: 3; style.bold: true; style.border-radius: 4
    }
    row_irq6: "IRQ6  Floppy Disk     default vec 14   hits Page Fault #PF        ← LETHAL" {
      style.fill: "#3d0000"; style.stroke: "#ff4400"; style.stroke-width: 3; style.bold: true; style.border-radius: 4
    }
    row_irq7: "IRQ7  LPT1/Spurious   default vec 15   hits Reserved              ← WRONG" {
      style.fill: "#2a1000"; style.stroke: "#cc6600"; style.border-radius: 4
    }
  }
}

icw_sequence: "ICW Initialization Protocol — Reprogramming the 8259 PIC" {
  style: {
    fill: "#001a00"
    stroke: "#00cc44"
    stroke-width: 3
    border-radius: 8
  }

  icw_label: "pic_remap(0x20, 0x28) — Four ICW Words sent to Two PICs in Strict Order" {
    style.fill: "#002a00"
    style.stroke: "#00aa33"
    style.bold: true
    style.border-radius: 4
  }

  icw1: "ICW1 — Start Initialization (both PICs simultaneously)" {
    style.fill: "#001a10"
    style.stroke: "#00aa44"
    style.border-radius: 6

    desc: "outb(0x20, 0x11) Master ICW1_INIT|ICW1_ICW4\noutb(0xA0, 0x11) Slave  ICW1_INIT|ICW1_ICW4\nio_wait() between each — ~1us delay for old hardware\nPIC enters init state machine awaiting ICW2" {
      style.fill: "#002a10"
      style.stroke: "#009933"
      style.border-radius: 4
      style.font: mono
    }
  }

  icw2: "ICW2 — Set Vector Offsets  THE CRITICAL REMAP STEP" {
    style.fill: "#002a10"
    style.stroke: "#00ff44"
    style.stroke-width: 4
    style.bold: true
    style.border-radius: 6

    desc: "outb(0x21, 0x20) Master: IRQ0-7 -> vectors 32-39  (0x20=32)\noutb(0xA1, 0x28) Slave:  IRQ8-15 -> vectors 40-47 (0x28=40)\nCollision with CPU exceptions eliminated after this step" {
      style.fill: "#003a10"
      style.stroke: "#00ff44"
      style.stroke-width: 2
      style.border-radius: 4
      style.font: mono
    }
  }

  icw3: "ICW3 — Configure Cascade Wiring" {
    style.fill: "#001a10"
    style.stroke: "#00aa44"
    style.border-radius: 6

    desc: "outb(0x21, 0x04) Master: slave on IRQ2 (bit2=0x04)\noutb(0xA1, 0x02) Slave:  its cascade ID = line 2\nLinks master IRQ2 pin to slave PIC output" {
      style.fill: "#002a10"
      style.stroke: "#009933"
      style.border-radius: 4
      style.font: mono
    }
  }

  icw4: "ICW4 — Set 8086 Mode" {
    style.fill: "#001a10"
    style.stroke: "#00aa44"
    style.border-radius: 6

    desc: "outb(0x21, 0x01) Master: 8086 mode (ICW4_8086)\noutb(0xA1, 0x01) Slave:  8086 mode\nRestore saved IMR masks — remapping complete" {
      style.fill: "#002a10"
      style.stroke: "#009933"
      style.border-radius: 4
      style.font: mono
    }
  }

  icw1 -> icw2: "PIC enters init state machine" {style.stroke: "#00aa44"; style.animated: true}
  icw2 -> icw3: "Offset registered — collision eliminated" {style.stroke: "#00ff44"; style.stroke-width: 2; style.animated: true}
  icw3 -> icw4: "Cascade wired correctly" {style.stroke: "#00aa44"; style.animated: true}
}

after: "AFTER: Remapped PIC State — Safe for Protected Mode" {
  style: {
    fill: "#001a00"
    stroke: "#00cc44"
    stroke-width: 3
    border-radius: 8
  }

  zone_cpu: "ZONE A — CPU Exceptions ONLY  Vectors 0-31  (32 entries reserved by Intel)" {
    style: {
      fill: "#1a1a00"
      stroke: "#aaaa00"
      stroke-width: 2
      bold: true
      border-radius: 6
    }

    exc_safe: "Vectors 0-31 — CPU exceptions — no IRQ will ever land here after remap" {
      style.fill: "#222200"
      style.stroke: "#888800"
      style.border-radius: 4
    }
    v8_safe: "Vector 8  Double Fault #DF  — SAFE: no IRQ mapped here anymore" {
      style.fill: "#1a2a00"
      style.stroke: "#88cc00"
      style.stroke-width: 2
      style.bold: true
      style.border-radius: 4
    }
    v13_safe: "Vector 13  GPF #GP  — SAFE: no IRQ mapped here anymore" {
      style.fill: "#1a2a00"
      style.stroke: "#88cc00"
      style.stroke-width: 2
      style.bold: true
      style.border-radius: 4
    }
    v14_safe: "Vector 14  Page Fault #PF  — SAFE: no IRQ mapped here anymore" {
      style.fill: "#1a2a00"
      style.stroke: "#88cc00"
      style.stroke-width: 2
      style.bold: true
      style.border-radius: 4
    }
  }

  safe_gap: "=== SAFE BOUNDARY: Vector 31 is last CPU exception | Vector 32 is first IRQ ===" {
    style: {
      fill: "#003300"
      stroke: "#00ff44"
      stroke-width: 5
      bold: true
      border-radius: 6
    }
    gap_detail: "Gap of 1 vector separates CPU exception space from hardware IRQ space — zero overlap guaranteed" {
      style.fill: "#004400"
      style.stroke: "#00cc44"
      style.stroke-width: 2
      style.border-radius: 4
    }
  }

  zone_irq: "ZONE B — Hardware IRQs  Vectors 32-47  (remapped by ICW2)" {
    style: {
      fill: "#001a10"
      stroke: "#00cc44"
      stroke-width: 2
      bold: true
      border-radius: 6
    }

    master_new: "MASTER PIC — IRQ0-7 → Vectors 32-39  after pic_remap(0x20, 0x28)" {
      style.fill: "#002a10"
      style.stroke: "#00aa44"
      style.bold: true
      style.border-radius: 6

      irq0_new: "IRQ0  PIT Timer       →  Vector 32  (0x20)  OK" {style.fill: "#003a10"; style.stroke: "#00cc44"; style.stroke-width: 2; style.border-radius: 4}
      irq1_new: "IRQ1  PS/2 Keyboard   →  Vector 33  (0x21)  OK" {style.fill: "#003a10"; style.stroke: "#00cc44"; style.stroke-width: 2; style.border-radius: 4}
      irq2_new: "IRQ2  PIC Cascade     →  Vector 34  (0x22)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
      irq3_new: "IRQ3  COM2 Serial     →  Vector 35  (0x23)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
      irq4_new: "IRQ4  COM1 Serial     →  Vector 36  (0x24)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
      irq5_new: "IRQ5  LPT2/Sound      →  Vector 37  (0x25)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
      irq6_new: "IRQ6  Floppy Disk     →  Vector 38  (0x26)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
      irq7_new: "IRQ7  LPT1/Spurious   →  Vector 39  (0x27)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
    }

    slave_new: "SLAVE PIC — IRQ8-15 → Vectors 40-47  after pic_remap(0x20, 0x28)" {
      style.fill: "#002a10"
      style.stroke: "#00aa44"
      style.bold: true
      style.border-radius: 6

      irq8_new:  "IRQ8   RTC Clock         →  Vector 40  (0x28)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
      irq9_new:  "IRQ9   ACPI/Legacy SCSI  →  Vector 41  (0x29)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
      irq10_new: "IRQ10  Free              →  Vector 42  (0x2A)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
      irq11_new: "IRQ11  Free              →  Vector 43  (0x2B)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
      irq12_new: "IRQ12  PS/2 Mouse        →  Vector 44  (0x2C)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
      irq13_new: "IRQ13  FPU               →  Vector 45  (0x2D)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
      irq14_new: "IRQ14  Primary ATA       →  Vector 46  (0x2E)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
      irq15_new: "IRQ15  Secondary ATA     →  Vector 47  (0x2F)  OK" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
    }
  }

  zone_sw: "ZONE C — Software Interrupts  Vectors 48-255  (available for kernel use)" {
    style: {
      fill: "#0a0a1a"
      stroke: "#4444aa"
      stroke-width: 2
      bold: true
      border-radius: 6
    }
    sw_detail: "Vector 128 (0x80) = System call gate  INT 0x80  DPL=3 trap gate — Milestone 4" {
      style.fill: "#0a0a2a"
      style.stroke: "#6666cc"
      style.border-radius: 4
    }
  }

  eoi_note: "MANDATORY: EOI after every IRQ handler — or that IRQ line is silently masked forever" {
    style: {
      fill: "#002000"
      stroke: "#00aa33"
      stroke-width: 2
      border-radius: 6
    }
    eoi_rule_master: "If IRQ < 8:   outb(0x20, 0x20) — EOI to master only" {style.fill: "#002a10"; style.stroke: "#009933"; style.border-radius: 4}
    eoi_rule_slave:  "If IRQ >= 8:  outb(0xA0, 0x20) then outb(0x20, 0x20) — EOI slave then master" {style.fill: "#002a10"; style.stroke: "#00cc44"; style.stroke-width: 2; style.border-radius: 4}
    eoi_consequence: "Forget EOI: PIC sets ISR bit permanently → IRQ line goes dead silently → timer stops → no crash warning" {
      style.fill: "#1a0000"
      style.stroke: "#cc4400"
      style.stroke-width: 2
      style.border-radius: 4
    }
  }
}

ordering: "MANDATORY Boot Ordering — pic_remap() Before sti" {
  style: {
    fill: "#0a0a0a"
    stroke: "#ffaa00"
    stroke-width: 3
    border-radius: 8
  }

  step1: "Step 1  idt_setup_all()         Load IDT 256 entries" {style.fill: "#1a1a00"; style.stroke: "#aaaa00"; style.border-radius: 4}
  step2: "Step 2  pic_remap(0x20, 0x28)   Remap PIC BEFORE enabling interrupts  ← MANDATORY" {style.fill: "#1a0a00"; style.stroke: "#ffaa00"; style.stroke-width: 3; style.border-radius: 4; style.bold: true}
  step3: "Step 3  pit_init(100)            Configure PIT at 100 Hz" {style.fill: "#001a00"; style.stroke: "#00aa33"; style.border-radius: 4}
  step4: "Step 4  keyboard_init()          Register IRQ1 handler" {style.fill: "#001a00"; style.stroke: "#00aa33"; style.border-radius: 4}
  step5: "Step 5  sti                      Enable interrupts LAST" {style.fill: "#001500"; style.stroke: "#00cc44"; style.stroke-width: 2; style.border-radius: 4; style.bold: true}

  step1 -> step2: "IDT valid before any IRQ fires" {style.stroke: "#aaaa00"}
  step2 -> step3: "PIC safe — IRQs now map to vectors 32+" {style.stroke: "#00aa44"}
  step3 -> step4: "Timer configured before first tick" {style.stroke: "#00aa44"}
  step4 -> step5: "All handlers registered — safe to go live" {style.stroke: "#00cc44"; style.stroke-width: 2}
}

before -> collision_panel: "Default factory state produces these fatal collisions" {
  style.stroke: "#ff4400"
  style.stroke-width: 3
  style.font-color: "#ff6644"
  style.bold: true
}

collision_panel -> icw_sequence: "Fix: send ICW1 through ICW4 to both PICs before sti" {
  style.stroke: "#ffaa00"
  style.stroke-width: 3
  style.font-color: "#ffcc44"
  style.bold: true
}

icw_sequence -> after: "Result: clean vector space — zero collisions" {
  style.stroke: "#00cc44"
  style.stroke-width: 3
  style.font-color: "#44ff88"
  style.bold: true
  style.animated: true
}

after -> ordering: "Even with safe mapping — boot ordering of calls is still mandatory" {
  style.stroke: "#00aa44"
  style.stroke-dash: 3
  style.font-color: "#44cc66"
}