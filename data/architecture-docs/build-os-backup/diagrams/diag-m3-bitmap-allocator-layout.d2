vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Physical Frame Allocator: Bitmap Data Structure
  **Microscopic view** â€” 128MB RAM, 4KB pages, 32768 frames, 4096 bytes bitmap
| {near: top-center}

legend: {
  near: bottom-right
  style: {
    fill: "#1a1a2e"
    stroke: "#444488"
    border-radius: 8
    font-size: 13
  }
  used_frame: "Red = Used / Hot path" {
    style.fill: "#3d0000"
    style.font-color: "#ff6b6b"
    style.border-radius: 4
  }
  free_frame: "Green = Free frame" {
    style.fill: "#003d00"
    style.font-color: "#6bff6b"
    style.border-radius: 4
  }
  meta: "Purple = Metadata" {
    style.fill: "#2d003d"
    style.font-color: "#cc88ff"
    style.border-radius: 4
  }
  data_flow: "Blue = Data flow" {
    style.fill: "#00103d"
    style.font-color: "#88aaff"
    style.border-radius: 4
  }
  yellow_wait: "Yellow = Caution/hint" {
    style.fill: "#3d3d00"
    style.font-color: "#ffff44"
    style.border-radius: 4
  }
}

phys_space: "Physical Address Space: 128MB RAM" {
  style: {
    fill: "#0d1b2a"
    stroke: "#336699"
    stroke-width: 2
    border-radius: 8
    font-size: 15
    bold: true
    font-color: "#88ccff"
  }

  frame0: "Frame 0\n0x00000000\nUSED: IVT+BIOS" {
    style.fill: "#3d0000"
    style.stroke: "#ff4444"
    style.font-color: "#ff8888"
    style.border-radius: 4
    style.font-size: 11
  }
  frame1: "Frame 1\n0x00001000\nUSED: EBDA" {
    style.fill: "#3d0000"
    style.stroke: "#ff4444"
    style.font-color: "#ff8888"
    style.border-radius: 4
    style.font-size: 11
  }
  frame_vga: "Frame 0xB8\n0x000B8000\nUSED: VGA MMIO" {
    style.fill: "#3d2200"
    style.stroke: "#ff8800"
    style.font-color: "#ffaa44"
    style.border-radius: 4
    style.font-size: 11
  }
  frame256: "Frame 256\n0x00100000\nUSED: Kernel" {
    style.fill: "#2d003d"
    style.stroke: "#aa44ff"
    style.font-color: "#cc88ff"
    style.border-radius: 4
    style.font-size: 11
  }
  frame_bitmap: "Frame 512\n0x00200000\nUSED: Bitmap itself" {
    style.fill: "#2d003d"
    style.stroke: "#aa44ff"
    style.font-color: "#cc88ff"
    style.border-radius: 4
    style.font-size: 11
    style.bold: true
  }
  frame_free1: "Frame 768\n0x00300000\nFREE (first alloc)" {
    style.fill: "#003d00"
    style.stroke: "#44ff44"
    style.font-color: "#88ff88"
    style.border-radius: 4
    style.font-size: 11
  }
  frame_last: "Frame 32767\n0x07FFF000\nFREE" {
    style.fill: "#003d00"
    style.stroke: "#44ff44"
    style.font-color: "#88ff88"
    style.border-radius: 4
    style.font-size: 11
  }

  frame0 -> frame1: "4096 bytes/frame" {
    style.stroke: "#555577"
    style.font-size: 10
    style.font-color: "#aaaacc"
  }
  frame1 -> frame_vga: "..." {
    style.stroke: "#555577"
    style.stroke-dash: 4
    style.font-size: 10
  }
  frame_vga -> frame256: "..." {
    style.stroke: "#555577"
    style.stroke-dash: 4
    style.font-size: 10
  }
  frame256 -> frame_bitmap: "Kernel ~256 frames" {
    style.stroke: "#aa44ff"
    style.font-size: 10
    style.font-color: "#cc88ff"
  }
  frame_bitmap -> frame_free1: "First free after kernel+bitmap" {
    style.stroke: "#44ff44"
    style.font-size: 10
    style.font-color: "#88ff88"
  }
  frame_free1 -> frame_last: "31999 more free frames" {
    style.stroke: "#44ff44"
    style.stroke-dash: 4
    style.font-size: 10
    style.font-color: "#88ff88"
  }
}

index_calc: "Index Calculation: Physical Address to Bitmap Bit" {
  style: {
    fill: "#0a1628"
    stroke: "#4488bb"
    stroke-width: 2
    border-radius: 8
    font-size: 14
    bold: true
    font-color: "#88ccff"
  }

  addr_decomp: "Physical Addr: 0x00300000 (frame 768)\nStep 1: frame_number = addr >> 12 = 768\nStep 2: word_index  = frame_number / 32 = 24\nStep 3: bit_index   = frame_number % 32 = 0\nResult: bitmap[24] bit 0" {
    style.fill: "#0a1628"
    style.font-size: 13
    style.border-radius: 6
    style.stroke: "#336699"
    style.font-color: "#aaccff"
  }

  c_macros: |`c
#define ADDR_TO_FRAME(a)  ((a) >> 12)

static inline void bitmap_set(uint32_t frame) {
    bitmap[frame/32] |=  (1U << (frame%32));
}
static inline void bitmap_clear(uint32_t frame) {
    bitmap[frame/32] &= ~(1U << (frame%32));
}
static inline int bitmap_test(uint32_t frame) {
    return (bitmap[frame/32] >> (frame%32)) & 1;
}
`| {
    style.fill: "#0d1117"
    style.font-size: 12
    style.border-radius: 6
    style.stroke: "#4488bb"
  }
}

bitmap_array: "Bitmap Array: uint32_t frame_bitmap[1024] -- 4KB total for 128MB RAM" {
  style: {
    fill: "#0a0a1e"
    stroke: "#8844ff"
    stroke-width: 2
    border-radius: 8
    font-size: 14
    bold: true
    font-color: "#cc88ff"
  }

  size_note: "Size: 128MB / 4KB = 32768 frames\n32768 / 8 bits = 4096 bytes = 4KB\n4096 / 4 = 1024 uint32_t entries\nEntire bitmap fits in ONE 4KB frame!\nOne 64-byte cache line covers 512 frames = 2MB RAM" {
    style.fill: "#0a0a1e"
    style.font-size: 13
    style.border-radius: 6
    style.stroke: "#6633cc"
    style.font-color: "#ddaaff"
  }

  word0: "bitmap[0]\nFrames 0-31\n= 0xFFFFFFFF\nall USED: IVT/BIOS" {
    style.fill: "#3d0000"
    style.stroke: "#ff4444"
    style.font-color: "#ff8888"
    style.border-radius: 4
    style.font-size: 11
    style.bold: true
  }
  word1: "bitmap[1]\nFrames 32-63\n= 0xFFFFFFFF\nall USED" {
    style.fill: "#3d0000"
    style.stroke: "#ff4444"
    style.font-color: "#ff8888"
    style.border-radius: 4
    style.font-size: 11
  }
  word8: "bitmap[8]\nFrames 256-287\n= 0xFFFFFFFF\nKernel code" {
    style.fill: "#2d003d"
    style.stroke: "#aa44ff"
    style.font-color: "#cc88ff"
    style.border-radius: 4
    style.font-size: 11
    style.bold: true
  }
  word16: "bitmap[16]\nFrames 512-543\n= 0xFFFFFFFF\nBitmap frame" {
    style.fill: "#2d003d"
    style.stroke: "#aa44ff"
    style.font-color: "#cc88ff"
    style.border-radius: 4
    style.font-size: 11
  }
  word24: "bitmap[24] SCAN TARGET\nFrames 768-799\n= 0x00000000\nall 32 frames FREE!" {
    style.fill: "#003300"
    style.stroke: "#00ff44"
    style.font-color: "#44ff88"
    style.border-radius: 4
    style.font-size: 12
    style.bold: true
    style.stroke-width: 3
    style.shadow: true
  }
  word25: "bitmap[25]\nFrames 800-831\n= 0x00000000\nall FREE" {
    style.fill: "#003d00"
    style.stroke: "#44ff44"
    style.font-color: "#88ff88"
    style.border-radius: 4
    style.font-size: 11
  }
  word1023: "bitmap[1023]\nFrames 32736-32767\n= 0x00000000\nall FREE" {
    style.fill: "#003d00"
    style.stroke: "#44ff44"
    style.font-color: "#88ff88"
    style.border-radius: 4
    style.font-size: 11
  }

  word0 -> word1: "" { style.stroke: "#554444" }
  word1 -> word8: "words 2-7: USED (BIOS region)" {
    style.stroke: "#554444"
    style.stroke-dash: 4
    style.font-size: 10
    style.font-color: "#888866"
  }
  word8 -> word16: "words 9-15: kernel+bitmap USED" {
    style.stroke: "#6633aa"
    style.font-size: 10
    style.font-color: "#aa88cc"
  }
  word16 -> word24: "search_hint skips to first non-0xFF word\n(O(1) amortized)" {
    style.stroke: "#ffff44"
    style.font-color: "#ffff88"
    style.font-size: 11
    style.stroke-width: 2
    style.animated: true
  }
  word24 -> word25: "" { style.stroke: "#44ff44" }
  word25 -> word1023: "998 more free words" {
    style.stroke: "#44ff44"
    style.stroke-dash: 4
    style.font-size: 10
    style.font-color: "#88ff88"
  }
}

word24_zoom: "Zoom: bitmap[24] = 0x00000000 -- Frames 768-799 all FREE" {
  style: {
    fill: "#001a00"
    stroke: "#00cc44"
    stroke-width: 2
    border-radius: 8
    font-size: 14
    bold: true
    font-color: "#44ff88"
  }

  bit_layout: "bit31 bit30 ... bit1 bit0\n[  0  ][  0  ]...[  0  ][  0  ]  ALL ZERO = ALL FREE\n F799  F798      F769  F768\n\nframe_number = 24*32 + 0 = 768\nphysical_addr = 768 << 12 = 0x00300000" {
    style.fill: "#001a00"
    style.font-size: 12
    style.border-radius: 6
    style.stroke: "#00aa33"
    style.font-color: "#88ffaa"
    style.font: mono
  }

  bsf_note: "BSF (Bit Scan Forward) x86 optimization:\nnot eax        ; invert: FREE=0 becomes 1\nbsf edx, eax  ; lowest set bit in 3-5 cycles\n               ; vs naive loop: up to 32 iters\nframe = word_index*32 + edx\naddr  = frame << 12 = 0x00300000" {
    style.fill: "#001500"
    style.font-size: 12
    style.border-radius: 6
    style.stroke: "#006622"
    style.font-color: "#66ee88"
    style.font: mono
  }
}

alloc_algo: "pmm_alloc_frame() -- Annotated Hot Path" {
  style: {
    fill: "#0d0d22"
    stroke: "#ff4444"
    stroke-width: 2
    border-radius: 8
    font-size: 14
    bold: true
    font-color: "#ff8888"
  }

  step1: "1. Start from\nsearch_hint/32\n(word of last alloc)" {
    style.fill: "#2a0000"
    style.stroke: "#ff6666"
    style.font-color: "#ffaaaa"
    style.border-radius: 6
    style.font-size: 12
    style.bold: true
  }
  step2: "2. Load bitmap[w]\n(likely L2 cache hit\n~5ns if warm)" {
    style.fill: "#1a1a00"
    style.stroke: "#ffff44"
    style.font-color: "#ffffaa"
    style.border-radius: 6
    style.font-size: 12
  }
  step3_skip: "3a. word == 0xFFFFFFFF\nSKIP entire word\n32 frames, 1 compare" {
    style.fill: "#1a0000"
    style.stroke: "#ff4444"
    style.font-color: "#ff8888"
    style.border-radius: 6
    style.font-size: 12
  }
  step3_found: "3b. word != 0xFFFFFFFF\nBSF finds bit index\nset bit, return addr\nO(1) result!" {
    style.fill: "#003300"
    style.stroke: "#00ff88"
    style.font-color: "#44ffaa"
    style.border-radius: 6
    style.font-size: 12
    style.bold: true
    style.shadow: true
  }
  step4_wrap: "4. Reached end\nof bitmap\nWrap to word 0" {
    style.fill: "#221100"
    style.stroke: "#ff8800"
    style.font-color: "#ffcc66"
    style.border-radius: 6
    style.font-size: 12
  }
  step5_oom: "5. Second full\nscan failed\nreturn NULL\nKERNEL PANIC" {
    style.fill: "#3d0000"
    style.stroke: "#ff0000"
    style.font-color: "#ff4444"
    style.border-radius: 6
    style.font-size: 12
    style.bold: true
  }

  step1 -> step2: "w++" {
    style.stroke: "#ffff44"
    style.font-color: "#ffff88"
    style.font-size: 11
    style.animated: true
  }
  step2 -> step3_skip: "0xFFFFFFFF\n(all used)" {
    style.stroke: "#ff4444"
    style.font-color: "#ff8888"
    style.font-size: 11
  }
  step2 -> step3_found: "has free bit!" {
    style.stroke: "#44ff44"
    style.font-color: "#88ff88"
    style.font-size: 11
    style.stroke-width: 2
  }
  step3_skip -> step2: "next word" {
    style.stroke: "#886600"
    style.font-color: "#ccaa44"
    style.font-size: 11
    style.stroke-dash: 3
  }
  step3_skip -> step4_wrap: "w >= 1024" {
    style.stroke: "#ff8800"
    style.font-color: "#ffcc66"
    style.font-size: 11
  }
  step4_wrap -> step2: "restart w=0" {
    style.stroke: "#ff8800"
    style.font-color: "#ffcc66"
    style.font-size: 11
    style.stroke-dash: 4
  }
  step4_wrap -> step5_oom: "already wrapped" {
    style.stroke: "#ff0000"
    style.font-color: "#ff4444"
    style.font-size: 11
    style.stroke-width: 2
  }
}

cache_analysis: "Cache Behavior: 64-byte Cache Line covers 512 Frames = 2MB Physical RAM" {
  style: {
    fill: "#001122"
    stroke: "#4488ff"
    stroke-width: 2
    border-radius: 8
    font-size: 14
    bold: true
    font-color: "#88aaff"
  }

  cache_line_vis: "One 64-byte L1 cache line (bitmap hot):\n[w0:32fr][w1:32fr][w2:32fr][w3:32fr][w4:32fr][w5:32fr][w6:32fr][w7:32fr]\n8 words x 32 frames = 256 frames = 1MB tracked per cache line\nTwo lines (128 bytes) = 512 frames = 2MB\nEntire 4KB bitmap = 64 lines -- fits in L2 (256KB+)" {
    style.fill: "#001122"
    style.font-size: 12
    style.border-radius: 6
    style.stroke: "#336699"
    style.font-color: "#88ccff"
    style.font: mono
  }

  prefetch_note: "Hardware prefetcher:\nsequential scan triggers\nautomatic cache line\nprefetch (stride=64 bytes)\nAll allocs served from\nL2 after warmup: ~5ns" {
    style.fill: "#002233"
    style.stroke: "#4488ff"
    style.font-color: "#aaccff"
    style.border-radius: 6
    style.font-size: 12
    style.bold: true
  }

  complexity: "Complexity Summary:\nbitmap_set(f):   O(1) -- 2 ops\nbitmap_clear(f): O(1) -- 2 ops\nbitmap_test(f):  O(1) -- 2 ops\nalloc_frame(): O(n/32) worst, O(1) amortized\ndouble-free:   O(1) -- test before clear" {
    style.fill: "#001a00"
    style.font-size: 12
    style.border-radius: 6
    style.stroke: "#336633"
    style.font-color: "#88cc88"
    style.font: mono
  }
}

freelist_compare: "Free List Alternative -- Why Bitmap Wins for Physical Frames" {
  style: {
    fill: "#1a0a00"
    stroke: "#ff8800"
    stroke-width: 2
    border-radius: 8
    font-size: 13
    bold: true
    font-color: "#ffaa44"
  }

  freelist_diagram: "Free List (linked list of free frame descriptors):\n[head] -> [frame@0x300000,next=0x500000] -> [frame@0x500000,next=NULL]\n           8 bytes per entry                     8 bytes per entry\n\nProblems:\n1. Memory: 8 bytes x 32768 frames = 256KB (vs 4KB bitmap)\n2. Pointer chasing: each .next = likely cache miss (~60ns)\n3. No O(1) double-free detection\n4. Worst case: 32768 cache misses = ~2ms to scan" {
    style.fill: "#1a0a00"
    style.font-size: 12
    style.border-radius: 6
    style.stroke: "#aa5500"
    style.font-color: "#ffbb66"
    style.font: mono
  }

  perf_table: "Performance Comparison (128MB / 32768 frames):\nOperation       Bitmap          Free List\nalloc_frame()   ~50 cycles      ~60ns x N hops\nfree_frame()    5 cycles        5 cycles (push)\nMemory cost     4KB             256KB\nCache behavior  Sequential OK   Pointer-chase BAD\nDouble-free     O(1) check      O(n) or separate set\nWarm access     L2 ~5ns         DRAM 60ns+" {
    style.fill: "#1a0a00"
    style.font-size: 12
    style.border-radius: 6
    style.stroke: "#aa5500"
    style.font-color: "#ffbb66"
    style.font: mono
  }
}

init_sequence: "pmm_init() Initialization Sequence" {
  style: {
    fill: "#0a0a1e"
    stroke: "#8844ff"
    stroke-width: 2
    border-radius: 8
    font-size: 13
    bold: true
    font-color: "#cc88ff"
  }

  init1: "1. memset(bitmap, 0xFF, 4096)\nMark ALL 32768 frames USED\n(conservative: unknown = dangerous)" {
    style.fill: "#3d0000"
    style.stroke: "#ff4444"
    style.font-color: "#ff8888"
    style.border-radius: 6
    style.font-size: 12
  }
  init2: "2. Parse E820 memory map\nFor each type=1 usable region:\n  pmm_mark_free(base, length)" {
    style.fill: "#003300"
    style.stroke: "#44ff44"
    style.font-color: "#88ff88"
    style.border-radius: 6
    style.font-size: 12
  }
  init3: "3. pmm_mark_used(kernel_start, kernel_end)\nRe-protect kernel frames\n(may overlap E820 usable region)" {
    style.fill: "#2d003d"
    style.stroke: "#aa44ff"
    style.font-color: "#cc88ff"
    style.border-radius: 6
    style.font-size: 12
  }
  init4: "4. pmm_mark_used(&frame_bitmap, 4096)\nProtect bitmap's own frame!\n(bitmap must not allocate itself)" {
    style.fill: "#3d2200"
    style.stroke: "#ff8800"
    style.font-color: "#ffcc66"
    style.border-radius: 6
    style.font-size: 12
    style.bold: true
  }
  init5: "5. Never allocate frame 0\nPhysical 0x0 = NULL pointer\nSpecial-cased in alloc_frame()" {
    style.fill: "#2a0000"
    style.stroke: "#ff4444"
    style.font-color: "#ff8888"
    style.border-radius: 6
    style.font-size: 12
  }

  init1 -> init2: "open E820 regions" {
    style.stroke: "#44ff44"
    style.font-color: "#88ff88"
    style.font-size: 11
    style.animated: true
  }
  init2 -> init3: "re-protect kernel" {
    style.stroke: "#aa44ff"
    style.font-color: "#cc88ff"
    style.font-size: 11
  }
  init3 -> init4: "re-protect bitmap" {
    style.stroke: "#ff8800"
    style.font-color: "#ffcc66"
    style.font-size: 11
    style.stroke-width: 2
  }
  init4 -> init5: "guard frame 0" {
    style.stroke: "#ff4444"
    style.font-color: "#ff8888"
    style.font-size: 11
  }
}

phys_space -> index_calc: "physical address\nbits[31:12]=frame#\nthen /32 and %32" {
  style.stroke: "#4488bb"
  style.font-color: "#88aaff"
  style.font-size: 11
  style.stroke-width: 2
  style.animated: true
}

index_calc -> bitmap_array: "frame 768 -> word[24] bit 0\ntarget for allocation" {
  style.stroke: "#8844ff"
  style.font-color: "#cc88ff"
  style.font-size: 11
  style.stroke-width: 2
}

bitmap_array.word24 -> word24_zoom: "zoom in: all 32 bits\nare zero = FREE" {
  style.stroke: "#00ff44"
  style.font-color: "#44ff88"
  style.font-size: 11
  style.stroke-width: 2
  style.animated: true
}

word24_zoom -> alloc_algo: "BSF finds bit 0\nframe 768\naddr 0x00300000" {
  style.stroke: "#ff4444"
  style.font-color: "#ff8888"
  style.font-size: 11
  style.stroke-width: 2
}

bitmap_array -> cache_analysis: "64-byte cache line\n= 8 words x 32 bits\n= 256 frames = 1MB" {
  style.stroke: "#4488ff"
  style.font-color: "#88aaff"
  style.font-size: 11
}

cache_analysis -> freelist_compare: "bitmap: sequential access\nvs free list: pointer-chasing" {
  style.stroke: "#ff8800"
  style.font-color: "#ffcc66"
  style.font-size: 11
  style.stroke-dash: 4
}

init_sequence -> bitmap_array: "after init:\nword[0..7]=0xFF (BIOS)\nword[8..15]=0xFF (kernel)\nword[16..23]=0xFF (bitmap)\nword[24..1023]=0x00 (FREE)" {
  style.stroke: "#8844ff"
  style.font-color: "#cc88ff"
  style.font-size: 11
  style.stroke-width: 2
}

alloc_algo -> phys_space: "returns 0x00300000\n(frame 768 allocated)" {
  style.stroke: "#44ff44"
  style.font-color: "#88ff88"
  style.font-size: 11
  style.stroke-width: 2
  style.animated: true
}