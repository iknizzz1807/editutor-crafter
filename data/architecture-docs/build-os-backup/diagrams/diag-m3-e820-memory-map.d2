vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # E820 Memory Map: Physical Address Space Classification
  ### 128MB QEMU VM — Frame Allocator Bootstrap View
| {near: top-center}

legend: {
  near: bottom-right
  label: "Legend"
  style: {
    fill: "#1a1a2e"
    stroke: "#444466"
    border-radius: 8
    font-size: 13
  }
  l1: "Green = Usable RAM (E820 type 1)" {
    shape: text
    style.font-color: "#90ee90"
    style.font-size: 12
  }
  l2: "Red = Reserved/BIOS (E820 type 2)" {
    shape: text
    style.font-color: "#ff7777"
    style.font-size: 12
  }
  l3: "Yellow = VGA MMIO (E820 reserved)" {
    shape: text
    style.font-color: "#ffdd77"
    style.font-size: 12
  }
  l4: "Blue = Kernel overlay (must mark used)" {
    shape: text
    style.font-color: "#77aaff"
    style.font-size: 12
  }
  l5: "Purple = Metadata structures" {
    shape: text
    style.font-color: "#cc88ff"
    style.font-size: 12
  }
  l6: "Gray = Unusable / padding frames" {
    shape: text
    style.font-color: "#aaaaaa"
    style.font-size: 12
  }
}

phys_space: "Physical Address Space (128 MB = 32,768 x 4KB frames)" {
  style: {
    fill: "#0d0d1a"
    stroke: "#555577"
    stroke-width: 2
    border-radius: 6
    font-color: "#ccccee"
    font-size: 15
    bold: true
  }

  r0: "0x00000000 - 0x000004FF: Real-Mode IVT + BIOS Data Area" {
    style: {
      fill: "#1a2a1a"
      stroke: "#336633"
      font-color: "#99cc99"
      font-size: 12
      border-radius: 4
    }
  }

  r0_detail: "Frame 0 = physical 0x0 | IVT: 256x4-byte vectors | BDA: keyboard state | PMM: frame 0 NEVER allocated (NULL sentinel) | pmm_mark_used(0x0, 0x500)" {
    style: {
      fill: "#0f1f0f"
      stroke: "#224422"
      font-size: 11
      font-color: "#88cc88"
    }
  }

  r1: "0x00000500 - 0x0007BFFF: Conventional Low RAM [~494 KB | E820 type=1 USABLE]" {
    style: {
      fill: "#0d2a0d"
      stroke: "#22aa22"
      stroke-width: 2
      font-color: "#88ff88"
      font-size: 12
      border-radius: 4
    }
  }

  r1_detail: "Frames 0x001-0x07B (123 frames x 4KB = 492KB) | Free RAM: general allocator pool | pmm_mark_free(0x500, 0x7BC00 - 0x500)" {
    style: {
      fill: "#071a07"
      stroke: "#115511"
      font-size: 11
      font-color: "#66aa66"
    }
  }

  r2: "0x00007C00 - 0x00007DFF: MBR / Stage-1 Bootloader [512 bytes | mark USED]" {
    style: {
      fill: "#1a1a2e"
      stroke: "#4444aa"
      stroke-width: 2
      font-color: "#8888ff"
      font-size: 12
      border-radius: 4
    }
  }

  r3: "0x00007E00 - 0x0009FFFF: Stage-2 / Free RAM / EBDA [~616 KB | E820 type=1 mostly]" {
    style: {
      fill: "#0d2a0d"
      stroke: "#22aa22"
      stroke-width: 2
      font-color: "#88ff88"
      font-size: 12
      border-radius: 4
    }
  }

  r3_detail: "Frames 0x07E-0x09F (usable) + EBDA at top | EBDA: variable size ~1-4KB | PMM: conservatively mark 0x80000-0xA0000 as reserved" {
    style: {
      fill: "#071a07"
      stroke: "#115511"
      font-size: 11
      font-color: "#66aa66"
    }
  }

  r4: "0x000A0000 - 0x000BFFFF: VGA Video RAM + Text Buffer [128 KB | E820 type=2 RESERVED]" {
    style: {
      fill: "#2a2a00"
      stroke: "#aaaa00"
      stroke-width: 2
      font-color: "#ffff44"
      font-size: 12
      border-radius: 4
    }
  }

  r4_detail: "Frames 0x0A0-0x0BF (32 frames) | 0xA0000-0xAFFFF: EGA/CGA graphics | 0xB8000-0xBFFFF: VGA text mode <- kprintf target | MMIO: writes go to VGA chip | pmm_mark_used(0xA0000, 0x20000) | Set PAGE_NOCACHE on PTE for 0xB8000" {
    style: {
      fill: "#1a1a00"
      stroke: "#666600"
      font-size: 11
      font-color: "#cccc44"
    }
  }

  r5: "0x000C0000 - 0x000EFFFF: Video BIOS + Option ROMs [192 KB | E820 type=2 RESERVED]" {
    style: {
      fill: "#2a0000"
      stroke: "#aa2222"
      stroke-width: 2
      font-color: "#ff8888"
      font-size: 12
      border-radius: 4
    }
  }

  r6: "0x000F0000 - 0x000FFFFF: System BIOS ROM [64 KB | E820 type=2 RESERVED | reset vector @ 0xFFFFFFF0]" {
    style: {
      fill: "#2a0000"
      stroke: "#cc2222"
      stroke-width: 3
      font-color: "#ffaaaa"
      font-size: 12
      border-radius: 4
    }
  }

  r6_detail: "Frames 0x0F0-0x0FF (16 frames) | CPU reset vector: 0xFFFFFFF0 maps here via top-of-ROM alias | POST, INT 13h disk, INT 10h video, INT 15h memory query | pmm_mark_used(0xC0000, 0x40000)" {
    style: {
      fill: "#1a0000"
      stroke: "#551111"
      font-size: 11
      font-color: "#cc7777"
    }
  }

  boundary_1mb: "=== 1MB BOUNDARY (0x00100000) ===" {
    style: {
      fill: "#222244"
      stroke: "#6666cc"
      stroke-width: 3
      font-color: "#aaaaff"
      font-size: 13
      bold: true
    }
  }

  r8: "0x00100000 - 0x001XXXXX: Kernel Binary (.text .rodata .data .bss) [MARK USED]" {
    style: {
      fill: "#0a1a3a"
      stroke: "#2255cc"
      stroke-width: 3
      font-color: "#88bbff"
      font-size: 12
      border-radius: 4
    }
  }

  r8_detail: "Frames 0x100-0x1FF (typical: kernel <= 1MB) | 0x100000: kernel_entry assembly trampoline | .text: code (R-X) | .rodata: constants (R--) | .data: initialized globals (RW-) | .bss: zero-init globals zeroed before kmain | Linker symbols: __kernel_start_phys __kernel_end_phys | pmm_mark_used(&__kernel_start_phys, kernel_size) | MANDATORY: kernel cannot allocate its own frames" {
    style: {
      fill: "#060f22"
      stroke: "#113388"
      font-size: 11
      font-color: "#6699cc"
    }
  }

  r9: "0x001XXXXX+N: Multiboot Information Structure [~1KB | placed by GRUB | MARK USED]" {
    style: {
      fill: "#2a0a2a"
      stroke: "#882288"
      stroke-width: 2
      font-color: "#cc88ff"
      font-size: 12
      border-radius: 4
    }
  }

  r9_detail: "multiboot_info_t passed in EBX by GRUB | flags: which fields are valid | mmap_addr -> E820 region array | mmap_length: byte length of E820 array | PMM: mark this frame used BEFORE parsing the map | Safe pattern: parse E820 into kernel structures THEN init PMM" {
    style: {
      fill: "#1a061a"
      stroke: "#551155"
      font-size: 11
      font-color: "#aa66cc"
    }
  }

  r10: "0x001XXXXX+2N: Boot Page Directory + Page Tables [3 frames = 12KB | MARK USED]" {
    style: {
      fill: "#2a1a00"
      stroke: "#aa6600"
      stroke-width: 2
      font-color: "#ffcc66"
      font-size: 12
      border-radius: 4
    }
  }

  r10_detail: "boot_page_directory[1024] (4KB 4KB-aligned) | identity_page_table[1024] (4KB maps virt 0x0-0x3FFFFF) | kernel_page_table[1024] (4KB maps virt 0xC0000000-0xC03FFFFF) | Declared __attribute__((aligned(4096))) static in .bss | pmm_mark_used(phys(boot_page_directory), 3*4096) | CR3 = physical address of boot_page_directory" {
    style: {
      fill: "#1a0f00"
      stroke: "#664400"
      font-size: 11
      font-color: "#ccaa44"
    }
  }

  r11: "0x001XXXXX+3N: PMM Frame Bitmap [128 KB for 4GB RAM | IN BSS | MARK USED]" {
    style: {
      fill: "#2a1a00"
      stroke: "#cc8800"
      stroke-width: 2
      font-color: "#ffdd88"
      font-size: 12
      border-radius: 4
    }
  }

  r11_detail: "static uint32_t frame_bitmap[32768] = 128KB | 1 bit per 4KB frame covers full 4GB | Lives in .bss zeroed by kernel_entry | PMM init sets ALL bits to 1 then clears usable regions | Verify: &frame_bitmap[0] >= __kernel_start_phys | If not: pmm_mark_used(&frame_bitmap, sizeof(frame_bitmap))" {
    style: {
      fill: "#1a1000"
      stroke: "#775500"
      font-size: 11
      font-color: "#ccaa44"
    }
  }

  r12: "0x00200000 - 0x07FFFFFF: Free Extended RAM — Allocator Pool [~126 MB | E820 type=1 | AVAILABLE]" {
    style: {
      fill: "#0d2a0d"
      stroke: "#33cc33"
      stroke-width: 3
      font-color: "#aaffaa"
      font-size: 12
      border-radius: 4
    }
  }

  r12_detail: "Frames 0x200-0x7FFF (~32,256 frames = ~126 MB) | Primary free pool for pmm_alloc_frame() | Used for: new page tables, process kernel stacks, heap backing frames, user-mode code/stack frames | pmm_mark_free(0x200000, 0x7E00000) | search_hint starts at frame 0x200 (first free frame after kernel)" {
    style: {
      fill: "#071a07"
      stroke: "#226622"
      font-size: 11
      font-color: "#88cc88"
    }
  }

  r13: "0x08000000 - 0xFFFFFFFF: ACPI Tables + APIC MMIO + BIOS ROM alias [RESERVED]" {
    style: {
      fill: "#2a0000"
      stroke: "#882222"
      stroke-width: 2
      font-color: "#ffaaaa"
      font-size: 12
      border-radius: 4
    }
  }

  r13_detail: "0xFEC00000: I/O APIC registers (MMIO) | 0xFEE00000: Local APIC registers (MMIO per-core) | 0xFFFF0000: BIOS ROM mirror (reset vector alias) | ACPI RSDP RSDT MADT tables (type=3 reclaimable after parse) | PMM: default-reserved (bitmap starts all 1s) | Do NOT call pmm_mark_free for type=2/4 regions" {
    style: {
      fill: "#1a0000"
      stroke: "#551111"
      font-size: 11
      font-color: "#cc7777"
    }
  }

  r0 -> r0_detail: "details"
  r1 -> r1_detail: "details"
  r3 -> r3_detail: "details"
  r4 -> r4_detail: "details"
  r6 -> r6_detail: "details"
  r8 -> r8_detail: "details"
  r9 -> r9_detail: "details"
  r10 -> r10_detail: "details"
  r11 -> r11_detail: "details"
  r12 -> r12_detail: "details"
  r13 -> r13_detail: "details"
}

bitmap_panel: "PMM Bitmap State After Initialization" {
  style: {
    fill: "#0d0d1a"
    stroke: "#555577"
    stroke-width: 2
    border-radius: 6
    font-color: "#ccccee"
    font-size: 14
    bold: true
  }

  bm_header: "Bitmap Layout: frame_bitmap[32768] = 128KB total | Each uint32_t word = 32 frames = 128KB of RAM | Bit=1 -> frame USED/reserved | Bit=0 -> frame FREE" {
    style: {
      fill: "#0a0a1a"
      stroke: "#333355"
      font-size: 12
      font-color: "#aaaacc"
    }
  }

  bm_word0: "Word[0]: Frames 0-31 (0x00000-0x1FFFF)" {
    label: "Word[0] Frames 0-31\n= 0xFFFFFFFF ALL RESERVED\nIVT BIOS-DA low-stack MBR"
    style: {
      fill: "#2a0000"
      stroke: "#aa3333"
      font-color: "#ff9999"
      font-size: 11
      border-radius: 3
    }
  }

  bm_word1: "Words[1-9]: Frames 32-319 (0x20000-0x13FFFF)" {
    label: "Words[1-9] Frames 32-319\n= 0x00000000 FREE\nLow usable RAM"
    style: {
      fill: "#002200"
      stroke: "#33aa33"
      font-color: "#88ff88"
      font-size: 11
      border-radius: 3
    }
  }

  bm_word10: "Words[10-11]: Frames 320-383 VGA MMIO (0xA0000-0xBFFFF)" {
    label: "Words[10-11] Frames 320-383\n= 0xFFFFFFFF RESERVED\nVGA MMIO region"
    style: {
      fill: "#2a2a00"
      stroke: "#aaaa00"
      font-color: "#ffff66"
      font-size: 11
      border-radius: 3
    }
  }

  bm_word12: "Words[12-15]: Frames 384-511 BIOS ROM (0xC0000-0xFFFFF)" {
    label: "Words[12-15] Frames 384-511\n= 0xFFFFFFFF RESERVED\nBIOS ROM Option ROMs"
    style: {
      fill: "#2a0000"
      stroke: "#cc3333"
      font-color: "#ff9999"
      font-size: 11
      border-radius: 3
    }
  }

  bm_word16: "Words[16-N]: Frames 512-K Kernel Binary + Metadata (0x100000-kernel_end)" {
    label: "Words[16-N] Frames 512-K\n= 0xFFFFFFFF RESERVED\nKernel binary + page tables + bitmap + mbi"
    style: {
      fill: "#0a1a3a"
      stroke: "#2255cc"
      stroke-width: 2
      font-color: "#88bbff"
      font-size: 11
      border-radius: 3
    }
  }

  bm_free: "Words[N+1 - 2047]: Frames K+1-32767 PRIMARY FREE POOL (~126MB)" {
    label: "Words[N+1 - 2047] Frames K+1-32767\n= 0x00000000 FREE\nPrimary allocatable pool ~126MB"
    style: {
      fill: "#002200"
      stroke: "#44cc44"
      stroke-width: 3
      font-color: "#aaffaa"
      font-size: 12
      border-radius: 3
      bold: true
    }
  }

  bm_high: "Words[2048-32767]: High address space (ACPI/APIC/ROM)" {
    label: "Words[2048-32767]\n= 0xFFFFFFFF RESERVED\nACPI APIC BIOS-ROM-alias not RAM"
    style: {
      fill: "#2a0000"
      stroke: "#882222"
      font-color: "#ff8888"
      font-size: 11
      border-radius: 3
    }
  }

  bm_stats: "Statistics: Frame 0=RESERVED(NULL sentinel) | Low RAM 0x500-0x9FFFF ~158 frames FREE | VGA 32 frames RESERVED | ROM 64 frames RESERVED | Kernel+Meta ~N frames RESERVED | Free pool 2MB+ ~32K frames FREE" {
    style: {
      fill: "#0a0a1a"
      stroke: "#333355"
      font-size: 11
      font-color: "#aaaacc"
    }
  }

  bm_header -> bm_word0: "lowest addresses"
  bm_word0 -> bm_word1: "low RAM starts"
  bm_word1 -> bm_word10: "VGA region"
  bm_word10 -> bm_word12: "ROM region"
  bm_word12 -> bm_word16: "1MB boundary -> kernel"
  bm_word16 -> bm_free: "kernel end -> free pool"
  bm_free -> bm_high: "128MB -> high reserved"
  bm_high -> bm_stats: "summary"
}

init_seq: "PMM Initialization Sequence (Order is Critical)" {
  style: {
    fill: "#0d0d1a"
    stroke: "#666688"
    stroke-width: 2
    border-radius: 6
    font-color: "#ccccee"
    font-size: 13
    bold: true
  }

  step1: "Step 1: memset(frame_bitmap, 0xFF, 128KB)" {
    style: {
      fill: "#2a0000"
      stroke: "#cc3333"
      font-color: "#ffaaaa"
      font-size: 12
      border-radius: 4
    }
  }
  step1_note: "All 1M frames marked USED — conservative safe start" {
    style: {
      fill: "#1a0000"
      stroke: "#551111"
      font-color: "#cc6666"
      font-size: 11
    }
  }

  step2: "Step 2: Parse E820 — pmm_mark_free(usable regions)" {
    style: {
      fill: "#002a00"
      stroke: "#33cc33"
      font-color: "#88ff88"
      font-size: 12
      border-radius: 4
    }
  }
  step2_note: "Walk mmap_entry_t list; clear bits for type=1 regions only" {
    style: {
      fill: "#001a00"
      stroke: "#226622"
      font-color: "#66cc66"
      font-size: 11
    }
  }

  step3: "Step 3: pmm_mark_used(kernel binary extent)" {
    style: {
      fill: "#0a1a3a"
      stroke: "#3366cc"
      stroke-width: 2
      font-color: "#88aaff"
      font-size: 12
      border-radius: 4
    }
  }
  step3_note: "pmm_mark_used(&__kernel_start_phys, kernel_size) | Covers .text .rodata .data .bss (includes bitmap if in BSS)" {
    style: {
      fill: "#060f22"
      stroke: "#113388"
      font-color: "#6699cc"
      font-size: 11
    }
  }

  step4: "Step 4: pmm_mark_used(multiboot info struct)" {
    style: {
      fill: "#2a0a2a"
      stroke: "#882288"
      font-color: "#cc88ff"
      font-size: 12
      border-radius: 4
    }
  }
  step4_note: "pmm_mark_used(mbi_phys_addr, sizeof(multiboot_info_t)) | Protect E820 array from allocation before parsing complete" {
    style: {
      fill: "#1a061a"
      stroke: "#551155"
      font-color: "#aa66cc"
      font-size: 11
    }
  }

  step5: "Step 5: pmm_mark_used(boot page tables) if outside BSS" {
    style: {
      fill: "#2a1a00"
      stroke: "#cc8800"
      font-color: "#ffcc66"
      font-size: 12
      border-radius: 4
    }
  }
  step5_note: "pmm_mark_used(phys(boot_page_directory), 3 x 4096) | CR3 target must never be reallocated" {
    style: {
      fill: "#1a1000"
      stroke: "#775500"
      font-color: "#ccaa44"
      font-size: 11
    }
  }

  step6: "Step 6: search_hint = first_free_frame_after_kernel" {
    style: {
      fill: "#002a00"
      stroke: "#33cc33"
      font-color: "#88ff88"
      font-size: 12
      border-radius: 4
    }
  }
  step6_note: "Sets allocator to start scanning at 0x200000+ | Avoids re-scanning reserved low frames on every alloc" {
    style: {
      fill: "#001a00"
      stroke: "#226622"
      font-color: "#66cc66"
      font-size: 11
    }
  }

  step1 -> step1_note: "effect"
  step1 -> step2: "conservative init\n(all reserved until proven otherwise)"
  step2 -> step2_note: "effect"
  step2 -> step3: "usable regions cleared\n(bitmap bits = 0 = FREE)"
  step3 -> step3_note: "effect"
  step3 -> step4: "kernel frames re-marked used\n(override E820 usable marking)"
  step4 -> step4_note: "effect"
  step4 -> step5: "metadata protected\n(mbi pointer stays valid)"
  step5 -> step5_note: "effect"
  step5 -> step6: "page table frames protected\n(CR3 target stable)"
  step6 -> step6_note: "effect"
}

cache_note: "BITMAP CACHE BEHAVIOR: One 64-byte cache line = 512 bits = 512 frames = 2MB of RAM | Scanning 128MB bitmap: 128KB / 64B = 2048 cache lines | Fits entirely in L2 cache (256KB-1MB) | After first scan: subsequent allocs hit L2 at ~10ns | search_hint keeps scan near last allocation: sequential frames -> same cache line -> ~0 extra misses | vs Free List pointer-chasing: each next ptr -> random physical frame -> L3/DRAM miss at ~60-100ns | Bitmap wins 6-10x on allocation-heavy workloads" {
  near: bottom-left
  style: {
    fill: "#0d0d1a"
    stroke: "#555577"
    border-radius: 8
    font-size: 11
    font-color: "#bbbbdd"
  }
}

phys_space.r0 -> bitmap_panel.bm_word0: "0x0-0x4FF -> bits 0-0\nframe 0 = never allocate\n(NULL sentinel)" {
  style: {
    stroke: "#cc3333"
    stroke-dash: 4
    font-color: "#ff9999"
    font-size: 10
  }
}

phys_space.r4 -> bitmap_panel.bm_word10: "0xA0000-0xBFFFF\n-> words[10-11] all 1s\nVGA MMIO region" {
  style: {
    stroke: "#aaaa00"
    stroke-dash: 4
    font-color: "#ffff66"
    font-size: 10
  }
}

phys_space.r8 -> bitmap_panel.bm_word16: "kernel binary\n-> words[16-N] all 1s\n(__kernel_start to __kernel_end)" {
  style: {
    stroke: "#2255cc"
    stroke-width: 2
    font-color: "#88bbff"
    font-size: 10
  }
}

phys_space.r12 -> bitmap_panel.bm_free: "0x200000-0x7FFFFFF\n-> words[N+1..2047] = 0\nPRIMARY ALLOCATOR POOL" {
  style: {
    stroke: "#33cc33"
    stroke-width: 2
    font-color: "#aaffaa"
    font-size: 10
  }
}

phys_space.r9 -> bitmap_panel.bm_word16: "multiboot_info_t\nwithin kernel extent\nor mark separately" {
  style: {
    stroke: "#882288"
    stroke-dash: 3
    font-color: "#cc88ff"
    font-size: 10
  }
}

phys_space.r6 -> init_seq.step1: "BIOS ROM always\nreserved by default\n(bitmap starts 0xFF)" {
  style: {
    stroke: "#cc4444"
    stroke-dash: 5
    font-color: "#ff8888"
    font-size: 10
  }
}

phys_space.r12 -> init_seq.step2: "E820 type=1 entry:\nbase=0x200000\nlen=0x5E00000\n-> mark_free" {
  style: {
    stroke: "#33cc33"
    stroke-width: 2
    font-color: "#88ff88"
    font-size: 10
  }
}

phys_space.r8 -> init_seq.step3: "linker provides\n__kernel_start_phys\n__kernel_end_phys\n-> mark_used override" {
  style: {
    stroke: "#2255cc"
    stroke-width: 2
    font-color: "#88aaff"
    font-size: 10
  }
}

phys_space.r9 -> init_seq.step4: "EBX from GRUB =\nphys addr of mbi\n-> mark_used" {
  style: {
    stroke: "#882288"
    font-color: "#cc88ff"
    font-size: 10
  }
}

phys_space.r10 -> init_seq.step5: "boot_page_directory\nphysical address\n-> mark_used" {
  style: {
    stroke: "#cc8800"
    font-color: "#ffcc66"
    font-size: 10
  }
}