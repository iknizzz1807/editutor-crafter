vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Paging Enablement: The Identity-Map Bootstrap Problem
| {near: top-center}

legend: {
  near: bottom-right
  style: {
    fill: "#1a1a2e"
    stroke: "#444466"
    border-radius: 8
  }
  content: |md
    **Color Semantics**
    Red = danger / triple-fault path
    Green = safe / success path
    Blue = data flow / memory read
    Yellow = critical transition
    Purple = hardware registers
    Gray = inactive / unused
  |
}

phys_mem: "Physical RAM Layout (Before Paging)" {
  style: {
    fill: "#0d1117"
    stroke: "#30363d"
    border-radius: 6
  }
  addr_0: "0x00000000-0x000FFFFF: BIOS / IVT / VGA" {
    style.fill: "#3d2b1f"
    style.stroke: "#8b4513"
    style.font-color: "#cd853f"
    style.border-radius: 4
  }
  addr_kernel: "0x00100000-0x001FFFFF: KERNEL CODE + DATA" {
    style.fill: "#1a3a1a"
    style.stroke: "#2ea043"
    style.font-color: "#56d364"
    style.border-radius: 4
    style.bold: true
  }
  addr_pd: "0x00200000-0x00200FFF: PAGE DIRECTORY (4KB)" {
    style.fill: "#1a1f3a"
    style.stroke: "#58a6ff"
    style.font-color: "#79c0ff"
    style.border-radius: 4
  }
  addr_pt_id: "0x00201000-0x00201FFF: PAGE TABLE Identity Map" {
    style.fill: "#1a1f3a"
    style.stroke: "#58a6ff"
    style.font-color: "#79c0ff"
    style.border-radius: 4
  }
  addr_pt_hi: "0x00202000-0x00202FFF: PAGE TABLE Higher-Half" {
    style.fill: "#1a1f3a"
    style.stroke: "#58a6ff"
    style.font-color: "#79c0ff"
    style.border-radius: 4
  }
  addr_free: "0x00300000+: Free RAM" {
    style.fill: "#21262d"
    style.stroke: "#30363d"
    style.font-color: "#6e7681"
    style.border-radius: 4
  }
}

step1: "STEP 1: Kernel Executes — No Paging Active" {
  style: {
    fill: "#161b22"
    stroke: "#2ea043"
    border-radius: 6
    bold: true
  }
  eip1: "EIP = 0x00100000 (physical address)" {
    style.fill: "#1a3a1a"
    style.stroke: "#2ea043"
    style.font-color: "#56d364"
    style.border-radius: 4
  }
  cr0_nopg: "CR0.PG = 0  — paging DISABLED" {
    style.fill: "#1a3a1a"
    style.stroke: "#2ea043"
    style.font-color: "#56d364"
    style.border-radius: 4
  }
  cr3_irrel: "CR3 = irrelevant (MMU not consulted)" {
    style.fill: "#21262d"
    style.stroke: "#30363d"
    style.font-color: "#6e7681"
    style.border-radius: 4
  }
  note1: "Every access is direct physical. No translation. No page tables consulted." {
    style.fill: "#0d1117"
    style.stroke: "#2ea043"
    style.font-color: "#56d364"
    style.border-radius: 4
  }
}

step2: "STEP 2: Build Page Tables — TWO Mappings Required" {
  style: {
    fill: "#161b22"
    stroke: "#f0883e"
    border-radius: 6
    bold: true
    stroke-width: 3
  }
  warning_box: "OMIT EITHER MAPPING = TRIPLE FAULT" {
    style: {
      fill: "#3d1f1f"
      stroke: "#f85149"
      font-color: "#ff7b72"
      border-radius: 4
      bold: true
      font-size: 14
    }
  }
  mapping_a: "Mapping A: Identity Map (MANDATORY FOR BOOTSTRAP)" {
    style: {
      fill: "#1a2a1a"
      stroke: "#2ea043"
      border-radius: 4
      bold: true
    }
    map_a_why: "Virtual 0x00000000-0x3FFFFF -> Physical 0x00000000-0x3FFFFF" {
      style.fill: "#0d1117"
      style.stroke: "#2ea043"
      style.font-color: "#aff7b6"
      style.border-radius: 3
    }
    map_a_reason: "WHY: After CR0.PG=1, EIP is still 0x00100xxx. CPU fetches via MMU at virt 0x00100xxx. Without this map: unmapped -> Page Fault -> PF handler also unmapped -> Triple Fault." {
      style.fill: "#0d1117"
      style.stroke: "#2ea043"
      style.font-color: "#56d364"
      style.border-radius: 3
    }
    pte_id_0: "PTE[0]   = 0x00000003  phys 0x000000, P=1 RW=1" {
      style.fill: "#0d1117"
      style.stroke: "#2ea043"
      style.font-color: "#79c0ff"
      style.border-radius: 3
    }
    pte_id_256: "PTE[256] = 0x00100003  phys 0x100000 KERNEL, P=1 RW=1" {
      style.fill: "#1a3a1a"
      style.stroke: "#56d364"
      style.font-color: "#56d364"
      style.border-radius: 3
      style.bold: true
    }
    pte_id_more: "...1024 entries total (covers 4MB)" {
      style.fill: "#0d1117"
      style.stroke: "#30363d"
      style.font-color: "#6e7681"
      style.border-radius: 3
    }
  }
  mapping_b: "Mapping B: Higher-Half Kernel" {
    style: {
      fill: "#1a1f3a"
      stroke: "#58a6ff"
      border-radius: 4
      bold: true
    }
    map_b_why: "Virtual 0xC0000000-0xC03FFFFF -> Physical 0x00000000-0x3FFFFF" {
      style.fill: "#0d1117"
      style.stroke: "#58a6ff"
      style.font-color: "#a5d6ff"
      style.border-radius: 3
    }
    map_b_reason: "WHY: After Step 6 far jump, EIP becomes 0xC0100xxx. Must exist BEFORE that jump or the far jump itself faults." {
      style.fill: "#0d1117"
      style.stroke: "#58a6ff"
      style.font-color: "#79c0ff"
      style.border-radius: 3
    }
    pte_hi_0: "PTE[0]   = 0x00000003  virt 0xC0000000 -> phys 0x000000" {
      style.fill: "#0d1117"
      style.stroke: "#58a6ff"
      style.font-color: "#79c0ff"
      style.border-radius: 3
    }
    pte_hi_256: "PTE[256] = 0x00100003  virt 0xC0100000 -> phys 0x100000" {
      style.fill: "#1a2a3a"
      style.stroke: "#79c0ff"
      style.font-color: "#79c0ff"
      style.border-radius: 3
      style.bold: true
    }
    pte_hi_more: "...1024 entries total" {
      style.fill: "#0d1117"
      style.stroke: "#30363d"
      style.font-color: "#6e7681"
      style.border-radius: 3
    }
  }
  pd_state: "Page Directory at phys 0x200000" {
    style.fill: "#0d1117"
    style.stroke: "#8b949e"
    style.border-radius: 3
    pde0: "PDE[0]   = 0x00201003 -> identity PT, P=1 RW=1" {
      style.fill: "#1a2a1a"
      style.stroke: "#2ea043"
      style.font-color: "#56d364"
      style.border-radius: 3
    }
    pde_gap: "PDE[1..767] = 0x00000000 not present" {
      style.fill: "#21262d"
      style.stroke: "#30363d"
      style.font-color: "#6e7681"
      style.border-radius: 3
    }
    pde768: "PDE[768] = 0x00202003 -> higher-half PT, P=1 RW=1" {
      style.fill: "#1a1f3a"
      style.stroke: "#58a6ff"
      style.font-color: "#79c0ff"
      style.border-radius: 3
    }
    pde_rest: "PDE[769..1023] = 0x00000000 not present" {
      style.fill: "#21262d"
      style.stroke: "#30363d"
      style.font-color: "#6e7681"
      style.border-radius: 3
    }
  }
  code2: |nasm
    ; Identity page table (phys 0x201000)
    mov edi, 0x201000
    mov eax, 0x00000003
    mov ecx, 1024
    fill_id: stosd
             add eax, 0x1000
             loop fill_id
    ; Higher-half page table (phys 0x202000)
    mov edi, 0x202000
    mov eax, 0x00000003
    mov ecx, 1024
    fill_hi: stosd
             add eax, 0x1000
             loop fill_hi
    ; Install both PDEs
    mov dword [0x200000], 0x00201003
    mov dword [0x200C00], 0x00202003
  | {style.fill: "#0d1117"; style.stroke: "#30363d"; style.font-color: "#e6edf3"}
}

step3: "STEP 3: Load CR3 with Page Directory Physical Address" {
  style: {
    fill: "#161b22"
    stroke: "#8957e5"
    border-radius: 6
    bold: true
  }
  cr3_val: "CR3 = 0x00200000 (physical addr of page directory)" {
    style.fill: "#1a1a3a"
    style.stroke: "#8957e5"
    style.font-color: "#d2a8ff"
    style.border-radius: 4
  }
  cr3_note: "MMU now knows where PDEs live. Paging still OFF — CR3 loaded but not consulted yet." {
    style.fill: "#0d1117"
    style.stroke: "#8957e5"
    style.font-color: "#d2a8ff"
    style.border-radius: 4
  }
  code3: |nasm
    mov eax, 0x200000 ; Physical addr of page directory
    mov cr3, eax      ; Load PDBR — paging still OFF
  | {style.fill: "#0d1117"; style.stroke: "#30363d"; style.font-color: "#e6edf3"}
}

step4: "STEP 4: Set CR0.PG = 1 — Point of No Return" {
  style: {
    fill: "#1f1a00"
    stroke: "#e3b341"
    border-radius: 6
    bold: true
    stroke-width: 3
  }
  cr0_note: "CR0 bit31=PG, bit16=WP. Next instruction fetch goes through MMU. No grace period." {
    style.fill: "#0d1117"
    style.stroke: "#e3b341"
    style.font-color: "#ffa657"
    style.border-radius: 4
  }
  t_minus1: "Previous instruction: physical addressing" {
    style.fill: "#1a3a1a"
    style.stroke: "#2ea043"
    style.font-color: "#aff7b6"
    style.border-radius: 3
  }
  t0: "mov cr0, eax: PAGING ENABLED — this instruction" {
    style.fill: "#3d2e00"
    style.stroke: "#e3b341"
    style.font-color: "#ffa657"
    style.border-radius: 3
    style.bold: true
  }
  t_plus1: "Next fetch: CPU computes virt->phys via page tables" {
    style.fill: "#1a2a1a"
    style.stroke: "#2ea043"
    style.font-color: "#56d364"
    style.border-radius: 3
  }
  code4: |nasm
    mov eax, cr0
    or  eax, 0x80010000 ; PG (bit31) + WP (bit16)
    mov cr0, eax        ; PAGING ACTIVE after this store
  | {style.fill: "#0d1117"; style.stroke: "#30363d"; style.font-color: "#e6edf3"}
}

step5: "STEP 5: First Instruction Fetch Under Paging — Identity Map Saves Us" {
  style: {
    fill: "#0d2a0d"
    stroke: "#2ea043"
    border-radius: 6
    bold: true
  }
  virt_eip: "Virtual EIP = 0x00100010" {
    style.fill: "#21262d"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    style.border-radius: 3
  }
  walk_pde: "Dir index=0 -> PDE[0] = 0x00201003  P=1 OK" {
    style.fill: "#1a2a1a"
    style.stroke: "#2ea043"
    style.font-color: "#56d364"
    style.border-radius: 3
  }
  walk_pte: "Table index=256 -> PTE[256] = 0x00100003  P=1 OK" {
    style.fill: "#1a2a1a"
    style.stroke: "#2ea043"
    style.font-color: "#56d364"
    style.border-radius: 3
  }
  walk_phys: "Physical = 0x00100010 -> KERNEL CODE  SUCCESS" {
    style.fill: "#1a3a1a"
    style.stroke: "#56d364"
    style.font-color: "#56d364"
    style.border-radius: 3
    style.bold: true
  }
  tlb_cache: "TLB caches: virt 0x00100xxx -> phys 0x00100xxx (future hits: 1 cycle)" {
    style.fill: "#1a1f3a"
    style.stroke: "#58a6ff"
    style.font-color: "#79c0ff"
    style.border-radius: 3
  }
  success: "Identity map saves us — kernel continues executing normally" {
    style.fill: "#0d3d0d"
    style.stroke: "#2ea043"
    style.font-color: "#56d364"
    style.border-radius: 4
    style.bold: true
  }
}

step6: "STEP 6: Far Jump to Higher-Half Virtual Address" {
  style: {
    fill: "#0d1a2a"
    stroke: "#58a6ff"
    border-radius: 6
    bold: true
  }
  jump_note: "jmp 0x08:0xC0100000 — loads CS=0x08, EIP=0xC0100000" {
    style.fill: "#0d1117"
    style.stroke: "#58a6ff"
    style.font-color: "#a5d6ff"
    style.border-radius: 4
  }
  w2_virt: "Virtual EIP = 0xC0100000" {
    style.fill: "#21262d"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    style.border-radius: 3
  }
  w2_pde: "Dir index=768 -> PDE[768] = 0x00202003  P=1 OK" {
    style.fill: "#1a1f3a"
    style.stroke: "#58a6ff"
    style.font-color: "#79c0ff"
    style.border-radius: 3
  }
  w2_pte: "Table index=256 -> PTE[256] = 0x00100003  P=1 OK" {
    style.fill: "#1a1f3a"
    style.stroke: "#58a6ff"
    style.font-color: "#79c0ff"
    style.border-radius: 3
  }
  w2_phys: "Physical = 0x00100000 -> Same kernel code, different virtual name OK" {
    style.fill: "#0d1a3a"
    style.stroke: "#79c0ff"
    style.font-color: "#79c0ff"
    style.border-radius: 3
    style.bold: true
  }
  code6: |nasm
    jmp 0x08:higher_half_entry
    ; Linker places higher_half_entry at 0xC01xxxxx
    ; After: EIP = 0xC01xxxxx (higher-half virtual)
  | {style.fill: "#0d1117"; style.stroke: "#30363d"; style.font-color: "#e6edf3"}
}

step7: "STEP 7: Remove Identity Map — Now Safe" {
  style: {
    fill: "#161b22"
    stroke: "#8b949e"
    border-radius: 6
    bold: true
  }
  remove_note: "boot_page_directory[0] = 0 — PDE[0] cleared. CR3 reload flushes TLB." {
    style.fill: "#0d1117"
    style.stroke: "#8b949e"
    style.font-color: "#8b949e"
    style.border-radius: 4
  }
  va_low: "0x00000000-0x3FFFFFFF: UNMAPPED (available for user processes)" {
    style.fill: "#21262d"
    style.stroke: "#30363d"
    style.font-color: "#6e7681"
    style.border-radius: 3
  }
  va_user: "0x00400000-0xBFFFFFFF: User process virtual range" {
    style.fill: "#2a1a0d"
    style.stroke: "#8b4513"
    style.font-color: "#cd853f"
    style.border-radius: 3
  }
  va_kernel: "0xC0000000-0xFFFFFFFF: Kernel virtual range (still mapped)" {
    style.fill: "#1a3a1a"
    style.stroke: "#2ea043"
    style.font-color: "#56d364"
    style.border-radius: 3
    style.bold: true
  }
  code7: |nasm
    mov dword [boot_page_directory], 0
    mov eax, cr3
    mov cr3, eax  ; TLB flush: removes identity entries
                  ; 0x000xxxxx now causes page fault
  | {style.fill: "#0d1117"; style.stroke: "#30363d"; style.font-color: "#e6edf3"}
}

triple_fault: "FAILURE PATH: Step 2 Omits Identity Map" {
  style: {
    fill: "#2d0d0d"
    stroke: "#f85149"
    border-radius: 6
    bold: true
    stroke-width: 3
  }
  tf_warn: "DANGER ZONE — This is what happens without the identity map" {
    style.fill: "#3d1f1f"
    style.stroke: "#f85149"
    style.font-color: "#ff7b72"
    style.bold: true
    style.border-radius: 4
  }
  tf_pd: "PDE[0]=NOT PRESENT (identity missing) PDE[768]=present" {
    style.fill: "#1f0d0d"
    style.stroke: "#f85149"
    style.font-color: "#ff7b72"
    style.border-radius: 4
  }
  tf_pf1: "CPU fetches virt 0x00100010 after CR0.PG=1" {
    style.fill: "#1f0d0d"
    style.stroke: "#f85149"
    style.font-color: "#ff7b72"
    style.border-radius: 4
  }
  tf_pf1_detail: "PDE[0] = NOT PRESENT -> PAGE FAULT (Exception 14)" {
    style.fill: "#0d0d0d"
    style.stroke: "#f85149"
    style.font-color: "#ff7b72"
    style.border-radius: 3
    style.bold: true
  }
  tf_pf2: "CPU invokes PF handler from IDT[14] at virt 0x00101234" {
    style.fill: "#3d1a1a"
    style.stroke: "#f85149"
    style.font-color: "#ff7b72"
    style.border-radius: 4
  }
  tf_pf2_detail: "PDE[0] still NOT PRESENT -> PAGE FAULT AGAIN -> DOUBLE FAULT" {
    style.fill: "#0d0d0d"
    style.stroke: "#f85149"
    style.font-color: "#ff7b72"
    style.border-radius: 3
    style.bold: true
  }
  tf_pf3: "CPU invokes DF handler from IDT[8] at virt 0x00102000" {
    style.fill: "#3d1a1a"
    style.stroke: "#f85149"
    style.font-color: "#ff7b72"
    style.border-radius: 4
  }
  tf_pf3_detail: "PDE[0] STILL NOT PRESENT -> Fault again -> TRIPLE FAULT" {
    style.fill: "#0d0d0d"
    style.stroke: "#f85149"
    style.font-color: "#ff7b72"
    style.border-radius: 3
    style.bold: true
  }
  tf_result: "TRIPLE FAULT: CPU HARD RESET — No error message" {
    style: {
      fill: "#5d0000"
      stroke: "#f85149"
      font-color: "#ff7b72"
      border-radius: 4
      bold: true
      font-size: 16
    }
  }
  tf_qemu: "QEMU: silent reboot. Diagnose with: qemu-system-i386 -d int" {
    style.fill: "#1f0d0d"
    style.stroke: "#f85149"
    style.font-color: "#8b949e"
    style.border-radius: 4
    style.italic: true
  }
  tf_log: "check_exception old=0xffffffff new=0xe  <- PF vec 14" {
    style.fill: "#0d0d0d"
    style.stroke: "#30363d"
    style.font-color: "#8b949e"
    style.border-radius: 3
  }
  tf_log2: "check_exception old=0xe new=0x8         <- DF vec 8" {
    style.fill: "#0d0d0d"
    style.stroke: "#30363d"
    style.font-color: "#8b949e"
    style.border-radius: 3
  }
  tf_log3: "check_exception old=0x8 new=0x8         <- Triple -> reset" {
    style.fill: "#0d0d0d"
    style.stroke: "#30363d"
    style.font-color: "#8b949e"
    style.border-radius: 3
  }
}

step1 -> step2: "physical addr mode: safe to write page tables anywhere" {
  style.stroke: "#2ea043"
  style.font-color: "#56d364"
  style.bold: true
}

step2 -> step3: "both maps written in RAM — load CR3" {
  style.stroke: "#8957e5"
  style.font-color: "#d2a8ff"
}

step3 -> step4: "CR3 loaded — flip paging bit" {
  style.stroke: "#e3b341"
  style.font-color: "#ffa657"
  style.bold: true
}

step4 -> step5: "paging ON — identity map serves next fetch" {
  style.stroke: "#2ea043"
  style.font-color: "#56d364"
  style.bold: true
  style.animated: true
}

step5 -> step6: "still at low virt addr — far jump to higher-half" {
  style.stroke: "#58a6ff"
  style.font-color: "#79c0ff"
}

step6 -> step7: "EIP = 0xC01xxxxx — safe to remove identity map" {
  style.stroke: "#8b949e"
  style.font-color: "#8b949e"
}

step2 -> triple_fault: "IF identity map omitted from Step 2" {
  style.stroke: "#f85149"
  style.font-color: "#ff7b72"
  style.stroke-dash: 6
  style.bold: true
  style.stroke-width: 3
}

triple_fault.tf_pf1 -> triple_fault.tf_pf1_detail: "MMU lookup" {
  style.stroke: "#f85149"
  style.font-color: "#ff7b72"
}

triple_fault.tf_pf1_detail -> triple_fault.tf_pf2: "invoke exception handler" {
  style.stroke: "#f85149"
  style.font-color: "#ff7b72"
  style.animated: true
}

triple_fault.tf_pf2 -> triple_fault.tf_pf2_detail: "handler also unmapped!" {
  style.stroke: "#f85149"
  style.font-color: "#ff7b72"
}

triple_fault.tf_pf2_detail -> triple_fault.tf_pf3: "double fault handler" {
  style.stroke: "#f85149"
  style.font-color: "#ff7b72"
  style.animated: true
}

triple_fault.tf_pf3 -> triple_fault.tf_pf3_detail: "also unmapped!" {
  style.stroke: "#f85149"
  style.font-color: "#ff7b72"
}

triple_fault.tf_pf3_detail -> triple_fault.tf_result: "no recovery — hard reset" {
  style.stroke: "#f85149"
  style.font-color: "#ff7b72"
  style.bold: true
  style.stroke-width: 3
}

triple_fault.tf_result -> triple_fault.tf_qemu: "QEMU behavior" {
  style.stroke: "#8b949e"
  style.font-color: "#8b949e"
  style.stroke-dash: 3
}

triple_fault.tf_log -> triple_fault.tf_log2: "" {style.stroke: "#30363d"}
triple_fault.tf_log2 -> triple_fault.tf_log3: "" {style.stroke: "#30363d"}

phys_mem.addr_kernel -> step5.walk_phys: "final physical destination of all kernel fetches" {
  style.stroke: "#2ea043"
  style.font-color: "#56d364"
  style.stroke-dash: 3
}