vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |'md
  ## x86 32-bit Two-Level Page Table Walk
  Virtual Address → Physical Frame Translation
'| {near: top-right-center}

cr3: "CR3 Register" {
  style: {
    fill: "#4a235a"
    stroke: "#9b59b6"
    stroke-width: 3
    font-color: white
    bold: true
    border-radius: 6
    shadow: true
  }
}

cr3_detail: |'md
  **Control Register 3**

  Bits 31-12 = Physical base of Page Directory

  Bits 11-0 = Flags (PWT, PCD; rest ignored)

  Loaded via: `mov cr3, eax`

  Flushed on: CR3 reload (all non-global TLB entries)
'| {
  style: {
    fill: "#2e1a35"
    stroke: "#9b59b6"
    font-color: "#d7bde2"
    border-radius: 4
  }
}

vaddr_pd: "Virtual Address Bits 31-22 (PD Index)" {
  style: {
    fill: "#7c3f8c"
    stroke: "#b86fc6"
    stroke-width: 2
    font-color: white
    border-radius: 4
    bold: true
  }
}

vaddr_pd_note: |'md
  **Bits 31-22 — 10 bits**

  PD Index: 0 to 1023

  Selects which 4MB region
'| {
  style: {
    fill: "#4a1a5e"
    stroke: "#b86fc6"
    font-color: "#e8d5f0"
    border-radius: 4
  }
}

vaddr_pt: "Virtual Address Bits 21-12 (PT Index)" {
  style: {
    fill: "#1a5276"
    stroke: "#3498db"
    stroke-width: 2
    font-color: white
    border-radius: 4
    bold: true
  }
}

vaddr_pt_note: |'md
  **Bits 21-12 — 10 bits**

  PT Index: 0 to 1023

  Selects which 4KB page
'| {
  style: {
    fill: "#0d2d45"
    stroke: "#3498db"
    font-color: "#aed6f1"
    border-radius: 4
  }
}

vaddr_off: "Virtual Address Bits 11-0 (Page Offset)" {
  style: {
    fill: "#1e5631"
    stroke: "#27ae60"
    stroke-width: 2
    font-color: white
    border-radius: 4
    bold: true
  }
}

vaddr_off_note: |'md
  **Bits 11-0 — 12 bits**

  Byte offset: 0 to 4095

  Added to frame base address
'| {
  style: {
    fill: "#071f10"
    stroke: "#27ae60"
    font-color: "#a9dfbf"
    border-radius: 4
  }
}

pd: "Page Directory (4KB physical page)" {
  style: {
    fill: "#2c1654"
    stroke: "#7c83fd"
    stroke-width: 3
    font-color: white
    bold: true
    border-radius: 6
    shadow: true
    multiple: true
  }
}

pd_info: |'md
  **1024 x 4-byte PDEs = 4096 bytes**

  Each PDE covers 4MB of virtual space

  Aligned to 4096 bytes
'| {
  style: {
    fill: "#1a0e33"
    stroke: "#7c83fd"
    font-color: "#c8c8ff"
    border-radius: 4
  }
}

pde: "PDE — Page Directory Entry" {
  style: {
    fill: "#7c3f8c"
    stroke: "#b86fc6"
    stroke-width: 2
    font-color: white
    border-radius: 4
    bold: true
  }
}

pde_bits: |'md
  **32-bit PDE layout:**

  31-12: PT Frame Addr (20 bits)

  8: G Global

  7: PS 0=4KB subtable 1=4MB PSE

  5: A Accessed (CPU sets)

  4: PCD Cache Disable

  3: PWT Write-Through

  2: U/S User/Supervisor

  1: R/W Read/Write

  0: P **Present** (page fault if 0)
'| {
  style: {
    fill: "#4a1a5e"
    stroke: "#b86fc6"
    font-color: "#e8d5f0"
    border-radius: 4
  }
}

pt: "Page Table (4KB physical page)" {
  style: {
    fill: "#0d2137"
    stroke: "#3498db"
    stroke-width: 3
    font-color: white
    bold: true
    border-radius: 6
    shadow: true
    multiple: true
  }
}

pt_info: |'md
  **1024 x 4-byte PTEs = 4096 bytes**

  Each PTE maps one 4KB page frame

  Allocated via pmm_alloc_frame()
'| {
  style: {
    fill: "#071422"
    stroke: "#3498db"
    font-color: "#aed6f1"
    border-radius: 4
  }
}

pte: "PTE — Page Table Entry" {
  style: {
    fill: "#1a5276"
    stroke: "#3498db"
    stroke-width: 2
    font-color: white
    border-radius: 4
    bold: true
  }
}

pte_bits: |'md
  **32-bit PTE layout:**

  31-12: Physical Frame Addr (20 bits)

  8: G **Global** survives CR3 reload

  7: PAT Page Attribute Table

  6: D **Dirty** CPU sets on write

  5: A **Accessed** CPU sets on read

  4: PCD Cache Disable: 1 for MMIO

  3: PWT Write-Through cache

  2: U/S **0=Kernel only 1=User OK**

  1: R/W **0=Read-only 1=Read-Write**

  0: P **Present** page fault if 0
'| {
  style: {
    fill: "#0d2d45"
    stroke: "#3498db"
    font-color: "#aed6f1"
    border-radius: 4
  }
}

phys_frame: "Physical Frame (4KB RAM)" {
  style: {
    fill: "#0d3b1f"
    stroke: "#27ae60"
    stroke-width: 3
    font-color: white
    bold: true
    border-radius: 6
    shadow: true
  }
}

phys_frame_note: |'md
  **Frame base** = PTE bits 31-12 shifted left 12

  **Final phys addr** = frame_base + offset

  4096-byte aligned in physical RAM
'| {
  style: {
    fill: "#071f10"
    stroke: "#27ae60"
    font-color: "#a9dfbf"
    border-radius: 4
  }
}

tlb: "TLB (Translation Lookaside Buffer)" {
  style: {
    fill: "#7a3b0d"
    stroke: "#e67e22"
    stroke-width: 3
    font-color: white
    bold: true
    border-radius: 6
    shadow: true
  }
}

tlb_detail: |'md
  **L1 dTLB:** ~32-64 entries — 1 cycle hit

  **L2 sTLB:** ~512-4096 entries — ~7 cycle hit

  **TLB miss:** full walk = 20-50 extra cycles

  invlpg vaddr: flush single entry

  CR3 reload: flush all non-global entries

  G=1 pages survive CR3 reload
'| {
  style: {
    fill: "#4a2006"
    stroke: "#e67e22"
    font-color: "#fad7a0"
    border-radius: 4
  }
}

identity_map: "Identity Map Low 4MB" {
  style: {
    fill: "#1c1c0a"
    stroke: "#f1c40f"
    stroke-width: 3
    font-color: white
    bold: true
    border-radius: 6
    stroke-dash: 4
  }
}

identity_map_detail: |'md
  **Virtual == Physical** (bootstrapping)

  vaddr 0x00000000 to 0x003FFFFF

  maps to phys 0x00000000 to 0x003FFFFF

  PD index 0 points to identity_page_table

  PTE[i] = (i*4096) OR PRESENT OR WRITABLE

  Covers: IVT (0x0), Kernel (0x100000), VGA (0xB8000)

  **Removed after** higher-half transition:

  boot_page_directory[0] = 0 then TLB flush
'| {
  style: {
    fill: "#0f0f04"
    stroke: "#f1c40f"
    font-color: "#fef9e7"
    border-radius: 4
  }
}

higher_half: "Higher-Half Kernel Map" {
  style: {
    fill: "#1a0505"
    stroke: "#e74c3c"
    stroke-width: 3
    font-color: white
    bold: true
    border-radius: 6
    stroke-dash: 4
  }
}

higher_half_detail: |'md
  **vaddr 0xC0000000 to 0xC03FFFFF**

  maps to phys 0x00000000 to 0x003FFFFF

  PD index 768 (= 0xC0000000 >> 22)

  points to kernel_page_table[0..1023]

  **Kernel 3GB/1GB split:**

  User: 0x00000000 to 0xBFFFFFFF (3 GB)

  Kernel: 0xC0000000 to 0xFFFFFFFF (1 GB)

  PDEs 768-1023 shared across all processes

  U/S=0 supervisor only; G=1 TLB-persistent
'| {
  style: {
    fill: "#0d0000"
    stroke: "#e74c3c"
    font-color: "#fadbd8"
    border-radius: 4
  }
}

example: "Concrete Example: vaddr 0xC0100234" {
  style: {
    fill: "#0a1628"
    stroke: "#5dade2"
    stroke-width: 2
    font-color: white
    border-radius: 6
    bold: true
  }
}

example_calc: |'md
  **Virtual address:** 0xC0100234

  **PD index:** bits 31-22 = 0b1100000000 = **768**

  boot_page_directory[768] -> kernel_page_table

  **PT index:** bits 21-12 = 0b0001000000 = **64**

  kernel_page_table[256] PTE bits 31-12 = frame 0x100

  **Offset:** bits 11-0 = 0x234 = 564

  **Physical:** 0x00100000 + 0x234 = **0x00100234**
'| {
  style: {
    fill: "#050e1c"
    stroke: "#5dade2"
    font-color: "#d6eaf8"
    border-radius: 4
  }
}

flag_legend: "PTE Flag Quick Reference" {
  style: {
    fill: "#1a1a1a"
    stroke: "#808080"
    stroke-width: 2
    font-color: white
    border-radius: 6
  }
}

flag_table: |'md
  | Flag | Bit | Kernel use |
  |------|-----|------------|
  | P    | 0   | Must=1; 0 triggers page fault |
  | R/W  | 1   | 0=RO code, 1=RW data/stack |
  | U/S  | 2   | 0=ring0 only, 1=ring3 OK |
  | PWT  | 3   | Write-Through cache |
  | PCD  | 4   | Disable cache for MMIO/VGA |
  | A    | 5   | CPU sets on first access |
  | D    | 6   | CPU sets on first write |
  | G    | 8   | Survive CR3 reload |
'| {
  style: {
    fill: "#111111"
    stroke: "#808080"
    font-color: "#d0d0d0"
    border-radius: 4
  }
}

cr3 -> pd: "Physical addr of PD\nCR3 bits[31:12] shift left 12\ncost: DRAM ~60ns if cold" {
  style: {
    stroke: "#9b59b6"
    stroke-width: 3
    font-color: "#d7bde2"
    bold: true
  }
}

vaddr_pd -> pde: "Index PD with bits[31:22]\n10-bit index selects 1 of 1024 PDEs\neach PDE covers 4MB virtual space" {
  style: {
    stroke: "#b86fc6"
    stroke-width: 2
    font-color: "#e8d5f0"
    stroke-dash: 3
  }
}

pde -> pt: "PDE[31:12] shift left 12\n= Physical base of Page Table\ncost: L2/L3 miss 10-40ns" {
  style: {
    stroke: "#7c83fd"
    stroke-width: 3
    font-color: "#c8c8ff"
    bold: true
  }
}

vaddr_pt -> pte: "Index PT with bits[21:12]\n10-bit index selects 1 of 1024 PTEs\neach PTE maps one 4KB frame" {
  style: {
    stroke: "#3498db"
    stroke-width: 2
    font-color: "#aed6f1"
    stroke-dash: 3
  }
}

pte -> phys_frame: "PTE[31:12] shift left 12\n= Physical frame base address\n4KB aligned in DRAM" {
  style: {
    stroke: "#27ae60"
    stroke-width: 3
    font-color: "#a9dfbf"
    bold: true
  }
}

vaddr_off -> phys_frame: "Add 12-bit page offset\nto frame base address\n= final physical address" {
  style: {
    stroke: "#27ae60"
    stroke-width: 2
    font-color: "#a9dfbf"
    stroke-dash: 3
  }
}

tlb -> phys_frame: "TLB HIT: skip walk entirely\n1 cycle to physical addr\nvpage cached to frame mapping" {
  style: {
    stroke: "#e67e22"
    stroke-width: 2
    stroke-dash: 5
    font-color: "#fad7a0"
    animated: true
  }
}

vaddr_pd -> tlb: "Lookup virtual page before walk\nhit rate ~99% in steady state\nmiss triggers full 3-level walk" {
  style: {
    stroke: "#e67e22"
    stroke-width: 2
    font-color: "#fad7a0"
  }
}

identity_map -> pd: "PD[0] -> identity_page_table\nvirt 0x0-0x3FFFFF == phys\nbootstrap: enables paging safely" {
  style: {
    stroke: "#f1c40f"
    stroke-width: 2
    stroke-dash: 4
    font-color: "#fef9e7"
  }
}

higher_half -> pd: "PD[768] -> kernel_page_table\nvirt 0xC0000000 maps to phys 0x0\nkernel runs in upper 1GB" {
  style: {
    stroke: "#e74c3c"
    stroke-width: 2
    stroke-dash: 4
    font-color: "#fadbd8"
  }
}

example -> cr3: "Walk starts at CR3\nloaded during vmm_enable_paging\nCR0.PG=1 activates MMU" {
  style: {
    stroke: "#5dade2"
    stroke-width: 2
    stroke-dash: 3
    font-color: "#d6eaf8"
  }
}

cr3_detail -> cr3: "" { style.stroke: "#9b59b6"; style.stroke-dash: 2 }
vaddr_pd_note -> vaddr_pd: "" { style.stroke: "#b86fc6"; style.stroke-dash: 2 }
vaddr_pt_note -> vaddr_pt: "" { style.stroke: "#3498db"; style.stroke-dash: 2 }
vaddr_off_note -> vaddr_off: "" { style.stroke: "#27ae60"; style.stroke-dash: 2 }
pd_info -> pd: "" { style.stroke: "#7c83fd"; style.stroke-dash: 2 }
pde_bits -> pde: "" { style.stroke: "#b86fc6"; style.stroke-dash: 2 }
pt_info -> pt: "" { style.stroke: "#3498db"; style.stroke-dash: 2 }
pte_bits -> pte: "" { style.stroke: "#3498db"; style.stroke-dash: 2 }
phys_frame_note -> phys_frame: "" { style.stroke: "#27ae60"; style.stroke-dash: 2 }
tlb_detail -> tlb: "" { style.stroke: "#e67e22"; style.stroke-dash: 2 }
identity_map_detail -> identity_map: "" { style.stroke: "#f1c40f"; style.stroke-dash: 2 }
higher_half_detail -> higher_half: "" { style.stroke: "#e74c3c"; style.stroke-dash: 2 }
example_calc -> example: "" { style.stroke: "#5dade2"; style.stroke-dash: 2 }
flag_table -> flag_legend: "" { style.stroke: "#808080"; style.stroke-dash: 2 }
pde -> pde_bits: "" { style.stroke: "#b86fc6"; style.stroke-dash: 2 }
pte -> pte_bits: "" { style.stroke: "#3498db"; style.stroke-dash: 2 }