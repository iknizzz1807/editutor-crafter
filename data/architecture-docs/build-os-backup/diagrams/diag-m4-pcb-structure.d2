vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Process Control Block — Memory Layout\n64 bytes = exactly one x86 cache line (hot path optimized)" {
  near: top-right-center
  style: {
    fill: "#0d0d1a"
    stroke: "#6666aa"
    border-radius: 6
    font-color: "#ccccff"
    bold: true
    font-size: 16
  }
}

pcb: "Process Control Block (process_t)" {
  style: {
    fill: "#0d0d1a"
    stroke: "#6666aa"
    stroke-width: 3
    border-radius: 6
    font-color: "#ccccff"
    bold: true
    font-size: 16
  }

  row_pid: "+0x00  pid — uint32_t — 4 bytes\nProcess Identifier (unique, monotonically increasing)" {
    style: {
      fill: "#2d1b4e"
      stroke: "#9966cc"
      stroke-width: 2
      border-radius: 4
      font-color: "#ddaaff"
      font-size: 13
    }
  }

  row_state: "+0x04  state — uint32_t (enum) — 4 bytes\n0=UNUSED  1=READY  2=RUNNING  3=BLOCKED  4=ZOMBIE" {
    style: {
      fill: "#2d1b4e"
      stroke: "#9966cc"
      stroke-width: 2
      border-radius: 4
      font-color: "#ddaaff"
      font-size: 13
    }
  }

  row_eip: "+0x08  cpu.eip — uint32_t — 4 bytes\nSaved Instruction Pointer (resume address after context switch)" {
    style: {
      fill: "#0d2040"
      stroke: "#4488cc"
      stroke-width: 2
      border-radius: 4
      font-color: "#aaccff"
      font-size: 13
    }
  }

  row_esp: "+0x0C  cpu.esp — uint32_t — 4 bytes\nSaved Kernel Stack Pointer (points into kernel_stack[])" {
    style: {
      fill: "#0d2040"
      stroke: "#4488cc"
      stroke-width: 2
      border-radius: 4
      font-color: "#aaccff"
      font-size: 13
    }
  }

  row_ebp: "+0x10  cpu.ebp — uint32_t — 4 bytes\nSaved Base Pointer (frame pointer for interrupted function)" {
    style: {
      fill: "#0d2040"
      stroke: "#4488cc"
      stroke-width: 2
      border-radius: 4
      font-color: "#aaccff"
      font-size: 13
    }
  }

  row_gpr: "+0x14 to +0x2B  General Purpose Registers — 24 bytes (6 x 4B)\neax  ebx  ecx  edx  esi  edi  (callee-saved + caller context)" {
    style: {
      fill: "#0d2040"
      stroke: "#2266aa"
      stroke-width: 2
      border-radius: 4
      font-color: "#88bbff"
      font-size: 13
    }
  }

  row_eflags: "+0x2C  cpu.eflags — uint32_t — 4 bytes\nIF=1 mandatory (interrupts re-enabled on iret); IOPL, CF, ZF, SF preserved" {
    style: {
      fill: "#0d2040"
      stroke: "#4488cc"
      stroke-width: 2
      border-radius: 4
      font-color: "#aaccff"
      font-size: 13
    }
  }

  row_cr3: "+0x30  page_dir_phys — uint32_t — 4 bytes\nPhysical address loaded into CR3 on context switch (address space root)" {
    style: {
      fill: "#2d1a00"
      stroke: "#cc7700"
      stroke-width: 2
      border-radius: 4
      font-color: "#ffcc66"
      font-size: 13
    }
  }

  row_kstack_top: "+0x34  kernel_stack_top — uint32_t — 4 bytes\nHighest address of kernel stack; written to TSS.ESP0 before iret to ring 3" {
    style: {
      fill: "#0d2d0d"
      stroke: "#33aa44"
      stroke-width: 2
      border-radius: 4
      font-color: "#88ffaa"
      font-size: 13
    }
  }

  row_kstack_bot: "+0x38  kernel_stack_bottom — uint32_t — 4 bytes\nLowest address of kernel stack; guard page boundary (stack overflow detect)" {
    style: {
      fill: "#0d2d0d"
      stroke: "#33aa44"
      stroke-width: 2
      border-radius: 4
      font-color: "#88ffaa"
      font-size: 13
    }
  }

  row_next: "+0x3C  next — uint32_t (ptr) — 4 bytes\nIntrusive linked list: next PCB in run queue (NULL if last)" {
    style: {
      fill: "#2d0d0d"
      stroke: "#cc3333"
      stroke-width: 2
      border-radius: 4
      font-color: "#ffaaaa"
      font-size: 13
    }
  }

  cacheline: "TOTAL: 64 bytes = 1 cache line (L1 64B line)\nAll fields fit without crossing a cache line boundary.\nScheduler hot path reads pid+state+cpu.esp in a single cache load." {
    style: {
      fill: "#1a1a00"
      stroke: "#888800"
      stroke-width: 2
      stroke-dash: 4
      border-radius: 4
      font-color: "#ffffaa"
      font-size: 12
      bold: true
    }
  }
}

hot_path: "Scheduler Hot Path\nsched_schedule reads\npid+state+cpu.esp\nfrom offsets 0x00-0x0C\n(single cache load)" {
  style: {
    fill: "#1a0000"
    stroke: "#ff4444"
    stroke-width: 2
    stroke-dash: 3
    border-radius: 6
    font-color: "#ff8888"
    font-size: 13
    bold: true
  }
}

context_save: "context_switch_asm\nsaves eip/esp/ebp\n+6 GPRs + eflags\nvia pusha sequence\n(32 bytes total)" {
  style: {
    fill: "#001a2d"
    stroke: "#4488cc"
    stroke-width: 2
    stroke-dash: 3
    border-radius: 6
    font-color: "#88bbff"
    font-size: 13
  }
}

tss_update: "TSS.ESP0 = kernel_stack_top\nbefore every ring-3 iret\n(prevents stack hijack\nif IRQ fires mid-switch)" {
  style: {
    fill: "#002d00"
    stroke: "#33aa44"
    stroke-width: 2
    stroke-dash: 3
    border-radius: 6
    font-color: "#88ffaa"
    font-size: 13
  }
}

cr3_load: "mov cr3, page_dir_phys\n=> TLB flush (~100 cyc)\n=> full address space\nswitch instantaneous" {
  style: {
    fill: "#2d1a00"
    stroke: "#cc7700"
    stroke-width: 2
    stroke-dash: 3
    border-radius: 6
    font-color: "#ffcc66"
    font-size: 13
  }
}

linked_list: "run_queue -> PCB -> PCB\n-> PCB -> NULL\nRound-robin O(n)\nper scheduler tick" {
  style: {
    fill: "#2d0000"
    stroke: "#cc3333"
    stroke-width: 2
    stroke-dash: 3
    border-radius: 6
    font-color: "#ffaaaa"
    font-size: 13
  }
}

hot_path -> pcb.row_pid: "reads pid+state at +0x00/+0x04 (identity check)" {
  style: { stroke: "#ff4444"; stroke-dash: 4; animated: true }
}
hot_path -> pcb.row_esp: "reads cpu.esp at +0x0C (stack pivot target)" {
  style: { stroke: "#ff6666"; stroke-dash: 4; animated: true }
}
context_save -> pcb.row_eip: "stores EIP at +0x08 (resume addr)" {
  style: { stroke: "#4488cc"; stroke-dash: 4 }
}
context_save -> pcb.row_gpr: "stores EAX-EDI at +0x14 to +0x2B (via pusha)" {
  style: { stroke: "#2266aa"; stroke-dash: 4 }
}
context_save -> pcb.row_eflags: "stores EFLAGS at +0x2C (IF=1 required)" {
  style: { stroke: "#4488cc"; stroke-dash: 4 }
}
tss_update -> pcb.row_kstack_top: "TSS.ESP0 loaded from this field" {
  style: { stroke: "#33aa44"; stroke-dash: 4 }
}
cr3_load -> pcb.row_cr3: "loaded into CR3 register" {
  style: { stroke: "#cc7700"; stroke-dash: 4 }
}
linked_list -> pcb.row_next: "scheduler advances via this ptr" {
  style: { stroke: "#cc3333"; stroke-dash: 4 }
}

switch_flow: "Context Switch Sequence" {
  style: {
    fill: "#080818"
    stroke: "#555577"
    border-radius: 8
    font-color: "#aaaacc"
    font-size: 14
    bold: true
  }

  s1: "IRQ fires\nIF=1, timer tick\n(~150 cyc latency)" {
    style: { fill: "#1a001a"; stroke: "#9933cc"; border-radius: 4; font-color: "#cc88ff"; font-size: 12 }
  }
  s2: "CPU pushes to kstack\nEFLAGS, CS, EIP\n[+SS, ESP if ring3]" {
    style: { fill: "#001a2d"; stroke: "#2266aa"; border-radius: 4; font-color: "#88aaff"; font-size: 12 }
  }
  s3: "irq_common_stub\npusha => 8 GPRs\n(32 bytes saved)" {
    style: { fill: "#001a2d"; stroke: "#4488cc"; border-radius: 4; font-color: "#aaccff"; font-size: 12 }
  }
  s4: "context_switch_asm\nmov [old.esp], esp\nmov esp, next.esp\nTHE PIVOT POINT" {
    style: { fill: "#1a1a00"; stroke: "#aaaa00"; border-radius: 4; font-color: "#ffff88"; font-size: 12; bold: true }
  }
  s5: "TSS.ESP0 = next\n.kernel_stack_top\n(~1 cyc, L1 hot)" {
    style: { fill: "#002d00"; stroke: "#33aa44"; border-radius: 4; font-color: "#88ffaa"; font-size: 12 }
  }
  s6: "mov cr3, next.cr3\nTLB flush\n(~100 cyc if cold)" {
    style: { fill: "#2d1a00"; stroke: "#cc7700"; border-radius: 4; font-color: "#ffcc66"; font-size: 12 }
  }
  s7: "popa + iret restores\nnext process state\n(~50 cyc total)" {
    style: { fill: "#002d00"; stroke: "#00aa55"; border-radius: 4; font-color: "#55ffaa"; font-size: 12; bold: true }
  }

  s1 -> s2: "INTR asserted by PIC" { style: { stroke: "#9933cc"; animated: true } }
  s2 -> s3: "5 writes to kstack\n(EFLAGS,CS,EIP,SS,ESP)" { style: { stroke: "#2266aa" } }
  s3 -> s4: "8 regs x 4B = 32B\npushed by pusha" { style: { stroke: "#4488cc" } }
  s4 -> s5: "old PCB.esp saved\nnew esp now live" { style: { stroke: "#aaaa00"; bold: true } }
  s5 -> s6: "TSS written before\naddress space swap" { style: { stroke: "#33aa44" } }
  s6 -> s7: "address space switch\ncomplete; run next" { style: { stroke: "#cc7700" } }
}

switch_flow -> pcb: "reads+writes PCB fields\non every context switch" {
  style: { stroke: "#666688"; stroke-dash: 5; opacity: 0.7 }
}

byte_table: |'md
  | Offset | Field | Size | Color Domain |
'|--------|-------|------|--------------|
  | +0x00 | pid | 4 B | Purple: Identity |
  | +0x04 | state | 4 B | Purple: Lifecycle |
  | +0x08 | cpu.eip | 4 B | Blue: CPU state |
  | +0x0C | cpu.esp | 4 B | Blue: CPU state |
  | +0x10 | cpu.ebp | 4 B | Blue: CPU state |
  | +0x14 | cpu.eax | 4 B | Blue: CPU state |
  | +0x18 | cpu.ebx | 4 B | Blue: CPU state |
  | +0x1C | cpu.ecx | 4 B | Blue: CPU state |
  | +0x20 | cpu.edx | 4 B | Blue: CPU state |
  | +0x24 | cpu.esi | 4 B | Blue: CPU state |
  | +0x28 | cpu.edi | 4 B | Blue: CPU state |
  | +0x2C | cpu.eflags | 4 B | Blue: CPU state |
  | +0x30 | page_dir_phys | 4 B | Orange: MMU |
  | +0x34 | kernel_stack_top | 4 B | Green: Stack |
  | +0x38 | kernel_stack_bottom | 4 B | Green: Stack |
  | +0x3C | next ptr | 4 B | Red: Scheduler |
  | Total | — | 64 B | 1 cache line |
'| {
  near: top-right-center
  style: {
    fill: "#111122"
    stroke: "#444466"
    border-radius: 6
    font-color: "#ccccee"
    font-size: 12
  }
}