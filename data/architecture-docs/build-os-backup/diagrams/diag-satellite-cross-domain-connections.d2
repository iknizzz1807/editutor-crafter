vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

style: {
  fill: "#0D1117"
  stroke: "#30363D"
}

title: |md
  # OS Primitives â†’ Cross-Domain Systems
  *Every concept you built powers a downstream world*
| {
  near: top-center
  style: {
    font-size: 13
    fill: transparent
    stroke: transparent
    font-color: "#8B949E"
  }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# LEGEND
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
legend: {
  near: bottom-right
  style: {
    fill: "#161B22"
    stroke: "#30363D"
    border-radius: 8
    font-size: 11
  }
  content: |md
    **Color Semantics**
    ðŸ”´ Red border = OS primitive (root cause)
    ðŸŸ¢ Green = success/safe descendant
    ðŸŸ¡ Yellow = performance optimization path
    ðŸ”µ Blue = data-flow / read path
    ðŸŸ£ Purple = metadata / security enforcement
    â¬œ Gray = padding / unused / deprecated path
  |
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# LAYER 0 â€” OS PRIMITIVES (roots)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

primitives: OS Primitives Built in This Project {
  style: {
    fill: "#161B22"
    stroke: "#F85149"
    stroke-width: 3
    border-radius: 10
    font-size: 13
    font-color: "#F85149"
    bold: true
  }

  pgtbl: Page Tables\n(CR3, PDE, PTE, TLB) {
    style: {
      fill: "#1C1C2E"
      stroke: "#F85149"
      stroke-width: 2
      border-radius: 8
      font-color: "#FF7B72"
      font-size: 12
      bold: true
    }
    detail: |md
      **What you built:**
      - 2-level PD â†’ PT walk
      - U/S, R/W, P flags
      - TLB flush via invlpg
      - Per-process CR3
      - Identity + higher-half map
    | {
      style.fill: "#0D1117"
      style.stroke: "#30363D"
      style.font-size: 10
    }
  }

  ctxsw: Context Switch\n(Assembly save/restore, pcb.cpu) {
    style: {
      fill: "#1C1C2E"
      stroke: "#F85149"
      stroke-width: 2
      border-radius: 8
      font-color: "#FF7B72"
      font-size: 12
      bold: true
    }
    detail: |md
      **What you built:**
      - pusha / popa on IRQ stack
      - esp swap in asm
      - Fake initial stack frame
      - ~1000 cycle cost measured
      - Round-robin + ticks_remaining
    | {
      style.fill: "#0D1117"
      style.stroke: "#30363D"
      style.font-size: 10
    }
  }

  idt: Interrupt IDT\n(Gates, PIC remap, ISR stubs) {
    style: {
      fill: "#1C1C2E"
      stroke: "#F85149"
      stroke-width: 2
      border-radius: 8
      font-color: "#FF7B72"
      font-size: 12
      bold: true
    }
    detail: |md
      **What you built:**
      - 256-entry IDT
      - Int gate (IF clears) vs Trap gate
      - PIC remapped: IRQ0â†’vec32
      - EOI protocol mandatory
      - ISR stack frame layout
    | {
      style.fill: "#0D1117"
      style.stroke: "#30363D"
      style.font-size: 10
    }
  }

  rings: Ring Transitions\n(TSS, ESP0, INT 0x80) {
    style: {
      fill: "#1C1C2E"
      stroke: "#F85149"
      stroke-width: 2
      border-radius: 8
      font-color: "#FF7B72"
      font-size: 12
      bold: true
    }
    detail: |md
      **What you built:**
      - TSS.ESP0 per-process kernel stack
      - INT 0x80 trap gate DPL=3
      - iret 5-field ring-3 frame
      - syscall_dispatch â†’ EAX number
      - Pointer validation in kernel
    | {
      style.fill: "#0D1117"
      style.stroke: "#30363D"
      style.font-size: 10
    }
  }

  bitmap: Bitmap Frame Allocator\n(PMM, 128KB bitmap, next-fit) {
    style: {
      fill: "#1C1C2E"
      stroke: "#F85149"
      stroke-width: 2
      border-radius: 8
      font-color: "#FF7B72"
      font-size: 12
      bold: true
    }
    detail: |md
      **What you built:**
      - 1 bit / 4KB frame â†’ 128KB
      - Sequential scan (prefetch-friendly)
      - search_hint next-fit optimization
      - Double-free detection
      - E820 usable region seeding
    | {
      style.fill: "#0D1117"
      style.stroke: "#30363D"
      style.font-size: 10
    }
  }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# LAYER 1 â€” LINUX KERNEL DESCENDANTS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

linux: Linux Kernel Descendants {
  style: {
    fill: "#0D2818"
    stroke: "#3FB950"
    stroke-width: 2
    border-radius: 10
    font-size: 13
    font-color: "#3FB950"
    bold: true
  }

  kpti: KPTI\n(Kernel Page Table Isolation) {
    style: {
      fill: "#0A1F12"
      stroke: "#3FB950"
      border-radius: 6
      font-color: "#7EE787"
      font-size: 11
    }
    note: |md
      Meltdown 2018: swap CR3 on
      every ring transition.
      Cost: 5â€“30% syscall overhead.
      **Root cause:** U/S flag bypass
      via speculative execution.
    | {
      style.fill: "#0D1117"
      style.stroke: "#238636"
      style.font-size: 10
    }
  }

  cfs: CFS Scheduler\n(vruntime, red-black tree) {
    style: {
      fill: "#0A1F12"
      stroke: "#3FB950"
      border-radius: 6
      font-color: "#7EE787"
      font-size: 11
    }
    note: |md
      vruntime = weighted CPU time.
      Always run lowest vruntime.
      I/O-bound processes starve
      less: blocked = 0 vruntime.
      **Root:** round-robin unfair to
      interactive workloads.
    | {
      style.fill: "#0D1117"
      style.stroke: "#238636"
      style.font-size: 10
    }
  }

  napi: Linux NAPI\n(Interrupt coalescing, poll mode) {
    style: {
      fill: "#0A1F12"
      stroke: "#3FB950"
      border-radius: 6
      font-color: "#7EE787"
      font-size: 11
    }
    note: |md
      10Gbps â†’ millions of IRQs/sec.
      Solution: first IRQ disables NIC
      IRQ (like skipping EOI), switch
      to polling until queue empty.
      **Root:** EOI protocol cost.
    | {
      style.fill: "#0D1117"
      style.stroke: "#238636"
      style.font-size: 10
    }
  }

  seccomp: seccomp\n(Syscall filter, BPF bytecode) {
    style: {
      fill: "#0A1F12"
      stroke: "#3FB950"
      border-radius: 6
      font-color: "#7EE787"
      font-size: 11
    }
    note: |md
      Filter inserted between IDT
      trap gate and syscall table.
      Docker default policy: blocks
      ~40 dangerous syscalls.
      **Root:** INT 0x80 dispatch path.
    | {
      style.fill: "#0D1117"
      style.stroke: "#238636"
      style.font-size: 10
    }
  }

  buddy: Buddy Allocator\n(Linux physical page mgr) {
    style: {
      fill: "#0A1F12"
      stroke: "#3FB950"
      border-radius: 6
      font-color: "#7EE787"
      font-size: 11
    }
    note: |md
      Power-of-2 block sizes.
      Adjacent free blocks merge
      (buddy = XOR of frame index).
      O(log n) alloc/free.
      **Root:** bitmap is O(n) scan,
      no contiguous-alloc support.
    | {
      style.fill: "#0D1117"
      style.stroke: "#238636"
      style.font-size: 10
    }
  }

  tlb_shoot: TLB Shootdown\n(IPI to remote cores) {
    style: {
      fill: "#0A1F12"
      stroke: "#3FB950"
      border-radius: 6
      font-color: "#7EE787"
      font-size: 11
    }
    note: |md
      Each core has private TLB.
      PTE modify on core 0 â†’
      IPI to cores 1..N-1 â†’
      each flushes invlpg locally.
      Cost: ~500 cycles Ã— N cores.
      **Root:** single-core invlpg.
    | {
      style.fill: "#0D1117"
      style.stroke: "#238636"
      style.font-size: 10
    }
  }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# LAYER 2 â€” VIRTUALIZATION / CONTAINERS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

virt: Virtualization & Container Descendants {
  style: {
    fill: "#0D1B2E"
    stroke: "#58A6FF"
    stroke-width: 2
    border-radius: 10
    font-size: 13
    font-color: "#58A6FF"
    bold: true
  }

  ept: Hypervisor EPT/NPT\n(Extended / Nested Page Tables) {
    style: {
      fill: "#071525"
      stroke: "#58A6FF"
      border-radius: 6
      font-color: "#79C0FF"
      font-size: 11
    }
    note: |md
      VMX root: second CR3 pointer
      (EPTP). Guest CR3 â†’ guest-phys.
      EPT â†’ machine-phys. Two walks.
      Guest OS manages its page tables
      normally; hypervisor intercepts CR3.
      **Root:** CR3 + PDE/PTE walk.
    | {
      style.fill: "#0D1117"
      style.stroke: "#1F6FEB"
      style.font-size: 10
    }
  }

  namespaces: Linux Namespaces\n(PID, Net, Mount, User) {
    style: {
      fill: "#071525"
      stroke: "#58A6FF"
      border-radius: 6
      font-color: "#79C0FF"
      font-size: 11
    }
    note: |md
      Namespaces wrap kernel data
      structures (mount table, PID
      table, network stack) per group.
      Memory isolation still rooted in
      per-process page directory.
      **Root:** per-process CR3.
    | {
      style.fill: "#0D1117"
      style.stroke: "#1F6FEB"
      style.font-size: 10
    }
  }

  overlay: Docker Overlay FS\n(overlayfs: upper/lower layers) {
    style: {
      fill: "#071525"
      stroke: "#58A6FF"
      border-radius: 6
      font-color: "#79C0FF"
      font-size: 11
    }
    note: |md
      CoW filesystem: read from lower
      layer, write creates copy in upper.
      Backed by demand-paging (P=0
      PTE triggers fault â†’ allocate
      frame â†’ copy-on-write).
      **Root:** page fault handler + PMM.
    | {
      style.fill: "#0D1117"
      style.stroke: "#1F6FEB"
      style.font-size: 10
    }
  }

  aslr: ASLR\n(Address Space Layout Randomization) {
    style: {
      fill: "#071525"
      stroke: "#58A6FF"
      border-radius: 6
      font-color: "#79C0FF"
      font-size: 11
    }
    note: |md
      Random base for kernel, heap,
      stack, libs at each exec.
      Linker address â‰  load address
      (PIC / relocations).
      KASLR randomizes kernel VMA.
      **Root:** link addr vs load addr
      split you experienced in M1.
    | {
      style.fill: "#0D1117"
      style.stroke: "#1F6FEB"
      style.font-size: 10
    }
  }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# LAYER 3 â€” USERSPACE / LANGUAGE RUNTIMES
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

runtimes: Language Runtime Descendants {
  style: {
    fill: "#1C1A00"
    stroke: "#D29922"
    stroke-width: 2
    border-radius: 10
    font-size: 13
    font-color: "#D29922"
    bold: true
  }

  goroutine: Go Goroutine Scheduler\n(M:N, work-stealing, ~100ns switch) {
    style: {
      fill: "#141000"
      stroke: "#D29922"
      border-radius: 6
      font-color: "#E3B341"
      font-size: 11
    }
    note: |md
      G (goroutine) â‰ˆ your PCB.
      M (OS thread) = kernel thread.
      P (processor) = run queue.
      Switch in user space: save 6 regs
      (caller-saved already gone),
      no TLB flush, stack is hot.
      5â€“10Ã— cheaper than OS switch.
      **Root:** your cpu_state_t struct.
    | {
      style.fill: "#0D1117"
      style.stroke: "#9E6A03"
      style.font-size: 10
    }
  }

  greenlets: Python Greenlets\n(ucontext / cooperative coroutines) {
    style: {
      fill: "#141000"
      stroke: "#D29922"
      border-radius: 6
      font-color: "#E3B341"
      font-size: 11
    }
    note: |md
      ucontext_t = C struct holding
      saved registers + stack pointer.
      swapcontext() = your
      context_switch_asm in libc.
      Cooperative: no timer IRQ,
      explicit yield() calls.
      **Root:** fake initial stack frame
      + esp swap pattern.
    | {
      style.fill: "#0D1117"
      style.stroke: "#9E6A03"
      style.font-size: 10
    }
  }

  wasm: WebAssembly Async\n(Asyncify, stack-switching proposal) {
    style: {
      fill: "#141000"
      stroke: "#D29922"
      border-radius: 6
      font-color: "#E3B341"
      font-size: 11
    }
    note: |md
      WASM has no OS; it synthesizes
      context switching in software.
      Asyncify: compiler transforms
      code to save locals on heap
      and resume from call point.
      Stack-switching proposal: native
      explicit stack save/restore.
      **Root:** your assembly context
      switch reduced to a software sim.
    | {
      style.fill: "#0D1117"
      style.stroke: "#9E6A03"
      style.font-size: 10
    }
  }

  jemalloc: jemalloc Extent Map\n(Size-class arenas, slab bitmap) {
    style: {
      fill: "#141000"
      stroke: "#D29922"
      border-radius: 6
      font-color: "#E3B341"
      font-size: 11
    }
    note: |md
      Per-size-class arenas: all 32B
      objects in contiguous slabs.
      Slab free-slot bitmap = your
      frame bitmap but for objects.
      Sequential scan â†’ cache-friendly.
      Thread-local caches avoid locks.
      **Root:** bitmap sequential scan
      cache behavior insight.
    | {
      style.fill: "#0D1117"
      style.stroke: "#9E6A03"
      style.font-size: 10
    }
  }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# LAYER 4 â€” HIGH-PERFORMANCE I/O
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

hpio: High-Performance I/O Descendants {
  style: {
    fill: "#1C0D2E"
    stroke: "#BC8CFF"
    stroke-width: 2
    border-radius: 10
    font-size: 13
    font-color: "#BC8CFF"
    bold: true
  }

  dpdk: DPDK Poll-Mode Drivers\n(Zero-IRQ, busy-poll NIC ring) {
    style: {
      fill: "#100820"
      stroke: "#BC8CFF"
      border-radius: 6
      font-color: "#D2A8FF"
      font-size: 11
    }
    note: |md
      Disables all NIC interrupts.
      User-space thread busy-polls
      NIC descriptor ring directly
      via MMIO (no kernel crossing).
      100ns packet latency vs 10Î¼s
      with interrupt path.
      **Root:** IRQ overhead + MMIO
      write you measured in M1.
    | {
      style.fill: "#0D1117"
      style.stroke: "#6E40C9"
      style.font-size: 10
    }
  }

  io_uring: io_uring\n(Shared ring, no syscall on hot path) {
    style: {
      fill: "#100820"
      stroke: "#BC8CFF"
      border-radius: 6
      font-color: "#D2A8FF"
      font-size: 11
    }
    note: |md
      SQ ring (user writes) +
      CQ ring (kernel writes).
      Shared via mmap: both sides
      access same physical page.
      SQPOLL mode: kernel thread
      polls SQ â€” zero syscall path.
      **Root:** MMIO/shared-memory
      pattern + INT 0x80 cost.
    | {
      style.fill: "#0D1117"
      style.stroke: "#6E40C9"
      style.font-size: 10
    }
  }

  ebpf: eBPF Verifier Enforcement\n(Bytecode in kernel, safety proof) {
    style: {
      fill: "#100820"
      stroke: "#BC8CFF"
      border-radius: 6
      font-color: "#D2A8FF"
      font-size: 11
    }
    note: |md
      eBPF programs run in kernel (ring 0)
      but are verified before load:
      no loops, bounded memory,
      no kernel pointer leaks.
      ptrace: ring-3 process inspects
      another via syscall (controlled
      ring transition per call).
      **Root:** ring 0 privilege model
      and TSS enforcement.
    | {
      style.fill: "#0D1117"
      style.stroke: "#6E40C9"
      style.font-size: 10
    }
  }

  vdso: vDSO / SYSCALL instruction\n(Avoid INT 0x80 overhead) {
    style: {
      fill: "#100820"
      stroke: "#BC8CFF"
      border-radius: 6
      font-color: "#D2A8FF"
      font-size: 11
    }
    note: |md
      vDSO: kernel maps code page into
      every process. clock_gettime()
      reads TSC directly â€” no ring cross.
      SYSCALL/SYSRET: MSR-based entry,
      skips IDT lookup + TSS read.
      ~100 cycles vs ~500 for INT 0x80.
      **Root:** INT 0x80 path cost you
      can now count instruction-by-inst.
    | {
      style.fill: "#0D1117"
      style.stroke: "#6E40C9"
      style.font-size: 10
    }
  }

  gpu_mm: GPU Memory Manager\n(VRAM frames, BAR MMIO mapping) {
    style: {
      fill: "#100820"
      stroke: "#BC8CFF"
      border-radius: 6
      font-color: "#D2A8FF"
      font-size: 11
    }
    note: |md
      GPU driver allocates VRAM frames
      using buddy-like extent allocator.
      Frames mapped into process VAS
      via PCIe BAR MMIO (PAGE_NOCACHE).
      GPU page tables (separate MMU)
      mirror CPU page table concepts:
      base addr + flags + present bit.
      **Root:** MMIO + bitmap allocator.
    | {
      style.fill: "#0D1117"
      style.stroke: "#6E40C9"
      style.font-size: 10
    }
  }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CONNECTIONS â€” Page Tables â†’ descendants
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

primitives.pgtbl -> linux.kpti: "CR3 swap on every\nring transition\n(Meltdown defense)" {
  style: { stroke: "#F85149"; stroke-width: 2; animated: true; font-size: 10; font-color: "#FF7B72" }
}

primitives.pgtbl -> virt.ept: "Two-level walk â†’\ntwo-level EPT walk\n(VMX root intercepts CR3)" {
  style: { stroke: "#58A6FF"; stroke-width: 2; font-size: 10; font-color: "#79C0FF" }
}

primitives.pgtbl -> virt.namespaces: "Per-process CR3 â†’\ncontainer memory\nisolation root" {
  style: { stroke: "#58A6FF"; stroke-width: 2; font-size: 10; font-color: "#79C0FF" }
}

primitives.pgtbl -> virt.aslr: "Link addr â‰  load addr\n(M1 linker script)\nâ†’ KASLR randomizes base" {
  style: { stroke: "#58A6FF"; stroke-width: 2; font-size: 10; font-color: "#79C0FF" }
}

primitives.pgtbl -> virt.overlay: "P=0 PTE â†’ fault â†’\nCOW frame allocation\n(overlayfs upper layer)" {
  style: { stroke: "#58A6FF"; stroke-width: 2; font-size: 10; font-color: "#79C0FF" }
}

primitives.pgtbl -> linux.tlb_shoot: "Single-core invlpg\nâ†’ SMP: IPI all cores\n(distributed TLB flush)" {
  style: { stroke: "#3FB950"; stroke-width: 2; font-size: 10; font-color: "#7EE787" }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CONNECTIONS â€” Context Switch â†’ descendants
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

primitives.ctxsw -> linux.cfs: "Round-robin â†’ vruntime\nfair weighted scheduling\n(I/O-bound gets priority)" {
  style: { stroke: "#3FB950"; stroke-width: 2; font-size: 10; font-color: "#7EE787" }
}

primitives.ctxsw -> runtimes.goroutine: "~1000 cycle OS switch\nâ†’ 100ns goroutine switch\n(user-space, no TLB flush)" {
  style: { stroke: "#D29922"; stroke-width: 2; animated: true; font-size: 10; font-color: "#E3B341" }
}

primitives.ctxsw -> runtimes.greenlets: "cpu_state_t + esp swap\n= ucontext_t +\nswapcontext() in libc" {
  style: { stroke: "#D29922"; stroke-width: 2; font-size: 10; font-color: "#E3B341" }
}

primitives.ctxsw -> runtimes.wasm: "Assembly register save\nâ†’ Asyncify: save locals\nto heap, resume later" {
  style: { stroke: "#D29922"; stroke-width: 2; font-size: 10; font-color: "#E3B341" }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CONNECTIONS â€” IDT / IRQ â†’ descendants
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

primitives.idt -> linux.napi: "EOI after every packet\nâ†’ coalesce: disable IRQ,\npoll until empty" {
  style: { stroke: "#3FB950"; stroke-width: 2; font-size: 10; font-color: "#7EE787" }
}

primitives.idt -> hpio.dpdk: "IRQ overhead per pkt\nâ†’ disable all NIC IRQs,\nbusy-poll in userspace" {
  style: { stroke: "#BC8CFF"; stroke-width: 2; animated: true; font-size: 10; font-color: "#D2A8FF" }
}

primitives.idt -> hpio.io_uring: "INT 0x80 per I/O op\nâ†’ shared ring buffer,\nzero-syscall hot path" {
  style: { stroke: "#BC8CFF"; stroke-width: 2; font-size: 10; font-color: "#D2A8FF" }
}

primitives.idt -> hpio.vdso: "INT 0x80 path cost\n(500 cycles) â†’ SYSCALL\ninstruction (100 cycles)" {
  style: { stroke: "#BC8CFF"; stroke-width: 2; font-size: 10; font-color: "#D2A8FF" }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CONNECTIONS â€” Ring Transitions / TSS â†’ descendants
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

primitives.rings -> linux.seccomp: "INT 0x80 dispatch path\nâ†’ seccomp filter inserted\nbetween gate and handler" {
  style: { stroke: "#3FB950"; stroke-width: 2; font-size: 10; font-color: "#7EE787" }
}

primitives.rings -> hpio.ebpf: "Ring 0 privilege model\nâ†’ eBPF verifier proof\nthat kernel code is safe" {
  style: { stroke: "#BC8CFF"; stroke-width: 2; font-size: 10; font-color: "#D2A8FF" }
}

primitives.rings -> hpio.vdso: "TSS.ESP0 per-process\nâ†’ SYSENTER uses MSR,\nskips TSS read entirely" {
  style: { stroke: "#BC8CFF"; stroke-width: 2; font-size: 10; font-color: "#D2A8FF" }
}

primitives.rings -> virt.namespaces: "Privilege ring enforces\nkernel vs user boundary\nâ†’ user-namespace isolation" {
  style: { stroke: "#58A6FF"; stroke-width: 2; font-size: 10; font-color: "#79C0FF" }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CONNECTIONS â€” Bitmap Allocator â†’ descendants
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

primitives.bitmap -> linux.buddy: "Bitmap O(n) scan, no\ncontiguous alloc â†’\nbuddy O(log n) merge" {
  style: { stroke: "#3FB950"; stroke-width: 2; font-size: 10; font-color: "#7EE787" }
}

primitives.bitmap -> runtimes.jemalloc: "Sequential bitmap scan\n(cache-line covers 512 frames)\nâ†’ slab bitmap same idea" {
  style: { stroke: "#D29922"; stroke-width: 2; font-size: 10; font-color: "#E3B341" }
}

primitives.bitmap -> hpio.gpu_mm: "Frame allocation primitives\nâ†’ VRAM extent allocator,\nPAGE_NOCACHE BAR mapping" {
  style: { stroke: "#BC8CFF"; stroke-width: 2; font-size: 10; font-color: "#D2A8FF" }
}

primitives.bitmap -> virt.overlay: "pmm_alloc_frame() on\npage fault â†’ COW\nframe backing overlayfs" {
  style: { stroke: "#58A6FF"; stroke-width: 2; font-size: 10; font-color: "#79C0FF" }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CROSS-LAYER CONNECTIONS (second-order effects)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

linux.kpti -> virt.ept: "KPTI doubles CR3 swaps\nper syscall; EPT adds\nsecond page-walk level\nâ†’ TLB pressure compounds" {
  style: { stroke: "#8B949E"; stroke-dash: 5; font-size: 10; font-color: "#8B949E" }
}

linux.napi -> hpio.dpdk: "NAPI: IRQ â†’ poll hybrid\nDPDK: pure poll, skip\nkernel entirely (PMD)" {
  style: { stroke: "#8B949E"; stroke-dash: 5; font-size: 10; font-color: "#8B949E" }
}

linux.buddy -> runtimes.jemalloc: "Buddy gives jemalloc\n2MB huge pages;\njemalloc slices into\nsize-class objects" {
  style: { stroke: "#8B949E"; stroke-dash: 5; font-size: 10; font-color: "#8B949E" }
}

runtimes.goroutine -> hpio.io_uring: "Go runtime uses io_uring\nfor async I/O; goroutine\nblocks, scheduler runs\nother goroutines" {
  style: { stroke: "#8B949E"; stroke-dash: 5; font-size: 10; font-color: "#8B949E" }
}

linux.seccomp -> hpio.ebpf: "seccomp BPF filter is\nearly eBPF; modern eBPF\nextends same verifier\nto kprobes, XDP, etc." {
  style: { stroke: "#8B949E"; stroke-dash: 5; font-size: 10; font-color: "#8B949E" }
}

virt.ept -> hpio.gpu_mm: "EPT: CPU MMU intercepts\ngraph memory; GPU MMU\nis independent but mirrors\nthe same flag semantics" {
  style: { stroke: "#8B949E"; stroke-dash: 5; font-size: 10; font-color: "#8B949E" }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SCALE ANNOTATIONS as standalone nodes
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

scale_ctx: |md
  **Cost Reference**
  OS context switch: ~1000 cycles (~500ns @ 2GHz)
  Go goroutine switch: ~100â€“200 cycles (~75ns)
  INT 0x80 round-trip: ~500 cycles
  SYSCALL/SYSRET: ~100 cycles
  vDSO clock_gettime: ~20 cycles (no ring cross)
  TLB miss + page walk: ~20â€“50 cycles
  DRAM access (TLB miss cold): ~200 cycles
  IPI (TLB shootdown): ~500 cycles Ã— N cores
| {
  near: bottom-left
  style: {
    fill: "#161B22"
    stroke: "#30363D"
    border-radius: 8
    font-size: 10
    font-color: "#8B949E"
  }
}