vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "ISR Stack Frame Layout: Ring 0 vs Ring 3 Interrupt" {
  shape: text
  near: top-center
  style: {
    font-size: 28
    bold: true
  }
}

ring0_frame: "Ring 0 Interrupt Frame\n(Kernel → Kernel)" {
  style: {
    fill: "#E8E8F0"
    stroke: "#4444AA"
    stroke-width: 2
    border-radius: 4
    font-size: 14
    bold: true
  }

  r0_header: |md
    **No privilege transition**
    **ESP stays on kernel stack**
    sizeof = 68 bytes (17 × 4)
  | {
    style.fill: "#9966CC"
    style.font-color: white
    style.border-radius: 4
  }

  r0_gs: "GS (saved)        +0" {
    style.fill: "#AADDFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r0_fs: "FS (saved)        +4" {
    style.fill: "#AADDFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r0_es: "ES (saved)        +8" {
    style.fill: "#AADDFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r0_ds: "DS (saved)       +12" {
    style.fill: "#AADDFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r0_edi: "EDI  (pusha)     +16" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r0_esi: "ESI  (pusha)     +20" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r0_ebp: "EBP  (pusha)     +24" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r0_esp_p: "ESP* (pusha, ignored)+28" {
    style.fill: "#BBBBBB"
    style.stroke: "#888888"
    style.font-size: 12
    style.italic: true
  }
  r0_ebx: "EBX  (pusha)     +32" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r0_edx: "EDX  (pusha)     +36" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r0_ecx: "ECX  (pusha)     +40" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r0_eax: "EAX  (pusha)     +44" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r0_vec: "vector  (stub)   +48" {
    style.fill: "#FFDDAA"
    style.stroke: "#AA6600"
    style.font-size: 13
  }
  r0_err: "error_code (CPU/dummy)+52" {
    style.fill: "#FFDDAA"
    style.stroke: "#AA6600"
    style.font-size: 13
  }
  r0_eip: "EIP  (CPU-pushed)+56" {
    style.fill: "#AAFFAA"
    style.stroke: "#228822"
    style.font-size: 13
    style.bold: true
  }
  r0_cs: "CS   (CPU-pushed)+60" {
    style.fill: "#AAFFAA"
    style.stroke: "#228822"
    style.font-size: 13
    style.bold: true
  }
  r0_eflags: "EFLAGS(CPU-pushed)+64" {
    style.fill: "#AAFFAA"
    style.stroke: "#228822"
    style.font-size: 13
    style.bold: true
  }
  r0_bottom: "← ESP points here\n(frame pointer)" {
    style.fill: "#FF8888"
    style.stroke: "#CC2222"
    style.font-size: 12
    style.bold: true
  }
}

ring3_frame: "Ring 3 Interrupt Frame\n(User → Kernel)" {
  style: {
    fill: "#F0E8E8"
    stroke: "#AA4444"
    stroke-width: 2
    border-radius: 4
    font-size: 14
    bold: true
  }

  r3_header: |md
    **Privilege transition: ring 3 → ring 0**
    **CPU reads TSS.ESP0 for kernel stack**
    sizeof = 76 bytes (19 × 4)
  | {
    style.fill: "#CC4444"
    style.font-color: white
    style.border-radius: 4
  }

  r3_gs: "GS (saved)        +0" {
    style.fill: "#AADDFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r3_fs: "FS (saved)        +4" {
    style.fill: "#AADDFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r3_es: "ES (saved)        +8" {
    style.fill: "#AADDFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r3_ds: "DS (saved)       +12" {
    style.fill: "#AADDFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r3_edi: "EDI  (pusha)     +16" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r3_esi: "ESI  (pusha)     +20" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r3_ebp: "EBP  (pusha)     +24" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r3_esp_p: "ESP* (pusha, ignored)+28" {
    style.fill: "#BBBBBB"
    style.stroke: "#888888"
    style.font-size: 12
    style.italic: true
  }
  r3_ebx: "EBX  (pusha)     +32" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r3_edx: "EDX  (pusha)     +36" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r3_ecx: "ECX  (pusha)     +40" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r3_eax: "EAX  (pusha)     +44" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  r3_vec: "vector  (stub)   +48" {
    style.fill: "#FFDDAA"
    style.stroke: "#AA6600"
    style.font-size: 13
  }
  r3_err: "error_code (CPU/dummy)+52" {
    style.fill: "#FFDDAA"
    style.stroke: "#AA6600"
    style.font-size: 13
  }
  r3_eip: "EIP  (CPU-pushed)+56" {
    style.fill: "#AAFFAA"
    style.stroke: "#228822"
    style.font-size: 13
    style.bold: true
  }
  r3_cs: "CS   (CPU-pushed)+60  [RPL=3]" {
    style.fill: "#AAFFAA"
    style.stroke: "#228822"
    style.font-size: 13
    style.bold: true
  }
  r3_eflags: "EFLAGS(CPU-pushed)+64" {
    style.fill: "#AAFFAA"
    style.stroke: "#228822"
    style.font-size: 13
    style.bold: true
  }
  r3_user_esp: "user_ESP (CPU)  +68" {
    style.fill: "#FF9944"
    style.stroke: "#AA4400"
    style.font-size: 13
    style.bold: true
  }
  r3_user_ss: "user_SS  (CPU)  +72" {
    style.fill: "#FF9944"
    style.stroke: "#AA4400"
    style.font-size: 13
    style.bold: true
  }
  r3_bottom: "← ESP points here\n(frame pointer)\n(on kernel stack via TSS.ESP0)" {
    style.fill: "#FF8888"
    style.stroke: "#CC2222"
    style.font-size: 12
    style.bold: true
  }
}

legend: "Legend" {
  style: {
    fill: "#F8F8F8"
    stroke: "#AAAAAA"
    border-radius: 6
    font-size: 14
    bold: true
  }
  l1: "Segment registers (stub saves)" {
    style.fill: "#AADDFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  l2: "General-purpose registers (pusha)" {
    style.fill: "#88BBFF"
    style.stroke: "#2266AA"
    style.font-size: 13
  }
  l3: "stub-pushed: vector + error_code" {
    style.fill: "#FFDDAA"
    style.stroke: "#AA6600"
    style.font-size: 13
  }
  l4: "CPU-pushed always (EIP, CS, EFLAGS)" {
    style.fill: "#AAFFAA"
    style.stroke: "#228822"
    style.font-size: 13
  }
  l5: "CPU-pushed on ring-3→0 only (user_ESP, user_SS)" {
    style.fill: "#FF9944"
    style.stroke: "#AA4400"
    style.font-size: 13
  }
  l6: "ESP_pusha: stored but ignored by popa" {
    style.fill: "#BBBBBB"
    style.stroke: "#888888"
    style.font-size: 13
    style.italic: true
  }
}

notes: |md
  **How the CPU builds the frame:**

  **Ring 0 → Ring 0 (no privilege transition):**
  1. CPU detects IRQ/exception with IF=1
  2. Saves EFLAGS, CS, EIP onto *current* kernel stack
  3. For exceptions with error code: pushes error_code
  4. Jumps to ISR stub → stub pushes vector (+ dummy 0 if no error code)
  5. `isr_common_stub`: pusha (8 GPRs), push DS/ES/FS/GS
  6. Sets DS/ES/FS/GS = 0x10 (kernel data)
  7. Calls C handler with frame pointer = ESP

  **Ring 3 → Ring 0 (privilege transition via interrupt gate):**
  1. CPU checks IDT gate DPL ≥ CPL; checks CPL > gate.DPL (transition needed)
  2. CPU reads **TSS.ESP0** (ring-0 stack pointer) from kernel_tss
  3. CPU switches SS:ESP to TSS.SS0:TSS.ESP0 (kernel stack)
  4. CPU pushes user_SS, user_ESP, EFLAGS, user_CS, user_EIP
  5. Remainder identical to ring-0 path (steps 3–7 above)

  **iret behavior:**
  - Ring 0: pops EIP, CS, EFLAGS (3 values, 12 bytes)
  - Ring 3: pops EIP, CS, EFLAGS, user_ESP, user_SS (5 values, 20 bytes)
    — CS.DPL > CPL triggers the extra pop and SS/ESP restore

  **FRAME_FROM_RING3(frame):** `(frame->cs & 0x3) == 3`
  — bit 0 and 1 of CS = RPL; if RPL=3 then user_esp/user_ss are valid
| {
  near: bottom-center
  style: {
    fill: "#FAFAFA"
    stroke: "#CCCCCC"
    border-radius: 6
    font-size: 13
  }
}