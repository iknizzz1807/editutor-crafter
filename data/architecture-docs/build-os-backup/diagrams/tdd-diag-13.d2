vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # ISR/IRQ Stub Assembly: Call Sequence from Hardware to C Handler
| {near: top-center}

# ─── PARTICIPANTS ───────────────────────────────────────────────────────────────

hw: "Hardware / CPU\n(Ring 0 or Ring 3)" {
  shape: rectangle
  style.fill: "#2D2D2D"
  style.font-color: white
  style.border-radius: 4
}

idt: "IDT\n(256 × 8-byte gates)" {
  shape: rectangle
  style.fill: "#4B0082"
  style.font-color: white
  style.border-radius: 4
}

stub_noerr: "ISR_NOERR stub\n(e.g. isr0 – divide error)" {
  shape: rectangle
  style.fill: "#1A3A5C"
  style.font-color: white
  style.font-size: 13
  style.border-radius: 4
}

stub_err: "ISR_ERR stub\n(e.g. isr14 – page fault)" {
  shape: rectangle
  style.fill: "#1A3A5C"
  style.font-color: white
  style.font-size: 13
  style.border-radius: 4
}

irq_stub: "IRQ stub\n(e.g. irq1 – keyboard)" {
  shape: rectangle
  style.fill: "#004D40"
  style.font-color: white
  style.font-size: 13
  style.border-radius: 4
}

common_stub: "isr_common_stub\n(unified save + dispatch)" {
  shape: rectangle
  style.fill: "#1A3A5C"
  style.font-color: "#90CAF9"
  style.stroke: "#90CAF9"
  style.stroke-width: 2
  style.border-radius: 4
}

irq_common: "irq_common_stub\n(unified save + dispatch)" {
  shape: rectangle
  style.fill: "#004D40"
  style.font-color: "#A5D6A7"
  style.stroke: "#A5D6A7"
  style.stroke-width: 2
  style.border-radius: 4
}

exc_handler: "exception_handler()\n[interrupt.c]" {
  shape: rectangle
  style.fill: "#6A0DAD"
  style.font-color: white
  style.border-radius: 4
}

irq_disp: "irq_dispatcher()\n[interrupt.c]" {
  shape: rectangle
  style.fill: "#006400"
  style.font-color: white
  style.border-radius: 4
}

irq_user: "irq_handler_t\nuser callback (e.g. timer_handler)" {
  shape: rectangle
  style.fill: "#1B5E20"
  style.font-color: "#C8E6C9"
  style.font-size: 13
  style.border-radius: 4
}

pic_eoi: "pic_send_eoi(irq)" {
  shape: rectangle
  style.fill: "#004D40"
  style.font-color: "#B2DFDB"
  style.font-size: 13
  style.border-radius: 4
}

iret_box: "iret\n(restore EIP, CS, EFLAGS\n[+ ESP, SS if ring-3])" {
  shape: rectangle
  style.fill: "#37474F"
  style.font-color: "#ECEFF1"
  style.stroke: "#90A4AE"
  style.border-radius: 4
}

# ─── STACK-STATE ANNOTATIONS ────────────────────────────────────────────────────

stack_noerr: |'md
  **After NOERR stub pushes:**
  
  [esp+ 0]  vector       (e.g. 0)
  [esp+ 4]  dummy 0      (error_code placeholder)
  [esp+ 8]  EIP          ← CPU-pushed
  [esp+12]  CS
  [esp+16]  EFLAGS
  [esp+20]  user_ESP*
  [esp+24]  user_SS*     * only if ring-3 → ring-0
  
'| {
  style.fill: "#1A1A2E"
  style.font-color: "#B0C4DE"
  style.stroke: "#4169E1"
  style.border-radius: 4
}

stack_err: |'md
  **After ERR stub pushes:**
  
  [esp+ 0]  vector       (e.g. 14)
  [esp+ 4]  error_code   ← CPU-pushed (present!)
  [esp+ 8]  EIP          ← CPU-pushed
  [esp+12]  CS
  [esp+16]  EFLAGS
  
'| {
  style.fill: "#1A1A2E"
  style.font-color: "#B0C4DE"
  style.stroke: "#4169E1"
  style.border-radius: 4
}

stack_after_pusha: |'md
  **Stack after pusha + seg saves in common_stub:**
  
  [esp+ 0]  gs        ← frame pointer (interrupt_frame_t*)
  [esp+ 4]  fs
  [esp+ 8]  es
  [esp+12]  ds
  [esp+16]  edi       ← pusha group
  [esp+20]  esi
  [esp+24]  ebp
  [esp+28]  esp_pusha (ignored by popa)
  [esp+32]  ebx
  [esp+36]  edx
  [esp+40]  ecx
  [esp+44]  eax
  [esp+48]  vector
  [esp+52]  error_code
  [esp+56]  eip
  [esp+60]  cs
  [esp+64]  eflags
  [esp+68]  user_esp*
  [esp+72]  user_ss*
  
  `*` only for ring-3 source
'| {
  style.fill: "#1A1A2E"
  style.font-color: "#B0C4DE"
  style.stroke: "#9C27B0"
  style.border-radius: 4
}

gate_types: |'md
  **IDT Gate type_attr encoding:**

  | Constant | Hex | Use |
  |---|---|---|
  | IDT_INTERRUPT_GATE | 0x8E | IRQ handlers (clears IF) |
  | IDT_TRAP_GATE | 0x8F | CPU exceptions (preserves IF) |
  | IDT_SYSCALL_GATE | 0xEF | INT 0x80 (DPL=3, trap) |

  **Error-code exceptions (ISR_ERR):**
  8, 10, 11, 12, 13, 14, 17

  **No error-code (ISR_NOERR):**
  0–7, 9, 15–16, 18–31
'| {
  style.fill: "#1A1A2E"
  style.font-color: "#CFD8DC"
  style.stroke: "#546E7A"
  style.border-radius: 4
}

# ─── CONNECTIONS ─────────────────────────────────────────────────────────────────

# Hardware detects interrupt → looks up IDT
hw -> idt: "1  INTR asserted\n(or exception / int N)\nlooks up vector" {
  style.stroke: "#FF6B6B"
  style.stroke-width: 2
}

# IDT dispatches to the correct stub
idt -> stub_noerr: "2a  vector 0–31 (no error code)\njumps to isr_NOERR stub" {
  style.stroke: "#90CAF9"
  style.stroke-dash: 3
}
idt -> stub_err: "2b  vector 0–31 (error code)\njumps to isr_ERR stub" {
  style.stroke: "#90CAF9"
  style.stroke-dash: 3
}
idt -> irq_stub: "2c  vector 32–47 (hardware IRQ)\njumps to irq_STUB" {
  style.stroke: "#A5D6A7"
  style.stroke-dash: 3
}

# NOERR stub: push dummy 0, then vector, then jump
stub_noerr -> common_stub: "3  push dword 0\npush dword <vector>\njmp isr_common_stub" {
  style.stroke: "#90CAF9"
  style.stroke-width: 2
}
stub_noerr -> stack_noerr: "stack state" {
  style.stroke: "#4169E1"
  style.stroke-dash: 5
}

# ERR stub: push vector only (CPU already pushed error code)
stub_err -> common_stub: "3  push dword <vector>\n(CPU already pushed error code)\njmp isr_common_stub" {
  style.stroke: "#90CAF9"
  style.stroke-width: 2
}
stub_err -> stack_err: "stack state" {
  style.stroke: "#4169E1"
  style.stroke-dash: 5
}

# IRQ stub: push dummy 0, then (irq+32), then jump
irq_stub -> irq_common: "3  push dword 0\npush dword (irq+32)\njmp irq_common_stub" {
  style.stroke: "#A5D6A7"
  style.stroke-width: 2
}

# common_stub: save state, load kernel segs, call C
common_stub -> stack_after_pusha: "4  pusha\n   push gs/fs/es/ds\n   stack layout" {
  style.stroke: "#9C27B0"
  style.stroke-dash: 5
}

common_stub -> exc_handler: "5  mov ax,0x10 → ds/es/fs/gs\n   push esp  (interrupt_frame_t*)\n   call exception_handler" {
  style.stroke: "#CE93D8"
  style.stroke-width: 2
}

irq_common -> exc_handler: "5  (same save sequence)\n   call irq_dispatcher\n   (goes via irq_common not exc)" {
  style.stroke: "#A5D6A7"
  style.stroke-dash: 5
  style.opacity: 0.3
}

irq_common -> irq_disp: "5  push esp\n   call irq_dispatcher" {
  style.stroke: "#A5D6A7"
  style.stroke-width: 2
}

# exception_handler: prints diagnostic, halts (or for syscall: dispatches)
exc_handler -> iret_box: "6  returns (trap gate only)\n   or halts for faults" {
  style.stroke: "#CE93D8"
  style.stroke-dash: 3
}

# irq_dispatcher: calls user handler, sends EOI
irq_disp -> irq_user: "6  if irq_handlers[irq] != NULL\n   call handler(frame)" {
  style.stroke: "#81C784"
  style.stroke-width: 2
}
irq_disp -> pic_eoi: "7  pic_send_eoi(irq)\n   unconditional" {
  style.stroke: "#4DB6AC"
  style.stroke-width: 2
}
irq_user -> irq_disp: "returns" {
  style.stroke: "#81C784"
  style.stroke-dash: 3
}
pic_eoi -> iret_box: "8  returns to irq_common_stub\n   exit sequence" {
  style.stroke: "#4DB6AC"
}

# Restore and return
iret_box -> hw: "9  pop ds/es/fs/gs\n   popa\n   add esp,8\n   iret → resumes interrupted code" {
  style.stroke: "#FF8A65"
  style.stroke-width: 3
  style.animated: true
}

# Gate type reference
gate_types -> idt: "type_attr determines\nIF behavior on entry" {
  style.stroke: "#546E7A"
  style.stroke-dash: 5
  style.opacity: 0.6
}