vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  ## Double Fault & Exception Chaining: Triple Fault Anatomy
| {near: top-center}

direction: right

classes: {
  normal: {
    style: {
      fill: "#E8F4FD"
      stroke: "#2980B9"
      stroke-width: 2
      border-radius: 4
    }
  }
  warn: {
    style: {
      fill: "#FEF9E7"
      stroke: "#F39C12"
      stroke-width: 2
      border-radius: 4
    }
  }
  error: {
    style: {
      fill: "#FDEDEC"
      stroke: "#E74C3C"
      stroke-width: 3
      border-radius: 4
    }
  }
  fatal: {
    style: {
      fill: "#922B21"
      stroke: "#641E16"
      stroke-width: 4
      font-color: white
      border-radius: 4
    }
  }
  hardware: {
    style: {
      fill: "#EBF5FB"
      stroke: "#1A5276"
      stroke-width: 2
      border-radius: 4
    }
  }
  idt_entry: {
    style: {
      fill: "#E8DAEF"
      stroke: "#7D3C98"
      stroke-width: 2
      border-radius: 4
    }
  }
  stack: {
    style: {
      fill: "#E9F7EF"
      stroke: "#1E8449"
      stroke-width: 2
      border-radius: 4
    }
  }
  invisible: {
    style: {
      opacity: 0
    }
  }
}

timeline: "Execution Timeline" {
  style.fill: "#FAFAFA"
  style.stroke: "#BDC3C7"
  style.stroke-width: 2
  style.border-radius: 6

  s1: "① Normal Execution\n(Ring 0, IF=1)" {
    class: normal
  }

  s2: "② Fault Occurs\n(e.g., divide by zero,\nGPF, page fault)" {
    class: warn
  }

  s3: "③ CPU Invokes\nFault Handler\n(IDT vector 0–31)" {
    class: normal
  }

  s4: "④ FAULT IN HANDLER\n(stack overflow, bad IDT\nentry, null pointer)" {
    class: error
  }

  s5: "⑤ CPU Invokes\nDouble Fault Handler\n(IDT vector 8)" {
    class: error
  }

  s6: "⑥ FAULT IN DF HANDLER\n(stack still invalid,\nor IDT vector 8 bad)" {
    class: error
    style.stroke-width: 4
  }

  s7: "⑦ TRIPLE FAULT\nCPU Unrecoverable\nHard Reset" {
    class: fatal
  }

  s1 -> s2: "fault instruction\nexecuted"
  s2 -> s3: "IDT lookup\n→ handler addr"
  s3 -> s4: "second fault\noccurs mid-handler"
  s4 -> s5: "double fault\ndetected by CPU" {
    style.stroke: "#E74C3C"
    style.stroke-width: 2
  }
  s5 -> s6: "third fault\noccurs" {
    style.stroke: "#922B21"
    style.stroke-width: 3
  }
  s6 -> s7: "no more\nrecovery possible" {
    style.stroke: "#641E16"
    style.stroke-width: 4
    style.stroke-dash: 0
  }
}

pic_hazard: "PIC Remapping Hazard\n(The Classic Triple Fault)" {
  style.fill: "#FDEDEC"
  style.stroke: "#E74C3C"
  style.stroke-width: 2
  style.border-radius: 6

  before: "DEFAULT PIC Mapping (WRONG)" {
    style.fill: "#FDFEFE"
    style.stroke: "#BDC3C7"
    style.border-radius: 4

    irq0: "IRQ0 (Timer)\n→ CPU Vector 8" {
      style.fill: "#FDEDEC"
      style.stroke: "#E74C3C"
      style.font-color: "#922B21"
      style.bold: true
    }
    irq1: "IRQ1 (Keyboard)\n→ CPU Vector 9" {
      style.fill: "#FDEDEC"
      style.stroke: "#E74C3C"
    }
    irq6: "IRQ6 (Floppy)\n→ CPU Vector 14" {
      style.fill: "#FDEDEC"
      style.stroke: "#E74C3C"
    }
    irq7: "IRQ7 (LPT/Spur)\n→ CPU Vector 15" {
      style.fill: "#FDEDEC"
      style.stroke: "#E74C3C"
    }
  }

  cpu_exc: "CPU Exception Vectors (RESERVED)" {
    style.fill: "#FDFEFE"
    style.stroke: "#BDC3C7"
    style.border-radius: 4

    v8: "Vector 8\n= Double Fault Handler" {
      style.fill: "#922B21"
      style.stroke: "#641E16"
      style.font-color: white
      style.bold: true
    }
    v9: "Vector 9\n= Coprocessor\nOverrun" {
      style.fill: "#FDEDEC"
      style.stroke: "#E74C3C"
    }
    v14: "Vector 14\n= Page Fault\nHandler" {
      style.fill: "#FDEDEC"
      style.stroke: "#E74C3C"
    }
    v15: "Vector 15\n= Reserved" {
      style.fill: "#FDEDEC"
      style.stroke: "#E74C3C"
    }
  }

  collision_note: |md
    **COLLISION**: Timer tick (55ms after STI)
    invokes CPU Vector 8 = Double Fault Handler
    → immediately triggers TRIPLE FAULT → REBOOT
  | {
    style.fill: "#922B21"
    style.font-color: white
    style.stroke: "#641E16"
    style.stroke-width: 2
    style.border-radius: 4
  }

  before.irq0 -> cpu_exc.v8: "COLLISION!\n55ms after STI" {
    style.stroke: "#922B21"
    style.stroke-width: 4
    style.font-color: "#922B21"
    style.bold: true
  }
  before.irq1 -> cpu_exc.v9: "collision" {
    style.stroke: "#E74C3C"
    style.stroke-dash: 5
  }
  before.irq6 -> cpu_exc.v14: "collision" {
    style.stroke: "#E74C3C"
    style.stroke-dash: 5
  }
  before.irq7 -> cpu_exc.v15: "collision" {
    style.stroke: "#E74C3C"
    style.stroke-dash: 5
  }
}

fix: "Correct PIC Remapping (pic_remap(0x20, 0x28))" {
  style.fill: "#E9F7EF"
  style.stroke: "#1E8449"
  style.stroke-width: 2
  style.border-radius: 6

  after_irq: "IRQ0–7 (Master PIC)" {
    style.fill: "#FDFEFE"
    style.stroke: "#BDC3C7"
    style.border-radius: 4

    a_irq0: "IRQ0 → Vector 32 ✓" {
      style.fill: "#E9F7EF"
      style.stroke: "#1E8449"
    }
    a_irq1: "IRQ1 → Vector 33 ✓" {
      style.fill: "#E9F7EF"
      style.stroke: "#1E8449"
    }
    a_irq7: "IRQ7 → Vector 39 ✓" {
      style.fill: "#E9F7EF"
      style.stroke: "#1E8449"
    }
  }

  safe_zone: "Vectors 32–47 (Safe Zone)" {
    style.fill: "#FDFEFE"
    style.stroke: "#BDC3C7"
    style.border-radius: 4

    sv32: "Vector 32 = IRQ0 Handler" {
      style.fill: "#E9F7EF"
      style.stroke: "#1E8449"
    }
    sv33: "Vector 33 = IRQ1 Handler" {
      style.fill: "#E9F7EF"
      style.stroke: "#1E8449"
    }
    sv39: "Vector 39 = IRQ7 Handler" {
      style.fill: "#E9F7EF"
      style.stroke: "#1E8449"
    }
  }

  after_irq.a_irq0 -> safe_zone.sv32: "no collision" {
    style.stroke: "#1E8449"
    style.stroke-width: 2
  }
  after_irq.a_irq1 -> safe_zone.sv33: "no collision" {
    style.stroke: "#1E8449"
    style.stroke-width: 2
  }
  after_irq.a_irq7 -> safe_zone.sv39: "no collision" {
    style.stroke: "#1E8449"
    style.stroke-width: 2
  }
}

idt_state: "IDT Gate States That Cause Double Fault" {
  style.fill: "#F4ECF7"
  style.stroke: "#7D3C98"
  style.stroke-width: 2
  style.border-radius: 6

  cause1: "Gate Not Present (P=0)\nIDT entry never set up" {
    class: error
  }
  cause2: "Wrong Selector (CS=0x00)\nNull descriptor loads → GPF\nGPF handler also fails" {
    class: error
  }
  cause3: "Stack Invalid (ESP invalid)\nCannot push interrupt frame\n→ Stack Fault → Double Fault" {
    class: error
  }
  cause4: "Stack Overflow\nKernel stack exhausted\nbefore handler completes" {
    class: error
  }
  cause5: "Handler Address Wrong\nEIP jumps to unmapped page\n→ Page Fault in handler" {
    class: error
  }
}

stack_state: "Stack Frames During Exception Chain" {
  style.fill: "#EBF5FB"
  style.stroke: "#1A5276"
  style.stroke-width: 2
  style.border-radius: 6

  direction: down

  frame1: "Kernel Stack (Pre-Fault)" {
    style.fill: "#E8F4FD"
    style.stroke: "#2980B9"
    style.border-radius: 4
    f1_top: "ESP → [kernel code locals]" {
      style.fill: "#D6EAF8"
      style.stroke: "#2980B9"
    }
  }

  frame2: "After First Fault\n(CPU pushes interrupt frame)" {
    style.fill: "#FEF9E7"
    style.stroke: "#F39C12"
    style.border-radius: 4
    f2_eflags: "ESP-4: EFLAGS" {
      style.fill: "#FDEBD0"
      style.stroke: "#E59866"
    }
    f2_cs: "ESP-8: CS" {
      style.fill: "#FDEBD0"
      style.stroke: "#E59866"
    }
    f2_eip: "ESP-12: EIP (return addr)" {
      style.fill: "#FDEBD0"
      style.stroke: "#E59866"
    }
    f2_err: "ESP-16: Error Code (if any)" {
      style.fill: "#FDEBD0"
      style.stroke: "#E59866"
    }
  }

  frame3: "Double Fault Frame\n(CPU pushes AGAIN, may fail\nif stack is corrupt)" {
    style.fill: "#FDEDEC"
    style.stroke: "#E74C3C"
    style.border-radius: 4
    f3_eflags: "ESP-?: EFLAGS" {
      style.fill: "#F5B7B1"
      style.stroke: "#E74C3C"
    }
    f3_cs: "ESP-?: CS" {
      style.fill: "#F5B7B1"
      style.stroke: "#E74C3C"
    }
    f3_eip: "ESP-?: EIP" {
      style.fill: "#F5B7B1"
      style.stroke: "#E74C3C"
    }
    f3_err: "ESP-?: Error Code = 0\n(always 0 for DF)" {
      style.fill: "#F5B7B1"
      style.stroke: "#E74C3C"
    }
  }

  frame4: "TRIPLE FAULT\nStack push FAILS again\n→ CPU Hard Reset" {
    class: fatal
  }

  frame1 -> frame2: "first exception\nCPU pushes frame"
  frame2 -> frame3: "second exception\nduring handler" {
    style.stroke: "#E74C3C"
    style.stroke-width: 2
  }
  frame3 -> frame4: "third exception\nno recovery" {
    style.stroke: "#922B21"
    style.stroke-width: 3
  }
}

qemu_diag: "QEMU Diagnostic: -d int" {
  style.fill: "#F8F9FA"
  style.stroke: "#6C757D"
  style.stroke-width: 2
  style.border-radius: 6

  log1: |md
    **Normal operation (correct):**
    
    v=20 e=0000 i=1  ← IRQ0 timer at vector 32
    v=21 e=0000 i=1  ← IRQ1 keyboard at vector 33
    
  |

  log2: |md
    **PIC not remapped (WRONG — triple fault):**
    
    v=08 e=0000      ← Double Fault at vector 8!
    v=08 e=0000      ← Double Fault again!
    [QEMU reboot]    ← Triple fault → reset
    
  | {
    style.fill: "#FDEDEC"
    style.stroke: "#E74C3C"
    style.border-radius: 4
  }

  log3: |md
    **IDT not loaded (WRONG):**
    
    v=0d e=0000      ← GPF from bad IDT entry
    v=08 e=0000      ← Double Fault
    [QEMU reboot]    ← Triple fault
    
  | {
    style.fill: "#FDEDEC"
    style.stroke: "#E74C3C"
    style.border-radius: 4
  }
}

prevention: "Prevention Checklist" {
  style.fill: "#E9F7EF"
  style.stroke: "#1E8449"
  style.stroke-width: 2
  style.border-radius: 6

  p1: "1. idt_setup_all() BEFORE sti" {
    style.fill: "#D5F5E3"
    style.stroke: "#27AE60"
    style.border-radius: 4
  }
  p2: "2. pic_remap(0x20, 0x28) BEFORE sti\n   → IRQ0 → vector 32, not 8" {
    style.fill: "#D5F5E3"
    style.stroke: "#27AE60"
    style.border-radius: 4
  }
  p3: "3. Double fault handler robust:\n   no kprintf, no complex calls,\n   cli+hlt immediately" {
    style.fill: "#D5F5E3"
    style.stroke: "#27AE60"
    style.border-radius: 4
  }
  p4: "4. All 256 IDT entries populated\n   (default_isr for unhandled)" {
    style.fill: "#D5F5E3"
    style.stroke: "#27AE60"
    style.border-radius: 4
  }
  p5: "5. Kernel stack valid before\n   first interrupt (mod-1 sets ESP)" {
    style.fill: "#D5F5E3"
    style.stroke: "#27AE60"
    style.border-radius: 4
  }
}

timeline -> pic_hazard: "most common cause\nin new kernels" {
  style.stroke-dash: 5
  style.stroke: "#E74C3C"
}
pic_hazard -> fix: "solution" {
  style.stroke: "#1E8449"
  style.stroke-width: 2
}
timeline -> idt_state: "other causes" {
  style.stroke-dash: 5
  style.stroke: "#7D3C98"
}
timeline -> stack_state: "stack view" {
  style.stroke-dash: 3
  style.stroke: "#1A5276"
}
timeline -> qemu_diag: "debug with" {
  style.stroke-dash: 3
  style.stroke: "#6C757D"
}
prevention -> timeline: "prevents" {
  style.stroke: "#1E8449"
  style.stroke-width: 2
}