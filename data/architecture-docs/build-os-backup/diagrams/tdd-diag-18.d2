vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  ## E820 Memory Map: Physical Address Space Classification
  *x86 Physical Address Space â€” 4GB Total*
| {near: top-center}

legend: |md
  **Color Legend**
  ðŸŸ£ Header/System  ðŸ”µ Usable RAM  ðŸ”´ Reserved  â¬œ MMIO/ROM
| {near: bottom-center}

style.fill: "#1a1a2e"
style.stroke: "#4a4a8a"

# Physical address space layout
space: Physical Address Space {
  style.fill: "#0d1117"
  style.stroke: "#30363d"

  # 0x00000000 - 0x000003FF (1KB)
  ivt: "0x00000000â€“0x000003FF [1 KB]" {
    label: |md
      **Real-Mode IVT**
      Interrupt Vector Table
      256 Ã— 4-byte vectors
    |
    style.fill: "#6a0dad"
    style.font-color: "#ffffff"
    style.border-radius: 4
    width: 480
    height: 80
  }

  # 0x00000400 - 0x000004FF (256 B)
  bda: "0x00000400â€“0x000004FF [256 B]" {
    label: |md
      **BIOS Data Area (BDA)**
      Hardware state, disk params
    |
    style.fill: "#6a0dad"
    style.font-color: "#ffffff"
    style.border-radius: 4
    width: 480
    height: 65
  }

  # 0x00000500 - 0x00007BFF
  low_ram1: "0x00000500â€“0x00007BFF [~30 KB]" {
    label: |md
      **Usable Low RAM**
      E820 Type 1 (Usable)
    |
    style.fill: "#1f6feb"
    style.font-color: "#ffffff"
    style.border-radius: 4
    width: 480
    height: 65
  }

  # 0x00007C00 - 0x00007DFF (512 B)
  mbr: "0x00007C00â€“0x00007DFF [512 B]" {
    label: |md
      **MBR Load Address**
      Bootloader Stage 1
    |
    style.fill: "#388bfd"
    style.font-color: "#ffffff"
    style.border-radius: 4
    width: 480
    height: 65
  }

  # 0x00007E00 - 0x0007FFFF
  low_ram2: "0x00007E00â€“0x0007FFFF [~480 KB]" {
    label: |md
      **Usable Low RAM**
      E820 Type 1 â€” Stage2, stack
    |
    style.fill: "#1f6feb"
    style.font-color: "#ffffff"
    style.border-radius: 4
    width: 480
    height: 65
  }

  # 0x00080000 - 0x0009FFFF (EBDA region)
  ebda: "0x00080000â€“0x0009FFFF [128 KB]" {
    label: |md
      **EBDA + Upper DOS Memory**
      Extended BIOS Data Area
      E820 Type 1 or 2 â€” avoid
    |
    style.fill: "#d29922"
    style.font-color: "#000000"
    style.border-radius: 4
    width: 480
    height: 75
  }

  # Cache-line boundary marker at 0xA0000
  cl_64k: "â”â”â” VGA Hole Boundary 0x000A0000 â”â”â”" {
    style.fill: "#21262d"
    style.font-color: "#8b949e"
    style.stroke: "#30363d"
    style.stroke-dash: 5
    style.border-radius: 0
    width: 480
    height: 28
  }

  # 0x000A0000 - 0x000B7FFF (CGA/EGA framebuffer)
  vga_plane: "0x000A0000â€“0x000B7FFF [96 KB]" {
    label: |md
      **VGA/EGA Framebuffer Planes**
      Graphics mode memory
      MMIO â€” Reserved (Type 2)
    |
    style.fill: "#6e1a1a"
    style.font-color: "#ffa657"
    style.border-radius: 4
    width: 480
    height: 75
  }

  # 0x000B8000 - 0x000BFFFF (VGA text mode)
  vga_text: "0x000B8000â€“0x000BFFFF [32 KB]" {
    label: |md
      **VGA Text Mode Buffer**
      80Ã—25 cells, 2B/cell
      Write â†’ immediate display
      MMIO Write-Combining
    |
    style.fill: "#da3633"
    style.font-color: "#ffffff"
    style.border-radius: 4
    width: 480
    height: 85
  }

  # 0x000C0000 - 0x000EFFFF (Option ROMs)
  optrom: "0x000C0000â€“0x000EFFFF [192 KB]" {
    label: |md
      **Option ROM Space**
      Video BIOS, NIC ROM
      E820 Type 2 â€” Reserved
    |
    style.fill: "#6e1a1a"
    style.font-color: "#ffa657"
    style.border-radius: 4
    width: 480
    height: 75
  }

  # 0x000F0000 - 0x000FFFFF (System BIOS)
  sysbios: "0x000F0000â€“0x000FFFFF [64 KB]" {
    label: |md
      **System BIOS ROM**
      INT handlers, POST code
      E820 Type 2 â€” Reserved
    |
    style.fill: "#6e1a1a"
    style.font-color: "#ffa657"
    style.border-radius: 4
    width: 480
    height: 75
  }

  # 1MB boundary
  cl_1mb: "â”â”â” 1 MB Boundary 0x00100000 â”â”â” [A20 Gate]" {
    style.fill: "#161b22"
    style.font-color: "#f0883e"
    style.stroke: "#f0883e"
    style.stroke-dash: 3
    style.stroke-width: 2
    style.border-radius: 0
    width: 480
    height: 30
  }

  # 0x00100000 - kernel
  kernel_region: "0x00100000â€“0x003FFFFF [3 MB]" {
    label: |md
      **Kernel Load Region**
      Stage2 loads kernel here
      Identity-mapped at boot
      E820 Type 1 â€” Usable
    |
    style.fill: "#1f6feb"
    style.stroke: "#388bfd"
    style.stroke-width: 2
    style.font-color: "#ffffff"
    style.border-radius: 4
    width: 480
    height: 90
  }

  # General usable RAM
  usable_ram: "0x00400000â€“0xFEBFFFFF [~3.97 GB]" {
    label: |md
      **Extended Usable RAM**
      E820 Type 1
      Page frames available to PMM
      Bitmap allocator manages this
    |
    style.fill: "#1f6feb"
    style.font-color: "#ffffff"
    style.border-radius: 4
    width: 480
    height: 90
  }

  # ACPI region (typical)
  acpi: "0xE8000000â€“0xEFFFFFFF [typical]" {
    label: |md
      **ACPI Tables**
      E820 Type 3 (Reclaim) or 4 (NVS)
      Do not overwrite
    |
    style.fill: "#264d3b"
    style.font-color: "#7ee787"
    style.border-radius: 4
    width: 480
    height: 75
  }

  # PCIe config space
  pcie: "0xF0000000â€“0xFEBFFFFF [typical]" {
    label: |md
      **PCIe Config + Device MMIO**
      BARs, APIC, GPU VRAM
      E820 Type 2 â€” Reserved
    |
    style.fill: "#6e1a1a"
    style.font-color: "#ffa657"
    style.border-radius: 4
    width: 480
    height: 75
  }

  # IOAPIC
  ioapic: "0xFEC00000 [4 KB]" {
    label: |md
      **I/O APIC Registers**
      MMIO â€” Reserved
    |
    style.fill: "#6e1a1a"
    style.font-color: "#ffa657"
    style.border-radius: 4
    width: 480
    height: 60
  }

  # Local APIC
  lapic: "0xFEE00000 [4 KB]" {
    label: |md
      **Local APIC Registers**
      Per-CPU interrupt controller
      MMIO Uncacheable
    |
    style.fill: "#6e1a1a"
    style.font-color: "#ffa657"
    style.border-radius: 4
    width: 480
    height: 65
  }

  # 4GB boundary
  cl_4gb: "â”â”â” 4 GB Boundary 0x100000000 â”â”â”" {
    style.fill: "#161b22"
    style.font-color: "#8b949e"
    style.stroke: "#30363d"
    style.stroke-dash: 5
    style.border-radius: 0
    width: 480
    height: 28
  }

  # BIOS ROM mirror
  biosrom: "0xFFFC0000â€“0xFFFFFFFF [256 KB]" {
    label: |md
      **BIOS ROM Mirror**
      Reset vector: 0xFFFFFFF0
      CPU starts executing here
      E820 Type 2 â€” Reserved
    |
    style.fill: "#6a0dad"
    style.font-color: "#ffffff"
    style.border-radius: 4
    width: 480
    height: 85
  }
}

# Right-side annotation panel
annotations: Annotations {
  style.fill: "#0d1117"
  style.stroke: "#30363d"

  e820_types: E820 Type Codes {
    style.fill: "#161b22"
    style.stroke: "#30363d"
    style.border-radius: 6

    t1: |md
      **Type 1 â€” Usable RAM**
      PMM bitmap marks free
      `pmm_mark_free()` called
    | { style.fill: "#1f6feb"; style.font-color: "#ffffff"; style.border-radius: 4 }

    t2: |md
      **Type 2 â€” Reserved**
      Hardware use only
      Never allocate
    | { style.fill: "#6e1a1a"; style.font-color: "#ffa657"; style.border-radius: 4 }

    t3: |md
      **Type 3 â€” ACPI Data**
      Read ACPI, then reclaim
      Treat as reserved for now
    | { style.fill: "#264d3b"; style.font-color: "#7ee787"; style.border-radius: 4 }

    t4: |md
      **Type 4 â€” ACPI NVS**
      Non-volatile storage
      Never reclaim
    | { style.fill: "#264d3b"; style.font-color: "#7ee787"; style.border-radius: 4 }

    t5: |md
      **Type 5 â€” Bad RAM**
      Hardware defect
      Permanently avoid
    | { style.fill: "#da3633"; style.font-color: "#ffffff"; style.border-radius: 4 }
  }

  pmm_init_order: PMM Init Sequence {
    style.fill: "#161b22"
    style.stroke: "#30363d"
    style.border-radius: 6

    s1: "â‘   memset(bitmap, 0xFF)" {
      style.fill: "#21262d"
      style.font-color: "#e6edf3"
      style.border-radius: 4
    }
    s2: "â‘¡  Mark Type-1 regions FREE" {
      style.fill: "#21262d"
      style.font-color: "#e6edf3"
      style.border-radius: 4
    }
    s3: "â‘¢  Re-mark 0x0â€“0xFFFFF USED" {
      style.fill: "#21262d"
      style.font-color: "#e6edf3"
      style.border-radius: 4
    }
    s4: "â‘£  Re-mark kernel range USED" {
      style.fill: "#21262d"
      style.font-color: "#e6edf3"
      style.border-radius: 4
    }
    s5: "â‘¤  Re-mark bitmap itself USED" {
      style.fill: "#21262d"
      style.font-color: "#e6edf3"
      style.border-radius: 4
    }
    s6: "â‘¥  Re-mark page tables USED" {
      style.fill: "#21262d"
      style.font-color: "#e6edf3"
      style.border-radius: 4
    }

    s1 -> s2 -> s3 -> s4 -> s5 -> s6
  }

  mmap_iter: mmap_entry_t Iterator {
    style.fill: "#161b22"
    style.stroke: "#30363d"
    style.border-radius: 6

    iter_code: |go
      entry = (mmap_entry_t*)mbi->mmap_addr
      end   = entry + mbi->mmap_length

      while entry < end:
        process(entry)
        // NOTE: +4 for size field itself
        entry = (uint8_t*)entry
               + entry->size + 4
    |
  }
}

# Connections â€” show what maps where
space.kernel_region -> annotations.pmm_init_order: "PMM init re-marks" {
  style.stroke: "#388bfd"
  style.stroke-dash: 4
}

space.usable_ram -> annotations.e820_types.t1: "Type 1 regions" {
  style.stroke: "#1f6feb"
  style.stroke-dash: 4
}

space.vga_text -> annotations.e820_types.t2: "Type 2 MMIO" {
  style.stroke: "#da3633"
  style.stroke-dash: 4
}

space.acpi -> annotations.e820_types.t3: "Type 3/4" {
  style.stroke: "#7ee787"
  style.stroke-dash: 4
}