vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |'md
  # GDT Descriptor Binary Layout — All 5 Entries at Byte Resolution
  *Each entry: 8 bytes. Selector = index × 8. CPU reads on every segment register load.*
'| {near: top-right-center}

legend: {
  near: top-right-right
  style.fill: "#F8F8F8"
  style.stroke: "#CCCCCC"
  style.border-radius: 6

  l1: "■ Purple = Header/null descriptor" {shape: text; style.font-color: "#7B2D8B"}
  l2: "■ Blue = Base/Limit data fields" {shape: text; style.font-color: "#1565C0"}
  l3: "■ Orange = Access byte (flags+DPL+type)" {shape: text; style.font-color: "#BF5700"}
  l4: "■ Green = Granularity+flags nibble" {shape: text; style.font-color: "#2E7D32"}
  l5: "■ Gray = Reserved/padding" {shape: text; style.font-color: "#555555"}
}

# ─────────────────────────────────────────────────────────────────────────────
# GDTR register at the top
# ─────────────────────────────────────────────────────────────────────────────
gdtr: "GDTR Register (6 bytes, loaded by lgdt)" {
  style.fill: "#EDE7F6"
  style.stroke: "#7B2D8B"
  style.stroke-width: 2
  style.border-radius: 4

  limit_field: "Limit [15:0]\nbytes 0–1\n= 39 (0x0027)\n(size−1 = 5×8−1)" {
    style.fill: "#D1C4E9"
    style.font-size: 12
    width: 200
  }
  base_field: "Base [31:0]\nbytes 2–5\nphysical addr of gdt_start\n(points to entry 0 below)" {
    style.fill: "#B39DDB"
    style.font-size: 12
    width: 280
  }
  limit_field -> base_field: "" {style.stroke-dash: 0; style.stroke-width: 1}
}

annotation_gdtr: |'md
  **lgdt** loads this 6-byte structure into the GDTR hardware register.
  `limit = 5 entries × 8 bytes − 1 = 39`
'| {
  near: top-rightr
  style.fill: transparent
  style.stroke: transparent
  style.font-size: 11
}

# ─────────────────────────────────────────────────────────────────────────────
# Byte-field legend row (column headers)
# ─────────────────────────────────────────────────────────────────────────────
col_headers: "Byte layout per 8-byte descriptor (Intel non-contiguous format)" {
  style.fill: "#ECEFF1"
  style.stroke: "#90A4AE"
  style.border-radius: 4
  style.font-size: 11

  b0: "Byte 0\nLimit\n[7:0]" {style.fill: "#BBDEFB"; style.font-size: 10; width: 90}
  b1: "Byte 1\nLimit\n[15:8]" {style.fill: "#BBDEFB"; style.font-size: 10; width: 90}
  b2: "Byte 2\nBase\n[7:0]" {style.fill: "#BBDEFB"; style.font-size: 10; width: 90}
  b3: "Byte 3\nBase\n[15:8]" {style.fill: "#BBDEFB"; style.font-size: 10; width: 90}
  b4: "Byte 4\nBase\n[23:16]" {style.fill: "#BBDEFB"; style.font-size: 10; width: 90}
  b5: "Byte 5\nAccess\nP|DPL|S|Type|A" {style.fill: "#FFE0B2"; style.font-size: 10; width: 130}
  b6: "Byte 6\nFlags+Limit\nG|DB|L|AVL|[19:16]" {style.fill: "#C8E6C9"; style.font-size: 10; width: 130}
  b7: "Byte 7\nBase\n[31:24]" {style.fill: "#BBDEFB"; style.font-size: 10; width: 90}

  b0 -> b1 -> b2 -> b3 -> b4 -> b5 -> b6 -> b7
}

# ─────────────────────────────────────────────────────────────────────────────
# ENTRY 0: Null Descriptor  (selector 0x00)
# ─────────────────────────────────────────────────────────────────────────────
entry0: "GDT[0] — Null Descriptor   Selector: 0x00   Offset: 0x00" {
  style.fill: "#F3E5F5"
  style.stroke: "#7B2D8B"
  style.stroke-width: 3
  style.border-radius: 4

  e0b0: "0x00\nLimit[7:0]" {style.fill: "#CE93D8"; style.font-size: 11; width: 90}
  e0b1: "0x00\nLimit[15:8]" {style.fill: "#CE93D8"; style.font-size: 11; width: 90}
  e0b2: "0x00\nBase[7:0]" {style.fill: "#CE93D8"; style.font-size: 11; width: 90}
  e0b3: "0x00\nBase[15:8]" {style.fill: "#CE93D8"; style.font-size: 11; width: 90}
  e0b4: "0x00\nBase[23:16]" {style.fill: "#CE93D8"; style.font-size: 11; width: 90}
  e0b5: "0x00\nAccess" {style.fill: "#CE93D8"; style.font-size: 11; width: 90}
  e0b6: "0x00\nFlags+Lim" {style.fill: "#CE93D8"; style.font-size: 11; width: 90}
  e0b7: "0x00\nBase[31:24]" {style.fill: "#CE93D8"; style.font-size: 11; width: 90}

  e0b0 -> e0b1 -> e0b2 -> e0b3 -> e0b4 -> e0b5 -> e0b6 -> e0b7
}

note0: |'md
  **Required by CPU spec.** All bytes = 0x00.
  Loading any segment register with selector `0x00` → **#GP** (General Protection Fault).
  Purpose: catches uninitialized segment register bugs at the hardware level.
'| {
  style.fill: "#FCE4EC"
  style.stroke: "#E91E63"
  style.font-size: 11
  style.border-radius: 4
}

# ─────────────────────────────────────────────────────────────────────────────
# ENTRY 1: Kernel Code  (selector 0x08)
# ─────────────────────────────────────────────────────────────────────────────
entry1: "GDT[1] — Kernel Code Segment   Selector: 0x08   Offset: 0x08" {
  style.fill: "#E3F2FD"
  style.stroke: "#1565C0"
  style.stroke-width: 2
  style.border-radius: 4

  e1b0: "0xFF\nLimit[7:0]" {style.fill: "#90CAF9"; style.font-size: 11; width: 90}
  e1b1: "0xFF\nLimit[15:8]" {style.fill: "#90CAF9"; style.font-size: 11; width: 90}
  e1b2: "0x00\nBase[7:0]" {style.fill: "#90CAF9"; style.font-size: 11; width: 90}
  e1b3: "0x00\nBase[15:8]" {style.fill: "#90CAF9"; style.font-size: 11; width: 90}
  e1b4: "0x00\nBase[23:16]" {style.fill: "#90CAF9"; style.font-size: 11; width: 90}
  e1b5: "0x9A\nAccess\nP=1 DPL=00\nS=1 E=1 R=1 A=0" {style.fill: "#FFB74D"; style.font-size: 10; width: 140}
  e1b6: "0xCF\nFlags+Lim\nG=1 DB=1 L=0\nAVL=0 Lim[19:16]=F" {style.fill: "#A5D6A7"; style.font-size: 10; width: 150}
  e1b7: "0x00\nBase[31:24]" {style.fill: "#90CAF9"; style.font-size: 11; width: 90}

  e1b0 -> e1b1 -> e1b2 -> e1b3 -> e1b4 -> e1b5 -> e1b6 -> e1b7
}

note1: |'md
  **Ring 0 code.** Base=0, Limit=0xFFFFF × 4KB = 4GB (flat model).
  Access 0x9A = `1 00 1 1 0 1 0`: P=1, DPL=00, S=1, Exec=1, Read=1, Accessed=0.
  Flags 0xC (high nibble of byte 6): G=1(4KB), DB=1(32-bit), L=0, AVL=0.
  **CS loaded by far jump after CR0.PE=1.** Selector `0x08` = index 1 × 8, RPL=0.
'| {
  style.fill: "#E3F2FD"
  style.stroke: "#1565C0"
  style.font-size: 11
  style.border-radius: 4
}

# ─────────────────────────────────────────────────────────────────────────────
# ENTRY 2: Kernel Data  (selector 0x10)
# ─────────────────────────────────────────────────────────────────────────────
entry2: "GDT[2] — Kernel Data Segment   Selector: 0x10   Offset: 0x10" {
  style.fill: "#E8F5E9"
  style.stroke: "#2E7D32"
  style.stroke-width: 2
  style.border-radius: 4

  e2b0: "0xFF\nLimit[7:0]" {style.fill: "#A5D6A7"; style.font-size: 11; width: 90}
  e2b1: "0xFF\nLimit[15:8]" {style.fill: "#A5D6A7"; style.font-size: 11; width: 90}
  e2b2: "0x00\nBase[7:0]" {style.fill: "#A5D6A7"; style.font-size: 11; width: 90}
  e2b3: "0x00\nBase[15:8]" {style.fill: "#A5D6A7"; style.font-size: 11; width: 90}
  e2b4: "0x00\nBase[23:16]" {style.fill: "#A5D6A7"; style.font-size: 11; width: 90}
  e2b5: "0x92\nAccess\nP=1 DPL=00\nS=1 E=0 W=1 A=0" {style.fill: "#FFB74D"; style.font-size: 10; width: 140}
  e2b6: "0xCF\nFlags+Lim\nG=1 DB=1 L=0\nAVL=0 Lim[19:16]=F" {style.fill: "#A5D6A7"; style.font-size: 10; width: 150}
  e2b7: "0x00\nBase[31:24]" {style.fill: "#A5D6A7"; style.font-size: 11; width: 90}

  e2b0 -> e2b1 -> e2b2 -> e2b3 -> e2b4 -> e2b5 -> e2b6 -> e2b7
}

note2: |'md
  **Ring 0 data.** Base=0, Limit=4GB (flat model). Access 0x92 = `1 00 1 0 0 1 0`:
  P=1, DPL=00, S=1, Exec=0 (data), Dir=0, Write=1, Accessed=0.
  **DS=ES=FS=GS=SS all loaded with 0x10** after protected mode entry.
  Selector `0x10` = index 2 × 8, RPL=0.
'| {
  style.fill: "#E8F5E9"
  style.stroke: "#2E7D32"
  style.font-size: 11
  style.border-radius: 4
}

# ─────────────────────────────────────────────────────────────────────────────
# ENTRY 3: User Code  (selector 0x18 / 0x1B with RPL=3)
# ─────────────────────────────────────────────────────────────────────────────
entry3: "GDT[3] — User Code Segment   Selector: 0x1B (index 3, RPL=3)   Offset: 0x18" {
  style.fill: "#FFF3E0"
  style.stroke: "#E65100"
  style.stroke-width: 2
  style.border-radius: 4

  e3b0: "0xFF\nLimit[7:0]" {style.fill: "#FFCC80"; style.font-size: 11; width: 90}
  e3b1: "0xFF\nLimit[15:8]" {style.fill: "#FFCC80"; style.font-size: 11; width: 90}
  e3b2: "0x00\nBase[7:0]" {style.fill: "#FFCC80"; style.font-size: 11; width: 90}
  e3b3: "0x00\nBase[15:8]" {style.fill: "#FFCC80"; style.font-size: 11; width: 90}
  e3b4: "0x00\nBase[23:16]" {style.fill: "#FFCC80"; style.font-size: 11; width: 90}
  e3b5: "0xFA\nAccess\nP=1 DPL=11\nS=1 E=1 R=1 A=0" {style.fill: "#FF8A65"; style.font-size: 10; width: 140}
  e3b6: "0xCF\nFlags+Lim\nG=1 DB=1 L=0\nAVL=0 Lim[19:16]=F" {style.fill: "#A5D6A7"; style.font-size: 10; width: 150}
  e3b7: "0x00\nBase[31:24]" {style.fill: "#FFCC80"; style.font-size: 11; width: 90}

  e3b0 -> e3b1 -> e3b2 -> e3b3 -> e3b4 -> e3b5 -> e3b6 -> e3b7
}

note3: |'md
  **Ring 3 code.** DPL=3 allows ring-3 execution. Access 0xFA = `1 11 1 1 0 1 0`:
  P=1, DPL=11 (ring 3), S=1, Exec=1, Read=1, Accessed=0.
  Selector `0x1B` = (index 3 × 8) | RPL 3 = 0x18 | 3 = **0x1B**.
  RPL bits [1:0] must equal DPL=3 or CPU raises #GP on segment load from ring 3.
'| {
  style.fill: "#FFF3E0"
  style.stroke: "#E65100"
  style.font-size: 11
  style.border-radius: 4
}

# ─────────────────────────────────────────────────────────────────────────────
# ENTRY 4: User Data  (selector 0x20 / 0x23 with RPL=3)
# ─────────────────────────────────────────────────────────────────────────────
entry4: "GDT[4] — User Data Segment   Selector: 0x23 (index 4, RPL=3)   Offset: 0x20" {
  style.fill: "#FCE4EC"
  style.stroke: "#AD1457"
  style.stroke-width: 2
  style.border-radius: 4

  e4b0: "0xFF\nLimit[7:0]" {style.fill: "#F48FB1"; style.font-size: 11; width: 90}
  e4b1: "0xFF\nLimit[15:8]" {style.fill: "#F48FB1"; style.font-size: 11; width: 90}
  e4b2: "0x00\nBase[7:0]" {style.fill: "#F48FB1"; style.font-size: 11; width: 90}
  e4b3: "0x00\nBase[15:8]" {style.fill: "#F48FB1"; style.font-size: 11; width: 90}
  e4b4: "0x00\nBase[23:16]" {style.fill: "#F48FB1"; style.font-size: 11; width: 90}
  e4b5: "0xF2\nAccess\nP=1 DPL=11\nS=1 E=0 W=1 A=0" {style.fill: "#FF8A65"; style.font-size: 10; width: 140}
  e4b6: "0xCF\nFlags+Lim\nG=1 DB=1 L=0\nAVL=0 Lim[19:16]=F" {style.fill: "#A5D6A7"; style.font-size: 10; width: 150}
  e4b7: "0x00\nBase[31:24]" {style.fill: "#F48FB1"; style.font-size: 11; width: 90}

  e4b0 -> e4b1 -> e4b2 -> e4b3 -> e4b4 -> e4b5 -> e4b6 -> e4b7
}

note4: |'md
  **Ring 3 data.** Access 0xF2 = `1 11 1 0 0 1 0`:
  P=1, DPL=11 (ring 3), S=1, Exec=0 (data), Dir=0, Write=1, Accessed=0.
  Selector `0x23` = (index 4 × 8) | RPL 3 = 0x20 | 3 = **0x23**.
  User DS/SS/ES loaded with 0x23. User stack segment uses this descriptor.
'| {
  style.fill: "#FCE4EC"
  style.stroke: "#AD1457"
  style.font-size: 11
  style.border-radius: 4
}

# ─────────────────────────────────────────────────────────────────────────────
# Access byte bit-decomposition detail box
# ─────────────────────────────────────────────────────────────────────────────
access_detail: "Access Byte (Byte 5) Bit Decomposition" {
  style.fill: "#FFF8E1"
  style.stroke: "#F57F17"
  style.stroke-width: 2
  style.border-radius: 4

  bits: |'md
    
    Bit 7   P   = Present         (1 = valid descriptor)
    Bit 6   DPL₁ \
    Bit 5   DPL₀ /  Privilege level: 00=ring0, 11=ring3
    Bit 4   S   = Descriptor type  (1=code/data, 0=system)
    Bit 3   E   = Executable        (1=code, 0=data)
    Bit 2   DC  = Direction/Conforming
    Bit 1   RW  = Readable(code) / Writable(data)
    Bit 0   A   = Accessed          (CPU sets; init to 0)

    Kernel code 0x9A = 1_00_1_1_0_1_0  (P DPL=0 S=1 E=1 DC=0 R=1 A=0)
    Kernel data 0x92 = 1_00_1_0_0_1_0  (P DPL=0 S=1 E=0 DC=0 W=1 A=0)
    User   code 0xFA = 1_11_1_1_0_1_0  (P DPL=3 S=1 E=1 DC=0 R=1 A=0)
    User   data 0xF2 = 1_11_1_0_0_1_0  (P DPL=3 S=1 E=0 DC=0 W=1 A=0)
'|
  style.font-size: 11
}

# ─────────────────────────────────────────────────────────────────────────────
# Selector arithmetic detail box
# ─────────────────────────────────────────────────────────────────────────────
selector_detail: "Segment Selector Format (16 bits)" {
  style.fill: "#E8EAF6"
  style.stroke: "#3F51B5"
  style.stroke-width: 2
  style.border-radius: 4

  sbits: |'md
    
    Bits [15:3]  Index into GDT (0–8191)
    Bit  [2]     TI: Table Indicator (0=GDT, 1=LDT)
    Bits [1:0]   RPL: Requested Privilege Level

    GDT[0] null:        0x00 = 0000_0000_0000_0000
    GDT[1] kcode:       0x08 = 0000_0000_0000_1000  (index 1, TI=0, RPL=0)
    GDT[2] kdata:       0x10 = 0000_0000_0001_0000  (index 2, TI=0, RPL=0)
    GDT[3] ucode:       0x1B = 0000_0000_0001_1011  (index 3, TI=0, RPL=3)
    GDT[4] udata:       0x23 = 0000_0000_0010_0011  (index 4, TI=0, RPL=3)
'|
  style.font-size: 11
}

# ─────────────────────────────────────────────────────────────────────────────
# Total size annotation
# ─────────────────────────────────────────────────────────────────────────────
size_note: "Total GDT size: 5 entries × 8 bytes = 40 bytes\nGDTR.limit = 39 (0x27)\nGDTR.base  = physical address of GDT[0]" {
  style.fill: "#E0E0E0"
  style.stroke: "#757575"
  style.border-radius: 4
  style.font-size: 12
}

# ─────────────────────────────────────────────────────────────────────────────
# Connections: GDTR → entries, entries flow downward
# ─────────────────────────────────────────────────────────────────────────────
gdtr -> entry0: "base points here" {style.stroke: "#7B2D8B"; style.stroke-width: 2; style.stroke-dash: 3}
entry0 -> entry1: "+8 bytes" {style.stroke: "#546E7A"; style.font-size: 10}
entry1 -> entry2: "+8 bytes" {style.stroke: "#546E7A"; style.font-size: 10}
entry2 -> entry3: "+8 bytes" {style.stroke: "#546E7A"; style.font-size: 10}
entry3 -> entry4: "+8 bytes" {style.stroke: "#546E7A"; style.font-size: 10}

entry0 -> note0: "" {style.stroke-dash: 4; style.stroke: "#9C27B0"}
entry1 -> note1: "" {style.stroke-dash: 4; style.stroke: "#1565C0"}
entry2 -> note2: "" {style.stroke-dash: 4; style.stroke: "#2E7D32"}
entry3 -> note3: "" {style.stroke-dash: 4; style.stroke: "#E65100"}
entry4 -> note4: "" {style.stroke-dash: 4; style.stroke: "#AD1457"}

entry4 -> access_detail: "access byte detail" {style.stroke-dash: 5; style.stroke: "#F57F17"}
entry4 -> selector_detail: "selector arithmetic" {style.stroke-dash: 5; style.stroke: "#3F51B5"}
entry4 -> size_note: "total" {style.stroke-dash: 5; style.stroke: "#757575"}

col_headers -> entry0: "byte positions" {style.stroke-dash: 6; style.stroke: "#90A4AE"; style.font-size: 10}