vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |'md
  ## x86 Two-Level Page Table: Virtual Address Decode and Walk
  **32-bit Protected Mode | 4KB Pages | 1024-Entry Tables**
'| {near: top-right-center}

# ── Virtual Address Input ──────────────────────────────────────────────────

va_title: "Virtual Address (32-bit)" {
  style.fill: "#E8E8E8"
  style.stroke: "#555555"
  style.font-size: 13
  style.bold: true
}

va_bits: |'md
  
  ┌──────────────────────┬──────────────────────┬──────────────────────────┐
  │  DIR INDEX [31:22]   │  TABLE INDEX [21:12] │    BYTE OFFSET [11:0]    │
  │       10 bits        │       10 bits        │         12 bits          │
  │     (0 – 1023)       │     (0 – 1023)       │       (0 – 4095)         │
  └──────────────────────┴──────────────────────┴──────────────────────────┘
  Example: 0xC0101234
    DIR   = 0xC0101234 >> 22         = 768   (0x300)
    TABLE = (0xC0101234 >> 12) & 3FF = 257   (0x101)
    OFFSET= 0xC0101234 & FFF         = 0x234
'| {
  style.fill: "#FAFAFA"
  style.stroke: "#AAAAAA"
  style.font: mono
  style.font-size: 12
}

va_title -> va_bits: "" {style.stroke-width: 0; style.opacity: 0}

# ── CR3 Register ─────────────────────────────────────────────────────────

cr3_box: "CR3  (Page Directory Base Register)" {
  style.fill: "#7B2D8B"
  style.font-color: white
  style.bold: true
  style.border-radius: 6
  style.font-size: 13
}

cr3_detail: |'md
  `bits [31:12]` = Physical base address of Page Directory  
  `bits [11:0]`  = Flags (PCD, PWT); low 12 bits masked to 0 by MMU  
  **Written by:** `mov cr3, eax`  
  **Flushed on write:** all non-GLOBAL TLB entries invalidated
'| {
  style.fill: "#F3E8F8"
  style.stroke: "#7B2D8B"
  style.font-size: 12
}

cr3_box -> cr3_detail

# ── Step 1: Page Directory ────────────────────────────────────────────────

step1_label: "① Read Page Directory Entry (PDE)" {
  style.fill: "#1A6B8A"
  style.font-color: white
  style.bold: true
  style.border-radius: 4
  style.font-size: 12
}

pde_mem: "Page Directory  [4 KB = 1024 × 4-byte PDEs]" {
  style.fill: "#D6EAF8"
  style.stroke: "#1A6B8A"
  style.stroke-width: 2
  style.font-size: 12

  pde_formula: |'md
    **Physical address of PDE:**  
    `PDE_addr = CR3.base + DIR_INDEX × 4`  
    `         = CR3.base + (VA[31:22]) × 4`
'| {style.fill: "#EBF5FB"; style.font-size: 11; style.font: mono}

  pde_row_0: "PDE[0]   → identity_page_table (phys)" {style.fill: "#ABEBC6"; style.font-size: 11}
  pde_row_1: "PDE[1..767]  → 0x00000000 (NOT PRESENT)" {style.fill: "#FDFEFE"; style.font-size: 11; style.font-color: "#888888"}
  pde_row_768: "PDE[768] → kernel_page_table (phys)" {style.fill: "#ABEBC6"; style.font-size: 11}
  pde_row_rest: "PDE[769..1023]  → heap/user (dynamic)" {style.fill: "#FDFEFE"; style.font-size: 11; style.font-color: "#888888"}
}

pde_entry_layout: "PDE Entry  [32-bit]" {
  style.fill: "#1A6B8A"
  style.font-color: white
  style.border-radius: 4
  style.font-size: 12

  pde_bits: |'md
    
    ┌────────────────────────┬──────────────────────────┐
    │ Physical Frame [31:12] │       Flags [11:0]        │
    │     (20 bits)          │  G PS  A PCD PWT U/S R/W P │
    └────────────────────────┴──────────────────────────┘
    
    `P=1` → PDE valid; go to next level  
    `P=0` → **Page Fault (vector 14)**; error code P=0  
    `PS=1` → 4 MB page (PSE); skip level 2 (NOT used here)  
    `U/S=0` → supervisor only; user access → **#PF error P=1**
'| {style.fill: "#EAF2FF"; style.font-size: 11; style.font: mono}
}

step1_label -> pde_mem
step1_label -> pde_entry_layout

# ── Step 2: Page Table ────────────────────────────────────────────────────

step2_label: "② Read Page Table Entry (PTE)" {
  style.fill: "#1A6B8A"
  style.font-color: white
  style.bold: true
  style.border-radius: 4
  style.font-size: 12
}

pte_mem: "Page Table  [4 KB = 1024 × 4-byte PTEs]" {
  style.fill: "#D6EAF8"
  style.stroke: "#1A6B8A"
  style.stroke-width: 2
  style.font-size: 12

  pte_formula: |'md
    **Physical address of PTE:**  
    `PTE_addr = PDE.frame + TABLE_INDEX × 4`  
    `         = PDE[31:12]<<12 + (VA[21:12]) × 4`
'| {style.fill: "#EBF5FB"; style.font-size: 11; style.font: mono}

  pte_row_0: "PTE[0]   phys=0x00000000  P|W" {style.fill: "#D5F5E3"; style.font-size: 11; style.font: mono}
  pte_row_184: "PTE[184] phys=0x000B8000  P|W  (VGA)" {style.fill: "#FAD7A0"; style.font-size: 11; style.font: mono}
  pte_row_256: "PTE[256] phys=0x00100000  P|W  (kernel .text)" {style.fill: "#D5F5E3"; style.font-size: 11; style.font: mono}
  pte_row_257: "PTE[257] phys=0x00101000  P|W" {style.fill: "#D5F5E3"; style.font-size: 11; style.font: mono}
  pte_dots: "…  (1024 entries cover 4 MB)" {style.fill: "#FDFEFE"; style.font-size: 11; style.font-color: "#AAAAAA"}
}

pte_entry_layout: "PTE Entry  [32-bit]" {
  style.fill: "#1A6B8A"
  style.font-color: white
  style.border-radius: 4
  style.font-size: 12

  pte_bits: |'md
    
    ┌────────────────────────┬──────────────────────────┐
    │ Physical Frame [31:12] │       Flags [11:0]        │
    │     (20 bits)          │  G 0  D  A PCD PWT U/S R/W P │
    └────────────────────────┴──────────────────────────┘
    
    `D` = Dirty: CPU sets on **first write**  
    `A` = Accessed: CPU sets on **first read or write**  
    `G` = Global: TLB entry survives `mov cr3` reload  
    `P=0` → **Page Fault**; must be set for any valid mapping
'| {style.fill: "#EAF2FF"; style.font-size: 11; style.font: mono}
}

step2_label -> pte_mem
step2_label -> pte_entry_layout

# ── Step 3: Physical Frame ────────────────────────────────────────────────

step3_label: "③ Compute Final Physical Address" {
  style.fill: "#1A6B8A"
  style.font-color: white
  style.bold: true
  style.border-radius: 4
  style.font-size: 12
}

phys_calc: |'md
  **Physical Address = PTE.frame_base + VA.offset**

  
  PTE.frame_base  = PTE[31:12] << 12
  VA.offset       = VA[11:0]          (0 – 4095)

  Example (VA = 0xC0101234):
    DIR   = 768  → PDE[768] = kernel_page_table phys
    TABLE = 257  → PTE[257] = 0x00101000 | P | W
    OFFSET= 0x234
    ─────────────────────────────────────────
    Physical = 0x00101000 + 0x234 = 0x00101234
'| {
  style.fill: "#EBF5FB"
  style.stroke: "#1A6B8A"
  style.font: mono
  style.font-size: 12
}

step3_label -> phys_calc

# ── TLB ──────────────────────────────────────────────────────────────────

tlb_box: "TLB  (Translation Lookaside Buffer)" {
  style.fill: "#7D6608"
  style.font-color: white
  style.bold: true
  style.border-radius: 6
  style.font-size: 13
}

tlb_detail: |'md
  **L1 dTLB:** 32–64 entries, 4-way set-associative, 4 cycles hit  
  **L2 sTLB:** 512–4096 entries, shared, ~12 cycles hit  
  **TLB Miss:** full 2-level walk → 2× memory reads + data = ~30–200 cycles  

  **Flush instructions:**  
  - `invlpg [addr]` → flush single page (~20 cycles) — use after each `vmm_map_page()`  
  - `mov cr3, val` → flush ALL non-global entries — use after bulk PT changes  

  **Global pages (G=1):** survive `mov cr3` reload → kernel pages should set G=1
'| {
  style.fill: "#FEF9E7"
  style.stroke: "#7D6608"
  style.font-size: 12
}

tlb_box -> tlb_detail

# ── Page Fault ────────────────────────────────────────────────────────────

pf_box: "Page Fault  (Exception #14)" {
  style.fill: "#A93226"
  style.font-color: white
  style.bold: true
  style.border-radius: 6
  style.font-size: 13
}

pf_detail: |'md
  **CR2** = faulting virtual address (save FIRST before any call)  
  **Error code bits:**
  | Bit | Name | 0 meaning | 1 meaning |
  |-----|------|-----------|-----------|
  | 0 | P | Not-present | Protection violation |
  | 1 | W | Read | Write |
  | 2 | U | Supervisor | User mode |
  | 3 | R | — | Reserved PTE bit set |
  | 4 | I | Data | Instruction fetch |

  **Common patterns:**  
  `P=0, W=0, U=0` → kernel null deref  
  `P=0, W=0, U=1` → user null deref  
  `P=1, W=0, U=1` → user reads kernel page (U/S=0)  
  `P=1, W=1, U=0` → kernel write to read-only page  
'| {
  style.fill: "#FDEDEC"
  style.stroke: "#A93226"
  style.font-size: 12
}

pf_box -> pf_detail

# ── TLB Stale Translation Warning ────────────────────────────────────────

stale_warn: |'md
  ⚠️  **Stale TLB Rule:** After ANY PTE or PDE modification, call  
  `invlpg(virt_addr)` immediately. Omitting this causes **silent**  
  wrong-physical-frame reads/writes — no fault, no message, just  
  corrupted data that surfaces far from the modification site.
'| {
  style.fill: "#FEF9E7"
  style.stroke: "#E67E22"
  style.stroke-width: 2
  style.font-size: 12
}

# ── Flag Combination Reference ─────────────────────────────────────────

flags_ref: "Common Flag Combinations" {
  style.fill: "#1E8449"
  style.font-color: white
  style.bold: true
  style.border-radius: 4
  style.font-size: 12

  flags_table: |'md
    | Usage | P | R/W | U/S | PCD | Value |
    |-------|---|-----|-----|-----|-------|
    | Kernel code/data | 1 | 1 | 0 | 0 | `0x003` |
    | User code (RO)   | 1 | 0 | 1 | 0 | `0x005` |
    | User data/stack  | 1 | 1 | 1 | 0 | `0x007` |
    | VGA MMIO         | 1 | 1 | 0 | 1 | `0x013` |
    | Heap backing     | 1 | 1 | 0 | 0 | `0x003` |
    | Not present      | 0 | — | — | — | `0x000` |

    **PDE flags** must include `P` and typically `R/W`.  
    **U/S in PDE** should be OR of all child PTEs' U/S intentions.
'| {style.fill: "#EAFAF1"; style.font-size: 11}
}

# ── Connections (walk flow) ───────────────────────────────────────────────

va_bits -> cr3_box: "① DIR_INDEX selects PDE" {
  style.stroke: "#7B2D8B"
  style.stroke-width: 2
  style.font-size: 11
}

cr3_box -> step1_label: "base + DIR×4" {
  style.stroke: "#1A6B8A"
  style.stroke-width: 2
  style.font-size: 11
}

step1_label -> step2_label: "PDE.frame + TABLE×4" {
  style.stroke: "#1A6B8A"
  style.stroke-width: 2
  style.font-size: 11
}

step2_label -> step3_label: "PTE.frame + OFFSET" {
  style.stroke: "#1A6B8A"
  style.stroke-width: 2
  style.font-size: 11
}

step3_label -> tlb_box: "cached on hit" {
  style.stroke: "#7D6608"
  style.stroke-dash: 4
  style.font-size: 11
}

step1_label -> pf_box: "P=0 → #PF" {
  style.stroke: "#A93226"
  style.stroke-dash: 5
  style.font-size: 11
  style.font-color: "#A93226"
}

step2_label -> pf_box: "P=0 or U violation → #PF" {
  style.stroke: "#A93226"
  style.stroke-dash: 5
  style.font-size: 11
  style.font-color: "#A93226"
}

pf_box -> stale_warn: "" {style.stroke-width: 0; style.opacity: 0}

step3_label -> flags_ref: "" {style.stroke-width: 0; style.opacity: 0}