vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Page Fault Handler: CR2 Decode and Error Code Decision Tree" {
  shape: text
  near: top-center
  style: {
    font-size: 20
    bold: true
  }
}

entry: "Exception Vector 14\nPage Fault Entry" {
  shape: rectangle
  style.fill: "#9B59B6"
  style.font-color: white
  style.bold: true
}

save_cr2: "STEP 1: Save CR2 Immediately\nmov %%cr2, faulting_addr\n(BEFORE any function call)" {
  shape: rectangle
  style.fill: "#E74C3C"
  style.font-color: white
  style.bold: true
}

decode: "STEP 2: Decode Error Code\nP  = bit 0 (0=not-present, 1=protection)\nW  = bit 1 (0=read, 1=write)\nU  = bit 2 (0=kernel, 1=user)\nR  = bit 3 (reserved bit set)\nI  = bit 4 (0=data, 1=instr fetch)" {
  shape: rectangle
  style.fill: "#2980B9"
  style.font-color: white
}

print_diag: "STEP 3: Print Diagnostics\nkprintf CR2, error_code,\nEIP, P/W/U flags, ring level" {
  shape: rectangle
  style.fill: "#27AE60"
  style.font-color: white
}

classify: "STEP 4: Classify Fault Type" {
  shape: diamond
  style.fill: "#F39C12"
  style.font-color: white
  style.bold: true
}

check_null: "!U && !P &&\nCR2 < PAGE_SIZE\n(4096)?" {
  shape: diamond
  style.fill: "#BDC3C7"
}

check_heap: "!U && !P &&\nCR2 in HEAP_RANGE\n[0xD0000000, 0xDFFFFFFF)?" {
  shape: diamond
  style.fill: "#BDC3C7"
}

check_user_kern: "U && CR2 >= 0xC0000000\n(user touching kernel)?" {
  shape: diamond
  style.fill: "#BDC3C7"
}

check_cow: "!U && P && W\n(kernel write to\nread-only page)?" {
  shape: diamond
  style.fill: "#BDC3C7"
}

diag_null: "→ Kernel null pointer\n   dereference!" {
  shape: rectangle
  style.fill: "#E74C3C"
  style.font-color: white
}

diag_heap: "→ Kernel accessed\n   unmapped heap\n   addr 0x%x" {
  shape: rectangle
  style.fill: "#E74C3C"
  style.font-color: white
}

diag_security: "→ SECURITY VIOLATION\n   User process accessing\n   kernel memory!" {
  shape: rectangle
  style.fill: "#C0392B"
  style.font-color: white
  style.bold: true
}

diag_cow: "→ Kernel write to\n   read-only page\n   (COW or bug)" {
  shape: rectangle
  style.fill: "#E74C3C"
  style.font-color: white
}

diag_generic: "→ Generic fault\n   (unmapped addr,\n   user NPD, etc.)" {
  shape: rectangle
  style.fill: "#E74C3C"
  style.font-color: white
}

halt: "STEP 5: System Halted\nfor(;;) { cli; hlt; }\n\nAll page faults are FATAL\nin this module (no demand paging)" {
  shape: rectangle
  style.fill: "#2C3E50"
  style.font-color: white
  style.bold: true
}

note_cr2: "⚠ CR2 TIMING CRITICAL\nAnother page fault (e.g., from\nkprintf) OVERWRITES CR2.\nMust save to local var FIRST." {
  shape: rectangle
  style.fill: "#F8F9FA"
  style.stroke: "#E74C3C"
  style.stroke-width: 2
}

note_errcode: "Error Code Bit Layout (32-bit):\n[31:5] Reserved\n[4] I: Instruction fetch\n[3] R: Reserved PTE bit\n[2] U: User mode\n[1] W: Write access\n[0] P: Present (protection fault)" {
  shape: rectangle
  style.fill: "#EBF5FB"
  style.stroke: "#2980B9"
}

note_cr2 -> save_cr2: "why" {
  style.stroke-dash: 4
  style.font-size: 11
}

note_errcode -> decode: "fields" {
  style.stroke-dash: 4
  style.font-size: 11
}

entry -> save_cr2
save_cr2 -> decode
decode -> print_diag
print_diag -> classify

classify -> check_null: "check conditions"
check_null -> diag_null: "YES" {
  style.stroke: "#E74C3C"
}
check_null -> check_heap: "NO"

check_heap -> diag_heap: "YES" {
  style.stroke: "#E74C3C"
}
check_heap -> check_user_kern: "NO"

check_user_kern -> diag_security: "YES" {
  style.stroke: "#C0392B"
  style.bold: true
}
check_user_kern -> check_cow: "NO"

check_cow -> diag_cow: "YES" {
  style.stroke: "#E74C3C"
}
check_cow -> diag_generic: "NO"

diag_null -> halt
diag_heap -> halt
diag_security -> halt
diag_cow -> halt
diag_generic -> halt