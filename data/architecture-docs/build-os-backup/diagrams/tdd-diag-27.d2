vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Per-Process Kernel Stack Layout: Initial Fake Frame vs Preempted Frame" {
  shape: text
  near: top-center
  style: {
    font-size: 20
    bold: true
  }
}

legend: |md
  **Colors:** Purple=Header/Control · Blue=CPU-pushed · Orange=Pointers · Gray=Dummy/Padding · Green=Restored by popa · Teal=Ring-3 only
| {
  near: bottom-center
  style.font-size: 13
}

# ────────────────────────────────────────────────────────────────
# LEFT: NEW PROCESS — fake initial frame
# ────────────────────────────────────────────────────────────────

new_proc: "NEW PROCESS (process_create_kernel)" {
  style.fill: "#F0F0FF"
  style.stroke: "#6A0DAD"
  style.stroke-width: 2

  stack_label: "kernel_stack[4096]  (grows ↓)" {
    shape: text
    style.bold: true
    style.font-size: 14
  }

  top_marker: "kernel_stack_top  ──────────────" {
    style.fill: "#EEEEEE"
    style.stroke: "#888888"
    style.font-size: 12
    style.italic: true
  }

  f_eflags: "+0x40  eflags = 0x00000202  [IF=1]" {
    style.fill: "#BFD9FF"
    style.stroke: "#1A5276"
  }
  f_cs: "+0x3C  cs     = 0x00000008  [ring-0]" {
    style.fill: "#BFD9FF"
    style.stroke: "#1A5276"
  }
  f_eip: "+0x38  eip    = entry_func  ← resume here" {
    style.fill: "#BFD9FF"
    style.stroke: "#1A5276"
    style.bold: true
  }
  f_errcode: "+0x34  error_code = 0x00000000  (dummy)" {
    style.fill: "#DDDDDD"
    style.stroke: "#888888"
    style.font-size: 12
  }
  f_vector: "+0x30  vector     = 0x00000000  (dummy)" {
    style.fill: "#DDDDDD"
    style.stroke: "#888888"
    style.font-size: 12
  }
  f_eax: "+0x2C  eax = 0" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  f_ecx: "+0x28  ecx = 0" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  f_edx: "+0x24  edx = 0" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  f_ebx: "+0x20  ebx = 0" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  f_esp_pusha: "+0x1C  esp_pusha = 0  ← popa IGNORES" {
    style.fill: "#DDDDDD"
    style.stroke: "#888888"
    style.font-size: 12
    style.italic: true
  }
  f_ebp: "+0x18  ebp = 0" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  f_esi: "+0x14  esi = 0" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  f_edi: "+0x10  edi = 0" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  f_ds: "+0x0C  ds  = 0x00000010" {
    style.fill: "#E8DAEF"
    style.stroke: "#6C3483"
    style.font-size: 12
  }
  f_es: "+0x08  es  = 0x00000010" {
    style.fill: "#E8DAEF"
    style.stroke: "#6C3483"
    style.font-size: 12
  }
  f_fs: "+0x04  fs  = 0x00000010" {
    style.fill: "#E8DAEF"
    style.stroke: "#6C3483"
    style.font-size: 12
  }
  f_gs: "+0x00  gs  = 0x00000010  ← saved_esp" {
    style.fill: "#E8DAEF"
    style.stroke: "#6C3483"
    style.bold: true
  }
  tramp: "      [irq_return_trampoline addr]  ← 'ret' pops this" {
    style.fill: "#FFD580"
    style.stroke: "#B7770D"
    style.bold: true
  }

  bot_marker: "      (lower addresses)" {
    shape: text
    style.italic: true
    style.font-size: 12
    style.font-color: "#888888"
  }
}

# ────────────────────────────────────────────────────────────────
# RIGHT: PREEMPTED PROCESS — real IRQ frame
# ────────────────────────────────────────────────────────────────

preempted: "PREEMPTED PROCESS (timer IRQ fired)" {
  style.fill: "#FFF8EE"
  style.stroke: "#E67E22"
  style.stroke-width: 2

  stack_label2: "kernel_stack[4096]  (grows ↓)" {
    shape: text
    style.bold: true
    style.font-size: 14
  }

  top2: "kernel_stack_top  ──────────────" {
    style.fill: "#EEEEEE"
    style.stroke: "#888888"
    style.font-size: 12
    style.italic: true
  }

  p_eflags: "CPU  eflags  — interrupted EFLAGS" {
    style.fill: "#BFD9FF"
    style.stroke: "#1A5276"
  }
  p_cs: "CPU  cs     = 0x0008 or 0x001B" {
    style.fill: "#BFD9FF"
    style.stroke: "#1A5276"
  }
  p_eip: "CPU  eip    = interrupted EIP  ← resume" {
    style.fill: "#BFD9FF"
    style.stroke: "#1A5276"
    style.bold: true
  }
  p_errcode: "stub error_code = 0x00000000  (dummy)" {
    style.fill: "#DDDDDD"
    style.stroke: "#888888"
    style.font-size: 12
  }
  p_vector: "stub vector     = 0x00000020  (IRQ0=32)" {
    style.fill: "#DDDDDD"
    style.stroke: "#888888"
    style.font-size: 12
  }
  p_eax: "pusha  eax = live value" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  p_ecx: "pusha  ecx = live value" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  p_edx: "pusha  edx = live value" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  p_ebx: "pusha  ebx = live value" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  p_esp_pusha: "pusha  esp_pusha  ← popa IGNORES" {
    style.fill: "#DDDDDD"
    style.stroke: "#888888"
    style.font-size: 12
    style.italic: true
  }
  p_ebp: "pusha  ebp = live value" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  p_esi: "pusha  esi = live value" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  p_edi: "pusha  edi = live value" {
    style.fill: "#B2DFDB"
    style.stroke: "#00695C"
    style.font-size: 12
  }
  p_ds: "stub   ds  = 0x00000010" {
    style.fill: "#E8DAEF"
    style.stroke: "#6C3483"
    style.font-size: 12
  }
  p_es: "stub   es  = 0x00000010" {
    style.fill: "#E8DAEF"
    style.stroke: "#6C3483"
    style.font-size: 12
  }
  p_fs: "stub   fs  = 0x00000010" {
    style.fill: "#E8DAEF"
    style.stroke: "#6C3483"
    style.font-size: 12
  }
  p_gs: "stub   gs  = 0x00000010  ← saved_esp" {
    style.fill: "#E8DAEF"
    style.stroke: "#6C3483"
    style.bold: true
  }
  p_ret: "      [return addr inside sched_schedule]  ← 'ret'" {
    style.fill: "#FFD580"
    style.stroke: "#B7770D"
    style.bold: true
  }

  bot2: "      (lower addresses)" {
    shape: text
    style.italic: true
    style.font-size: 12
    style.font-color: "#888888"
  }
}

# ────────────────────────────────────────────────────────────────
# MIDDLE: context_switch_asm explanation box
# ────────────────────────────────────────────────────────────────

csw: "context_switch_asm(old_esp_ptr, new_esp, new_cr3)" {
  style.fill: "#FFFDE7"
  style.stroke: "#F9A825"
  style.stroke-width: 2

  step1: "1. Load all args to registers BEFORE touching esp" {
    style.fill: "#FFFDE7"
    style.font-size: 13
  }
  step2: "2. mov [old_esp_ptr], esp  →  saves current stack" {
    style.fill: "#FFFDE7"
    style.font-size: 13
    style.bold: true
  }
  step3: "3. mov esp, new_esp  →  PIVOTS to next stack" {
    style.fill: "#FFFDE7"
    style.font-size: 13
    style.bold: true
    style.font-color: "#B7770D"
  }
  step4: "4. cmp cr3, new_cr3  →  reload only if different" {
    style.fill: "#FFFDE7"
    style.font-size: 13
  }
  step5: "5. ret  →  pops return addr from NEW stack" {
    style.fill: "#FFFDE7"
    style.font-size: 13
  }
  note: |md
    After **ret**:
    - New process: → **irq_return_trampoline** (pops segs, popa, add 8, iret)
    - Old process: → back inside **sched_schedule** (after call site)
  | {
    style.font-size: 12
    style.fill: "#FFFDE7"
  }
}

# ────────────────────────────────────────────────────────────────
# saved_esp pointer annotations
# ────────────────────────────────────────────────────────────────

new_saved_esp: "proc->saved_esp\n= addr of gs field" {
  shape: diamond
  style.fill: "#FF9800"
  style.stroke: "#E65100"
  style.font-color: white
  style.bold: true
  style.font-size: 13
}

pre_saved_esp: "proc->saved_esp\n= addr of gs field\n(set by context_switch_asm)" {
  shape: diamond
  style.fill: "#FF9800"
  style.stroke: "#E65100"
  style.font-color: white
  style.bold: true
  style.font-size: 13
}

# ────────────────────────────────────────────────────────────────
# Ring-3 extra annotation
# ────────────────────────────────────────────────────────────────

ring3_note: "Ring-3 process: CPU also pushes\nuser_ss and user_esp ABOVE eflags\n(iret pops them to restore user stack)" {
  shape: rectangle
  style.fill: "#E0F7FA"
  style.stroke: "#00838F"
  style.font-size: 13
  style.italic: true
}

# ────────────────────────────────────────────────────────────────
# Connections
# ────────────────────────────────────────────────────────────────

new_proc.f_gs -> new_saved_esp: "saved_esp points here" {
  style.stroke: "#E65100"
  style.stroke-width: 2
  style.stroke-dash: 3
}

preempted.p_gs -> pre_saved_esp: "saved_esp points here" {
  style.stroke: "#E65100"
  style.stroke-width: 2
  style.stroke-dash: 3
}

new_saved_esp -> csw: "passed as new_esp\nto activate" {
  style.stroke: "#F9A825"
  style.stroke-width: 2
}

pre_saved_esp -> csw: "old_esp_ptr written\nby step 2" {
  style.stroke: "#F9A825"
  style.stroke-width: 2
}

new_proc.tramp -> csw: "first activation:\nret → trampoline" {
  style.stroke: "#B7770D"
  style.stroke-dash: 4
}

preempted.p_ret -> csw: "subsequent resume:\nret → sched_schedule" {
  style.stroke: "#B7770D"
  style.stroke-dash: 4
}

ring3_note -> new_proc: "applies to\nprocess_create_user" {
  style.stroke: "#00838F"
  style.stroke-dash: 3
  style.font-size: 11
}