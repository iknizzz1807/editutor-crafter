vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "TSS Structure: Hardware Ring 3→Ring 0 Transition Fields" {
  shape: text
  near: top-center
  style: {
    font-size: 22
    bold: true
  }
}

tss: "kernel_tss (104 bytes total)" {
  style: {
    fill: "#F0F0FF"
    stroke: "#5050A0"
    stroke-width: 2
    font-size: 13
    bold: true
  }

  f00: "+0   prev_tss (uint32_t)" {
    style.fill: "#D0D0D0"
    style.stroke: "#999999"
    style.font-size: 12
  }
  f04: "+4   esp0 (uint32_t) ← CPU reads this on every ring-3→ring-0 transition" {
    style.fill: "#FF9900"
    style.stroke: "#CC6600"
    style.font-size: 12
    style.bold: true
  }
  f08: "+8   ss0 (uint32_t) = 0x0010  ← kernel data segment" {
    style.fill: "#FFCC66"
    style.stroke: "#CC9900"
    style.font-size: 12
    style.bold: true
  }
  f12: "+12  esp1 (uint32_t) — ring 1, unused" {
    style.fill: "#D0D0D0"
    style.stroke: "#999999"
    style.font-size: 12
  }
  f16: "+16  ss1 (uint32_t) — ring 1, unused" {
    style.fill: "#D0D0D0"
    style.stroke: "#999999"
    style.font-size: 12
  }
  f20: "+20  esp2 (uint32_t) — ring 2, unused" {
    style.fill: "#D0D0D0"
    style.stroke: "#999999"
    style.font-size: 12
  }
  f24: "+24  ss2 (uint32_t) — ring 2, unused" {
    style.fill: "#D0D0D0"
    style.stroke: "#999999"
    style.font-size: 12
  }
  f28: "+28  cr3 (uint32_t) — unused (we manage CR3 in context_switch_asm)" {
    style.fill: "#D0D0D0"
    style.stroke: "#999999"
    style.font-size: 12
  }
  f32_67: "+32..+67  eip,eflags,eax..edi — hardware task switch fields, unused" {
    style.fill: "#D0D0D0"
    style.stroke: "#999999"
    style.font-size: 12
  }
  f72_95: "+72..+95  es,cs,ss,ds,fs,gs,ldt — hardware task switch fields, unused" {
    style.fill: "#D0D0D0"
    style.stroke: "#999999"
    style.font-size: 12
  }
  f100: "+100 debug_trap (uint16_t) = 0" {
    style.fill: "#D0D0D0"
    style.stroke: "#999999"
    style.font-size: 12
  }
  f102: "+102 iomap_base (uint16_t) = 104 → all I/O ports restricted for ring-3" {
    style.fill: "#FFE0A0"
    style.stroke: "#CC9900"
    style.font-size: 12
  }
}

gdt_entry: "GDT Entry 5: TSS Descriptor (8 bytes)" {
  style: {
    fill: "#F0F0FF"
    stroke: "#5050A0"
    stroke-width: 2
    font-size: 13
    bold: true
  }
  b01: "bytes 0-1:  limit_low  = sizeof(tss_t)-1 = 0x0067" {
    style.fill: "#D8D8FF"
    style.font-size: 12
  }
  b23: "bytes 2-3:  base_low   = &kernel_tss & 0xFFFF" {
    style.fill: "#D8D8FF"
    style.font-size: 12
  }
  b4: "byte  4:    base_mid   = (&kernel_tss >> 16) & 0xFF" {
    style.fill: "#D8D8FF"
    style.font-size: 12
  }
  b5: "byte  5:    access     = 0x89  (P=1, DPL=0, S=0, Type=0x9 TSS-available)" {
    style.fill: "#FF9900"
    style.stroke: "#CC6600"
    style.font-size: 12
    style.bold: true
  }
  b6: "byte  6:    gran       = 0x00  (G=0 byte-granular; limit high nibble = 0)" {
    style.fill: "#D8D8FF"
    style.font-size: 12
  }
  b7: "byte  7:    base_high  = (&kernel_tss >> 24) & 0xFF" {
    style.fill: "#D8D8FF"
    style.font-size: 12
  }
}

tr_reg: "TR (Task Register)" {
  shape: rectangle
  style: {
    fill: "#CCFFCC"
    stroke: "#339933"
    stroke-width: 2
    font-size: 13
    bold: true
  }
  tr_val: "selector = 0x0028\n(GDT index 5, TI=0, RPL=0)\nCached TSS descriptor base + limit" {
    style.fill: "#E8FFE8"
    style.font-size: 12
  }
}

cpu_hw: "CPU Hardware Action on Ring-3 IRQ/Exception" {
  style: {
    fill: "#FFF0F0"
    stroke: "#A03030"
    stroke-width: 2
    font-size: 13
    bold: true
  }
  step1: "1. Privilege change needed (CPL=3, IDT gate DPL=0)" {
    style.fill: "#FFE0E0"
    style.font-size: 12
  }
  step2: "2. Read kernel_tss.esp0  ← tss_set_kernel_stack() must have written this" {
    style.fill: "#FFB0B0"
    style.font-size: 12
    style.bold: true
  }
  step3: "3. Switch kernel stack: SS=ss0=0x10, ESP=esp0" {
    style.fill: "#FFE0E0"
    style.font-size: 12
  }
  step4: "4. Push SS_user, ESP_user, EFLAGS, CS_user, EIP_user onto kernel stack" {
    style.fill: "#FFE0E0"
    style.font-size: 12
  }
  step5: "5. Jump to IDT handler (irq_common_stub)" {
    style.fill: "#FFE0E0"
    style.font-size: 12
  }
}

sched_update: "tss_set_kernel_stack(next->kernel_stack_top)" {
  shape: rectangle
  style: {
    fill: "#E0FFE0"
    stroke: "#339933"
    stroke-width: 2
    font-size: 13
    bold: true
  }
  upd: "Writes next->kernel_stack_top to kernel_tss.esp0\nMUST occur BEFORE context_switch_asm()\nSingle 32-bit store; takes effect on next ring transition" {
    style.fill: "#F0FFF0"
    style.font-size: 12
  }
}

per_proc: "Per-Process kernel_stack_top values" {
  style: {
    fill: "#FFF8E0"
    stroke: "#CC9900"
    stroke-width: 2
    font-size: 13
    bold: true
  }
  idle: "idle (PID 0):  proc_table[0].kernel_stack + 4096" {
    style.fill: "#FFF8E0"
    style.font-size: 12
  }
  pa: "proc_a (PID 1): proc_table[1].kernel_stack + 4096" {
    style.fill: "#FFF8E0"
    style.font-size: 12
  }
  pb: "proc_b (PID 2): proc_table[2].kernel_stack + 4096" {
    style.fill: "#FFF8E0"
    style.font-size: 12
  }
  pu: "user  (PID N):  proc_table[N].kernel_stack + 4096" {
    style.fill: "#FFF8E0"
    style.font-size: 12
  }
}

tss.f04 -> cpu_hw.step2: "CPU reads esp0 here" {
  style.stroke: "#FF6600"
  style.stroke-width: 2
  style.bold: true
}

sched_update -> tss.f04: "writes new process kernel_stack_top" {
  style.stroke: "#339933"
  style.stroke-width: 2
  style.stroke-dash: 3
}

per_proc -> sched_update: "kernel_stack_top argument" {
  style.stroke: "#CC9900"
  style.stroke-dash: 3
}

tr_reg -> gdt_entry: "CPU caches TSS descriptor from GDT[5]" {
  style.stroke: "#5050A0"
  style.stroke-dash: 4
}

gdt_entry -> tss: "base address points to" {
  style.stroke: "#5050A0"
  style.stroke-dash: 4
}

cpu_hw.step2 -> cpu_hw.step3: "" {style.stroke: "#A03030"}
cpu_hw.step3 -> cpu_hw.step4: "" {style.stroke: "#A03030"}
cpu_hw.step4 -> cpu_hw.step5: "" {style.stroke: "#A03030"}

note_ltr: |'md
**Initialization sequence:**
1. `gdt_install_tss(5, &kernel_tss, 103)`
2. `gdt_flush()` — CPU reloads GDTR
3. `ltr 0x28` — CPU loads TR, caches GDT[5]
4. After `ltr`: CPU reads `esp0` from memory
   on every ring-3→ring-0 transition
5. `tss_set_kernel_stack()` = one store to `esp0`
   No `ltr` needed again — TR already loaded
'| {
  near: bottom-center
  style.font-size: 12
}