vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Process State Machine: Lifecycle and Scheduler Transitions
  **Module mod-4** · Single-core preemptive x86 kernel · Round-robin 50ms slices
| {near: top-center}

# ── States ──────────────────────────────────────────────────────────────────

UNUSED: "PROCESS_UNUSED\n──────────────\nslot free\npid = 0\nsaved_esp = 0\nstate = 0" {
  style.fill: "#E8E8E8"
  style.stroke: "#999999"
  style.font-size: 13
  style.border-radius: 6
}

READY: "PROCESS_READY\n─────────────\nsaved_esp valid\npage_dir valid\nticks_remaining set\ncurrent_process ≠ this" {
  style.fill: "#D4EDDA"
  style.stroke: "#28A745"
  style.font-size: 13
  style.border-radius: 6
}

RUNNING: "PROCESS_RUNNING\n───────────────\ncurrent_process == this\nIF = 1 (from EFLAGS)\ntss.esp0 == kernel_stack_top\nCR3 == page_directory" {
  style.fill: "#CCE5FF"
  style.stroke: "#0066CC"
  style.font-size: 13
  style.border-radius: 6
  style.bold: true
}

BLOCKED: "PROCESS_BLOCKED\n───────────────\nawaiting event\nskipped by round-robin\n(not implemented in mod-4)" {
  style.fill: "#FFF3CD"
  style.stroke: "#FFC107"
  style.font-size: 13
  style.border-radius: 6
  style.stroke-dash: 4
}

ZOMBIE: "PROCESS_ZOMBIE\n──────────────\nsys_exit() called\nnever scheduled again\nPCB slot leaked\n(no wait() in mod-4)" {
  style.fill: "#F8D7DA"
  style.stroke: "#DC3545"
  style.font-size: 13
  style.border-radius: 6
}

# ── Initial state marker ────────────────────────────────────────────────────

INIT: "" {
  shape: circle
  width: 24
  height: 24
  style.fill: "#000000"
  style.stroke: "#000000"
}

INIT -> UNUSED: "" {
  style.stroke: "#000000"
  style.stroke-width: 2
}

# ── Legal transitions ────────────────────────────────────────────────────────

UNUSED -> READY: "process_create_kernel()\nor process_create_user()\n[guard: free slot exists]\naction: build fake frame,\nset state=READY" {
  style.stroke: "#28A745"
  style.font-size: 12
}

READY -> RUNNING: "sched_schedule() selects\n[guard: state==READY]\naction:\n  next->state = RUNNING\n  tss_set_kernel_stack(next->kst)\n  current_process = next\n  context_switch_asm()" {
  style.stroke: "#0066CC"
  style.font-size: 12
  style.stroke-width: 2
}

RUNNING -> READY: "timer IRQ (100Hz) +\nticks_remaining-- == 0\n[guard: state==RUNNING]\naction:\n  old->state = READY\n  pick next READY process" {
  style.stroke: "#FF8800"
  style.font-size: 12
  style.stroke-width: 2
}

RUNNING -> ZOMBIE: "sys_exit(code)\n[guard: state==RUNNING]\naction:\n  state = ZOMBIE\n  kprintf exit message\n  sched_schedule()" {
  style.stroke: "#DC3545"
  style.font-size: 12
  style.stroke-width: 2
}

RUNNING -> BLOCKED: "blocking I/O wait\n(not implemented)" {
  style.stroke: "#FFC107"
  style.stroke-dash: 5
  style.font-size: 11
}

BLOCKED -> READY: "event arrives\n(not implemented)" {
  style.stroke: "#FFC107"
  style.stroke-dash: 5
  style.font-size: 11
}

# ── Self-loop: keep running when no other ready process ─────────────────────

RUNNING -> RUNNING: "sched_schedule() + no READY found\naction: state stays RUNNING,\nticks_remaining reset" {
  style.stroke: "#6699CC"
  style.stroke-dash: 3
  style.font-size: 11
}

# ── ILLEGAL transitions (red dashed) ────────────────────────────────────────

ILLEGAL_1: "ILLEGAL" {
  shape: text
  style.font-color: "#DC3545"
  style.bold: true
  style.font-size: 11
}

ILLEGAL_2: "ILLEGAL" {
  shape: text
  style.font-color: "#DC3545"
  style.bold: true
  style.font-size: 11
}

ILLEGAL_3: "ILLEGAL" {
  shape: text
  style.font-color: "#DC3545"
  style.bold: true
  style.font-size: 11
}

UNUSED -> RUNNING: "skip READY\n→ saved_esp=0\n→ ESP=0 after switch\n→ triple fault" {
  style.stroke: "#DC3545"
  style.stroke-dash: 4
  style.font-color: "#DC3545"
  style.font-size: 11
}

ZOMBIE -> READY: "resurrect zombie\n→ stack may be reused\n→ undefined behaviour" {
  style.stroke: "#DC3545"
  style.stroke-dash: 4
  style.font-color: "#DC3545"
  style.font-size: 11
}

ZOMBIE -> RUNNING: "direct activate\n→ no context switch path\n→ undefined behaviour" {
  style.stroke: "#DC3545"
  style.stroke-dash: 4
  style.font-color: "#DC3545"
  style.font-size: 11
}

# ── Invariant annotation ─────────────────────────────────────────────────────

invariant: |md
  **Scheduler Invariant (enforced while IF=0):**
  - Exactly **one** process has `state == RUNNING`
  - That process **equals** `current_process`
  - `tss.esp0` equals `current_process->kernel_stack_top`
  - All other schedulable processes have `state == READY`
  - Round-robin slice = 5 ticks × 10ms = **50ms**
| {
  near: bottom-right
  style.fill: "#FFFFF0"
  style.stroke: "#CCCC00"
  style.font-size: 12
  style.border-radius: 6
}