vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "INT 0x80 System Call: User â†’ Kernel â†’ User" {
  shape: text
  near: top-center
  style: {
    font-size: 20
    bold: true
  }
}

direction: right

############################
# PARTICIPANTS
############################

user_proc: "User Process\n(CPL=3, CS=0x1B)" {
  shape: rectangle
  style.fill: "#E8F4FD"
  style.stroke: "#2980B9"
  style.stroke-width: 2
}

cpu_hw: "CPU Hardware\n(MMU + IDT Dispatch)" {
  shape: rectangle
  style.fill: "#FEF9E7"
  style.stroke: "#F39C12"
  style.stroke-width: 2
}

tss_mem: "TSS Memory\nkernal_tss.esp0" {
  shape: cylinder
  style.fill: "#FDEDEC"
  style.stroke: "#E74C3C"
  style.stroke-width: 2
}

idt_gate: "IDT[0x80]\nDPL=3 Trap Gate\noffset=isr128" {
  shape: rectangle
  style.fill: "#F9EBEA"
  style.stroke: "#C0392B"
  style.stroke-width: 1
}

isr128_stub: "isr128 Stub\n(kernel, CPL=0)\npush 0; push 128\njmp isr_common_stub" {
  shape: rectangle
  style.fill: "#EBF5FB"
  style.stroke: "#1A5276"
  style.stroke-width: 1
}

isr_common: "isr_common_stub\npusha\npush seg regs\nmov ds,0x10\npush esp\ncall exception_handler" {
  shape: rectangle
  style.fill: "#EBF5FB"
  style.stroke: "#1A5276"
  style.stroke-width: 1
}

exc_handler: "exception_handler()\nvector==128?\nâ†’ syscall_dispatch(frame)" {
  shape: rectangle
  style.fill: "#E9F7EF"
  style.stroke: "#1E8449"
  style.stroke-width: 1
}

syscall_disp: "syscall_dispatch(frame)\nframe->eax = syscall#\nswitch(eax)\n4=SYS_WRITE\n1=SYS_EXIT" {
  shape: rectangle
  style.fill: "#E9F7EF"
  style.stroke: "#1E8449"
  style.stroke-width: 2
}

sys_write: "sys_write_impl()\nvalidate buf<0xC0000000\nfor each byte:\n  vga_putchar()\n  serial_putchar()\nframe->eax = written" {
  shape: rectangle
  style.fill: "#E8F8F5"
  style.stroke: "#17A589"
  style.stroke-width: 1
}

sys_exit: "sys_exit_impl()\ncurrent->state=ZOMBIE\nsched_schedule()\n(never returns)" {
  shape: rectangle
  style.fill: "#FDEDEC"
  style.stroke: "#E74C3C"
  style.stroke-width: 1
}

restore_path: "isr_common_stub (return)\npop seg regs\npopa\nadd esp,8\niret" {
  shape: rectangle
  style.fill: "#EBF5FB"
  style.stroke: "#1A5276"
  style.stroke-width: 1
}

############################
# KERNEL STACK LAYOUT (annotation)
############################

kstack_layout: |md
  **Kernel Stack after CPU push (ring-3â†’ring-0):**

  
  [esp+20] user_ss  = 0x23
  [esp+16] user_esp = 0x00BFF...
  [esp+12] eflags   = 0x202
  [esp+ 8] cs       = 0x1B
  [esp+ 4] eip      = ret_addr
  [esp+ 0] â† TSS.esp0 â†’ kernel stack top
  
  Then isr128 pushes:
  
  push 0   (error_code)
  push 128 (vector)
  
  Then isr_common_stub adds:
  
  pusha    (8 regs Ã— 4 = 32 bytes)
  push gs,fs,es,ds (16 bytes)
  push esp â†’ frame* argument
  
| {
  near: bottom-center
  style.font-size: 12
}

############################
# PHASE LABELS (sequences)
############################

ph1: "â‘  User invokes\nint 0x80\n(EAX=syscall#\n EBX=arg1\n ECX=arg2\n EDX=arg3)" {
  shape: text
  style.font-color: "#2980B9"
  style.font-size: 12
  style.bold: true
}

ph2: "â‘¡ CPL check:\nCPL(3) â‰¤ DPL(3) âœ“\nRead TSS.esp0\nSwitch SS:ESP" {
  shape: text
  style.font-color: "#E67E22"
  style.font-size: 12
  style.bold: true
}

ph3: "â‘¢ CPU auto-pushes\n5 values onto\nkernel stack" {
  shape: text
  style.font-color: "#E74C3C"
  style.font-size: 12
  style.bold: true
}

ph4: "â‘£ Kernel handler\nsaves all state\ndispatches syscall" {
  shape: text
  style.font-color: "#1E8449"
  style.font-size: 12
  style.bold: true
}

ph5: "â‘¤ iret restores\nEIP,CS,EFLAGS\nESP,SS (ring-3)\nResumes CPL=3" {
  shape: text
  style.font-color: "#2980B9"
  style.font-size: 12
  style.bold: true
}

############################
# CONNECTIONS: Forward path
############################

user_proc -> cpu_hw: "int \$0x80\nEAX=syscall#" {
  style.stroke: "#2980B9"
  style.stroke-width: 3
  style.animated: true
}

ph1 -> user_proc: "" {
  style.stroke-dash: 5
  style.stroke: "#2980B9"
  target-arrowhead.shape: arrow
}

cpu_hw -> tss_mem: "read esp0\n(ring-3 interrupt)" {
  style.stroke: "#E67E22"
  style.stroke-width: 2
}

ph2 -> cpu_hw: "" {
  style.stroke-dash: 5
  style.stroke: "#E67E22"
  target-arrowhead.shape: arrow
}

cpu_hw -> idt_gate: "vector 0x80\nlookup" {
  style.stroke: "#F39C12"
  style.stroke-width: 2
}

cpu_hw -> isr128_stub: "push SS,ESP\npush EFLAGS,CS,EIP\njump to isr128" {
  style.stroke: "#E74C3C"
  style.stroke-width: 2
  style.animated: true
}

ph3 -> cpu_hw: "" {
  style.stroke-dash: 5
  style.stroke: "#E74C3C"
  target-arrowhead.shape: arrow
}

idt_gate -> isr128_stub: "handler addr" {
  style.stroke: "#C0392B"
  style.stroke-dash: 3
}

isr128_stub -> isr_common: "jmp" {
  style.stroke: "#1A5276"
  style.stroke-width: 2
}

isr_common -> exc_handler: "call exception_handler\n(frame* on stack)" {
  style.stroke: "#1A5276"
  style.stroke-width: 2
}

exc_handler -> syscall_disp: "vector==128\nâ†’ dispatch" {
  style.stroke: "#1E8449"
  style.stroke-width: 2
}

ph4 -> exc_handler: "" {
  style.stroke-dash: 5
  style.stroke: "#1E8449"
  target-arrowhead.shape: arrow
}

syscall_disp -> sys_write: "SYS_WRITE (4)" {
  style.stroke: "#17A589"
  style.stroke-width: 2
}

syscall_disp -> sys_exit: "SYS_EXIT (1)" {
  style.stroke: "#E74C3C"
  style.stroke-width: 2
}

############################
# CONNECTIONS: Return path
############################

sys_write -> restore_path: "frame->eax = n\nreturn" {
  style.stroke: "#17A589"
  style.stroke-width: 2
}

restore_path -> user_proc: "iret: restore\nEIP,CS,EFLAGS,ESP,SS\nResume CPL=3\nEAX = return value" {
  style.stroke: "#2980B9"
  style.stroke-width: 3
  style.animated: true
}

ph5 -> restore_path: "" {
  style.stroke-dash: 5
  style.stroke: "#2980B9"
  target-arrowhead.shape: arrow
}

############################
# SECURITY ANNOTATION
############################

sec_check: "ðŸ”’ Security Checks in sys_write_impl:\nâ€¢ buf >= 0xC0000000 â†’ return -EFAULT\nâ€¢ buf+count spans kernel boundary â†’ clamp\nâ€¢ fd not in {1,2} â†’ return -EBADF\nâ€¢ User PD: kernel pages U/S=0 (hardware)" {
  shape: rectangle
  style.fill: "#FEF9E7"
  style.stroke: "#F39C12"
  style.stroke-width: 1
  style.font-size: 11
  near: bottom-right
}

sys_write -> sec_check: "validation\nbefore deref" {
  style.stroke: "#F39C12"
  style.stroke-dash: 3
  target-arrowhead.shape: diamond
}

############################
# PRIVILEGE LEVEL ANNOTATION
############################

ring3_label: "CPL = 3\n(User Mode)" {
  shape: text
  style.font-color: "#2980B9"
  style.font-size: 14
  style.bold: true
}

ring0_label: "CPL = 0\n(Kernel Mode)" {
  shape: text
  style.font-color: "#C0392B"
  style.font-size: 14
  style.bold: true
}

ring3_label -> user_proc: "" {
  style.stroke-dash: 5
  style.stroke: "#2980B9"
  target-arrowhead.shape: arrow
}

ring0_label -> isr128_stub: "" {
  style.stroke-dash: 5
  style.stroke: "#C0392B"
  target-arrowhead.shape: arrow
}