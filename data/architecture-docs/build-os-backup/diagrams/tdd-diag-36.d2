vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

title: |md
  ## Privilege Ring Model: Hardware Enforcement of Kernel-User Boundary
  *x86 Protected Mode â€” Ring 0 (Kernel) vs Ring 3 (User)*
| {near: top-center}

# â”€â”€ Ring 3: User Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ring3: "Ring 3 â€” User Mode (CPL=3)" {
  style.fill: "#E8F4FD"
  style.stroke: "#2196F3"
  style.stroke-width: 3
  style.border-radius: 12

  user_proc: "User Process" {
    style.fill: "#BBDEFB"
    style.stroke: "#1565C0"
    style.border-radius: 8

    cs_reg: "CS = 0x1B\n(GDT idx 3, RPL=3)" {
      style.fill: "#FFF9C4"
      style.stroke: "#F9A825"
      style.font: mono
    }
    ds_reg: "DS/SS = 0x23\n(GDT idx 4, RPL=3)" {
      style.fill: "#FFF9C4"
      style.stroke: "#F9A825"
      style.font: mono
    }
    eflags_val: "EFLAGS = 0x202\n(IF=1, Reserved=1)" {
      style.fill: "#FFF9C4"
      style.stroke: "#F9A825"
      style.font: mono
    }
    va_range: "Virtual 0x00000000â€“0xBFFFFFFF\n(3 GB user space)" {
      style.fill: "#C8E6C9"
      style.stroke: "#388E3C"
      style.font: mono
    }
  }

  syscall_instr: "int 0x80\n(Software Interrupt)" {
    style.fill: "#FF8A65"
    style.stroke: "#BF360C"
    style.stroke-width: 2
    style.border-radius: 6
    style.font: mono
  }

  page_fault_user: "Page Fault on\nKernel Access\n(U/S=0 pages)" {
    style.fill: "#EF9A9A"
    style.stroke: "#C62828"
    style.border-radius: 6
  }

  gpf_user: "GPF on\nPrivileged Instruction\n(IN/OUT, MOV CR0, etc.)" {
    style.fill: "#EF9A9A"
    style.stroke: "#C62828"
    style.border-radius: 6
  }
}

# â”€â”€ Hardware Boundary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
hw_gate: "x86 Hardware Gate\n(IDT Gate Descriptor)" {
  shape: hexagon
  style.fill: "#4A148C"
  style.stroke: "#7B1FA2"
  style.font-color: white
  style.stroke-width: 3
}

tss_read: "TSS Read\n(esp0 â†’ Kernel Stack)\nss0 = 0x10" {
  shape: diamond
  style.fill: "#880E4F"
  style.stroke: "#AD1457"
  style.font-color: white
  style.font: mono
}

# â”€â”€ Ring 0: Kernel Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ring0: "Ring 0 â€” Kernel Mode (CPL=0)" {
  style.fill: "#F3E5F5"
  style.stroke: "#7B1FA2"
  style.stroke-width: 3
  style.border-radius: 12

  idt_entry: "IDT[0x80]\ntype=0xEF (DPL=3 Trap Gate)\nhandler=isr128" {
    style.fill: "#CE93D8"
    style.stroke: "#6A1B9A"
    style.font: mono
    style.border-radius: 6
  }

  kernel_stack: "Per-Process Kernel Stack\n(4 KB, in PCB)\nTSS.esp0 â†’ top" {
    style.fill: "#F8BBD9"
    style.stroke: "#880E4F"
    style.border-radius: 6
  }

  interrupt_frame: "Interrupt Frame (CPU-pushed)\n[ss_user]\n[esp_user]\n[eflags]\n[cs_user]\n[eip_user]" {
    style.fill: "#E1BEE7"
    style.stroke: "#6A1B9A"
    style.font: mono
    style.border-radius: 6
  }

  isr_stub: "isr128 Stub\npush 0     ; error code\npush 128   ; vector\njmp isr_common_stub" {
    style.fill: "#B39DDB"
    style.stroke: "#4527A0"
    style.font: mono
    style.border-radius: 6
  }

  common_stub: "isr_common_stub\npusha          ; save 8 GPRs\npush ds/es/fs/gs\nmov ax, 0x10   ; kernel DS\ncall exception_handler" {
    style.fill: "#B39DDB"
    style.stroke: "#4527A0"
    style.font: mono
    style.border-radius: 6
  }

  syscall_dispatch_box: "syscall_dispatch(frame)\nâ†’ sys_write / sys_exit\nReturn: frame->eax = retval" {
    style.fill: "#A5D6A7"
    style.stroke: "#2E7D32"
    style.border-radius: 6
  }

  kernel_space: "Kernel Virtual 0xC0000000â€“0xFFFFFFFF\nU/S=0 in all page tables\n(Supervisor-only pages)" {
    style.fill: "#C5CAE9"
    style.stroke: "#283593"
    style.font: mono
    style.border-radius: 6
  }

  iret_restore: "iret\nRestores: EIP, CS, EFLAGS\n[ESP_user, SS_user if ring-3]\nâ†’ Returns to CPL=3" {
    style.fill: "#FFCC80"
    style.stroke: "#E65100"
    style.font: mono
    style.border-radius: 6
  }
}

# â”€â”€ GDT and Page Tables (shared hardware structures) â”€â”€â”€â”€â”€â”€â”€â”€
gdt_box: "GDT (6 entries)" {
  style.fill: "#FFF3E0"
  style.stroke: "#E65100"
  style.stroke-width: 2
  style.border-radius: 8

  gdt_null: "0x00  Null (required)" { style.fill: "#BDBDBD"; style.font: mono }
  gdt_kcode: "0x08  Kernel Code  DPL=0 0x9A" { style.fill: "#A5D6A7"; style.font: mono }
  gdt_kdata: "0x10  Kernel Data  DPL=0 0x92" { style.fill: "#A5D6A7"; style.font: mono }
  gdt_ucode: "0x18  User Code   DPL=3 0xFA" { style.fill: "#BBDEFB"; style.font: mono }
  gdt_udata: "0x20  User Data   DPL=3 0xF2" { style.fill: "#BBDEFB"; style.font: mono }
  gdt_tss:   "0x28  TSS         DPL=0 0x89" { style.fill: "#F8BBD9"; style.font: mono }
}

pt_box: "Page Tables (hardware enforced)" {
  style.fill: "#E8F5E9"
  style.stroke: "#2E7D32"
  style.stroke-width: 2
  style.border-radius: 8

  pt_user: "User pages\nU/S=1  (flags 0x007)\nCPL=3 can access" { style.fill: "#C8E6C9"; style.font: mono }
  pt_kernel: "Kernel pages\nU/S=0  (flags 0x003)\nCPL=3 â†’ Page Fault!" { style.fill: "#FFCDD2"; style.font: mono }
}

# â”€â”€ MMU enforcement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mmu: "MMU (Hardware)\nAddress Translation\n+ Permission Check" {
  shape: diamond
  style.fill: "#37474F"
  style.stroke: "#546E7A"
  style.font-color: white
}

# â”€â”€ Connections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# syscall path
ring3.user_proc -> ring3.syscall_instr: "EAX=4 (SYS_WRITE)\nEBX=fd ECX=buf EDX=n" {
  style.stroke: "#FF6D00"
  style.stroke-width: 2
}

ring3.syscall_instr -> hw_gate: "int 0x80\nCPL check:\nCPL(3) â‰¤ DPL(3) âœ“" {
  style.stroke: "#BF360C"
  style.stroke-width: 3
  style.animated: true
}

hw_gate -> tss_read: "DPL check passed\nPrivilege transition\nCPL: 3 â†’ 0" {
  style.stroke: "#4A148C"
  style.stroke-width: 3
}

tss_read -> ring0.kernel_stack: "Load SS0=0x10\nesp0 = current_process\n->kernel_stack_top" {
  style.stroke: "#880E4F"
  style.stroke-width: 2
}

ring0.kernel_stack -> ring0.interrupt_frame: "CPU pushes\n5 words\n(ring-3 crossing)" {
  style.stroke: "#6A1B9A"
  style.stroke-width: 2
}

ring0.interrupt_frame -> ring0.idt_entry: "IDT lookup\nvector 0x80" {
  style.stroke: "#6A1B9A"
}

ring0.idt_entry -> ring0.isr_stub: "jump to\nhandler address" {
  style.stroke: "#4527A0"
}

ring0.isr_stub -> ring0.common_stub: "jmp isr_common_stub" {
  style.stroke: "#4527A0"
}

ring0.common_stub -> ring0.syscall_dispatch_box: "frame->vector == 128\nâ†’ syscall_dispatch()" {
  style.stroke: "#2E7D32"
  style.stroke-width: 2
}

ring0.syscall_dispatch_box -> ring0.iret_restore: "retval in frame->eax\npopa / add esp,8" {
  style.stroke: "#E65100"
  style.stroke-width: 2
}

ring0.iret_restore -> ring3.user_proc: "iret: restore\nEIP, CS=0x1B, EFLAGS\nESP_user, SS=0x23\nCPL: 0 â†’ 3" {
  style.stroke: "#1565C0"
  style.stroke-width: 3
  style.animated: true
}

# page fault path
ring3.user_proc -> mmu: "Memory access\nvirtual addr" {
  style.stroke: "#388E3C"
  style.stroke-dash: 3
}
mmu -> pt_box.pt_user: "CPL=3, U/S=1\nâ†’ ALLOWED" {
  style.stroke: "#388E3C"
}
mmu -> ring3.page_fault_user: "CPL=3 access\nU/S=0 kernel page\nâ†’ FAULT #PF(13)" {
  style.stroke: "#C62828"
  style.stroke-width: 2
}
mmu -> ring3.gpf_user: "Privileged\ninstruction\nâ†’ FAULT #GP(0)" {
  style.stroke: "#C62828"
  style.stroke-width: 2
}

ring3.page_fault_user -> ring0.idt_entry: "vector 14\nerror P=1,W=0,U=1" {
  style.stroke: "#C62828"
  style.stroke-dash: 5
}

ring3.gpf_user -> ring0.idt_entry: "vector 13\nerror code" {
  style.stroke: "#C62828"
  style.stroke-dash: 5
}

# GDT relationships
ring3.user_proc.cs_reg -> gdt_box.gdt_ucode: "selector 0x1B\nDPL=3 validates\nCPL=3" {
  style.stroke: "#F9A825"
  style.stroke-dash: 3
}
ring3.user_proc.ds_reg -> gdt_box.gdt_udata: "selector 0x23\nDPL=3" {
  style.stroke: "#F9A825"
  style.stroke-dash: 3
}
tss_read -> gdt_box.gdt_tss: "TR=0x28\nltr at boot" {
  style.stroke: "#880E4F"
  style.stroke-dash: 3
}
ring0.isr_stub -> gdt_box.gdt_kcode: "CS=0x08\nafter jmp" {
  style.stroke: "#4527A0"
  style.stroke-dash: 3
}

# kernel space protection annotation
ring0.kernel_space -> pt_box.pt_kernel: "kernel PTEs\nhave U/S=0" {
  style.stroke: "#283593"
  style.stroke-dash: 3
}

# legend
legend: |md
  **Legend**
  - ðŸ”´ Fault/Error path
  - ðŸŸ  System call path (animated)
  - ðŸ”µ Return to user path (animated)
  - â¬œ Hardware-enforced boundary
  - `DPL` = Descriptor Privilege Level
  - `CPL` = Current Privilege Level
  - Check: `CPL â‰¤ DPL` for gate access
| {
  near: bottom-right
  style.fill: white
  style.stroke: "#9E9E9E"
  style.border-radius: 8
}