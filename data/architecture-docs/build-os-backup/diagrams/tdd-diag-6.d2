vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  ## Kernel Virtual Address Space: Linker Script Section Layout
  Physical = Virtual (Identity Map) â€¢ Kernel loaded at 0x00100000
| {near: top-center}

style.fill: "#F8F9FA"
style.stroke: "#CED4DA"

legend: |md
  **Colors:** ðŸŸ£ Header/Entry  ðŸ”µ Data  ðŸŸ¢ Free  â¬œ Reserved/MMIO  ðŸŸ  Pointers
| {near: bottom-center}

addr_col: "Virtual Address" {
  shape: text
  style.font-size: 13
  style.bold: true
  style.font-color: "#495057"
  near: top-left
}

mem: "Memory Layout" {
  style.fill: "#FFFFFF"
  style.stroke: "#ADB5BD"
  style.stroke-width: 2

  bios_ivt: "0x00000000 â€“ 0x000003FF\nReal-mode IVT (1 KB)" {
    style.fill: "#DEE2E6"
    style.stroke: "#ADB5BD"
    style.font-size: 12
    style.font-color: "#495057"
  }

  bios_data: "0x00000400 â€“ 0x000004FF\nBIOS Data Area (256 B)" {
    style.fill: "#DEE2E6"
    style.stroke: "#ADB5BD"
    style.font-size: 12
    style.font-color: "#495057"
  }

  low_ram: "0x00000500 â€“ 0x00007BFF\nLow RAM (usable by stage1)" {
    style.fill: "#D3F9D8"
    style.stroke: "#8CE99A"
    style.font-size: 12
    style.font-color: "#2B8A3E"
  }

  stage1: "0x00007C00 â€“ 0x00007DFF\nStage1 MBR (512 B)" {
    style.fill: "#E7D5FF"
    style.stroke: "#9775FA"
    style.font-size: 12
    style.font-color: "#5F3DC4"
  }

  stage2: "0x00007E00 â€“ 0x00009DFF\nStage2 (up to 8 KB)" {
    style.fill: "#E7D5FF"
    style.stroke: "#9775FA"
    style.font-size: 12
    style.font-color: "#5F3DC4"
  }

  ebda: "0x00080000 â€“ 0x0009FFFF\nEBDA / Reserved" {
    style.fill: "#DEE2E6"
    style.stroke: "#ADB5BD"
    style.font-size: 12
    style.font-color: "#495057"
  }

  vga_buf: "0x000B8000 â€“ 0x000B8F9F\nVGA Text Buffer (4000 B)\nMMIO â€” volatile uint16_t*" {
    style.fill: "#FFF3BF"
    style.stroke: "#F08C00"
    style.font-size: 12
    style.font-color: "#7A4F01"
  }

  bios_rom: "0x000C0000 â€“ 0x000FFFFF\nVideo BIOS + System ROM" {
    style.fill: "#DEE2E6"
    style.stroke: "#ADB5BD"
    style.font-size: 12
    style.font-color: "#495057"
  }

  cache_line_1: "â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ 1 MB Boundary â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€" {
    style.fill: "#E7F5FF"
    style.stroke: "#74C0FC"
    style.stroke-dash: 4
    style.font-size: 11
    style.bold: true
    style.font-color: "#1971C2"
  }

  text_sec: "0x00100000\n.text  (kernel entry + code)\nkernel_entry: â†’ kmain()" {
    style.fill: "#D0BFFF"
    style.stroke: "#7048E8"
    style.stroke-width: 2
    style.font-size: 12
    style.font-color: "#3B0764"
    style.bold: true
  }

  rodata_sec: ".rodata  (string literals, const arrays)\nexception_names[], scancode tables" {
    style.fill: "#D0BFFF"
    style.stroke: "#7048E8"
    style.font-size: 12
    style.font-color: "#3B0764"
  }

  data_sec: ".data  (initialized globals)\nvga_state, uart registers, gdt[]" {
    style.fill: "#A5D8FF"
    style.stroke: "#1971C2"
    style.font-size: 12
    style.font-color: "#1864AB"
  }

  bss_sec: ".bss  [__bss_start â†’ __bss_end]\nframe_bitmap (128 KB)\nidt[256] (2 KB)\nprocess_table[16] (65 KB)\nkernel_tss (104 B)\n+ all zero-init globals" {
    style.fill: "#B2F2BB"
    style.stroke: "#2F9E44"
    style.stroke-width: 2
    style.font-size: 12
    style.font-color: "#1B5E20"
  }

  kstack: ".bss  kernel_stack[16384]\n__stack_top  â† ESP initialized here\n(16 KB, grows â†“)" {
    style.fill: "#B2F2BB"
    style.stroke: "#2F9E44"
    style.stroke-dash: 3
    style.font-size: 12
    style.font-color: "#1B5E20"
  }

  page_tables: ".bss  boot_page_directory (4 KB)\n       identity_page_table  (4 KB)\n       kernel_page_table    (4 KB)\n[aligned to PAGE_SIZE = 4096]" {
    style.fill: "#FFE8CC"
    style.stroke: "#E8590C"
    style.font-size: 12
    style.font-color: "#7C2D12"
  }

  heap_region: "0xD0000000 â€“ 0xDFFFFFFF\nKernel Heap (256 MB virtual)\nkmalloc / kfree  [on-demand mapped]" {
    style.fill: "#D3F9D8"
    style.stroke: "#2F9E44"
    style.stroke-dash: 4
    style.font-size: 12
    style.font-color: "#1B5E20"
  }

  higher_half: "0xC0000000 â€“ 0xC03FFFFF\nHigher-Half Kernel Map\nâ†’ Physical 0x0 â€“ 0x3FFFFF\n(PD index 768)" {
    style.fill: "#FFF0F6"
    style.stroke: "#C2255C"
    style.font-size: 12
    style.font-color: "#880E4F"
  }

  apic: "0xFEC00000  I/O APIC\n0xFEE00000  Local APIC\n0xFFFF0000  BIOS ROM mirror" {
    style.fill: "#DEE2E6"
    style.stroke: "#ADB5BD"
    style.font-size: 12
    style.font-color: "#495057"
  }
}

sizes: "Sizes" {
  shape: text
  style.font-size: 12
  style.font-color: "#868E96"
  label: |md
    **Sections (approx):**
    - .text + .rodata: ~32 KB
    - .data: ~4 KB
    - .bss (bitmap): 128 KB
    - .bss (IDT): 2 KB
    - .bss (proc table): ~65 KB
    - .bss (page tables): 12 KB
    - .bss (stack): 16 KB
    - **Total kernel image: ~260 KB**
    - Heap virtual: 256 MB
    - User space: 0x0â€“0xBFFFFFFF (3 GB)
    - Kernel virtual: 0xC0000000â€“0xFFFFFFFF (1 GB)
  |
}

gdtptr: "GDTR â†’ gdt[6]\n(Index 0â€“4: null/kcode/kdata/ucode/udata\n Index 5: TSS selector 0x28)" {
  style.fill: "#FFE8CC"
  style.stroke: "#E8590C"
  style.font-size: 11
  style.font-color: "#7C2D12"
}

idtptr: "IDTR â†’ idt[256]\n(2048 bytes, 2 KB aligned)\nVectors 0â€“31: exceptions\nVectors 32â€“47: IRQs\nVector 0x80: syscall gate" {
  style.fill: "#A5D8FF"
  style.stroke: "#1971C2"
  style.font-size: 11
  style.font-color: "#1864AB"
}

tssptr: "TSS (104 B)\nesp0 â† updated each context switch\nss0 = 0x10 (kernel data)" {
  style.fill: "#FFE8CC"
  style.stroke: "#E8590C"
  style.font-size: 11
  style.font-color: "#7C2D12"
}

mem.text_sec -> gdtptr: "gdt[] in .data" {
  style.stroke: "#E8590C"
  style.stroke-dash: 3
  style.font-size: 10
}
mem.bss_sec -> idtptr: "idt[] in .bss" {
  style.stroke: "#1971C2"
  style.stroke-dash: 3
  style.font-size: 10
}
mem.bss_sec -> tssptr: "kernel_tss in .bss" {
  style.stroke: "#E8590C"
  style.stroke-dash: 3
  style.font-size: 10
}
mem.page_tables -> mem.higher_half: "PD[768] â†’ kernel_page_table\nPD[0] â†’ identity_page_table" {
  style.stroke: "#C2255C"
  style.stroke-dash: 4
  style.font-size: 10
}
mem.bss_sec -> mem.heap_region: "heap_init() maps\nframes on demand" {
  style.stroke: "#2F9E44"
  style.stroke-dash: 4
  style.font-size: 10
}