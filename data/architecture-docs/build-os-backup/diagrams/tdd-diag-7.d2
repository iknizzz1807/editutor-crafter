vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # VGA Text Buffer: Physical 0xB8000 — 80×25 Cell Grid
  **Each cell = 2 bytes (char + attribute). Total = 4000 bytes.**
| {near: top-center}

legend: {
  near: bottom-center
  style.fill: "#F8F8F8"
  style.stroke: "#CCCCCC"
  style.border-radius: 6
  l1: "■ Cell[row][col] = uint16_t @ 0xB8000 + (row×80 + col)×2" {shape: text; style.font-size: 13}
  l2: "Byte 0 = ASCII char  |  Byte 1 = attribute (bg[6:4] | fg[3:0])" {shape: text; style.font-size: 13}
  l3: "Attribute 0x07 = white-on-black (default kernel output)" {shape: text; style.font-size: 13}
}

base: Physical Base: 0xB8000 {
  style.fill: "#9B59B6"
  style.font-color: white
  style.bold: true
  style.border-radius: 4
}

row0: Row 0  (offset +0x000) {
  style.fill: "#EBF5FB"
  style.border-radius: 4
  c00: "Cell[0][0]\n0xB8000\nbyte0=char\nbyte1=attr" {
    style.fill: "#3498DB"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 3
  }
  c01: "Cell[0][1]\n0xB8002" {
    style.fill: "#5DADE2"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 3
  }
  c02: "Cell[0][2]\n0xB8004" {
    style.fill: "#5DADE2"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 3
  }
  cdots0: "... cols 3-77 ..." {
    style.fill: "#D6EAF8"
    style.font-size: 11
    style.border-radius: 3
  }
  c78: "Cell[0][78]\n0xB809C" {
    style.fill: "#5DADE2"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 3
  }
  c79: "Cell[0][79]\n0xB809E\n(col 79)" {
    style.fill: "#2980B9"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 3
  }
  rowsize0: "Row size = 160 bytes" {shape: text; style.font-size: 12; style.italic: true}
}

row1: Row 1  (offset +0x0A0) {
  style.fill: "#EBF5FB"
  style.border-radius: 4
  c10: "Cell[1][0]\n0xB80A0" {
    style.fill: "#3498DB"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 3
  }
  cdots1: "... 80 cells ..." {
    style.fill: "#D6EAF8"
    style.font-size: 11
    style.border-radius: 3
  }
  c179: "Cell[1][79]\n0xB813E" {
    style.fill: "#2980B9"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 3
  }
}

rowmid: Rows 2–23  (offsets +0x140 … +0xEBE) {
  style.fill: "#EAF7FB"
  style.border-radius: 4
  note: "22 rows × 160 bytes = 3520 bytes\nAddress of Cell[r][c] = 0xB8000 + (r×80+c)×2" {
    shape: text
    style.font-size: 12
    style.fill: "#D1F2EB"
    style.border-radius: 3
  }
}

row24: Row 24 — Last Row  (offset +0xF00) {
  style.fill: "#FDEDEC"
  style.border-radius: 4
  c240: "Cell[24][0]\n0xB8F00" {
    style.fill: "#E74C3C"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 3
  }
  cdots24: "... 80 cells ..." {
    style.fill: "#FADBD8"
    style.font-size: 11
    style.border-radius: 3
  }
  c2479: "Cell[24][79]\n0xB8F9E\n(last cell)" {
    style.fill: "#C0392B"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 3
  }
  rowsize24: "End of buffer = 0xB8F9E+2 = 0xB8FA0\nTotal = 4000 bytes" {
    shape: text
    style.font-size: 12
    style.italic: true
    style.fill: "#FADBD8"
    style.border-radius: 3
  }
}

celldetail: Cell Layout Detail (2 bytes) {
  style.fill: "#FEF9E7"
  style.border-radius: 6
  style.stroke: "#F39C12"
  byte0: "Byte 0\n[7:0]\nASCII code\n0x00–0xFF" {
    style.fill: "#F7DC6F"
    style.border-radius: 3
    style.font-size: 12
  }
  byte1: "Byte 1\n[7:0]\nAttribute\nbg[6:4]|fg[3:0]" {
    style.fill: "#F0B27A"
    style.border-radius: 3
    style.font-size: 12
  }
  attrdetail: "bit[7]=blink  bits[6:4]=bg(0-7)  bits[3:0]=fg(0-15)\n0x07=white(fg=7) on black(bg=0)  |  0x0A=green on black\n0x0C=light-red on black  |  0x0E=yellow on black" {
    shape: text
    style.font-size: 11
    style.fill: "#FDEBD0"
    style.border-radius: 3
  }
  byte0 -> byte1: "little-endian uint16_t" {style.font-size: 11}
}

addrformula: Address Formula {
  style.fill: "#F0FFF0"
  style.border-radius: 6
  style.stroke: "#27AE60"
  f1: "uint16_t *cell = (volatile uint16_t*)0xB8000 + row×80 + col" {
    shape: text; style.font-size: 12; style.fill: "#D5F5E3"; style.border-radius: 3
  }
  f2: "*cell = (uint16_t)ascii_char | ((uint16_t)attribute << 8)" {
    shape: text; style.font-size: 12; style.fill: "#D5F5E3"; style.border-radius: 3
  }
  f3: "volatile qualifier MANDATORY — prevents compiler dead-store elimination" {
    shape: text; style.font-size: 11; style.fill: "#A9DFBF"; style.border-radius: 3; style.italic: true
  }
}

scrollnote: Scroll Operation {
  style.fill: "#F4F6F7"
  style.border-radius: 6
  sn1: "memmove(VGA_BASE, VGA_BASE+80, 80×24×2)  — shift rows 1–24 → rows 0–23" {
    shape: text; style.font-size: 12; style.fill: "#EAECEE"; style.border-radius: 3
  }
  sn2: "memset(VGA_BASE + 24×80, blank_cell, 80×2)  — clear last row" {
    shape: text; style.font-size: 12; style.fill: "#EAECEE"; style.border-radius: 3
  }
  sn3: "Cost: 1920 uint16_t reads + 1920 writes + 80 writes = 3920 MMIO ops ≈ 784µs" {
    shape: text; style.font-size: 11; style.fill: "#D5D8DC"; style.border-radius: 3; style.italic: true
  }
}

base -> row0: "+0x000" {style.stroke: "#9B59B6"; style.stroke-width: 2; style.bold: true}
row0 -> row1: "+0x0A0\n(160 bytes)" {style.font-size: 11}
row1 -> rowmid: "+0x140" {style.font-size: 11}
rowmid -> row24: "+0xF00" {style.font-size: 11}
celldetail -> addrformula: "usage" {style.stroke-dash: 4; style.font-size: 11}
row0.c00 -> celldetail: "each cell" {style.stroke-dash: 5; style.font-size: 11}
row24.c2479 -> scrollnote: "triggers scroll\nwhen cursor here" {style.stroke-dash: 5; style.font-size: 11}