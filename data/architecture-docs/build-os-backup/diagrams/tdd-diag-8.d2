vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Module Architecture: Bootloader, Drivers, and Kernel Entry (mod-1)
| {near: top-center}

# ─────────────────────────────────────────────────────────────────
# PHYSICAL MEMORY / DISK LAYOUT
# ─────────────────────────────────────────────────────────────────

disk: "Disk Image (os.img)" {
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a8a"
  style.font-color: white
  style.border-radius: 6

  s0: "Sector 0\n[LBA 0]\n512 bytes\nStage1 MBR" {
    style.fill: "#6a0dad"
    style.font-color: white
    style.border-radius: 4
  }
  s1: "Sectors 1–8\n[LBA 1–8]\n4096 bytes\nStage2 Loader" {
    style.fill: "#7b2fbe"
    style.font-color: white
    style.border-radius: 4
  }
  s2: "Sectors 9–72\n[LBA 9–72]\n32768 bytes\nKernel Binary" {
    style.fill: "#2e86de"
    style.font-color: white
    style.border-radius: 4
  }

  s0 -> s1: "Stage1 loads\nINT 13h AH=02h\nCHS: C=0,H=0,S=2"
  s1 -> s2: "Stage2 loads\nINT 13h AH=02h\nor LBA ext 42h"
}

# ─────────────────────────────────────────────────────────────────
# PHYSICAL MEMORY MAP
# ─────────────────────────────────────────────────────────────────

phys_mem: "Physical Address Space" {
  style.fill: "#0d1b2a"
  style.stroke: "#2e86de"
  style.font-color: white
  style.border-radius: 6

  ivt: "0x00000000–0x000003FF\nReal-Mode IVT (1KB)" {
    style.fill: "#555555"
    style.font-color: "#cccccc"
    style.border-radius: 3
  }
  bda: "0x00000400–0x000004FF\nBIOS Data Area" {
    style.fill: "#555555"
    style.font-color: "#cccccc"
    style.border-radius: 3
  }
  mbr_load: "0x00007C00–0x00007DFF\nMBR Load Address (512B)\nStage1 executes here" {
    style.fill: "#6a0dad"
    style.font-color: white
    style.border-radius: 3
  }
  stage2_load: "0x00007E00–0x00009DFF\nStage2 Load (8 sectors = 4KB)" {
    style.fill: "#7b2fbe"
    style.font-color: white
    style.border-radius: 3
  }
  vga_text: "0x000B8000–0x000B8F9F\nVGA Text Buffer (4000B)\n80×25 cells, 2B each" {
    style.fill: "#e8a838"
    style.font-color: "#1a1a1a"
    style.border-radius: 3
  }
  bios_rom: "0x000C0000–0x000FFFFF\nBIOS ROM / Reserved" {
    style.fill: "#555555"
    style.font-color: "#cccccc"
    style.border-radius: 3
  }
  kernel_1mb: "0x00100000 (1MB)\nKernel Load Base\n.text / .rodata / .data / .bss" {
    style.fill: "#2e86de"
    style.font-color: white
    style.border-radius: 3
    style.bold: true
  }

  ivt -> bda -> mbr_load -> stage2_load -> vga_text -> bios_rom -> kernel_1mb: {
    style.opacity: 0
  }
}

# ─────────────────────────────────────────────────────────────────
# GDT STRUCTURE
# ─────────────────────────────────────────────────────────────────

gdt_box: "Global Descriptor Table (GDT)\n5 entries × 8 bytes = 40 bytes\nGDTR limit=39, base=physical addr" {
  style.fill: "#0a2342"
  style.stroke: "#2e86de"
  style.font-color: white
  style.border-radius: 6

  gdt0: "Index 0 | Sel 0x00\nNull Descriptor\nAccess=0x00 | 8 bytes" {
    style.fill: "#333355"
    style.font-color: "#aaaacc"
    style.border-radius: 3
  }
  gdt1: "Index 1 | Sel 0x08\nKernel Code (Ring 0)\nBase=0 Lim=4GB Access=0x9A Flags=0xCF" {
    style.fill: "#1a3a6b"
    style.font-color: white
    style.border-radius: 3
  }
  gdt2: "Index 2 | Sel 0x10\nKernel Data (Ring 0)\nBase=0 Lim=4GB Access=0x92 Flags=0xCF" {
    style.fill: "#1a3a6b"
    style.font-color: white
    style.border-radius: 3
  }
  gdt3: "Index 3 | Sel 0x18\nUser Code (Ring 3)\nBase=0 Lim=4GB Access=0xFA Flags=0xCF" {
    style.fill: "#1a4a4a"
    style.font-color: white
    style.border-radius: 3
  }
  gdt4: "Index 4 | Sel 0x20\nUser Data (Ring 3)\nBase=0 Lim=4GB Access=0xF2 Flags=0xCF" {
    style.fill: "#1a4a4a"
    style.font-color: white
    style.border-radius: 3
  }
}

# ─────────────────────────────────────────────────────────────────
# LINKER SCRIPT VIRTUAL ADDRESS LAYOUT
# ─────────────────────────────────────────────────────────────────

linker: "Kernel ELF Layout (kernel.elf)\nLinked at 0x00100000 (identity mapped)\nProduced by kernel.ld" {
  style.fill: "#0d2a1a"
  style.stroke: "#27ae60"
  style.font-color: white
  style.border-radius: 6

  sect_text: ".text\n0x00100000+\nCode: entry.asm + C files\nExecutable, read-only" {
    style.fill: "#145a32"
    style.font-color: white
    style.border-radius: 3
  }
  sect_rodata: ".rodata\nString literals, const arrays\nRead-only" {
    style.fill: "#1e6b3a"
    style.font-color: white
    style.border-radius: 3
  }
  sect_data: ".data\nInitialized globals\n(e.g., vga_state_t cursor pos)" {
    style.fill: "#1e6b3a"
    style.font-color: white
    style.border-radius: 3
  }
  sect_bss: ".bss  [__bss_start → __bss_end]\nUninitialised globals\nframe_bitmap(128KB) + stacks\nZeroed by entry.asm rep stosd" {
    style.fill: "#1a7a3a"
    style.font-color: white
    style.border-radius: 3
  }
  sect_stack: "Kernel Stack [__stack_top]\n16KB static in .bss\nESP set by entry.asm" {
    style.fill: "#0e8a50"
    style.font-color: white
    style.border-radius: 3
  }

  sect_text -> sect_rodata -> sect_data -> sect_bss -> sect_stack: {
    style.opacity: 0
  }
}

# ─────────────────────────────────────────────────────────────────
# VGA CELL FORMAT
# ─────────────────────────────────────────────────────────────────

vga_cell: "VGA Text Cell (2 bytes per cell)\n0xB8000 + row×160 + col×2" {
  style.fill: "#2a1a00"
  style.stroke: "#e8a838"
  style.font-color: white
  style.border-radius: 6

  char_byte: "Byte 0: ASCII char\n0x00–0xFF\ne.g. 0x4B = 'K'" {
    style.fill: "#5a3a00"
    style.font-color: white
    style.border-radius: 3
  }
  attr_byte: "Byte 1: Attribute\n[7]=blink [6:4]=bg [3:0]=fg\n0x0F = white-on-black" {
    style.fill: "#5a3a00"
    style.font-color: white
    style.border-radius: 3
  }
  cell_enc: "Encoding: (uint16_t)ch | (attr<<8)\nVGA_BASE[row*80+col] = cell\nvolatile uint16_t* required" {
    style.fill: "#7a5000"
    style.font-color: white
    style.border-radius: 3
  }
}

# ─────────────────────────────────────────────────────────────────
# COM1 UART REGISTER MAP
# ─────────────────────────────────────────────────────────────────

uart_box: "COM1 UART (16550) Port Map\nBase: 0x3F8  Baud: 38400/8N1\nDivisor = 1843200/16/38400 = 3" {
  style.fill: "#1a0a2e"
  style.stroke: "#8a2be2"
  style.font-color: white
  style.border-radius: 6

  u0: "+0 DLAB=0 W: THR Transmit\n+0 DLAB=0 R: RBR Receive\n+0 DLAB=1 R/W: DLL div low" {
    style.fill: "#3a1a5a"
    style.font-color: white
    style.border-radius: 3
  }
  u1: "+1 DLAB=0: IER Int Enable\n+1 DLAB=1: DLH div high\nInit: 0x00 (disable IRQs)" {
    style.fill: "#3a1a5a"
    style.font-color: white
    style.border-radius: 3
  }
  u3: "+3 LCR Line Control\nDLAB=bit7; 8N1=0x03\nInit seq: 0x80→0x03" {
    style.fill: "#3a1a5a"
    style.font-color: white
    style.border-radius: 3
  }
  u5: "+5 LSR Line Status\nbit5=THRE (tx ready)\nBusy-wait: (inb(0x3FD)&0x20)==0" {
    style.fill: "#3a1a5a"
    style.font-color: white
    style.border-radius: 3
  }
}

# ─────────────────────────────────────────────────────────────────
# BOOT FLOW SEQUENCE
# ─────────────────────────────────────────────────────────────────

flow: "Boot Execution Flow" {
  style.fill: "#0a0a1a"
  style.stroke: "#6666aa"
  style.font-color: white
  style.border-radius: 6

  bios: "BIOS Power-On\n0xFFFFFFF0 (ROM)\nPOST → find boot disk" {
    style.fill: "#333366"
    style.font-color: white
    style.border-radius: 4
  }
  stage1: "Stage1 MBR\n0x7C00 (512B)\nReal mode 16-bit\n• cli/sti/segment setup\n• INT 13h: load Stage2\n• jmp 0x7E00" {
    style.fill: "#6a0dad"
    style.font-color: white
    style.border-radius: 4
  }
  stage2: "Stage2 Bootloader\n0x7E00 (≤4KB)\nReal mode → protected\n• INT 15h A20 enable\n• Unreal mode kernel load\n• Build GDT table\n• cli; lgdt; CR0.PE=1\n• jmp 0x08:pm32" {
    style.fill: "#7b2fbe"
    style.font-color: white
    style.border-radius: 4
  }
  pm32: "Protected Mode Entry\n0x100000\n32-bit CS=0x08\n• DS/ES/FS/GS/SS = 0x10\n• ESP = __stack_top" {
    style.fill: "#1a3a8a"
    style.font-color: white
    style.border-radius: 4
  }
  entry_asm: "entry.asm\n[bits 32]\n• rep stosd BSS zero\n• call kmain" {
    style.fill: "#2e86de"
    style.font-color: white
    style.border-radius: 4
  }
  kmain_box: "kmain()\nC entry point\n• serial_init()\n• vga_init()\n• kprintf(\"Boot OK\")\n• for(;;) hlt" {
    style.fill: "#27ae60"
    style.font-color: white
    style.border-radius: 4
  }

  bios -> stage1: "Loads 512B\nto 0x7C00\nVerifies 0x55AA"
  stage1 -> stage2: "INT 13h\nAH=0x02 AL=8\nCHS C=0 H=0 S=2"
  stage2 -> pm32: "INT 13h kernel load\nlgdt → CR0.PE=1\njmp 0x08:0x100000"
  pm32 -> entry_asm: "Segment regs\nall loaded"
  entry_asm -> kmain_box: "BSS zeroed\nStack valid\ncall kmain"
}

# ─────────────────────────────────────────────────────────────────
# DRIVER INTERFACES
# ─────────────────────────────────────────────────────────────────

drivers: "Kernel Drivers (ring 0, no paging, no interrupts)" {
  style.fill: "#0d1f0d"
  style.stroke: "#27ae60"
  style.font-color: white
  style.border-radius: 6

  vga_drv: "VGA Driver (vga.c)\nvga_init() → vga_clear()\nvga_putchar(c,fg,bg)\nvga_scroll() copy rows 1-24→0-23\nvga_write_string(s,fg,bg)\nvolatile uint16_t* 0xB8000\nState: cursor_row, cursor_col" {
    style.fill: "#145a32"
    style.font-color: white
    style.border-radius: 4
  }
  serial_drv: "Serial Driver (serial.c)\nserial_init() 8 port writes\nserial_putchar(c) busy-wait THRE\nserial_write_string(s) CRLF\nBase 0x3F8 Baud 38400\nio_wait() between init writes" {
    style.fill: "#3a1a5a"
    style.font-color: white
    style.border-radius: 4
  }
  kprintf_drv: "kprintf (kprintf.c)\nFormats: %d %u %x %X %08x %s %c %%\n→ vga_putchar + serial_putchar\nInt-to-str: local 32-byte buf\nNULL %s → \"(null)\"" {
    style.fill: "#1a3a6b"
    style.font-color: white
    style.border-radius: 4
  }
  io_hdr: "Port I/O (io.h inline)\noutb(port,val): out %%al,%%dx\ninb(port)→val: in %%al,%%dx\nio_wait(): outb(0x80,0)\n\"memory\" clobber prevents reorder" {
    style.fill: "#2a2a00"
    style.font-color: white
    style.border-radius: 4
  }
}

# ─────────────────────────────────────────────────────────────────
# CONNECTIONS BETWEEN MAJOR GROUPS
# ─────────────────────────────────────────────────────────────────

disk -> flow.stage1: "BIOS reads\nSector 0"
phys_mem.kernel_1mb -> linker.sect_text: "Stage2 copies\nkernel binary here"
gdt_box -> flow.stage2: "lgdt loads GDTR\nbefore CR0.PE=1"
flow.kmain_box -> drivers.vga_drv: "calls vga_init()\nvga_clear()"
flow.kmain_box -> drivers.serial_drv: "calls serial_init()"
flow.kmain_box -> drivers.kprintf_drv: "calls kprintf()\n\"Boot OK\""
drivers.vga_drv -> vga_cell: "writes uint16_t\nto 0xB8000"
drivers.serial_drv -> uart_box: "outb/inb\nport 0x3F8–0x3FD"
drivers.kprintf_drv -> drivers.vga_drv: "vga_putchar()"
drivers.kprintf_drv -> drivers.serial_drv: "serial_putchar()"
linker.sect_bss -> flow.entry_asm: "__bss_start/__bss_end\nrep stosd zeroing"

# Size annotations
size_note: |md
  **Memory Sizes**
  - GDT: 5 × 8 = 40 bytes
  - GDTR: 6 bytes (limit=39, base)
  - VGA buffer: 80×25×2 = 4000 bytes
  - Kernel stack: 16384 bytes (16KB)
  - frame_bitmap: 131072 bytes (128KB)
  - process_table[16]: 66432 bytes (~65KB)
  - sizeof(vga_state_t): 12 bytes
  - sizeof(idtr_t): 6 bytes (mod-2)
| {near: bottom-center}