vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    usable: "#ACE1AF"
    reserved: "#F5B7B1"
    acpi: "#F9E79F"
    mmio: "#D7BDE2"
    kernel: "#85C1E9"
    bios: "#FADBD8"
    legend-text: "#5D6D7E"
  }
}
title: |md
  # E820 Memory Map: Physical Memory Layout
  **BIOS-provided memory regions at boot time**
| {near: top-center}
direction: right
memory_map: {
  label: "Physical Address Space (0x00000000 - 0xFFFFFFFF)"
  style.fill: white
  style.stroke: "#34495E"
  style.stroke-width: 3
  # Region 0: Conventional Low Memory
  low_mem: {
    label: |md
      **Conventional Memory**
      `0x00000000 - 0x0009FFFF`
      640 KB - Usable
    |
    style.fill: ${colors.usable}
    style.stroke: "#27AE60"
    width: 180
    height: 80
  }
  # Region 1: BIOS Data Area + Video Memory
  bios_video: {
    label: |md
      **BIOS Data + Video RAM**
      `0x000A0000 - 0x000FFFFF`
      384 KB - Reserved
    |
    style.fill: ${colors.reserved}
    style.stroke: "#C0392B"
    width: 180
    height: 80
  }
  # Region 2: Extended Memory (Main RAM)
  extended: {
    label: |md
      **Extended Memory**
      `0x00100000 - 0x7FFEFFFF`
      ~2 GB - Usable
      ─────────────────────
      Kernel: 0x100000-0x200000
      Frame Bitmap: ~32KB
      User Memory: Remainder
    |
    style.fill: ${colors.usable}
    style.stroke: "#27AE60"
    width: 180
    height: 200
  }
  # Region 3: ACPI Tables
  acpi: {
    label: |md
      **ACPI Tables**
      `0x7FF00000 - 0x7FFFFFFF`
      1 MB - ACPI NVS
    |
    style.fill: ${colors.acpi}
    style.stroke: "#D4AC0D"
    width: 180
    height: 60
  }
  # Region 4: MMIO Gap
  mmio: {
    label: |md
      **Memory-Mapped I/O**
      `0x80000000 - 0xDFFFFFFF`
      ~1.5 GB - Reserved
      PCI devices, APIC,
      Graphics memory
    |
    style.fill: ${colors.mmio}
    style.stroke: "#8E44AD"
    width: 180
    height: 140
  }
  # Region 5: BIOS ROM
  bios_rom: {
    label: |md
      **BIOS ROM**
      `0xE0000000 - 0xFFFFFFFF`
      512 MB - Reserved
    |
    style.fill: ${colors.reserved}
    style.stroke: "#C0392B"
    width: 180
    height: 60
  }
}
# Legend
legend: {
  near: top-right
  style.fill: white
  style.stroke: "#BDC3C7"
  style.stroke-dash: 2
  leg_title: "Memory Region Types" {
    style.bold: true
    style.font-size: 14
  }
  leg_usable: "■ Usable RAM" {
    style.font-color: ${colors.legend-text}
  }
  leg_usable.style.fill: ${colors.usable}
  leg_reserved: "■ Reserved (BIOS/MMIO)" {
    style.font-color: ${colors.legend-text}
  }
  leg_reserved.style.fill: ${colors.reserved}
  leg_acpi: "■ ACPI Tables" {
    style.font-color: ${colors.legend-text}
  }
  leg_acpi.style.fill: ${colors.acpi}
  leg_kernel: "■ Kernel Space" {
    style.font-color: ${colors.legend-text}
  }
  leg_kernel.style.fill: ${colors.kernel}
}
# E820 Entry Structure
e820_struct: {
  label: "E820 Entry Structure"
  shape: class
  base: uint64_t
  length: uint64_t
  type: uint32_t
  acpi_attrs: uint32_t
}
# Type values
type_values: {
  label: |md
    **Type Values:**
    1 = Usable RAM
    2 = Reserved
    3 = ACPI Reclaimable
    4 = ACPI NVS (preserve)
    5 = Unusable (defective)
  |
  shape: rectangle
  style.fill: "#F8F9F9"
  style.stroke: "#BDC3C7"
}
# Critical note
critical: {
  near: bottom-center
  label: |md
    ⚠️ **CRITICAL:** Kernel MUST parse this map before allocating frames!
    Allocating from reserved regions corrupts:
    • BIOS data structures → unpredictable boot failures
    • ACPI tables → power management breaks
    • MMIO regions → hardware malfunction
  |
  shape: rectangle
  style.fill: "#FDEDEC"
  style.stroke: "#E74C3C"
  style.stroke-width: 2
  width: 600
}
# Allocation flow
flow: {
  direction: right
  near: bottom-center
  bios: "BIOS INT 0x15\nAX=0xE820" {
    shape: oval
    style.fill: ${colors.acpi}
  }
  parser: "Kernel\nParser" {
    shape: rectangle
    style.fill: ${colors.kernel}
  }
  bitmap: "Frame\nBitmap" {
    shape: cylinder
    style.fill: ${colors.usable}
  }
  alloc: "frame_alloc()" {
    shape: rectangle
    style.fill: "#82E0AA"
  }
  bios -> parser: "Memory map\nentries"
  parser -> bitmap: "Mark usable\nframes free"
  bitmap -> alloc: "Scan for\nfree bit"
}
# Detail of low memory
low_detail: {
  label: |md
    **Low Memory Detail:**
    0x0000 - 0x03FF: IVT (1KB)
    0x0400 - 0x04FF: BDA (256B)
    0x0500 - 0x7BFF: Free (~30KB)
    0x7C00 - 0x7DFF: Bootloader (512B)
    0x7E00 - 0x9FFF: Free (~8KB)
  |
  shape: rectangle
  style.fill: "#EBF5FB"
  style.stroke: "#5DADE2"
  width: 200
}
# Example multiboot parsing
parse_code: {
  label: |md
    **Parsing from Multiboot:**
    c
    struct mmap_entry {
      uint64_t base;
      uint64_t length;
      uint32_t type;
    };
    // Iterate entries
    for (each entry) {
      if (type == USABLE) {
        mark_frames_free(
          base, length);
      }
    }
    
  |
  shape: rectangle
  style.fill: "#F4F6F6"
  style.stroke: "#99A3A4"
  style.font: mono
  width: 220
}
# Connect related elements for layout
e820_struct -> type_values: "defines"
memory_map -> e820_struct: "parsed by"
low_detail -> memory_map.low_mem
parse_code -> memory_map.extended