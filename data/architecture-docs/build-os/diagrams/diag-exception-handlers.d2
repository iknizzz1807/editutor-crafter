vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # CPU Exception Vectors 0-31
  Reference: x86 Protected Mode Exception Handling
| {near: top-center}
classes: {
  exception: {
    shape: rectangle
    style: {
      fill: "#E8E8E8"
      stroke: "#666666"
      stroke-width: 2
      border-radius: 4
    }
  }
  fatal: {
    style: {
      fill: "#FFE4E1"
      stroke: "#DC143C"
    }
  }
  debug: {
    style: {
      fill: "#E0FFFF"
      stroke: "#008B8B"
    }
  }
  memory: {
    style: {
      fill: "#FFF8DC"
      stroke: "#DAA520"
    }
  }
  fpu: {
    style: {
      fill: "#E6E6FA"
      stroke: "#9370DB"
    }
  }
  reserved: {
    style: {
      fill: "#F5F5F5"
      stroke: "#A9A9A9"
      stroke-dash: 3
    }
  }
  error_code: {
    shape: circle
    width: 28
    height: 28
    style: {
      fill: "#FF6B6B"
      stroke: "#8B0000"
      font-color: white
      font-size: 18
      bold: true
    }
  }
  no_error: {
    shape: circle
    width: 28
    height: 28
    style: {
      fill: "#90EE90"
      stroke: "#228B22"
      font-color: white
      font-size: 18
      bold: true
    }
  }
  vector_num: {
    style: {
      font: mono
      font-size: 14
      font-color: "#444444"
    }
  }
}
legend: {
  near: top-right
  legend_title: Error Code Legend {
    style.fill: white
    style.stroke: "#333"
  }
  ec: "E" {class: error_code}
  ec_label: "CPU pushes error code" {style.font-size: 12}
  ec -> ec_label
  ne: "-" {class: no_error}
  ne_label: "No error code pushed" {style.font-size: 12}
  ne -> ne_label
  style_note: |md
    **Color Categories:**
    ðŸ”´ Fatal/System Critical
    ðŸ”µ Debug/Trap  
    ðŸŸ¡ Memory/Segmentation
    ðŸŸ£ FPU/SIMD
    âšª Reserved/Unknown
  | {shape: text}
}
exceptions: {
  grid-columns: 4
  grid-gap: 8
  v0: {
    class: [exception; debug]
    label: "#0: Divide Error\n(DE)"
    desc: "`div`/`idiv` by zero\nor quotient overflow"
    ec0: "-" {class: no_error; near: top-right}
  }
  v1: {
    class: [exception; debug]
    label: "#1: Debug\n(DB)"
    desc: "Debug trap or\nbreakpoint condition"
    ec1: "-" {class: no_error; near: top-right}
  }
  v2: {
    class: [exception; fatal]
    label: "#2: NMI\n(Non-Maskable)"
    desc: "Hardware emergency\nsignal (mask ignored)"
    ec2: "-" {class: no_error; near: top-right}
  }
  v3: {
    class: [exception; debug]
    label: "#3: Breakpoint\n(BP)"
    desc: "`int3` instruction\n(0xCC opcode)"
    ec3: "-" {class: no_error; near: top-right}
  }
  v4: {
    class: [exception; debug]
    label: "#4: Overflow\n(OF)"
    desc: "`into` with\nOF flag set"
    ec4: "-" {class: no_error; near: top-right}
  }
  v5: {
    class: [exception; memory]
    label: "#5: BOUNDS\n(BR)"
    desc: "`bound` range\ncheck failed"
    ec5: "-" {class: no_error; near: top-right}
  }
  v6: {
    class: [exception; fatal]
    label: "#6: Invalid Opcode\n(UD)"
    desc: "Undefined opcode\nor UD2 instruction"
    ec6: "-" {class: no_error; near: top-right}
  }
  v7: {
    class: [exception; fpu]
    label: "#7: Device Not Avail\n(NM)"
    desc: "FPU instruction\nwith TS/EM set"
    ec7: "-" {class: no_error; near: top-right}
  }
  v8: {
    class: [exception; fatal]
    label: "#8: Double Fault\n(DF)"
    desc: "Exception during\nexception handling"
    ec8: "E" {class: error_code; near: top-right}
  }
  v9: {
    class: [exception; reserved]
    label: "#9: Coprocessor\nSegment Overrun"
    desc: "FPU segment limit\n(386 only, reserved)"
    ec9: "-" {class: no_error; near: top-right}
  }
  v10: {
    class: [exception; memory]
    label: "#10: Invalid TSS\n(TS)"
    desc: "Task switch with\ninvalid TSS"
    ec10: "E" {class: error_code; near: top-right}
  }
  v11: {
    class: [exception; memory]
    label: "#11: Segment Not\nPresent (NP)"
    desc: "Load segment with\nP=0 in descriptor"
    ec11: "E" {class: error_code; near: top-right}
  }
  v12: {
    class: [exception; memory]
    label: "#12: Stack Segment\n(SS)"
    desc: "Stack op with\nSS limit violation"
    ec12: "E" {class: error_code; near: top-right}
  }
  v13: {
    class: [exception; fatal]
    label: "#13: General\nProtection (GP)"
    desc: "Protection violation\n(not covered above)"
    ec13: "E" {class: error_code; near: top-right}
  }
  v14: {
    class: [exception; memory]
    label: "#14: Page Fault\n(PF)"
    desc: "Page not present or\nprotection violation"
    ec14: "E" {class: error_code; near: top-right}
  }
  v15: {
    class: [exception; reserved]
    label: "#15: Reserved"
    desc: "(Not used by CPU)"
    ec15: "-" {class: no_error; near: top-right}
  }
  v16: {
    class: [exception; fpu]
    label: "#16: x87 FPU Error\n(MF)"
    desc: "Unmasked x87 FPU\nexception pending"
    ec16: "-" {class: no_error; near: top-right}
  }
  v17: {
    class: [exception; memory]
    label: "#17: Alignment\nCheck (AC)"
    desc: "Misaligned access\nwith AC flag set"
    ec17: "E" {class: error_code; near: top-right}
  }
  v18: {
    class: [exception; fatal]
    label: "#18: Machine Check\n(MC)"
    desc: "CPU internal error\n(abort - unrecoverable)"
    ec18: "-" {class: no_error; near: top-right}
  }
  v19: {
    class: [exception; fpu]
    label: "#19: SIMD Floating\nPoint (XF)"
    desc: "SSE/AVX exception\n(unmasked)"
    ec19: "-" {class: no_error; near: top-right}
  }
  v20: {
    class: [exception; reserved]
    label: "#20: Virtualization\nException (VE)"
    desc: "EPT violation with\nVE enabled (Intel VT-x)"
    ec20: "-" {class: no_error; near: top-right}
  }
  v21: {
    class: [exception; reserved]
    label: "#21: Control\nProtection (CP)"
    desc: "CET shadow stack\nviolation"
    ec21: "E" {class: error_code; near: top-right}
  }
  v22: {
    class: [exception; reserved]
    label: "#22: Reserved"
    desc: "(Not used by CPU)"
    ec22: "-" {class: no_error; near: top-right}
  }
  v23: {
    class: [exception; reserved]
    label: "#23: Reserved"
    desc: "(Not used by CPU)"
    ec23: "-" {class: no_error; near: top-right}
  }
  v24: {
    class: [exception; reserved]
    label: "#24: Reserved"
    desc: "(Not used by CPU)"
    ec24: "-" {class: no_error; near: top-right}
  }
  v25: {
    class: [exception; reserved]
    label: "#25: Reserved"
    desc: "(Not used by CPU)"
    ec25: "-" {class: no_error; near: top-right}
  }
  v26: {
    class: [exception; reserved]
    label: "#26: Reserved"
    desc: "(Not used by CPU)"
    ec26: "-" {class: no_error; near: top-right}
  }
  v27: {
    class: [exception; reserved]
    label: "#27: Reserved"
    desc: "(Not used by CPU)"
    ec27: "-" {class: no_error; near: top-right}
  }
  v28: {
    class: [exception; reserved]
    label: "#28: Hypervisor\nInjection (HV)"
    desc: "VMM injected event\n(Intel VT-x)"
    ec28: "-" {class: no_error; near: top-right}
  }
  v29: {
    class: [exception; reserved]
    label: "#29: VMM\nCommunication (VC)"
    desc: "SEV-SNP VC handler\ninvoked"
    ec29: "E" {class: error_code; near: top-right}
  }
  v30: {
    class: [exception; reserved]
    label: "#30: Security\nException (SX)"
    desc: "Security exception\n(SEV-SNP / TDX)"
    ec30: "E" {class: error_code; near: top-right}
  }
  v31: {
    class: [exception; reserved]
    label: "#31: Reserved"
    desc: "(Not used by CPU)"
    ec31: "-" {class: no_error; near: top-right}
  }
}
error_code_structure: {
  near: bottom-center
  title: Page Fault Error Code (Exception #14) {
    style: {
      fill: "#FFF8DC"
      stroke: "#DAA520"
      border-radius: 4
    }
  }
  bits: {
    grid-columns: 5
    grid-gap: 0
    b0: "0" {style.fill: "#FFB6C1"; style.stroke: "#8B0000"; width: 40}
    b1: "1" {style.fill: "#FFB6C1"; style.stroke: "#8B0000"; width: 40}
    b2: "2" {style.fill: "#FFB6C1"; style.stroke: "#8B0000"; width: 40}
    b3: "3" {style.fill: "#DDA0DD"; style.stroke: "#4B0082"; width: 40}
    b4: "4" {style.fill: "#DDA0DD"; style.stroke: "#4B0082"; width: 40}
    l0: "P" {style.fill: "#FFB6C1"; style.stroke: "#8B0000"; width: 40; style.font-size: 12}
    l1: "W" {style.fill: "#FFB6C1"; style.stroke: "#8B0000"; width: 40; style.font-size: 12}
    l2: "U" {style.fill: "#FFB6C1"; style.stroke: "#8B0000"; width: 40; style.font-size: 12}
    l3: "R" {style.fill: "#DDA0DD"; style.stroke: "#4B0082"; width: 40; style.font-size: 12}
    l4: "I" {style.fill: "#DDA0DD"; style.stroke: "#4B0082"; width: 40; style.font-size: 12}
  }
  legend_bits: |md
    **Bit 0 (P):** 0=Page not present, 1=Protection violation
    **Bit 1 (W):** 0=Read access, 1=Write access
    **Bit 2 (U):** 0=Kernel mode, 1=User mode
    **Bit 3 (R):** 1=Reserved bit set in PTE
    **Bit 4 (I):** 1=Instruction fetch (NX violation)
  | {shape: text; style.font-size: 11}
}
stack_frame: {
  near: bottom-right
  title: Exception Stack Frame (no privilege change) {
    style: {
      fill: "#F0F8FF"
      stroke: "#4169E1"
      border-radius: 4
    }
  }
  frame: {
    grid-columns: 2
    grid-gap: 2
    offset_hi: "+12" {style.font: mono; style.font-size: 11; style.fill: white}
    eip_val: "EIP" {style.fill: "#98FB98"; style.stroke: "#228B22"; style.font-size: 12}
    offset_8: "+8" {style.font: mono; style.font-size: 11; style.fill: white}
    cs_val: "CS" {style.fill: "#98FB98"; style.stroke: "#228B22"; style.font-size: 12}
    offset_4: "+4" {style.font: mono; style.font-size: 11; style.fill: white}
    eflags_val: "EFLAGS" {style.fill: "#98FB98"; style.stroke: "#228B22"; style.font-size: 12}
    offset_0: "+0" {style.font: mono; style.font-size: 11; style.fill: white}
    err_val: "Error Code*" {style.fill: "#FFB6C1"; style.stroke: "#8B0000"; style.font-size: 12}
    note: |md
      *Only pushed for exceptions
      8, 10-14, 17, 21, 29-30
    | {shape: text; style.font-size: 10}
  }
  note2: "ESP points here after CPU push" {shape: text; style.font-size: 10; style.font-color: "#666"}
}
handler_flow: {
  near: bottom-left
  title: Exception Handler Sequence {
    style: {
      fill: "#F5F5DC"
      stroke: "#8B4513"
      border-radius: 4
    }
  }
  step1: "1. CPU completes current instruction" {shape: text}
  step2: "2. CPU pushes EFLAGS, CS, EIP" {shape: text}
  step3: "3. CPU pushes error code (if applicable)" {shape: text}
  step4: "4. CPU looks up IDT[vector]" {shape: text}
  step5: "5. CPU loads CS:EIP from IDT entry" {shape: text}
  step6: "6. Handler executes (save registers)" {shape: text}
  step7: "7. Handler processes exception" {shape: text}
  step8: "8. Handler restores registers" {shape: text}
  step9: "9. `iret` restores EIP, CS, EFLAGS" {shape: text}
  step1 -> step2 -> step3 -> step4 -> step5 -> step6 -> step7 -> step8 -> step9: {
    style: {
      stroke: "#8B4513"
      stroke-width: 2
      animated: true
    }
  }
}