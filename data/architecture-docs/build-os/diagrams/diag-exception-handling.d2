vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # CPU Exception Flow: Divide Error to Handler
  Complete interrupt path from fault to recovery
| {near: top-center}

direction: right

classes: {
  hardware: {
    style: {
      fill: "#FFE6E6"
      stroke: "#CC0000"
      stroke-width: 2
    }
  }
  cpu_action: {
    style: {
      fill: "#FFF9C4"
      stroke: "#F57C00"
      stroke-width: 2
    }
  }
  memory: {
    style: {
      fill: "#E3F2FD"
      stroke: "#1976D2"
      stroke-width: 2
    }
  }
  handler: {
    style: {
      fill: "#E8F5E9"
      stroke: "#388E3C"
      stroke-width: 2
    }
  }
  stack_frame: {
    style: {
      fill: "#F3E5F5"
      stroke: "#7B1FA2"
      stroke-width: 2
      font: mono
    }
  }
  annotation: {
    style: {
      fill: "#FFFDE7"
      stroke: "#FFA000"
      stroke-dash: 3
      border-radius: 8
    }
  }
}

divider_hw: |md
  **HARDWARE**
| {near: top-left}
divider_cpu: |md
  **CPU ACTIONS**
| {near: top-left}
divider_mem: |md
  **MEMORY**
| {near: top-left}

Divide_Instruction: "DIV EBX\n(EDX:EAX / EBX)" {
  class: hardware
  tooltip: "Division instruction executing"
  link: "#exception-0-divide-error"
}

Page_Fault_Access: "MOV [0xDEADBEEF], EAX\n(virtual address 0xDEADBEEF)" {
  class: hardware
  tooltip: "Memory access to unmapped page"
  link: "#exception-14-page-fault"
}

CPU_Detector: "Exception Detector" {
  class: hardware
  label: ||md
    **Exception Detector**
    - Checks divisor = 0
    - Checks PTE present bit
    - Checks privilege levels
  ||
}

IDT_Lookup: "IDT Gate Lookup" {
  class: cpu_action
  label: ||md
    **IDT Gate Lookup**
    1. Read IDTR for base
    2. Index: vector × 8
    3. Read 8-byte gate
  ||
}

Gate_Descriptor: "Gate Descriptor (8 bytes)" {
  class: memory
  label: ||md
    **Gate Descriptor (8 bytes)**
    
    | Offset | Field        |
    |--------|--------------|
    | +0     | offset_low   |
    | +2     | selector     |
    | +4     | zero         |
    | +5     | type_attr    |
    | +6     | offset_high  |
    
    selector: 0x08 (kernel CS)
    type_attr: 0x8E (32-bit int gate)
  ||
}

Annotation_IDT: ||md
  **IDT Entry Structure**
  - Offset Low: bits 0-15 of handler
  - Selector: code segment (0x08)
  - Type/Attr: 0x8E = 32-bit int gate
  - Offset High: bits 16-31 of handler
|| {near: top-right; class: annotation}

Stack_Before: "Stack Before Exception" {
  class: stack_frame
  label: ||md
    ESP → [local vars]
          [return addr]
          [caller rbp]
  ||
}

Stack_After_Div0: "Stack After Exception 0" {
  class: stack_frame
  label: ||md
    ESP → [EFLAGS]     ← pushed
          [CS=0x08]    ← pushed
          [EIP]        ← pushed
    [local vars]
    [return addr]
    
    **No error code for DIV**
  ||
}

Stack_After_PF: "Stack After Exception 14" {
  class: stack_frame
  label: ||md
    ESP → [Error Code] ← pushed (bits: P,W/U,Rsvd)
          [EFLAGS]     ← pushed
          [CS=0x08]    ← pushed
          [EIP]        ← pushed
    
    **CR2 = 0xDEADBEEF**
  ||
}

Annotation_ErrorCode: ||md
  **Error Code (Page Fault)**
  - Bit 0 (P): 0=not present
  - Bit 1 (W): 0=read, 1=write
  - Bit 2 (U): 0=kernel, 1=user
  - Bit 3: reserved bit set
  - Bit 4: instruction fetch
|| {near: bottom-left; class: annotation}

CR2_Register: "CR2 Register" {
  class: cpu_action
  label: ||md
    **CR2 Register**
    Holds faulting address
    (Page Fault only)
    Value: 0xDEADBEEF
  ||
}

Handler_Entry: "Exception Handler Entry" {
  class: handler
  label: ||md
    **Handler Entry (asm)**
    asm
    isr0:
      cli
      push byte 0    ; dummy err
      push byte 0    ; vector
      jmp isr_common
    
  ||
}

Handler_Entry_PF: "Page Fault Entry" {
  class: handler
  label: ||md
    **Handler Entry (asm)**
    asm
    isr14:
      cli
      push byte 14   ; vector
      jmp isr_common ; err on stack
    
  ||
}

Common_Stub: "Common ISR Stub" {
  class: handler
  label: ||md
    **Common ISR Stub**
    asm
    isr_common:
      pusha           ; save all GP
      push ds/es/fs/gs
      mov ax, 0x10
      mov ds, ax      ; kernel seg
      push esp
      call c_handler
    
  ||
}

C_Handler: "C Handler Function" {
  class: handler
  label: ||md
    **C Handler Functions**
    c
    void c_interrupt_handler(regs_t *regs);
    void exception_handler(regs_t *regs);
    void irq_handler(regs_t *regs);
    
  ||
}

Diagnostic_Output: "Diagnostic Output" {
  class: handler
  label: ||md
    EXCEPTION: Division by zero
    Vector: 0
    EIP: 0xC0102042
    CS: 0x08
    EFLAGS: 0x202
  ||
}

Diagnostic_PF: "Page Fault Diagnostic" {
  class: handler
  label: ||md
    PAGE FAULT
    Faulting addr: 0xDEADBEEF
    Error code: 0x04
    Reason: User access to kernel page
    EIP: 0x00001234
  ||
}

Restore_Context: "Context Restoration" {
  class: handler
  label: ||md
    **Restore & Return**
    asm
      pop gs/fs/es/ds
      popa
      add esp, 8    ; err + vec
      iret          ; restore all
    
  ||
}

Annotation_iret: ||md
  **IRET Instruction**
  Pops EIP, CS, EFLAGS
  If RPL(CS)=3: also pops ESP, SS
  Restores interrupt flag from EFLAGS.IF
|| {near: bottom-right; class: annotation}

Resume_Execution: "Resume Execution" {
  class: hardware
  label: ||md
    **Execution Resumes**
    - EIP restored
    - CS restored
    - EFLAGS restored
    - IF restored (interrupts)
  ||
}

Legend: {
  near: bottom-center
  hardware_legend: "Pink = Hardware/Fault Source" {class: hardware}
  cpu_legend: "Yellow = CPU Actions" {class: cpu_action}
  memory_legend: "Blue = Memory Structures" {class: memory}
  handler_legend: "Green = Handler Code" {class: handler}
  stack_legend: "Purple = Stack Frames" {class: stack_frame}
}

Divide_Instruction -> CPU_Detector: "divisor = 0\ndetected\n(Exception 0)" {
  style.stroke: "#CC0000"
  style.stroke-width: 3
}

Page_Fault_Access -> CPU_Detector: "PTE.P = 0\ndetected\n(Exception 14)" {
  style.stroke: "#CC0000"
  style.stroke-width: 3
  style.stroke-dash: 5
}

CPU_Detector -> IDT_Lookup: "vector 0 or 14\npush EIP,CS,EFLAGS" {
  style.stroke: "#F57C00"
  style.stroke-width: 2
}

IDT_Lookup -> Gate_Descriptor: "read 8 bytes\nfrom IDT[vec×8]" {
  style.stroke: "#1976D2"
  style.stroke-width: 2
}

Gate_Descriptor -> Handler_Entry: "load CS:EIP\n(0x08:handler_addr)\nException 0 path" {
  style.stroke: "#388E3C"
  style.stroke-width: 2
}

Gate_Descriptor -> Handler_Entry_PF: "load CS:EIP\n(0x08:handler_addr)\nException 14 path" {
  style.stroke: "#388E3C"
  style.stroke-width: 2
  style.stroke-dash: 5
}

Stack_Before -> Stack_After_Div0: "CPU pushes\n3 values" {
  style.stroke: "#7B1FA2"
  style.stroke-width: 2
}

Stack_Before -> Stack_After_PF: "CPU pushes\n4 values" {
  style.stroke: "#7B1FA2"
  style.stroke-width: 2
  style.stroke-dash: 5
}

Page_Fault_Access -> CR2_Register: "CPU stores\nfaulting addr" {
  style.stroke: "#F57C00"
  style.stroke-dash: 5
}

Handler_Entry -> Common_Stub: "jmp" {
  style.stroke: "#388E3C"
}

Handler_Entry_PF -> Common_Stub: "jmp" {
  style.stroke: "#388E3C"
  style.stroke-dash: 5
}

Common_Stub -> C_Handler: "call" {
  style.stroke: "#388E3C"
  style.stroke-width: 2
}

C_Handler -> Diagnostic_Output: "kprintf()\nfor vector 0" {
  style.stroke: "#388E3C"
}

C_Handler -> Diagnostic_PF: "kprintf()\nfor vector 14" {
  style.stroke: "#388E3C"
  style.stroke-dash: 5
}

C_Handler -> Restore_Context: "return" {
  style.stroke: "#388E3C"
  style.stroke-width: 2
}

CR2_Register -> C_Handler: "read CR2\nin handler" {
  style.stroke: "#F57C00"
  style.stroke-dash: 5
}

Restore_Context -> Resume_Execution: "iret" {
  style.stroke: "#388E3C"
  style.stroke-width: 3
}

Stack_After_Div0 -> Common_Stub: "ESP passed\nto handler" {
  style.stroke: "#7B1FA2"
  style.animated: true
}

Stack_After_PF -> Common_Stub: "ESP passed\nto handler" {
  style.stroke: "#7B1FA2"
  style.stroke-dash: 5
  style.animated: true
}

Gate_Descriptor -- Annotation_IDT: "documents" {
  style.stroke-dash: 3
  style.opacity: 0.5
}

Stack_After_PF -- Annotation_ErrorCode: "documents" {
  style.stroke-dash: 3
  style.opacity: 0.5
}

Restore_Context -- Annotation_iret: "documents" {
  style.stroke-dash: 3
  style.opacity: 0.5
}