vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#4A5568"
    critical: "#E53E3E"
    error_code: "#805AD5"
    highlight: "#DD6B20"
    normal: "#38A169"
    selector: "#3182CE"
  }
}

title: |md
  # CPU Exception Vectors & Error Codes
  x86 Protected Mode (IDT Vector 0-31)
| {near: top-center}

legend: {
  near: top-right
  EC: Error Code Pushed {
    shape: text
    style.font-color: ${colors.error_code}
  }
  NO: No Error Code {
    shape: text
    style.font-color: ${colors.normal}
  }
  FAULT: Fault (can recover) {
    shape: text
    style.font-color: ${colors.normal}
  }
  ABORT: Abort (fatal) {
    shape: text
    style.font-color: ${colors.critical}
  }
  TRAP: Trap (after instruction) {
    shape: text
    style.font-color: ${colors.highlight}
  }
}

vectors: {
  grid-columns: 4
  grid-gap: 0
  
  # Header row
  h_vec: "Vector" {class: header}
  h_name: "Name" {class: header}
  h_type: "Type" {class: header}
  h_ec: "Error Code" {class: header}
  
  # Vector 0 - HIGHLIGHTED
  v0: "0 (0x00)" {
    style.fill: ${colors.highlight}
    style.stroke: ${colors.critical}
    style.stroke-width: 3
  }
  v0_name: "#DE Divide Error" {
    style.fill: ${colors.highlight}
    style.font-color: white
  }
  v0_type: FAULT {
    style.fill: ${colors.highlight}
  }
  v0_ec: NO {
    style.fill: "#FFF5F5"
    style.font-color: ${colors.normal}
  }
  
  # Vector 1
  v1: "1 (0x01)" {class: normal_row}
  v1_name: "#DB Debug" {class: normal_row}
  v1_type: FAULT/TRAP {class: normal_row}
  v1_ec: NO {class: no_ec}
  
  # Vector 2
  v2: "2 (0x02)" {class: normal_row}
  v2_name: "NMI Interrupt" {class: normal_row}
  v2_type: INTERRUPT {class: normal_row}
  v2_ec: NO {class: no_ec}
  
  # Vector 3
  v3: "3 (0x03)" {class: normal_row}
  v3_name: "#BP Breakpoint" {class: normal_row}
  v3_type: TRAP {class: normal_row}
  v3_ec: NO {class: no_ec}
  
  # Vector 4
  v4: "4 (0x04)" {class: normal_row}
  v4_name: "#OF Overflow" {class: normal_row}
  v4_type: TRAP {class: normal_row}
  v4_ec: NO {class: no_ec}
  
  # Vector 5
  v5: "5 (0x05)" {class: normal_row}
  v5_name: "#BR BOUND Range" {class: normal_row}
  v5_type: FAULT {class: normal_row}
  v5_ec: NO {class: no_ec}
  
  # Vector 6
  v6: "6 (0x06)" {class: normal_row}
  v6_name: "#UD Invalid Opcode" {class: normal_row}
  v6_type: FAULT {class: normal_row}
  v6_ec: NO {class: no_ec}
  
  # Vector 7
  v7: "7 (0x07)" {class: normal_row}
  v7_name: "#NM Device Not Avail" {class: normal_row}
  v7_type: FAULT {class: normal_row}
  v7_ec: NO {class: no_ec}
  
  # Vector 8 - HIGHLIGHTED (Double Fault)
  v8: "8 (0x08)" {
    style.fill: ${colors.critical}
    style.stroke: "#742A2A"
    style.stroke-width: 3
  }
  v8_name: "#DF Double Fault" {
    style.fill: ${colors.critical}
    style.font-color: white
  }
  v8_type: ABORT {
    style.fill: ${colors.critical}
    style.font-color: white
  }
  v8_ec: "YES (0)" {
    style.fill: "#FED7D7"
    style.font-color: ${colors.error_code}
    style.bold: true
  }
  
  # Vector 9
  v9: "9 (0x09)" {class: normal_row}
  v9_name: "#MF Coprocessor Seg" {class: normal_row}
  v9_type: FAULT {class: normal_row}
  v9_ec: NO {class: no_ec}
  
  # Vector 10
  v10: "10 (0x0A)" {class: normal_row}
  v10_name: "#TS Invalid TSS" {class: normal_row}
  v10_type: FAULT {class: normal_row}
  v10_ec: "YES" {class: yes_ec}
  
  # Vector 11
  v11: "11 (0x0B)" {class: normal_row}
  v11_name: "#NP Segment Not Pres" {class: normal_row}
  v11_type: FAULT {class: normal_row}
  v11_ec: "YES" {class: yes_ec}
  
  # Vector 12
  v12: "12 (0x0C)" {class: normal_row}
  v12_name: "#SS Stack Segment" {class: normal_row}
  v12_type: FAULT {class: normal_row}
  v12_ec: "YES" {class: yes_ec}
  
  # Vector 13 - HIGHLIGHTED (GPF)
  v13: "13 (0x0D)" {
    style.fill: ${colors.highlight}
    style.stroke: ${colors.critical}
    style.stroke-width: 3
  }
  v13_name: "#GP General Protect" {
    style.fill: ${colors.highlight}
    style.font-color: white
  }
  v13_type: FAULT {
    style.fill: ${colors.highlight}
  }
  v13_ec: "YES" {
    style.fill: "#FED7D7"
    style.font-color: ${colors.error_code}
    style.bold: true
  }
  
  # Vector 14 - HIGHLIGHTED (Page Fault)
  v14: "14 (0x0E)" {
    style.fill: ${colors.highlight}
    style.stroke: ${colors.critical}
    style.stroke-width: 3
  }
  v14_name: "#PF Page Fault" {
    style.fill: ${colors.highlight}
    style.font-color: white
  }
  v14_type: FAULT {
    style.fill: ${colors.highlight}
  }
  v14_ec: "YES" {
    style.fill: "#FED7D7"
    style.font-color: ${colors.error_code}
    style.bold: true
  }
  
  # Vector 15
  v15: "15 (0x0F)" {class: reserved_row}
  v15_name: "(Reserved)" {class: reserved_row}
  v15_type: "-" {class: reserved_row}
  v15_ec: "-" {class: reserved_row}
  
  # Vector 16
  v16: "16 (0x10)" {class: normal_row}
  v16_name: "#MF x87 FPU Error" {class: normal_row}
  v16_type: FAULT {class: normal_row}
  v16_ec: NO {class: no_ec}
  
  # Vector 17
  v17: "17 (0x11)" {class: normal_row}
  v17_name: "#AC Alignment Check" {class: normal_row}
  v17_type: FAULT {class: normal_row}
  v17_ec: "YES" {class: yes_ec}
  
  # Vector 18
  v18: "18 (0x12)" {class: normal_row}
  v18_name: "#MC Machine Check" {class: normal_row}
  v18_type: ABORT {class: normal_row}
  v18_ec: NO {class: no_ec}
  
  # Vector 19
  v19: "19 (0x13)" {class: normal_row}
  v19_name: "#XM SIMD Exception" {class: normal_row}
  v19_type: FAULT {class: normal_row}
  v19_ec: NO {class: no_ec}
  
  # Vectors 20-31
  v20_31: "20-31" {class: reserved_row}
  v20_31_name: "(Reserved)" {class: reserved_row}
  v20_31_type: "-" {class: reserved_row}
  v20_31_ec: "-" {class: reserved_row}
}

classes: {
  header: {
    style: {
      fill: ${colors.header}
      font-color: white
      bold: true
    }
  }
  normal_row: {
    style: {
      fill: "#F7FAFC"
    }
  }
  reserved_row: {
    style: {
      fill: "#E2E8F0"
      font-color: "#718096"
    }
  }
  no_ec: {
    style: {
      fill: "#F0FFF4"
      font-color: ${colors.normal}
    }
  }
  yes_ec: {
    style: {
      fill: "#FAF5FF"
      font-color: ${colors.error_code}
    }
  }
}

# Error Code Bit Layout Section
error_code_section: {
  label: "Error Code Bit Layout"
  near: bottom-left
  
  selector_format: {
    label: |md
      ## Selector Error Format (Vectors 8, 10-13, 17)
      
      ┌─────────────────────────────────────────┬─────┬─────┬─────┐
      │         Reserved (16 bits)              │ TI  │ IDT │ EXT │
      ├─────────────────────────────────────────┼─────┼─────┼─────┤
      │ Bit 31-16                               │  2  │  1  │  0  │
      └─────────────────────────────────────────┴─────┴─────┴─────┘
      
      * **EXT (bit 0)**: External event caused exception
      * **IDT (bit 1)**: Index references IDT (not GDT/LDT)
      * **TI (bit 2)**: Table Indicator (0=GDT, 1=LDT)
      * **Bits 15:3**: Selector index
    |
  }
  
  page_fault_format: {
    label: |md
      ## Page Fault Error Code (Vector 14)
      
      ┌─────┬─────┬─────┬─────┬─────┬─────┬────┬────┬────┐
      │ SGZ │ SG1 │ RSVD│ I/D │ RSVD│ US  │ WR  │ P   │
      ├─────┼─────┼─────┼─────┼─────┼─────┼────┼────┼────┤
      │  7  │  6  │  5  │  4  │  3  │  2  │ 1  │ 0  │
      └─────┴─────┴─────┴─────┴─────┴─────┴────┴────┴────┘
      
      * **P (bit 0)**: 0=page not present, 1=protection violation
      * **WR (bit 1)**: 0=read, 1=write access
      * **US (bit 2)**: 0=supervisor, 1=user mode
      * **I/D (bit 4)**: 0=instruction fetch, 1=data access
      * **SG1 (bit 6)**: Shadow stack access
      * **SGZ (bit 7)**: SGX access violation
      
      **CR2 holds faulting linear address**
    |
  }
}

# Highlighted Vectors Detail
detail_section: {
  near: bottom-right
  label: "Critical Vectors Deep Dive"
  
  divide_error: {
    label: "Vector 0: #DE Divide Error"
    style.fill: "#FED7AA"
    style.stroke: ${colors.highlight}
    
    trigger: |md
      **Trigger**: `DIV` or `IDIV` with divisor = 0
      or quotient exceeds destination size
    |
    
    handler: |md
      **Handler action**: Typically SIGFPE to process
      Can recover by modifying registers and resuming
    |
  }
  
  double_fault: {
    label: "Vector 8: #DF Double Fault (ABORT)"
    style.fill: "#FED7D7"
    style.stroke: ${colors.critical}
    
    trigger: |md
      **Trigger**: Exception during handler for another exception
      e.g., Page fault while handling page fault
    |
    
    handler: |md
      **Handler action**: System must reset or halt
      No recovery possible - state is corrupted
    |
  }
  
  gpf: {
    label: "Vector 13: #GP General Protection"
    style.fill: "#FED7AA"
    style.stroke: ${colors.highlight}
    
    trigger: |md
      **Trigger**: Segment limit violation, privileged instruction
      in user mode, invalid descriptor, writing to RO segment
    |
    
    error_bits: |md
      **Error code bits**:
      * EXT=1: External event (NMI/hardware)
      * IDT=1: Selector index into IDT
      * TI=1: LDT, TI=0: GDT
    |
  }
  
  page_fault: {
    label: "Vector 14: #PF Page Fault"
    style.fill: "#FED7AA"
    style.stroke: ${colors.highlight}
    
    trigger: |md
      **Trigger**: Page not present, privilege violation,
      reserved bit set, or write to read-only page
    |
    
    critical_info: |md
      **CRITICAL REGISTERS**:
      * **CR2**: Linear address that caused fault
      * **Error code**: Tells WHY (P, WR, US bits)
      * **RIP**: Instruction that caused fault
      
      Common fix: Map page, update permissions, or SIGSEGV
    |
  }
}

# Stack frame illustration
stack_frame: {
  near: center-right
  label: "Exception Stack Frame (w/ Error Code)"
  
  frame: {
    shape: class
    EIP: "Return CS:EIP (from interrupted code)"
    CS: ""
    EFLAGS: "CPU flags at time of exception"
    SP3: "User ESP (if privilege change)"
    SS3: "User SS (if privilege change)"
    ERROR: "Error code (optional, vector-dependent)"
  }
  
  note: |md
    Stack grows downward →
    Error code popped by IRET
    (if present, handler must pop it!)
  |
}

# Connection annotations
vectors.v14 -> error_code_section.page_fault_format: "CR2 = faulting addr" {
  style.stroke: ${colors.highlight}
  style.stroke-dash: 3
}

vectors.v13 -> error_code_section.selector_format: "selector info" {
  style.stroke: ${colors.highlight}
  style.stroke-dash: 3
}

vectors.v8 -> detail_section.double_fault: "FATAL" {
  style.stroke: ${colors.critical}
  style.stroke-width: 2
}