vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # GDT Entry Layout: 8-Byte Segment Descriptor
  Microscopic view of x86 Protected Mode segment descriptor structure
| {near: top-center}

direction: right

classes: {
  byte-col: {
    width: 80
    height: 200
    style: {
      stroke: black
      stroke-width: 2
      fill: white
    }
  }
  base-field: {
    style.fill: "#90EE90"
  }
  limit-field: {
    style.fill: "#87CEEB"
  }
  access-field: {
    style.fill: "#FFD700"
  }
  flags-field: {
    style.fill: "#FF6B6B"
  }
  label-style: {
    style: {
      font-size: 14
      bold: true
    }
  }
}

GDT_Entry: {
  label: "8-Byte Segment Descriptor (64 bits)"
  style.stroke: black
  style.stroke-width: 3

  Byte7: {
    label: "Byte 7\n(MSB)"
    class: byte-col
    style.fill: "#90EE90"
  }
  Byte7_desc: |md
    **Base[31:24]**
    
    Bits 31-24 of
    segment base
    address
  |
  
  Byte6: {
    label: "Byte 6"
    class: byte-col
  }
  Byte6_desc: |md
    **Flags + Limit**
    
    G D L AVL | Limit[19:16]
    
    G: Granularity
    D: Default size
    L: Long mode
    AVL: Available
  |
  
  Byte5: {
    label: "Byte 5"
    class: byte-col
    style.fill: "#FFD700"
  }
  Byte5_desc: |md
    **Access Byte**
    
    P DPL S | Type
    
    P: Present
    DPL: Privilege
    S: System
  |
  
  Byte4: {
    label: "Byte 4"
    class: byte-col
    style.fill: "#90EE90"
  }
  Byte4_desc: |md
    **Base[23:16]**
    
    Bits 23-16 of
    segment base
    address
  |
  
  Byte3: {
    label: "Byte 3"
    class: byte-col
    style.fill: "#87CEEB"
  }
  Byte3_desc: |md
    **Limit[15:8]**
    
    Bits 15-8 of
    segment limit
  |
  
  Byte2: {
    label: "Byte 2"
    class: byte-col
    style.fill: "#87CEEB"
  }
  Byte2_desc: |md
    **Limit[7:0]**
    
    Bits 7-0 of
    segment limit
  |
  
  Byte1: {
    label: "Byte 1"
    class: byte-col
    style.fill: "#90EE90"
  }
  Byte1_desc: |md
    **Base[15:8]**
    
    Bits 15-8 of
    segment base
  |
  
  Byte0: {
    label: "Byte 0\n(LSB)"
    class: byte-col
    style.fill: "#90EE90"
  }
  Byte0_desc: |md
    **Base[7:0]**
    
    Bits 7-0 of
    segment base
  |
}

legend: {
  near: bottom-center
  direction: right
  
  base_leg: {
    label: "Base (32-bit, split 3 locations)"
    class: base-field
    style.fill: "#90EE90"
    width: 180
  }
  limit_leg: {
    label: "Limit (20-bit, split 2 locations)"
    class: limit-field
    style.fill: "#87CEEB"
    width: 200
  }
  access_leg: {
    label: "Access Byte"
    class: access-field
    style.fill: "#FFD700"
    width: 120
  }
  flags_leg: {
    label: "Flags (4 bits)"
    class: flags-field
    style.fill: "#FF6B6B"
    width: 120
  }
}

Access_Byte_Detail: {
  label: "Access Byte Bit Layout (Byte 5)"
  style.stroke: black
  style.stroke-width: 2
  
  grid-columns: 8
  grid-gap: 0
  
  ab7: {
    label: "P"
    style.fill: "#FFD700"
    width: 60
    height: 60
  }
  ab6: {
    label: "DPL"
    style.fill: "#FFD700"
    width: 60
    height: 60
  }
  ab5: {
    label: "DPL"
    style.fill: "#FFD700"
    width: 60
    height: 60
  }
  ab4: {
    label: "S"
    style.fill: "#FFD700"
    width: 60
    height: 60
  }
  ab3: {
    label: "E"
    style.fill: "#FFB347"
    width: 60
    height: 60
  }
  ab2: {
    label: "DC"
    style.fill: "#FFB347"
    width: 60
    height: 60
  }
  ab1: {
    label: "RW"
    style.fill: "#FFB347"
    width: 60
    height: 60
  }
  ab0: {
    label: "A"
    style.fill: "#FFB347"
    width: 60
    height: 60
  }
}

access_legend: {
  near: Access_Byte_Detail
  direction: right
  
  p_desc: {
    label: "P=1: Present in memory"
    style.font-size: 12
  }
  dpl_desc: {
    label: "DPL: 0=Ring0, 3=Ring3"
    style.font-size: 12
  }
  s_desc: {
    label: "S=1: Code/Data, S=0: System"
    style.font-size: 12
  }
  e_desc: {
    label: "E: Executable (1=Code)"
    style.font-size: 12
  }
  dc_desc: {
    label: "DC: Direction/Conforming"
    style.font-size: 12
  }
  rw_desc: {
    label: "RW: Readable/Writable"
    style.font-size: 12
  }
  a_desc: {
    label: "A: Accessed bit"
    style.font-size: 12
  }
}

Typical_GDT: {
  label: "Typical OS GDT Entries"
  style.stroke: black
  style.stroke-width: 2
  
  Null_Desc: {
    label: "Entry 0: Null Descriptor"
    style.fill: "#D3D3D3"
    width: 300
  }
  Null_Desc_desc: |md
    **0x0000000000000000**
    
    Required by CPU
    Selector 0x00 = NULL
  |
  
  Kernel_Code: {
    label: "Entry 1: Kernel Code (0x08)"
    style.fill: "#90EE90"
    width: 300
  }
  Kernel_Code_desc: |md
    **0x00CF9A000000FFFF**
    
    Base=0x00000000, Limit=0xFFFFF (4GB w/ G=1)
    P=1, DPL=0, S=1, Type=1010 (Code, Exec+Read)
  |
  
  Kernel_Data: {
    label: "Entry 2: Kernel Data (0x10)"
    style.fill: "#87CEEB"
    width: 300
  }
  Kernel_Data_desc: |md
    **0x00CF92000000FFFF**
    
    Base=0x00000000, Limit=0xFFFFF (4GB w/ G=1)
    P=1, DPL=0, S=1, Type=0010 (Data, R+W)
  |
  
  User_Code: {
    label: "Entry 3: User Code (0x18)"
    style.fill: "#FFD700"
    width: 300
  }
  User_Code_desc: |md
    **0x00CFFA000000FFFF**
    
    Base=0x00000000, Limit=0xFFFFF (4GB w/ G=1)
    P=1, DPL=3, S=1, Type=1010 (Code, Exec+Read)
  |
  
  User_Data: {
    label: "Entry 4: User Data (0x20)"
    style.fill: "#FF6B6B"
    width: 300
  }
  User_Data_desc: |md
    **0x00CFF2000000FFFF**
    
    Base=0x00000000, Limit=0xFFFFF (4GB w/ G=1)
    P=1, DPL=3, S=1, Type=0010 (Data, R+W)
  |
  
  TSS_Desc: {
    label: "Entry 5: TSS (0x28)"
    style.fill: "#DDA0DD"
    width: 300
  }
  TSS_Desc_desc: |md
    **Varies with TSS location**
    
    S=0 (System segment)
    Type=1001 (Available 32-bit TSS)
    Base points to TSS struct
  |
}

Selector_Format: {
  label: "Segment Selector Format (16-bit)"
  style.stroke: black
  style.stroke-width: 2
  
  grid-columns: 4
  grid-gap: 0
  
  sel15: {
    label: "Index[15:3]"
    style.fill: "#87CEEB"
    width: 160
    height: 50
  }
  sel2: {
    label: "TI"
    style.fill: "#FFD700"
    width: 60
    height: 50
  }
  sel1_0: {
    label: "RPL"
    style.fill: "#FF6B6B"
    width: 120
    height: 50
  }
}

selector_examples: {
  near: Selector_Format
  direction: right
  
  idx_desc: {
    label: "Index: Entry # in GDT (0-8191)"
    style.font-size: 12
  }
  ti_desc: {
    label: "TI: 0=GDT, 1=LDT"
    style.font-size: 12
  }
  rpl_desc: {
    label: "RPL: Requested Privilege Level"
    style.font-size: 12
  }
}

example_selectors: {
  direction: right
  
  ex_kc: {
    label: "0x08 = Kernel Code"
    style.fill: "#90EE90"
    width: 150
  }
  ex_kd: {
    label: "0x10 = Kernel Data"
    style.fill: "#87CEEB"
    width: 150
  }
  ex_uc: {
    label: "0x18 | 0x03 = User Code (RPL=3)"
    style.fill: "#FFD700"
    width: 200
  }
  ex_ud: {
    label: "0x20 | 0x03 = User Data (RPL=3)"
    style.fill: "#FF6B6B"
    width: 200
  }
}

back_to_map: {
  label: "Back to Satellite View"
  near: top-right
  link: "#satellite-system"
  style: {
    fill: transparent
    font-color: blue
    underline: true
  }
}