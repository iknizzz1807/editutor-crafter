vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Dual Mapping: Identity + Higher-Half Kernel
  Virtual Address Space Architecture
| {near: top-center}
direction: right
# Virtual Address Space (Left Side)
virtual_space: Virtual Address Space (32-bit) {
  style.fill: "#E8F4F8"
  style.stroke: "#2B6CB0"
  style.stroke-width: 3
  low_region: Identity-Mapped Region {
    style.fill: "#C6F6D5"
    style.stroke: "#276749"
    desc: |md
      0x00000000 - 0x00FFFFFF
      (First 16 MB)
    |
    vga: "VGA Buffer 0x000B8000" {
      style.fill: "#FED7D7"
      style.stroke: "#C53030"
      style.font-size: 14
    }
    mmio: "MMIO Region 0x000A0000-0x000BFFFF" {
      style.fill: "#FEEBC8"
      style.stroke: "#C05621"
      style.font-size: 14
    }
    kernel_low: "Kernel (Identity) 0x00100000-0x001FFFFF" {
      style.fill: "#BEE3F8"
      style.stroke: "#2B6CB0"
      style.font-size: 14
    }
  }
  gap_region: |md
    0x01000000 - 0xBFFFFFFF
    ~3GB Unmapped/User Space
  | {
    style.fill: "#F7FAFC"
    style.stroke: "#A0AEC0"
    style.stroke-dash: 3
    style.font-color: "#718096"
  }
  high_region: Higher-Half Kernel Region {
    style.fill: "#E9D8FD"
    style.stroke: "#6B46C1"
    desc: |md
      0xC0000000 - 0xFFFFFFFF
      (Top 1 GB)
    |
    kernel_high: "Kernel (Higher-Half) 0xC0100000-0xC01FFFFF" {
      style.fill: "#BEE3F8"
      style.stroke: "#2B6CB0"
      style.font-size: 14
    }
    kheap: "Kernel Heap 0xD0000000+" {
      style.fill: "#C4F1F9"
      style.stroke: "#0891B2"
      style.font-size: 14
    }
    kstacks: "Kernel Stacks 0xE0000000+" {
      style.fill: "#FED7E2"
      style.stroke: "#D53F8C"
      style.font-size: 14
    }
  }
}
# Physical Memory (Right Side)
physical_mem: Physical Memory {
  style.fill: "#FFF5F5"
  style.stroke: "#C53030"
  style.stroke-width: 3
  desc: |md
    Physical RAM Layout
  |
  low_phys: "Low Memory 0x00000000 - 0x000FFFFF (BIOS, Bootloader)" {
    style.fill: "#FED7D7"
    style.stroke: "#C53030"
    style.font-size: 14
  }
  vga_phys: "VGA Buffer 0x000B8000" {
    style.fill: "#FED7D7"
    style.stroke: "#C53030"
    style.font-size: 14
  }
  kernel_phys: "Kernel Binary 0x00100000 - 0x001FFFFF (1MB - 2MB)" {
    style.fill: "#BEE3F8"
    style.stroke: "#2B6CB0"
    style.font-size: 16
    style.bold: true
  }
  free_phys: "Free Physical Memory 0x00200000+" {
    style.fill: "#C6F6D5"
    style.stroke: "#276749"
    style.font-size: 14
  }
}
# Page Tables (Center)
page_tables: Page Tables {
  style.fill: "#FFFBEB"
  style.stroke: "#D69E2E"
  style.stroke-width: 2
  pd: "Page Directory (CR3)" {
    style.fill: "#FAF089"
    style.stroke: "#D69E2E"
    shape: diamond
  }
  pt_low: "Page Table 0 (Entries 0-255)" {
    style.fill: "#FAF089"
    style.stroke: "#D69E2E"
  }
  pt_high: "Page Table 768 (Entries 768+)" {
    style.fill: "#FAF089"
    style.stroke: "#D69E2E"
  }
  pd -> pt_low: "PD Index 0"
  pd -> pt_high: "PD Index 768 (0xC0000000)"
}
# Mapping Arrows - Identity
virtual_space.low_region.vga -> physical_mem.vga_phys: "Identity Map VA 0xB8000 -> PA 0xB8000" {
  style.stroke: "#C53030"
  style.stroke-width: 3
  style.stroke-dash: 5
}
virtual_space.low_region.kernel_low -> physical_mem.kernel_phys: "Identity Map VA 0x100000 -> PA 0x100000" {
  style.stroke: "#2B6CB0"
  style.stroke-width: 3
  style.stroke-dash: 5
}
# Mapping Arrows - Higher-Half
virtual_space.high_region.kernel_high -> physical_mem.kernel_phys: "Higher-Half Map VA 0xC0100000 -> PA 0x100000" {
  style.stroke: "#6B46C1"
  style.stroke-width: 4
  style.animated: true
}
# Page Table Connections
page_tables.pt_low -> physical_mem.vga_phys: {
  style.stroke: "#D69E2E"
  style.stroke-width: 2
}
page_tables.pt_low -> physical_mem.kernel_phys: {
  style.stroke: "#2B6CB0"
  style.stroke-width: 2
}
page_tables.pt_high -> physical_mem.kernel_phys: {
  style.stroke: "#6B46C1"
  style.stroke-width: 3
}
# Why Both Needed - Bottom Explanation
why_both: Why Both Mappings Are Needed {
  style.fill: "#F0FFF4"
  style.stroke: "#276749"
  style.stroke-width: 2
  phase1: Boot Phase {
    style.fill: "#C6F6D5"
    desc: |md
      **Before paging enabled:**
      - CPU executes at physical addresses
      - EIP = 0x100123 (physical)
      - Need identity map so code continues
        after `mov cr0, PG=1`
    |
  }
  phase2: Running Phase {
    style.fill: "#E9D8FD"
    desc: |md
      **After paging enabled:**
      - Jump to 0xC0100123 (virtual)
      - Kernel runs in "clean" high address
      - Low 3GB available for user processes
      - Identity map can be removed later
    |
  }
  phase1 -> phase2: "Far jump after CR0.PG = 1" {
    style.stroke: "#276749"
    style.stroke-width: 2
    style.animated: true
  }
}
# Danger Zone Callout
danger: |md
  **WARNING: CRITICAL**
  Without identity mapping, the CPU will
  page fault on the **very next instruction**
  after enabling paging - before your page
  fault handler can even run!
  Result: Triple Fault -> System Reset
| {
  style.fill: "#FED7D7"
  style.stroke: "#C53030"
  style.stroke-width: 2
  style.font-size: 14
}
# Translation Example
translation: Translation Example {
  style.fill: "#EDF2F7"
  style.stroke: "#4A5568"
  desc: |md
    Virtual Address: 0xC0101234
    Bits [31:22] = 0x301 = 768 -> PD Entry 768
    Bits [21:12] = 0x001 = 1   -> PT Entry 1  
    Bits [11:0]  = 0x234       -> Page Offset
    Physical Frame: 0x100000 (kernel)
    Physical Address: 0x101234
  |
}
# Legend
legend: {
  style.fill: "#F7FAFC"
  style.stroke: "#A0AEC0"
  leg1: Identity Mapping {
    style.fill: "#C6F6D5"
  }
  leg2: Higher-Half Mapping {
    style.fill: "#E9D8FD"
  }
  leg3: Physical Kernel {
    style.fill: "#BEE3F8"
  }
}