vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Interrupt Stack Frame: What the CPU Pushes
  ### Complete Stack State After Interrupt Delivery
| {near: top-center}
direction: right
legend: {
  legend_cpu: CPU Pushed (Automatic) {
    style.fill: "#E8F4FD"
    style.stroke: "#2196F3"
    style.font-color: "#1565C0"
  }
  legend_handler: Handler Pushed (Manual) {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    style.font-color: "#E65100"
  }
  legend_conditional: Conditional (Privilege Change) {
    style.fill: "#F3E5F5"
    style.stroke: "#9C27B0"
    style.font-color: "#6A1B9A"
  }
}
note: |md
  **Stack grows downward** ↑
  Lower addresses at top
| {near: bottom-left}
# ============================================
# SAME PRIVILEGE (Ring 0 → Ring 0)
# ============================================
same_priv: "Same Privilege Transition\n(Ring 0 → Ring 0)" {
  style.fill: "#FAFAFA"
  style.stroke: "#424242"
  # High addresses (bottom of visual stack)
  sp_high: "← Higher Address (ESP before interrupt)" {
    shape: text
    style.font-color: "#757575"
    style.italic: true
  }
  # CPU pushes
  eip_same: EIP {
    style.fill: "#E8F4FD"
    style.stroke: "#2196F3"
    tooltip: "Instruction Pointer - Return address"
  }
  eip_same.width: 280
  cs_same: CS {
    style.fill: "#E8F4FD"
    style.stroke: "#2196F3"
    tooltip: "Code Segment selector (extended to 32-bit)"
  }
  cs_same.width: 280
  eflags_same: EFLAGS {
    style.fill: "#E8F4FD"
    style.stroke: "#2196F3"
    tooltip: "Processor flags (CF, ZF, IF, etc.)"
  }
  eflags_same.width: 280
  # Handler pushes
  gs_same: GS {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: push gs"
  }
  gs_same.width: 280
  fs_same: FS {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: push fs"
  }
  fs_same.width: 280
  es_same: ES {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: push es"
  }
  es_same.width: 280
  ds_same: DS {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: push ds"
  }
  ds_same.width: 280
  pusha_label: "← pusha starts here" {
    shape: text
    style.font-color: "#E65100"
    style.bold: true
  }
  edi_same: EDI {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: pusha (EDI)"
  }
  edi_same.width: 280
  esi_same: ESI {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: pusha (ESI)"
  }
  esi_same.width: 280
  ebp_same: EBP {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: pusha (EBP)"
  }
  ebp_same.width: 280
  esp_same: "ESP (old value)" {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: pusha (skipped ESP - uses old value)"
  }
  esp_same.width: 280
  ebx_same: EBX {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: pusha (EBX)"
  }
  ebx_same.width: 280
  edx_same: EDX {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: pusha (EDX)"
  }
  edx_same.width: 280
  ecx_same: ECX {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: pusha (ECX)"
  }
  ecx_same.width: 280
  eax_same: EAX {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: pusha (EAX)"
  }
  eax_same.width: 280
  sp_low: "← Lower Address (ESP after pusha)" {
    shape: text
    style.font-color: "#757575"
    style.italic: true
  }
}
# ============================================
# PRIVILEGE TRANSITION (Ring 3 → Ring 0)
# ============================================
priv_trans: "Privilege Transition\n(Ring 3 → Ring 0)" {
  style.fill: "#FAFAFA"
  style.stroke: "#424242"
  pt_high: "← Higher Address (User ESP)" {
    shape: text
    style.font-color: "#757575"
    style.italic: true
  }
  # CPU pushes (privilege change - SS and ESP first!)
  ss_pt: SS {
    style.fill: "#F3E5F5"
    style.stroke: "#9C27B0"
    tooltip: "User Stack Segment - CPU pushed (privilege change)"
  }
  ss_pt.width: 280
  esp_pt: ESP {
    style.fill: "#F3E5F5"
    style.stroke: "#9C27B0"
    tooltip: "User Stack Pointer - CPU pushed (privilege change)"
  }
  esp_pt.width: 280
  # Standard CPU pushes
  eflags_pt: EFLAGS {
    style.fill: "#E8F4FD"
    style.stroke: "#2196F3"
    tooltip: "Processor flags (IF cleared for interrupt gate)"
  }
  eflags_pt.width: 280
  cs_pt: CS {
    style.fill: "#E8F4FD"
    style.stroke: "#2196F3"
    tooltip: "User Code Segment selector (e.g., 0x1B)"
  }
  cs_pt.width: 280
  eip_pt: EIP {
    style.fill: "#E8F4FD"
    style.stroke: "#2196F3"
    tooltip: "User-mode return address"
  }
  eip_pt.width: 280
  # Optional error code (for exceptions 8, 10-14, 17, 21)
  err_pt: "Error Code\n(optional)" {
    style.fill: "#FFEBEE"
    style.stroke: "#F44336"
    style.stroke-dash: 3
    tooltip: "Pushed ONLY for exceptions 8, 10, 11, 12, 13, 14, 17, 21"
  }
  err_pt.width: 280
  # Handler pushes
  gs_pt: GS {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: push gs"
  }
  gs_pt.width: 280
  fs_pt: FS {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: push fs"
  }
  fs_pt.width: 280
  es_pt: ES {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: push es"
  }
  es_pt.width: 280
  ds_pt: DS {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "Handler: push ds"
  }
  ds_pt.width: 280
  pusha_pt: "← pusha starts here" {
    shape: text
    style.font-color: "#E65100"
    style.bold: true
  }
  edi_pt: EDI {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
  }
  edi_pt.width: 280
  esi_pt: ESI {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
  }
  esi_pt.width: 280
  ebp_pt: EBP {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
  }
  ebp_pt.width: 280
  esp_pt2: "ESP (kernel)" {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    tooltip: "pusha saves ESP but it's the kernel ESP"
  }
  esp_pt2.width: 280
  ebx_pt: EBX {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
  }
  ebx_pt.width: 280
  edx_pt: EDX {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
  }
  edx_pt.width: 280
  ecx_pt: ECX {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
  }
  ecx_pt.width: 280
  eax_pt: EAX {
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
  }
  eax_pt.width: 280
  pt_low: "← Lower Address (Kernel ESP)" {
    shape: text
    style.font-color: "#757575"
    style.italic: true
  }
}
# ============================================
# BYTE OFFSET REFERENCE (for privilege transition)
# ============================================
offsets: "Byte Offsets from ESP\n(Privilege Transition)" {
  style.fill: "#ECEFF1"
  style.stroke: "#607D8B"
  off_0: "+0  → EAX (pusha last)" {
    shape: text
    style.font: mono
  }
  off_4: "+4  → ECX" {
    shape: text
    style.font: mono
  }
  off_8: "+8  → EDX" {
    shape: text
    style.font: mono
  }
  off_12: "+12 → EBX" {
    shape: text
    style.font: mono
  }
  off_16: "+16 → ESP (kernel)" {
    shape: text
    style.font: mono
  }
  off_20: "+20 → EBP" {
    shape: text
    style.font: mono
  }
  off_24: "+24 → ESI" {
    shape: text
    style.font: mono
  }
  off_28: "+28 → EDI" {
    shape: text
    style.font: mono
  }
  off_32: "+32 → DS" {
    shape: text
    style.font: mono
  }
  off_36: "+36 → ES" {
    shape: text
    style.font: mono
  }
  off_40: "+40 → FS" {
    shape: text
    style.font: mono
  }
  off_44: "+44 → GS" {
    shape: text
    style.font: mono
  }
  off_err: "+48 → Error Code*" {
    shape: text
    style.font: mono
    style.font-color: "#F44336"
  }
  off_eip: "+52 → EIP" {
    shape: text
    style.font: mono
  }
  off_cs: "+56 → CS" {
    shape: text
    style.font: mono
  }
  off_ef: "+60 → EFLAGS" {
    shape: text
    style.font: mono
  }
  off_esp: "+64 → User ESP" {
    shape: text
    style.font: mono
    style.font-color: "#9C27B0"
  }
  off_ss: "+68 → User SS" {
    shape: text
    style.font: mono
    style.font-color: "#9C27B0"
  }
  note_off: |md
    *Error code only present for
    certain exceptions
    struct cpu_state offset
    calculations use these values
  | {
    shape: text
    style.font-color: "#607D8B"
    style.font-size: 12
  }
}
# ============================================
# KEY BEHAVIOR NOTES
# ============================================
notes: {
  notes_title: "Critical Implementation Details" {
    style.fill: "#FFF8E1"
    style.stroke: "#FFC107"
  }
  note1: |md
    ### iret Restoration
    `iret` pops in **reverse order**:
    1. EIP, CS, EFLAGS (always)
    2. ESP, SS (only if returning to lower privilege)
    This is why privilege transitions work
    automatically!
  | {shape: text}
  note2: |md
    ### TSS Role in Privilege Change
    When Ring 3 → Ring 0:
    - CPU reads **SS0:ESP0** from TSS
    - Switches to kernel stack
    - Saves user SS:ESP on kernel stack
    **TSS must be configured before
    any user-mode code runs!**
  | {shape: text}
  note3: |md
    ### Error Code Exceptions
    Only these exceptions push error code:
    - 8  (Double Fault)
    - 10 (Invalid TSS)
    - 11 (Segment Not Present)
    - 12 (Stack Segment Fault)
    - 13 (General Protection)
    - 14 (Page Fault)
    - 17 (Alignment Check)
    - 21 (Control Protection)
    IRQs (32-47) never push error code
  | {shape: text}
  note4: |md
    ### pusha Behavior
    `pusha` pushes: DI, SI, BP, SP, BX, DX, CX, AX
    The saved SP is the value **before**
    pusha executed (original ESP - 16)
    `popa` restores all except SP
  | {shape: text}
}
# Connections showing flow
same_priv.sp_high -> same_priv.eip_same: "CPU pushes" {style.stroke: "#2196F3"}
same_priv.eip_same -> same_priv.cs_same {style.stroke: "#2196F3"}
same_priv.cs_same -> same_priv.eflags_same {style.stroke: "#2196F3"}
same_priv.eflags_same -> same_priv.gs_same: "Handler pushes" {style.stroke: "#FF9800"}
same_priv.ds_same -> same_priv.edi_same: "pusha" {style.stroke: "#FF9800"}
same_priv.eax_same -> same_priv.sp_low {style.stroke: "#BDBDBD"}
priv_trans.pt_high -> priv_trans.ss_pt: "CPU pushes\n(from TSS)" {style.stroke: "#9C27B0"}
priv_trans.ss_pt -> priv_trans.esp_pt {style.stroke: "#9C27B0"}
priv_trans.esp_pt -> priv_trans.eflags_pt {style.stroke: "#2196F3"}
priv_trans.eflags_pt -> priv_trans.cs_pt {style.stroke: "#2196F3"}
priv_trans.cs_pt -> priv_trans.eip_pt {style.stroke: "#2196F3"}
priv_trans.eip_pt -> priv_trans.err_pt: "optional" {style.stroke: "#F44336"; style.stroke-dash: 3}
priv_trans.err_pt -> priv_trans.gs_pt: "Handler" {style.stroke: "#FF9800"}
priv_trans.ds_pt -> priv_trans.edi_pt: "pusha" {style.stroke: "#FF9800"}
priv_trans.eax_pt -> priv_trans.pt_low {style.stroke: "#BDBDBD"}