vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    hardware: "#FF6B6B"
    interrupt: "#4ECDC4"
    kernel: "#45B7D1"
    buffer: "#96CEB4"
    metadata: "#9B59B6"
  }
}

title: |md
  # Keyboard Input: Scancode to Buffer
  **Data Walk: PS/2 Port 0x60 ‚Üí IRQ1 ‚Üí IDT ‚Üí Handler ‚Üí Buffer**
| {near: top-center}

direction: right

KBController: Keyboard Controller (i8042) {
  style.fill: ${colors.hardware}
  style.stroke: "#C0392B"
  
  port60: Port 0x60 {
    shape: hexagon
    style.fill: "#E74C3C"
    tooltip: "Data register: read scancode, write commands"
  }
  port64: Port 0x64 {
    shape: hexagon
    style.fill: "#E74C3C"
    tooltip: "Status register: bit 0 = output buffer full"
  }
  
  port60 <-> port64: internal
}

PIC: PIC (8259A) {
  style.fill: ${colors.hardware}
  style.stroke: "#C0392B"
  
  irq1: IRQ1 {
    shape: circle
    style.fill: "#E74C3C"
    tooltip: "Keyboard interrupt line (vector 0x21)"
  }
  irr: IRR {
    shape: rectangle
    tooltip: "Interrupt Request Register"
  }
  isr: ISR {
    shape: rectangle
    tooltip: "In-Service Register"
  }
  
  irq1 -> irr: set bit 1
  irr -> isr: on INTA
}

IDT: Interrupt Descriptor Table {
  style.fill: ${colors.interrupt}
  style.stroke: "#16A085"
  
  entry33: Entry 0x21 (33) {
    shape: rectangle
    tooltip: "Gate: selector=0x08, offset=keyboard_handler"
  }
  
  content: |md
    offset_low:  0x1234
    selector:    0x08 (kernel CS)
    flags:       0x8E (DPL=0, present)
    offset_high: 0x0000
  |
  
  gate_desc: Gate Descriptor {
    shape: class
    offset: uint16 (low)
    selector: uint16
    flags: uint8
    zero: uint8
    offset2: uint16 (high)
  }
}

Handler: Keyboard Handler {
  style.fill: ${colors.kernel}
  style.stroke: "#2980B9"
  
  read_scancode: Read Port 0x60 {
    shape: rectangle
    tooltip: "in al, 0x60"
  }
  
  lookup: Scancode Table {
    shape: rectangle
    style.fill: ${colors.metadata}
  }
  
  table_content: ||md
    | Set 1 Code | Key | Make | Break |
    |------------|-----|------|-------|
    | 0x1E | A | 0x1E | 0x9E |
    | 0x30 | B | 0x30 | 0xB0 |
    | 0x2A | LShift | 0x2A | 0xAA |
    | 0x36 | RShift | 0x36 | 0xB6 |
    | 0xE0 | Extended | prefix | - |
  ||
  
  shift_state: Shift State {
    shape: rectangle
    style.fill: ${colors.metadata}
    tooltip: "Global: shift_pressed = false"
  }
  
  state_content: ||c
    static bool shift_pressed;
    uint8_t modifiers = 0;
    // bit 0: left shift
    // bit 1: right shift
    // bit 2: ctrl
    // bit 3: alt
  ||
  
  process: Process Logic {
    shape: rectangle
  }
  
  process_content: ||c
    if (code == 0xE0) {
        extended = true;
        return; // wait for next byte
    }
    if (code & 0x80) {
        // Break code: key released
        handle_release(code & 0x7F);
    } else {
        // Make code: key pressed
        char c = translate(code, shift_state);
        buffer_put(c);
    }
  ||
  
  read_scancode -> lookup: "scancode\n(e.g., 0x1E)"
  lookup -> shift_state: "check modifiers"
  shift_state -> process: "combined state"
  lookup -> process: "base char"
}

Buffer: Keyboard Buffer {
  style.fill: ${colors.buffer}
  style.stroke: "#27AE60"
  
  ring: Ring Buffer {
    shape: cylinder
    tooltip: "Typically 64-256 bytes"
  }
  
  buffer_content: ||c
    char buf[256];
    uint8_t head = 0;  // write position
    uint8_t tail = 0;  // read position
    
    #define BUFFER_EMPTY  (head == tail)
    #define BUFFER_FULL   ((head+1) % 256 == tail)
  ||
  
  head: Head (write) {
    shape: circle
    style.fill: "#2ECC71"
  }
  
  tail: Tail (read) {
    shape: circle
    style.fill: "#2ECC71"
  }
  
  head -> ring: "producer\n(handler)"
  tail -> ring: "consumer\n(syscall)"
}

KBController.port60 -> PIC.irq1: "scancode ready\n(bit 0 of port 0x64 = 1)" {
  style.stroke: red
  style.stroke-width: 3
  style.animated: true
}

PIC.irq1 -> IDT.entry33: "CPU vectors to\nhandler address" {
  style.stroke: orange
  style.stroke-width: 3
  style.animated: true
}

IDT.entry33 -> Handler.read_scancode: "jmp keyboard_handler" {
  style.stroke: yellow
  style.stroke-width: 3
  style.animated: true
}

Handler.process -> Buffer.head: "buffer_put(char)" {
  style.stroke: green
  style.stroke-width: 3
  style.animated: true
}

UserProcess: User Process {
  style.fill: "#E8E8E8"
  
  read_syscall: read(0, buf, n) {
    tooltip: "STDIN_FILENO = 0"
  }
  
  read_syscall -> Buffer.tail: "syscall blocks\nuntil data available" {
    style.stroke: blue
    style.stroke-dash: 5
  }
}

Timeline: |md
  ## Timing (Set 1 Scancodes)
  
  **Make Code**: Key pressed - single byte (e.g., `0x1E` for 'A')
  
  **Break Code**: Key released - byte | 0x80 (e.g., `0x9E` for 'A' release)
  
  **Extended Codes**: `0xE0` prefix for arrow keys, navigation cluster
  
  Press 'A':     0x1E
  Release 'A':   0x9E
  Press LShift:  0x2A
  Press 'A':     0x1E - 'A' becomes 'a' (no shift) or 'A' (shift)
  Release 'A':   0x9E
  Release LShift: 0xAA
  Press Right:   0xE0, 0x4D
| {near: bottom-center}

Legend: {
  near: top-right
  style.fill: "#F5F5F5"
  
  hw: Hardware { style.fill: ${colors.hardware} }
  int: Interrupt { style.fill: ${colors.interrupt} }
  kern: Kernel { style.fill: ${colors.kernel} }
  buf: Buffer { style.fill: ${colors.buffer} }
  meta: State { style.fill: ${colors.metadata} }
  
  hw - int - kern - buf - meta
}

BackToMap: "üìç Back to Satellite Map" {
  near: top-left
  shape: text
  link: "#keyboard-subsystem"
}