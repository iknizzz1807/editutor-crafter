vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  section: {
    width: 260
    style: {
      stroke-width: 2
      font: mono
      font-size: 14
    }
  }
}

title: |md
  # Kernel Memory Map: Linker Script Layout
  Physical (LMA) â†’ Virtual (VMA) Mapping
| {near: top-center}

direction: right

memory_layout: {
  grid-rows: 1
  grid-gap: 40
  
  physical: Physical Memory (LMA) {
    grid-rows: 7
    grid-gap: 0
    width: 280
    
    p_1mb: |md
      **0x00100000**
      (1 MB - Kernel Load)
    | {
      style.fill: transparent
      style.stroke: transparent
    }
    
    p_text: .text {
      class: section
      style.fill: "#E8F5E9"
      style.stroke: "#2E7D32"
      tooltip: "Executable code\nRead-only, executable"
    }
    
    p_rodata: .rodata {
      class: section
      style.fill: "#E3F2FD"
      style.stroke: "#1565C0"
      tooltip: "Read-only data\nStrings, constants"
    }
    
    p_data: .data {
      class: section
      style.fill: "#FFF3E0"
      style.stroke: "#EF6C00"
      tooltip: "Initialized data\nRead-write"
    }
    
    p_bss: .bss {
      class: section
      style.fill: "#F3E5F5"
      style.stroke: "#7B1FA2"
      tooltip: "Uninitialized data\nZero-filled at boot"
    }
    
    p_end: |md
      **0x00XXXXXX**
      (Kernel End)
    | {
      style.fill: transparent
      style.stroke: transparent
    }
  }
  
  virtual: Virtual Memory (VMA) {
    grid-rows: 7
    grid-gap: 0
    width: 280
    
    v_base: |md
      **0xC0000000**
      (Higher-Half Base)
    | {
      style.fill: transparent
      style.stroke: transparent
    }
    
    v_text: .text {
      class: section
      style.fill: "#E8F5E9"
      style.stroke: "#2E7D32"
    }
    
    v_rodata: .rodata {
      class: section
      style.fill: "#E3F2FD"
      style.stroke: "#1565C0"
    }
    
    v_data: .data {
      class: section
      style.fill: "#FFF3E0"
      style.stroke: "#EF6C00"
    }
    
    v_bss: .bss {
      class: section
      style.fill: "#F3E5F5"
      style.stroke: "#7B1FA2"
    }
    
    v_end: |md
      **0xC0XXXXXX**
      (Kernel End + Offset)
    | {
      style.fill: transparent
      style.stroke: transparent
    }
  }
}

physical.p_text -> virtual.v_text: "+ 0xC0000000\n(page tables map)" {
  style.stroke: "#666"
  style.stroke-dash: 5
  style.animated: true
  style.font-size: 12
  style.font: mono
}

physical.p_rodata -> virtual.v_rodata: "+ 0xC0000000" {
  style.stroke: "#666"
  style.stroke-dash: 5
  style.font-size: 11
  style.font: mono
}

physical.p_data -> virtual.v_data: "+ 0xC0000000" {
  style.stroke: "#666"
  style.stroke-dash: 5
  style.font-size: 11
  style.font: mono
}

physical.p_bss -> virtual.v_bss: "+ 0xC0000000" {
  style.stroke: "#666"
  style.stroke-dash: 5
  style.font-size: 11
  style.font: mono
}

legend: {
  near: bottom-center
  grid-columns: 2
  grid-gap: 20
  
  lma_box: LMA (Load Memory Address) {
    style.fill: "#F5F5F5"
    style.stroke: "#999"
    style.font-size: 12
    width: 180
  }
  
  vma_box: VMA (Virtual Memory Address) {
    style.fill: "#F5F5F5"
    style.stroke: "#999"
    style.font-size: 12
    width: 180
  }
}

linker_script: |md
  ld
  ENTRY(_start)
  
  SECTIONS {
    . = 0xC0000000;  /* Higher-half virtual base */
    
    _kernel_start = .;
    
    .text : AT(0x100000) {
      *(.text)
      *(.text.*)
    }
    
    .rodata : {
      *(.rodata)
      *(.rodata.*)
    }
    
    .data : {
      *(.data)
      *(.data.*)
    }
    
    .bss : {
      *(.COMMON)
      *(.bss)
    }
    
    _kernel_end = .;
  }
  
| {
  near: bottom-right
  width: 350
}

notes: |md
  ### Higher-Half Kernel Benefits
  
  1. **User space at 0x00000000**: Full 3GB for processes
  2. **Kernel mapped in every process**: No TLB flush on syscall
  3. **Physical memory mapping**: Direct map at 0xC0000000+
  
  ### AT() Directive
  The `AT(0x100000)` tells the linker:
  - **VMA**: 0xC0000000+ (where code expects to run)
  - **LMA**: 0x100000 (where bootloader loads the kernel)
| {
  near: top-right
  width: 280
}

back_to_map: ðŸ”™ Satellite View {
  near: top-left
  link: "#satellite-system"
  style.fill: "#E3F2FD"
  style.stroke: "#1565C0"
  style.border-radius: 4
  style.font-size: 12
}