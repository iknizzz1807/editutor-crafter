vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    code_section: "#E8F5E9"
    rodata_section: "#E3F2FD"
    data_section: "#FFF3E0"
    bss_section: "#F3E5F5"
    vma_color: "#1565C0"
    lma_color: "#2E7D32"
    symbol_color: "#C62828"
    arrow_data: "#1976D2"
    arrow_meta: "#7B1FA2"
    lma_fill: "#E8F5E8"
    vma_fill: "#E3F2FD"
  }
}

title: |md
  # Linker Script: Section Placement
  ## LMA vs VMA Address Translation
| {near: top-center}

direction: right

addresses: {
  label: ""
  
  address_space: {
    label: ""
    shape: rectangle
    style.fill: transparent
    
    physical_row: {
      label: ""
      shape: rectangle
      style.fill: transparent
      
      phys_label: "Physical\nMemory"
      phys_label.shape: text
      phys_label.style.font-size: 20
      phys_label.style.bold: true
      phys_label.style.font-color: ${colors.lma_color}
      
      lma_0x100000: "0x100000\n(1 MB)"
      lma_0x100000.shape: rectangle
      lma_0x100000.width: 90
      lma_0x100000.style.fill: ${colors.lma_fill}
      lma_0x100000.style.stroke: ${colors.lma_color}
      lma_0x100000.style.stroke-width: 2
      lma_0x100000.style.font-color: ${colors.lma_color}
      lma_0x100000.style.font-size: 14
      
      lma_arrow: "→"
      lma_arrow.shape: text
      lma_arrow.style.font-size: 24
      
      lma_0x100XXX: "0x100XXX\n(section end)"
      lma_0x100XXX.shape: rectangle
      lma_0x100XXX.width: 90
      lma_0x100XXX.style.fill: ${colors.lma_fill}
      lma_0x100XXX.style.stroke: ${colors.lma_color}
      lma_0x100XXX.style.stroke-width: 2
      lma_0x100XXX.style.font-color: ${colors.lma_color}
      lma_0x100XXX.style.font-size: 14
      lma_0x100XXX.style.stroke-dash: 3
    }
    
    virtual_row: {
      label: ""
      shape: rectangle
      style.fill: transparent
      
      virt_label: "Virtual\nMemory"
      virt_label.shape: text
      virt_label.style.font-size: 20
      virt_label.style.bold: true
      virt_label.style.font-color: ${colors.vma_color}
      
      vma_0xC0000000: "0xC0000000\n(3 GB)"
      vma_0xC0000000.shape: rectangle
      vma_0xC0000000.width: 90
      vma_0xC0000000.style.fill: ${colors.vma_fill}
      vma_0xC0000000.style.stroke: ${colors.vma_color}
      vma_0xC0000000.style.stroke-width: 2
      vma_0xC0000000.style.font-color: ${colors.vma_color}
      vma_0xC0000000.style.font-size: 14
      
      vma_arrow: "→"
      vma_arrow.shape: text
      vma_arrow.style.font-size: 24
      
      vma_0xC00XXX: "0xC00XXXX\n(section end)"
      vma_0xC00XXX.shape: rectangle
      vma_0xC00XXX.width: 90
      vma_0xC00XXX.style.fill: ${colors.vma_fill}
      vma_0xC00XXX.style.stroke: ${colors.vma_color}
      vma_0xC00XXX.style.stroke-width: 2
      vma_0xC00XXX.style.font-color: ${colors.vma_color}
      vma_0xC00XXX.style.font-size: 14
      vma_0xC00XXX.style.stroke-dash: 3
    }
  }
  
  lma_to_vma: "LMA + 0xC0000000 = VMA"
  lma_to_vma.shape: rectangle
  lma_to_vma.style.fill: "#FFFDE7"
  lma_to_vma.style.stroke: "#F9A825"
  lma_to_vma.style.stroke-width: 2
  lma_to_vma.style.font-size: 16
  lma_to_vma.style.bold: true
  
  physical_row.lma_0x100000 -> lma_to_vma
  lma_to_vma -> virtual_row.vma_0xC0000000
}

sections: {
  label: "Kernel Binary Sections"
  
  linker_header: |md
  ld
  ENTRY(kernel_entry)
  SECTIONS {
    . = 0xC0100000;  /* Virtual address */
  
  |
  linker_header.shape: rectangle
  linker_header.style.fill: "#FAFAFA"
  linker_header.style.stroke: "#9E9E9E"
  linker_header.style.font: mono
  linker_header.style.font-size: 12
  
  text_section: {
    label: ".text"
    shape: rectangle
    width: 200
    style.fill: ${colors.code_section}
    style.stroke: "#4CAF50"
    style.stroke-width: 2
    
    text_content: {
      label: |md
      **Code Section**
      - Executable instructions
      - `*(.multiboot)` header
      - `*(.text)` all code
      |
      text_content.shape: text
      text_content.style.font-size: 12
    }
    
    text_vma: "VMA: 0xC0100000"
    text_vma.shape: rectangle
    text_vma.style.fill: ${colors.vma_color}
    text_vma.style.font-color: white
    text_vma.style.font-size: 11
    text_vma.style.bold: true
    
    text_lma: "LMA: 0x00100000"
    text_lma.shape: rectangle
    text_lma.style.fill: ${colors.lma_color}
    text_lma.style.font-color: white
    text_lma.style.font-size: 11
    text_lma.style.bold: true
    
    text_ld: |md
    ld
    .text : AT(ADDR(.text) - 0xC000000)
    
    |
    text_ld.shape: rectangle
    text_ld.style.fill: "#FAFAFA"
    text_ld.style.font: mono
    text_ld.style.font-size: 10
  }
  
  rodata_section: {
    label: ".rodata"
    shape: rectangle
    width: 200
    style.fill: ${colors.rodata_section}
    style.stroke: "#2196F3"
    style.stroke-width: 2
    
    rodata_content: {
      label: |md
      **Read-Only Data**
      - String literals
      - Constant variables
      - Jump tables
      |
      rodata_content.shape: text
      rodata_content.style.font-size: 12
    }
    
    rodata_vma: "VMA: 0xC010XXXX"
    rodata_vma.shape: rectangle
    rodata_vma.style.fill: ${colors.vma_color}
    rodata_vma.style.font-color: white
    rodata_vma.style.font-size: 11
    rodata_vma.style.bold: true
    
    rodata_lma: "LMA: 0x0010XXXX"
    rodata_lma.shape: rectangle
    rodata_lma.style.fill: ${colors.lma_color}
    rodata_lma.style.font-color: white
    rodata_lma.style.font-size: 11
    rodata_lma.style.bold: true
  }
  
  data_section: {
    label: ".data"
    shape: rectangle
    width: 200
    style.fill: ${colors.data_section}
    style.stroke: "#FF9800"
    style.stroke-width: 2
    
    data_content: {
      label: |md
      **Initialized Data**
      - Global variables with values
      - Static variables
      - Function pointers
      |
      data_content.shape: text
      data_content.style.font-size: 12
    }
    
    data_vma: "VMA: 0xC010YYYY"
    data_vma.shape: rectangle
    data_vma.style.fill: ${colors.vma_color}
    data_vma.style.font-color: white
    data_vma.style.font-size: 11
    data_vma.style.bold: true
    
    data_lma: "LMA: 0x0010YYYY"
    data_lma.shape: rectangle
    data_lma.style.fill: ${colors.lma_color}
    data_lma.style.font-color: white
    data_lma.style.font-size: 11
    data_lma.style.bold: true
  }
  
  bss_section: {
    label: ".bss"
    shape: rectangle
    width: 200
    style.fill: ${colors.bss_section}
    style.stroke: "#9C27B0"
    style.stroke-width: 2
    
    bss_content: {
      label: |md
      **Uninitialized Data**
      - Zero-initialized globals
      - `*(.COMMON)`
      - `*(.bss)`
      |
      bss_content.shape: text
      bss_content.style.font-size: 12
    }
    
    bss_start: "__bss_start"
    bss_start.shape: rectangle
    bss_start.style.fill: ${colors.symbol_color}
    bss_start.style.font-color: white
    bss_start.style.font-size: 11
    bss_start.style.bold: true
    
    bss_end: "__bss_end"
    bss_end.shape: rectangle
    bss_end.style.fill: ${colors.symbol_color}
    bss_end.style.font-color: white
    bss_end.style.font-size: 11
    bss_end.style.bold: true
    
    bss_vma: "VMA: 0xC010ZZZZ"
    bss_vma.shape: rectangle
    bss_vma.style.fill: ${colors.vma_color}
    bss_vma.style.font-color: white
    bss_vma.style.font-size: 11
    bss_vma.style.bold: true
  }
  
  linker_header -> text_section: "First section"
  text_section -> rodata_section: "4KB aligned"
  rodata_section -> data_section: "4KB aligned"
  data_section -> bss_section: "4KB aligned"
  
  bss_section.bss_start -> bss_section.bss_end: "Range to zero" {
    style.stroke: ${colors.symbol_color}
    style.stroke-width: 3
    style.animated: true
  }
}

bootloader_flow: {
  label: "Boot Process"
  
  bios: {
    label: "BIOS/GRUB"
    shape: rectangle
    style.fill: "#ECEFF1"
    style.stroke: "#607D8B"
    
    bios_action: {
      label: |md
      1. Reads kernel binary
      2. Loads to **LMA** (physical)
      3. Jumps to entry point
      |
      bios_action.shape: text
      bios_action.style.font-size: 12
    }
  }
  
  kernel_entry: {
    label: "kernel_entry.asm"
    shape: rectangle
    style.fill: "#E8F5E9"
    style.stroke: "#4CAF50"
    
    entry_action: {
      label: |md
      Before C code runs:
      
      mov edi, __bss_start
      mov ecx, __bss_end
      sub ecx, edi
      xor eax, eax
      rep stosb  ; Zero BSS!
      
      |
      entry_action.shape: text
      entry_action.style.font: mono
      entry_action.style.font-size: 11
    }
  }
  
  paging: {
    label: "Page Tables"
    shape: rectangle
    style.fill: "#E3F2FD"
    style.stroke: "#2196F3"
    
    paging_action: {
      label: |md
      Higher-half mapping:
      - 0xC0000000 → 0x00000000
      - CPU translates VMA→LMA
      - Code accesses via VMA
      |
      paging_action.shape: text
      paging_action.style.font-size: 12
    }
  }
  
  bios -> kernel_entry: "Control transfer\n(at physical addr)"
  kernel_entry -> paging: "Enable paging\nthen call kernel_main()"
}

zero_bss: {
  label: "BSS Zeroing Detail"
  
  memory_before: {
    label: "Before Zeroing"
    shape: rectangle
    width: 180
    style.fill: "#FFEBEE"
    style.stroke: "#C62828"
    
    garbage1: "0x?? 0x?? 0x?? ..."
    garbage1.shape: text
    garbage1.style.font: mono
    garbage1.style.font-size: 12
    garbage1.style.font-color: "#C62828"
    
    addr1: "__bss_start"
    addr1.shape: text
    addr1.style.font-size: 10
  }
  
  memory_after: {
    label: "After Zeroing"
    shape: rectangle
    width: 180
    style.fill: "#E8F5E9"
    style.stroke: "#2E7D32"
    
    zeros: "0x00 0x00 0x00 ..."
    zeros.shape: text
    zeros.style.font: mono
    zeros.style.font-size: 12
    zeros.style.font-color: "#2E7D32"
    
    addr2: "__bss_start → __bss_end"
    addr2.shape: text
    addr2.style.font-size: 10
  }
  
  zero_op: |md
  `rep stosb` fills memory
  from `edi` to `edi+ecx-1`
  with byte value in `al` (0x00)
  |
  zero_op.shape: rectangle
  zero_op.style.fill: "#FFF8E1"
  zero_op.style.stroke: "#FFA000"
  zero_op.style.font-size: 11
  
  memory_before -> zero_op: "Garbage!"
  zero_op -> memory_after: "Zeroed!"
}

legend: {
  label: "Legend"
  
  lma_legend: "LMA (Load Memory Address)"
  lma_legend.shape: rectangle
  lma_legend.style.fill: ${colors.lma_color}
  lma_legend.style.font-color: white
  lma_legend.style.font-size: 12
  
  vma_legend: "VMA (Virtual Memory Address)"
  vma_legend.shape: rectangle
  vma_legend.style.fill: ${colors.vma_color}
  vma_legend.style.font-color: white
  vma_legend.style.font-size: 12
  
  symbol_legend: "Linker Symbols"
  symbol_legend.shape: rectangle
  symbol_legend.style.fill: ${colors.symbol_color}
  symbol_legend.style.font-color: white
  symbol_legend.style.font-size: 12
}

key_insight: {
  label: |md
  ### Key Insight
  The `AT()` directive tells the linker:
  - **Place section at VMA** for code execution
  - **Store in binary at LMA** for bootloader loading
  
  Without `AT()`, the binary would have 3GB of padding!
  |
  key_insight.shape: rectangle
  key_insight.style.fill: "#E8EAF6"
  key_insight.style.stroke: "#3F51B5"
  key_insight.style.stroke-width: 2
}

legend.near: bottom-right
key_insight.near: bottom-center

addresses -> sections: "Defined in\nlinker.ld"
sections -> bootloader_flow: "Binary layout"
bootloader_flow.kernel_entry -> zero_bss: "Must zero\nbefore use"