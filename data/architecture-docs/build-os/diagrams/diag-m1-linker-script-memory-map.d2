vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |'md
  # Linker Script: Physical vs Virtual Address Spaces
'| {near: top-center}

phys: "Physical Address Space" {
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a8a"
    stroke-width: 2
    font-color: "#e0e0ff"
    bold: true
  }

  p_zero: "0x00000000 — Real-mode IVT (1KB)" {
    style: { fill: "#2d2d5a"; stroke: "#5555aa"; font-color: "#aaaaff" }
  }

  p_bda: "0x00000400 — BIOS Data Area" {
    style: { fill: "#2d2d5a"; stroke: "#5555aa"; font-color: "#aaaaff" }
  }

  p_low: "0x00000500 — Free Low RAM" {
    style: { fill: "#1e3a1e"; stroke: "#3a7a3a"; font-color: "#aaffaa" }
  }

  p_mbr: "0x00007C00 — MBR Load (512 bytes)" {
    style: { fill: "#3a2800"; stroke: "#aa7700"; font-color: "#ffcc44"; bold: true }
  }

  p_stage2: "0x00007E00 — Stage 2 Bootloader" {
    style: { fill: "#3a2800"; stroke: "#aa7700"; font-color: "#ffcc44" }
  }

  p_ebda: "0x00080000 — EBDA (reserved)" {
    style: { fill: "#3a0000"; stroke: "#aa3333"; font-color: "#ffaaaa" }
  }

  p_vga: "0x000B8000 — VGA Text Buffer MMIO" {
    style: { fill: "#1a2a3a"; stroke: "#3388cc"; font-color: "#88ddff"; bold: true }
  }

  p_rom: "0x000C0000 — Option ROM / BIOS" {
    style: { fill: "#2d1a2d"; stroke: "#884488"; font-color: "#ddaadd" }
  }

  p_1mb: "0x00100000 — 1MB Boundary (A20 Gate)" {
    style: { fill: "#333300"; stroke: "#aaaa00"; font-color: "#ffff44"; bold: true }
  }

  p_kernel: "0x00100000 — KERNEL LOAD (LMA)" {
    style: { fill: "#003300"; stroke: "#00aa44"; font-color: "#44ff88"; bold: true; shadow: true }
  }

  p_text: ".text — Code (R/X, U/S=0)" {
    style: { fill: "#002244"; stroke: "#0066cc"; font-color: "#66aaff" }
  }

  p_rodata: ".rodata — Read-only Data (R, U/S=0)" {
    style: { fill: "#002244"; stroke: "#0066cc"; font-color: "#66aaff" }
  }

  p_data: ".data — Initialized Globals (R/W, U/S=0)" {
    style: { fill: "#002244"; stroke: "#0055bb"; font-color: "#5599ff" }
  }

  p_bss_start: "__bss_start — linker symbol (EDI start)" {
    style: { fill: "#1a3300"; stroke: "#55aa00"; font-color: "#aaff44"; bold: true }
  }

  p_bss: ".bss — Uninitialized (NOT in ELF, must zero!)" {
    style: { fill: "#1a3300"; stroke: "#55aa00"; font-color: "#aaff44" }
  }

  p_bss_end: "__bss_end — linker symbol (ECX limit)" {
    style: { fill: "#1a3300"; stroke: "#55aa00"; font-color: "#aaff44"; bold: true }
  }

  p_stack: "Kernel Stack (grows down from kernel_stack_top)" {
    style: { fill: "#1a1a00"; stroke: "#888800"; font-color: "#dddd44" }
  }

  p_heap: "Heap Region (grows up, PMM-backed frames)" {
    style: { fill: "#1a0033"; stroke: "#770099"; font-color: "#dd44ff" }
  }

  p_zero -> p_bda: "256 bytes" { style: { stroke: "#4444aa"; stroke-dash: 3 } }
  p_bda -> p_low: "BIOS data" { style: { stroke: "#4444aa"; stroke-dash: 3 } }
  p_low -> p_mbr: "~30KB free" { style: { stroke: "#aa7700"; stroke-dash: 3 } }
  p_mbr -> p_stage2: "BIOS loads MBR then jumps" { style: { stroke: "#aa7700" } }
  p_stage2 -> p_ebda: "stage2 runs" { style: { stroke: "#aa3333"; stroke-dash: 3 } }
  p_ebda -> p_vga: "avoid EBDA" { style: { stroke: "#3388cc"; stroke-dash: 3 } }
  p_vga -> p_rom: "0xB8000 MMIO" { style: { stroke: "#884488"; stroke-dash: 3 } }
  p_rom -> p_1mb: "firmware ROM" { style: { stroke: "#aaaa00"; stroke-width: 2 } }
  p_1mb -> p_kernel: "A20 must be enabled" { style: { stroke: "#00aa44"; stroke-width: 3 } }
  p_kernel -> p_text: "sections in order" { style: { stroke: "#0066cc"; stroke-width: 2 } }
  p_text -> p_rodata: "ALIGN(4) in ld" { style: { stroke: "#0066cc" } }
  p_rodata -> p_data: "ALIGN(4) in ld" { style: { stroke: "#0055bb" } }
  p_data -> p_bss_start: "ALIGN(4096) in ld" { style: { stroke: "#55aa00"; stroke-width: 2 } }
  p_bss_start -> p_bss: "EDI = __bss_start; rep stosd begins" { style: { stroke: "#55aa00"; stroke-width: 2 } }
  p_bss -> p_bss_end: "SHT_NOBITS: 0 bytes in ELF on disk" { style: { stroke: "#55aa00"; stroke-width: 2 } }
  p_bss_end -> p_stack: "ALIGN(16) for SSE ABI" { style: { stroke: "#888800" } }
  p_stack -> p_heap: "grows down from _top symbol" { style: { stroke: "#770099"; stroke-dash: 5 } }
}

virt: "Virtual Address Space (After Paging)" {
  style: {
    fill: "#1a2a1a"
    stroke: "#4a8a4a"
    stroke-width: 2
    font-color: "#e0ffe0"
    bold: true
  }

  v_null: "0x00000000 — NULL Guard Page (PTE P=0)" {
    style: { fill: "#2a1a1a"; stroke: "#aa3333"; font-color: "#ffaaaa" }
  }

  v_user: "0x00400000 — User Code (P=1, U/S=1, R/W=0)" {
    style: { fill: "#1a2a3a"; stroke: "#3366aa"; font-color: "#88aaff" }
  }

  v_user_stack: "0x00BFF000 — User Stack (P=1, U/S=1, R/W=1)" {
    style: { fill: "#1a2a3a"; stroke: "#3366aa"; font-color: "#88aaff" }
  }

  v_identity: "0x0-0x3FFFFF — Identity Map PDE[0] (TEMPORARY)" {
    style: { fill: "#2a2a00"; stroke: "#888800"; font-color: "#ffff44"; stroke-dash: 4 }
  }

  v_vga_mmio: "0x000B8000 — VGA MMIO (volatile, PCD=1 uncacheable)" {
    style: { fill: "#1a2a3a"; stroke: "#3388cc"; font-color: "#88ddff" }
  }

  v_split: "0xC0000000 — Kernel/User Split (3GB/1GB)" {
    style: { fill: "#333300"; stroke: "#aaaa00"; font-color: "#ffff44"; bold: true }
  }

  v_ktext: "0xC0100000 — .text VMA (phys: 0x00100000)" {
    style: { fill: "#002244"; stroke: "#0066cc"; font-color: "#66aaff"; bold: true }
  }

  v_krodata: "0xC01xxxxx — .rodata VMA (P=1, R/W=0, G=1)" {
    style: { fill: "#002244"; stroke: "#0066cc"; font-color: "#66aaff" }
  }

  v_kdata: "0xC01xxxxx — .data VMA (P=1, R/W=1, G=1)" {
    style: { fill: "#002244"; stroke: "#0055bb"; font-color: "#5599ff" }
  }

  v_kbss: "0xC01xxxxx — .bss VMA (__bss_start to __bss_end)" {
    style: { fill: "#1a3300"; stroke: "#55aa00"; font-color: "#aaff44" }
  }

  v_kstack: "0xC01xxxxx — Kernel Stack (TSS.ESP0 = kernel_stack_top)" {
    style: { fill: "#1a1a00"; stroke: "#888800"; font-color: "#dddd44" }
  }

  v_heap_virt: "0xD0000000 — Kernel Heap (256MB, on-demand PMM frames)" {
    style: { fill: "#1a0033"; stroke: "#770099"; font-color: "#dd44ff" }
  }

  v_apic: "0xFEE00000 — Local APIC MMIO (PCD=1 uncacheable)" {
    style: { fill: "#2d1a2d"; stroke: "#884488"; font-color: "#ddaadd" }
  }

  v_null -> v_user: "user space 0x0-0xBFFFFFFF" { style: { stroke: "#3366aa"; stroke-dash: 3 } }
  v_user -> v_user_stack: "user code mapped" { style: { stroke: "#3366aa"; stroke-dash: 3 } }
  v_user_stack -> v_identity: "user stack" { style: { stroke: "#888800"; stroke-dash: 5 } }
  v_identity -> v_vga_mmio: "covers 0xB8000" { style: { stroke: "#3388cc" } }
  v_vga_mmio -> v_split: "identity region ends" { style: { stroke: "#aaaa00"; stroke-width: 2 } }
  v_split -> v_ktext: "PDE[768] installed by vmm_init()" { style: { stroke: "#0066cc"; stroke-width: 2 } }
  v_ktext -> v_krodata: "linker places after .text" { style: { stroke: "#0066cc" } }
  v_krodata -> v_kdata: "linker places after .rodata" { style: { stroke: "#0055bb" } }
  v_kdata -> v_kbss: "ALIGN(4096) boundary" { style: { stroke: "#55aa00" } }
  v_kbss -> v_kstack: "ALIGN(16) for SSE ABI" { style: { stroke: "#888800" } }
  v_kstack -> v_heap_virt: "heap starts at 0xD0000000" { style: { stroke: "#770099"; stroke-dash: 5 } }
  v_heap_virt -> v_apic: "MMIO above heap" { style: { stroke: "#884488"; stroke-dash: 3 } }
}

linker: "kernel.ld + Build Pipeline" {
  style: {
    fill: "#1a1a1a"
    stroke: "#666666"
    stroke-width: 2
    font-color: "#cccccc"
    bold: true
  }

  ld_script: "Linker Script (identity-mapped)" {
    style: { fill: "#0d1a0d"; stroke: "#336633"; font-color: "#88cc88" }
  }

  ld_content: |'go
    ENTRY(kernel_entry)
    SECTIONS {
      . = 0x00100000;
      .text   : { *(.text) }
      .rodata : { *(.rodata) }
      .data   : { *(.data) }
      . = ALIGN(4096);
      __bss_start = .;
      .bss : { *(.bss) *(COMMON) }
      __bss_end = .;
      . = ALIGN(16);
      kernel_stack = .;
      . += 0x4000;
      kernel_stack_top = .;
    }
'|

  bss_routine: "BSS Zero Routine (before kmain)" {
    style: { fill: "#0d1a0d"; stroke: "#336633"; font-color: "#88cc88" }
  }

  bss_asm: |'go
    mov edi, __bss_start
    mov ecx, __bss_end
    sub ecx, edi
    xor eax, eax
    shr ecx, 2
    rep stosd
'|

  build_cmd: |'go
    gcc -m32 -ffreestanding -nostdlib
        -nostdinc -fno-builtin
        -c kernel.c -o kernel.o
    ld -T kernel.ld -o kernel.elf *.o
    objcopy -O binary kernel.elf kernel.bin
    nm kernel.elf | grep bss
    objdump -h kernel.elf
'|

  ld_script -> ld_content: "script text" { style: { stroke: "#336633" } }
  ld_content -> bss_routine: "__bss_start and __bss_end as absolute symbols" { style: { stroke: "#55aa00"; stroke-width: 2 } }
  bss_routine -> bss_asm: "must run before any C global access" { style: { stroke: "#336633" } }
  bss_asm -> build_cmd: "LMA=VMA=0x100000 identity mapped at boot" { style: { stroke: "#555599" } }
}

bss_detail: "BSS: Disk vs RAM vs Zeroed" {
  style: {
    fill: "#0d1a0d"
    stroke: "#336633"
    stroke-width: 2
    font-color: "#aaffaa"
    bold: true
  }

  on_disk: "On Disk: SHT_NOBITS (0 bytes stored)" {
    style: { fill: "#1a2a1a"; stroke: "#447744"; font-color: "#88cc88" }
  }

  in_ram: "In RAM after load: GARBAGE (BIOS POST patterns)" {
    style: { fill: "#2a1a1a"; stroke: "#aa3333"; font-color: "#ffaaaa" }
  }

  zeroed: "After rep stosd: all zeros — kmain safe" {
    style: { fill: "#0d2a0d"; stroke: "#55aa55"; font-color: "#aaffaa" }
  }

  on_disk -> in_ram: "bootloader copies ELF segments; BSS has no bytes to copy" { style: { stroke: "#447744" } }
  in_ram -> zeroed: "kernel_entry.asm rep stosd: (__bss_end - __bss_start)/4 iters" { style: { stroke: "#55aa55"; stroke-width: 2 } }
}

paging_seq: "Paging Enable: Mandatory Order" {
  style: {
    fill: "#1a0d00"
    stroke: "#cc6600"
    stroke-width: 2
    font-color: "#ffaa44"
    bold: true
  }

  s1: "1. Build page tables while paging OFF" {
    style: { fill: "#2a1a00"; stroke: "#aa5500"; font-color: "#ffcc44" }
  }

  s1n: "PDE[0]=identity_pt, PDE[768]=kernel_pt" {
    style: { fill: "#1a1000"; stroke: "#776600"; font-color: "#ccaa44" }
  }

  s2: "2. Load CR3 with PHYSICAL PD address" {
    style: { fill: "#2a1a00"; stroke: "#aa5500"; font-color: "#ffcc44" }
  }

  s2n: "mov cr3, pd_phys; TLB flushed on CR3 write" {
    style: { fill: "#1a1000"; stroke: "#776600"; font-color: "#ccaa44" }
  }

  s3: "3. Set CR0.PG=1 — POINT OF NO RETURN" {
    style: { fill: "#3a0000"; stroke: "#cc0000"; font-color: "#ff4444"; bold: true }
  }

  s3n: "or cr0, 0x80000000; next fetch goes through page tables" {
    style: { fill: "#2a0000"; stroke: "#880000"; font-color: "#ff8888" }
  }

  s4: "4. Far jump to flush pipeline" {
    style: { fill: "#2a1a00"; stroke: "#aa5500"; font-color: "#ffcc44" }
  }

  s4n: "jmp via fn-ptr to higher-half; remove PDE[0]=0; reload CR3" {
    style: { fill: "#1a1000"; stroke: "#776600"; font-color: "#ccaa44" }
  }

  s1 -> s1n { style: { stroke: "#aa5500" } }
  s1n -> s2: "tables ready" { style: { stroke: "#cc6600"; stroke-width: 2 } }
  s2 -> s2n { style: { stroke: "#aa5500" } }
  s2n -> s3: "CR3 valid" { style: { stroke: "#cc0000"; stroke-width: 2 } }
  s3 -> s3n { style: { stroke: "#cc0000" } }
  s3n -> s4: "paging active; identity map live" { style: { stroke: "#cc6600"; stroke-width: 2 } }
  s4 -> s4n { style: { stroke: "#aa5500" } }
}

phys.p_kernel -> virt.v_ktext: "Higher-half map (permanent): virt 0xC0100000 -> phys 0x00100000; PDE[768] U/S=0 G=1" {
  style: { stroke: "#0088ff"; stroke-width: 3; animated: true }
}

phys.p_kernel -> virt.v_identity: "Identity map (boot only): virt=phys=0x00100000; PDE[0] REMOVED after jump" {
  style: { stroke: "#00cc66"; stroke-width: 2; stroke-dash: 5 }
}

phys.p_vga -> virt.v_vga_mmio: "MMIO identity map: 0xB8000=0xB8000; volatile uint16_t*; PTE PCD=1 uncacheable" {
  style: { stroke: "#3388cc"; stroke-width: 2 }
}

phys.p_bss_start -> linker.bss_routine: "__bss_start exported by ld as absolute symbol" {
  style: { stroke: "#55aa00"; stroke-dash: 3 }
}

phys.p_bss_end -> linker.bss_routine: "__bss_end exported by ld as absolute symbol" {
  style: { stroke: "#55aa00"; stroke-dash: 3 }
}

phys.p_bss -> bss_detail: "SHT_NOBITS section; 128KB frame_bitmap in BSS" {
  style: { stroke: "#55aa00"; stroke-dash: 3 }
}

linker -> phys: "LMA set by . = 0x00100000 in SECTIONS" {
  style: { stroke: "#666666"; stroke-dash: 3 }
}

linker -> virt: "VMA=LMA here (identity); higher-half uses offset in script" {
  style: { stroke: "#666666"; stroke-dash: 3 }
}

paging_seq -> virt.v_split: "result: kernel at 0xC0000000+; user at 0x0-0xBFFFFFFF" {
  style: { stroke: "#cc6600"; stroke-dash: 3 }
}