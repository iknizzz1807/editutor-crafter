vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  ## Exception Cascading: Fault → Double Fault → Triple Fault
  *x86 Exception Delivery State Machine — CPU Reset is Irreversible*
| {near: top-center}
back_to_map: "↖ Satellite Map" {
  link: "#diag-satellite-os-map"
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4aff"
    font-color: "#aaaaff"
    font-size: 12
    border-radius: 6
  }
}
classes: {
  state_normal: {
    style: {
      fill: "#1e3a2f"
      stroke: "#2ecc71"
      font-color: "#aaffcc"
      border-radius: 6
      bold: true
    }
  }
  state_fault: {
    style: {
      fill: "#3a2a1a"
      stroke: "#f39c12"
      font-color: "#ffd080"
      border-radius: 6
      bold: true
    }
  }
  state_critical: {
    style: {
      fill: "#3a1a1a"
      stroke: "#e74c3c"
      font-color: "#ffaaaa"
      border-radius: 6
      bold: true
    }
  }
  state_dead: {
    style: {
      fill: "#2a0a0a"
      stroke: "#8b0000"
      font-color: "#ff6666"
      border-radius: 6
      bold: true
      double-border: true
    }
  }
  annotation: {
    style: {
      fill: "#1a1a2e"
      stroke: "#334"
      font-color: "#8888bb"
      font-size: 11
      border-radius: 4
      italic: true
    }
  }
  hardware_struct: {
    style: {
      fill: "#1a2035"
      stroke: "#4466aa"
      font-color: "#88aadd"
      border-radius: 4
      font-size: 11
    }
  }
  guard: {
    style: {
      fill: "#251830"
      stroke: "#9b59b6"
      font-color: "#cc99ff"
      border-radius: 4
      font-size: 11
      italic: true
    }
  }
}
# ── LANE 0: NORMAL EXECUTION ──────────────────────────────────────────────────
lane0: "LANE 0 — Normal CPU Execution" {
  style: {
    fill: "#0d1a0d"
    stroke: "#2ecc71"
    font-color: "#2ecc71"
    font-size: 12
  }
  S0: "RUNNING\nCPU executing instruction stream\nCPL=0 or CPL=3\nIDT loaded & valid" {
    class: state_normal
    link: "#diag-m1-real-to-protected-transition"
  }
}
# ── LANE 1: FIRST EXCEPTION ───────────────────────────────────────────────────
lane1: "LANE 1 — First Exception (Any Vector 0–31 or IRQ)" {
  style: {
    fill: "#1a1200"
    stroke: "#f39c12"
    font-color: "#f39c12"
    font-size: 12
  }
  S1_trigger: "FAULT TRIGGER\nExamples:\n• #PF (14): NULL deref — CR2 = 0x00000000\n• #GP (13): ring-3 access to kernel segment\n• #DE (0): divide by zero\n• IRQ — timer, keyboard" {
    class: state_fault
  }
  S1_cpu_lookup: "CPU: IDT VECTOR LOOKUP\nRead IDTR register → IDT base address\nFetch IDT[vector] — 8-byte gate descriptor\nCheck: gate.P == 1 ?\nCheck: CPL ≤ gate.DPL ?\nCheck: gate.selector → valid GDT code seg?" {
    class: state_fault
  }
  S1_stack_switch: "CPU: STACK SETUP\nIF privilege change (CPL > gate DPL):\n  Read TSS.SS0 and TSS.ESP0\n  Switch to kernel stack\nPush onto kernel stack:\n  [SS, ESP]   ← only if CPL changed\n  EFLAGS\n  CS\n  EIP  ← return address\n  error_code  ← for #PF, #GP, #DF, #TS, #NP, #SS" {
    class: state_fault
  }
  S1_handler_enter: "HANDLER ENTERED\nisr_N stub running at ring 0\nESP = kernel stack (with pushed frame)\nIDT gate type = interrupt gate → IF cleared\nAll GPRs still contain old process values!\nNO automatic GPR save by hardware" {
    class: state_normal
  }
  idt_struct: "IDT Entry (8 bytes)\n─────────────────────────\nbits 63–48 : handler addr [31:16]\nbits 47    : Present (P)\nbits 46–45 : DPL\nbits 44    : 0\nbits 43–40 : type (1110=IntGate)\nbits 39–32 : reserved\nbits 31–16 : GDT selector\nbits 15–0  : handler addr [15:0]" {
    class: hardware_struct
  }
}
# ── LANE 2: DOUBLE FAULT PATH ─────────────────────────────────────────────────
lane2: "LANE 2 — Double Fault Escalation (#DF, Vector 8)" {
  style: {
    fill: "#1a0808"
    stroke: "#e74c3c"
    font-color: "#e74c3c"
    font-size: 12
  }
  S2_delivery_fail: "EXCEPTION DELIVERY FAILED\nTrigger conditions (during S1 dispatch):\n• IDT[vector].P == 0  (gate not present)\n• IDT[vector].selector → invalid GDT entry\n• SS:ESP for kernel stack not mapped\n• GPF during IDT read itself (#GP in #GP)\n• Stack overflow on kernel stack → #SS" {
    class: state_critical
  }
  S2_combinatorial: "COMBINATORIAL FAULT TABLE\n(Intel SDM Vol.3 §6.3.3)\n────────────────────────────────────\nFirst  │ Second       │ Result\n────────────────────────────────────\n#DE    │ #DE          │ → #DF\n#TS    │ {almost any} │ → #DF\n#NP    │ {almost any} │ → #DF\n#SS    │ #SS          │ → #DF\n#GP    │ #GP          │ → #DF\n#PF    │ #PF / #GP    │ → #DF\n────────────────────────────────────\n#DF itself (any 2nd except #MC, NMI)\n→ Triple Fault" {
    class: state_critical
  }
  S2_df_dispatch: "CPU: DOUBLE FAULT DISPATCH\nVector = 8 (#DF)\nError code always = 0 (fixed by architecture)\nCPU attempts IDT[8] lookup\nRequires VALID IDT[8] gate\nRequires ACCESSIBLE kernel stack\n\nWARNING: If current kernel stack is corrupt,\nESP0 from TSS must point to SEPARATE stack\n(Task Gate → separate TSS with own ESP0)" {
    class: state_critical
  }
  S2_df_handler: "#DF HANDLER RUNNING\nLast chance for diagnostics:\n• Print EIP, ESP, EFLAGS from frame\n• Print error context\n• Halt: cli; hlt\n\nCannot recover — #DF is ABORT class\nProcess (or kernel) state is undefined\nOnly safe action: halt or reboot" {
    class: state_critical
  }
  df_stack_note: "⚠ Dedicated #DF Stack\nRobust implementation uses\nTask Gate for IDT[8]:\n• Points to separate mini-TSS\n• That TSS has its own ESP0\n• Even if kernel stack is blown,\n  #DF handler can still execute\nWithout this: corrupt ESP0\n→ #DF delivery fails\n→ immediate triple fault" {
    class: guard
  }
}
# ── LANE 3: TRIPLE FAULT → RESET ─────────────────────────────────────────────
lane3: "LANE 3 — Triple Fault (CPU Reset — No Recovery Possible)" {
  style: {
    fill: "#0f0000"
    stroke: "#8b0000"
    font-color: "#cc4444"
    font-size: 12
  }
  S3_triple: "TRIPLE FAULT\nCPU has NO remaining exception vector to invoke\nSilent — no error code, no message, no log\nCPU asserts RESET# signal on system bus\nChipset interprets RESET# → full system reset\n\nOccurs when:\n• #DF handler itself faults (any exception)\n• IDT[8] not present\n• Stack for #DF delivery is also inaccessible" {
    class: state_dead
  }
  S3_cpu_reset: "CPU RESET STATE\nAll registers → architectural reset values\nCS:EIP = 0xFFFF:0xFFF0 (real mode reset vector)\nPE bit in CR0 = 0 (real mode)\nAll protected-mode structures: irrelevant\nBIOS begins POST sequence\nKernel never sees this event" {
    class: state_dead
    link: "#diag-m1-boot-sequence-timeline"
  }
  qemu_debug: "QEMU Diagnosis\n─────────────────────\nqemu ... -d int,cpu_reset \\\n         -no-reboot\n\nOutput on triple fault:\n  check exception 8 [#DF]\n  check exception 13 [#GP]\n  ... (rapid cascade)\n  CPU Reset\n\nFirst exception = actual bug\nSubsequent = delivery failures" {
    class: hardware_struct
  }
}
# ── BEFORE/AFTER PANEL ────────────────────────────────────────────────────────
before_after: "BEFORE vs AFTER: Working #DF Handler" {
  style: {
    fill: "#0a0a14"
    stroke: "#334466"
    font-color: "#888899"
    font-size: 12
  }
  before: "BEFORE (No IDT / Bad IDT)\n──────────────────────────────\nNULL deref at 0x00000000\n  → #PF fires\n  → IDT not loaded (M1 early boot)\n  → CPU tries IDT[14]\n  → GP fault (IDT not valid)\n  → CPU tries IDT[13] for the GP\n  → another fault\n  → CPU tries IDT[8] for DF\n  → another fault\n  → TRIPLE FAULT\n  → silent machine reset\n\nDebugging: impossible\nEvidence: machine reboots" {
    style: {
      fill: "#1a0a0a"
      stroke: "#cc4444"
      font-color: "#ffaaaa"
      border-radius: 4
      font-size: 11
    }
  }
  after: "AFTER (M2: IDT + PIC remapped)\n──────────────────────────────\nNULL deref at 0x00000000\n  → #PF fires (vector 14)\n  → IDT[14] valid: isr_14 called\n  → isr_common_stub → C handler\n  → page_fault_handler() runs:\n      CR2 = 0x00000000\n      err=0 (not present, read)\n      EIP = faulting address\n  → kprintf diagnostic\n  → hlt\n\nDebugging: immediate diagnosis\nEvidence: error message on screen" {
    style: {
      fill: "#0a1a0a"
      stroke: "#2ecc71"
      font-color: "#aaffaa"
      border-radius: 4
      font-size: 11
    }
  }
}
# ── CONNECTIONS: NORMAL FLOW ──────────────────────────────────────────────────
lane0.S0 -> lane1.S1_trigger: "Exception/Interrupt fires\n(hardware or software)" {
  style: {
    stroke: "#f39c12"
    font-color: "#f39c12"
    bold: true
    font-size: 11
  }
}
lane1.S1_trigger -> lane1.S1_cpu_lookup: "CPU begins delivery\n(hardware-automatic)" {
  style: { stroke: "#f39c12"; font-color: "#aaaaaa"; font-size: 10 }
}
lane1.S1_cpu_lookup -> lane1.S1_stack_switch: "Gate valid, privilege check passes\n[GUARD: P=1, DPL≥CPL, selector valid]" {
  style: { stroke: "#f39c12"; font-color: "#aaaaaa"; font-size: 10 }
}
lane1.S1_stack_switch -> lane1.S1_handler_enter: "Kernel stack accessible\nTSS.ESP0 valid (if ring change)" {
  style: { stroke: "#2ecc71"; font-color: "#aaaaaa"; font-size: 10 }
}
lane1.S1_handler_enter -> lane0.S0: "iretd executed\nEFLAGS/CS/EIP/ESP/SS restored\n(fault was handled)" {
  style: {
    stroke: "#2ecc71"
    font-color: "#2ecc71"
    stroke-dash: 5
    font-size: 10
    bold: true
  }
}
# ── CONNECTIONS: FAULT DURING DELIVERY ───────────────────────────────────────
lane1.S1_cpu_lookup -> lane2.S2_delivery_fail: "DELIVERY FAULT\n[gate not present OR\nselector invalid OR\nGP fault during IDT read]" {
  style: {
    stroke: "#e74c3c"
    font-color: "#e74c3c"
    bold: true
    font-size: 11
    stroke-width: 3
  }
}
lane1.S1_stack_switch -> lane2.S2_delivery_fail: "STACK FAULT\n[TSS.ESP0 not mapped OR\n#SS during push OR\nkernel stack overflow]" {
  style: {
    stroke: "#e74c3c"
    font-color: "#e74c3c"
    bold: true
    font-size: 11
    stroke-width: 3
  }
}
lane1.S1_handler_enter -> lane2.S2_delivery_fail: "SECOND FAULT IN HANDLER\n[handler itself causes exception:\ne.g. #GP(handler) → #DF\nor #PF in handler code]" {
  style: {
    stroke: "#e74c3c"
    font-color: "#cc8800"
    bold: true
    font-size: 11
    stroke-width: 3
    stroke-dash: 3
  }
}
lane2.S2_delivery_fail -> lane2.S2_combinatorial: "CPU classifies:\nfirst + second exception\nvia combinatorial table" {
  style: { stroke: "#e74c3c"; font-color: "#aaaaaa"; font-size: 10 }
}
lane2.S2_combinatorial -> lane2.S2_df_dispatch: "Result = #DF\n(vectors 8, error_code=0)" {
  style: {
    stroke: "#e74c3c"
    font-color: "#e74c3c"
    bold: true
    font-size: 11
  }
}
lane2.S2_df_dispatch -> lane2.S2_df_handler: "IDT[8] valid &\nDedicated stack accessible" {
  style: { stroke: "#9b59b6"; font-color: "#cc99ff"; font-size: 10 }
}
lane2.S2_df_handler -> lane0.S0: "Halted (cli; hlt)\nKernel restart required\n(controlled shutdown)" {
  style: {
    stroke: "#9b59b6"
    font-color: "#9b59b6"
    stroke-dash: 5
    font-size: 10
  }
}
lane2.S2_df_dispatch -> lane3.S3_triple: "IDT[8] INVALID or\n#DF delivery itself faults\n(stack inaccessible, gate P=0)" {
  style: {
    stroke: "#8b0000"
    font-color: "#cc4444"
    bold: true
    font-size: 12
    stroke-width: 4
  }
}
lane2.S2_df_handler -> lane3.S3_triple: "#DF handler itself throws exception\n(ANY exception during #DF = Triple Fault)" {
  style: {
    stroke: "#8b0000"
    font-color: "#cc4444"
    bold: true
    font-size: 11
    stroke-width: 3
  }
}
lane3.S3_triple -> lane3.S3_cpu_reset: "RESET# asserted on bus\nChipset performs\nhardware reset cycle" {
  style: {
    stroke: "#8b0000"
    font-color: "#cc4444"
    bold: true
    font-size: 12
    stroke-width: 4
  }
}
lane3.S3_cpu_reset -> lane0.S0: "BIOS POST →\nbootloader →\nkernel restart\n(cold boot)" {
  style: {
    stroke: "#555555"
    font-color: "#888888"
    stroke-dash: 8
    font-size: 10
  }
}
# ── ANNOTATION CONNECTIONS ────────────────────────────────────────────────────
lane1.idt_struct -> lane1.S1_cpu_lookup: "CPU reads this\nper-interrupt" {
  style: { stroke: "#4466aa"; font-color: "#4466aa"; stroke-dash: 4; font-size: 10 }
}
lane2.df_stack_note -> lane2.S2_df_dispatch: "Mitigation: use\nTask Gate for IDT[8]" {
  style: { stroke: "#9b59b6"; font-color: "#9b59b6"; stroke-dash: 4; font-size: 10 }
}
lane3.qemu_debug -> lane3.S3_triple: "Observing triple faults\nduring development" {
  style: { stroke: "#4466aa"; font-color: "#4466aa"; stroke-dash: 4; font-size: 10 }
}
before_after.before -> before_after.after: "Install IDT (M2)\nRemap PIC before sti" {
  style: {
    stroke: "#2ecc71"
    font-color: "#2ecc71"
    bold: true
    font-size: 11
  }
}