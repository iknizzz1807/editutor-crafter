vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Exception Chaining: Triple Fault Anatomy
  **x86 Fault Escalation â€” From IRQ to RESET Pin**
| {near: top-center}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# COLOR LEGEND
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
legend: {
  near: bottom-right
  label: "Color Semantics"
  style: {
    fill: "#1a1a2e"
    stroke: "#444466"
    border-radius: 8
    font-size: 13
  }
  g: "ðŸŸ¢ Green = safe / success path" { shape: text; style.font-color: "#88ff88" }
  y: "ðŸŸ¡ Yellow = warning / recoverable" { shape: text; style.font-color: "#ffdd88" }
  r: "ðŸ”´ Red = hot path / danger" { shape: text; style.font-color: "#ff6666" }
  p: "ðŸŸ£ Purple = CPU hardware action" { shape: text; style.font-color: "#cc88ff" }
  b: "ðŸ”µ Blue = data / memory reads" { shape: text; style.font-color: "#88aaff" }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SCENARIO 1 â€” NORMAL EXCEPTION (GREEN PATH)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s1: Scenario 1: Normal Exception (Healthy Kernel) {
  style: {
    fill: "#0a1f0a"
    stroke: "#22aa22"
    stroke-width: 2
    border-radius: 10
    font-color: "#88ff88"
    font-size: 15
    bold: true
  }

  s1_trigger: |md
    **Fault Event**
    e.g. divide-by-zero
    executing user code
    `int` or CPU exception
  | {
    style: { fill: "#0d2a0d"; stroke: "#33cc33"; border-radius: 6; font-color: "#aaffaa" }
  }

  s1_idt: |md
    **IDT Lookup**
    CPU reads vector N from
    IDT (properly set up)
    Gate descriptor valid âœ“
    Handler addr resolved
  | {
    style: { fill: "#112211"; stroke: "#22aa22"; border-radius: 6; font-color: "#88ff88" }
  }

  s1_stack: |md
    **CPU Pushes Frame**
    (kernel stack, ESP from TSS)
    EFLAGS, CS, EIP
    [SS, ESP if ring-3]
    Error code (if applicable)
  | {
    style: { fill: "#0a1a0a"; stroke: "#1a8a1a"; border-radius: 6; font-color: "#77ee77" }
  }

  s1_handler: |md
    **Handler Executes**
    `pusha` saves registers
    C handler runs cleanly
    No nested fault occurs
    EOI sent (if IRQ)
  | {
    style: { fill: "#0a200a"; stroke: "#33bb33"; border-radius: 6; font-color: "#99ff99" }
  }

  s1_iret: |md
    **`iret` Resumes**
    Pops EIP, CS, EFLAGS
    [ESP, SS for ring-3]
    Interrupted code resumes
    âœ… System continues
  | {
    style: { fill: "#112b11"; stroke: "#44dd44"; border-radius: 6; font-color: "#aaffaa" }
  }

  s1_trigger -> s1_idt: "exception fires\n(synchronous or IRQ)" {
    style: { stroke: "#33cc33"; font-color: "#88ff88"; font-size: 12 }
  }
  s1_idt -> s1_stack: "gate found\nDPL check passes" {
    style: { stroke: "#22aa22"; font-color: "#77ee77"; font-size: 12 }
  }
  s1_stack -> s1_handler: "ring transition\n+ frame pushed" {
    style: { stroke: "#22aa22"; font-color: "#77ee77"; font-size: 12 }
  }
  s1_handler -> s1_iret: "popa + add esp,8\nthen iret" {
    style: { stroke: "#44dd44"; font-color: "#aaffaa"; font-size: 12 }
  }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SCENARIO 2 â€” DOUBLE FAULT (YELLOW / WARNING)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s2: Scenario 2: Double Fault (Recoverable if Handler Exists) {
  style: {
    fill: "#1f1a00"
    stroke: "#ccaa00"
    stroke-width: 2
    border-radius: 10
    font-color: "#ffdd88"
    font-size: 15
    bold: true
  }

  s2_fault1: |md
    **First Fault**
    e.g. GPF, page fault
    or bad segment access
    during kernel execution
  | {
    style: { fill: "#2a2200"; stroke: "#bbaa00"; border-radius: 6; font-color: "#ffee99" }
  }

  s2_handler_bad: |md
    **Handler Faults!**
    Kernel exception handler
    itself raises an exception
    (stack overflow, null ptr,
    bad IDT gate, etc.)
  | {
    style: { fill: "#2a1800"; stroke: "#ff8800"; border-radius: 6; font-color: "#ffcc66"; bold: true }
  }

  s2_df_lookup: |md
    **CPU Invokes Vector 8**
    Double Fault = exception 8
    CPU looks up IDT[8]
    Requires valid gate
    Error code pushed = 0
  | {
    style: { fill: "#221a00"; stroke: "#cc9900"; border-radius: 6; font-color: "#ffdd77" }
  }

  s2_df_handler: |md
    **Double Fault Handler**
    (vector 8, error code=0)
    Must NOT fault again
    Print diagnostics
    Halt: `cli; hlt`
    âš ï¸ Recoverable here
  | {
    style: { fill: "#2a2200"; stroke: "#ddbb00"; border-radius: 6; font-color: "#ffee88" }
  }

  s2_causes: |md
    **Common Causes of Handler Fault**
    â€¢ Stack overflow in ISR (ESP invalid)
    â€¢ Null pointer dereference in handler
    â€¢ BSS not zeroed (global = garbage)
    â€¢ pusha/popa mismatch â†’ corrupt ESP
    â€¢ Missing `volatile` â†’ bad MMIO write
  | {
    style: { fill: "#1a1400"; stroke: "#aa8800"; border-radius: 6; font-color: "#ddbb66"; font-size: 12 }
  }

  s2_fault1 -> s2_handler_bad: "CPU invokes\nfirst handler" {
    style: { stroke: "#ccaa00"; font-color: "#ffdd88"; font-size: 12 }
  }
  s2_handler_bad -> s2_df_lookup: "nested fault!\n(fault-in-handler)" {
    style: { stroke: "#ff8800"; font-color: "#ffcc66"; font-size: 12; bold: true }
  }
  s2_df_lookup -> s2_df_handler: "IDT[8] valid\nâ†’ handler runs" {
    style: { stroke: "#bbaa00"; font-color: "#ffee88"; font-size: 12 }
  }
  s2_causes -> s2_handler_bad: "what causes\nthe nested fault" {
    style: { stroke: "#aa8800"; stroke-dash: 5; font-color: "#ccaa55"; font-size: 11 }
  }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SCENARIO 3 â€” TRIPLE FAULT (RED / FATAL)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s3: "Scenario 3: Triple Fault â†’ RESET (Fatal, Unrecoverable)" {
  style: {
    fill: "#200000"
    stroke: "#ff2222"
    stroke-width: 3
    border-radius: 10
    font-color: "#ff6666"
    font-size: 15
    bold: true
  }

  s3_fault1: |md
    **Original Fault**
    Any exception or IRQ
    fires at the wrong moment
    (before IDT / during setup)
  | {
    style: { fill: "#2a0000"; stroke: "#cc2222"; border-radius: 6; font-color: "#ff8888" }
  }

  s3_df: |md
    **Double Fault**
    Attempt to invoke double
    fault handler (IDT[8])
    also fails â€” invalid gate,
    or handler faults again
  | {
    style: { fill: "#330000"; stroke: "#ff3333"; border-radius: 6; font-color: "#ff9999"; bold: true }
  }

  s3_triple: |md
    **TRIPLE FAULT**
    CPU has NO fallback
    Cannot invoke any handler
    Cannot print any message
    Cannot signal the OS
    âš¡ Asserts RESET# pin
  | {
    style: {
      fill: "#440000"
      stroke: "#ff0000"
      stroke-width: 4
      border-radius: 8
      font-color: "#ffaaaa"
      bold: true
      font-size: 14
      shadow: true
    }
  }

  s3_reset: |md
    **QEMU: Instant Reboot**
    Physical HW: Cold reset
    No error message
    No stack trace
    Appears as: system restarts
    QEMU flag: `-d int` shows
    last interrupt before reset
  | {
    style: { fill: "#3a0000"; stroke: "#dd2222"; border-radius: 6; font-color: "#ff7777" }
  }

  s3_fault1 -> s3_df: "handler faults\nor IDT invalid" {
    style: { stroke: "#cc2222"; font-color: "#ff7777"; font-size: 12 }
  }
  s3_df -> s3_triple: "double fault\nhandler ALSO faults" {
    style: { stroke: "#ff3333"; font-color: "#ff9999"; font-size: 12; bold: true; stroke-width: 3 }
  }
  s3_triple -> s3_reset: "RESET# asserted\nhardware line" {
    style: { stroke: "#ff0000"; font-color: "#ffaaaa"; font-size: 12; bold: true; stroke-width: 3; animated: true }
  }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ROOT CAUSE PANEL â€” THREE SPECIFIC TRIPLE FAULT TRIGGERS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
causes: Root Causes: Specific Triple Fault Triggers {
  style: {
    fill: "#0d0a1a"
    stroke: "#5533aa"
    stroke-width: 2
    border-radius: 10
    font-color: "#cc99ff"
    font-size: 14
    bold: true
  }

  cause_pic: |md
    **â‘  PIC Not Remapped**
    Default: IRQ0 (timer) â†’ vector 8
    Vector 8 = Double Fault handler
    First timer tick (â‰ˆ55ms after `sti`):
    â†’ timer fires IRQ0
    â†’ CPU sees vector 8
    â†’ invokes "double fault handler"
    â†’ this was your timer code, not
      a real double fault handler
    â†’ immediate nested fault
    â†’ **TRIPLE FAULT**

    Fix: `pic_remap(0x20, 0x28)`
    BEFORE calling `sti`
  | {
    style: {
      fill: "#1a0a2a"
      stroke: "#7744cc"
      border-radius: 8
      font-color: "#cc99ff"
      font-size: 12
    }
  }

  cause_stack: |md
    **â‘¡ Stack Overflow in Handler**
    Handler uses too much stack
    OR kernel stack not set up
    OR TSS.ESP0 points to old process
    ESP becomes invalid mid-handler
    â†’ next push triggers stack fault (#SS)
    â†’ fault-in-fault = double fault
    â†’ double fault handler uses same
      broken stack â†’ faults again
    â†’ **TRIPLE FAULT**

    Fix: Per-process kernel stacks
    Update TSS.ESP0 on every switch
    Check KERNEL_STACK_SIZE â‰¥ 4KB
  | {
    style: {
      fill: "#1a0a2a"
      stroke: "#7744cc"
      border-radius: 8
      font-color: "#cc99ff"
      font-size: 12
    }
  }

  cause_idt: |md
    **â‘¢ IDT Not Set Up Before `sti`**
    IDTR points to zero / garbage
    OR IDT has invalid gate entries
    Any interrupt after `sti` fires:
    â†’ CPU reads IDT at address 0
      (real-mode IVT â€” invalid gates)
    â†’ GPF trying to load bad selector
    â†’ fault-in-fault â†’ double fault
    â†’ IDT[8] also invalid â†’ triple
    â†’ **TRIPLE FAULT**

    Fix: `idt_setup_all()` + `lidt`
    THEN `pic_remap()`
    THEN `sti` â€” always in this order
  | {
    style: {
      fill: "#1a0a2a"
      stroke: "#7744cc"
      border-radius: 8
      font-color: "#cc99ff"
      font-size: 12
    }
  }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PIC VECTOR COLLISION DETAIL
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pic_detail: PIC Default vs Remapped: Vector Collision Detail {
  style: {
    fill: "#100a00"
    stroke: "#cc6600"
    stroke-width: 2
    border-radius: 10
    font-color: "#ffaa44"
    font-size: 13
    bold: true
  }

  before: |md
    **BEFORE pic_remap() â€” BROKEN**
    IRQ0  (Timer)    â†’ vector  8  â† DOUBLE FAULT!
    IRQ1  (Keyboard) â†’ vector  9  â† Invalid TSS
    IRQ2  (Cascade)  â†’ vector 10  â† Seg Not Present
    IRQ3  (COM2)     â†’ vector 11  â† Stack Fault
    IRQ4  (COM1)     â†’ vector 12  â† Stack Fault
    IRQ5  (LPT2)     â†’ vector 13  â† GP Fault
    IRQ6  (Floppy)   â†’ vector 14  â† PAGE FAULT!
    IRQ7  (LPT1)     â†’ vector 15  â† Reserved
    IRQ8  (RTC)      â†’ vector 112 (0x70)
  | {
    style: {
      fill: "#2a0800"
      stroke: "#ff6600"
      border-radius: 6
      font-color: "#ffcc88"
      font-size: 11
    }
  }

  after: |md
    **AFTER pic_remap(0x20,0x28) â€” CORRECT**
    IRQ0  (Timer)    â†’ vector 32 âœ“ safe
    IRQ1  (Keyboard) â†’ vector 33 âœ“ safe
    IRQ2  (Cascade)  â†’ vector 34 âœ“ safe
    IRQ3  (COM2)     â†’ vector 35 âœ“ safe
    IRQ4  (COM1)     â†’ vector 36 âœ“ safe
    IRQ5  (LPT2)     â†’ vector 37 âœ“ safe
    IRQ6  (Floppy)   â†’ vector 38 âœ“ safe
    IRQ7  (LPT1)     â†’ vector 39 âœ“ safe
    IRQ8  (RTC)      â†’ vector 40 âœ“ safe
    IRQ15 (Spurious) â†’ vector 47 âœ“ safe
    CPU Exceptions:  vectors 0â€“31 (no collision)
  | {
    style: {
      fill: "#002a00"
      stroke: "#22cc22"
      border-radius: 6
      font-color: "#88ffaa"
      font-size: 11
    }
  }

  before -> after: "pic_remap(0x20, 0x28)\n(call BEFORE sti!)" {
    style: { stroke: "#ffaa00"; font-color: "#ffcc44"; font-size: 12; bold: true }
  }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CORRECT INITIALIZATION ORDER
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init_order: Correct Boot Initialization Order {
  style: {
    fill: "#080f08"
    stroke: "#33aa33"
    stroke-width: 2
    border-radius: 10
    font-color: "#88ff88"
    font-size: 13
    bold: true
  }

  o1: "â‘  idt_setup_all()\nLoad all 256 IDT gates\nlidt [IDTR]" {
    style: { fill: "#0a1a0a"; stroke: "#22aa22"; border-radius: 6; font-color: "#88ee88" }
  }
  o2: "â‘¡ pic_remap(0x20, 0x28)\nIRQ0-7 â†’ 32-39\nIRQ8-15 â†’ 40-47" {
    style: { fill: "#0a1a0a"; stroke: "#22aa22"; border-radius: 6; font-color: "#88ee88" }
  }
  o3: "â‘¢ tss_init() + ltr\nPer-process kernel stacks\nTSS.ESP0 = kernel_stack_top" {
    style: { fill: "#0a1a0a"; stroke: "#22aa22"; border-radius: 6; font-color: "#88ee88" }
  }
  o4: "â‘£ pit_init(100)\nTimer at 100Hz\nIRQ0 handler registered" {
    style: { fill: "#0a1a0a"; stroke: "#22aa22"; border-radius: 6; font-color: "#88ee88" }
  }
  o5: "â‘¤ sti â€” LAST\nNow safe to accept IRQs\nTimer fires â†’ vector 32 âœ“" {
    style: { fill: "#113311"; stroke: "#44dd44"; border-radius: 6; font-color: "#aaffaa"; bold: true }
  }

  o1 -> o2: "IDT valid\nbefore any IRQ" { style: { stroke: "#22aa22"; font-color: "#66ee66"; font-size: 11 } }
  o2 -> o3: "vectors safe\nbefore sti" { style: { stroke: "#22aa22"; font-color: "#66ee66"; font-size: 11 } }
  o3 -> o4: "stacks ready\nbefore timer" { style: { stroke: "#22aa22"; font-color: "#66ee66"; font-size: 11 } }
  o4 -> o5: "all handlers\nregistered" { style: { stroke: "#44dd44"; font-color: "#aaffaa"; font-size: 11 } }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# QEMU DEBUG TIP
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
qemu_tip: QEMU Diagnostic: Catching Triple Faults {
  style: {
    fill: "#0a0a1a"
    stroke: "#4466cc"
    stroke-width: 2
    border-radius: 10
    font-color: "#88aaff"
    font-size: 13
  }

  cmd: |md
    bash
    # Log all interrupts to file; last entry before reboot = triple fault cause
    qemu-system-i386 \
      -drive format=raw,file=os.img \
      -serial stdio \
      -d int 2>interrupts.log

    # Signature of PIC-not-remapped triple fault in log:
    #   v=08 e=0000 i=0 cpl=0 IP=0008:001000xx  â† double fault (timerâ†’vec8)
    #   v=08 e=0000 i=0 cpl=0 IP=0008:001000xx  â† double fault handler faults
    #   [QEMU resets â€” no more entries]

    # Attach GDB for live inspection:
    qemu-system-i386 ... -s -S
    gdb kernel.elf -ex "target remote :1234" \
        -ex "break idt_setup_all" -ex "continue"
    
  | {
    style: { fill: "#080814"; stroke: "#3355bb"; border-radius: 6; font-color: "#99bbff"; font-size: 11 }
  }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CONNECTIONS BETWEEN PANELS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s1 -> s2: "handler itself\nencounters a fault" {
  style: { stroke: "#ccaa00"; stroke-dash: 5; font-color: "#ffdd66"; font-size: 12 }
}
s2 -> s3: "double fault handler\nalso faults" {
  style: { stroke: "#ff4400"; font-color: "#ff8866"; font-size: 12; bold: true; stroke-width: 2 }
}
causes.cause_pic -> s3: "most common cause\n(PIC not remapped)" {
  style: { stroke: "#ff2222"; stroke-dash: 3; font-color: "#ff7777"; font-size: 11 }
}
causes.cause_stack -> s3: "handler stack\ncorruption path" {
  style: { stroke: "#ff2222"; stroke-dash: 3; font-color: "#ff7777"; font-size: 11 }
}
causes.cause_idt -> s3: "no valid handlers\nexist yet" {
  style: { stroke: "#ff2222"; stroke-dash: 3; font-color: "#ff7777"; font-size: 11 }
}
pic_detail -> causes.cause_pic: "detail of\nIRQ0â†’vector 8\ncollision" {
  style: { stroke: "#cc6600"; stroke-dash: 4; font-color: "#ffaa44"; font-size: 11 }
}
init_order -> causes: "prevents all three\ntrigger conditions" {
  style: { stroke: "#33aa33"; font-color: "#88ff88"; font-size: 12 }
}
qemu_tip -> s3: "how to diagnose\ntriple faults" {
  style: { stroke: "#4466cc"; stroke-dash: 4; font-color: "#88aaff"; font-size: 11 }
}