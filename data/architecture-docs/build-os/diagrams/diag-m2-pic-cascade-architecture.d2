vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right
title: |md
  ## 8259 PIC Master/Slave Cascade — Hardware Wiring
  EOI Rule: IRQ0-7 -> EOI to Master only | IRQ8-15 -> EOI to Slave AND Master
| {near: top-center}
back_to_map: "↖ Satellite Map" {
  link: "#diag-satellite-os-map"
  style: {
    fill: "#2d2d2d"
    font-color: "#aaaaaa"
    stroke: "#555555"
    border-radius: 4
    font-size: 11
  }
}
cpu: CPU {
  style: {
    fill: "#1a1a2e"
    stroke: "#4a90d9"
    stroke-width: 3
    font-color: "#e0e0e0"
    bold: true
    font-size: 14
  }
  intr: INTR pin {
    style.fill: "#c0392b"
    style.font-color: white
    style.stroke: "#922b21"
  }
  inta: INTA pin {
    style.fill: "#27ae60"
    style.font-color: white
    style.stroke: "#1e8449"
  }
  data_bus: "Data Bus (D0-D7)" {
    style.fill: "#8e44ad"
    style.font-color: white
    style.stroke: "#6c3483"
  }
}
master_pic: "Master PIC (8259A)" {
  style: {
    fill: "#1a2a1a"
    stroke: "#27ae60"
    stroke-width: 3
    font-color: "#e0e0e0"
    bold: true
    font-size: 13
  }
  ports: I/O Ports {
    style: {
      fill: "#0d1f0d"
      stroke: "#27ae60"
      font-color: "#90ee90"
      font-size: 11
    }
    cmd_port: "0x20 — Command/Status" {
      style.fill: "#1e3a1e"
      style.font-color: "#90ee90"
      style.font-size: 11
    }
    data_port: "0x21 — IMR / Data" {
      style.fill: "#1e3a1e"
      style.font-color: "#90ee90"
      style.font-size: 11
    }
  }
  regs: Internal Registers {
    style: {
      fill: "#0d1f0d"
      stroke: "#27ae60"
      font-color: "#90ee90"
      font-size: 11
    }
    irr: "IRR — Interrupt Request Reg (8 bits)" {
      style.fill: "#152b15"
      style.font-color: "#aaffaa"
      style.font-size: 11
    }
    isr_reg: "ISR — In-Service Register (8 bits)" {
      style.fill: "#152b15"
      style.font-color: "#aaffaa"
      style.font-size: 11
    }
    imr: "IMR — Interrupt Mask Register (8 bits)" {
      style.fill: "#152b15"
      style.font-color: "#aaffaa"
      style.font-size: 11
    }
  }
  irq_lines: "IRQ Lines -> Vector Mapping" {
    style: {
      fill: "#0d1f0d"
      stroke: "#27ae60"
      font-color: "#90ee90"
      font-size: 11
    }
    irq0: "IRQ0 -> Vector 32 (0x20)" {
      style.fill: "#c0392b"
      style.font-color: white
      style.font-size: 11
    }
    irq0_dev: "PIT Timer (1,193,182 Hz)" {
      style.fill: "#2c0b0b"
      style.font-color: "#ff9999"
      style.font-size: 11
    }
    irq1: "IRQ1 -> Vector 33 (0x21)" {
      style.fill: "#e67e22"
      style.font-color: white
      style.font-size: 11
    }
    irq1_dev: "PS/2 Keyboard (8042 ctrl)" {
      style.fill: "#2c1a0b"
      style.font-color: "#ffcc88"
      style.font-size: 11
    }
    irq2: "IRQ2 -> Vector 34 (0x22)" {
      style.fill: "#8e44ad"
      style.font-color: white
      style.font-size: 11
      style.bold: true
    }
    irq2_dev: "CASCADE <- Slave PIC INT line" {
      style.fill: "#2a0d3d"
      style.font-color: "#cc99ff"
      style.font-size: 11
      style.bold: true
    }
    irq3: "IRQ3 -> Vector 35 (0x23)" {
      style.fill: "#2c3e50"
      style.font-color: "#aaaaaa"
      style.font-size: 11
    }
    irq3_dev: "COM2 / COM4 (serial port)" {
      style.fill: "#1a2530"
      style.font-color: "#888888"
      style.font-size: 11
    }
    irq4: "IRQ4 -> Vector 36 (0x24)" {
      style.fill: "#2c3e50"
      style.font-color: "#aaaaaa"
      style.font-size: 11
    }
    irq4_dev: "COM1 / COM3 (serial port)" {
      style.fill: "#1a2530"
      style.font-color: "#888888"
      style.font-size: 11
    }
    irq5: "IRQ5 -> Vector 37 (0x25)" {
      style.fill: "#2c3e50"
      style.font-color: "#aaaaaa"
      style.font-size: 11
    }
    irq5_dev: "LPT2 / Sound Card" {
      style.fill: "#1a2530"
      style.font-color: "#888888"
      style.font-size: 11
    }
    irq6: "IRQ6 -> Vector 38 (0x26)" {
      style.fill: "#2c3e50"
      style.font-color: "#aaaaaa"
      style.font-size: 11
    }
    irq6_dev: "Floppy Disk Controller" {
      style.fill: "#1a2530"
      style.font-color: "#888888"
      style.font-size: 11
    }
    irq7: "IRQ7 -> Vector 39 (0x27)" {
      style.fill: "#2c3e50"
      style.font-color: "#888888"
      style.font-size: 11
    }
    irq7_dev: "LPT1 / Spurious IRQ" {
      style.fill: "#1a2530"
      style.font-color: "#888888"
      style.font-size: 11
    }
  }
}
slave_pic: "Slave PIC (8259A)" {
  style: {
    fill: "#1a1a2e"
    stroke: "#4a90d9"
    stroke-width: 3
    font-color: "#e0e0e0"
    bold: true
    font-size: 13
  }
  ports: I/O Ports {
    style: {
      fill: "#0d0d1f"
      stroke: "#4a90d9"
      font-color: "#88aaff"
      font-size: 11
    }
    cmd_port: "0xA0 — Command/Status" {
      style.fill: "#0d0d2a"
      style.font-color: "#88aaff"
      style.font-size: 11
    }
    data_port: "0xA1 — IMR / Data" {
      style.fill: "#0d0d2a"
      style.font-color: "#88aaff"
      style.font-size: 11
    }
  }
  regs: Internal Registers {
    style: {
      fill: "#0d0d1f"
      stroke: "#4a90d9"
      font-color: "#88aaff"
      font-size: 11
    }
    irr: "IRR — Interrupt Request Reg (8 bits)" {
      style.fill: "#0d1525"
      style.font-color: "#aabbff"
      style.font-size: 11
    }
    isr_reg: "ISR — In-Service Register (8 bits)" {
      style.fill: "#0d1525"
      style.font-color: "#aabbff"
      style.font-size: 11
    }
    imr: "IMR — Interrupt Mask Register (8 bits)" {
      style.fill: "#0d1525"
      style.font-color: "#aabbff"
      style.font-size: 11
    }
  }
  irq_lines: "IRQ Lines -> Vector Mapping" {
    style: {
      fill: "#0d0d1f"
      stroke: "#4a90d9"
      font-color: "#88aaff"
      font-size: 11
    }
    irq8: "IRQ8  -> Vector 40 (0x28)" {
      style.fill: "#1a1a3a"
      style.font-color: "#aabbff"
      style.font-size: 11
    }
    irq8_dev: "RTC (Real-Time Clock)" {
      style.fill: "#0d0d25"
      style.font-color: "#8899dd"
      style.font-size: 11
    }
    irq9: "IRQ9  -> Vector 41 (0x29)" {
      style.fill: "#1a1a3a"
      style.font-color: "#aabbff"
      style.font-size: 11
    }
    irq9_dev: "ACPI / IRQ2 redirect" {
      style.fill: "#0d0d25"
      style.font-color: "#8899dd"
      style.font-size: 11
    }
    irq10: "IRQ10 -> Vector 42 (0x2A)" {
      style.fill: "#1a1a3a"
      style.font-color: "#aabbff"
      style.font-size: 11
    }
    irq10_dev: "Free / NIC (available)" {
      style.fill: "#0d0d25"
      style.font-color: "#8899dd"
      style.font-size: 11
    }
    irq11: "IRQ11 -> Vector 43 (0x2B)" {
      style.fill: "#1a1a3a"
      style.font-color: "#aabbff"
      style.font-size: 11
    }
    irq11_dev: "Free / USB (available)" {
      style.fill: "#0d0d25"
      style.font-color: "#8899dd"
      style.font-size: 11
    }
    irq12: "IRQ12 -> Vector 44 (0x2C)" {
      style.fill: "#1a1a3a"
      style.font-color: "#aabbff"
      style.font-size: 11
    }
    irq12_dev: "PS/2 Mouse" {
      style.fill: "#0d0d25"
      style.font-color: "#8899dd"
      style.font-size: 11
    }
    irq13: "IRQ13 -> Vector 45 (0x2D)" {
      style.fill: "#1a1a3a"
      style.font-color: "#aabbff"
      style.font-size: 11
    }
    irq13_dev: "FPU / Math Coprocessor" {
      style.fill: "#0d0d25"
      style.font-color: "#8899dd"
      style.font-size: 11
    }
    irq14: "IRQ14 -> Vector 46 (0x2E)" {
      style.fill: "#1a1a3a"
      style.font-color: "#aabbff"
      style.font-size: 11
    }
    irq14_dev: "Primary IDE / ATA" {
      style.fill: "#0d0d25"
      style.font-color: "#8899dd"
      style.font-size: 11
    }
    irq15: "IRQ15 -> Vector 47 (0x2F)" {
      style.fill: "#1a1a3a"
      style.font-color: "#8899dd"
      style.font-size: 11
    }
    irq15_dev: "Secondary IDE / Spurious" {
      style.fill: "#0d0d25"
      style.font-color: "#8899dd"
      style.font-size: 11
    }
  }
}
eoi_legend: EOI Protocol {
  style: {
    fill: "#1f1a00"
    stroke: "#f39c12"
    stroke-width: 2
    font-color: "#f5cba7"
    bold: true
    font-size: 12
  }
  rule1: "IRQ0-7:  outb(0x20, 0x20)  -> Master EOI only" {
    style.fill: "#2c2200"
    style.font-color: "#f5cba7"
    style.font-size: 11
    style.font: mono
  }
  rule2: "IRQ8-15: outb(0xA0, 0x20)  -> Slave EOI first" {
    style.fill: "#2c2200"
    style.font-color: "#f5cba7"
    style.font-size: 11
    style.font: mono
  }
  rule3: "         outb(0x20, 0x20)  -> Master EOI second" {
    style.fill: "#2c2200"
    style.font-color: "#f5cba7"
    style.font-size: 11
    style.font: mono
  }
  rule4: "IRQ7/15 SPURIOUS: check ISR bit before EOI!" {
    style.fill: "#3d1a00"
    style.font-color: "#ff9944"
    style.font-size: 11
    style.bold: true
  }
}
remap_note: "PIC Remapping (Required!)" {
  style: {
    fill: "#1f001f"
    stroke: "#9b59b6"
    stroke-width: 2
    font-color: "#d7bde2"
    font-size: 12
  }
  before: "BEFORE remap: IRQ0->Vec8 (Double Fault!), IRQ1->Vec9" {
    style.fill: "#2a002a"
    style.font-color: "#c0392b"
    style.font-size: 11
    style.bold: true
  }
  after: "AFTER  remap: IRQ0->Vec32, IRQ8->Vec40 (safe)" {
    style.fill: "#2a002a"
    style.font-color: "#27ae60"
    style.font-size: 11
    style.bold: true
  }
  icw1: "ICW1: outb(0x20,0x11)  outb(0xA0,0x11)  Init" {
    style.fill: "#1a001a"
    style.font-color: "#bb88ff"
    style.font-size: 11
    style.font: mono
  }
  icw2: "ICW2: outb(0x21,0x20)  outb(0xA1,0x28)  Vectors" {
    style.fill: "#1a001a"
    style.font-color: "#bb88ff"
    style.font-size: 11
    style.font: mono
  }
  icw3: "ICW3: outb(0x21,0x04)  outb(0xA1,0x02)  Cascade" {
    style.fill: "#1a001a"
    style.font-color: "#bb88ff"
    style.font-size: 11
    style.font: mono
  }
  icw4: "ICW4: outb(0x21,0x01)  outb(0xA1,0x01)  8086 mode" {
    style.fill: "#1a001a"
    style.font-color: "#bb88ff"
    style.font-size: 11
    style.font: mono
  }
}
master_pic -> cpu.intr: "INT line asserted (when unmasked IRQ pending)" {
  style.stroke: "#c0392b"
  style.stroke-width: 3
  style.font-color: "#c0392b"
  style.font-size: 11
  style.bold: true
}
cpu.inta -> master_pic: "INTA: acknowledge (CPU reads vector)" {
  style.stroke: "#27ae60"
  style.stroke-width: 2
  style.font-color: "#27ae60"
  style.font-size: 11
}
cpu.data_bus -> master_pic: "Data Bus (8-bit) read/write ICW/OCW" {
  style.stroke: "#8e44ad"
  style.stroke-width: 2
  style.font-color: "#8e44ad"
  style.font-size: 11
  style.stroke-dash: 4
}
cpu.data_bus -> slave_pic: "Data Bus (8-bit) read/write ICW/OCW" {
  style.stroke: "#8e44ad"
  style.stroke-width: 2
  style.font-color: "#8e44ad"
  style.font-size: 11
  style.stroke-dash: 4
}
slave_pic -> master_pic.irq_lines.irq2: "INT -> IRQ2 CASCADE wire (Master ICW3: bit2=1, Slave ICW3: id=2)" {
  style.stroke: "#9b59b6"
  style.stroke-width: 4
  style.font-color: "#9b59b6"
  style.font-size: 11
  style.bold: true
}
eoi_master_path: "EOI path: IRQ0-7 outb(0x20, 0x20)" {
  shape: text
  style.font-color: "#27ae60"
  style.font-size: 11
  style.bold: true
}
eoi_slave_path: "EOI path: IRQ8-15 (1) outb(0xA0,0x20) (2) outb(0x20,0x20)" {
  shape: text
  style.font-color: "#e67e22"
  style.font-size: 11
  style.bold: true
}
eoi_legend -> master_pic: "Controls IRQ0-7 EOI (write 0x20 to port 0x20)" {
  style.stroke: "#27ae60"
  style.stroke-width: 2
  style.font-color: "#27ae60"
  style.font-size: 11
  style.stroke-dash: 3
}
eoi_legend -> slave_pic: "Controls IRQ8-15 EOI (write 0x20 to port 0xA0 THEN EOI to master)" {
  style.stroke: "#e67e22"
  style.stroke-width: 2
  style.font-color: "#e67e22"
  style.font-size: 11
  style.stroke-dash: 3
}
remap_note -> master_pic: "Remaps IRQ0-7 to vectors 32-39" {
  style.stroke: "#9b59b6"
  style.stroke-width: 2
  style.font-color: "#9b59b6"
  style.font-size: 11
  style.stroke-dash: 5
}
remap_note -> slave_pic: "Remaps IRQ8-15 to vectors 40-47" {
  style.stroke: "#9b59b6"
  style.stroke-width: 2
  style.font-color: "#9b59b6"
  style.font-size: 11
  style.stroke-dash: 5
}