vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: ||md
  # Bitmap Frame Allocator — Structure & Operations
  **Resolution**: 1 bit = 1 × 4 KB frame | **Capacity**: 128 MB RAM (32,768 frames) | **Metadata Overhead**: 4,096 bytes (1 page)
||
title.near: top-center

back_to_map: "⬆ BACK TO SATELLITE MAP" {
  link: "#diag-satellite-os-map"
  style: {
    fill: "#1a1a2e"
    font-color: "#a0aec0"
    stroke: "#4a5568"
    border-radius: 6
    font-size: 11
  }
}

# ─────────────────────────────────────────────────────────────────────────────
# LEGEND & COLOR SEMANTICS
# ─────────────────────────────────────────────────────────────────────────────
legend: {
  near: bottom-right
  label: "MEMORY STATE SEMANTICS"
  style: {
    fill: "#1e293b"
    stroke: "#475569"
    border-radius: 8
    font-color: "#e2e8f0"
    bold: true
  }
  l_reserved: "■ Reserved / MMIO (Set)" {
    style: { fill: "#7b2d2d"; font-color: "#fca5a5"; stroke: "#ef4444"; border-radius: 4; font-size: 10 }
  }
  l_kernel: "■ Kernel Binary (Set)" {
    style: { fill: "#1e3a5f"; font-color: "#93c5fd"; stroke: "#3b82f6"; border-radius: 4; font-size: 10 }
  }
  l_pt: "■ Page Tables (Set)" {
    style: { fill: "#3b2a6e"; font-color: "#c4b5fd"; stroke: "#8b5cf6"; border-radius: 4; font-size: 10 }
  }
  l_free: "■ Free Usable RAM (Clear)" {
    style: { fill: "#14532d"; font-color: "#86efac"; stroke: "#22c55e"; border-radius: 4; font-size: 10 }
  }
  l_alloc: "■ Allocation Target (Flip)" {
    style: { fill: "#7c2d12"; font-color: "#fdba74"; stroke: "#f97316"; border-radius: 4; font-size: 10; bold: true }
  }
}

# ─────────────────────────────────────────────────────────────────────────────
# PHYSICAL ADDRESS SPACE LAYOUT
# ─────────────────────────────────────────────────────────────────────────────
phys_space: "PHYSICAL MEMORY MAP (0x0 – 0x08000000)" {
  style: {
    fill: "#0f172a"
    stroke: "#334155"
    border-radius: 8
    font-color: "#cbd5e1"
    bold: true
  }
  
  m_map: {
    shape: sql_table
    # Column Headers
    "Address Range": "Frames" {constraint: "Usage / Content"}
    
    # Rows
    "0x00000000 – 0x000FFFFF": "0 – 255" {constraint: "BIOS / IVT / VGA / EBDA"}
    "0x00100000 – 0x004FFFFF": "256 – 1279" {constraint: "Kernel Binary (.text/.data)"}
    "0x00500000 – 0x005FFFFF": "1280 – 1535" {constraint: "Boot Paging Structures"}
    "0x00600000 – 0x00FFFFFF": "1536 – 4095" {constraint: "Kernel Heap (kmalloc)"}
    "0x01000000 – 0x07FDFFFF": "4096 – 32735" {constraint: "User Page Pool (Free)"}
    "0x07FE0000 – 0x07FFFFFF": "32736 – 32767" {constraint: "ACPI / Stack / Reserved"}
  }
  
  m_map."0x00000000 – 0x000FFFFF".style: { fill: "#7b2d2d"; font-color: "#fca5a5" }
  m_map."0x00100000 – 0x004FFFFF".style: { fill: "#1e3a5f"; font-color: "#93c5fd" }
  m_map."0x00500000 – 0x005FFFFF".style: { fill: "#3b2a6e"; font-color: "#c4b5fd" }
  m_map."0x00600000 – 0x00FFFFFF".style: { fill: "#14532d"; font-color: "#86efac" }
  m_map."0x01000000 – 0x07FDFFFF".style: { fill: "#14532d"; font-color: "#86efac" }
  m_map."0x07FE0000 – 0x07FFFFFF".style: { fill: "#7b2d2d"; font-color: "#fca5a5" }
}

# ─────────────────────────────────────────────────────────────────────────────
# BITMAP MEMORY STRUCTURE
# ─────────────────────────────────────────────────────────────────────────────
bitmap_struct: "frame_bitmap[1024] (uint32_t)" {
  link: "#bitmap-frame-allocator"
  style: {
    fill: "#1e293b"
    stroke: "#475569"
    border-radius: 8
    font-color: "#94a3b8"
    bold: true
  }

  math: ||md
    **Addressing Logic**
    c
    uint32_t word = frame / 32;
    uint32_t bit  = frame % 32;
    
    *Bit = 1 (Used)* | *Bit = 0 (Free)*
  ||
  math.style.font-size: 11

  grid: {
    grid-columns: 1
    w0: "word[0] (BIOS/Res) | [0-31] | 0xFFFFFFFF" {
      style: { fill: "#450a0a"; stroke: "#ef4444"; font-color: "#fca5a5"; font-size: 11 }
    }
    w1: "word[1..7] (Reserved) | [32-255] | 0xFFFFFFFF" {
      style: { fill: "#450a0a"; stroke: "#ef4444"; font-color: "#fca5a5"; font-size: 11 }
    }
    w8: "word[8] (Kernel) | [256-287] | 0xFFFFFFFF" {
      style: { fill: "#0c1d3b"; stroke: "#3b82f6"; font-color: "#93c5fd"; font-size: 11 }
    }
    w_gap: "word[9..47] (...) | [288-1535] | 0xFFFFFFFF" {
      style: { fill: "#1e1b4b"; stroke: "#8b5cf6"; font-color: "#c4b5fd"; font-size: 11 }
    }
    w48: "word[48] (Heap-Start) | [1536-1567] | 0x00000000" {
      style: { fill: "#052e16"; stroke: "#22c55e"; font-color: "#86efac"; font-size: 11 }
    }
    w49: "word[49] (Next-Free) | [1568-1599] | 0x00000000" {
      style: { fill: "#052e16"; stroke: "#22c55e"; font-color: "#86efac"; font-size: 11; bold: true }
    }
  }
}

# ─────────────────────────────────────────────────────────────────────────────
# DATA WALK: ALLOCATION PROCESS
# ─────────────────────────────────────────────────────────────────────────────
allocation_flow: "pmm_alloc_frame() Lifecycle" {
  style: { fill: "#0f172a"; stroke: "#f97316"; border-radius: 8; font-color: "#fdba74"; bold: true }

  step1: "1. Linear Scan for !0xFFFFFFFF word"
  step2: "2. Find first 0-bit: __builtin_ctz(~bitmap[i])"
  step3: "3. Calculate frame index: i * 32 + bit"
  step4: "4. Assert Bit: bitmap[i] |= (1 << bit)"
  step5: "5. Return Phys: frame << 12"

  step1 -> step2 -> step3 -> step4 -> step5
  
  code_block: ||cpp
    // Allocation of Frame 1568
    i = 1568 / 32; // 49
    bit = 1568 % 32; // 0
    bitmap[49] |= (1 << 0);
    return 0x00620000;
  ||
  code_block.style: { font: mono; fill: "#1c1917"; stroke: "#44403c"; font-size: 11 }
}

# ─────────────────────────────────────────────────────────────────────────────
# STATE EVOLUTION: BITMAP MUTATION
# ─────────────────────────────────────────────────────────────────────────────
mutation_view: "Microscope: Mutation of word[49]" {
  style: { fill: "#0f172a"; stroke: "#8b5cf6"; border-radius: 8; font-color: "#c4b5fd"; bold: true }
  
  before: "BEFORE ALLOC\n0x00000000\n[0000...0000]" {
    style: { fill: "#052e16"; stroke: "#22c55e"; font-color: "#86efac" }
  }
  
  after: "AFTER ALLOC\n0x00000001\n[0000...0001]" {
    style: { fill: "#7c2d12"; stroke: "#f97316"; font-color: "#fdba74" }
  }

  before -> after: "pmm_alloc_frame() calls\nSET_BIT(49, 0)" {
    style: { stroke: "#f97316"; animated: true; bold: true }
  }
}

# ─────────────────────────────────────────────────────────────────────────────
# CONNECTIONS & INTERPLAY
# ─────────────────────────────────────────────────────────────────────────────
phys_space.m_map -> bitmap_struct.grid: "Mapped 1:1" {
  style: { stroke: "#64748b"; stroke-dash: 5 }
}

bitmap_struct.grid.w49 -> allocation_flow.step1: "Scan Target" {
  style: { stroke: "#f97316"; stroke-width: 2 }
}

allocation_flow.step4 -> mutation_view.before: "Triggers Mutation" {
  style: { stroke: "#8b5cf6"; stroke-dash: 3 }
}

# Initialize process
init: "pmm_init()" {
  shape: circle
  style.fill: "#94a3b8"
}
init -> bitmap_struct.grid.w0: "memset(0xFF)"
init -> bitmap_struct.grid.w48: "clear free RAM"

footer: ||md
  **Complexity**: O(N) Worst Case, O(1) Typical (using `last_free` hint)
  **Synchronization**: Spinlock required for SMP environments
||
footer.near: bottom-center
footer.style.font-size: 10