vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right
# ── Legend ────────────────────────────────────────────────────────────────────
legend: {
  near: bottom-right
  label: "LEGEND"
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a6a"
    border-radius: 6
    font-size: 13
    bold: true
    font-color: "#e0e0ff"
  }
  usable_leg: "■ Usable RAM (Type 1)" {
    shape: text
    style: { font-color: "#4ade80"; font-size: 12 }
  }
  reserved_leg: "■ Reserved / MMIO (Type 2)" {
    shape: text
    style: { font-color: "#f87171"; font-size: 12 }
  }
  acpi_leg: "■ ACPI Reclaimable (Type 3)" {
    shape: text
    style: { font-color: "#facc15"; font-size: 12 }
  }
  kernel_leg: "■ Kernel Binary (re-marked used)" {
    shape: text
    style: { font-color: "#c084fc"; font-size: 12 }
  }
  bitmap_leg: "■ PMM Bitmap (carved from usable)" {
    shape: text
    style: { font-color: "#60a5fa"; font-size: 12 }
  }
}
# ── E820 Entry Wire Format ────────────────────────────────────────────────────
entry_format: "E820 Entry Structure (24 bytes)" {
  style: {
    fill: "#1e1e3f"
    stroke: "#6366f1"
    stroke-width: 2
    border-radius: 6
    bold: true
    font-color: "#a5b4fc"
    font-size: 14
  }
  grid-rows: 1
  grid-gap: 0
  f_size: "size\n[+0] u32\n4 bytes" {
    style: {
      fill: "#312e81"
      stroke: "#6366f1"
      font-color: "#c7d2fe"
      font-size: 11
      border-radius: 3
    }
  }
  f_base: "base_addr\n[+4] u64\n8 bytes" {
    style: {
      fill: "#1e3a5f"
      stroke: "#3b82f6"
      font-color: "#93c5fd"
      font-size: 11
      border-radius: 3
    }
  }
  f_len: "length\n[+12] u64\n8 bytes" {
    style: {
      fill: "#1e3a5f"
      stroke: "#3b82f6"
      font-color: "#93c5fd"
      font-size: 11
      border-radius: 3
    }
  }
  f_type: "type\n[+20] u32\n4 bytes" {
    style: {
      fill: "#3b1f5e"
      stroke: "#a855f7"
      font-color: "#d8b4fe"
      font-size: 11
      border-radius: 3
    }
  }
}
type_decode: "Type Field Values" {
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a6a"
    border-radius: 5
    font-color: "#e0e0ff"
    font-size: 13
    bold: true
  }
  t1: "1 = Usable RAM  → PMM may free these frames" {
    shape: text
    style: { font-color: "#4ade80"; font-size: 12 }
  }
  t2: "2 = Reserved    → Never allocate (hardware/ROM/MMIO)" {
    shape: text
    style: { font-color: "#f87171"; font-size: 12 }
  }
  t3: "3 = ACPI Reclaim→ Usable after ACPI tables read" {
    shape: text
    style: { font-color: "#facc15"; font-size: 12 }
  }
  t4: "4 = ACPI NVS    → Never reclaim (firmware storage)" {
    shape: text
    style: { font-color: "#f97316"; font-size: 12 }
  }
  t5: "5 = Bad Memory  → Defective, never allocate" {
    shape: text
    style: { font-color: "#9ca3af"; font-size: 12 }
  }
}
# ── Physical Address Space Map ────────────────────────────────────────────────
phys_map: "Physical Address Space — QEMU 128 MB Machine" {
  style: {
    fill: "#0f0f1a"
    stroke: "#6366f1"
    stroke-width: 3
    border-radius: 8
    bold: true
    font-color: "#a5b4fc"
    font-size: 15
  }
  direction: down
  # ── Address range column labels ──────────────────────────────────────────
  col_hdr: "Addr Range               Size        Type   E820 Region Description" {
    shape: text
    style: {
      font-size: 12
      bold: true
      font-color: "#94a3b8"
    }
  }
  r00: {
    label: "0x00000000 – 0x000003FF   1 KB     Reserved   Real-Mode Interrupt Vector Table (IVT)"
    style: {
      fill: "#3b1515"
      stroke: "#ef4444"
      border-radius: 3
      font-color: "#fca5a5"
      font-size: 12
    }
  }
  r01: {
    label: "0x00000400 – 0x000004FF   256 B    Reserved   BIOS Data Area (BDA)"
    style: {
      fill: "#3b1515"
      stroke: "#ef4444"
      border-radius: 3
      font-color: "#fca5a5"
      font-size: 12
    }
  }
  r02: {
    label: "0x00000500 – 0x00007BFF   ~30 KB   Usable     Free conventional memory (stage2, early use)"
    style: {
      fill: "#14291e"
      stroke: "#16a34a"
      border-radius: 3
      font-color: "#86efac"
      font-size: 12
    }
  }
  r03: {
    label: "0x00007C00 – 0x00007DFF   512 B    Usable     Stage-1 MBR bootloader (loaded by BIOS)" {
      style.bold: true
    }
    style: {
      fill: "#1a2e1a"
      stroke: "#22c55e"
      border-radius: 3
      font-color: "#86efac"
      font-size: 12
    }
  }
  r04: {
    label: "0x00007E00 – 0x00009EFF   ~8 KB    Usable     Stage-2 loader (loaded by stage-1 INT 13h)"
    style: {
      fill: "#1a2e1a"
      stroke: "#22c55e"
      border-radius: 3
      font-color: "#86efac"
      font-size: 12
    }
  }
  r05: {
    label: "0x0009F000 – 0x0009FBFF   3 KB     Usable     Top of conventional memory (639–640 KB)"
    style: {
      fill: "#1a2e1a"
      stroke: "#22c55e"
      border-radius: 3
      font-color: "#86efac"
      font-size: 12
    }
  }
  r06_ebda: {
    label: "0x0009FC00 – 0x0009FFFF   1 KB     Reserved   Extended BIOS Data Area (EBDA) — Type 2"
    style: {
      fill: "#3b1515"
      stroke: "#ef4444"
      stroke-width: 2
      border-radius: 3
      font-color: "#fca5a5"
      font-size: 12
      bold: true
    }
  }
  r07_vga: {
    label: "0x000A0000 – 0x000AFFFF   64 KB    Reserved   VGA Framebuffer MMIO  ← volatile uint16_t *0xB8000"
    style: {
      fill: "#3b1515"
      stroke: "#ef4444"
      stroke-width: 2
      border-radius: 3
      font-color: "#fca5a5"
      font-size: 12
      bold: true
    }
  }
  r08_vgatext: {
    label: "0x000B8000 – 0x000BFFFF   32 KB    Reserved   VGA Text Mode Buffer  (80×25 × 2 bytes = 4000 B used)"
    style: {
      fill: "#4a2000"
      stroke: "#f97316"
      stroke-width: 2
      border-radius: 3
      font-color: "#fdba74"
      font-size: 12
      bold: true
    }
  }
  r09_rom: {
    label: "0x000C0000 – 0x000EFFFF   192 KB   Reserved   Option ROMs (NIC, SCSI, VGA BIOS extension)"
    style: {
      fill: "#3b1515"
      stroke: "#ef4444"
      border-radius: 3
      font-color: "#fca5a5"
      font-size: 12
    }
  }
  r10_biosrom: {
    label: "0x000F0000 – 0x000FFFFF   64 KB    Reserved   System BIOS ROM  — entire range Type 2"
    style: {
      fill: "#3b1515"
      stroke: "#ef4444"
      stroke-width: 2
      border-radius: 3
      font-color: "#fca5a5"
      font-size: 12
      bold: true
    }
  }
  r11_1mb: {
    label: "── 1 MB boundary (0x00100000) ── A20 must be enabled to cross this line ──"
    style: {
      fill: "#1e1e3f"
      stroke: "#818cf8"
      stroke-width: 2
      stroke-dash: 4
      border-radius: 3
      font-color: "#a5b4fc"
      font-size: 12
      bold: true
      italic: true
    }
  }
  r12_kernel: {
    label: "0x00100000 – 0x001FFFFF   1 MB     ★ KERNEL   Kernel binary (ELF loaded here by bootloader)\n                                              LMA=0x100000, VMA=0xC0100000 after paging" {
      style.bold: true
    }
    style: {
      fill: "#2e1a4a"
      stroke: "#a855f7"
      stroke-width: 3
      border-radius: 4
      font-color: "#e879f9"
      font-size: 12
      bold: true
    }
  }
  r13_pmm_bitmap: {
    label: "0x00200000 – 0x00200FFF   4 KB     ★ PMM MAP  PMM Bitmap (1 bit/frame × 32768 frames = 4096 B)\n                                              Carved from usable region; re-marked used in init"
    style: {
      fill: "#1a2a4a"
      stroke: "#3b82f6"
      stroke-width: 2
      border-radius: 4
      font-color: "#93c5fd"
      font-size: 12
      bold: true
    }
  }
  r14_kheap: {
    label: "0x00201000 – 0x07FDFFFF   ~125 MB  Usable     Free frames — handed out by pmm_alloc_frame()\n                                              Page tables, kernel heap, user stacks allocated here"
    style: {
      fill: "#14291e"
      stroke: "#16a34a"
      border-radius: 4
      font-color: "#86efac"
      font-size: 12
    }
  }
  r15_acpi: {
    label: "0x07FE0000 – 0x07FFFFFF   128 KB   ACPI(3)    ACPI Reclaimable — Type 3\n                                              Usable after OS parses ACPI tables (ignored for now)"
    style: {
      fill: "#2d2a10"
      stroke: "#ca8a04"
      stroke-width: 2
      border-radius: 3
      font-color: "#fde68a"
      font-size: 12
    }
  }
  r16_pcie: {
    label: "0x08000000 – 0xFEFFFFFF   ~3.8 GB  Reserved   PCIe MMIO, LAPIC (0xFEE00000), IOAPIC, etc."
    style: {
      fill: "#3b1515"
      stroke: "#ef4444"
      border-radius: 3
      font-color: "#fca5a5"
      font-size: 12
    }
  }
  r17_biosflash: {
    label: "0xFFFC0000 – 0xFFFFFFFF   256 KB   Reserved   BIOS Flash/ROM (top of 32-bit space)\n                                              CPU reset vector at 0xFFFFFFF0 points here"
    style: {
      fill: "#3b1515"
      stroke: "#ef4444"
      stroke-width: 2
      border-radius: 3
      font-color: "#fca5a5"
      font-size: 12
      bold: true
    }
  }
  # vertical ordering
  col_hdr -> r00: { style.opacity: 0 }
  r00 -> r01: { style.opacity: 0 }
  r01 -> r02: { style.opacity: 0 }
  r02 -> r03: { style.opacity: 0 }
  r03 -> r04: { style.opacity: 0 }
  r04 -> r05: { style.opacity: 0 }
  r05 -> r06_ebda: { style.opacity: 0 }
  r06_ebda -> r07_vga: { style.opacity: 0 }
  r07_vga -> r08_vgatext: { style.opacity: 0 }
  r08_vgatext -> r09_rom: { style.opacity: 0 }
  r09_rom -> r10_biosrom: { style.opacity: 0 }
  r10_biosrom -> r11_1mb: { style.opacity: 0 }
  r11_1mb -> r12_kernel: { style.opacity: 0 }
  r12_kernel -> r13_pmm_bitmap: { style.opacity: 0 }
  r13_pmm_bitmap -> r14_kheap: { style.opacity: 0 }
  r14_kheap -> r15_acpi: { style.opacity: 0 }
  r15_acpi -> r16_pcie: { style.opacity: 0 }
  r16_pcie -> r17_biosflash: { style.opacity: 0 }
}
# ── PMM Init Algorithm ────────────────────────────────────────────────────────
pmm_algo: "pmm_init() Algorithm — Reserve-Then-Free" {
  style: {
    fill: "#0f1a2e"
    stroke: "#3b82f6"
    stroke-width: 2
    border-radius: 6
    bold: true
    font-color: "#93c5fd"
    font-size: 14
  }
  step1: "Step 1: Mark ALL 32768 frames as USED\nfor (i=0; i < total_frames/32; i++) bitmap[i] = 0xFFFFFFFF;" {
    shape: rectangle
    style: {
      fill: "#3b1515"
      stroke: "#ef4444"
      border-radius: 4
      font-color: "#fca5a5"
      font-size: 12
      font: mono
    }
  }
  step2: "Step 2: Walk E820 map — for each Type=1 (Usable) region:\nalign base UP to 4KB, align end DOWN to 4KB\ncall frame_clear(frame) for each frame in range\nfree_frames++" {
    shape: rectangle
    style: {
      fill: "#14291e"
      stroke: "#16a34a"
      border-radius: 4
      font-color: "#86efac"
      font-size: 12
      font: mono
    }
  }
  step3: "Step 3: Re-mark kernel binary frames as USED\nkstart = &__kernel_start / 4096\nkend   = (&__kernel_end + 4095) / 4096\nfor (f = kstart; f < kend; f++) frame_set(f)" {
    shape: rectangle
    style: {
      fill: "#2e1a4a"
      stroke: "#a855f7"
      border-radius: 4
      font-color: "#d8b4fe"
      font-size: 12
      font: mono
    }
  }
  step4: "Step 4: Re-mark PMM bitmap itself as USED\n(bitmap lives in .bss — already within kernel range)\nAlso mark frame 0 USED: NULL ptr → instant #PF" {
    shape: rectangle
    style: {
      fill: "#1a2a4a"
      stroke: "#3b82f6"
      border-radius: 4
      font-color: "#93c5fd"
      font-size: 12
      font: mono
    }
  }
  step5: "Step 5: Result — only safe, kernel-free usable frames remain clear\npmm_alloc_frame() scans bitmap for first 0-bit → O(n/32)\n__builtin_ctz(~bitmap[i]) finds first free bit in O(1)" {
    shape: rectangle
    style: {
      fill: "#1a2e1a"
      stroke: "#22c55e"
      stroke-width: 2
      border-radius: 4
      font-color: "#86efac"
      font-size: 12
      font: mono
    }
  }
  step1 -> step2: "parse mmap_addr entries\nskip type != 1" {
    style: { stroke: "#4ade80"; font-color: "#4ade80" }
  }
  step2 -> step3: "free_frames = N\n(usable frames counted)" {
    style: { stroke: "#a855f7"; font-color: "#a855f7" }
  }
  step3 -> step4: "kernel frames\nprotected" {
    style: { stroke: "#60a5fa"; font-color: "#60a5fa" }
  }
  step4 -> step5: "init complete" {
    style: { stroke: "#22c55e"; font-color: "#22c55e" }
  }
}
# ── Bitmap Layout Detail ──────────────────────────────────────────────────────
bitmap_detail: "PMM Bitmap Layout Detail — 128 MB RAM" {
  style: {
    fill: "#0f1a2e"
    stroke: "#60a5fa"
    border-radius: 6
    bold: true
    font-color: "#93c5fd"
    font-size: 13
  }
  grid-rows: 1
  grid-gap: 0
  bw0: "bitmap[0]\nword 0\nFrames 0–31\n0x000000–\n0x01FFFF\nAll USED\n(0xFFFFFFFF)" {
    style: {
      fill: "#3b1515"
      stroke: "#ef4444"
      font-color: "#fca5a5"
      font-size: 11
      border-radius: 3
    }
  }
  bw1: "bitmap[1–63]\nwords 1–63\nFrames 32–2047\n0x020000–\n0x7FFFFF\nAll USED\n(0xFFFFFFFF)" {
    style: {
      fill: "#3b1515"
      stroke: "#ef4444"
      font-color: "#fca5a5"
      font-size: 11
      border-radius: 3
    }
  }
  bw2: "bitmap[64–127]\nwords 64–127\nFrames 2048–4095\n0x800000–\n0xFFFFFF\n← KERNEL\nAll USED (purple)" {
    style: {
      fill: "#2e1a4a"
      stroke: "#a855f7"
      font-color: "#d8b4fe"
      font-size: 11
      border-radius: 3
    }
  }
  bw3: "bitmap[128–256]\nwords 128–256\nFrames 4096–8191\n0x1000000–\n0x1FFFFFF\nFREE → 0x00000000\npmm_alloc picks here" {
    style: {
      fill: "#14291e"
      stroke: "#22c55e"
      stroke-width: 2
      font-color: "#86efac"
      font-size: 11
      border-radius: 3
    }
  }
  bw_dots: "  . . . " {
    style: {
      fill: "#1a1a2e"
      stroke: "#374151"
      font-color: "#6b7280"
      font-size: 14
    }
  }
  bw_last: "bitmap[1023]\nword 1023\nFrames 32736–32767\n0x7FE00000–\n0x7FFFFFFF\nACPI→USED\n(0xFFFFFFFF)" {
    style: {
      fill: "#2d2a10"
      stroke: "#ca8a04"
      font-color: "#fde68a"
      font-size: 11
      border-radius: 3
    }
  }
}
# ── Alloc Path ───────────────────────────────────────────────────────────────
alloc_path: "pmm_alloc_frame() Hot Path" {
  style: {
    fill: "#0f1a2e"
    stroke: "#22c55e"
    stroke-width: 2
    border-radius: 6
    bold: true
    font-color: "#86efac"
    font-size: 13
  }
  ap1: "for i in 0..total_frames/32\n  if bitmap[i] == 0xFFFFFFFF → skip (all used)" {
    shape: hexagon
    style: {
      fill: "#1a2e1a"
      stroke: "#16a34a"
      font-color: "#86efac"
      font-size: 11
      font: mono
    }
  }
  ap2: "bit = __builtin_ctz(~bitmap[i])\n(BSF: Bit Scan Forward — 1 cycle)" {
    shape: diamond
    style: {
      fill: "#14291e"
      stroke: "#22c55e"
      font-color: "#86efac"
      font-size: 11
      font: mono
    }
  }
  ap3: "frame = i×32 + bit\nbitmap[i] |= (1 << bit)  // mark used\nfree_frames--\nreturn frame × 4096     // physical addr" {
    shape: rectangle
    style: {
      fill: "#0d2318"
      stroke: "#4ade80"
      stroke-width: 2
      font-color: "#4ade80"
      font-size: 11
      font: mono
    }
  }
  ap_oom: "kprintf(OUT OF MEMORY)\nhlt  // kernel panic" {
    shape: rectangle
    style: {
      fill: "#3b0000"
      stroke: "#dc2626"
      stroke-width: 3
      font-color: "#fca5a5"
      font-size: 11
      font: mono
    }
  }
  ap1 -> ap2: "found word\nwith free bit" {
    style: { stroke: "#22c55e"; font-color: "#22c55e" }
  }
  ap2 -> ap3: "bit found" {
    style: { stroke: "#4ade80"; font-color: "#4ade80" }
  }
  ap1 -> ap_oom: "all words = 0xFFFFFFFF\n(no free frames)" {
    style: { stroke: "#ef4444"; font-color: "#ef4444" }
  }
}
# ── E820 Iteration Code ───────────────────────────────────────────────────────
iter_code: |go
  // E820 iteration (C, in kernel_main before pmm_init)
  multiboot_mmap_entry_t *e =
    (multiboot_mmap_entry_t *)(uintptr_t)mbi->mmap_addr;
  uintptr_t end = mbi->mmap_addr + mbi->mmap_length;
  while ((uintptr_t)e < end) {
      uint32_t frame_start =
          (uint32_t)((e->base_addr + 0xFFF) / 4096); // ceil
      uint32_t frame_end   =
          (uint32_t)((e->base_addr + e->length) / 4096); // floor
      if (e->type == 1) {  // Usable
          for (uint32_t f = frame_start; f < frame_end; f++) {
              frame_clear(f);   // Clear bit → free
              free_frames++;
          }
      }
      // Advance: size field gives remaining byte count of entry
      e = (multiboot_mmap_entry_t*)((uintptr_t)e + e->size + 4);
  }
| {
  near: bottom-left
  style: {
    fill: "#0a0a1a"
    stroke: "#6366f1"
    stroke-width: 2
    border-radius: 6
    font-size: 12
  }
}
# ── Annotations / Data-flow arrows ───────────────────────────────────────────
entry_format -> type_decode: "type field\ndecoded here" {
  style: {
    stroke: "#a855f7"
    font-color: "#a855f7"
    stroke-dash: 3
  }
}
phys_map -> entry_format: "E820 BIOS call\npopulates one entry\nper region" {
  style: {
    stroke: "#6366f1"
    font-color: "#a5b4fc"
    stroke-width: 2
  }
}
phys_map.r12_kernel -> pmm_algo.step3: "linker exports\n__kernel_start\n__kernel_end" {
  style: {
    stroke: "#a855f7"
    font-color: "#d8b4fe"
    stroke-width: 2
    stroke-dash: 4
  }
}
phys_map.r13_pmm_bitmap -> pmm_algo.step4: "bitmap carving:\n4KB @ 0x200000\nmarked USED" {
  style: {
    stroke: "#3b82f6"
    font-color: "#93c5fd"
    stroke-dash: 4
  }
}
phys_map.r14_kheap -> pmm_algo.step2: "~125 MB freed\nafter step 2" {
  style: {
    stroke: "#22c55e"
    font-color: "#4ade80"
    stroke-dash: 4
  }
}
pmm_algo -> bitmap_detail: "resulting bitmap\nstate after init" {
  style: {
    stroke: "#60a5fa"
    font-color: "#93c5fd"
    stroke-width: 2
  }
}
pmm_algo.step5 -> alloc_path: "allocation\nalgorithm" {
  style: {
    stroke: "#22c55e"
    font-color: "#4ade80"
    stroke-width: 2
  }
}
phys_map.r07_vga -> phys_map.r08_vgatext: "VGA MMIO zone\nnever allocate\n(Type 2 reserved)" {
  style: {
    stroke: "#ef4444"
    font-color: "#f87171"
    stroke-dash: 3
  }
}
phys_map.r11_1mb -> phys_map.r12_kernel: "A20 must be\nenabled before\ncrossing 1 MB" {
  style: {
    stroke: "#818cf8"
    font-color: "#a5b4fc"
    stroke-width: 2
    stroke-dash: 5
  }
}