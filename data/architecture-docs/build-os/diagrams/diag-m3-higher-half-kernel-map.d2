vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Higher-Half Kernel: Boot Physical vs Runtime Virtual
| {near: top-center}

before: "BEFORE PAGING — Physical Address Space (CR0.PG=0)" {
  style: {
    fill: "#1a1a2e"
    stroke: "#e94560"
    stroke-width: 3
    border-radius: 8
    font-color: "#e94560"
    bold: true
    font-size: 16
  }

  phys_null: "0x00000000\nReal-mode IVT + BIOS Data Area\n(256B IVT + 256B BDA)" {
    style: {
      fill: "#2d2d44"
      stroke: "#666688"
      stroke-dash: 3
      font-color: "#aaaacc"
      font-size: 12
    }
  }

  phys_vga: "0x000B8000\nVGA Text Buffer 80x25 cells\n2 bytes per cell: char + attr\nPhysical MMIO — not RAM" {
    style: {
      fill: "#1e3a1e"
      stroke: "#44aa44"
      stroke-width: 2
      font-color: "#88ff88"
      font-size: 12
    }
  }

  phys_bios_rom: "0x000C0000 to 0x000FFFFF\nVideo BIOS ROM + System BIOS\nOption ROMs, firmware code" {
    style: {
      fill: "#2d2d44"
      stroke: "#666688"
      stroke-dash: 3
      font-color: "#aaaacc"
      font-size: 12
    }
  }

  phys_kernel_start: "0x00100000 = __kernel_phys_start\n.text section — kernel code\nExecuting HERE right now\nEIP = 0x00100000 + offset" {
    style: {
      fill: "#1a1a3e"
      stroke: "#e94560"
      stroke-width: 3
      font-color: "#ff6688"
      font-size: 12
      bold: true
    }
  }

  phys_rodata: "0x00101000+\n.rodata — read-only data\nString literals, const tables\nphysical addr == linked addr" {
    style: {
      fill: "#1a1a3e"
      stroke: "#e94560"
      font-color: "#ff6688"
      font-size: 12
    }
  }

  phys_data: "0x00102000+\n.data — initialized globals\n.bss — zeroed by kernel_entry\nBSS zeroed with rep stosd" {
    style: {
      fill: "#1a1a3e"
      stroke: "#e94560"
      font-color: "#ff6688"
      font-size: 12
    }
  }

  phys_stack: "0x0019F000 (example)\nBoot kernel stack\nESP set by kernel_entry.asm\nGrows downward" {
    style: {
      fill: "#3e1a1a"
      stroke: "#ff4444"
      font-color: "#ffaaaa"
      font-size: 12
    }
  }

  phys_page_tables: "0x001A0000+\nBoot page directory 4KB\nBoot page tables static\n__attribute__((aligned(4096)))" {
    style: {
      fill: "#2a1a3e"
      stroke: "#9944ff"
      font-color: "#cc88ff"
      font-size: 12
    }
  }

  phys_free: "0x001B0000 to top of RAM\nFree physical frames\npmm_alloc_frame() pool\nBitmap: 1 bit per 4KB frame" {
    style: {
      fill: "#1a2e1a"
      stroke: "#228822"
      stroke-dash: 4
      font-color: "#66aa66"
      font-size: 12
    }
  }

  phys_null -> phys_vga: "0xB8000 gap\n(BIOS holes)" {
    style: { stroke: "#666688"; stroke-dash: 3; font-color: "#888888"; font-size: 10 }
  }
  phys_vga -> phys_bios_rom: "MMIO not RAM" {
    style: { stroke: "#44aa44"; font-color: "#66aa66"; font-size: 10 }
  }
  phys_bios_rom -> phys_kernel_start: "1MB boundary\nkernel loads here" {
    style: { stroke: "#e94560"; stroke-width: 2; font-color: "#ff6688"; font-size: 10 }
  }
  phys_kernel_start -> phys_rodata: ".text ends\n.rodata begins" {
    style: { stroke: "#e94560"; font-color: "#ff6688"; font-size: 10 }
  }
  phys_rodata -> phys_data: ".rodata ends\n.data/.bss begins" {
    style: { stroke: "#e94560"; font-color: "#ff6688"; font-size: 10 }
  }
  phys_data -> phys_stack: "__kernel_phys_end\nstack reserved" {
    style: { stroke: "#ff4444"; font-color: "#ffaaaa"; font-size: 10 }
  }
  phys_stack -> phys_page_tables: "above stack\npage table storage" {
    style: { stroke: "#9944ff"; font-color: "#cc88ff"; font-size: 10 }
  }
  phys_page_tables -> phys_free: "above page tables\nfree pool" {
    style: { stroke: "#228822"; stroke-dash: 3; font-color: "#66aa66"; font-size: 10 }
  }
}

after: "AFTER PAGING + HIGHER-HALF JUMP — Virtual Address Space (CR0.PG=1)" {
  style: {
    fill: "#0d1b0d"
    stroke: "#00cc66"
    stroke-width: 3
    border-radius: 8
    font-color: "#00cc66"
    bold: true
    font-size: 16
  }

  virt_null_guard: "0x00000000 to 0x000FFFFF\nNULL guard + legacy region\nNOT mapped (P=0)\nAccess = Page Fault (CR2=addr)" {
    style: {
      fill: "#2d1a1a"
      stroke: "#cc3333"
      stroke-dash: 5
      font-color: "#ff6666"
      font-size: 12
    }
  }

  virt_user_low: "0x00400000 to 0xBFFFFFFF\nUser process virtual space\nPer-process page directories\nU/S=1 pages (ring 3 accessible)" {
    style: {
      fill: "#1a2e2e"
      stroke: "#0088aa"
      stroke-dash: 3
      font-color: "#44aacc"
      font-size: 12
    }
  }

  virt_vga_alias: "0x000B8000 (identity mapped)\nVGA Text Buffer accessible\nIdentity map: virt == phys\nPAGE_NOCACHE recommended" {
    style: {
      fill: "#1e3a1e"
      stroke: "#44aa44"
      stroke-width: 2
      font-color: "#88ff88"
      font-size: 12
    }
  }

  virt_kernel_base: "0xC0000000 = KERNEL_VMA_BASE\nKernel virtual region begins\n1GB for kernel (to 0xFFFFFFFF)\nPDEs 768-1023 in every page dir" {
    style: {
      fill: "#0d1a0d"
      stroke: "#00cc66"
      stroke-width: 3
      font-color: "#00ff88"
      font-size: 12
      bold: true
    }
  }

  virt_kernel_text: "0xC0100000 = __kernel_virt_start\n.text — kernel code (ring 0)\nEIP = 0xC0100000 + offset NOW\nLinked at this address by ld" {
    style: {
      fill: "#0d2a0d"
      stroke: "#00cc66"
      stroke-width: 3
      font-color: "#00ff88"
      font-size: 12
      bold: true
    }
  }

  virt_kernel_rodata: "0xC0101000+\n.rodata — kernel read-only data\nMapped PAGE_PRESENT no WRITABLE\nWrite = GPF protection fault" {
    style: {
      fill: "#0d2a0d"
      stroke: "#00cc66"
      font-color: "#00ff88"
      font-size: 12
    }
  }

  virt_kernel_data: "0xC0102000+\n.data + .bss — kernel globals\nPAGE_PRESENT | PAGE_WRITABLE\nKernel stack lives here too" {
    style: {
      fill: "#0d2a0d"
      stroke: "#00cc66"
      font-color: "#00ff88"
      font-size: 12
    }
  }

  virt_heap: "0xD0000000 to 0xDFFFFFFF\nKernel heap kmalloc/kfree\nGrows on demand: heap_expand()\npmm_alloc_frame() + vmm_map_page()" {
    style: {
      fill: "#1a1a0d"
      stroke: "#ccaa00"
      font-color: "#ffcc00"
      font-size: 12
    }
  }

  virt_guard_top: "0xFFFF0000 to 0xFFFFFFFF\nBIOS ROM mirror / APIC region\nFirmware physical range\nMapped uncacheable if needed" {
    style: {
      fill: "#2d2d44"
      stroke: "#666688"
      stroke-dash: 3
      font-color: "#aaaacc"
      font-size: 12
    }
  }

  virt_null_guard -> virt_user_low: "identity map removed\nafter higher-half jump" {
    style: { stroke: "#cc3333"; stroke-dash: 3; font-color: "#ff6666"; font-size: 10 }
  }
  virt_vga_alias -> virt_user_low: "0xB8000 identity map\nsurvives in lower 4MB PDE" {
    style: { stroke: "#44aa44"; font-color: "#66aa66"; font-size: 10 }
  }
  virt_user_low -> virt_kernel_base: "3GB user / 1GB kernel split\nclassic 32-bit Linux layout" {
    style: { stroke: "#00cc66"; stroke-width: 2; font-color: "#00ff88"; font-size: 10 }
  }
  virt_kernel_base -> virt_kernel_text: "0xC0000000 + 0x100000\nkernel loads at +1MB into region" {
    style: { stroke: "#00cc66"; stroke-width: 2; font-color: "#00ff88"; font-size: 10 }
  }
  virt_kernel_text -> virt_kernel_rodata: ".text ends\n.rodata begins" {
    style: { stroke: "#00cc66"; font-color: "#00ff88"; font-size: 10 }
  }
  virt_kernel_rodata -> virt_kernel_data: ".rodata ends\n.data/.bss begins" {
    style: { stroke: "#00cc66"; font-color: "#00ff88"; font-size: 10 }
  }
  virt_kernel_data -> virt_heap: "__kernel_virt_end\nheap begins" {
    style: { stroke: "#ccaa00"; font-color: "#ffcc00"; font-size: 10 }
  }
  virt_heap -> virt_guard_top: "heap top\nAPIC/BIOS region" {
    style: { stroke: "#666688"; stroke-dash: 3; font-color: "#aaaacc"; font-size: 10 }
  }
}

linker: "Linker Script — kernel.ld" {
  style: {
    fill: "#0d0d1a"
    stroke: "#4488ff"
    stroke-width: 2
    border-radius: 6
    font-color: "#4488ff"
    font-size: 16
    bold: true
  }

  ld_sections: "SECTIONS Directive" {
    style: {
      fill: "#050510"
      stroke: "#334488"
      font-color: "#8899cc"
      font-size: 13
    }
  }

  ld_vma: "VMA = 0xC0000000 + 0x100000\n= 0xC0100000\nSymbol addresses in binary\n(what EIP jumps to)" {
    style: {
      fill: "#0d0d2a"
      stroke: "#4488ff"
      font-color: "#88aaff"
      font-size: 12
    }
  }

  ld_lma: "LMA = 0x00100000\nAT(ADDR(.text) - KERNEL_VMA)\nWhere objcopy writes bytes\n(what bootloader loads)" {
    style: {
      fill: "#0d0d2a"
      stroke: "#ff8844"
      font-color: "#ffaa88"
      font-size: 12
    }
  }

  ld_at: "AT() Directive\nDecouples VMA from LMA\nVMA: 0xC0100000 (virtual)\nLMA: 0x00100000 (physical)\nWithout AT(): objcopy broken" {
    style: {
      fill: "#1a1a00"
      stroke: "#aaaa00"
      stroke-width: 2
      font-color: "#ffff44"
      font-size: 12
      bold: true
    }
  }

  ld_syms: "__kernel_virt_start = .\n__kernel_phys_start = . - KERNEL_VMA\n__bss_start = . (in .bss)\n__bss_end = . (in .bss)\n__kernel_virt_end = .\n__kernel_phys_end = . - KERNEL_VMA" {
    style: {
      fill: "#050510"
      stroke: "#336688"
      font-color: "#88aacc"
      font-size: 11
      font: mono
    }
  }

  ld_sections -> ld_vma: "links symbols at\nvirtual address" {
    style: { stroke: "#4488ff"; font-color: "#88aaff"; font-size: 10 }
  }
  ld_sections -> ld_lma: "places bytes at\nphysical address" {
    style: { stroke: "#ff8844"; font-color: "#ffaa88"; font-size: 10 }
  }
  ld_vma -> ld_at: "AT() bridges\nVMA and LMA" {
    style: { stroke: "#aaaa00"; stroke-width: 2; font-color: "#ffff44"; font-size: 10 }
  }
  ld_lma -> ld_at: "AT() bridges\nVMA and LMA" {
    style: { stroke: "#aaaa00"; stroke-width: 2; font-color: "#ffff44"; font-size: 10 }
  }
  ld_at -> ld_syms: "exported linker symbols\nused in boot assembly" {
    style: { stroke: "#4488ff"; font-color: "#88aaff"; font-size: 10 }
  }
}

boot_asm: "Boot Assembly — Before Paging (physical addr arithmetic)" {
  style: {
    fill: "#1a0d0d"
    stroke: "#ff6600"
    stroke-width: 2
    border-radius: 6
    font-color: "#ff6600"
    font-size: 16
    bold: true
  }

  asm_rule: "RULE: symbol - KERNEL_VMA\nEvery symbol before CR0.PG=1\nmust subtract 0xC0000000\nForgetting = triple fault" {
    style: {
      fill: "#2d1a00"
      stroke: "#ff6600"
      stroke-width: 3
      font-color: "#ffaa44"
      font-size: 13
      bold: true
    }
  }

  asm_bss: "Zero BSS — Physical Address\nmov edi, __bss_start - 0xC0000000\nmov ecx, __bss_end - 0xC0000000\nsub ecx, edi\nxor eax, eax\nrep stosb" {
    style: {
      fill: "#0d0505"
      stroke: "#882200"
      font-color: "#ffaa88"
      font-size: 11
      font: mono
    }
  }

  asm_stack: "Setup Stack — Physical\nmov esp, kernel_stack_top - 0xC0000000\n; stack grows down from physical addr\n; NOT virtual addr yet" {
    style: {
      fill: "#0d0505"
      stroke: "#882200"
      font-color: "#ffaa88"
      font-size: 11
      font: mono
    }
  }

  asm_cr3: "Load CR3 — Physical PD addr\nmov eax, boot_pd - 0xC0000000\nmov cr3, eax\n; TLB flushed automatically" {
    style: {
      fill: "#0d0505"
      stroke: "#9944ff"
      font-color: "#cc88ff"
      font-size: 11
      font: mono
    }
  }

  asm_cr0: "Enable Paging — CR0.PG=1\nmov eax, cr0\nor  eax, 0x80000000\nmov cr0, eax\n; NEXT FETCH goes via page tables\n; identity map keeps EIP valid" {
    style: {
      fill: "#2a1500"
      stroke: "#ff8800"
      stroke-width: 2
      font-color: "#ffbb44"
      font-size: 11
      font: mono
      bold: true
    }
  }

  asm_jmp: "Far Jump — flush pipeline\njmp 0x08:higher_half_entry\n; CS = kernel code selector 0x08\n; EIP = 0xC010xxxx (virtual NOW)\n; identity map still valid for jmp" {
    style: {
      fill: "#002a00"
      stroke: "#00cc00"
      stroke-width: 2
      font-color: "#88ff88"
      font-size: 11
      font: mono
      bold: true
    }
  }

  asm_cleanup: "Remove Identity Map\nboot_page_directory[0] = 0\nmov eax, cr3\nmov cr3, eax  ; flush TLB\n; 0x00000000 now unmapped\n; reload segs + virtual stack" {
    style: {
      fill: "#1a0000"
      stroke: "#cc3333"
      font-color: "#ff6666"
      font-size: 11
      font: mono
    }
  }

  asm_rule -> asm_bss: "apply to BSS zeroing" {
    style: { stroke: "#ff6600"; font-color: "#ffaa44"; font-size: 10 }
  }
  asm_bss -> asm_stack: "BSS zeroed\nsetup stack" {
    style: { stroke: "#882200"; font-color: "#ffaa88"; font-size: 10 }
  }
  asm_stack -> asm_cr3: "stack ready\nload CR3" {
    style: { stroke: "#882200"; font-color: "#ffaa88"; font-size: 10 }
  }
  asm_cr3 -> asm_cr0: "CR3 loaded\nenable paging" {
    style: { stroke: "#ff8800"; stroke-width: 2; font-color: "#ffbb44"; font-size: 10 }
  }
  asm_cr0 -> asm_jmp: "paging ON\nfar jump" {
    style: { stroke: "#00cc00"; stroke-width: 2; font-color: "#88ff88"; font-size: 10 }
  }
  asm_jmp -> asm_cleanup: "in higher-half\nremove identity" {
    style: { stroke: "#cc3333"; font-color: "#ff6666"; font-size: 10 }
  }
}

mapping: "Page Table Mapping — The Translation Bridge" {
  style: {
    fill: "#0d0d0d"
    stroke: "#9944ff"
    stroke-width: 2
    border-radius: 6
    font-color: "#9944ff"
    font-size: 16
    bold: true
  }

  cr3_box: "CR3 Register\nPhysical addr of boot_page_directory\nLoaded: mov cr3, pd_phys\nMust be PHYSICAL — paging not on yet" {
    style: {
      fill: "#2a1a3e"
      stroke: "#9944ff"
      stroke-width: 3
      font-color: "#cc88ff"
      font-size: 12
      bold: true
      shadow: true
    }
  }

  identity_pde: "PDE[0] — Identity Map\nVirtual 0x00000000 to 0x003FFFFF\n= Physical 0x00000000 to 0x003FFFFF\nPTE[i] = (i*4096) | PRESENT | WRITABLE\nPurpose: keep EIP valid at boot\nRemoved after higher-half jump" {
    style: {
      fill: "#1a1a2e"
      stroke: "#4444aa"
      stroke-dash: 3
      font-color: "#8888cc"
      font-size: 12
    }
  }

  higher_half_pde: "PDE[768] — Higher-Half Map\nVirtual 0xC0000000 to 0xC03FFFFF\n= Physical 0x00000000 to 0x003FFFFF\n768 = 0xC0000000 >> 22\nPermanent kernel home\nShared across ALL process PDs" {
    style: {
      fill: "#0d1a0d"
      stroke: "#00aa44"
      stroke-width: 2
      font-color: "#00cc66"
      font-size: 12
    }
  }

  vga_pte: "PTE[0xB8] in identity table\nVirtual 0x000B8000\n= Physical 0x000B8000 MMIO\nFlags: PRESENT | WRITABLE\nRecommend: NOCACHE | WRITETHROUGH" {
    style: {
      fill: "#0d1a0d"
      stroke: "#44aa44"
      font-color: "#88ff88"
      font-size: 12
    }
  }

  cr3_box -> identity_pde: "PDE[0] present\n(virt = phys at boot)" {
    style: { stroke: "#4444aa"; stroke-dash: 3; font-color: "#8888cc"; font-size: 10 }
  }
  cr3_box -> higher_half_pde: "PDE[768] present\n0xC0000000 maps to 0x0" {
    style: { stroke: "#00aa44"; stroke-width: 2; font-color: "#00cc66"; font-size: 10 }
  }
  identity_pde -> vga_pte: "PTE[0xB8] covers VGA\nwithin identity region" {
    style: { stroke: "#44aa44"; font-color: "#66aa66"; font-size: 10 }
  }
}

before -> linker: "Kernel binary placed at\nphysical 0x100000 (LMA)\nLinker script determines\nboth LMA and VMA" {
  style: { stroke: "#4488ff"; stroke-width: 2; font-color: "#88aaff"; font-size: 11 }
}

before -> boot_asm: "Boot code executes at\nphysical 0x100000\nAll symbol refs need\nsymbol - KERNEL_VMA" {
  style: { stroke: "#ff6600"; stroke-width: 2; font-color: "#ffaa44"; font-size: 11 }
}

linker -> mapping: "AT() directive gives objcopy\ncorrect LMA for raw binary\npage tables reference LMA\n(physical addresses)" {
  style: { stroke: "#4488ff"; font-color: "#88aaff"; font-size: 11 }
}

boot_asm -> mapping: "kernel_entry builds\nPDE[0] and PDE[768]\nloads CR3 with physical\naddr of page directory" {
  style: { stroke: "#9944ff"; stroke-width: 2; font-color: "#cc88ff"; font-size: 11 }
}

mapping -> after: "After CR0.PG=1 and\nfar jump to 0xC0100000:\nall virtual addresses\nresolve through these PTEs" {
  style: { stroke: "#00cc66"; stroke-width: 2; font-color: "#00ff88"; font-size: 11 }
}

before -> after: "TRANSITION:\nCR0.PG=1 + far jmp\n+ identity map removal\n+ segment reload" {
  style: { stroke: "#ffaa00"; stroke-width: 3; font-color: "#ffcc44"; font-size: 12; bold: true; animated: true }
}

legend: "Legend" {
  near: bottom-center
  style: {
    fill: "#0d0d0d"
    stroke: "#444444"
    border-radius: 4
    font-color: "#888888"
    font-size: 12
  }

  leg_content: "Red border = hot path / danger zone\nGreen border = kernel code/data after paging\nYellow/Orange = transition / pre-paging\nPurple = page tables / MMU metadata\nBlue = linker script / build system\nDashed border = temporary / removed after transition\nVMA = Virtual Memory Address (linked symbol value)\nLMA = Load Memory Address (physical location in RAM)\nAT() = linker directive to decouple VMA from LMA\nidentity map = virt == phys (bootstrap only)\nhigher-half = kernel at virtual 0xC0000000+" {
    style: {
      fill: "#050505"
      stroke: "#333333"
      font-color: "#888888"
      font-size: 11
    }
  }
}