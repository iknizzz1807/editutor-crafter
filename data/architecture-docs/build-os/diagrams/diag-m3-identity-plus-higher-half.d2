vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  ## Dual Mapping: Identity Map + Higher-Half Kernel
  **Virtual Address Space Layout — Paging Enable Transition**
| {near: top-center}
# ─── LEGEND ───────────────────────────────────────────────────────────────────
legend: {
  near: bottom-left
  style: {
    fill: "#1a1a2e"
    stroke: "#444466"
    border-radius: 8
    font-size: 13
  }
  content: |md
    **Color Semantics**
    🟥 Red = Hot path / danger zone
    🟩 Green = Active / safe mapping
    🟦 Blue = Data flow / pointer
    🟨 Yellow = Transition / caution
    ⬛ Gray = Unmapped / unused
    🟪 Purple = Metadata / headers
  |
}
# ─── PHASE LABELS ─────────────────────────────────────────────────────────────
phase_before: "BEFORE paging enabled\n(physical addressing)" {
  style: {
    fill: "#0d1b2a"
    stroke: "#f4a261"
    stroke-width: 3
    font-size: 16
    bold: true
    font-color: "#f4a261"
    border-radius: 6
  }
}
phase_after: "AFTER paging enabled\n(both maps active)" {
  style: {
    fill: "#0d1b2a"
    stroke: "#2ecc71"
    stroke-width: 3
    font-size: 16
    bold: true
    font-color: "#2ecc71"
    border-radius: 6
  }
}
phase_before -> phase_after: "mov cr0, eax   (set CR0.PG bit 31)\nfar jmp 0xC0100xxx" {
  style: {
    stroke: "#f4a261"
    stroke-width: 3
    font-size: 12
    bold: true
    animated: true
    font-color: "#f4a261"
  }
}
# ═══════════════════════════════════════════════════════════════════════════════
# PHYSICAL MEMORY (shared reference — shown once on right)
# ═══════════════════════════════════════════════════════════════════════════════
phys: "PHYSICAL MEMORY (RAM)" {
  style: {
    fill: "#0f0f23"
    stroke: "#7b68ee"
    stroke-width: 3
    border-radius: 6
    font-size: 14
    bold: true
    font-color: "#b8b0ff"
  }
  p_null: "0x00000000 – 0x00000FFF\n[Frame 0] BIOS data area / NULL guard\n4 KB" {
    style: { fill: "#3d0000"; stroke: "#cc0000"; font-size: 11; border-radius: 4; font-color: "#ff6b6b" }
  }
  p_low: "0x00001000 – 0x000FFFFF\n[Frames 1–255] Conventional RAM\nBIOS, EBDA, VGA hole\n~1 MB" {
    style: { fill: "#2d2d00"; stroke: "#888800"; font-size: 11; border-radius: 4; font-color: "#e0e060" }
  }
  p_vga: "0x000B8000 – 0x000BFFFF\n[VGA text framebuffer]\nMMIO — in low region above\n32 KB" {
    style: { fill: "#1a0033"; stroke: "#8800cc"; font-size: 11; border-radius: 4; font-color: "#cc88ff" }
  }
  p_kernel: "0x00100000 – 0x004FFFFF\n[Frames 256–1279] KERNEL BINARY\n.text / .rodata / .data / .bss\nLMA (load address) — 4 MB window" {
    style: { fill: "#003300"; stroke: "#00aa00"; stroke-width: 2; font-size: 11; border-radius: 4; font-color: "#88ff88"; bold: true }
  }
  p_heap: "0x00500000 – 0x07FFFFFF\n[Frames 1280–32767] Available RAM\nFuture: pmm_alloc_frame() pool\n~123 MB" {
    style: { fill: "#001a33"; stroke: "#004488"; font-size: 11; border-radius: 4; font-color: "#6699cc" }
  }
  p_high: "0x08000000 – 0xFFBFFFFF\nReserved / ACPI / PCI MMIO\n(DO NOT ALLOCATE)" {
    style: { fill: "#1a1a1a"; stroke: "#555555"; font-size: 11; border-radius: 4; font-color: "#888888" }
  }
  p_null -> p_low -> p_vga -> p_kernel -> p_heap -> p_high: {style.stroke: "#444466"; style.stroke-width: 1}
}
# ═══════════════════════════════════════════════════════════════════════════════
# PAGE DIRECTORY — the hardware structure
# ═══════════════════════════════════════════════════════════════════════════════
page_dir: "boot_pd  [PAGE DIRECTORY]\n4 KB — 1024 entries × 4 bytes\nCR3 = VIRT_TO_PHYS(&boot_pd)\nAligned: __attribute__((aligned(4096)))" {
  style: {
    fill: "#0d0d2e"
    stroke: "#7b68ee"
    stroke-width: 3
    border-radius: 6
    font-size: 13
    bold: true
    font-color: "#b8b0ff"
  }
  pde_null_range: "PDE[1] – PDE[767]\nVirtual 0x00400000 – 0xBFFFFFFF\nvalue = 0x00000000\n(NOT PRESENT — P-bit = 0)\n~3 GB user space (future processes)" {
    style: { fill: "#1a1a1a"; stroke: "#444444"; font-size: 11; border-radius: 4; font-color: "#666666"; italic: true }
  }
  pde_identity: "PDE[0]  →  pt_low\nVirtual 0x00000000 – 0x003FFFFF\nvalue = PHYS(pt_low) | P | W\nIndex: virt >> 22 = 0\n⚠ IDENTITY MAP — TEMPORARY" {
    style: { fill: "#2d1a00"; stroke: "#f4a261"; stroke-width: 3; font-size: 11; border-radius: 4; font-color: "#f4a261"; bold: true }
  }
  pde_higher: "PDE[768] →  pt_high\nVirtual 0xC0000000 – 0xC03FFFFF\nvalue = PHYS(pt_high) | P | W\nIndex: 0xC0000000 >> 22 = 768\n✓ HIGHER-HALF KERNEL MAP" {
    style: { fill: "#003300"; stroke: "#2ecc71"; stroke-width: 3; font-size: 11; border-radius: 4; font-color: "#2ecc71"; bold: true }
  }
  pde_null_range -> pde_identity -> pde_higher: {style.stroke: "#444466"; style.stroke-width: 1}
}
# ═══════════════════════════════════════════════════════════════════════════════
# PAGE TABLE — IDENTITY MAP (pt_low)
# ═══════════════════════════════════════════════════════════════════════════════
pt_low: "pt_low  [PAGE TABLE — Identity Map]\n4 KB — 1024 entries\nfor (i=0; i<1024; i++) pt_low[i] = (i*4096) | P | W" {
  style: {
    fill: "#1a0d00"
    stroke: "#f4a261"
    stroke-width: 2
    border-radius: 6
    font-size: 12
    bold: true
    font-color: "#f4a261"
  }
  ptl_0: "PTE[0]   = 0x00000000 | P|W\nVirt 0x00000000 → Phys 0x00000000" {
    style: { fill: "#2d1a00"; stroke: "#f4a261"; font-size: 11; border-radius: 3; font-color: "#ccaa77" }
  }
  ptl_b8: "PTE[184] = 0x000B8000 | P|W\nVirt 0x000B8000 → Phys 0x000B8000\n(VGA buffer identity-mapped)" {
    style: { fill: "#1a0033"; stroke: "#8800cc"; font-size: 11; border-radius: 3; font-color: "#cc88ff" }
  }
  ptl_100: "PTE[256] = 0x00100000 | P|W\nVirt 0x00100000 → Phys 0x00100000\n(kernel code — identity)" {
    style: { fill: "#2d1a00"; stroke: "#f4a261"; font-size: 11; border-radius: 3; font-color: "#ccaa77" }
  }
  ptl_dots: "PTE[257..1023]\nVirt 0x00101000..0x003FFFFF\n→ Phys same address" {
    style: { fill: "#1a1000"; stroke: "#776633"; font-size: 11; border-radius: 3; font-color: "#998855"; italic: true }
  }
  ptl_0 -> ptl_b8 -> ptl_100 -> ptl_dots: {style.stroke: "#774433"; style.stroke-width: 1}
}
# ═══════════════════════════════════════════════════════════════════════════════
# PAGE TABLE — HIGHER-HALF MAP (pt_high)
# ═══════════════════════════════════════════════════════════════════════════════
pt_high: "pt_high  [PAGE TABLE — Higher-Half Kernel]\n4 KB — 1024 entries\nfor (i=0; i<1024; i++) pt_high[i] = (i*4096) | P | W\nSAME FRAMES as pt_low — different virtual window" {
  style: {
    fill: "#001a00"
    stroke: "#2ecc71"
    stroke-width: 2
    border-radius: 6
    font-size: 12
    bold: true
    font-color: "#2ecc71"
  }
  pth_0: "PTE[0]   = 0x00000000 | P|W\nVirt 0xC0000000 → Phys 0x00000000" {
    style: { fill: "#002200"; stroke: "#2ecc71"; font-size: 11; border-radius: 3; font-color: "#88cc88" }
  }
  pth_100: "PTE[256] = 0x00100000 | P|W\nVirt 0xC0100000 → Phys 0x00100000\n(kernel .text VMA — LINKED HERE)" {
    style: { fill: "#003300"; stroke: "#2ecc71"; stroke-width: 2; font-size: 11; border-radius: 3; font-color: "#aaffaa"; bold: true }
  }
  pth_dots: "PTE[257..1023]\nVirt 0xC0101000..0xC03FFFFF\n→ Phys 0x00101000..0x003FFFFF\n(rest of kernel binary)" {
    style: { fill: "#001a00"; stroke: "#228844"; font-size: 11; border-radius: 3; font-color: "#66bb66"; italic: true }
  }
  pth_0 -> pth_100 -> pth_dots: {style.stroke: "#226633"; style.stroke-width: 1}
}
# ═══════════════════════════════════════════════════════════════════════════════
# VIRTUAL ADDRESS SPACE VIEWS
# ═══════════════════════════════════════════════════════════════════════════════
virt_space: "VIRTUAL ADDRESS SPACE (32-bit, 4 GB total)" {
  style: {
    fill: "#0a0a1a"
    stroke: "#4444aa"
    stroke-width: 2
    border-radius: 6
    font-size: 13
    bold: true
    font-color: "#8888cc"
  }
  v_null: "0x00000000 – 0x003FFFFF  [PDE 0 → pt_low]\nIDENTITY-MAPPED first 4 MB\nVirt == Phys during boot transition\nRequired: execution continues after CR0.PG set\n4 MB" {
    style: { fill: "#2d1a00"; stroke: "#f4a261"; stroke-width: 2; font-size: 11; border-radius: 4; font-color: "#f4a261" }
  }
  v_user: "0x00400000 – 0xBFFFFFFF  [PDE 1–767]\nNOT PRESENT — all PDEs = 0\nFuture: user process pages mapped here\nAccess → Page Fault #PF\n~3 GB" {
    style: { fill: "#111111"; stroke: "#444444"; font-size: 11; border-radius: 4; font-color: "#666666"; italic: true }
  }
  v_kernel: "0xC0000000 – 0xC03FFFFF  [PDE 768 → pt_high]\nHIGHER-HALF KERNEL  ← ALL SYMBOL ADDRESSES\nKernel .text linked at 0xC0100000 (VMA)\nPhysical frames: 0x00000000–0x003FFFFF\n4 MB" {
    style: { fill: "#003300"; stroke: "#2ecc71"; stroke-width: 2; font-size: 11; border-radius: 4; font-color: "#2ecc71"; bold: true }
  }
  v_heap: "0xC0400000 – 0xCFFFFFFF  [PDE 769–831]\nKERNEL HEAP (kmalloc arena)\nPages committed on demand via pmm_alloc_frame\n+ paging_map()\n252 MB virtual" {
    style: { fill: "#001a33"; stroke: "#004488"; font-size: 11; border-radius: 4; font-color: "#6699cc" }
  }
  v_reserved: "0xD0000000 – 0xFFBFFFFF  [PDE 832–1022]\nReserved kernel space\n(device MMIO, future kernel extensions)\n~780 MB" {
    style: { fill: "#1a1a1a"; stroke: "#555555"; font-size: 11; border-radius: 4; font-color: "#888888"; italic: true }
  }
  v_recursive: "0xFFC00000 – 0xFFFFFFFF  [PDE 1023]\nOptional: recursive PD mapping\n(maps page tables into virtual space)\n4 MB" {
    style: { fill: "#1a001a"; stroke: "#664466"; font-size: 11; border-radius: 4; font-color: "#aa66aa"; italic: true }
  }
  v_null -> v_user -> v_kernel -> v_heap -> v_reserved -> v_recursive: {style.stroke: "#333355"; style.stroke-width: 1}
}
# ═══════════════════════════════════════════════════════════════════════════════
# ADDRESS TRANSLATION EXAMPLES
# ═══════════════════════════════════════════════════════════════════════════════
translation: "ADDRESS TRANSLATION — Walk Examples" {
  style: {
    fill: "#0d1b2a"
    stroke: "#4488bb"
    stroke-width: 2
    border-radius: 6
    font-size: 13
    bold: true
    font-color: "#88bbdd"
  }
  tx_identity: "IDENTITY WALK  (before jmp to high)\nVirt 0x00100000:\n  [31:22] = 0x000 → PDE[0] = PHYS(pt_low)|P|W\n  [21:12] = 0x100 → PTE[256] = 0x00100000|P|W\n  [11:0]  = 0x000 → offset 0\n  Phys = 0x00100000 ✓ (same as virt)" {
    style: { fill: "#1a0d00"; stroke: "#f4a261"; font-size: 11; border-radius: 4; font-color: "#ccaa77"; font: mono }
  }
  tx_higher: "HIGHER-HALF WALK  (after jmp to high)\nVirt 0xC0100000:\n  [31:22] = 0x300 (768) → PDE[768] = PHYS(pt_high)|P|W\n  [21:12] = 0x100 (256) → PTE[256] = 0x00100000|P|W\n  [11:0]  = 0x000 → offset 0\n  Phys = 0x00100000 ✓ (kernel code)" {
    style: { fill: "#001a00"; stroke: "#2ecc71"; font-size: 11; border-radius: 4; font-color: "#88cc88"; font: mono }
  }
  tx_identity -> tx_higher: "same physical frame\ntwo virtual aliases" {
    style: { stroke: "#888844"; stroke-dash: 4; font-size: 11; font-color: "#bbbb66" }
  }
}
# ═══════════════════════════════════════════════════════════════════════════════
# CRITICAL SEQUENCE ANNOTATION
# ═══════════════════════════════════════════════════════════════════════════════
sequence: "CRITICAL ENABLE SEQUENCE" {
  style: {
    fill: "#1a0000"
    stroke: "#cc2222"
    stroke-width: 2
    border-radius: 6
    font-size: 13
    bold: true
    font-color: "#ff6666"
  }
  s1: "① Fill pt_low[0..1023]: frame i → virt (i×4KB)\n   Identity map: virt == phys for 0x0–0x3FFFFF" {
    style: { fill: "#1a0d00"; stroke: "#f4a261"; font-size: 11; border-radius: 3; font-color: "#ccaa77" }
  }
  s2: "② Fill pt_high[0..1023]: same frames\n   Higher-half map: 0xC0000000+offset → same phys" {
    style: { fill: "#001a00"; stroke: "#2ecc71"; font-size: 11; border-radius: 3; font-color: "#88cc88" }
  }
  s3: "③ boot_pd[0]   = PHYS(pt_low)  | P | W\n   boot_pd[768] = PHYS(pt_high) | P | W" {
    style: { fill: "#0d0d2e"; stroke: "#7b68ee"; font-size: 11; border-radius: 3; font-color: "#b8b0ff" }
  }
  s4: "④ mov cr3, PHYS(boot_pd)   ← load page directory" {
    style: { fill: "#2d1a00"; stroke: "#f4a261"; stroke-width: 2; font-size: 11; border-radius: 3; font-color: "#f4a261"; bold: true }
  }
  s5: "⑤ mov eax,cr0 / or eax,0x80000000 / mov cr0,eax\n   ← PAGING ON — next fetch uses virtual addressing\n   Identity map saves us: 0x00100xxx still valid!" {
    style: { fill: "#330000"; stroke: "#cc0000"; stroke-width: 3; font-size: 11; border-radius: 3; font-color: "#ff8888"; bold: true }
  }
  s6: "⑥ jmp 0xC0100xxx   ← load EIP with higher-half addr\n   Identity map no longer needed — remove PDE[0]" {
    style: { fill: "#003300"; stroke: "#2ecc71"; stroke-width: 2; font-size: 11; border-radius: 3; font-color: "#2ecc71"; bold: true }
  }
  s7: "⑦ boot_pd[0] = 0   ← REMOVE identity map\n   mov cr3, cr3      ← TLB flush\n   NULL deref now → #PF  (safe!)" {
    style: { fill: "#001100"; stroke: "#228844"; font-size: 11; border-radius: 3; font-color: "#66bb66" }
  }
  s1 -> s2 -> s3 -> s4 -> s5 -> s6 -> s7: {style.stroke: "#883322"; style.stroke-width: 1; style.animated: true}
}
# ═══════════════════════════════════════════════════════════════════════════════
# CONNECTIONS — Virtual space to page directory
# ═══════════════════════════════════════════════════════════════════════════════
virt_space.v_null -> page_dir.pde_identity: "PDE lookup\nvirt[31:22]=0x000" {
  style: { stroke: "#f4a261"; stroke-width: 2; font-size: 11; font-color: "#f4a261"; stroke-dash: 3 }
}
virt_space.v_kernel -> page_dir.pde_higher: "PDE lookup\nvirt[31:22]=0x300" {
  style: { stroke: "#2ecc71"; stroke-width: 2; font-size: 11; font-color: "#2ecc71"; stroke-dash: 3 }
}
# Page directory to page tables
page_dir.pde_identity -> pt_low: "points to\nPHYS(pt_low)" {
  style: { stroke: "#f4a261"; stroke-width: 2; font-size: 11; font-color: "#f4a261" }
}
page_dir.pde_higher -> pt_high: "points to\nPHYS(pt_high)" {
  style: { stroke: "#2ecc71"; stroke-width: 2; font-size: 11; font-color: "#2ecc71" }
}
# Page tables to physical frames
pt_low.ptl_100 -> phys.p_kernel: "→ Phys 0x00100000\n(LMA = load address)" {
  style: { stroke: "#f4a261"; stroke-width: 2; font-size: 11; font-color: "#f4a261"; animated: true }
}
pt_high.pth_100 -> phys.p_kernel: "→ SAME Phys 0x00100000\n(kernel binary shared)" {
  style: { stroke: "#2ecc71"; stroke-width: 2; font-size: 11; font-color: "#2ecc71"; animated: true }
}
pt_low.ptl_b8 -> phys.p_vga: "→ Phys 0x000B8000\nVGA framebuffer" {
  style: { stroke: "#aa44cc"; stroke-width: 1; font-size: 10; font-color: "#aa44cc"; stroke-dash: 4 }
}
# Translation examples to page tables
translation.tx_identity -> pt_low: "walks pt_low[256]" {
  style: { stroke: "#888855"; stroke-dash: 3; font-size: 10; font-color: "#888855" }
}
translation.tx_higher -> pt_high: "walks pt_high[256]" {
  style: { stroke: "#558855"; stroke-dash: 3; font-size: 10; font-color: "#558855" }
}
# Physical memory label connection
phys.p_kernel -> translation: "both maps → same frames" {
  style: { stroke: "#7b68ee"; stroke-dash: 5; font-size: 10; font-color: "#7b68ee" }
}
# Sequence flow to key structures
sequence.s4 -> page_dir: "CR3 ← PHYS(boot_pd)" {
  style: { stroke: "#cc4444"; stroke-width: 2; font-size: 11; font-color: "#cc4444" }
}
sequence.s6 -> virt_space.v_kernel: "EIP = 0xC0100xxx\nexecution moves here" {
  style: { stroke: "#2ecc71"; stroke-width: 2; font-size: 11; font-color: "#2ecc71" }
}