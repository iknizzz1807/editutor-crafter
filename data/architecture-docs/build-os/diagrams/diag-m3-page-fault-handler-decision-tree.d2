vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Page Fault Handler: CR2 Decoding and Response Decision Tree" {
  near: top-center
  style: {
    font-size: 22
    bold: true
    font-color: "#e0e0ff"
  }
}

entry: "Exception 14 Fires\nCPU pushes: EIP, CS, EFLAGS\nESP, SS (ring-3), Error Code\nHardware sets CR2 = faulting VA" {
  style: {
    fill: "#1a1a2e"
    font-color: white
    stroke: "#4a9eff"
    stroke-width: 3
    border-radius: 8
  }
}

read_cr2: "Step 1: Read CR2 IMMEDIATELY\nasm: mov %%cr2, reg\nMust be first line in handler\nNested fault overwrites CR2" {
  style: {
    fill: "#16213e"
    font-color: "#ffd700"
    stroke: "#ffd700"
    stroke-width: 2
    border-radius: 6
  }
}

decode_error: "Step 2: Decode Error Code\nP bit0: 0=Not-present 1=Protection\nW bit1: 0=Read 1=Write\nU bit2: 0=Supervisor 1=User\nR bit3: 0=Normal 1=Reserved PTE\nI bit4: 0=Data 1=Instr fetch" {
  style: {
    fill: "#0f3460"
    font-color: white
    stroke: "#7b68ee"
    stroke-width: 2
    border-radius: 6
  }
}

q_reserved: "Reserved bit set?\nR=1 in error code?" {
  shape: diamond
  style: {
    fill: "#4a0000"
    font-color: white
    stroke: "#ff4444"
    stroke-width: 2
  }
}

q_user_mode: "User-mode fault?\nU=1?" {
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: white
    stroke: "#7b68ee"
    stroke-width: 2
  }
}

q_p_bit_kernel: "Page present?\nP=1 (kernel)" {
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: white
    stroke: "#7b68ee"
    stroke-width: 2
  }
}

q_p_bit_user: "Page present?\nP=1 (user)" {
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: white
    stroke: "#cc0066"
    stroke-width: 2
  }
}

q_addr_null_kernel: "CR2 < PAGE_SIZE?\nKernel null-ptr deref?" {
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: white
    stroke: "#ff8c00"
    stroke-width: 2
  }
}

q_addr_range_kernel: "CR2 in heap range?\n0xD0000000-0xDFFFFFFF?" {
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: white
    stroke: "#4a9eff"
    stroke-width: 2
  }
}

q_write_user: "Write fault?\nW=1?" {
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: white
    stroke: "#cc0066"
    stroke-width: 2
  }
}

q_cow: "PTE has COW flag?\ncopy-on-write marked?" {
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: white
    stroke: "#7b68ee"
    stroke-width: 2
  }
}

q_user_prot: "PTE supervisor-only?\nU/S=0 in PTE?" {
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: white
    stroke: "#7b68ee"
    stroke-width: 2
  }
}

q_user_null: "CR2 < PAGE_SIZE?\nUser null deref?" {
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: white
    stroke: "#ff8c00"
    stroke-width: 2
  }
}

branch_reserved: "CORRUPT PAGE TABLE PANIC\nImplemented in M3\n\nReserved PTE bit set:\nhardware spec violation.\npage tables corrupted.\n\nPrint: CR2, PDE, PTE values\nasm: cli + hlt\nUnrecoverable." {
  style: {
    fill: "#330000"
    font-color: "#ff9999"
    stroke: "#ff0000"
    stroke-width: 3
    border-radius: 8
  }
}

branch1: "DEMAND PAGING\nImplemented in M3\n\n1. frame = pmm_alloc_frame()\n2. memset(frame, 0, 4096)\n3. vmm_map_page(pd, cr2 and ~mask,\n   frame, PRESENT or WRITABLE)\n4. invlpg(cr2)\n5. return to isr stub\n\nCPU retries faulting instruction.\nProcess unaware fault occurred." {
  style: {
    fill: "#003300"
    font-color: "#90ee90"
    stroke: "#00cc00"
    stroke-width: 3
    border-radius: 8
  }
}

branch2: "KERNEL NULL-PTR PANIC\nImplemented in M3\n\nKernel code deref'd NULL.\nLikely bad pointer init.\n\nPrint: CR2, EC, EIP, all regs\nasm: cli + hlt\nSystem halted." {
  style: {
    fill: "#330000"
    font-color: "#ff9999"
    stroke: "#ff4444"
    stroke-width: 3
    border-radius: 8
  }
}

branch3: "KERNEL UNMAPPED PANIC\nImplemented in M3\n\nCR2 not in heap range:\n- Stack overflow past reserve\n- Bad pointer arithmetic\n- Corrupted function pointer\n\nPrint: CR2, PDE/PTE values\nasm: cli + hlt" {
  style: {
    fill: "#330000"
    font-color: "#ff9999"
    stroke: "#ff4444"
    stroke-width: 3
    border-radius: 8
  }
}

branch4: "KERNEL PROTECTION PANIC\nImplemented in M3\n\nP=1: page present but:\n- Write to read-only page\n- Execute from NX page\n- Reserved PTE bit\n\nPrint: CR2, W flag, PTE flags\nasm: cli + hlt" {
  style: {
    fill: "#330000"
    font-color: "#ff9999"
    stroke: "#ff4444"
    stroke-width: 3
    border-radius: 8
  }
}

branch5: "COPY-ON-WRITE\nFuture Extension: M5+\nNOT in M3\n\nAllocate new frame\nmemcpy(new, old, 4096)\nvmm_map_page WRITABLE\npmm_deref(old frame)\nreturn: CPU retries write\n\nUsed for fork() child writes." {
  style: {
    fill: "#1a1000"
    font-color: "#ffcc44"
    stroke: "#ff8c00"
    stroke-width: 2
    border-radius: 8
    stroke-dash: 5
  }
}

branch6: "USER SIGSEGV: Supervisor Page\nImplemented in M4\n\nUser accessed kernel mem or\nU/S=0 page without COW.\n\nPrint: PID, CR2, EIP\ncurrent->state = ZOMBIE\nsched_schedule()\nProcess killed, others continue." {
  style: {
    fill: "#330022"
    font-color: "#ff99cc"
    stroke: "#cc0066"
    stroke-width: 3
    border-radius: 8
  }
}

branch7: "USER SIGSEGV: Unmapped Page\nImplemented in M4\n\n- Stack overflow past guard\n- Use-after-free (unmapped)\n- Heap overrun\n\nPrint: PID, CR2, EIP\ncurrent->state = ZOMBIE\nsched_schedule()" {
  style: {
    fill: "#330022"
    font-color: "#ff99cc"
    stroke: "#cc0066"
    stroke-width: 3
    border-radius: 8
  }
}

branch8: "USER SIGSEGV: Null Deref\nImplemented in M4\n\nCR2 in 0x0-0xFFF range.\nVA 0 intentionally unmapped.\nGuard page catches cleanly.\n\nPrint: PID, CR2=0x%x, EIP\ncurrent->state = ZOMBIE\nsched_schedule()" {
  style: {
    fill: "#330022"
    font-color: "#ff99cc"
    stroke: "#cc0066"
    stroke-width: 3
    border-radius: 8
  }
}

iret_path: "iret: Resume Faulting Instruction\n\nCPU retries the memory access.\nPTE now present: succeeds.\nProcess unaware fault occurred.\nCost: ~200-500 cycles total." {
  style: {
    fill: "#003300"
    font-color: "#90ee90"
    stroke: "#00cc00"
    stroke-width: 2
    border-radius: 6
  }
}

legend: |md
  **Color Legend**

  ðŸŸ¢ Green â€” Implemented M3
  ðŸŸ  Orange â€” Implemented M4
  ðŸŸ¡ Yellow dashed â€” Future M5+
  ðŸ”´ Red â€” Always panic
| {
  near: bottom-right
  style: {
    fill: "#111122"
    font-color: white
    stroke: "#7b68ee"
    border-radius: 6
  }
}

entry -> read_cr2: "pusha + seg saves done\ncalls C handler" {
  style: { stroke: "#4a9eff"; font-color: "#4a9eff"; stroke-width: 2 }
}

read_cr2 -> decode_error: "CR2 saved to local\nbefore any other code" {
  style: { stroke: "#ffd700"; font-color: "#ffd700"; stroke-width: 2 }
}

decode_error -> q_reserved: "check R bit first\ncorruption guard" {
  style: { stroke: "#7b68ee"; font-color: "#aaaaff" }
}

q_reserved -> branch_reserved: "R=1\ncorrupt tables" {
  style: { stroke: "#ff0000"; font-color: "#ff4444"; bold: true; stroke-width: 2 }
}

q_reserved -> q_user_mode: "R=0\nnormal path" {
  style: { stroke: "#7b68ee"; font-color: "#aaaaff" }
}

q_user_mode -> q_p_bit_kernel: "U=0\nkernel mode" {
  style: { stroke: "#4a9eff"; font-color: "#88ccff" }
}

q_user_mode -> q_p_bit_user: "U=1\nuser mode" {
  style: { stroke: "#cc0066"; font-color: "#ff88bb" }
}

q_p_bit_kernel -> q_addr_null_kernel: "P=0\nnot present" {
  style: { stroke: "#4a9eff"; font-color: "#88ccff" }
}

q_p_bit_kernel -> branch4: "P=1\nprotection violation" {
  style: { stroke: "#ff4444"; font-color: "#ff4444"; bold: true; stroke-width: 2 }
}

q_addr_null_kernel -> branch2: "CR2 < 0x1000\nkernel null ptr" {
  style: { stroke: "#ff4444"; font-color: "#ff4444"; bold: true; stroke-width: 2 }
}

q_addr_null_kernel -> q_addr_range_kernel: "CR2 >= 0x1000\nnon-null addr" {
  style: { stroke: "#4a9eff"; font-color: "#88ccff" }
}

q_addr_range_kernel -> branch1: "YES\nheap range\nM3: demand page" {
  style: { stroke: "#00cc00"; font-color: "#90ee90"; stroke-width: 3; bold: true }
}

q_addr_range_kernel -> branch3: "NO\nunexpected addr\nkernel bug" {
  style: { stroke: "#ff4444"; font-color: "#ff4444"; bold: true; stroke-width: 2 }
}

branch1 -> iret_path: "frame mapped\nTLB flushed\nreturn" {
  style: { stroke: "#00cc00"; font-color: "#90ee90"; stroke-width: 3 }
}

q_p_bit_user -> q_user_null: "P=0\nnot present" {
  style: { stroke: "#cc0066"; font-color: "#ff88bb" }
}

q_p_bit_user -> q_write_user: "P=1\npresent" {
  style: { stroke: "#cc0066"; font-color: "#ff88bb" }
}

q_write_user -> q_cow: "W=1\nwrite fault" {
  style: { stroke: "#cc0066"; font-color: "#ff88bb" }
}

q_write_user -> q_user_prot: "W=0\nread violation" {
  style: { stroke: "#cc0066"; font-color: "#ff88bb" }
}

q_user_null -> branch8: "CR2 < 0x1000\nnull deref" {
  style: { stroke: "#cc0066"; font-color: "#ff88bb"; bold: true; stroke-width: 2 }
}

q_user_null -> branch7: "CR2 >= 0x1000\nunmapped page" {
  style: { stroke: "#cc0066"; font-color: "#ff88bb"; bold: true; stroke-width: 2 }
}

q_cow -> branch5: "COW bit set\nM5+ future" {
  style: { stroke: "#ff8c00"; font-color: "#ffcc44"; stroke-dash: 5; bold: true }
}

q_cow -> branch6: "No COW\nwrite to RO page" {
  style: { stroke: "#cc0066"; font-color: "#ff88bb"; bold: true; stroke-width: 2 }
}

q_user_prot -> branch6: "U/S=0 in PTE\nkernel page read" {
  style: { stroke: "#cc0066"; font-color: "#ff88bb"; bold: true; stroke-width: 2 }
}