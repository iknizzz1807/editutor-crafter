vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |'md
  # PDE / PTE — 32-bit Bit-Level Layout
  **structure_layout** · x86 Two-Level Paging · Milestone 3
'| {near: top-center}
back_to_map: "↖ Satellite Map" {
  link: "#diag-satellite-os-map"
  style: {
    fill: "#2d2d2d"
    font-color: "#aaaaaa"
    stroke: "#555555"
    border-radius: 4
    font-size: 11
  }
}
# ─────────────────────────────────────────────────────────────────────────────
# LEGEND
# ─────────────────────────────────────────────────────────────────────────────
legend: {
  near: bottom-left
  label: "Legend"
  style: {
    fill: "#1a1a2e"
    stroke: "#444466"
    border-radius: 6
    font-size: 12
  }
  l_addr: "■ Physical Frame Address (20 bits)" {
    style.fill: "#1a3a5c"
    style.font-color: "#7ab8f5"
    style.stroke: "#2a5a8c"
    style.border-radius: 3
  }
  l_avl: "■ AVL — available for OS use (3 bits)" {
    style.fill: "#2d1b4e"
    style.font-color: "#bb99ee"
    style.stroke: "#5533aa"
    style.border-radius: 3
  }
  l_flags: "■ Control/Status flags (8 bits)" {
    style.fill: "#1a3a1a"
    style.font-color: "#88cc88"
    style.stroke: "#336633"
    style.border-radius: 3
  }
  l_pte_only: "■ PTE-only field (not in PDE)" {
    style.fill: "#3a2a00"
    style.font-color: "#ddaa44"
    style.stroke: "#886600"
    style.border-radius: 3
  }
  l_present: "■ P — Present bit (critical)" {
    style.fill: "#3a0000"
    style.font-color: "#ff6666"
    style.stroke: "#aa0000"
    style.border-radius: 3
  }
}
# ─────────────────────────────────────────────────────────────────────────────
# SHARED ENTRY LAYOUT — 32-bit word diagram
# ─────────────────────────────────────────────────────────────────────────────
shared_header: |'md
  ## Generic 32-bit PDE / PTE Structure
  `offset 0` — one 4-byte (32-bit) entry in a 1024-entry table (4 KB total per table)
'| {
  style: {
    fill: "#111122"
    stroke: "#333355"
    border-radius: 6
    font-size: 13
  }
}
bit_row: "Bit-field Map  (bit 31 → bit 0, left to right)" {
  style: {
    fill: "#0d0d1a"
    stroke: "#2a2a4a"
    border-radius: 8
    font-size: 12
  }
  b31_12: "BITS 31 : 12\nPhysical Frame Number\n(20 bits)\npage-aligned addr >> 12\nexample: 0x00100 → 0x00100000" {
    width: 340
    style: {
      fill: "#1a3a5c"
      font-color: "#7ab8f5"
      stroke: "#2a6aaa"
      bold: true
      border-radius: 4
    }
  }
  b11_9: "BITS 11:9\nAVL\n(3 bits)\nOS-defined\nignored by CPU" {
    width: 90
    style: {
      fill: "#2d1b4e"
      font-color: "#bb99ee"
      stroke: "#5533aa"
      border-radius: 4
    }
  }
  b8: "BIT 8\nG\nGlobal\n(PTE)\nno TLB\nflush" {
    width: 70
    style: {
      fill: "#1a3a1a"
      font-color: "#88cc88"
      stroke: "#336633"
      border-radius: 4
    }
  }
  b7: "BIT 7\nPAT/PS\nPage Size\n(PDE: 1=4MB)\nor PAT\n(PTE)" {
    width: 75
    style: {
      fill: "#1a3a1a"
      font-color: "#88cc88"
      stroke: "#336633"
      border-radius: 4
    }
  }
  b6: "BIT 6\nD\nDirty\n(PTE only)\nCPU sets\non write" {
    width: 72
    style: {
      fill: "#3a2a00"
      font-color: "#ddaa44"
      stroke: "#886600"
      bold: true
      border-radius: 4
    }
  }
  b5: "BIT 5\nA\nAccessed\nCPU sets\non any\naccess" {
    width: 70
    style: {
      fill: "#1a3a1a"
      font-color: "#88cc88"
      stroke: "#336633"
      border-radius: 4
    }
  }
  b4: "BIT 4\nPCD\nCache\nDisable\n(MMIO\nuse)" {
    width: 68
    style: {
      fill: "#1a3a1a"
      font-color: "#88cc88"
      stroke: "#336633"
      border-radius: 4
    }
  }
  b3: "BIT 3\nPWT\nWrite\nThrough\ncache" {
    width: 66
    style: {
      fill: "#1a3a1a"
      font-color: "#88cc88"
      stroke: "#336633"
      border-radius: 4
    }
  }
  b2: "BIT 2\nU/S\nUser /\nSupervisor\n0=kernel\n1=user" {
    width: 72
    style: {
      fill: "#1a3a1a"
      font-color: "#88cc88"
      stroke: "#224422"
      bold: true
      border-radius: 4
    }
  }
  b1: "BIT 1\nR/W\nRead /\nWrite\n0=RO\n1=RW" {
    width: 66
    style: {
      fill: "#1a3a1a"
      font-color: "#88cc88"
      stroke: "#336633"
      bold: true
      border-radius: 4
    }
  }
  b0: "BIT 0\nP\nPresent\n0=FAULT\n1=valid" {
    width: 62
    style: {
      fill: "#3a0000"
      font-color: "#ff6666"
      stroke: "#aa2222"
      bold: true
      border-radius: 4
    }
  }
}
# ─────────────────────────────────────────────────────────────────────────────
# ANNOTATION CALLOUTS
# ─────────────────────────────────────────────────────────────────────────────
addr_note: |'md
  **Address Field (bits 31:12) — 20 bits**
  Pages are **4 KB-aligned** (2¹² = 4096 bytes),
  so the low 12 bits of any frame address are
  always zero. The CPU stores only bits **31:12**
  (the "Page Frame Number"), saving 12 bits for
  the flag fields below.
  `Physical Addr = PFN << 12`
  → 20-bit PFN → 32-bit physical address
  → Max addressable: 2²⁰ × 4 KB = **4 GB**
'| {
  style: {
    fill: "#0d1e30"
    stroke: "#2a5a8c"
    font-color: "#7ab8f5"
    border-radius: 6
    font-size: 12
  }
}
dirty_note: |'md
  **D (Dirty) — BIT 6 — PTE only**
  The CPU **hardware** sets this bit on the
  first **write** to the page. The OS uses it
  to detect modified pages before swapping
  to disk (dirty pages must be written back;
  clean pages can be discarded).
  PDE bit 6 is **reserved** (must be 0).
  Never set in a PDE.
'| {
  style: {
    fill: "#1e1200"
    stroke: "#886600"
    font-color: "#ddaa44"
    border-radius: 6
    font-size: 12
  }
}
us_note: |'md
  **U/S — BIT 2 — User / Supervisor**
  `U/S = 0` → **Supervisor-only** (ring 0 access)
  `U/S = 1` → **User-accessible** (ring 3 allowed)
  CPL check rule:
  `CPL ≤ 0` (kernel): can access ANY page
  `CPL = 3` (user): can only access U/S=1 pages
  A user-mode access to a U/S=0 page raises
  **#PF (vector 14)** with error-code bit 2=1
  (user-mode violation, page IS present).
'| {
  style: {
    fill: "#0d1a0d"
    stroke: "#336633"
    font-color: "#99dd99"
    border-radius: 6
    font-size: 12
  }
}
present_note: |'md
  **P (Present) — BIT 0**
  `P = 0` → Entry is **invalid**.
  Any access → **#PF (vector 14)**, error code
  bit 0 = 0 (not-present fault).
  Handler maps the page and returns via `iret`
  to **retry** the faulting instruction.
  `P = 1` → Entry is valid; CPU uses
  bits 31:12 as the physical frame number.
  **TLB rule:** After setting P=0 on a
  previously-present PTE, call `invlpg` or
  reload CR3 — the TLB may cache the old
  valid translation.
'| {
  style: {
    fill: "#1a0000"
    stroke: "#aa2222"
    font-color: "#ff8888"
    border-radius: 6
    font-size: 12
  }
}
# ─────────────────────────────────────────────────────────────────────────────
# EXAMPLE ENTRIES — CONCRETE VALUES
# ─────────────────────────────────────────────────────────────────────────────
examples_header: |'md
  ## Concrete Entry Examples
'| {
  style: {
    fill: "#111122"
    stroke: "#333355"
    border-radius: 4
    font-size: 13
  }
}
examples: {
  style: {
    fill: "#0d0d1a"
    stroke: "#2a2a4a"
    border-radius: 8
    font-size: 12
  }
  ex1: {
    label: "KERNEL CODE PTE\n(read-only, supervisor)"
    style: {
      fill: "#0d1e30"
      stroke: "#2a5a8c"
      font-color: "#aaccff"
      border-radius: 6
      bold: false
    }
    raw: "Raw value:  0x00101001" {
      style.fill: "#0a0a1a"
      style.font-color: "#cccccc"
      style.stroke: "#333333"
      style.font: mono
    }
    decode: |'md
      **Decoded:**
      - Bits 31:12 = `0x00101` → frame at **0x00101000**
      - AVL = `000`
      - G=0, PAT=0, D=0, A=0, PCD=0, PWT=0
      - **U/S = 0** → supervisor only (ring 0)
      - **R/W = 0** → read-only
      - **P  = 1** → present ✓
      `→ kernel .text page, no user access, no writes`
    '| {
      style.fill: "#0a1420"
      style.font-color: "#88aedd"
      style.stroke: "#1a3a5c"
    }
  }
  ex2: {
    label: "KERNEL DATA PTE\n(writable, supervisor)"
    style: {
      fill: "#0d1e30"
      stroke: "#2a5a8c"
      font-color: "#aaccff"
      border-radius: 6
    }
    raw: "Raw value:  0x00200003" {
      style.fill: "#0a0a1a"
      style.font-color: "#cccccc"
      style.stroke: "#333333"
      style.font: mono
    }
    decode: |'md
      **Decoded:**
      - Bits 31:12 = `0x00200` → frame at **0x00200000**
      - AVL = `000`
      - G=0, PAT=0, D=0, A=0, PCD=0, PWT=0
      - **U/S = 0** → supervisor only
      - **R/W = 1** → read/write
      - **P  = 1** → present ✓
      `→ kernel .data/.bss page — writable, kernel-only`
    '| {
      style.fill: "#0a1420"
      style.font-color: "#88aedd"
      style.stroke: "#1a3a5c"
    }
  }
  ex3: {
    label: "USER DATA PTE\n(writable, user-accessible)"
    style: {
      fill: "#0d260d"
      stroke: "#225522"
      font-color: "#99cc99"
      border-radius: 6
    }
    raw: "Raw value:  0x00B00007" {
      style.fill: "#0a0a1a"
      style.font-color: "#cccccc"
      style.stroke: "#333333"
      style.font: mono
    }
    decode: |'md
      **Decoded:**
      - Bits 31:12 = `0x00B00` → frame at **0x00B00000**
      - AVL = `000`
      - G=0, PAT=0, D=0, A=0, PCD=0, PWT=0
      - **U/S = 1** → user-accessible ← key difference
      - **R/W = 1** → read/write
      - **P  = 1** → present ✓
      `→ user heap/stack page — ring 3 can read & write`
    '| {
      style.fill: "#0a1a0a"
      style.font-color: "#88cc88"
      style.stroke: "#1a3a1a"
    }
  }
  ex4: {
    label: "NOT-PRESENT PTE\n(demand paging trigger)"
    style: {
      fill: "#200000"
      stroke: "#660000"
      font-color: "#ff9999"
      border-radius: 6
    }
    raw: "Raw value:  0x00000000" {
      style.fill: "#0a0a1a"
      style.font-color: "#cccccc"
      style.stroke: "#333333"
      style.font: mono
    }
    decode: |'md
      **Decoded:**
      - Bits 31:12 = `0x00000` (OS may store swap info here)
      - All flags = 0
      - **P = 0** → **NOT PRESENT** ← triggers #PF
      **CPU action on access:**
      1. Raises #PF (vector 14)
      2. Saves faulting address in **CR2**
      3. Pushes error code: bit0=0 (not-present)
      4. Calls `idt[14]` handler
      5. Handler allocates frame, sets P=1
      6. `iret` → CPU **retries** the instruction
    '| {
      style.fill: "#1a0000"
      style.font-color: "#ff7777"
      style.stroke: "#550000"
    }
  }
  ex5: {
    label: "MMIO PTE\n(uncached, e.g. VGA 0xB8000)"
    style: {
      fill: "#1a1a00"
      stroke: "#666600"
      font-color: "#dddd88"
      border-radius: 6
    }
    raw: "Raw value:  0x000B8013" {
      style.fill: "#0a0a1a"
      style.font-color: "#cccccc"
      style.stroke: "#333333"
      style.font: mono
    }
    decode: |'md
      **Decoded:**
      - Bits 31:12 = `0x000B8` → frame at **0x000B8000** (VGA buffer)
      - AVL = `000`
      - G=0, PAT=0, D=0, A=0
      - **PCD = 1** → Cache Disable ← no CPU caching for MMIO
      - PWT = 0
      - **U/S = 0** → supervisor only
      - **R/W = 1** → writable
      - **P  = 1** → present ✓
      `0x13 = 0b0001_0011: PCD=1, R/W=1, P=1`
    '| {
      style.fill: "#151500"
      style.font-color: "#cccc66"
      style.stroke: "#444400"
    }
  }
}
# ─────────────────────────────────────────────────────────────────────────────
# PDE vs PTE DIFFERENCE TABLE
# ─────────────────────────────────────────────────────────────────────────────
diff_table: |'md
  ## PDE vs PTE — Field Differences
  | Bit | Field | In PDE | In PTE |
  |-----|-------|--------|--------|
  | 31:12 | Frame addr | → physical addr of **Page Table** | → physical addr of **4 KB page** |
  | 8 | G (Global) | **Ignored** | TLB global flag — survives CR3 reload |
  | 7 | PS / PAT | **PS=1 → 4 MB huge page** (maps 1024 pages directly) | PAT (Page Attribute Table index bit 2) |
  | 6 | D (Dirty) | **Reserved, must be 0** | CPU sets on first **write** to this page |
  | 5 | A (Accessed) | CPU sets when any PTE in this PT is accessed | CPU sets on any access to this page |
  | 2 | U/S | Controls user access to **entire 4 MB region** | Controls user access to **this 4 KB page** |
  | 1 | R/W | If 0: all PTEs in this PT are read-only (AND logic) | Individual page write permission |
  > **AND-logic rule for R/W and U/S:**  
  > Final permission = PDE.flag **AND** PTE.flag  
  > A PDE with R/W=0 makes the entire page table read-only, regardless of PTE R/W bits.
'| {
  style: {
    fill: "#0d0d1a"
    stroke: "#333355"
    font-color: "#ccccee"
    border-radius: 8
    font-size: 12
  }
}
# ─────────────────────────────────────────────────────────────────────────────
# ADDRESS TRANSLATION FORMULA
# ─────────────────────────────────────────────────────────────────────────────
translation: |'md
  ## Address Translation — Full Walk
  
  Virtual Address (32-bit):
  ┌────────────┬────────────┬────────────┐
  │  DIR[9:0]  │  TBL[9:0]  │  OFS[11:0] │
  │  bits 31:22│  bits 21:12│  bits 11:0 │
  └────────────┴────────────┴────────────┘
  Step 1:  PDE = PageDirectory[ DIR ]          ← CR3 + DIR×4
           if PDE.P == 0  →  #PF (not-present)
  Step 2:  PTE = PageTable[ TBL ]              ← PDE.frame<<12 + TBL×4
           if PTE.P == 0  →  #PF (not-present)
           if PTE.U/S==0 and CPL==3  →  #PF (protection violation)
           if PTE.R/W==0 and write   →  #PF (write to read-only)
  Step 3:  PhysAddr = (PTE.frame << 12) | OFS  ← final physical address
  TLB caches: virtual[31:12]  →  (physical[31:12], flags)
  INVLPG vaddr  →  evicts single entry
  MOV CR3, val  →  flushes ALL non-global entries
'| {
  style: {
    fill: "#0a0a14"
    stroke: "#2a2a44"
    font-color: "#aaaacc"
    border-radius: 8
    font-size: 12
  }
}
# ─────────────────────────────────────────────────────────────────────────────
# CONNECTIONS / FLOW
# ─────────────────────────────────────────────────────────────────────────────
shared_header -> bit_row: "32-bit entry layout →" {
  style.stroke: "#555577"
  style.font-color: "#888899"
  style.font-size: 11
}
bit_row.b31_12 -> addr_note: "20-bit PFN — why only 20 bits?" {
  style.stroke: "#2a6aaa"
  style.font-color: "#5588bb"
  style.font-size: 11
  style.stroke-dash: 3
}
bit_row.b6 -> dirty_note: "PTE-only — CPU sets on write" {
  style.stroke: "#886600"
  style.font-color: "#aa8800"
  style.font-size: 11
  style.stroke-dash: 3
}
bit_row.b2 -> us_note: "hardware ring isolation" {
  style.stroke: "#336633"
  style.font-color: "#448844"
  style.font-size: 11
  style.stroke-dash: 3
}
bit_row.b0 -> present_note: "#PF trigger — demand paging entry point" {
  style.stroke: "#aa2222"
  style.font-color: "#cc4444"
  style.font-size: 11
  style.stroke-dash: 3
  style.stroke-width: 2
}
examples_header -> examples: "" {
  style.stroke: "#333355"
  style.font-size: 10
}
examples.ex4 -> translation: "P=0 → triggers this walk ending in #PF" {
  style.stroke: "#cc3333"
  style.stroke-dash: 4
  style.font-color: "#cc4444"
  style.font-size: 11
}
bit_row -> diff_table: "PDE vs PTE field semantics →" {
  style.stroke: "#444466"
  style.font-color: "#666688"
  style.font-size: 11
  style.stroke-dash: 3
}