vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# â”€â”€ VISUAL STYLES & CLASSES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
classes: {
  memory_box: {
    style: {
      fill: "#0d1520"
      stroke: "#445566"
      stroke-width: 2
      border-radius: 4
    }
  }
  hardware_component: {
    style: {
      fill: "#1a1a2e"
      stroke: "#444466"
      stroke-width: 3
      border-radius: 8
    }
  }
  danger_state: {
    style: {
      fill: "#2d0a0a"
      stroke: "#ff4444"
      stroke-width: 3
    }
  }
  success_state: {
    style: {
      fill: "#0a1a0a"
      stroke: "#44cc44"
      stroke-width: 3
    }
  }
}

# â”€â”€ TITLE & OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
title: {
  shape: text
  near: top-center
  label: ||md
    # TLB â€” Translation Caching & Flush Requirements
    **Mechanism: Handling Stale Entries during Page Table Updates**
  ||
}

# â”€â”€ NAVIGATION & BACKLINK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
back_link: {
  label: "Back to Satellite Map"
  link: "#anchor-os-map"
  near: top-right
  style: { 
    italic: true
    font-size: 11
    fill: transparent
    stroke: "#555555"
  }
}

# â”€â”€ COLOR SEMANTICS LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
legend: {
  near: bottom-left
  style: {
    stroke: "#444466"
    fill: "#1a1a2e"
    font-size: 12
  }
  label: ||md
    ### Visual Semantics
    - ðŸ”´ **Red**: Stale state / Fault / Danger
    - ðŸŸ¢ **Green**: Coherent state / Correct
    - ðŸ”µ **Blue**: Data Flow / Translation Path
    - ðŸŸ£ **Purple**: Metadata / CR3 / Control
    - â¬œ **Gray**: Invalid / Flushed
  ||
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTION 1: THE STALE ENTRY PROBLEM (BEFORE)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
before_state: {
  label: "â‘  BEFORE: PTE Updated in RAM, TLB remains Stale"
  style: {
    fill: "#16161d"
    stroke: "#cc3333"
    stroke-width: 4
    double-border: true
  }

  cpu_core: {
    class: hardware_component
    label: "CPU Execution Core"
    instr: "MOV [0xBEEF1000], EAX" {
      style: { font: mono; bold: true; fill: "#2d1515" }
    }
  }

  tlb_cache: {
    class: hardware_component
    label: "TLB (L1 D-TLB Cache)"
    
    stale_entry: {
      class: danger_state
      label: ||md
        **VPN: 0xBEEF1**
        PFN: 0x0042A
        **Perms: R/W=1** (Writable)
        *Status: STALE*
      ||
    }
    other: "... other entries ..." { style.opacity: 0.5 }
  }

  page_table_ram: {
    class: memory_box
    label: "Physical RAM (Page Tables)"
    
    pte_val: {
      class: success_state
      label: ||md
        **PTE @ 0x1F1**
        PFN: 0x0042A
        **Perms: R/W=0** (Read-Only)
        *Status: UPDATED*
      ||
    }
  }

  corruption_fault: {
    shape: cloud
    label: "SILENT CORRUPTION: User writes to Read-Only COW page"
    style: { 
      fill: "#440000"
      stroke: "#ff0000"
      font-color: "#ffffff"
      bold: true 
    }
  }

  cpu_core.instr -> tlb_cache.stale_entry: "VA Lookup: 0xBEEF1"
  tlb_cache.stale_entry -> corruption_fault: "HIT: R/W=1 allowed"
  tlb_cache.stale_entry -> page_table_ram.pte_val: "INCOHERENT" {
    style: { 
      stroke: "#ffaa00"
      stroke-dash: 5
      stroke-width: 2 
    }
  }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTION 2: FLUSH STRATEGIES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
flush_logic: {
  label: "â‘¡ Corrective Actions (OS Kernel Intervention)"
  style: { 
    fill: "#1a1a2e"
    stroke: "#4466cc"
    stroke-width: 2 
  }

  invlpg_op: {
    label: "Strategy A: Targeted (INVLPG)"
    class: hardware_component
    action: "invlpg [0xBEEF1000]" { 
      style: { font: mono; fill: "#0d2a0d" } 
    }
    desc: "Evicts only the specific 4KB mapping."
  }

  cr3_op: {
    label: "Strategy B: Full (CR3 Reload)"
    class: hardware_component
    action: "mov cr3, rsi" { 
      style: { font: mono; fill: "#2a2000" } 
    }
    desc: "Flushes entire non-global TLB."
  }
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTION 3: RECOVERY (AFTER)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
after_state: {
  label: "â‘¢ AFTER: Forced Page Walk & Protection Fault"
  style: {
    fill: "#16161d"
    stroke: "#33cc33"
    stroke-width: 4
    double-border: true
  }

  cpu_retry: {
    class: hardware_component
    label: "CPU Retry"
    instr: "MOV [0xBEEF1000], EAX" { 
      style: { font: mono; fill: "#0d200d" } 
    }
  }

  tlb_miss_box: {
    label: "TLB: MISS (VPN 0xBEEF1 not found)"
    style: { 
      fill: "#1a1a1a"
      stroke: "#666666"
      stroke-dash: 3 
    }
  }

  mmu_walker: {
    class: hardware_component
    label: "MMU Hardware Page Walker"
    
    walk_steps: {
      grid-rows: 4
      s1: "1. Read CR3"
      s2: "2. Traverse PD/PT"
      s3: "3. Fetch PTE (R/W=0)" { 
        style: { fill: "#0d2a0d"; bold: true } 
      }
      s4: "4. Raise #PF Exception" { 
        style: { fill: "#440000"; stroke: "#ff0000" } 
      }
      
      s1 -> s2 -> s3 -> s4
    }
  }

  cpu_retry.instr -> tlb_miss_box: "VA Lookup"
  tlb_miss_box -> mmu_walker.walk_steps.s1: "Trigger Walk"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTION 4: DATA SHEET
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
stats: {
  near: bottom-right
  style: { 
    stroke: "#4466cc"
    fill: "#0d1020" 
  }
  label: ||md
    ### Performance & Overhead Summary
    | Feature | INVLPG | CR3 Reload |
    | :--- | :--- | :--- |
    | Scope | Single Page | Full TLB |
    | Latency | ~20-50 cycles | ~500+ cycles |
    | Coherency | High Precision | Nuclear |
    | Use Case | COW / Unmap | Context Switch |
  ||
}

# â”€â”€ GLOBAL FLOW CONNECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
before_state -> flush_logic: "OS Kernel Step"
flush_logic -> after_state: "TLB Coherency Restored"

(before_state -> flush_logic)[0].label: "1. Update PTE in RAM\n2. Issue Flush Command"
(before_state -> flush_logic)[0].style: { 
  stroke: "#4466cc"
  stroke-width: 2 
}

(flush_logic -> after_state)[0].label: "Hardware Coherency"
(flush_logic -> after_state)[0].style: { 
  stroke: "#33cc33"
  stroke-width: 2 
}