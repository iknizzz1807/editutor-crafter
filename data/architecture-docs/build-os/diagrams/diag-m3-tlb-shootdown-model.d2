vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |'md
  # TLB: Translation Cache and Invalidation
  Microscopic view — 64-entry fully-associative cache · invlpg vs CR3 reload
'| {near: top-center}

legend: {
  near: bottom-left
  style: {
    fill: "#1a1a2e"
    stroke: "#444"
    border-radius: 8
    font-size: 13
  }
  red_leg: "Red = stale/wrong/danger" {
    shape: text
    style.font-color: "#ff6b6b"
    style.font-size: 12
  }
  green_leg: "Green = correct/safe/valid" {
    shape: text
    style.font-color: "#51cf66"
    style.font-size: 12
  }
  blue_leg: "Blue = data flow/read" {
    shape: text
    style.font-color: "#74c0fc"
    style.font-size: 12
  }
  purple_leg: "Purple = metadata/hardware state" {
    shape: text
    style.font-color: "#cc5de8"
    style.font-size: 12
  }
  yellow_leg: "Yellow = waiting/event trigger" {
    shape: text
    style.font-color: "#ffd43b"
    style.font-size: 12
  }
  gray_leg: "Gray = evicted/flushed/inactive" {
    shape: text
    style.font-color: "#adb5bd"
    style.font-size: 12
  }
}

tlb_section: "TLB: 64-entry Fully-Associative Cache (per core, private)" {
  style: {
    fill: "#0d1b2a"
    stroke: "#cc5de8"
    stroke-width: 2
    border-radius: 10
    font-color: "#cc5de8"
    font-size: 15
    bold: true
  }

  tlb_entries: "TLB Entry Table (representative sample)" {
    style: {
      fill: "#0a1628"
      stroke: "#cc5de8"
      border-radius: 6
      font-size: 12
      font-color: "#e0cffc"
    }
    grid-rows: 9
    grid-columns: 5
    h0: "Entry" {
      style.fill: "#1a1a3e"
      style.font-color: "#cc5de8"
      style.bold: true
      style.font-size: 11
    }
    h1: "Virtual Page" {
      style.fill: "#1a1a3e"
      style.font-color: "#cc5de8"
      style.bold: true
      style.font-size: 11
    }
    h2: "Physical Frame" {
      style.fill: "#1a1a3e"
      style.font-color: "#cc5de8"
      style.bold: true
      style.font-size: 11
    }
    h3: "Flags" {
      style.fill: "#1a1a3e"
      style.font-color: "#cc5de8"
      style.bold: true
      style.font-size: 11
    }
    h4: "Valid" {
      style.fill: "#1a1a3e"
      style.font-color: "#cc5de8"
      style.bold: true
      style.font-size: 11
    }
    r0c0: "0" {
      style.fill: "#3d0000"
      style.font-color: "#ff6b6b"
      style.font-size: 11
    }
    r0c1: "0x00400" {
      style.fill: "#3d0000"
      style.font-color: "#ff6b6b"
      style.font-size: 11
    }
    r0c2: "Frame_A (STALE)" {
      style.fill: "#3d0000"
      style.font-color: "#ff6b6b"
      style.font-size: 11
      style.bold: true
    }
    r0c3: "P|RW|U" {
      style.fill: "#3d0000"
      style.font-color: "#ff6b6b"
      style.font-size: 11
    }
    r0c4: "STALE" {
      style.fill: "#3d0000"
      style.font-color: "#ff6b6b"
      style.font-size: 11
      style.bold: true
    }
    r1c0: "1" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r1c1: "0x00401" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r1c2: "0x201000" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r1c3: "P|RW|U" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r1c4: "OK" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 11
    }
    r2c0: "2" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r2c1: "0xC0010" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r2c2: "0x010000" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r2c3: "P|RW|S|G" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 11
    }
    r2c4: "GLOBAL" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 11
      style.bold: true
    }
    r3c0: "3" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r3c1: "0x00BFF" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r3c2: "0x305000" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r3c3: "P|RW|U" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r3c4: "OK" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 11
    }
    r4c0: "4" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r4c1: "0xC0011" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r4c2: "0x011000" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r4c3: "P|RW|S|G" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 11
    }
    r4c4: "GLOBAL" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 11
    }
    r5c0: "..." {
      style.fill: "#0a0a0a"
      style.font-color: "#555"
      style.font-size: 11
    }
    r5c1: "..." {
      style.fill: "#0a0a0a"
      style.font-color: "#555"
      style.font-size: 11
    }
    r5c2: "..." {
      style.fill: "#0a0a0a"
      style.font-color: "#555"
      style.font-size: 11
    }
    r5c3: "..." {
      style.fill: "#0a0a0a"
      style.font-color: "#555"
      style.font-size: 11
    }
    r5c4: "OK" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 11
    }
    r6c0: "63" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r6c1: "0xC00B8" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r6c2: "0x0B8000" {
      style.fill: "#0a1628"
      style.font-color: "#74c0fc"
      style.font-size: 11
    }
    r6c3: "P|RW|S|G" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 11
    }
    r6c4: "GLOBAL" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 11
    }
  }

  tlb_props: "TLB Architecture Properties" {
    style: {
      fill: "#0a1628"
      stroke: "#cc5de8"
      border-radius: 5
      font-size: 12
      font-color: "#e0cffc"
    }
    p1: "Fully-associative: any entry holds any page translation" {
      shape: text
      style.font-size: 11
      style.font-color: "#e0cffc"
    }
    p2: "64 entries: L1 dTLB (Intel Core). L2 stlb: 512-4096 entries" {
      shape: text
      style.font-size: 11
      style.font-color: "#e0cffc"
    }
    p3: "TLB hit cost: 1 cycle. TLB miss: 20-50 cycle page table walk" {
      shape: text
      style.font-size: 11
      style.font-color: "#ffd43b"
    }
    p4: "NOT coherent with DRAM page tables — SW must invalidate!" {
      shape: text
      style.font-size: 11
      style.font-color: "#ff6b6b"
      style.bold: true
    }
    p5: "Coverage: 64 x 4KB = 256KB working set at zero translation cost" {
      shape: text
      style.font-size: 11
      style.font-color: "#74c0fc"
    }
  }
}

pte_mod: "PTE Modification Event: vmm_map_page(pd, 0x400000, Frame_B, flags)" {
  style: {
    fill: "#1c1000"
    stroke: "#ffd43b"
    stroke-width: 2
    border-radius: 10
    font-color: "#ffd43b"
    font-size: 14
    bold: true
  }

  before_pte: "BEFORE: PTE for vpage 0x400" {
    style: {
      fill: "#001a00"
      stroke: "#51cf66"
      border-radius: 6
      font-color: "#51cf66"
      font-size: 12
    }
    b1: "Raw value: 0x00200007" {
      shape: text
      style.font-size: 12
      style.font-color: "#51cf66"
    }
    b2: "Frame_A physical base: 0x200000" {
      shape: text
      style.font-size: 12
      style.font-color: "#74c0fc"
    }
    b3: "Flags: P=1 R/W=1 U/S=1" {
      shape: text
      style.font-size: 11
      style.font-color: "#a9e34b"
    }
  }

  after_pte: "AFTER: PTE at same location (single mov instruction)" {
    style: {
      fill: "#001a00"
      stroke: "#51cf66"
      stroke-width: 3
      border-radius: 6
      font-color: "#51cf66"
      font-size: 12
    }
    a1: "Raw value: 0x00300007" {
      shape: text
      style.font-size: 12
      style.font-color: "#51cf66"
    }
    a2: "Frame_B physical base: 0x300000" {
      shape: text
      style.font-size: 12
      style.font-color: "#74c0fc"
    }
    a3: "Flags: P=1 R/W=1 U/S=1" {
      shape: text
      style.font-size: 11
      style.font-color: "#a9e34b"
    }
    a4: "TLB still caches Frame_A -> DIVERGED!" {
      shape: text
      style.font-size: 11
      style.font-color: "#ff6b6b"
      style.bold: true
    }
  }

  code_snippet: |'go
    // vmm_map_page writes new PTE (DRAM updated)
    // but TLB still has OLD entry — DANGER!
    pt[table_idx] = (Frame_B_phys) | flags;
    // TLB entry 0: vpage 0x400 -> Frame_A (STALE)
    // DRAM PTE:    vpage 0x400 -> Frame_B (NEW)
    // INCONSISTENT until invlpg!
    tlb_flush_page(virt); // invlpg [virt]
'|

  before_pte -> after_pte: "kernel: mov [pte], 0x00300007\n(atomic 32-bit write to DRAM)"
}

scenario_bad: "PATH A: No TLB Invalidation (BUG: Stale Translation)" {
  style: {
    fill: "#1a0000"
    stroke: "#ff6b6b"
    stroke-width: 3
    border-radius: 10
    font-color: "#ff6b6b"
    font-size: 14
    bold: true
  }

  b_s1: "1. CPU executes: mov eax, [0x00400000]" {
    style.fill: "#2d0000"
    style.stroke: "#ff6b6b"
    style.border-radius: 5
    style.font-color: "#ff6b6b"
    style.font-size: 12
  }
  b_s2: "2. MMU: lookup TLB for vpage 0x00400" {
    style.fill: "#2d0000"
    style.stroke: "#ff6b6b"
    style.border-radius: 5
    style.font-color: "#ff6b6b"
    style.font-size: 12
  }
  b_s3: "3. TLB HIT — Entry 0 present (STALE — not evicted)" {
    style.fill: "#4d0000"
    style.stroke: "#ff6b6b"
    style.stroke-width: 2
    style.border-radius: 5
    style.font-color: "#ff6b6b"
    style.font-size: 13
    style.bold: true
  }
  b_s4: "4. MMU returns: Frame_A phys 0x200000 (WRONG FRAME)" {
    style.fill: "#4d0000"
    style.stroke: "#ff6b6b"
    style.stroke-width: 2
    style.border-radius: 5
    style.font-color: "#ff6b6b"
    style.font-size: 13
    style.bold: true
  }
  b_s5: "5. Bus read from physical 0x200000+offset" {
    style.fill: "#3d0000"
    style.stroke: "#ff6b6b"
    style.border-radius: 5
    style.font-color: "#ff6b6b"
    style.font-size: 12
  }
  b_corrupt: "SILENT MEMORY CORRUPTION" {
    style.fill: "#6d0000"
    style.stroke: "#ff6b6b"
    style.stroke-width: 4
    style.border-radius: 8
    style.font-color: "#ff6b6b"
    style.font-size: 13
    style.bold: true
    bc1: "Frame_A may belong to another process" {
      shape: text
      style.font-size: 11
      style.font-color: "#ff6b6b"
    }
    bc2: "EAX receives wrong data" {
      shape: text
      style.font-size: 11
      style.font-color: "#ff6b6b"
    }
    bc3: "Bug surfaces far from this site" {
      shape: text
      style.font-size: 11
      style.font-color: "#ffd43b"
    }
  }

  b_s1 -> b_s2: "MMU intercepts memory access"
  b_s2 -> b_s3: "TLB lookup: 1 cycle (HIT — stale entry survives)"
  b_s3 -> b_s4: "returns cached Frame_A address (wrong!)"
  b_s4 -> b_s5: "memory bus: read from wrong physical frame"
  b_s5 -> b_corrupt: "wrong data loaded into CPU register"
}

scenario_good: "PATH B: Correct — invlpg After PTE Write (~20 cycles)" {
  style: {
    fill: "#001a00"
    stroke: "#51cf66"
    stroke-width: 3
    border-radius: 10
    font-color: "#51cf66"
    font-size: 14
    bold: true
  }

  g_invlpg: "invlpg [0x400000] — executed immediately after PTE write" {
    style.fill: "#002200"
    style.stroke: "#51cf66"
    style.stroke-width: 3
    style.border-radius: 6
    style.font-color: "#51cf66"
    style.font-size: 13
    style.bold: true
  }

  g_invlpg_detail: "invlpg semantics: evicts single TLB entry for page containing addr" {
    style.fill: "#001500"
    style.stroke: "#51cf66"
    style.border-radius: 5
    style.font-size: 12
    style.font-color: "#a9e34b"
    d1: "Instruction: invlpg m (operand = memory address, not value)" {
      shape: text
      style.font-size: 11
      style.font-color: "#a9e34b"
    }
    d2: "Cost: ~20 cycles. Privilege: ring 0 only." {
      shape: text
      style.font-size: 11
      style.font-color: "#a9e34b"
    }
    d3: "Surgical: only entry 0 evicted, 63 others untouched" {
      shape: text
      style.font-size: 11
      style.font-color: "#51cf66"
    }
    d4: "C: __asm__ volatile(invlpg (%0)::r(vaddr):memory);" {
      shape: text
      style.font-size: 11
      style.font-color: "#74c0fc"
    }
  }

  g_tlb_after: "TLB after invlpg: Entry 0 evicted, 63 others intact" {
    style.fill: "#001a00"
    style.stroke: "#51cf66"
    style.border-radius: 6
    style.font-color: "#51cf66"
    style.font-size: 12
    grid-rows: 3
    grid-columns: 3
    e0: "Entry 0: EVICTED" {
      style.fill: "#111"
      style.font-color: "#555"
      style.font-size: 11
    }
    e1: "Entry 1: 0x00401->0x201 OK" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 10
    }
    e2: "Entry 2: 0xC0010->0x010 GLOBAL" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 10
    }
    e3: "Entry 3: 0x00BFF->0x305 OK" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 10
    }
    e4: "Entry 4: 0xC0011->0x011 GLOBAL" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 10
    }
    e5: "Entries 5-63: untouched" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 10
    }
  }

  g_s1: "1. CPU executes: mov eax, [0x00400000]" {
    style.fill: "#002200"
    style.stroke: "#51cf66"
    style.border-radius: 5
    style.font-color: "#51cf66"
    style.font-size: 12
  }
  g_s2: "2. MMU: lookup TLB for vpage 0x00400" {
    style.fill: "#002200"
    style.stroke: "#51cf66"
    style.border-radius: 5
    style.font-color: "#51cf66"
    style.font-size: 12
  }
  g_s3: "3. TLB MISS — entry was evicted by invlpg" {
    style.fill: "#003300"
    style.stroke: "#51cf66"
    style.stroke-width: 2
    style.border-radius: 5
    style.font-color: "#51cf66"
    style.font-size: 13
    style.bold: true
  }
  g_s4: "4. Hardware page-table walk: CR3->PD->PT (20-50 cycles)" {
    style.fill: "#002200"
    style.stroke: "#74c0fc"
    style.border-radius: 5
    style.font-color: "#74c0fc"
    style.font-size: 12
    w1: "Reads CURRENT PTE: 0x00300007 = Frame_B phys 0x300000" {
      shape: text
      style.font-size: 11
      style.font-color: "#a9e34b"
    }
    w2: "TLB refilled: entry 0 <- vpage 0x00400 -> 0x300000" {
      shape: text
      style.font-size: 11
      style.font-color: "#51cf66"
    }
  }
  g_s5: "5. Bus read from physical 0x300000+offset — CORRECT" {
    style.fill: "#005500"
    style.stroke: "#51cf66"
    style.stroke-width: 3
    style.border-radius: 8
    style.font-color: "#51cf66"
    style.font-size: 13
    style.bold: true
  }

  g_invlpg -> g_invlpg_detail: "instruction semantics and C wrapper"
  g_invlpg -> g_tlb_after: "entry 0 evicted (surgical, ~20 cycles)"
  g_tlb_after -> g_s1: "next access to 0x400000 proceeds"
  g_s1 -> g_s2: "MMU intercepts"
  g_s2 -> g_s3: "TLB lookup: MISS (1 cycle)"
  g_s3 -> g_s4: "hardware MMU walks page tables"
  g_s4 -> g_s5: "correct Frame_B returned, TLB refilled"
}

scenario_cr3: "PATH C: CR3 Reload — Flush All Non-Global Entries (context switch)" {
  style: {
    fill: "#0a001a"
    stroke: "#cc5de8"
    stroke-width: 3
    border-radius: 10
    font-color: "#cc5de8"
    font-size: 14
    bold: true
  }

  cr3_when: "When to use CR3 reload vs invlpg" {
    style.fill: "#1a0030"
    style.stroke: "#cc5de8"
    style.border-radius: 6
    style.font-color: "#cc5de8"
    style.font-size: 12
    w1: "Context switch to different process: mandatory (new PD physical addr)" {
      shape: text
      style.font-size: 11
      style.font-color: "#cc5de8"
    }
    w2: "Bulk PTE changes (>8 pages): cheaper than N x invlpg" {
      shape: text
      style.font-size: 11
      style.font-color: "#ffd43b"
    }
    w3: "Flush ALL including kernel: write same CR3 value" {
      shape: text
      style.font-size: 11
      style.font-color: "#74c0fc"
    }
    w4: "Global entries (PAGE_GLOBAL + CR4.PGE=1) SURVIVE all CR3 reloads" {
      shape: text
      style.font-size: 11
      style.font-color: "#51cf66"
      style.bold: true
    }
  }

  cr3_before: "TLB BEFORE CR3 reload (64 mixed entries)" {
    style.fill: "#1a0030"
    style.stroke: "#cc5de8"
    style.border-radius: 6
    style.font-color: "#cc5de8"
    style.font-size: 12
    grid-rows: 2
    grid-columns: 4
    bb0: "vp:0x400 fr:A VALID" {
      style.fill: "#2d0050"
      style.font-size: 10
      style.font-color: "#cc5de8"
    }
    bb1: "vp:0x401 fr:B VALID" {
      style.fill: "#2d0050"
      style.font-size: 10
      style.font-color: "#cc5de8"
    }
    bb2: "vp:0xC00 fr:K GLOBAL" {
      style.fill: "#001a00"
      style.font-size: 10
      style.font-color: "#51cf66"
    }
    bb3: "vp:0xD00 fr:H GLOBAL" {
      style.fill: "#001a00"
      style.font-size: 10
      style.font-color: "#51cf66"
    }
    bb4: "vp:0x500 fr:C VALID" {
      style.fill: "#2d0050"
      style.font-size: 10
      style.font-color: "#cc5de8"
    }
    bb5: "vp:0xBFF fr:S VALID" {
      style.fill: "#2d0050"
      style.font-size: 10
      style.font-color: "#cc5de8"
    }
    bb6: "vp:0xC01 fr:K GLOBAL" {
      style.fill: "#001a00"
      style.font-size: 10
      style.font-color: "#51cf66"
    }
    bb7: "56 more entries..." {
      style.fill: "#150025"
      style.font-size: 10
      style.font-color: "#888"
    }
  }

  cr3_op: "mov cr3, new_pd_phys (or same value for flush-all)" {
    style.fill: "#2a0050"
    style.stroke: "#cc5de8"
    style.stroke-width: 3
    style.border-radius: 6
    style.font-color: "#cc5de8"
    style.font-size: 13
    style.bold: true
    op1: "Direct cost: ~30 cycles for mov cr3 instruction" {
      shape: text
      style.font-size: 11
      style.font-color: "#ffd43b"
    }
    op2: "Indirect cost: cold TLB miss penalty on next ~60 unique page accesses" {
      shape: text
      style.font-size: 11
      style.font-color: "#ff6b6b"
    }
    op3: "60 misses x 50 cycles = ~3000 cycles warmup overhead after switch" {
      shape: text
      style.font-size: 11
      style.font-color: "#ff6b6b"
    }
  }

  cr3_after: "TLB AFTER CR3 reload (non-global evicted, globals survive)" {
    style.fill: "#0a0a0a"
    style.stroke: "#adb5bd"
    style.border-radius: 6
    style.font-color: "#adb5bd"
    style.font-size: 12
    grid-rows: 2
    grid-columns: 4
    ba0: "EMPTY (evicted)" {
      style.fill: "#111"
      style.font-color: "#555"
      style.font-size: 10
    }
    ba1: "EMPTY (evicted)" {
      style.fill: "#111"
      style.font-color: "#555"
      style.font-size: 10
    }
    ba2: "vp:0xC00 fr:K GLOBAL" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 10
    }
    ba3: "vp:0xD00 fr:H GLOBAL" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 10
    }
    ba4: "EMPTY (evicted)" {
      style.fill: "#111"
      style.font-color: "#555"
      style.font-size: 10
    }
    ba5: "EMPTY (evicted)" {
      style.fill: "#111"
      style.font-color: "#555"
      style.font-size: 10
    }
    ba6: "vp:0xC01 fr:K GLOBAL" {
      style.fill: "#001a00"
      style.font-color: "#51cf66"
      style.font-size: 10
    }
    ba7: "EMPTY (evicted)" {
      style.fill: "#111"
      style.font-color: "#555"
      style.font-size: 10
    }
  }

  global_note: "PAGE_GLOBAL Optimization: kernel pages survive context switches" {
    style.fill: "#001510"
    style.stroke: "#51cf66"
    style.border-radius: 5
    style.font-size: 12
    style.font-color: "#a9e34b"
    gn1: "Set PAGE_GLOBAL (bit 8) on all kernel PTEs + enable CR4.PGE" {
      shape: text
      style.font-size: 11
      style.font-color: "#a9e34b"
    }
    gn2: "Result: kernel TLB entries never flushed on process switch" {
      shape: text
      style.font-size: 11
      style.font-color: "#51cf66"
    }
    gn3: "Without GLOBAL: every context switch cold-walks all kernel PTEs" {
      shape: text
      style.font-size: 11
      style.font-color: "#ffd43b"
    }
    gn4: "Linux uses this; KPTI (Meltdown fix 2018) deliberately breaks it" {
      shape: text
      style.font-size: 11
      style.font-color: "#ff6b6b"
    }
  }

  cr3_before -> cr3_op: "context switch triggers CR3 load"
  cr3_op -> cr3_after: "non-global entries evicted atomically"
  cr3_after -> global_note: "global kernel entries remain valid"
  cr3_when -> cr3_op: "decision: when CR3 reload is appropriate"
}

comparison: "Invalidation Strategy Comparison" {
  style: {
    fill: "#0d1117"
    stroke: "#74c0fc"
    stroke-width: 2
    border-radius: 10
    font-color: "#74c0fc"
    font-size: 14
    bold: true
  }
  grid-rows: 6
  grid-columns: 5
  ch0: "Strategy" {
    style.fill: "#1a1a3e"
    style.font-color: "#74c0fc"
    style.bold: true
    style.font-size: 11
  }
  ch1: "Scope" {
    style.fill: "#1a1a3e"
    style.font-color: "#74c0fc"
    style.bold: true
    style.font-size: 11
  }
  ch2: "Cost (cycles)" {
    style.fill: "#1a1a3e"
    style.font-color: "#74c0fc"
    style.bold: true
    style.font-size: 11
  }
  ch3: "Ring" {
    style.fill: "#1a1a3e"
    style.font-color: "#74c0fc"
    style.bold: true
    style.font-size: 11
  }
  ch4: "Use Case" {
    style.fill: "#1a1a3e"
    style.font-color: "#74c0fc"
    style.bold: true
    style.font-size: 11
  }
  cr0: "invlpg vaddr" {
    style.fill: "#001a00"
    style.font-color: "#51cf66"
    style.font-size: 11
  }
  cr1: "Single page" {
    style.fill: "#001a00"
    style.font-color: "#51cf66"
    style.font-size: 11
  }
  cr2: "~20 (surgical)" {
    style.fill: "#001a00"
    style.font-color: "#51cf66"
    style.font-size: 11
  }
  cr3r: "0 only" {
    style.fill: "#001a00"
    style.font-color: "#51cf66"
    style.font-size: 11
  }
  cr4: "Single PTE modification" {
    style.fill: "#001a00"
    style.font-color: "#51cf66"
    style.font-size: 11
  }
  cr5: "CR3 reload same val" {
    style.fill: "#001a28"
    style.font-color: "#74c0fc"
    style.font-size: 11
  }
  cr6: "All non-global" {
    style.fill: "#001a28"
    style.font-color: "#74c0fc"
    style.font-size: 11
  }
  cr7: "~30 + warmup" {
    style.fill: "#001a28"
    style.font-color: "#ffd43b"
    style.font-size: 11
  }
  cr8: "0 only" {
    style.fill: "#001a28"
    style.font-color: "#74c0fc"
    style.font-size: 11
  }
  cr9: "Bulk changes (>8 pages)" {
    style.fill: "#001a28"
    style.font-color: "#74c0fc"
    style.font-size: 11
  }
  cr10: "CR3 load new value" {
    style.fill: "#1a0030"
    style.font-color: "#cc5de8"
    style.font-size: 11
  }
  cr11: "All non-global" {
    style.fill: "#1a0030"
    style.font-color: "#cc5de8"
    style.font-size: 11
  }
  cr12: "~30 + ~3000 warmup" {
    style.fill: "#1a0030"
    style.font-color: "#ffd43b"
    style.font-size: 11
  }
  cr13: "0 only" {
    style.fill: "#1a0030"
    style.font-color: "#cc5de8"
    style.font-size: 11
  }
  cr14: "Context switch (mandatory)" {
    style.fill: "#1a0030"
    style.font-color: "#cc5de8"
    style.font-size: 11
  }
  cr15: "No action (BUG)" {
    style.fill: "#3d0000"
    style.font-color: "#ff6b6b"
    style.font-size: 11
    style.bold: true
  }
  cr16: "None" {
    style.fill: "#3d0000"
    style.font-color: "#ff6b6b"
    style.font-size: 11
  }
  cr17: "0 now / INF later" {
    style.fill: "#3d0000"
    style.font-color: "#ff6b6b"
    style.font-size: 11
    style.bold: true
  }
  cr18: "any" {
    style.fill: "#3d0000"
    style.font-color: "#ff6b6b"
    style.font-size: 11
  }
  cr19: "Undefined behavior / CORRUPTION" {
    style.fill: "#3d0000"
    style.font-color: "#ff6b6b"
    style.font-size: 11
    style.bold: true
  }
}

smp_shootdown: "Hardware Soul: SMP TLB Shootdown (multi-core systems)" {
  style: {
    fill: "#0d1b2a"
    stroke: "#ffd43b"
    stroke-width: 2
    border-radius: 10
    font-color: "#ffd43b"
    font-size: 14
    bold: true
  }

  core0: "Core 0 (modifies PTE, owns the mapping)" {
    style.fill: "#1c1000"
    style.stroke: "#ffd43b"
    style.border-radius: 8
    style.font-color: "#ffd43b"
    style.font-size: 13
    c0_tlb: "Core 0 TLB: Entry 0 evicted by local invlpg" {
      style.fill: "#002200"
      style.stroke: "#51cf66"
      style.font-size: 11
      style.font-color: "#51cf66"
      style.border-radius: 5
    }
    c0_seq: "Core 0 Sequence" {
      style.fill: "#1c1000"
      style.stroke: "#ffd43b"
      style.border-radius: 4
      style.font-size: 11
      style.font-color: "#ffd43b"
      s1: "1. Write PTE: Frame_A -> Frame_B" {
        shape: text
        style.font-size: 10
        style.font-color: "#ffd43b"
      }
      s2: "2. invlpg 0x400000 (local TLB flushed)" {
        shape: text
        style.font-size: 10
        style.font-color: "#51cf66"
      }
      s3: "3. Send IPI to cores 1,2,...N via LAPIC" {
        shape: text
        style.font-size: 10
        style.font-color: "#cc5de8"
      }
      s4: "4. Spin-wait for ACK from all remote cores" {
        shape: text
        style.font-size: 10
        style.font-color: "#ffd43b"
      }
      s5: "5. Resume only after all ACKs received" {
        shape: text
        style.font-size: 10
        style.font-color: "#51cf66"
      }
    }
  }

  core1: "Core 1 (stale TLB — must receive IPI)" {
    style.fill: "#1a0000"
    style.stroke: "#ff6b6b"
    style.border-radius: 8
    style.font-color: "#ff6b6b"
    style.font-size: 13
    c1_before: "BEFORE IPI: vp:0x400 -> Frame_A STALE" {
      style.fill: "#3d0000"
      style.stroke: "#ff6b6b"
      style.font-size: 11
      style.font-color: "#ff6b6b"
      style.border-radius: 5
    }
    c1_handler: "IPI handler: invlpg 0x400000, write ACK to LAPIC" {
      style.fill: "#1a0000"
      style.stroke: "#cc5de8"
      style.font-size: 11
      style.font-color: "#cc5de8"
      style.border-radius: 4
    }
    c1_after: "AFTER IPI handler: vp:0x400 EVICTED" {
      style.fill: "#111"
      style.stroke: "#adb5bd"
      style.font-size: 11
      style.font-color: "#adb5bd"
      style.border-radius: 5
    }
    c1_before -> c1_handler: "IPI received from Core 0" {
      style.stroke: "#ffd43b"
      style.animated: true
    }
    c1_handler -> c1_after: "invlpg executed, TLB entry evicted"
  }

  shootdown_cost: "TLB Shootdown Cost Analysis (16-core system)" {
    style.fill: "#1a0010"
    style.stroke: "#ff6b6b"
    style.border-radius: 6
    style.font-color: "#ff6b6b"
    style.font-size: 12
    sc1: "15 IPIs x ~500 cycles round-trip = 7500 cycles per shootdown" {
      shape: text
      style.font-size: 11
      style.font-color: "#ff6b6b"
    }
    sc2: "Linux flush_tlb_others() uses APIC broadcast IPI" {
      shape: text
      style.font-size: 11
      style.font-color: "#74c0fc"
    }
    sc3: "Linux batches multiple PTE changes before single shootdown" {
      shape: text
      style.font-size: 11
      style.font-color: "#51cf66"
    }
    sc4: "KPTI (2018 Meltdown fix): CR3 swap per syscall = 2 shootdowns" {
      shape: text
      style.font-size: 11
      style.font-color: "#ffd43b"
    }
    sc5: "Measured KPTI overhead: 5-30% on syscall-heavy workloads" {
      shape: text
      style.font-size: 11
      style.font-color: "#ff6b6b"
      style.bold: true
    }
  }

  core0 -> core1: "IPI via LAPIC broadcast (~500 cycles/core)" {
    style.stroke: "#ffd43b"
    style.stroke-width: 2
    style.animated: true
    style.stroke-dash: 3
  }
  core1 -> shootdown_cost: "latency scales linearly with core count"
  core0 -> shootdown_cost: "total cost: 15 x 500 = 7500 cycles blocked"
}

tlb_section -> pte_mod: "kernel writes new PTE to DRAM\n(TLB still holds old entry — inconsistency!)" {
  style.stroke: "#ffd43b"
  style.stroke-width: 2
}

pte_mod -> scenario_bad: "PATH A: forgot invlpg (common new-kernel bug)" {
  style.stroke: "#ff6b6b"
  style.stroke-width: 2
  style.stroke-dash: 4
}

pte_mod -> scenario_good: "PATH B: correct — invlpg immediately after PTE write" {
  style.stroke: "#51cf66"
  style.stroke-width: 2
}

pte_mod -> scenario_cr3: "PATH C: context switch loads new page directory" {
  style.stroke: "#cc5de8"
  style.stroke-width: 2
}

scenario_good -> comparison: "invlpg: 1 page, ~20 cycles (surgical)" {
  style.stroke: "#74c0fc"
}

scenario_cr3 -> comparison: "CR3 reload: all non-global, ~30c + warmup" {
  style.stroke: "#74c0fc"
}

scenario_bad -> comparison: "no invalidation: 0 cycles now, corruption later" {
  style.stroke: "#ff6b6b"
  style.stroke-dash: 5
}

scenario_cr3 -> smp_shootdown: "single-core invlpg scales to SMP:\nremote cores need IPI to flush their private TLBs" {
  style.stroke: "#ffd43b"
  style.stroke-width: 2
  style.stroke-dash: 3
}