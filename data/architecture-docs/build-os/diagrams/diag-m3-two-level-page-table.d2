vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

title: |md
  ## x86 Two-Level Paging — Virtual Address Translation
  **data_walk** · 32-bit protected mode · CR3 → PD → PT → Physical Frame
| {near: top-center}

back_to_map: "↑ Satellite Map" {
  link: "#diag-satellite-os-map"
  style: {
    fill: "#1a1a2e"
    font-color: "#aaaacc"
    stroke: "#444466"
    font-size: 11
    border-radius: 4
  }
}

# ─────────────────────────────────────────────────
# VIRTUAL ADDRESS DECOMPOSITION
# ─────────────────────────────────────────────────
vaddr: "Virtual Address (32 bits)" {
  link: "#phase-3-x86-two-level-paging"
  style: {
    fill: "#1a1a2e"
    stroke: "#6666cc"
    stroke-width: 2
    font-color: "#ccccff"
    font-size: 13
    bold: true
  }
  
  example: ||md
    `0xC0401A3B`
    = `1100 0000 0100 0000 0001 1010 0011 1011`
  ||
  
  bits_31_22: "Bits 31:22 — PD Index\n10 bits → 0–1023\nexample: 0x301 = 769" {
    style: {
      fill: "#2d1b4e"
      stroke: "#9966cc"
      stroke-width: 2
      font-color: "#cc99ff"
      font-size: 11
      bold: true
    }
  }
  
  bits_21_12: "Bits 21:12 — PT Index\n10 bits → 0–1023\nexample: 0x040 = 64" {
    style: {
      fill: "#1b2d4e"
      stroke: "#6699cc"
      stroke-width: 2
      font-color: "#99ccff"
      font-size: 11
      bold: true
    }
  }
  
  bits_11_0: "Bits 11:0 — Page Offset\n12 bits → 0–4095\nexample: 0xA3B = 2619" {
    style: {
      fill: "#1b3d2d"
      stroke: "#66cc99"
      stroke-width: 2
      font-color: "#99ffcc"
      font-size: 11
      bold: true
    }
  }
}

# ─────────────────────────────────────────────────
# CR3 REGISTER
# ─────────────────────────────────────────────────
cr3: "CR3 Register" {
  link: "#phase-5-building-the-initial-page-tables"
  style: {
    fill: "#3d1a00"
    stroke: "#cc6600"
    stroke-width: 3
    font-color: "#ffaa44"
    font-size: 13
    bold: true
    shadow: true
  }
  
  cr3_fields: {
    shape: sql_table
    "PD Physical Base": "bits 31:12 (4KB-aligned)\n= 0x00003000" { constraint: PK }
    "Flags": "bits 11:0 (PWT, PCD, etc.)" { constraint: "" }
  }
  
  note: "Written by: mov cr3, eax\nFlushes entire TLB" {
    style: { fill: "#2a1000"; stroke: "#884400"; font-size: 10; font-color: "#cc8833" }
  }
}

# ─────────────────────────────────────────────────
# PAGE DIRECTORY
# ─────────────────────────────────────────────────
pd: "Page Directory\n(4KB)" {
  link: "#phase-3-x86-two-level-paging"
  style: {
    fill: "#1a1a3d"
    stroke: "#4444cc"
    stroke-width: 2
    font-color: "#aaaaff"
    font-size: 12
    bold: true
    multiple: true
  }
  
  pde_layout: {
    shape: sql_table
    "PDE[0]": "PT phys @ 0x00005000 | P=1 W=1 U=0" { constraint: "" }
    "PDE[1..767]": "P=0 (not present)" { constraint: "" }
    "PDE[768] (Index)": "PT phys @ 0x00006000 | P=1 W=1 U=0" { constraint: PK }
    "PDE[769..1023]": "kernel heap, MMIO, etc." { constraint: "" }
  }
  
  pde_bits: "PDE Bit Layout" {
    style: { fill: "#0d0d2a"; stroke: "#333399"; font-size: 10 }
    fields: {
      shape: sql_table
      "bits 31:12": "Page Table Physical Address >> 12" { constraint: PK }
      "bit 7 (PS)": "0 = 4KB pages" { constraint: "" }
      "bit 0 (P)": "Present bit" { constraint: "" }
    }
  }
}

# ─────────────────────────────────────────────────
# PAGE TABLE
# ─────────────────────────────────────────────────
pt: "Page Table\n(4KB)" {
  link: "#phase-3-x86-two-level-paging"
  style: {
    fill: "#1a2d3d"
    stroke: "#4488cc"
    stroke-width: 2
    font-color: "#aaccff"
    font-size: 12
    bold: true
    multiple: true
  }
  
  pte_layout: {
    shape: sql_table
    "PTE[0..63]": "P=0 (not mapped)" { constraint: "" }
    "PTE[64] (Index)": "frame @ 0x00201000 | P=1 W=1 U=0" { constraint: PK }
    "PTE[65..1023]": "P=0 or other mappings" { constraint: "" }
  }
  
  pte_bits: "PTE Bit Layout" {
    style: { fill: "#0d1a2a"; stroke: "#336699"; font-size: 10 }
    fields: {
      shape: sql_table
      "bits 31:12": "Physical Frame Address >> 12" { constraint: PK }
      "bit 5 (A)": "Accessed bit" { constraint: "" }
      "bit 0 (P)": "Present bit" { constraint: "" }
    }
  }
}

# ─────────────────────────────────────────────────
# PHYSICAL FRAME
# ─────────────────────────────────────────────────
phys_frame: "Physical Frame\n0x00201000" {
  link: "#phase-2-the-bitmap-frame-allocator"
  style: {
    fill: "#1a3d1a"
    stroke: "#44cc44"
    stroke-width: 3
    font-color: "#aaffaa"
    font-size: 12
    bold: true
    shadow: true
  }
  
  frame_addr: "Final Physical Address" {
    style: { fill: "#0d2a0d"; stroke: "#226622"; font-size: 11 }
    calc: ||md
      `PTE.frame[31:12] << 12 | VA[11:0]`
      `= 0x00201000 | 0xA3B`
      `= 0x00201A3B`
    ||
  }
}

# ─────────────────────────────────────────────────
# SATELLITE COMPONENTS
# ─────────────────────────────────────────────────
tlb: "TLB (Translation Lookaside Buffer)" {
  link: "#phase-6-the-tlb"
  style: { fill: "#3d2a00"; stroke: "#cc9900"; font-color: "#ffcc44"; bold: true }
}

pf_handler: "#PF Handler (vector 14)" {
  link: "#phase-8-the-page-fault-handler"
  style: { fill: "#3d0000"; stroke: "#cc2222"; font-color: "#ff8888"; bold: true }
}

# ─────────────────────────────────────────────────
# SCALE LEGEND
# ─────────────────────────────────────────────────
scale_legend: {
  near: bottom-center
  style: { 
    fill: "#111122"
    stroke: "#333355"
    font-size: 10
    font-color: "#9999bb"
  }
  label: ||md
    | Unit | Size | Count per level |
    |------|------|----------------|
    | Page offset | 12 bits → 4,096 bytes | 1 per page |
    | Page Table | 10 bits → 1,024 PTEs | 1 per PDE |
    | Page Directory | 10 bits → 1,024 PDEs | 1 per process |
    | PDE coverage | 1,024 PTEs × 4KB = 4MB | per PDE |
    | Total virtual | 1,024 PDEs × 4MB = 4GB | full space |
  ||
}

# ─────────────────────────────────────────────────
# CONNECTIONS — THE DATA WALK
# ─────────────────────────────────────────────────
vaddr.bits_31_22 -> pd.pde_layout."PDE[768] (Index)": "PD Index = 769\nSelects PDE" {
  style: { stroke: "#9966cc"; stroke-width: 2; font-color: "#cc99ff"; bold: true }
}

vaddr.bits_21_12 -> pt.pte_layout."PTE[64] (Index)": "PT Index = 64\nSelects PTE" {
  style: { stroke: "#6699cc"; stroke-width: 2; font-color: "#99ccff"; bold: true }
}

vaddr.bits_11_0 -> phys_frame.frame_addr: "Offset = 0xA3B\nFinal byte access" {
  style: { stroke: "#66cc99"; stroke-width: 2; font-color: "#99ffcc"; bold: true }
}

cr3.cr3_fields -> pd: "Base Pointer\n(Physical)" {
  style: { stroke: "#cc6600"; stroke-width: 3; animated: true }
}

pd.pde_layout -> pt: "PDE[768].frame\nStep 2: Load PT" {
  style: { stroke: "#4444cc"; stroke-width: 3; animated: true }
}

pt.pte_layout -> phys_frame: "PTE[64].frame\nStep 3: Access frame" {
  style: { stroke: "#44cc44"; stroke-width: 3; animated: true }
}

tlb -> pd: "MISS" {
  style: { stroke: "#cc9900"; stroke-dash: 5 }
}

tlb -> phys_frame: "HIT" {
  style: { stroke: "#cc9900"; stroke-dash: 2 }
}

pd -> pf_handler: "P=0" {
  style: { stroke: "#cc2222"; stroke-dash: 5 }
}

pt -> pf_handler: "P=0" {
  style: { stroke: "#cc2222"; stroke-dash: 5 }
}