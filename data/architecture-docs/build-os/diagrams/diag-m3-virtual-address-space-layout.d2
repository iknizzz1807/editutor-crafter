direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: {
  shape: text
  label: |md
    # x86 Virtual Address Space Layout (32-bit, 4 GB)
    After paging enabled Â· Higher-half kernel at `0xC0000000` Â· Flat model segments
  |
  near: top-center
}

back_to_map: "â†– Satellite Map" {
  link: "#diag-satellite-os-map"
  style: {
    fill: "#2d2d2d"
    font-color: "#aaaaaa"
    stroke: "#555555"
    font-size: 11
    border-radius: 4
  }
}

legend: {
  near: bottom-right
  style: {
    fill: "#1a1a2e"
    stroke: "#444466"
    border-radius: 6
  }
  label: |md
    ### Color Semantics
    - ðŸŸ£ **Purple**: Metadata / Page Structures
    - ðŸ”µ **Blue**: Kernel Code / Executable
    - ðŸŸ  **Orange**: MMIO / Hardware
    - ðŸŸ¢ **Green**: Dynamic Memory / Heap
    - â¬› **Gray**: Unmapped / Guard Pages
    - ðŸ”´ **Red**: Critical Boundary
    - ðŸŸ¡ **Yellow**: User Space (Ring 3)
  |
}

vas: "Complete Virtual Address Space" {
  style: {
    fill: "#0f0f1a"
    stroke: "#334"
    stroke-width: 2
    border-radius: 8
    font-color: "#ccccdd"
    font-size: 14
    bold: true
  }

  region_stack: {
    style.fill: transparent
    style.stroke-width: 0

    r_bios_rom: "BIOS / Firmware ROM (0xFFF00000 - 0xFFFFFFFF)" {
      tooltip: "Physical BIOS ROM shadowed or mapped here."
      style: {
        fill: "#3a1a1a"
        stroke: "#cc4444"
        stroke-dash: 4
        font-color: "#cc7777"
      }
    }

    r_recursive: "Recursive PD Map (0xFFC00000)" {
      tooltip: "PD mapped to itself at entry 1023."
      style: {
        fill: "#1e1a3a"
        stroke: "#7766bb"
        stroke-dash: 3
        font-color: "#9988cc"
      }
    }

    r_reserved_high: "Reserved Kernel Space" {
      style: {
        fill: "#1a1a1a"
        stroke: "#444444"
        stroke-dash: 5
        font-color: "#666666"
      }
    }

    r_mmio_window: "MMIO Window (PCI/Devices)" {
      style: {
        fill: "#2a1a00"
        stroke: "#cc7700"
        stroke-dash: 3
        font-color: "#cc9900"
      }
    }

    r_kheap: "Kernel Heap (Arena)" {
      link: "#diag-m3-kernel-heap-architecture"
      style: {
        fill: "#0a2a0a"
        stroke: "#33aa33"
        stroke-width: 2
        font-color: "#55cc55"
      }
      kh_detail: |md
        `0xD0000000` - `0xE0000000`
        **kmalloc** dynamic region
      |
    }

    r_kmap: "Kernel Dynamic Maps" {
      style: {
        fill: "#0a1a2a"
        stroke: "#3366aa"
        font-color: "#5588cc"
      }
    }

    r_kdata: "Kernel .data / .bss" {
      style: {
        fill: "#1a1a3a"
        stroke: "#6666cc"
        font-color: "#9999ee"
      }
      kdata_meta: "GDT/IDT/TSS"
    }

    r_krodata: "Kernel .rodata" {
      style: {
        fill: "#1a2a1a"
        stroke: "#449944"
        font-color: "#66bb66"
      }
    }

    r_ktext: "Kernel .text (VMA: 0xC0100000)" {
      link: "#diag-m1-linker-script-sections"
      style: {
        fill: "#0a1f3a"
        stroke: "#2266cc"
        stroke-width: 2
        font-color: "#4488ff"
        bold: true
      }
    }

    r_kernel_boundary: "KERNEL / USER SPLIT (0xC0000000)" {
      style: {
        fill: "#cc3333"
        stroke: "#ff5555"
        stroke-width: 3
        font-color: "#ffffff"
        bold: true
      }
    }

    r_user_stack: "User Stack (Ring 3)" {
      style: {
        fill: "#2a2a0a"
        stroke: "#aaaa22"
        stroke-width: 2
        font-color: "#cccc44"
      }
      ustk_info: "0xBFFFF000 -> 0xC0000000"
    }

    r_user_space_mid: "User Data/Heap (brk/mmap)" {
      style: {
        fill: "#141414"
        stroke: "#444444"
        stroke-dash: 4
        font-color: "#888888"
      }
    }

    r_user_text: "User Code (ELF VMA: 0x08048000)" {
      style: {
        fill: "#1a2a3a"
        stroke: "#336699"
        font-color: "#5588bb"
      }
    }

    r_null_page: "NULL Page Guard (0x0 - 0x1000)" {
      style: {
        fill: "#2a0000"
        stroke: "#cc2222"
        stroke-width: 2
        stroke-dash: 3
        font-color: "#ee4444"
      }
    }
  }
}

# Info & Support Boxes
pte_flags_box: "PTE Control Bits" {
  style: {
    fill: "#0f0f22"
    stroke: "#445588"
    border-radius: 6
    font-color: "#8899cc"
  }
  label: |md
    | Bit | Name | Ring 0 | Ring 3 |
    | :--- | :--- | :--- | :--- |
    | 0 | **Present** | OK | OK |
    | 1 | **Writable** | RW | RO/RW |
    | 2 | **User** | System | User |
  |
}

addr_decode_box: "MMU Address Decoding" {
  style: {
    fill: "#0f1a0f"
    stroke: "#337733"
    border-radius: 6
    font-color: "#77cc77"
  }
  label: |go
    // virt -> phys
    pd_idx = addr >> 22
    pt_idx = (addr >> 12) & 0x3FF
    offset = addr & 0xFFF
  |
}

vga_hw: "VGA Buffer (Phys: 0xB8000)" {
  style: {
    fill: "#2a1500"
    stroke: "#cc6600"
    font-color: "#ffaa44"
    stroke-dash: 2
  }
}

# Ordering Connections (Ensures top-down stack in ELK)
vas.region_stack.r_bios_rom -> vas.region_stack.r_recursive
vas.region_stack.r_recursive -> vas.region_stack.r_reserved_high
vas.region_stack.r_reserved_high -> vas.region_stack.r_mmio_window
vas.region_stack.r_mmio_window -> vas.region_stack.r_kheap
vas.region_stack.r_kheap -> vas.region_stack.r_kmap
vas.region_stack.r_kmap -> vas.region_stack.r_kdata
vas.region_stack.r_kdata -> vas.region_stack.r_krodata
vas.region_stack.r_krodata -> vas.region_stack.r_ktext
vas.region_stack.r_ktext -> vas.region_stack.r_kernel_boundary
vas.region_stack.r_kernel_boundary -> vas.region_stack.r_user_stack
vas.region_stack.r_user_stack -> vas.region_stack.r_user_space_mid
vas.region_stack.r_user_space_mid -> vas.region_stack.r_user_text
vas.region_stack.r_user_text -> vas.region_stack.r_null_page

# Functional Connections
vga_hw -> vas.region_stack.r_krodata: "Identity Mapped / Shadowed" {
  style.stroke: "#cc6600"
}

pte_flags_box -> vas.region_stack.r_kernel_boundary: "Gate (U/S bit)" {
  style.stroke: "#ff5555"
}

addr_decode_box -> vas.region_stack.r_recursive: "PD Self-Reference Logic" {
  style: { stroke: "#7766bb"; stroke-dash: 2 }
}

vas.region_stack.r_user_stack -> vas.region_stack.r_kdata: "Kernel Stack in TSS.ESP0" {
  style: { stroke: "#55cc55"; animated: true }
}