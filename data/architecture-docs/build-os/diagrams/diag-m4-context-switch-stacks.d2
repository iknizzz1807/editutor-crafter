vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Context Switch: The ESP Swap Metamorphosis
  **`mov esp, [new_pcb + ESP_OFFSET]`** â€” One instruction changes identity
| {near: top-center}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  COLOR LEGEND
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
legend: {
  near: bottom-center
  style.fill: "#1a1a2e"
  style.stroke: "#444466"
  style.border-radius: 8
  label: ""
  l1: "ðŸŸ¥ Process A (RUNNING â†’ SUSPENDED)" {
    shape: text
    style.font-color: "#ff6b6b"
    style.bold: true
  }
  l2: "ðŸŸ¦ Process B (SUSPENDED â†’ RUNNING)" {
    shape: text
    style.font-color: "#4fc3f7"
    style.bold: true
  }
  l3: "ðŸŸ¨ The Pivot: ESP swap instruction" {
    shape: text
    style.font-color: "#ffd700"
    style.bold: true
  }
  l4: "ðŸŸ© Control flow before swap â†’ Stack A" {
    shape: text
    style.font-color: "#69db7c"
    style.bold: true
  }
  l5: "ðŸŸ£ Control flow after swap â†’ Stack B" {
    shape: text
    style.font-color: "#cc99ff"
    style.bold: true
  }
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  BEFORE PANEL  (left side)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
before: "BEFORE â€” Process A is being saved" {
  style.fill: "#0d0d1a"
  style.stroke: "#ff6b6b"
  style.stroke-width: 3
  style.border-radius: 6
  phase_label: |md
    **Phase: Saving Process A**
    `push ebx; push esi; push edi; push ebp; pushfd`
    ESP moves DOWN into A's stack with each push
  | {
    style.fill: "#1a0a0a"
    style.font-color: "#ff9999"
  }
  stack_a: "Process A â€” Kernel Stack (8 KB alloc)" {
    style.fill: "#1a0a0a"
    style.stroke: "#ff6b6b"
    style.stroke-width: 2
    style.border-radius: 4
    top_marker: "â† kernel_stack_top  [0xC040_2000]" {
      style.fill: "#2d0000"
      style.font-color: "#ff4444"
      style.bold: true
      style.font: mono
    }
    empty1: "(unused â€” grows down from top)" {
      style.fill: "#110808"
      style.font-color: "#553333"
      style.italic: true
    }
    iret_ss: "[ +20 ]  SS_user   = 0x0023  â† CPU pushed on interrupt entry" {
      style.fill: "#2a1010"
      style.font-color: "#ff8888"
      style.font: mono
    }
    iret_esp: "[ +16 ]  ESP_user  = 0xBFFFFFF0  â† CPU pushed" {
      style.fill: "#2a1010"
      style.font-color: "#ff8888"
      style.font: mono
    }
    iret_efl: "[ +12 ]  EFLAGS    = 0x00000202  â† CPU pushed" {
      style.fill: "#2a1010"
      style.font-color: "#ff8888"
      style.font: mono
    }
    iret_cs:  "[ +08 ]  CS_user   = 0x001B  â† CPU pushed" {
      style.fill: "#2a1010"
      style.font-color: "#ff8888"
      style.font: mono
    }
    iret_eip: "[ +04 ]  EIP_user  = 0x00401073  â† CPU pushed (resume addr)" {
      style.fill: "#2a1010"
      style.font-color: "#ff8888"
      style.font: mono
    }
    divider: "â”€â”€ pusha saves GP registers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" {
      style.fill: "#330000"
      style.font-color: "#ff4444"
      style.font: mono
      style.bold: true
    }
    saved_eflags: "[ -00 ]  EFLAGS (pushfd)    = 0x00000002" {
      style.fill: "#1f0b0b"
      style.font-color: "#ffaaaa"
      style.font: mono
    }
    saved_ebp:    "[ -04 ]  EBP               = 0xC04019E0" {
      style.fill: "#1f0b0b"
      style.font-color: "#ffaaaa"
      style.font: mono
    }
    saved_edi:    "[ -08 ]  EDI               = 0x00000000" {
      style.fill: "#1f0b0b"
      style.font-color: "#ffaaaa"
      style.font: mono
    }
    saved_esi:    "[ -12 ]  ESI               = 0x00000003" {
      style.fill: "#1f0b0b"
      style.font-color: "#ffaaaa"
      style.font: mono
    }
    saved_ebx:    "[ -16 ]  EBX               = 0xDEAD0001" {
      style.fill: "#1f0b0b"
      style.font-color: "#ffaaaa"
      style.font: mono
    }
    ret_addr:     "[ -20 ]  return EIP (call) = isr_common_stub+N" {
      style.fill: "#2a1010"
      style.font-color: "#ff8888"
      style.font: mono
    }
    esp_arrow: "â–¶ ESP = 0xC040_1FDC  (current stack pointer â€” grows here)" {
      style.fill: "#330000"
      style.font-color: "#ff0000"
      style.bold: true
      style.font: mono
      style.stroke: "#ff0000"
      style.border-radius: 3
    }
    arg_old:  "[ below ESP ]  arg: old_ctx ptr â†’ &A->context" {
      style.fill: "#110808"
      style.font-color: "#886666"
      style.font: mono
      style.italic: true
    }
    arg_new:  "[ below ESP ]  arg: new_ctx ptr â†’ &B->context" {
      style.fill: "#110808"
      style.font-color: "#886666"
      style.font: mono
      style.italic: true
    }
    bot_marker: "â† kernel_stack_bottom  [0xC040_0000]" {
      style.fill: "#2d0000"
      style.font-color: "#ff4444"
      style.bold: true
      style.font: mono
    }
  }
  save_action: |md
    **Action just completed:**
    
    push ebx      ; EBX saved
    push esi      ; ESI saved
    push edi      ; EDI saved
    push ebp      ; EBP saved
    pushfd        ; EFLAGS saved
    ; ESP now = old_ctx ptr - 20
    mov [old_ctx+ESP_OFF], esp   ; â† SAVE A's ESP
    
    Process A's full context is now frozen on its stack.
    Next: one instruction ends Process A's reign.
  | {
    style.fill: "#1a0505"
    style.stroke: "#aa3333"
    style.border-radius: 4
    style.font-color: "#ffcccc"
  }
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  THE PIVOT INSTRUCTION (center)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pivot: {
  style.fill: "#1a1500"
  style.stroke: "#ffd700"
  style.stroke-width: 4
  style.border-radius: 8
  pivot_title: "THE METAMORPHOSIS" {
    style.fill: "#2a2000"
    style.font-color: "#ffd700"
    style.bold: true
    style.font-size: 18
    style.underline: true
  }
  the_instruction: |md
    asm
    mov esp, [eax + 16]
    
    `eax` = &B->context
    offset 16 = `.esp` field in cpu_context_t
  | {
    style.fill: "#332b00"
    style.stroke: "#ffd700"
    style.stroke-width: 2
    style.font-color: "#ffe066"
  }
  before_after_note: |md
    **BEFORE this instruction:**
    - ESP âˆˆ Process A's kernel stack
    - Every push/pop â†’ Stack A
    **AFTER this instruction:**
    - ESP âˆˆ Process B's kernel stack
    - Every push/pop â†’ Stack B
    The CPU identity has changed.
    The function that "returns" is NOT
    the same process that "called" it.
  | {
    style.fill: "#221c00"
    style.font-color: "#ffd700"
  }
  cpu_context_layout: |md
    **`cpu_context_t` memory layout:**
    
    offset  0: edi
    offset  4: esi
    offset  8: ebx
    offset 12: ebp
    offset 16: esp  â† loaded into ESP
    offset 20: eip  â† where B will resume
    offset 24: eflags
    
  | {
    style.fill: "#1a1600"
    style.font-color: "#ccaa00"
    style.font: mono
  }
  hardware_note: |md
    **What the CPU does NOT do automatically:**
    - Save/restore GP registers (EBX, ESI, EDI, EBP)
    - Save/restore EFLAGS
    - Update TSS.ESP0
    - Load new CR3
    All of this is YOUR code, before/after this instruction.
  | {
    style.fill: "#1a1000"
    style.font-color: "#aa8800"
    style.italic: true
  }
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  AFTER PANEL  (right side)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
after: "AFTER â€” Process B is being restored" {
  style.fill: "#000d1a"
  style.stroke: "#4fc3f7"
  style.stroke-width: 3
  style.border-radius: 6
  phase_label: |md
    **Phase: Restoring Process B**
    `popfd; pop ebp; pop edi; pop esi; pop ebx; ret`
    ESP moves UP through B's stack with each pop
  | {
    style.fill: "#000a1a"
    style.font-color: "#99ccff"
  }
  stack_b: "Process B â€” Kernel Stack (8 KB alloc)" {
    style.fill: "#000a1a"
    style.stroke: "#4fc3f7"
    style.stroke-width: 2
    style.border-radius: 4
    top_marker_b: "â† kernel_stack_top  [0xC040_4000]" {
      style.fill: "#00102d"
      style.font-color: "#4488ff"
      style.bold: true
      style.font: mono
    }
    empty_b: "(unused kernel stack space)" {
      style.fill: "#000814"
      style.font-color: "#223355"
      style.italic: true
    }
    iret_ss_b: "[ +20 ]  SS_user   = 0x0023  â† will be popped by iretd" {
      style.fill: "#001028"
      style.font-color: "#6699cc"
      style.font: mono
    }
    iret_esp_b: "[ +16 ]  ESP_user  = 0xBFFFFEC8  â† will be popped by iretd" {
      style.fill: "#001028"
      style.font-color: "#6699cc"
      style.font: mono
    }
    iret_efl_b: "[ +12 ]  EFLAGS    = 0x00000202  â† will be popped by iretd" {
      style.fill: "#001028"
      style.font-color: "#6699cc"
      style.font: mono
    }
    iret_cs_b:  "[ +08 ]  CS_user   = 0x001B  â† will be popped by iretd" {
      style.fill: "#001028"
      style.font-color: "#6699cc"
      style.font: mono
    }
    iret_eip_b: "[ +04 ]  EIP_user  = 0x00401A20  â† B's exact resume address" {
      style.fill: "#001028"
      style.font-color: "#6699cc"
      style.font: mono
    }
    divider_b: "â”€â”€ GP registers saved from B's LAST preemption â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" {
      style.fill: "#003044"
      style.font-color: "#4fc3f7"
      style.font: mono
      style.bold: true
    }
    saved_eflags_b: "[ -00 ]  EFLAGS (popfd) â† 0x00000202  IF=1 âœ“" {
      style.fill: "#001525"
      style.font-color: "#99ddff"
      style.font: mono
    }
    saved_ebp_b:    "[ -04 ]  EBP  (pop ebp) â† 0xC04039A0" {
      style.fill: "#001525"
      style.font-color: "#99ddff"
      style.font: mono
    }
    saved_edi_b:    "[ -08 ]  EDI  (pop edi) â† 0x00000007" {
      style.fill: "#001525"
      style.font-color: "#99ddff"
      style.font: mono
    }
    saved_esi_b:    "[ -12 ]  ESI  (pop esi) â† 0x00000005" {
      style.fill: "#001525"
      style.font-color: "#99ddff"
      style.font: mono
    }
    saved_ebx_b:    "[ -16 ]  EBX  (pop ebx) â† 0xCAFE0002" {
      style.fill: "#001525"
      style.font-color: "#99ddff"
      style.font: mono
    }
    ret_addr_b:     "[ -20 ]  EIP  (ret)  â† isr_common_stub+N (B's last callsite)" {
      style.fill: "#001028"
      style.font-color: "#6699cc"
      style.font: mono
    }
    esp_arrow_b: "â–¶ ESP = 0xC040_3FDC  (loaded from B->context.esp)" {
      style.fill: "#003044"
      style.font-color: "#00ccff"
      style.bold: true
      style.font: mono
      style.stroke: "#00ccff"
      style.border-radius: 3
    }
    below_b: "(below ESP â€” B's previous args, no longer relevant)" {
      style.fill: "#000814"
      style.font-color: "#223355"
      style.italic: true
      style.font: mono
    }
    bot_marker_b: "â† kernel_stack_bottom  [0xC040_2000]" {
      style.fill: "#00102d"
      style.font-color: "#4488ff"
      style.bold: true
      style.font: mono
    }
  }
  restore_action: |md
    **Action about to execute:**
    
    ; ESP is now on B's stack
    popfd         ; Restore B's EFLAGS (IF=1 â†’ interrupts ON)
    pop ebp       ; Restore B's EBP
    pop edi       ; Restore B's EDI
    pop esi       ; Restore B's ESI
    pop ebx       ; Restore B's EBX
    ret           ; Pop B's saved EIP â†’ jump to B's resume point
    
    Process B resumes exactly where it was
    preempted. It never knew it stopped.
  | {
    style.fill: "#000a1a"
    style.stroke: "#336699"
    style.border-radius: 4
    style.font-color: "#aaddff"
  }
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  PCB STRUCTURES (showing the context fields)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pcb_row: {
  style.fill: "#0a0a0a"
  style.stroke: "#444"
  style.border-radius: 4
  pcb_a: "PCB â€” Process A  (pid=3, name=\"proc_a\")" {
    style.fill: "#1a0808"
    style.stroke: "#ff6b6b"
    style.border-radius: 4
    ctx_a: {
      shape: sql_table
      style.fill: "#220808"
      edi:    "uint32_t  |  0x00000000"
      esi:    "uint32_t  |  0x00000003"
      ebx:    "uint32_t  |  0xDEAD0001"
      ebp:    "uint32_t  |  0xC04019E0"
      esp:    "uint32_t  |  0xC0401FDC  â† saved by  mov [old+16], esp"
      eip:    "uint32_t  |  isr_common_stub+N"
      eflags: "uint32_t  |  0x00000002  (IF=0, in interrupt handler)"
    }
    state_a: "state = PROCESS_READY  (was RUNNING, now suspended)" {
      style.fill: "#330000"
      style.font-color: "#ff8888"
      style.font: mono
    }
    kstack_a: "kernel_stack_top = 0xC040_2000" {
      style.fill: "#1a0808"
      style.font-color: "#cc6666"
      style.font: mono
    }
    cr3_a: "page_directory (phys) = 0x00105000" {
      style.fill: "#1a0808"
      style.font-color: "#cc6666"
      style.font: mono
    }
  }
  pcb_b: "PCB â€” Process B  (pid=4, name=\"proc_b\")" {
    style.fill: "#000a1a"
    style.stroke: "#4fc3f7"
    style.border-radius: 4
    ctx_b: {
      shape: sql_table
      style.fill: "#001520"
      edi:    "uint32_t  |  0x00000007"
      esi:    "uint32_t  |  0x00000005"
      ebx:    "uint32_t  |  0xCAFE0002"
      ebp:    "uint32_t  |  0xC04039A0"
      esp:    "uint32_t  |  0xC0403FDC  â† loaded by  mov esp, [new+16]"
      eip:    "uint32_t  |  isr_common_stub+N"
      eflags: "uint32_t  |  0x00000202  (IF=1, will re-enable on popfd)"
    }
    state_b: "state = PROCESS_RUNNING  (was READY, now active)" {
      style.fill: "#003044"
      style.font-color: "#4fc3f7"
      style.font: mono
    }
    kstack_b: "kernel_stack_top = 0xC040_4000" {
      style.fill: "#000a1a"
      style.font-color: "#4488bb"
      style.font: mono
    }
    cr3_b: "page_directory (phys) = 0x00209000" {
      style.fill: "#000a1a"
      style.font-color: "#4488bb"
      style.font: mono
    }
  }
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  COMPLETE ASSEMBLY TRACE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
asm_trace: "context_switch_asm â€” Complete Annotated Trace" {
  style.fill: "#0d0d0d"
  style.stroke: "#666688"
  style.border-radius: 6
  phase1: |md
    **â‘  SAVE PHASE â€” running on Stack A (green = Stack A)**
    asm
    context_switch_asm:         ; called with (old_ctx, new_ctx) on Stack A
      push ebx                  ; ESP-=4  â†’ Stack A  [âˆ’16]
      push esi                  ; ESP-=4  â†’ Stack A  [âˆ’12]
      push edi                  ; ESP-=4  â†’ Stack A  [âˆ’08]
      push ebp                  ; ESP-=4  â†’ Stack A  [âˆ’04]
      pushfd                    ; ESP-=4  â†’ Stack A  [âˆ’00]
      mov eax, [esp + 24]       ; eax = old_ctx ptr  (reads Stack A)
      mov [eax + 16], esp       ; old_ctx->esp = current ESP   â† A is FROZEN
    
  | {
    style.fill: "#0d1408"
    style.font-color: "#88cc66"
    style.stroke: "#336611"
    style.border-radius: 4
  }
  phase2: |md
    **â‘¡ THE PIVOT â€” ESP is reassigned (yellow = metamorphosis)**
    asm
      mov eax, [esp + 28]       ; eax = new_ctx ptr (reads Stack A, last time)
      mov esp, [eax + 16]       ; ESP = B->context.esp  â† â˜… IDENTITY SWAP â˜…
                                ; â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                ; BEFORE: [esp+N] reads Stack A
                                ; AFTER:  [esp+N] reads Stack B
                                ; The CPU does not know. The code does not care.
                                ; One register assignment changed everything.
    
  | {
    style.fill: "#1a1500"
    style.font-color: "#ffd700"
    style.stroke: "#ffd700"
    style.stroke-width: 2
    style.border-radius: 4
  }
  phase3: |md
    **â‘¢ RESTORE PHASE â€” running on Stack B (purple = Stack B)**
    asm
      popfd                     ; ESP+=4  â† Stack B  restores B's EFLAGS
                                ;                     IF=1 â†’ interrupts re-enabled!
      pop ebp                   ; ESP+=4  â† Stack B  restores B's EBP
      pop edi                   ; ESP+=4  â† Stack B  restores B's EDI
      pop esi                   ; ESP+=4  â† Stack B  restores B's ESI
      pop ebx                   ; ESP+=4  â† Stack B  restores B's EBX
      ret                       ; ESP+=4  â† Stack B  pops B's saved EIP
                                ;           jumps to: isr_common_stub+N
                                ;           which runs iretd â†’ user mode Process B
    
  | {
    style.fill: "#100a1a"
    style.font-color: "#cc99ff"
    style.stroke: "#664499"
    style.border-radius: 4
  }
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  CONNECTIONS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Before panel â†’ Pivot
before -> pivot: "A's ESP saved to\nold_ctx->esp\nvia mov [eax+16], esp" {
  style.stroke: "#ff6b6b"
  style.stroke-width: 2
  style.animated: true
  style.bold: true
}
# Pivot â†’ After panel
pivot -> after: "B's ESP loaded from\nnew_ctx->esp\nvia mov esp, [eax+16]" {
  style.stroke: "#4fc3f7"
  style.stroke-width: 2
  style.animated: true
  style.bold: true
}
# PCB A connected to before
pcb_row.pcb_a -> before.stack_a.esp_arrow: "context.esp field\npoints into stack" {
  style.stroke: "#ff6b6b"
  style.stroke-dash: 5
}
# PCB B connected to after
pcb_row.pcb_b -> after.stack_b.esp_arrow_b: "context.esp field\nloaded as new ESP" {
  style.stroke: "#4fc3f7"
  style.stroke-dash: 5
}
# Assembly trace sits below, connected to pivot
asm_trace -> pivot: "implements this\nexact sequence" {
  style.stroke: "#ffd700"
  style.stroke-dash: 3
}
# PCB row connected to pivot for context
pcb_row -> pivot: "PCB structures supply\nold_ctx / new_ctx pointers" {
  style.stroke: "#888800"
  style.stroke-dash: 5
  style.font-color: "#888800"
}