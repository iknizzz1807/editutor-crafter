vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |'md
  ## Process State Machine â€” Ready Â· Running Â· Blocked
  *Preemptive round-robin kernel â€” every transition annotated with trigger + kernel code*
'| {near: top-center}

back_to_map: "â†© Satellite Map" {
  link: "#diag-satellite-os-map"
  style: {
    fill: "#2a2a3e"
    stroke: "#7c7caa"
    font-color: "#aaaacc"
    font-size: 11
    border-radius: 6
    italic: true
  }
}

# â”€â”€ STATE NODES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CREATED: |'md
  **CREATED**
  `process_create()`
  â€¢ kmalloc PCB
  â€¢ kmalloc kernel stack (8 KB)
  â€¢ fabricate initial context
  â€¢ set EFLAGS = 0x202 (IF=1)
  â€¢ state = PROCESS_READY
'| {
  link: "#phase-4-creating-a-process--fabricating-the-initial-context"
  style: {
    fill: "#1a2a1a"
    stroke: "#44bb44"
    font-color: "#aaffaa"
    border-radius: 8
  }
}

READY: |'md
  **READY**
  In the run queue
  â€¢ PCB in circular list
  â€¢ kernel stack cold
  â€¢ context.esp valid
  â€¢ page_directory set
  â€¢ ticks_remaining reset
'| {
  link: "#phase-5-the-round-robin-scheduler"
  style: {
    fill: "#1a2d3a"
    stroke: "#44aaff"
    font-color: "#aaddff"
    border-radius: 8
  }
}

RUNNING: |'md
  **RUNNING**
  On the CPU
  â€¢ current_process = this
  â€¢ CR3 = page_directory (phys)
  â€¢ TSS.ESP0 = kernel_stack_top
  â€¢ total_ticks++ per tick
  â€¢ CPL = 0 (kernel) or 3 (user)
'| {
  link: "#phase-3-the-context-switch--assembly-as-the-only-option"
  style: {
    fill: "#2a1a1a"
    stroke: "#ff6644"
    font-color: "#ffccaa"
    border-radius: 8
  }
}

BLOCKED: |'md
  **BLOCKED**
  Awaiting event
  â€¢ removed from run queue
  â€¢ state = PROCESS_BLOCKED
  â€¢ kernel stack suspended
  â€¢ NOT selected by scheduler
  â€¢ wakeup registered in
    event source (kbd/timer)
'| {
  link: "#phase-5-the-round-robin-scheduler"
  style: {
    fill: "#2a2a1a"
    stroke: "#ddaa00"
    font-color: "#ffeeaa"
    border-radius: 8
  }
}

TERMINATED: |'md
  **TERMINATED**
  `PROCESS_DEAD`
  â€¢ removed from list
  â€¢ kmalloc memory freed
  â€¢ page_directory freed
  â€¢ kernel stack freed
  â€¢ scheduler bypasses
'| {
  link: "#phase-8-the-system-call-interface--int-0x80"
  style: {
    fill: "#221a22"
    stroke: "#aa44aa"
    font-color: "#ddaadd"
    border-radius: 8
  }
}

# â”€â”€ TRANSITION LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

legend: |'md
  **Transition Legend**
  ğŸŸ¢ Green arrow  = creation / admission
  ğŸ”µ Blue arrow   = scheduling dispatch
  ğŸ”´ Red arrow    = preemption
  ğŸŸ¡ Yellow arrow = blocking / wakeup
  ğŸŸ£ Purple arrow = termination
'| {
  near: bottom-right
  style: {
    fill: "#16161e"
    stroke: "#444466"
    font-color: "#aaaacc"
    font-size: 12
    border-radius: 6
  }
}

# â”€â”€ TRANSITIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# T1 â€” CREATED â†’ READY
CREATED -> READY: "scheduler_add_process()\nâ€¢ appends PCB to circular list\nâ€¢ state â† PROCESS_READY\nâ€¢ Trigger: process_create() returns" {
  style: {
    stroke: "#44bb44"
    stroke-width: 3
    font-color: "#88ee88"
    font-size: 12
    bold: true
  }
  target-arrowhead: {
    shape: arrow
    style.filled: true
  }
}

# T2 â€” READY â†’ RUNNING (scheduler dispatch)
READY -> RUNNING: "scheduler_tick() selects next\nâ€¢ context_switch(old, next)\nâ€¢ CR3 â† next->page_directory\nâ€¢ TSS.ESP0 â† next->kernel_stack_top\nâ€¢ context_switch_asm: swap ESP\nâ€¢ Trigger: timer IRQ0 (100 Hz, 10 ms)" {
  style: {
    stroke: "#44aaff"
    stroke-width: 3
    font-color: "#88ccff"
    font-size: 12
    bold: true
  }
  target-arrowhead: {
    shape: arrow
    style.filled: true
  }
}

# T3 â€” RUNNING â†’ READY (preemption)
RUNNING -> READY: "timer_handler() â†’ scheduler_tick()\nâ€¢ old->state â† PROCESS_READY\nâ€¢ next selected by round-robin\nâ€¢ context_switch_asm:\n    pushfd / push EBX ESI EDI EBP\n    mov [old.esp], ESP\n    mov ESP, [next.esp]\n    popfd / pop EBP EDI ESI EBX / ret\nâ€¢ Trigger: PIT IRQ0 fires at 100 Hz" {
  style: {
    stroke: "#ff6644"
    stroke-width: 3
    font-color: "#ffaa88"
    font-size: 12
    bold: true
  }
  target-arrowhead: {
    shape: arrow
    style.filled: true
  }
}

# T4 â€” RUNNING â†’ BLOCKED
RUNNING -> BLOCKED: "keyboard_getchar() / sleep()\nâ€¢ state â† PROCESS_BLOCKED\nâ€¢ prev->next = proc->next (bypass)\nâ€¢ hlt waits; event handler will\n  call scheduler_wake(proc)\nâ€¢ Trigger: process calls blocking\n  kernel API (kbd, wait, sleep)" {
  style: {
    stroke: "#ddaa00"
    stroke-width: 3
    font-color: "#ffdd88"
    font-size: 12
    bold: true
  }
  target-arrowhead: {
    shape: arrow
    style.filled: true
  }
}

# T5 â€” BLOCKED â†’ READY (wakeup)
BLOCKED -> READY: "Event fires (kbd IRQ1 / timer)\nâ€¢ keyboard_handler() detects waiter\nâ€¢ scheduler_wake(proc):\n    proc->state â† PROCESS_READY\n    re-insert into circular list\nâ€¢ Trigger: I/O completion interrupt\n  or timeout expiry" {
  style: {
    stroke: "#ddaa00"
    stroke-width: 3
    stroke-dash: 5
    font-color: "#ffdd88"
    font-size: 12
    bold: true
  }
  source-arrowhead: {
    shape: circle
    style.filled: false
  }
  target-arrowhead: {
    shape: arrow
    style.filled: true
  }
}

# T6 â€” RUNNING â†’ TERMINATED (sys_exit)
RUNNING -> TERMINATED: "sys_exit(code) via INT 0x80\nâ€¢ state â† PROCESS_DEAD\nâ€¢ remove from circular list\nâ€¢ free kernel_stack, page_dir\nâ€¢ kfree(PCB)\nâ€¢ force context_switch to next\nâ€¢ Trigger: SYS_EXIT (EAX=1)" {
  style: {
    stroke: "#aa44aa"
    stroke-width: 3
    font-color: "#ddaadd"
    font-size: 12
    bold: true
  }
  target-arrowhead: {
    shape: arrow
    style.filled: true
  }
}

# â”€â”€ ANNOTATED INTERNAL DETAIL NODES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ctx_switch_detail: |'md
  **context_switch_asm internals**
  
  push EBX, ESI, EDI, EBP
  pushfd                    ; save IF flag
  mov [old+16], ESP         ; old->context.esp
  â”€â”€â”€â”€ identity swap â”€â”€â”€â”€
  mov ESP, [new+16]         ; new->context.esp
  â”€â”€â”€â”€ now on new stack â”€â”€
  popfd                     ; IF restored (=1)
  pop EBP, EDI, ESI, EBX
  ret                       ; â†’ new->EIP
  
  28 bytes saved per context
'| {
  style: {
    fill: "#161620"
    stroke: "#555577"
    font-color: "#9999bb"
    font-size: 11
    border-radius: 4
  }
}

tss_detail: |'md
  **TSS update (every switch)**
  c
  kernel_tss.esp0 =
      next->kernel_stack_top;
  // CPU reads this on next IRQ
  // to find kernel stack base
  // Must precede context_switch_asm
  
  Selector 0x28 loaded via `ltr`
'| {
  style: {
    fill: "#161620"
    stroke: "#555577"
    font-color: "#9999bb"
    font-size: 11
    border-radius: 4
  }
}

cr3_detail: |'md
  **CR3 swap (address space)**
  c
  if (old->page_directory !=
      new->page_directory) {
    asm("mov cr3, %0"
        : : "r"(new->pd_phys));
    // Full TLB flush â€”
    // user translations evicted
    // Kernel PDEs always present
    // in every page directory
  }
'| {
  style: {
    fill: "#161620"
    stroke: "#555577"
    font-color: "#9999bb"
    font-size: 11
    border-radius: 4
  }
}

RUNNING -> ctx_switch_detail: "calls" {
  style: {
    stroke: "#444466"
    stroke-dash: 3
    font-color: "#666688"
    font-size: 10
  }
}
RUNNING -> tss_detail: "updates" {
  style: {
    stroke: "#444466"
    stroke-dash: 3
    font-color: "#666688"
    font-size: 10
  }
}
RUNNING -> cr3_detail: "loads" {
  style: {
    stroke: "#444466"
    stroke-dash: 3
    font-color: "#666688"
    font-size: 10
  }
}

# â”€â”€ PCB STRUCTURE MINI-REFERENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

pcb_ref: |'md
  **process_t fields used per transition**
  | Field | T2 dispatch | T3 preempt | T6 exit |
  |-------|------------|------------|---------|
  | `state` | â† RUNNING | â† READY | â† DEAD |
  | `context.esp` | restore | save | â€” |
  | `page_directory` | â†’ CR3 | save CR3 | free |
  | `kernel_stack_top` | â†’ TSS.ESP0 | â€” | free |
  | `total_ticks` | â€” | ++ | â€” |
  | `next` (list ptr) | advance | â€” | unlink |
'| {
  near: bottom-left
  style: {
    fill: "#16161e"
    stroke: "#444466"
    font-color: "#aaaacc"
    font-size: 11
    border-radius: 6
  }
}