vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  ## Three-Process Preemptive Round-Robin â€” Interleaved VGA Execution Timeline
  **Timer: 100Hz (10ms tick) Â· Kernel Ring 0 Â· Shared Page Directory**
| {near: top-center}
# â”€â”€ COLOR LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
legend: {
  near: bottom-center
  style.fill: "#1a1a2e"
  style.stroke: "#444466"
  style.border-radius: 8
  label: |md
    ðŸŸ© **Process A** â€” cols 0â€“26 Â· Green Â· `0x0A41`    ðŸŸ¥ **Process B** â€” cols 27â€“53 Â· Red Â· `0x0C42`    ðŸŸ¦ **Process C** â€” cols 54â€“79 Â· Cyan Â· `0x0B43`
    âš¡ **IRQ0** = Timer interrupt Â· forces preemption    ðŸ” **context_switch_asm** Â· swaps ESP Â· updates CR3 + TSS.ESP0
  |
  style.font-size: 13
}
# â”€â”€ TIMER AXIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
timer_axis: "PIT IRQ0 Timeline\n1,193,182 Hz Ã· 11932 = 100 Hz\n(10 ms per tick)" {
  style.fill: "#12122a"
  style.stroke: "#5555aa"
  style.font-color: "#aaaaff"
  style.font-size: 13
  style.border-radius: 6
}
# â”€â”€ TICK MARKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tick0: "t=0 ms\ntick #0\nBootstrap\ncurrent=A" {
  style.fill: "#2a2a50"
  style.stroke: "#7777cc"
  style.font-color: "#ccccff"
  style.font-size: 11
  style.border-radius: 4
}
tick1: "t=10 ms\ntick #1\nIRQ0 fires\nâ†’ schedule()" {
  style.fill: "#3a1a1a"
  style.stroke: "#cc3333"
  style.font-color: "#ffaaaa"
  style.font-size: 11
  style.border-radius: 4
}
tick2: "t=20 ms\ntick #2\nIRQ0 fires\nâ†’ schedule()" {
  style.fill: "#3a1a1a"
  style.stroke: "#cc3333"
  style.font-color: "#ffaaaa"
  style.font-size: 11
  style.border-radius: 4
}
tick3: "t=30 ms\ntick #3\nIRQ0 fires\nâ†’ schedule()" {
  style.fill: "#3a1a1a"
  style.stroke: "#cc3333"
  style.font-color: "#ffaaaa"
  style.font-size: 11
  style.border-radius: 4
}
tick4: "t=40 ms\ntick #4\nIRQ0 fires\nâ†’ schedule()" {
  style.fill: "#3a1a1a"
  style.stroke: "#cc3333"
  style.font-color: "#ffaaaa"
  style.font-size: 11
  style.border-radius: 4
}
tick5: "t=50 ms\ntick #5\nIRQ0 fires\nâ†’ schedule()" {
  style.fill: "#3a1a1a"
  style.stroke: "#cc3333"
  style.font-color: "#ffaaaa"
  style.font-size: 11
  style.border-radius: 4
}
tick6: "t=60 ms\ntick #6\nback to A\n(full cycle)" {
  style.fill: "#1a2a1a"
  style.stroke: "#33aa33"
  style.font-color: "#aaffaa"
  style.font-size: 11
  style.border-radius: 4
}
timer_axis -> tick0: "kernel_main\nbootstraps A" {
  style.stroke: "#7777cc"
  style.font-size: 10
  style.font-color: "#aaaaff"
}
tick0 -> tick1: "10 ms elapsed\nA executes ~1.2M cycles" {
  style.stroke: "#cc3333"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#ffaaaa"
  style.animated: true
}
tick1 -> tick2: "10 ms elapsed\nB executes ~1.2M cycles" {
  style.stroke: "#cc3333"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#ffaaaa"
  style.animated: true
}
tick2 -> tick3: "10 ms elapsed\nC executes ~1.2M cycles" {
  style.stroke: "#cc3333"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#ffaaaa"
  style.animated: true
}
tick3 -> tick4: "10 ms elapsed\nA executes again" {
  style.stroke: "#cc3333"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#ffaaaa"
  style.animated: true
}
tick4 -> tick5: "10 ms elapsed\nB executes again" {
  style.stroke: "#cc3333"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#ffaaaa"
  style.animated: true
}
tick5 -> tick6: "10 ms elapsed\nC executes again" {
  style.stroke: "#cc3333"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#ffaaaa"
  style.animated: true
}
# â”€â”€ PROCESS EXECUTION SLOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
slot_a1: "PROCESS A Â· RUNNING\nt = 0â€“10 ms Â· Ring 0\ncurrent_process = A\nTSS.ESP0 = Aâ†’kernel_stack_top\nCR3 = kernel_pd_phys\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nWriting 'A' (0x0A41)\nVGA cols 0â€“26, row++\nvolatile uint16_t *vga\n= (uint16_t*)0xC00B8000\nvga[row*80+col] = entry\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nA.total_ticks++" {
  style.fill: "#0d2b0d"
  style.stroke: "#22aa22"
  style.font-color: "#88ff88"
  style.font-size: 11
  style.border-radius: 6
  style.bold: false
}
ctx_switch_ab: "âš¡ IRQ0 FIRES â†’ context_switch(Aâ†’B)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ‘  isr_32: push 0, push 32 â†’ isr_common_stub\nâ‘¡ pusha â†’ [edi,esi,ebp,esp_dummy,ebx,edx,ecx,eax]\nâ‘¢ push ds/es/fs/gs â†’ reload 0x10\nâ‘£ call interrupt_dispatch â†’ timer_handler â†’ scheduler_tick\nâ‘¤ A.state=READY  B.state=RUNNING\nâ‘¥ context_switch(A, B):\n   â€¢ CR3 â† Bâ†’page_directory (same kernel_pd_phys)\n   â€¢ TSS.ESP0 â† Bâ†’kernel_stack_top\n   â€¢ current_process â† B\nâ‘¦ context_switch_asm(&Aâ†’ctx, &Bâ†’ctx):\n   â€¢ push ebx,esi,edi,ebp,pushfd  [saves A state]\n   â€¢ Aâ†’ctx.esp â† esp\n   â€¢ esp â† Bâ†’ctx.esp           â† ESP SWAP (identity changes here)\n   â€¢ popfd,pop ebp,edi,esi,ebx  [restores B state]\n   â€¢ ret â†’ Bâ†’saved EIP (inside isr_common_stub)\nâ‘§ isr_common_stub resumes: popa, add esp,8, iretd\nâ‘¨ PIC EOI sent: outb(0x20, 0x20)" {
  style.fill: "#2a0a0a"
  style.stroke: "#ff4444"
  style.font-color: "#ffcccc"
  style.font-size: 10
  style.border-radius: 6
  style.bold: false
}
slot_b1: "PROCESS B Â· RUNNING\nt = 10â€“20 ms Â· Ring 0\ncurrent_process = B\nTSS.ESP0 = Bâ†’kernel_stack_top\nCR3 = kernel_pd_phys\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nWriting 'B' (0x0C42)\nVGA cols 27â€“53, row++\nvolatile uint16_t *vga\n= (uint16_t*)0xC00B8000\nvga[row*80+col] = entry\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nB.total_ticks++" {
  style.fill: "#2b0d0d"
  style.stroke: "#aa2222"
  style.font-color: "#ffaaaa"
  style.font-size: 11
  style.border-radius: 6
}
ctx_switch_bc: "âš¡ IRQ0 FIRES â†’ context_switch(Bâ†’C)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ‘  isr_32 fires (B was interrupted mid-loop)\n   Bâ†’ctx captured: EIP inside process_b() loop\n   EFLAGS.IF=1 saved (will re-enable after popfd)\nâ‘¡ scheduler_tick: B.state=READY  C.state=RUNNING\nâ‘¢ context_switch_asm(&Bâ†’ctx, &Câ†’ctx):\n   â€¢ esp â† Câ†’ctx.esp            â† ESP SWAP\n   â€¢ C's fabricated/saved frame popped\nâ‘£ TSS.ESP0 â† Câ†’kernel_stack_top\nâ‘¤ iretd restores C user_esp,cs,eflags if user;\n   here: C is kernel-mode â†’ restores EIP only\nâ‘¥ PIC EOI â†’ outb(0x20, 0x20)" {
  style.fill: "#2a0a0a"
  style.stroke: "#ff4444"
  style.font-color: "#ffcccc"
  style.font-size: 10
  style.border-radius: 6
}
slot_c1: "PROCESS C Â· RUNNING\nt = 20â€“30 ms Â· Ring 0\ncurrent_process = C\nTSS.ESP0 = Câ†’kernel_stack_top\nCR3 = kernel_pd_phys\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nWriting 'C' (0x0B43)\nVGA cols 54â€“79, row++\nvolatile uint16_t *vga\n= (uint16_t*)0xC00B8000\nvga[row*80+col] = entry\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nC.total_ticks++" {
  style.fill: "#0d1f2b"
  style.stroke: "#2299aa"
  style.font-color: "#aaeeff"
  style.font-size: 11
  style.border-radius: 6
}
ctx_switch_ca: "âš¡ IRQ0 FIRES â†’ context_switch(Câ†’A)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ‘  Round-robin: after C, next READY = A\n   Circular list: Aâ†’Bâ†’Câ†’A (head=A)\nâ‘¡ C.state=READY  A.state=RUNNING\nâ‘¢ context_switch_asm(&Câ†’ctx, &Aâ†’ctx):\n   â€¢ esp â† Aâ†’ctx.esp            â† ESP SWAP\n   â€¢ A's previously saved EBX,ESI,EDI,EBP,EFLAGS popped\n   â€¢ ret â†’ Aâ†’saved EIP (mid-loop in process_a)\nâ‘£ TSS.ESP0 â† Aâ†’kernel_stack_top\nâ‘¤ A resumes exactly where timer interrupted it\n   row counter, col counter â€” all intact on A's stack\nâ‘¥ PIC EOI sent" {
  style.fill: "#2a0a0a"
  style.stroke: "#ff4444"
  style.font-color: "#ffcccc"
  style.font-size: 10
  style.border-radius: 6
}
slot_a2: "PROCESS A Â· RUNNING (2nd turn)\nt = 30â€“40 ms Â· Ring 0\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nResumes EXACTLY mid-instruction\nRow counter = where A left off\nContinues writing col 0â€“26\nA.total_ticks now = 2" {
  style.fill: "#0d2b0d"
  style.stroke: "#22aa22"
  style.font-color: "#88ff88"
  style.font-size: 11
  style.border-radius: 6
}
slot_b2: "PROCESS B Â· RUNNING (2nd turn)\nt = 40â€“50 ms Â· Ring 0\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nResumes EXACTLY mid-instruction\nRow counter = where B left off\nContinues writing col 27â€“53\nB.total_ticks now = 2" {
  style.fill: "#2b0d0d"
  style.stroke: "#aa2222"
  style.font-color: "#ffaaaa"
  style.font-size: 11
  style.border-radius: 6
}
slot_c2: "PROCESS C Â· RUNNING (2nd turn)\nt = 50â€“60 ms Â· Ring 0\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nResumes EXACTLY mid-instruction\nRow counter = where C left off\nContinues writing col 54â€“79\nC.total_ticks now = 2" {
  style.fill: "#0d1f2b"
  style.stroke: "#2299aa"
  style.font-color: "#aaeeff"
  style.font-size: 11
  style.border-radius: 6
}
# â”€â”€ EXECUTION FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tick0 -> slot_a1: "Bootstrap: A fabricated context\nEFLAGS=0x202 (IF=1)\ninitial EIP = process_a\nESP = Aâ†’kernel_stack_top - 24" {
  style.stroke: "#22aa22"
  style.font-size: 10
  style.font-color: "#88ff88"
}
slot_a1 -> ctx_switch_ab: "Timer interrupt fires\nA preempted involuntarily\n(no voluntary yield)" {
  style.stroke: "#ff4444"
  style.font-size: 10
  style.font-color: "#ffaaaa"
  style.animated: true
}
ctx_switch_ab -> slot_b1: "B resumes from\nfabricated EIP (1st time)\nor saved EIP (subsequent)" {
  style.stroke: "#aa2222"
  style.font-size: 10
  style.font-color: "#ffaaaa"
}
slot_b1 -> ctx_switch_bc: "Timer interrupt fires\nB preempted involuntarily" {
  style.stroke: "#ff4444"
  style.font-size: 10
  style.font-color: "#ffaaaa"
  style.animated: true
}
ctx_switch_bc -> slot_c1: "C resumes" {
  style.stroke: "#2299aa"
  style.font-size: 10
  style.font-color: "#aaeeff"
}
slot_c1 -> ctx_switch_ca: "Timer interrupt fires\nC preempted involuntarily" {
  style.stroke: "#ff4444"
  style.font-size: 10
  style.font-color: "#ffaaaa"
  style.animated: true
}
ctx_switch_ca -> slot_a2: "A resumes mid-loop\n(full round-robin cycle: 30ms)" {
  style.stroke: "#22aa22"
  style.font-size: 10
  style.font-color: "#88ff88"
}
slot_a2 -> slot_b2: "IRQ0 â†’ Aâ†’B again" {
  style.stroke: "#ff4444"
  style.stroke-dash: 4
  style.font-size: 10
  style.font-color: "#ffaaaa"
  style.animated: true
}
slot_b2 -> slot_c2: "IRQ0 â†’ Bâ†’C again" {
  style.stroke: "#ff4444"
  style.stroke-dash: 4
  style.font-size: 10
  style.font-color: "#ffaaaa"
  style.animated: true
}
# â”€â”€ VGA SCREEN STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
vga_state: "VGA Buffer Physical 0xB8000 Â· Virtual 0xC00B8000\n80Ã—25 chars Â· 2 bytes/cell: [color_attr][ascii]\nvolatile uint16_t *vga = (uint16_t*)0xC00B8000" {
  style.fill: "#000010"
  style.stroke: "#555588"
  style.font-color: "#8888cc"
  style.font-size: 12
  style.border-radius: 6
  col_a: "Cols 0â€“26\n(27 wide)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€\nAAAAAAAAA\nAAAAAAAAA\nAAAAAAAAA\n   Â·Â·Â·\n(grows each\n A-turn)" {
    style.fill: "#0a1a0a"
    style.stroke: "#22aa22"
    style.font-color: "#44ff44"
    style.font-size: 12
    style.border-radius: 4
  }
  col_b: "Cols 27â€“53\n(27 wide)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€\nBBBBBBBBB\nBBBBBBBBB\nBBBBBBBBB\n   Â·Â·Â·\n(grows each\n B-turn)" {
    style.fill: "#1a0a0a"
    style.stroke: "#aa2222"
    style.font-color: "#ff4444"
    style.font-size: 12
    style.border-radius: 4
  }
  col_c: "Cols 54â€“79\n(26 wide)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€\nCCCCCCCCC\nCCCCCCCCC\nCCCCCCCCC\n   Â·Â·Â·\n(grows each\n C-turn)" {
    style.fill: "#0a1520"
    style.stroke: "#2299aa"
    style.font-color: "#44ddff"
    style.font-size: 12
    style.border-radius: 4
  }
  key_obs: "Key Observation:\nAll 3 regions grow\nSIMULTANEOUSLY from\nuser perspective.\nNo region stalls.\n= Proof of preemption." {
    style.fill: "#1a1a10"
    style.stroke: "#aaaa22"
    style.font-color: "#ffff88"
    style.font-size: 11
    style.border-radius: 4
  }
}
slot_a1 -> vga_state.col_a: "writes 0x0A41\n(green 'A')" {
  style.stroke: "#22aa22"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#88ff88"
}
slot_a2 -> vga_state.col_a: "continues\nnext rows" {
  style.stroke: "#22aa22"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#88ff88"
}
slot_b1 -> vga_state.col_b: "writes 0x0C42\n(red 'B')" {
  style.stroke: "#aa2222"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#ffaaaa"
}
slot_b2 -> vga_state.col_b: "continues\nnext rows" {
  style.stroke: "#aa2222"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#ffaaaa"
}
slot_c1 -> vga_state.col_c: "writes 0x0B43\n(cyan 'C')" {
  style.stroke: "#2299aa"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#aaeeff"
}
slot_c2 -> vga_state.col_c: "continues\nnext rows" {
  style.stroke: "#2299aa"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#aaeeff"
}
# â”€â”€ SHARED KERNEL STATE (PCB SNAPSHOT) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
kernel_state: "Kernel Shared State â€” All Processes" {
  style.fill: "#12122a"
  style.stroke: "#5555aa"
  style.font-color: "#aaaaff"
  style.border-radius: 6
  run_queue: "Run Queue (circular list)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nAâ†’next = B\nBâ†’next = C\nCâ†’next = A  â† wraps\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\ncurrent_process: *Aâ†’*Bâ†’*Câ†’*A\n(advances each tick)" {
    style.fill: "#1a1a3a"
    style.stroke: "#7777cc"
    style.font-color: "#ccccff"
    style.font-size: 11
    style.border-radius: 4
  }
  tss_box: "TSS (1 global)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nss0  = 0x10 (constant)\nesp0 = updated EACH switch\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nt=0â€“10ms:  esp0=Aâ†’kstack_top\nt=10â€“20ms: esp0=Bâ†’kstack_top\nt=20â€“30ms: esp0=Câ†’kstack_top\nt=30â€“40ms: esp0=Aâ†’kstack_top\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nIf NOT updated â†’ corrupt!" {
    style.fill: "#2a1a3a"
    style.stroke: "#aa77cc"
    style.font-color: "#ddaaff"
    style.font-size: 11
    style.border-radius: 4
  }
  cr3_box: "CR3 (loaded on switch)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nAll 3 processes share\nkernel_pd_phys (same\npage directory).\nFor user-mode procs:\nCR3 â† procâ†’page_dir_phys\n(per-process PD with\nkernel PDEs 768â€“1023\ncopied in)" {
    style.fill: "#1a2a3a"
    style.stroke: "#5599cc"
    style.font-color: "#aaddff"
    style.font-size: 11
    style.border-radius: 4
  }
  tick_ctr: "tick_counter (volatile uint64_t)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nt=0:  tick_counter = 0\nt=10: tick_counter = 1  (Aâ†’B)\nt=20: tick_counter = 2  (Bâ†’C)\nt=30: tick_counter = 3  (Câ†’A)\nt=40: tick_counter = 4  (Aâ†’B)\nÂ·Â·Â·\nvolatile: forces memory read\nevery timer_handler call" {
    style.fill: "#2a1a1a"
    style.stroke: "#cc5555"
    style.font-color: "#ffbbbb"
    style.font-size: 11
    style.border-radius: 4
  }
}
ctx_switch_ab -> kernel_state.tss_box: "esp0 â† Bâ†’kstack_top\nCR3 unchanged (same pd)" {
  style.stroke: "#aa77cc"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#ddaaff"
}
ctx_switch_bc -> kernel_state.tss_box: "esp0 â† Câ†’kstack_top" {
  style.stroke: "#aa77cc"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#ddaaff"
}
ctx_switch_ca -> kernel_state.run_queue: "scheduler advances\ncircular list pointer" {
  style.stroke: "#7777cc"
  style.stroke-dash: 3
  style.font-size: 10
  style.font-color: "#ccccff"
}
tick1 -> kernel_state.tick_ctr: "tick_counter = 1\n(atomic in single-core)" {
  style.stroke: "#cc5555"
  style.stroke-dash: 4
  style.font-size: 10
  style.font-color: "#ffbbbb"
}
# â”€â”€ NON-PREEMPTIVE CONTRAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
no_yield_note: "WHY NO VOLUNTARY YIELD?\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nprocess_a() is an infinite while(1) loop.\nIt NEVER calls yield() or sleep().\nThe for(volatile int i=0;i<10000;i++) loop\nis NOT a yield â€” it's a busy-wait.\nThe ONLY reason B and C get CPU time:\n  â†’ the PIT fires IRQ0 every 10 ms\n  â†’ timer_handler() calls scheduler_tick()\n  â†’ scheduler_tick() calls context_switch()\nThis is PREEMPTIVE scheduling:\nthe OS takes the CPU away from A\nwithout A's cooperation or knowledge." {
  style.fill: "#1a1510"
  style.stroke: "#aa8822"
  style.font-color: "#ffdd88"
  style.font-size: 11
  style.border-radius: 6
}
slot_a1 -> no_yield_note: "A never calls\nyield() or sleep()" {
  style.stroke: "#aa8822"
  style.stroke-dash: 5
  style.font-size: 10
  style.font-color: "#ffdd88"
}
# â”€â”€ BACK TO MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
back_to_map: "â†‘ Back to Satellite Map" {
  link: "#diag-satellite-os-map"
  style.fill: "#0a0a1a"
  style.stroke: "#444488"
  style.font-color: "#8888cc"
  style.font-size: 11
  style.border-radius: 4
}
vga_state -> back_to_map