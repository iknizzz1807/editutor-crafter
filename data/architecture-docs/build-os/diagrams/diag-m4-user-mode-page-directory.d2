vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right
title: |md
  ## Per-Process Page Directory â€” User/Kernel Split
  CR3 switch changes user-space mapping; kernel PDEs 768â€“1023 are identical in every process
| {near: top-center}
back_to_map: "â¬† Satellite Map" {
  link: "#diag-satellite-os-map"
  style: {
    fill: "#2d2d2d"
    font-color: "#ffffff"
    border-radius: 4
    font-size: 11
    stroke: "#555555"
  }
}
legend: {
  near: bottom-center
  style: {
    fill: "#1a1a2e"
    stroke: "#444466"
    border-radius: 6
    font-size: 11
  }
  content: |md
    **Color Key:**
    ðŸŸ¦ Blue = Kernel PDEs (shared, U/S=0, supervisor-only)
    ðŸŸ© Green = User PDEs (per-process, U/S=1, user-accessible)
    ðŸŸ¥ Red = Forbidden access (ring-3 attempt â†’ #PF error_code.U=1)
    â¬œ Gray = Empty / not present (P=0)
  |
}
# â”€â”€â”€ VIRTUAL ADDRESS SPACE RULER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
vas_ruler: "Virtual Address Space (32-bit: 4 GB)" {
  style: {
    fill: "#0d0d1a"
    stroke: "#3333aa"
    stroke-width: 2
    font-color: "#aaaaff"
    bold: true
    font-size: 13
  }
  grid-columns: 4
  grid-gap: 0
  r_user: "0x00000000 â€“ 0xBFFFFFFF\nUser Space  (3 GB)\nPDE index 0 â€“ 767\n768 entries" {
    style: {
      fill: "#0d2b0d"
      stroke: "#226622"
      font-color: "#88ee88"
      font-size: 11
    }
  }
  r_k1: "0xC0000000 â€“ 0xC03FFFFF\nKernel Code+Data\nPDE 768 (4 MB)\nVMA=0xC01xxxxx" {
    style: {
      fill: "#0d0d3d"
      stroke: "#3333cc"
      font-color: "#9999ff"
      font-size: 11
    }
  }
  r_k2: "0xC0400000 â€“ 0xCFFFFFFF\nKernel Heap\nPDE 769 â€“ 831\n(kmalloc arena)" {
    style: {
      fill: "#0d0d3d"
      stroke: "#3333cc"
      font-color: "#9999ff"
      font-size: 11
    }
  }
  r_k3: "0xD0000000 â€“ 0xFFFFFFFF\nKernel Reserved\nPDE 832 â€“ 1023\n(MMIO, future)" {
    style: {
      fill: "#1a0d3d"
      stroke: "#5533cc"
      font-color: "#cc99ff"
      font-size: 11
    }
  }
}
# â”€â”€â”€ PROCESS A PAGE DIRECTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
proc_a_pd: "Process A â€” Page Directory\nCR3 = 0x00201000 (physical)\nPID=2  name=\"user_shell\"" {
  link: "#process-context-block"
  style: {
    fill: "#0d1a0d"
    stroke: "#33aa33"
    stroke-width: 2
    font-color: "#66ff66"
    bold: true
    font-size: 12
  }
  a_header: "PD Header Info" {
    style: {
      fill: "#0a120a"
      stroke: "#226622"
      font-color: "#55dd55"
      font-size: 10
      bold: true
    }
    grid-columns: 2
    grid-gap: 0
    h1: "Physical base: 0x00201000" {
      style.fill: "#0a120a"
      style.stroke: "#226622"
      style.font-color: "#88ee88"
      style.font-size: 10
    }
    h2: "4096 bytes = 1 page\n1024 entries Ã— 4 B" {
      style.fill: "#0a120a"
      style.stroke: "#226622"
      style.font-color: "#88ee88"
      style.font-size: 10
    }
  }
  a_pde0: "PDE[0]  idx=0   virt=0x00000000\nP=0  Frame=â€”  (not mapped)\nNULL page: access â†’ #PF(P=0)" {
    style: {
      fill: "#1a1a1a"
      stroke: "#555555"
      font-color: "#888888"
      font-size: 10
    }
  }
  a_pde1: "PDE[1â€“3]  0x00400000â€“0x00FFFFFF\nP=1  Frame=0x00210000\nU/S=1  R/W=1  USER CODE+STACK\nâ†’ user_process_entry() lives here" {
    style: {
      fill: "#0d2b0d"
      stroke: "#33aa33"
      font-color: "#88ee88"
      bold: true
      font-size: 10
    }
  }
  a_pde_user_stack: "PDE[191]  virt=0xBFC00000\nP=1  Frame=0x00280000\nU/S=1  R/W=1  USER STACK\nESP_user â‰ˆ 0xBFFFFFF0" {
    style: {
      fill: "#0d2b0d"
      stroke: "#33aa33"
      font-color: "#88ee88"
      font-size: 10
    }
  }
  a_pde_gap: "PDE[4â€“767]  0x01000000â€“0xBFBFFFFF\nP=0  (not mapped / on-demand)\n~763 entries empty  â‰ˆ 3 GB virtual" {
    style: {
      fill: "#111111"
      stroke: "#333333"
      font-color: "#555555"
      font-size: 10
    }
  }
  a_pde768: "PDE[768]  virt=0xC0000000  â˜… SHARED\nP=1  Frame=0x00101000 (kernel PT)\nU/S=0  R/W=1  Kernel Code Segment\n.text .rodata .data .bss" {
    style: {
      fill: "#0d0d3d"
      stroke: "#5555ff"
      font-color: "#aaaaff"
      bold: true
      stroke-width: 2
      font-size: 10
    }
  }
  a_pde769: "PDE[769]  virt=0xC0400000  â˜… SHARED\nP=1  Frame=0x00102000 (heap PT)\nU/S=0  R/W=1  Kernel Heap (kmalloc)\nkmalloc arena start" {
    style: {
      fill: "#0d0d3d"
      stroke: "#5555ff"
      font-color: "#aaaaff"
      bold: true
      stroke-width: 2
      font-size: 10
    }
  }
  a_pde770_1023: "PDE[770â€“1023]  0xC0800000â€“0xFFFFFFFF  â˜… SHARED\nP=1 (some)  U/S=0  Kernel Reserved\nMMIO, IDT, GDT, TSS, page table pages\nAll ring-3 access â†’ #PF(P=1,U=1,W=?)" {
    style: {
      fill: "#1a0d3d"
      stroke: "#7755cc"
      font-color: "#cc99ff"
      bold: true
      stroke-width: 2
      font-size: 10
    }
  }
}
# â”€â”€â”€ PROCESS B PAGE DIRECTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
proc_b_pd: "Process B â€” Page Directory\nCR3 = 0x00305000 (physical)\nPID=3  name=\"proc_a\"" {
  link: "#process-context-block"
  style: {
    fill: "#1a0d00"
    stroke: "#cc7700"
    stroke-width: 2
    font-color: "#ffaa33"
    bold: true
    font-size: 12
  }
  b_header: "PD Header Info" {
    style: {
      fill: "#120a00"
      stroke: "#885500"
      font-color: "#ffaa33"
      font-size: 10
      bold: true
    }
    grid-columns: 2
    grid-gap: 0
    h1: "Physical base: 0x00305000" {
      style.fill: "#120a00"
      style.stroke: "#885500"
      style.font-color: "#ffcc77"
      style.font-size: 10
    }
    h2: "4096 bytes = 1 page\n1024 entries Ã— 4 B" {
      style.fill: "#120a00"
      style.stroke: "#885500"
      style.font-color: "#ffcc77"
      style.font-size: 10
    }
  }
  b_pde0: "PDE[0]  idx=0   virt=0x00000000\nP=0  Frame=â€”  (not mapped)\nNULL page: access â†’ #PF(P=0)" {
    style: {
      fill: "#1a1a1a"
      stroke: "#555555"
      font-color: "#888888"
      font-size: 10
    }
  }
  b_pde1: "PDE[1â€“3]  0x00400000â€“0x00FFFFFF\nP=1  Frame=0x00350000\nU/S=1  R/W=1  USER CODE+STACK\nâ†’ DIFFERENT frames than Proc A!" {
    style: {
      fill: "#2b1a00"
      stroke: "#cc7700"
      font-color: "#ffcc77"
      bold: true
      font-size: 10
    }
  }
  b_pde_user_stack: "PDE[191]  virt=0xBFC00000\nP=1  Frame=0x00380000\nU/S=1  R/W=1  USER STACK\nDIFFERENT physical frame than A" {
    style: {
      fill: "#2b1a00"
      stroke: "#cc7700"
      font-color: "#ffcc77"
      font-size: 10
    }
  }
  b_pde_gap: "PDE[4â€“767]  0x01000000â€“0xBFBFFFFF\nP=0  (not mapped / on-demand)\n~763 entries empty  â‰ˆ 3 GB virtual" {
    style: {
      fill: "#111111"
      stroke: "#333333"
      font-color: "#555555"
      font-size: 10
    }
  }
  b_pde768: "PDE[768]  virt=0xC0000000  â˜… SHARED\nP=1  Frame=0x00101000 (SAME PT!)\nU/S=0  R/W=1  Kernel Code Segment\nIDENTICAL to Process A" {
    style: {
      fill: "#0d0d3d"
      stroke: "#5555ff"
      font-color: "#aaaaff"
      bold: true
      stroke-width: 2
      font-size: 10
    }
  }
  b_pde769: "PDE[769]  virt=0xC0400000  â˜… SHARED\nP=1  Frame=0x00102000 (SAME PT!)\nU/S=0  R/W=1  Kernel Heap\nIDENTICAL to Process A" {
    style: {
      fill: "#0d0d3d"
      stroke: "#5555ff"
      font-color: "#aaaaff"
      bold: true
      stroke-width: 2
      font-size: 10
    }
  }
  b_pde770_1023: "PDE[770â€“1023]  0xC0800000â€“0xFFFFFFFF  â˜… SHARED\nP=1 (some)  U/S=0  Kernel Reserved\nIDENTICAL physical page tables\nAll ring-3 access â†’ #PF(P=1,U=1)" {
    style: {
      fill: "#1a0d3d"
      stroke: "#7755cc"
      font-color: "#cc99ff"
      bold: true
      stroke-width: 2
      font-size: 10
    }
  }
}
# â”€â”€â”€ SHARED KERNEL PAGE TABLES (physical) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
shared_kernel_pts: "Shared Kernel Page Tables (Physical Memory)\nFrame=0x00101000 for PDE[768] â€” used by ALL processes" {
  link: "#phase-3-x86-two-level-paging"
  style: {
    fill: "#050520"
    stroke: "#3333aa"
    stroke-width: 3
    font-color: "#8888ff"
    bold: true
    font-size: 12
  }
  kpt_hdr: "Kernel Page Table Layout" {
    style: {
      fill: "#0a0a30"
      stroke: "#3333aa"
      font-color: "#aaaaff"
      bold: true
      font-size: 11
    }
    grid-columns: 2
    grid-gap: 0
    kpt_h1: "PT phys base: 0x00101000\n1024 PTEs Ã— 4B = 4096B" {
      style.fill: "#0a0a30"
      style.stroke: "#3333aa"
      style.font-color: "#9999ff"
      style.font-size: 10
    }
    kpt_h2: "All PTEs: U/S=0 (supervisor)\nR/W=1 (kernel can write)\nGlobal=1 (don't TLB-flush)" {
      style.fill: "#0a0a30"
      style.stroke: "#3333aa"
      style.font-color: "#9999ff"
      style.font-size: 10
    }
  }
  kpt_text: "PTE[0â€“63]  phys=0x00100000â€“0x001FFFFF\nKernel .text segment (exec, no-write ideal)\nvirt=0xC0100000â€“0xC01FFFFF\nU/S=0  â†’ ring-3 read â†’ #PF(P=1, U=1)" {
    style: {
      fill: "#0d0d3d"
      stroke: "#5555ff"
      font-color: "#9999ff"
      font-size: 10
    }
  }
  kpt_data: "PTE[64â€“127]  phys=0x00200000â€“0x002FFFFF\nKernel .data .bss heap (GDT/IDT/TSS)\nvirt=0xC0200000â€“0xC02FFFFF\nU/S=0  Dirty bit set by kernel writes" {
    style: {
      fill: "#0d0d3d"
      stroke: "#5555ff"
      font-color: "#9999ff"
      font-size: 10
    }
  }
  kpt_vga: "PTE[special]  phys=0x000B8000\nVGA Text Buffer MMIO\nvirt=0xC00B8000\nU/S=0  cache_disable=1  write_through=1" {
    style: {
      fill: "#0d1a00"
      stroke: "#336633"
      font-color: "#66cc66"
      font-size: 10
    }
  }
}
# â”€â”€â”€ USER PAGE TABLES (per-process, private) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_pt_a: "Process A â€” User Page Table\nPhys base: 0x00210000\n(not shared with any other process)" {
  style: {
    fill: "#0a1a0a"
    stroke: "#33aa33"
    stroke-width: 2
    font-color: "#66ff66"
    font-size: 11
    bold: true
  }
  a_upt1: "PTE[0]  phys=0x00400000\nvirt=0x00400000  .text of user_process_entry\nU/S=1  R/W=0 (exec, read-only code)\nP=1  Accessed=1" {
    style: {
      fill: "#0d2b0d"
      stroke: "#33aa33"
      font-color: "#88ee88"
      font-size: 10
    }
  }
  a_upt2: "PTE[stack]  phys=0x00280000\nvirt=0xBFFFF000  User stack page\nU/S=1  R/W=1  Dirty=1\nESP_user=0xBFFFFFF0 (init top)" {
    style: {
      fill: "#0d2b0d"
      stroke: "#33aa33"
      font-color: "#88ee88"
      font-size: 10
    }
  }
}
user_pt_b: "Process B â€” User Page Table\nPhys base: 0x00350000\n(completely separate from Proc A)" {
  style: {
    fill: "#1a1000"
    stroke: "#cc7700"
    stroke-width: 2
    font-color: "#ffaa33"
    font-size: 11
    bold: true
  }
  b_upt1: "PTE[0]  phys=0x00350000\nvirt=0x00400000  .text of proc_b entry\nU/S=1  R/W=0 (exec, read-only code)\nSAME virtual addr, DIFFERENT physical!" {
    style: {
      fill: "#2b1a00"
      stroke: "#cc7700"
      font-color: "#ffcc77"
      font-size: 10
    }
  }
  b_upt2: "PTE[stack]  phys=0x00380000\nvirt=0xBFFFF000  User stack page\nU/S=1  R/W=1  Dirty=1\nSAME virtual addr, DIFFERENT physical!" {
    style: {
      fill: "#2b1a00"
      stroke: "#cc7700"
      font-color: "#ffcc77"
      font-size: 10
    }
  }
}
# â”€â”€â”€ CR3 REGISTER + CONTEXT SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cr3_box: "CPU CR3 Register\n(active page directory physical addr)" {
  style: {
    fill: "#1a0000"
    stroke: "#ff3333"
    stroke-width: 3
    font-color: "#ff8888"
    bold: true
    font-size: 12
    shadow: true
  }
  cr3_current: "Current CR3 = 0x00201000\n(Process A is RUNNING)\nMMU walks Proc A's PD\non every memory access" {
    style: {
      fill: "#2b0000"
      stroke: "#ff3333"
      font-color: "#ff9999"
      font-size: 11
      bold: true
    }
  }
  cr3_switch: "context_switch() writes:\nmov cr3, new_pd_phys\nâ†’ TLB fully flushed!\nâ†’ All user translations gone\nâ†’ Kernel translations remain\n   (invlpg not needed â€” CR3 reload)" {
    style: {
      fill: "#1a0000"
      stroke: "#ff6666"
      font-color: "#ffaaaa"
      font-size: 10
    }
  }
}
# â”€â”€â”€ PAGE FAULT ACCESS CONTROL MATRIX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
access_matrix: "Access Control Matrix â€” U/S Bit Enforcement" {
  style: {
    fill: "#0d0d0d"
    stroke: "#666666"
    stroke-width: 2
    font-color: "#cccccc"
    bold: true
    font-size: 12
  }
  grid-columns: 3
  grid-gap: 0
  am_hdr1: "Accessor\n(CPL)" {
    style.fill: "#1a1a1a"
    style.stroke: "#666666"
    style.font-color: "#aaaaaa"
    style.bold: true
    style.font-size: 10
  }
  am_hdr2: "Page PTE\n(U/S bit)" {
    style.fill: "#1a1a1a"
    style.stroke: "#666666"
    style.font-color: "#aaaaaa"
    style.bold: true
    style.font-size: 10
  }
  am_hdr3: "Result" {
    style.fill: "#1a1a1a"
    style.stroke: "#666666"
    style.font-color: "#aaaaaa"
    style.bold: true
    style.font-size: 10
  }
  am_r1c1: "Ring 0\n(kernel)" {
    style.fill: "#0d0d3d"
    style.stroke: "#5555ff"
    style.font-color: "#9999ff"
    style.font-size: 10
  }
  am_r1c2: "U/S=0\n(supervisor)" {
    style.fill: "#0d0d3d"
    style.stroke: "#5555ff"
    style.font-color: "#9999ff"
    style.font-size: 10
  }
  am_r1c3: "âœ… ALLOWED\nFull R/W/X access" {
    style.fill: "#0d2b0d"
    style.stroke: "#33aa33"
    style.font-color: "#66ff66"
    style.font-size: 10
  }
  am_r2c1: "Ring 0\n(kernel)" {
    style.fill: "#0d0d3d"
    style.stroke: "#5555ff"
    style.font-color: "#9999ff"
    style.font-size: 10
  }
  am_r2c2: "U/S=1\n(user)" {
    style.fill: "#0d2b0d"
    style.stroke: "#33aa33"
    style.font-color: "#88ee88"
    style.font-size: 10
  }
  am_r2c3: "âœ… ALLOWED\nKernel can read user mem\n(needed for sys_write ptr)" {
    style.fill: "#0d2b0d"
    style.stroke: "#33aa33"
    style.font-color: "#66ff66"
    style.font-size: 10
  }
  am_r3c1: "Ring 3\n(user)" {
    style.fill: "#2b1a00"
    style.stroke: "#cc7700"
    style.font-color: "#ffcc77"
    style.font-size: 10
  }
  am_r3c2: "U/S=1\n(user)" {
    style.fill: "#0d2b0d"
    style.stroke: "#33aa33"
    style.font-color: "#88ee88"
    style.font-size: 10
  }
  am_r3c3: "âœ… ALLOWED\n(if P=1, R/W matches)" {
    style.fill: "#0d2b0d"
    style.stroke: "#33aa33"
    style.font-color: "#66ff66"
    style.font-size: 10
  }
  am_r4c1: "Ring 3\n(user)" {
    style.fill: "#2b1a00"
    style.stroke: "#cc7700"
    style.font-color: "#ffcc77"
    style.font-size: 10
  }
  am_r4c2: "U/S=0\n(supervisor)" {
    style.fill: "#0d0d3d"
    style.stroke: "#5555ff"
    style.font-color: "#9999ff"
    style.font-size: 10
  }
  am_r4c3: "ðŸ”´ #PF FAULT\nerr=0x05 (P=1,W=0,U=1)\nCR2=fault_addr\nProcess killed / SIGSEGV" {
    style.fill: "#2b0000"
    style.stroke: "#ff3333"
    style.font-color: "#ff8888"
    style.bold: true
    style.font-size: 10
  }
}
# â”€â”€â”€ BYTE OFFSET RULER FOR PDE ENTRIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pde_bitfield: "PDE / PTE Bit Layout (32-bit entry = 4 bytes)" {
  style: {
    fill: "#100020"
    stroke: "#6633cc"
    stroke-width: 2
    font-color: "#cc99ff"
    bold: true
    font-size: 12
  }
  grid-columns: 8
  grid-gap: 0
  bf_frame: "Bits 31â€“12\n20 bits\nPage Frame Number\n(phys_addr >> 12)" {
    style.fill: "#0d0d3d"
    style.stroke: "#5555ff"
    style.font-color: "#aaaaff"
    style.bold: true
    style.font-size: 10
  }
  bf_avl: "Bits 11â€“9\n3 bits\nAVL\n(OS use)" {
    style.fill: "#1a1a1a"
    style.stroke: "#555555"
    style.font-color: "#888888"
    style.font-size: 10
  }
  bf_g: "Bit 8\nG\nGlobal\n(no TLB\nflush)" {
    style.fill: "#1a1a1a"
    style.stroke: "#555555"
    style.font-color: "#888888"
    style.font-size: 10
  }
  bf_d: "Bit 6\nD\nDirty\n(written)" {
    style.fill: "#1a1a1a"
    style.stroke: "#555555"
    style.font-color: "#888888"
    style.font-size: 10
  }
  bf_a: "Bit 5\nA\nAccessed\n(CPU sets)" {
    style.fill: "#1a1a1a"
    style.stroke: "#555555"
    style.font-color: "#888888"
    style.font-size: 10
  }
  bf_us: "Bit 2\nU/S\n0=Super\n1=User" {
    style.fill: "#2b0d2b"
    style.stroke: "#cc33cc"
    style.font-color: "#ff88ff"
    style.bold: true
    style.font-size: 10
  }
  bf_rw: "Bit 1\nR/W\n0=RO\n1=RW" {
    style.fill: "#2b1a00"
    style.stroke: "#cc7700"
    style.font-color: "#ffcc77"
    style.font-size: 10
  }
  bf_p: "Bit 0\nP\n1=Present\n0=#PF" {
    style.fill: "#2b0000"
    style.stroke: "#ff3333"
    style.font-color: "#ff8888"
    style.bold: true
    style.font-size: 10
  }
}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONNECTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CR3 â†’ page directories
cr3_box.cr3_current -> proc_a_pd: "CR3=0x00201000\n(Proc A running)" {
  style: {
    stroke: "#ff3333"
    stroke-width: 2
    font-color: "#ff8888"
    font-size: 10
    bold: true
  }
}
cr3_box.cr3_switch -> proc_b_pd: "after context_switch(Aâ†’B)\nCR3=0x00305000\nTLB flushed on CR3 write" {
  style: {
    stroke: "#ff6666"
    stroke-width: 2
    stroke-dash: 5
    font-color: "#ffaaaa"
    font-size: 10
  }
}
# Proc A PDEs â†’ shared kernel PTs
proc_a_pd.a_pde768 -> shared_kernel_pts: "PTE_FRAME=0x00101000\nSAME physical PT" {
  style: {
    stroke: "#5555ff"
    stroke-width: 3
    font-color: "#aaaaff"
    font-size: 10
    bold: true
  }
}
proc_a_pd.a_pde769 -> shared_kernel_pts: "PTE_FRAME=0x00102000\nkernel heap PT" {
  style: {
    stroke: "#5555ff"
    stroke-width: 2
    font-color: "#aaaaff"
    font-size: 10
  }
}
# Proc B PDEs â†’ SAME shared kernel PTs
proc_b_pd.b_pde768 -> shared_kernel_pts: "PTE_FRAME=0x00101000\nIDENTICAL physical PT" {
  style: {
    stroke: "#5555ff"
    stroke-width: 3
    font-color: "#aaaaff"
    font-size: 10
    bold: true
  }
}
proc_b_pd.b_pde769 -> shared_kernel_pts: "PTE_FRAME=0x00102000\nidentical kernel heap PT" {
  style: {
    stroke: "#5555ff"
    stroke-width: 2
    font-color: "#aaaaff"
    font-size: 10
  }
}
# Proc A PDEs â†’ private user PT
proc_a_pd.a_pde1 -> user_pt_a: "PTE_FRAME=0x00210000\nProc A private PT" {
  style: {
    stroke: "#33aa33"
    stroke-width: 2
    font-color: "#88ee88"
    font-size: 10
  }
}
# Proc B PDEs â†’ DIFFERENT private user PT
proc_b_pd.b_pde1 -> user_pt_b: "PTE_FRAME=0x00350000\nProc B private PT\n(different frames!)" {
  style: {
    stroke: "#cc7700"
    stroke-width: 2
    font-color: "#ffcc77"
    font-size: 10
  }
}
# Virtual address space annotations
vas_ruler.r_user -> proc_a_pd.a_pde_gap: "virt 0x00000000â€“0xBFFFFFFF\nPDE[0â€“767] in both PDs" {
  style: {
    stroke: "#226622"
    stroke-dash: 3
    font-color: "#55aa55"
    font-size: 10
  }
}
vas_ruler.r_k1 -> shared_kernel_pts: "virt 0xC0000000â€“0xC03FFFFF\nPDE[768] â†’ single shared PT" {
  style: {
    stroke: "#3333cc"
    stroke-width: 2
    font-color: "#9999ff"
    font-size: 10
    bold: true
  }
}
# Access matrix explains the U/S bit
proc_a_pd.a_pde768 -> access_matrix: "U/S=0 â†’ ring-3 access denied\n#PF err_code bit2=1 (U)" {
  style: {
    stroke: "#cc3333"
    stroke-dash: 5
    font-color: "#ff8888"
    font-size: 10
  }
}
proc_a_pd.a_pde1 -> access_matrix: "U/S=1 â†’ ring-3 access allowed\n(if P=1 and R/W check passes)" {
  style: {
    stroke: "#33aa33"
    stroke-dash: 5
    font-color: "#88ee88"
    font-size: 10
  }
}