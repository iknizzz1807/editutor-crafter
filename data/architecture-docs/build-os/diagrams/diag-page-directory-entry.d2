vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header-bg: "#2E3440"
    present: "#BF616A"
    rw: "#D08770"
    user: "#EBCB8B"
    cache: "#A3BE8C"
    accessed: "#B48EAD"
    dirty: "#5E81AC"
    ps: "#88C0D0"
    global: "#81A1C1"
    avail: "#4C566A"
    frame: "#8FBCBB"
    reserved: "#D8DEE9"
  }
}
title: |md
  # Page Directory / Page Table Entry (32-bit)
  ### x86 Paging Structure - Bit-Level Layout
| {near: top-center}
direction: right
legend: {
  legend_title: Field Legend {
    shape: rectangle
    style.fill: white
    style.stroke: "#4C566A"
  }
  grid-columns: 2
  grid-gap: 8
  P_bit: "P (0): Present" {
    style.fill: "${colors.present}"
    style.font-color: white
    style.stroke: none
  }
  RW_bit: "R/W (1): Read/Write" {
    style.fill: "${colors.rw}"
    style.font-color: white
    style.stroke: none
  }
  US_bit: "U/S (2): User/Supervisor" {
    style.fill: "${colors.user}"
    style.font-color: black
    style.stroke: none
  }
  PWT_bit: "PWT (3): Write-Through" {
    style.fill: "${colors.cache}"
    style.font-color: black
    style.stroke: none
  }
  PCD_bit: "PCD (4): Cache Disable" {
    style.fill: "${colors.cache}"
    style.font-color: black
    style.stroke: none
  }
  A_bit: "A (5): Accessed" {
    style.fill: "${colors.accessed}"
    style.font-color: white
    style.stroke: none
  }
  D_bit: "D (6): Dirty" {
    style.fill: "${colors.dirty}"
    style.font-color: white
    style.stroke: none
  }
  PS_bit: "PS (7): Page Size" {
    style.fill: "${colors.ps}"
    style.font-color: black
    style.stroke: none
  }
  G_bit: "G (8): Global" {
    style.fill: "${colors.global}"
    style.font-color: white
    style.stroke: none
  }
  AVAIL_bits: "AVAIL (9-11): Available" {
    style.fill: "${colors.avail}"
    style.font-color: white
    style.stroke: none
  }
  FRAME_bits: "FRAME (12-31): Physical Address" {
    style.fill: "${colors.frame}"
    style.font-color: black
    style.stroke: none
  }
}
entry_structure: Page Directory/Table Entry {
  direction: right
  style.fill: white
  style.stroke: "${colors.header-bg}"
  style.stroke-width: 3
  bit31_12: "Frame Address\n[31:12]" {
    width: 400
    height: 80
    style.fill: "${colors.frame}"
    style.font-color: black
    style.font-size: 20
    style.bold: true
  }
  bit11_9: "AVAIL\n[11:9]" {
    width: 90
    height: 80
    style.fill: "${colors.avail}"
    style.font-color: white
    style.font-size: 16
  }
  bit8: "G\n[8]" {
    width: 40
    height: 80
    style.fill: "${colors.global}"
    style.font-color: white
    style.font-size: 16
    style.bold: true
  }
  bit7: "PS\n[7]" {
    width: 40
    height: 80
    style.fill: "${colors.ps}"
    style.font-color: black
    style.font-size: 16
    style.bold: true
  }
  bit6: "D\n[6]" {
    width: 40
    height: 80
    style.fill: "${colors.dirty}"
    style.font-color: white
    style.font-size: 16
    style.bold: true
  }
  bit5: "A\n[5]" {
    width: 40
    height: 80
    style.fill: "${colors.accessed}"
    style.font-color: white
    style.font-size: 16
    style.bold: true
  }
  bit4: "PCD\n[4]" {
    width: 40
    height: 80
    style.fill: "${colors.cache}"
    style.font-color: black
    style.font-size: 14
    style.bold: true
  }
  bit3: "PWT\n[3]" {
    width: 40
    height: 80
    style.fill: "${colors.cache}"
    style.font-color: black
    style.font-size: 14
    style.bold: true
  }
  bit2: "U/S\n[2]" {
    width: 40
    height: 80
    style.fill: "${colors.user}"
    style.font-color: black
    style.font-size: 14
    style.bold: true
  }
  bit1: "R/W\n[1]" {
    width: 40
    height: 80
    style.fill: "${colors.rw}"
    style.font-color: white
    style.font-size: 14
    style.bold: true
  }
  bit0: "P\n[0]" {
    width: 40
    height: 80
    style.fill: "${colors.present}"
    style.font-color: white
    style.font-size: 16
    style.bold: true
  }
}
bit_positions: {
  direction: right
  high_label: |md
    **31**
  | {
    width: 40
    style.fill: transparent
    style.stroke: none
    style.font-size: 12
  }
  frame_label: |md
    `0xXXXXX000`
  | {
    width: 380
    style.fill: transparent
    style.stroke: none
    style.font-size: 14
    style.font: mono
    style.font-color: "${colors.frame}"
  }
  avail_space: {
    width: 90
    style.fill: transparent
    style.stroke: none
  }
  g_space: {
    width: 40
    style.fill: transparent
    style.stroke: none
  }
  ps_space: {
    width: 40
    style.fill: transparent
    style.stroke: none
  }
  d_space: {
    width: 40
    style.fill: transparent
    style.stroke: none
  }
  a_space: {
    width: 40
    style.fill: transparent
    style.stroke: none
  }
  pcd_space: {
    width: 40
    style.fill: transparent
    style.stroke: none
  }
  pwt_space: {
    width: 40
    style.fill: transparent
    style.stroke: none
  }
  us_space: {
    width: 40
    style.fill: transparent
    style.stroke: none
  }
  rw_space: {
    width: 40
    style.fill: transparent
    style.stroke: none
  }
  low_label: |md
    **0**
  | {
    width: 40
    style.fill: transparent
    style.stroke: none
    style.font-size: 12
  }
}
field_details: {
  direction: right
  style.fill: "#F5F5F5"
  style.stroke: "${colors.header-bg}"
  present_detail: "P (Present)" {
    width: 180
    style.fill: "${colors.present}"
    style.font-color: white
    present_desc: |md
      **1** = Page in memory
      **0** = Page fault on access
    | {
      style.fill: white
      style.font-color: black
      style.font-size: 11
    }
  }
  rw_detail: "R/W (Read/Write)" {
    width: 180
    style.fill: "${colors.rw}"
    style.font-color: white
    rw_desc: |md
      **1** = Read/Write allowed
      **0** = Read-only
    | {
      style.fill: white
      style.font-color: black
      style.font-size: 11
    }
  }
  us_detail: "U/S (User/Supervisor)" {
    width: 180
    style.fill: "${colors.user}"
    style.font-color: black
    us_desc: |md
      **1** = User-mode accessible
      **0** = Kernel-only (ring 0)
    | {
      style.fill: white
      style.font-color: black
      style.font-size: 11
    }
  }
  cache_detail: "PWT / PCD (Cache)" {
    width: 180
    style.fill: "${colors.cache}"
    style.font-color: black
    cache_desc: |md
      **PWT**: Write-through policy
      **PCD**: Disable caching
    | {
      style.fill: white
      style.font-color: black
      style.font-size: 11
    }
  }
  access_detail: "A (Accessed)" {
    width: 180
    style.fill: "${colors.accessed}"
    style.font-color: white
    access_desc: |md
      Set by CPU on **read**
      (software clears it)
    | {
      style.fill: white
      style.font-color: black
      style.font-size: 11
    }
  }
  dirty_detail: "D (Dirty)" {
    width: 180
    style.fill: "${colors.dirty}"
    style.font-color: white
    dirty_desc: |md
      Set by CPU on **write**
      **PTE only** (not in PDE)
    | {
      style.fill: white
      style.font-color: black
      style.font-size: 11
    }
  }
}
field_details2: {
  direction: right
  style.fill: "#F5F5F5"
  style.stroke: "${colors.header-bg}"
  ps_detail: "PS (Page Size)" {
    width: 180
    style.fill: "${colors.ps}"
    style.font-color: black
    ps_desc: |md
      **PDE only**:
      **0** = 4 KB pages
      **1** = 4 MB pages
    | {
      style.fill: white
      style.font-color: black
      style.font-size: 11
    }
  }
  g_detail: "G (Global)" {
    width: 180
    style.fill: "${colors.global}"
    style.font-color: white
    g_desc: |md
      Not flushed on CR3 reload
      (requires PGE in CR4)
    | {
      style.fill: white
      style.font-color: black
      style.font-size: 11
    }
  }
  avail_detail: "AVAIL (9-11)" {
    width: 180
    style.fill: "${colors.avail}"
    style.font-color: white
    avail_desc: |md
      **3 bits** for OS use
      (e.g., swap, COW flags)
    | {
      style.fill: white
      style.font-color: black
      style.font-size: 11
    }
  }
  frame_detail: "FRAME (12-31)" {
    width: 380
    style.fill: "${colors.frame}"
    style.font-color: black
    frame_desc: |md
      **20-bit** physical frame address
      Shifted left by 12 â†’ 4KB aligned
      `0x00000` to `0xFFFFF` = 0-4GB physical
    | {
      style.fill: white
      style.font-color: black
      style.font-size: 11
    }
  }
}
pde_vs_pte: {
  direction: right
  style.fill: white
  style.stroke: "${colors.header-bg}"
  style.stroke-width: 2
  pde_box: "Page Directory Entry (PDE)" {
    style.fill: "#ECEFF4"
    pde_content: |md
      Points to a **Page Table**
      - **PS=1**: 4MB page (skip PT)
      - **D bit**: Ignored
      - Frame addr = Page Table addr
    | {
      style.fill: white
      style.font-size: 12
    }
  }
  vs_label: |md
    ## vs
  | {
    style.fill: transparent
    style.stroke: none
    style.font-color: "${colors.header-bg}"
  }
  pte_box: "Page Table Entry (PTE)" {
    style.fill: "#ECEFF4"
    pte_content: |md
      Points to a **4KB Frame**
      - **PS bit**: Ignored
      - **D bit**: Set on writes
      - Frame addr = Physical page
    | {
      style.fill: white
      style.font-size: 12
    }
  }
}
code_example: {
  style.fill: "#2E3440"
  style.stroke: none
  code: ||c
    // Page table entry flags
    #define PTE_PRESENT     0x001   // Bit 0
    #define PTE_WRITABLE    0x002   // Bit 1
    #define PTE_USER        0x004   // Bit 2
    #define PTE_WRITETHROUGH 0x008  // Bit 3
    #define PTE_CACHE_DISABLE 0x010 // Bit 4
    #define PTE_ACCESSED    0x020   // Bit 5
    #define PTE_DIRTY       0x040   // Bit 6
    #define PTE_HUGE        0x080   // Bit 7 (4MB page)
    #define PTE_GLOBAL      0x100   // Bit 8
    #define PTE_FRAME       0xFFFFF000  // Bits 12-31
    // Example: Map 0xC0000000 -> 0x00100000, user+rw
    uint32_t pte = 0x00100000 | PTE_PRESENT | PTE_WRITABLE | PTE_USER;
    // Result: 0x00101007
  ||
}
memory_layout: {
  direction: right
  style.fill: "#F9F9F9"
  style.stroke: "${colors.header-bg}"
  layout_title: "32-bit Entry Memory Layout" {
    style.fill: "${colors.header-bg}"
    style.font-color: white
  }
  byte_layout: {
    grid-columns: 4
    grid-gap: 0
    byte3: |md
      **Byte 3**
      `Frame[31:24]`
    | {
      width: 200
      style.fill: "${colors.frame}"
      style.font-color: black
    }
    byte2: |md
      **Byte 2**
      `Frame[23:16]`
    | {
      width: 200
      style.fill: "${colors.frame}"
      style.font-color: black
    }
    byte1: |md
      **Byte 1**
      `AVAIL|G|PS|D|A|PCD|PWT`
    | {
      width: 200
      style.fill: "#E5E5E5"
      style.font-color: black
      style.font-size: 10
    }
    byte0: |md
      **Byte 0**
      `U/S|R/W|P|Frame[11:0]`
    | {
      width: 200
      style.fill: "#E5E5E5"
      style.font-color: black
      style.font-size: 10
    }
  }
  offset_labels: {
    direction: right
    off3: "Offset +3" {
      style.fill: transparent
      style.stroke: none
      width: 200
    }
    off2: "Offset +2" {
      style.fill: transparent
      style.stroke: none
      width: 200
    }
    off1: "Offset +1" {
      style.fill: transparent
      style.stroke: none
      width: 200
    }
    off0: "Offset +0" {
      style.fill: transparent
      style.stroke: none
      width: 200
    }
  }
}
entry_structure -> field_details: "Bit Fields" {
  style.stroke: "${colors.header-bg}"
  style.stroke-dash: 3
}
field_details -> field_details2: {
  style.stroke: transparent
}
legend -> entry_structure: {
  style.stroke: transparent
}