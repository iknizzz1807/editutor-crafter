vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Two-Level x86 Page Table Structure
  **32-bit Virtual Address → Physical Frame Translation**
| {near: top-center}
direction: right
classes: {
  container: {
    style: {
      fill: "#1a1a2e"
      stroke: "#4a4a6a"
      stroke-width: 2
      font-color: "#e0e0e0"
    }
  }
  entry: {
    style: {
      fill: "#16213e"
      stroke: "#0f3460"
      stroke-width: 1
      font: mono
      font-size: 14
      font-color: "#e0e0e0"
    }
  }
  frame: {
    style: {
      fill: "#0d7377"
      stroke: "#14ffec"
      stroke-width: 2
      font-color: "#ffffff"
    }
  }
  bitfield: {
    style: {
      fill: "#2d2d44"
      stroke: "#4a4a6a"
      font: mono
      font-size: 16
      font-color: "#ffffff"
    }
  }
  highlight: {
    style: {
      fill: "#e94560"
      font-color: "#ffffff"
      font: mono
    }
  }
  metadata: {
    style: {
      fill: "#533483"
      stroke: "#7952b3"
      font-color: "#e0e0e0"
      font-size: 12
    }
  }
}
virtual_address: {
  label: "Virtual Address (32-bit)"
  class: container
  va_bits: |md
  ┌─────────────────┬─────────────────┬─────────────────┐
  │   Page Dir      │   Page Table    │    Offset       │
  │    Index        │     Index       │                 │
  │   (10 bits)     │   (10 bits)     │   (12 bits)     │
  │   [31:22]       │   [21:12]       │   [11:0]        │
  └─────────────────┴─────────────────┴─────────────────┘
       1024 entries      1024 entries     4096 bytes
  |
  va_bits.class: bitfield
  va_example: |md
  **Example: Virtual Address `0xC0301004`**
  Binary: 1100 0000 11 | 00 0011 0000 | 0001 0000 0100
          └─────┬────┘ └─────┬─────┘ └──────┬──────┘
            PD Index         PT Index        Offset
              0x303           0x030           0x004
  |
  va_example.class: entry
}
cr3_register: {
  label: "CR3 Register"
  class: container
  width: 180
  cr3_label: |md
  **Page Directory Base**
  (Physical Address)
  |
  cr3_label.class: metadata
  cr3_value: |md
  ┌──────────────────────────────┐
  │  PDBR (Bits 31:12)  │ Ignored │
  │     0x00100000      │  0x000  │
  └──────────────────────────────┘
  |
  cr3_value.class: bitfield
}
page_directory: {
  label: "Page Directory (4KB)"
  class: container
  width: 280
  pd_header: |md
  **1024 entries × 4 bytes = 4096 bytes**
  Aligned to 4KB boundary
  |
  pd_header.class: metadata
  pd_entry_0: |md
  Entry 0 [0x000]: 0x00000000 (Not Present)
  ┌────┬───┬───┬───────┬────────────────┐
  │ P  │RW│U/S│ Other │  Frame Addr    │
  │ 0  │ 0 │ 0 │  ...  │  0x00000       │
  └────┴───┴───┴───────┴────────────────┘
  |
  pd_entry_0.class: entry
  pd_entry_1: |md
  Entry 1 [0x001]: 0x00000000 (Not Present)
  |
  pd_entry_1.class: entry
  pd_entry_2: |md
  Entry 2 [0x002]: 0x00000000 (Not Present)
  |
  pd_entry_2.class: entry
  pd_dots: |md
  ... (entries 3-766) ...
  |
  pd_dots.class: entry
  pd_entry_kern: |md
  Entry 768 [0x300]: 0x00101027
  ┌────┬───┬───┬───────┬────────────────┐
  │ P  │RW│U/S│ G|PS  │  Frame Addr    │
  │ 1  │ 1 │ 0 │ 0|0   │  0x00101       │
  └────┴───┴───┴───────┴────────────────┘
  Points to Page Table at 0x00101000
  |
  pd_entry_kern.class: highlight
  pd_legend: |md
  **P**=Present **RW**=Read/Write **U/S**=User/Supervisor
  **G**=Global **PS**=Page Size (0=4KB)
  |
  pd_legend.class: metadata
}
page_table: {
  label: "Page Table (4KB)"
  class: container
  width: 280
  pt_header: |md
  **1024 entries × 4 bytes = 4096 bytes**
  Each entry maps one 4KB page
  |
  pt_header.class: metadata
  pt_label: {
    label: "PT at 0x00101000 (PD Entry 768)"
    class: highlight
    style.fill: "#533483"
  }
  pt_entry_0: |md
  Entry 0 [0x000]: 0x00103003
  ┌────┬───┬───┬───┬───┬───────────────┐
  │ P  │RW│U/S│ D │ A │  Frame Addr   │
  │ 1  │ 1 │ 0 │ 0 │ 0 │   0x00103     │
  └────┴───┴───┴───┴───┴───────────────┘
  Maps VA 0xC0000000 → PA 0x00103000
  |
  pt_entry_0.class: highlight
  pt_entry_1: |md
  Entry 1 [0x001]: 0x00104003
  Maps VA 0xC0001000 → PA 0x00104000
  |
  pt_entry_1.class: entry
  pt_entry_2: |md
  Entry 2 [0x002]: 0x00105003
  Maps VA 0xC0002000 → PA 0x00105000
  |
  pt_entry_2.class: entry
  pt_dots: |md
  ... (entries 3-1023) ...
  |
  pt_dots.class: entry
  pt_legend: |md
  **D**=Dirty **A**=Accessed
  |
  pt_legend.class: metadata
}
physical_frame: {
  label: "Physical Frame (4KB)"
  class: container
  width: 200
  frame_header: |md
  **Frame at 0x00103000**
  4096 bytes of physical memory
  |
  frame_header.class: metadata
  frame_data: {
    shape: cylinder
    class: frame
    label: "4KB Frame\n0x00103000\n-\n0x00103FFF"
  }
  frame_content: |md
  Offset 0x000: Kernel code
  Offset 0x100: Kernel data
  Offset 0x200: ...
  Offset 0xFFF: (end of frame)
  |
  frame_content.class: entry
}
translation_flow: {
  label: "Translation Steps"
  class: container
  width: 350
  step1: |md
  **1. Extract PD Index [31:22]**
  From VA `0xC0301004`:
  → PD Index = `0x303` (771)
  |
  step1.class: entry
  step2: |md
  **2. Read PDE from CR3 + (PD_Index × 4)**
  CR3 = 0x00100000
  PDE addr = 0x00100000 + (0x303 × 4)
           = 0x00100C0C
  PDE value = 0x00101027
  PT base = 0x00101000
  |
  step2.class: entry
  step3: |md
  **3. Extract PT Index [21:12]**
  From VA `0xC0301004`:
  → PT Index = `0x030` (48)
  |
  step3.class: entry
  step4: |md
  **4. Read PTE from PT + (PT_Index × 4)**
  PT base = 0x00101000
  PTE addr = 0x00101000 + (0x030 × 4)
           = 0x001010C0
  PTE value = 0x00103003
  Frame = 0x00103000
  |
  step4.class: entry
  step5: |md
  **5. Add Offset [11:0] to Frame**
  Frame = 0x00103000
  Offset = 0x004
  **Physical = 0x00103004**
  |
  step5.class: highlight
}
tlb_cache: {
  label: "TLB (Translation Lookaside Buffer)"
  class: container
  width: 220
  tlb_header: |md
  **Cache for recent translations**
  Avoids page table walks
  |
  tlb_header.class: metadata
  tlb_entry: |md
  ┌─────────────────┬─────────────────┐
  │ Virtual Page    │ Physical Frame  │
  ├─────────────────┼─────────────────┤
  │ 0xC0301         │ 0x00103         │
  │ 0xC0000         │ 0x00101         │
  │ ...             │ ...             │
  └─────────────────┴─────────────────┘
  |
  tlb_entry.class: entry
  tlb_note: |md
  **TLB Hit**: ~1-2 cycles
  **TLB Miss**: ~20-100 cycles (page walk)
  **Page Fault**: ~10ms+ (disk I/O)
  |
  tlb_note.class: metadata
}
memory_layout: {
  label: "Process Memory Layout"
  class: container
  width: 250
  layout: |md
  0xFFFFFFFF ┌─────────────────┐
             │ Kernel Space    │ PD[768-1023]
             │ (1GB, Ring 0)   │
  0xC0000000 ├─────────────────┤
             │                 │
             │   User Space    │ PD[0-767]
             │   (3GB, Ring 3) │
             │                 │
  0x00000000 └─────────────────┘
  |
  layout.class: bitfield
}
entry_format: {
  label: "PDE/PTE Entry Format (4 bytes)"
  class: container
  width: 320
  format: |md
       31                              12 11 9 8 7 6 5 4 3 2 1 0
  ┌─────────────────────────────────────┬───┬─┬─┬─┬─┬─┬─┬─┬─┬─┐
  │      Frame/Page Address [31:12]     │Avl│0│0│G│P│D│A│U│R│P│
  │         (20 bits)                   │   │ │ │ │S│ │ │/│/│ │
  └─────────────────────────────────────┴───┴─┴─┴─┴─┴─┴─┴S│W│ │
                                                          │ │ │
  Avl=Available  G=Global  PS=Page Size                  │ │ │
  D=Dirty  A=Accessed  U/S=User/Supervisor  RW=Read/Write│ │ │
                                                        S │ │
  P=Present ───────────────────────────────────────────────┘ │
  |
  format.class: bitfield
}
cr3_register -> page_directory: "CR3 points to\nPage Directory" {
  style: {
    stroke: "#14ffec"
    stroke-width: 3
  }
  source-arrowhead: {
    shape: circle
    style.filled: true
    style.fill: "#14ffec"
  }
}
page_directory -> page_table: "PDE points to\nPage Table" {
  style: {
    stroke: "#e94560"
    stroke-width: 2
    animated: true
  }
}
page_table -> physical_frame: "PTE points to\nPhysical Frame" {
  style: {
    stroke: "#14ffec"
    stroke-width: 2
  }
}
virtual_address -> page_directory: "PD Index [31:22]" {
  style: {
    stroke: "#7952b3"
    stroke-dash: 4
  }
}
virtual_address -> page_table: "PT Index [21:12]" {
  style: {
    stroke: "#7952b3"
    stroke-dash: 4
  }
}
virtual_address -> physical_frame: "Offset [11:0]" {
  style: {
    stroke: "#7952b3"
    stroke-dash: 4
  }
}