vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Enabling Paging: Critical Sequence
  Identity mapping is MANDATORY for the instruction that enables paging
| {near: top-center}

direction: right

classes: {
  critical: {
    style: {
      fill: "#FFE4E1"
      stroke: "#DC143C"
      stroke-width: 3
    }
  }
  safe: {
    style: {
      fill: "#E8F5E9"
      stroke: "#4CAF50"
    }
  }
  step: {
    style: {
      fill: "#E3F2FD"
      stroke: "#1976D2"
      border-radius: 4
    }
  }
  memory: {
    shape: rectangle
    style: {
      fill: "#FFF8E1"
      stroke: "#FF8F00"
      stroke-dash: 3
    }
  }
  warning: {
    style: {
      fill: "#FFEBEE"
      stroke: "#F44336"
      font-color: "#B71C1C"
    }
  }
}

sequence: {
  step1: "1. CREATE IDENTITY MAP\n\nfor (i = 0; i < 4MB; i += 4096)\n  map_page(i, i, PAGE_RW | PAGE_PRESENT)" {
    class: step
    width: 280
  }
  
  step1_note: |md
    - Maps virtual addr â†’ same physical addr
    - At minimum: current code page
    - Better: kernel's full image
    - Requires: 1 PDE + 1024 PTEs (4MB)
| {near: bottom-center}
  
  step2: "2. LOAD CR3\n\nmov eax, page_directory\nmov cr3, eax" {
    class: step
    width: 280
  }
  
  step2_effect: |md
    Sets page directory base
    TLB is NOT yet flushed
    Paging NOT yet active
    Execution continues linear
| {near: bottom-center}
  
  step3: "3. SET CR0.PG BIT\n\nmov eax, cr0\nor eax, 0x80000000\nmov cr0, eax" {
    class: critical
    width: 280
  }
  
  step3_critical: |md
    **CRITICAL INSTRUCTION**
    
    After this executes:
    - Paging is ENABLED
    - Next fetch uses translation
    - If EIP=0x100000 and NOT identity-mapped
    - PAGE FAULT - TRIPLE FAULT
| {near: bottom-center}
  
  step4: "4. CONTINUE EXECUTION\n\n; Paging now active\n; But EIP still points to\n; same physical location\n; because identity map!\n\njmp higher_half_kernel" {
    class: safe
    width: 280
  }
  
  step4_safe: |md
    Safe because:
    Virtual EIP == Physical EIP
    Fetch succeeds, execution continues
    Now can jump to higher half
| {near: bottom-center}
  
  step1 -> step2: "Page tables ready"
  step2 -> step3: "CR3 loaded"
  step3 -> step4: "Paging ON (identity-mapped)"
}

why_identity: {
  label: "Why Identity Mapping is MANDATORY"
  
  scenario: {
    label: "The Problem"
    
    before: {
      label: "Before mov cr0"
      
      cpu_state1: {
        label: |md
          **CPU State:**
          - EIP = 0x100000
          - CR0.PG = 0 (paging OFF)
          - CR3 = (don't care)
          
          **Fetch Logic:**
          - Read instruction at PHYSICAL 0x100000
          - No translation needed
|
      }
      
      physical_view: {
        label: "Physical Memory View"
        class: memory
        
        phys_100k: "0x000000 - 0x0FFFFF: Unused"
        phys_kernel: "0x100000 - 0x200000: Kernel Code" {
          style.fill: "#C8E6C9"
        }
        phys_page_tables: "0x200000 - 0x204000: Page Tables" {
          style.fill: "#BBDEFB"
        }
      }
    }
    
    after: {
      label: "After mov cr0 (NO identity map)"
      
      cpu_state2: {
        label: |md
          **CPU State:**
          - EIP = 0x100000 (unchanged!)
          - CR0.PG = 1 (paging ON)
          - CR3 = 0x200000 (PDE base)
          
          **Fetch Logic:**
          - Virtual 0x100000 = ???
          - PDE[1] = ??? (not mapped!)
          - **PAGE FAULT**
|
        class: warning
      }
      
      page_walk_fail: {
        label: "Page Walk Failure"
        
        cr3_base: "CR3 = 0x200000 (PDE physical base)"
        pde_entry: "PDE[1] = 0x00000000 = NOT PRESENT" {
          class: warning
        }
        fault: "PAGE FAULT! Error code: 0x00 CR2 = 0x100000" {
          style.fill: "#FFCDD2"
        }
        
        cr3_base -> pde_entry: "Index = 0"
        pde_entry -> fault: "Present bit = 0"
      }
    }
    
    before -> after: "mov cr0, eax (sets PG bit)" {
      style: {
        stroke: red
        stroke-width: 3
        animated: true
      }
    }
  }
  
  solution: {
    label: "The Solution: Identity Map"
    
    before_good: {
      label: "Create Identity Mapping First"
      
      identity_code: |md
        // Map first 4MB identity
        for (uint32_t i = 0; i < 1024; i++) {
          uint32_t vaddr = i * 4096;
          uint32_t paddr = i * 4096;
          map_page(vaddr, paddr, PTE_RW | PTE_PRESENT);
        }
|
      
      pde_state: {
        label: "Resulting PDE State"
        
        pde_0: "PDE[0] = 0x200xxx (present)"
        pde_1: "PDE[1] = 0x200xxx (present)"
        pde_other: "PDE[2..1023] = 0 (not present)"
        
        pde_0 -> pde_1
        pde_1 -> pde_other
      }
    }
    
    after_good: {
      label: "After mov cr0 (WITH identity map)"
      
      cpu_state3: {
        label: |md
          **CPU State:**
          - EIP = 0x100000 (still unchanged)
          - CR0.PG = 1 (paging ON)
          - CR3 = 0x200000 (PDE base)
          
          **Fetch Logic:**
          - Virtual 0x100000 = Page walk
          - PDE[0] = 0x200xxx (present!)
          - PTE[256] = 0x100xxx (present!)
          - Physical = 0x100000 SUCCESS
|
        class: safe
      }
      
      page_walk_success: {
        label: "Page Walk Succeeds"
        
        step_a: "1. CR3 = 0x200000"
        step_b: "2. PDE index = 0; PDE[0] = 0x200xxx | 0x003"
        step_c: "3. PTE index = 256; PTE[256] = 0x100000 | 0x003"
        step_d: "4. Physical addr = 0x100000 - SAME as virtual!" {
          class: safe
        }
        
        step_a -> step_b: "read PDE"
        step_b -> step_c: "read PTE"
        step_c -> step_d: "construct phys"
      }
    }
    
    before_good -> after_good: "mov cr0, eax (safe now!)" {
      style: {
        stroke: "#4CAF50"
        stroke-width: 3
      }
    }
  }
}

memory_layout: {
  label: "Memory Layout During Transition"
  
  layout: {
    shape: rectangle
    width: 600
    
    addr_0: |md
      0x00000000 +------------------+
                 |   Unused         |
      0x000FFFFF +------------------+
                 |  Kernel Code     | EIP is here
                 |  (boot.S)        | MUST be identity mapped!
      0x001FFFFF +------------------+
                 |  Page Directory  | CR3 points here
      0x002000FF +------------------+
                 |  Page Tables     | Identity map entries
      0x00200FFF +------------------+
                 |  Available       |
      0xFFFFFFFF +------------------+
|
  }
  
  critical_region: {
    label: "Critical Code Region"
    
    boot_code: |md
      // In boot.S - MUST be identity mapped!
      
      setup_paging:
          call create_identity_map
          mov eax, 0x200000
          mov cr3, eax
      
          // THE DANGEROUS INSTRUCTION
          mov eax, cr0
          or eax, 0x80000000
          mov cr0, eax
          // Identity map saves us here
          
          jmp 0xC0100000
      
      higher_half:
          // Now running at 0xC0100000
|
  }
}

skip_consequences: {
  label: "What Happens If You Skip Identity Mapping"
  
  timeline: {
    t1: "T0: mov cr0, eax executes; Paging enabled"
    t2: "T1: CPU fetches next instruction; EIP = 0x100xxx"
    t3: "T2: MMU walks page tables; PDE[0] = 0 (not present)"
    t4: "T3: PAGE FAULT! Vector 14, error code = 0x00"
    t5: "T4: CPU pushes error code; Looks up IDT[14]"
    t6: "T5: IDT[14] not mapped either! Another page fault"
    t7: "T6: DOUBLE FAULT; IDT[8] handler..."
    t8: "T7: TRIPLE FAULT; CPU shuts down" {
      class: warning
    }
    
    t1 -> t2 -> t3 -> t4 -> t5 -> t6 -> t7 -> t8
  }
  
  recovery: {
    label: "Recovery (in emulator)"
    
    recovery_note: |md
      **Triple fault behavior:**
      - Real hardware: CPU reset (reboot)
      - Bochs/QEMU: Debug output, stop
      - No way to recover in software
      
      **Debugging tips:**
      - Set breakpoint on mov cr0
      - Check PDE[0] before enabling
      - Verify identity map covers EIP
|
  }
}

back_to_map: {
  label: "Back to Satellite View"
  link: "#satellite-system"
  near: top-left
  style: {
    fill: "#E8EAF6"
    stroke: "#3F51B5"
    border-radius: 8
  }
}

sequence.step1 -> why_identity.solution
skip_consequences -> sequence.step3: "AVOID THIS" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}