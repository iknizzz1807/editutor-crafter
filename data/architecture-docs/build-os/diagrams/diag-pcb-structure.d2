vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Process Control Block (PCB): Memory Layout
  **`struct process` — 96+ bytes (implementation dependent)**
| {near: top-center}
direction: right
classes: {
  header: {
    style: {
      fill: "#E8E8E8"
      stroke: "#666666"
      stroke-width: 2
      font: mono
      bold: true
    }
  }
  pid: {
    style: {
      fill: "#FFE4B5"
      stroke: "#CD853F"
    }
  }
  state: {
    style: {
      fill: "#98FB98"
      stroke: "#228B22"
    }
  }
  registers: {
    style: {
      fill: "#ADD8E6"
      stroke: "#4169E1"
    }
  }
  pointers: {
    style: {
      fill: "#DDA0DD"
      stroke: "#8B008B"
    }
  }
  scheduling: {
    style: {
      fill: "#F0E68C"
      stroke: "#BDB76B"
    }
  }
  meta: {
    style: {
      fill: "#E0E0E0"
      stroke: "#808080"
    }
  }
  offset: {
    shape: text
    style: {
      font: mono
      font-color: "#666666"
    }
  }
}
pcb_memory: Process Control Block Memory Layout {
  grid-columns: 3
  grid-gap: 0
  offset_header: "-" {class: offset}
  field_header: "Field" {class: header}
  value_header: "Value / Notes" {class: header}
  o0: "0x00" {class: offset}
  f_pid: "pid: uint32_t" {class: pid}
  v_pid: "Process ID (1, 2, 3, ...)" {class: pid}
  o4: "0x04" {class: offset}
  f_state: "state: uint8_t" {class: state}
  v_state: |md
    0 = UNUSED
    1 = READY
    2 = RUNNING
    3 = BLOCKED
    4 = ZOMBIE
  | {class: state}
  o5: "0x05" {class: offset}
  f_pad1: "padding[3]" {class: meta}
  v_pad1: "Align to 4-byte boundary" {class: meta}
  o8: "0x08" {class: offset}
  f_name: "name[32]: char" {class: meta}
  v_name: "Process name (debug)" {class: meta}
  o40: "0x28" {class: offset}
  f_kstack: "kernel_stack: *" {class: pointers}
  v_kstack: "→ struct cpu_state on k-stack" {class: pointers}
  o44: "0x2C" {class: offset}
  f_pdir: "page_directory: *" {class: pointers}
  v_pdir: "→ struct page_directory" {class: pointers}
  o48: "0x30" {class: offset}
  f_kstack_top: "kernel_stack_top: uint32_t" {class: pointers}
  v_kstack_top: "Top of kernel stack (for TSS.ESP0)" {class: pointers}
  o52: "0x34" {class: offset}
  f_priority: "priority: int" {class: scheduling}
  v_priority: "Scheduling priority (higher = more CPU)" {class: scheduling}
  o56: "0x38" {class: offset}
  f_cputime: "cpu_time: uint64_t" {class: scheduling}
  v_cputime: "Total CPU ticks consumed" {class: scheduling}
  o64: "0x40" {class: offset}
  f_waketime: "wake_time: uint64_t" {class: scheduling}
  v_waketime: "When to wake (if BLOCKED)" {class: scheduling}
  o72: "0x48" {class: offset}
  f_parent: "parent_pid: uint32_t" {class: meta}
  v_parent: "PID of parent process" {class: meta}
  o76: "0x4C" {class: offset}
  f_exitcode: "exit_code: int" {class: meta}
  v_exitcode: "Exit status (for ZOMBIE)" {class: meta}
  o80: "0x50" {class: offset}
  f_next: "next: struct process *" {class: pointers}
  v_next: "→ Next process in run queue" {class: pointers}
  size: "0x54+ (84+ bytes)" {class: offset}
  f_total: "Total Size" {class: header}
  v_total: "Implementation dependent" {class: header}
}
cpu_state: CPU State (Saved on Kernel Stack) {
  grid-columns: 3
  grid-gap: 0
  cs_header: "-" {class: offset}
  cs_field: "Field" {class: header}
  cs_value: "Value / Notes" {class: header}
  cs0: "+0x00" {class: offset}
  cs_gs: "gs, fs, es, ds" {class: registers}
  csv_gs: "Segment registers (pushed by stub)" {class: registers}
  cs16: "+0x10" {class: offset}
  cs_gpr: "edi, esi, ebp, esp" {class: registers}
  csv_gpr: "General purpose (pusha-style)" {class: registers}
  cs32: "+0x20" {class: offset}
  cs_gpr2: "ebx, edx, ecx, eax" {class: registers}
  csv_gpr2: "General purpose (cont.)" {class: registers}
  cs48: "+0x30" {class: offset}
  cs_int: "int_no, err_code" {class: registers}
  csv_int: "Interrupt number, error code" {class: registers}
  cs56: "+0x38" {class: offset}
  cs_cpu: "eip, cs, eflags" {class: registers}
  csv_cpu: "Pushed by CPU automatically" {class: registers}
  cs68: "+0x44" {class: offset}
  cs_user: "useresp, ss" {class: registers}
  csv_user: "Only if from ring 3 (user mode)" {class: registers}
  cs76: "+0x4C" {class: offset}
  cs_total: "Total: 76 bytes (kernel)" {class: header}
  cs_vtotal: "84 bytes (from user mode)" {class: header}
}
legend: Alignment & Notes {
  style.fill: transparent
  note1: |md
    ### Alignment Requirements
    - **struct process**: 4-byte aligned (uint32_t fields)
    - **struct cpu_state**: 4-byte aligned
    - **Page directory**: 4096-byte aligned (`__attribute__((aligned(4096)))`)
    - **Kernel stack**: 4096-byte aligned (one page)
    ### Key Pointers
    - `kernel_stack`: Points INTO the kernel stack at the saved `cpu_state`
    - `kernel_stack_top`: Points to TOP of stack (high address)
    - `page_directory`: Physical address for CR3 load
  | {shape: text}
}
relationships: Pointer Relationships {
  style.fill: transparent
  pcb_node: "struct process pcb" {
    shape: rectangle
    style.fill: "#DDA0DD"
    style.stroke: "#8B008B"
  }
  kstack_mem: "Kernel Stack\n(4KB page)" {
    shape: rectangle
    style.fill: "#ADD8E6"
    style.stroke: "#4169E1"
  }
  pdir_mem: "Page Directory\n(4KB page)" {
    shape: rectangle
    style.fill: "#ADD8E6"
    style.stroke: "#4169E1"
  }
  tss_box: "TSS.ESP0" {
    shape: rectangle
    style.fill: "#FFE4B5"
    style.stroke: "#CD853F"
  }
  pcb_node -> kstack_mem: "kernel_stack\n(points to saved state)" {
    style.stroke: "#4169E1"
    style.stroke-dash: 3
  }
  pcb_node -> pdir_mem: "page_directory\n(for CR3)" {
    style.stroke: "#8B008B"
    style.stroke-dash: 3
  }
  pcb_node -> tss_box: "kernel_stack_top\n(updated every switch)" {
    style.stroke: "#CD853F"
    style.stroke-dash: 3
  }
  kstack_mem.label: "Stack grows down ↓" {near: bottom-center}
}
back: Back to Milestone {
  link: "#build-os-m4"
  shape: text
  style.font-color: "#0066CC"
  near: bottom-left
}