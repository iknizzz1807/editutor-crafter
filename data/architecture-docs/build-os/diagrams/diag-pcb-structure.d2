vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Process Control Block (PCB) Memory Layout
| {near: top-center}

direction: right

legend: {
  near: top-right
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a6a"
  style.border-radius: 8

  header_legend: Header/Metadata
  header_legend.style.fill: "#9b59b6"
  header_legend.style.stroke: "#8e44ad"

  register_legend: Saved Registers
  register_legend.style.fill: "#3498db"
  register_legend.style.stroke: "#2980b9"

  pointer_legend: Pointers/Links
  pointer_legend.style.fill: "#27ae60"
  pointer_legend.style.stroke: "#1e8449"

  kernel_legend: Kernel State
  kernel_legend.style.fill: "#e74c3c"
  kernel_legend.style.stroke: "#c0392b"

  header_legend -- register_legend -- pointer_legend -- kernel_legend: {style.opacity: 0}
}

pcb_structure: PCB Structure (64-byte cache-line aligned) {
  style.fill: "#0d1117"
  style.stroke: "#30363d"
  style.border-radius: 8

  header: |md
    Offset  Field              Size   Description
    ─────────────────────────────────────────────
    0x00    pid                4      Process ID
    0x04    state              4      READY=0|RUNNING=1|BLOCKED=2
    0x08    priority           4      Scheduling priority
    0x0C    flags              4      Process flags
  |
  header.shape: rectangle
  header.style.fill: "#9b59b6"
  header.style.stroke: "#8e44ad"
  header.style.border-radius: 4

  registers: |md
    Offset  Field              Size   Description
    ─────────────────────────────────────────────
    0x10    eip                4      Instruction pointer
    0x14    esp                4      User stack pointer
    0x18    ebp                4      Base pointer
    0x1C    eflags             4      CPU flags
    0x20    eax                4      Return value / temp
    0x24    ebx                4      Syscall arg1
    0x28    ecx                4      Syscall arg2
    0x2C    edx                4      Syscall arg3
    0x30    esi                4      Source index
    0x34    edi                4      Destination index
  |
  registers.shape: rectangle
  registers.style.fill: "#3498db"
  registers.style.stroke: "#2980b9"
  registers.style.border-radius: 4

  kernel_state: |md
    Offset  Field              Size   Description
    ─────────────────────────────────────────────
    0x38    cr3                4      Page directory (PDBR)
    0x3C    kernel_esp         4      Kernel stack pointer
    0x40    kernel_stack_base  4      Kernel stack bottom
    0x44    user_stack_base    4      User stack limit
  |
  kernel_state.shape: rectangle
  kernel_state.style.fill: "#e74c3c"
  kernel_state.style.stroke: "#c0392b"
  kernel_state.style.border-radius: 4

  pointers: |md
    Offset  Field              Size   Description
    ─────────────────────────────────────────────
    0x48    next               4      -> Next PCB in queue
    0x4C    prev               4      -> Prev PCB in queue
    0x50    parent             4      -> Parent PCB
    0x54    children           4      -> Child process list
    0x58    sleep_node         8      -> Wait queue node
    ─────────────────────────────────────────────
    Total:  92 bytes (pad to 128 for alignment)
  |
  pointers.shape: rectangle
  pointers.style.fill: "#27ae60"
  pointers.style.stroke: "#1e8449"
  pointers.style.border-radius: 4

  header -> registers: "saved on interrupt" {
    style.stroke: "#f39c12"
    style.stroke-dash: 3
    style.animated: true
  }
  registers -> kernel_state: "context switch"
  kernel_state -> pointers: "scheduler links"
}

memory_view: Physical Memory Layout {
  style.fill: "#0d1117"
  style.stroke: "#30363d"
  style.border-radius: 8

  cache_line: |md
    +---------------------------------------------+
    | CACHE LINE 0 (64 bytes)                     |
    | +-- pid, state, priority, flags             |
    | +-- eip, esp, ebp, eflags                   |
    +---------------------------------------------+
    | CACHE LINE 1 (64 bytes)                     |
    | +-- eax, ebx, ecx, edx, esi, edi            |
    | +-- cr3, kernel_esp (hot path!)             |
    +---------------------------------------------+
    | CACHE LINE 2 (64 bytes)                     |
    | +-- Pointers (next, prev, lists...)         |
    +---------------------------------------------+
  |
  cache_line.shape: rectangle
  cache_line.style.fill: "#161b22"
  cache_line.style.stroke: "#30363d"
  cache_line.style.font: mono
  cache_line.style.border-radius: 4

  alignment_note: |md
    **Alignment Strategy:**
    - First 64 bytes: Hot data (context switch path)
    - CR3 at offset 0x38: Loaded during every switch
    - Pointers in separate cache line (cold data)
    - Padded to 128 bytes for allocator efficiency
  |
  alignment_note.shape: rectangle
  alignment_note.near: bottom-center
  alignment_note.style.fill: "#21262d"
  alignment_note.style.border-radius: 4
}

pcb_queue: Scheduler Queue (Circular Doubly-Linked) {
  style.fill: "#0d1117"
  style.stroke: "#30363d"
  style.border-radius: 8

  pcb1: PCB[1] {
    style.fill: "#3498db"
    shape: hexagon
  }
  pcb2: PCB[2] {
    style.fill: "#27ae60"
    shape: hexagon
  }
  pcb3: PCB[3] {
    style.fill: "#9b59b6"
    shape: hexagon
  }
  running: RUNNING {
    style.fill: "#e74c3c"
    style.stroke: "#c0392b"
    style.stroke-width: 3
    shape: diamond
  }

  pcb1.next -> pcb2: "next"
  pcb2.next -> pcb3: "next"
  pcb3.next -> pcb1: "next"
  pcb1.prev <- pcb2: "prev"
  pcb2.prev <- pcb3: "prev"
  pcb3.prev <- pcb1: "prev"

  running -> pcb1: "current"
}

pcb_structure -> memory_view: "memory layout"
memory_view -> pcb_queue: "queue structure"

context_switch_flow: Context Switch Assembly {
  style.fill: "#0d1117"
  style.stroke: "#30363d"
  style.border-radius: 8

  asm_code: |go
    // switch_task(prev_pcb, next_pcb)
    // EAX = prev_pcb, EDX = next_pcb

    // 1. Save current context
    mov [eax + 0x10], eip
    mov [eax + 0x14], esp
    mov [eax + 0x18], ebp
    mov [eax + 0x1C], eflags
    mov [eax + 0x20], eax

    // 2. Load new context
    mov cr3, [edx + 0x38]
    mov esp, [edx + 0x3C]

    // 3. Jump to new process
    jmp [edx + 0x10]
  |
  asm_code.shape: rectangle
  asm_code.style.fill: "#161b22"
  asm_code.style.stroke: "#f39c12"
  asm_code.style.font: mono
  asm_code.style.border-radius: 4

  hot_path_note: |md
    **Hot Path (offset 0x10-0x3C):**
    - All context switch data in first 64 bytes
    - Single cache miss per switch (best case)
    - CR3 load at 0x38 is critical path
  |
  hot_path_note.shape: rectangle
  hot_path_note.style.fill: "#21262d"
  hot_path_note.style.border-radius: 4
  hot_path_note.style.stroke: "#f39c12"
  hot_path_note.style.stroke-dash: 2
}

pcb_structure -> context_switch_flow: "offsets used in assembly"