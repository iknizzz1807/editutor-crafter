vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # PIC Remapping: Avoiding Vector Collisions
  **IRQ0 at vector 8 collides with Double Fault exception**
| {near: top-center}
direction: right
classes: {
  danger: {
    style: {
      fill: "#FF6B6B"
      stroke: "#C0392B"
      font-color: white
      bold: true
    }
  }
  safe: {
    style: {
      fill: "#27AE60"
      stroke: "#1E8449"
      font-color: white
      bold: true
    }
  }
  warning: {
    style: {
      fill: "#F39C12"
      stroke: "#D68910"
      font-color: white
      bold: true
    }
  }
  reserved: {
    style: {
      fill: "#BDC3C7"
      stroke: "#7F8C8D"
      font-color: "#2C3E50"
    }
  }
  available: {
    style: {
      fill: "#AED6F1"
      stroke: "#5DADE2"
      font-color: "#1A5276"
    }
  }
  pic_chip: {
    style: {
      fill: "#2C3E50"
      stroke: "#1A252F"
      font-color: white
      border-radius: 8
      shadow: true
    }
  }
  collision_marker: {
    shape: circle
    style: {
      fill: "#E74C3C"
      stroke: "#C0392B"
      font-color: white
      bold: true
    }
  }
}
spacer: "" {style.opacity: 0}
before: {
  label: "BEFORE: Default PIC Mapping\n(COLLISION DANGER)"
}
legend_before: |md
  **Vector 0-31**: CPU Exceptions
  **Vector 32-255**: Available
  **Red = Collision!**
| {
  near: top-center
  style.fill: transparent
  style.font-size: 14
}
master_pic_before: Master PIC {
  class: pic_chip
  irq0_b: "IRQ0 -> Vec 8" {class: danger}
  irq1_b: "IRQ1 -> Vec 9"
  irq2_b: "IRQ2 -> Vec 10"
  irq3_b: "IRQ3 -> Vec 11"
  irq4_b: "IRQ4 -> Vec 12"
  irq5_b: "IRQ5 -> Vec 13" {class: danger}
  irq6_b: "IRQ6 -> Vec 14" {class: danger}
  irq7_b: "IRQ7 -> Vec 15"
  irq0_b -> irq1_b -> irq2_b -> irq3_b -> irq4_b -> irq5_b -> irq6_b -> irq7_b
}
slave_pic_before: Slave PIC {
  class: pic_chip
  irq8_b: "IRQ8 -> Vec 112"
  irq9_b: "IRQ9 -> Vec 113"
  irq10_b: "IRQ10 -> Vec 114"
  irq11_b: "IRQ11 -> Vec 115"
  irq12_b: "IRQ12 -> Vec 116"
  irq13_b: "IRQ13 -> Vec 117" {class: danger}
  irq14_b: "IRQ14 -> Vec 118"
  irq15_b: "IRQ15 -> Vec 119"
  irq8_b -> irq9_b -> irq10_b -> irq11_b -> irq12_b -> irq13_b -> irq14_b -> irq15_b
}
idt_before: IDT Vectors 0-15 {
  style.fill: white
  style.stroke: "#7F8C8D"
  vec0_b: "#0: Divide Error" {class: reserved}
  vec1_b: "#1: Debug" {class: reserved}
  vec2_b: "#2: NMI" {class: reserved}
  vec3_b: "#3: Breakpoint" {class: reserved}
  vec4_b: "#4: Overflow" {class: reserved}
  vec5_b: "#5: BOUNDS" {class: reserved}
  vec6_b: "#6: Invalid Opcode" {class: reserved}
  vec7_b: "#7: Device N/A" {class: reserved}
  vec8_b: "#8: DOUBLE FAULT" {class: danger}
  vec9_b: "#9: Coproc Overrun" {class: reserved}
  vec10_b: "#10: Invalid TSS" {class: reserved}
  vec11_b: "#11: Seg Not Pres" {class: reserved}
  vec12_b: "#12: Stack Fault" {class: reserved}
  vec13_b: "#13: GPF" {class: danger}
  vec14_b: "#14: PAGE FAULT" {class: danger}
  vec15_b: "#15: Reserved" {class: reserved}
  vec0_b -> vec1_b -> vec2_b -> vec3_b -> vec4_b -> vec5_b -> vec6_b -> vec7_b
  vec7_b -> vec8_b -> vec9_b -> vec10_b -> vec11_b -> vec12_b -> vec13_b -> vec14_b -> vec15_b
}
collision_explain: ||md
  ### COLLISION CATASTROPHE
  | IRQ | Default Vector | CPU Exception |
  |-----|---------------|---------------|
  | IRQ0 | 8 | Double Fault |
  | IRQ5 | 13 | GPF |
  | IRQ6 | 14 | Page Fault |
  | IRQ13 | 117 | No collision |
  **Timer tick -> Double Fault?**
  **Keyboard -> Coprocessor Overrun?**
|| {
  near: center-right
  style.fill: "#FADBD8"
  style.stroke: "#E74C3C"
  style.border-radius: 8
}
master_pic_before.irq0_b -> idt_before.vec8_b: "COLLISION!" {
  style.stroke: "#E74C3C"
  style.stroke-width: 3
  style.animated: true
}
master_pic_before.irq5_b -> idt_before.vec13_b: "COLLISION!" {
  style.stroke: "#E74C3C"
  style.stroke-width: 3
  style.animated: true
}
master_pic_before.irq6_b -> idt_before.vec14_b: "COLLISION!" {
  style.stroke: "#E74C3C"
  style.stroke-width: 3
  style.animated: true
}
slave_pic_before -> master_pic_before.irq2_b: "Cascade\n(IRQ2)" {
  style.stroke: "#3498DB"
  style.stroke-dash: 3
}
arrow: "REMAP\nICW1-ICW4\n->" {
  shape: text
  style.font-size: 32
  style.bold: true
  style.font-color: "#27AE60"
}
after: {
  label: "AFTER: Remapped PIC Mapping\n(SAFE)"
}
legend_after: |md
  **Vector 0-31**: CPU Exceptions (unchanged)
  **Vector 32-47**: Hardware IRQs
  **Green = Safe separation**
| {
  near: top-center
  style.fill: transparent
  style.font-size: 14
}
master_pic_after: Master PIC {
  class: pic_chip
  irq0_a: "IRQ0 -> Vec 32\n(Timer)" {class: safe}
  irq1_a: "IRQ1 -> Vec 33\n(Keyboard)" {class: safe}
  irq2_a: "IRQ2 -> Vec 34\n(Cascade)" {class: safe}
  irq3_a: "IRQ3 -> Vec 35\n(COM2)" {class: safe}
  irq4_a: "IRQ4 -> Vec 36\n(COM1)" {class: safe}
  irq5_a: "IRQ5 -> Vec 37\n(LPT2)" {class: safe}
  irq6_a: "IRQ6 -> Vec 38\n(Floppy)" {class: safe}
  irq7_a: "IRQ7 -> Vec 39\n(LPT1)" {class: safe}
  irq0_a -> irq1_a -> irq2_a -> irq3_a -> irq4_a -> irq5_a -> irq6_a -> irq7_a
}
slave_pic_after: Slave PIC {
  class: pic_chip
  irq8_a: "IRQ8 -> Vec 40\n(RTC)" {class: safe}
  irq9_a: "IRQ9 -> Vec 41\n(Free)" {class: available}
  irq10_a: "IRQ10 -> Vec 42\n(Free)" {class: available}
  irq11_a: "IRQ11 -> Vec 43\n(Free)" {class: available}
  irq12_a: "IRQ12 -> Vec 44\n(PS/2 Mouse)" {class: safe}
  irq13_a: "IRQ13 -> Vec 45\n(FPU)" {class: safe}
  irq14_a: "IRQ14 -> Vec 46\n(Primary ATA)" {class: safe}
  irq15_a: "IRQ15 -> Vec 47\n(Secondary ATA)" {class: safe}
  irq8_a -> irq9_a -> irq10_a -> irq11_a -> irq12_a -> irq13_a -> irq14_a -> irq15_a
}
idt_after: IDT Vectors 32-47 {
  style.fill: white
  style.stroke: "#27AE60"
  vec32_a: "#32: Timer IRQ" {class: safe}
  vec33_a: "#33: Keyboard IRQ" {class: safe}
  vec34_a: "#34: Cascade IRQ" {class: safe}
  vec35_a: "#35: COM2 IRQ" {class: safe}
  vec36_a: "#36: COM1 IRQ" {class: safe}
  vec37_a: "#37: LPT2 IRQ" {class: safe}
  vec38_a: "#38: Floppy IRQ" {class: safe}
  vec39_a: "#39: LPT1 IRQ" {class: safe}
  vec40_a: "#40: RTC IRQ" {class: safe}
  vec41_a: "#41: Free" {class: available}
  vec42_a: "#42: Free" {class: available}
  vec43_a: "#43: Free" {class: available}
  vec44_a: "#44: Mouse IRQ" {class: safe}
  vec45_a: "#45: FPU IRQ" {class: safe}
  vec46_a: "#46: Primary ATA" {class: safe}
  vec47_a: "#47: Secondary ATA" {class: safe}
  vec32_a -> vec33_a -> vec34_a -> vec35_a -> vec36_a -> vec37_a -> vec38_a -> vec39_a
  vec39_a -> vec40_a -> vec41_a -> vec42_a -> vec43_a -> vec44_a -> vec45_a -> vec46_a -> vec47_a
}
safe_explain: ||md
  ### SAFE SEPARATION
  - Exceptions: Vectors 0-31
  - Hardware IRQs: Vectors 32-47
  - No overlap!
  - Timer -> Vector 32 (safe)
  - Keyboard -> Vector 33 (safe)
|| {
  near: center-right
  style.fill: "#D5F5E3"
  style.stroke: "#27AE60"
  style.border-radius: 8
}
master_pic_after.irq0_a -> idt_after.vec32_a: "Safe" {
  style.stroke: "#27AE60"
  style.stroke-width: 2
}
master_pic_after.irq1_a -> idt_after.vec33_a: "Safe" {
  style.stroke: "#27AE60"
  style.stroke-width: 2
}
slave_pic_after -> master_pic_after.irq2_a: "Cascade\n(IRQ2)" {
  style.stroke: "#3498DB"
  style.stroke-dash: 3
}
slave_pic_after.irq8_a -> idt_after.vec40_a: "Safe" {
  style.stroke: "#27AE60"
  style.stroke-width: 2
}
icw_sequence: {
  label: "PIC Initialization Sequence (ICW1-ICW4)"
  style.fill: "#FDFEFE"
  style.stroke: "#2C3E50"
  style.border-radius: 8
  step1: ICW1 {
    style.fill: "#3498DB"
    style.font-color: white
    tooltip: "0x11 = INIT + ICW4 needed"
    cmd1: ||md
      **Port 0x20/0xA0**
      `outb(0x20, 0x11)`
      `outb(0xA0, 0x11)`
      Bit 4=1: Initialize
      Bit 0=1: ICW4 needed
||
  }
  step2: ICW2 {
    style.fill: "#9B59B6"
    style.font-color: white
    tooltip: "Vector offset (0x20 for master, 0x28 for slave)"
    cmd2: ||md
      **Port 0x21/0xA1**
      `outb(0x21, 0x20)` <- Master
      `outb(0xA1, 0x28)` <- Slave
      Master: IRQ0->0x20 (32)
      Slave: IRQ8->0x28 (40)
||
  }
  step3: ICW3 {
    style.fill: "#E67E22"
    style.font-color: white
    tooltip: "Cascade configuration"
    cmd3: ||md
      **Port 0x21/0xA1**
      `outb(0x21, 0x04)` <- Master
      `outb(0xA1, 0x02)` <- Slave
      Master: Slave at IRQ2
      Slave: Identity 2
||
  }
  step4: ICW4 {
    style.fill: "#1ABC9C"
    style.font-color: white
    tooltip: "8086 mode, non-auto EOI"
    cmd4: ||md
      **Port 0x21/0xA1**
      `outb(0x21, 0x01)`
      `outb(0xA1, 0x01)`
      8086 mode
      Non-auto EOI
||
  }
  step1 -> step2 -> step3 -> step4: "Next" {
    style.stroke: "#2C3E50"
    style.stroke-width: 2
  }
}
cascade_detail: {
  label: "Cascade Connection Detail"
  style.fill: "#EBF5FB"
  style.stroke: "#3498DB"
  style.border-radius: 8
  master_cascade: Master PIC {
    style.fill: "#2C3E50"
    style.font-color: white
    m_irq0: IRQ0 (Timer)
    m_irq1: IRQ1 (Kbd)
    m_irq2: IRQ2 (Cascade IN) {class: warning}
    m_irq3: IRQ3
    m_irq4: IRQ4
    m_irq5: IRQ5
    m_irq6: IRQ6
    m_irq7: IRQ7
    m_irq0 -> m_irq1 -> m_irq2 -> m_irq3 -> m_irq4 -> m_irq5 -> m_irq6 -> m_irq7
  }
  slave_cascade: Slave PIC {
    style.fill: "#2C3E50"
    style.font-color: white
    s_irq8: IRQ8 (RTC)
    s_irq9: IRQ9
    s_irq10: IRQ10
    s_irq11: IRQ11
    s_irq12: IRQ12
    s_irq13: IRQ13
    s_irq14: IRQ14
    s_irq15: IRQ15
    s_irq8 -> s_irq9 -> s_irq10 -> s_irq11 -> s_irq12 -> s_irq13 -> s_irq14 -> s_irq15
  }
  slave_cascade -> master_cascade.m_irq2: "INT line -> IRQ2" {
    label: "Slave signals Master\nvia IRQ2"
    style.stroke: "#E67E22"
    style.stroke-width: 3
    style.animated: true
  }
  master_cascade -> cpu_cascade: "Single INT to CPU" {
    style.stroke: "#E74C3C"
    style.stroke-width: 2
  }
  cpu_cascade: CPU {
    shape: diamond
    style.fill: "#E74C3C"
    style.font-color: white
  }
}
code_example: ||c
  void pic_remap(int offset1, int offset2) {
      // Save masks
      uint8_t mask1 = inb(PIC1_DATA);
      uint8_t mask2 = inb(PIC2_DATA);
      // ICW1: Start init
      outb(PIC1_CMD, 0x11);  // 00010001b
      outb(PIC2_CMD, 0x11);
      // ICW2: Vector offsets
      outb(PIC1_DATA, offset1);  // 0x20 (32)
      outb(PIC2_DATA, offset2);  // 0x28 (40)
      // ICW3: Cascade config
      outb(PIC1_DATA, 0x04);  // Slave at IRQ2
      outb(PIC2_DATA, 0x02);  // Slave ID
      // ICW4: 8086 mode
      outb(PIC1_DATA, 0x01);
      outb(PIC2_DATA, 0x01);
      // Restore masks
      outb(PIC1_DATA, mask1);
      outb(PIC2_DATA, mask2);
  }
  // Call during boot:
  pic_remap(0x20, 0x28);
|| {near: bottom-center}