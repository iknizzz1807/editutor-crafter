vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    danger: "#DC2626"
    warning: "#F59E0B"
    success: "#10B981"
    info: "#3B82F6"
    purple: "#8B5CF6"
    gray: "#6B7280"
    bg_light: "#F3F4F6"
  }
}

title: |md
  # PIC Remapping: IRQ to Vector Mapping
| {near: top-center}

direction: right

section_before: BEFORE REMAP (Problem) {
  style.fill: "${colors.bg_light}"
  style.stroke: "${colors.danger}"
  style.stroke-dash: 4
  
  before_label: |md
    **Default BIOS Mapping**
    IRQs 0-7 → Vectors 0x08-0x0F
    IRQs 8-15 → Vectors 0x70-0x77
  |
  
  default_master: Master PIC (8259A) {
    style.fill: white
    style.stroke: "${colors.danger}"
    
    irq0: IRQ0 (Timer) {
      style.fill: "${colors.danger}"
      style.font-color: white
    }
    irq1: IRQ1 (Keyboard)
    irq2: IRQ2 (Cascade)
    irq3_7: IRQ3-7 {
      style.fill: "${colors.gray}"
      style.font-color: white
    }
  }
  
  default_slave: Slave PIC (8259A) {
    style.fill: white
    style.stroke: "${colors.warning}"
    
    irq8_15: IRQ8-15 (RTC, etc) {
      style.fill: "${colors.gray}"
      style.font-color: white
    }
  }
  
  default_vectors: IDT Vectors {
    style.fill: white
    
    vec8: Vector 0x08 {
      style.fill: "${colors.danger}"
      style.font-color: white
    }
    vec8_label: "Double Fault!"
    vec_df: Vector 8 = Double Fault {
      style.fill: "${colors.purple}"
      style.font-color: white
    }
  }
  
  conflict_box: ⚠️ CONFLICT {
    style.fill: "${colors.danger}"
    style.font-color: white
    style.bold: true
  }
  
  default_master.irq0 -> default_vectors.vec8: "maps to" {
    style.stroke: "${colors.danger}"
    style.stroke-width: 3
    style.animated: true
  }
  
  default_vectors.vec8 -- conflict_box: "Same vector!" {
    style.stroke: "${colors.danger}"
    style.stroke-dash: 3
  }
  
  default_slave.irq8_15 -> default_vectors: "0x70-0x77" {
    style.stroke: "${colors.warning}"
    style.stroke-dash: 3
  }
  
  default_master.irq2 -> default_slave: "INT line" {
    style.stroke: "${colors.purple}"
    style.stroke-width: 2
  }
}

section_after: AFTER REMAP (Solution) {
  style.fill: "${colors.bg_light}"
  style.stroke: "${colors.success}"
  
  after_label: |md
    **Remapped Mapping**
    IRQs 0-7 → Vectors 0x20-0x27 (32-39)
    IRQs 8-15 → Vectors 0x28-0x2F (40-47)
  |
  
  remap_master: Master PIC (8259A) {
    style.fill: white
    style.stroke: "${colors.success}"
    
    irq0_r: IRQ0 (Timer) {
      style.fill: "${colors.success}"
      style.font-color: white
    }
    irq1_r: IRQ1 (Keyboard)
    irq2_r: IRQ2 (Cascade) {
      style.fill: "${colors.info}"
    }
    irq3_7_r: IRQ3-7
  }
  
  remap_slave: Slave PIC (8259A) {
    style.fill: white
    style.stroke: "${colors.info}"
    
    irq8_r: IRQ8 (RTC)
    irq9_15_r: IRQ9-15
  }
  
  remap_vectors: IDT Vectors {
    style.fill: white
    
    vec32: Vector 0x20 (32) {
      style.fill: "${colors.success}"
      style.font-color: white
    }
    vec33: Vector 0x21 (33)
    vec40: Vector 0x28 (40)
    vec_user: Vectors 0-31 {
      style.fill: "${colors.purple}"
      style.font-color: white
      label: "CPU Exceptions\n(Reserved)"
    }
  }
  
  remap_master.irq0_r -> remap_vectors.vec32: "IRQ0 → 0x20" {
    style.stroke: "${colors.success}"
    style.stroke-width: 3
    style.animated: true
  }
  
  remap_master.irq1_r -> remap_vectors.vec33: "IRQ1 → 0x21" {
    style.stroke: "${colors.info}"
  }
  
  remap_master.irq2_r -> remap_slave: "cascade\n(INT)" {
    style.stroke: "${colors.info}"
    style.stroke-width: 2
  }
  
  remap_slave.irq8_r -> remap_vectors.vec40: "IRQ8 → 0x28" {
    style.stroke: "${colors.info}"
  }
}

section_flow: EOI Flow {
  style.fill: white
  
  flow_title: End-of-Interrupt Flow {
    style.bold: true
  }
  
  eoi_steps: {
    shape: sequence_diagram
    
    cpu
    master_pic: Master PIC
    slave_pic: Slave PIC
    
    irq_from_slave: "IRQ from device (8-15)" {
      style.stroke: "${colors.info}"
    }
    
    slave_pic.a -> cpu.a: "INT signal"
    cpu.a -> slave_pic.a: "read vector"
    slave_pic.a -> master_pic.a: "cascade via IRQ2"
    
    handler: "ISR runs" {
      style.stroke: "${colors.success}"
    }
    
    cpu.b -> slave_pic.b: "outb(0x20, 0xA0)"
    cpu.c -> master_pic.b: "outb(0x20, 0x20)"
    
    note: "Must send EOI to BOTH\nif IRQ came from slave!"
  }
}

init_sequence: Initialization Sequence {
  style.fill: "${colors.bg_light}"
  style.stroke: "${colors.purple}"
  
  init_title: |md
    **ICW1-ICW4 Initialization**
  |
  
  icw_grid: {
    grid-columns: 1
    grid-gap: 0
    
    icw1: |md
      `ICW1` (0x20/0xA0): 0x11
      - IC4=1 (need ICW4)
      - SNGL=0 (cascade mode)
      - LTIM=0 (edge triggered)
    |
    
    icw2_m: |md
      `ICW2` Master (0x21): 0x20
      - Vector base = 32 (0x20)
      - IRQ0 → Vector 32, IRQ1 → 33...
    |
    
    icw2_s: |md
      `ICW2` Slave (0xA1): 0x28
      - Vector base = 40 (0x28)
      - IRQ8 → Vector 40, IRQ9 → 41...
    |
    
    icw3_m: |md
      `ICW3` Master (0x21): 0x04
      - Bit 2 set: IR2 connects to slave
    |
    
    icw3_s: |md
      `ICW3` Slave (0xA1): 0x02
      - Slave ID = 2 (connected to IR2)
    |
    
    icw4: |md
      `ICW4` (0x21/0xA1): 0x01
      - 8086 mode (not MCS-80/85)
    |
  }
}

cascade_detail: Cascade Connection {
  style.fill: white
  
  cascade_title: PIC Cascade Wiring {
    style.bold: true
  }
  
  master_ports: Master PIC Ports {
    style.fill: "${colors.success}"
    style.font-color: white
    
    cmd_m: 0x20 (Command)
    data_m: 0x21 (Data)
  }
  
  slave_ports: Slave PIC Ports {
    style.fill: "${colors.info}"
    style.font-color: white
    
    cmd_s: 0xA0 (Command)
    data_s: 0xA1 (Data)
  }
  
  cascade_wire: INT Output → IRQ2 {
    style.fill: "${colors.purple}"
    style.font-color: white
    label: "Slave INT pin connects\nto Master IRQ2 pin"
  }
  
  slave_ports -> cascade_wire -> master_ports {
    style.stroke: "${colors.purple}"
    style.stroke-width: 3
    style.animated: true
  }
}

legend: {
  near: bottom-center
  
  leg_title: Legend
  leg_danger: Conflict/Danger {
    style.fill: "${colors.danger}"
    style.font-color: white
  }
  leg_success: Remapped/Safe {
    style.fill: "${colors.success}"
    style.font-color: white
  }
  leg_info: Data Flow {
    style.fill: "${colors.info}"
    style.font-color: white
  }
  leg_purple: CPU Reserved {
    style.fill: "${colors.purple}"
    style.font-color: white
  }
}

section_before -> section_after: "Remap\nFixes\nConflict" {
  style.stroke: "${colors.success}"
  style.stroke-width: 4
  style.bold: true
}

section_after -> section_flow: "Handling\nInterrupts" {
  style.stroke: "${colors.info}"
  style.stroke-dash: 3
}

section_flow -> init_sequence: "Setup\nCode" {
  style.stroke: "${colors.purple}"
  style.stroke-dash: 3
}