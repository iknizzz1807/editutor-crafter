vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # x86 Privilege Rings: Ring 0 vs. Ring 3
  CPU Protection Model and Current Privilege Level (CPL)
| {near: top-center}

direction: right

rings: {
  grid-columns: 1
  grid-gap: 0
  
  ring0_outer: {
    grid-columns: 1
    style.fill: "#E8F5E9"
    style.stroke: "#2E7D32"
    style.stroke-width: 3
    
    ring0_label: |md
      **RING 0 — Kernel Mode**
      *Maximum Privilege*
    | {shape: text}
    
    ring1_outer: {
      grid-columns: 1
      style.fill: "#C8E6C9"
      style.stroke: "#2E7D32"
      style.stroke-width: 2
      
      ring1_label: |md
        **RING 1** (Unused in modern OS)
      | {shape: text}
      
      ring2_outer: {
        grid-columns: 1
        style.fill: "#A5D6A7"
        style.stroke: "#2E7D32"
        style.stroke-width: 2
        
        ring2_label: |md
          **RING 2** (Unused in modern OS)
        | {shape: text}
        
        ring3_outer: {
          grid-columns: 1
          style.fill: "#FFCDD2"
          style.stroke: "#C62828"
          style.stroke-width: 3
          
          ring3_label: |md
            **RING 3 — User Mode**
            *Minimum Privilege*
          | {shape: text}
        }
      }
    }
  }
}

ring0_capabilities: {
  label: Ring 0 Capabilities
  style.fill: "#E8F5E9"
  style.stroke: "#2E7D32"
  
  cap1: |md
    ✓ **Full Hardware Access**
    All physical memory addressable
  |
  cap2: |md
    ✓ **All I/O Ports**
    Can access any port (0x00-0xFFFF)
  |
  cap3: |md
    ✓ **Privileged Instructions**
    CLI, STI, HLT, INVLPG, MOV CRx
  |
  cap4: |md
    ✓ **Control Registers**
    Can modify CR0, CR2, CR3, CR4
  |
  cap5: |md
    ✓ **GDT/IDT Management**
    LGDT, LIDT, LLDT, LTR
  |
  cap6: |md
    ✓ **Page Table Control**
    Read/write any PTE/PDE
  |
}

ring3_capabilities: {
  label: Ring 3 Restrictions
  style.fill: "#FFCDD2"
  style.stroke: "#C62828"
  
  rest1: |md
    ✗ **Limited Memory Access**
    Only user-pages (U/S=1)
  |
  rest2: |md
    ✗ **I/O Restricted**
    IOPPL check against IOPL
  |
  rest3: |md
    ✗ **Privileged Instructions Fault**
    Triggers #GP (General Protection)
  |
  rest4: |md
    ✗ **Cannot Modify Control Regs**
    MOV CRx causes #GP
  |
  rest5: |md
    ✗ **Cannot Load GDT/IDT**
    LGDT/LIDT causes #GP
  |
  rest6: |md
    ✗ **Page Table Read-Only**
    Cannot modify page tables
  |
}

cs_register: {
  style.fill: "#E3F2FD"
  style.stroke: "#1565C0"
  
  cs_title: **CS Register (Code Segment)**
  
  cs_bits: {
    grid-columns: 5
    grid-gap: 0
    
    bits_31_16: |md
      **Bits 31-16**
      Segment Base
      (in descriptor)
    |
    bits_15_3: |md
      **Bits 15-3**
      Index into GDT
    |
    ti: |md
      **TI**
      Table
      Indicator
    |
    rpl: |md
      **Bits 1-0**
      **RPL / CPL**
      Requested
      Privilege
    |
  }
  
  cpl_box: {
    style.fill: "#BBDEFB"
    style.stroke: "#1565C0"
    
    cpl_title: **Current Privilege Level (CPL)**
    
    cpl_values: {
      grid-columns: 2
      grid-gap: 10
      
      cpl_0: |md
        **CPL = 00** (Ring 0)
        Kernel mode
        Full privileges
      |
      cpl_3: |md
        **CPL = 11** (Ring 3)
        User mode
        Restricted
      |
    }
  }
  
  cpl_note: |md
    CPL = CS[1:0]
    CPU checks CPL on every
    privileged operation
  | {shape: text}
}

selector_examples: {
  style.fill: "#FFF3E0"
  style.stroke: "#E65100"
  
  sel_title: **Segment Selector Examples**
  
  sel_table: {
    grid-columns: 3
    grid-gap: 5
    
    sel_header1: **Selector**
    sel_header2: **Binary**
    sel_header3: **Meaning**
    
    sel1_val: 0x08
    sel1_bin: "0000 1000"
    sel1_mean: |md
      Index=1, RPL=0
      Kernel code (Ring 0)
    |
    
    sel2_val: 0x10
    sel2_bin: "0001 0000"
    sel2_mean: |md
      Index=2, RPL=0
      Kernel data (Ring 0)
    |
    
    sel3_val: 0x1B
    sel3_bin: "0001 1011"
    sel3_mean: |md
      Index=3, RPL=3
      User code (Ring 3)
    |
    
    sel4_val: 0x23
    sel4_bin: "0010 0011"
    sel4_mean: |md
      Index=4, RPL=3
      User data (Ring 3)
    |
  }
}

privilege_check: {
  style.fill: "#F3E5F5"
  style.stroke: "#7B1FA2"
  
  check_title: **Privilege Check on Memory Access**
  
  check_flow: {
    check1: |md
      1. CPU reads CPL from CS[1:0]
    |
    check2: |md
      2. Read PTE/PDE DPL (U/S bit)
    |
    check3: |md
      3. If CPL > DPL → #PF (Page Fault)
    |
    check4: |md
      4. Ring 0 (CPL=0) can access any page
    |
    check5: |md
      5. Ring 3 (CPL=3) only accesses U/S=1 pages
    |
  }
  
  check_note: |md
    DPL 0 = Supervisor (kernel only)
    DPL 3 = User (accessible by all)
  | {shape: text}
}

protection_fault: {
  style.fill: "#FFEBEE"
  style.stroke: "#B71C1C"
  
  fault_title: **#GP — General Protection Fault (Vector 13)**
  
  fault_causes: {
    grid-columns: 1
    
    cause1: |md
      • Executing CLI/STI with CPL > IOPL
    |
    cause2: |md
      • Executing IN/OUT to restricted port
    |
    cause3: |md
      • Loading kernel segment with CPL=3
    |
    cause4: |md
      • Writing to read-only segment
    |
    cause5: |md
      • Executing privileged instruction in Ring 3
    |
  }
  
  fault_result: |md
    Result: CPU pushes error code,
    jumps to IDT[13] handler
  | {shape: text}
}

transition_mechanism: {
  style.fill: "#E0F7FA"
  style.stroke: "#006064"
  
  trans_title: **Privilege Transitions**
  
  trans_up: {
    style.fill: "#B2EBF2"
    
    up_label: **Ring 3 → Ring 0 (Privilege Elevation)**
    up_method: |md
      Via INT instruction or SYSCALL:
      • CPU loads CS from IDT gate (DPL=0)
      • CPU loads SS:ESP from TSS (SS0:ESP0)
      • Handler runs at CPL=0
    |
  }
  
  trans_down: {
    style.fill: "#80DEEA"
    
    down_label: **Ring 0 → Ring 3 (Return to User)**
    down_method: |md
      Via IRET instruction:
      • Pops CS with RPL=3 from stack
      • Pops SS:ESP (user stack pointer)
      • CPL becomes 3
    |
  }
  
  tss_note: |md
    **TSS Required**: ESP0/SS0 fields
    tell CPU where kernel stack lives
    for each process
  | {shape: text}
}

rings.ring0_outer -> ring0_capabilities: Ring 0 {
  style.stroke: "#2E7D32"
}
rings.ring0_outer.ring1_outer.ring2_outer.ring3_outer -> ring3_capabilities: Ring 3 {
  style.stroke: "#C62828"
}

cs_register -> selector_examples: Encoded in {
  style.stroke: "#1565C0"
}
cs_register -> privilege_check: Determines {
  style.stroke: "#1565C0"
}
privilege_check -> protection_fault: "Violation →" {
  style.stroke: "#7B1FA2"
}
transition_mechanism -> cs_register: Modifies CPL {
  style.stroke: "#006064"
}

legend: {
  near: bottom-center
  style.fill: transparent
  
  leg_ring0: "Ring 0 = Full Access" {style.fill: "#E8F5E9"}
  leg_ring3: "Ring 3 = Restricted" {style.fill: "#FFCDD2"}
  leg_cpl: "CPL = CS bits [1:0]" {style.fill: "#E3F2FD"}
}