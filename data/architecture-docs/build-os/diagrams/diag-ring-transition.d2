vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Ring 3 → Ring 0 Transition: Stack Switch
  CPU privilege level change via TSS on interrupt/syscall
| {near: top-center}

direction: right

BEFORE: {
  label: "BEFORE"
  style.fill: "#e8f5e9"
  style.stroke: "#2e7d32"
  style.stroke-width: 3
  
  user_mode: {
    label: "User Mode (Ring 3)"
    style.fill: "#c8e6c9"
    style.stroke: "#388e3c"
    
    cpu_state: {
      label: "CPU State"
      style.fill: white
      
      cs: "CS = 0x1B (CPL=3)"
      ss_val: "SS = 0x23"
      esp_val: "ESP = 0xBFFFF000"
      eip_val: "EIP = user_code"
    }
    
    ring3_stack: {
      label: "Ring 3 Stack\n(SS:ESP)"
      shape: cylinder
      style.fill: "#a5d6a7"
      style.stroke: "#2e7d32"
      
      stack_content: |md
        0xBFFFF000: local_var_1
        0xBFFFF004: local_var_2
        0xBFFFF008: return_addr
        ← ESP
      |
    }
  }
  
  tss_before: {
    label: "TSS (Task State Segment)"
    style.fill: "#fff9c4"
    style.stroke: "#f57f17"
    
    ss0: "SS0 = 0x10 (kernel data)"
    esp0: "ESP0 = 0xC00FF000 (kernel stack)"
  }
  
  trigger: {
    label: "TRIGGER"
    shape: diamond
    style.fill: "#ffcdd2"
    style.stroke: "#c62828"
    
    event: |md
      int 0x80
      OR
      Timer Interrupt
      (IRQ0 → IDT[32])
    |
  }
}

arrow_before: {
  label: "CPU detects\nprivilege change\n(CPL 3 → 0)"
  style.stroke: "#c62828"
  style.stroke-width: 3
  style.animated: true
}

AFTER: {
  label: "AFTER"
  style.fill: "#ffebee"
  style.stroke: "#c62828"
  style.stroke-width: 3
  
  kernel_mode: {
    label: "Kernel Mode (Ring 0)"
    style.fill: "#ffcdd2"
    style.stroke: "#c62828"
    
    cpu_state_kern: {
      label: "CPU State"
      style.fill: white
      
      cs_kern: "CS = 0x08 (CPL=0)"
      ss_kern: "SS = 0x10"
      esp_kern: "ESP = 0xC00FEEE0"
      eip_kern: "EIP = isr_handler"
    }
    
    ring0_stack: {
      label: "Ring 0 Stack\n(SS0:ESP0)"
      shape: cylinder
      style.fill: "#ef9a9a"
      style.stroke: "#c62828"
      
      stack_content_kern: |md
        0xC00FEEE0: SS (0x23)     ← ESP
        0xC00FEEE4: ESP (0xBFFFF000)
        0xC00FEEE8: EFLAGS
        0xC00FEEEC: CS (0x1B)
        0xC00FEF00: EIP (user_code)
        0xC00FEF04: (error code if any)
        --- bottom of kernel stack ---
      |
    }
  }
  
  tss_after: {
    label: "TSS (unchanged)"
    style.fill: "#fff9c4"
    style.stroke: "#f57f17"
    style.opacity: 0.5
    
    ss0_a: "SS0 = 0x10"
    esp0_a: "ESP0 = 0xC00FF000"
  }
}

process_flow: {
  label: "Stack Switch Sequence"
  near: bottom-center
  
  step1: "1. CPU reads TSS.SS0:ESP0" {shape: text}
  step2: "2. Saves user SS:ESP to kernel stack" {shape: text}
  step3: "3. Loads SS:ESP from TSS (switch!)" {shape: text}
  step4: "4. Pushes CS:EIP, EFLAGS to kernel stack" {shape: text}
  step5: "5. Loads CS:EIP from IDT gate" {shape: text}
  step6: "6. Now executing in Ring 0!" {shape: text; style.bold: true; style.font-color: "#c62828"}
  
  step1 -> step2 -> step3 -> step4 -> step5 -> step6: {
    style.stroke: "#666"
    style.stroke-dash: 3
  }
}

BEFORE -> arrow_before
arrow_before -> AFTER

BEFORE.user_mode.cpu_state -> BEFORE.trigger: "syscall\ninstruction" {
  style.stroke: "#1565c0"
  style.animated: true
  style.stroke-width: 2
}

legend: {
  near: top-right
  style.fill: "#f5f5f5"
  style.stroke: "#999"
  
  ring3: "Ring 3 (User)" {
    style.fill: "#c8e6c9"
  }
  ring0: "Ring 0 (Kernel)" {
    style.fill: "#ffcdd2"
  }
  tss_leg: "TSS" {
    style.fill: "#fff9c4"
  }
}

back_link: "← Back to Satellite Map" {
  link: "#ring-transitions"
  near: top-left
  style.font-color: "#1565c0"
  style.underline: true
}