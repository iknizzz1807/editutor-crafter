vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # OS Kernel: Full System Atlas
  Bootstrap → Protected Mode → Interrupts → Memory → Scheduling → Syscall
| {near: top-center}

legend: {
  near: bottom-right
  label: "Legend"
  style: {
    fill: "#1a1a2e"
    stroke: "#444466"
    border-radius: 8
    font-size: 12
  }
  l1: "■ Red    = Hot path / danger" {
    shape: text
    style.font-color: "#ff6b6b"
    style.font-size: 11
  }
  l2: "■ Green  = Safe / success" {
    shape: text
    style.font-color: "#6bcb77"
    style.font-size: 11
  }
  l3: "■ Yellow = Waiting / caution" {
    shape: text
    style.font-color: "#ffd93d"
    style.font-size: 11
  }
  l4: "■ Blue   = Data read / flow" {
    shape: text
    style.font-color: "#4db8ff"
    style.font-size: 11
  }
  l5: "■ Purple = Metadata / struct" {
    shape: text
    style.font-color: "#c084fc"
    style.font-size: 11
  }
  l6: "■ Gray   = Unused / padding" {
    shape: text
    style.font-color: "#888888"
    style.font-size: 11
  }
}

hw: "HARDWARE & BIOS LAYER\n(Physical Reality — CPU at reset = 16-bit real mode)" {
  style: {
    fill: "#1a0a0a"
    stroke: "#ff6b6b"
    stroke-width: 3
    border-radius: 10
    font-color: "#ff6b6b"
    font-size: 14
    bold: true
  }

  cpu_reset: "CPU RESET VECTOR\n0xFFFFFFF0 (ROM)\n16-bit real mode\nAll registers undefined" {
    style: {
      fill: "#3d0000"
      stroke: "#ff6b6b"
      stroke-width: 2
      border-radius: 6
      font-color: "#ff9999"
      font-size: 11
    }
  }

  bios_post: "BIOS POST\nPower-On Self-Test\nMemory probe • Device enum\nBoot device selection" {
    style: {
      fill: "#2a0000"
      stroke: "#cc4444"
      border-radius: 6
      font-color: "#ff9999"
      font-size: 11
    }
  }

  e820: "E820 MEMORY MAP\nPhysical RAM layout\nUsable • Reserved • ACPI\nHoles for MMIO/ROM" {
    style: {
      fill: "#2a0000"
      stroke: "#cc4444"
      border-radius: 6
      font-color: "#ff9999"
      font-size: 11
    }
  }

  pit_hw: "PIT CHIP (8253)\n1,193,182 Hz clock\nChannel 0 → IRQ0\nDivisor → frequency" {
    style: {
      fill: "#2a0000"
      stroke: "#cc4444"
      border-radius: 6
      font-color: "#ff9999"
      font-size: 11
    }
  }

  pic_hw: "8259 PIC (x2)\nMaster: IRQ 0-7\nSlave: IRQ 8-15\nDefault map COLLIDES with exceptions" {
    style: {
      fill: "#3d0000"
      stroke: "#ff4444"
      stroke-width: 2
      border-radius: 6
      font-color: "#ff6b6b"
      font-size: 11
    }
  }

  ps2_hw: "PS/2 KEYBOARD\nPort 0x60 data\nPort 0x64 status\nScancode Set 1" {
    style: {
      fill: "#2a0000"
      stroke: "#cc4444"
      border-radius: 6
      font-color: "#ff9999"
      font-size: 11
    }
  }

  vga_hw: "VGA TEXT BUFFER\nMMIO: 0xB8000\n80x25 cells - 2 bytes/cell\nChar | Attribute" {
    style: {
      fill: "#2a0000"
      stroke: "#cc4444"
      border-radius: 6
      font-color: "#ff9999"
      font-size: 11
    }
  }

  serial_hw: "SERIAL UART\nCOM1: 0x3F8\nPort-mapped I/O\n38400 baud debug" {
    style: {
      fill: "#2a0000"
      stroke: "#cc4444"
      border-radius: 6
      font-color: "#ff9999"
      font-size: 11
    }
  }

  cpu_reset -> bios_post: "executes firmware\n(real mode, 1MB addr space)" {
    style: {
      stroke: "#ff6b6b"
      font-color: "#ff9999"
      font-size: 10
    }
  }
  bios_post -> e820: "probes RAM\nbuilds memory map" {
    style: {
      stroke: "#cc4444"
      font-color: "#ff9999"
      font-size: 10
    }
  }
}

m1: "MILESTONE 1 — BOOTLOADER, GDT & KERNEL ENTRY" {
  link: "#build-os-m1"
  style: {
    fill: "#0a1a0a"
    stroke: "#6bcb77"
    stroke-width: 3
    border-radius: 10
    font-color: "#6bcb77"
    font-size: 14
    bold: true
  }

  mbr: "STAGE 1 MBR\n0x7C00 physical\n512 bytes total\nSig: 0x55 0xAA @ bytes 510-511" {
    style: {
      fill: "#002200"
      stroke: "#6bcb77"
      stroke-width: 2
      border-radius: 6
      font-color: "#aaffaa"
      font-size: 11
    }
  }

  stage2: "STAGE 2 BOOTLOADER\n0x7E00 physical\nA20 enable • INT 13h disk read\nLoad kernel to 0x100000" {
    style: {
      fill: "#001a00"
      stroke: "#44aa44"
      border-radius: 6
      font-color: "#aaffaa"
      font-size: 11
    }
  }

  gdt: "GDT — GLOBAL DESCRIPTOR TABLE\n5 entries x 8 bytes = 40 bytes\nNull • KCode(0x08) • KData(0x10)\nUCode(0x18) • UData(0x20)\nDPL encodes ring 0 vs ring 3" {
    style: {
      fill: "#001a00"
      stroke: "#44aa44"
      stroke-width: 2
      border-radius: 6
      font-color: "#aaffaa"
      font-size: 11
    }
  }

  pm_switch: "PROTECTED MODE SWITCH\n1. cli (mask interrupts)\n2. lgdt [gdt_descriptor]\n3. mov cr0, cr0|1 (CR0.PE=1)\n4. jmp 0x08:pm_entry (far jmp)" {
    style: {
      fill: "#003300"
      stroke: "#6bcb77"
      stroke-width: 2
      border-radius: 6
      font-color: "#66ff66"
      font-size: 11
    }
  }

  bss_zero: "KERNEL ENTRY ASM\nZero BSS: rep stosd\nSet ESP = stack_top\ncall kmain()" {
    style: {
      fill: "#001a00"
      stroke: "#44aa44"
      border-radius: 6
      font-color: "#aaffaa"
      font-size: 11
    }
  }

  vga_drv: "VGA TEXT DRIVER\nvolatile uint16_t* 0xB8000\n(char | attr<<8) per cell\nMMIO — volatile mandatory" {
    style: {
      fill: "#001a00"
      stroke: "#44aa44"
      border-radius: 6
      font-color: "#aaffaa"
      font-size: 11
    }
  }

  serial_drv: "SERIAL DEBUG DRIVER\noutb/inb port I/O\nCOM1 init: DLAB • baud • 8N1\nBusy-wait on THRE flag" {
    style: {
      fill: "#001a00"
      stroke: "#44aa44"
      border-radius: 6
      font-color: "#aaffaa"
      font-size: 11
    }
  }

  linker: "LINKER SCRIPT\n. = 0x100000 (identity map)\n.text .rodata .data .bss\n__bss_start / __bss_end symbols" {
    style: {
      fill: "#001a00"
      stroke: "#44aa44"
      border-radius: 6
      font-color: "#aaffaa"
      font-size: 11
    }
  }

  mbr -> stage2: "INT 13h: load 15 sectors\nto 0x7E00, jmp" {
    style: {
      stroke: "#6bcb77"
      font-color: "#aaffaa"
      font-size: 10
    }
  }
  stage2 -> gdt: "build 5 descriptors\nbefore entering PM" {
    style: {
      stroke: "#44aa44"
      font-color: "#aaffaa"
      font-size: 10
    }
  }
  gdt -> pm_switch: "lgdt loads GDTR\n(6-byte: limit + base)" {
    style: {
      stroke: "#44aa44"
      font-color: "#aaffaa"
      font-size: 10
    }
  }
  pm_switch -> bss_zero: "far jmp to 32-bit\nloads all seg regs" {
    style: {
      stroke: "#6bcb77"
      font-color: "#aaffaa"
      font-size: 10
    }
  }
  bss_zero -> vga_drv: "kmain() calls\nvga_clear()" {
    style: {
      stroke: "#44aa44"
      font-color: "#aaffaa"
      font-size: 10
    }
  }
  bss_zero -> serial_drv: "kmain() calls\nserial_init()" {
    style: {
      stroke: "#44aa44"
      font-color: "#aaffaa"
      font-size: 10
    }
  }
  linker -> bss_zero: "provides __bss_start\n__bss_end symbols" {
    style: {
      stroke: "#44aa44"
      font-color: "#aaffaa"
      font-size: 10
      stroke-dash: 4
    }
  }
}

m2: "MILESTONE 2 — IDT, PIC REMAP, TIMER & KEYBOARD" {
  link: "#build-os-m2"
  style: {
    fill: "#0a0a1a"
    stroke: "#4db8ff"
    stroke-width: 3
    border-radius: 10
    font-color: "#4db8ff"
    font-size: 14
    bold: true
  }

  idt: "IDT — INTERRUPT DESCRIPTOR TABLE\n256 gates x 8 bytes = 2048 bytes\nVec 0-31: CPU exceptions (trap gates)\nVec 32-47: IRQs (interrupt gates)\nVec 0x80: syscall (trap, DPL=3)\nlidt [idtr] loads 6-byte IDTR" {
    style: {
      fill: "#000033"
      stroke: "#4db8ff"
      stroke-width: 2
      border-radius: 6
      font-color: "#88ccff"
      font-size: 11
    }
  }

  pic_remap: "PIC REMAP (ICW1-4)\nMaster: IRQ0-7 → vec 32-39\nSlave: IRQ8-15 → vec 40-47\nFix collision: IRQ0 was vec 8 = Double Fault!\nEOI required after every IRQ" {
    style: {
      fill: "#000033"
      stroke: "#ff4444"
      stroke-width: 2
      border-radius: 6
      font-color: "#ff9999"
      font-size: 11
    }
  }

  isr_stubs: "ISR STUBS (NASM)\nISR_NOERR: push 0 (dummy errcode)\nISR_ERR: CPU already pushed errcode\npusha • seg saves • call C handler\npopa • add esp,8 • iret" {
    style: {
      fill: "#00001a"
      stroke: "#2288cc"
      border-radius: 6
      font-color: "#88ccff"
      font-size: 11
    }
  }

  exc_handler: "EXCEPTION HANDLER (C)\ninterrupt_frame_t* passed\nVec 14: read CR2 (faulting addr)\nVec 8: double fault → halt\nDecodes P-W-U error code bits" {
    style: {
      fill: "#00001a"
      stroke: "#2288cc"
      border-radius: 6
      font-color: "#88ccff"
      font-size: 11
    }
  }

  pit_drv: "PIT DRIVER (8253)\nDivisor = 1193182 / 100Hz = 11932\noutb(0x43, 0x36) mode cmd\nIRQ0 → timer_handler\npit_tick_count (volatile)" {
    style: {
      fill: "#00001a"
      stroke: "#2288cc"
      border-radius: 6
      font-color: "#88ccff"
      font-size: 11
    }
  }

  kbd_drv: "KEYBOARD DRIVER\nIRQ1 → keyboard_handler\ninb(0x60) = scancode\nMake (press) vs Break (|0x80)\nCircular buffer 256 bytes\nScancode Set 1 → ASCII table" {
    style: {
      fill: "#00001a"
      stroke: "#2288cc"
      border-radius: 6
      font-color: "#88ccff"
      font-size: 11
    }
  }

  irq_dispatch: "IRQ DISPATCHER (C)\nirq_handlers[16] table\nRoute vec-32 → handler fn\npic_send_eoi(irq)\n(slave+master if IRQ>=8)" {
    style: {
      fill: "#00001a"
      stroke: "#2288cc"
      border-radius: 6
      font-color: "#88ccff"
      font-size: 11
    }
  }

  idt -> isr_stubs: "gate[n].offset = &isr_n\nCPU indexes IDT on interrupt" {
    style: {
      stroke: "#4db8ff"
      font-color: "#88ccff"
      font-size: 10
    }
  }
  isr_stubs -> exc_handler: "vec 0-31:\ncall exception_handler" {
    style: {
      stroke: "#4db8ff"
      font-color: "#88ccff"
      font-size: 10
    }
  }
  isr_stubs -> irq_dispatch: "vec 32-47:\ncall irq_dispatcher" {
    style: {
      stroke: "#4db8ff"
      font-color: "#88ccff"
      font-size: 10
    }
  }
  irq_dispatch -> pit_drv: "IRQ0 → timer_handler\nincrement tick count" {
    style: {
      stroke: "#4db8ff"
      font-color: "#88ccff"
      font-size: 10
    }
  }
  irq_dispatch -> kbd_drv: "IRQ1 → keyboard_handler\nread port 0x60" {
    style: {
      stroke: "#4db8ff"
      font-color: "#88ccff"
      font-size: 10
    }
  }
  pic_remap -> idt: "remap before sti\nto prevent double-fault\ncollision on IRQ0" {
    style: {
      stroke: "#ff6b6b"
      stroke-dash: 4
      font-color: "#ff9999"
      font-size: 10
    }
  }
}

m3: "MILESTONE 3 — PMM, PAGE TABLES & KERNEL HEAP" {
  link: "#build-os-m3"
  style: {
    fill: "#1a0a1a"
    stroke: "#c084fc"
    stroke-width: 3
    border-radius: 10
    font-color: "#c084fc"
    font-size: 14
    bold: true
  }

  pmm: "PHYSICAL MEMORY MANAGER\nBitmap: 1 bit / 4KB frame\n4GB → 128KB bitmap\nStart: all USED (conservative)\nMark usable from E820 map\nMark kernel frames as USED\nSearch hint (next-fit) O(1) amort." {
    style: {
      fill: "#1a0033"
      stroke: "#c084fc"
      stroke-width: 2
      border-radius: 6
      font-color: "#d4a8ff"
      font-size: 11
    }
  }

  paging: "TWO-LEVEL PAGE TABLES (x86-32)\nCR3 → Page Directory (1024 PDEs)\nPDE → Page Table (1024 PTEs)\nPTE → 4KB Physical Frame\nVirt[31:22]=PD idx, [21:12]=PT idx\n[11:0]=byte offset\nFlags: P-R/W-U/S-PCD-A-D-G" {
    style: {
      fill: "#1a0033"
      stroke: "#c084fc"
      stroke-width: 2
      border-radius: 6
      font-color: "#d4a8ff"
      font-size: 11
    }
  }

  identity_map: "IDENTITY MAP\nVirt 0x00000000-0x003FFFFF\n= Phys 0x00000000-0x003FFFFF\nCovers VGA(0xB8000), kernel(0x100000)\nRequired BEFORE CR0.PG=1" {
    style: {
      fill: "#0d0033"
      stroke: "#8844cc"
      border-radius: 6
      font-color: "#d4a8ff"
      font-size: 11
    }
  }

  higher_half: "HIGHER-HALF MAP\nVirt 0xC0000000-0xC03FFFFF\n= Phys 0x00000000-0x003FFFFF\nKernel virtual home (3GB/1GB split)\nDirectory index 768 = 0xC0000000>>22" {
    style: {
      fill: "#0d0033"
      stroke: "#8844cc"
      border-radius: 6
      font-color: "#d4a8ff"
      font-size: 11
    }
  }

  paging_enable: "ENABLE PAGING\n1. mov cr3, pd_phys\n2. mov eax, cr0\n   or  eax, 0x80010000\n   mov cr0, eax  (PG+WP bits)\nTLB flushed automatically\ninvlpg after every PTE change" {
    style: {
      fill: "#330033"
      stroke: "#ff88ff"
      stroke-width: 2
      border-radius: 6
      font-color: "#ffaaff"
      font-size: 11
    }
  }

  tlb: "TLB MANAGEMENT\nL1 DTLB: ~64 entries (hot)\nL2 sTLB: ~512 entries\nTLB miss → 3 extra mem reads\ninvlpg: single-page invalidation\nCR3 reload: full flush (non-global)\nGlobal pages survive CR3 reload" {
    style: {
      fill: "#0d0033"
      stroke: "#8844cc"
      border-radius: 6
      font-color: "#d4a8ff"
      font-size: 11
    }
  }

  pf_handler: "PAGE FAULT HANDLER (vec 14)\nCR2 = faulting virtual address\nError code bits: P - W - U\nP=0: not present (demand page later)\nP=1 U=1: security violation\nHalt now; demand paging in M4+" {
    style: {
      fill: "#1a0033"
      stroke: "#c084fc"
      border-radius: 6
      font-color: "#d4a8ff"
      font-size: 11
    }
  }

  heap: "KERNEL HEAP (kmalloc/kfree)\nHeap start: 0xD0000000 virtual\nFirst-fit linked list allocator\nheap_block_t header per chunk\nmagic=0xDEADBEEF canary\nExpand: pmm_alloc + vmm_map_page\nCoalesce adjacent free blocks" {
    style: {
      fill: "#1a0033"
      stroke: "#c084fc"
      stroke-width: 2
      border-radius: 6
      font-color: "#d4a8ff"
      font-size: 11
    }
  }

  pmm -> identity_map: "provides physical frames\nfor page table entries" {
    style: {
      stroke: "#c084fc"
      font-color: "#d4a8ff"
      font-size: 10
    }
  }
  pmm -> higher_half: "same frames remapped\nat 0xC0000000 virtual" {
    style: {
      stroke: "#c084fc"
      font-color: "#d4a8ff"
      font-size: 10
    }
  }
  identity_map -> paging: "PD[0] → identity_page_table\n(virtual = physical)" {
    style: {
      stroke: "#8844cc"
      font-color: "#d4a8ff"
      font-size: 10
    }
  }
  higher_half -> paging: "PD[768] → kernel_page_table\n(virt 0xC0000000 = phys 0x0)" {
    style: {
      stroke: "#8844cc"
      font-color: "#d4a8ff"
      font-size: 10
    }
  }
  paging -> paging_enable: "CR3 <- phys addr of PD\nthen set CR0.PG" {
    style: {
      stroke: "#ff88ff"
      stroke-width: 2
      font-color: "#ffaaff"
      font-size: 10
    }
  }
  paging_enable -> tlb: "PG=1 → MMU active\nevery PTE change needs invlpg" {
    style: {
      stroke: "#c084fc"
      font-color: "#d4a8ff"
      font-size: 10
    }
  }
  paging -> pf_handler: "PTE.P=0 → CPU raises\nexception 14 with error code" {
    style: {
      stroke: "#8844cc"
      stroke-dash: 4
      font-color: "#d4a8ff"
      font-size: 10
    }
  }
  heap -> pmm: "heap_expand() calls\npmm_alloc_frame()" {
    style: {
      stroke: "#c084fc"
      font-color: "#d4a8ff"
      font-size: 10
    }
  }
  heap -> paging: "heap_expand() calls\nvmm_map_page()" {
    style: {
      stroke: "#c084fc"
      font-color: "#d4a8ff"
      font-size: 10
    }
  }
}

m4: "MILESTONE 4 — PCB, CONTEXT SWITCH, SCHEDULER & SYSCALL" {
  link: "#build-os-m4"
  style: {
    fill: "#1a1a0a"
    stroke: "#ffd93d"
    stroke-width: 3
    border-radius: 10
    font-color: "#ffd93d"
    font-size: 14
    bold: true
  }

  pcb: "PROCESS CONTROL BLOCK\npid • name[32] • state\ncpu_state_t: edi esi ebp esp\n  ebx edx ecx eax\n  eip cs eflags [user_esp user_ss]\npage_directory* (phys CR3)\nkernel_stack[4096] (aligned 16)\nkernel_stack_top • ticks_remaining" {
    style: {
      fill: "#332200"
      stroke: "#ffd93d"
      stroke-width: 2
      border-radius: 6
      font-color: "#ffe88a"
      font-size: 11
    }
  }

  ctx_switch: "CONTEXT SWITCH (NASM)\ncontext_switch_asm(old_esp*, new_esp, new_cr3)\n1. Load all 3 args into regs (before esp change!)\n2. [old_esp_ptr] = esp  (save current stack pos)\n3. esp = new_esp        (pivot to next process stack)\n4. cmp cr3, new_cr3; jne reload  (skip if same PD)\n5. ret → back to irq_common_stub exit path\n   popa • iret restore NEXT process state" {
    style: {
      fill: "#332200"
      stroke: "#ffd93d"
      stroke-width: 2
      border-radius: 6
      font-color: "#ffe88a"
      font-size: 11
    }
  }

  tss: "TSS — TASK STATE SEGMENT\n104 bytes, Intel-defined layout\nTSS.SS0 = 0x10 (kernel data)\nTSS.ESP0 = current proc kernel stack top\nCPU reads ESP0 on EVERY ring3→ring0\nGDT entry 5 (selector 0x28)\nltr 0x28 loads Task Register\ntss_set_kernel_stack() on each switch" {
    style: {
      fill: "#332200"
      stroke: "#ffd93d"
      stroke-width: 2
      border-radius: 6
      font-color: "#ffe88a"
      font-size: 11
    }
  }

  scheduler: "ROUND-ROBIN SCHEDULER\nprocess_table[16] PCB array\ncurrent_process* global\nsched_tick(): decrement ticks\n  → sched_schedule() on expiry\nState: UNUSED→READY→RUNNING\n  RUNNING→BLOCKED / ZOMBIE\nSLICE = 5 ticks x 10ms = 50ms" {
    style: {
      fill: "#333300"
      stroke: "#ffcc00"
      stroke-width: 2
      border-radius: 6
      font-color: "#ffe88a"
      font-size: 11
    }
  }

  proc_init: "PROCESS CREATION\nFake initial stack frame:\n  [irq_return_trampoline]\n  [gs fs es ds] (kernel segs)\n  [pusha regs all=0]\n  [vector=0 errcode=0]\n  [eip=entry cs=0x08]\n  [eflags=0x202 (IF=1)]\n  Ring3 also: [user_esp user_ss]" {
    style: {
      fill: "#332200"
      stroke: "#ffd93d"
      border-radius: 6
      font-color: "#ffe88a"
      font-size: 11
    }
  }

  user_pd: "USER PAGE DIRECTORY\npmm_alloc_frame() for new PD\nCopy PD[768-1023] from kernel\n  (kernel mapped, U/S=0)\nMap user code: 0x00400000\n  PAGE_USER | PAGE_PRESENT\nMap user stack: 0x00BFF000\n  PAGE_USER | PAGE_WRITABLE\nCR3 = phys addr of user PD" {
    style: {
      fill: "#332200"
      stroke: "#ffd93d"
      border-radius: 6
      font-color: "#ffe88a"
      font-size: 11
    }
  }

  syscall_gate: "SYSCALL INTERFACE (INT 0x80)\nIDT[0x80]: trap gate DPL=3\n  → user code can invoke\n  → IF stays enabled (trap gate)\nEAX=syscall#, EBX/ECX/EDX=args\nSYS_WRITE(4): validate buf in user space\nSYS_EXIT(1): set ZOMBIE, reschedule\nReturn value in EAX" {
    style: {
      fill: "#334400"
      stroke: "#88cc00"
      stroke-width: 2
      border-radius: 6
      font-color: "#ccff88"
      font-size: 11
    }
  }

  ring3_isolation: "RING 3 ISOLATION\nCS=0x1B (user code, DPL=3)\nSS=0x23 (user data, DPL=3)\nPage faults on kernel addr access\n(U/S=0 kernel pages → GPF)\nSMAP/SMEP ready in page flags\nINT 0x80 only controlled entry" {
    style: {
      fill: "#332200"
      stroke: "#ffd93d"
      border-radius: 6
      font-color: "#ffe88a"
      font-size: 11
    }
  }

  pcb -> ctx_switch: "cpu.esp saved/restored\npage_directory → CR3" {
    style: {
      stroke: "#ffd93d"
      font-color: "#ffe88a"
      font-size: 10
    }
  }
  ctx_switch -> tss: "BEFORE switch:\ntss_set_kernel_stack(next->kernel_stack_top)" {
    style: {
      stroke: "#ffd93d"
      stroke-width: 2
      font-color: "#ffe88a"
      font-size: 10
    }
  }
  scheduler -> ctx_switch: "sched_schedule() calls\ncontext_switch_asm()" {
    style: {
      stroke: "#ffcc00"
      font-color: "#ffe88a"
      font-size: 10
    }
  }
  proc_init -> pcb: "fills fake initial\nstack frame in PCB" {
    style: {
      stroke: "#ffd93d"
      font-color: "#ffe88a"
      font-size: 10
    }
  }
  user_pd -> pcb: "pcb->page_directory =\nuser PD phys addr" {
    style: {
      stroke: "#ffd93d"
      font-color: "#ffe88a"
      font-size: 10
    }
  }
  ring3_isolation -> syscall_gate: "ring 3 invokes\nint 0x80 to enter kernel" {
    style: {
      stroke: "#88cc00"
      font-color: "#ccff88"
      font-size: 10
    }
  }
  syscall_gate -> scheduler: "SYS_EXIT sets ZOMBIE\nthen calls sched_schedule()" {
    style: {
      stroke: "#88cc00"
      stroke-dash: 4
      font-color: "#ccff88"
      font-size: 10
    }
  }
}

hw.bios_post -> m1.mbr: "loads 512 bytes to 0x7C00\nverifies 0x55 0xAA signature\njmp 0x7C00" {
  style: {
    stroke: "#ff6b6b"
    stroke-width: 2
    font-color: "#ff9999"
    font-size: 10
  }
}

hw.e820 -> m3.pmm: "multiboot_info.mmap_addr\npassed in EBX by GRUB\npmm_parse_memory_map(mbi)" {
  style: {
    stroke: "#ff6b6b"
    stroke-width: 2
    font-color: "#ff9999"
    font-size: 10
  }
}

hw.pic_hw -> m2.pic_remap: "IRQ lines wired to PIC\nDefault: IRQ0→vec8 = COLLISION\nremap to vec 32-47" {
  style: {
    stroke: "#ff4444"
    stroke-width: 3
    font-color: "#ff9999"
    font-size: 10
  }
}

hw.pit_hw -> m2.pit_drv: "IRQ0 at configured freq\n(divisor-controlled)" {
  style: {
    stroke: "#ff6b6b"
    font-color: "#ff9999"
    font-size: 10
  }
}

hw.ps2_hw -> m2.kbd_drv: "IRQ1 on keypress\nport 0x60 scancode ready" {
  style: {
    stroke: "#ff6b6b"
    font-color: "#ff9999"
    font-size: 10
  }
}

hw.vga_hw -> m1.vga_drv: "physical 0xB8000\nMMIO write = display" {
  style: {
    stroke: "#ff6b6b"
    font-color: "#ff9999"
    font-size: 10
  }
}

hw.serial_hw -> m1.serial_drv: "port 0x3F8 I/O\noutb/inb primitives" {
  style: {
    stroke: "#ff6b6b"
    font-color: "#ff9999"
    font-size: 10
  }
}

m1.pm_switch -> m2.idt: "protected mode active\nIDT replaces IVT\nlidt [idtr] valid in PM only" {
  style: {
    stroke: "#6bcb77"
    stroke-width: 2
    font-color: "#aaffaa"
    font-size: 10
  }
}

m1.gdt -> m2.idt: "gate.selector = 0x08\n(kernel code segment)\nset during idt_set_gate()" {
  style: {
    stroke: "#6bcb77"
    stroke-dash: 4
    font-color: "#aaffaa"
    font-size: 10
  }
}

m2.exc_handler -> m3.pf_handler: "exception_handler routes\nvec 14 to page_fault_handler\nreads CR2" {
  style: {
    stroke: "#4db8ff"
    stroke-width: 2
    font-color: "#88ccff"
    font-size: 10
  }
}

m2.pit_drv -> m4.scheduler: "timer_handler calls\nsched_tick() every 10ms\n→ may trigger switch" {
  style: {
    stroke: "#4db8ff"
    stroke-width: 2
    font-color: "#88ccff"
    font-size: 10
  }
}

m2.idt -> m4.syscall_gate: "idt_set_gate(0x80, isr128,\n0x08, IDT_SYSCALL_GATE=0xEF)\nDPL=3: user-callable" {
  style: {
    stroke: "#4db8ff"
    stroke-width: 2
    font-color: "#88ccff"
    font-size: 10
  }
}

m3.pmm -> m4.user_pd: "pmm_alloc_frame() provides\nphysical frames for\nnew page directories" {
  style: {
    stroke: "#c084fc"
    stroke-width: 2
    font-color: "#d4a8ff"
    font-size: 10
  }
}

m3.paging -> m4.ctx_switch: "context_switch_asm loads\nnew CR3 = next->page_directory\nflushes non-global TLB" {
  style: {
    stroke: "#c084fc"
    stroke-width: 2
    font-color: "#d4a8ff"
    font-size: 10
  }
}

m3.heap -> m4.pcb: "kmalloc() available for\nfuture dynamic PCB alloc\n(current: static table)" {
  style: {
    stroke: "#c084fc"
    stroke-dash: 4
    font-color: "#d4a8ff"
    font-size: 10
  }
}

m1.gdt -> m4.tss: "gdt_install_tss(index=5)\nTSS descriptor type=0x89\nltr 0x28 loads Task Register" {
  style: {
    stroke: "#6bcb77"
    stroke-width: 2
    font-color: "#aaffaa"
    font-size: 10
  }
}

m4.syscall_gate -> m2.isr_stubs: "isr128 stub uses same\nirq_common_stub path\npusha • call • popa • iret" {
  style: {
    stroke: "#ffd93d"
    stroke-dash: 4
    font-color: "#ffe88a"
    font-size: 10
  }
}