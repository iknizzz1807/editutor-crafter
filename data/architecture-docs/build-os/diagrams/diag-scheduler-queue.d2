vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    running: "#DC2626"
    ready: "#16A34A"
    waiting: "#EAB308"
    transition: "#3B82F6"
    bg: "#1F2937"
    panel: "#374151"
    text: "#F3F4F6"
  }
}

title: |md
  # Round-Robin Scheduler: Ready Queue
  **Timer Interrupt (IRQ0) → Rotate Queue → Context Switch**
| {near: top-center}

direction: right

ready_queue: Ready Queue (Circular) {
  grid-columns: 5
  grid-gap: 0

  pcb_head: {
    label: "PCB[0]\nPID: 42\nRIP: 0x401000\nRSP: 0x7fff0000\nCR3: 0x12000"
    style: {
      fill: ${colors.running}
      stroke: "#FCA5A5"
      stroke-width: 3
      font-color: white
      bold: true
    }
  }

  pcb_1: {
    label: "PCB[1]\nPID: 7\nRIP: 0x400500\nRSP: 0x7ffe8000\nCR3: 0x15000"
    style: {
      fill: ${colors.ready}
      stroke: "#86EFAC"
      stroke-width: 2
      font-color: white
    }
  }

  pcb_2: {
    label: "PCB[2]\nPID: 15\nRIP: 0x402000\nRSP: 0x7ffe0000\nCR3: 0x18000"
    style: {
      fill: ${colors.ready}
      stroke: "#86EFAC"
      stroke-width: 2
      font-color: white
    }
  }

  pcb_3: {
    label: "PCB[3]\nPID: 23\nRIP: 0x401800\nRSP: 0x7ffd8000\nCR3: 0x1B000"
    style: {
      fill: ${colors.ready}
      stroke: "#86EFAC"
      stroke-width: 2
      font-color: white
    }
  }

  pcb_ellipsis: {
    label: "...\n\nHEAD →\nRunning"
    style: {
      fill: ${colors.panel}
      font-color: ${colors.text}
      italic: true
    }
  }
}

ready_queue.pcb_head -> ready_queue.pcb_1: "next\nptr" {
  style.stroke: ${colors.transition}
  style.stroke-width: 2
}

ready_queue.pcb_1 -> ready_queue.pcb_2: "next" {
  style.stroke: ${colors.transition}
  style.stroke-width: 2
}

ready_queue.pcb_2 -> ready_queue.pcb_3: "next" {
  style.stroke: ${colors.transition}
  style.stroke-width: 2
}

ready_queue.pcb_3 -> ready_queue.pcb_ellipsis: "next" {
  style.stroke: ${colors.transition}
  style.stroke-width: 2
}

ready_queue.pcb_ellipsis -> ready_queue.pcb_head: "circular\n(closes loop)" {
  style.stroke: ${colors.transition}
  style.stroke-dash: 4
  style.animated: true
}

timer_interrupt: Timer Interrupt\nIRQ0 (100Hz) {
  shape: diamond
  style: {
    fill: "#7C3AED"
    stroke: "#C4B5FD"
    stroke-width: 3
    font-color: white
  }
}

cpu: CPU State {
  style.fill: ${colors.panel}

  current_pcb: Current PCB {
    style.fill: ${colors.running}
    style.font-color: white
    style.stroke: "#FCA5A5"
    label: "PID: 42 (RUNNING)\nQuantum: 10ms\nTime Used: 10ms"
  }

  registers: |md
    **Register State (Saved)**

    RAX: 0x00000042
    RBX: 0x00007FFE
    RCX: 0x00000001
    RDX: 0x00000000
    RSI: 0x00004000
    RDI: 0x00005000
    RSP: 0x7FFF0000
    RBP: 0x7FFF0020
    RIP: 0x401000
    RFLAGS: 0x246
    CR3: 0x12000
  |
}

context_switch: Context Switch Routine {
  style.fill: "#0D9488"
  style.stroke: "#5EEAD4"
  style.stroke-width: 2
  style.font-color: white

  steps: |md
    **switch_to(prev, next):**

    1. push rax, rbx, rcx, rdx
    2. mov [prev.rsp], rsp
    3. mov rsp, [next.rsp]
    4. mov cr3, [next.cr3]
    5. pop rdx, rcx, rbx, rax
    6. iretq
  |
}

state_machine: Process State Machine {
  grid-columns: 3
  grid-gap: 40

  state_running: RUNNING {
    shape: circle
    style: {
      fill: ${colors.running}
      stroke: "#FCA5A5"
      stroke-width: 3
      font-color: white
      bold: true
    }
  }

  state_ready: READY {
    shape: circle
    style: {
      fill: ${colors.ready}
      stroke: "#86EFAC"
      stroke-width: 3
      font-color: white
    }
  }

  state_blocked: BLOCKED {
    shape: circle
    style: {
      fill: ${colors.waiting}
      stroke: "#FDE047"
      stroke-width: 3
      font-color: white
    }
  }
}

state_machine.state_running -> state_machine.state_ready: "Quantum Expired\n(Timer Interrupt)" {
  style.stroke: ${colors.transition}
  style.stroke-width: 3
  style.animated: true
  style.font-color: ${colors.text}
}

state_machine.state_ready -> state_machine.state_running: "Scheduled\n(pick from head)" {
  style.stroke: "#10B981"
  style.stroke-width: 3
  style.animated: true
  style.font-color: ${colors.text}
}

state_machine.state_running -> state_machine.state_blocked: "I/O Request\nblock_on_read()" {
  style.stroke: "#F59E0B"
  style.stroke-width: 2
  style.stroke-dash: 3
  style.font-color: ${colors.text}
}

state_machine.state_blocked -> state_machine.state_ready: "I/O Complete\n(wakeup callback)" {
  style.stroke: "#F59E0B"
  style.stroke-width: 2
  style.stroke-dash: 3
  style.font-color: ${colors.text}
}

timer_interrupt -> cpu: "Fires every 10ms\n(100Hz)" {
  style.stroke: "#A78BFA"
  style.stroke-width: 3
  style.animated: true
}

cpu -> context_switch: "Quantum expired!\nTime to switch" {
  style.stroke: ${colors.running}
  style.stroke-width: 2
}

context_switch -> ready_queue.pcb_head: "1. Save current state\nto PCB[0]" {
  style.stroke: "#FCA5A5"
  style.stroke-width: 2
}

context_switch -> ready_queue.pcb_1: "2. Move PCB[0] to tail\n3. Load PCB[1] state" {
  style.stroke: "#10B981"
  style.stroke-width: 2
  style.animated: true
}

timing_analysis: |md
  ## Timing Analysis (x86_64)

  | Operation | Cycles | Time @ 3GHz |
  |-----------|--------|-------------|
  | Register save | ~14 | ~5ns |
  | RSP switch | ~1 | ~0.3ns |
  | CR3 load | ~100-500 | ~30-170ns |
  | Register restore | ~14 | ~5ns |
  | iretq | ~20-50 | ~7-17ns |
  | **Total** | ~150-600 | **~50-200ns** |
|
timing_analysis.near: bottom-left
timing_analysis.style.fill: ${colors.panel}
timing_analysis.style.font-color: ${colors.text}

code_flow: |md
  ## Scheduler Flow (timer_tick)

  c
  void timer_interrupt_handler(void) {
      struct pcb *prev = current;
      struct pcb *next = dequeue_head(&ready_queue);
      if (prev->state == RUNNING) {
          prev->state = READY;
          enqueue_tail(&ready_queue, prev);
      }
      next->state = RUNNING;
      current = next;
      switch_to(prev, next);
  }
  
|
code_flow.near: bottom-right
code_flow.style.fill: ${colors.panel}
code_flow.style.font-color: ${colors.text}

legend: Legend {
  grid-columns: 3
  grid-gap: 20

  leg_run: Running {
    style.fill: ${colors.running}
    style.font-color: white
  }

  leg_ready: Ready {
    style.fill: ${colors.ready}
    style.font-color: white
  }

  leg_block: Blocked {
    style.fill: ${colors.waiting}
    style.font-color: white
  }
}
legend.style.fill: transparent
legend.near: bottom-center