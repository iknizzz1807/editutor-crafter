vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Timer-Driven Preemption: Timeline
  ### 100 Hz Scheduler — 10ms Time Slices
| {near: top-center}
direction: right
timeline: {
  direction: right
  header_row: {
    grid-columns: 9
    grid-gap: 0
    time_label: "Time →" {
      style.fill: transparent
      style.stroke: transparent
      style.font-color: "#666666"
      style.font-size: 14
    }
    t0: "0ms" {
      style.fill: "#E8E8E8"
      style.stroke: "#CCCCCC"
      style.font-size: 12
    }
    t1: "10ms" {
      style.fill: "#E8E8E8"
      style.stroke: "#CCCCCC"
      style.font-size: 12
    }
    t2: "20ms" {
      style.fill: "#E8E8E8"
      style.stroke: "#CCCCCC"
      style.font-size: 12
    }
    t3: "30ms" {
      style.fill: "#E8E8E8"
      style.stroke: "#CCCCCC"
      style.font-size: 12
    }
    t4: "40ms" {
      style.fill: "#E8E8E8"
      style.stroke: "#CCCCCC"
      style.font-size: 12
    }
    t5: "50ms" {
      style.fill: "#E8E8E8"
      style.stroke: "#CCCCCC"
      style.font-size: 12
    }
    t6: "60ms" {
      style.fill: "#E8E8E8"
      style.stroke: "#CCCCCC"
      style.font-size: 12
    }
    t7: "70ms+" {
      style.fill: "#E8E8E8"
      style.stroke: "#CCCCCC"
      style.font-size: 12
    }
  }
  cpu_row: {
    grid-columns: 8
    grid-gap: 0
    slice_a1: "Process A\nRUNNING" {
      style.fill: "#3498DB"
      style.stroke: "#2980B9"
      style.font-color: white
      style.font-size: 11
      width: 120
    }
    slice_b1: "Process B\nRUNNING" {
      style.fill: "#27AE60"
      style.stroke: "#1E8449"
      style.font-color: white
      style.font-size: 11
      width: 120
    }
    slice_c1: "Process C\nRUNNING" {
      style.fill: "#9B59B6"
      style.stroke: "#7D3C98"
      style.font-color: white
      style.font-size: 11
      width: 120
    }
    slice_a2: "Process A\nRUNNING" {
      style.fill: "#3498DB"
      style.stroke: "#2980B9"
      style.font-color: white
      style.font-size: 11
      width: 120
    }
    slice_b2: "Process B\nRUNNING" {
      style.fill: "#27AE60"
      style.stroke: "#1E8449"
      style.font-color: white
      style.font-size: 11
      width: 120
    }
    slice_c2: "Process C\nRUNNING" {
      style.fill: "#9B59B6"
      style.stroke: "#7D3C98"
      style.font-color: white
      style.font-size: 11
      width: 120
    }
    slice_a3: "Process A\nRUNNING" {
      style.fill: "#3498DB"
      style.stroke: "#2980B9"
      style.font-color: white
      style.font-size: 11
      width: 120
    }
    slice_cont: "..." {
      style.fill: "#F5F5F5"
      style.stroke: "#DDDDDD"
      style.font-size: 18
      width: 120
    }
  }
}
interrupt_section: {
  int_label: "Timer IRQ0\n(100 Hz)" {
    shape: diamond
    style.fill: "#E74C3C"
    style.stroke: "#C0392B"
    style.font-color: white
    style.font-size: 10
    width: 80
  }
  int_desc: |md
    **Every 10ms:**
    1. PIT fires IRQ0
    2. CPU pushes state
    3. Scheduler picks next
    4. Context switch
    5. `iret` to new process
  | {
    style.fill: "#FDF2F2"
    style.stroke: "#E74C3C"
    style.font-size: 11
  }
}
state_diagram: {
  direction: right
  proc_a: {
    label: "Process A"
    style.fill: "#3498DB"
    style.stroke: "#2980B9"
    style.font-color: white
    ready_a: "READY\n(waiting)" {
      shape: circle
      style.fill: "#85C1E9"
      style.stroke: "#3498DB"
      style.font-color: "#1A5276"
      style.font-size: 9
    }
    running_a: "RUNNING\n(active)" {
      shape: circle
      style.fill: "#3498DB"
      style.stroke: "#2980B9"
      style.font-color: white
      style.font-size: 9
    }
    ready_a -> running_a: "scheduled" {
      style.stroke: "#27AE60"
      style.stroke-width: 2
    }
    running_a -> ready_a: "preempted\n(time slice)" {
      style.stroke: "#E74C3C"
      style.stroke-width: 2
      style.stroke-dash: 3
    }
  }
  proc_b: {
    label: "Process B"
    style.fill: "#27AE60"
    style.stroke: "#1E8449"
    style.font-color: white
    ready_b: "READY" {
      shape: circle
      style.fill: "#82E0AA"
      style.stroke: "#27AE60"
      style.font-color: "#145A32"
      style.font-size: 9
    }
    running_b: "RUNNING" {
      shape: circle
      style.fill: "#27AE60"
      style.stroke: "#1E8449"
      style.font-color: white
      style.font-size: 9
    }
    ready_b -> running_b: "scheduled" {
      style.stroke: "#27AE60"
      style.stroke-width: 2
    }
    running_b -> ready_b: "preempted" {
      style.stroke: "#E74C3C"
      style.stroke-width: 2
      style.stroke-dash: 3
    }
  }
  proc_c: {
    label: "Process C"
    style.fill: "#9B59B6"
    style.stroke: "#7D3C98"
    style.font-color: white
    ready_c: "READY" {
      shape: circle
      style.fill: "#D7BDE2"
      style.stroke: "#9B59B6"
      style.font-color: "#512E5F"
      style.font-size: 9
    }
    running_c: "RUNNING" {
      shape: circle
      style.fill: "#9B59B6"
      style.stroke: "#7D3C98"
      style.font-color: white
      style.font-size: 9
    }
    ready_c -> running_c: "scheduled" {
      style.stroke: "#27AE60"
      style.stroke-width: 2
    }
    running_c -> ready_c: "preempted" {
      style.stroke: "#E74C3C"
      style.stroke-width: 2
      style.stroke-dash: 3
    }
  }
}
run_queue: {
  direction: right
  queue_label: "Run Queue (Round-Robin)" {
    style.fill: "#2C3E50"
    style.stroke: "#1A252F"
    style.font-color: white
    style.font-size: 12
  }
  queue_box: {
    grid-columns: 4
    grid-gap: 2
    q_head: "HEAD→" {
      style.fill: "#F39C12"
      style.stroke: "#D68910"
      style.font-size: 10
    }
    q_a: "A" {
      style.fill: "#3498DB"
      style.stroke: "#2980B9"
      style.font-color: white
      style.font-size: 12
      style.bold: true
    }
    q_b: "B" {
      style.fill: "#27AE60"
      style.stroke: "#1E8449"
      style.font-color: white
      style.font-size: 12
      style.bold: true
    }
    q_c: "C" {
      style.fill: "#9B59B6"
      style.stroke: "#7D3C98"
      style.font-color: white
      style.font-size: 12
      style.bold: true
    }
  }
  queue_note: |md
    After A's slice:
    Queue becomes: **B → C → A**
    After B's slice:
    Queue becomes: **C → A → B**
  | {
    style.fill: "#FEF9E7"
    style.stroke: "#F39C12"
    style.font-size: 10
  }
}
context_switch_detail: {
  direction: right
  cs_label: "Context Switch Cost" {
    style.fill: "#8E44AD"
    style.stroke: "#6C3483"
    style.font-color: white
    style.font-size: 12
  }
  cs_breakdown: {
    shape: class
    "Save registers": "50-100 cycles"
    "TLB flush (CR3)": "100-500 cycles"
    "Cache pollution": "1000+ cycles"
    "Pipeline flush": "15-20 cycles"
    "─────────────": "─────────────"
    "Total": "~1000-2000 cycles (~0.5-1 μs)"
  }
}
overhead_calc: {
  direction: right
  calc_label: "Overhead Analysis" {
    style.fill: "#16A085"
    style.stroke: "#0E6655"
    style.font-color: white
    style.font-size: 12
  }
  calc_box: |md
    **At 100 Hz (10ms slices):**
    - Context switch: ~1 μs
    - Time slice: 10,000 μs
    - Overhead: **0.01%** ✓
    **At 10,000 Hz (0.1ms slices):**
    - Context switch: ~1 μs
    - Time slice: 100 μs
    - Overhead: **1%** (marginal)
    **At 100,000 Hz (0.01ms slices):**
    - Context switch: ~1 μs
    - Time slice: 10 μs
    - Overhead: **10%** ✗ (wasteful)
  | {
    style.fill: "#E8F8F5"
    style.stroke: "#16A085"
    style.font-size: 10
  }
}
legend: {
  near: bottom-center
  leg_a: "Process A" {
    style.fill: "#3498DB"
    style.stroke: "#2980B9"
    style.font-color: white
    style.font-size: 11
  }
  leg_b: "Process B" {
    style.fill: "#27AE60"
    style.stroke: "#1E8449"
    style.font-color: white
    style.font-size: 11
  }
  leg_c: "Process C" {
    style.fill: "#9B59B6"
    style.stroke: "#7D3C98"
    style.font-color: white
    style.font-size: 11
  }
  leg_int: "Timer Interrupt\n(Preemption Point)" {
    shape: diamond
    style.fill: "#E74C3C"
    style.stroke: "#C0392B"
    style.font-color: white
    style.font-size: 10
    width: 100
  }
}
key_insight: |md
  ### Key Insight: The Illusion of Simultaneity
  Only **one** process executes at any instant. What feels like "multitasking" is actually
  rapid switching — thousands of times per second — between different execution contexts.
  Each process believes it has the entire CPU to itself, unaware it was ever paused.
| {
  near: bottom-center
  style.fill: "#FDFEFE"
  style.stroke: "#3498DB"
  style.font-size: 12
  width: 800
}