vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Task State Segment (TSS): 104-Byte Structure
  ## x86 32-bit Protected Mode
| {near: top-center}
direction: right
tss_structure: {
  label: "TSS (Task State Segment)\n104 bytes total"
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a6a"
  style.stroke-width: 2
  header_fields: {
    label: ""
    style.fill: transparent
    link_field: {
      label: "link\n(prev task)\n2 bytes + 2 pad"
      style.fill: "#2d2d44"
      style.font-color: "#8888aa"
      width: 140
    }
    esp0_label: {
      label: "ESP0 ← CRITICAL\n(kernel stack ptr)\n4 bytes"
      style.fill: "#4a1a1a"
      style.stroke: "#ff4444"
      style.stroke-width: 3
      style.font-color: "#ff6666"
      width: 140
      tooltip: "Updated EVERY context switch!"
    }
    ss0_label: {
      label: "SS0 ← CRITICAL\n(kernel stack seg)\n2 bytes + 2 pad"
      style.fill: "#4a1a1a"
      style.stroke: "#ff4444"
      style.stroke-width: 3
      style.font-color: "#ff6666"
      width: 140
      tooltip: "Usually 0x10 (kernel data)"
    }
  }
  ring1_ring2_fields: {
    label: "Ring 1 & Ring 2 Stack Pointers\n(Unused in most modern OSes)"
    style.fill: "#1a2a1a"
    style.stroke: "#3a5a3a"
    style.stroke-dash: 3
    style.font-color: "#6a8a6a"
    esp1: {label: "ESP1\n4 bytes"; width: 100}
    ss1_pad: {label: "SS1 + pad\n4 bytes"; width: 100}
    esp2: {label: "ESP2\n4 bytes"; width: 100}
    ss2_pad: {label: "SS2 + pad\n4 bytes"; width: 100}
  }
  core_state: {
    label: "Core CPU State\n(Used for hardware task switching — we don't use this)"
    style.fill: "#2a2a3a"
    style.stroke: "#5a5a7a"
    style.stroke-dash: 2
    style.font-color: "#7a7a9a"
    cr3_reg: {
      label: "CR3\n(page directory)\n4 bytes"
      style.fill: "#2d2d44"
      width: 120
    }
    eip_reg: {
      label: "EIP\n(instruction ptr)\n4 bytes"
      style.fill: "#2d2d44"
      width: 120
    }
    eflags_reg: {
      label: "EFLAGS\n4 bytes"
      style.fill: "#2d2d44"
      width: 120
    }
    gpr_row1: {
      label: ""
      style.fill: transparent
      eax: {label: "EAX\n4 bytes"; width: 80}
      ecx: {label: "ECX\n4 bytes"; width: 80}
      edx: {label: "EDX\n4 bytes"; width: 80}
      ebx: {label: "EBX\n4 bytes"; width: 80}
    }
    gpr_row2: {
      label: ""
      style.fill: transparent
      esp: {label: "ESP\n4 bytes"; width: 80}
      ebp: {label: "EBP\n4 bytes"; width: 80}
      esi: {label: "ESI\n4 bytes"; width: 80}
      edi: {label: "EDI\n4 bytes"; width: 80}
    }
  }
  segment_regs: {
    label: "Segment Registers"
    style.fill: "#2a2a3a"
    style.stroke: "#5a5a7a"
    style.font-color: "#7a7a9a"
    es_seg: {label: "ES + pad\n4 bytes"; width: 80}
    cs_seg: {label: "CS + pad\n4 bytes"; width: 80}
    ss_seg: {label: "SS + pad\n4 bytes"; width: 80}
    ds_seg: {label: "DS + pad\n4 bytes"; width: 80}
    fs_seg: {label: "FS + pad\n4 bytes"; width: 80}
    gs_seg: {label: "GS + pad\n4 bytes"; width: 80}
  }
  footer_fields: {
    label: ""
    style.fill: transparent
    ldtr_trap: {
      label: "LDTR + trap\n4 bytes"
      style.fill: "#2d2d44"
      style.font-color: "#8888aa"
      width: 120
    }
    iomap_base: {
      label: "I/O Map Base\n(offset to bitmap)\n2 bytes"
      style.fill: "#3a3a2a"
      style.stroke: "#7a7a4a"
      style.font-color: "#aaaa6a"
      width: 120
      tooltip: "Set to 104 (sizeof TSS) = no I/O bitmap"
    }
    iomap_note: {
      label: "I/O Bitmap\n(variable size)\n0-8192 bytes"
      style.fill: "#1a1a1a"
      style.stroke: "#5a5a3a"
      style.stroke-dash: 2
      style.font-color: "#666644"
      width: 120
    }
  }
}
update_legend: {
  near: top-right
  style.fill: "#0a0a14"
  style.stroke: "#3a3a5a"
  style.border-radius: 8
  legend_title: {
    label: "Context Switch Updates"
    style.fill: transparent
    style.font-color: "#ffffff"
    style.bold: true
    style.font-size: 18
  }
  critical: {
    label: "■ MUST update every switch"
    style.fill: transparent
    style.font-color: "#ff6666"
  }
  hardware: {
    label: "■ Hardware task switch only"
    style.fill: transparent
    style.font-color: "#7a7a9a"
  }
  optional: {
    label: "■ Optional (I/O perms)"
    style.fill: transparent
    style.font-color: "#aaaa6a"
  }
}
ring_transition: {
  near: bottom-center
  label: "Ring 3 → Ring 0 Interrupt Transition"
  style.fill: "#0a0a14"
  style.stroke: "#4a4a6a"
  style.border-radius: 8
  step1: {
    label: "1. User process\nrunning in Ring 3"
    style.fill: "#1a2a1a"
    style.font-color: "#6a8a6a"
  }
  step2: {
    label: "2. Interrupt fires\nCPU reads TSS"
    style.fill: "#2a2a3a"
    style.font-color: "#8a8aaa"
  }
  step3: {
    label: "3. CPU loads\nSS0:ESP0 from TSS"
    style.fill: "#4a1a1a"
    style.stroke: "#ff4444"
    style.stroke-width: 2
    style.font-color: "#ff6666"
  }
  step4: {
    label: "4. CPU pushes\nuser SS:ESP to\nkernel stack"
    style.fill: "#2a1a2a"
    style.font-color: "#8a6a8a"
  }
  step5: {
    label: "5. Handler runs\non kernel stack"
    style.fill: "#1a1a2a"
    style.font-color: "#6a6a8a"
  }
  step1 -> step2: "IRQ" {style.stroke: "#4a4a6a"; style.stroke-dash: 3}
  step2 -> step3: "read" {style.stroke: "#ff4444"}
  step3 -> step4: "push" {style.stroke: "#8a6a8a"}
  step4 -> step5: "jump" {style.stroke: "#6a6a8a"}
}
byte_layout: {
  near: bottom-left
  label: ||md
    Offset  Size  Field
    ─────────────────────────
    0x00    2+2   link (reserved)
    0x04    4     ESP0    ← UPDATE
    0x08    2+2   SS0     ← SET 0x10
    0x0C    4     ESP1    (unused)
    0x10    2+2   SS1     (unused)
    0x14    4     ESP2    (unused)
    0x18    2+2   SS2     (unused)
    0x1C    4     CR3
    0x20    4     EIP
    0x24    4     EFLAGS
    0x28    4     EAX
    0x2C    4     ECX
    0x30    4     EDX
    0x34    4     EBX
    0x38    4     ESP
    0x3C    4     EBP
    0x40    4     ESI
    0x44    4     EDI
    0x48    2+2   ES
    0x4C    2+2   CS
    0x50    2+2   SS
    0x54    2+2   DS
    0x58    2+2   FS
    0x5C    2+2   GS
    0x60    2+2   LDTR
    0x64    2     IOPB    ← SET 104
    0x66    104-  (end)
  ||
  style.font: mono
  style.font-size: 12
  style.font-color: "#aaaacc"
}
code_example: {
  near: bottom-right
  label: ||md
    c
    // Context switch MUST update ESP0:
    void context_switch(process_t *next) {
        // Update TSS for next process
        tss.esp0 = next->kernel_stack_top;
        // Switch page directory
        if (next->pd != current->pd)
            load_cr3(next->pd);
        // Switch stacks and return
        switch_to(current, next);
    }
    
  ||
  style.font: mono
  style.font-size: 11
  style.font-color: "#aaccaa"
}
tss_structure.header_fields.esp0_label -> tss_structure.header_fields.ss0_label: "paired" {style.stroke: "#ff4444"; style.stroke-dash: 2}