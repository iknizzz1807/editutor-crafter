vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    green: "#C8E6C9"
    green_dark: "#388E3C"
    green_light: "#E8F5E9"
    red: "#EF5350"
    red_dark: "#B71C1C"
    red_light: "#FFEBEE"
    purple: "#CE93D8"
    purple_dark: "#7B1FA2"
    purple_light: "#F3E5F5"
    yellow: "#FFF9C4"
    orange: "#FF9800"
  }
}

title: |md
  # Process Address Space: User vs Kernel
  4GB Virtual Memory Layout with Protection Rings
| {near: top-center}

direction: right

page_directory: Page Directory (CR3) {
  shape: cylinder
  style.fill: "${colors.purple}"
  style.stroke: "${colors.purple_dark}"
  
  pd_desc: |md
    1024 entries × 4 bytes = 4KB
    Each entry covers 4MB of VA
  |
}

address_space: Virtual Address Space (4GB) {
  grid-rows: 1
  grid-gap: 0
  
  kernel_region: Kernel Space (0xC0000000 - 0xFFFFFFFF) {
    style.fill: "${colors.red}"
    style.stroke: "${colors.red_dark}"
    height: 400
    
    k_desc: |md
      **1GB Supervisor-Only**
      - Kernel code/data
      - Device mappings
      - Page tables
      - User-bit: **0**
    |
  }
  
  user_region: User Space (0x00000000 - 0xBFFFFFFF) {
    style.fill: "${colors.green}"
    style.stroke: "${colors.green_dark}"
    height: 600
    
    u_desc: |md
      **3GB User-Accessible**
      - Code segment (.text)
      - Data segment (.data, .bss)
      - Heap (grows up)
      - Stack (grows down)
      - User-bit: **1**
    |
  }
}

page_directory -> address_space: "Maps VA → PA" {
  style.stroke: "${colors.purple_dark}"
}

access_attempt: User Access Attempt {
  style.fill: "${colors.yellow}"
  style.stroke: "${colors.orange}"
  
  user_code: User Process {
    shape: person
    style.fill: "${colors.green_light}"
  }
  
  kernel_mem: Kernel Memory {
    style.fill: "${colors.red_light}"
    style.stroke: "${colors.red_dark}"
    style.stroke-dash: 3
    
    addr: |md
      Address: 0xC0100000
      PTE.user = 0
    |
  }
}

access_attempt.user_code -> access_attempt.kernel_mem: "MOV EAX, [0xC0100000]" {
  style.stroke: red
  style.stroke-width: 3
  style.animated: true
}

page_fault: Page Fault (#PF) {
  style.fill: "${colors.red}"
  style.stroke: "${colors.red_dark}"
  
  fault_desc: |md
    **CPU Raises #PF Exception**
    
    Error Code bits:
    - P=1 (page present)
    - W/R=0 (read access)
    - U/S=1 (from user mode)
    - Cause: CPL=3 > PTE.DPL=0
    
    CR2 = 0xC0100000 (faulting addr)
  |
}

access_attempt.kernel_mem -> page_fault: "Protection Violation" {
  style.stroke: red
  style.stroke-dash: 5
  style.animated: true
}

pte_detail: Page Table Entry (4 bytes) {
  shape: class
  
  addr_bits: "Address [31:12]"
  avail: "Available [11:9]"
  g: "G: Global"
  ps: "PS: Page Size"
  d: "D: Dirty"
  a: "A: Accessed"
  pcd: "PCD: Cache Disable"
  pwt: "PWT: Write-Through"
  u_bit: "U/S: User/Supervisor"
  w_bit: "R/W: Read/Write"
  p_bit: "P: Present"
}

pte_detail.style.fill: "${colors.purple_light}"
pte_detail.style.stroke: "${colors.purple_dark}"

legend: {
  near: bottom-center
  grid-columns: 4
  grid-gap: 20
  
  l1: User Accessible {
    style.fill: "${colors.green}"
  }
  l2: Supervisor Only {
    style.fill: "${colors.red}"
  }
  l3: Page Fault {
    style.fill: "${colors.red}"
    style.font-color: white
  }
  l4: PTE Structure {
    style.fill: "${colors.purple}"
    style.font-color: white
  }
}