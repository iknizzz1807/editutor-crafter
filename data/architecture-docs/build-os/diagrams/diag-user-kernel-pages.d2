vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # User vs. Kernel Page Directories: Memory Isolation
| {near: top-center}

direction: right

classes: {
  kernel_page: {
    style: {
      fill: "#1a365d"
      stroke: "#2c5282"
      font-color: white
    }
  }
  user_page: {
    style: {
      fill: "#276749"
      stroke: "#38a169"
      font-color: white
    }
  }
  shared_kernel: {
    style: {
      fill: "#2d3748"
      stroke: "#4a5568"
      font-color: "#a0aec0"
    }
  }
  page_table: {
    style: {
      fill: "#553c9a"
      stroke: "#6b46c1"
      font-color: white
    }
  }
  fault: {
    style: {
      fill: "#c53030"
      stroke: "#e53e3e"
      font-color: white
    }
  }
  success: {
    style: {
      fill: "#2f855a"
      stroke: "#38a169"
      font-color: white
    }
  }
}

kernel_space: "Kernel Page Directory (CR3)" {
  style.fill: "#1a202c"
  style.stroke: "#4a5568"
  style.font-color: white
  
  kernel_desc: |md
    **All entries supervisor-only**
    (U/S bit = 0)
    
    - Kernel code at 0xC0100000
    - Kernel data at 0xC0200000
    - Device MMIO identity-mapped
  | {shape: text}
  
  kernel_pd: "Page Directory\n(CR3 points here)" {
    class: page_table
    
    pd_entry_0: "PDE[0-767]\nUser Space\n(not used)" {
      style.fill: "#4a5568"
      style.stroke: "#718096"
    }
    
    pd_entry_k: "PDE[768-1023]\nKernel Space\nU/S=0 (Supervisor)" {
      class: kernel_page
    }
  }
  
  kernel_pt: "Page Tables\n(Kernel Region)" {
    class: page_table
    
    kpte_code: "PTE: 0xC0100000\n→ Frame 0x100000\nU/S=0, R/W=1" {
      class: kernel_page
    }
    
    kpte_data: "PTE: 0xC0200000\n→ Frame 0x200000\nU/S=0, R/W=1" {
      class: kernel_page
    }
  }
}

user_space: "User Process Page Directory (CR3)" {
  style.fill: "#1a202c"
  style.stroke: "#4a5568"
  style.font-color: white
  
  user_desc: |md
    **User pages accessible**
    (U/S bit = 1)
    
    **Kernel pages mapped but**
    **supervisor-only (U/S = 0)**
  | {shape: text}
  
  user_pd: "Page Directory\n(Per-process CR3)" {
    class: page_table
    
    pd_entry_u: "PDE[0-767]\nUser Space\nU/S=1 (User)" {
      class: user_page
    }
    
    pd_entry_k2: "PDE[768-1023]\nKernel Space\nU/S=0 (Supervisor)" {
      class: shared_kernel
    }
  }
  
  user_pt: "Page Tables" {
    class: page_table
    
    user_pt_user: "User PT" {
      upte_code: "PTE: 0x00100000\n→ User Frame\nU/S=1, R/W=1" {
        class: user_page
      }
      
      upte_stack: "PTE: 0xBFFFF000\n→ User Stack Frame\nU/S=1, R/W=1" {
        class: user_page
      }
    }
    
    user_pt_kernel: "Kernel PT\n(Same as kernel's)" {
      ukpte_code: "PTE: 0xC0100000\n→ Frame 0x100000\nU/S=0, R/W=1" {
        class: shared_kernel
      }
    }
  }
}

access_scenarios: "Access Scenarios" {
  style.fill: "#1a202c"
  style.stroke: "#4a5568"
  style.font-color: white
  
  scenario1: "✓ User reads user memory\n0x00100000 from Ring 3" {
    class: success
    desc: |md
      U/S=1 in PTE ✓
      Ring 3 ≥ U/S bit
      **ACCESS GRANTED**
    | {shape: text}
  }
  
  scenario2: "✗ User reads kernel memory\n0xC0100000 from Ring 3" {
    class: fault
    desc: |md
      U/S=0 in PTE ✗
      Ring 3 < U/S bit
      **PAGE FAULT (#PF)**
      
      CPU pushes error code:
      - P=0 (protection violation)
      - U/S=1 (user mode access)
    | {shape: text}
  }
  
  scenario3: "✓ Kernel reads kernel memory\n0xC0100000 from Ring 0" {
    class: success
    desc: |md
      U/S=0 in PTE
      Ring 0 ≥ U/S bit ✓
      **ACCESS GRANTED**
    | {shape: text}
  }
  
  scenario4: "✓ Kernel reads user memory\n0x00100000 from Ring 0" {
    class: success
    desc: |md
      U/S=1 in PTE
      Ring 0 ≥ U/S bit ✓
      **ACCESS GRANTED**
      (Kernel can access all)
    | {shape: text}
  }
}

kernel_space.kernel_pd.pd_entry_k -> kernel_space.kernel_pt

user_space.user_pd.pd_entry_u -> user_space.user_pt.user_pt_user
user_space.user_pd.pd_entry_k2 -> user_space.user_pt.user_pt_kernel

access_scenarios.scenario2 -> kernel_space.kernel_pt.kpte_code: "Ring 3 access\nto U/S=0 page" {
  style.stroke: "#e53e3e"
  style.stroke-dash: 4
  style.animated: true
  label: "BLOCKED!"
}

legend: ||md
  ## U/S Bit (User/Supervisor)
  
  | U/S | CPL (Current Privilege) | Result |
  |-----|-------------------------|--------|
  | 0   | Ring 0 (Kernel)         | ✓ Access |
  | 0   | Ring 3 (User)           | ✗ #PF |
  | 1   | Ring 0 (Kernel)         | ✓ Access |
  | 1   | Ring 3 (User)           | ✓ Access |
  
  **Key insight**: Kernel pages mapped in every process, but U/S=0
  prevents user code from reading kernel memory.
|| {near: bottom-center}