vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Dual Console Output: VGA and Serial
  ### kprintf Driver Architecture
| {near: top-center}
direction: right
kprintf: kprintf(fmt, ...) {
  style: {
    fill: "#E8F5E9"
    stroke: "#2E7D32"
    stroke-width: 2
    font: mono
  }
  description: |md
    **Formatted Output Engine**
    - Parses format string
    - Handles %d, %x, %s, %c, %p
    - Calls console_putchar() for each char
  |
}
console_putchar: console_putchar(c) {
  style: {
    fill: "#FFF3E0"
    stroke: "#E65100"
    stroke-width: 2
  }
  desc: |md
    **Dispatcher**
    Routes character to:
    - VGA driver
    - Serial driver
  |
}
kprintf -> console_putchar: "char c\n(via internal loop)"
vga_driver: VGA Driver {
  style: {
    fill: "#E3F2FD"
    stroke: "#1565C0"
  }
  vga_buffer: VGA Buffer @ 0xB8000 {
    style: {
      fill: "#BBDEFB"
      stroke: "#1565C0"
    }
    shape: cylinder
  }
  vga_state: State {
    row: int (0-24)
    col: int (0-79)
    color: uint8_t
    buffer: *uint16_t
  }
  vga_funcs: Functions {
    vga_init()
    vga_putchar(c)
    vga_scroll()
    vga_puts(s)
  }
}
serial_driver: Serial Driver {
  style: {
    fill: "#F3E5F5"
    stroke: "#7B1FA2"
  }
  uart_16550: 16550 UART @ 0x3F8 {
    style: {
      fill: "#E1BEE7"
      stroke: "#7B1FA2"
    }
    shape: cylinder
  }
  serial_state: State {
    base_port: 0x3F8
    baud_divisor: uint16_t
  }
  serial_funcs: Functions {
    serial_init()
    serial_putchar(c)
    serial_is_tx_empty()
  }
}
console_putchar -> vga_driver.vga_funcs: "vga_putchar(c)"
console_putchar -> serial_driver.serial_funcs: "serial_putchar(c)"
vga_memory_layout: VGA Memory Layout {
  style: {
    fill: "#ECEFF1"
    stroke: "#546E7A"
  }
  grid-columns: 3
  grid-gap: 0
  offset_header: "Offset" {class: header}
  byte0_header: "Byte 0" {class: header}
  byte1_header: "Byte 1" {class: header}
  offset_0: "0x0000"
  cell_0_char: "'H' (0x48)"
  cell_0_attr: "0x0F (White on Black)"
  offset_2: "0x0002"
  cell_1_char: "'i' (0x69)"
  cell_1_attr: "0x0F"
  offset_4: "0x0004"
  cell_2_char: "'!' (0x21)"
  cell_2_attr: "0x0F"
  offset_4kb: "..."
  cell_4kb_char: "..."
  cell_4kb_attr: "..."
  offset_end: "0x0F9E"
  cell_end_char: "Row 24, Col 79"
  cell_end_attr: "80Ã—25 = 4000 bytes"
}
classes: {
  header: {
    style: {
      underline: true
      bold: true
      fill: "#CFD8DC"
    }
  }
}
serial_reg_layout: Serial Register Map {
  style: {
    fill: "#ECEFF1"
    stroke: "#546E7A"
  }
  grid-columns: 2
  grid-gap: 0
  reg_header: "Register" {class: header}
  val_header: "Port" {class: header}
  reg_data: "DATA (R/W)"
  val_data: "0x3F8 +0"
  reg_ier: "IER (Interrupt Enable)"
  val_ier: "0x3F8 +1"
  reg_fcr: "FCR (FIFO Control)"
  val_fcr: "0x3F8 +2"
  reg_lcr: "LCR (Line Control)"
  val_lcr: "0x3F8 +3"
  reg_mcr: "MCR (Modem Control)"
  val_mcr: "0x3F8 +4"
  reg_lsr: "LSR (Line Status)"
  val_lsr: "0x3F8 +5"
  reg_dll: "DLL (Divisor Low)"
  val_dll: "0x3F8 +0 (DLAB=1)"
  reg_dlh: "DLH (Divisor High)"
  val_dlh: "0x3F8 +1 (DLAB=1)"
}
vga_driver.vga_buffer -> vga_memory_layout: "Memory\nMapped"
serial_driver.uart_16550 -> serial_reg_layout: "I/O\nMapped"
attribute_byte: Attribute Byte {
  style: {
    fill: "#FFF8E1"
    stroke: "#F57F17"
  }
  layout: |md
    
    Bit 7: Blink / Bright BG
    Bits 6-4: Background Color (0-7)
    Bit 3: Bright FG
    Bits 2-0: Foreground Color (0-7)
    
    **Colors:**
    0=Black, 1=Blue, 2=Green, 3=Cyan
    4=Red, 5=Magenta, 6=Brown, 7=Light Gray
    8=Dark Gray, 9=Light Blue, 10=Light Green
    11=Light Cyan, 12=Light Red, 13=Light Magenta
    14=Yellow, 15=White
  |
}
vga_memory_layout -> attribute_byte: "Byte 1\nFormat"
tx_flow: TX Flow {
  style.fill: transparent
  wait_lsr: Wait for TX Empty {
    style: {
      fill: "#FFEBEE"
      stroke: "#C62828"
      stroke-dash: 3
    }
  }
  outb: outb(0x3F8, char) {
    style: {
      fill: "#E8F5E9"
      stroke: "#2E7D32"
    }
  }
  wait_lsr -> outb: "LSR bit 5 = 1"
  outb -> wait_lsr: "Next char"
}
serial_driver.serial_funcs -> tx_flow: "TX Path"
legend: |md
  **Color Semantics:**
  - ğŸŸ¢ Green: Data flow / Success
  - ğŸŸ  Orange: Dispatch / Control
  - ğŸ”µ Blue: Memory-mapped I/O
  - ğŸŸ£ Purple: Port-mapped I/O
  - â¬œ Gray: Hardware registers
| {
  near: bottom-center
  style: {
    fill: "#FAFAFA"
    stroke: "#BDBDBD"
    border-radius: 8
  }
}
back: â† Back to Overview {
  link: "#satellite-view"
  near: bottom-left
  style: {
    fill: transparent
    font-color: "#1565C0"
  }
}