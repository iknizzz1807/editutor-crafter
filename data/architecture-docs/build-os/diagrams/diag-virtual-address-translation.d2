vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Virtual to Physical Address Translation
  ### Translating Virtual Address 0xC0123456
| {near: top-center}
direction: right
classes: {
  register: {
    shape: rectangle
    style: {
      fill: "#FFE4B5"
      stroke: "#CD853F"
      stroke-width: 2
      font: mono
      bold: true
    }
  }
  memory: {
    shape: rectangle
    style: {
      fill: "#E6E6FA"
      stroke: "#9370DB"
      stroke-width: 2
    }
  }
  cache: {
    shape: rectangle
    style: {
      fill: "#98FB98"
      stroke: "#228B22"
      stroke-width: 2
    }
  }
  step: {
    shape: circle
    style: {
      fill: "#87CEEB"
      stroke: "#4682B4"
      font-color: white
      bold: true
    }
  }
  highlight: {
    style: {
      fill: "#FFD700"
      stroke: "#FF8C00"
      stroke-width: 3
    }
  }
}
Virtual_Address: {
  class: memory
  style.fill: "#FFB6C1"
  style.stroke: "#DC143C"
  label: "Virtual Address\n0xC0123456"
  breakdown: {
    label: ||md
      **Bit Breakdown:**
      0xC0123456 = 1100 0000 0001 0010 0011 0100 0101 0110
      Bits [31:22] = 0x300 → PD Index
      Bits [21:12] = 0x123 → PT Index  
      Bits [11:0]  = 0x456 → Page Offset
    ||
    shape: rectangle
    style.fill: "#FFF8DC"
    style.stroke: "#DAA520"
  }
}
Step1: "1" {class: step}
Step2: "2" {class: step}
Step3: "3" {class: step}
Step4: "4" {class: step}
Step5: "5" {class: step}
CR3: {
  class: register
  label: "CR3 Register\n(Page Directory Base)\n\n0x00100000"
}
Page_Directory: {
  class: memory
  label: "Page Directory\n@ Physical 0x00100000\n\n1024 entries × 4 bytes\n(4KB total)"
  PDE_Entry: {
    class: highlight
    label: ||md
      **PDE[0x300]**
      Address: 0x00100000 + (0x300 × 4)
             = 0x00100C00
      Value: 0x00203007
             ├─ Frame: 0x00203000
             ├─ Present: 1
             ├─ R/W: 1
             └─ User: 1
    ||
  }
}
Page_Table: {
  class: memory
  label: "Page Table\n@ Physical 0x00203000\n\n1024 entries × 4 bytes\n(4KB total)"
  PTE_Entry: {
    class: highlight
    label: ||md
      **PTE[0x123]**
      Address: 0x00203000 + (0x123 × 4)
             = 0x0020348C
      Value: 0x00ABC007
             ├─ Frame: 0x00ABC000
             ├─ Present: 1
             ├─ R/W: 1
             └─ User: 1
    ||
  }
}
Physical_Frame: {
  class: memory
  style.fill: "#90EE90"
  style.stroke: "#228B22"
  label: "Physical Frame\n@ 0x00ABC000\n\n4KB (4096 bytes)"
  Offset: {
    class: highlight
    label: ||md
      **Final Address**
      0x00ABC000 + 0x456
      = 0x00ABC456
    ||
  }
}
TLB: {
  class: cache
  label: "TLB\n(Translation Lookaside Buffer)\n\n~64-1536 entries\n~1-2 cycle lookup"
  Entry: {
    shape: rectangle
    style.fill: "#F0FFF0"
    style.stroke: "#2E8B57"
    label: ||md
      | VPN | Frame | Permissions |
      |-----|-------|-------------|
      | 0xC0123 | 0x00ABC | RW-User |
    ||
  }
  Note: {
    shape: text
    style.font-size: 12
    style.italic: true
    label: "TLB hit: skip page walk!\nTLB miss: full walk required"
  }
}
Virtual_Address -> Step1: "Parse bits\n[31:22][21:12][11:0]" {
  style.stroke: "#DC143C"
  style.stroke-width: 2
}
Step1 -> CR3: "Read CR3\nfor PD base" {
  style.stroke: "#4682B4"
  style.stroke-width: 2
}
CR3 -> Step2: "PD base\n0x00100000" {
  style.stroke: "#4682B4"
  style.stroke-width: 2
}
Step2 -> Page_Directory: "Index by\nPD[0x300]" {
  style.stroke: "#4682B4"
  style.stroke-width: 2
}
Page_Directory -> Step3: "PDE → PT base\n0x00203000" {
  style.stroke: "#4682B4"
  style.stroke-width: 2
}
Step3 -> Page_Table: "Index by\nPT[0x123]" {
  style.stroke: "#4682B4"
  style.stroke-width: 2
}
Page_Table -> Step4: "PTE → Frame\n0x00ABC000" {
  style.stroke: "#4682B4"
  style.stroke-width: 2
}
Step4 -> Physical_Frame: "Add offset\n+ 0x456" {
  style.stroke: "#228B22"
  style.stroke-width: 2
}
Physical_Frame -> Step5: "Physical\n0x00ABC456" {
  style.stroke: "#228B22"
  style.stroke-width: 2
  style.animated: true
}
Virtual_Address -> TLB: "Check cache\nfirst!" {
  style.stroke: "#228B22"
  style.stroke-dash: 5
  style.animated: true
}
TLB -> Physical_Frame: "TLB HIT:\nDirect translation" {
  style.stroke: "#228B22"
  style.stroke-dash: 5
  style.stroke-width: 3
}
Legend: {
  shape: rectangle
  style.fill: "#F5F5F5"
  style.stroke: "#808080"
  label: ||md
    **Translation Path:**
    - **Blue path**: Full page table walk (TLB miss) → ~20-100 cycles
    - **Green dashed**: TLB shortcut (TLB hit) → ~1-2 cycles
    - **Orange highlight**: Active lookup entries
    **Memory Access Cost:**
    | Access Type | Cycles | Latency |
    |-------------|--------|---------|
    | TLB hit | 1-2 | ~1 ns |
    | TLB miss | 20-100 | ~10-50 ns |
    | Page fault | 10M+ | ~10 ms |
  ||
}
Address_Bits: {
  shape: rectangle
  style.fill: "#FFFACD"
  style.stroke: "#BDB76B"
  label: ||md
    **32-bit Virtual Address Decomposition**
    ┌──────────┬──────────┬────────────┐
    │ PD Index │ PT Index │ Page Offset│
    │ 10 bits  │ 10 bits  │  12 bits   │
    ├──────────┼──────────┼────────────┤
    │  0x300   │  0x123   │   0x456    │
    └──────────┴──────────┴────────────┘
         │           │          │
         ▼           ▼          ▼
       Select      Select    Offset
        PD         PT       within
       entry      entry      page
  ||
}
Legend_Note: "TLB hit: skip page walk!\nTLB miss: full walk required" {
  near: bottom-center
  shape: text
  style.font-size: 12
  style.italic: true
}