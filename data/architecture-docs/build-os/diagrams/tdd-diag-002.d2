vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # GDT Layout and Segment Descriptors
  Global Descriptor Table with 5 entries (32 bytes total)
| {near: top-center}

gdt_memory: {
  label: ""
  grid-columns: 1
  grid-gap: 0

  entry_0: {
    label: ""
    grid-columns: 3
    grid-gap: 0
    
    null_bytes: |md
      **Entry 0: NULL**
      `0x0000000000000000`
      
      Offset: 0x00-0x07
      Required by CPU
    |
    null_bytes.style: {
      fill: "#6B7280"
      stroke: "#4B5563"
      font-color: white
    }
  }

  entry_1: {
    label: ""
    grid-columns: 3
    grid-gap: 0
    
    kcode_bytes: |md
      **Entry 1: Kernel Code**
      `0x00CF9A000000FFFF`
      
      Offset: 0x08-0x0F
      Ring 0, Executable, Readable
    |
    kcode_bytes.style: {
      fill: "#7C3AED"
      stroke: "#5B21B6"
      font-color: white
    }
  }

  entry_2: {
    label: ""
    grid-columns: 3
    grid-gap: 0
    
    kdata_bytes: |md
      **Entry 2: Kernel Data**
      `0x00CF92000000FFFF`
      
      Offset: 0x10-0x17
      Ring 0, Writable
    |
    kdata_bytes.style: {
      fill: "#3B82F6"
      stroke: "#1D4ED8"
      font-color: white
    }
  }

  entry_3: {
    label: ""
    grid-columns: 3
    grid-gap: 0
    
    ucode_bytes: |md
      **Entry 3: User Code**
      `0x00CFFA000000FFFF`
      
      Offset: 0x18-0x1F
      Ring 3, Executable, Readable
    |
    ucode_bytes.style: {
      fill: "#7C3AED"
      stroke: "#5B21B6"
      font-color: white
      stroke-dash: 4
    }
  }

  entry_4: {
    label: ""
    grid-columns: 3
    grid-gap: 0
    
    udata_bytes: |md
      **Entry 4: User Data**
      `0x00CFF2000000FFFF`
      
      Offset: 0x20-0x27
      Ring 3, Writable
    |
    udata_bytes.style: {
      fill: "#3B82F6"
      stroke: "#1D4ED8"
      font-color: white
      stroke-dash: 4
    }
  }
}

descriptor_layout: {
  label: "Segment Descriptor Layout (8 bytes)"
  
  header: |md
    ### Byte-by-Byte Structure
  |
  header.near: top-center

  bytes: {
    grid-columns: 8
    grid-gap: 2
    
    b0: |md
      **Byte 0**
      Limit
      Bits 0-7
    |
    b0.style.fill: "#E5E7EB"
    
    b1: |md
      **Byte 1**
      Limit
      Bits 8-15
    |
    b1.style.fill: "#E5E7EB"
    
    b2: |md
      **Byte 2**
      Base
      Bits 0-7
    |
    b2.style.fill: "#FDE68A"
    
    b3: |md
      **Byte 3**
      Base
      Bits 8-15
    |
    b3.style.fill: "#FDE68A"
    
    b4: |md
      **Byte 4**
      Base
      Bits 16-23
    |
    b4.style.fill: "#FDE68A"
    
    b5: |md
      **Byte 5**
      Access
      Byte
    |
    b5.style.fill: "#FCA5A5"
    
    b6: |md
      **Byte 6**
      Flags +
      Limit 16-19
    |
    b6.style.fill: "#A7F3D0"
    
    b7: |md
      **Byte 7**
      Base
      Bits 24-31
    |
    b7.style.fill: "#FDE68A"
  }
}

access_byte: {
  label: "Access Byte Decoding (Byte 5)"
  
  kernel_code: {
    label: "Kernel Code: 0x9A"
    grid-columns: 8
    grid-gap: 1
    
    ab_p: |md
      **P**
      1
      Present
    |
    ab_p.style.fill: "#86EFAC"
    
    ab_dpl1: |md
      **DPL**
      0
      Ring 0
    |
    ab_dpl1.style.fill: "#86EFAC"
    
    ab_dpl2: |md
      **DPL**
      0
      Ring 0
    |
    ab_dpl2.style.fill: "#86EFAC"
    
    ab_s: |md
      **S**
      1
      Code/Data
    |
    ab_s.style.fill: "#86EFAC"
    
    ab_e: |md
      **E**
      1
      Executable
    |
    ab_e.style.fill: "#93C5FD"
    
    ab_dc: |md
      **DC**
      0
      Non-conf
    |
    ab_dc.style.fill: "#E5E7EB"
    
    ab_rw: |md
      **RW**
      1
      Readable
    |
    ab_rw.style.fill: "#93C5FD"
    
    ab_a: |md
      **A**
      0
      Accessed
    |
    ab_a.style.fill: "#E5E7EB"
  }

  user_code: {
    label: "User Code: 0xFA"
    grid-columns: 8
    grid-gap: 1
    
    ub_p: |md
      **P**
      1
      Present
    |
    ub_p.style.fill: "#86EFAC"
    
    ub_dpl1: |md
      **DPL**
      1
      Ring 3
    |
    ub_dpl1.style.fill: "#FCA5A5"
    
    ub_dpl2: |md
      **DPL**
      1
      Ring 3
    |
    ub_dpl2.style.fill: "#FCA5A5"
    
    ub_s: |md
      **S**
      1
      Code/Data
    |
    ub_s.style.fill: "#86EFAC"
    
    ub_e: |md
      **E**
      1
      Executable
    |
    ub_e.style.fill: "#93C5FD"
    
    ub_dc: |md
      **DC**
      1
      Conf
    |
    ub_dc.style.fill: "#93C5FD"
    
    ub_rw: |md
      **RW**
      1
      Readable
    |
    ub_rw.style.fill: "#93C5FD"
    
    ub_a: |md
      **A**
      0
      Accessed
    |
    ub_a.style.fill: "#E5E7EB"
  }
}

flags_byte: {
  label: "Flags Byte Decoding (Byte 6, High Nibble)"
  
  flags_ex: {
    label: "Flags: 0xC (for 0x00CF...)"
    grid-columns: 4
    grid-gap: 1
    
    f_g: |md
      **G**
      1
      4KB Granularity
    |
    f_g.style.fill: "#C4B5FD"
    
    f_d: |md
      **D/B**
      1
      32-bit
    |
    f_d.style.fill: "#C4B5FD"
    
    f_l: |md
      **L**
      0
      Not 64-bit
    |
    f_l.style.fill: "#E5E7EB"
    
    f_avl: |md
      **AVL**
      0
      Available
    |
    f_avl.style.fill: "#E5E7EB"
  }
}

selector_table: {
  label: "Segment Selector Reference"
  
  selectors: {
    shape: sql_table
    Selector: string {constraint: primary_key}
    Index: int
    RPL: int
    Usage: string
    
    row1: 0x08 | 1 | 0 | "Kernel Code"
    row2: 0x10 | 2 | 0 | "Kernel Data"
    row3: 0x1B | 3 | 3 | "User Code (CS)"
    row4: 0x23 | 4 | 3 | "User Data (DS/SS)"
  }
  
  selector_note: |md
    **Selector Format:** `Index(13 bits) | TI(1 bit) | RPL(2 bits)`
    
    - **TI=0**: Use GDT
    - **RPL**: Requested Privilege Level (0=kernel, 3=user)
    - **Index**: GDT entry number (1-4 for our segments)
  |
}

legend: {
  near: bottom-center
  label: ""
  
  leg: {
    grid-columns: 5
    grid-gap: 8
    
    l1: |md
      **Purple** = Code Segment
    |
    l1.style.fill: transparent
    
    l2: |md
      **Blue** = Data Segment
    |
    l2.style.fill: transparent
    
    l3: |md
      **Dashed** = Ring 3 (User)
    |
    l3.style.fill: transparent
    
    l4: |md
      **Solid** = Ring 0 (Kernel)
    |
    l4.style.fill: transparent
    
    l5: |md
      **Gray** = Null/Reserved
    |
    l5.style.fill: transparent
  }
}

summary: |md
  ### Flat Addressing Configuration
  
  All segments use **Base=0** and **Limit=0xFFFFF** with **G=1** (4KB granularity).
  
  This gives each segment a 4GB address range (`0xFFFFF × 4096 = 4GB`).
  
  **Result:** Segmentation becomes a no-op — linear addresses equal virtual addresses.
  Paging (CR3 → Page Directory → Page Table) becomes the sole translation mechanism.
|
summary.near: bottom-center