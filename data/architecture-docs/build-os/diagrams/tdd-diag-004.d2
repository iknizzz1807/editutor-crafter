vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    text: "#8B5CF6"
    rodata: "#3B82F6"
    data: "#10B981"
    bss: "#6B7280"
    vaddr: "#F59E0B"
    paddr: "#EF4444"
  }
}

title: |md
  # Linker Script: Section Placement
  Physical Load vs. Virtual Run Addresses
| {near: top-center}

direction: right

Physical_Memory: {
  label: "Physical Memory\n(Load Addresses)"
  style.fill: "#FEF3C7"
  style.stroke: "#D97706"
  style.stroke-width: 2
  
  p_header: |md
    **AT() Directive**
    ld
    .text : AT(ADDR(.text) - 0xC000000)
    
  | {style.fill: "#FEF9C3"}
  
  p_text: {
    label: ".text\n\n0x00100000\n\nCode Section"
    style.fill: "${colors.text}"
    style.font-color: white
    width: 140
    height: 120
  }
  
  p_rodata: {
    label: ".rodata\n\n0x00102000\n\nRead-Only Data"
    style.fill: "${colors.rodata}"
    style.font-color: white
    width: 140
    height: 100
  }
  
  p_data: {
    label: ".data\n\n0x00103000\n\nInitialized Data"
    style.fill: "${colors.data}"
    style.font-color: white
    width: 140
    height: 100
  }
  
  p_bss: {
    label: ".bss\n\n0x00104000\n\nUninitialized"
    style.fill: "${colors.bss}"
    style.font-color: white
    width: 140
    height: 80
  }
  
  p_text -> p_rodata -> p_data -> p_bss {style.opacity: 0}
}

Virtual_Memory: {
  label: "Virtual Memory\n(Higher Half: 0xC0000000+)"
  style.fill: "#DBEAFE"
  style.stroke: "#2563EB"
  style.stroke-width: 2
  
  v_header: |md
    **Virtual Addresses**
    ld
    . = 0xC0100000;
    
  | {style.fill: "#BFDBFE"}
  
  v_text: {
    label: ".text\n\n0xC0100000\n\nCode Section"
    style.fill: "${colors.text}"
    style.font-color: white
    width: 140
    height: 120
  }
  
  v_rodata: {
    label: ".rodata\n\n0xC0102000\n\nRead-Only Data"
    style.fill: "${colors.rodata}"
    style.font-color: white
    width: 140
    height: 100
  }
  
  v_data: {
    label: ".data\n\n0xC0103000\n\nInitialized Data"
    style.fill: "${colors.data}"
    style.font-color: white
    width: 140
    height: 100
  }
  
  v_bss: {
    label: ".bss\n\n0xC0104000\n\nUninitialized"
    style.fill: "${colors.bss}"
    style.font-color: white
    width: 140
    height: 80
  }
  
  v_text -> v_rodata -> v_data -> v_bss {style.opacity: 0}
}

Mapping: {
  label: ""
  style.fill: transparent
  style.stroke: transparent
  
  m1: {
    shape: text
    label: "AT()\nmaps"
    style.font-size: 12
    style.fill: "#F3E8FF"
  }
}

Bootloader: {
  label: "Bootloader"
  shape: rectangle
  style.fill: "#FEE2E2"
  style.stroke: "#DC2626"
  width: 120
}

CPU: {
  label: "CPU Executes"
  shape: diamond
  style.fill: "#D1FAE5"
  style.stroke: "#059669"
  width: 100
}

legend: {
  near: bottom-center
  label: ""
  style.fill: transparent
  style.stroke: transparent
  
  leg1: {
    label: "Purple = .text (code)"
    shape: rectangle
    width: 150
    style.fill: "${colors.text}"
    style.font-color: white
  }
  leg2: {
    label: "Blue = .rodata (const)"
    shape: rectangle
    width: 150
    style.fill: "${colors.rodata}"
    style.font-color: white
  }
  leg3: {
    label: "Green = .data (globals)"
    shape: rectangle
    width: 150
    style.fill: "${colors.data}"
    style.font-color: white
  }
  leg4: {
    label: "Gray = .bss (zeroed)"
    shape: rectangle
    width: 150
    style.fill: "${colors.bss}"
    style.font-color: white
  }
  
  leg1 -> leg2 -> leg3 -> leg4 {style.opacity: 0}
}

notes: |md
  ## Linker Script Mechanics
  
  **`. = 0xC0100000`** — Sets virtual address counter
  
  **`AT(ADDR(.text) - 0xC000000)`** — Sets physical load address
  
  The bootloader loads sections to **physical addresses**.
  The CPU executes from **virtual addresses** after paging.
  
  **Offset**: Virtual - Physical = 0xC0000000 (3GB)
| {near: bottom-right}

Physical_Memory.p_text -- Mapping.m1 -> Virtual_Memory.v_text: {
  style.stroke: "${colors.paddr}"
  style.stroke-width: 2
  style.stroke-dash: 4
}

Physical_Memory.p_rodata -- Virtual_Memory.v_rodata: {
  style.stroke: "${colors.paddr}"
  style.stroke-width: 2
  style.stroke-dash: 4
  style.opacity: 0.5
}

Physical_Memory.p_data -- Virtual_Memory.v_data: {
  style.stroke: "${colors.paddr}"
  style.stroke-width: 2
  style.stroke-dash: 4
  style.opacity: 0.5
}

Physical_Memory.p_bss -- Virtual_Memory.v_bss: {
  style.stroke: "${colors.paddr}"
  style.stroke-width: 2
  style.stroke-dash: 4
  style.opacity: 0.5
}

Bootloader -> Physical_Memory.p_text: {
  label: "loads to\nphysical"
  style.stroke: "#DC2626"
  style.stroke-width: 2
}

CPU -> Virtual_Memory.v_text: {
  label: "executes\nfrom virtual"
  style.stroke: "#059669"
  style.stroke-width: 2
}

Physical_Memory -> Bootloader {style.opacity: 0}
Virtual_Memory -> CPU {style.opacity: 0}