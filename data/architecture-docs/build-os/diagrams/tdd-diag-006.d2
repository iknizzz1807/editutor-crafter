vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#E8D5B7"
    data: "#B8D4E8"
    free: "#B8E8B8"
    padding: "#D8D8D8"
    pointer: "#F5B8E8"
    step-bg: "#F8F8F8"
    highlight: "#FFE4B5"
    port-label: "#4A90A4"
    write-arrow: "#E85454"
  }
}

classes: {
  header: {
    style: {
      fill: ${colors.header}
      bold: true
    }
  }
}

title: |md
  ## Serial Port Initialization Sequence
  **COM1 (0x3F8) — Step-by-step port writes showing DLAB enable, divisor programming, and FIFO configuration**
| {near: top-center}

step_1: {
  label: "Step 1: Disable Interrupts"
  style.fill: ${colors.step-bg}
  
  port_write: {
    shape: rectangle
    label: |md
      **OUTB** `0x3F9 ← 0x00`
      
      Port: Interrupt Enable Register (IER)
      
      `0x00` = All interrupts disabled
    |
    style.fill: ${colors.highlight}
    style.stroke: ${colors.write-arrow}
    style.stroke-width: 2
  }
  
  note: |md
    Disables all serial interrupts before configuration.
    Prevents spurious interrupts during setup.
  | {shape: text}
}

step_2: {
  label: "Step 2: Enable DLAB"
  style.fill: ${colors.step-bg}
  
  port_write: {
    shape: rectangle
    label: |md
      **OUTB** `0x3FB ← 0x80`
      
      Port: Line Control Register (LCR)
      
      `0x80` = DLAB bit set (bit 7)
    |
    style.fill: ${colors.highlight}
    style.stroke: ${colors.write-arrow}
    style.stroke-width: 2
  }
  
  note: |md
    DLAB (Divisor Latch Access Bit) enables access to
    divisor registers for baud rate programming.
    
    When DLAB=1:
    - Port 0x3F8 → Divisor Latch Low (DLL)
    - Port 0x3F9 → Divisor Latch High (DLH)
  | {shape: text}
}

step_3: {
  label: "Step 3: Program Divisor (38400 baud)"
  style.fill: ${colors.step-bg}
  
  divisor_low: {
    shape: rectangle
    label: |md
      **OUTB** `0x3F8 ← 0x03`
      
      Port: Divisor Latch Low (DLL)
      
      `0x03` = Low byte of divisor
    |
    style.fill: ${colors.highlight}
    style.stroke: ${colors.write-arrow}
    style.stroke-width: 2
  }
  
  divisor_high: {
    shape: rectangle
    label: |md
      **OUTB** `0x3F9 ← 0x00`
      
      Port: Divisor Latch High (DLH)
      
      `0x00` = High byte of divisor
    |
    style.fill: ${colors.highlight}
    style.stroke: ${colors.write-arrow}
    style.stroke-width: 2
  }
  
  divisor_calc: {
    shape: rectangle
    label: |md
      **Baud Rate Calculation:**
      
      
      Base frequency = 1,843,200 Hz
      Divisor = 115,200 / 38400 = 3
      Divisor = 0x0003
      
      Actual baud = 1,843,200 / (16 × 3)
                 = 38,400 bps
      
    |
    style.fill: ${colors.data}
    style.stroke: ${colors.port-label}
  }
  
  divisor_low -> divisor_high: "then"
  divisor_high -> divisor_calc: "calculates to"
}

step_4: {
  label: "Step 4: Set Line Format (8N1)"
  style.fill: ${colors.step-bg}
  
  port_write: {
    shape: rectangle
    label: |md
      **OUTB** `0x3FB ← 0x03`
      
      Port: Line Control Register (LCR)
      
      `0x03` = 8 bits, no parity, 1 stop bit
    |
    style.fill: ${colors.highlight}
    style.stroke: ${colors.write-arrow}
    style.stroke-width: 2
  }
  
  bit_breakdown: {
    shape: rectangle
    label: |md
      **LCR Bit Breakdown:**
      
      Bits 7 (DLAB): 0 = Access TX/RX buffers
      Bit 6: 0 = No break signal
      Bits 5-3: 000 = No parity
      Bit 2: 0 = 1 stop bit
      Bits 1-0: 11 = 8 data bits
      
      Result: 8-N-1 format
    |
    style.fill: ${colors.data}
    style.stroke: ${colors.port-label}
  }
}

step_5: {
  label: "Step 5: Enable FIFO"
  style.fill: ${colors.step-bg}
  
  port_write: {
    shape: rectangle
    label: |md
      **OUTB** `0x3FA ← 0xC7`
      
      Port: FIFO Control Register (FCR)
      
      `0xC7` = Enable, clear, 14-byte trigger
    |
    style.fill: ${colors.highlight}
    style.stroke: ${colors.write-arrow}
    style.stroke-width: 2
  }
  
  bit_breakdown: {
    shape: rectangle
    label: |md
      **FCR Bit Breakdown:**
      
      Bits 7-6: 11 = 14-byte trigger level
      Bit 5: 0 = Reserved
      Bit 4: 0 = Reserved
      Bit 3: 0 = DMA mode disabled
      Bit 2: 1 = Clear transmit FIFO
      Bit 1: 1 = Clear receive FIFO
      Bit 0: 1 = Enable FIFO
    |
    style.fill: ${colors.data}
    style.stroke: ${colors.port-label}
  }
}

step_6: {
  label: "Step 6: Set Modem Control"
  style.fill: ${colors.step-bg}
  
  port_write: {
    shape: rectangle
    label: |md
      **OUTB** `0x3FC ← 0x0B`
      
      Port: Modem Control Register (MCR)
      
      `0x0B` = DTR + RTS + OUT2
    |
    style.fill: ${colors.highlight}
    style.stroke: ${colors.write-arrow}
    style.stroke-width: 2
  }
  
  bit_breakdown: {
    shape: rectangle
    label: |md
      **MCR Bit Breakdown:**
      
      Bits 7-5: 0 = Reserved
      Bit 4: 0 = Loopback disabled
      Bit 3: 1 = OUT2 (IRQ enable)
      Bit 2: 0 = OUT1 (unused)
      Bit 1: 1 = RTS (Request To Send)
      Bit 0: 1 = DTR (Data Terminal Ready)
    |
    style.fill: ${colors.data}
    style.stroke: ${colors.port-label}
  }
}

step_7: {
  label: "Step 7: Verify Initialization"
  style.fill: ${colors.step-bg}
  
  port_read: {
    shape: rectangle
    label: |md
      **INB** `0x3FD → AL`
      
      Port: Line Status Register (LSR)
      
      Check bit 5 (THRE) = Transmitter empty
    |
    style.fill: ${colors.free}
    style.stroke: ${colors.port-label}
    style.stroke-width: 2
  }
  
  check: {
    shape: diamond
    label: "THRE=1?"
  }
  
  ready: {
    label: "Serial port ready for output"
    style.fill: ${colors.free}
  }
  
  port_read -> check
  check -> ready: "Yes"
}

step_1 -> step_2: {
  label: "disable interrupts first"
  style.stroke: ${colors.port-label}
  style.stroke-dash: 3
}
step_2 -> step_3: {
  label: "DLAB enables divisor access"
  style.stroke: ${colors.port-label}
  style.stroke-dash: 3
}
step_3 -> step_4: {
  label: "clear DLAB for normal operation"
  style.stroke: ${colors.port-label}
  style.stroke-dash: 3
}
step_4 -> step_5: {
  label: "configure hardware buffers"
  style.stroke: ${colors.port-label}
  style.stroke-dash: 3
}
step_5 -> step_6: {
  label: "enable modem control lines"
  style.stroke: ${colors.port-label}
  style.stroke-dash: 3
}
step_6 -> step_7: {
  label: "verify before use"
  style.stroke: ${colors.port-label}
  style.stroke-dash: 3
}

register_map: {
  label: "COM1 Register Map (0x3F8 Base)"
  style.fill: ${colors.padding}
  
  grid-columns: 4
  grid-gap: 0
  
  header_offset: "Offset" {class: header}
  header_dlab0: "DLAB=0" {class: header}
  header_dlab1: "DLAB=1" {class: header}
  header_rw: "R/W" {class: header}
  
  r0_off: "+0" {style.fill: ${colors.step-bg}}
  r0_dlab0: "TX/RX Buffer" {style.fill: ${colors.data}}
  r0_dlab1: "Divisor Latch Low" {style.fill: ${colors.pointer}}
  r0_rw: "R/W" {style.fill: ${colors.step-bg}}
  
  r1_off: "+1" {style.fill: ${colors.step-bg}}
  r1_dlab0: "Interrupt Enable" {style.fill: ${colors.data}}
  r1_dlab1: "Divisor Latch High" {style.fill: ${colors.pointer}}
  r1_rw: "R/W" {style.fill: ${colors.step-bg}}
  
  r2_off: "+2" {style.fill: ${colors.step-bg}}
  r2_dlab0: "FIFO Control" {style.fill: ${colors.data}}
  r2_dlab1: "(same)" {style.fill: ${colors.data}}
  r2_rw: "W" {style.fill: ${colors.step-bg}}
  
  r3_off: "+3" {style.fill: ${colors.step-bg}}
  r3_dlab0: "Line Control" {style.fill: ${colors.data}}
  r3_dlab1: "(same)" {style.fill: ${colors.data}}
  r3_rw: "R/W" {style.fill: ${colors.step-bg}}
  
  r4_off: "+4" {style.fill: ${colors.step-bg}}
  r4_dlab0: "Modem Control" {style.fill: ${colors.data}}
  r4_dlab1: "(same)" {style.fill: ${colors.data}}
  r4_rw: "R/W" {style.fill: ${colors.step-bg}}
  
  r5_off: "+5" {style.fill: ${colors.step-bg}}
  r5_dlab0: "Line Status" {style.fill: ${colors.free}}
  r5_dlab1: "(same)" {style.fill: ${colors.free}}
  r5_rw: "R" {style.fill: ${colors.step-bg}}
}

code_example: {
  label: "Implementation Code"
  style.fill: ${colors.padding}
  
  code: |c
    void serial_init(uint16_t port) {
        outb(port + 1, 0x00);    // Step 1: Disable interrupts
        outb(port + 3, 0x80);    // Step 2: Enable DLAB
        outb(port + 0, 0x03);    // Step 3: Divisor low (38400 baud)
        outb(port + 1, 0x00);    // Step 3: Divisor high
        outb(port + 3, 0x03);    // Step 4: 8N1, DLAB off
        outb(port + 2, 0xC7);    // Step 5: Enable FIFO
        outb(port + 4, 0x0B);    // Step 6: RTS/DSR set
    }
  |
}