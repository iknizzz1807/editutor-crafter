vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # kprintf Data Flow
  Format string parsing → argument extraction → dual output
| {near: top-center}

direction: right

# Input stage
format_string: "Format String\n\"Count: %d, Name: %s\"" {
  shape: rectangle
  style.fill: "#E4DBFE"
  style.stroke: "#7C5CBF"
}

va_list: "va_list\n(args...)" {
  shape: rectangle
  style.fill: "#E4DBFE"
  style.stroke: "#7C5CBF"
}

# Parser
parser: {
  label: "Format Parser"
  shape: rectangle
  style.fill: "#B5AFF6"
  style.stroke: "#5A4FCF"
  
  scan: "Scan for '%'"
  extract: "Extract specifier"
}

# Specifier dispatch
dispatch: {
  label: "Specifier\nDispatch"
  shape: diamond
  style.fill: "#F9D8A7"
  style.stroke: "#D4940A"
}

# Type handlers
handlers: {
  label: "Type Handlers"
  style.fill: "#ACE1AF"
  style.stroke: "#2E8B57"
  
  string: "%s → string"
  decimal: "%d → itoa()"
  hex: "%x → htoa()"
  char: "%c → direct"
  pointer: "%p → hex prefix"
}

# Character buffer
char_stream: "Character\nStream" {
  shape: rectangle
  style.fill: "#C5C6C7"
  style.stroke: "#6B6E70"
}

# Output sinks
sinks: {
  label: "Output Sinks"
  style.fill: "#F6C889"
  style.stroke: "#D4840A"
  
  vga: {
    label: "VGA Driver\n(0xB8000)"
    shape: rectangle
  }
  serial: {
    label: "Serial Driver\n(COM1: 0x3F8)"
    shape: rectangle
  }
}

# Final output
vga_screen: "Screen\n(80×25 text)" {
  shape: rectangle
  style.fill: "#000000"
  style.font-color: "#FFFFFF"
  style.stroke: "#333333"
}

serial_console: "Serial\nConsole" {
  shape: rectangle
  style.fill: "#1E1E1E"
  style.font-color: "#00FF00"
  style.stroke: "#333333"
}

# Connections
format_string -> parser.scan
va_list -> parser

parser.scan -> parser.extract
parser.extract -> dispatch

dispatch -> handlers.string: "%s"
dispatch -> handlers.decimal: "%d"
dispatch -> handlers.hex: "%x"
dispatch -> handlers.char: "%c"
dispatch -> handlers.pointer: "%p"

handlers -> char_stream
char_stream -> sinks.vga
char_stream -> sinks.serial

sinks.vga -> vga_screen: "memory-mapped\nwrite"
sinks.serial -> serial_console: "port I/O\noutb"

# Annotations
annotation: |md
  **Data Flow:**
  
  1. **Parse**: Scan format string for '%'
  2. **Extract**: Read specifier character
  3. **Fetch**: Pop argument from va_list
  4. **Convert**: Transform to character sequence
  5. **Output**: Write to both VGA and serial
  
  **Supported Specifiers:**
  - `%s` — null-terminated string
  - `%d` — signed decimal integer
  - `%x` — hexadecimal (lowercase)
  - `%c` — single character
  - `%p` — pointer with 0x prefix
| {
  near: bottom-center
  shape: text
  style.fill: "#F6F9FC"
  style.stroke: "#CBD6E0"
  style.border-radius: 8
}