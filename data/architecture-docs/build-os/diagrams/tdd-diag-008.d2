vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Bootloader Module Architecture
  Component relationships and data flow
| {
  near: top-center
}

direction: right

boot_stage: {
  label: "Boot Stage\n(Real Mode → Protected Mode)"
  style.fill: "#E8D5B7"
  style.stroke: "#8B7355"
  
  boot_asm: "boot.asm\n─────────────\n• BIOS handoff at 0x7C00\n• A20 line enable\n• GDT load (lgdt)\n• CR0.PE set\n• Far jump flush\n• Kernel disk load" {
    shape: rectangle
    style.fill: "#F5E6D3"
    style.stroke: "#8B7355"
  }
  
  gdt_asm: "gdt.asm\n─────────────\n• Null descriptor\n• Kernel code (0x08)\n• Kernel data (0x10)\n• User code (0x1B)\n• User data (0x23)\n• GDTR pointer" {
    shape: rectangle
    style.fill: "#F5E6D3"
    style.stroke: "#8B7355"
  }
  
  boot_asm -> gdt_asm: "includes\nGDT definitions"
}

kernel_entry_stage: {
  label: "Kernel Entry\n(Protected Mode)"
  style.fill: "#B5D8EB"
  style.stroke: "#4A90A4"
  
  kernel_entry_asm: "kernel_entry.asm\n─────────────────\n• BSS zeroing\n• Stack setup\n• Call kernel_main\n• Halt on return" {
    shape: rectangle
    style.fill: "#D4E8F2"
    style.stroke: "#4A90A4"
  }
}

linker: "linker.ld\n─────────────\nENTRY(kernel_entry)\n\nSECTIONS:\n• .text  @ 0x100000\n• .rodata\n• .data\n• .bss\n\nDefines:\n__bss_start\n__bss_end" {
  shape: rectangle
  style.fill: "#E8E0F0"
  style.stroke: "#7B68A6"
}

kernel_main: "main.c\n─────────────\nkernel_main()\n─────────────\n• vga_init()\n• serial_init()\n• kprintf()\n• Main loop" {
  shape: rectangle
  style.fill: "#C8E6C9"
  style.stroke: "#4CAF50"
}

drivers: {
  label: "Output Drivers"
  style.fill: "#FFF3E0"
  style.stroke: "#FF9800"
  
  vga: "vga.c / vga.h\n───────────────\nVGA_BUFFER: 0xB8000\n───────────────\n• vga_init()\n• vga_putchar()\n• vga_puts()\n• vga_set_color()\n• Scroll handling" {
    shape: rectangle
    style.fill: "#FFE0B2"
    style.stroke: "#FF9800"
  }
  
  serial: "serial.c / serial.h\n─────────────────\nCOM1_PORT: 0x3F8\n─────────────────\n• serial_init()\n• serial_putchar()\n• serial_puts()\n• THRE wait loop" {
    shape: rectangle
    style.fill: "#FFE0B2"
    style.stroke: "#FF9800"
  }
  
  port_io: "port_io.h\n─────────────\n• outb(port, val)\n• inb(port)\n\nInline asm\nI/O primitives" {
    shape: rectangle
    style.fill: "#FFE0B2"
    style.stroke: "#FF9800"
  }
  
  serial -> port_io: "uses"
}

kprintf: "kprintf.c\n─────────────\nFormat output to\nVGA + Serial\n─────────────\n• %s string\n• %d decimal\n• %x hex\n• %c char\n• %p pointer" {
  shape: rectangle
  style.fill: "#E1F5FE"
  style.stroke: "#03A9F4"
}

hardware: {
  label: "Hardware Interface"
  style.fill: "#FFEBEE"
  style.stroke: "#F44336"
  
  bios: "BIOS\n─────────\nINT 13h\nDisk read\nPOST complete" {
    shape: diamond
    style.fill: "#FFCDD2"
    style.stroke: "#F44336"
  }
  
  vga_hw: "VGA Controller\n──────────────\nText buffer\n@ 0xB8000\n80×25 cells" {
    shape: hexagon
    style.fill: "#FFCDD2"
    style.stroke: "#F44336"
  }
  
  serial_hw: "Serial Port\n───────────\nCOM1: 0x3F8\nTX/RX regs\nLine status" {
    shape: hexagon
    style.fill: "#FFCDD2"
    style.stroke: "#F44336"
  }
  
  cpu: "CPU\n─────────\nReal Mode\nProtected Mode\nGDT/IDT/CR0" {
    shape: circle
    style.fill: "#FFCDD2"
    style.stroke: "#F44336"
  }
}

memory: {
  near: bottom-right
  shape: rectangle
  style.fill: "#F5F5F5"
  style.stroke: "#9E9E9E"
  label: |md
    ## Memory Layout
    
    | Address | Content |
    |---------|---------|
    | 0x7C00 | Bootloader (512B) |
    | 0x90000 | Kernel stack |
    | 0x100000 | Kernel binary |
    | 0xB8000 | VGA text buffer |
    
    ## GDT Selectors
    
    | Selector | Segment |
    |----------|---------|
    | 0x08 | Kernel code |
    | 0x10 | Kernel data |
    | 0x1B | User code |
    | 0x23 | User data |
  |
}

boot_stage.boot_asm -> kernel_entry_stage.kernel_entry_asm: "jmp 0x08:0x100000\n(far jump)" {
  style.stroke: "#2196F3"
  style.stroke-width: 3
}

linker -> kernel_entry_stage.kernel_entry_asm: "provides\n__bss_start\n__bss_end" {
  style.stroke-dash: 3
  style.stroke: "#7B68A6"
}

linker -> kernel_main: "places at\n0x100000" {
  style.stroke-dash: 3
  style.stroke: "#7B68A6"
}

kernel_entry_stage.kernel_entry_asm -> kernel_main: "call" {
  style.stroke: "#4CAF50"
  style.stroke-width: 2
}

kernel_main -> kprintf: "calls"
kernel_main -> drivers.vga: "vga_init()\nvga_puts()"
kernel_main -> drivers.serial: "serial_init()"

kprintf -> drivers.vga: "vga_putchar()"
kprintf -> drivers.serial: "serial_putchar()"

drivers.serial -> drivers.port_io: "outb()\ninb()"

hardware.bios -> boot_stage.boot_asm: "loads MBR\nto 0x7C00" {
  style.stroke-dash: 5
  style.stroke: "#F44336"
}

boot_stage.boot_asm -> hardware.cpu: "sets CR0.PE\nloads GDTR" {
  style.stroke: "#8B7355"
  style.stroke-dash: 3
}

drivers.vga -> hardware.vga_hw: "mmio write\n@ 0xB8000" {
  style.stroke: "#FF9800"
}

drivers.serial -> hardware.serial_hw: "port I/O\n@ 0x3F8" {
  style.stroke: "#FF9800"
}