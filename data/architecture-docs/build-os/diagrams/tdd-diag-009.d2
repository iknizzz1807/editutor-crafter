vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # IDT Entry Layout
  ## 8-Byte Gate Descriptor Structure
| {near: top-center}

direction: right

byte_layout: {
  grid-columns: 8
  grid-gap: 0
  
  b0: "Byte 0\n\nOffset Low\n(bits 0-7)" {
    style.fill: "#4A90D9"
    style.stroke: "#2E5A8C"
    style.font-color: white
    style.bold: true
  }
  
  b1: "Byte 1\n\nOffset Low\n(bits 8-15)" {
    style.fill: "#4A90D9"
    style.stroke: "#2E5A8C"
    style.font-color: white
    style.bold: true
  }
  
  b2: "Byte 2\n\nSelector\n(bits 0-7)" {
    style.fill: "#E67E22"
    style.stroke: "#B35A1C"
    style.font-color: white
    style.bold: true
  }
  
  b3: "Byte 3\n\nSelector\n(bits 8-15)" {
    style.fill: "#E67E22"
    style.stroke: "#B35A1C"
    style.font-color: white
    style.bold: true
  }
  
  b4: "Byte 4\n\nReserved\n(0x00)" {
    style.fill: "#7F8C8D"
    style.stroke: "#5D6667"
    style.font-color: white
  }
  
  b5: "Byte 5\n\nType/Attr\n(0x8E)" {
    style.fill: "#9B59B6"
    style.stroke: "#6E3A82"
    style.font-color: white
    style.bold: true
  }
  
  b6: "Byte 6\n\nOffset High\n(bits 16-23)" {
    style.fill: "#4A90D9"
    style.stroke: "#2E5A8C"
    style.font-color: white
    style.bold: true
  }
  
  b7: "Byte 7\n\nOffset High\n(bits 24-31)" {
    style.fill: "#4A90D9"
    style.stroke: "#2E5A8C"
    style.font-color: white
    style.bold: true
  }
}

offset_group: {
  label: Handler Address (32-bit)
  style.fill: "#D4E6F7"
  style.stroke: "#4A90D9"
  style.stroke-dash: 3
  
  desc: |md
    **Offset Low** (bytes 0-1): Bits 0-15 of handler address
    **Offset High** (bytes 6-7): Bits 16-31 of handler address
    
    Full address = (OffsetHigh << 16) | OffsetLow
  |
}

selector_group: {
  label: Code Segment Selector
  style.fill: "#FDEBD0"
  style.stroke: "#E67E22"
  style.stroke-dash: 3
  
  desc: |md
    **Selector** (bytes 2-3): Segment selector for handler
    
    Typically `0x08` for kernel code segment
    (GDT index 1, RPL=0, TI=0)
  |
}

type_attr_detail: {
  label: "Byte 5: Type/Attributes (Bit-Level)"
  style.fill: "#E8DAEF"
  style.stroke: "#9B59B6"
  
  bits_grid: {
    grid-columns: 8
    grid-gap: 0
    
    bit7: "7\nP" {
      style.fill: "#27AE60"
      style.font-color: white
      style.bold: true
    }
    bit6_5: "6-5\nDPL" {
      style.fill: "#2980B9"
      style.font-color: white
      style.bold: true
    }
    bit5: "" {
      style.fill: "#2980B9"
    }
    bit4: "4\nS" {
      style.fill: "#8E44AD"
      style.font-color: white
      style.bold: true
    }
    bit3_0: "3-0\nType" {
      style.fill: "#E74C3C"
      style.font-color: white
      style.bold: true
    }
    bit2: "" {
      style.fill: "#E74C3C"
    }
    bit1: "" {
      style.fill: "#E74C3C"
    }
    bit0: "" {
      style.fill: "#E74C3C"
    }
  }
  
  legend: {
    present: {
      label: "P (Present)"
      desc: |md
        **Bit 7**: 1 = valid gate, 0 = gate not present
      |
    }
    
    dpl: {
      label: "DPL (Privilege)"
      desc: |md
        **Bits 5-6**: Descriptor Privilege Level
        - `00` = Ring 0 only
        - `11` = Ring 3 can invoke (for syscalls)
      |
    }
    
    storage: {
      label: "S (Storage)"
      desc: |md
        **Bit 4**: 0 for interrupt/trap gates
        (1 for code/data segments)
      |
    }
    
    gate_type: {
      label: "Type (Gate Type)"
      desc: |md
        **Bits 0-3**: Gate type
        - `0xE` (1110) = 32-bit Interrupt Gate
        - `0xF` (1111) = 32-bit Trap Gate
        
        Interrupt gate: disables interrupts on entry
        Trap gate: keeps interrupts enabled
      |
    }
  }
}

common_values: {
  label: "Common Type/Attr Values"
  style.fill: "#F9F9F9"
  style.stroke: "#BDC3C7"
  
  int_gate: "0x8E\nInterrupt Gate\nRing 0, ints disabled" {
    style.fill: "#3498DB"
    style.font-color: white
  }
  
  trap_gate: "0x8F\nTrap Gate\nRing 0, ints enabled" {
    style.fill: "#1ABC9C"
    style.font-color: white
  }
  
  user_int: "0xEE\nUser Interrupt\nRing 3 syscall" {
    style.fill: "#E74C3C"
    style.font-color: white
  }
  
  user_trap: "0xEF\nUser Trap\nRing 3, ints enabled" {
    style.fill: "#9B59B6"
    style.font-color: white
  }
}

memory_example: {
  label: "Example: Timer Interrupt (IRQ0 -> Vector 32)"
  style.fill: "#F4F4F4"
  style.stroke: "#95A5A6"
  
  example_desc: |md
    Handler at `0x00105000`, CS = `0x08`, Interrupt Gate, Ring 0
    
    | Byte | Value | Hex | Description |
    |------|-------|-----|-------------|
    | 0    | 0x00  | 00  | Offset low (0x00) |
    | 1    | 0x50  | 50  | Offset low (0x50) |
    | 2    | 0x08  | 08  | Selector low |
    | 3    | 0x00  | 00  | Selector high |
    | 4    | 0x00  | 00  | Reserved |
    | 5    | 0x8E  | 8E  | Interrupt gate, Ring 0 |
    | 6    | 0x10  | 10  | Offset high (0x10) |
    | 7    | 0x00  | 00  | Offset high (0x00) |
    
    **Raw bytes (little-endian):** `00 50 08 00 00 8E 10 00`
  |
}

size_annotation: {
  label: "sizeof(idt_entry_t) = 8 bytes"
  style.fill: "#2C3E50"
  style.font-color: white
  style.bold: true
  style.border-radius: 4
}

byte_layout -> offset_group: "32-bit handler"
byte_layout -> selector_group: "16-bit CS"
byte_layout -> type_attr_detail: "bit decode"
type_attr_detail -> common_values: "examples"