vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Interrupt Stack Frame: CPU-Pushed vs Handler-Pushed
| {near: top-center}

direction: right

stack_grows_down: |md
  
  Stack grows down ↓
  Higher addresses at top
  
| {near: top-center}

stack_frame: {
  # CPU-PUSHED STATE (automatic)
  cpu_pushed: CPU-Pushed State {
    style.fill: "#E8D5E3"
    style.stroke: "#9B59B6"
    style.stroke-width: 2
    
    user_ss: SS (user mode) {
      style.fill: "#FADBD8"
      style.font-color: "#922B21"
      width: 180
    }
    user_esp: ESP (user mode) {
      style.fill: "#FADBD8"
      style.font-color: "#922B21"
      width: 180
    }
    eflags: EFLAGS {
      style.fill: "#D7BDE2"
      width: 180
      |md
      Bit 9: IF (Interrupt Flag)
      Bit 0: CF (Carry Flag)
      |
    }
    cs: CS (Code Segment) {
      style.fill: "#D7BDE2"
      width: 180
      |md
      Selector: 0x08 (kernel)
      or 0x1B (user)
      |
    }
    eip: EIP (Instruction Ptr) {
      style.fill: "#D7BDE2"
      width: 180
      |md
      Return address
      |
    }
    
    user_ss -> user_esp: "ring 3→0 only" {style.stroke-dash: 3}
    user_esp -> eflags
    eflags -> cs
    cs -> eip
  }
  
  # Error code (exception-dependent)
  error_code: Error Code {
    style.fill: "#FDEBD0"
    style.stroke: "#E67E22"
    style.stroke-width: 2
    style.stroke-dash: 3
    
    err_code: Error Code {
      width: 180
      |md
      **Exception-dependent**
      Vectors: 8, 10-14, 17, 21, 29, 30
      
      Page Fault (14):
      • Bit 0: Present
      • Bit 1: Write
      • Bit 2: User
      |
    }
  }
  
  # HANDLER-PUSHED STATE
  handler_pushed: Handler-Pushed State {
    style.fill: "#D4E6F1"
    style.stroke: "#2980B9"
    style.stroke-width: 2
    
    int_no: Interrupt Number {
      style.fill: "#AED6F1"
      width: 180
    }
    dummy: Dummy Error (0) {
      style.fill: "#FDEDEC"
      style.stroke-dash: 3
      width: 180
      |md
      Pushed for exceptions
      without error code
      |
    }
    
    gs: GS
    fs: FS
    es: ES
    ds: DS
    
    edi: EDI
    esi: ESI
    ebp: EBP
    esp_ignored: ESP (ignored) {
      style.fill: "#F5EEF8"
      |md
      Value before pusha
      |
    }
    ebx: EBX
    edx: EDX
    ecx: ECX
    eax: EAX
    
    int_no -> dummy
    dummy -> gs
    gs -> fs
    fs -> es
    es -> ds
    ds -> edi
    edi -> esi
    esi -> ebp
    ebp -> esp_ignored
    esp_ignored -> ebx
    ebx -> edx
    edx -> ecx
    ecx -> eax
  }
  
  # Connection between sections
  cpu_pushed.eip -> error_code.err_code: "some exceptions" {style.stroke-dash: 5; style.stroke: "#E67E22"}
  error_code.err_code -> handler_pushed.int_no
}

# Stack pointer position
esp_now: ESP → {
  shape: text
  style.font-color: "#C0392B"
  style.bold: true
}

# Legend
legend: {
  near: bottom-center
  cpu: CPU-Pushed {
    style.fill: "#E8D5E3"
    shape: rectangle
  }
  err: Error Code {
    style.fill: "#FDEBD0"
    shape: rectangle
  }
  handler: Handler-Pushed {
    style.fill: "#D4E6F1"
    shape: rectangle
  }
  user: User Mode Only {
    style.fill: "#FADBD8"
    shape: rectangle
  }
  
  cpu -- err -- handler -- user
}

# Assembly reference
asm_ref: |md
  asm
  ; ISR common stub
  isr_common_stub:
      pusha           ; EDI,ESI,EBP,ESP,EBX,EDX,ECX,EAX
      push ds
      push es
      push fs
      push gs
      mov ax, 0x10    ; Load kernel DS
      mov ds, ax
      mov es, ax
      push esp        ; Pass regs* to C handler
      call c_handler
      ...
      iret            ; Restores EIP,CS,EFLAGS[,ESP,SS]
  
| {near: bottom-center}