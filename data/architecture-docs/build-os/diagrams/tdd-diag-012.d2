vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # PIC Remapping: IRQ to Vector Translation
| {near: top-center}

direction: right

# ========== DEFAULT MAPPING (PROBLEM) ==========
default_mapping: {
  label: "DEFAULT MAPPING\n(Problematic)"

  default_irqs: {
    label: ""

    irq0_def: "IRQ0\n(Timer)" {style.fill: "#ffcccc"}
    irq1_def: "IRQ1\n(Keyboard)" {style.fill: "#ffcccc"}
    irq2_def: "IRQ2\n(Cascade)" {style.fill: "#ffcccc"}
    irq7_def: "IRQ7\n(Parallel)" {style.fill: "#ffcccc"}
  }

  default_vectors: {
    label: ""

    v8: "Vector 8\n(Double Fault!)" {
      style.fill: "#ff6b6b"
      style.font-color: white
      style.bold: true
    }
    v9: "Vector 9\n(Coprocessor)" {style.fill: "#ffaaaa"}
    v10: "Vector 10\n(Invalid TSS)" {style.fill: "#ffaaaa"}
    v15: "Vector 15\n(Reserved)" {style.fill: "#ffaaaa"}
  }

  problem_note: |md
    **PROBLEM:** IRQ0 → Vector 8
    
    Vector 8 is CPU Double Fault!
    
    Timer tick looks like a
    catastrophic system failure!
  | {
    style.fill: "#ffeeee"
    style.stroke: red
    style.border-radius: 4
  }

  default_irqs -> default_vectors: "Maps to\n(BROKEN!)" {
    style.stroke: red
    style.stroke-dash: 3
    style.animated: true
  }
}

# ========== REMAPPED MAPPING (SOLUTION) ==========
remapped_mapping: {
  label: "REMAPPED MAPPING\n(Correct)"

  remapped_irqs: {
    label: ""

    irq0_rem: "IRQ0\n(Timer)" {style.fill: "#ccffcc"}
    irq1_rem: "IRQ1\n(Keyboard)" {style.fill: "#ccffcc"}
    irq2_rem: "IRQ2\n(Cascade)" {style.fill: "#ccffcc"}
    irq7_rem: "IRQ7\n(Parallel)" {style.fill: "#ccffcc"}
  }

  remapped_vectors: {
    label: ""

    v32: "Vector 32\n(Timer Handler)" {
      style.fill: "#90EE90"
      style.bold: true
    }
    v33: "Vector 33\n(Keyboard Handler)" {style.fill: "#90EE90"}
    v34: "Vector 34\n(Cascade Handler)" {style.fill: "#90EE90"}
    v39: "Vector 39\n(Parallel Handler)" {style.fill: "#90EE90"}
  }

  solution_note: |md
    **SOLUTION:** IRQ0 → Vector 32
    
    Vectors 32-47 are safe to use
    for hardware interrupts.
    
    No conflict with CPU exceptions!
  | {
    style.fill: "#eeffee"
    style.stroke: green
    style.border-radius: 4
  }

  remapped_irqs -> remapped_vectors: "Maps to\n(CORRECT)" {
    style.stroke: green
    style.stroke-width: 2
  }
}

# ========== PIC CASCADE STRUCTURE ==========
pic_structure: {
  label: "8259 PIC Cascade Structure"

  master_pic: "Master PIC\n(Port 0x20/0x21)" {
    style.fill: "#E8D4F8"
    shape: rectangle
  }

  slave_pic: "Slave PIC\n(Port 0xA0/0xA1)" {
    style.fill: "#D4E8F8"
    shape: rectangle
  }

  cpu: "CPU\n(INT Pin)" {
    shape: circle
    style.fill: "#FFE4B5"
  }

  cascade_note: |md
    **Cascade Configuration:**
    - Master handles IRQ0-IRQ7
    - Slave handles IRQ8-IRQ15
    - Slave INT connected to Master IRQ2
  | {
    style.fill: "#f5f5f5"
    style.border-radius: 4
  }

  slave_pic -> master_pic: "INT output → IRQ2"
  master_pic -> cpu: "INT output"
}

# ========== ICW PROGRAMMING SEQUENCE ==========
icw_sequence: {
  label: "ICW Programming Sequence"

  step1: "ICW1\n(0x11 to 0x20/0xA0)" {
    shape: rectangle
    style.fill: "#E6F3FF"
  }
  step1_detail: |md
    - Initialize PIC
    - Cascade mode
    - Need ICW4
  |

  step2: "ICW2\n(Offset to 0x21/0xA1)" {
    shape: rectangle
    style.fill: "#CCE5FF"
  }
  step2_detail: |md
    **Master:** 0x20 (vector 32)
    **Slave:** 0x28 (vector 40)
    
    Sets IRQ base vector
  |

  step3: "ICW3\n(Cascade config)" {
    shape: rectangle
    style.fill: "#B3D9FF"
  }
  step3_detail: |md
    **Master:** 0x04 (slave at IRQ2)
    **Slave:** 0x02 (I am slave ID 2)
  |

  step4: "ICW4\n(Mode setting)" {
    shape: rectangle
    style.fill: "#99CCFF"
  }
  step4_detail: |md
    0x01 = 8086 mode
    Manual EOI
  |

  step1 -> step2 -> step3 -> step4: {
    style.stroke: "#4a90d9"
    style.stroke-width: 2
  }
}

# ========== VECTOR ALLOCATION TABLE ==========
vector_table: {
  label: "Vector Allocation"

  cpu_exceptions: {
    label: "CPU Exceptions\n(Reserved)"
    style.fill: "#ffdddd"

    ex0: "0: Divide Error"
    ex1: "1: Debug"
    ex2: "2: NMI"
    ex3: "3: Breakpoint"
    ex8: "8: Double Fault"
    ex14: "14: Page Fault"
  }

  hardware_irqs: {
    label: "Hardware IRQs\n(Remapped)"
    style.fill: "#ddffdd"

    hw32: "32: IRQ0 Timer"
    hw33: "33: IRQ1 Keyboard"
    hw34: "34: IRQ2 Cascade"
    hw40: "40: IRQ8 RTC"
    hw46: "46: IRQ14 Disk"
  }

  available: {
    label: "Available\n(48-255)"
    style.fill: "#eeeeee"

    avail: "Software interrupts\nSyscalls (e.g., 0x80)"
  }
}

# ========== CODE EXAMPLE ==========
code_example: |md
  c
  void pic_remap(int offset1, int offset2) {
      // ICW1: Initialize
      outb(0x20, 0x11);  // Master
      outb(0xA0, 0x11);  // Slave
      
      // ICW2: Vector offsets
      outb(0x21, offset1);  // Master: IRQ0→vector 32
      outb(0xA1, offset2);  // Slave: IRQ8→vector 40
      
      // ICW3: Cascade configuration
      outb(0x21, 0x04);  // Master: slave at IRQ2
      outb(0xA1, 0x02);  // Slave: I am ID 2
      
      // ICW4: 8086 mode
      outb(0x21, 0x01);
      outb(0xA1, 0x01);
      
      // Clear masks (enable all IRQs)
      outb(0x21, 0x00);
      outb(0xA1, 0x00);
  }
  
  // Call with: pic_remap(32, 40);
  
| {
  near: bottom-center
  style.fill: "#2d2d2d"
  style.font-color: "#f8f8f2"
  style.font: mono
  style.border-radius: 8
}