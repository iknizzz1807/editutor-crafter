layout-engine: elk
theme-id: 200

title: "EOI Timing: Why Forgetting EOI Freezes the System"

direction: right

normal_flow: "Normal Flow (with EOI)" {
  timeline_normal: {
    shape: sequence_diagram
    
    PIC: "8259 PIC"
    CPU: "CPU"
    Handler: "IRQ Handler"
    
    "1. IRQ Fires": {
      PIC -> CPU: IRQ0 asserted
    }
    
    "2. CPU Acknowledges": {
      CPU -> PIC: INTA
      PIC -> CPU: Vector 32
      PIC: "ISR bit 0 SET"
    }
    
    "3. Handler Executes": {
      CPU -> Handler: Jump to handler
      Handler -> Handler: timer_ticks++
    }
    
    "4. EOI Sent": {
      Handler -> PIC: outb(0x20, 0x20)
      PIC: "ISR bit 0 CLEARED"
    }
    
    "5. Return": {
      Handler -> CPU: iret
    }
    
    "6. Next IRQ Ready": {
      PIC -> CPU: Next IRQ0 can fire
    }
  }
}

note_normal: |md
  **Key Point:** EOI clears the ISR bit,
  allowing lower-priority IRQs.
|
note_normal.near: top-center

frozen_flow: "Frozen System (WITHOUT EOI)" {
  timeline_frozen: {
    shape: sequence_diagram
    
    PIC2: "8259 PIC"
    CPU2: "CPU"
    Handler2: "IRQ Handler"
    Keyboard: "Keyboard"
    
    "1. Timer IRQ Fires": {
      PIC2 -> CPU2: IRQ0 asserted
      CPU2 -> PIC2: INTA
      PIC2 -> CPU2: Vector 32
      PIC2: "ISR bit 0 SET"
    }
    
    "2. Handler Executes": {
      CPU2 -> Handler2: Jump to handler
      Handler2 -> Handler2: timer_ticks++
      Handler2: "Forgot EOI!"
    }
    
    "3. Return (No EOI)": {
      Handler2 -> CPU2: iret
      PIC2: "ISR bit 0 STILL SET"
    }
    
    "4. Keyboard IRQ Blocked": {
      Keyboard -> PIC2: IRQ1 asserted
      PIC2 -> PIC2: Priority check
      PIC2: "IRQ1 < IRQ0 priority"
      PIC2: "BLOCKED by ISR bit 0"
    }
    
    "5. System Appears Frozen": {
      CPU2: "No more IRQs delivered"
      Keyboard: "Keystrokes lost"
    }
  }
}

note_frozen: |md
  **CRITICAL:** ISR bit 0 blocks all lower-priority
  IRQs (IRQ1-IRQ7). System doesn't crashâ€”it
  just stops responding to input!
|
note_frozen.near: top-center

pic_state: "PIC In-Service Register (ISR) State" {
  direction: right
  
  isr_normal: "After EOI (Normal)" {
    shape: sql_table
    Bit7: int
    Bit6: int
    Bit5: int
    Bit4: int
    Bit3: int
    Bit2: int
    Bit1: int
    Bit0: int
  }
  isr_normal_note: |md
    All ISR bits = 0
    All IRQs enabled
  |
  
  isr_frozen: "Without EOI (Frozen)" {
    shape: sql_table
    Bit7: int
    Bit6: int
    Bit5: int
    Bit4: int
    Bit3: int
    Bit2: int
    Bit1: int
    Bit0: int
  }
  isr_frozen_note: |md
    ISR bit 0 = 1 (STUCK)
    IRQ1-7 BLOCKED
  |
}

note_isr: |md
  The PIC won't deliver any IRQ with priority
  lower than the highest bit set in ISR.
  IRQ1 (keyboard) has lower priority than IRQ0 (timer).
|
note_isr.near: top-center

priority_diagram: "PIC Priority Chain" {
  direction: right
  
  irq0_node: "IRQ0 (Timer)\nHIGHEST PRIORITY" {
    style.fill: "#90EE90"
  }
  
  irq1_node: "IRQ1 (Keyboard)" {
    style.fill: "#FFD700"
  }
  
  irq2_node: "IRQ2 (Cascade)" {
    style.fill: "#ADD8E6"
  }
  
  irq3_7: "IRQ3-7\nLower Priority" {
    style.fill: "#D3D3D3"
  }
  
  irq0_node -> irq1_node: "Priority"
  irq1_node -> irq2_node: "Priority"
  irq2_node -> irq3_7: "Priority"
}

block_indicator: "ISR bit 0=1 blocks everything below" {
  shape: text
  style: {
    font-color: red
    bold: true
  }
}

code_example: "Correct EOI in Handler" {
  correct_code: |c
    void irq_handler(registers_t *regs) {
        uint8_t irq = regs->int_no - 32;
        
        // Handle the IRQ
        switch (irq) {
            case 0: timer_handler(); break;
            case 1: keyboard_handler(); break;
        }
        
        // CRITICAL: Send EOI
        pic_send_eoi(irq);  // NEVER FORGET!
    }
  |
  
  eoi_function: |c
    void pic_send_eoi(uint8_t irq) {
        if (irq >= 8) {
            // From slave PIC
            outb(PIC2_CMD, PIC_EOI);
        }
        // Always send to master
        outb(PIC1_CMD, PIC_EOI);
    }
  |
}

symptom_table: "Debugging: EOI Forgetting Symptoms" {
  shape: sql_table
  Symptom: string
  Cause: string
  Fix: string
}

normal_flow -> frozen_flow: "What if we forget?"
frozen_flow -> pic_state: "Register state"
pic_state -> priority_diagram: "Why keyboard blocked"
priority_diagram -> code_example: "The fix"
code_example -> symptom_table: "Debug guide"