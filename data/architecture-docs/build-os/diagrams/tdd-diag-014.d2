vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Keyboard Scancode Processing
  ## IRQ1 Handler: PS/2 Controller → ASCII Buffer
| {near: top-center}

direction: right

step1: {
  label: "1. IRQ1 Fires"
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  
  note1: |md
    Keyboard controller asserts IRQ1
    CPU jumps to vector 33 (after PIC remap)
    Handler: `keyboard_handler()`
  |
}

step2: {
  label: "2. Read Scancode"
  style.fill: "#FFF9C4"
  style.stroke: "#F9A825"
  style.bold: true
  
  note2: |md
    
    uint8_t scancode = inb(0x60);
    
    Port 0x60 = PS/2 data register
    Scancode Set 1 (default)
  |
  
  reg_scancode: {
    label: "scancode"
    shape: rectangle
    style.fill: "#FFF3E0"
    style.stroke: "#FF9800"
    width: 80
  }
}

step3: {
  label: "3. Make/Break Detection"
  style.fill: "#E3F2FD"
  style.stroke: "#1976D2"
  style.bold: true
  
  check_break: {
    label: "bit 7 set?"
    shape: diamond
    style.fill: "#BBDEFB"
    style.stroke: "#1976D2"
    width: 120
  }
  
  break_path: {
    label: "Break Code\n(key released)"
    style.fill: "#FFCDD2"
    style.stroke: "#E53935"
    
    note_break: |md
      
      if (scancode & 0x80) {
        scancode &= 0x7F;  // Clear bit 7
        // Check for shift release
        if (scancode == 0x2A || scancode == 0x36)
          shift_pressed = 0;
        return;  // Ignore other breaks
      }
      
    |
  }
  
  make_path: {
    label: "Make Code\n(key pressed)"
    style.fill: "#C8E6C9"
    style.stroke: "#43A047"
  }
}

step4: {
  label: "4. Modifier Tracking"
  style.fill: "#F3E5F5"
  style.stroke: "#8E24AA"
  style.bold: true
  
  check_modifier: {
    label: "Shift key?"
    shape: diamond
    style.fill: "#E1BEE7"
    style.stroke: "#8E24AA"
    width: 100
  }
  
  shift_set: {
    label: "shift_pressed = 1"
    style.fill: "#CE93D8"
    style.stroke: "#8E24AA"
  }
  
  shift_state: {
    label: |md
      **State Variable**
      
      static int shift_pressed = 0;
      
    |
    shape: rectangle
    style.fill: "#F3E5F5"
    style.stroke: "#8E24AA"
    style.stroke-dash: 3
  }
}

step5: {
  label: "5. Scancode → ASCII"
  style.fill: "#E8F5E9"
  style.stroke: "#2E7D32"
  style.bold: true
  
  tables: {
    label: "Translation Tables"
    
    normal_table: {
      label: |md
        `scancode_to_ascii[]`
        
        0x1E → 'a'
        0x30 → 'b'
        0x2E → 'c'
        ...
      |
      style.fill: "#C8E6C9"
      style.stroke: "#43A047"
    }
    
    shift_table: {
      label: |md
        `scancode_to_ascii_shift[]`
        
        0x1E → 'A'
        0x30 → 'B'
        0x2E → 'C'
        ...
      |
      style.fill: "#A5D6A7"
      style.stroke: "#2E7D32"
    }
  }
  
  selection: {
    label: |md
      
      char ascii = shift_pressed 
        ? scancode_to_ascii_shift[scancode]
        : scancode_to_ascii[scancode];
      
    |
    style.fill: "#DCEDC8"
    style.stroke: "#7CB342"
  }
  
  reg_ascii: {
    label: "ascii"
    shape: rectangle
    style.fill: "#C8E6C9"
    style.stroke: "#43A047"
    width: 60
  }
}

step6: {
  label: "6. Buffer Insertion"
  style.fill: "#FFF3E0"
  style.stroke: "#E65100"
  style.bold: true
  
  check_valid: {
    label: "ascii != 0?"
    shape: diamond
    style.fill: "#FFE0B2"
    style.stroke: "#F57C00"
    width: 100
  }
  
  buffer_struct: {
    label: |md
      **Circular Buffer**
      
      char keyboard_buffer[256];
      uint32_t read_pos = 0;
      uint32_t write_pos = 0;
      
    |
    style.fill: "#FFE0B2"
    style.stroke: "#F57C00"
    
    buffer_mem: {
      label: |md
        [0] [1] [2] ... [254] [255]
         ↑               ↑
       read_pos       write_pos
      |
      style.fill: "#FFCC80"
      style.stroke: "#EF6C00"
      style.font: mono
    }
  }
  
  insert_code: {
    label: |md
      
      if (ascii != 0) {
        keyboard_buffer[write_pos] = ascii;
        write_pos = (write_pos + 1) % 256;
      }
      
    |
    style.fill: "#FFE0B2"
    style.stroke: "#F57C00"
  }
}

step7: {
  label: "7. EOI & Return"
  style.fill: "#FFEBEE"
  style.stroke: "#C62828"
  
  eoi: {
    label: |md
      
      pic_send_eoi(1);  // IRQ1
      
      **CRITICAL**: Without EOI,
      all lower-priority IRQs blocked
    |
    style.fill: "#FFCDD2"
    style.stroke: "#E53935"
  }
  
  iret: {
    label: "iret"
    style.fill: "#EF9A9A"
    style.stroke: "#C62828"
  }
}

step1 -> step2: "handler entry"
step2 -> step3: "scancode read"
step3.check_break -> step3.break_path: "yes"
step3.check_break -> step3.make_path: "no"
step3.break_path -> step7: "return"

step3.make_path -> step4.check_modifier
step4.check_modifier -> step4.shift_set: "yes (0x2A/0x36)"
step4.check_modifier -> step5: "no"
step4.shift_set -> step4.shift_state: "update"
step4.shift_set -> step7: "return"

step5 -> step5.tables: "lookup"
step5.tables -> step5.selection: "select"
step5.selection -> step5.reg_ascii: "result"
step5.reg_ascii -> step6.check_valid

step6.check_valid -> step6.insert_code: "yes"
step6.check_valid -> step7: "no"
step6.insert_code -> step6.buffer_struct: "store"
step6.insert_code -> step7

step7.eoi -> step7.iret
step7.iret -> end: "resume"

end: {
  label: "Interrupted Code\nResumes"
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
}

legend: {
  near: bottom-center
  label: |md
    **Scancode Examples (Set 1)**
    
    | Scancode | Key      | Make  | Break |
    |----------|----------|-------|-------|
    | 0x1E     | A        | 0x1E  | 0x9E  |
    | 0x2A     | L-Shift  | 0x2A  | 0xAA  |
    | 0x36     | R-Shift  | 0x36  | 0xB6  |
    | 0x39     | Space    | 0x39  | 0xB9  |
  |
}

state_box: {
  near: step4.shift_state
  label: |md
    **Persistent State**
    Modified by IRQ handler only
    (single-threaded in IRQ context)
  |
  style.fill: "#F5F5F5"
  style.stroke: "#9E9E9E"
  style.stroke-dash: 3
}