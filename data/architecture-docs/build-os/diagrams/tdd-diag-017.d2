layout-engine: elk
theme-id: 200

title: |md
  # Physical Memory Map: E820/Multiboot Regions
  Typical 1GB System Layout
| {near: top-center}

# Memory Address Space Container
memory_space: {
  label: "32-bit Physical Address Space (4GB max)"
  style.fill: "#f8f9fa"
  style.stroke: "#dee2e6"
  style.stroke-width: 2
  
  # Address scale
  scale: {
    shape: text
    label: |md
      0x00000000
      │
      │
      │
      0x000FFFFF
      │
      │
      0x00100000
      │
      │
      0x00FFFFFF
      │
      │
      0x01000000
      │
      │
      0x7FFFFFFF
    |
    style.font: mono
    style.font-size: 11
    style.font-color: "#6c757d"
  }
  
  # Region 0: Low Memory (0x0 - 0xFFFFF)
  low_mem: {
    label: "Conventional + Extended\n(0x00000000 - 0x000FFFFF)\n1 MB"
    shape: rectangle
    width: 400
    height: 80
    style.fill: "#ffcccc"
    style.stroke: "#dc3545"
    style.stroke-width: 2
    
    # Sub-regions within low memory
    ivt_bda: {
      label: "IVT/BDA\n0x0-0x4FF"
      shape: rectangle
      width: 380
      height: 20
      style.fill: "#ff9999"
      style.stroke: "#dc3545"
      style.stroke-dash: 2
    }
    
    bios_data: {
      label: "BIOS Data\n0x400-0x4FF"
      shape: rectangle
      width: 380
      height: 15
      style.fill: "#ff9999"
      style.stroke: "#dc3545"
      style.stroke-dash: 2
    }
    
    usable_low: {
      label: "Usable (limited)\n0x500-0x7FFFF"
      shape: rectangle
      width: 380
      height: 20
      style.fill: "#c3e6cb"
      style.stroke: "#28a745"
    }
    
    vga_rom: {
      label: "VGA ROM / Video Memory\n0xA0000-0xFFFFF"
      shape: rectangle
      width: 380
      height: 20
      style.fill: "#ff9999"
      style.stroke: "#dc3545"
      style.stroke-dash: 2
    }
  }
  
  # Region 1: Kernel Space (0x100000 - 0xFFFFFF)
  kernel_space: {
    label: "Kernel Load Area\n(0x00100000 - 0x00FFFFFF)\n~15 MB"
    shape: rectangle
    width: 400
    height: 60
    style.fill: "#d4edda"
    style.stroke: "#28a745"
    style.stroke-width: 2
    
    kernel_binary: {
      label: "Kernel Binary\n0x100000+"
      shape: rectangle
      width: 180
      style.fill: "#c3e6cb"
      style.stroke: "#28a745"
    }
    
    kernel_bss: {
      label: "Kernel BSS\n& Data"
      shape: rectangle
      width: 180
      style.fill: "#c3e6cb"
      style.stroke: "#28a745"
    }
  }
  
  # Region 2: Main Usable RAM
  main_ram: {
    label: "Main Usable RAM\n(0x01000000 - 0x7FFFFFFF)\n~1008 MB"
    shape: rectangle
    width: 400
    height: 150
    style.fill: "#c3e6cb"
    style.stroke: "#28a745"
    style.stroke-width: 3
    
    # Memory hole
    hole_15mb: {
      label: |md
        **Memory Hole**
        (ISA DMA 15-16 MB)
        Type: RESERVED
      |
      shape: rectangle
      width: 380
      height: 30
      style.fill: "#fff3cd"
      style.stroke: "#ffc107"
      style.stroke-dash: 4
    }
    
    # ACPI Region
    acpi_region: {
      label: |md
        **ACPI Tables**
        (RSDP, RSDT, MADT, etc.)
        Type: ACPI_RECLAIMABLE
      |
      shape: rectangle
      width: 380
      height: 30
      style.fill: "#cce5ff"
      style.stroke: "#007bff"
    }
    
    # ACPI NVS
    acpi_nvs: {
      label: |md
        **ACPI NVS**
        (Non-Volatile Storage)
        Type: ACPI_NVS
      |
      shape: rectangle
      width: 380
      height: 25
      style.fill: "#d6d8db"
      style.stroke: "#6c757d"
    }
    
    usable_high: {
      label: "Available for Allocation\n(Physical Frame Allocator)"
      shape: rectangle
      width: 380
      height: 50
      style.fill: "#c3e6cb"
      style.stroke: "#28a745"
    }
  }
}

# Legend
legend: {
  label: "Legend"
  shape: rectangle
  width: 300
  style.fill: "#f8f9fa"
  style.stroke: "#dee2e6"
  near: top-right
  
  legend_usable: {
    label: "USABLE (Type 1)"
    shape: rectangle
    width: 100
    height: 20
    style.fill: "#c3e6cb"
    style.stroke: "#28a745"
  }
  
  legend_reserved: {
    label: "RESERVED (Type 2)"
    shape: rectangle
    width: 100
    height: 20
    style.fill: "#ffcccc"
    style.stroke: "#dc3545"
  }
  
  legend_acpi_rec: {
    label: "ACPI_RECLAIM (Type 3)"
    shape: rectangle
    width: 100
    height: 20
    style.fill: "#cce5ff"
    style.stroke: "#007bff"
  }
  
  legend_acpi_nvs: {
    label: "ACPI_NVS (Type 4)"
    shape: rectangle
    width: 100
    height: 20
    style.fill: "#d6d8db"
    style.stroke: "#6c757d"
  }
  
  legend_hole: {
    label: "Memory Hole"
    shape: rectangle
    width: 100
    height: 20
    style.fill: "#fff3cd"
    style.stroke: "#ffc107"
    style.stroke-dash: 4
  }
}

# E820 Entry Structure
e820_struct: {
  label: "E820/Multiboot Entry Structure"
  shape: class
  near: bottom-left
  
  "+base": "uint64_t"
  "+length": "uint64_t"
  "+type": "uint32_t"
  "+acpi_attrs": "uint32_t"
  
  style.fill: "#e9ecef"
  style.stroke: "#495057"
}

# Type Codes
type_codes: {
  label: "Memory Type Codes"
  shape: sql_table
  near: bottom-right
  
  type: "Type"
  value: "Value"
  desc: "Description"
  
  row1_type: "MEMORY_TYPE_USABLE"
  row1_value: "1"
  row1_desc: "Available RAM"
  row2_type: "MEMORY_TYPE_RESERVED"
  row2_value: "2"
  row2_desc: "Reserved (BIOS, MMIO)"
  row3_type: "MEMORY_TYPE_ACPI_RECLAIM"
  row3_value: "3"
  row3_desc: "ACPI tables (reclaimable)"
  row4_type: "MEMORY_TYPE_ACPI_NVS"
  row4_value: "4"
  row4_desc: "ACPI NVS (preserve)"
  row5_type: "MEMORY_TYPE_BAD"
  row5_value: "5"
  row5_desc: "Bad memory"
  
  style.fill: "#f8f9fa"
}

# Annotations
annotation_pmm: {
  label: |md
    **PMM Initialization**
    
    for each region:
      if type == USABLE:
        for frame in region:
          mark_frame_free(frame)
    
    // Always mark low 1MB used
    for addr in 0x0..0x100000:
      mark_frame_used(addr)
    
  |
  shape: text
  near: center-left
  style.font: mono
  style.font-size: 10
}

# Layout connections
memory_space.low_mem -> memory_space.kernel_space: "+1 MB"
memory_space.kernel_space -> memory_space.main_ram: "+15 MB"

legend.legend_usable -> legend.legend_reserved
legend.legend_reserved -> legend.legend_acpi_rec
legend.legend_acpi_rec -> legend.legend_acpi_nvs
legend.legend_acpi_nvs -> legend.legend_hole