vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # x86 Two-Level Page Table Translation
| {near: top-center}

# Virtual Address Decomposition
virtual_address: {
  label: "Virtual Address (32-bit)"
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  
  bits31_22: {
    label: "PD Index\n(bits 31-22)"
    shape: rectangle
    style.fill: "#9B59B6"
    style.font-color: white
    width: 100
  }
  
  bits21_12: {
    label: "PT Index\n(bits 21-12)"
    shape: rectangle
    style.fill: "#3498DB"
    style.font-color: white
    width: 100
  }
  
  bits11_0: {
    label: "Offset\n(bits 11-0)"
    shape: rectangle
    style.fill: "#27AE60"
    style.font-color: white
    width: 100
  }
}

# Page Directory
page_directory: {
  label: "Page Directory\n(4KB, 1024 entries)"
  shape: rectangle
  style.fill: "#D5B8E8"
  style.stroke: "#9B59B6"
  style.stroke-width: 2
  width: 200
  height: 300
  
  pd_entries: {
    label: |md
      Entry 0
      Entry 1
      ...
      **Entry N** ← PD Index
      ...
      Entry 1023
    |
    shape: text
  }
  
  pde_n: {
    label: "PDE[N]\n(base + N×4)"
    shape: rectangle
    style.fill: "#9B59B6"
    style.font-color: white
    style.stroke: white
    width: 80
    height: 40
  }
}

# Page Table
page_table: {
  label: "Page Table\n(4KB, 1024 entries)"
  shape: rectangle
  style.fill: "#AED6F1"
  style.stroke: "#3498DB"
  style.stroke-width: 2
  width: 200
  height: 300
  
  pt_entries: {
    label: |md
      Entry 0
      Entry 1
      ...
      **Entry M** ← PT Index
      ...
      Entry 1023
    |
    shape: text
  }
  
  pte_m: {
    label: "PTE[M]\n(pt_base + M×4)"
    shape: rectangle
    style.fill: "#3498DB"
    style.font-color: white
    style.stroke: white
    width: 80
    height: 40
  }
}

# Physical Memory
physical_frame: {
  label: "Physical Frame\n(4KB)"
  shape: rectangle
  style.fill: "#A9DFBF"
  style.stroke: "#27AE60"
  style.stroke-width: 2
  width: 200
  height: 150
  
  frame_data: {
    label: |md
      Byte 0
      Byte 1
      ...
      **Byte Offset** ← bits 11-0
      ...
      Byte 4095
    |
    shape: text
  }
  
  target_byte: {
    label: "Data"
    shape: rectangle
    style.fill: "#27AE60"
    style.font-color: white
    width: 60
    height: 30
  }
}

# CR3 Register
cr3: {
  label: "CR3\n(PDBR)"
  shape: rectangle
  style.fill: "#F39C12"
  style.font-color: white
  style.stroke: "#D35400"
  width: 80
  height: 50
}

# Physical Address Assembly
physical_address: {
  label: "Physical Address (32-bit)"
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  
  frame_addr: {
    label: "Frame Base\n(bits 31-12)\nfrom PTE"
    shape: rectangle
    style.fill: "#27AE60"
    style.font-color: white
    width: 140
  }
  
  page_offset: {
    label: "Offset\n(bits 11-0)\nfrom VA"
    shape: rectangle
    style.fill: "#27AE60"
    style.font-color: white
    style.stroke-dash: 3
    width: 80
  }
}

# Connections - Translation Flow
cr3 -> page_directory: "points to\n(base addr)" {
  style.stroke: "#F39C12"
  style.stroke-width: 2
}

virtual_address.bits31_22 -> page_directory.pde_n: "index\n→ N" {
  style.stroke: "#9B59B6"
  style.stroke-width: 2
  style.animated: true
}

page_directory.pde_n -> page_table: "contains\nPT base addr" {
  style.stroke: "#9B59B6"
  style.stroke-width: 2
  style.animated: true
}

virtual_address.bits21_12 -> page_table.pte_m: "index\n→ M" {
  style.stroke: "#3498DB"
  style.stroke-width: 2
  style.animated: true
}

page_table.pte_m -> physical_frame: "contains\nframe base" {
  style.stroke: "#3498DB"
  style.stroke-width: 2
  style.animated: true
}

virtual_address.bits11_0 -> physical_frame.target_byte: "offset\nwithin frame" {
  style.stroke: "#27AE60"
  style.stroke-width: 2
  style.animated: true
}

page_table.pte_m -> physical_address.frame_addr: "bits 31-12" {
  style.stroke: "#27AE60"
  style.stroke-dash: 3
}

virtual_address.bits11_0 -> physical_address.page_offset: "bits 11-0" {
  style.stroke: "#27AE60"
  style.stroke-dash: 3
}

# Legend
legend: {
  near: bottom-right
  content: |md
    **Translation Steps:**
    1. Extract PD index (bits 31-22) from VA
    2. Read PDE[N] from Page Directory (CR3 + N×4)
    3. Extract PT base address from PDE
    4. Extract PT index (bits 21-12) from VA
    5. Read PTE[M] from Page Table (PT_base + M×4)
    6. Extract frame base from PTE (bits 31-12)
    7. Combine with offset (bits 11-0) → Physical Address
    
    **Total: 2 memory accesses per translation**
    (without TLB caching)
  |
  shape: text
  style.font-size: 14
}

# PDE/PTE Structure Detail
pde_structure: {
  label: "PDE/PTE Entry (4 bytes)"
  shape: rectangle
  style.fill: "#F5F5F5"
  style.stroke: "#666666"
  width: 350
}

pde_fields: {
  label: |md
    **PDE/PTE Entry Fields:**
    
    | Bits | Field |
    |------|-------|
    | 0 | Present (P) |
    | 1 | Read/Write (R/W) |
    | 2 | User/Supervisor (U/S) |
    | 3 | Write-Through (PWT) |
    | 4 | Cache Disable (PCD) |
    | 5 | Accessed (A) |
    | 6 | Dirty (PTE only) |
    | 7 | Page Size (PDE only) |
    | 8 | Global (PTE only) |
    | 9-11 | Available (OS) |
    | 12-31 | **Frame/Page Table Address** |
  |
  shape: text
}

# TLB Note
tlb_note: {
  near: top-right
  content: |md
    **TLB (Translation Lookaside Buffer)**
    Caches recent VA→PA translations
    - 32-64 entries typical
    - Hit: 0 extra memory accesses
    - Miss: 2 memory accesses (PD + PT)
  |
  shape: text
  style.fill: "#FFF9C4"
  style.stroke: "#F9A825"
  style.stroke-width: 1
}