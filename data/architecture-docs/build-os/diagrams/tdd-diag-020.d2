vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # PDE and PTE Entry Layout (4 bytes each)
  32-bit x86 Page Directory and Page Table Entry Structure
| {near: top-center}

direction: right

entry_breakdown: {
  label: "32-bit Entry Structure"
  
  bytes_view: {
    label: "Byte View (Little-Endian)"
    
    byte3: "Byte 3\n[31:24]" {
      style.fill: "#E8D4F0"
      style.stroke: "#8B5CF6"
    }
    byte2: "Byte 2\n[23:16]" {
      style.fill: "#D4E8F0"
      style.stroke: "#3B82F6"
    }
    byte1: "Byte 1\n[15:8]" {
      style.fill: "#D4E8F0"
      style.stroke: "#3B82F6"
    }
    byte0: "Byte 0\n[7:0]" {
      style.fill: "#D4F0E8"
      style.stroke: "#10B981"
    }
    
    byte3 -> byte2 -> byte1 -> byte0
  }
  
  bit_breakdown: {
    label: "Bit-Level Layout"
    
    bits_31_12: "[31:12]\nFrame Address\n(20 bits)" {
      width: 200
      style.fill: "#3B82F6"
      style.font-color: white
      style.stroke: "#1D4ED8"
    }
    
    bits_11_9: "[11:9]\nAVL\n(3 bits)" {
      width: 60
      style.fill: "#9CA3AF"
      style.font-color: white
    }
    
    bit_8: "G\n[8]" {
      width: 40
      style.fill: "#F59E0B"
      style.font-color: white
    }
    
    bit_7: "PS/D\n[7]" {
      width: 40
      style.fill: "#8B5CF6"
      style.font-color: white
    }
    
    bit_6: "A/D\n[6]" {
      width: 40
      style.fill: "#8B5CF6"
      style.font-color: white
    }
    
    bit_5: "PCD\n[5]" {
      width: 40
      style.fill: "#EC4899"
      style.font-color: white
    }
    
    bit_4: "PWT\n[4]" {
      width: 40
      style.fill: "#EC4899"
      style.font-color: white
    }
    
    bit_3: "U/S\n[3]" {
      width: 40
      style.fill: "#EF4444"
      style.font-color: white
    }
    
    bit_2: "R/W\n[2]" {
      width: 40
      style.fill: "#EF4444"
      style.font-color: white
    }
    
    bit_1: "P\n[1]" {
      width: 40
      style.fill: "#10B981"
      style.font-color: white
    }
    
    bit_0: "0\n[0]" {
      width: 40
      style.fill: "#6B7280"
      style.font-color: white
    }
    
    bits_31_12 -> bits_11_9 -> bit_8 -> bit_7 -> bit_6 -> bit_5 -> bit_4 -> bit_3 -> bit_2 -> bit_1 -> bit_0
  }
}

flag_legend: {
  label: "Flag Definitions"
  
  present: {
    label: |md
      **P (Present)** - Bit 0
      - `1` = Page/table is in memory
      - `0` = Not present, access causes #PF
    |
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
  }
  
  rw: {
    label: |md
      **R/W (Read/Write)** - Bit 1
      - `1` = Read and write allowed
      - `0` = Read-only access
    |
    style.fill: "#FEE2E2"
    style.stroke: "#EF4444"
  }
  
  us: {
    label: |md
      **U/S (User/Supervisor)** - Bit 2
      - `1` = User mode (ring 3) can access
      - `0` = Kernel only (ring 0-2)
    |
    style.fill: "#FEE2E2"
    style.stroke: "#EF4444"
  }
  
  cache: {
    label: |md
      **PWT/PCD** - Bits 3-4
      - PWT: Page-level write-through
      - PCD: Page-level cache disable
    |
    style.fill: "#FCE7F3"
    style.stroke: "#EC4899"
  }
  
  accessed: {
    label: |md
      **A (Accessed) / D (Dirty)** - Bit 5-6
      - A: CPU sets on read (both PDE/PTE)
      - D: CPU sets on write (PTE only)
    |
    style.fill: "#EDE9FE"
    style.stroke: "#8B5CF6"
  }
  
  ps: {
    label: |md
      **PS (Page Size)** - Bit 7
      - PDE: `1` = 4MB page, `0` = 4KB page
      - PTE: Dirty bit (set by CPU on write)
    |
    style.fill: "#EDE9FE"
    style.stroke: "#8B5CF6"
  }
  
  global: {
    label: |md
      **G (Global)** - Bit 8
      - `1` = Not flushed on CR3 reload
      - Used for kernel pages
    |
    style.fill: "#FEF3C7"
    style.stroke: "#F59E0B"
  }
  
  avl: {
    label: |md
      **AVL (Available)** - Bits 9-11
      - Free for OS use
      - Often used for: COW, swap, etc.
    |
    style.fill: "#F3F4F6"
    style.stroke: "#9CA3AF"
  }
  
  frame: {
    label: |md
      **Frame Address** - Bits 12-31
      - Physical address of page table (PDE)
      - Physical address of frame (PTE)
      - Must be 4KB aligned (bits 0-11 = 0)
    |
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
}

differences: {
  label: "PDE vs PTE Bit Differences"
  
  comparison: {
    shape: sql_table
    Bit: string
    PDE: string
    PTE: string
    
    row1: "6" {constraint: primary_key}
    row1_pde: "Accessed"
    row1_pte: "Dirty"
    
    row2: "7"
    row2_pde: "PS (Page Size)"
    row2_pte: "Pat (Page Attr)"
    
    row3: "8"
    row3_pde: "G (Global)"
    row3_pte: "G (Global)"
  }
}

examples: {
  label: "Example Entry Values"
  
  kernel_code: {
    label: |md
      **Kernel Code Page**
      `0x00000083`
      - Frame: 0x00000 (identity mapped)
      - P=1, R/W=0 (read-only), U/S=0 (kernel)
      - PS=1 (4MB page in PDE)
    |
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
  
  user_data: {
    label: |md
      **User Data Page**
      `0x00B80007`
      - Frame: 0x00B80 (physical 0xB8000)
      - P=1, R/W=1 (writable), U/S=1 (user)
    |
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
  }
  
  not_present: {
    label: |md
      **Not Present Entry**
      `0x00000000`
      - P=0 (page not in memory)
      - Access triggers #PF
    |
    style.fill: "#FEE2E2"
    style.stroke: "#EF4444"
  }
}

translation_note: {
  label: ||md
    ### Virtual Address Decomposition
    
    | Bits | Field | Description |
    |------|-------|-------------|
    | [31:22] | PD Index | Index into Page Directory (1024 entries) |
    | [21:12] | PT Index | Index into Page Table (1024 entries) |
    | [11:0] | Offset | Offset within 4KB page |
    
    **Translation:**  
    `PDE = PD[pd_index]`  
    `PTE = PT[pt_index]` (where PT = PDE frame)  
    `phys = PTE.frame + offset`
  ||
  style.fill: "#F8FAFC"
  style.stroke: "#64748B"
}

size_info: {
  label: |md
    **sizeof(PDE/PTE) = 4 bytes**
    
    - Page Directory: 1024 entries = 4KB (one page)
    - Page Table: 1024 entries = 4KB (one page)
    - Frame address must be 4KB aligned
  |
  style.fill: "#FEF3C7"
  style.stroke: "#F59E0B"
}