vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Identity Mapping vs Higher-Half Mapping
  Side-by-side comparison of address translation strategies
| {near: top-center}

direction: right

classes: {
  vaddr: {
    style: {
      fill: "#E3F2FD"
      stroke: "#1565C0"
      stroke-width: 2
      font-color: "#0D47A1"
    }
  }
  paddr: {
    style: {
      fill: "#C8E6C9"
      stroke: "#2E7D32"
      stroke-width: 2
      font-color: "#1B5E20"
    }
  }
  frame: {
    shape: rectangle
    width: 140
    height: 40
    style: {
      fill: "#FFF3E0"
      stroke: "#E65100"
      stroke-width: 2
      font-color: "#BF360C"
    }
  }
  arrow: {
    style: {
      stroke: "#7B1FA2"
      stroke-width: 3
    }
  }
  section: {
    style: {
      fill: "#FAFAFA"
      stroke: "#9E9E9E"
      stroke-dash: 3
    }
  }
}

Identity_Mapping: {
  label: "Identity Mapping\n(virtual == physical)"
  class: section
  
  Virtual_Addresses: {
    label: "Virtual Addresses"
    style.fill: "#E3F2FD"
    
    va_0: "0x00000000" {class: vaddr}
    va_1: "0x00001000" {class: vaddr}
    va_kernel: "0x00100000\n(Kernel)" {class: vaddr; style.fill: "#FFECB3"}
    va_vga: "0x000B8000\n(VGA)" {class: vaddr; style.fill: "#F8BBD9"}
    va_4mb: "0x00400000" {class: vaddr}
  }
  
  Arrow_Id: {
    shape: text
    label: |md
      
      ────────────►
      vaddr = paddr
      
    |
    style: {
      font-size: 14
      font-color: "#7B1FA2"
    }
  }
  
  Physical_Memory: {
    label: "Physical Memory"
    style.fill: "#C8E6C9"
    
    pm_0: "Frame 0\n0x00000000" {class: frame}
    pm_1: "Frame 1\n0x00001000" {class: frame}
    pm_kernel: "Kernel\n0x00100000" {class: frame; style.fill: "#FFE082"}
    pm_vga: "VGA Buffer\n0x000B8000" {class: frame; style.fill: "#F48FB1"}
    pm_4mb: "Frame 1024\n0x00400000" {class: frame}
  }
  
  va_0 -> Arrow_Id -> pm_0 {class: arrow; style.stroke-dash: 0}
  va_1 -> Arrow_Id -> pm_1 {class: arrow; style.stroke-dash: 0}
  va_kernel -> Arrow_Id -> pm_kernel {class: arrow; style.stroke-dash: 0}
  va_vga -> Arrow_Id -> pm_vga {class: arrow; style.stroke-dash: 0}
  va_4mb -> Arrow_Id -> pm_4mb {class: arrow; style.stroke-dash: 0}
}

Higher_Half_Mapping: {
  label: "Higher-Half Mapping\n(virtual = 0xC0000000 + physical)"
  class: section
  
  Virtual_Addresses_High: {
    label: "Virtual Addresses"
    style.fill: "#E3F2FD"
    
    vah_kern: "0xC0100000\n(Kernel)" {class: vaddr; style.fill: "#FFECB3"}
    vah_vga: "0xC00B8000\n(VGA)" {class: vaddr; style.fill: "#F8BBD9"}
    vah_0: "0xC0000000" {class: vaddr}
    vah_1: "0xC0001000" {class: vaddr}
    vah_4mb: "0xC0400000" {class: vaddr}
  }
  
  Arrow_High: {
    shape: text
    label: |md
      
      ────────────►
      vaddr - 0xC0000000
         = paddr
      
    |
    style: {
      font-size: 14
      font-color: "#7B1FA2"
    }
  }
  
  Physical_Memory_High: {
    label: "Physical Memory"
    style.fill: "#C8E6C9"
    
    pmh_0: "Frame 0\n0x00000000" {class: frame}
    pmh_1: "Frame 1\n0x00001000" {class: frame}
    pmh_kernel: "Kernel\n0x00100000" {class: frame; style.fill: "#FFE082"}
    pmh_vga: "VGA Buffer\n0x000B8000" {class: frame; style.fill: "#F48FB1"}
    pmh_4mb: "Frame 1024\n0x00400000" {class: frame}
  }
  
  vah_0 -> Arrow_High -> pmh_0 {class: arrow; style.stroke-dash: 0}
  vah_1 -> Arrow_High -> pmh_1 {class: arrow; style.stroke-dash: 0}
  vah_kern -> Arrow_High -> pmh_kernel {class: arrow; style.stroke-dash: 0}
  vah_vga -> Arrow_High -> pmh_vga {class: arrow; style.stroke-dash: 0}
  vah_4mb -> Arrow_High -> pmh_4mb {class: arrow; style.stroke-dash: 0}
}

Legend: {
  near: bottom-center
  shape: rectangle
  style: {
    fill: "#FAFAFA"
    stroke: "#9E9E9E"
    stroke-dash: 3
  }
  
  legend_title: "Legend" {style.bold: true}
  
  leg_va: "Virtual Address" {class: vaddr; width: 100}
  leg_pa: "Physical Frame" {class: frame; width: 100}
  leg_kern: "Kernel Code" {shape: rectangle; width: 100; style.fill: "#FFE082"}
  leg_vga: "VGA Buffer" {shape: rectangle; width: 100; style.fill: "#F48FB1"}
}

Notes: |md
  ## Key Differences
  
  **Identity Mapping:**
  - Virtual address equals physical address
  - Used during paging enable transition
  - Required for bootstrap (CPU continues executing same code)
  - Maps 0x0 - 0x400000 → 0x0 - 0x400000
  
  **Higher-Half Mapping:**
  - Virtual address = 0xC0000000 + physical
  - Kernel lives at 0xC0100000+ in virtual space
  - User processes use lower half (0x00000000 - 0xBFFFFFFF)
  - Provides isolation: user cannot access kernel directly
  - Maps 0xC0000000 - 0xC0400000 → 0x0 - 0x400000
  
  **Both Required:**
  - Identity map needed during `mov cr0` (paging enable)
  - Higher-half map for normal kernel operation
  - Transition: enable paging with identity, then jump to higher-half
| {near: bottom-center}