vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # TLB Coherency: invlpg vs CR3 Reload
| {near: top-center}

direction: right

invlpg_method: {
  label: "Single-Entry Invalidation\n(invlpg)"
  style.fill: "#E8F5E9"
  style.stroke: "#4CAF50"
  style.stroke-width: 2
  
  header: |md
    **`invlpg virtual_addr`**
| {shape: text}
  
  sequence: {
    shape: sequence_diagram
    
    code: Code
    cpu: CPU
    tlb: TLB
    
    code -> cpu: "1. Execute invlpg"
    cpu -> tlb: "2. Invalidate single entry"
    tlb -> tlb: "3. Entry removed"
    code <- tlb: "4. Ready (~25 cycles)"
  }
  
  characteristics: {
    shape: class
    label: "Characteristics"
    
    cycles: "~25 cycles"
    scope: "Single 4KB page"
    cache_impact: "Other TLB entries preserved"
    use_case: "Single page remap"
  }
  
  use_cases: {
    shape: class
    label: "Best For"
    
    case1: "+ vmm_map_page()"
    case2: "+ vmm_unmap_page()"
    case3: "+ Permission changes"
    case4: "+ COW page faults"
  }
}

cr3_reload_method: {
  label: "Full TLB Flush\n(CR3 Reload)"
  style.fill: "#FFEBEE"
  style.stroke: "#F44336"
  style.stroke-width: 2
  
  header: |md
    **`mov CR3, page_dir`**
| {shape: text}
  
  sequence: {
    shape: sequence_diagram
    
    code: Code
    cpu: CPU
    tlb: TLB
    
    code -> cpu: "1. Load new CR3"
    cpu -> tlb: "2. Flush ALL entries"
    tlb -> tlb: "3. All entries cleared\n(except global)"
    tlb -> tlb: "4. Cache pollution"
    code <- tlb: "5. Ready (~450+ cycles)"
  }
  
  characteristics: {
    shape: class
    label: "Characteristics"
    
    cycles: "~450-1000 cycles"
    scope: "All entries (except global)"
    cache_impact: "Full TLB miss penalty resumes"
    use_case: "Context switch"
  }
  
  use_cases: {
    shape: class
    label: "Best For"
    
    case1: "+ Context switch (CR3 change)"
    case2: "+ Page directory replacement"
    case3: "+ Mass invalidation needed"
    case4: "+ Process isolation"
  }
}

comparison: {
  label: "Cycle Comparison"
  style.fill: "#FFF8E1"
  style.stroke: "#FFC107"
  style.stroke-width: 2
  
  grid-columns: 3
  
  operation: "Operation" {style.bold: true}
  invlpg_cycles: "invlpg" {style.bold: true}
  cr3_cycles: "CR3 Reload" {style.bold: true}
  
  single_page: "Single page"
  invlpg_single: "~25 cycles" {style.fill: "#C8E6C9"}
  cr3_single: "~450 cycles" {style.fill: "#FFCDD2"}
  
  ten_pages: "10 pages"
  invlpg_ten: "~250 cycles" {style.fill: "#FFF9C4"}
  cr3_ten: "~450 cycles" {style.fill: "#FFCDD2"}
  
  hundred_pages: "100 pages"
  invlpg_hundred: "~2500 cycles" {style.fill: "#FFCDD2"}
  cr3_hundred: "~450 cycles" {style.fill: "#C8E6C9"}
  
  all_entries: "All entries"
  invlpg_all: "N/A (loop required)" {style.fill: "#FFCDD2"}
  cr3_all: "~450 cycles" {style.fill: "#C8E6C9"}
}

code_examples: {
  label: "Implementation"
  
  invlpg_example: ||c
    // Single page invalidation
    static inline void tlb_invalidate_page(uint32_t addr) {
        __asm__ volatile ("invlpg (%0)" 
            : : "r"(addr) : "memory");
    }
    
    // After mapping change:
    vmm_map_page(vaddr, paddr, flags);
    tlb_invalidate_page(vaddr);  // ~25 cycles
||
  
  cr3_example: ||c
    // Full TLB flush
    static inline void tlb_flush_all(void) {
        uint32_t cr3;
        __asm__ volatile ("mov %%cr3, %0" 
            : "=r"(cr3));
        __asm__ volatile ("mov %0, %%cr3" 
            : : "r"(cr3) : "memory");
    }
    
    // Context switch:
    context_switch(old, new);
    // CR3 reload happens automatically
    // ~450 cycles for TLB repopulation
||
}

global_pages: {
  label: "Global Pages Optimization"
  style.fill: "#E3F2FD"
  style.stroke: "#2196F3"
  style.stroke-width: 2
  
  note: |md
    Pages marked with `PAGE_GLOBAL` (bit 8) are NOT flushed on CR3 reload.
    
    **Benefit:** Kernel code/data can stay in TLB across context switches.
    
    **Requirement:** CR4.PGE must be enabled.
| {shape: text}
  
  setup: ||c
    // Enable global pages
    void enable_global_pages(void) {
        uint32_t cr4;
        __asm__ volatile ("mov %%cr4, %0" 
            : "=r"(cr4));
        cr4 |= (1 << 7);  // Set PGE bit
        __asm__ volatile ("mov %0, %%cr4" 
            : : "r"(cr4));
    }
    
    // Map kernel code as global
    #define PAGE_GLOBAL (1 << 8)
    vmm_map_page(KERNEL_START, phys, 
                 PAGE_WRITABLE | PAGE_GLOBAL);
||
}

invlpg_method -- comparison
cr3_reload_method -- comparison
comparison -- code_examples
code_examples -- global_pages

legend: {
  near: bottom-center
  shape: text
  label: |md
    **TLB (Translation Lookaside Buffer):** CPU cache for page table entries (~32-64 entries)
    
    **Stale TLB:** After modifying page tables, TLB may contain outdated mappings â†’ memory corruption or security issues
|
}