vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#8B5CF6"
    data: "#3B82F6"
    free: "#10B981"
    used: "#F59E0B"
    pointer: "#F97316"
    text: "#1F2937"
  }
}

title: |md
  # kmalloc Block Header and Free List
  Kernel heap allocator with first-fit allocation and coalescing
| {near: top-center}

direction: right

classes: {
  header-block: {
    shape: rectangle
    style: {
      fill: "${colors.header}"
      stroke: "#7C3AED"
      stroke-width: 2
      font-color: white
      bold: true
      font-size: 14
    }
  }
  data-block: {
    shape: rectangle
    style: {
      fill: "${colors.data}"
      stroke: "#2563EB"
      stroke-width: 2
      font-color: white
      font-size: 12
    }
  }
  free-block: {
    shape: rectangle
    style: {
      fill: "${colors.free}"
      stroke: "#059669"
      stroke-width: 2
      font-color: white
      font-size: 12
    }
  }
  used-block: {
    shape: rectangle
    style: {
      fill: "${colors.used}"
      stroke: "#D97706"
      stroke-width: 2
      font-color: white
      font-size: 12
    }
  }
  pointer-arrow: {
    style: {
      stroke: "${colors.pointer}"
      stroke-width: 2
      font-color: "${colors.text}"
      font-size: 11
    }
  }
}

header-structure: {
  label: "Block Header Layout (24 bytes)"
  style.fill: "#F3E8FF"
  style.stroke: "${colors.header}"
  style.stroke-width: 2

  offset-grid: {
    grid-columns: 3
    grid-gap: 0

    off0: "Offset" {class: header-block}
    size0: "Size" {class: header-block}
    field0: "Field" {class: header-block}

    off1: "0x00" {style.fill: "#EDE9FE"}
    size1: "4" {style.fill: "#EDE9FE"}
    field1: "magic (0x4B484250)" {style.fill: "#EDE9FE"; style.font-size: 11}

    off2: "0x04" {style.fill: "#F3E8FF"}
    size2: "4" {style.fill: "#F3E8FF"}
    field2: "size (usable bytes)" {style.fill: "#F3E8FF"; style.font-size: 11}

    off3: "0x08" {style.fill: "#EDE9FE"}
    size3: "1" {style.fill: "#EDE9FE"}
    field3: "free flag (0/1)" {style.fill: "#EDE9FE"; style.font-size: 11}

    off4: "0x09" {style.fill: "#F3E8FF"}
    size4: "3" {style.fill: "#F3E8FF"}
    field4: "padding" {style.fill: "#F3E8FF"; style.font-size: 11}

    off5: "0x0C" {style.fill: "#EDE9FE"}
    size5: "4" {style.fill: "#EDE9FE"}
    field5: "*next" {style.fill: "#EDE9FE"; style.font-size: 11}

    off6: "0x10" {style.fill: "#F3E8FF"}
    size6: "4" {style.fill: "#F3E8FF"}
    field6: "*prev" {style.fill: "#F3E8FF"; style.font-size: 11}

    off7: "0x14" {style.fill: "#EDE9FE"}
    size7: "4" {style.fill: "#EDE9FE"}
    field7: "padding (align)" {style.fill: "#EDE9FE"; style.font-size: 11}
  }

  total: "Total: 24 bytes (HEADER_SIZE)" {
    style.fill: "${colors.header}"
    style.font-color: white
    style.bold: true
  }
}

block-in-memory: {
  label: "Block In Memory"
  style.fill: "#F8FAFC"
  style.stroke: "#CBD5E1"

  direction: down

  memory-layout: {
    grid-columns: 1
    grid-gap: 0

    header-visual: "Header (24 bytes)\nmagic | size | free | next | prev" {
      class: header-block
      width: 200
    }
    data-visual: "Usable Space (size bytes)\nReturned to caller" {
      class: data-block
      width: 200
      height: 80
    }
  }

  ptr-label: "ptr returned = block_start + 24" {
    style.font-size: 11
    style.italic: true
  }
}

free-list-structure: {
  label: "Free List State"
  style.fill: "#F8FAFC"
  style.stroke: "#CBD5E1"

  direction: down

  heap-head: "heap_head" {
    shape: rectangle
    style.fill: "${colors.pointer}"
    style.font-color: white
    style.bold: true
  }

  block1: "Block 1\nFREE\nsize=128" {
    class: free-block
  }
  block2: "Block 2\nUSED\nsize=64" {
    class: used-block
  }
  block3: "Block 3\nFREE\nsize=256" {
    class: free-block
  }
  block4: "Block 4\nUSED\nsize=32" {
    class: used-block
  }
  block5: "Block 5\nFREE\nsize=96" {
    class: free-block
  }
  null-terminator: "NULL" {
    shape: circle
    style.fill: "#94A3B8"
    style.font-color: white
    style.font-size: 10
    width: 40
  }

  heap-head -> block1: "next" {class: pointer-arrow}
  block1 -> block2: {class: pointer-arrow; style.stroke-dash: 3}
  block2 -> block3: {class: pointer-arrow; style.stroke-dash: 3}
  block3 -> block4: {class: pointer-arrow; style.stroke-dash: 3}
  block4 -> block5: {class: pointer-arrow; style.stroke-dash: 3}
  block5 -> null-terminator: {class: pointer-arrow}

  legend-free: "FREE (allocatable)" {class: free-block; width: 100}
  legend-used: "USED (allocated)" {class: used-block; width: 100}
}

allocation-flow: {
  label: "kmalloc(80) - First-Fit Search"
  style.fill: "#FEF3C7"
  style.stroke: "${colors.used}"

  direction: down

  step1: {
    label: "Step 1: Check Block 1"
    style.fill: "#ECFDF5"

    b1: "size=128, free=1" {class: free-block}
    check1: "128 >= 80 + 24? YES" {
      style.fill: "${colors.free}"
      style.font-color: white
      style.bold: true
    }
    result1: "SPLIT BLOCK!" {
      style.fill: "${colors.free}"
      style.font-color: white
      style.bold: true
    }

    b1 -> check1 -> result1
  }

  split-diagram: {
    label: "Block Splitting"
    style.fill: "#F0FDF4"
    style.stroke: "${colors.free}"

    before: "Before\n[128 bytes FREE]" {
      class: free-block
      width: 200
    }

    after: {
      grid-columns: 2
      grid-gap: 0

      allocated: "[104 bytes USED]\n(80 + 24 header)" {
        class: used-block
        width: 100
      }
      remainder: "[24 bytes FREE]\n(128 - 104)" {
        class: free-block
        width: 100
      }
    }

    before -> after: "split" {style.stroke: "${colors.free}"; style.bold: true}
  }
}

coalescing-flow: {
  label: "kfree() - Coalescing"
  style.fill: "#ECFDF5"
  style.stroke: "${colors.free}"

  direction: down

  before-free: {
    label: "Before kfree(ptr)"
    style.fill: "#F8FAFC"

    bf1: "FREE" {class: free-block; width: 60}
    bf2: "USED\n(to free)" {class: used-block; width: 60; style.stroke: "#EF4444"; style.stroke-width: 3}
    bf3: "FREE" {class: free-block; width: 60}

    bf1 -> bf2 -> bf3
  }

  during-free: {
    label: "After Setting free=1"
    style.fill: "#F8FAFC"

    df1: "FREE" {class: free-block; width: 60}
    df2: "FREE\n(just freed)" {class: free-block; width: 60; style.stroke: "#059669"; style.stroke-width: 3}
    df3: "FREE" {class: free-block; width: 60}

    df1 -> df2 -> df3
  }

  after-coalesce: {
    label: "After Coalescing"
    style.fill: "#F0FDF4"

    ac1: "MERGED\nsingle large block" {
      class: free-block
      width: 180
      style.bold: true
    }
  }

  before-free -> during-free -> after-coalesce

  coalesce-note: |md
    Coalescing rules:
    1. Check next->free: merge if true
    2. Check prev->free: merge if true
    3. Update size = sum + headers
    4. Relink pointers
  | {style.fill: "#ECFDF5"}
}

edge-cases: {
  label: "Edge Cases"
  style.fill: "#FEF2F2"
  style.stroke: "#EF4444"

  direction: down

  case1: {
    label: "Double-Free Detection"
    style.fill: "#FEF2F2"

    df-code: |md
      c
      if (block->free) {
        kprintf("Double free!\n");
        return; // Ignore
      }
      
    |
  }

  case2: {
    label: "Magic Number Validation"
    style.fill: "#FEF2F2"

    magic-code: |md
      c
      if (block->magic != HEAP_MAGIC) {
        kprintf("Corruption!\n");
        return; // Ignore
      }
      
    |
  }

  case3: {
    label: "Minimum Block Size"
    style.fill: "#FEF2F2"

    min-code: |md
      c
      // Don't split if remainder < MIN_BLOCK_SIZE
      if (block->size >= size + HEADER + MIN_BLOCK) {
        // Safe to split
      }
      
    |
  }
}

performance: {
  label: "Performance Characteristics"
  style.fill: "#EFF6FF"
  style.stroke: "#3B82F6"

  direction: down

  alloc-table: {
    grid-columns: 2
    grid-gap: 0

    op1: "Operation" {class: header-block}
    time1: "Time Complexity" {class: header-block}

    op2: "kmalloc" {style.fill: "#DBEAFE"}
    time2: "O(n) first-fit scan" {style.fill: "#DBEAFE"}

    op3: "kfree" {style.fill: "#EFF6FF"}
    time3: "O(1) + coalesce check" {style.fill: "#EFF6FF"}

    op4: "Split" {style.fill: "#DBEAFE"}
    time4: "O(1)" {style.fill: "#DBEAFE"}

    op5: "Coalesce" {style.fill: "#EFF6FF"}
    time5: "O(1) per neighbor" {style.fill: "#EFF6FF"}
  }

  fragmentation: |md
    **Fragmentation Sources:**
    - Internal: padding to ALIGN_SIZE (16 bytes)
    - External: small free blocks between used blocks
    - Solution: periodic heap compaction (not implemented)
  | {style.fill: "#DBEAFE"}
}