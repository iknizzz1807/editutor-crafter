vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Memory Management Module Architecture
| {near: top-center}

# Style definitions
classes: {
  component: {
    shape: rectangle
    style: {
      fill: "#E8F4FD"
      stroke: "#2E86AB"
      stroke-width: 2
      border-radius: 8
      font-color: "#1A365D"
      bold: true
    }
  }
  data-struct: {
    shape: rectangle
    style: {
      fill: "#FFF9E6"
      stroke: "#D69E2E"
      stroke-width: 2
      stroke-dash: 4
      border-radius: 6
    }
  }
  hardware: {
    shape: rectangle
    style: {
      fill: "#F0FFF4"
      stroke: "#38A169"
      stroke-width: 2
      border-radius: 8
    }
  }
  flow-arrow: {
    style: {
      stroke: "#4A5568"
      stroke-width: 2
      animated: true
    }
  }
  label-box: {
    shape: rectangle
    style: {
      fill: "#EDF2F7"
      stroke: "#A0AEC0"
      border-radius: 4
      font-size: 12
    }
  }
}

# Main components
memory_map: "memory_map.c\n(E820/Multiboot)" {
  class: component
  regions: "memory_region_t[]" {
    class: data-struct
    style.fill: "#FFF9E6"
  }
}

pmm: "pmm.c\n(Physical Frame Allocator)" {
  class: component
  bitmap: "frame_bitmap[32768]" {
    class: data-struct
    label: "Bitmap\n(1 bit per 4KB frame)"
  }
}

vmm: "vmm.c\n(Virtual Memory Manager)" {
  class: component
  page_dir: "page_directory_t" {
    class: data-struct
    label: "Page Directory\n(1024 PDEs)"
  }
  page_tbl: "page_table_t" {
    class: data-struct
    label: "Page Table\n(1024 PTEs)"
  }
}

kmalloc: "kmalloc.c\n(Kernel Heap)" {
  class: component
  heap_header: "block_header_t" {
    class: data-struct
    label: "Heap Block Header\n(magic, size, free, next, prev)"
  }
}

# Hardware layer
physical_ram: "Physical RAM\n(4GB addressable)" {
  class: hardware
  shape: cylinder
}

cpu_mmu: "CPU MMU\n(CR3, TLB)" {
  class: hardware
  shape: diamond
}

# Flow 1: Memory Map Initialization
memory_map.regions -> pmm: "1. usable regions" {
  class: flow-arrow
  label: "init regions"
  style.stroke: "#3182CE"
}

# Flow 2: Frame Allocation
pmm.bitmap -> physical_ram: "2. alloc/free 4KB frames" {
  class: flow-arrow
  label: "frame addr"
  style.stroke: "#38A169"
}

pmm.bitmap -> vmm.page_dir: "3. allocate page tables" {
  class: flow-arrow
  label: "pmm_alloc_frame()"
  style.stroke: "#805AD5"
}

# Flow 3: Page Mapping
vmm.page_dir -> cpu_mmu: "4. CR3 load" {
  class: flow-arrow
  label: "pd physical addr"
  style.stroke: "#DD6B20"
}

vmm.page_tbl -> cpu_mmu: "5. page walk" {
  class: flow-arrow
  label: "PTE → frame"
  style.stroke: "#DD6B20"
}

cpu_mmu -> physical_ram: "6. translate vaddr→paddr" {
  class: flow-arrow
  style.stroke: "#E53E3E"
}

# Flow 4: Heap Allocation
kmalloc.heap_header -> vmm: "7. request pages" {
  class: flow-arrow
  label: "grow heap"
  style.stroke: "#D69E2E"
}

vmm.page_tbl -> kmalloc.heap_header: "8. map heap pages" {
  class: flow-arrow
  label: "vaddr range\n0xD0000000+"
  style.stroke: "#D69E2E"
}

# Legend
legend: {
  near: bottom-right
  shape: rectangle
  style: {
    fill: "#FAFAFA"
    stroke: "#CBD5E0"
    border-radius: 8
  }
  
  leg_title: "Data Flows" {style.bold: true}
  
  flow1: "① Memory Map → PMM init" {
    class: label-box
    style.fill: "#EBF8FF"
  }
  flow2: "② PMM ↔ Physical RAM" {
    class: label-box
    style.fill: "#F0FFF4"
  }
  flow3: "③④⑤ VMM → MMU Translation" {
    class: label-box
    style.fill: "#FFFAF0"
  }
  flow4: "⑥ MMU → Physical Access" {
    class: label-box
    style.fill: "#FFF5F5"
  }
  flow5: "⑦⑧ Heap → VMM Growth" {
    class: label-box
    style.fill: "#FFFFF0"
  }
}

# Size annotations
pmm.bitmap: |md
  **128KB bitmap**
  Covers 4GB (1M frames)
|

vmm.page_dir: |md
  **4KB per PD/PT**
  2-level hierarchy
|

kmalloc.heap_header: |md
  **24 bytes header**
  16-byte aligned blocks
|