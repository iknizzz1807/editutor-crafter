vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Process Control Block (PCB)
  ## Saved State Layout â€” sizeof(process_t) â‰ˆ 100 bytes (2 cache lines)
| {near: top-center}

pcb: {
  # Header section
  header: {
    shape: rectangle
    style.fill: "#9B59B6"
    style.font-color: white
    style.stroke: "#8E44AD"
    label: "Process Metadata"
    
    grid-columns: 4
    grid-gap: 0
    
    pid: "PID: uint32" {
      style.fill: "#E8DAEF"
      style.stroke: "#9B59B6"
    }
    name: "name[16]: char" {
      style.fill: "#E8DAEF"
      style.stroke: "#9B59B6"
    }
    state: "state: enum" {
      style.fill: "#E8DAEF"
      style.stroke: "#9B59B6"
    }
    flags: "is_user: int" {
      style.fill: "#E8DAEF"
      style.stroke: "#9B59B6"
    }
  }
  
  # CPU State - the critical save/restore region
  cpu_state: {
    label: "cpu_state_t (60 bytes, 1 cache line)"
    style.fill: "#3498DB"
    style.font-color: white
    style.stroke: "#2980B9"
    
    # General-purpose registers
    gp_regs: {
      label: "General-Purpose Registers\n(pusha order)"
      style.fill: "#D6EAF8"
      style.stroke: "#3498DB"
      style.font-color: "#1A5276"
      
      grid-columns: 2
      grid-gap: 0
      
      edi: "edi: uint32\noffset: 0" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
      }
      esi: "esi: uint32\noffset: 4" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
      }
      ebp: "ebp: uint32\noffset: 8" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
      }
      esp: "esp: uint32\noffset: 12" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
        style.bold: true
      }
      ebx: "ebx: uint32\noffset: 16" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
      }
      edx: "edx: uint32\noffset: 20" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
      }
      ecx: "ecx: uint32\noffset: 24" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
      }
      eax: "eax: uint32\noffset: 28" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
      }
    }
    
    # Segment registers
    seg_regs: {
      label: "Segment Registers"
      style.fill: "#D6EAF8"
      style.stroke: "#3498DB"
      style.font-color: "#1A5276"
      
      grid-columns: 4
      grid-gap: 0
      
      ds: "ds: uint16\noffset: 30" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
      }
      es: "es: uint16\noffset: 32" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
      }
      fs: "fs: uint16\noffset: 34" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
      }
      gs: "gs: uint16\noffset: 36" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
      }
      ss: "ss: uint16\noffset: 38" {
        style.fill: "#AED6F1"
        style.stroke: "#3498DB"
        style.bold: true
      }
      pad: "pad: uint16\noffset: 40" {
        style.fill: "#D5DBDB"
        style.stroke: "#7F8C8D"
      }
    }
    
    # Control registers
    ctrl_regs: {
      label: "Control & Instruction State"
      style.fill: "#D6EAF8"
      style.stroke: "#3498DB"
      style.font-color: "#1A5276"
      
      grid-columns: 2
      grid-gap: 0
      
      eip: "eip: uint32\noffset: 44\nâ† Instruction Pointer" {
        style.fill: "#F39C12"
        style.stroke: "#D68910"
        style.font-color: white
        style.bold: true
      }
      eflags: "eflags: uint32\noffset: 48\nâ† CPU Flags (IF=0x202)" {
        style.fill: "#F39C12"
        style.stroke: "#D68910"
        style.font-color: white
        style.bold: true
      }
      cs: "cs: uint32\noffset: 52\nâ† Code Segment" {
        style.fill: "#E67E22"
        style.stroke: "#CA6F1E"
        style.font-color: white
      }
      cr3: "cr3: uint32\noffset: 56\nâ† Page Directory" {
        style.fill: "#E74C3C"
        style.stroke: "#C0392B"
        style.font-color: white
        style.bold: true
      }
    }
  }
  
  # Memory management
  memory: {
    label: "Memory Management"
    style.fill: "#27AE60"
    style.font-color: white
    style.stroke: "#1E8449"
    
    grid-columns: 2
    grid-gap: 0
    
    kstack: "kernel_stack: uint32\nPhysical frame address" {
      style.fill: "#D5F5E3"
      style.stroke: "#27AE60"
      style.font-color: "#145A32"
    }
    kstack_top: "kernel_stack_top: uint32\nESP value for TSS" {
      style.fill: "#D5F5E3"
      style.stroke: "#27AE60"
      style.font-color: "#145A32"
      style.bold: true
    }
    ustack: "user_stack: uint32\n(if user mode)" {
      style.fill: "#D5F5E3"
      style.stroke: "#27AE60"
      style.font-color: "#145A32"
    }
    pd: "page_directory: uint32\nCR3 value (phys)" {
      style.fill: "#D5F5E3"
      style.stroke: "#27AE60"
      style.font-color: "#145A32"
    }
  }
  
  # Scheduling
  scheduling: {
    label: "Scheduling Links"
    style.fill: "#E67E22"
    style.font-color: white
    style.stroke: "#CA6F1E"
    
    grid-columns: 3
    grid-gap: 0
    
    next: "next: process_t*\nâ†’ Next in queue" {
      style.fill: "#FDEBD0"
      style.stroke: "#E67E22"
      style.font-color: "#935116"
    }
    prev: "prev: process_t*\nâ† Previous in queue" {
      style.fill: "#FDEBD0"
      style.stroke: "#E67E22"
      style.font-color: "#935116"
    }
    ticks: "total_ticks: uint32\nCPU time consumed" {
      style.fill: "#FDEBD0"
      style.stroke: "#E67E22"
      style.font-color: "#935116"
    }
  }
}

# Legend
legend: {
  near: bottom-right
  style.fill: transparent
  style.stroke: "#7F8C8D"
  style.stroke-dash: 3
  
  label: |md
    **Legend**
    - ðŸŸ  Orange: Critical for execution resume (EIP, EFLAGS)
    - ðŸ”´ Red: Address space (CR3)
    - Bold: Modified on every context switch
  |
}

# Annotations
annotation: |md
  
  Context Switch Sequence:
  1. Save current: pusha â†’ segment regs â†’ ESP â†’ EIP â†’ EFLAGS â†’ CR3
  2. Load new: CR3 â†’ TSS.ESP0 â†’ segments â†’ general regs â†’ ESP â†’ EIP
  3. Resume at new->cpu.eip with new->cpu.eflags
  
| {near: bottom-center}