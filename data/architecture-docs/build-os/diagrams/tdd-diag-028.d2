vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Context Switch: Save Old â†’ Load New
  Complete flow from timer interrupt to resuming new process
| {near: top-center}

# Step 1: Timer Interrupt Entry
step1: {
  label: "Step 1: Timer Interrupt Fires"
  style.fill: "#E8E8E8"
  
  timer_irq: {
    label: "IRQ0 (Timer)"
    shape: oval
    style.fill: "#FF6B6B"
    style.font-color: white
    style.bold: true
  }
  
  cpu_state1: {
    label: "CPU State\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nEIP: 0x1000 (old proc)\nESP: 0x8000 (old proc)\nCS/DS/SS: kernel\nCR3: old page dir"
    shape: rectangle
    style.fill: "#B8D4E3"
  }
  
  timer_irq -> cpu_state1: "Interrupts\nexecution"
}

# Step 2: Save Old Process State
step2: {
  label: "Step 2: Save Old Process to PCB"
  style.fill: "#FFE4B5"
  
  old_pcb: {
    label: "Old PCB (Process A)"
    shape: rectangle
    style.fill: "#98D8AA"
    style.bold: true
    
    fields: {
      label: |md
        **Saved State:**
        - EAX, EBX, ECX, EDX
        - ESI, EDI, EBP, ESP
        - EIP â† return address
        - EFLAGS â† IF=1
        - CS, DS, ES, FS, GS, SS
        - CR3 â† page directory
      |
      shape: text
    }
  }
  
  stack_frame: {
    label: "Stack After Save\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n[GS] [FS] [ES] [DS]\n[EDI] [ESI] [EBP]\n[ESP] [EBX] [EDX]\n[ECX] [EAX]\n[int_no] [err_code]\n[EIP] [CS] [EFLAGS]"
    shape: rectangle
    style.fill: "#D4E6F1"
  }
}

# Step 3: Scheduler Picks Next
step3: {
  label: "Step 3: Scheduler Picks Next Process"
  style.fill: "#E8DAEF"
  
  ready_queue: {
    label: "Ready Queue (Round-Robin)"
    shape: rectangle
    style.fill: "#F5B7B1"
    
    p1: {label: "P1\n(RUNNING)"}
    p2: {label: "P2\n(READY)"}
    p3: {label: "P3\n(READY)"}
    
    p1 -> p2: "next"
    p2 -> p3: "next"
    p3 -> p1: "next"
  }
  
  scheduler: {
    label: "scheduler_pick_next()"
    shape: diamond
    style.fill: "#F9E79F"
  }
  
  ready_queue.p2 -> scheduler: "selected"
}

# Step 4: Load New Process State
step4: {
  label: "Step 4: Load New Process from PCB"
  style.fill: "#D5F5E3"
  
  new_pcb: {
    label: "New PCB (Process B)"
    shape: rectangle
    style.fill: "#85C1E9"
    style.bold: true
    
    fields: {
      label: |md
        **Restored State:**
        - EAX, EBX, ECX, EDX â† saved
        - ESI, EDI, EBP, ESP â† saved
        - EIP â† 0x2000 (resume point)
        - EFLAGS â† IF=1
        - CR3 â† new page directory
      |
      shape: text
    }
  }
  
  cpu_state2: {
    label: "CPU State (After Load)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nEIP: 0x2000 (new proc)\nESP: 0x9000 (new proc)\nCR3: NEW page dir\nRegisters: from PCB"
    shape: rectangle
    style.fill: "#B8D4E3"
    style.stroke: "#2E86AB"
    style.stroke-width: 3
  }
  
  new_pcb -> cpu_state2: "Restore"
}

# Step 5: Update TSS ESP0
step5: {
  label: "Step 5: Update TSS ESP0"
  style.fill: "#FADBD8"
  
  tss: {
    label: "Task State Segment"
    shape: rectangle
    style.fill: "#F5CBA7"
    
    esp0_field: {
      label: "ESP0: 0x9000\n(new kernel stack)"
      style.fill: "#E74C3C"
      style.font-color: white
      style.bold: true
    }
    ss0_field: {
      label: "SS0: 0x10"
    }
    
    esp0_field - ss0_field: {style.opacity: 0}
  }
  
  note: {
    label: |md
      **CRITICAL:** TSS ESP0 must point to
      new process's kernel stack top.
      Required for ring 3 â†’ ring 0 transitions.
    |
    shape: text
    style.italic: true
  }
}

# Step 6: iret to New Process
step6: {
  label: "Step 6: iret Resumes New Process"
  style.fill: "#D4EFDF"
  
  iret_frame: {
    label: "Stack for iret\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n[EIP: 0x2000]\n[CS: 0x08]\n[EFLAGS: 0x202]\n[ESP: 0x9000]\n[SS: 0x10]"
    shape: rectangle
    style.fill: "#AED6F1"
  }
  
  new_execution: {
    label: "Process B Resumes\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nExecuting at EIP=0x2000\nStack at ESP=0x9000\nPage directory switched\nInterrupts enabled"
    shape: rectangle
    style.fill: "#58D68D"
    style.font-color: white
    style.bold: true
  }
  
  iret_frame -> new_execution: "iret"
}

# Flow arrows between steps
step1 -> step2: "push registers\npusha + segments"
step2 -> step3: "call scheduler"
step3 -> step4: "return new PCB"
step4 -> step5: "update TSS"
step5 -> step6: "iret"

# Legend
legend: {
  near: bottom-right
  label: |md
    **Legend:**
    - ğŸ”´ Red/Orange: Interrupt/saved state
    - ğŸŸ¢ Green: New process state
    - ğŸ”µ Blue: CPU state
    - ğŸŸ¡ Yellow: Scheduler decision
  |
  shape: text
  style.fill: "#F8F9F9"
  style.stroke: "#BDC3C7"
}

# Critical note
critical: {
  near: bottom-center
  label: |md
    âš ï¸ **CRITICAL INVARIANTS:**
    1. Interrupts disabled (cli) during entire switch
    2. TSS ESP0 updated BEFORE iret
    3. CR3 reload flushes TLB (unless global pages)
    4. EFLAGS.IF restored from new process
  |
  shape: rectangle
  style.fill: "#FDEDEC"
  style.stroke: "#E74C3C"
  style.stroke-width: 2
}