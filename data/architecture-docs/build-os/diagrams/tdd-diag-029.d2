vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # TSS Structure and ESP0 for Ring Transitions
| {near: top-center}

direction: right

tss_memory: {
  label: "Task State Segment (TSS)\n104 bytes"
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  
  header: {
    label: ""
    style.fill: transparent
    style.stroke: transparent
    
    offset_col: {label: "Offset"; style.fill: "#DDDDDD"; style.bold: true}
    field_col: {label: "Field"; style.fill: "#DDDDDD"; style.bold: true}
    value_col: {label: "Value"; style.fill: "#DDDDDD"; style.bold: true}
    desc_col: {label: "Purpose"; style.fill: "#DDDDDD"; style.bold: true}
  }
  
  row_00: {
    offset: {label: "0x00"; style.fill: "#F5F5F5"}
    field: {label: "link"; style.fill: "#F5F5F5"}
    value: {label: "0"; style.fill: "#F5F5F5"}
    desc: {label: "Previous task"; style.fill: "#F5F5F5"; style.font-color: "#888888"}
  }
  
  row_04: {
    offset: {label: "0x04"; style.fill: "#FFD700"; style.bold: true}
    field: {label: "esp0"; style.fill: "#FFD700"; style.bold: true}
    value: {label: "Kernel Stack Top"; style.fill: "#FFD700"; style.bold: true}
    desc: {label: "★ CRITICAL: Ring 0 ESP"; style.fill: "#FFD700"; style.bold: true; style.font-color: "#CC0000"}
  }
  
  row_08: {
    offset: {label: "0x08"; style.fill: "#FFE4B5"; style.bold: true}
    field: {label: "ss0"; style.fill: "#FFE4B5"; style.bold: true}
    value: {label: "0x10"; style.fill: "#FFE4B5"; style.bold: true}
    desc: {label: "★ CRITICAL: Ring 0 SS"; style.fill: "#FFE4B5"; style.bold: true; style.font-color: "#CC0000"}
  }
  
  row_0c: {
    offset: {label: "0x0C"; style.fill: "#F5F5F5"}
    field: {label: "esp1, ss1"; style.fill: "#F5F5F5"}
    value: {label: "—"; style.fill: "#F5F5F5"}
    desc: {label: "Ring 1 (unused)"; style.fill: "#F5F5F5"; style.font-color: "#888888"}
  }
  
  row_14: {
    offset: {label: "0x14"; style.fill: "#F5F5F5"}
    field: {label: "esp2, ss2"; style.fill: "#F5F5F5"}
    value: {label: "—"; style.fill: "#F5F5F5"}
    desc: {label: "Ring 2 (unused)"; style.fill: "#F5F5F5"; style.font-color: "#888888"}
  }
  
  row_1c: {
    offset: {label: "0x1C-0x60"; style.fill: "#F5F5F5"}
    field: {label: "cr3, regs..."; style.fill: "#F5F5F5"}
    value: {label: "—"; style.fill: "#F5F5F5"}
    desc: {label: "Not used for stack switch"; style.fill: "#F5F5F5"; style.font-color: "#888888"}
  }
  
  row_64: {
    offset: {label: "0x64"; style.fill: "#E8E8E8"}
    field: {label: "iomap_base"; style.fill: "#E8E8E8"}
    value: {label: "104"; style.fill: "#E8E8E8"}
    desc: {label: "No I/O bitmap"; style.fill: "#E8E8E8"; style.font-color: "#888888"}
  }
}

ring3_user: {
  label: "Ring 3: User Mode\n(CPL = 3)"
  style.fill: "#E6F3FF"
  style.stroke: "#0066CC"
  style.stroke-width: 2
  
  user_code: {
    label: "User Code\nExecuting"
    shape: rectangle
    style.fill: "#CCE5FF"
  }
  
  user_stack: {
    label: "User Stack\nSS=0x23\nESP=user_stack"
    shape: rectangle
    style.fill: "#CCE5FF"
  }
  
  user_code -> user_stack: uses
}

transition: {
  label: |md
    **Ring 3 → Ring 0 Transition**
    
    Triggered by:
    • INT instruction (syscall)
    • Hardware interrupt
    • CPU exception
    
    CPU automatically:
    1. Reads TSS.ss0 → load SS
    2. Reads TSS.esp0 → load ESP
    3. Pushes old SS, ESP
    4. Pushes EFLAGS, CS, EIP
    5. Loads new CS:EIP from IDT
  |
  style.fill: "#FFF8DC"
  style.stroke: "#DAA520"
  style.stroke-width: 2
}

ring0_kernel: {
  label: "Ring 0: Kernel Mode\n(CPL = 0)"
  style.fill: "#FFE6E6"
  style.stroke: "#CC0000"
  style.stroke-width: 2
  
  kernel_handler: {
    label: "Interrupt Handler\nor Syscall Handler"
    shape: rectangle
    style.fill: "#FFCCCC"
  }
  
  kernel_stack: {
    label: "Kernel Stack\n(Per-Process)\n\nSS=0x10 (from TSS.ss0)\nESP=TSS.esp0 value"
    shape: rectangle
    style.fill: "#FFCCCC"
    style.bold: true
  }
  
  stack_frame: {
    label: |md
      **Stack Frame After Switch:**
      
      ESP+0x00:  User EIP
      ESP+0x04:  User CS (0x1B)
      ESP+0x08:  User EFLAGS
      ESP+0x0C:  User ESP
      ESP+0x10:  User SS (0x23)
      
    |
    shape: rectangle
    style.fill: "#FFF0F0"
    style.stroke-dash: 2
  }
  
  kernel_handler -> kernel_stack: uses
  kernel_stack -> stack_frame: contains
}

context_switch: {
  label: |md
    **Context Switch Must Update ESP0!**
    
    c
    void context_switch(proc_t *old, proc_t *new) {
        // ... save old state ...
        
        // CRITICAL: Update TSS
        tss.esp0 = new->kernel_stack_top;
        
        // ... load new state ...
    }
    
    
    If ESP0 is wrong → corrupted stack → crash!
  |
  style.fill: "#FFE4E1"
  style.stroke: "#8B0000"
  style.stroke-width: 2
}

ring3_user -> transition: "INT 0x80\nor IRQ" {style.stroke: "#0066CC"; style.stroke-width: 2; style.animated: true}
transition -> ring0_kernel: "CPU loads\nSS0:ESP0 from TSS" {style.stroke: "#CC0000"; style.stroke-width: 2; style.animated: true}

tss_memory.row_04 -> ring0_kernel.kernel_stack: "ESP0 points here" {style.stroke: "#FFD700"; style.stroke-width: 3; style.stroke-dash: 4}
tss_memory.row_08 -> ring0_kernel.kernel_stack: "SS0 = 0x10" {style.stroke: "#FFE4B5"; style.stroke-width: 2; style.stroke-dash: 4}

ring0_kernel -> context_switch: "On schedule" {style.stroke-dash: 3}
context_switch -> tss_memory.row_04: "Updates" {style.stroke: "#8B0000"; style.stroke-width: 2; style.bold: true}

legend: {
  near: bottom-center
  label: |md
    **Legend:**
    • ★ Gold fields (esp0, ss0) are CRITICAL for ring transitions
    • CPU hardware automatically reads these on privilege change
    • Must be updated on every context switch
  |
  style.fill: "#F9F9F9"
  style.stroke: "#CCCCCC"
}