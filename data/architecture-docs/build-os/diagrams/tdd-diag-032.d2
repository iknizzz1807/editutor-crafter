vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # User vs Kernel Page Directories
  Process Isolation Through Separate Address Spaces
| {near: top-center}

direction: right

kernel_pd: Kernel Page Directory {
  style.fill: "#E8E4F0"
  style.stroke: "#7B68EE"
  style.stroke-width: 2
  
  kernel_desc: |md
    **Single Copy, Shared by All Processes**
    
    • Mapped at 0xC0000000+ (higher half)
    • Supervisor-only (PAGE_USER = 0)
    • Identical in every page directory
    • Contains kernel code, data, heap
  | {
    shape: text
    style.font-size: 14
  }
  
  entries_k: Entries 768-1023 {
    style.fill: "#DDA0DD"
    shape: rectangle
    width: 180
  }
}

user_a_pd: Process A Page Directory {
  style.fill: "#E0F0E8"
  style.stroke: "#3CB371"
  style.stroke-width: 2
  
  user_desc_a: |md
    **Process A's Isolated Space**
    
    • User pages at 0x00000000-0xBFFFFFFF
    • User-accessible (PAGE_USER = 1)
    • Cannot access Process B's memory
    • Kernel pages inherited but read-only to user
  | {
    shape: text
    style.font-size: 14
  }
  
  entries_a_u: Entries 0-767 (User) {
    style.fill: "#98FB98"
    shape: rectangle
    width: 140
  }
  
  entries_a_k: Entries 768-1023 (Kernel) {
    style.fill: "#DDA0DD"
    shape: rectangle
    width: 140
  }
}

user_b_pd: Process B Page Directory {
  style.fill: "#F0E8E0"
  style.stroke: "#CD853F"
  style.stroke-width: 2
  
  user_desc_b: |md
    **Process B's Isolated Space**
    
    • Different user pages than Process A
    • Same kernel mappings as Process A
    • Cannot access Process A's memory
    • CR3 switch on context switch
  | {
    shape: text
    style.font-size: 14
  }
  
  entries_b_u: Entries 0-767 (User) {
    style.fill: "#DEB887"
    shape: rectangle
    width: 140
  }
  
  entries_b_k: Entries 768-1023 (Kernel) {
    style.fill: "#DDA0DD"
    shape: rectangle
    width: 140
  }
}

kernel_pd.entries_k -> user_a_pd.entries_a_k: "Shared mapping\n(supervisor-only)" {
  style.stroke: "#7B68EE"
  style.stroke-dash: 3
  style.animated: true
}

kernel_pd.entries_k -> user_b_pd.entries_b_k: "Shared mapping\n(supervisor-only)" {
  style.stroke: "#7B68EE"
  style.stroke-dash: 3
  style.animated: true
}

legend: {
  near: bottom-center
  shape: rectangle
  style.fill: "#F5F5F5"
  style.stroke: "#CCCCCC"
  width: 600
  
  legend_title: "Legend" {
    style.bold: true
  }
  
  row1: {
    grid-columns: 4
    grid-gap: 20
    
    k_box: "" {shape: rectangle; width: 20; style.fill: "#DDA0DD"}
    k_label: "Kernel pages (supervisor-only)"
    
    u_box: "" {shape: rectangle; width: 20; style.fill: "#98FB98"}
    u_label: "Process A user pages"
    
    b_box: "" {shape: rectangle; width: 20; style.fill: "#DEB887"}
    b_label: "Process B user pages"
    
    arrow_label: "---> Shared kernel mapping"
  }
}

cr3_note: |md
  **CR3 Switching on Context Switch**
  
  
  ; Switch to Process A
  mov eax, [process_a.page_directory]
  mov cr3, eax        ; TLB flushed!
  
  ; Switch to Process B  
  mov eax, [process_b.page_directory]
  mov cr3, eax        ; TLB flushed again!
  
| {
  near: center-left
  shape: text
  style.font: mono
  style.font-size: 12
}

isolation_note: |md
  **Isolation Guarantee**
  
  Process A accessing 0x00400000:
  → Page fault if not in A's user pages
  
  Process B accessing 0x00400000:
  → Maps to B's page (different physical frame)
  
  Either process accessing 0xC0100000:
  → Page fault (supervisor-only) from ring 3
  → Success from ring 0 (kernel mode)
| {
  near: center-right
  shape: text
  style.font-size: 12
  style.fill: "#FFFACD"
  style.stroke: "#DAA520"
}

address_space: Virtual Address Space Layout {
  direction: right
  near: bottom-center
  
  low: |md
    **0x00000000**
    User Space
    (Process-specific)
  | {shape: text}
  
  kernel_boundary: |md
    **0xC0000000**
    Kernel Boundary
  | {shape: text; style.bold: true}
  
  high: |md
    **0xFFFFFFFF**
    Kernel Space
    (Shared, supervisor-only)
  | {shape: text}
  
  low -> kernel_boundary -> high
}