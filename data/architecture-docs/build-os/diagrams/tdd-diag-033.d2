vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Jump to User Mode: Stack Setup for iret
  Kernel stack layout before executing `iret` to enter ring 3
|

# Stack grows downward (high to low addresses)
stack_direction: |md
  ↓ Stack grows down
| {
  near: top-left
  shape: text
  style.font-size: 14
  style.italic: true
}

# Stack frame container
stack_frame: {
  label: "Kernel Stack\n(before iret)"
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  style.stroke-width: 2
  
  # Stack entries from top to bottom (high to low addresses)
  ss_entry: {
    label: "SS = 0x23"
    style.fill: "#FFB6C1"
    style.stroke: "#CC6699"
    width: 200
    height: 40
  }
  
  esp_entry: {
    label: "ESP = User Stack Top\n(e.g., 0xBFFFF000)"
    style.fill: "#98FB98"
    style.stroke: "#66CC66"
    width: 200
    height: 50
  }
  
  eflags_entry: {
    label: "EFLAGS = 0x202\n(IF=1, bit 1 reserved)"
    style.fill: "#ADD8E6"
    style.stroke: "#6699CC"
    width: 200
    height: 50
  }
  
  cs_entry: {
    label: "CS = 0x1B"
    style.fill: "#DDA0DD"
    style.stroke: "#9966CC"
    width: 200
    height: 40
  }
  
  eip_entry: {
    label: "EIP = User Entry Point\n(e.g., 0x00001000)"
    style.fill: "#F0E68C"
    style.stroke: "#CCAA33"
    width: 200
    height: 50
  }
  
  # Show stack ordering with connections
  ss_entry -> esp_entry: " "
  esp_entry -> eflags_entry: " "
  eflags_entry -> cs_entry: " "
  cs_entry -> eip_entry: " "
}

# Address labels on the side
addresses: {
  shape: text
  label: |md
    High Address
    (ESP before push)
    
    ↓
    ↓
    ↓
    ↓
    ↓
    Low Address
    (ESP after push)
  |
  style.font: mono
  style.font-size: 11
}

# Segment selector breakdown
selector_breakdown: {
  label: "Segment Selector Encoding"
  style.fill: "#F5F5F5"
  style.stroke: "#999999"
  style.stroke-dash: 2
  
  cs_selector: {
    label: |md
      **CS = 0x1B (User Code)**
      
      Binary: 0001 1011
              │││   ││
              │││   └─ RPL = 3 (Ring 3)
              ││└───── TI = 0 (GDT)
              └┴────── Index = 3 (GDT entry 3)
      
    |
    shape: text
    style.fill: "#DDA0DD"
    style.stroke: "#9966CC"
    width: 280
  }
  
  ss_selector: {
    label: |md
      **SS = 0x23 (User Data)**
      
      Binary: 0010 0011
              │││   ││
              │││   └─ RPL = 3 (Ring 3)
              ││└───── TI = 0 (GDT)
              └┴────── Index = 4 (GDT entry 4)
      
    |
    shape: text
    style.fill: "#FFB6C1"
    style.stroke: "#CC6699"
    width: 280
  }
  
  cs_selector -> ss_selector: " "
}

# GDT reference
gdt_reference: {
  label: "GDT Layout Reference"
  style.fill: "#E6E6FA"
  style.stroke: "#6666CC"
  
  gdt_table: {
    shape: sql_table
    label: "GDT"
    
    null_entry: "Index 0: Null"
    kcode: "Index 1: Kernel Code (0x08)"
    kdata: "Index 2: Kernel Data (0x10)"
    ucode: "Index 3: User Code (0x1B)"
    udata: "Index 4: User Data (0x23)"
  }
  
  ucode_row: {
    label: "User Code Selector\n= 3 × 8 + 3 = 0x1B"
    shape: text
    style.fill: "#DDA0DD"
  }
  
  udata_row: {
    label: "User Data Selector\n= 4 × 8 + 3 = 0x23"
    shape: text
    style.fill: "#FFB6C1"
  }
}

# iret behavior
iret_behavior: {
  label: "iret Behavior"
  style.fill: "#FFFACD"
  style.stroke: "#CCAA33"
  
  iret_steps: {
    label: |md
      1. Pop EIP from stack
      2. Pop CS from stack
      3. Pop EFLAGS from stack
      4. **If CPL changes:** Pop ESP, Pop SS
      5. Resume execution at CS:EIP
    |
    shape: text
    style.font: mono
  }
}

# CPL transition note
cpl_note: {
  label: |md
    **Critical:** CS.RPL (bits 0-1) = 3 tells CPU to enter Ring 3.
    This triggers privilege level change → CPU pops SS and ESP.
  |
  shape: text
  style.fill: "#FFE4B5"
  style.stroke: "#CC8833"
  style.stroke-width: 2
  near: bottom-center
}

# Assembly code reference
asm_code: {
  label: "Assembly Setup Code"
  style.fill: "#2D2D2D"
  style.font-color: "#FFFFFF"
  
  code: |md
    asm
    jump_to_user_mode:
        mov eax, [esp + 4]     ; entry point
        mov ebx, [esp + 8]     ; stack top
        
        ; Load user data segments
        mov ax, 0x23           ; User data (index 4, RPL=3)
        mov ds, ax
        mov es, ax
        mov fs, ax
        mov gs, ax
        
        ; Setup iret stack frame
        push 0x23              ; SS (user data segment)
        push ebx               ; ESP (user stack top)
        push 0x202             ; EFLAGS (IF=1)
        push 0x1B              ; CS (user code segment)
        push eax               ; EIP (entry point)
        
        iret                   ; Jump to ring 3!
    
  |
  shape: text
  style.font: mono
}

# Connections to show relationships
stack_frame.ss_entry -> selector_breakdown.ss_selector: "SS value" {
  style.stroke-dash: 3
  style.stroke: "#CC6699"
}
stack_frame.cs_entry -> selector_breakdown.cs_selector: "CS value" {
  style.stroke-dash: 3
  style.stroke: "#9966CC"
}

selector_breakdown.cs_selector -> gdt_reference.ucode_row: " " {
  style.stroke-dash: 3
  style.stroke: "#9966CC"
}
selector_breakdown.ss_selector -> gdt_reference.udata_row: " " {
  style.stroke-dash: 3
  style.stroke: "#CC6699"
}