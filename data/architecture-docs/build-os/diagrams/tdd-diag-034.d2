vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

System_Call_INT_0x80_Entry_and_Exit: {
  shape: sequence_diagram
  
  User_Process: User Process (Ring 3)
  CPU: CPU
  TSS: TSS
  Kernel: Kernel Handler (Ring 0)
  
  User_Process."1. Prepare syscall"
  
  Step_1: {
    User_Process -> CPU: "INT 0x80"
    User_Process -- CPU: "EAX=syscall#, EBX/ECX/EDX=args"
  }
  
  Step_2: {
    CPU -> TSS: "2. Read ESP0/SS0"
    TSS -> CPU: "Kernel stack pointer"
  }
  
  Step_3: {
    CPU -> CPU: "3. Switch to ring 0"
    CPU -- CPU: "Load SS:ESP from TSS"
  }
  
  Step_4: {
    CPU -> CPU: "4. Push user state"
    CPU -- CPU: "SS, ESP, EFLAGS, CS, EIP"
  }
  
  Step_5: {
    CPU -> Kernel: "5. Jump to IDT[0x80]"
  }
  
  Step_6: {
    Kernel -> Kernel: "6. Save registers"
    Kernel -- Kernel: "pusha, push ds/es/fs/gs"
  }
  
  Step_7: {
    Kernel -> Kernel: "7. Dispatch syscall"
    Kernel -- Kernel: "handler = table[EAX]"
    Kernel -- Kernel: "args: EBX, ECX, EDX"
  }
  
  Step_8: {
    Kernel -> Kernel: "8. Execute syscall"
  }
  
  Step_9: {
    Kernel -> Kernel: "9. Set return value"
    Kernel -- Kernel: "EAX = result"
  }
  
  Step_10: {
    Kernel -> Kernel: "10. Restore registers"
    Kernel -- Kernel: "pop gs/fs/es/ds, popa"
  }
  
  Step_11: {
    Kernel -> CPU: "11. IRET"
  }
  
  Step_12: {
    CPU -> CPU: "12. Restore user state"
    CPU -- CPU: "Pop EIP, CS, EFLAGS, ESP, SS"
  }
  
  Step_13: {
    CPU -> User_Process: "13. Resume in ring 3"
    CPU -- User_Process: "EAX contains return value"
  }
  
  User_Process."14. Continue execution"
}