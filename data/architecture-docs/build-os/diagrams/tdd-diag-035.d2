vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Multi-Process Demo: Three Concurrent Processes
  Preemptive Round-Robin Scheduling
| {near: top-center}

# Hardware Layer
timer_hardware: {
  label: PIT Timer\n(Hardware)
  shape: diamond
  style.fill: "#E8D5B7"
  style.stroke: "#8B7355"
  style.font-color: "#5D4E37"
}

# Interrupt Layer
irq0_interrupt: {
  label: IRQ0\nTimer Interrupt
  shape: hexagon
  style.fill: "#FFE4B5"
  style.stroke: "#CD853F"
}

# Scheduler
scheduler: {
  label: Round-Robin\nScheduler
  style.fill: "#E6F3FF"
  style.stroke: "#4A90D9"
  style.bold: true
}

# Ready Queue
ready_queue: {
  label: Ready Queue (Circular)
  style.fill: "#F0F0F0"
  style.stroke: "#999999"
  style.stroke-dash: 3
  
  proc_a_queue: Process A {
    style.fill: "#90EE90"
    style.stroke: "#228B22"
  }
  proc_b_queue: Process B {
    style.fill: "#87CEEB"
    style.stroke: "#4169E1"
  }
  proc_c_queue: Process C {
    style.fill: "#FFB6C1"
    style.stroke: "#DC143C"
  }
  
  proc_a_queue -> proc_b_queue: next
  proc_b_queue -> proc_c_queue: next
  proc_c_queue -> proc_a_queue: next
}

# Context Switch
context_switch: {
  label: Context Switch\n(Save/Restore)
  style.fill: "#DDA0DD"
  style.stroke: "#8B008B"
  style.bold: true
}

# Three Processes
processes: {
  label: Running Processes
  style.fill: "#FAFAFA"
  style.stroke: "#333333"
  
  proc_a: {
    label: "Process A\nPID=1\nRing 0"
    style.fill: "#90EE90"
    style.stroke: "#228B22"
    style.stroke-width: 3
    
    code_a: |md
      c
      void proc_a(void) {
        int col = 0;
        while(1) {
          vga_putc_at(0, col, 'A');
          col = (col+1) % 26;
          delay();
        }
      }
      
    |
  }
  
  proc_b: {
    label: "Process B\nPID=2\nRing 0"
    style.fill: "#87CEEB"
    style.stroke: "#4169E1"
    style.stroke-width: 3
    
    code_b: |md
      c
      void proc_b(void) {
        int col = 0;
        while(1) {
          vga_putc_at(10, col, 'B');
          col = (col+1) % 26;
          delay();
        }
      }
      
    |
  }
  
  proc_c: {
    label: "Process C\nPID=3\nRing 0"
    style.fill: "#FFB6C1"
    style.stroke: "#DC143C"
    style.stroke-width: 3
    
    code_c: |md
      c
      void proc_c(void) {
        int col = 0;
        while(1) {
          vga_putc_at(20, col, 'C');
          col = (col+1) % 26;
          delay();
        }
      }
      
    |
  }
}

# VGA Output
vga_display: {
  label: VGA Text Buffer\n(0xB8000)
  style.fill: "#2F2F2F"
  style.stroke: "#000000"
  style.font-color: "#FFFFFF"
  
  row0: {
    label: Row 0
    style.fill: "#1a1a1a"
    style.stroke: "#333"
    
    cell_a1: A {style.fill: "#228B22"; style.font-color: white; style.bold: true}
    cell_a2: A {style.fill: "#228B22"; style.font-color: white; style.bold: true}
    cell_a3: A {style.fill: "#228B22"; style.font-color: white; style.bold: true}
    cell_a4: A {style.fill: "#228B22"; style.font-color: white; style.bold: true}
    cell_a5: A {style.fill: "#228B22"; style.font-color: white; style.bold: true}
    dots_a: ... {style.fill: "#1a1a1a"; style.font-color: "#666"}
  }
  
  row1: {
    label: Row 10
    style.fill: "#1a1a1a"
    style.stroke: "#333"
    
    cell_b1: B {style.fill: "#4169E1"; style.font-color: white; style.bold: true}
    cell_b2: B {style.fill: "#4169E1"; style.font-color: white; style.bold: true}
    cell_b3: B {style.fill: "#4169E1"; style.font-color: white; style.bold: true}
    cell_b4: B {style.fill: "#4169E1"; style.font-color: white; style.bold: true}
    cell_b5: B {style.fill: "#4169E1"; style.font-color: white; style.bold: true}
    dots_b: ... {style.fill: "#1a1a1a"; style.font-color: "#666"}
  }
  
  row2: {
    label: Row 20
    style.fill: "#1a1a1a"
    style.stroke: "#333"
    
    cell_c1: C {style.fill: "#DC143C"; style.font-color: white; style.bold: true}
    cell_c2: C {style.fill: "#DC143C"; style.font-color: white; style.bold: true}
    cell_c3: C {style.fill: "#DC143C"; style.font-color: white; style.bold: true}
    cell_c4: C {style.fill: "#DC143C"; style.font-color: white; style.bold: true}
    cell_c5: C {style.fill: "#DC143C"; style.font-color: white; style.bold: true}
    dots_c: ... {style.fill: "#1a1a1a"; style.font-color: "#666"}
  }
}

# Time Slice Timeline
timeline: {
  label: Execution Timeline (10ms quantum)
  style.fill: "#FFF8DC"
  style.stroke: "#DAA520"
  
  t1: {
    label: 0-10ms
    proc_run: Process A runs {
      style.fill: "#90EE90"
      style.stroke: "#228B22"
    }
  }
  t2: {
    label: 10-20ms
    proc_run: Process B runs {
      style.fill: "#87CEEB"
      style.stroke: "#4169E1"
    }
  }
  t3: {
    label: 20-30ms
    proc_run: Process C runs {
      style.fill: "#FFB6C1"
      style.stroke: "#DC143C"
    }
  }
  t4: {
    label: 30-40ms
    proc_run: Process A runs {
      style.fill: "#90EE90"
      style.stroke: "#228B22"
    }
  }
  dots: "..." {style.fill: "#FFF8DC"; style.font-color: "#666"}
  
  t1 -> t2 -> t3 -> t4 -> dots
}

# Connections - Main Flow
timer_hardware -> irq0_interrupt: fires every 10ms {
  style.stroke: "#8B7355"
  style.stroke-width: 2
}

irq0_interrupt -> scheduler: triggers {
  style.stroke: "#CD853F"
  style.stroke-width: 2
}

scheduler -> ready_queue: pick_next() {
  style.stroke: "#4A90D9"
  style.stroke-dash: 3
}

ready_queue -> scheduler: returns next process {
  style.stroke: "#4A90D9"
  style.stroke-dash: 3
}

scheduler -> context_switch: switch_to(next) {
  style.stroke: "#8B008B"
  style.stroke-width: 2
  style.animated: true
}

# Context switch to processes
context_switch -> processes.proc_a: {
  style.stroke: "#228B22"
  style.stroke-width: 2
}
context_switch -> processes.proc_b: {
  style.stroke: "#4169E1"
  style.stroke-width: 2
}
context_switch -> processes.proc_c: {
  style.stroke: "#DC143C"
  style.stroke-width: 2
}

# Processes to VGA
processes.proc_a -> vga_display.row0: writes 'A' {
  style.stroke: "#228B22"
  style.stroke-width: 2
}
processes.proc_b -> vga_display.row1: writes 'B' {
  style.stroke: "#4169E1"
  style.stroke-width: 2
}
processes.proc_c -> vga_display.row2: writes 'C' {
  style.stroke: "#DC143C"
  style.stroke-width: 2
}

# Process execution feeds back to ready queue
processes.proc_a -> ready_queue.proc_a_queue: time slice expired {
  style.stroke: "#228B22"
  style.stroke-dash: 5
}
processes.proc_b -> ready_queue.proc_b_queue: time slice expired {
  style.stroke: "#4169E1"
  style.stroke-dash: 5
}
processes.proc_c -> ready_queue.proc_c_queue: time slice expired {
  style.stroke: "#DC143C"
  style.stroke-dash: 5
}

# Legend
legend: {
  near: bottom-right
  style.fill: "#F5F5F5"
  style.stroke: "#999"
  
  note: |md
    **Preemptive Scheduling Flow:**
    
    1. PIT timer fires IRQ0 every 10ms
    2. Timer interrupt handler calls scheduler
    3. Scheduler picks next process (round-robin)
    4. Context switch saves old process state
    5. Context switch restores new process state
    6. New process runs until next timer tick
    7. Process writes to its VGA region
    
    **Key Invariants:**
    - Each process has isolated execution
    - Context switch is atomic (interrupts disabled)
    - All processes get fair CPU time
    - VGA writes go to different rows (no corruption)
  |
}