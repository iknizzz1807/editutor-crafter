vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Boot Sequence State Machine: BIOS to kmain()
  *x86 Power-On â†’ 16-bit Real Mode â†’ 32-bit Protected Mode â†’ C Kernel Entry*
| {near: top-center}

# â”€â”€ States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

reset: RESET / POWER-ON {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#e94560"
  style.stroke-width: 3
  style.font-color: white
}

firmware: FIRMWARE (BIOS ROM) {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#0f3460"
  style.stroke-width: 2
  style.font-color: white
  style.border-radius: 6
  inv: |md
    **Invariants**
    - CPU at 0xFFFFFFF0 (ROM alias)
    - 16-bit real mode
    - MTRR/PAT: default
    - A20 line: OFF
    - CS=0xF000 IP=0xFFF0
  |
}

post: POST + DEVICE INIT {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#0f3460"
  style.stroke-width: 2
  style.font-color: white
  style.border-radius: 6
  inv: |md
    **Invariants**
    - IVT loaded at 0x0000
    - BIOS Data Area at 0x0400
    - Memory sized via INT 15h
    - Boot device selected
    - Interrupts: ENABLED (BIOS IVT)
  |
}

mbr_load: MBR LOAD {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#0f3460"
  style.stroke-width: 2
  style.font-color: white
  style.border-radius: 6
  inv: |md
    **Invariants**
    - 512 bytes at 0x7C00
    - Signature 0x55 0xAA verified
    - DL = boot drive number
    - DS=ES=0, SS=0, SP=0x7C00
    - Interrupts: ENABLED
  |
}

stage1: STAGE 1 (MBR) {
  shape: rectangle
  style.fill: "#0a2342"
  style.stroke: "#e94560"
  style.stroke-width: 2
  style.font-color: white
  style.border-radius: 6
  inv: |md
    **Invariants**
    - org 0x7C00; 16-bit real mode
    - DL preserved (boot drive)
    - INT 13h available (BIOS IVT)
    - Stack: SS=0, SP=0x7C00
    - Size: EXACTLY 512 bytes
    - Bytes 510â€“511 = 0x55 0xAA
  |
}

stage2_load: STAGE 2 LOADED {
  shape: rectangle
  style.fill: "#0a2342"
  style.stroke: "#e94560"
  style.stroke-width: 2
  style.font-color: white
  style.border-radius: 6
  inv: |md
    **Invariants**
    - Stage 2 at 0x7E00 (sectors 1â€“8)
    - Up to 4 KB available
    - BIOS IVT still valid
    - Interrupts: ENABLED
  |
}

a20_enabled: A20 ENABLED {
  shape: rectangle
  style.fill: "#0a2342"
  style.stroke: "#f5a623"
  style.stroke-width: 2
  style.font-color: white
  style.border-radius: 6
  inv: |md
    **Invariants**
    - 21st address bit active
    - [0x100000] â‰  [0x000000]
    - Address space: full 4 GB
    - BIOS IVT: still valid
    - Interrupts: ENABLED
  |
}

kernel_loaded: KERNEL LOADED {
  shape: rectangle
  style.fill: "#0a2342"
  style.stroke: "#f5a623"
  style.stroke-width: 2
  style.font-color: white
  style.border-radius: 6
  inv: |md
    **Invariants**
    - Kernel binary at phys 0x100000
    - Loaded via INT 13h / Unreal Mode
    - Still in 16-bit real mode
    - BIOS calls still functional
  |
}

cli_active: CLI ACTIVE {
  shape: rectangle
  style.fill: "#3d0000"
  style.stroke: "#e94560"
  style.stroke-width: 3
  style.font-color: white
  style.border-radius: 6
  inv: |md
    **Invariants**
    - EFLAGS.IF = 0 (HARD REQUIREMENT)
    - BIOS IVT: present but DANGEROUS
    - lgdt must be next instruction
    - No BIOS calls permitted
    - No delay loops using INT
  |
}

gdt_loaded: GDT LOADED {
  shape: rectangle
  style.fill: "#3d0000"
  style.stroke: "#e94560"
  style.stroke-width: 3
  style.font-color: white
  style.border-radius: 6
  inv: |md
    **Invariants**
    - GDTR.base = &gdt_start
    - GDTR.limit = 39 (5 entries Ã— 8 âˆ’ 1)
    - Entries: null, K-code, K-data, U-code, U-data
    - CR0.PE = 0 still (real mode)
    - EFLAGS.IF = 0
  |
}

pm_unstable: PROTECTED MODE UNSTABLE {
  shape: rectangle
  style.fill: "#3d0000"
  style.stroke: "#e94560"
  style.stroke-width: 4
  style.font-color: white
  style.border-radius: 6
  inv: |md
    **DANGER ZONE**
    - CR0.PE = 1 (prot. mode ON)
    - CS = stale real-mode value
    - Pipeline: real-mode prefetch
    - ONLY VALID OP: far jmp 0x08:label
    - IF = 0
  |
}

pm_stable: PROTECTED MODE STABLE {
  shape: rectangle
  style.fill: "#003d1a"
  style.stroke: "#00c853"
  style.stroke-width: 3
  style.font-color: white
  style.border-radius: 6
  inv: |md
    **Invariants**
    - CR0.PE = 1
    - CS = 0x0008 (kernel code)
    - Pipeline: 32-bit clean
    - DS = ES = FS = GS = SS = 0x10
    - ESP = kernel_stack_top
    - IF = 0; No IDT yet
  |
}

bss_zero: BSS ZEROED {
  shape: rectangle
  style.fill: "#003d1a"
  style.stroke: "#00c853"
  style.stroke-width: 2
  style.font-color: white
  style.border-radius: 6
  inv: |md
    **Invariants**
    - [__bss_start .. __bss_end) = 0
    - All C globals with no initialiser = 0
    - rep stosd complete
    - ESP valid; stack usable
    - kmain() callable
  |
}

kmain_entry: kmain() EXECUTING {
  shape: rectangle
  style.fill: "#003d1a"
  style.stroke: "#00c853"
  style.stroke-width: 3
  style.font-color: white
  style.border-radius: 6
  style.bold: true
  inv: |md
    **Module Exit Invariants**
    - CR0.PE = 1; CS=0x08; DS=0x10
    - BSS: zeroed
    - VGA driver: operational (0xB8000)
    - Serial COM1: 38400/8N1
    - GDT: 5 descriptors
    - IF = 0 (interrupts still OFF)
    - Ready for mod-2 (IDT setup)
  |
}

# â”€â”€ Error / Halt States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

disk_err: DISK ERROR HALT {
  shape: rectangle
  style.fill: "#4a0000"
  style.stroke: "#e94560"
  style.stroke-width: 2
  style.font-color: "#ff6b6b"
  style.border-radius: 4
  label: "DISK ERROR\nHALT"
}

a20_err: A20 FAIL HALT {
  shape: rectangle
  style.fill: "#4a0000"
  style.stroke: "#e94560"
  style.stroke-width: 2
  style.font-color: "#ff6b6b"
  style.border-radius: 4
  label: "A20 FAIL\nHALT"
}

triple_fault: TRIPLE FAULT {
  shape: rectangle
  style.fill: "#4a0000"
  style.stroke: "#e94560"
  style.stroke-width: 4
  style.font-color: "#ff6b6b"
  style.border-radius: 4
  style.bold: true
  label: "TRIPLE FAULT\nâ†’ REBOOT"
}

# â”€â”€ Transitions (happy path) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

reset -> firmware: "CPU executes at\n0xFFFFFFF0\n(ROM alias)" {
  style.stroke: "#00c853"
  style.stroke-width: 2
}

firmware -> post: "POST init\n& device enum" {
  style.stroke: "#00c853"
  style.stroke-width: 2
}

post -> mbr_load: "Find bootable disk\nINT 13h reads sector 0\nto 0x7C00\nverify 0x55 0xAA" {
  style.stroke: "#00c853"
  style.stroke-width: 2
}

mbr_load -> stage1: "BIOS jumps\nto 0x7C00" {
  style.stroke: "#00c853"
  style.stroke-width: 2
}

stage1 -> stage2_load: "INT 13h: read\n8 sectors â†’ 0x7E00\nDL = boot drive\njmp 0x7E00" {
  style.stroke: "#f5a623"
  style.stroke-width: 2
}

stage2_load -> a20_enabled: "BIOS INT 15h\nAX=2401h\nor port 0x92\nA20 verify loop" {
  style.stroke: "#f5a623"
  style.stroke-width: 2
}

a20_enabled -> kernel_loaded: "Unreal mode trick\n+ INT 13h loop\nread kernel to\nphys 0x100000" {
  style.stroke: "#f5a623"
  style.stroke-width: 2
}

kernel_loaded -> cli_active: "cli\n(EFLAGS.IF â†’ 0)\nPoint of no return\nfor BIOS calls" {
  style.stroke: "#e94560"
  style.stroke-width: 3
}

cli_active -> gdt_loaded: "lgdt [gdt_descriptor]\n(6-byte: limit=39\nbase=&gdt_start)" {
  style.stroke: "#e94560"
  style.stroke-width: 3
}

gdt_loaded -> pm_unstable: "mov eax, cr0\nor eax, 1\nmov cr0, eax\n(CR0.PE = 1)" {
  style.stroke: "#e94560"
  style.stroke-width: 4
  style.bold: true
}

pm_unstable -> pm_stable: "jmp 0x08:pm32_entry\n(far jump: loads CS=0x08\nflushes pipeline)\nload DS/ES/FS/GS/SS=0x10\nmov esp, kernel_stack_top" {
  style.stroke: "#00c853"
  style.stroke-width: 4
  style.bold: true
}

pm_stable -> bss_zero: "rep stosd\n[__bss_start .. __bss_end)\n(ECX = bytesÃ·4\nEAX = 0, EDI = start)" {
  style.stroke: "#00c853"
  style.stroke-width: 2
}

bss_zero -> kmain_entry: "call kmain\n(serial_init â†’ vga_init\nâ†’ kprintf ready)" {
  style.stroke: "#00c853"
  style.stroke-width: 3
  style.bold: true
}

# â”€â”€ Error transitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

stage1 -> disk_err: "INT 13h CF=1\nor AHâ‰ 0" {
  style.stroke: "#e94560"
  style.stroke-dash: 4
  style.font-color: "#e94560"
}

stage2_load -> disk_err: "Stage 2\nread failure" {
  style.stroke: "#e94560"
  style.stroke-dash: 4
  style.font-color: "#e94560"
}

a20_enabled -> a20_err: "BIOS + port 0x92\nboth fail\n[0x100000]=[0x00000]" {
  style.stroke: "#e94560"
  style.stroke-dash: 4
  style.font-color: "#e94560"
}

# â”€â”€ Illegal transition (annotated) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cli_active -> triple_fault: "ILLEGAL:\ninterrupt fires\nbetween cli and iret\n(BIOS IVT + protected mode)" {
  style.stroke: "#e94560"
  style.stroke-dash: 6
  style.stroke-width: 2
  style.font-color: "#ff6b6b"
}

pm_unstable -> triple_fault: "ILLEGAL:\nany instruction\nexcept far jmp\n(stale CS, pipeline hazard)" {
  style.stroke: "#e94560"
  style.stroke-dash: 6
  style.stroke-width: 3
  style.font-color: "#ff6b6b"
}

gdt_loaded -> triple_fault: "ILLEGAL:\nsti before\nfar jump\n(IVT + CR0.PE race)" {
  style.stroke: "#e94560"
  style.stroke-dash: 6
  style.stroke-width: 2
  style.font-color: "#ff6b6b"
}

# â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

legend: |md
  **Legend**
  ğŸŸ¢ Happy path  ğŸ”´ Error / Halt
  âš ï¸  Danger zone (IF must stay 0)
  â•Œâ•Œ ILLEGAL transition â†’ Triple Fault
| {
  near: bottom-right
  style.fill: "#0d0d1a"
  style.stroke: "#444"
  style.font-color: white
  style.border-radius: 8
}