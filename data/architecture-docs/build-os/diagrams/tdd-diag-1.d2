vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Physical Memory Map at Boot Time (x86 Real Mode → Protected Mode)
  Addresses 0x00000 – 0x110000 · A20 Line Boundary at 0x100000
| {near: top-center}
style.fill: "#1a1a2e"
style.stroke: "#16213e"
map: {
  style.fill: "#0f0f1a"
  style.stroke: "#333366"
  style.border-radius: 4
  direction: down
  # ─── IVT ─────────────────────────────────────────────────────────────────
  ivt: "0x00000  Interrupt Vector Table (IVT)" {
    style.fill: "#4a0080"
    style.stroke: "#9b30ff"
    style.font-color: "#e8d5ff"
    style.font-size: 13
    style.bold: true
    label: |md
      **0x00000 – 0x003FF**
      Interrupt Vector Table (IVT)
      Size: 1 KB · 256 × 4-byte real-mode far pointers
      Access: R/W (ring 0 only in protected mode)
      ⚠ Overwritten by IDT in Milestone 2
    |
  }
  # ─── BDA ─────────────────────────────────────────────────────────────────
  bda: "0x00400  BIOS Data Area (BDA)" {
    style.fill: "#4a0080"
    style.stroke: "#9b30ff"
    style.font-color: "#e8d5ff"
    style.font-size: 13
    label: |md
      **0x00400 – 0x004FF**
      BIOS Data Area (BDA)
      Size: 256 B · COM/LPT ports, equipment, keyboard state
      Access: Read-only after boot · PMM marks RESERVED
    |
  }
  # ─── Free Conventional RAM ───────────────────────────────────────────────
  conv_ram: "0x00500  Free Conventional RAM" {
    style.fill: "#003a1a"
    style.stroke: "#00cc66"
    style.font-color: "#ccffdd"
    style.font-size: 13
    label: |md
      **0x00500 – 0x07BFF**
      Free Conventional RAM
      Size: ~30 KB · Available for stage2 data, stack scratch
      Access: R/W · E820 Type 1 (Usable)
    |
  }
  # ─── Stack region ────────────────────────────────────────────────────────
  stack_region: "0x07C00  Real-Mode Boot Stack" {
    style.fill: "#1a3a00"
    style.stroke: "#66aa00"
    style.font-color: "#ddeebb"
    style.font-size: 13
    label: |md
      **0x07BFF ↓ (grows down from MBR)**
      Real-Mode Boot Stack
      SP initialized to 0x7C00 · grows toward lower addresses
      Access: R/W · ephemeral during stage1
    |
  }
  # ─── MBR ────────────────────────────────────────────────────────────────
  mbr: "0x07C00  MBR — Stage 1 Bootloader" {
    style.fill: "#7a3000"
    style.stroke: "#ff8800"
    style.font-color: "#ffe0c0"
    style.font-size: 13
    style.bold: true
    label: |md
      **0x07C00 – 0x07DFF**
      MBR — Stage 1 Bootloader
      Size: 512 B · BIOS loads from disk sector 0
      Bytes 510-511: 0x55 0xAA boot signature
      Access: Execute-once · then overwritten by stack
    |
  }
  # ─── Stage 2 ─────────────────────────────────────────────────────────────
  stage2: "0x07E00  Stage 2 Loader" {
    style.fill: "#7a3000"
    style.stroke: "#ff8800"
    style.font-color: "#ffe0c0"
    style.font-size: 13
    style.bold: true
    label: |md
      **0x07E00 – 0x08FFF**
      Stage 2 Loader
      Size: ≤ 4 KB (8 sectors) · loaded by stage1 INT 13h CHS
      Contains: A20 enable, GDT, CR0.PE, kernel copy, far jump
      Access: Execute-once · temporary residence
    |
  }
  # ─── Free RAM gap ────────────────────────────────────────────────────────
  free_gap: "0x09000  Available RAM (stage2 load buffer)" {
    style.fill: "#003a1a"
    style.stroke: "#00cc66"
    style.font-color: "#ccffdd"
    style.font-size: 13
    label: |md
      **0x09000 – 0x0FFFF**
      Kernel staging buffer (loaded here first by INT 13h)
      Size: ~28 KB · kernel binary at 0x10000 before relocation
      Access: R/W · used during stage2 disk load + memcpy
    |
  }
  # ─── EBDA ────────────────────────────────────────────────────────────────
  ebda: "0x9FC00  EBDA — Extended BIOS Data Area" {
    style.fill: "#4a0080"
    style.stroke: "#9b30ff"
    style.font-color: "#e8d5ff"
    style.font-size: 13
    label: |md
      **0x9FC00 – 0x9FFFF**
      EBDA — Extended BIOS Data Area
      Size: ≤ 1 KB · BIOS reserves; exact size varies
      Stack top set to 0x9FC00 in protected-mode entry
      Access: RESERVED · E820 Type 2 · PMM never allocates
    |
  }
  # ─── VGA Framebuffer ─────────────────────────────────────────────────────
  vga: "0xB8000  VGA Text Framebuffer" {
    style.fill: "#002244"
    style.stroke: "#0088ff"
    style.font-color: "#aaddff"
    style.font-size: 13
    style.bold: true
    label: |md
      **0xB8000 – 0xBFFFF**
      VGA Text Mode Framebuffer (MMIO)
      Size: 32 KB · 80×25 grid · 2 B/cell (char + attr)
      Cell: [ASCII][FG:BG color] · mapped at virt 0xC00B8000
      Access: MMIO R/W · volatile · PTE_CACHE_DIS required
      ⚠ Not RAM — writes go to VGA card, not DRAM
    |
  }
  # ─── Adapter ROM / Upper Memory ──────────────────────────────────────────
  upper_mem: "0xC0000  Adapter ROM / Upper Memory Area" {
    style.fill: "#2a0a00"
    style.stroke: "#884400"
    style.font-color: "#ddaa88"
    style.font-size: 13
    label: |md
      **0xC0000 – 0xEFFFF**
      Adapter ROM / Upper Memory Area (UMA)
      Size: 192 KB · VGA BIOS, option ROMs, EMS page frame
      Access: RESERVED · E820 Type 2 · never allocate
    |
  }
  # ─── BIOS ROM ────────────────────────────────────────────────────────────
  bios_rom: "0xF0000  BIOS ROM" {
    style.fill: "#2a0a00"
    style.stroke: "#ff4400"
    style.font-color: "#ffccbb"
    style.font-size: 13
    style.bold: true
    label: |md
      **0xF0000 – 0xFFFFF**
      BIOS ROM (System BIOS)
      Size: 64 KB · POST, INT 13h/10h/15h handlers
      Reset vector: 0xFFFFFFF0 (top of 32-bit space)
      Access: READ-ONLY · E820 Type 2 · hardware enforced
    |
  }
  # ─── A20 Boundary ────────────────────────────────────────────────────────
  a20_boundary: "0x100000  ← A20 Line Boundary (1 MB mark)" {
    style.fill: "#2a2a00"
    style.stroke: "#ffff00"
    style.font-color: "#ffff88"
    style.font-size: 13
    style.bold: true
    label: |md
      **── 0x100000 ── A20 LINE BOUNDARY ──**
      Without A20: address 0x100000 wraps to 0x00000
      0x10500 → 0x00500 (aliases into BDA/conventional RAM)
      With A20 enabled: 0x100000 is distinct physical RAM
      Enable methods: BIOS INT 15h/2401 → port 0x92 → KBC 8042
    |
  }
  # ─── Kernel ──────────────────────────────────────────────────────────────
  kernel: "0x100000  Kernel Binary" {
    style.fill: "#003366"
    style.stroke: "#3399ff"
    style.font-color: "#aaddff"
    style.font-size: 13
    style.bold: true
    label: |md
      **0x100000 – ~0x104FFF**
      Kernel Binary (loaded by stage2 rep movsd)
      LMA = 0x100000 · VMA = 0xC0100000 (after paging)
      Sections: .text / .rodata / .data / .bss (4 KB aligned)
      __kernel_start = 0x100000 · __kernel_end = (varies)
      Access: Execute (.text) · R/W (.data/.bss) · via PMM
    |
  }
  # ─── High RAM ────────────────────────────────────────────────────────────
  high_ram: "0x110000  High RAM (E820 Usable)" {
    style.fill: "#003a1a"
    style.stroke: "#00cc66"
    style.font-color: "#ccffdd"
    style.font-size: 13
    label: |md
      **0x110000 – (top of installed RAM)**
      High Conventional RAM — bulk of usable physical memory
      Example: 128 MB machine → usable to ~0x07FDFFFF
      Managed by PMM bitmap · frames allocated by pmm_alloc_frame()
      Access: R/W · E820 Type 1 · kernel heap + page tables
    |
  }
  ivt -> bda
  bda -> conv_ram
  conv_ram -> stack_region
  stack_region -> mbr
  mbr -> stage2
  stage2 -> free_gap
  free_gap -> ebda
  ebda -> vga
  vga -> upper_mem
  upper_mem -> bios_rom
  bios_rom -> a20_boundary
  a20_boundary -> kernel
  kernel -> high_ram
}
# ─── A20 Wrap-Around Annotation ──────────────────────────────────────────────
a20_wrap: |md
  **A20 DISABLED — Wrap-Around Effect**
  Physical address bits: A20 (bit 20) forced LOW by hardware gate
  Write to: **0x10500** (0x1 0000 0101 0000 0000)
  → Becomes: **0x00500** (0x0 0000 0101 0000 0000)
  → Silently aliases into conventional RAM / BDA region
  **Impact on kernel load:**
  Stage2 loads kernel to 0x10000–0x17FFF via INT 13h.
  Without A20: these writes hit 0x00000–0x07FFF → corrupt IVT + BDA
  → System crashes before protected-mode transition.
  **Verification test (stage2):**
  Write 0xFF to [0x10500]; read [0x00500].
  If equal → A20 OFF. If differ → A20 ON.
| {
  near: bottom-center
  style.fill: "#1a1a00"
  style.stroke: "#aaaa00"
  style.font-color: "#eeee88"
  style.border-radius: 4
}
# ─── Legend ──────────────────────────────────────────────────────────────────
legend: {
  near: bottom-left
  style.fill: "#111122"
  style.stroke: "#444488"
  style.border-radius: 4
  grid-columns: 2
  grid-gap: 8
  l1: "■ Purple — BIOS Reserved (IVT/BDA/EBDA/ROM)" {style.fill:"#4a0080";style.stroke:"#9b30ff";style.font-color:"#e8d5ff";style.font-size:11}
  l2: "■ Green — Usable RAM (E820 Type 1)" {style.fill:"#003a1a";style.stroke:"#00cc66";style.font-color:"#ccffdd";style.font-size:11}
  l3: "■ Orange — Bootloader (stage1/stage2)" {style.fill:"#7a3000";style.stroke:"#ff8800";style.font-color:"#ffe0c0";style.font-size:11}
  l4: "■ Blue — MMIO / VGA Framebuffer" {style.fill:"#002244";style.stroke:"#0088ff";style.font-color:"#aaddff";style.font-size:11}
  l5: "■ Dark Red — Adapter ROM / Upper Memory" {style.fill:"#2a0a00";style.stroke:"#884400";style.font-color:"#ddaa88";style.font-size:11}
  l6: "■ Sky Blue — Kernel Binary + High RAM" {style.fill:"#003366";style.stroke:"#3399ff";style.font-color:"#aaddff";style.font-size:11}
  l7: "── Yellow ── A20 boundary / wrap-around limit" {style.fill:"#2a2a00";style.stroke:"#ffff00";style.font-color:"#ffff88";style.font-size:11}
  l8: "PMM never allocates Purple or Dark Red regions" {style.fill:"#111122";style.stroke:"#444488";style.font-color:"#8888cc";style.font-size:11}
}