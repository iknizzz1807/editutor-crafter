vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Interrupt Stack Frame â€” With vs Without Error Code
  After CPU delivery + `pusha` + segment saves in `isr_common_stub`
| {near: top-center}

# â”€â”€ LEFT: No Error Code (e.g., IRQ0, vector 32) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
no_err: "No Error Code (e.g., IRQ0 / #DE / #BP)" {
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a8a"
  style.border-radius: 6

  label_high: "HIGH ADDRESS (stack bottom)" {
    style.fill: "#2d2d2d"
    style.stroke: "#555"
    style.font-color: "#888"
    style.font-size: 11
  }
  eflags_ne: "[ESP+64]  EFLAGS = 0x00000202" {
    style.fill: "#6B2D8B"
    style.stroke: "#9B4DBB"
    style.font-color: white
    style.font: mono
    style.font-size: 12
  }
  cs_ne: "[ESP+60]  CS    = 0x0008" {
    style.fill: "#6B2D8B"
    style.stroke: "#9B4DBB"
    style.font-color: white
    style.font: mono
    style.font-size: 12
  }
  eip_ne: "[ESP+56]  EIP   = <interrupted addr>" {
    style.fill: "#6B2D8B"
    style.stroke: "#9B4DBB"
    style.font-color: white
    style.font: mono
    style.font-size: 12
  }
  cpu_brace_ne: "â”€â”€ CPU pushed (always 3 words) â”€â”€" {
    style.fill: "#111"
    style.stroke: "#444"
    style.font-color: "#9B4DBB"
    style.font-size: 11
    style.italic: true
  }
  err_code_ne: "[ESP+52]  err_code = 0x00000000  â† ISR_NOERR pushed fake 0" {
    style.fill: "#2D6A2D"
    style.stroke: "#4D9A4D"
    style.font-color: white
    style.font: mono
    style.font-size: 12
    style.bold: true
  }
  int_no_ne: "[ESP+48]  int_no   = 32" {
    style.fill: "#2D6A2D"
    style.stroke: "#4D9A4D"
    style.font-color: white
    style.font: mono
    style.font-size: 12
  }
  stub_brace_ne: "â”€â”€ ISR stub pushed (2 words) â”€â”€" {
    style.fill: "#111"
    style.stroke: "#444"
    style.font-color: "#4D9A4D"
    style.font-size: 11
    style.italic: true
  }
  gs_ne: "[ESP+44]  GS" {
    style.fill: "#1a3a5c"
    style.stroke: "#2a6aac"
    style.font-color: "#aaccff"
    style.font: mono
    style.font-size: 12
  }
  fs_ne: "[ESP+40]  FS" {
    style.fill: "#1a3a5c"
    style.stroke: "#2a6aac"
    style.font-color: "#aaccff"
    style.font: mono
    style.font-size: 12
  }
  es_ne: "[ESP+36]  ES" {
    style.fill: "#1a3a5c"
    style.stroke: "#2a6aac"
    style.font-color: "#aaccff"
    style.font: mono
    style.font-size: 12
  }
  ds_ne: "[ESP+32]  DS" {
    style.fill: "#1a3a5c"
    style.stroke: "#2a6aac"
    style.font-color: "#aaccff"
    style.font: mono
    style.font-size: 12
  }
  seg_brace_ne: "â”€â”€ isr_common_stub: push ds/es/fs/gs â”€â”€" {
    style.fill: "#111"
    style.stroke: "#444"
    style.font-color: "#2a6aac"
    style.font-size: 11
    style.italic: true
  }
  edi_ne: "[ESP+28]  EDI" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
  }
  esi_ne: "[ESP+24]  ESI" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
  }
  ebp_ne: "[ESP+20]  EBP" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
  }
  esp_d_ne: "[ESP+16]  ESP (pre-pusha, unreliable)" {
    style.fill: "#3a3a1a"
    style.stroke: "#6a6a2a"
    style.font-color: "#cccc88"
    style.font: mono
    style.font-size: 12
  }
  ebx_ne: "[ESP+12]  EBX" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
  }
  edx_ne: "[ESP+8]   EDX" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
  }
  ecx_ne: "[ESP+4]   ECX" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
  }
  eax_ne: "[ESP+0]   EAX  â† ESP when interrupt_dispatch called" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
    style.bold: true
  }
  pusha_brace_ne: "â”€â”€ isr_common_stub: pusha (8 words) â”€â”€" {
    style.fill: "#111"
    style.stroke: "#444"
    style.font-color: "#2a8a2a"
    style.font-size: 11
    style.italic: true
  }
  label_low: "LOW ADDRESS (stack top = ESP)" {
    style.fill: "#2d2d2d"
    style.stroke: "#555"
    style.font-color: "#888"
    style.font-size: 11
  }

  label_high -> eflags_ne -> cs_ne -> eip_ne -> cpu_brace_ne -> err_code_ne -> int_no_ne -> stub_brace_ne -> gs_ne -> fs_ne -> es_ne -> ds_ne -> seg_brace_ne -> edi_ne -> esi_ne -> ebp_ne -> esp_d_ne -> ebx_ne -> edx_ne -> ecx_ne -> eax_ne -> pusha_brace_ne -> label_low: {style.stroke: transparent}
}

# â”€â”€ RIGHT: With Error Code (e.g., #GP=13, #PF=14) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with_err: "With Error Code (e.g., #GP=13 / #PF=14 / #DF=8)" {
  style.fill: "#1a1a2e"
  style.stroke: "#8a2d2d"
  style.border-radius: 6

  label_high2: "HIGH ADDRESS (stack bottom)" {
    style.fill: "#2d2d2d"
    style.stroke: "#555"
    style.font-color: "#888"
    style.font-size: 11
  }
  eflags_we: "[ESP+64]  EFLAGS" {
    style.fill: "#6B2D8B"
    style.stroke: "#9B4DBB"
    style.font-color: white
    style.font: mono
    style.font-size: 12
  }
  cs_we: "[ESP+60]  CS    = 0x0008" {
    style.fill: "#6B2D8B"
    style.stroke: "#9B4DBB"
    style.font-color: white
    style.font: mono
    style.font-size: 12
  }
  eip_we: "[ESP+56]  EIP   = <faulting addr>" {
    style.fill: "#6B2D8B"
    style.stroke: "#9B4DBB"
    style.font-color: white
    style.font: mono
    style.font-size: 12
  }
  cpu_brace_we: "â”€â”€ CPU pushed (always 3 words) â”€â”€" {
    style.fill: "#111"
    style.stroke: "#444"
    style.font-color: "#9B4DBB"
    style.font-size: 11
    style.italic: true
  }
  err_code_we: "[ESP+52]  err_code = 0x0002  â† CPU pushed REAL error code" {
    style.fill: "#8B2D2D"
    style.stroke: "#CC4444"
    style.font-color: white
    style.font: mono
    style.font-size: 12
    style.bold: true
  }
  int_no_we: "[ESP+48]  int_no   = 13" {
    style.fill: "#6a2020"
    style.stroke: "#CC4444"
    style.font-color: "#ffaaaa"
    style.font: mono
    style.font-size: 12
  }
  stub_brace_we: "â”€â”€ ISR_ERR stub: push int_no only (1 word) â”€â”€" {
    style.fill: "#111"
    style.stroke: "#444"
    style.font-color: "#CC4444"
    style.font-size: 11
    style.italic: true
  }
  gs_we: "[ESP+44]  GS" {
    style.fill: "#1a3a5c"
    style.stroke: "#2a6aac"
    style.font-color: "#aaccff"
    style.font: mono
    style.font-size: 12
  }
  fs_we: "[ESP+40]  FS" {
    style.fill: "#1a3a5c"
    style.stroke: "#2a6aac"
    style.font-color: "#aaccff"
    style.font: mono
    style.font-size: 12
  }
  es_we: "[ESP+36]  ES" {
    style.fill: "#1a3a5c"
    style.stroke: "#2a6aac"
    style.font-color: "#aaccff"
    style.font: mono
    style.font-size: 12
  }
  ds_we: "[ESP+32]  DS" {
    style.fill: "#1a3a5c"
    style.stroke: "#2a6aac"
    style.font-color: "#aaccff"
    style.font: mono
    style.font-size: 12
  }
  seg_brace_we: "â”€â”€ isr_common_stub: push ds/es/fs/gs â”€â”€" {
    style.fill: "#111"
    style.stroke: "#444"
    style.font-color: "#2a6aac"
    style.font-size: 11
    style.italic: true
  }
  edi_we: "[ESP+28]  EDI" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
  }
  esi_we: "[ESP+24]  ESI" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
  }
  ebp_we: "[ESP+20]  EBP" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
  }
  esp_d_we: "[ESP+16]  ESP (pre-pusha)" {
    style.fill: "#3a3a1a"
    style.stroke: "#6a6a2a"
    style.font-color: "#cccc88"
    style.font: mono
    style.font-size: 12
  }
  ebx_we: "[ESP+12]  EBX" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
  }
  edx_we: "[ESP+8]   EDX" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
  }
  ecx_we: "[ESP+4]   ECX" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
  }
  eax_we: "[ESP+0]   EAX  â† ESP when interrupt_dispatch called" {
    style.fill: "#1a4a1a"
    style.stroke: "#2a8a2a"
    style.font-color: "#aaffaa"
    style.font: mono
    style.font-size: 12
    style.bold: true
  }
  pusha_brace_we: "â”€â”€ isr_common_stub: pusha (8 words) â”€â”€" {
    style.fill: "#111"
    style.stroke: "#444"
    style.font-color: "#2a8a2a"
    style.font-size: 11
    style.italic: true
  }
  label_low2: "LOW ADDRESS (stack top = ESP)" {
    style.fill: "#2d2d2d"
    style.stroke: "#555"
    style.font-color: "#888"
    style.font-size: 11
  }

  label_high2 -> eflags_we -> cs_we -> eip_we -> cpu_brace_we -> err_code_we -> int_no_we -> stub_brace_we -> gs_we -> fs_we -> es_we -> ds_we -> seg_brace_we -> edi_we -> esi_we -> ebp_we -> esp_d_we -> ebx_we -> edx_we -> ecx_we -> eax_we -> pusha_brace_we -> label_low2: {style.stroke: transparent}
}

# â”€â”€ CENTRE: interrupt_frame_t struct + cleanup annotation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
frame_struct: "interrupt_frame_t  (C struct â€” offsets from ESP)" {
  style.fill: "#0d1b2a"
  style.stroke: "#2a5a8a"
  style.border-radius: 6
  
  hdr: ||md
    **`typedef struct interrupt_frame`**  `sizeof = 76 bytes`
  || {
    style.fill: "#0d1b2a"
    style.stroke: transparent
    style.font-color: "#88ccff"
  }
  
  tbl: ||md
    | Offset | Field | Pushed by |
    |--------|-------|-----------|
    | +0  | `eax`       | `pusha` |
    | +4  | `ecx`       | `pusha` |
    | +8  | `edx`       | `pusha` |
    | +12 | `ebx`       | `pusha` |
    | +16 | `esp_dummy` | `pusha` |
    | +20 | `ebp`       | `pusha` |
    | +24 | `esi`       | `pusha` |
    | +28 | `edi`       | `pusha` |
    | +32 | `ds`        | stub    |
    | +36 | `es`        | stub    |
    | +40 | `fs`        | stub    |
    | +44 | `gs`        | stub    |
    | +48 | `int_no`    | ISR macro |
    | +52 | `err_code`  | CPU / ISR_NOERR |
    | +56 | `eip`       | CPU     |
    | +60 | `cs`        | CPU     |
    | +64 | `eflags`    | CPU     |
    | +68 | `user_esp`  | CPU (ring-3 only) |
    | +72 | `user_ss`   | CPU (ring-3 only) |
  ||

  cleanup: "isr_common_stub cleanup before iretd" {
    style.fill: "#2a1a00"
    style.stroke: "#ff8800"
    style.border-radius: 4
    style.font-color: "#ffcc88"
    
    code: ||md
      nasm
      ; After: pop gs / pop fs / pop es / pop ds / popa
      add esp, 8     ; â† REMOVE int_no + err_code from stack
                     ;   (both 4-byte words; uniform because ISR_NOERR
                     ;    pushed fake 0 to keep layout identical)
      iretd          ; pops EIP, CS, EFLAGS (+ ESP, SS on privilege change)
      
    ||
  }

  note_key: ||md
    **Key invariant:** `ISR_NOERR` stubs push `dword 0` as fake `err_code`
    so the struct layout is **identical** for all 256 vectors.
    The `add esp, 8` always removes exactly 8 bytes regardless of which
    vector fired. Without the fake push, `iretd` would pop `int_no` as
    `EIP` â†’ instant triple-fault.
  || {
    style.fill: "#1a2a1a"
    style.stroke: "#2a6a2a"
    style.font-color: "#aaffaa"
    style.font-size: 12
  }
}

# â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
legend: "Legend" {
  style.fill: "#111"
  style.stroke: "#333"
  style.border-radius: 4
  near: bottom-center
  
  lg: ||md
    ðŸŸ£ **Purple** = CPU auto-pushed (EIP, CS, EFLAGS)
    ðŸŸ¢ **Green** = Stub-pushed (int_no, err_code)  
    ðŸ”µ **Blue** = isr_common_stub segment saves
    ðŸŸ© **Dark green** = pusha GP registers
    ðŸ”´ **Red** = CPU-pushed REAL error code (ISR_ERR vectors only)
    ðŸŸ  **Orange border** = `add esp, 8` cleanup â€” critical for `iretd` alignment
  ||
}

# â”€â”€ Connections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
no_err -> frame_struct: "same layout\n(err_code = 0)" {
  style.stroke: "#4D9A4D"
  style.stroke-dash: 3
  style.font-color: "#4D9A4D"
}
with_err -> frame_struct: "same layout\n(err_code = CPU value)" {
  style.stroke: "#CC4444"
  style.stroke-dash: 3
  style.font-color: "#CC4444"
}