vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  ## 8259A Dual-PIC Cascade — Vector Remapping & EOI Protocol
| {near: top-center}
# ─── CPU ───────────────────────────────────────────────────────────────────────
cpu: CPU {
  style.fill: "#4B0082"
  style.font-color: white
  style.border-radius: 6
  style.bold: true
  intr: INTR pin {style.fill: "#6A0DAD"; style.font-color: white}
  inta: INTA bus {style.fill: "#6A0DAD"; style.font-color: white}
}
# ─── MASTER PIC ────────────────────────────────────────────────────────────────
master: "Master 8259A PIC" {
  style.fill: "#003366"
  style.font-color: white
  style.border-radius: 6
  ports: |md
    **Ports: 0x20 (CMD) / 0x21 (DATA)**
  |
  irq0: "IRQ0 — PIT Timer" {style.fill: "#0055AA"; style.font-color: white}
  irq1: "IRQ1 — PS/2 Keyboard" {style.fill: "#0055AA"; style.font-color: white}
  irq2: "IRQ2 — CASCADE ← Slave" {style.fill: "#005577"; style.font-color: white; style.italic: true}
  irq3: "IRQ3 — COM2 Serial" {style.fill: "#003388"; style.font-color: white}
  irq4: "IRQ4 — COM1 Serial" {style.fill: "#003388"; style.font-color: white}
  irq5: "IRQ5 — LPT2" {style.fill: "#003388"; style.font-color: white}
  irq6: "IRQ6 — Floppy" {style.fill: "#003388"; style.font-color: white}
  irq7: "IRQ7 — LPT1 / Spurious" {style.fill: "#003388"; style.font-color: white}
  isr_reg: "ISR Register (8-bit)" {style.fill: "#002255"; style.font-color: white}
  imr: "IMR: 0xFC after init\n(mask=1111 1100)" {style.fill: "#002255"; style.font-color: white}
}
# ─── SLAVE PIC ─────────────────────────────────────────────────────────────────
slave: "Slave 8259A PIC" {
  style.fill: "#003300"
  style.font-color: white
  style.border-radius: 6
  ports: |md
    **Ports: 0xA0 (CMD) / 0xA1 (DATA)**
  |
  irq8:  "IRQ8  — RTC" {style.fill: "#005500"; style.font-color: white}
  irq9:  "IRQ9  — ACPI" {style.fill: "#005500"; style.font-color: white}
  irq10: "IRQ10 — Available" {style.fill: "#005500"; style.font-color: white}
  irq11: "IRQ11 — Available" {style.fill: "#005500"; style.font-color: white}
  irq12: "IRQ12 — PS/2 Mouse" {style.fill: "#005500"; style.font-color: white}
  irq13: "IRQ13 — FPU/Coprocessor" {style.fill: "#005500"; style.font-color: white}
  irq14: "IRQ14 — Primary ATA" {style.fill: "#005500"; style.font-color: white}
  irq15: "IRQ15 — Secondary ATA / Spurious" {style.fill: "#005500"; style.font-color: white}
  isr_reg: "ISR Register (8-bit)" {style.fill: "#002200"; style.font-color: white}
  imr: "IMR: 0xFF after init\n(all masked)" {style.fill: "#002200"; style.font-color: white}
}
# ─── ICW SEQUENCE ──────────────────────────────────────────────────────────────
icw: "ICW Initialization Sequence (cli required before)" {
  style.fill: "#1A1A2E"
  style.font-color: white
  style.border-radius: 6
  icw1: |md
    **ICW1** — Port 0x20 & 0xA0 ← 0x11
    Cascade mode; ICW4 required
    io_wait()
  |
  icw2: |md
    **ICW2** — Port 0x21 ← 0x20 (master base=32)
              Port 0xA1 ← 0x28 (slave base=40)
    io_wait()
  |
  icw3: |md
    **ICW3** — Port 0x21 ← 0x04 (slave on IRQ2, bitmask)
               Port 0xA1 ← 0x02 (cascade identity=2, binary)
    io_wait()
  |
  icw4: |md
    **ICW4** — Port 0x21 ← 0x01 (8086 mode)
               Port 0xA1 ← 0x01 (8086 mode)
    io_wait()
  |
  mask_restore: |md
    **Mask restore** — Port 0x21 ← 0xFC (unmask IRQ0+IRQ1)
                       Port 0xA1 ← 0xFF (all slave masked)
  |
  icw1 -> icw2 -> icw3 -> icw4 -> mask_restore
}
# ─── BEFORE REMAPPING ──────────────────────────────────────────────────────────
before: "BEFORE REMAP (BROKEN — default IBM PC mapping)" {
  style.fill: "#3D0000"
  style.font-color: "#FFAAAA"
  style.border-radius: 6
  b: |md
    IRQ0 → **vec 8**  = #DF Double Fault ❌
    IRQ1 → **vec 9**  = Coprocessor Overrun ❌
    IRQ2 → **vec 10** = Invalid TSS ❌
    IRQ3 → **vec 11** = Segment Not Present ❌
    IRQ4 → **vec 12** = Stack Fault ❌
    IRQ5 → **vec 13** = #GP General Protection ❌
    IRQ6 → **vec 14** = #PF Page Fault ❌
    IRQ7 → **vec 15** = Reserved ❌
  |
}
# ─── AFTER REMAPPING ───────────────────────────────────────────────────────────
after: "AFTER REMAP (correct)" {
  style.fill: "#003320"
  style.font-color: "#AAFFCC"
  style.border-radius: 6
  master_map: |md
    **Master → vecs 32–39**
    IRQ0 → vec 32 (PIT Timer)
    IRQ1 → vec 33 (Keyboard)
    IRQ2 → vec 34 (Cascade)
    IRQ3 → vec 35
    IRQ4 → vec 36
    IRQ5 → vec 37
    IRQ6 → vec 38
    IRQ7 → vec 39 (LPT1/Spurious)
  |
  slave_map: |md
    **Slave → vecs 40–47**
    IRQ8  → vec 40 (RTC)
    IRQ9  → vec 41
    IRQ10 → vec 42
    IRQ11 → vec 43
    IRQ12 → vec 44 (PS/2 Mouse)
    IRQ13 → vec 45
    IRQ14 → vec 46 (Primary ATA)
    IRQ15 → vec 47 (Secondary/Spurious)
  |
}
# ─── EOI RULES ─────────────────────────────────────────────────────────────────
eoi: "EOI Protocol (End-of-Interrupt)" {
  style.fill: "#1A0050"
  style.font-color: white
  style.border-radius: 6
  rule_master: |md
    **IRQ0–IRQ7 (Master only):**
    outb(0x20, 0x20)  ← master EOI
  |
  rule_slave: |md
    **IRQ8–IRQ15 (Slave + Master):**
    outb(0xA0, 0x20)  ← slave EOI first
    outb(0x20, 0x20)  ← master EOI second
    (releases cascade IRQ2 on master)
  |
  rule_spurious7: |md
    **IRQ7 spurious check:**
    outb(0x20, 0x0B) → read master ISR
    If bit 7 NOT set → spurious, NO EOI
    If bit 7 set → real IRQ7, send EOI
  |
  rule_spurious15: |md
    **IRQ15 spurious check:**
    outb(0xA0, 0x0B) → read slave ISR
    If bit 15 NOT set → spurious:
      EOI to master ONLY (0x20)
    If bit 15 set → real IRQ15, both EOIs
  |
}
# ─── CONNECTIONS ───────────────────────────────────────────────────────────────
# Slave cascade to Master IRQ2
slave -> master.irq2: "Cascade line\n(slave INT output)" {
  style.stroke: "#00AAFF"
  style.stroke-width: 3
  style.bold: true
}
# Master to CPU
master -> cpu.intr: "INTR assert\n(interrupt request)" {
  style.stroke: "#FF8800"
  style.stroke-width: 3
  style.animated: true
}
# CPU INTA to Master (acknowledgment → vector number)
cpu.inta -> master: "INTA cycle\n(CPU acks, PIC returns vector)" {
  style.stroke: "#FFCC00"
  style.stroke-width: 2
  style.stroke-dash: 4
}
# ICW sequence drives PICs
icw -> master: "Initialization\nICW1-ICW4 + masks" {
  style.stroke: "#AA00FF"
  style.stroke-width: 2
}
icw -> slave: "Initialization\nICW1-ICW4 + masks" {
  style.stroke: "#AA00FF"
  style.stroke-width: 2
}
# Before/After annotation connections
before -> master: "Default mapping\n(conflict with CPU exceptions)" {
  style.stroke: "#FF4444"
  style.stroke-dash: 5
}
after -> master: "Remapped via ICW2" {
  style.stroke: "#44FF88"
  style.stroke-dash: 5
}
after -> slave: "Remapped via ICW2" {
  style.stroke: "#44FF88"
  style.stroke-dash: 5
}
# EOI connections
eoi -> master: "pic_send_eoi(irq)" {
  style.stroke: "#CCAAFF"
  style.stroke-dash: 3
}
eoi -> slave: "pic_send_eoi(irq≥8)" {
  style.stroke: "#CCAAFF"
  style.stroke-dash: 3
}