vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # ISR Stub Assembly â€” Stack State Before/After Each Instruction
  `isr_common_stub` execution trace Â· privilege-change path (SS/ESP present)
| {near: top-center}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# LEGEND
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
legend: {
  near: bottom-right
  label: "Legend"
  style.fill: "#F8F8F8"
  style.stroke: "#AAAAAA"
  style.border-radius: 6
  l_cpu: "CPU-pushed (hardware)" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"; style.border-radius: 4}
  l_stub: "ISR stub macro push" {style.fill: "#A0C4FF"; style.stroke: "#3A7BCC"; style.border-radius: 4}
  l_pusha: "pusha (8 GP regs)" {style.fill: "#90E0A0"; style.stroke: "#2A8A40"; style.border-radius: 4}
  l_seg: "Segment reg saves" {style.fill: "#FFD080"; style.stroke: "#CC8800"; style.border-radius: 4}
  l_ptr: "Frame pointer arg" {style.fill: "#FF9A9A"; style.stroke: "#CC2222"; style.border-radius: 4}
  l_changed: "â†’ RED = changed this step" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.border-radius: 4}
  l_esp: "ESP arrow shows current top" {style.fill: "#EEEEEE"; style.stroke: "#666666"; style.border-radius: 4}
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STEP 0 â€” Initial state: CPU raised interrupt (privilege change path)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s0: "Step 0 â€” CPU Hardware Pushes Interrupt Frame" {
  style.fill: "#F5F0FF"
  style.stroke: "#9B30FF"
  style.border-radius: 8
  note0: |md
    **Trigger:** IRQ or exception fires while ring-3 code runs.
    CPU reads TSS.ESP0 â†’ switches to **kernel stack**.
    Pushes 5 words automatically (privilege-change path).
  | {style.fill: "#EDE8FF"; style.stroke: "#9B30FF"}
  stack0: {
    style.fill: "#FFFFFF"
    style.stroke: "#9B30FF"
    s0_hi: "â†‘  HIGH ADDRESS  (kernel_stack_top)" {style.fill: "#EEEEEE"; style.font-color: "#888888"}
    s0_ss:     "[ESPâ‚€ âˆ’  4]  user_ss     = 0x23" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s0_uesp:   "[ESPâ‚€ âˆ’  8]  user_esp    = 0xBFFFFFFx" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s0_efl:    "[ESPâ‚€ âˆ’ 12]  EFLAGS      = 0x00000202" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s0_cs:     "[ESPâ‚€ âˆ’ 16]  CS          = 0x1B (ring-3 code)" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s0_eip:    "[ESPâ‚€ âˆ’ 20]  EIP         = <faulting instr>" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s0_esp_marker: "â† ESP after CPU pushes (5 Ã— 4 = 20 B)" {style.fill: "#FFE0E0"; style.stroke: "#CC2222"; style.font-color: "#CC0000"; style.bold: true}
    s0_lo: "â†“  LOW ADDRESS" {style.fill: "#EEEEEE"; style.font-color: "#888888"}
  }
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STEP 1 â€” ISR_NOERR stub: push fake error code, push int_no
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s1: "Step 1 â€” ISR_NOERR Stub Macro (e.g. isr_32)" {
  style.fill: "#F0F4FF"
  style.stroke: "#3A7BCC"
  style.border-radius: 8
  code1: |asm
    isr_32:
      push dword 0    ; fake err_code (uniform frame)
      push dword 32   ; int_no
      jmp  isr_common_stub
  | {style.fill: "#E8EEFF"; style.stroke: "#3A7BCC"}
  note1: |md
    **ISR_ERR** skips the fake push â€” CPU already pushed the real error code.
    Both paths now have identical stack layout entering `isr_common_stub`.
  | {style.fill: "#E8EEFF"; style.stroke: "#3A7BCC"}
  stack1: {
    style.fill: "#FFFFFF"
    style.stroke: "#3A7BCC"
    s1_ss:     "[ESPâ‚€ âˆ’  4]  user_ss     = 0x23" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s1_uesp:   "[ESPâ‚€ âˆ’  8]  user_esp" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s1_efl:    "[ESPâ‚€ âˆ’ 12]  EFLAGS" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s1_cs:     "[ESPâ‚€ âˆ’ 16]  CS          = 0x1B" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s1_eip:    "[ESPâ‚€ âˆ’ 20]  EIP" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s1_err:    "[ESPâ‚€ âˆ’ 24]  err_code    = 0  â† NEW (fake)" {style.fill: "#A0C4FF"; style.stroke: "#3A7BCC"; style.bold: true}
    s1_int:    "[ESPâ‚€ âˆ’ 28]  int_no      = 32 â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s1_esp_m:  "â† ESP (âˆ’28 from stack top)" {style.fill: "#FFE0E0"; style.stroke: "#CC2222"; style.font-color: "#CC0000"; style.bold: true}
  }
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STEP 2 â€” pusha: saves 8 GP registers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s2: "Step 2 â€” pusha  (saves EAX ECX EDX EBX ESP EBP ESI EDI)" {
  style.fill: "#F0FFF4"
  style.stroke: "#2A8A40"
  style.border-radius: 8
  code2: |asm
    isr_common_stub:
      pusha        ; pushes EAX,ECX,EDX,EBX,ESP*,EBP,ESI,EDI
                   ; (* = ESP value BEFORE pusha â€” "esp_dummy")
                   ; layout lowâ†’high: EDI,ESI,EBP,esp_dummy,EBX,EDX,ECX,EAX
  | {style.fill: "#E8FFF0"; style.stroke: "#2A8A40"}
  note2: |md
    **pusha push order** (EAX first â†’ EAX at highest address in block):
    Stack lowâ†’high after pusha: EDI Â· ESI Â· EBP Â· esp_dummy Â· EBX Â· EDX Â· ECX Â· EAX
    This matches `interrupt_frame_t` field order exactly.
  | {style.fill: "#E8FFF0"; style.stroke: "#2A8A40"}
  stack2: {
    style.fill: "#FFFFFF"
    style.stroke: "#2A8A40"
    s2_ss:    "[ESPâ‚€ âˆ’  4]  user_ss" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s2_uesp:  "[ESPâ‚€ âˆ’  8]  user_esp" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s2_efl:   "[ESPâ‚€ âˆ’ 12]  EFLAGS" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s2_cs:    "[ESPâ‚€ âˆ’ 16]  CS" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s2_eip:   "[ESPâ‚€ âˆ’ 20]  EIP" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s2_err:   "[ESPâ‚€ âˆ’ 24]  err_code = 0" {style.fill: "#A0C4FF"; style.stroke: "#3A7BCC"}
    s2_int:   "[ESPâ‚€ âˆ’ 28]  int_no   = 32" {style.fill: "#A0C4FF"; style.stroke: "#3A7BCC"}
    s2_eax:   "[ESPâ‚€ âˆ’ 32]  EAX â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s2_ecx:   "[ESPâ‚€ âˆ’ 36]  ECX â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s2_edx:   "[ESPâ‚€ âˆ’ 40]  EDX â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s2_ebx:   "[ESPâ‚€ âˆ’ 44]  EBX â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s2_espdm: "[ESPâ‚€ âˆ’ 48]  esp_dummy â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s2_ebp:   "[ESPâ‚€ âˆ’ 52]  EBP â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s2_esi:   "[ESPâ‚€ âˆ’ 56]  ESI â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s2_edi:   "[ESPâ‚€ âˆ’ 60]  EDI â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s2_espm:  "â† ESP (âˆ’60 from top)" {style.fill: "#FFE0E0"; style.stroke: "#CC2222"; style.font-color: "#CC0000"; style.bold: true}
  }
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STEP 3 â€” push segment registers (as 32-bit zero-extended values)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s3: "Step 3 â€” Push Segment Registers (push ds / es / fs / gs)" {
  style.fill: "#FFFFF0"
  style.stroke: "#CC8800"
  style.border-radius: 8
  code3: |asm
      push ds      ; save current DS (may be 0x23 if from ring-3)
      push es
      push fs
      push gs
  | {style.fill: "#FFFCE0"; style.stroke: "#CC8800"}
  stack3: {
    style.fill: "#FFFFFF"
    style.stroke: "#CC8800"
    s3_ss:   "[ESPâ‚€ âˆ’  4]  user_ss" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s3_uesp: "[ESPâ‚€ âˆ’  8]  user_esp" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s3_efl:  "[ESPâ‚€ âˆ’ 12]  EFLAGS" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s3_cs:   "[ESPâ‚€ âˆ’ 16]  CS" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s3_eip:  "[ESPâ‚€ âˆ’ 20]  EIP" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s3_err:  "[ESPâ‚€ âˆ’ 24]  err_code" {style.fill: "#A0C4FF"; style.stroke: "#3A7BCC"}
    s3_int:  "[ESPâ‚€ âˆ’ 28]  int_no" {style.fill: "#A0C4FF"; style.stroke: "#3A7BCC"}
    s3_gp:   "[ESPâ‚€ âˆ’ 32..âˆ’60]  EAXâ€¦EDI (pusha block, 8 Ã— 4 B)" {style.fill: "#90E0A0"; style.stroke: "#2A8A40"}
    s3_gs:   "[ESPâ‚€ âˆ’ 64]  GS â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s3_fs:   "[ESPâ‚€ âˆ’ 68]  FS â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s3_es:   "[ESPâ‚€ âˆ’ 72]  ES â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s3_ds:   "[ESPâ‚€ âˆ’ 76]  DS â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s3_espm: "â† ESP (âˆ’76 from top)" {style.fill: "#FFE0E0"; style.stroke: "#CC2222"; style.font-color: "#CC0000"; style.bold: true}
  }
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STEP 4 â€” CRITICAL: reload kernel data segments
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s4: "Step 4 â€” CRITICAL: Reload Kernel Data Segments" {
  style.fill: "#FFF0F0"
  style.stroke: "#CC0000"
  style.border-radius: 8
  warning4: |md
    âš ï¸  **Without this step the kernel faults immediately.**
    If DS still holds 0x23 (user-mode selector, DPL=3), the next kernel
    memory access (e.g., reading `interrupt_dispatch` function pointer)
    checks DPL: CPL=0 > DPL=3 allowed, but the **segment limit and base**
    from the user descriptor are wrong for kernel virtual addresses â†’
    **General Protection Fault (#GP, vector 13)** before any C code runs.
  | {style.fill: "#FFE8E8"; style.stroke: "#CC0000"}
  code4: |asm
      mov ax, 0x10   ; kernel data selector (GDT[2], DPL=0)
      mov ds, ax     ; â† replaces user DS with kernel DS
      mov es, ax
      mov fs, ax
      mov gs, ax
      ; SS is already 0x10 (CPU set it from TSS.SS0 on privilege change)
  | {style.fill: "#FFE8E8"; style.stroke: "#CC0000"}
  note4: |md
    **Stack unchanged** â€” no push/pop here.
    Only CPU segment-descriptor cache registers (DS, ES, FS, GS) change.
    ESP stays at ESPâ‚€ âˆ’ 76.
  | {style.fill: "#FFE8E8"; style.stroke: "#CC0000"}
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STEP 5 â€” push esp â†’ frame pointer argument for C handler
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s5: "Step 5 â€” push esp  (pass interrupt_frame_t* to C handler)" {
  style.fill: "#FFF0FF"
  style.stroke: "#8800CC"
  style.border-radius: 8
  code5: |asm
      push esp        ; argument: pointer to interrupt_frame_t on stack
      call interrupt_dispatch   ; void interrupt_dispatch(interrupt_frame_t*)
      add  esp, 4     ; cdecl cleanup
  | {style.fill: "#F8E8FF"; style.stroke: "#8800CC"}
  note5: |md
    `esp` pushed **before** the `call` â€” so the C function receives a pointer
    to the GS field (lowest address of the saved frame).
    `interrupt_frame_t*` field `gs` sits at offset 0 from this pointer.
  | {style.fill: "#F8E8FF"; style.stroke: "#8800CC"}
  stack5: {
    style.fill: "#FFFFFF"
    style.stroke: "#8800CC"
    s5_ss:   "[ESPâ‚€ âˆ’  4]  user_ss" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s5_uesp: "[ESPâ‚€ âˆ’  8]  user_esp" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s5_efl:  "[ESPâ‚€ âˆ’ 12]  EFLAGS" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s5_cs:   "[ESPâ‚€ âˆ’ 16]  CS" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s5_eip:  "[ESPâ‚€ âˆ’ 20]  EIP" {style.fill: "#D4A0FF"; style.stroke: "#9B30FF"}
    s5_err:  "[ESPâ‚€ âˆ’ 24]  err_code" {style.fill: "#A0C4FF"; style.stroke: "#3A7BCC"}
    s5_int:  "[ESPâ‚€ âˆ’ 28]  int_no" {style.fill: "#A0C4FF"; style.stroke: "#3A7BCC"}
    s5_gp:   "[ESPâ‚€ âˆ’ 32..âˆ’60]  EAXâ€¦EDI" {style.fill: "#90E0A0"; style.stroke: "#2A8A40"}
    s5_ds:   "[ESPâ‚€ âˆ’ 64..âˆ’76]  GS / FS / ES / DS" {style.fill: "#FFD080"; style.stroke: "#CC8800"}
    s5_ptr:  "[ESPâ‚€ âˆ’ 80]  frame ptr = (ESPâ‚€âˆ’76) â† NEW" {style.fill: "#FF4444"; style.stroke: "#CC0000"; style.font-color: white; style.bold: true}
    s5_espm: "â† ESP passed as arg to interrupt_dispatch()" {style.fill: "#FFE0E0"; style.stroke: "#CC2222"; style.font-color: "#CC0000"; style.bold: true}
    s5_note: "interrupt_frame_t* frame â†’ frame->gs is at this address" {style.fill: "#EEE8FF"; style.stroke: "#8800CC"; style.font-color: "#8800CC"; style.italic: true}
  }
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STEP 6 â€” interrupt_dispatch runs, returns; unwind begins
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s6: "Step 6 â€” C Handler Returns; Restore Begins" {
  style.fill: "#F5F5FF"
  style.stroke: "#555599"
  style.border-radius: 8
  code6: |asm
      ; interrupt_dispatch() returns here
      add  esp, 4     ; discard pushed frame ptr (cdecl cleanup)
      pop  gs         ; restore segment registers (reverse of push order)
      pop  fs
      pop  es
      pop  ds
      popa            ; restore EAX..EDI (reverse of pusha)
      add  esp, 8     ; discard int_no + err_code (they're "consumed")
      iretd           ; restore EIP, CS, EFLAGS [, ESP, SS] from CPU-saved block
  | {style.fill: "#EEEEEE"; style.stroke: "#555599"}
  note6: |md
    **`add esp, 8`** is essential â€” without it `iretd` pops `err_code`
    as EIP and `int_no` as CS, jumping to a garbage address.
    **`iretd`** detects CS.RPL=3 â†’ also pops ESP and SS â†’ full ring-3 restore.
  | {style.fill: "#EEEEEE"; style.stroke: "#555599"}
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STEP 7 â€” Final state: iretd completes, user process resumed
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s7: "Step 7 â€” iretd Complete: User Process Resumed at Ring 3" {
  style.fill: "#F0FFF0"
  style.stroke: "#2A8A40"
  style.border-radius: 8
  note7: |md
    CPU pops from kernel stack (now back at ESPâ‚€ âˆ’ 20):
    - **EIP** â†’ resumes at interrupted instruction
    - **CS**  â†’ 0x1B (ring-3 code, RPL=3) â†’ privilege level drops to 3
    - **EFLAGS** â†’ IF=1 re-enabled
    - **ESP** â†’ user_esp (switches back to user stack)
    - **SS**  â†’ 0x23 (user stack segment)
    Kernel stack is fully unwound to ESPâ‚€.
    All general-purpose and segment registers restored to pre-interrupt values.
    **User process continues with zero visible evidence of the interrupt.**
  | {style.fill: "#E8FFE8"; style.stroke: "#2A8A40"}
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# interrupt_frame_t STRUCT REFERENCE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
frame_ref: "interrupt_frame_t â€” Field â†” Stack Offset Mapping" {
  style.fill: "#F8F8F8"
  style.stroke: "#555555"
  style.border-radius: 8
  tbl: ||md
    | Offset | Field        | Pushed By         | Color |
    |--------|-------------|-------------------|-------|
    | +0     | `gs`        | isr_common_stub   | ðŸŸ¡ Yellow |
    | +4     | `fs`        | isr_common_stub   | ðŸŸ¡ Yellow |
    | +8     | `es`        | isr_common_stub   | ðŸŸ¡ Yellow |
    | +12    | `ds`        | isr_common_stub   | ðŸŸ¡ Yellow |
    | +16    | `edi`       | pusha             | ðŸŸ¢ Green  |
    | +20    | `esi`       | pusha             | ðŸŸ¢ Green  |
    | +24    | `ebp`       | pusha             | ðŸŸ¢ Green  |
    | +28    | `esp_dummy` | pusha             | ðŸŸ¢ Green  |
    | +32    | `ebx`       | pusha             | ðŸŸ¢ Green  |
    | +36    | `edx`       | pusha             | ðŸŸ¢ Green  |
    | +40    | `ecx`       | pusha             | ðŸŸ¢ Green  |
    | +44    | `eax`       | pusha             | ðŸŸ¢ Green  |
    | +48    | `int_no`    | ISR stub macro    | ðŸ”µ Blue   |
    | +52    | `err_code`  | CPU or stub(=0)   | ðŸ”µ Blue   |
    | +56    | `eip`       | CPU (hardware)    | ðŸŸ£ Purple |
    | +60    | `cs`        | CPU (hardware)    | ðŸŸ£ Purple |
    | +64    | `eflags`    | CPU (hardware)    | ðŸŸ£ Purple |
    | +68    | `user_esp`  | CPU (priv change) | ðŸŸ£ Purple |
    | +72    | `user_ss`   | CPU (priv change) | ðŸŸ£ Purple |
  ||
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CONNECTIONS â€” vertical flow
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s0 -> s1: "jmp isr_common_stub\n(after stub macro pushes)" {style.stroke: "#444444"; style.bold: true}
s1 -> s2: "pusha" {style.stroke: "#2A8A40"; style.bold: true}
s2 -> s3: "push ds/es/fs/gs" {style.stroke: "#CC8800"; style.bold: true}
s3 -> s4: "âš ï¸  CRITICAL\nmov ax, 0x10\nmov ds/es/fs/gs, ax" {style.stroke: "#CC0000"; style.bold: true; style.stroke-width: 3}
s4 -> s5: "push esp\ncall interrupt_dispatch" {style.stroke: "#8800CC"; style.bold: true}
s5 -> s6: "C returns\nbegin unwind" {style.stroke: "#555599"; style.bold: true}
s6 -> s7: "iretd" {style.stroke: "#2A8A40"; style.bold: true; style.stroke-width: 3}
# Frame reference connected to step 5 (where the pointer is valid)
s5 -> frame_ref: "frame* points here\n(offset 0 = GS field)" {style.stroke: "#8800CC"; style.stroke-dash: 5}