vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # x86 Two-Level Page Table Walk
  ### 32-bit Virtual Address (CR3 Enabled)
| {near: top-center}

# ── Virtual Address Decomposition (32-bit) ──────────────────────────────────
# Offset 0x0 | Size 4B
vaddr: "Virtual Address" {
  grid-columns: 3
  grid-gap: 0
  style: {
    stroke: "#7C3AED"
    stroke-width: 2
  }

  pd_idx: "PD Index\n[31:22]\n10 bits" {
    style: {
      fill: "#7C3AED"
      font-color: white
      bold: true
    }
    width: 140
  }
  pt_idx: "PT Index\n[21:12]\n10 bits" {
    style: {
      fill: "#2563EB"
      font-color: white
      bold: true
    }
    width: 140
  }
  offset: "Page Offset\n[11:0]\n12 bits" {
    style: {
      fill: "#059669"
      font-color: white
      bold: true
    }
    width: 140
  }
}

# ── Control Register ────────────────────────────────────────────────────────
cr3: "CR3 (PDBR)" {
  shape: parallelogram
  label: "CR3 Register\nBits 31:12 = PD Base\n(Phys Address)"
  style: {
    fill: "#DC2626"
    font-color: white
    bold: true
  }
}

# ── Translation Lookaside Buffer ──────────────────────────────────────────
tlb: "TLB Cache" {
  style.fill: "#D97706"
  style.font-color: white
  
  hit: "HIT" { style.fill: "#065F46" }
  miss: "MISS" { style.fill: "#7C2D12" }
}

# ── Step 1: Page Directory ──────────────────────────────────────────────────
# 1024 Entries * 4 Bytes = 4096B (1 Page)
page_directory: "Page Directory (PD)\nSize: 4096B | Align: 4KB" {
  style: {
    stroke: "#7C3AED"
    fill: "#F5F3FF"
    stroke-dash: 5
  }
  
  pde: "PDE (4 Bytes)" {
    grid-columns: 2
    grid-gap: 0
    base: "PT Base [31:12]" {
      style.fill: "#7C3AED"
      style.font-color: white
    }
    flags: "Flags [11:0]" {
      style.fill: "#A78BFA"
      style.font-color: white
    }
  }
}

# ── Step 2: Page Table ──────────────────────────────────────────────────────
# 1024 Entries * 4 Bytes = 4096B (1 Page)
page_table: "Page Table (PT)\nSize: 4096B | Align: 4KB" {
  style: {
    stroke: "#2563EB"
    fill: "#EFF6FF"
    stroke-dash: 5
  }
  
  pte: "PTE (4 Bytes)" {
    grid-columns: 2
    grid-gap: 0
    frame: "Page Base [31:12]" {
      style.fill: "#2563EB"
      style.font-color: white
    }
    flags: "Flags [11:0]" {
      style.fill: "#60A5FA"
      style.font-color: white
    }
  }
}

# ── Physical Address Assembly ──────────────────────────────────────────────
assembly: "MMU Address Generator" {
  logic: ||md
    **PhysAddr Calculation**
    Base  = (PTE.Frame << 12)
    Final = Base | VA.Offset
  ||
}

phys_addr: "Physical Address" {
  style: {
    fill: "#059669"
    font-color: white
    bold: true
    double-border: true
  }
}

# ── Legend ──────────────────────────────────────────────────────────────────
mmu_specs: {
  near: bottom-right
  label: ||md
    ### MMU Traversal Logic
    1. **VA[31:22]** selects PDE from PD.
    2. **VA[21:12]** selects PTE from PT.
    3. **VA[11:0]** is direct byte offset.
    4. **PDE Bit 0**: P (Present)
    5. **PDE Bit 1**: R/W (Read/Write)
  ||
}

# ── Sequence & Data Flow ────────────────────────────────────────────────────

# 1. TLB Lookup
vaddr -> tlb: "VPN Check" { style.stroke-dash: 3 }
tlb.hit -> phys_addr: "Fast Path" { style.stroke: "#059669"; style.stroke-width: 4 }

# 2. Walk Initiation (on Miss)
tlb.miss -> cr3: "Page Walk" { style.stroke: "#DC2626" }

# 3. PD Access
cr3 -> page_directory: "0: Pointer to PD Base" { 
  source-arrowhead: dot
  style.stroke: "#F59E0B" 
}
vaddr.pd_idx -> page_directory.pde: "1: VA[31:22] * 4" { 
  style.stroke: "#7C3AED" 
}

# 4. PT Access
page_directory.pde.base -> page_table: "2: Pointer to PT Base" { 
  source-arrowhead: dot
  style.stroke: "#F59E0B" 
}
vaddr.pt_idx -> page_table.pte: "3: VA[21:12] * 4" { 
  style.stroke: "#2563EB" 
}

# 5. Final Assembly
page_table.pte.frame -> assembly: "4: Phys Frame Base" { 
  style.stroke: "#2563EB" 
}
vaddr.offset -> assembly: "5: Offset" { 
  style.stroke: "#059669" 
}

assembly -> phys_addr: "6: Result" { 
  style.stroke: "#059669"
  style.stroke-width: 3
}

# 6. Update Cache
phys_addr -> tlb: "Fill TLB" { 
  style.stroke: "#D97706"
  style.stroke-dash: 5
}