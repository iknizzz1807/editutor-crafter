vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  ## PDE and PTE Bit-Field Layout — x86 32-bit Paging
  All flag bits identical in bits 11:0; bits 31:12 differ in purpose
| {near: top-center}

# ── PDE ROW ──────────────────────────────────────────────────────────────────
pde_container: "Page Directory Entry (PDE) — 32 bits" {
  style.fill: "#2D1B5E"
  style.stroke: "#7C3AED"
  style.font-color: white
  style.bold: true
  style.border-radius: 6

  pde_grid: {
    style.fill: transparent
    style.stroke: transparent
    grid-rows: 1
    grid-gap: 2
    horizontal-gap: 2

    pde_f31_12: "bits 31:12\nPT Physical Addr\n20 bits\n(addr >> 12)" {
      width: 280
      style.fill: "#F97316"
      style.stroke: "#EA580C"
      style.font-color: white
      style.bold: true
      style.border-radius: 4
    }
    pde_f11_9: "11:9\nAVAIL\n3b" {
      width: 64
      style.fill: "#6B7280"
      style.stroke: "#4B5563"
      style.font-color: white
      style.border-radius: 4
    }
    pde_f8: "8\nG\n1b" {
      width: 40
      style.fill: "#6B7280"
      style.stroke: "#4B5563"
      style.font-color: white
      style.border-radius: 4
    }
    pde_f7: "7\nPS\n4MB?" {
      width: 52
      style.fill: "#F59E0B"
      style.stroke: "#D97706"
      style.font-color: white
      style.bold: true
      style.border-radius: 4
    }
    pde_f6: "6\nRSV\n0" {
      width: 44
      style.fill: "#374151"
      style.stroke: "#1F2937"
      style.font-color: "#9CA3AF"
      style.border-radius: 4
    }
    pde_f5: "5\nA\nacc" {
      width: 40
      style.fill: "#6B7280"
      style.stroke: "#4B5563"
      style.font-color: white
      style.border-radius: 4
    }
    pde_f4: "4\nPCD\n\$" {
      width: 44
      style.fill: "#DC2626"
      style.stroke: "#B91C1C"
      style.font-color: white
      style.bold: true
      style.border-radius: 4
    }
    pde_f3: "3\nPWT\nWT" {
      width: 44
      style.fill: "#EF4444"
      style.stroke: "#DC2626"
      style.font-color: white
      style.border-radius: 4
    }
    pde_f2: "2\nU/S\nring" {
      width: 48
      style.fill: "#7C3AED"
      style.stroke: "#6D28D9"
      style.font-color: white
      style.bold: true
      style.border-radius: 4
    }
    pde_f1: "1\nR/W\nwrt" {
      width: 44
      style.fill: "#2563EB"
      style.stroke: "#1D4ED8"
      style.font-color: white
      style.bold: true
      style.border-radius: 4
    }
    pde_f0: "0\nP\npres" {
      width: 44
      style.fill: "#16A34A"
      style.stroke: "#15803D"
      style.font-color: white
      style.bold: true
      style.border-radius: 4
    }
  }
}

# ── PTE ROW ──────────────────────────────────────────────────────────────────
pte_container: "Page Table Entry (PTE) — 32 bits" {
  style.fill: "#1A3A5C"
  style.stroke: "#2563EB"
  style.font-color: white
  style.bold: true
  style.border-radius: 6

  pte_grid: {
    style.fill: transparent
    style.stroke: transparent
    grid-rows: 1
    grid-gap: 2
    horizontal-gap: 2

    pte_f31_12: "bits 31:12\nFrame Physical Addr\n20 bits\n(phys >> 12)" {
      width: 280
      style.fill: "#3B82F6"
      style.stroke: "#2563EB"
      style.font-color: white
      style.bold: true
      style.border-radius: 4
    }
    pte_f11_9: "11:9\nAVAIL\n3b" {
      width: 64
      style.fill: "#6B7280"
      style.stroke: "#4B5563"
      style.font-color: white
      style.border-radius: 4
    }
    pte_f8: "8\nG\n1b" {
      width: 40
      style.fill: "#6B7280"
      style.stroke: "#4B5563"
      style.font-color: white
      style.border-radius: 4
    }
    pte_f7: "7\nRSV\n0" {
      width: 44
      style.fill: "#374151"
      style.stroke: "#1F2937"
      style.font-color: "#9CA3AF"
      style.border-radius: 4
    }
    pte_f6: "6\nD\ndirty" {
      width: 52
      style.fill: "#B45309"
      style.stroke: "#92400E"
      style.font-color: white
      style.bold: true
      style.border-radius: 4
    }
    pte_f5: "5\nA\nacc" {
      width: 40
      style.fill: "#6B7280"
      style.stroke: "#4B5563"
      style.font-color: white
      style.border-radius: 4
    }
    pte_f4: "4\nPCD\n\$" {
      width: 44
      style.fill: "#DC2626"
      style.stroke: "#B91C1C"
      style.font-color: white
      style.bold: true
      style.border-radius: 4
    }
    pte_f3: "3\nPWT\nWT" {
      width: 44
      style.fill: "#EF4444"
      style.stroke: "#DC2626"
      style.font-color: white
      style.border-radius: 4
    }
    pte_f2: "2\nU/S\nring" {
      width: 48
      style.fill: "#7C3AED"
      style.stroke: "#6D28D9"
      style.font-color: white
      style.bold: true
      style.border-radius: 4
    }
    pte_f1: "1\nR/W\nwrt" {
      width: 44
      style.fill: "#2563EB"
      style.stroke: "#1D4ED8"
      style.font-color: white
      style.bold: true
      style.border-radius: 4
    }
    pte_f0: "0\nP\npres" {
      width: 44
      style.fill: "#16A34A"
      style.stroke: "#15803D"
      style.font-color: white
      style.bold: true
      style.border-radius: 4
    }
  }
}

# ── CONCRETE EXAMPLES ────────────────────────────────────────────────────────
examples: "Concrete PTE Values" {
  style.fill: "#111827"
  style.stroke: "#374151"
  style.font-color: white
  style.border-radius: 6
  grid-rows: 1
  grid-gap: 24
  horizontal-gap: 24

  ex_kernel: "Kernel Identity-Map PTE\n─────────────────────\nValue: frame | 0x003\nbits: P=1  R/W=1  U/S=0\n      PWT=0  PCD=0  A=0\n      D=0   G=0\n\nSupvisor-only, writable\nNo user-mode access\nWrite-back cache" {
    style.fill: "#1E3A5F"
    style.stroke: "#2563EB"
    style.font-color: "#93C5FD"
    style.border-radius: 6
    width: 240
  }
  ex_user: "User Page PTE\n─────────────────────\nValue: frame | 0x007\nbits: P=1  R/W=1  U/S=1\n      PWT=0  PCD=0  A=0\n      D=0   G=0\n\nRing-3 accessible\nWritable\nWrite-back cache" {
    style.fill: "#2D1B5E"
    style.stroke: "#7C3AED"
    style.font-color: "#C4B5FD"
    style.border-radius: 6
    width: 240
  }
  ex_mmio: "MMIO Page PTE (VGA)\n─────────────────────\nValue: 0xB8000 | 0x01B\nbits: P=1  R/W=1  U/S=0\n      PWT=1  PCD=1  A=0\n      D=0   G=0\n\nSupervisor-only\nWrite-through enabled\nCache disabled (PCD=1)" {
    style.fill: "#3B1818"
    style.stroke: "#DC2626"
    style.font-color: "#FCA5A5"
    style.border-radius: 6
    width: 240
  }
}

# ── LEGEND ───────────────────────────────────────────────────────────────────
legend: |md
  **Bit Abbreviations** — P=Present · R/W=Writable · U/S=User(1)/Supervisor(0) · PWT=Write-Through
  PCD=Cache-Disable · A=Accessed(CPU sets) · D=Dirty(CPU sets, PTE only) · G=Global(no TLB flush)
  PS=Page-Size(PDE: 0=4KB, 1=4MB) · AVAIL=OS-defined bits 11:9
  **Selector Rule:** P=0 → entry invalid; MMU raises #PF. P=1 → bits 31:12 valid frame/PT address.
| {
  near: bottom-center
  style.fill: "#1F2937"
  style.stroke: "#374151"
  style.font-color: "#D1D5DB"
  style.border-radius: 6
}

pde_container -> pte_container: "bits 11:0 identical layout\nonly bits 31:12 differ\n(PT addr vs Frame addr)" {
  style.stroke: "#6B7280"
  style.stroke-dash: 5
  style.font-color: "#9CA3AF"
}

pte_container -> examples: "concrete encodings" {
  style.stroke: "#374151"
  style.stroke-dash: 3
  style.font-color: "#6B7280"
}