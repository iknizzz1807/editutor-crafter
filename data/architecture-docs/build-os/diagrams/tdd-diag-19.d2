vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  ## Virtual Address Space Layout — Identity + Higher-Half Mapping
  32-bit x86 · 4 GB addressable
| {near: top-center}
# ── Address space column ──────────────────────────────────────────────────────
space: "32-bit Virtual Address Space" {
  style.fill: "#1a1a2e"
  style.stroke: "#444"
  style.border-radius: 4
  r_identity: "0x00000000 – 0x003FFFFF\n[4 MB  |  Identity Map]\nVGA 0xB8000 · BIOS · stack\nPresent=1 before jump\nRemoved after jump → NULL protection" {
    style.fill: "#2d4a22"
    style.stroke: "#55aa33"
    style.font-color: "#aaee88"
    style.font-size: 13
    style.border-radius: 3
    height: 110
  }
  r_user: "0x00400000 – 0xBFFFFFFF\n[~3 GB  |  Future User Space]\n(per-process page directories — M4)" {
    style.fill: "#1a2a3a"
    style.stroke: "#336699"
    style.font-color: "#7799bb"
    style.font-size: 13
    style.border-radius: 3
    height: 90
  }
  r_kernel: "0xC0000000 – 0xC03FFFFF\n[4 MB  |  Higher-Half Kernel]\nKernel code (.text) · .rodata · .data · .bss\nVGA mapped at 0xC00B8000\nLinked VMA = 0xC0100000 · LMA = 0x00100000" {
    style.fill: "#3a1a5a"
    style.stroke: "#9955cc"
    style.font-color: "#cc88ff"
    style.font-size: 13
    style.border-radius: 3
    height: 110
  }
  r_heap: "0xC0400000 – 0xCFFFFFFF\n[252 MB  |  Kernel Heap Arena]\nkmalloc / kfree · backed by PMM on demand\nHEAP_START=0xC0400000 · HEAP_END=0xCFFF0000" {
    style.fill: "#2a3a1a"
    style.stroke: "#558833"
    style.font-color: "#88bb55"
    style.font-size: 13
    style.border-radius: 3
    height: 100
  }
  r_reserved: "0xD0000000 – 0xFFBFFFFF\n[~768 MB  |  Reserved]" {
    style.fill: "#252525"
    style.stroke: "#555"
    style.font-color: "#666"
    style.font-size: 13
    style.border-radius: 3
    height: 70
  }
  r_recursive: "0xFFC00000 – 0xFFFFFFFF\n[4 MB  |  Recursive PD Mapping (optional)]\nboot_pd[1023] → self · enables virtual PT access" {
    style.fill: "#2a2a3a"
    style.stroke: "#555577"
    style.font-color: "#8888aa"
    style.font-size: 13
    style.border-radius: 3
    height: 80
  }
}
# ── Physical memory column ─────────────────────────────────────────────────────
phys: "Physical Address Space (relevant range)" {
  style.fill: "#1a1a1a"
  style.stroke: "#444"
  style.border-radius: 4
  p_low: "0x00000000 – 0x003FFFFF\n[4 MB Physical]\nFrame 0: IVT/BDA (reserved)\n0xB8000: VGA framebuffer (MMIO)\n0x100000: Kernel binary load address\nCovered by pt_low[0..1023] and pt_high[0..1023]" {
    style.fill: "#3a2a00"
    style.stroke: "#aa7700"
    style.font-color: "#ffcc44"
    style.font-size: 13
    style.border-radius: 3
    height: 120
  }
  p_heap_frames: "0x00400000 – …\n[Heap frames, allocated on demand]\npmm_alloc_frame() → bitmap scan\nReturned to paging_map() for heap VAs" {
    style.fill: "#1a2a1a"
    style.stroke: "#336633"
    style.font-color: "#669966"
    style.font-size: 13
    style.border-radius: 3
    height: 90
  }
}
# ── Page structures box ────────────────────────────────────────────────────────
pgstructs: "Boot Page Tables (static, in .bss)" {
  style.fill: "#2a1a2a"
  style.stroke: "#774477"
  style.border-radius: 4
  boot_pd: "boot_pd[1024]\n4 KB · 4 KB-aligned\nPD[0]   = pt_low_phys | P|W  (identity)\nPD[768] = pt_high_phys | P|W  (kernel)\nAll others = 0 (not present)" {
    style.fill: "#3a1a3a"
    style.stroke: "#aa44aa"
    style.font-color: "#dd88dd"
    style.font-size: 12
    style.border-radius: 3
  }
  pt_low: "pt_low[1024]\n4 KB · Maps 4 MB identity\nPTE[i] = (i*4096) | P|W\nPTE[0xB8] adds CACHE_DIS\nRemoved: boot_pd[0]=0 + INVLPG" {
    style.fill: "#2a1a1a"
    style.stroke: "#884444"
    style.font-color: "#cc8888"
    style.font-size: 12
    style.border-radius: 3
  }
  pt_high: "pt_high[1024]\n4 KB · Maps 4 MB kernel\nPTE[i] = (i*4096) | P|W\nPTE[0xB8] adds CACHE_DIS\nVGA: VA 0xC00B8000 → PA 0xB8000" {
    style.fill: "#1a2a1a"
    style.stroke: "#447744"
    style.font-color: "#88cc88"
    style.font-size: 12
    style.border-radius: 3
  }
}
# ── Jump moment annotation ─────────────────────────────────────────────────────
jump_moment: "Paging Enable Sequence" {
  style.fill: "#2a2010"
  style.stroke: "#aa6600"
  style.border-radius: 4
  style.font-color: "#ffaa44"
  step1: "① CR3 ← VIRT_TO_PHYS(boot_pd)" {
    style.fill: "#2a2010"
    style.stroke: "#775500"
    style.font-color: "#ffbb55"
    style.font-size: 12
  }
  step2: "② CR0 |= 0x80000001  (PG + PE)" {
    style.fill: "#2a2010"
    style.stroke: "#775500"
    style.font-color: "#ffbb55"
    style.font-size: 12
  }
  step3: "③ jmp paging_high_entry  (→ 0xC01xxxxx)" {
    style.fill: "#2a2010"
    style.stroke: "#775500"
    style.font-color: "#ffbb55"
    style.font-size: 12
  }
  step4: "④ boot_pd[0] = 0 ; tlb_flush_all()" {
    style.fill: "#2a2010"
    style.stroke: "#775500"
    style.font-color: "#ffbb55"
    style.font-size: 12
  }
  step1 -> step2 -> step3 -> step4
}
# ── Removed identity map warning ──────────────────────────────────────────────
null_warn: "⛔ After identity map removal:\n0x00000000 is UNMAPPED\nNULL deref → #PF (CR2=0, P=0)\nThis is intentional — catches kernel NULL bugs" {
  style.fill: "#3a0000"
  style.stroke: "#cc0000"
  style.font-color: "#ff5555"
  style.font-size: 13
  style.border-radius: 3
}
# ── Connections: VA → Physical mappings ───────────────────────────────────────
space.r_identity -> phys.p_low: "Identity map\nVA = PA (before jump)\npt_low: 1024 PTEs\nGranularity: 4 KB/page" {
  style.stroke: "#888833"
  style.stroke-dash: 4
  style.font-color: "#aaaa55"
  style.font-size: 11
}
space.r_kernel -> phys.p_low: "Higher-half map\nVA = PA + 0xC0000000\npt_high: 1024 PTEs\nVIRT_TO_PHYS(va) = va − 0xC0000000" {
  style.stroke: "#9955cc"
  style.font-color: "#cc88ff"
  style.font-size: 11
}
space.r_heap -> phys.p_heap_frames: "Demand-mapped\npaging_map() per kmalloc page\nPTE flags: P|W (kernel only)" {
  style.stroke: "#558833"
  style.stroke-dash: 3
  style.font-color: "#88bb55"
  style.font-size: 11
}
# ── Page structure connections ─────────────────────────────────────────────────
pgstructs.boot_pd -> pgstructs.pt_low: "PD[0] → pt_low\n(cleared after jump)" {
  style.stroke: "#884444"
  style.font-color: "#cc8888"
  style.font-size: 11
}
pgstructs.boot_pd -> pgstructs.pt_high: "PD[768] → pt_high\n(permanent)" {
  style.stroke: "#447744"
  style.font-color: "#88cc88"
  style.font-size: 11
}
pgstructs.pt_low -> phys.p_low: "Entries: PA 0x000–0x3FF\n× 4096" {
  style.stroke: "#775500"
  style.stroke-dash: 3
  style.font-color: "#aa8833"
  style.font-size: 11
}
pgstructs.pt_high -> phys.p_low: "Same frames\ndifferent VA base" {
  style.stroke: "#447744"
  style.stroke-dash: 3
  style.font-color: "#66aa66"
  style.font-size: 11
}
# ── Jump sequence connections ──────────────────────────────────────────────────
jump_moment -> pgstructs.boot_pd: "CR3 = VIRT_TO_PHYS(boot_pd)\nbefore step ①" {
  style.stroke: "#aa6600"
  style.stroke-dash: 5
  style.font-color: "#cc9944"
  style.font-size: 11
}
jump_moment -> space.r_identity: "Removed in step ④\n→ NULL trap active" {
  style.stroke: "#cc0000"
  style.stroke-dash: 4
  style.font-color: "#ff4444"
  style.font-size: 11
}
jump_moment -> null_warn: "Consequence of step ④" {
  style.stroke: "#cc0000"
  style.font-color: "#ff4444"
  style.font-size: 11
}
# ── Size annotation legend ────────────────────────────────────────────────────
legend: |md
  **Address Split:**  
  `bits 31:22` → PD index (0–1023)  
  `bits 21:12` → PT index (0–1023)  
  `bits 11:0`  → Page offset (0–4095)
  **Key Constants:**  
  `KERNEL_VIRT_BASE = 0xC0000000`  
  `KERNEL_PHYS_BASE = 0x00100000`  
  `HEAP_START       = 0xC0400000`  
  `PAGE_SIZE        = 4096 (4 KB)`  
  `PD[768]          = 0xC0000000 >> 22`
| {near: bottom-right}