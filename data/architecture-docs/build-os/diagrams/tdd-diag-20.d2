direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Paging Enable Moment — Instruction-Level Transition
  *CR3 load → CR0.PG=1 → identity-map execution → higher-half jump → identity-map removal*
| {near: top-center}

# ─── State containers ──────────────────────────────────────────────────────────

s1: State 1 {
  style.fill: "#1E1E2E"
  style.stroke: "#6C91C2"
  style.border-radius: 8
  label: "**STATE 1: Paging OFF**"
  
  desc: |md
    **Initial Execution**
    `CR0.PG = 0`
    `EIP = 0x00100000`
    Physical addr == Virtual addr
    Address space: **Flat Physical**
  |
  desc.style.fill: "#2A2A3E"
  desc.style.stroke: "#6C91C2"
  desc.style.font-color: "#A8D8EA"

  regs: ||md
    | Reg | Value |
    |-----|-------|
    | CR0 | `0x00000001` (PE=1, PG=**0**) |
    | CR3 | `0x00000000` (unused) |
    | EIP | `0x00100000` |
    | CS  | `0x0008` |
  ||
  regs.style.fill: "#1A1A2E"
  regs.style.stroke: "#444466"
  regs.style.font-color: "#CCCCFF"
}

s2: State 2 {
  style.fill: "#1E1E2E"
  style.stroke: "#6C91C2"
  style.border-radius: 8
  label: "**STATE 2: Prep**"

  inst: "`mov cr3, boot_pd_phys`"
  inst.style.fill: "#2D2B55"
  inst.style.stroke: "#8888FF"
  inst.style.font-color: "#DDDDFF"

  desc: |md
    **CR3 loaded, paging still OFF**
    `CR0.PG = 0` — CR3 write is safe.
    MMU ignores CR3 contents until PG=1.
    No TLB flush triggered yet.
  |
  desc.style.fill: "#2A2A3E"
  desc.style.stroke: "#6C91C2"
  desc.style.font-color: "#A8D8EA"

  regs: ||md
    | Reg | Value |
    |-----|-------|
    | CR0 | `0x00000001` (PE=1, PG=**0**) |
    | CR3 | **`boot_pd_phys`** |
    | EIP | `0x001000xx` |
    | CS  | `0x0008` |
  ||
  regs.style.fill: "#1A1A2E"
  regs.style.stroke: "#444466"
  regs.style.font-color: "#CCCCFF"
}

s3: State 3 {
  style.fill: "#220000"
  style.stroke: "#FF4444"
  style.stroke-width: 4
  style.border-radius: 8
  label: "**STATE 3: PAGING ACTIVE**"

  inst: ||md
    `or eax, 0x80000001`
    `mov cr0, eax`
  ||
  inst.style.fill: "#3A0000"
  inst.style.stroke: "#FF4444"
  inst.style.font-color: "#FFAAAA"

  desc: |md
    **CR0.PG = 1 — MMU Engaged**
    Next fetch uses virtual translation.
    `EIP 0x001xxxxx` → `PDE[0]` lookup.
    Result: `phys 0x001xxxxx`.
    **Identity map prevents immediate crash.**
  |
  desc.style.fill: "#300000"
  desc.style.stroke: "#FF4444"
  desc.style.font-color: "#FFCCCC"

  regs: ||md
    | Reg | Value |
    |-----|-------|
    | CR0 | **`0x80000001`** (PG=**1**) |
    | CR3 | `boot_pd_phys` |
    | EIP | `0x001000xx` (Identity) |
  ||
  regs.style.fill: "#1A0000"
  regs.style.stroke: "#AA2222"
  regs.style.font-color: "#FFCCCC"
}

s4: State 4 {
  style.fill: "#001A00"
  style.stroke: "#44BB44"
  style.border-radius: 8
  label: "**STATE 4: Address Load**"

  inst: "`lea eax, [kernel_main_high]`"
  inst.style.fill: "#002200"
  inst.style.stroke: "#44BB44"
  inst.style.font-color: "#AAFFAA"

  desc: |md
    **Prepare Higher-Half Jump**
    `EAX` loaded with linker addr `0xC01xxxxx`.
    Execution still in low identity range.
    PDE[768] is ready to map `0xC0000000`.
  |
  desc.style.fill: "#001500"
  desc.style.stroke: "#44BB44"
  desc.style.font-color: "#88FF88"

  regs: ||md
    | Reg | Value |
    |-----|-------|
    | CR0 | `0x80000001` (PG=1) |
    | EIP | `0x001000xx` |
    | EAX | **`0xC01xxxxx`** |
  ||
  regs.style.fill: "#001000"
  regs.style.stroke: "#224422"
  regs.style.font-color: "#AAFFAA"
}

s5: State 5 {
  style.fill: "#001A00"
  style.stroke: "#88FF44"
  style.stroke-width: 3
  style.border-radius: 8
  label: "**STATE 5: Higher-Half Jump**"

  inst: "`jmp eax`"
  inst.style.fill: "#003300"
  inst.style.stroke: "#88FF44"
  inst.style.font-color: "#CCFFAA"

  desc: |md
    **EIP Transferred to High Memory**
    MMU walk: `PDE[768]` → `phys 0x001xxxxx`.
    Jump flushes instruction pipeline.
    Code executes from same physical bits
    via new virtual alias.
  |
  desc.style.fill: "#001500"
  desc.style.stroke: "#88FF44"
  desc.style.font-color: "#CCFFAA"

  regs: ||md
    | Reg | Value |
    |-----|-------|
    | CR0 | `0x80000001` (PG=1) |
    | EIP | **`0xC01xxxxx`** |
  ||
  regs.style.fill: "#001000"
  regs.style.stroke: "#224422"
  regs.style.font-color: "#AAFFAA"
}

s6: State 6 {
  style.fill: "#1A1A00"
  style.stroke: "#CCBB22"
  style.stroke-width: 3
  style.border-radius: 8
  label: "**STATE 6: Cleanup**"

  inst: ||md
    `mov [boot_pd+0], 0`
    `mov cr3, ecx ; TLB Flush`
  ||
  inst.style.fill: "#2A2A00"
  inst.style.stroke: "#CCBB22"
  inst.style.font-color: "#FFFFAA"

  desc: |md
    **Identity Map Removal**
    `PDE[0]` marked Not Present.
    CR3 reload flushes TLB stale entries.
    Low addresses now trigger **#PF**.
    Only Higher-Half remains mapped.
  |
  desc.style.fill: "#201A00"
  desc.style.stroke: "#CCBB22"
  desc.style.font-color: "#FFFFAA"

  regs: ||md
    | Reg | Value |
    |-----|-------|
    | CR0 | `0x80000001` (PG=1) |
    | CR3 | `boot_pd_phys` |
    | EIP | `0xC01xxxxx` |
    | PDE[0] | **`0x00000000`** |
  ||
  regs.style.fill: "#100D00"
  regs.style.stroke: "#665500"
  regs.style.font-color: "#FFFFAA"
}

# ─── Memory Context Maps ──────────────────────────────────────────────────────

map_s1: Memory Map (S1-S2) {
  style.stroke-dash: 3
  phys: "Physical Address Space (0-4GB)" {
    style.fill: "#1A3A1A"
    label: "Identity Mapped / Flat"
  }
}

map_s3: Memory Map (S3-S5) {
  style.stroke-dash: 3
  low: "0x00000000 (Identity)" {
    style.fill: "#1A3A1A"
    style.stroke: "#44AA44"
  }
  gap: "Gap (Unmapped)" {
    style.fill: "#222222"
    style.stroke: "#444444"
  }
  high: "0xC0000000 (Kernel)" {
    style.fill: "#1A1A3A"
    style.stroke: "#4444AA"
  }
}

map_s6: Memory Map (S6 Final) {
  style.stroke-dash: 3
  null: "0x00000000 (Fault Zone)" {
    style.fill: "#3A0000"
    style.stroke: "#FF0000"
  }
  high: "0xC0000000 (Kernel)" {
    style.fill: "#1A1A3A"
    style.stroke: "#4444AA"
  }
}

# ─── Tables & Notes ───────────────────────────────────────────────────────────

pde_note: ||md
  ### boot_pd layout (Architectural Invariant)
  | Index | Virt Base | Flags | Purpose |
  |-------|-----------|-------|---------|
  | **0** | `0x000000` | `P|W` | Identity (Transient) |
  | **768** | `0xC00000` | `P|W` | Kernel (Persistent) |
|| {
  style.fill: "#1A1A2E"
  style.stroke: "#4444AA"
  style.font-color: "#AAAAFF"
  style.border-radius: 8
  near: bottom-center
}

# ─── Connections ──────────────────────────────────────────────────────────────

s1 -> s2: "Load CR3"
s2 -> s3: "Set CR0.PG" {
  style.stroke: "#FF4444"
  style.stroke-width: 4
}
s3 -> s4: "Identity Execution"
s4 -> s5: "Jump to EAX" {
  style.stroke: "#88FF44"
  style.stroke-width: 3
}
s5 -> s6: "Unmap PDE[0]"

s1 -.-> map_s1
s3 -.-> map_s3
s6 -.-> map_s6