vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  ## Paging Enablement: Identity-Map Bootstrap Problem
  ### The CPU must fetch the *next* instruction through page tables immediately after CR0.PG=1
| {
  near: top-center
  style.font-size: 14
}

# ─── BEFORE PAGING ───────────────────────────────────────────────

before: "BEFORE: CR0.PG = 0 (Paging Off)" {
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a8a"
  style.font-color: "#e0e0ff"
  style.border-radius: 8

  cpu_b: "x86 CPU" {
    style.fill: "#2d2d5a"
    style.stroke: "#6060c0"
    style.font-color: "#c0c0ff"
    style.border-radius: 4

    eip_b: "EIP = 0x100050\n(physical = virtual)" {
      style.fill: "#3a3a7a"
      style.stroke: "#8080d0"
      style.font-color: "#d0d0ff"
    }
    cr0_b: "CR0.PG = 0" {
      style.fill: "#3a3a7a"
      style.stroke: "#8080d0"
      style.font-color: "#d0d0ff"
    }
    cr3_b: "CR3 = 0x101000\n(page dir ready)" {
      style.fill: "#3a5a3a"
      style.stroke: "#60c060"
      style.font-color: "#c0ffc0"
    }
  }

  phys_b: "Physical Memory" {
    style.fill: "#1a2a1a"
    style.stroke: "#2a5a2a"
    style.font-color: "#80c080"

    kernel_b: "0x100000–0x1FFFFF\nKernel Code + Data" {
      style.fill: "#1e3a1e"
      style.stroke: "#3a7a3a"
      style.font-color: "#90d090"
    }
    pd_b: "0x101000\nPage Directory\n(built, not active)" {
      style.fill: "#1e3a1e"
      style.stroke: "#3a7a3a"
      style.font-color: "#90d090"
    }
    identity_b: "0x102000\nidentity_page_table\n[256]=0x100003 P|W\n[184]=0x0B8003 P|W" {
      style.fill: "#1e3a1e"
      style.stroke: "#3a7a3a"
      style.font-color: "#90d090"
    }
    higher_b: "0x103000\nkernel_page_table\n[0..1023]: 0x0–0x3FF003" {
      style.fill: "#1e3a1e"
      style.stroke: "#3a7a3a"
      style.font-color: "#90d090"
    }
  }

  note_b: |md
    **No translation** — physical = virtual
    All addresses directly decoded
    Any write to any address succeeds
    No protection enforced
  | {
    style.fill: "#252550"
    style.stroke: "#5050a0"
    style.font-color: "#c0c0ff"
  }

  cpu_b.eip_b -> phys_b.kernel_b: "Direct physical fetch\n(no MMU)" {
    style.stroke: "#6080ff"
    style.stroke-dash: 0
  }
}

# ─── THE CRITICAL MOMENT ─────────────────────────────────────────

moment: "THE CRITICAL INSTANT: mov cr0, eax (sets PG=1)" {
  style.fill: "#2a1a00"
  style.stroke: "#ff8000"
  style.font-color: "#ffcc00"
  style.border-radius: 8
  style.bold: true

  inst1: "mov eax, cr0\nor  eax, 0x80010000  ; PG + WP\nmov cr0, eax" {
    style.fill: "#3a2800"
    style.stroke: "#cc6600"
    style.font-color: "#ffaa00"
    style.font: mono
  }
  consequence: "After this single write:\n● MMU activates IMMEDIATELY\n● Next fetch goes through CR3 → page tables\n● Pipeline serialized — prefetch discarded\n● EIP still = 0x100054 (next instruction)" {
    style.fill: "#3a2800"
    style.stroke: "#cc6600"
    style.font-color: "#ffaa00"
  }

  inst1 -> consequence: "serializing\ninstruction" {
    style.stroke: "#ff8000"
    style.animated: true
  }
}

# ─── AFTER PAGING ────────────────────────────────────────────────

after: "AFTER: CR0.PG = 1 (Paging Active)" {
  style.fill: "#001a2a"
  style.stroke: "#008080"
  style.font-color: "#00e0e0"
  style.border-radius: 8

  cpu_a: "x86 CPU (MMU active)" {
    style.fill: "#002040"
    style.stroke: "#0080c0"
    style.font-color: "#80d0ff"
    style.border-radius: 4

    eip_a: "EIP = 0x100054\n(virtual address)" {
      style.fill: "#003050"
      style.stroke: "#0090d0"
      style.font-color: "#90d0ff"
    }
    cr0_a: "CR0.PG = 1\nCR0.WP = 1" {
      style.fill: "#003050"
      style.stroke: "#0090d0"
      style.font-color: "#90d0ff"
    }
    cr3_a: "CR3 = 0x101000\n(physical addr of PD)" {
      style.fill: "#003050"
      style.stroke: "#0090d0"
      style.font-color: "#90d0ff"
    }
    tlb_a: "TLB\n(flushed on PG set)" {
      style.fill: "#002040"
      style.stroke: "#004080"
      style.font-color: "#6090c0"
      style.italic: true
    }
  }

  walk: "Two-Level Page Table Walk\nfor VA 0x100054" {
    style.fill: "#002030"
    style.stroke: "#006090"
    style.font-color: "#00c0c0"
    style.border-radius: 4

    step1_a: "1. VA[31:22] = 0\n   PD[0] = 0x102003 (identity PT)\n   Present ✓" {
      style.fill: "#003040"
      style.stroke: "#007090"
      style.font-color: "#00b0b0"
    }
    step2_a: "2. VA[21:12] = 0x100\n   PT[256] = 0x100003\n   Frame = 0x100000" {
      style.fill: "#003040"
      style.stroke: "#007090"
      style.font-color: "#00b0b0"
    }
    step3_a: "3. PA = 0x100000 + 0x054\n         = 0x100054 ✓\n   (identity: VA == PA)" {
      style.fill: "#003040"
      style.stroke: "#007090"
      style.font-color: "#00b0b0"
      style.bold: true
    }

    step1_a -> step2_a -> step3_a
  }

  success_a: "✓ BOOT SUCCEEDS\nCode at 0x100054 fetched\nvia identity mapping" {
    style.fill: "#003020"
    style.stroke: "#008040"
    style.font-color: "#00e080"
    style.bold: true
  }

  cpu_a.eip_a -> walk: "VA → MMU walk" {
    style.stroke: "#0080ff"
  }
  walk.step3_a -> success_a: "PA → L1/L2 cache\nor DRAM" {
    style.stroke: "#00c060"
  }
}

# ─── THE PROBLEM (no identity map) ───────────────────────────────

problem: "PROBLEM SCENARIO: No Identity Map" {
  style.fill: "#2a0000"
  style.stroke: "#cc0000"
  style.font-color: "#ff8080"
  style.border-radius: 8

  prob_desc: "If boot_page_directory[0] = 0\n(identity PTE not installed):" {
    style.fill: "#3a0000"
    style.stroke: "#aa0000"
    style.font-color: "#ff6060"
  }

  fault1: "CR0.PG=1 set\n⬇\nNext fetch: VA 0x100054\n⬇\nMMU: PD[0].P = 0\n⬇\nPage Fault #14\n(EIP = 0x100054, P=0)" {
    style.fill: "#400000"
    style.stroke: "#cc0000"
    style.font-color: "#ff4040"
  }
  fault2: "Page Fault Handler:\n● Lives at some VA\n● That VA also not mapped!\n⬇\nAnother Page Fault\n⬇\nDouble Fault #8" {
    style.fill: "#400000"
    style.stroke: "#cc0000"
    style.font-color: "#ff4040"
  }
  fault3: "Double Fault handler:\n● Also not mapped!\n⬇\n⬇\nTRIPLE FAULT\n⬇\nCPU RESET" {
    style.fill: "#500000"
    style.stroke: "#ff0000"
    style.font-color: "#ff0000"
    style.bold: true
  }

  prob_desc -> fault1 -> fault2 -> fault3

  no_diag: "No error message possible.\nQEMU reboots silently.\n-d int shows v=08 (double fault)\nthen CPU reset." {
    style.fill: "#300000"
    style.stroke: "#880000"
    style.font-color: "#cc4040"
    style.italic: true
  }
  fault3 -> no_diag
}

# ─── SOLUTION REQUIREMENTS ────────────────────────────────────────

solution: "SOLUTION: Required Identity Map Coverage" {
  style.fill: "#001a00"
  style.stroke: "#008000"
  style.font-color: "#80ff80"
  style.border-radius: 8

  req1: "identity_page_table[0..1023]:\nPD index 0 → virtual 0x0–0x3FFFFF\n→ physical 0x0–0x3FFFFF (identity)" {
    style.fill: "#002000"
    style.stroke: "#006000"
    style.font-color: "#60d060"
  }
  req2: "Covers ALL executing code:\n• Kernel at 0x100000 (PTE[256])\n• Stack below kernel\n• VGA at 0xB8000 (PTE[184])\n• Page tables themselves" {
    style.fill: "#002000"
    style.stroke: "#006000"
    style.font-color: "#60d060"
  }
  req3: "Higher-half ALSO mapped:\nkernel_page_table[0..1023]\nPD index 768 → virtual 0xC0000000+\n→ physical 0x0–0x3FFFFF" {
    style.fill: "#002000"
    style.stroke: "#006000"
    style.font-color: "#60d060"
  }
  req4: "Both maps active simultaneously\nduring the transition window.\nIdentity removed AFTER\njumping to higher-half VA." {
    style.fill: "#003000"
    style.stroke: "#008000"
    style.font-color: "#80e080"
    style.italic: true
  }

  req1 -> req2 -> req3 -> req4
}

# ─── PAGING ENABLE SEQUENCE ──────────────────────────────────────

sequence: "Correct 3-Step Paging Enable Sequence" {
  style.fill: "#0a0a20"
  style.stroke: "#4040a0"
  style.font-color: "#c0c0ff"
  style.border-radius: 8

  s1: "Step 1: Load CR3\nmov pd_phys, cr3\nMust be PHYSICAL address.\nPaging OFF → no translation yet." {
    style.fill: "#141430"
    style.stroke: "#5050b0"
    style.font-color: "#b0b0ff"
  }
  s2: "Step 2: Set CR0.PG + CR0.WP\nmov cr0, (cr0 | 0x80010000)\nPAGING ACTIVATES HERE.\nNext instruction through MMU." {
    style.fill: "#141430"
    style.stroke: "#8080d0"
    style.font-color: "#d0c0ff"
    style.bold: true
  }
  s3: "Step 3: (Optional) Far jump\njmp 0x08:next_label\nFlush pipeline explicitly.\nOn identity map: implicit via\nCR0 serialization." {
    style.fill: "#141430"
    style.stroke: "#5050b0"
    style.font-color: "#b0b0ff"
  }
  s4: "Post-paging: remove identity map\nboot_page_directory[0] = 0\nCR3 reload → TLB flush\nIdentity range now faults on access." {
    style.fill: "#101028"
    style.stroke: "#3030a0"
    style.font-color: "#9090e0"
    style.italic: true
  }

  s1 -> s2 -> s3 -> s4
}

# ─── CONNECTIONS BETWEEN PANELS ──────────────────────────────────

before -> moment: "vmm_enable_paging()\ncalled with:\n• PD built\n• Both maps installed\n• CR3 loaded" {
  style.stroke: "#ff8000"
  style.stroke-width: 2
  style.font-color: "#ff8000"
}

moment -> after: "Success path\n(identity map present)" {
  style.stroke: "#00c060"
  style.stroke-width: 2
  style.font-color: "#00c060"
}

moment -> problem: "Failure path\n(identity map absent)" {
  style.stroke: "#ff0000"
  style.stroke-width: 2
  style.stroke-dash: 4
  style.font-color: "#ff4040"
}

after -> solution: "These requirements\nmust ALL hold\nbefore Step 2" {
  style.stroke: "#00a0a0"
  style.stroke-dash: 3
}

solution -> sequence: "Implements\ncorrectly as" {
  style.stroke: "#006000"
  style.stroke-dash: 3
}