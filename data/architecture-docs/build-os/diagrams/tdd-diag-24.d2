layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # process_t â€” PCB Byte-Level Field Map
  sizeof(process_t) = 96 bytes Â· Stack grows â†“ Â· Physical addr in page_directory
|
title.near: top-center

pcb: {
  label: "process_t struct (PCB)"
  style: {
    fill: "#1a1a2e"
    stroke: "#e0e0e0"
    stroke-width: 2
  }

  hdr: "Offset   â”‚ Field Name                      â”‚ Size â”‚ Valid States"
  hdr.style: {
    fill: "#2d2d4e"
    font-color: "#e0e0e0"
    stroke: "#555"
    bold: true
  }

  f0: "0x00 (+0) â”‚ pid : uint32_t                  â”‚ 4 B  â”‚ READYÂ·RUNNINGÂ·BLOCKEDÂ·DEAD"
  f0.style: {
    fill: "#4a0080"
    font-color: "#e8d5ff"
    stroke: "#8800cc"
    font: mono
  }

  f4: "0x04 (+4) â”‚ name[32] : char                 â”‚ 32 B â”‚ ALL STATES"
  f4.style: {
    fill: "#003366"
    font-color: "#cce5ff"
    stroke: "#0055aa"
    font: mono
  }

  f36: "0x24 (+36)â”‚ state : process_state_t         â”‚ 4 B  â”‚ ALL STATES"
  f36.style: {
    fill: "#4a0080"
    font-color: "#e8d5ff"
    stroke: "#8800cc"
    font: mono
  }

  ctx_label: "0x28 (+40)â•”â•â•â•â•â•â• cpu_context_t â•â•â•â•â•â•â•— 28 B â”‚ READYÂ·BLOCKED (saved)"
  ctx_label.style: {
    fill: "#005533"
    font-color: "#ccffee"
    stroke: "#00aa66"
    font: mono
  }

  ctx: {
    style: {
      fill: "#003322"
      stroke: "#00aa66"
      stroke-width: 2
    }
    c0: "+0  â”‚ edi : uint32_t                  â”‚ 4 B"
    c4: "+4  â”‚ esi : uint32_t                  â”‚ 4 B"
    c8: "+8  â”‚ ebx : uint32_t                  â”‚ 4 B"
    c12: "+12 â”‚ ebp : uint32_t                  â”‚ 4 B"
    c16: "+16 â”‚ esp : uint32_t (PIVOT)          â”‚ 4 B"
    c20: "+20 â”‚ eip : uint32_t (Resume)         â”‚ 4 B"
    c24: "+24 â”‚ eflags : uint32_t               â”‚ 4 B"
    
    *.style: {
      fill: "#004422"
      font-color: "#aaffcc"
      stroke: "#006633"
      font: mono
    }
    c16.style: {
      fill: "#664400"
      font-color: "#ffddaa"
      stroke: "#cc8800"
      bold: true
    }
  }

  f68: "0x44 (+68)â”‚ page_directory* (PHYSICAL)     â”‚ 4 B  â”‚ ALL â€” physical addr â†’ CR3"
  f68.style: {
    fill: "#663300"
    font-color: "#ffddbb"
    stroke: "#cc6600"
    font: mono
    bold: true
  }

  f72: "0x48 (+72)â”‚ kernel_stack* (VIRTUAL)        â”‚ 4 B  â”‚ ALL â€” virtual base of 8KB"
  f72.style: {
    fill: "#003366"
    font-color: "#cce5ff"
    stroke: "#0055aa"
    font: mono
  }

  f76: "0x4C (+76)â”‚ kernel_stack_top (TSS.ESP0)    â”‚ 4 B  â”‚ ALL â€” CPU hardware bridge"
  f76.style: {
    fill: "#660000"
    font-color: "#ffcccc"
    stroke: "#cc0000"
    stroke-width: 2
    font: mono
    bold: true
  }

  f80: "0x50 (+80)â”‚ user_esp : uint32_t             â”‚ 4 B  â”‚ RUNNINGÂ·READY"
  f80.style: {
    fill: "#003366"
    font-color: "#cce5ff"
    stroke: "#0055aa"
    font: mono
  }

  f84: "0x54 (+84)â”‚ ticks_remaining : uint32_t     â”‚ 4 B"
  f88: "0x58 (+88)â”‚ total_ticks : uint32_t         â”‚ 4 B"
  f84.style.fill: "#1a1a1a"
  f88.style.fill: "#1a1a1a"

  f92: "0x5C (+92)â”‚ next* : process_t* (QUEUE)     â”‚ 4 B  â”‚ Linked list pointer"
  f92.style: {
    fill: "#663300"
    font-color: "#ffddbb"
    stroke: "#cc6600"
    font: mono
  }

  total_row: "| Total Size: 96 Bytes (0x60) | Fits 1.5 Cache Lines (64B/CL) |"
  total_row.style: {
    fill: "#2d2d2d"
    font-color: "#ffff99"
    stroke: "#888800"
  }
}

legend: {
  style: {
    fill: "#111122"
    stroke: "#555577"
  }
  
  identity: "ðŸŸ£ Purple = Identity / State fields"
  identity.style.font-color: "#e8d5ff"
  
  data: "ðŸ”µ Blue = Data / Virtual Pointers"
  data.style.font-color: "#cce5ff"
  
  hw: "ðŸŸ  Orange = Hardware / Physical Pointers"
  hw.style.font-color: "#ffddbb"
  
  regs: "ðŸŸ¢ Green = Saved CPU Context (GPRs)"
  regs.style.font-color: "#ccffee"
  
  tss: "ðŸ”´ Red = Hardware Bridge (TSS.ESP0)"
  tss.style.font-color: "#ffcccc"
  
  meta: "âš« Gray = Scheduler Metadata"
  meta.style.font-color: "#aaaaaa"
}

cache_map: {
  style: {
    fill: "#0a0a1a"
    stroke: "#445566"
  }
  cl0: "Cache Line 0 [0x00-0x3F] (64 B)"
  cl0.style: {
    fill: "#0d1a33"
    stroke: "#334477"
    stroke-dash: 4
    font: mono
    font-color: "#88aaff"
  }
  cl0_c: "pid + name + state + edi + esi + ebx + ebp + esp = 60/64 bytes used"
  
  cl1: "Cache Line 1 [0x40-0x7F] (64 B)"
  cl1.style: {
    fill: "#1a0d33"
    stroke: "#553377"
    stroke-dash: 4
    font: mono
    font-color: "#aa88ff"
  }
  cl1_c: "eip + flags + cr3 + kstack + top + uesp + ticks + next = 36/64 bytes used"
}

tss_note: |md
  **TSS Interaction (hardware contract)**
  On every `context_switch(old, new)`:
  1. `kernel_tss.esp0 â† new->kernel_stack_top`
  2. `CR3 â† new->page_directory` (physical)
  3. `context_switch_asm(&old->context, &new->context)`
|
tss_note.near: bottom-center
tss_note.style: {
  fill: "#1a0000"
  font-color: "#ff9999"
  stroke: "#cc0000"
}

init_stack: |md
  **Fabricated Initial Stack Frame**
  *Push order at kernel_stack_top:*
  - entry_fn addr
  - EBX = 0x0, ESI = 0x0, EDI = 0x0
  - EBP = 0x0
  - EFLAGS = 0x202 (IF=1)
|
init_stack.near: bottom-left
init_stack.style: {
  fill: "#002200"
  font-color: "#88ff88"
  stroke: "#006600"
  font: mono
}