vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |'md'
  # Task State Segment — tss_t Fields, GDT Descriptor Entry 5, and Ring-3 Interrupt Stack Switch
'| {near: top-center}

# ─── TSS STRUCT MEMORY LAYOUT ──────────────────────────────────────────────
tss_struct: "tss_t  kernel_tss  (104 bytes total)" {
  style.fill: "#1a1a2e"
  style.stroke: "#7c3aed"
  style.stroke-width: 2
  style.border-radius: 6
  style.font-color: white
  style.bold: true
  
  f00: "+0x00  prev_tss   uint32_t   [0x00000000 — unused]" {
    style.fill: "#2d3748"
    style.font-color: "#a0aec0"
    style.font-size: 12
    style.border-radius: 3
  }
  f04: "+0x04  esp0       uint32_t   ◀ KERNEL STACK PTR — ONLY FIELD THAT MATTERS" {
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.stroke-width: 3
    style.font-color: "#fca5a5"
    style.bold: true
    style.font-size: 12
    style.border-radius: 3
  }
  f08: "+0x08  ss0        uint32_t   ◀ KERNEL STACK SEG = 0x10 — ONLY OTHER ACTIVE FIELD" {
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.stroke-width: 3
    style.font-color: "#fca5a5"
    style.bold: true
    style.font-size: 12
    style.border-radius: 3
  }
  f0c: "+0x0C  esp1       uint32_t   [0x00000000 — ring 1 unused]" {
    style.fill: "#2d3748"
    style.font-color: "#a0aec0"
    style.font-size: 12
    style.border-radius: 3
  }
  f10: "+0x10  ss1        uint32_t   [0x00000000]" {
    style.fill: "#2d3748"
    style.font-color: "#a0aec0"
    style.font-size: 12
    style.border-radius: 3
  }
  f14: "+0x14  esp2       uint32_t   [0x00000000 — ring 2 unused]" {
    style.fill: "#2d3748"
    style.font-color: "#a0aec0"
    style.font-size: 12
    style.border-radius: 3
  }
  f18: "+0x18  ss2        uint32_t   [0x00000000]" {
    style.fill: "#2d3748"
    style.font-color: "#a0aec0"
    style.font-size: 12
    style.border-radius: 3
  }
  f1c: "+0x1C  cr3_field  uint32_t   [0x00000000 — HW task switch only]" {
    style.fill: "#2d3748"
    style.font-color: "#a0aec0"
    style.font-size: 12
    style.border-radius: 3
  }
  f20: "+0x20  eip_field  uint32_t   [0x00000000]" {
    style.fill: "#2d3748"
    style.font-color: "#a0aec0"
    style.font-size: 12
    style.border-radius: 3
  }
  f24: "+0x24  eflags_f   uint32_t   [0x00000000]" {
    style.fill: "#2d3748"
    style.font-color: "#a0aec0"
    style.font-size: 12
    style.border-radius: 3
  }
  gpregs: "+0x28–0x44  eax/ecx/edx/ebx/esp/ebp/esi/edi  [all 0x00000000 — HW task unused]" {
    style.fill: "#2d3748"
    style.font-color: "#a0aec0"
    style.font-size: 12
    style.border-radius: 3
  }
  segregs: "+0x48–0x5C  es/cs/ss/ds/fs/gs  uint16_t pairs + pad  [all 0x0000]" {
    style.fill: "#2d3748"
    style.font-color: "#a0aec0"
    style.font-size: 12
    style.border-radius: 3
  }
  f60: "+0x60  ldt        uint16_t   [0x0000]" {
    style.fill: "#2d3748"
    style.font-color: "#a0aec0"
    style.font-size: 12
    style.border-radius: 3
  }
  f62: "+0x62  _pad6      uint16_t   [0x0000]" {
    style.fill: "#2d3748"
    style.font-color: "#718096"
    style.font-size: 12
    style.border-radius: 3
  }
  f64: "+0x64  trap       uint16_t   [0x0000 — no debug trap on task switch]" {
    style.fill: "#2d3748"
    style.font-color: "#a0aec0"
    style.font-size: 12
    style.border-radius: 3
  }
  f66: "+0x66  iomap_base uint16_t   [0x0068 = sizeof(tss_t) → no ring-3 I/O]" {
    style.fill: "#1a365d"
    style.stroke: "#3182ce"
    style.font-color: "#90cdf4"
    style.font-size: 12
    style.border-radius: 3
  }
  fend: "+0x68  [end — 104 bytes total; sizeof(tss_t) = 104]" {
    style.fill: "#1c4532"
    style.font-color: "#68d391"
    style.font-size: 12
    style.border-radius: 3
  }
}

# ─── GDT COMPARISON TABLE ──────────────────────────────────────────────────
gdt_table: "GDT — Six Entries After M4 (each 8 bytes)" {
  style.fill: "#0f2027"
  style.stroke: "#7c3aed"
  style.stroke-width: 2
  style.border-radius: 6
  style.font-color: white
  style.bold: true
  hdr: |'md'
    | Idx | Selector | Name | S | DPL | Type | Access | flags_limit |
    |-----|----------|------|---|-----|------|--------|-------------|
    | 0 | 0x00 | Null | — | — | — | 0x00 | 0x00 |
    | 1 | 0x08 | Kernel code | **1** | 0 | Code/Read | 0x9A | 0xCF |
    | 2 | 0x10 | Kernel data | **1** | 0 | Data/Write | 0x92 | 0xCF |
    | 3 | 0x1B | User code | **1** | 3 | Code/Read | 0xFA | 0xCF |
    | 4 | 0x23 | User data | **1** | 3 | Data/Write | 0xF2 | 0xCF |
    | **5** | **0x28** | **TSS** | **0** | **0** | **32b TSS avail** | **0x89** | **0x00** |
  '|
}

gdt_note: |'md'
  **S=0 (system) vs S=1 (code/data)**
  Entries 1–4: S=1 → code or data segment.
  Entry 5 (TSS): **S=0** → system descriptor.
  Type nibble 0x9 = 32-bit TSS, available.
  G=0: **byte granularity** (limit counts bytes, not 4KB pages).
  Limit = sizeof(tss_t) − 1 = **103 = 0x67**.
  Base = linear address of kernel_tss.
'| {
  style.fill: "#1a1a2e"
  style.stroke: "#7c3aed"
  style.font-color: "#c4b5fd"
  style.font-size: 12
  near: bottom-left
}

# ─── TSS DESCRIPTOR BIT LAYOUT ─────────────────────────────────────────────
tss_desc: "GDT[5] — TSS Descriptor Byte Layout (8 bytes)" {
  style.fill: "#1a1a2e"
  style.stroke: "#7c3aed"
  style.stroke-width: 2
  style.border-radius: 6
  style.bold: true
  style.font-color: white
  byte01: "Bytes 0–1: limit_low  = 0x0067  (103 & 0xFFFF)" {
    style.fill: "#2d1b69"
    style.font-color: "#c4b5fd"
    style.font-size: 12
    style.border-radius: 3
  }
  byte23: "Bytes 2–3: base_low   = &kernel_tss[15:0]" {
    style.fill: "#ff6b35"
    style.font-color: white
    style.font-size: 12
    style.border-radius: 3
  }
  byte4:  "Byte  4:   base_mid   = &kernel_tss[23:16]" {
    style.fill: "#ff6b35"
    style.font-color: white
    style.font-size: 12
    style.border-radius: 3
  }
  byte5:  "Byte  5:   access     = 0x89  → P=1 DPL=00 S=0 Type=1001" {
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.stroke-width: 2
    style.font-color: "#fca5a5"
    style.bold: true
    style.font-size: 12
    style.border-radius: 3
  }
  byte6:  "Byte  6:   flags_lim  = 0x00  → G=0 D=0 L=0 AVL=0 | limit[19:16]=0" {
    style.fill: "#1e3a5f"
    style.font-color: "#90cdf4"
    style.font-size: 12
    style.border-radius: 3
  }
  byte7:  "Byte  7:   base_high  = &kernel_tss[31:24]" {
    style.fill: "#ff6b35"
    style.font-color: white
    style.font-size: 12
    style.border-radius: 3
  }
  ltr_box: "ltr  0x28  — loads TR (Task Register) with TSS selector" {
    style.fill: "#14532d"
    style.stroke: "#22c55e"
    style.stroke-width: 2
    style.font-color: "#86efac"
    style.bold: true
    style.font-size: 12
    style.border-radius: 3
  }
}

# ─── INTERRUPT STACK SWITCH SEQUENCE ───────────────────────────────────────
irq_seq: "Ring-3 Interrupt Arrival → Hardware Stack Switch Sequence" {
  style.fill: "#0f2027"
  style.stroke: "#ef4444"
  style.stroke-width: 2
  style.border-radius: 6
  style.font-color: white
  style.bold: true
  s1: "① Timer IRQ fires (PIT IRQ0 → vector 32)\n   CPU running ring-3 process\n   ESP = user_esp (ring-3 stack)" {
    style.fill: "#1e3a5f"
    style.font-color: "#90cdf4"
    style.font-size: 12
    style.border-radius: 4
  }
  s2: "② CPU checks EFLAGS.IF = 1 → interrupt accepted\n   Reads IDT[32]: interrupt gate, selector=0x08\n   Detects CPL=3 → DPL=0: privilege change required" {
    style.fill: "#1e3a5f"
    style.font-color: "#90cdf4"
    style.font-size: 12
    style.border-radius: 4
  }
  s3: "③ CPU reads TSS.ESP0 and TSS.SS0\n   (hardware reads physical bytes at kernel_tss+4 and +8)\n   TSS.SS0 = 0x10   TSS.ESP0 = current_process->kernel_stack_top" {
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.stroke-width: 3
    style.font-color: "#fca5a5"
    style.bold: true
    style.font-size: 12
    style.border-radius: 4
  }
  s4: "④ CPU switches stack:\n   SS  ← 0x10  (kernel data)\n   ESP ← TSS.ESP0  (kernel_stack_top)" {
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.stroke-width: 2
    style.font-color: "#fca5a5"
    style.bold: true
    style.font-size: 12
    style.border-radius: 4
  }
  s5: "⑤ CPU pushes 5 values onto KERNEL stack (high→low):\n   +16: SS_user    (old ring-3 stack segment)\n   +12: ESP_user   (old ring-3 stack pointer)\n   + 8: EFLAGS     (with IF=1 from user)\n   + 4: CS_user    (0x1B  — ring 3 code selector)\n   + 0: EIP_user   (interrupted instruction address)" {
    style.fill: "#1c4532"
    style.stroke: "#22c55e"
    style.stroke-width: 2
    style.font-color: "#86efac"
    style.font-size: 12
    style.border-radius: 4
  }
  s6: "⑥ isr_32 stub executes → isr_common_stub → interrupt_dispatch\n   → timer_handler → scheduler_tick → context_switch\n   context_switch MUST call tss_set_kernel_stack(new->kernel_stack_top)\n   BEFORE context_switch_asm swaps ESP" {
    style.fill: "#2d1b69"
    style.stroke: "#7c3aed"
    style.stroke-width: 2
    style.font-color: "#c4b5fd"
    style.font-size: 12
    style.border-radius: 4
  }
  s7: "⑦ iretd (return from interrupt):\n   Pops EIP, CS → sees CS.RPL=3 > CPL=0 → privilege change back\n   Also pops EFLAGS, ESP, SS → restores ring-3 stack\n   User process resumes at exact interrupted instruction" {
    style.fill: "#1e3a5f"
    style.font-color: "#90cdf4"
    style.font-size: 12
    style.border-radius: 4
  }
  s1 -> s2: "INTR asserted"
  s2 -> s3: "privilege change detected"
  s3 -> s4: "TSS.ESP0 read"
  s4 -> s5: "stack switched to ring-0"
  s5 -> s6: "handler dispatched"
  s6 -> s7: "iretd"
}

# ─── CRITICAL BUG PANEL ────────────────────────────────────────────────────
bug_panel: "Critical Invariant: TSS.ESP0 Must Be Updated on Every Context Switch" {
  style.fill: "#450a0a"
  style.stroke: "#ef4444"
  style.stroke-width: 3
  style.border-radius: 6
  style.font-color: "#fca5a5"
  style.bold: true
  correct: |'md'
    **CORRECT order in context_switch():**
    1. `tss_set_kernel_stack(new->kernel_stack_top)` ← FIRST
    2. CR3 ← new->page_directory (if different)
    3. `current_process = new`
    4. `context_switch_asm(&old->context, &new->context)`
    If ESP0 is stale (points to old process's stack_top):
    → Next ring-3 interrupt pushes frame onto WRONG stack
    → Corrupts old process's kernel state silently
    → System crashes unpredictably later, not immediately
    → Hardest class of bug to diagnose in OS development
  '| {
    style.fill: "#450a0a"
    style.font-color: "#fca5a5"
    style.font-size: 12
  }
}

# ─── tss_set_kernel_stack implementation ───────────────────────────────────
impl_box: "tss_set_kernel_stack() — Implementation" {
  style.fill: "#0f2027"
  style.stroke: "#22c55e"
  style.stroke-width: 2
  style.border-radius: 6
  style.font-color: white
  code: |'c'
    void tss_set_kernel_stack(uint32_t esp0_value) {
        kernel_tss.esp0 = esp0_value;
        // Single 32-bit store — atomic on x86.
        // Called with IF=0 (inside IRQ handler).
        // No lock needed on single-core.
    }
    // tss_init() sequence:
    void tss_init(void) {
        memset(&kernel_tss, 0, sizeof(tss_t));
        kernel_tss.ss0       = 0x10;           // Kernel data selector
        kernel_tss.iomap_base = sizeof(tss_t); // = 104 → no ring-3 I/O
        gdt_set_tss_entry(5,
            (uint32_t)&kernel_tss,    // base
            sizeof(tss_t) - 1);       // limit = 103
        __asm__ volatile ("ltr %0" : : "r"((uint16_t)0x28));
    }
  '| {
    style.fill: "#0a1628"
    style.font-color: "#86efac"
    style.font-size: 11
  }
}

# ─── CONNECTIONS ───────────────────────────────────────────────────────────
tss_struct.f04 -> irq_seq.s3: "CPU reads this field on every ring-3 interrupt" {
  style.stroke: "#ef4444"
  style.stroke-width: 2
  style.stroke-dash: 3
  style.font-color: "#fca5a5"
  style.font-size: 11
}
tss_struct.f08 -> irq_seq.s4: "Loaded into SS on privilege change" {
  style.stroke: "#ef4444"
  style.stroke-width: 2
  style.stroke-dash: 3
  style.font-color: "#fca5a5"
  style.font-size: 11
}
tss_desc.ltr_box -> irq_seq.s3: "TR register points CPU to kernel_tss" {
  style.stroke: "#22c55e"
  style.stroke-width: 2
  style.font-color: "#86efac"
  style.font-size: 11
}
irq_seq.s6 -> bug_panel: "context_switch must update TSS first" {
  style.stroke: "#ef4444"
  style.stroke-width: 2
  style.font-color: "#fca5a5"
  style.font-size: 11
}
bug_panel -> impl_box: "tss_set_kernel_stack(new->kernel_stack_top)" {
  style.stroke: "#7c3aed"
  style.stroke-width: 2
  style.font-color: "#c4b5fd"
  style.font-size: 11
}
gdt_table -> tss_desc: "Entry 5 encoding" {
  style.stroke: "#7c3aed"
  style.stroke-width: 2
  style.font-color: "#c4b5fd"
  style.font-size: 11
}