vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  ## context_switch_asm — Stack State Trace at Each Instruction
  _Left = OLD process kernel stack · Right = NEW process kernel stack_
  _Red vertical bar = identity-change moment_
| {near: top-center}
# ─── OLD PROCESS STACK (left column) ─────────────────────────────────────────
old_stack: "OLD Process — Kernel Stack" {
  style.fill: "#1a1a2e"
  style.stroke: "#7c3aed"
  style.stroke-width: 2
  style.font-color: white
  style.bold: true
  s0: "ESP₀  [entry to context_switch_asm]\nReturn EIP pushed by 'call'" {
    style.fill: "#2d1b69"
    style.stroke: "#7c3aed"
    style.font-color: "#c4b5fd"
    style.font: mono
  }
  s1: "ESP₀−4   push ebx\n[OLD EBX saved]" {
    style.fill: "#1e3a5f"
    style.stroke: "#3b82f6"
    style.font-color: "#93c5fd"
    style.font: mono
  }
  s2: "ESP₀−8   push esi\n[OLD ESI saved]" {
    style.fill: "#1e3a5f"
    style.stroke: "#3b82f6"
    style.font-color: "#93c5fd"
    style.font: mono
  }
  s3: "ESP₀−12  push edi\n[OLD EDI saved]" {
    style.fill: "#1e3a5f"
    style.stroke: "#3b82f6"
    style.font-color: "#93c5fd"
    style.font: mono
  }
  s4: "ESP₀−16  push ebp\n[OLD EBP saved]" {
    style.fill: "#1e3a5f"
    style.stroke: "#3b82f6"
    style.font-color: "#93c5fd"
    style.font: mono
  }
  s5: "ESP₀−20  pushfd\n[OLD EFLAGS — IF=0 inside IRQ gate]" {
    style.fill: "#7c3aed"
    style.stroke: "#a78bfa"
    style.stroke-width: 3
    style.font-color: white
    style.bold: true
    style.font: mono
  }
  save_esp: "mov [old_ctx+0], esp\nold_ctx→esp = ESP₀−20\n(stores pointer to entire frame)" {
    style.fill: "#065f46"
    style.stroke: "#10b981"
    style.stroke-width: 3
    style.font-color: "#6ee7b7"
    style.bold: true
    style.font: mono
  }
  s0 -> s1: "push ebx" {
    style.stroke: "#3b82f6"
    style.font-color: "#93c5fd"
    style.font: mono
  }
  s1 -> s2: "push esi" {
    style.stroke: "#3b82f6"
    style.font-color: "#93c5fd"
    style.font: mono
  }
  s2 -> s3: "push edi" {
    style.stroke: "#3b82f6"
    style.font-color: "#93c5fd"
    style.font: mono
  }
  s3 -> s4: "push ebp" {
    style.stroke: "#3b82f6"
    style.font-color: "#93c5fd"
    style.font: mono
  }
  s4 -> s5: "pushfd" {
    style.stroke: "#7c3aed"
    style.stroke-width: 2
    style.font-color: "#c4b5fd"
    style.font: mono
  }
  s5 -> save_esp: "ESP saved to\nold_ctx→esp" {
    style.stroke: "#10b981"
    style.stroke-width: 2
    style.font-color: "#6ee7b7"
    style.font: mono
  }
}
# ─── IDENTITY CHANGE BARRIER ──────────────────────────────────────────────────
identity_swap: "◀─────  IDENTITY CHANGE  ─────▶\nmov esp, [new_ctx+0]\nESP jumps to NEW process stack\nInstruction 7 of 11 — point of no return" {
  style.fill: "#7f1d1d"
  style.stroke: "#ef4444"
  style.stroke-width: 4
  style.font-color: "#fca5a5"
  style.bold: true
  style.font: mono
}
# ─── NEW PROCESS STACK (right column) ─────────────────────────────────────────
new_stack: "NEW Process — Kernel Stack" {
  style.fill: "#1a1a2e"
  style.stroke: "#f59e0b"
  style.stroke-width: 2
  style.font-color: white
  style.bold: true
  n_label: |md
    **Stack built by prior context_switch_asm save**
    _(or fabricated by process_create on first schedule)_
  | {
    style.fill: "#292524"
    style.stroke: "#78716c"
    style.font-color: "#d6d3d1"
  }
  n0: "new_ctx→esp  ← ESP loaded here\n[NEW EFLAGS  — IF=1 for new process]" {
    style.fill: "#7c3aed"
    style.stroke: "#a78bfa"
    style.stroke-width: 3
    style.font-color: white
    style.bold: true
    style.font: mono
  }
  n1: "new_ctx→esp+4\n[NEW EBP]" {
    style.fill: "#1e3a5f"
    style.stroke: "#f59e0b"
    style.font-color: "#fde68a"
    style.font: mono
  }
  n2: "new_ctx→esp+8\n[NEW EDI]" {
    style.fill: "#1e3a5f"
    style.stroke: "#f59e0b"
    style.font-color: "#fde68a"
    style.font: mono
  }
  n3: "new_ctx→esp+12\n[NEW ESI]" {
    style.fill: "#1e3a5f"
    style.stroke: "#f59e0b"
    style.font-color: "#fde68a"
    style.font: mono
  }
  n4: "new_ctx→esp+16\n[NEW EBX]" {
    style.fill: "#1e3a5f"
    style.stroke: "#f59e0b"
    style.font-color: "#fde68a"
    style.font: mono
  }
  n5: "new_ctx→esp+20\n[NEW EIP  — return address for 'ret']" {
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.stroke-width: 3
    style.font-color: "#fca5a5"
    style.bold: true
    style.font: mono
  }
  ret_target: "ret → jumps to NEW EIP\n• Previously-running process: resumes after context_switch_asm call site\n• First-time process: jumps to entry_fn  (or user trampoline)" {
    style.fill: "#064e3b"
    style.stroke: "#10b981"
    style.stroke-width: 3
    style.font-color: "#6ee7b7"
    style.bold: true
    style.font: mono
  }
  n_label -> n0: "ESP loaded\nfrom new_ctx" {
    style.stroke: "#f59e0b"
    style.stroke-width: 2
    style.font-color: "#fde68a"
    style.font: mono
  }
  n0 -> n1: "popfd\n(restores EFLAGS; IF=1\nenables interrupts)" {
    style.stroke: "#7c3aed"
    style.stroke-width: 2
    style.font-color: "#c4b5fd"
    style.font: mono
  }
  n1 -> n2: "pop ebp" {
    style.stroke: "#f59e0b"
    style.font-color: "#fde68a"
    style.font: mono
  }
  n2 -> n3: "pop edi" {
    style.stroke: "#f59e0b"
    style.font-color: "#fde68a"
    style.font: mono
  }
  n3 -> n4: "pop esi" {
    style.stroke: "#f59e0b"
    style.font-color: "#fde68a"
    style.font: mono
  }
  n4 -> n5: "pop ebx" {
    style.stroke: "#f59e0b"
    style.font-color: "#fde68a"
    style.font: mono
  }
  n5 -> ret_target: "ret" {
    style.stroke: "#ef4444"
    style.stroke-width: 3
    style.font-color: "#fca5a5"
    style.bold: true
    style.font: mono
  }
}
# ─── FABRICATED FRAME ANNOTATION ─────────────────────────────────────────────
fabricated: "First-Time Process — Fabricated Frame\n(built by process_create)" {
  style.fill: "#1c1917"
  style.stroke: "#d97706"
  style.stroke-width: 2
  style.font-color: "#fcd34d"
  fab0: "[kst−24]  EFLAGS = 0x00000202\n• Bit 9 (IF)=1  interrupts ON\n• Bit 1=1  always set (reserved)" {
    style.fill: "#451a03"
    style.stroke: "#d97706"
    style.font-color: "#fcd34d"
    style.font: mono
  }
  fab1: "[kst−20]  EBP = 0x00000000\n(marks call-chain bottom for backtraces)" {
    style.fill: "#1c1917"
    style.stroke: "#78716c"
    style.font-color: "#d6d3d1"
    style.font: mono
  }
  fab2: "[kst−16]  EDI = 0x00000000" {
    style.fill: "#1c1917"
    style.stroke: "#78716c"
    style.font-color: "#d6d3d1"
    style.font: mono
  }
  fab3: "[kst−12]  ESI = 0x00000000" {
    style.fill: "#1c1917"
    style.stroke: "#78716c"
    style.font-color: "#d6d3d1"
    style.font: mono
  }
  fab4: "[kst−8]   EBX = 0x00000000" {
    style.fill: "#1c1917"
    style.stroke: "#78716c"
    style.font-color: "#d6d3d1"
    style.font: mono
  }
  fab5: "[kst−4]   EIP = entry_fn address\n← 'ret' pops this → process begins" {
    style.fill: "#7f1d1d"
    style.stroke: "#ef4444"
    style.stroke-width: 2
    style.font-color: "#fca5a5"
    style.bold: true
    style.font: mono
  }
  fab_ctx: "context.esp = kst−24\n(stored in process_t.context.esp)" {
    style.fill: "#065f46"
    style.stroke: "#10b981"
    style.font-color: "#6ee7b7"
    style.bold: true
    style.font: mono
  }
  fab0 -> fab1
  fab1 -> fab2
  fab2 -> fab3
  fab3 -> fab4
  fab4 -> fab5
  fab5 -> fab_ctx: "process_create\nsets context.esp" {
    style.stroke: "#10b981"
    style.font-color: "#6ee7b7"
    style.font: mono
  }
}
# ─── INSTRUCTION COUNTER TABLE ───────────────────────────────────────────────
instr_table: "context_switch_asm — All 11 Instructions" {
  shape: sql_table
  style.fill: "#0f172a"
  style.stroke: "#334155"
  style.font-color: white
  "① push ebx": "SAVE: callee-saved reg 1/5 → OLD stack"
  "② push esi": "SAVE: callee-saved reg 2/5 → OLD stack"
  "③ push edi": "SAVE: callee-saved reg 3/5 → OLD stack"
  "④ push ebp": "SAVE: callee-saved reg 4/5 → OLD stack"
  "⑤ pushfd": "SAVE: EFLAGS (incl. IF=0) → OLD stack  [ESP₀−20]"
  "⑥ mov [old_ctx+0], esp": "CAPTURE: write ESP₀−20 into old_ctx→esp"
  "⑦ mov esp, [new_ctx+0]": "⚠ IDENTITY SWAP: ESP = new_ctx→esp  [RED LINE]"
  "⑧ popfd": "RESTORE: EFLAGS from NEW stack  (IF=1 re-enabled)"
  "⑨ pop ebp": "RESTORE: EBP from NEW stack"
  "⑩ pop edi / esi / ebx": "RESTORE: EDI, ESI, EBX from NEW stack  (3 pops)"
  "⑪ ret": "JUMP: pop NEW EIP → resume NEW process"
}
# ─── FLOWS ────────────────────────────────────────────────────────────────────
old_stack.save_esp -> identity_swap: "OLD context fully\nsaved — ready to suspend" {
  style.stroke: "#ef4444"
  style.stroke-width: 4
  style.font-color: "#fca5a5"
  style.bold: true
  style.animated: true
}
identity_swap -> new_stack.n_label: "NEW stack activated\nExecution identity changed" {
  style.stroke: "#ef4444"
  style.stroke-width: 4
  style.font-color: "#fca5a5"
  style.bold: true
  style.animated: true
}
fabricated -> new_stack.n0: "First scheduling:\nfabricated frame\nlooks identical" {
  style.stroke: "#d97706"
  style.stroke-dash: 4
  style.font-color: "#fcd34d"
  style.font: mono
}