vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |'md
  ## process_t PCB and cpu_state_t — Byte-Level Memory Layout
  **sizeof(process_t) = 4152 bytes | 16 PCBs = 66,432 bytes in .bss**
'| {near: top-center}

pcb: process_t (one PCB entry) {
  style.fill: "#1a1a2e"
  style.stroke: "#e94560"
  style.stroke-width: 2
  style.font-color: white
  style.bold: true

  identity: Identity Fields {
    style.fill: "#6a0572"
    style.stroke: "#9b2dca"
    style.font-color: white

    pid_row: "Offset 0 │ pid: uint32_t │ 4 bytes │ Unique process ID (0=unused)" {
      style.fill: "#6a0572"
      style.font-color: "#f0a0ff"
      style.font: mono
    }
    name_row: "Offset 4 │ name[32]: char │ 32 bytes │ Null-terminated debug name" {
      style.fill: "#6a0572"
      style.font-color: "#f0a0ff"
      style.font: mono
    }
  }

  sched: Scheduling Fields {
    style.fill: "#0d3b66"
    style.stroke: "#1a78c2"
    style.font-color: white

    state_row: "Offset 36 │ state: process_state_t │ 4 bytes │ UNUSED/READY/RUNNING/BLOCKED/ZOMBIE" {
      style.fill: "#0d3b66"
      style.font-color: "#a0d0ff"
      style.font: mono
    }
    ticks_row: "Offset 40 │ ticks_remaining: uint32_t │ 4 bytes │ Countdown to preemption" {
      style.fill: "#0d3b66"
      style.font-color: "#a0d0ff"
      style.font: mono
    }
  }

  cpu_ptr: CPU State Pointer {
    style.fill: "#e65c00"
    style.stroke: "#ff8c00"
    style.font-color: white

    saved_esp_row: "Offset 44 │ saved_esp: uint32_t │ 4 bytes │ Kernel stack pointer (points into kernel_stack[])" {
      style.fill: "#e65c00"
      style.font-color: "#ffd0a0"
      style.font: mono
    }
  }

  mem: Memory Fields {
    style.fill: "#1b4332"
    style.stroke: "#40916c"
    style.font-color: white

    pd_row: "Offset 48 │ page_directory: pde_t* │ 4 bytes │ Physical addr of process page directory" {
      style.fill: "#1b4332"
      style.font-color: "#a0ffcc"
      style.font: mono
    }
    kstop_row: "Offset 52 │ kernel_stack_top: uint32_t │ 4 bytes │ Top of kernel stack (= kernel_stack + 4096)" {
      style.fill: "#1b4332"
      style.font-color: "#a0ffcc"
      style.font: mono
    }
  }

  kstack: "kernel_stack[4096] — Per-Process Kernel Stack" {
    style.fill: "#2d2d2d"
    style.stroke: "#888888"
    style.stroke-dash: 4
    style.font-color: "#cccccc"

    kstack_hdr: "Offset 56 │ kernel_stack[4096] │ 4096 bytes │ __attribute__((aligned(16)))" {
      style.fill: "#2d2d2d"
      style.font-color: "#aaaaaa"
      style.font: mono
    }
    growth: "Stack grows ↓ DOWNWARD from kernel_stack_top" {
      style.fill: "#3a3a3a"
      style.font-color: "#888888"
      style.italic: true
    }
    stack_top: "kernel_stack_top (highest addr) ← TSS.ESP0 points here" {
      style.fill: "#444400"
      style.font-color: "#ffff88"
      style.font: mono
    }
    stack_saved: "saved_esp → [saved state lives here when process is suspended]" {
      style.fill: "#004444"
      style.font-color: "#88ffff"
      style.font: mono
    }
    stack_bot: "kernel_stack[0] (lowest addr)" {
      style.fill: "#2d2d2d"
      style.font-color: "#666666"
      style.font: mono
    }
  }

  total: "Total sizeof(process_t) = 4 + 32 + 4 + 4 + 4 + 4 + 4 + 4096 = 4152 bytes" {
    style.fill: "#1a1a1a"
    style.font-color: "#ff9944"
    style.bold: true
    style.font: mono
  }
}

cpu_state: cpu_state_t — Saved on Kernel Stack When Process is Preempted {
  style.fill: "#1a1a2e"
  style.stroke: "#44aaff"
  style.stroke-width: 2
  style.font-color: white

  note: |'md
    **Lives on the kernel stack at address `saved_esp`**
    All fields are pushed by hardware + assembly stubs.
    Read back by `popa` + `iret` on resume.
'| {
    style.fill: "#0a0a1e"
    style.font-color: "#88ccff"
  }

  segs: Segment Registers (pushed by irq_common_stub) {
    style.fill: "#2d0047"
    style.stroke: "#9b2dca"
    style.font-color: white

    gs_f:  "Offset  0 │ gs: uint32_t │ 4 B │ Saved GS register" {style.font: mono; style.fill: "#2d0047"; style.font-color: "#d0a0ff"}
    fs_f:  "Offset  4 │ fs: uint32_t │ 4 B │ Saved FS register" {style.font: mono; style.fill: "#2d0047"; style.font-color: "#d0a0ff"}
    es_f:  "Offset  8 │ es: uint32_t │ 4 B │ Saved ES register" {style.font: mono; style.fill: "#2d0047"; style.font-color: "#d0a0ff"}
    ds_f:  "Offset 12 │ ds: uint32_t │ 4 B │ Saved DS register" {style.font: mono; style.fill: "#2d0047"; style.font-color: "#d0a0ff"}
  }

  gprs: General-Purpose Registers (saved by pusha) {
    style.fill: "#002244"
    style.stroke: "#1a78c2"
    style.font-color: white

    edi_f: "Offset 16 │ edi: uint32_t │ 4 B │ pusha order: EDI first" {style.font: mono; style.fill: "#002244"; style.font-color: "#88ccff"}
    esi_f: "Offset 20 │ esi: uint32_t │ 4 B" {style.font: mono; style.fill: "#002244"; style.font-color: "#88ccff"}
    ebp_f: "Offset 24 │ ebp: uint32_t │ 4 B" {style.font: mono; style.fill: "#002244"; style.font-color: "#88ccff"}
    esp_p: "Offset 28 │ esp_pusha: uint32_t │ 4 B │ ⚠ IGNORED by popa — hardware skips restore" {style.font: mono; style.fill: "#444400"; style.font-color: "#ffff44"}
    ebx_f: "Offset 32 │ ebx: uint32_t │ 4 B" {style.font: mono; style.fill: "#002244"; style.font-color: "#88ccff"}
    edx_f: "Offset 36 │ edx: uint32_t │ 4 B" {style.font: mono; style.fill: "#002244"; style.font-color: "#88ccff"}
    ecx_f: "Offset 40 │ ecx: uint32_t │ 4 B" {style.font: mono; style.fill: "#002244"; style.font-color: "#88ccff"}
    eax_f: "Offset 44 │ eax: uint32_t │ 4 B │ pusha order: EAX last" {style.font: mono; style.fill: "#002244"; style.font-color: "#88ccff"}
  }

  stub: Stub-Pushed Fields (discarded by add esp,8) {
    style.fill: "#2d2d2d"
    style.stroke: "#666666"
    style.font-color: "#aaaaaa"

    vec_f: "Offset 48 │ vector: uint32_t │ 4 B │ IRQ vector number (e.g. 32 = IRQ0)" {style.font: mono; style.fill: "#2d2d2d"; style.font-color: "#aaaaaa"}
    err_f: "Offset 52 │ error_code: uint32_t │ 4 B │ Dummy 0 for hardware IRQs" {style.font: mono; style.fill: "#2d2d2d"; style.font-color: "#aaaaaa"}
  }

  hw: CPU-Pushed Interrupt Frame (iret consumes these) {
    style.fill: "#004400"
    style.stroke: "#00cc44"
    style.font-color: white

    eip_f:    "Offset 56 │ eip: uint32_t │ 4 B │ Return address — where process resumes" {style.font: mono; style.fill: "#004400"; style.font-color: "#88ff88"}
    cs_f:     "Offset 60 │ cs: uint32_t │ 4 B │ 0x0008 (ring-0) or 0x001B (ring-3)" {style.font: mono; style.fill: "#004400"; style.font-color: "#88ff88"}
    efl_f:    "Offset 64 │ eflags: uint32_t │ 4 B │ MUST have bit 9 (IF)=1 → 0x00000202" {style.font: mono; style.fill: "#006600"; style.font-color: "#ccffcc"}
  }

  ring3: Ring-3 Only Fields (present when cs & 3 == 3) {
    style.fill: "#440000"
    style.stroke: "#cc0000"
    style.font-color: "#ffaaaa"

    uesp_f: "Offset 68 │ user_esp: uint32_t │ 4 B │ User-mode stack pointer" {style.font: mono; style.fill: "#440000"; style.font-color: "#ffaaaa"}
    uss_f:  "Offset 72 │ user_ss: uint32_t │ 4 B │ User-mode stack segment = 0x23" {style.font: mono; style.fill: "#440000"; style.font-color: "#ffaaaa"}
    note3: "⚠ Only pushed by CPU when CPL changes (ring-3 → ring-0 transition)" {style.fill: "#330000"; style.font-color: "#ff8888"; style.italic: true}
  }

  totals: "sizeof ring-0 frame = 68 bytes | sizeof ring-3 frame = 76 bytes" {
    style.fill: "#1a1a1a"
    style.font-color: "#ff9944"
    style.bold: true
    style.font: mono
  }
}

stack_diagram: Kernel Stack Contents at Context Switch {
  style.fill: "#0a0a0a"
  style.stroke: "#555555"
  style.font-color: white

  addr_hi: "kernel_stack_top (highest address) ← TSS.ESP0" {
    style.fill: "#444400"
    style.font-color: "#ffff88"
    style.font: mono
  }
  f1: "  ← [eflags = 0x202]  iret pops last" {style.fill: "#004400"; style.font-color: "#88ff88"; style.font: mono}
  f2: "  ← [cs = 0x0008]" {style.fill: "#004400"; style.font-color: "#88ff88"; style.font: mono}
  f3: "  ← [eip = entry_func]  iret jumps here" {style.fill: "#004400"; style.font-color: "#88ff88"; style.font: mono}
  f4: "  ← [error_code = 0]  add esp,8 skips" {style.fill: "#2d2d2d"; style.font-color: "#888888"; style.font: mono}
  f5: "  ← [vector = 0]" {style.fill: "#2d2d2d"; style.font-color: "#888888"; style.font: mono}
  f6: "  ← [eax=0 .. edi=0]  popa restores (8 × 4 = 32 bytes)" {style.fill: "#002244"; style.font-color: "#88ccff"; style.font: mono}
  f7: "  ← [gs=ds=es=fs=0x10]  trampoline pops (4 × 4 = 16 bytes)" {style.fill: "#2d0047"; style.font-color: "#d0a0ff"; style.font: mono}
  f8: "  ← [irq_return_trampoline addr]  context_switch_asm 'ret' pops" {style.fill: "#663300"; style.font-color: "#ffaa44"; style.font: mono}
  saved_ptr: "  ← saved_esp points HERE (76 bytes below kernel_stack_top)" {style.fill: "#004444"; style.font-color: "#88ffff"; style.font: mono; style.bold: true}
  addr_lo: "kernel_stack[0] (lowest address)" {style.fill: "#1a1a1a"; style.font-color: "#444444"; style.font: mono}
}

pcb -> cpu_state: "saved_esp points into kernel stack where cpu_state lives" {
  style.stroke: "#44aaff"
  style.stroke-dash: 3
}
pcb -> stack_diagram: "kernel_stack[] array contains this layout" {
  style.stroke: "#888888"
  style.stroke-dash: 5
}
cpu_state -> stack_diagram: "matches this exact layout" {
  style.stroke: "#00cc44"
  style.stroke-dash: 3
}