vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right

title: |md
  ## Fabricated Initial Kernel Stack Frame
  `process_create()` builds a fake `context_switch_asm` return frame on the new kernel stack
| {near: top-center}

# ─── LEFT PANEL: process_create() Setup ───────────────────────────────────────
setup: "process_create() Setup" {
  style.fill: "#1a1a2e"
  style.stroke: "#7c3aed"
  style.stroke-width: 2
  style.border-radius: 8

  alloc: "① kmalloc(KERNEL_STACK_SIZE)" {
    style.fill: "#2d1b69"
    style.stroke: "#a78bfa"
    style.border-radius: 4
    label: |md
      proc->kernel_stack     = kmalloc(8192)
      proc->kernel_stack_top = kernel_stack + 8192
    |
  }

  compute: "② Compute initial ESP" {
    style.fill: "#1e1b4b"
    style.stroke: "#818cf8"
    style.border-radius: 4
    label: |md
      context.esp = kernel_stack_top - 24
      (6 words × 4 bytes = 24 bytes below top)
    |
  }

  eflags_note: "③ EFLAGS = 0x00000202" {
    style.fill: "#14532d"
    style.stroke: "#4ade80"
    style.border-radius: 4
    label: |md
      Bit 9 (IF) = **1** → interrupts enabled on first run  
      Bit 1       = **1** → always-set reserved bit
    |
  }
  alloc -> compute -> eflags_note
}

# ─── CENTER PANEL: Stack Memory Layout ────────────────────────────────────────
stack_layout: "Kernel Stack Buffer (8 KB, from kmalloc)" {
  style.fill: "#0f172a"
  style.stroke: "#94a3b8"
  style.stroke-width: 2
  style.border-radius: 8

  kst_label: "kernel_stack_top  (ESP = kernel_stack + 8192)" {
    style.fill: "#1e293b"
    style.stroke: "#64748b"
    style.stroke-dash: 4
    style.border-radius: 3
    label: "▼ stack grows downward from here"
  }

  row0: "[ top - 4  ]  +0x00 from context.esp + 20" {
    style.fill: "#365314"
    style.stroke: "#84cc16"
    style.stroke-width: 2
    style.border-radius: 3
    label: |md
      **EFLAGS = 0x00000202**  ← `pushfd` / `popfd`  
      IF=1  reserved=1
    |
  }

  row1: "[ top - 8  ]  +0x04 from context.esp + 16" {
    style.fill: "#1e3a5f"
    style.stroke: "#60a5fa"
    style.border-radius: 3
    label: |md
      **EBP = 0x00000000**  ← `push ebp` / `pop ebp`
    |
  }

  row2: "[ top - 12 ]  +0x08 from context.esp + 12" {
    style.fill: "#1e3a5f"
    style.stroke: "#60a5fa"
    style.border-radius: 3
    label: |md
      **EDI = 0x00000000**
    |
  }

  row3: "[ top - 16 ]  +0x0C from context.esp + 8" {
    style.fill: "#1e3a5f"
    style.stroke: "#60a5fa"
    style.border-radius: 3
    label: |md
      **ESI = 0x00000000**
    |
  }

  row4: "[ top - 20 ]  +0x10 from context.esp + 4" {
    style.fill: "#1e3a5f"
    style.stroke: "#60a5fa"
    style.border-radius: 3
    label: |md
      **EBX = 0x00000000**
    |
  }

  row5: "[ top - 24 ]  ← context.esp  (offset 0)" {
    style.fill: "#4c1d95"
    style.stroke: "#c084fc"
    style.stroke-width: 3
    style.border-radius: 3
    label: |md
      **EIP = entry_point**  ← `call` / `ret` target
    |
  }

  unused: "[ top - 25 … kernel_stack + 0 ]" {
    style.fill: "#1c1917"
    style.stroke: "#44403c"
    style.stroke-dash: 3
    style.border-radius: 3
    label: "unused / zero-filled"
  }

  kst_label -> row0: {
    style.stroke: "#94a3b8"
    style.stroke-dash: 4
  }
  row0 -> row1
  row1 -> row2
  row2 -> row3
  row3 -> row4
  row4 -> row5: {
    style.stroke: "#c084fc"
    style.stroke-width: 2
  }
  row5 -> unused: {
    style.stroke: "#44403c"
    style.stroke-dash: 3
  }
}

# ─── RIGHT PANEL: context_switch_asm Restore Path ─────────────────────────────
restore: "context_switch_asm Restore Path" {
  style.fill: "#1a0a0a"
  style.stroke: "#f87171"
  style.stroke-width: 2
  style.border-radius: 8

  s1: "① mov esp, [new_ctx->esp]" {
    style.fill: "#450a0a"
    style.stroke: "#f87171"
    style.border-radius: 3
    label: |md
      `ESP ← context.esp`  
      Now on new process's stack
    |
  }

  s2: "② popfd" {
    style.fill: "#365314"
    style.stroke: "#84cc16"
    style.border-radius: 3
    label: |md
      Pops `0x00000202` → EFLAGS  
      **IF bit set → interrupts RE-ENABLED**
    |
  }

  s3: "③ pop ebp" {
    style.fill: "#1e3a5f"
    style.stroke: "#60a5fa"
    style.border-radius: 3
    label: "Pops 0 → EBP"
  }

  s4: "④ pop edi" {
    style.fill: "#1e3a5f"
    style.stroke: "#60a5fa"
    style.border-radius: 3
    label: "Pops 0 → EDI"
  }

  s5: "⑤ pop esi" {
    style.fill: "#1e3a5f"
    style.stroke: "#60a5fa"
    style.border-radius: 3
    label: "Pops 0 → ESI"
  }

  s6: "⑥ pop ebx" {
    style.fill: "#1e3a5f"
    style.stroke: "#60a5fa"
    style.border-radius: 3
    label: "Pops 0 → EBX"
  }

  s7: "⑦ ret" {
    style.fill: "#4c1d95"
    style.stroke: "#c084fc"
    style.stroke-width: 3
    style.border-radius: 3
    label: |md
      Pops **entry_point** → EIP  
      **Process begins executing!**
    |
  }

  s8: "⑧ Process entry_point()" {
    style.fill: "#172554"
    style.stroke: "#38bdf8"
    style.stroke-width: 2
    style.border-radius: 3
    label: "Process runs as if resumed"
  }
  s1 -> s2 -> s3 -> s4 -> s5 -> s6 -> s7 -> s8
}

# ─── BOTTOM PANEL: Real vs Fabricated Comparison ──────────────────────────────
comparison: "Real Saved Frame vs Fabricated Frame" {
  style.fill: "#0c0a09"
  style.stroke: "#d97706"
  style.stroke-width: 2
  style.border-radius: 8

  real: "Real Frame (Preempted)" {
    style.fill: "#1c1410"
    style.stroke: "#f59e0b"
    style.border-radius: 4
    label: ||md
      | Offset | Content | Set By |
      | --- | --- | --- |
      | context.esp + 0  | **EFLAGS** | `context_switch_asm` |
      | context.esp + 4  | **EBP** | `context_switch_asm` |
      | context.esp + 8  | **EDI** | `context_switch_asm` |
      | context.esp + 12 | **ESI** | `context_switch_asm` |
      | context.esp + 16 | **EBX** | `context_switch_asm` |
      | context.esp + 20 | **EIP** | CPU via `call` |
    ||
  }

  fabricated: "Fabricated Frame (Created)" {
    style.fill: "#1c1410"
    style.stroke: "#fb923c"
    style.border-radius: 4
    label: ||md
      | Offset | Content | Set By |
      | --- | --- | --- |
      | context.esp + 0  | **0x00000202** | `process_create` |
      | context.esp + 4  | **0x00000000** | `process_create` |
      | context.esp + 8  | **0x00000000** | `process_create` |
      | context.esp + 12 | **0x00000000** | `process_create` |
      | context.esp + 16 | **0x00000000** | `process_create` |
      | context.esp + 20 | **entry_point** | `process_create` |
    ||
  }

  verdict: "⚠ Logic is structurally identical" {
    style.fill: "#1c0a0a"
    style.stroke: "#f87171"
    style.stroke-width: 2
    style.border-radius: 4
    label: |md
      The restore path is identical.  
      **IF=1 in fabricated EFLAGS is mandatory** — otherwise the first process  
      runs with interrupts disabled forever.
    |
  }
  real -> fabricated -> verdict
}

# ─── CONNECTIONS ──────────────────────────────────────────────────────────────
setup -> stack_layout: "builds frame at top − 24" {
  style.stroke: "#a78bfa"
  style.stroke-width: 2
}
stack_layout -> restore: "restores from context.esp" {
  style.stroke: "#f87171"
  style.stroke-width: 2
}
stack_layout -> comparison: "layout comparison" {
  style.stroke: "#d97706"
  style.stroke-dash: 3
}