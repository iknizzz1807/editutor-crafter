vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

title: |md
  ## User Process Memory Isolation: Per-Process Page Directories
  **x86 32-bit Protected Mode â€” Mod-4 Process Isolation Architecture**
| {near: top-center}

legend: |md
  **Colors:** ðŸŸ£ Header/CR3 Â· ðŸ”µ Kernel Pages Â· ðŸŸ¢ User Pages Â· â¬œ Not Present Â· ðŸŸ  PD Pointers
| {near: bottom-center}

# â”€â”€â”€ PHYSICAL MEMORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

phys: Physical Memory {
  style.fill: "#1a1a2e"
  style.font-color: white
  style.stroke: "#4a4a8a"
  style.stroke-width: 2

  p_ivt: "0x00000000  IVT / BIOS Data" {
    style.fill: "#6b2d6b"
    style.font-color: white
    style.font-size: 12
  }
  p_vga: "0x000B8000  VGA Text Buffer" {
    style.fill: "#2d4a6b"
    style.font-color: white
    style.font-size: 12
  }
  p_kernel: "0x00100000  Kernel Code+Data+BSS" {
    style.fill: "#1a4a7a"
    style.font-color: white
    style.font-size: 12
    style.stroke: "#5a8aff"
    style.stroke-width: 2
  }
  p_bitmap: "0x00200000  PMM Bitmap (128KB)" {
    style.fill: "#2d2d6b"
    style.font-color: "#aaaaff"
    style.font-size: 12
  }
  p_boot_pd: "0x00280000  boot_page_directory" {
    style.fill: "#7a3a00"
    style.font-color: "#ffbb44"
    style.font-size: 12
    style.stroke: "#ff8800"
    style.stroke-width: 2
  }
  p_idt_pt: "0x00281000  identity_page_table" {
    style.fill: "#7a3a00"
    style.font-color: "#ffbb44"
    style.font-size: 12
  }
  p_kpt: "0x00282000  kernel_page_table" {
    style.fill: "#7a3a00"
    style.font-color: "#ffbb44"
    style.font-size: 12
  }
  p_proc_table: "0x00300000  process_table[16] (64KB)" {
    style.fill: "#004a00"
    style.font-color: "#88ff88"
    style.font-size: 12
    style.stroke: "#00aa00"
    style.stroke-width: 2
  }
  p_heap: "0x00400000  Kernel Heap (grows up)" {
    style.fill: "#1a3a1a"
    style.font-color: "#66aa66"
    style.font-size: 12
  }
  p_user_pd_a: "0x00500000  User PD (Process A)" {
    style.fill: "#7a5500"
    style.font-color: "#ffdd77"
    style.font-size: 12
    style.stroke: "#ffaa00"
    style.stroke-width: 2
  }
  p_user_code_a: "0x00501000  User Code Frame A (4KB)" {
    style.fill: "#2a4a00"
    style.font-color: "#aaffaa"
    style.font-size: 12
  }
  p_user_stack_a: "0x00502000  User Stack Frame A (4KB)" {
    style.fill: "#2a4a00"
    style.font-color: "#aaffaa"
    style.font-size: 12
  }
  p_user_pd_b: "0x00503000  User PD (Process B)" {
    style.fill: "#7a5500"
    style.font-color: "#ffdd77"
    style.font-size: 12
    style.stroke: "#ffaa00"
    style.stroke-width: 2
  }
  p_user_code_b: "0x00504000  User Code Frame B (4KB)" {
    style.fill: "#2a4a00"
    style.font-color: "#aaffaa"
    style.font-size: 12
  }
  p_user_stack_b: "0x00505000  User Stack Frame B (4KB)" {
    style.fill: "#2a4a00"
    style.font-color: "#aaffaa"
    style.font-size: 12
  }
}

# â”€â”€â”€ BOOT PAGE DIRECTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

boot_pd: boot_page_directory\n(shared by all kernel processes) {
  style.fill: "#3d2000"
  style.font-color: "#ffaa44"
  style.stroke: "#ff8800"
  style.stroke-width: 3

  bpd_0: "PD[0]   â†’ identity_page_table\n(Virtual 0x00000000â€“0x003FFFFF)" {
    style.fill: "#7a3a00"
    style.font-color: "#ffcc88"
    style.font-size: 12
  }
  bpd_768: "PD[768] â†’ kernel_page_table\n(Virtual 0xC0000000â€“0xC03FFFFF)" {
    style.fill: "#7a3a00"
    style.font-color: "#ffcc88"
    style.font-size: 12
  }
  bpd_rest: "PD[1-767, 769-1023] = 0\n(Not Present)" {
    style.fill: "#333333"
    style.font-color: "#888888"
    style.font-size: 12
    style.stroke-dash: 5
  }
}

# â”€â”€â”€ USER PAGE DIRECTORY A â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

upd_a: User PD â€” Process A {
  style.fill: "#2d1a00"
  style.font-color: "#ffdd77"
  style.stroke: "#ffaa00"
  style.stroke-width: 3

  ua_1: "PD[1]   â†’ user_page_table_A\n(Virtual 0x00400000â€“0x00BFFFFF)" {
    style.fill: "#4a3000"
    style.font-color: "#ffcc77"
    style.font-size: 12
  }
  ua_768: "PD[768] = boot_pd[768]\n(kernel_page_table, U/S=0)" {
    style.fill: "#3a2800"
    style.font-color: "#cc9944"
    style.font-size: 12
    style.stroke: "#cc7700"
    style.stroke-dash: 3
  }
  ua_rest: "PD[0, 2-767, 769-1023] = 0\n(Not Present)" {
    style.fill: "#333333"
    style.font-color: "#888888"
    style.font-size: 12
    style.stroke-dash: 5
  }
}

user_pt_a: user_page_table_A {
  style.fill: "#1a2800"
  style.font-color: "#88ff88"
  style.stroke: "#44aa44"
  style.stroke-width: 2

  upa_code: "PT[0]  0x00400000 â†’ phys 0x00501000\nFlags: P|USER  (read-only)" {
    style.fill: "#1a3a00"
    style.font-color: "#aaffaa"
    style.font-size: 12
  }
  upa_stack: "PT[0x3FF] 0x00BFF000 â†’ phys 0x00502000\nFlags: P|W|USER" {
    style.fill: "#1a3a00"
    style.font-color: "#aaffaa"
    style.font-size: 12
  }
}

# â”€â”€â”€ USER PAGE DIRECTORY B â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

upd_b: User PD â€” Process B {
  style.fill: "#2d1a00"
  style.font-color: "#ffdd77"
  style.stroke: "#ffaa00"
  style.stroke-width: 3

  ub_1: "PD[1]   â†’ user_page_table_B\n(Virtual 0x00400000â€“0x00BFFFFF)" {
    style.fill: "#4a3000"
    style.font-color: "#ffcc77"
    style.font-size: 12
  }
  ub_768: "PD[768] = boot_pd[768]\n(kernel_page_table, U/S=0)" {
    style.fill: "#3a2800"
    style.font-color: "#cc9944"
    style.font-size: 12
    style.stroke: "#cc7700"
    style.stroke-dash: 3
  }
  ub_rest: "PD[0, 2-767, 769-1023] = 0\n(Not Present)" {
    style.fill: "#333333"
    style.font-color: "#888888"
    style.font-size: 12
    style.stroke-dash: 5
  }
}

user_pt_b: user_page_table_B {
  style.fill: "#1a2800"
  style.font-color: "#88ff88"
  style.stroke: "#44aa44"
  style.stroke-width: 2

  upb_code: "PT[0]  0x00400000 â†’ phys 0x00504000\nFlags: P|USER  (read-only)" {
    style.fill: "#1a3a00"
    style.font-color: "#aaffaa"
    style.font-size: 12
  }
  upb_stack: "PT[0x3FF] 0x00BFF000 â†’ phys 0x00505000\nFlags: P|W|USER" {
    style.fill: "#1a3a00"
    style.font-color: "#aaffaa"
    style.font-size: 12
  }
}

# â”€â”€â”€ CPU STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cpu_a: CPU State â€” Running Process A {
  style.fill: "#001a3a"
  style.font-color: "#88bbff"
  style.stroke: "#4488ff"
  style.stroke-width: 3

  cr3_a: "CR3 = 0x00500000\n(phys addr of User PD A)" {
    style.fill: "#002a5a"
    style.font-color: "#aaccff"
    style.font-size: 13
    style.bold: true
    style.stroke: "#4488ff"
    style.stroke-width: 2
  }
  cs_a: "CS  = 0x001B  (DPL=3, ring 3)\nEIP = 0x00400000 (user code)" {
    style.fill: "#1a1a4a"
    style.font-color: "#8899ff"
    style.font-size: 12
  }
  esp_a: "ESP = 0x00BFFFFC (user stack)" {
    style.fill: "#1a1a4a"
    style.font-color: "#8899ff"
    style.font-size: 12
  }
}

cpu_b: CPU State â€” Running Process B {
  style.fill: "#001a3a"
  style.font-color: "#88bbff"
  style.stroke: "#4488ff"
  style.stroke-width: 3

  cr3_b: "CR3 = 0x00503000\n(phys addr of User PD B)" {
    style.fill: "#002a5a"
    style.font-color: "#aaccff"
    style.font-size: 13
    style.bold: true
    style.stroke: "#4488ff"
    style.stroke-width: 2
  }
  cs_b: "CS  = 0x001B  (DPL=3, ring 3)\nEIP = 0x00400000 (user code)" {
    style.fill: "#1a1a4a"
    style.font-color: "#8899ff"
    style.font-size: 12
  }
  esp_b: "ESP = 0x00BFFFFC (user stack)" {
    style.fill: "#1a1a4a"
    style.font-color: "#8899ff"
    style.font-size: 12
  }
}

# â”€â”€â”€ PAGE FAULT GUARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

isolation: |md
  **Hardware Isolation Enforcement**

  - `0x00400000` (A) â†’ physical `0x501000` (A's code)
  - `0x00400000` (B) â†’ physical `0x504000` (B's code)
  - **Same virtual address â†’ different physical frames**
  - `0xC0000000` kernel pages have **U/S = 0**
  - User CPL=3 access to kernel â†’ **#PF error code P=1,U=1**
| {
  style.fill: "#1a001a"
  style.font-color: "#ffaaff"
  style.stroke: "#aa44aa"
  style.stroke-width: 2
  near: bottom-right
}

# â”€â”€â”€ CONNECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# CPU A â†’ User PD A (via CR3)
cpu_a.cr3_a -> upd_a: "CR3 load on\ncontext switch" {
  style.stroke: "#ff8800"
  style.stroke-width: 3
  style.font-color: "#ff8800"
  style.bold: true
}

# CPU B â†’ User PD B (via CR3)
cpu_b.cr3_b -> upd_b: "CR3 load on\ncontext switch" {
  style.stroke: "#ff8800"
  style.stroke-width: 3
  style.font-color: "#ff8800"
  style.bold: true
}

# User PD A â†’ user_page_table_A
upd_a.ua_1 -> user_pt_a: "PDE frame addr\n0x00506000" {
  style.stroke: "#ffaa44"
  style.stroke-width: 2
  style.font-color: "#ffaa44"
}

# User PD B â†’ user_page_table_B
upd_b.ub_1 -> user_pt_b: "PDE frame addr\n0x00507000" {
  style.stroke: "#ffaa44"
  style.stroke-width: 2
  style.font-color: "#ffaa44"
}

# user_page_table_A â†’ physical frames
user_pt_a.upa_code -> phys.p_user_code_a: "PTE â†’ phys 0x00501000" {
  style.stroke: "#44cc44"
  style.stroke-width: 2
  style.font-color: "#44cc44"
}
user_pt_a.upa_stack -> phys.p_user_stack_a: "PTE â†’ phys 0x00502000" {
  style.stroke: "#44cc44"
  style.stroke-width: 2
  style.font-color: "#44cc44"
}

# user_page_table_B â†’ physical frames
user_pt_b.upb_code -> phys.p_user_code_b: "PTE â†’ phys 0x00504000" {
  style.stroke: "#44cc44"
  style.stroke-width: 2
  style.font-color: "#44cc44"
}
user_pt_b.upb_stack -> phys.p_user_stack_b: "PTE â†’ phys 0x00505000" {
  style.stroke: "#44cc44"
  style.stroke-width: 2
  style.font-color: "#44cc44"
}

# User PD A/B kernel entries â†’ boot_pd kernel page table (shared)
upd_a.ua_768 -> boot_pd.bpd_768: "Copy of PDE[768]\n(inherited, U/S=0)" {
  style.stroke: "#cc6600"
  style.stroke-width: 2
  style.stroke-dash: 4
  style.font-color: "#cc8833"
}
upd_b.ub_768 -> boot_pd.bpd_768: "Copy of PDE[768]\n(inherited, U/S=0)" {
  style.stroke: "#cc6600"
  style.stroke-width: 2
  style.stroke-dash: 4
  style.font-color: "#cc8833"
}

# boot_pd â†’ physical page directory
boot_pd.bpd_768 -> phys.p_kpt: "PDE â†’ phys" {
  style.stroke: "#ff8833"
  style.stroke-width: 2
  style.font-color: "#ff8833"
}
boot_pd.bpd_0 -> phys.p_idt_pt: "PDE â†’ phys" {
  style.stroke: "#ff8833"
  style.stroke-width: 2
  style.font-color: "#ff8833"
}

# User PDs in physical memory
upd_a -> phys.p_user_pd_a: "lives at" {
  style.stroke: "#888888"
  style.stroke-dash: 3
  style.font-color: "#888888"
}
upd_b -> phys.p_user_pd_b: "lives at" {
  style.stroke: "#888888"
  style.stroke-dash: 3
  style.font-color: "#888888"
}