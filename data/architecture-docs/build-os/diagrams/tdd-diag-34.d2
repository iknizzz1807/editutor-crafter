vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right

title: |md
  ## TSS ESP0 Update Requirement — Correct vs Incorrect Sequence
  *The time-distance between cause (missed update) and effect (crash)*
| {near: top-center}

correct: "✓ CORRECT — TSS.ESP0 Updated Before Stack Swap" {
  style: {
    fill: "#1a2e1a"
    stroke: "#00CC44"
    stroke-width: 2
    border-radius: 8
  }
  shape: sequence_diagram
  
  sched_c: "context_switch()" {shape: rectangle}
  tss_c: "kernel_tss.esp0" {shape: rectangle}
  asm_c: "context_switch_asm" {shape: rectangle}
  new_c: "new_proc (ring 3)" {shape: rectangle}
  cpu_c: "CPU / PIC" {shape: rectangle}
  isr_c: "isr_common_stub" {shape: rectangle}
  
  step1c: "① timer IRQ fires → scheduler_tick() called" {
    style.font-color: "#AAAAAA"
  }
  sched_c -> tss_c: "tss_set_kernel_stack(\nnew_proc->kernel_stack_top)" {
    style.stroke: "#00CC44"
    style.stroke-width: 2
  }
  tss_c -> sched_c: "esp0 = 0xC0412000  ✓" {
    style.stroke: "#00CC44"
    style.stroke-dash: 4
  }
  sched_c -> sched_c: "CR3 ← new_proc->page_directory" {
    style.stroke: "#44AAFF"
  }
  sched_c -> asm_c: "context_switch_asm(\n&old->ctx, &new->ctx)" {
    style.stroke: "#FFFFFF"
  }
  asm_c -> asm_c: "push EBX/ESI/EDI/EBP/EFLAGS\nmov old->ctx.esp, ESP" {
    style.stroke: "#888888"
  }
  asm_c -> asm_c: "mov ESP, new->ctx.esp\npopfd/pop.../ret → entry_fn" {
    style.stroke: "#FF8844"
    style.bold: true
  }
  asm_c -> new_c: "execution resumes at ring-3 entry" {
    style.stroke: "#FFAA00"
    style.stroke-width: 2
  }
  step2c: "② 10 ms later: PIT fires IRQ0" {
    style.font-color: "#AAAAAA"
  }
  cpu_c -> cpu_c: "read TSS.esp0 → 0xC0412000\n(new_proc kernel stack top)" {
    style.stroke: "#00CC44"
    style.bold: true
  }
  cpu_c -> isr_c: "push SS/ESP/EFLAGS/CS/EIP\nonto new_proc kernel stack ✓" {
    style.stroke: "#00CC44"
    style.stroke-width: 2
  }
  isr_c -> isr_c: "pusha, save segs\ncall interrupt_dispatch\n→ scheduler_tick()" {
    style.stroke: "#FFFFFF"
  }
  isr_c -> new_c: "iretd → new_proc continues\ncorrectly" {
    style.stroke: "#00CC44"
    style.stroke-dash: 4
  }
  
  ok: |md
    **Result:** Interrupt frame lands on
    new_proc's kernel stack.
    System stable. ✓
  | {
    style.font-color: "#00CC44"
  }
}

incorrect: "✗ INCORRECT — TSS.ESP0 NOT Updated" {
  style: {
    fill: "#2e1a1a"
    stroke: "#CC2200"
    stroke-width: 2
    border-radius: 8
  }
  shape: sequence_diagram
  
  sched_i: "context_switch()" {shape: rectangle}
  tss_i: "kernel_tss.esp0" {shape: rectangle}
  asm_i: "context_switch_asm" {shape: rectangle}
  new_i: "new_proc (ring 3)" {shape: rectangle}
  cpu_i: "CPU / PIC" {shape: rectangle}
  old_stk: "OLD proc kernel stack" {shape: rectangle}
  
  step1i: "① timer IRQ fires → scheduler_tick() called" {
    style.font-color: "#AAAAAA"
  }
  sched_i -> sched_i: "❌ tss_set_kernel_stack()\nNOT CALLED" {
    style.stroke: "#CC2200"
    style.stroke-width: 2
    style.bold: true
  }
  tss_i -> tss_i: "esp0 = 0xC0402000\n(STALE — old_proc stack top)" {
    style.stroke: "#CC2200"
    style.stroke-dash: 4
    style.italic: true
  }
  sched_i -> asm_i: "context_switch_asm(\n&old->ctx, &new->ctx)" {
    style.stroke: "#FFFFFF"
  }
  asm_i -> asm_i: "push/save old context\nmov ESP, new->ctx.esp\nret → new_proc entry_fn" {
    style.stroke: "#FF8844"
  }
  asm_i -> new_i: "new_proc runs at ring 3" {
    style.stroke: "#FFAA00"
  }
  step2i: "② 10 ms later: PIT fires IRQ0" {
    style.font-color: "#AAAAAA"
  }
  cpu_i -> cpu_i: "read TSS.esp0 → 0xC0402000\n⚠ STALE: old_proc stack top" {
    style.stroke: "#CC2200"
    style.bold: true
  }
  cpu_i -> old_stk: "push SS/ESP/EFLAGS/CS/EIP\nonto OLD proc's kernel stack ✗" {
    style.stroke: "#CC2200"
    style.stroke-width: 3
    style.bold: true
  }
  old_stk -> old_stk: "Frame clobbers data\nalready on old_proc's stack\n(saved regs, local vars)" {
    style.stroke: "#FF4400"
    style.stroke-dash: 3
  }
  step3i: "③ ISR runs, eventually iretd back to new_proc" {
    style.font-color: "#AAAAAA"
  }
  step4i: "④ Later: old_proc rescheduled" {
    style.font-color: "#AAAAAA"
  }
  old_stk -> old_stk: "context_switch_asm restores\nold_proc context from\ncorrupted stack" {
    style.stroke: "#FF4400"
  }
  old_stk -> old_stk: "popfd/pop.../ret pops\nGARBAGE return address\n(overwritten by IRQ frame)" {
    style.stroke: "#FF0000"
    style.stroke-width: 3
    style.bold: true
  }
  
  crash: |md
    **CRASH — hours or instructions later**
    EIP = garbage → wild jump → #GP or #PF
    Root cause: missed TSS update in step ①
    Symptom appears in completely unrelated code
  | {
    style.font-color: "#FF4444"
  }
}

correct -> incorrect: |md
  **Time gap:**
  cause ① → effect ④
  may span thousands
  of timer ticks
| {
  style.stroke: "#888888"
  style.stroke-dash: 5
  style.font-color: "#AAAAAA"
}