vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

title: |'md
  ## Module Architecture: Process, Scheduler, TSS, and Syscall Components
  *mod-4: Processes and Preemptive Scheduling*
'| {near: top-right-center}

# ── Hardware Layer ──────────────────────────────────────────────────────────────
hw: "Hardware" {
  style.fill: "#1a1a2e"
  style.font-color: white
  style.stroke: "#4a4a8a"
  style.border-radius: 8

  cpu: "x86 CPU" {
    style.fill: "#16213e"
    style.font-color: "#e0e0ff"
    style.stroke: "#6060cc"

    cr3: "CR3 Register\n[phys addr of PD]" {
      style.fill: "#2d1b69"
      style.font-color: "#c8b8ff"
      style.font-size: 12
    }
    tr: "TR (Task Register)\n[TSS selector 0x28]" {
      style.fill: "#2d1b69"
      style.font-color: "#c8b8ff"
      style.font-size: 12
    }
    eflags: "EFLAGS.IF" {
      style.fill: "#2d1b69"
      style.font-color: "#c8b8ff"
      style.font-size: 12
    }
    idt_reg: "IDTR" {
      style.fill: "#2d1b69"
      style.font-color: "#c8b8ff"
      style.font-size: 12
    }
  }

  pic: "8259 PIC\nIRQ0 → vector 32" {
    style.fill: "#1a3a1a"
    style.font-color: "#90ff90"
    style.stroke: "#40a040"
    style.font-size: 12
  }

  pit: "PIT 8254\n100Hz → IRQ0" {
    style.fill: "#1a3a1a"
    style.font-color: "#90ff90"
    style.stroke: "#40a040"
    style.font-size: 12
  }

  pit -> pic: "IRQ0 pulse\n~10ms" {
    style.stroke: "#60c060"
    style.font-size: 11
  }
  pic -> cpu: "INTR signal\n[vector 32]" {
    style.stroke: "#60c060"
    style.font-size: 11
  }
}

# ── GDT / TSS ───────────────────────────────────────────────────────────────────
gdt_group: "GDT + TSS (mod-4 extends GDT to 6 entries)" {
  style.fill: "#2d1a00"
  style.font-color: "#ffcc80"
  style.stroke: "#cc8800"
  style.border-radius: 6

  gdt: "GDT Array\ngdt[0..5]" {
    shape: sql_table
    style.fill: "#3d2a00"
    style.stroke: "#cc8800"
    "0x00": "Null descriptor"
    "0x08": "Kernel Code DPL=0"
    "0x10": "Kernel Data DPL=0"
    "0x18": "User Code   DPL=3"
    "0x20": "User Data   DPL=3"
    "0x28": "TSS  access=0x89 ← NEW"
  }

  tss_struct: "tss_t (104 bytes, packed)" {
    shape: sql_table
    style.fill: "#2d1a00"
    style.stroke: "#ffaa00"
    "+0  prev_tss": "uint32 (unused)"
    "+4  esp0 ★": "uint32 ← tss_set_kernel_stack()"
    "+8  ss0": "uint32 = 0x10 (kernel data)"
    "+12 esp1..ss2": "uint32 × 4 (unused)"
    "+28 cr3..edi": "uint32 × 13 (unused)"
    "+100 debug_trap": "uint16"
    "+102 iomap_base": "uint16 = sizeof(tss_t)"
  }

  tss_init: "tss_init()" {
    style.fill: "#4d3000"
    style.font-color: "#ffcc80"
    style.font-size: 12
  }

  tss_set: "tss_set_kernel_stack(esp0)" {
    style.fill: "#4d3000"
    style.font-color: "#ffcc80"
    style.font-size: 12
  }

  tss_init -> gdt: "gdt_install_tss(5,...)\ngdt_flush()\nltr 0x28" {
    style.stroke: "#ffaa00"
    style.font-size: 11
  }
  tss_init -> tss_struct: "memset + configure\nss0=0x10, iomap=104" {
    style.stroke: "#ffaa00"
    style.font-size: 11
  }
  tss_set -> tss_struct: "kernel_tss.esp0 = esp0\n[single store]" {
    style.stroke: "#ff8800"
    style.stroke-width: 2
    style.font-size: 11
  }
}

# ── IDT / Interrupt Entry ────────────────────────────────────────────────────────
idt_group: "IDT & Interrupt Entry Stubs (mod-2 + mod-4 additions)" {
  style.fill: "#1a001a"
  style.font-color: "#ff80ff"
  style.stroke: "#aa00aa"
  style.border-radius: 6

  idt_table: "IDT[256]" {
    shape: sql_table
    style.fill: "#2d002d"
    style.stroke: "#aa00aa"
    "vec 0-31": "CPU exceptions (trap gates, DPL=0)"
    "vec 32   ★": "IRQ0 Timer → irq0 stub (intr gate)"
    "vec 33   ★": "IRQ1 KB → irq1 stub (intr gate)"
    "vec 0x80 ★": "INT 0x80 syscall (DPL=3 TRAP gate) ← NEW"
    "vec 34-47": "IRQ2-15 stubs (intr gates)"
    "vec 48-255": "default_isr stubs"
  }

  irq_stubs: "irq_common_stub\n(irq_stubs.asm)" {
    style.fill: "#3d003d"
    style.font-color: "#ff80ff"
    style.font-size: 12
    style.border-radius: 4
  }

  trampoline: "irq_return_trampoline\n(context_switch.asm) ← NEW" {
    style.fill: "#5a005a"
    style.font-color: "#ffaaff"
    style.stroke: "#ff00ff"
    style.stroke-width: 2
    style.font-size: 12
  }

  isr128: "isr128 stub\n(trap gate, no cli) ← NEW" {
    style.fill: "#3d003d"
    style.font-color: "#ff80ff"
    style.font-size: 12
  }

  irq_stubs -> trampoline: "new process:\nret → here\n[pop segs+popa+iret]" {
    style.stroke: "#ff00ff"
    style.stroke-dash: 4
    style.font-size: 11
  }

  trampoline_body: |'md
    **irq_return_trampoline body:**
    
    pop eax; mov ds, ax
    pop eax; mov es, ax
    pop eax; mov fs, ax
    pop eax; mov gs, ax
    popa
    add esp, 8
    iret
'| {
    style.fill: "#2a002a"
    style.font-color: "#dd88dd"
    style.font-size: 11
    near: top-righte
  }
}

# ── PCB / Process Table ──────────────────────────────────────────────────────────
pcb_group: "Process Control Block (process_t)" {
  style.fill: "#001a2d"
  style.font-color: "#80ccff"
  style.stroke: "#0066cc"
  style.border-radius: 6

  pcb_struct: "process_t (≈4152 bytes each)" {
    shape: sql_table
    style.fill: "#001a3d"
    style.stroke: "#0088ff"
    "+0  pid": "uint32"
    "+4  name[32]": "char[32]"
    "+36 state": "process_state_t"
    "+40 ticks_remaining": "uint32"
    "+44 saved_esp ★": "uint32 ← context_switch_asm saves here"
    "+48 page_directory": "pde_t * (physical addr)"
    "+52 kernel_stack_top": "uint32 = stack+4096"
    "+56 kernel_stack[4096]": "uint8[4096] aligned(16)"
  }

  process_table: "process_table[16]" {
    style.fill: "#001030"
    style.font-color: "#80ccff"
    style.font-size: 12
  }

  current_proc: "current_process\n(global ptr)" {
    style.fill: "#002050"
    style.font-color: "#00aaff"
    style.stroke: "#0066ff"
    style.stroke-width: 2
    style.font-size: 12
  }

  states: |'md
    **process_state_t:**
    - UNUSED = 0
    - READY = 1
    - RUNNING = 2
    - BLOCKED = 3
    - ZOMBIE = 4
'| {
    style.fill: "#001020"
    style.font-color: "#6699cc"
    style.font-size: 11
  }

  process_table -> pcb_struct: "16 slots × 4152B\n= 66,432B in .bss" {
    style.stroke: "#0066cc"
    style.font-size: 11
  }
  current_proc -> process_table: "indexes into" {
    style.stroke: "#0088ff"
    style.stroke-dash: 3
    style.font-size: 11
  }
}

# ── Stack Frame Layout ───────────────────────────────────────────────────────────
stack_frame: "Kernel Stack Frame Layout (per process)" {
  style.fill: "#001a00"
  style.font-color: "#80ff80"
  style.stroke: "#008800"
  style.border-radius: 6

  frame_new: "Fake Initial Frame (process_create_*)" {
    shape: sql_table
    style.fill: "#002800"
    style.stroke: "#00aa00"
    "↓ HIGH (kernel_stack_top)": "—"
    "[user_ss = 0x23]": "ring-3 only"
    "[user_esp = 0xC00000]": "ring-3 only"
    "eflags = 0x202 ★": "IF=1 MANDATORY"
    "cs = 0x1B / 0x08": "ring-3 / ring-0"
    "eip = entry_func": "process entry point"
    "error_code = 0": "dummy"
    "vector = 0": "dummy"
    "eax..edi = 0": "pusha frame (8 words)"
    "ds=es=fs=gs=0x10": "segment regs (4 words)"
    "irq_return_trampoline ★": "← saved_esp points here"
    "↑ LOW (saved_esp)": "—"
  }

  frame_preempted: "Preempted Frame (irq_common_stub)" {
    shape: sql_table
    style.fill: "#002800"
    style.stroke: "#00cc00"
    "↓ HIGH": "—"
    "[user_ss, user_esp]": "if from ring-3"
    "eflags, cs, eip": "CPU-pushed"
    "error_code, vector": "stub-pushed"
    "eax..edi": "pusha frame"
    "ds,es,fs,gs": "segment saves"
    "retaddr→sched_schedule": "call context_switch_asm"
    "↑ LOW (saved_esp)": "—"
  }
}

# ── Scheduler ───────────────────────────────────────────────────────────────────
sched_group: "Scheduler (sched.c)" {
  style.fill: "#1a1a00"
  style.font-color: "#ffff80"
  style.stroke: "#888800"
  style.border-radius: 6

  sched_init: "sched_init()" {
    style.fill: "#2a2a00"
    style.font-color: "#ffff80"
    style.font-size: 12
  }

  sched_tick: "sched_timer_irq(frame)" {
    style.fill: "#2a2a00"
    style.font-color: "#ffff80"
    style.font-size: 12
  }

  sched_sched: "sched_schedule()" {
    style.fill: "#3a3a00"
    style.font-color: "#ffff00"
    style.stroke: "#aaaa00"
    style.stroke-width: 2
    style.font-size: 12
  }

  ctx_asm: "context_switch_asm(\n  old_esp_ptr,\n  new_esp,\n  new_cr3\n) ← NASM" {
    style.fill: "#4a4a00"
    style.font-color: "#ffff00"
    style.stroke: "#ffff00"
    style.stroke-width: 2
    style.font-size: 12
  }

  ctx_body: |'md
    **context_switch_asm body:**
    nasm
    mov eax, [esp+4]  ; old_esp_ptr
    mov ecx, [esp+8]  ; new_esp
    mov edx, [esp+12] ; new_cr3
    mov [eax], esp    ; save old ESP
    mov esp, ecx      ; ← THE PIVOT
    cmp cr3, edx
    je .same_cr3
    mov cr3, edx      ; flush TLB
    .same_cr3:
    ret               ; → trampoline or sched
'| {
    style.fill: "#1a1a00"
    style.font-color: "#dddd60"
    style.font-size: 11
    near: top-rightm
  }

  slice: "SCHEDULER_TICKS_PER_SLICE = 5\n(5 × 10ms = 50ms slice)" {
    style.fill: "#2a2a00"
    style.font-color: "#cccc60"
    style.font-size: 11
  }

  sched_init -> sched_tick: "irq_install_handler(0,\nsched_timer_irq)" {
    style.stroke: "#888800"
    style.font-size: 11
  }
  sched_tick -> sched_sched: "ticks_remaining-- == 0\n→ sched_schedule()" {
    style.stroke: "#aaaa00"
    style.font-size: 11
  }
  sched_sched -> ctx_asm: "context_switch_asm(\n&old->saved_esp,\nnext->saved_esp,\nCR3)" {
    style.stroke: "#ffff00"
    style.stroke-width: 2
    style.font-size: 11
  }
}

# ── System Call ──────────────────────────────────────────────────────────────────
syscall_group: "System Call Interface (syscall.c)" {
  style.fill: "#1a0010"
  style.font-color: "#ff80c0"
  style.stroke: "#880044"
  style.border-radius: 6

  syscall_dispatch: "syscall_dispatch(frame)" {
    style.fill: "#2a0020"
    style.font-color: "#ff80c0"
    style.font-size: 12
  }

  sys_write: "sys_write_impl(\n  fd, buf_vaddr, count\n)" {
    style.fill: "#2a0020"
    style.font-color: "#ff80c0"
    style.font-size: 12
  }

  sys_exit: "sys_exit_impl(code)" {
    style.fill: "#2a0020"
    style.font-color: "#ff80c0"
    style.font-size: 12
  }

  abi: |'md
    **INT 0x80 ABI (Linux-compatible):**
    - EAX = syscall number
    - EBX = arg1 (fd / exit_code)
    - ECX = arg2 (buf_vaddr)
    - EDX = arg3 (count)
    - Return: EAX ← frame->eax
'| {
    style.fill: "#1a0010"
    style.font-color: "#cc6699"
    style.font-size: 11
  }

  security: |'md
    **sys_write security check:**
    
    if buf >= 0xC0000000: return -EFAULT
    if buf+count > 0xC0000000: clamp count
'| {
    style.fill: "#1a0010"
    style.font-color: "#cc6699"
    style.font-size: 11
  }

  syscall_dispatch -> sys_write: "EAX=4 SYS_WRITE" {
    style.stroke: "#880044"
    style.font-size: 11
  }
  syscall_dispatch -> sys_exit: "EAX=1 SYS_EXIT\n→ ZOMBIE\n→ sched_schedule()" {
    style.stroke: "#880044"
    style.font-size: 11
  }
}

# ── User Process ─────────────────────────────────────────────────────────────────
user_group: "User-Mode Process (ring 3)" {
  style.fill: "#0d0d0d"
  style.font-color: "#aaaaaa"
  style.stroke: "#555555"
  style.border-radius: 6

  user_pd: "Per-Process Page Directory" {
    shape: sql_table
    style.fill: "#1a1a1a"
    style.stroke: "#666666"
    "PD[0..767]": "User space (initially empty)"
    "PD[0x300=768..1023]": "Kernel PDEs copied,\nU/S=0 → ring-3 access FAULTS"
    "PD[100=0x400000>>22]": "User code frame P|U (read-only)"
    "PD[47=0xBFF000>>22]": "User stack frame P|W|U"
  }

  user_mem: "User Virtual Layout" {
    style.fill: "#1a1a1a"
    style.font-color: "#888888"
    style.font-size: 11
  }
  user_mem: |'md
    **User Virtual Address Space:**
    
    0x00000000–0x003FFFFF  unmapped (null trap)
    0x00400000–0x00400FFF  user code  P|U (r/o)
    0x00BFF000–0x00BFFFFF  user stack P|W|U
    0x00C00000–0xBFFFFFFF  unmapped
    0xC0000000–0xC03FFFFF  kernel (U/S=0) → PF if user accesses
'|

  user_abi: "user_hello.c (ring-3)" {
    style.fill: "#1a1a1a"
    style.font-color: "#888888"
    style.font-size: 11
  }
  user_abi: |'md
    c
    // user_hello.c compiled to 0x00400000
    void user_main(void) {
      u_write(1, "Hello from ring 3!\n", 19);
      u_exit(0);
    }
    // u_write: int $0x80, eax=4, ebx=1, ecx=buf, edx=n
    // u_exit:  int $0x80, eax=1, ebx=0
'|
}

# ── CONNECTIONS BETWEEN GROUPS ───────────────────────────────────────────────────

# Hardware → IDT
hw.pic -> idt_group.idt_table: "INTR → IDT[32]\nlookup gate" {
  style.stroke: "#60c060"
  style.font-size: 11
}

# IDT → Stubs → irq_common_stub
idt_group.idt_table -> idt_group.irq_stubs: "vec 32 gate\n→ irq0 stub\n→ irq_common_stub" {
  style.stroke: "#aa00aa"
  style.font-size: 11
}

# IDT → isr128
idt_group.idt_table -> idt_group.isr128: "vec 0x80 gate\nDPL=3 trap" {
  style.stroke: "#cc00cc"
  style.font-size: 11
}

# irq_common_stub → scheduler dispatch
idt_group.irq_stubs -> sched_group.sched_tick: "call irq_dispatcher\n→ irq_handlers[0]()\n= sched_timer_irq" {
  style.stroke: "#aa00aa"
  style.stroke-dash: 3
  style.font-size: 11
}

# isr128 → syscall
idt_group.isr128 -> syscall_group.syscall_dispatch: "isr_common_stub\n→ exception_handler\n→ syscall_dispatch(frame)" {
  style.stroke: "#cc00cc"
  style.stroke-dash: 3
  style.font-size: 11
}

# Scheduler → TSS update
sched_group.sched_sched -> gdt_group.tss_set: "tss_set_kernel_stack(\nnext->kernel_stack_top)\nBEFORE context switch" {
  style.stroke: "#ffaa00"
  style.stroke-width: 2
  style.font-size: 11
}

# Scheduler → PCB
sched_group.sched_sched -> pcb_group.current_proc: "current_process = next\n(BEFORE switch)" {
  style.stroke: "#0088ff"
  style.font-size: 11
}

# context_switch_asm → PCB saved_esp
sched_group.ctx_asm -> pcb_group.pcb_struct: "mov [old->saved_esp], esp\nmov esp, next->saved_esp" {
  style.stroke: "#ffff00"
  style.stroke-width: 2
  style.font-size: 11
}

# context_switch_asm → CR3
sched_group.ctx_asm -> hw.cpu.cr3: "mov cr3, new_cr3\n[if changed]" {
  style.stroke: "#ffff00"
  style.stroke-width: 2
  style.font-size: 11
}

# TSS → Hardware
gdt_group.tss_struct -> hw.cpu.tr: "CPU reads esp0\non ring-3→ring-0" {
  style.stroke: "#ffaa00"
  style.stroke-dash: 5
  style.font-size: 11
}

# Process creation → Stack Frame
pcb_group.pcb_struct -> stack_frame.frame_new: "process_create_*\nbuilds fake frame\nin kernel_stack[]" {
  style.stroke: "#0066cc"
  style.font-size: 11
}

# Trampoline → resumes new process
idt_group.trampoline -> stack_frame.frame_new: "pops frame fields:\nsegs+GPRs+iret" {
  style.stroke: "#ff00ff"
  style.stroke-width: 2
  style.font-size: 11
}

# User process → ring-3 INT 0x80
user_group.user_abi -> idt_group.idt_table: "int 0x80\n(CPL=3, DPL=3 OK)" {
  style.stroke: "#888888"
  style.stroke-dash: 5
  style.font-size: 11
}

# sys_exit → scheduler
syscall_group.sys_exit -> sched_group.sched_sched: "state=ZOMBIE\n→ sched_schedule()" {
  style.stroke: "#880044"
  style.stroke-dash: 3
  style.font-size: 11
}

# User page directory → mod-3 PMM
user_group.user_pd -> pcb_group.pcb_struct: "page_directory ptr\nstored in PCB" {
  style.stroke: "#555555"
  style.stroke-dash: 3
  style.font-size: 11
}

# Invariant annotation
invariant: |'md
  **Key Invariants:**
  1. `tss_set_kernel_stack()` called **before** `context_switch_asm()`
  2. `current_process = next` set **before** `context_switch_asm()`
  3. `EFLAGS = 0x202` in every initial frame (IF=1)
  4. User CS = `0x1B` (DPL=3), Kernel CS = `0x08` (DPL=0)
  5. Kernel PDEs in user PD have U/S=0 → hardware ring-3 isolation
  6. IF=0 throughout `sched_schedule()` (timer intr gate)
'| {
  near: top-right-center
  style.fill: "#0a0a0a"
  style.font-color: "#888888"
  style.stroke: "#444444"
  style.font-size: 11
}