vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right
title: |md
  ## Segment Selector → GDT → Linear Address Resolution
  Hardware performs CPL/DPL check on **every memory access**
| {near: top-center}
# ─── KERNEL PATH ─────────────────────────────────────────────────────────────
kernel_sel: "Kernel Code Selector\n0x08" {
  style.fill: "#7C3AED"
  style.font-color: white
  style.border-radius: 6
}
kernel_decomp: "Bit Decomposition" {
  style.fill: "#EDE9FE"
  style.border-radius: 6
  f15_3: "Bits 15:3 = 1\n(GDT Index = 1)" {
    style.fill: "#DDD6FE"
    style.border-radius: 4
  }
  f2: "Bit 2 = 0\n(TI = 0 → GDT)" {
    style.fill: "#DDD6FE"
    style.border-radius: 4
  }
  f1_0: "Bits 1:0 = 00\n(RPL = 0, Ring 0)" {
    style.fill: "#DDD6FE"
    style.border-radius: 4
  }
}
gdtr_reg: "GDTR Register" {
  style.fill: "#F97316"
  style.font-color: white
  style.border-radius: 6
  base_field: "Base = 0xC0200000\n(kernel virtual addr of GDT)" {
    style.fill: "#FED7AA"
    style.border-radius: 4
  }
  limit_field: "Limit = 39\n(5 entries × 8B − 1)" {
    style.fill: "#FED7AA"
    style.border-radius: 4
  }
}
offset_calc: "Offset Calculation\nIndex × 8 = 1 × 8 = 8 bytes" {
  style.fill: "#94A3B8"
  style.font-color: white
  style.border-radius: 6
}
kernel_desc: "GDT[1] — Kernel Code Descriptor\n(8 bytes at GDTR.base + 8)" {
  style.fill: "#1D4ED8"
  style.font-color: white
  style.border-radius: 6
  style.shadow: true
  kd_base: "Base = 0x00000000\n(flat model: covers all RAM)" {
    style.fill: "#BFDBFE"
    style.border-radius: 4
  }
  kd_limit: "Limit = 0xFFFFF\n× 4KB (G=1) = 4 GB" {
    style.fill: "#BFDBFE"
    style.border-radius: 4
  }
  kd_access: "Access = 0x9A\nP=1 DPL=0 S=1 E=1 R=1" {
    style.fill: "#BFDBFE"
    style.border-radius: 4
  }
  kd_flags: "Flags = 0xCF\nG=1 D/B=1 L=0" {
    style.fill: "#BFDBFE"
    style.border-radius: 4
  }
}
cpl_check_k: "Hardware Access Check\nCPL=0, RPL=0, DPL=0\nmax(CPL,RPL)=0 ≤ DPL=0 ✓" {
  style.fill: "#16A34A"
  style.font-color: white
  style.border-radius: 6
  style.bold: true
}
linear_k: "Linear Address\n= Base(0) + Logical Offset\n= Logical Offset\n(identity — flat model)" {
  style.fill: "#064E3B"
  style.font-color: white
  style.border-radius: 8
  style.bold: true
}
# ─── USER PATH ────────────────────────────────────────────────────────────────
user_sel: "User Code Selector\n0x1B" {
  style.fill: "#B45309"
  style.font-color: white
  style.border-radius: 6
}
user_decomp: "Bit Decomposition" {
  style.fill: "#FEF3C7"
  style.border-radius: 6
  uf15_3: "Bits 15:3 = 3\n(GDT Index = 3)" {
    style.fill: "#FDE68A"
    style.border-radius: 4
  }
  uf2: "Bit 2 = 0\n(TI = 0 → GDT)" {
    style.fill: "#FDE68A"
    style.border-radius: 4
  }
  uf1_0: "Bits 1:0 = 11\n(RPL = 3, Ring 3)" {
    style.fill: "#FDE68A"
    style.border-radius: 4
  }
}
user_offset: "Offset Calculation\nIndex × 8 = 3 × 8 = 24 bytes" {
  style.fill: "#94A3B8"
  style.font-color: white
  style.border-radius: 6
}
user_desc: "GDT[3] — User Code Descriptor\n(8 bytes at GDTR.base + 24)" {
  style.fill: "#B45309"
  style.font-color: white
  style.border-radius: 6
  style.shadow: true
  ud_base: "Base = 0x00000000\n(flat model)" {
    style.fill: "#FEF3C7"
    style.border-radius: 4
  }
  ud_limit: "Limit = 0xFFFFF\n× 4KB (G=1) = 4 GB" {
    style.fill: "#FEF3C7"
    style.border-radius: 4
  }
  ud_access: "Access = 0xFA\nP=1 DPL=3 S=1 E=1 R=1" {
    style.fill: "#FEF3C7"
    style.border-radius: 4
  }
  ud_flags: "Flags = 0xCF\nG=1 D/B=1 L=0" {
    style.fill: "#FEF3C7"
    style.border-radius: 4
  }
}
cpl_check_u: "Hardware Access Check\nCPL=3, RPL=3, DPL=3\nmax(CPL,RPL)=3 ≤ DPL=3 ✓" {
  style.fill: "#16A34A"
  style.font-color: white
  style.border-radius: 6
  style.bold: true
}
linear_u: "Linear Address\n= Base(0) + Logical Offset\n= Logical Offset\n(identity — flat model)" {
  style.fill: "#064E3B"
  style.font-color: white
  style.border-radius: 8
  style.bold: true
}
# ─── ILLEGAL PATH ─────────────────────────────────────────────────────────────
illegal_attempt: "User code loads\nkernel selector 0x08\n(RPL=0 in ring-3 code)" {
  style.fill: "#EF4444"
  style.font-color: white
  style.border-radius: 6
  style.stroke: "#DC2626"
  style.stroke-width: 2
}
illegal_check: "Hardware Access Check\nCPL=3, RPL=0, DPL=0\nmax(CPL,RPL)=3 > DPL=0 ✗" {
  style.fill: "#DC2626"
  style.font-color: white
  style.border-radius: 6
  style.bold: true
}
gp_fault: "#GP General Protection Fault\nVector 13 — Access Denied\nHardware enforced, no software check" {
  style.fill: "#7F1D1D"
  style.font-color: white
  style.border-radius: 8
  style.bold: true
  style.multiple: true
}
# ─── CONNECTIONS — KERNEL PATH ────────────────────────────────────────────────
kernel_sel -> kernel_decomp: "decompose 16-bit value" {
  style.stroke: "#7C3AED"
  style.stroke-width: 2
}
kernel_sel -> gdtr_reg: "lidt/lgdt loads GDTR\nonce at boot" {
  style.stroke: "#F97316"
  style.stroke-dash: 4
}
kernel_decomp -> offset_calc: "index field" {
  style.stroke: "#7C3AED"
}
gdtr_reg -> offset_calc: "GDTR.base" {
  style.stroke: "#F97316"
}
offset_calc -> kernel_desc: "GDTR.base + (index × 8)\nhardware walks table" {
  style.stroke: "#1D4ED8"
  style.stroke-width: 2
}
kernel_decomp -> cpl_check_k: "RPL from\nselector bits 1:0" {
  style.stroke: "#7C3AED"
  style.stroke-dash: 3
}
kernel_desc -> cpl_check_k: "DPL from\ndescriptor access byte" {
  style.stroke: "#1D4ED8"
  style.stroke-dash: 3
}
cpl_check_k -> linear_k: "ACCESS GRANTED" {
  style.stroke: "#16A34A"
  style.stroke-width: 3
}
# ─── CONNECTIONS — USER PATH ──────────────────────────────────────────────────
user_sel -> user_decomp: "decompose 16-bit value" {
  style.stroke: "#B45309"
  style.stroke-width: 2
}
user_decomp -> user_offset: "index field" {
  style.stroke: "#B45309"
}
gdtr_reg -> user_offset: "GDTR.base\n(same register)" {
  style.stroke: "#F97316"
}
user_offset -> user_desc: "GDTR.base + (index × 8)" {
  style.stroke: "#B45309"
  style.stroke-width: 2
}
user_decomp -> cpl_check_u: "RPL=3 from\nselector bits 1:0" {
  style.stroke: "#B45309"
  style.stroke-dash: 3
}
user_desc -> cpl_check_u: "DPL=3 from\ndescriptor access byte" {
  style.stroke: "#B45309"
  style.stroke-dash: 3
}
cpl_check_u -> linear_u: "ACCESS GRANTED" {
  style.stroke: "#16A34A"
  style.stroke-width: 3
}
# ─── CONNECTIONS — ILLEGAL PATH ───────────────────────────────────────────────
illegal_attempt -> illegal_check: "CPL=3 (ring-3 code)\nRPL=0 (selector value)\nDPL=0 (GDT[1])" {
  style.stroke: "#EF4444"
  style.stroke-width: 2
}
illegal_check -> gp_fault: "DENIED — raise #GP\nvector 13" {
  style.stroke: "#DC2626"
  style.stroke-width: 3
  style.stroke-dash: 0
}
# ─── ANNOTATION ───────────────────────────────────────────────────────────────
rule_note: |md
  **Hardware Rule (every memory access):**
  Access granted iff `max(CPL, RPL) ≤ DPL`
  - **CPL** = Current Privilege Level = low 2 bits of CS
  - **RPL** = Requested Privilege Level = low 2 bits of selector
  - **DPL** = Descriptor Privilege Level = bits 6:5 of access byte
  *Not a software check — enforced in MMU silicon*
| {
  near: bottom-center
  style.fill: "#F1F5F9"
  style.stroke: "#94A3B8"
  style.border-radius: 8
}