layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  ## Real Mode → Protected Mode — CPU State Machine
  *x86 Privilege Transition with Exact Instruction Triggers*
| {near: top-center}

# --- STATES ---

● -> REAL_MODE: "Power On / Reset"

REAL_MODE: {
  shape: rectangle
  style: {
    fill: "#1a1a2e"
    stroke: "#4fc3f7"
    stroke-width: 3
    font-color: "#e0f7fa"
    bold: true
    border-radius: 8
  }
  label: |md
    **REAL_MODE**
    - 16-bit registers & opcodes
    - Segment×16+Offset addressing
    - Max addressable: 1 MB (0xFFFFF)
    - IVT active at 0000:0000
    - CR0.PE = **0**
  |
}

TRANSITION_UNSAFE: {
  shape: rectangle
  style: {
    fill: "#4a0000"
    stroke: "#ff5252"
    stroke-width: 4
    font-color: "#ffcdd2"
    bold: true
    border-radius: 8
  }
  label: |md
    **TRANSITION_UNSAFE** ⚠️
    - CR0.PE = **1** ← just set
    - CS still holds real-mode base
    - Prefetch queue: real-mode decoded
    - IVT now INVALID as IDT
    - Duration: **ONE instruction**
    - Any exception → Triple Fault
  |
}

PROTECTED_MODE_PARTIAL: {
  shape: rectangle
  style: {
    fill: "#1b3a1b"
    stroke: "#81c784"
    stroke-width: 3
    font-color: "#e8f5e9"
    bold: true
    border-radius: 8
  }
  label: |md
    **PROTECTED_MODE_PARTIAL**
    - CR0.PE = **1** ✓
    - CS = 0x08 (kernel code) ✓
    - Pipeline flushed ✓
    - DS/ES/SS = stale ✗
    - Interrupts: DISABLED
  |
}

PROTECTED_MODE_FULL: {
  shape: rectangle
  style: {
    fill: "#1a237e"
    stroke: "#7c4dff"
    stroke-width: 3
    font-color: "#e8eaf6"
    bold: true
    border-radius: 8
  }
  label: |md
    **PROTECTED_MODE_FULL** ✓
    - CR0.PE = **1** ✓
    - CS = 0x08, DS/ES/SS = 0x10 ✓
    - ESP = 32-bit stack ✓
    - GDT selectors validated ✓
    - Ready for: IDT load, sti
  |
}

# --- ERROR STATES ---

ILLEGAL_STI: {
  shape: hexagon
  style: {
    fill: "#7f0000"
    stroke: "#ff1744"
    stroke-width: 3
    font-color: "#ffffff"
    bold: true
  }
  label: |md
    **TRIPLE FAULT**
    IVT misread as IDT
    (Reset)
  |
}

STUCK_GPF: {
  shape: hexagon
  style: {
    fill: "#4a1942"
    stroke: "#e040fb"
    stroke-width: 3
    font-color: "#f3e5f5"
    bold: true
  }
  label: |md
    **TRIPLE FAULT**
    CS Selector Invalid
    (Reset)
  |
}

# --- TRANSITIONS ---

REAL_MODE -> TRANSITION_UNSAFE: "① cli\n② lgdt [gdt_ptr]\n③ mov eax, cr0\n④ or eax, 1\n⑤ mov cr0, eax" {
  style: {
    stroke: "#ffd54f"
    stroke-width: 3
    font-color: "#ffd54f"
    bold: true
    animated: true
  }
}

TRANSITION_UNSAFE -> PROTECTED_MODE_PARTIAL: "⑥ jmp 0x08:pmode\n(mandatory far jump)" {
  style: {
    stroke: "#69f0ae"
    stroke-width: 3
    font-color: "#69f0ae"
    bold: true
    animated: true
  }
}

PROTECTED_MODE_PARTIAL -> PROTECTED_MODE_FULL: "⑦ Load Data Segments\n⑧ Setup 32-bit ESP" {
  style: {
    stroke: "#40c4ff"
    stroke-width: 3
    font-color: "#40c4ff"
    bold: true
    animated: true
  }
}

TRANSITION_UNSAFE -> ILLEGAL_STI: "sti (ILLEGAL)" {
  style: {
    stroke: red
    stroke-width: 3
    stroke-dash: 5
    font-color: red
    bold: true
  }
  source-arrowhead.label: "ILLEGAL"
  target-arrowhead: {
    shape: diamond
    style.filled: true
  }
}

TRANSITION_UNSAFE -> STUCK_GPF: "Missing Far Jump" {
  style: {
    stroke: red
    stroke-width: 3
    stroke-dash: 5
    font-color: red
    bold: true
  }
  source-arrowhead.label: "ILLEGAL"
  target-arrowhead: {
    shape: diamond
    style.filled: true
  }
}

# --- ANNOTATIONS (Fixing Block String Error) ---

invariants: {
  label: |'md
    **Invariants & Constraints**
    | Phase | EFLAGS.IF | BIOS INTs | GDT Status |
    | :--- | :--- | :--- | :--- |
    | REAL_MODE | Any | ✓ OK | Not Used |
    | TRANSITION | **0** (cli) | ✗ Broken | Loaded |
    | PMODE_PART | **0** | ✗ Broken | Active |
    | PMODE_FULL | 0 until IDT | ✗ Broken | Validated |
  '|
  near: bottom-center
  style: {
    font-size: 14
    fill: "#0d0d1a"
    stroke: "#4fc3f7"
    stroke-width: 1
    font-color: "#b0bec5"
    border-radius: 6
  }
}