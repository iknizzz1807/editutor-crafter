direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: {
  label: |md
    # Linker Script Section Layout — VMA vs LMA
    **Milestone 1:** VMA = LMA = 0x100000 | **Milestone 3:** VMA = 0xC0100000, LMA = 0x100000
  |
  near: top-center
}

# ─── LEFT COLUMN: VMA (Virtual Memory Address) ───────────────────────────────
vma_col: {
  label: "VMA — Virtual Address Space (Symbol Resolution)"
  style: {
    fill: "#F0E6FF"
    stroke: "#7B2FBE"
    stroke-width: 2
    border-radius: 6
  }

  vma_base: {
    label: |md
      **0xC0100000**
      VMA Base Address
      M3 Higher-Half
    |
    style: {
      fill: "#7B2FBE"
      font-color: white
      stroke: "#4A1880"
      stroke-width: 2
      font-size: 11
      bold: true
    }
  }

  vma_text: {
    label: |md
      .text [4KB-aligned]
      *(.multiboot)
      *(.text)
      ────────────────────────────
      Executable Code (R-X)
    |
    style: {
      fill: "#E2CCFF"
      stroke: "#7B2FBE"
      stroke-width: 3
      font-size: 11
      font: mono
    }
  }

  vma_rodata: {
    label: |md
      .rodata [4KB-aligned]
      *(.rodata)
      ────────────────────────────
      Constants (R--)
    |
    style: {
      fill: "#CCE5FF"
      stroke: "#0056B3"
      stroke-width: 2
      font-size: 11
      font: mono
    }
  }

  vma_data: {
    label: |md
      .data [4KB-aligned]
      *(.data)
      ────────────────────────────
      Initialized Globals (RW-)
    |
    style: {
      fill: "#CCE5FF"
      stroke: "#0056B3"
      stroke-width: 2
      font-size: 11
      font: mono
    }
  }

  vma_bss: {
    label: |md
      .bss [4KB-aligned]
      __bss_start = .
      *(.bss) *(COMMON)
      __bss_end = .
      ────────────────────────────
      Zero-Init (RW-)
    |
    style: {
      fill: "#D4EDDA"
      stroke: "#28A745"
      stroke-width: 2
      font-size: 11
      font: mono
    }
  }

  vma_kernel_end: {
    label: "__kernel_end = ."
    style: {
      fill: "#E8D5FA"
      stroke: "#7B2FBE"
      font-size: 11
      italic: true
    }
  }

  vma_base -> vma_text: "Entry"
  vma_text -> vma_rodata: "ALIGN(4K)"
  vma_rodata -> vma_data: "ALIGN(4K)"
  vma_data -> vma_bss: "ALIGN(4K)"
  vma_bss -> vma_kernel_end
}

# ─── RIGHT COLUMN: LMA (Load Memory Address) ─────────────────────────────────
lma_col: {
  label: "LMA — Load Memory Address (Binary Image on Disk)"
  style: {
    fill: "#E6F3FF"
    stroke: "#0056B3"
    stroke-width: 2
    border-radius: 6
  }

  lma_phys_base: {
    label: |md
      **0x00100000**
      Physical Base (1MB)
    |
    style: {
      fill: "#0056B3"
      font-color: white
      stroke: "#003D80"
      stroke-width: 2
      font-size: 11
      bold: true
    }
  }

  lma_text_img: {
    label: |md
      .text image
      AT(0x100000)
    |
    style: {
      fill: "#E2CCFF"
      stroke: "#7B2FBE"
      stroke-width: 3
      font-size: 11
      font: mono
    }
  }

  lma_rodata_img: {
    label: |md
      .rodata image
      LMA: 0x100000 + off
    |
    style: {
      fill: "#CCE5FF"
      stroke: "#0056B3"
      stroke-width: 2
      font-size: 11
      font: mono
    }
  }

  lma_data_img: {
    label: |md
      .data image
      LMA: 0x100000 + off
    |
    style: {
      fill: "#CCE5FF"
      stroke: "#0056B3"
      stroke-width: 2
      font-size: 11
      font: mono
    }
  }

  lma_no_bss: {
    label: |md
      BSS: NO STORAGE
      [0 bytes on disk]
    |
    style: {
      fill: "#D4EDDA"
      stroke: "#28A745"
      stroke-width: 2
      stroke-dash: 5
      font-size: 11
      font: mono
    }
  }

  lma_phys_base -> lma_text_img: "GRUB Load"
  lma_text_img -> lma_rodata_img: "Packed"
  lma_rodata_img -> lma_data_img: "Packed"
  lma_data_img -> lma_no_bss: "Skip"
}

# ─── ANNOTATIONS ─────────────────────────────────────────────────────────────
m1_box: {
  label: |md
    **MILESTONE 1**
    VMA == LMA
  |
  style: {
    fill: "#FFF3CD"
    stroke: "#856404"
  }
}

m3_box: {
  label: |md
    **MILESTONE 3**
    VMA != LMA
    Higher-Half
  |
  style: {
    fill: "#F8D7DA"
    stroke: "#842029"
  }
}

# ─── CROSS-COLUMN CORRESPONDENCE ─────────────────────────────────────────────
vma_col.vma_text -> lma_col.lma_text_img: "AT() Mapping" {
  style: {
    stroke: orange
    stroke-width: 2
    stroke-dash: 5
  }
}

vma_col.vma_bss -> lma_col.lma_no_bss: "Virtual Only" {
  style: {
    stroke: "#28A745"
    stroke-dash: 3
  }
}

m1_box -> vma_col.vma_base: "Identity"
m3_box -> lma_col.lma_phys_base: "Physical"

constants: {
  label: |md
    **Linker Constants**
    Phys: 0x100000
    Virt: 0xC0100000
  |
  style: {
    fill: "#F5F5F5"
    stroke: "#666666"
    font-size: 10
  }
}