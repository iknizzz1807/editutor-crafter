vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |'md
# VGA Text Mode Buffer — Physical 0xB8000
80 × 25 = 2000 cells · 2 bytes/cell · 4000 bytes total · MMIO (volatile required)
'| {
  near: top-center
}

# ─── POINTER ARITHMETIC ───────────────────────────────────────────────────────
ptr_math: "Pointer Arithmetic" {
  style: {
    fill: "#2D1B4E"
    stroke: "#7B1FA2"
    font-color: white
  }
  formula: |'md
c
volatile uint16_t *VGA = (volatile uint16_t *)0xB8000;
uint16_t offset = row * 80 + col;   // Index 0..1999
uint32_t phys   = 0xB8000 + (offset * 2);
VGA[offset] = (uint16_t)(attr << 8) | (uint8_t)ch;

**volatile** mandatory: MMIO writes must not be optimized away or reordered by the compiler.
'|
}

# ─── BUFFER EXTENT ────────────────────────────────────────────────────────────
buffer_extent: "Physical Memory Extent" {
  style.fill: "#1A1A2E"
  row_data: |'md
| Address      | Cell Location (Row, Col) | Offset (hex) |
|--------------|--------------------------|--------------|
| 0x000B8000   | Cell (0, 0)              | +0x0000      |
| 0x000B8002   | Cell (0, 1)              | +0x0002      |
| 0x000B80A0   | Cell (1, 0)              | +0x00A0      |
| 0x000B8F9E   | Cell (24, 79)            | +0x0F9E      |
| 0x000B8FA0   | **End of Buffer**        | +0x0FA0      |
'|
}

# ─── SINGLE CELL LAYOUT ───────────────────────────────────────────────────────
cell_diagram: "Single VGA Cell (16-bit word)" {
  style.fill: "#0D0D0D"
  
  byte0: "0x0: Character Code" {
    style: {
      fill: "#1565C0"
      font-color: white
    }
    label: "Offset +0 (Low Byte)\nASCII Character (e.g., 0x41='A')\nSize: 8 bits"
  }
  
  byte1: "0x1: Attribute" {
    style: {
      fill: "#7B1FA2"
      font-color: white
    }
    label: "Offset +1 (High Byte)\nColor/FX Metadata\nSize: 8 bits"
  }

  attr_bits: "Attribute Bitfield Structure" {
    style.fill: "#1A0A2E"
    bits: |'md
| Bit 7 | Bit 6 | Bit 5 | Bit 4 | Bit 3 | Bit 2 | Bit 1 | Bit 0 |
|-------|-------|-------|-------|-------|-------|-------|-------|
| BG B  | BG G  | BG R  | BG I  | FG B  | FG G  | FG R  | FG I  |
| <--- Background (0-15) ---> | <--- Foreground (0-15) ---> |
'|
  }

  byte0 -> byte1: "word (LE)" {style.stroke-dash: 3}
  byte1 -> attr_bits: "decomposed"
}

# ─── COLOUR TABLE ─────────────────────────────────────────────────────────────
color_table: "VGA 16-Color Palette" {
  style.fill: "#0A0A1A"
  table: |'md
| Hex | Color | Hex | Color |
|-----|-------|-----|-------|
| 0x0 | Black | 0x8 | D-Gray |
| 0x1 | Blue  | 0x9 | L-Blue |
| 0x2 | Green | 0xA | L-Green|
| 0x4 | Red   | 0xC | L-Red  |
| 0x7 | L-Gray| 0xF | White  |
'|
}

# ─── IMPLEMENTATION ───────────────────────────────────────────────────────────
macros: "C Driver Logic" {
  style.fill: "#0F1A10"
  code: |'md
c
#define VGA_BUF ((volatile uint16_t*)0xB8000)

static inline uint16_t vga_entry(char c, uint8_t fg, uint8_t bg) {
    uint8_t color = (bg << 4) | (fg & 0x0F);
    return (uint16_t)c | (uint16_t)color << 8;
}

'|
}

# ─── SCROLL OPERATION ─────────────────────────────────────────────────────────
scroll_op_container: "VGA Scroll Engine (Row Shift)" {
  before: "Buffer Before" {
    style.fill: "#1A1000"
    content: |'md
- Row 0 (Discard)
- Row 1 -> Row 0
- Row 2 -> Row 1
'|
  }
  
  operation: "memmove logic" {
    style.fill: "#2A1A00"
    label: "Copy rows 1-24 to 0-23\nClear row 24 with ' '"
  }
  
  after: "Buffer After" {
    style.fill: "#0A1A00"
    content: |'md
- Row 23 (was 24)
- Row 24 (Cleared)
'|
  }

  before -> operation -> after
}

# ─── VOLATILE WARNING ─────────────────────────────────────────────────────────
volatile_warn: |'md
⚠ **VOLATILE HAZARD**
MMIO writes must be marked `volatile`. Without it, the compiler may eliminate 
"redundant" writes to the same memory address, preventing visual updates 
on the hardware registers.
'| {
  near: bottom-center
  style: {
    fill: "#2A0000"
    font-color: "#FF8888"
    stroke: "#B71C1C"
    bold: true
  }
}

# ─── CONNECTIONS ──────────────────────────────────────────────────────────────
ptr_math -> buffer_extent: "defines bounds"
ptr_math -> cell_diagram: "writes unit"
cell_diagram -> color_table: "attr lookup"
cell_diagram -> macros: "impl"
macros -> scroll_op_container: "usage"