vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  ## IDT Gate Descriptor — 8-Byte Layout (x86 32-bit Protected Mode)
  `idt_set_gate(vector, handler_addr, selector=0x08, flags)`
|
title.near: top-center

# ─── BYTE RULER ───────────────────────────────────────────────────────────────
ruler: "Byte Offset →   0        1        2        3        4        5        6        7" {
  shape: text
  style: {
    font: mono
    font-size: 13
    font-color: "#555555"
  }
  near: top-left
}

# ─── MAIN 8-BYTE ENTRY ────────────────────────────────────────────────────────
entry: "IDT Entry (8 bytes total)" {
  style: {
    fill: "#1e1e2e"
    stroke: "#89b4fa"
    stroke-width: 2
    font-color: "#cdd6f4"
    font-size: 14
    bold: true
  }
  fields: {
    grid-columns: 8
    grid-gap: 0
    b0: "OFFSET\n[7:0]" {
      width: 80
      style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 11; bold: true }
    }
    b1: "OFFSET\n[15:8]" {
      width: 80
      style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 11; bold: true }
    }
    b2: "SEG SEL\n[7:0]" {
      width: 80
      style: { fill: "#d35400"; stroke: "#e67e22"; font-color: white; font-size: 11; bold: true }
    }
    b3: "SEG SEL\n[15:8]" {
      width: 80
      style: { fill: "#d35400"; stroke: "#e67e22"; font-color: white; font-size: 11; bold: true }
    }
    b4: "RSVD\n=0x00" {
      width: 80
      style: { fill: "#555555"; stroke: "#888888"; font-color: "#cccccc"; font-size: 11; bold: true }
    }
    b5: "FLAGS\nBYTE" {
      width: 80
      style: { fill: "#1a6b3a"; stroke: "#27ae60"; font-color: white; font-size: 11; bold: true }
    }
    b6: "OFFSET\n[23:16]" {
      width: 80
      style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 11; bold: true }
    }
    b7: "OFFSET\n[31:24]" {
      width: 80
      style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 11; bold: true }
    }
  }
  offsets: {
    grid-columns: 8
    grid-gap: 0
    o0: "+0" { width: 80; style: { fill: "#2d1b4e"; stroke: "#a569bd"; font-color: "#a569bd"; font-size: 10; font: mono } }
    o1: "+1" { width: 80; style: { fill: "#2d1b4e"; stroke: "#a569bd"; font-color: "#a569bd"; font-size: 10; font: mono } }
    o2: "+2" { width: 80; style: { fill: "#4a1f00"; stroke: "#e67e22"; font-color: "#e67e22"; font-size: 10; font: mono } }
    o3: "+3" { width: 80; style: { fill: "#4a1f00"; stroke: "#e67e22"; font-color: "#e67e22"; font-size: 10; font: mono } }
    o4: "+4" { width: 80; style: { fill: "#222222"; stroke: "#888888"; font-color: "#888888"; font-size: 10; font: mono } }
    o5: "+5" { width: 80; style: { fill: "#0d2b1a"; stroke: "#27ae60"; font-color: "#27ae60"; font-size: 10; font: mono } }
    o6: "+6" { width: 80; style: { fill: "#2d1b4e"; stroke: "#a569bd"; font-color: "#a569bd"; font-size: 10; font: mono } }
    o7: "+7" { width: 80; style: { fill: "#2d1b4e"; stroke: "#a569bd"; font-color: "#a569bd"; font-size: 10; font: mono } }
  }
}

# ─── FIELD LEGEND ─────────────────────────────────────────────────────────────
legend: {
  grid-columns: 4
  grid-gap: 8
  l_offset: "handler offset (split)" {
    style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 11 }
  }
  l_sel: "segment selector" {
    style: { fill: "#d35400"; stroke: "#e67e22"; font-color: white; font-size: 11 }
  }
  l_rsvd: "reserved = 0x00" {
    style: { fill: "#555555"; stroke: "#888888"; font-color: "#cccccc"; font-size: 11 }
  }
  l_flags: "flags byte" {
    style: { fill: "#1a6b3a"; stroke: "#27ae60"; font-color: white; font-size: 11 }
  }
}

# ─── FLAGS BYTE DETAIL ────────────────────────────────────────────────────────
flags_detail: "FLAGS BYTE (offset +5) — Bit-Level Breakdown" {
  style: {
    fill: "#0d2b1a"
    stroke: "#27ae60"
    stroke-width: 2
    font-color: "#27ae60"
    font-size: 13
    bold: true
  }
  bits: {
    grid-columns: 8
    grid-gap: 0
    bit7: "P\n(7)" {
      width: 60
      style: { fill: "#922b21"; stroke: "#e74c3c"; font-color: white; font-size: 11; bold: true }
    }
    bit6: "DPL\n(6)" {
      width: 60
      style: { fill: "#1a5276"; stroke: "#2e86c1"; font-color: white; font-size: 11; bold: true }
    }
    bit5: "DPL\n(5)" {
      width: 60
      style: { fill: "#1a5276"; stroke: "#2e86c1"; font-color: white; font-size: 11; bold: true }
    }
    bit4: "0\n(4)" {
      width: 60
      style: { fill: "#555555"; stroke: "#888888"; font-color: "#cccccc"; font-size: 11 }
    }
    bit3: "TYPE\n(3)" {
      width: 60
      style: { fill: "#1a6b3a"; stroke: "#27ae60"; font-color: white; font-size: 11; bold: true }
    }
    bit2: "TYPE\n(2)" {
      width: 60
      style: { fill: "#1a6b3a"; stroke: "#27ae60"; font-color: white; font-size: 11; bold: true }
    }
    bit1: "TYPE\n(1)" {
      width: 60
      style: { fill: "#1a6b3a"; stroke: "#27ae60"; font-color: white; font-size: 11; bold: true }
    }
    bit0: "TYPE\n(0)" {
      width: 60
      style: { fill: "#1a6b3a"; stroke: "#27ae60"; font-color: white; font-size: 11; bold: true }
    }
  }
  field_desc: {
    grid-columns: 3
    grid-gap: 8
    p_desc: |md
      **P — Present**
      Must = 1 for valid gate.
      CPU ignores entries with P=0.
    |
    p_desc.style: { fill: "#1c0a0a"; stroke: "#e74c3c"; font-size: 12 }

    dpl_desc: |md
      **DPL — Descriptor Privilege Level**
      DPL=0 → only ring 0 can `int n`
      DPL=3 → ring 3 can `int n` (syscalls)
      Hardware IRQs bypass DPL check.
    |
    dpl_desc.style: { fill: "#0a1520"; stroke: "#2e86c1"; font-size: 12 }

    type_desc: |md
      **TYPE — Gate Type (4 bits)**
      `1110` = 32-bit Interrupt Gate
      `1111` = 32-bit Trap Gate
      Bit 4 is always 0 (shown separately).
    |
    type_desc.style: { fill: "#0d2b1a"; stroke: "#27ae60"; font-size: 12 }
  }
  gate_types: {
    grid-columns: 2
    grid-gap: 12
    int_gate: |md
      ### 32-bit Interrupt Gate  `type=1110`
      **Clears EFLAGS.IF on entry**
      interrupts disabled until handler calls `sti` or `iretd`.
      Use for: all hardware IRQs, all CPU exceptions.
    |
    int_gate.style: { fill: "#1a3a1a"; stroke: "#27ae60"; font-size: 12 }

    trap_gate: |md
      ### 32-bit Trap Gate  `type=1111`
      **Preserves EFLAGS.IF**
      kernel remains interruptible during handler.
      Use for: INT 0x80 system call gate.
    |
    trap_gate.style: { fill: "#1a2a3a"; stroke: "#2e86c1"; font-size: 12 }
  }
}

# ─── CONCRETE EXAMPLES ────────────────────────────────────────────────────────
examples: "Concrete Gate Values" {
  style: {
    fill: "#1a1a2e"
    stroke: "#89b4fa"
    stroke-width: 2
    font-color: "#cdd6f4"
    font-size: 13
    bold: true
  }
  ex_kernel: "Kernel Exception Gate (e.g., \#PF handler, IRQ0 timer)" {
    style: { fill: "#1e2a1e"; stroke: "#27ae60"; font-size: 12; font-color: "#a8d5b5" }
    bytes: {
      grid-columns: 8
      grid-gap: 0
      ke0: "0xAB\noffset\n[7:0]"   { width: 80; style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 10; font: mono } }
      ke1: "0xCD\noffset\n[15:8]"  { width: 80; style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 10; font: mono } }
      ke2: "0x08\nsel\n[7:0]"      { width: 80; style: { fill: "#d35400"; stroke: "#e67e22"; font-color: white; font-size: 10; font: mono } }
      ke3: "0x00\nsel\n[15:8]"     { width: 80; style: { fill: "#d35400"; stroke: "#e67e22"; font-color: white; font-size: 10; font: mono } }
      ke4: "0x00\nrsvd"            { width: 80; style: { fill: "#555555"; stroke: "#888888"; font-color: "#cccccc"; font-size: 10; font: mono } }
      ke5: "0x8E\nflags"           { width: 80; style: { fill: "#1a5f2a"; stroke: "#27ae60"; font-color: "#7defa7"; font-size: 10; font: mono; bold: true } }
      ke6: "0xC0\noffset\n[23:16]" { width: 80; style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 10; font: mono } }
      ke7: "0x10\noffset\n[31:24]" { width: 80; style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 10; font: mono } }
    }
    flags_expand_kernel: |'md
      `0x8E` = `1000_1110`  →  **P=1**, DPL=00, type=1110 (interrupt)
      handler = `0x10C0CDAB` | selector = `0x0008` (kernel code)
    '|
    flags_expand_kernel.style: { font: mono; font-size: 12; fill: "#0d2b1a"; stroke: "#27ae60"; font-color: "#7defa7" }
  }
  ex_syscall: "Syscall Trap Gate (INT 0x80 — user-invocable)" {
    style: { fill: "#1a1e2e"; stroke: "#2e86c1"; font-size: 12; font-color: "#a8c4e5" }
    bytes: {
      grid-columns: 8
      grid-gap: 0
      ks0: "0x12\noffset\n[7:0]"   { width: 80; style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 10; font: mono } }
      ks1: "0x34\noffset\n[15:8]"  { width: 80; style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 10; font: mono } }
      ks2: "0x08\nsel\n[7:0]"      { width: 80; style: { fill: "#d35400"; stroke: "#e67e22"; font-color: white; font-size: 10; font: mono } }
      ks3: "0x00\nsel\n[15:8]"     { width: 80; style: { fill: "#d35400"; stroke: "#e67e22"; font-color: white; font-size: 10; font: mono } }
      ks4: "0x00\nrsvd"            { width: 80; style: { fill: "#555555"; stroke: "#888888"; font-color: "#cccccc"; font-size: 10; font: mono } }
      ks5: "0xEF\nflags"           { width: 80; style: { fill: "#1a2a5a"; stroke: "#2e86c1"; font-color: "#7ab3e0"; font-size: 10; font: mono; bold: true } }
      ks6: "0xC0\noffset\n[23:16]" { width: 80; style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 10; font: mono } }
      ks7: "0x10\noffset\n[31:24]" { width: 80; style: { fill: "#6c3483"; stroke: "#a569bd"; font-color: white; font-size: 10; font: mono } }
    }
    flags_expand_syscall: |'md
      `0xEF` = `1110_1111`  →  **P=1**, DPL=11 (user!), type=1111 (trap)
      handler = `0x10C03412` | selector = `0x0008` (kernel code)
    '|
    flags_expand_syscall.style: { font: mono; font-size: 12; fill: "#0a1520"; stroke: "#2e86c1"; font-color: "#7ab3e0" }
  }
}

# ─── C API ────────────────────────────────────────────────────────────────────
c_api: |go
  // idt_set_gate — field assignments with bit masks
  void idt_set_gate(uint8_t vector, uint32_t handler, uint16_t sel, uint8_t flags) {
      idt[vector].offset_low  = (uint16_t)( handler        & 0xFFFF);
      idt[vector].selector    = sel;                                   
      idt[vector].reserved    = 0;                                     
      idt[vector].flags       = flags;                                 
      idt[vector].offset_high = (uint16_t)((handler >> 16) & 0xFFFF); 
  }
  // Kernel exception/IRQ gate  →  flags = 0x8E
  idt_set_gate(14, (uint32_t)isr_14, 0x08, 0x8E);
  // Syscall trap gate          →  flags = 0xEF
  idt_set_gate(0x80, (uint32_t)isr_128, 0x08, 0xEF);
|
c_api.near: bottom-center
c_api.style: { fill: "#1a1a1a"; stroke: "#555555"; font-size: 12 }

# ─── SIZE ANNOTATION ──────────────────────────────────────────────────────────
size_note: |md
  **IDT size:** 256 entries × 8 bytes = **2048 bytes**
  **IDTR:** `limit = 2047`, `base = (uint32_t)idt`
|
size_note.near: bottom-right
size_note.style: { fill: "#1a1a1a"; stroke: "#89b4fa"; font-size: 12; font-color: "#89b4fa" }

# ─── CONNECTIONS ──────────────────────────────────────────────────────────────
entry.fields.b5 -> flags_detail: "bit-level detail" {
  style: { stroke: "#27ae60"; stroke-dash: 4; stroke-width: 2; font-color: "#27ae60"; font-size: 11 }
}
entry -> examples: "concrete values" {
  style: { stroke: "#89b4fa"; stroke-dash: 4; stroke-width: 1; font-color: "#89b4fa"; font-size: 11 }
}
flags_detail -> examples: "0x8E / 0xEF" {
  style: { stroke: "#555555"; stroke-dash: 4; stroke-width: 1; font-color: "#aaaaaa"; font-size: 11 }
}