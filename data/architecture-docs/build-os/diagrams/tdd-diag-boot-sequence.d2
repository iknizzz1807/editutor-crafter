vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # x86 Boot Sequence: BIOS to C Entry
| {near: top-center}

direction: down

# Hardware/BIOS Layer
power_on: "Power On" {
  shape: circle
  style.fill: "#4A90D9"
  style.font-color: white
  style.stroke: "#2E5A8B"
}

bios_post: "BIOS POST\n(Power-On Self-Test)" {
  style.fill: "#5B9BD5"
  style.font-color: white
}

# MBR Loading
mbr_load: |md
  **MBR Load**
  - BIOS reads sector 0
  - Destination: `0x7C00`
  - Size: 512 bytes
| {
  style.fill: "#70AD47"
  style.font-color: white
}

# Stage 1 Bootloader
stage1: "Stage 1 Bootloader\n(at 0x7C00)" {
  style.fill: "#ED7D31"
  style.font-color: white
}

# A20 Line
a20_enable: |md
  **Enable A20 Line**
  - Fast A20 (port 0x92)
  - Keyboard controller fallback
  - Verify: `0x100000` writable
| {
  style.fill: "#FFC000"
  style.font-color: black
}

# GDT Setup
gdt_setup: |md
  **Load GDT**
  - Null descriptor (0x00)
  - Kernel Code: base=0, limit=4GB, DPL=0
  - Kernel Data: base=0, limit=4GB, DPL=0
  - User Code: base=0, limit=4GB, DPL=3
  - User Data: base=0, limit=4GB, DPL=3
  - `lgdt [gdt_ptr]`
| {
  style.fill: "#9E480E"
  style.font-color: white
}

# Protected Mode Entry
cr0_pe: |md
  **Set CR0.PE = 1**
  
  mov eax, cr0
  or al, 1
  mov cr0, eax
  
| {
  style.fill: "#7030A0"
  style.font-color: white
}

# Far Jump
far_jump: |md
  **Far Jump to 32-bit Code**
  
  jmp 0x08:protected_mode_entry
  
  - CS â† 0x08 (kernel code selector)
  - Flushes prefetch queue
| {
  style.fill: "#C00000"
  style.font-color: white
}

# Segment Register Setup
seg_setup: |md
  **Initialize Segment Registers**
  
  mov ax, 0x10
  mov ds, ax
  mov es, ax
  mov fs, ax
  mov gs, ax
  mov ss, ax
  mov esp, 0x90000
  
| {
  style.fill: "#002060"
  style.font-color: white
}

# C Entry Point
c_entry: "C Entry Point\n`kernel_main()`" {
  style.fill: "#00B050"
  style.font-color: white
  style.stroke: "#006400"
  style.stroke-width: 3
  style.shadow: true
}

# Connections
power_on -> bios_post: "Reset vector:\n0xFFFFFFF0"
bios_post -> mbr_load: "INT 0x13\nAH=0x02"
mbr_load -> stage1: "Jump to 0x7C00"
stage1 -> a20_enable: "1. A20 gate"
a20_enable -> gdt_setup: "2. Setup GDT"
gdt_setup -> cr0_pe: "3. Enable PM"
cr0_pe -> far_jump: "4. Far jump"
far_jump -> seg_setup: "Now in 32-bit\nprotected mode"
seg_setup -> c_entry: "Call kernel_main()"

# Annotations
note_memory: |md
  **Memory Layout at Boot**
  
  
  0x00000000 - 0x000003FF  IVT (real mode)
  0x00000400 - 0x000004FF  BDA
  0x00007C00 - 0x00007DFF  MBR loaded here
  0x00007E00 - 0x0007FFFF  Available
  0x00080000 - 0x0008FFFF  EBDA
  0x00090000 - 0x0009FFFF  Kernel stack
  0x000A0000 - 0x000FFFFF  ROM area
  0x00100000 +             Extended memory
  
| {
  near: center-right
  style.fill: "#F2F2F2"
  style.stroke: "#808080"
  style.stroke-dash: 3
}

note_registers: |md
  **CPU State Transitions**
  
  Stage: CS: IP: Mode
  Reset: 0xF000: 0xFFF0: Real
  POST: varies: varies: Real
  MBR: 0x0000: 0x7C00: Real
  PM entry: 0x08: entry: Protected
  C code: 0x08: kmain: Protected
| {
  near: bottom-right
  style.fill: "#E2EFDA"
  style.stroke: "#548235"
}

# Legend
legend: {
  near: bottom-left
  style.fill: white
  style.stroke: black
  
  hw: "Hardware/BIOS" {
    shape: rectangle
    style.fill: "#4A90D9"
    style.font-color: white
  }
  bl: "Bootloader" {
    shape: rectangle
    style.fill: "#ED7D31"
    style.font-color: white
  }
  pm: "Protected Mode" {
    shape: rectangle
    style.fill: "#7030A0"
    style.font-color: white
  }
  kern: "Kernel" {
    shape: rectangle
    style.fill: "#00B050"
    style.font-color: white
  }
}