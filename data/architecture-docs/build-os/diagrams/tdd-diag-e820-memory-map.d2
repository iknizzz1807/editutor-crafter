vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # E820 Memory Map Parsing & Frame Allocator Initialization
| {near: top-center}

direction: right

e820_raw: "BIOS E820 Buffer" {
  shape: cylinder
  style.fill: "#E8D4F0"
  
  entry0: "Entry[0]" {
    shape: rectangle
    style.fill: "#E8D4F0"
    desc: |md
      base=0x00000000
      len=0x0009FC00
      type=1 (USABLE)
    |
  }
  entry1: "Entry[1]" {
    shape: rectangle
    style.fill: "#F4B4B4"
    desc: |md
      base=0x0009FC00
      len=0x00000400
      type=2 (RESERVED)
    |
  }
  entry2: "Entry[2]" {
    shape: rectangle
    style.fill: "#E8D4F0"
    desc: |md
      base=0x00100000
      len=0x1EFF0000
      type=1 (USABLE)
    |
  }
  entry3: "Entry[3]" {
    shape: rectangle
    style.fill: "#B4D4F4"
    desc: |md
      base=0x20000000
      len=0x00400000
      type=3 (ACPI)
    |
  }
  entry4: "Entry[4]" {
    shape: rectangle
    style.fill: "#F4B4B4"
    desc: |md
      base=0xFFFC0000
      len=0x00040000
      type=2 (RESERVED)
    |
  }
}

parser: "E820 Parser" {
  style.fill: "#DEE1EB"
  
  parse_entry: parse_e820_entry {
    shape: class
    base: uint64_t
    length: uint64_t
    type: uint32_t
    ext_attrs: uint32_t
  }
  
  filter: "Filter & Validate" {
    shape: rectangle
    style.fill: "#DEE1EB"
    desc: |md
      - Remove zero-length entries
      - Merge adjacent same-type
      - Sort by base address
      - Clip to 4GB for 32-bit
    |
  }
}

memory_regions: "Processed Regions" {
  style.fill: "#F5F5F5"
  
  usable: "Usable Memory" {
    shape: rectangle
    style.fill: "#C8E6C9"
    desc: |md
      Region 0: 0x0000 - 0x9FC00
      Region 1: 0x100000 - 0x1FFFFFFF
      Total: ~512MB available
    |
  }
  
  reserved: Reserved {
    shape: rectangle
    style.fill: "#FFCDD2"
    desc: |md
      BIOS EBDA: 0x9FC00-0x9FFFF
      ACPI tables: 0x20000000-0x203FFFFF
      BIOS ROM: 0xFFFC0000-0xFFFFFFFF
    |
  }
}

frame_allocator: "Frame Allocator Init" {
  style.fill: "#B5AFF6"
  
  bitmap: "Frame Bitmap" {
    shape: rectangle
    style.fill: "#E4DBFE"
    desc: |md
      sizeof=32KB for 512MB
      Each bit = 1 frame (4KB)
      0 = free, 1 = allocated
      
      Bitmap at: 0x100000
      End mark: 0x108000
    |
  }
  
  init: frame_allocator_init {
    shape: class
    bitmap_base: void*
    total_frames: size_t
    free_frames: size_t
    first_free: size_t
  }
  
  mark: "Mark Regions" {
    shape: rectangle
    style.fill: "#E4DBFE"
    desc: |md
      Step 1: Zero entire bitmap
      Step 2: Mark reserved regions
      Step 3: Mark kernel image
      Step 4: Mark bitmap itself
      Step 5: Count free frames
    |
  }
}

final_state: "Allocator Ready" {
  style.fill: "#88DCF7"
  
  alloc: alloc_frame {
    shape: class
    returns: phys_addr_t
  }
  
  free: free_frame {
    shape: class
    addr: phys_addr_t
    returns: void
  }
  
  stats: |md
    State After Init:
    
    total_frames = 131072
    free_frames  = 128000
    first_free   = 0x2000
  |
}

e820_raw -> parser: "int 0x15, EAX=0xE820"
parser -> memory_regions: validated entries
memory_regions.usable -> frame_allocator.mark: usable regions
memory_regions.reserved -> frame_allocator.mark: reserved regions
frame_allocator.mark -> frame_allocator.bitmap: set bits
frame_allocator.bitmap -> final_state: ready

legend: {
  near: bottom-center
  shape: rectangle
  style.fill: "#FAFAFA"
  content: |md
    E820 Memory Types
    
    Type 1 (USABLE): RAM, can be allocated
    Type 2 (RESERVED): BIOS, ROM, unavailable
    Type 3 (ACPI Reclaim): ACPI tables (reclaimable after init)
    Type 4 (ACPI NVS): ACPI non-volatile storage
    Type 5 (Unusable): Bad memory
  |
}