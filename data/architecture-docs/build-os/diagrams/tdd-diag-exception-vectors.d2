vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # CPU Exception Vectors and Error Codes
  x86 Architecture Reference
| {near: top-center}

classes: {
  exception-row: {
    style: {
      font: mono
      font-size: 18
    }
  }
  vector-header: {
    style: {
      bold: true
      fill: "#4A5568"
      font-color: white
    }
  }
  fault: {
    style.fill: "#FED7D7"
  }
  trap: {
    style.fill: "#C6F6D5"
  }
  abort: {
    style.fill: "#FEEBC8"
  }
  interrupt: {
    style.fill: "#BEE3F8"
  }
  error-code-box: {
    style: {
      fill: "#E2E8F0"
      border-radius: 4
    }
  }
}

exception_vectors: "Exception Vectors (0-31)" {
  grid-columns: 5
  grid-gap: 0
  
  header_vec: "Vector" {class: vector-header}
  header_name: "Exception" {class: vector-header}
  header_type: "Type" {class: vector-header}
  header_error: "Error Code" {class: vector-header}
  header_source: "Source" {class: vector-header}

  vec0: "#0 (0x00)" {class: [exception-row; fault]}
  name0: "#DE" {class: [exception-row; fault]}
  type0: Fault {class: [exception-row; fault]}
  err0: "No" {class: [exception-row; fault]}
  src0: "DIV/IDIV" {class: [exception-row; fault]}

  vec1: "#1 (0x01)" {class: [exception-row; trap]}
  name1: "#DB" {class: [exception-row; trap]}
  type1: Fault/Trap {class: [exception-row; trap]}
  err1: "No" {class: [exception-row; trap]}
  src1: "INT1/DR0-3" {class: [exception-row; trap]}

  vec2: "#2 (0x02)" {class: [exception-row; interrupt]}
  name2: "NMI" {class: [exception-row; interrupt]}
  type2: Interrupt {class: [exception-row; interrupt]}
  err2: "No" {class: [exception-row; interrupt]}
  src2: "External" {class: [exception-row; interrupt]}

  vec3: "#3 (0x03)" {class: [exception-row; trap]}
  name3: "#BP" {class: [exception-row; trap]}
  type3: Trap {class: [exception-row; trap]}
  err3: "No" {class: [exception-row; trap]}
  src3: "INT3" {class: [exception-row; trap]}

  vec4: "#4 (0x04)" {class: [exception-row; trap]}
  name4: "#OF" {class: [exception-row; trap]}
  type4: Trap {class: [exception-row; trap]}
  err4: "No" {class: [exception-row; trap]}
  src4: "INTO" {class: [exception-row; trap]}

  vec5: "#5 (0x05)" {class: [exception-row; fault]}
  name5: "#BR" {class: [exception-row; fault]}
  type5: Fault {class: [exception-row; fault]}
  err5: "No" {class: [exception-row; fault]}
  src5: "BOUND" {class: [exception-row; fault]}

  vec6: "#6 (0x06)" {class: [exception-row; fault]}
  name6: "#UD" {class: [exception-row; fault]}
  type6: Fault {class: [exception-row; fault]}
  err6: "No" {class: [exception-row; fault]}
  src6: "Invalid opcode" {class: [exception-row; fault]}

  vec7: "#7 (0x07)" {class: [exception-row; fault]}
  name7: "#NM" {class: [exception-row; fault]}
  type7: Fault {class: [exception-row; fault]}
  err7: "No" {class: [exception-row; fault]}
  src7: "FPU/ESC" {class: [exception-row; fault]}

  vec8: "#8 (0x08)" {class: [exception-row; abort]}
  name8: "#DF" {class: [exception-row; abort]}
  type8: Abort {class: [exception-row; abort]}
  err8: "Yes (0)" {class: [exception-row; abort]}
  src8: "Double fault" {class: [exception-row; abort]}

  vec9: "#9 (0x09)" {class: [exception-row; fault]}
  name9: "#MF" {class: [exception-row; fault]}
  type9: Fault {class: [exception-row; fault]}
  err9: "No" {class: [exception-row; fault]}
  src9: "FPU segment" {class: [exception-row; fault]}

  vec10: "#10 (0x0A)" {class: [exception-row; fault]}
  name10: "#TS" {class: [exception-row; fault]}
  type10: Fault {class: [exception-row; fault]}
  err10: "Yes" {class: [exception-row; fault]}
  src10: "TSS invalid" {class: [exception-row; fault]}

  vec11: "#11 (0x0B)" {class: [exception-row; fault]}
  name11: "#NP" {class: [exception-row; fault]}
  type11: Fault {class: [exception-row; fault]}
  err11: "Yes" {class: [exception-row; fault]}
  src11: "Segment not present" {class: [exception-row; fault]}

  vec12: "#12 (0x0C)" {class: [exception-row; fault]}
  name12: "#SS" {class: [exception-row; fault]}
  type12: Fault {class: [exception-row; fault]}
  err12: "Yes" {class: [exception-row; fault]}
  src12: "Stack fault" {class: [exception-row; fault]}

  vec13: "#13 (0x0D)" {class: [exception-row; fault]}
  name13: "#GP" {class: [exception-row; fault]}
  type13: Fault {class: [exception-row; fault]}
  err13: "Yes" {class: [exception-row; fault]}
  src13: "General protection" {class: [exception-row; fault]}

  vec14: "#14 (0x0E)" {class: [exception-row; fault]}
  name14: "#PF" {class: [exception-row; fault]}
  type14: Fault {class: [exception-row; fault]}
  err14: "Yes" {class: [exception-row; fault]}
  src14: "Page fault" {class: [exception-row; fault]}

  vec15: "#15 (0x0F)" {class: exception-row}
  name15: "Reserved" {class: exception-row}
  type15: "-" {class: exception-row}
  err15: "-" {class: exception-row}
  src15: "-" {class: exception-row}

  vec16: "#16 (0x10)" {class: [exception-row; fault]}
  name16: "#MF" {class: [exception-row; fault]}
  type16: Fault {class: [exception-row; fault]}
  err16: "No" {class: [exception-row; fault]}
  src16: "FPU error" {class: [exception-row; fault]}

  vec17: "#17 (0x11)" {class: [exception-row; fault]}
  name17: "#AC" {class: [exception-row; fault]}
  type17: Fault {class: [exception-row; fault]}
  err17: "Yes (0)" {class: [exception-row; fault]}
  src17: "Alignment check" {class: [exception-row; fault]}

  vec18: "#18 (0x12)" {class: [exception-row; abort]}
  name18: "#MC" {class: [exception-row; abort]}
  type18: Abort {class: [exception-row; abort]}
  err18: "No" {class: [exception-row; abort]}
  src18: "Machine check" {class: [exception-row; abort]}

  vec19: "#19 (0x13)" {class: [exception-row; fault]}
  name19: "#XM" {class: [exception-row; fault]}
  type19: Fault {class: [exception-row; fault]}
  err19: "No" {class: [exception-row; fault]}
  src19: "SIMD FP" {class: [exception-row; fault]}

  vec20: "#20 (0x14)" {class: [exception-row; fault]}
  name20: "#VE" {class: [exception-row; fault]}
  type20: Fault {class: [exception-row; fault]}
  err20: "No" {class: [exception-row; fault]}
  src20: "Virtualization" {class: [exception-row; fault]}

  vec21_31: "#21-31" {class: exception-row}
  name21_31: "Reserved" {class: exception-row}
  type21_31: "-" {class: exception-row}
  err21_31: "-" {class: exception-row}
  src21_31: "-" {class: exception-row}
}

legend: "Exception Types" {
  direction: right
  
  fault_legend: "Fault: Correctable, return to instruction" {class: fault}
  trap_legend: "Trap: Correctable, return to next instruction" {class: trap}
  abort_legend: "Abort: Fatal, cannot continue" {class: abort}
  int_legend: "Interrupt: External event" {class: interrupt}
}

error_code_format: "Error Code Bit Fields (32 bits)" {
  direction: right
  
  common_format: "Segment Exception Format (#TS, #NP, #SS, #GP)" {
    class: error-code-box
    
    bit_layout: ||md
      | Bit 31-16 | Bit 15-3 | Bit 2 | Bit 1 | Bit 0 |
      |-----------|----------|-------|-------|-------|
      | Reserved  | Selector | TI    | IDT   | EXT   |
    ||
  }
  
  page_fault_format: "Page Fault Format (#PF)" {
    class: error-code-box
    
    pf_layout: ||md
      | Bit 31 | Bit 30 | Bit 5-6 | Bit 4 | Bit 3 | Bit 2 | Bit 1 | Bit 0 |
      |--------|--------|---------|-------|-------|-------|-------|-------|
      | RSVD   | I/D    | PK      | I/D   | US    | WR    | PR    | P     |
    ||
  }
}

bit_field_meanings: "Error Code Bit Definitions" {
  grid-columns: 3
  grid-gap: 2
  
  hdr_bit: "Bit" {class: vector-header}
  hdr_name: "Name" {class: vector-header}
  hdr_meaning: "Meaning" {class: vector-header}
  
  b0_ext: "0 (EXT)" {class: exception-row}
  n0_ext: "External" {class: exception-row}
  m0_ext: "Exception from external event (NMI, interrupt)" {class: exception-row}
  
  b1_idt: "1 (IDT)" {class: exception-row}
  n1_idt: "IDT Flag" {class: exception-row}
  m1_idt: "Selector from IDT (interrupt gate)" {class: exception-row}
  
  b2_ti: "2 (TI)" {class: exception-row}
  n2_ti: "Table Indicator" {class: exception-row}
  m2_ti: "0=GDT, 1=LDT" {class: exception-row}
  
  b3_15: "3-15" {class: exception-row}
  n3_15: "Selector" {class: exception-row}
  m3_15: "Segment selector index causing exception" {class: exception-row}
  
  pf0_p: "0 (P)" {class: exception-row}
  pfn0_p: "Present" {class: exception-row}
  pfm0_p: "0=Page not present, 1=Protection violation" {class: exception-row}
  
  pf1_wr: "1 (W/R)" {class: exception-row}
  pfn1_wr: "Write/Read" {class: exception-row}
  pfm1_wr: "0=Read access, 1=Write access" {class: exception-row}
  
  pf2_us: "2 (U/S)" {class: exception-row}
  pfn2_us: "User/Supervisor" {class: exception-row}
  pfm2_us: "0=Supervisor mode, 1=User mode" {class: exception-row}
  
  pf3_rsvd: "3 (RSVD)" {class: exception-row}
  pfn3_rsvd: "Reserved" {class: exception-row}
  pfm3_rsvd: "1=Reserved bits set in page table" {class: exception-row}
  
  pf4_id: "4 (I/D)" {class: exception-row}
  pfn4_id: "Instruction Fetch" {class: exception-row}
  pfm4_id: "1=Instruction fetch caused fault" {class: exception-row}
}

critical_registers: "Associated Registers" {
  direction: right
  
  cr2_info: ||md
    ### CR2 (Page Fault Address)
    Contains the linear address that caused #PF
    
    
    mov eax, cr2    ; Get faulting address
    
  ||
  
  cr3_info: ||md
    ### CR3 (Page Directory Base)
    Contains PDBR, must be valid before enabling paging
  ||
  
  gdtr_info: ||md
    ### GDTR (GDT Register)
    Base + Limit for Global Descriptor Table
    
    
    sgdt [gdtr_ptr]
    
  ||
}

handler_stack_layout: "Exception Handler Stack Frame" {
  direction: right
  
  no_error: "Without Error Code (pushed by CPU)" {
    class: error-code-box
    stack1: ||md
      | Offset | Value |
      |--------|-------|
      | SS     | Old stack segment (if CPL change) |
      | ESP    | Old stack pointer (if CPL change) |
      | EFLAGS | Old EFLAGS |
      | CS     | Old code segment |
      | EIP    | Return address |
    ||
  }
  
  with_error: "With Error Code" {
    class: error-code-box
    stack2: ||md
      | Offset | Value |
      |--------|-------|
      | ...    | (same as above) |
      | EIP    | Return address |
      | ERROR  | Error code (pushed by CPU) |
    ||
  }
}

handler_stub: "Exception Handler Assembly Stub" {
  code: ||asm
    ; Macro for exceptions WITHOUT error code
    %macro ISR_NOERR 1
    global isr%1
    isr%1:
        push dword 0            ; Push dummy error code
        push dword %1           ; Push interrupt number
        jmp  isr_common_stub
    %endmacro

    ; Macro for exceptions WITH error code
    %macro ISR_ERR 1
    global isr%1
    isr%1:
        push dword %1           ; Push interrupt number
        jmp  isr_common_stub
    %endmacro

    ; Usage:
    ISR_NOERR 0   ; #DE - Divide Error
    ISR_NOERR 3   ; #BP - Breakpoint
    ISR_ERR   8   ; #DF - Double Fault
    ISR_ERR   13  ; #GP - General Protection
    ISR_ERR   14  ; #PF - Page Fault
  ||
}