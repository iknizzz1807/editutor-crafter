vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # GDT Entry Structure & Segment Selectors
  sizeof(GDT Entry) = 8 bytes
| {near: top-center}

direction: right

gdt_entry: "GDT Entry (8 bytes)" {
  grid-columns: 1
  grid-gap: 0
  
  byte7: |md
    +7
  | {
    style.fill: transparent
    style.stroke: transparent
  }
  
  byte6: |md
    +6
  | {
    style.fill: transparent
    style.stroke: transparent
  }
  
  byte5: |md
    +5
  | {
    style.fill: "#E8D5F0"
    style.stroke: "#8B5CF6"
  }
  
  byte4: |md
    +4
  | {
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
  }
  
  byte3: |md
    +3
  | {
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
  
  byte2: |md
    +2
  | {
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
  
  byte1: |md
    +1
  | {
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
  
  byte0: |md
    +0
  | {
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
}

legend: {
  near: top-right
  header: |md
    ## Field Colors
  | {
    style.fill: transparent
    style.stroke: transparent
  }
  
  base: "Base Address" {
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
  
  limit: "Segment Limit" {
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
  }
  
  access: "Access Byte" {
    style.fill: "#E8D5F0"
    style.stroke: "#8B5CF6"
  }
  
  flags: Flags {
    style.fill: "#FEF3C7"
    style.stroke: "#F59E0B"
  }
}

field_breakdown: "Field Layout" {
  direction: right
  
  limit_low: "Limit[15:0]" {
    style.fill: "#D1FAE5"
    width: 120
  }
  
  base_low: "Base[15:0]" {
    style.fill: "#DBEAFE"
    width: 120
  }
  
  base_mid: "Base[23:16]" {
    style.fill: "#DBEAFE"
    width: 120
  }
  
  access_byte: "Access Byte" {
    style.fill: "#E8D5F0"
    width: 120
  }
  
  limit_flags: "Limit[19:16] + Flags" {
    style.fill: "#D1FAE5"
    width: 120
  }
  
  base_high: "Base[31:24]" {
    style.fill: "#DBEAFE"
    width: 120
  }
  
  limit_low -> base_low -> base_mid -> access_byte -> limit_flags -> base_high
}

access_byte_detail: "Access Byte (Byte 5)" {
  grid-columns: 8
  grid-gap: 0
  
  p: P {
    style.fill: "#FEE2E2"
    width: 40
    tooltip: "Present (1=segment present)"
  }
  
  dpl2: DPL {
    style.fill: "#FEF3C7"
    width: 40
    tooltip: "Descriptor Privilege Level (0-3)"
  }
  
  dpl1: DPL {
    style.fill: "#FEF3C7"
    width: 40
  }
  
  s: S {
    style.fill: "#E0E7FF"
    width: 40
    tooltip: "System (0=system, 1=code/data)"
  }
  
  e: E {
    style.fill: "#DBEAFE"
    width: 40
    tooltip: "Executable (1=code, 0=data)"
  }
  
  dc: DC {
    style.fill: "#D1FAE5"
    width: 40
    tooltip: "Direction/Conforming"
  }
  
  rw: RW {
    style.fill: "#FCE7F3"
    width: 40
    tooltip: "Readable/Writable"
  }
  
  a: A {
    style.fill: "#F3E8FF"
    width: 40
    tooltip: "Accessed (set by CPU)"
  }
  
  p -> dpl2 -> dpl1 -> s -> e -> dc -> rw -> a
}

flags_detail: "Flags Byte (Byte 6, high nibble)" {
  grid-columns: 4
  grid-gap: 0
  
  g: G {
    style.fill: "#FEE2E2"
    width: 60
    tooltip: "Granularity (0=byte, 1=4KB)"
  }
  
  db: "D/B" {
    style.fill: "#FEF3C7"
    width: 60
    tooltip: "Default size (0=16-bit, 1=32-bit)"
  }
  
  l: L {
    style.fill: "#E0E7FF"
    width: 60
    tooltip: "Long mode (1=64-bit code)"
  }
  
  avl: AVL {
    style.fill: "#F3F4F6"
    width: 60
    tooltip: "Available for OS use"
  }
  
  g -> db -> l -> avl
}

selector: "Segment Selector (16 bits)" {
  grid-columns: 3
  grid-gap: 0
  
  index: "Index[15:3]" {
    style.fill: "#DBEAFE"
    width: 180
    tooltip: "GDT index (entry = GDT + index * 8)"
  }
  
  ti: TI {
    style.fill: "#FEF3C7"
    width: 60
    tooltip: "Table Indicator (0=GDT, 1=LDT)"
  }
  
  rpl: "RPL[1:0]" {
    style.fill: "#FEE2E2"
    width: 80
    tooltip: "Requested Privilege Level"
  }
  
  index -> ti -> rpl
}

offset_annotations: {
  near: center-left
  
  byte0_label: |md
    Offset 0x00
  | {
    style.fill: transparent
    style.stroke: transparent
  }
}

example_selectors: "Example Selectors" {
  direction: right
  
  kernel_cs: "0x08" {
    tooltip: "Index=1, TI=0, RPL=0\nKernel Code Segment"
    style.fill: "#D1FAE5"
  }
  
  kernel_ds: "0x10" {
    tooltip: "Index=2, TI=0, RPL=0\nKernel Data Segment"
    style.fill: "#DBEAFE"
  }
  
  user_cs: "0x1B" {
    tooltip: "Index=3, TI=0, RPL=3\nUser Code Segment"
    style.fill: "#FEE2E2"
  }
  
  user_ds: "0x23" {
    tooltip: "Index=4, TI=0, RPL=3\nUser Data Segment"
    style.fill: "#FEF3C7"
  }
  
  tss: "0x28" {
    tooltip: "Index=5, TI=0, RPL=0\nTask State Segment"
    style.fill: "#E0E7FF"
  }
}

example_selectors_desc: |md
  0x08 = 00001 0 00 → GDT[1], RPL=0 (kernel CS)
  0x10 = 00010 0 00 → GDT[2], RPL=0 (kernel DS)
  0x1B = 00011 0 11 → GDT[3], RPL=3 (user CS)
  0x23 = 00100 0 11 → GDT[4], RPL=3 (user DS)
  0x28 = 00101 0 00 → GDT[5], RPL=0 (TSS)
| {
  near: bottom-center
  style.fill: "#F9FAFB"
  style.stroke: "#E5E7EB"
}

size_annotation: |md
  sizeof(GDT Entry) = 8 bytes
  Total GDT size = 6 entries × 8 = 48 bytes (minimum)
| {
  near: bottom-right
  style.fill: "#F3F4F6"
  style.stroke: "#9CA3AF"
}