vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Identity and Higher-Half Address Space Layout" {
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
  }
}

address_space: {
  direction: right
  
  addresses: {
    shape: text
    label: ""
    
    addr_0: {
      shape: text
      label: "0x00000000"
      style.font: mono
      style.font-size: 14
    }
    addr_1mb: {
      shape: text
      label: "0x00100000"
      style.font: mono
      style.font-size: 14
    }
    addr_vga: {
      shape: text
      label: "0x000B8000"
      style.font: mono
      style.font-size: 14
    }
    addr_4mb: {
      shape: text
      label: "0x00400000"
      style.font: mono
      style.font-size: 14
    }
    addr_16mb: {
      shape: text
      label: "0x01000000"
      style.font: mono
      style.font-size: 14
    }
    addr_kernel: {
      shape: text
      label: "0xC0000000"
      style.font: mono
      style.font-size: 14
      style.bold: true
    }
    addr_4gb: {
      shape: text
      label: "0xFFFFFFFF"
      style.font: mono
      style.font-size: 14
    }
  }
  
  regions: {
    direction: down
    grid-rows: 7
    grid-gap: 2
    
    null_region: "NULL (Unmapped)" {
      width: 400
      height: 40
      style.fill: gray
      style.stroke: darkgray
      style.font-color: white
    }
    
    identity_low: "Identity-Mapped Low Memory" {
      width: 400
      height: 60
      style.fill: "#4A90D9"
      style.stroke: "#2E5A8C"
      style.font-color: white
    }
    
    vga: "VGA Text Buffer\n0xB8000 (identity mapped)" {
      width: 400
      height: 50
      style.fill: "#8B5CF6"
      style.stroke: "#5B3AA6"
      style.font-color: white
      style.bold: true
    }
    
    identity_high: "Identity-Mapped Continuation" {
      width: 400
      height: 50
      style.fill: "#4A90D9"
      style.stroke: "#2E5A8C"
      style.font-color: white
    }
    
    gap: "Unmapped (Gap)" {
      width: 400
      height: 40
      style.fill: gray
      style.stroke: darkgray
      style.font-color: white
    }
    
    kernel: "Higher-Half Kernel\n(CODE + DATA + HEAP)" {
      width: 400
      height: 80
      style.fill: "#E74C3C"
      style.stroke: "#A83226"
      style.font-color: white
      style.bold: true
    }
    
    kernel_end: "Kernel Space\n(User processes below 0xC0000000)" {
      width: 400
      height: 60
      style.fill: "#2ECC71"
      style.stroke: "#1E8449"
      style.font-color: white
    }
  }
}

legend: |md
  **Memory Layout (sizeof=4GB virtual)**
  
  
  0x00000000 - NULL guard page (unmapped)
  0x00100000 - 1 MB: Identity-mapped physical memory
                (boot loader, low memory structures)
  0x000B8000 - VGA text buffer (purple)
                Mapped at both 0xB8000 and 0xC00B8000
  0x01000000 - 16 MB: End of identity-mapped region
  0xC0000000 - Higher-half kernel base (red)
                Kernel code, data, heap, page tables
                Virtual → Physical: vaddr - 0xC0000000
  0xFFFFFFFF - End of kernel space
                User processes limited to < 0xC0000000
  
  
  **Page Table Entry for VGA (0xB8000):**
    Physical: 0x000B8 | Flags: P=1, R/W=1, U/S=0
    Virtual:  0x000B8000 (identity) and 0xC00B8000 (higher-half)
|
legend.near: bottom-center

vga_note: "VGA: 80×25 text, 2 bytes/char\nAttribute byte + ASCII byte" {
  near: address_space.regions.vga
  shape: text
  style.font-size: 12
  style.font-color: "#8B5CF6"
}