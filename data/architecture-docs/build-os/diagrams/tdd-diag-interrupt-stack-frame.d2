vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Interrupt Stack Frame Layout
  x86 Protected Mode (32-bit)
| {
  near: top-center
  shape: text
  style: {
    font-size: 20
    bold: true
  }
}

stack_frame: {
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a6a"
    stroke-width: 2
  }

  legend: |md
    **Stack grows downward (↑)**
    Higher addresses at bottom
  | {
    near: top-center
    shape: text
    style: {
      font-color: "#888888"
      font-size: 12
    }
  }

  entry_ss: {
    label: |md
      **SS**
      `0x+00`
      Stack Segment (ring 3 only)
    |
    style: {
      fill: "#9b59b6"
      stroke: "#8e44ad"
      font-color: white
      stroke-width: 1
    }
  }

  entry_esp: {
    label: |md
      **ESP**
      `0x+04`
      User Stack Pointer (ring 3 only)
    |
    style: {
      fill: "#9b59b6"
      stroke: "#8e44ad"
      font-color: white
      stroke-width: 1
    }
  }

  note_privilege: |md
    *Pushed by CPU only on privilege level change*
    *(Ring 3 → Ring 0)*
  | {
    shape: text
    style: {
      font-color: "#9b59b6"
      font-size: 11
      italic: true
    }
  }

  entry_eflags: {
    label: |md
      **EFLAGS**
      `0x+08` / `0x+00`
      Processor Flags Register
    |
    style: {
      fill: "#e74c3c"
      stroke: "#c0392b"
      font-color: white
      stroke-width: 1
    }
  }

  entry_cs: {
    label: |md
      **CS**
      `0x+0C` / `0x+04`
      Code Segment Selector
    |
    style: {
      fill: "#e74c3c"
      stroke: "#c0392b"
      font-color: white
      stroke-width: 1
    }
  }

  entry_eip: {
    label: |md
      **EIP**
      `0x+10` / `0x+08`
      Instruction Pointer (Return Address)
    |
    style: {
      fill: "#e74c3c"
      stroke: "#c0392b"
      font-color: white
      stroke-width: 1
    }
  }

  note_cpu: |md
    *Always pushed by CPU*
  | {
    shape: text
    style: {
      font-color: "#e74c3c"
      font-size: 11
      italic: true
    }
  }

  entry_error: {
    label: |md
      **Error Code**
      `0x+14` / `0x+0C`
      Exception-specific (optional)
    |
    style: {
      fill: "#f39c12"
      stroke: "#d68910"
      font-color: white
      stroke-width: 1
    }
  }

  note_error: |md
    *Pushed for: #8, #10, #11, #12, #13, #14, #17, #30*
    *(Page Fault, GPF, Double Fault, etc.)*
  | {
    shape: text
    style: {
      font-color: "#f39c12"
      font-size: 11
      italic: true
    }
  }

  entry_eax: {
    label: |md
      **EAX**
      `+0/+4`
      General Purpose
    |
    style: {
      fill: "#3498db"
      stroke: "#2980b9"
      font-color: white
      stroke-width: 1
    }
  }

  entry_ebx: {
    label: |md
      **EBX**
      `+4/+8`
      General Purpose
    |
    style: {
      fill: "#3498db"
      stroke: "#2980b9"
      font-color: white
      stroke-width: 1
    }
  }

  entry_ecx: {
    label: |md
      **ECX**
      `+8/+12`
      General Purpose
    |
    style: {
      fill: "#3498db"
      stroke: "#2980b9"
      font-color: white
      stroke-width: 1
    }
  }

  entry_edx: {
    label: |md
      **EDX**
      `+12/+16`
      General Purpose
    |
    style: {
      fill: "#3498db"
      stroke: "#2980b9"
      font-color: white
      stroke-width: 1
    }
  }

  entry_esi: {
    label: |md
      **ESI**
      `+16/+20`
      Source Index
    |
    style: {
      fill: "#3498db"
      stroke: "#2980b9"
      font-color: white
      stroke-width: 1
    }
  }

  entry_edi: {
    label: |md
      **EDI**
      `+20/+24`
      Destination Index
    |
    style: {
      fill: "#3498db"
      stroke: "#2980b9"
      font-color: white
      stroke-width: 1
    }
  }

  entry_ebp: {
    label: |md
      **EBP**
      `+24/+28`
      Base Pointer
    |
    style: {
      fill: "#3498db"
      stroke: "#2980b9"
      font-color: white
      stroke-width: 1
    }
  }

  entry_ds: {
    label: |md
      **DS**
      `+28/+32`
      Data Segment
    |
    style: {
      fill: "#e67e22"
      stroke: "#d35400"
      font-color: white
      stroke-width: 1
    }
  }

  entry_es: {
    label: |md
      **ES**
      `+30/+36`
      Extra Segment
    |
    style: {
      fill: "#e67e22"
      stroke: "#d35400"
      font-color: white
      stroke-width: 1
    }
  }

  entry_fs: {
    label: |md
      **FS**
      `+32/+40`
      Extra Segment
    |
    style: {
      fill: "#e67e22"
      stroke: "#d35400"
      font-color: white
      stroke-width: 1
    }
  }

  entry_gs: {
    label: |md
      **GS**
      `+36/+44`
      Extra Segment
    |
    style: {
      fill: "#e67e22"
      stroke: "#d35400"
      font-color: white
      stroke-width: 1
    }
  }

  note_handler: |md
    *Pushed by ISR handler (pusha + segment pushes)*
  | {
    shape: text
    style: {
      font-color: "#3498db"
      font-size: 11
      italic: true
    }
  }

  entry_esp_syscall: {
    label: |md
      **ESP (saved)**
      `+40/+48`
      Kernel Stack Ptr
    |
    style: {
      fill: "#27ae60"
      stroke: "#1e8449"
      font-color: white
      stroke-width: 1
    }
  }

  note_final: |md
    *Pushed manually to complete trap frame*
    *→ `struct regs_t` complete here*
  | {
    shape: text
    style: {
      font-color: "#27ae60"
      font-size: 11
      italic: true
    }
  }
}

size_annotation: {
  style: {
    fill: "#2c3e50"
    stroke: "#1a252f"
    stroke-width: 2
  }

  header: |md
    ### Total Frame Size
  | {
    shape: text
    style: {
      font-color: white
      bold: true
    }
  }

  ring3_size: {
    label: |md
      **Ring 3 → Ring 0:**
      `52 bytes` (13 × 4)
      
      SS+ESP = 8
      EFLAGS+CS+EIP = 12
      Error? = 0/4
      GPRegs×6 = 24
      SegRegs×4 = 16
      ESP = 4
    |
    style: {
      fill: "#34495e"
      font-color: "#ecf0f1"
      font: mono
    }
  }

  ring0_size: {
    label: |md
      **Ring 0 → Ring 0:**
      `44 bytes` (11 × 4)
      
      (no SS/ESP push)
      EFLAGS+CS+EIP = 12
      Error? = 0/4
      GPRegs×6 = 24
      SegRegs×4 = 16
      ESP = 4
    |
    style: {
      fill: "#34495e"
      font-color: "#ecf0f1"
      font: mono
    }
  }
}

color_legend: {
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a6a"
    stroke-width: 2
  }

  header: |md
    ### Color Legend
  | {
    shape: text
    style: {
      font-color: white
      bold: true
    }
  }

  purple_box: {
    label: "Privilege Switch Data"
    style: {
      fill: "#9b59b6"
      stroke: "#8e44ad"
      font-color: white
    }
  }

  red_box: {
    label: "CPU-Pushed (Always)"
    style: {
      fill: "#e74c3c"
      stroke: "#c0392b"
      font-color: white
    }
  }

  orange_box: {
    label: "Error Code (Optional)"
    style: {
      fill: "#f39c12"
      stroke: "#d68910"
      font-color: white
    }
  }

  blue_box: {
    label: "Handler-Pushed GP Regs"
    style: {
      fill: "#3498db"
      stroke: "#2980b9"
      font-color: white
    }
  }

  dark_orange_box: {
    label: "Handler-Pushed Seg Regs"
    style: {
      fill: "#e67e22"
      stroke: "#d35400"
      font-color: white
    }
  }

  green_box: {
    label: "Manual Push (regs_t end)"
    style: {
      fill: "#27ae60"
      stroke: "#1e8449"
      font-color: white
    }
  }

  gray_box: {
    label: "Padding / Free Space"
    style: {
      fill: "#7f8c8d"
      stroke: "#5d6d7e"
      font-color: white
    }
  }
}

growth_arrow: {
  shape: text
  label: |md
    
    ▲
    │
    │  Stack grows UP
    │  (toward lower addresses)
    │
    ▼
    
  |
  style: {
    font-color: "#ecf0f1"
    font: mono
  }
}

struct_def: {
  style: {
    fill: "#2c3e50"
    stroke: "#1a252f"
    stroke-width: 2
  }

  header: |md
    ### `struct regs_t` Definition
  | {
    shape: text
    style: {
      font-color: white
      bold: true
    }
  }

  code: ||c
    // Interrupt/Trap Frame (44 bytes)
    typedef struct regs {
        uint32_t gs, fs, es, ds;      // +0  : Segments
        uint32_t edi, esi, ebp;       // +16 : Pointers
        uint32_t esp;                 // +28 : Saved kernel ESP
        uint32_t ebx, edx, ecx, eax;  // +32 : GP Registers
        uint32_t err;                 // +48 : Error code (0 if none)
        uint32_t eip, cs, eflags;     // +52 : CPU state
        uint32_t esp3, ss3;           // +64 : Ring 3 stack (if CPL≠0)
    } regs_t;  // sizeof = 72 bytes max
||
}

exceptions_table: {
  style: {
    fill: "#2c3e50"
    stroke: "#1a252f"
    stroke-width: 2
  }

  header: |md
    ### Exceptions with Error Codes
  | {
    shape: text
    style: {
      font-color: white
      bold: true
    }
  }

  table: {
    shape: sql_table
    vector: int {constraint: primary_key}
    mnemonic: string
    name: string
    error_bits: string
  }
}

page_fault_bits: {
  style: {
    fill: "#2c3e50"
    stroke: "#1a252f"
    stroke-width: 2
  }

  header: |md
    ### Page Fault Error Code (CR2 = faulting address)
  | {
    shape: text
    style: {
      font-color: white
      bold: true
    }
  }

  bitfield: {
    style: {
      fill: "#1e272e"
      stroke: "#4a4a6a"
    }
  }

  bits: |md
    Bit 0 (P):    0 = Not-present  | 1 = Protection violation
    Bit 1 (R/W):  0 = Read         | 1 = Write
    Bit 2 (U/S):  0 = Supervisor   | 1 = User
    Bit 3 (R):    0 = Reserved     | 1 = Reserved bit set
    Bit 4 (I/D):  0 = Instruction  | 1 = Instruction fetch
  | {
    shape: text
    style: {
      font: mono
      font-size: 11
      font-color: "#ecf0f1"
    }
  }
}

iret_frame: {
  style: {
    fill: "#2c3e50"
    stroke: "#1a252f"
    stroke-width: 2
  }

  header: |md
    ### `IRET` Recovery Sequence
  | {
    shape: text
    style: {
      font-color: white
      bold: true
    }
  }

  code: ||asm
    ; Restore from struct regs_t
    add esp, 4           ; Skip saved ESP
    pop gs, fs, es, ds   ; Restore segments
    popa                 ; Restore GP regs
    add esp, 4           ; Skip error code
    
    ; IRET pops: EIP, CS, EFLAGS
    ;         and: ESP, SS (if privilege change)
    iret                 ; Return from interrupt
||
}

stack_frame -> size_annotation: {
  style: {
    stroke: "#4a4a6a"
    stroke-dash: 3
  }
}

stack_frame -> color_legend: {
  style: {
    stroke: "#4a4a6a"
    stroke-dash: 3
  }
}

stack_frame -> struct_def: {
  style: {
    stroke: "#4a4a6a"
    stroke-dash: 3
  }
}

stack_frame -> exceptions_table: {
  style: {
    stroke: "#4a4a6a"
    stroke-dash: 3
  }
}

exceptions_table -> page_fault_bits: {
  style: {
    stroke: "#e74c3c"
    stroke-dash: 2
  }
  label: "#PF most common"
}

struct_def -> iret_frame: {
  style: {
    stroke: "#27ae60"
    stroke-dash: 2
  }
  label: "Restoration"
}