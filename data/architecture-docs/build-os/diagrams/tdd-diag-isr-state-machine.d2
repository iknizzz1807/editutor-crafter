vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # ISR Handler State Machine
| {near: top-center}

direction: right

idle: ● IDLE {
  style.fill: "#E8F5E9"
  style.stroke: "#4CAF50"
  
  invariant: |md
    - IF=1 (interrupts enabled)
    - No pending IRQ
    - CPU executing normal code
  |
}

irq_asserted: IRQ ASSERTED {
  style.fill: "#FFF3E0"
  style.stroke: "#FF9800"
  style.bold: true
  
  invariant: |md
    - Hardware IRQ line asserted
    - CPU acknowledges IRQ
    - IF=0 (interrupts disabled automatically)
  |
}

cpu_pushes: CPU PUSHES FRAME {
  style.fill: "#E3F2FD"
  style.stroke: "#2196F3"
  
  invariant: |md
    - CPU pushes: SS, ESP, EFLAGS, CS, EIP
    - Stack switched if privilege change
    - Error code pushed (for some exceptions)
  |
}

stub_saves: STUB SAVES REGS {
  style.fill: "#F3E5F5"
  style.stroke: "#9C27B0"
  
  invariant: |md
    - Push DS, ES, FS, GS
    - Push EAX, EBX, ECX, EDX
    - Push ESI, EDI, EBP
    - Load kernel DS (0x10)
  |
}

c_handler: C HANDLER {
  style.fill: "#E0F7FA"
  style.stroke: "#00BCD4"
  
  invariant: |md
    - Execute ISR function
    - Process interrupt source
    - May wake blocked processes
    - May schedule new process
  |
}

stub_restores: STUB RESTORES {
  style.fill: "#F3E5F5"
  style.stroke: "#9C27B0"
  
  invariant: |md
    - Pop EBP, EDI, ESI
    - Pop EDX, ECX, EBX, EAX
    - Pop GS, FS, ES, DS
    - Add error code if present
  |
}

eoi_sent: EOI SENT {
  style.fill: "#FFF8E1"
  style.stroke: "#FFC107"
  
  invariant: |md
    - outb(0x20, 0x20) for master PIC
    - outb(0xA0, 0x20) for slave PIC
    - PIC ready for new IRQs
  |
}

iret: iret {
  style.fill: "#FFEBEE"
  style.stroke: "#F44336"
  
  invariant: |md
    - Pop EIP, CS, EFLAGS
    - Pop ESP, SS (if privilege change)
    - Return to interrupted code
  |
}

illegal: ILLEGAL {
  style.fill: "#FFCDD2"
  style.stroke: "#F44336"
  style.stroke-dash: 5
  
  label: |md
    ILLEGAL
    (IF modified in handler)
  |
}

# Transitions
idle -> irq_asserted: {
  label: "IRQ signal\nfrom device"
  style.stroke: "#4CAF50"
  style.stroke-width: 3
}

irq_asserted -> cpu_pushes: {
  label: "CPU\nacknowledges"
  style.stroke: "#FF9800"
  style.stroke-width: 2
}

cpu_pushes -> stub_saves: {
  label: "Jump to\nIDT vector"
  style.stroke: "#2196F3"
}

stub_saves -> c_handler: {
  label: "Call\nhandler(rcontext_t*)"
  style.stroke: "#9C27B0"
}

c_handler -> stub_restores: {
  label: "Return\nfrom handler"
  style.stroke: "#00BCD4"
}

stub_restores -> eoi_sent: {
  label: "Interrupt\nprocessed"
  style.stroke: "#9C27B0"
}

eoi_sent -> iret: {
  label: "PIC\nre-enabled"
  style.stroke: "#FFC107"
}

iret -> idle: {
  label: "Resume\ninterrupted code"
  style.stroke: "#F44336"
  style.stroke-width: 3
}

# Illegal transitions
idle -> illegal: {
  label: "IF=0\nblocked"
  style.stroke: "#F44336"
  style.stroke-dash: 5
  style.stroke-width: 2
}

# Annotations - using constant near values for ELK compatibility
stack_frame: |md
  ## Interrupt Stack Frame
  
  +0x00  SS (if CPL change)
  +0x04  ESP (if CPL change)
  +0x08  EFLAGS
  +0x0C  CS
  +0x10  EIP
  +0x14  Error (exception only)
  
| {near: center-left}

register_save: |md
  ## Saved Registers
  
  struct rcontext {
    edi, esi, ebp;
    edx, ecx, ebx, eax;
    gs, fs, es, ds;
    int_num, err_code;
  };
  
| {near: center-right}

timing: |md
  ## Timing Constraints
  - IRQ to IDT: ~1 μs (CPU)
  - Handler execution: < 100 μs
  - EOI to next IRQ: Immediate
  - Total latency: < 200 μs target
| {near: bottom-center}