vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Keyboard Scancode Processing Pipeline
| {near: top-center}

direction: right

# Hardware Layer
hardware: Hardware Layer {
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  
  keyboard: Physical Keyboard {
    shape: rectangle
    style.fill: "#D0D0D0"
  }
  
  kbd_controller: "Keyboard Controller\n(i8042)" {
    shape: rectangle
    style.fill: "#C0C0C0"
  }
  
  keyboard -> kbd_controller: key press {
    style.stroke: "#333333"
  }
}

# Interrupt Layer
irq_layer: Interrupt Layer {
  style.fill: "#FFE4B5"
  style.stroke: "#CD853F"
  
  pic: "PIC (8259A)" {
    shape: rectangle
    style.fill: "#FFD700"
  }
  
  irq1: "IRQ1\n(Vector 0x21)" {
    shape: diamond
    style.fill: "#FFA500"
  }
  
  pic -> irq1 {
    style.stroke: "#CD853F"
  }
}

# Data Acquisition
data_acq: Data Acquisition {
  style.fill: "#B0E0E6"
  style.stroke: "#4682B4"
  
  port_60: Read Port 0x60 {
    shape: rectangle
    style.fill: "#87CEEB"
  }
  
  raw_scancode: "Raw Scancode\n(1 byte)" {
    shape: hexagon
    style.fill: "#ADD8E6"
  }
  
  port_60 -> raw_scancode {
    style.stroke: "#4682B4"
  }
}

# Processing Pipeline
processing: Scancode Processing {
  style.fill: "#DDA0DD"
  style.stroke: "#8B008B"
  
  extended_check: Extended Check {
    shape: diamond
    style.fill: "#DA70D6"
  }
  
  extended_note: |md
    If 0xE0:
    Set extended flag
    Read next byte
  |
  
  release_check: Release Check {
    shape: diamond
    style.fill: "#BA55D3"
  }
  
  release_note: |md
    If bit 7 set:
    Key released
    Clear from state
  |
  
  ascii_lookup: "ASCII Lookup\n(scancode_map[])" {
    shape: rectangle
    style.fill: "#9932CC"
    style.font-color: "#FFFFFF"
  }
  
  extended_check -> release_check {
    style.stroke: "#8B008B"
  }
  
  release_check -> ascii_lookup {
    style.stroke: "#8B008B"
  }
}

# Output Buffer
buffer_layer: Output Buffer {
  style.fill: "#90EE90"
  style.stroke: "#228B22"
  
  key_buffer: "Keyboard Buffer\n(Ring Buffer)" {
    shape: cylinder
    style.fill: "#32CD32"
  }
  
  key_event: KeyEvent {
    shape: class
    scancode: uint8_t
    ascii: char
    flags: uint8_t
    style.fill: "#3CB371"
  }
  
  key_buffer -> key_event {
    style.stroke: "#228B22"
  }
}

# Consumer
consumer: Consumer {
  style.fill: "#F0F8FF"
  style.stroke: "#4169E1"
  
  kernel: "Kernel\n tty_read()" {
    shape: rectangle
    style.fill: "#B0C4DE"
  }
  
  user_app: User Application {
    shape: person
    style.fill: "#6495ED"
  }
  
  kernel -> user_app: read() {
    style.stroke: "#4169E1"
  }
}

# Main Flow Connections
hardware.kbd_controller -> irq_layer.pic: INT {
  style.stroke: "#FF0000"
  style.stroke-width: 3
  style.animated: true
}

irq_layer.irq1 -> data_acq.port_60: handler {
  style.stroke: "#FF4500"
  style.bold: true
}

data_acq.raw_scancode -> processing.extended_check: process {
  style.stroke: "#4B0082"
  style.bold: true
}

processing.ascii_lookup -> buffer_layer.key_buffer: store {
  style.stroke: "#006400"
  style.bold: true
}

buffer_layer.key_event -> consumer.kernel: dequeue {
  style.stroke: "#00008B"
  style.bold: true
}

# Annotations
annotation: |md
  ## Pipeline Stages
  
  1. **Hardware**: Key press triggers IRQ1
  2. **Interrupt**: PIC signals CPU, IDT dispatches handler
  3. **Acquisition**: Handler reads scancode from port 0x60
  4. **Processing**: 
     - Check for 0xE0/0xE1 extended prefix
     - Check bit 7 for release vs press
     - Look up ASCII in scancode table
  5. **Buffer**: Store KeyEvent in ring buffer
  6. **Consumer**: Kernel/user reads from buffer
| {near: bottom-right}

# Legend
legend: Legend {
  near: top-right
  
  irq_legend: IRQ Signal {
    style.fill: "#FFD700"
  }
  
  data_legend: Data Flow {
    style.fill: "#87CEEB"
  }
  
  proc_legend: Processing {
    style.fill: "#DA70D6"
  }
  
  buf_legend: Buffer {
    style.fill: "#32CD32"
  }
}