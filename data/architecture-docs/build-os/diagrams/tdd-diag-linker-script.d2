vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Kernel Memory Map: Linker Script Layout
| {near: top-center}

direction: right

memory_layout: {
  grid-rows: 1
  grid-gap: 0
  
  header: {
    width: 120
    height: 40
    label: "Address"
    style: {
      fill: "#2E3440"
      font-color: "#ECEFF4"
      bold: true
      border-radius: 4
    }
  }
  
  content: {
    width: 280
    height: 40
    label: "Content"
    style: {
      fill: "#2E3440"
      font-color: "#ECEFF4"
      bold: true
      border-radius: 4
    }
  }
  
  size: {
    width: 100
    height: 40
    label: "Size"
    style: {
      fill: "#2E3440"
      font-color: "#ECEFF4"
      bold: true
      border-radius: 4
    }
  }
}

section_text: {
  grid-rows: 1
  grid-gap: 0
  
  addr_1mb: {
    width: 120
    height: 60
    label: "0x100000"
    style: {
      fill: "#B48EAD"
      font-color: "#2E3440"
      bold: true
      font: mono
    }
  }
  
  text_section: {
    width: 280
    height: 60
    label: ".text\n(executable code)"
    style: {
      fill: "#5E81AC"
      font-color: "#ECEFF4"
      bold: true
    }
  }
  
  text_size: {
    width: 100
    height: 60
    label: "~64 KB"
    style: {
      fill: "#5E81AC"
      font-color: "#ECEFF4"
      font: mono
    }
  }
}

section_rodata: {
  grid-rows: 1
  grid-gap: 0
  
  addr_rodata: {
    width: 120
    height: 50
    label: "0x110000"
    style: {
      fill: "#A3BE8C"
      font-color: "#2E3440"
      bold: true
      font: mono
    }
  }
  
  rodata_section: {
    width: 280
    height: 50
    label: ".rodata\n(read-only data, strings)"
    style: {
      fill: "#5E81AC"
      font-color: "#ECEFF4"
      bold: true
    }
  }
  
  rodata_size: {
    width: 100
    height: 50
    label: "~16 KB"
    style: {
      fill: "#5E81AC"
      font-color: "#ECEFF4"
      font: mono
    }
  }
}

section_data: {
  grid-rows: 1
  grid-gap: 0
  
  addr_data: {
    width: 120
    height: 50
    label: "0x114000"
    style: {
      fill: "#A3BE8C"
      font-color: "#2E3440"
      bold: true
      font: mono
    }
  }
  
  data_section: {
    width: 280
    height: 50
    label: ".data\n(initialized globals)"
    style: {
      fill: "#81A1C1"
      font-color: "#2E3440"
      bold: true
    }
  }
  
  data_size: {
    width: 100
    height: 50
    label: "~8 KB"
    style: {
      fill: "#81A1C1"
      font-color: "#2E3440"
      font: mono
    }
  }
}

bss_start: {
  grid-rows: 1
  grid-gap: 0
  
  addr_bss_start: {
    width: 120
    height: 45
    label: "__bss_start\n0x116000"
    style: {
      fill: "#EBCB8B"
      font-color: "#2E3440"
      bold: true
      font: mono
    }
  }
  
  bss_section: {
    width: 280
    height: 45
    label: ".bss\n(uninitialized data)"
    style: {
      fill: "#D08770"
      font-color: "#2E3440"
      bold: true
    }
  }
  
  bss_size: {
    width: 100
    height: 45
    label: "~32 KB"
    style: {
      fill: "#D08770"
      font-color: "#2E3440"
      font: mono
    }
  }
}

bss_end: {
  grid-rows: 1
  grid-gap: 0
  
  addr_bss_end: {
    width: 120
    height: 45
    label: "__bss_end\n0x11E000"
    style: {
      fill: "#EBCB8B"
      font-color: "#2E3440"
      bold: true
      font: mono
    }
  }
  
  end_marker: {
    width: 280
    height: 45
    label: "(end of kernel image)"
    style: {
      fill: "#E5E9F0"
      font-color: "#3B4252"
      italic: true
    }
  }
  
  end_size: {
    width: 100
    height: 45
    label: "-"
    style: {
      fill: "#E5E9F0"
      font-color: "#3B4252"
    }
  }
}

page_boundary: {
  grid-rows: 1
  grid-gap: 0
  
  addr_4mb: {
    width: 120
    height: 40
    label: "0x400000"
    style: {
      fill: "#BF616A"
      font-color: "#ECEFF4"
      bold: true
      font: mono
    }
  }
  
  kernel_end: {
    width: 280
    height: 40
    label: "KERNEL_END (4 MB boundary)"
    style: {
      fill: "#BF616A"
      font-color: "#ECEFF4"
      bold: true
      stroke-dash: 5
    }
  }
  
  total_size: {
    width: 100
    height: 40
    label: "4 MB"
    style: {
      fill: "#BF616A"
      font-color: "#ECEFF4"
      bold: true
      font: mono
    }
  }
}

symbols: {
  label: "Linker Symbols"
  style: {
    fill: "#3B4252"
    stroke: "#4C566A"
    border-radius: 8
  }
  
  symbol_list: ||md
    ENTRY(start)
    
    SECTIONS {
        . = 1M;
        
        .text : {
            *(.multiboot)
            *(.text)
        }
        
        .rodata : {
            *(.rodata)
        }
        
        .data : {
            *(.data)
        }
        
        .bss : {
            __bss_start = .;
            *(.COMMON)
            *(.bss)
            __bss_end = .;
        }
        
        KERNEL_END = .;
    }
  ||
}

growth: {
  label: ""
  width: 30
  height: 300
  style: {
    fill: "linear-gradient(#5E81AC, #BF616A)"
    stroke: "#2E3440"
  }
}

growth_arrow: {
  shape: text
  label: "â†‘ Growth"
  style: {
    font-size: 16
    bold: true
    font-color: "#2E3440"
  }
}

memory_layout.header -> section_text.addr_1mb
section_text.addr_1mb -> section_rodata.addr_rodata
section_rodata.addr_rodata -> section_data.addr_data
section_data.addr_data -> bss_start.addr_bss_start
bss_start.addr_bss_start -> bss_end.addr_bss_end
bss_end.addr_bss_end -> page_boundary.addr_4mb

growth -> growth_arrow -> memory_layout.header {
  style: {
    stroke: transparent
  }
}

legend: {
  near: bottom-center
  legend_text: |md
    **Color Key:**
    ğŸŸ£ Purple = Entry point  |  ğŸ”µ Blue = Code/RO data  |  ğŸŸ¢ Green = Initialized data  
    ğŸŸ  Orange = BSS (zero-init)  |  ğŸ”´ Red = Page boundary
  |
}

annotations: {
  near: top-right
  cache_line: |md
    ### Memory Alignment
    
    - All sections page-aligned (4 KB)
    - .bss zeroed by `memset(&__bss_start, 0, &__bss_end - &__bss_start)`
    - Kernel loaded at 1 MB (safe from BIOS reserved areas)
    - Total kernel image: ~120 KB typical
  |
}