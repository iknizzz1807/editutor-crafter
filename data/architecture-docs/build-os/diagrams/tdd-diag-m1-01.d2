vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    boot: "#E8D5B7"
    kernel: "#B5D8EB"
    hardware: "#D4E5D4"
    memory: "#F0E6F6"
    border: "#666666"
  }
}
title: |md
  # OS Kernel Architecture: Satellite View
| {near: top-center}
direction: down
hardware: Hardware Layer {
  style.fill: ${colors.hardware}
  cpu: CPU (x86) {
    style.fill: white
    registers: Registers {
      shape: class
      "EIP, EFLAGS": "Instruction state"
      "CR0, CR3": "Control registers"
      "CS, DS, SS": "Segment selectors"
    }
  }
  memory_controller: Memory Controller
  pic: PIC 8259 {
    style.fill: white
    "IRQ 0-15": "Interrupt routing"
  }
  devices: I/O Devices {
    style.fill: white
    pit: PIT Timer
    kbd: Keyboard
    vga: VGA Display
    serial: Serial Port
  }
  cpu -> memory_controller: Memory bus
  cpu <-> pic: INT/ACK
  pic -> cpu: IRQ signals
  devices -> pic: Hardware interrupts
}
bios: BIOS/Firmware {
  style.fill: ${colors.boot}
  style.stroke-dash: 3
  post: POST
  ivt: IVT (0x000-0x3FF)
  bios_services: INT 10h, 13h, 15h
}
boot: Boot Sequence {
  style.fill: ${colors.boot}
  mbr: MBR Bootloader {
    style.fill: "#F5E6D3"
    "512 bytes": "at 0x7C00"
    "Stage 1": "Load stage 2"
  }
  stage2: Stage 2 Loader {
    style.fill: "#F5E6D3"
    "Enable A20": "Memory access"
    "Load GDT": "Segmentation"
    "Enter PM": "32-bit mode"
    "Load kernel": "From disk"
  }
  mbr -> stage2: "Handoff"
}
kernel: Kernel (0x100000+) {
  style.fill: ${colors.kernel}
  entry: kernel_entry.asm {
    style.fill: white
    "Setup stack": "ESP = 0x200000"
    "Zero BSS": "rep stosb"
    "Call main": "kernel_main()"
  }
  core: Core Subsystems {
    style.fill: "#C8E0F0"
    gdt: GDT Manager {
      "Null, Kernel CS/DS": "Selectors 0x08, 0x10"
      "User CS/DS": "Selectors 0x18, 0x20"
    }
    idt: IDT + Interrupts {
      "Exceptions 0-31": "CPU faults"
      "IRQs 32-47": "Hardware"
      "Syscall 0x80": "User interface"
    }
    memory: Memory Manager {
      "Frame allocator": "Bitmap, 4KB pages"
      "Page tables": "2-level, PD + PT"
      "Kernel heap": "kmalloc/kfree"
    }
    process: Process Manager {
      "PCB array": "64 processes max"
      "Context switch": "Register save/restore"
      "Round-robin": "Timer preemptive"
    }
  }
  drivers: Drivers {
    style.fill: "#C8E0F0"
    vga_drv: VGA Console
    serial_drv: Serial Debug
    timer_drv: PIT Timer
    kbd_drv: Keyboard
  }
  entry -> core: Initialize
  core -> drivers: Use
}
memory_layout: Physical Memory Map {
  style.fill: ${colors.memory}
  low: Low Memory (0x000-0xFFFFF) {
    style.fill: "#E8DCE8"
    ivt_region: "IVT: 0x000-0x3FF"
    bios_data: "BIOS Data: 0x400-0x4FF"
    free_low: "Free: 0x500-0x7BFF"
    mbr_region: "MBR: 0x7C00-0x7DFF"
    stage2_region: "Stage 2: 0x7E00+"
    vga_region: "VGA: 0xA0000-0xBFFFF"
    bios_rom: "BIOS ROM: 0xC0000-0xFFFFF"
  }
  extended: Extended Memory (1MB+) {
    style.fill: "#E8DCE8"
    kernel_region: "Kernel: 0x100000+"
    free_region: "Available RAM"
  }
}
hardware <-> bios: Boot
bios -> boot.mbr: Load sector 0
boot.stage2 -> kernel.entry: jmp 0x100000
kernel.core.gdt <-> hardware.cpu: Segment translation
kernel.core.idt <-> hardware.pic: IRQ handling
kernel.drivers.vga_drv -> hardware.devices.vga: MMIO 0xB8000
kernel.drivers.serial_drv -> hardware.devices.serial: I/O ports
kernel.drivers.timer_drv <-> hardware.devices.pit: IRQ0
kernel.drivers.kbd_drv <- hardware.devices.kbd: IRQ1
kernel.core.memory <-> hardware.memory_controller: Physical RAM
legend: |md
  **Boot Flow:** BIOS → MBR → Stage 2 → Kernel
  **Key Addresses:**
  - MBR: 0x7C00 (512 bytes)
  - Kernel: 0x100000 (1MB)
  - VGA: 0xB8000
  - IVT: 0x000-0x3FF
| {near: bottom-center}