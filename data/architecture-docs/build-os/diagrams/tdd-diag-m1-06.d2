vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#7B68EE"
    data: "#4A90D9"
    changed: "#E53935"
    pointer: "#FF9800"
    kernel: "#2E7D32"
  }
}
title: |md
  # Protected Mode Transition Sequence
  Step-by-step CPU state changes from real mode to protected mode
| {near: top-center}
direction: right
step1: {
  label: "STEP 1: Real Mode Initial State"
  style.fill: "${colors.header}"
  style.font-color: white
  cpu_state_1: {
    shape: sql_table
    CR0: "0x00000000 {constraint: PE=0}"
    CS: "0x0000 (real mode)"
    EIP: "0x7C00 + offset"
    GDTR: "undefined"
    Mode: "16-bit Real Mode"
  }
  note1: |md
    - CPU starts in real mode
    - Segmentation: CS×16 + IP
    - No protection, no paging
  |
}
step2: {
  label: "STEP 2: Load GDT"
  style.fill: "${colors.header}"
  style.font-color: white
  cpu_state_2: {
    shape: sql_table
    CR0: "0x00000000 {constraint: PE=0}"
    CS: "0x0000 (unchanged)"
    GDTR: "← gdt_descriptor {constraint: CHANGED}"
    Mode: "16-bit Real Mode"
  }
  note2: |md
    lgdt [gdt_descriptor]
    - GDTR.base → GDT address
    - GDTR.limit → GDT size - 1
    - Still in real mode!
  |
}
step3: {
  label: "STEP 3: Set CR0.PE Bit"
  style.fill: "${colors.changed}"
  style.font-color: white
  style.stroke: "#B71C1C"
  style.stroke-width: 3
  cpu_state_3: {
    shape: sql_table
    CR0: "0x00000001 {constraint: PE=1 CHANGED}"
    CS: "0x0000 (DANGER!)"
    GDTR: "loaded"
    Mode: "??? UNDEFINED"
  }
  warning3: |md
    **⚠️ CRITICAL DANGER ZONE**
    mov eax, cr0
    or eax, 1
    mov cr0, eax    ; PE bit set
    - CR0.PE = 1 (protected mode enabled)
    - But CS still has real-mode format!
    - CPU in undefined state
    - **NEXT INSTRUCTION MUST BE FAR JUMP**
  |
  warning3.style.fill: "#FFEBEE"
}
step4: {
  label: "STEP 4: Far Jump (Pipeline Flush)"
  style.fill: "${colors.kernel}"
  style.font-color: white
  cpu_state_4: {
    shape: sql_table
    CR0: "0x00000001 {constraint: PE=1}"
    CS: "0x0008 {constraint: CHANGED}"
    EIP: "protected_mode_entry"
    Mode: "32-bit Protected"
  }
  code4: |md
    jmp 0x08:protected_mode_entry
    - Loads CS with selector 0x08
    - Index 1 → GDT kernel code
    - Flushes 16-bit prefetch queue
    - Now executing 32-bit code
  |
}
step5: {
  label: "STEP 5: Reload Segment Registers"
  style.fill: "${colors.data}"
  style.font-color: white
  cpu_state_5: {
    shape: sql_table
    CR0: "0x00000001 {constraint: PE=1}"
    CS: "0x0008 (kernel code)"
    DS: "0x0010 {constraint: CHANGED}"
    ES: "0x0010 {constraint: CHANGED}"
    SS: "0x0010 {constraint: CHANGED}"
    ESP: "0x90000 {constraint: CHANGED}"
    Mode: "32-bit Protected"
  }
  code5: |md
    mov ax, 0x10    ; kernel data selector
    mov ds, ax
    mov es, ax
    mov fs, ax
    mov gs, ax
    mov ss, ax
    mov esp, 0x90000
  |
}
step6: {
  label: "STEP 6: Protected Mode Complete"
  style.fill: "${colors.kernel}"
  style.font-color: white
  style.3d: true
  cpu_state_6: {
    shape: sql_table
    CR0: "0x00000001"
    CS: "0x0008 (GDT[1])"
    DS: "0x0010 (GDT[2])"
    SS: "0x0010 (GDT[2])"
    ESP: "0x90000"
    GDTR: "loaded"
    Mode: "32-bit Protected ✓"
  }
  note6: |md
    **✓ Transition Complete**
    - All segments use GDT selectors
    - 32-bit code execution
    - Flat 4GB address space
    - Ready for kernel operations
  |
}
step1 -> step2: "lgdt" {style.stroke: "${colors.data}"}
step2 -> step3: "mov cr0, eax" {style.stroke: "${colors.changed}"; style.stroke-width: 3; style.animated: true}
step3 -> step4: "jmp 0x08:addr" {style.stroke: "${colors.kernel}"; style.stroke-width: 3; style.animated: true}
step4 -> step5: "reload segs" {style.stroke: "${colors.data}"}
step5 -> step6: "complete" {style.stroke: "${colors.kernel}"}
legend: {
  style.fill: "#FAFAFA"
  style.stroke: "#E0E0E0"
  leg_title: "Legend"
  leg1: "Purple = Header/Initial" {style.fill: "${colors.header}"}
  leg2: "Red = DANGER/Changed" {style.fill: "${colors.changed}"}
  leg3: "Green = Kernel/Complete" {style.fill: "${colors.kernel}"}
  leg4: "Blue = Data/Final" {style.fill: "${colors.data}"}
}