vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#9B59B6"
    code: "#3498DB"
    data: "#2ECC71"
    bss: "#95A5A6"
    padding: "#E74C3C"
    pointer: "#F39C12"
    reserved: "#7F8C8D"
  }
}
title: |md
  # Linker Script Memory Layout
  **Kernel Sections at Physical 0x100000 (1MB)**
| {near: top-center}
direction: right
memory_layout: {
  label: ""
  style.fill: transparent
  style.stroke: transparent
  # Address column
  addresses: {
    label: ""
    style.fill: transparent
    style.stroke: transparent
    grid-rows: 7
    addr_100000: |md
      `0x100000`
    | {style.fill: transparent; style.stroke: transparent}
    addr_text_end: |md
      `0x10XXXX`
    | {style.fill: transparent; style.stroke: transparent}
    addr_rodata_end: |md
      `0x10XXXX`
    | {style.fill: transparent; style.stroke: transparent}
    addr_data_end: |md
      `0x10XXXX`
    | {style.fill: transparent; style.stroke: transparent}
    addr_bss_start: |md
      `__bss_start`
    | {style.fill: transparent; style.stroke: transparent}
    addr_bss_end: |md
      `__bss_end`
    | {style.fill: transparent; style.stroke: transparent}
    addr_kernel_end: |md
      `_kernel_end`
    | {style.fill: transparent; style.stroke: transparent}
  }
  # Sections column
  sections: {
    label: ""
    style.fill: transparent
    style.stroke: transparent
    grid-rows: 7
    multiboot: "Multiboot Header\n16 bytes" {
      style.fill: "${colors.header}"
      style.stroke: "${colors.header}"
      style.font-color: white
      style.bold: true
    }
    text: ".text\nExecutable Code" {
      style.fill: "${colors.code}"
      style.stroke: "${colors.code}"
      style.font-color: white
      style.bold: true
    }
    rodata: ".rodata\nRead-Only Data" {
      style.fill: "${colors.code}"
      style.stroke: "${colors.code}"
      style.font-color: white
      style.bold: true
    }
    data: ".data\nInitialized Data" {
      style.fill: "${colors.data}"
      style.stroke: "${colors.data}"
      style.font-color: white
      style.bold: true
    }
    bss: ".bss\nUninitialized Data\n(ZEROED)" {
      style.fill: "${colors.bss}"
      style.stroke: "${colors.bss}"
      style.font-color: white
      style.bold: true
    }
    free: "Free Memory" {
      style.fill: "${colors.reserved}"
      style.stroke: "${colors.reserved}"
      style.font-color: white
      style.fill-pattern: lines
    }
  }
  # Size/alignment column
  details: {
    label: ""
    style.fill: transparent
    style.stroke: transparent
    grid-rows: 7
    detail_multiboot: |md
      ALIGN(4K)
    | {style.fill: transparent; style.stroke: transparent}
    detail_text: |md
      ALIGN(4K)
      `*(.text)`
      `*(.text.*)`
    | {style.fill: transparent; style.stroke: transparent}
    detail_rodata: |md
      ALIGN(4K)
      `*(.rodata)`
      `*(.rodata.*)`
    | {style.fill: transparent; style.stroke: transparent}
    detail_data: |md
      ALIGN(4K)
      `*(.data)`
      `*(.data.*)`
    | {style.fill: transparent; style.stroke: transparent}
    detail_bss_start: |md
      ALIGN(4K)
    | {style.fill: transparent; style.stroke: transparent}
    detail_bss_end: |md
      `*(COMMON)`
      `*(.bss)`
    | {style.fill: transparent; style.stroke: transparent}
    detail_free: |md
      Available for
      heap/stack
    | {style.fill: transparent; style.stroke: transparent}
  }
  # Alignment annotations embedded in container
  align_4k_1: |md
    **4KB Page Aligned**
  | {
    style.fill: transparent
    style.stroke: transparent
    style.font-color: "${colors.pointer}"
    style.font-size: 12
  }
  # Growth arrow embedded in container
  arrow_label: |md
    **Memory
    Grows
    Upward↑**
  | {
    style.fill: transparent
    style.stroke: transparent
    style.font-size: 11
    style.font-color: "${colors.pointer}"
  }
}
# Legend
legend: {
  near: bottom-center
  label: ""
  style.fill: transparent
  style.stroke: transparent
  grid-columns: 4
  leg_header: "Header" {style.fill: "${colors.header}"; style.stroke: "${colors.header}"; style.font-color: white}
  leg_code: "Code" {style.fill: "${colors.code}"; style.stroke: "${colors.code}"; style.font-color: white}
  leg_data: "Data" {style.fill: "${colors.data}"; style.stroke: "${colors.data}"; style.font-color: white}
  leg_bss: "BSS" {style.fill: "${colors.bss}"; style.stroke: "${colors.bss}"; style.font-color: white}
}
# Linker script example
linker_example: |md
  **linker.ld**
  ld
  ENTRY(kernel_entry)
  SECTIONS
  {
      . = 0x100000;
      .text : ALIGN(4K) {
          *(.multiboot)
          *(.text)
          *(.text.*)
      }
      .rodata : ALIGN(4K) {
          *(.rodata)
          *(.rodata.*)
      }
      .data : ALIGN(4K) {
          *(.data)
          *(.data.*)
      }
      .bss : ALIGN(4K) {
          __bss_start = .;
          *(COMMON)
          *(.bss)
          __bss_end = .;
      }
      _kernel_end = .;
  }
  
| {
  near: top-right
  style.fill: "#1E1E1E"
  style.stroke: "#3C3C3C"
  style.font-color: "#D4D4D4"
  style.font: mono
  style.font-size: 11
  width: 320
}
# Critical note
note: |md
  ### Critical Symbols
  - **`__bss_start`** → Beginning of BSS (must be zeroed)
  - **`__bss_end`** → End of BSS section
  - **`_kernel_end`** → First free address after kernel
  - **All sections 4KB aligned** → Page table friendly
| {
  near: bottom-right
  style.fill: "#FDF6E3"
  style.stroke: "#D4A76A"
  style.border-radius: 8
  width: 280
}
# BSS zeroing note
bss_note: |md
  **BSS must be zeroed**
  before any C code runs
| {
  near: bottom-left
  style.fill: "#FFEBEE"
  style.stroke: "#E53935"
  style.font-size: 11
  style.border-radius: 4
}