vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Kernel Entry Assembly Flow
  `kernel_entry.asm` - Assembly Bootstrap Sequence
|
direction: down
kernel_entry: {
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  style.border-radius: 8
  step1: {
    label: |md
      ## Step 1: Stack Setup
      asm
      mov esp, 0x200000    ; 2MB stack
      
    |
    style.fill: "#B8D4E3"
    style.stroke: "#2E75B6"
  }
  step2: {
    label: |md
      ## Step 2: Clear Direction Flag
      asm
      cld                  ; Required by ABI
      
    |
    style.fill: "#B8D4E3"
    style.stroke: "#2E75B6"
  }
  step3: {
    label: |md
      ## Step 3: Zero BSS Section
      asm
      mov edi, __bss_start
      mov ecx, __bss_end
      sub ecx, edi
      xor eax, eax
      rep stosb
      
    |
    style.fill: "#B8D4E3"
    style.stroke: "#2E75B6"
  }
  step4: {
    label: |md
      ## Step 4: Call C Entry Point
      asm
      call kernel_main
      
    |
    style.fill: "#C5E0B4"
    style.stroke: "#538135"
  }
  step5: {
    label: |md
      ## Step 5: Halt Loop
      asm
      .halt:
        cli
        hlt
        jmp .halt
      
    |
    style.fill: "#F8CBAD"
    style.stroke: "#C55A11"
  }
  step1 -> step2: ""
  step2 -> step3: ""
  step3 -> step4: ""
  step4 -> step5: "returns\n(unexpected)"
}
memory_regions: {
  style.fill: "#F5F5F5"
  style.stroke: "#999999"
  style.stroke-dash: 3
  bss_section: {
    label: |md
      ### BSS Section
      `__bss_start` â†’ `__bss_end`
      Uninitialized globals/statics
      Must be zeroed before C code
    |
    style.fill: "#E2EFDA"
    style.stroke: "#538135"
  }
  stack_region: {
    label: |md
      ### Kernel Stack
      Top: `0x200000` (2MB)
      Grows downward
      1MB reserved for stack
    |
    style.fill: "#DEEBF7"
    style.stroke: "#2E75B6"
  }
}
kernel_entry.step3 -> memory_regions.bss_section: {
  style.stroke: "#538135"
  style.stroke-dash: 5
  label: "zeros"
}
kernel_entry.step1 -> memory_regions.stack_region: {
  style.stroke: "#2E75B6"
  style.stroke-dash: 5
  label: "sets up"
}
legend: {
  near: bottom-right
  style.fill: transparent
  style.stroke: transparent
  note: |md
    ### Key Points
    - **ESP at 2MB**: Stack grows down, giving 1MB
    - **CLD required**: System V ABI mandates clear direction
    - **BSS must be zeroed**: C standard requires this
    - **Halt loop**: Safety net if `kernel_main` returns
  |
}