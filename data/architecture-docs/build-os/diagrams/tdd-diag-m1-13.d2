vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Dual Console Output: VGA and Serial
  kprintf writes to both devices simultaneously
| {near: top-center}
direction: right
# kprintf source
kprintf: {
  label: "kprintf()\nFormatted Output"
  shape: hexagon
  style.fill: "#9B59B6"
  style.stroke: "#8E44AD"
  style.font-color: white
  style.bold: true
}
# Formatter
formatter: {
  label: "Format Engine\n% parsing &\narg extraction"
  shape: rectangle
  style.fill: "#E8DAEF"
  style.stroke: "#9B59B6"
}
# Output dispatcher
dispatcher: {
  label: "console_putchar()"
  shape: rectangle
  style.fill: "#3498DB"
  style.stroke: "#2980B9"
  style.font-color: white
  style.bold: true
}
# VGA subsystem
vga: {
  label: "VGA Text Mode\nDriver"
  shape: rectangle
  style.fill: "#2ECC71"
  style.stroke: "#27AE60"
  style.font-color: white
  vga_putchar: {
    label: "vga_putchar(c)"
    shape: rectangle
    style.fill: "#58D68D"
    style.stroke: "#27AE60"
  }
}
# VGA buffer
vga_buffer: {
  label: "VGA Buffer\n0xB8000"
  shape: cylinder
  style.fill: "#ABEBC6"
  style.stroke: "#27AE60"
  style.stroke-dash: 3
}
# Serial subsystem
serial: {
  label: "Serial Port\nDriver (COM1)"
  shape: rectangle
  style.fill: "#E74C3C"
  style.stroke: "#C0392B"
  style.font-color: white
  serial_putchar: {
    label: "serial_putchar(c)"
    shape: rectangle
    style.fill: "#EC7063"
    style.stroke: "#C0392B"
  }
}
# Serial hardware
serial_hw: {
  label: "UART 16550\nI/O Port 0x3F8"
  shape: diamond
  style.fill: "#F5B7B1"
  style.stroke: "#C0392B"
}
# External outputs
monitor: {
  label: "Monitor\n(VGA Display)"
  shape: rectangle
  style.fill: "#D5F5E3"
  style.stroke: "#27AE60"
  style.shadow: true
}
terminal: {
  label: "Terminal\n(QEMU stdio)"
  shape: rectangle
  style.fill: "#FADBD8"
  style.stroke: "#C0392B"
  style.shadow: true
}
# Format specifiers table
format_table: |md
  | Spec | Output |
  |------|--------|
  | `%c` | char |
  | `%s` | string |
  | `%d` | decimal |
  | `%x` | hex |
  | `%p` | pointer |
|
format_table.near: top-right
# Connections
kprintf -> formatter: "format string\n+ varargs"
formatter -> dispatcher: "char stream"
dispatcher -> vga: "char c"
dispatcher -> serial: "char c"
vga.vga_putchar -> vga_buffer: "write cell\n(char + attr)"
vga_buffer -> monitor: "memory-mapped\nMMIO"
serial.serial_putchar -> serial_hw: "outb(0x3F8, c)\npoll THRE"
serial_hw -> terminal: "115200 baud\n8N1"
# Annotation for simultaneous writes
annotation: |md
  **Each character written to BOTH:**
  - VGA: immediate screen update
  - Serial: buffered transmit
  Enables debugging when VGA
  unavailable or for logging.
|
annotation.near: bottom-center