vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#9B59B6"
    data: "#3498DB"
    pointer: "#E67E22"
    padding: "#95A5A6"
    reserved: "#7F8C8D"
  }
}
title: |md
  # Milestone 4: Process Memory Layouts
  ### cpu_state (76 bytes) | Process Control Block | TSS (104 bytes)
| {
  near: top-center
}
direction: right
cpu_state: {
  label: "cpu_state (Stack Frame)"
  style.fill: white
  style.stroke: "#2C3E50"
  style.stroke-width: 2
  header: |md
    **Assembly Stub Pushed**
    (Saved on kernel stack)
  | {
    style.fill: "${colors.header}"
    style.stroke: none
    shape: rectangle
    width: 200
  }
  gs: {
    label: "gs [+0x00]"
    style.fill: "${colors.data}"
    width: 200
  }
  fs: {
    label: "fs [+0x04]"
    style.fill: "${colors.data}"
    width: 200
  }
  es: {
    label: "es [+0x08]"
    style.fill: "${colors.data}"
    width: 200
  }
  ds: {
    label: "ds [+0x0C]"
    style.fill: "${colors.data}"
    width: 200
  }
  edi: {
    label: "edi [+0x10]"
    style.fill: "${colors.data}"
    width: 200
  }
  esi: {
    label: "esi [+0x14]"
    style.fill: "${colors.data}"
    width: 200
  }
  ebp: {
    label: "ebp [+0x18]"
    style.fill: "${colors.data}"
    width: 200
  }
  esp: {
    label: "esp [+0x1C]"
    style.fill: "${colors.data}"
    width: 200
  }
  ebx: {
    label: "ebx [+0x20]"
    style.fill: "${colors.data}"
    width: 200
  }
  edx: {
    label: "edx [+0x24]"
    style.fill: "${colors.data}"
    width: 200
  }
  ecx: {
    label: "ecx [+0x28]"
    style.fill: "${colors.data}"
    width: 200
  }
  eax: {
    label: "eax [+0x2C]"
    style.fill: "${colors.data}"
    width: 200
  }
  int_no: {
    label: "int_no [+0x30]"
    style.fill: "${colors.padding}"
    width: 200
  }
  err: {
    label: "err_code [+0x34]"
    style.fill: "${colors.padding}"
    width: 200
  }
  cpu_pushed: |md
    **CPU Pushed**
    (Automatic)
  | {
    style.fill: "#E74C3C"
    style.stroke: none
    style.font-color: white
    shape: rectangle
    width: 200
  }
  eip: {
    label: "eip [+0x38]"
    style.fill: "${colors.pointer}"
    width: 200
  }
  cs: {
    label: "cs [+0x3C]"
    style.fill: "${colors.pointer}"
    width: 200
  }
  eflags: {
    label: "eflags [+0x40]"
    style.fill: "${colors.pointer}"
    width: 200
  }
  priv_change: |md
    **Privilege Change Only**
    (Ring 3 to Ring 0)
  | {
    style.fill: "#F39C12"
    style.stroke: none
    shape: rectangle
    width: 200
  }
  useresp: {
    label: "useresp [+0x44]"
    style.fill: "${colors.pointer}"
    width: 200
  }
  ss: {
    label: "ss [+0x48]"
    style.fill: "${colors.pointer}"
    width: 200
  }
  total: {
    label: "TOTAL: 76 bytes (0x4C)"
    style.fill: "#1ABC9C"
    style.font-color: white
    style.bold: true
    width: 200
  }
  header -> gs
  gs -> fs
  fs -> es
  es -> ds
  ds -> edi
  edi -> esi
  esi -> ebp
  ebp -> esp
  esp -> ebx
  ebx -> edx
  edx -> ecx
  ecx -> eax
  eax -> int_no
  int_no -> err
  err -> cpu_pushed
  cpu_pushed -> eip
  eip -> cs
  cs -> eflags
  eflags -> priv_change
  priv_change -> useresp
  useresp -> ss
  ss -> total
}
pcb: {
  label: "Process Control Block"
  style.fill: white
  style.stroke: "#2C3E50"
  style.stroke-width: 2
  ident: |md
    **Identification**
  | {
    style.fill: "${colors.header}"
    shape: rectangle
    width: 220
  }
  pid: {
    label: "pid [+0x00] uint32"
    style.fill: "${colors.data}"
    width: 220
  }
  name: {
    label: "name[32] [+0x04] char"
    style.fill: "${colors.data}"
    width: 220
  }
  sched: |md
    **Scheduling State**
  | {
    style.fill: "${colors.header}"
    shape: rectangle
    width: 220
  }
  state: {
    label: "state [+0x24] enum"
    style.fill: "${colors.data}"
    width: 220
  }
  priority: {
    label: "priority [+0x28] int"
    style.fill: "${colors.data}"
    width: 220
  }
  cpu_time: {
    label: "cpu_time [+0x2C] uint64"
    style.fill: "${colors.data}"
    width: 220
  }
  wake_time: {
    label: "wake_time [+0x34] uint64"
    style.fill: "${colors.data}"
    width: 220
  }
  cpu_state: |md
    **CPU State**
  | {
    style.fill: "#E74C3C"
    style.font-color: white
    shape: rectangle
    width: 220
  }
  kstack: {
    label: "kernel_stack [+0x3C] ptr"
    style.fill: "${colors.pointer}"
    width: 220
  }
  kstack_top: {
    label: "kernel_stack_top [+0x40] uint32"
    style.fill: "${colors.pointer}"
    width: 220
  }
  mem: |md
    **Memory Management**
  | {
    style.fill: "${colors.header}"
    shape: rectangle
    width: 220
  }
  page_dir: {
    label: "page_directory [+0x44] ptr"
    style.fill: "${colors.pointer}"
    width: 220
  }
  tree: |md
    **Process Tree**
  | {
    style.fill: "${colors.header}"
    shape: rectangle
    width: 220
  }
  parent: {
    label: "parent_pid [+0x48] uint32"
    style.fill: "${colors.data}"
    width: 220
  }
  exit: {
    label: "exit_code [+0x4C] int"
    style.fill: "${colors.data}"
    width: 220
  }
  queue: |md
    **Run Queue Links**
  | {
    style.fill: "${colors.header}"
    shape: rectangle
    width: 220
  }
  next: {
    label: "next [+0x50] ptr"
    style.fill: "${colors.pointer}"
    width: 220
  }
  prev: {
    label: "prev [+0x54] ptr"
    style.fill: "${colors.pointer}"
    width: 220
  }
  pcb_total: {
    label: "TOTAL: ~88 bytes (aligned)"
    style.fill: "#1ABC9C"
    style.font-color: white
    style.bold: true
    width: 220
  }
  ident -> pid
  pid -> name
  name -> sched
  sched -> state
  state -> priority
  priority -> cpu_time
  cpu_time -> wake_time
  wake_time -> cpu_state
  cpu_state -> kstack
  kstack -> kstack_top
  kstack_top -> mem
  mem -> page_dir
  page_dir -> tree
  tree -> parent
  parent -> exit
  exit -> queue
  queue -> next
  next -> prev
  prev -> pcb_total
}
tss: {
  label: "Task State Segment (TSS)"
  style.fill: white
  style.stroke: "#2C3E50"
  style.stroke-width: 2
  tss_header: |md
    **Critical Fields**
  | {
    style.fill: "#E74C3C"
    style.font-color: white
    shape: rectangle
    width: 240
  }
  link: {
    label: "link [+0x00] 2+2"
    style.fill: "${colors.reserved}"
    width: 240
  }
  esp0: {
    label: "esp0 STAR [+0x04] 4"
    style.fill: "#F1C40F"
    style.bold: true
    width: 240
  }
  ss0: {
    label: "ss0 STAR [+0x08] 2+2"
    style.fill: "#F1C40F"
    style.bold: true
    width: 240
  }
  unused: |md
    **Unused (Rings 1,2)**
  | {
    style.fill: "${colors.padding}"
    shape: rectangle
    width: 240
  }
  esp1: {
    label: "esp1,ss1 [+0x0C] 4+4"
    style.fill: "${colors.reserved}"
    width: 240
  }
  esp2: {
    label: "esp2,ss2 [+0x14] 4+4"
    style.fill: "${colors.reserved}"
    width: 240
  }
  cr3_field: {
    label: "cr3 [+0x1C] 4"
    style.fill: "${colors.reserved}"
    width: 240
  }
  regs: |md
    **Saved Registers (task switch)**
  | {
    style.fill: "${colors.header}"
    shape: rectangle
    width: 240
  }
  eip_tss: {
    label: "eip-edi [+0x20] 32"
    style.fill: "${colors.data}"
    width: 240
  }
  segs: {
    label: "es-gs [+0x48] 10"
    style.fill: "${colors.data}"
    width: 240
  }
  ldtr: {
    label: "ldtr [+0x54] 2+2"
    style.fill: "${colors.reserved}"
    width: 240
  }
  iomap: {
    label: "trap,iomap [+0x56] 4"
    style.fill: "${colors.data}"
    width: 240
  }
  tss_total: {
    label: "TOTAL: 104 bytes (0x68)"
    style.fill: "#1ABC9C"
    style.font-color: white
    style.bold: true
    width: 240
  }
  tss_header -> link
  link -> esp0
  esp0 -> ss0
  ss0 -> unused
  unused -> esp1
  esp1 -> esp2
  esp2 -> cr3_field
  cr3_field -> regs
  regs -> eip_tss
  eip_tss -> segs
  segs -> ldtr
  ldtr -> iomap
  iomap -> tss_total
}
note1: |md
  STAR = Must update on EVERY context switch.
  TSS.ESP0 tells CPU where to find
  kernel stack when interrupt occurs
  from user mode (ring 3).
| {
  near: tss
  shape: text
  style.italic: true
}
note2: |md
  cpu_state lives on the kernel stack.
  ESP points to base after interrupt.
  iret pops eip, cs, eflags (and
  useresp, ss if privilege change).
| {
  near: cpu_state
  shape: text
  style.italic: true
}