vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right
title: |md
  # Interrupt Stack Frame: What the CPU Pushes
| {near: top-center}
# Stack grows downward (high to low addresses)
stack_frame: {
  label: "Kernel Stack\n(Grows Down â†“)"
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  # High addresses (pushed first / deeper in stack)
  ss_user: {
    label: |md
      **SS** (User Stack Segment)
      
      0x23 (user data selector)
      
    |
    style.fill: "#FFE4B5"
    style.stroke: "#CC8800"
  }
  esp_user: {
    label: |md
      **ESP** (User Stack Pointer)
      
      User's stack pointer value
      
    |
    style.fill: "#FFE4B5"
    style.stroke: "#CC8800"
  }
  privilege_note: {
    shape: text
    label: |md
      â†‘ **Only if privilege change** (Ring 3 â†’ Ring 0)
      Otherwise CPU does NOT push these
    |
    style.fill: transparent
    style.font-color: "#CC6600"
    style.italic: true
  }
  eflags: {
    label: |md
      **EFLAGS** (CPU Flags Register)
      
      CF, ZF, SF, OF, IF, DF, etc.
      Bit 9 (IF) = Interrupt Flag
      
    |
    style.fill: "#B5D8EB"
    style.stroke: "#2E75B6"
  }
  cs: {
    label: |md
      **CS** (Code Segment Selector)
      
      0x08 (kernel) or 0x1B (user)
      
    |
    style.fill: "#D4E6F1"
    style.stroke: "#2E75B6"
  }
  eip: {
    label: |md
      **EIP** (Instruction Pointer)
      
      Return address (next instruction)
      
    |
    style.fill: "#D4E6F1"
    style.stroke: "#2E75B6"
  }
  error_code: {
    label: |md
      **Error Code** (Exception-specific)
      
      Vectors: 8, 10, 11, 12, 13, 14, 17
      Page Fault: P, W, U, R, I bits
      Others: Selector index, TI, IDT, EXT
      
    |
    style.fill: "#F5B7B1"
    style.stroke: "#C0392B"
  }
  error_note: {
    shape: text
    label: |md
      â†‘ **Only for exceptions 8, 10-14, 17**
      Our stub pushes fake 0 for others
    |
    style.fill: transparent
    style.font-color: "#922B21"
    style.italic: true
  }
  # Our stub additions
  int_no: {
    label: |md
      **int_no** (Interrupt Number)
      
      Vector 0-255 (pushed by our stub)
      
    |
    style.fill: "#D5F5E3"
    style.stroke: "#27AE60"
  }
  gp_regs: {
    label: |md
      **General Registers**
      
      EAX, ECX, EDX, EBX
      ESP, EBP, ESI, EDI
      (pushed by pusha)
      
    |
    style.fill: "#D5F5E3"
    style.stroke: "#27AE60"
  }
  seg_regs: {
    label: |md
      **Segment Registers**
      
      DS, ES, FS, GS
      (pushed by our stub)
      
    |
    style.fill: "#D5F5E3"
    style.stroke: "#27AE60"
  }
  esp_here: {
    label: |md
      **ESP points here** â†
      
      Passed to C handler
      
    |
    style.fill: "#F9E79F"
    style.stroke: "#D4AC0D"
    style.bold: true
  }
  # Layout connections (vertical stack)
  ss_user -> esp_user: ""
  esp_user -> privilege_note: ""
  privilege_note -> eflags: ""
  eflags -> cs: ""
  cs -> eip: ""
  eip -> error_code: ""
  error_code -> error_note: ""
  error_note -> int_no: ""
  int_no -> gp_regs: ""
  gp_regs -> seg_regs: ""
  seg_regs -> esp_here: ""
}
# Legend
legend: {
  near: top-right
  label: |md
    ## Legend
    ğŸŸ  **Orange** - User mode stack (conditional)
    ğŸ”µ **Blue** - CPU-pushed (always)
    ğŸ”´ **Red** - Error code (exception-specific)
    ğŸŸ¢ **Green** - Stub-pushed (our code)
    ğŸŸ¡ **Yellow** - Handler entry point
  |
  shape: text
  style.fill: "#FAFAFA"
  style.stroke: "#CCCCCC"
}
# Side note about push order
push_order: {
  near: bottom-right
  label: |md
    ## Push Order (High â†’ Low)
    1. **SS** (if privilege change)
    2. **ESP** (if privilege change)
    3. **EFLAGS**
    4. **CS**
    5. **EIP**
    6. **Error Code** (some exceptions)
    ---
    Then our stub pushes:
    7. **int_no** + **err_code**
    8. **pusha** (8 GP regs)
    9. **DS, ES, FS, GS**
  |
  shape: text
  style.fill: "#FAFAFA"
  style.stroke: "#CCCCCC"
}
# Connection to legend
stack_frame -> legend: {style.stroke: transparent}
stack_frame -> push_order: {style.stroke: transparent}