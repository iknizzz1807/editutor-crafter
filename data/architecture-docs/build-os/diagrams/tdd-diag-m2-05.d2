vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # PIC Remapping: Avoiding Vector Collisions
| {near: top-center}
direction: right
classes: {
  exception: {
    style: {
      fill: "#FF6B6B"
      stroke: "#C92A2A"
      font-color: white
      bold: true
    }
  }
  irq_collision: {
    style: {
      fill: "#FFD43B"
      stroke: "#F59F00"
      font-color: "#333"
      bold: true
    }
  }
  irq_safe: {
    style: {
      fill: "#69DB7C"
      stroke: "#2F9E44"
      font-color: "#333"
      bold: true
    }
  }
  container_box: {
    style: {
      stroke: "#868E96"
      stroke-dash: 3
      fill: "#F8F9FA"
    }
  }
}
# === LEFT SIDE: DEFAULT (PROBLEMATIC) MAPPING ===
default_mapping: Default PIC Mapping (COLLISION!) {
  class: container_box
  vector_space_default: {
    label: "IDT Vectors 0-47"
    # CPU Exceptions (0-31) - Always these
    ex0: "#0 Divide Error" {class: exception}
    ex1: "#1 Debug" {class: exception}
    ex2: "#2 NMI" {class: exception}
    ex3: "#3 Breakpoint" {class: exception}
    ex6: "#6 Invalid Opcode" {class: exception}
    ex8: "#8 Double Fault" {class: exception}
    ex13: "#13 General Protection" {class: exception}
    ex14: "#14 Page Fault" {class: exception}
    # IRQs with collision (8-15, 112-119)
    irq0_collision: "IRQ0 (Timer) → Vector 8" {
      class: irq_collision
      tooltip: "COLLIDES with Double Fault!"
    }
    irq1_collision: "IRQ1 (Keyboard) → Vector 9" {
      class: irq_collision
      tooltip: "Collides with reserved vector"
    }
    irq8_collision: "IRQ8 (RTC) → Vector 112" {
      class: irq_collision
    }
    ellipsis: "..." {style.opacity: 0.5}
  }
  # Collision indicators
  ex8 -> irq0_collision: "COLLISION!" {
    style: {
      stroke: "#E03131"
      stroke-width: 3
      animated: true
    }
  }
}
# === RIGHT SIDE: REMAPPED (CORRECT) MAPPING ===
remapped_mapping: Remapped PIC Mapping (Correct) {
  class: container_box
  vector_space_remapped: {
    label: "IDT Vectors 0-47"
    # CPU Exceptions (0-31) - Safe
    ex0_r: "#0 Divide Error" {class: exception}
    ex1_r: "#1 Debug" {class: exception}
    ex2_r: "#2 NMI" {class: exception}
    ex3_r: "#3 Breakpoint" {class: exception}
    ex6_r: "#6 Invalid Opcode" {class: exception}
    ex8_r: "#8 Double Fault" {class: exception}
    ex13_r: "#13 General Protection" {class: exception}
    ex14_r: "#14 Page Fault" {class: exception}
    # IRQs safely mapped (32-47)
    irq0_safe: "IRQ0 (Timer) → Vector 32" {
      class: irq_safe
      tooltip: "Safely above exceptions"
    }
    irq1_safe: "IRQ1 (Keyboard) → Vector 33" {
      class: irq_safe
    }
    irq2_safe: "IRQ2 (Cascade) → Vector 34" {
      class: irq_safe
    }
    irq8_safe: "IRQ8 (RTC) → Vector 40" {
      class: irq_safe
    }
    irq14_safe: "IRQ14 (Disk) → Vector 46" {
      class: irq_safe
    }
  }
}
# === CONNECTION: Show the transformation ===
default_mapping -> remapped_mapping: "PIC Remap\nICW1-ICW4" {
  style: {
    stroke: "#1971C2"
    stroke-width: 3
    fill: "#D0EBFF"
  }
}
# === PIC CHIP DETAIL ===
pic_detail: "8259 PIC Configuration" {
  near: bottom-center
  master_pic: Master PIC {
    style.fill: "#E9ECEF"
    ports_m: {
      label: "I/O Ports"
      cmd_m: "CMD: 0x20"
      data_m: "DATA: 0x21"
    }
    icw_sequence: {
      label: "Initialization"
      icw1_m: "ICW1: 0x11 (init)"
      icw2_m: "ICW2: 0x20 (offset 32)"
      icw3_m: "ICW3: 0x04 (cascade)"
      icw4_m: "ICW4: 0x01 (8086)"
    }
  }
  slave_pic: Slave PIC {
    style.fill: "#E9ECEF"
    ports_s: {
      label: "I/O Ports"
      cmd_s: "CMD: 0xA0"
      data_s: "DATA: 0xA1"
    }
    icw_sequence_s: {
      label: "Initialization"
      icw2_s: "ICW2: 0x28 (offset 40)"
    }
  }
  master_pic.icw_sequence.icw2_m -> slave_pic.icw_sequence_s.icw2_s: "Cascade\nvia IRQ2"
}
# === LEGEND ===
legend: {
  near: bottom-right
  legend_title: "Legend" {style.bold: true}
  exc: "CPU Exception (Fixed)" {class: exception}
  col: "IRQ Collision (BAD)" {class: irq_collision}
  safe: "IRQ Remapped (SAFE)" {class: irq_safe}
}
# === ANNOTATION ===
note: |md
  **Problem**: Default PIC maps IRQ0→8 (Double Fault!), IRQ1→9, etc.
  **Solution**: Remap master to offset 0x20 (32), slave to 0x28 (40)
  **Code**: `pic_remap(0x20, 0x28);`
| {near: bottom-center}