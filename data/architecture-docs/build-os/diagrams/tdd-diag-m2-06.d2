vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    master: "#E8F4FD"
    slave: "#FFF3E0"
    data_val: "#E8F5E9"
    port: "#FCE4EC"
  }
}
title: |md
  # PIC Initialization Command Words
  **ICW1-ICW4 Sequence for Master (0x20/0x21) and Slave (0xA0/0xA1) PICs**
| {near: top-center}
direction: right
master_pic: Master PIC {
  style.fill: ${colors.master}
  cmd_port: Command Port 0x20 {
    style.fill: ${colors.port}
    shape: hexagon
  }
  data_port: Data Port 0x21 {
    style.fill: ${colors.port}
    shape: hexagon
  }
}
slave_pic: Slave PIC {
  style.fill: ${colors.slave}
  cmd_port2: Command Port 0xA0 {
    style.fill: ${colors.port}
    shape: hexagon
  }
  data_port2: Data Port 0xA1 {
    style.fill: ${colors.port}
    shape: hexagon
  }
}
icw_sequence: ICW Sequence {
  style.fill: transparent
  icw1: ICW1 - Initialize {
    style.fill: ${colors.data_val}
    value: Value: 0x11 {
      shape: text
      style.bold: true
      style.font: mono
    }
    bits: |md
      **Binary:** `00010001`
      - Bit 4 (1): Initialize
      - Bit 0 (1): ICW4 needed
    | {shape: text}
  }
  icw2_m: ICW2 Master - Vector Offset {
    style.fill: ${colors.data_val}
    value2: Value: 0x20 {
      shape: text
      style.bold: true
      style.font: mono
    }
    desc2: |md
      **Vectors:** 0x20-0x27
      IRQ0 → Vector 32 (Timer)
      IRQ1 → Vector 33 (Keyboard)
    | {shape: text}
  }
  icw2_s: ICW2 Slave - Vector Offset {
    style.fill: ${colors.data_val}
    value3: Value: 0x28 {
      shape: text
      style.bold: true
      style.font: mono
    }
    desc3: |md
      **Vectors:** 0x28-0x2F
      IRQ8 → Vector 40 (RTC)
      IRQ14 → Vector 46 (Primary ATA)
    | {shape: text}
  }
  icw3_m: ICW3 Master - Cascade {
    style.fill: ${colors.data_val}
    value4: Value: 0x04 {
      shape: text
      style.bold: true
      style.font: mono
    }
    desc4: |md
      **Binary:** `00000100`
      Bit 2 = 1: Slave at IRQ2
    | {shape: text}
  }
  icw3_s: ICW3 Slave - Identity {
    style.fill: ${colors.data_val}
    value5: Value: 0x02 {
      shape: text
      style.bold: true
      style.font: mono
    }
    desc5: |md
      **Binary:** `00000010`
      Slave ID = 2
    | {shape: text}
  }
  icw4: ICW4 - Mode {
    style.fill: ${colors.data_val}
    value6: Value: 0x01 {
      shape: text
      style.bold: true
      style.font: mono
    }
    desc6: |md
      **Binary:** `00000001`
      8086 mode, Non-auto EOI
    | {shape: text}
  }
}
step1: Step 1 {
  shape: circle
  style.fill: "#4CAF50"
  style.font-color: white
}
step2: Step 2 {
  shape: circle
  style.fill: "#4CAF50"
  style.font-color: white
}
step3: Step 3 {
  shape: circle
  style.fill: "#4CAF50"
  style.font-color: white
}
step4: Step 4 {
  shape: circle
  style.fill: "#4CAF50"
  style.font-color: white
}
step5: Step 5 {
  shape: circle
  style.fill: "#4CAF50"
  style.font-color: white
}
step6: Step 6 {
  shape: circle
  style.fill: "#4CAF50"
  style.font-color: white
}
step7: Step 7 {
  shape: circle
  style.fill: "#4CAF50"
  style.font-color: white
}
step1 -> icw_sequence.icw1
icw_sequence.icw1 -> master_pic.cmd_port: outb(0x20, 0x11) {
  style.stroke: "#2196F3"
  style.bold: true
}
icw_sequence.icw1 -> slave_pic.cmd_port2: outb(0xA0, 0x11) {
  style.stroke: "#FF9800"
  style.bold: true
}
step2 -> icw_sequence.icw2_m
icw_sequence.icw2_m -> master_pic.data_port: outb(0x21, 0x20) {
  style.stroke: "#2196F3"
  style.bold: true
}
step3 -> icw_sequence.icw2_s
icw_sequence.icw2_s -> slave_pic.data_port2: outb(0xA1, 0x28) {
  style.stroke: "#FF9800"
  style.bold: true
}
step4 -> icw_sequence.icw3_m
icw_sequence.icw3_m -> master_pic.data_port: outb(0x21, 0x04) {
  style.stroke: "#2196F3"
  style.bold: true
}
step5 -> icw_sequence.icw3_s
icw_sequence.icw3_s -> slave_pic.data_port2: outb(0xA1, 0x02) {
  style.stroke: "#FF9800"
  style.bold: true
}
step6 -> icw_sequence.icw4
icw_sequence.icw4 -> master_pic.data_port: outb(0x21, 0x01) {
  style.stroke: "#2196F3"
  style.bold: true
}
step7 -> icw_sequence.icw4
icw_sequence.icw4 -> slave_pic.data_port2: outb(0xA1, 0x01) {
  style.stroke: "#FF9800"
  style.bold: true
}
note: |md
  **Critical:** Save and restore IRQ masks before/after remapping!
  c
  uint8_t mask1 = inb(0x21);
  uint8_t mask2 = inb(0xA1);
  // ... ICW sequence ...
  outb(0x21, mask1);
  outb(0xA1, mask2);
  
| {near: bottom-center}