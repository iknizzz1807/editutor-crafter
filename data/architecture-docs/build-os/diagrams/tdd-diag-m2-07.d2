vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#7B68EE"
    data: "#4A90D9"
    changed: "#E53935"
    pointer: "#FF9800"
    padding: "#9E9E9E"
    step_bg: "#1A1A2E"
  }
}
title: |md
  # ISR Stub Register Save/Restore Sequence
  ## Assembly Interrupt Handler Entry/Exit Protocol
| {near: top-center}
direction: right
Step_1: {
  label: "Step 1: CPU Auto-Push"
  style.fill: "${colors.step_bg}"
  style.stroke: "${colors.header}"
  style.font-color: white
  note: |md
    **CPU automatically pushes:**
    - EFLAGS (condition codes, IF)
    - CS (code segment selector)
    - EIP (return address)
    - Error code (exceptions 8,10-14,17 only)
  |
  stack_before: {
    label: "Stack Before"
    shape: rectangle
    style.fill: "${colors.data}"
    style.font-color: white
    width: 180
    cell_1: "(previous stack content)"
  }
  stack_after: {
    label: "Stack After CPU Push"
    shape: rectangle
    style.fill: "${colors.data}"
    style.font-color: white
    width: 180
    eflags: "EFLAGS"
    cs: "CS"
    eip: "EIP"
    err: "Error Code (optional)"
    cell_1: "(previous content)"
    eflags.style.fill: "${colors.changed}"
    eflags.style.font-color: white
    eflags.style.bold: true
    cs.style.fill: "${colors.changed}"
    cs.style.font-color: white
    cs.style.bold: true
    eip.style.fill: "${colors.changed}"
    eip.style.font-color: white
    eip.style.bold: true
    err.style.fill: "${colors.changed}"
    err.style.font-color: white
    err.style.bold: true
  }
  stack_before -> stack_after: "CPU" {
    style.stroke: "${colors.changed}"
    style.stroke-width: 3
  }
}
Step_2: {
  label: "Step 2: Stub Push (Error Code)"
  style.fill: "${colors.step_bg}"
  style.stroke: "${colors.header}"
  style.font-color: white
  note: |md
    **For exceptions WITHOUT error code:**
    asm
    push dword 0    ; Fake error code
    push dword N    ; ISR number
    
    **For exceptions WITH error code:**
    asm
    push dword N    ; ISR number only
    
  |
  stack_before: {
    label: "Stack Before"
    shape: rectangle
    style.fill: "${colors.data}"
    style.font-color: white
    width: 180
    eflags: "EFLAGS"
    cs: "CS"
    eip: "EIP"
    err: "Error Code"
  }
  stack_after: {
    label: "Stack After Stub Push"
    shape: rectangle
    style.fill: "${colors.data}"
    style.font-color: white
    width: 180
    fake_err: "0x00000000 (fake err)"
    int_no: "Interrupt Number"
    err: "Error Code"
    eip: "EIP"
    cs: "CS"
    eflags: "EFLAGS"
    fake_err.style.fill: "${colors.changed}"
    fake_err.style.font-color: white
    fake_err.style.bold: true
    int_no.style.fill: "${colors.changed}"
    int_no.style.font-color: white
    int_no.style.bold: true
  }
  stack_before -> stack_after: "push 0\npush N" {
    style.stroke: "${colors.changed}"
    style.stroke-width: 3
  }
}
Step_3: {
  label: "Step 3: pusha (General Regs)"
  style.fill: "${colors.step_bg}"
  style.stroke: "${colors.header}"
  style.font-color: white
  note: |md
    **pusha instruction pushes:**
    EDI, ESI, EBP, ESP, EBX, EDX, ECX, EAX
    *Note: ESP pushed is value BEFORE pusha*
  |
  stack_before: {
    label: "Stack Before"
    shape: rectangle
    style.fill: "${colors.data}"
    style.font-color: white
    width: 180
    int_no: "Interrupt Number"
    err: "Error Code"
    eip: "EIP"
  }
  stack_after: {
    label: "Stack After pusha"
    shape: rectangle
    style.fill: "${colors.data}"
    style.font-color: white
    width: 180
    edi: "EDI"
    esi: "ESI"
    ebp: "EBP"
    esp: "ESP (old value)"
    ebx: "EBX"
    edx: "EDX"
    ecx: "ECX"
    eax: "EAX"
    int_no: "Interrupt Number"
    err: "Error Code"
    edi.style.fill: "${colors.changed}"
    edi.style.font-color: white
    edi.style.bold: true
    esi.style.fill: "${colors.changed}"
    esi.style.font-color: white
    esi.style.bold: true
    ebp.style.fill: "${colors.changed}"
    ebp.style.font-color: white
    ebp.style.bold: true
    esp.style.fill: "${colors.changed}"
    esp.style.font-color: white
    esp.style.bold: true
    ebx.style.fill: "${colors.changed}"
    ebx.style.font-color: white
    ebx.style.bold: true
    edx.style.fill: "${colors.changed}"
    edx.style.font-color: white
    edx.style.bold: true
    ecx.style.fill: "${colors.changed}"
    ecx.style.font-color: white
    ecx.style.bold: true
    eax.style.fill: "${colors.changed}"
    eax.style.font-color: white
    eax.style.bold: true
  }
  stack_before -> stack_after: "pusha" {
    style.stroke: "${colors.changed}"
    style.stroke-width: 3
  }
}
Step_4: {
  label: "Step 4: Segment Regs + Call"
  style.fill: "${colors.step_bg}"
  style.stroke: "${colors.header}"
  style.font-color: white
  note: |md
    **Manual segment register saves:**
    asm
    push ds
    push es
    push fs
    push gs
    mov ax, 0x10    ; Load kernel DS
    mov ds, ax
    mov es, ax
    mov fs, ax
    mov gs, ax
    push esp        ; Pass stack pointer
    call isr_common_handler
    
  |
  stack_before: {
    label: "Stack Before"
    shape: rectangle
    style.fill: "${colors.data}"
    style.font-color: white
    width: 180
    eax: "EAX"
    int_no: "Interrupt Number"
    err: "Error Code"
    eip: "EIP"
  }
  stack_after: {
    label: "Stack After Seg Push + Call"
    shape: rectangle
    style.fill: "${colors.data}"
    style.font-color: white
    width: 180
    gs: "GS"
    fs: "FS"
    es: "ES"
    ds: "DS"
    edi: "EDI"
    eax: "EAX"
    int_no: "Interrupt Number"
    err: "Error Code"
    eip: "EIP (CPU)"
    cs: "CS"
    eflags: "EFLAGS"
    gs.style.fill: "${colors.changed}"
    gs.style.font-color: white
    gs.style.bold: true
    fs.style.fill: "${colors.changed}"
    fs.style.font-color: white
    fs.style.bold: true
    es.style.fill: "${colors.changed}"
    es.style.font-color: white
    es.style.bold: true
    ds.style.fill: "${colors.changed}"
    ds.style.font-color: white
    ds.style.bold: true
  }
  stack_before -> stack_after: "push ds/es/fs/gs\ncall handler" {
    style.stroke: "${colors.changed}"
    style.stroke-width: 3
  }
}
Step_5: {
  label: "Step 5: Restore & Return"
  style.fill: "${colors.step_bg}"
  style.stroke: "${colors.header}"
  style.font-color: white
  note: |md
    **Restoration sequence:**
    asm
    add esp, 4      ; Remove arg pointer
    pop gs
    pop fs
    pop es
    pop ds
    popa            ; Restore general regs
    add esp, 8      ; Remove err_code + int_no
    iret            ; Return from interrupt
    
  |
  stack_before: {
    label: "Stack at Handler Return"
    shape: rectangle
    style.fill: "${colors.data}"
    style.font-color: white
    width: 180
    gs: "GS"
    fs: "FS"
    es: "ES"
    ds: "DS"
    edi: "EDI"
    eax: "EAX"
    int_no: "Interrupt Number"
    err: "Error Code"
    eip: "EIP"
    cs: "CS"
    eflags: "EFLAGS"
  }
  stack_after: {
    label: "Stack After iret"
    shape: rectangle
    style.fill: "${colors.padding}"
    style.font-color: white
    width: 180
    style.stroke-dash: 3
    cell_1: "(original stack content)"
    note: |md
      **CPU restored:**
      - EIP, CS, EFLAGS
      - SS, ESP (if privilege change)
    |
  }
  stack_before -> stack_after: "pop gs/fs/es/ds\npopa\nadd esp, 8\niret" {
    style.stroke: "#4CAF50"
    style.stroke-width: 3
  }
}
Memory_Layout: {
  label: "cpu_state Structure Layout"
  style.fill: "${colors.step_bg}"
  style.stroke: "${colors.header}"
  style.font-color: white
  offset_table: {
    shape: sql_table
    offset: uint32
    field: string
    size: string
    row_gs: "0x00 | gs | 4 bytes"
    row_fs: "0x04 | fs | 4 bytes"
    row_es: "0x08 | es | 4 bytes"
    row_ds: "0x0C | ds | 4 bytes"
    row_edi: "0x10 | edi | 4 bytes"
    row_esi: "0x14 | esi | 4 bytes"
    row_ebp: "0x18 | ebp | 4 bytes"
    row_esp: "0x1C | esp | 4 bytes"
    row_ebx: "0x20 | ebx | 4 bytes"
    row_edx: "0x24 | edx | 4 bytes"
    row_ecx: "0x28 | ecx | 4 bytes"
    row_eax: "0x2C | eax | 4 bytes"
    row_int_no: "0x30 | int_no | 4 bytes"
    row_err_code: "0x34 | err_code | 4 bytes"
    row_eip: "0x38 | eip | 4 bytes"
    row_cs: "0x3C | cs | 4 bytes"
    row_eflags: "0x40 | eflags | 4 bytes"
    row_useresp: "0x44 | useresp | 4 bytes"
    row_ss: "0x48 | ss | 4 bytes"
  }
  note: |md
    **Total size: 76 bytes (0x4C)**
    - Bytes 0x00-0x2F: Stub-pushed (segment + general regs)
    - Bytes 0x30-0x34: Stub-pushed metadata
    - Bytes 0x38-0x40: CPU-pushed
    - Bytes 0x44-0x48: CPU-pushed (privilege change only)
  |
}
Step_1 -> Step_2 -> Step_3 -> Step_4 -> Step_5
Step_5 -> Memory_Layout: {style.stroke-dash: 5; style.stroke: "${colors.padding}"}