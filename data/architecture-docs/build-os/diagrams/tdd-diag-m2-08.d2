direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
classes: {
  state_normal: {
    style: {
      fill: "#E8F5E9"
      stroke: "#2E7D32"
      stroke-width: 2
      font-color: "#1B5E20"
    }
  }
  state_error: {
    style: {
      fill: "#FFEBEE"
      stroke: "#C62828"
      stroke-width: 2
      font-color: "#B71C1C"
    }
  }
  state_processing: {
    style: {
      fill: "#FFF3E0"
      stroke: "#EF6C00"
      stroke-width: 2
      font-color: "#E65100"
    }
  }
  state_terminal: {
    style: {
      fill: "#ECEFF1"
      stroke: "#455A64"
      stroke-width: 2
      font-color: "#37474F"
    }
  }
  decision: {
    shape: diamond
    style: {
      fill: "#E3F2FD"
      stroke: "#1565C0"
      stroke-width: 2
    }
  }
  initial: {
    shape: circle
    style: {
      fill: "#2196F3"
      stroke: "#0D47A1"
      stroke-width: 3
    }
  }
  trans_normal: {
    style: {
      stroke: "#1565C0"
      stroke-width: 2
    }
  }
  trans_error: {
    style: {
      stroke: "#C62828"
      stroke-width: 2
      stroke-dash: 3
    }
  }
}
# Initial state
initial_node: "" {
  class: initial
  width: 30
  height: 30
}
# Main states
idle: "IDLE\nExecuting Code" {
  class: state_normal
}
exception_arrives: "EXCEPTION\nArrives" {
  class: state_processing
}
save_state: "SAVE STATE\nPush Registers\n(EAX,ECX,EDX,EBX,\nESP,EBP,ESI,EDI)\n+ Segments (DS,ES,FS,GS)" {
  class: state_processing
}
identify: "IDENTIFY\nException Type\n(vector 0-31)" {
  class: state_processing
}
decision_halt: "Recoverable?" {
  class: decision
}
print_diag: "PRINT DIAGNOSTICS\n• Exception name\n• Error code\n• EIP, CS, EFLAGS\n• Register dump" {
  class: state_processing
}
page_fault_extra: "PAGE FAULT\nEXTRA\n• Read CR2\n• Decode P/W/U bits" {
  class: state_processing
}
halt_system: "HALT\ncli; hlt" {
  class: state_error
}
return_resume: "RETURN\nRestore State\npopa + iret" {
  class: state_normal
}
# Terminal
terminated: "TERMINATED\nSystem Stopped" {
  class: state_terminal
}
resumed: "RESUMED\nContinue Execution" {
  class: state_normal
}
# Transitions
initial_node -> idle: "" {
  class: trans_normal
}
idle -> exception_arrives: "CPU detects\nexception" {
  class: trans_normal
}
exception_arrives -> save_state: "CPU pushes\nEFLAGS, CS, EIP\n(+SS,ESP if ring3→ring0)" {
  class: trans_normal
}
save_state -> identify: "Stub pushes\nregisters" {
  class: trans_normal
}
identify -> decision_halt: "Lookup\nexception_messages[]" {
  class: trans_normal
}
decision_halt -> print_diag: "Yes" {
  class: trans_normal
}
decision_halt -> halt_system: "No\n(Double Fault,\nMachine Check)" {
  class: trans_error
}
print_diag -> page_fault_extra: "vector == 14\n(Page Fault)" {
  class: trans_normal
}
print_diag -> return_resume: "Other\nexception" {
  class: trans_normal
}
page_fault_extra -> return_resume: "Diagnostic\ncomplete" {
  class: trans_normal
}
halt_system -> terminated: "System\nhalted" {
  class: trans_error
}
return_resume -> resumed: "iret\ninstruction" {
  class: trans_normal
}
# Legend
legend: |md
  ## Exception Handler State Machine
  **State Flow:**
  1. **IDLE** - Normal code execution
  2. **EXCEPTION** - CPU detects fault/trap
  3. **SAVE STATE** - Preserve all registers
  4. **IDENTIFY** - Determine exception type
  5. **DECISION** - Can we recover?
  6. **PRINT** - Output diagnostics
  7. **RETURN/HALT** - Resume or stop
  **Unrecoverable Exceptions:**
  - Vector 8: Double Fault
  - Vector 18: Machine Check
  **Recoverable (for debug):**
  - Vector 0: Divide Error
  - Vector 6: Invalid Opcode
  - Vector 13: General Protection
  - Vector 14: Page Fault
| {
  near: bottom-center
  style.fill: "#FAFAFA"
  style.stroke: "#BDBDBD"
  style.stroke-width: 1
}