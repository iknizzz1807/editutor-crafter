vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # EOI Flow: Master vs Slave PIC
  End of Interrupt acknowledgment sequence
| {near: top-center}
direction: right
classes: {
  pic_chip: {
    shape: rectangle
    style: {
      fill: "#E8E8E8"
      stroke: "#666666"
      stroke-width: 2
      border-radius: 4
    }
  }
  device: {
    shape: rectangle
    style: {
      fill: "#ACE1AF"
      stroke: "#228B22"
      stroke-width: 2
    }
  }
  eoi_cmd: {
    shape: diamond
    style: {
      fill: "#FFD700"
      stroke: "#B8860B"
      stroke-width: 2
    }
  }
  flow_box: {
    shape: rectangle
    style: {
      fill: "#E6F3FF"
      stroke: "#4169E1"
      stroke-width: 2
      border-radius: 4
    }
  }
  label_text: {
    shape: text
    style: {
      font-size: 14
      bold: true
    }
  }
}
section_irq_low: IRQ0-7 (Master PIC Only) {
  irq_low_devices: {
    timer: Timer (IRQ0) {class: device}
    keyboard: Keyboard (IRQ1) {class: device}
    cascade: Cascade (IRQ2) {class: device}
    other_low: IRQ3-7 {class: device}
  }
  master_pic_low: Master PIC {
    class: pic_chip
    label: "Master PIC\nPort: 0x20/0x21"
  }
  eoi_master_only: EOI to Master {
    class: eoi_cmd
    label: "outb(0x20, 0x20)\nEOI Command"
  }
  irq_low_devices.timer -> master_pic_low: "IRQ0"
  irq_low_devices.keyboard -> master_pic_low: "IRQ1"
  irq_low_devices.cascade -> master_pic_low: "IRQ2"
  irq_low_devices.other_low -> master_pic_low: "IRQ3-7"
  master_pic_low -> eoi_master_only: "Handler\ncompletes"
}
section_irq_high: IRQ8-15 (Both PICs) {
  irq_high_devices: {
    rtc: RTC (IRQ8) {class: device}
    mouse: Mouse (IRQ12) {class: device}
    disk: Disk (IRQ14/15) {class: device}
    other_high: IRQ9-11,13 {class: device}
  }
  slave_pic: Slave PIC {
    class: pic_chip
    label: "Slave PIC\nPort: 0xA0/0xA1"
  }
  master_pic_high: Master PIC {
    class: pic_chip
    label: "Master PIC\n(IRQ2 cascade)"
  }
  eoi_slave_first: EOI to Slave First {
    class: eoi_cmd
    label: "outb(0xA0, 0x20)\nEOI to Slave"
  }
  eoi_master_second: EOI to Master Second {
    class: eoi_cmd
    label: "outb(0x20, 0x20)\nEOI to Master"
  }
  irq_high_devices.rtc -> slave_pic: "IRQ8"
  irq_high_devices.mouse -> slave_pic: "IRQ12"
  irq_high_devices.disk -> slave_pic: "IRQ14/15"
  irq_high_devices.other_high -> slave_pic: "IRQ9-11,13"
  slave_pic -> master_pic_high: "Signals via\nIRQ2 cascade"
  master_pic_high -> eoi_slave_first: "Handler\ncompletes"
  eoi_slave_first -> eoi_master_second: "Then"
}
legend: |md
  **EOI (End of Interrupt) Protocol:**
  - **IRQ0-7**: Send EOI to Master PIC only
    - `outb(0x20, 0x20)`
  - **IRQ8-15**: Send EOI to BOTH PICs
    - First: `outb(0xA0, 0x20)` (Slave)
    - Then: `outb(0x20, 0x20)` (Master)
  **Why both for IRQ8-15?**
  Slave PIC signals master via IRQ2.
  Both have interrupt "in progress" state.
  Both require acknowledgment.
| {near: bottom-center}