direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#7C3AED"
    hardware: "#3B82F6"
    kernel: "#10B981"
    ascii: "#F59E0B"
    arrow: "#6B7280"
  }
}
title: |md
  # PS/2 Keyboard: Scancode to ASCII Pipeline
| {near: top-center}
hardware: Hardware Layer {
  style.fill: "${colors.hardware}"
  style.stroke: "#1E40AF"
  style.font-color: white
  Keyboard: Keyboard Matrix {
    shape: rectangle
    style.fill: "#1E3A8A"
  }
  KBC: Keyboard Controller (8042) {
    shape: rectangle
    style.fill: "#1E3A8A"
  }
  Port: I/O Port 0x60 {
    shape: rectangle
    style.fill: "#1E3A8A"
  }
  Keyboard -> KBC: Key press/release
  KBC -> Port: Scancode
}
interrupt: Interrupt Handling {
  style.fill: "#EF4444"
  style.stroke: "#991B1B"
  style.font-color: white
  PIC: PIC IRQ1 {
    shape: diamond
    style.fill: "#DC2626"
  }
  CPU: CPU INT 33 {
    shape: rectangle
    style.fill: "#DC2626"
  }
  Port -> PIC: Signal
  PIC -> CPU: Vector 33
}
handler: Keyboard Driver (Kernel) {
  style.fill: "${colors.kernel}"
  style.stroke: "#047857"
  style.font-color: white
  ReadScancode: "1. Read Scancode\ninb(0x60)"
  CheckRelease: "2. Check Release\nscancode & 0x80"
  HandleModifier: "3. Handle Modifier\nShift/Ctrl/Alt/Caps"
  LookupTable: "4. Table Lookup\nscancode to ASCII"
  Buffer: "5. Circular Buffer\nkmalloc'd chars" {
    shape: cylinder
  }
  ReadScancode -> CheckRelease
  CheckRelease -> HandleModifier
  HandleModifier -> LookupTable
  LookupTable -> Buffer
}
CPU -> ReadScancode: Handler invoked
table: Scancode Table (Set 1) {
  style.fill: "#FEF3C7"
  style.stroke: "${colors.ascii}"
  table_content: ||md
    | Key | Make | Break | ASCII |
    |-----|------|-------|-------|
    | A | 0x1E | 0x9E | a/A |
    | B | 0x30 | 0xB0 | b/B |
    | Enter | 0x1C | 0x9C | LF |
    | Space | 0x39 | 0xB9 | SPC |
    | L-Shift | 0x2A | 0xAA | mod |
    | Escape | 0x01 | 0x81 | ESC |
  ||
}
LookupTable -> table: Reference
output: User Space {
  style.fill: "${colors.ascii}"
  style.stroke: "#B45309"
  UserBuffer: "User Read Buffer\ngetchar()" {
    shape: queue
  }
  Process: User Process {
    shape: person
  }
  Buffer -> UserBuffer: keyboard_getchar()
  UserBuffer -> Process: Returns ASCII
}
legend: |md
  **Legend**
  - **Make Code**: Key press
  - **Break Code**: Key release (make + 0x80)
  - **Extended**: 0xE0 prefix
  - **Modifier**: Shift, Ctrl, Alt, Caps
| {near: bottom-right}
anno_hardware: |md
  **Hardware generates scancode**
  - Set 1 (default): 1 byte per key
  - Extended keys: 0xE0 prefix
  - No ASCII conversion in hardware
| {
  shape: text
  style.font-size: 12
  near: top-left
}
anno_handler: |md
  **Kernel driver responsibilities**
  - Read raw scancode from port
  - Track modifier state
  - Convert to ASCII via table
  - Handle buffer overflow
| {
  shape: text
  style.font-size: 12
  near: bottom-left
}