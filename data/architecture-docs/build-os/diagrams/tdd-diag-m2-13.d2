vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#8B5CF6"
    data: "#3B82F6"
    free: "#22C55E"
    pointer: "#F97316"
    text: "#374151"
  }
}
title: |md
  # Keyboard Circular Buffer
  **256-byte buffer with wraparound indices**
|
buffer_container: {
  label: "char kb_buffer[256]"
  style.fill: white
  style.stroke: "${colors.data}"
  style.stroke-width: 2
  grid-columns: 16
  grid-gap: 0
  # Row 0 (indices 0-15)
  cell_0: "0" {style.fill: "${colors.free}"}
  cell_1: "1" {style.fill: "${colors.free}"}
  cell_2: "2" {style.fill: "${colors.free}"}
  cell_3: "3" {style.fill: "${colors.free}"}
  cell_4: "4" {style.fill: "${colors.free}"}
  cell_5: "5" {style.fill: "${colors.free}"}
  cell_6: "6" {style.fill: "${colors.free}"}
  cell_7: "7" {style.fill: "${colors.free}"}
  cell_8: "8" {style.fill: "${colors.free}"}
  cell_9: "9" {style.fill: "${colors.free}"}
  cell_10: "10" {style.fill: "${colors.free}"}
  cell_11: "11" {style.fill: "${colors.free}"}
  cell_12: "12" {style.fill: "${colors.free}"}
  cell_13: "13" {style.fill: "${colors.free}"}
  cell_14: "14" {style.fill: "${colors.free}"}
  cell_15: "15" {style.fill: "${colors.free}"}
  # Row 1 (indices 16-31) with data
  cell_16: "'H'" {style.fill: "${colors.data}"; style.font-color: white}
  cell_17: "'e'" {style.fill: "${colors.data}"; style.font-color: white}
  cell_18: "'l'" {style.fill: "${colors.data}"; style.font-color: white}
  cell_19: "'l'" {style.fill: "${colors.data}"; style.font-color: white}
  cell_20: "'o'" {style.fill: "${colors.data}"; style.font-color: white}
  cell_21: "21" {style.fill: "${colors.free}"}
  cell_22: "22" {style.fill: "${colors.free}"}
  cell_23: "23" {style.fill: "${colors.free}"}
  cell_24: "24" {style.fill: "${colors.free}"}
  cell_25: "25" {style.fill: "${colors.free}"}
  cell_26: "26" {style.fill: "${colors.free}"}
  cell_27: "27" {style.fill: "${colors.free}"}
  cell_28: "28" {style.fill: "${colors.free}"}
  cell_29: "29" {style.fill: "${colors.free}"}
  cell_30: "30" {style.fill: "${colors.free}"}
  cell_31: "31" {style.fill: "${colors.free}"}
  # Ellipsis row
  ellipsis_1: "..." {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_2: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_3: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_4: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_5: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_6: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_7: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_8: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_9: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_10: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_11: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_12: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_13: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_14: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_15: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  ellipsis_16: "" {style.fill: "#F3F4F6"; style.stroke: "#E5E7EB"}
  # Row 15 (indices 240-255)
  cell_240: "240" {style.fill: "${colors.free}"}
  cell_241: "241" {style.fill: "${colors.free}"}
  cell_242: "242" {style.fill: "${colors.free}"}
  cell_243: "243" {style.fill: "${colors.free}"}
  cell_244: "244" {style.fill: "${colors.free}"}
  cell_245: "245" {style.fill: "${colors.free}"}
  cell_246: "246" {style.fill: "${colors.free}"}
  cell_247: "247" {style.fill: "${colors.free}"}
  cell_248: "248" {style.fill: "${colors.free}"}
  cell_249: "249" {style.fill: "${colors.free}"}
  cell_250: "250" {style.fill: "${colors.free}"}
  cell_251: "251" {style.fill: "${colors.free}"}
  cell_252: "252" {style.fill: "${colors.free}"}
  cell_253: "253" {style.fill: "${colors.free}"}
  cell_254: "254" {style.fill: "${colors.free}"}
  cell_255: "255" {style.fill: "${colors.free}"}
}
# Read pointer
read_ptr: {
  label: "read_pos\n= 16"
  shape: hexagon
  style.fill: "${colors.pointer}"
  style.font-color: white
  style.bold: true
}
# Write pointer
write_ptr: {
  label: "write_pos\n= 21"
  shape: hexagon
  style.fill: "${colors.pointer}"
  style.font-color: white
  style.bold: true
}
# Arrows pointing to cells
read_ptr -> buffer_container.cell_16: "reads from" {
  style.stroke: "${colors.pointer}"
  style.stroke-width: 2
  style.bold: true
}
write_ptr -> buffer_container.cell_21: "writes to" {
  style.stroke: "${colors.pointer}"
  style.stroke-width: 2
  style.bold: true
}
# State detection
state_box: {
  label: "Buffer State Detection"
  style.fill: "#FEF3C7"
  style.stroke: "#F59E0B"
  style.stroke-width: 2
  empty_check: |md
    **EMPTY:** `read_pos == write_pos`
    Returns 0, no data available
  |
  full_check: |md
    **FULL:** `(write_pos + 1) % 256 == read_pos`
    Discard input, buffer overflow
  |
  available: |md
    **AVAILABLE:** `write_pos - read_pos`
    (with wraparound: `+ 256) % 256`
  |
}
# Wraparound logic
wraparound_box: {
  label: "Wraparound Logic"
  style.fill: "#DBEAFE"
  style.stroke: "${colors.data}"
  style.stroke-width: 2
  put_logic: |md
    **PUT (keyboard_handler):**
    next = (write_pos + 1) % 256
    if (next != read_pos) {
        buffer[write_pos] = char
        write_pos = next
    }
  |
  get_logic: |md
    **GET (keyboard_getchar):**
    if (read_pos != write_pos) {
        c = buffer[read_pos]
        read_pos = (read_pos + 1) % 256
        return c
    }
    return 0
  |
}
# Legend
legend: {
  label: "Legend"
  style.fill: white
  style.stroke: "#9CA3AF"
  data_cell: "Data" {style.fill: "${colors.data}"; style.font-color: white}
  free_cell: "Free" {style.fill: "${colors.free}"}
  ptr: "Pointer" {shape: hexagon; style.fill: "${colors.pointer}"; style.font-color: white}
}
# Layout
read_ptr.near: top-left
write_ptr.near: top-right
state_box.near: bottom-left
wraparound_box.near: bottom-right
legend.near: bottom-center