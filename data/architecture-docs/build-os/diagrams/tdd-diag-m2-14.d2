vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Double Fault Handler Strategy
  Exception 8 with Error Code → Print All Registers → Halt
| {near: top-center}
# Hardware layer
hardware_layer: {
  label: "Hardware Layer"
  style.fill: "#F8E8FF"
  style.stroke: "#9B59B6"
  style.stroke-width: 2
  cpu_exception: "CPU Exception\nVector 8" {
    shape: circle
    style.fill: "#E8D4F8"
    style.stroke: "#9B59B6"
  }
  error_code_push: "Error Code\nPushed by CPU" {
    shape: rectangle
    style.fill: "#FFE6E6"
    style.stroke: "#E74C3C"
    style.font-color: "#C0392B"
    style.bold: true
  }
}
# Assembly stub layer
assembly_layer: {
  label: "Assembly Stub Layer"
  style.fill: "#FFF8E1"
  style.stroke: "#F39C12"
  style.stroke-width: 2
  stub_entry: "isr8 Entry\n(no fake error)" {
    shape: rectangle
    style.fill: "#FFF3CD"
    style.stroke: "#F39C12"
  }
  push_state: "Push State\npusha + segments" {
    shape: rectangle
    style.fill: "#FFF3CD"
    style.stroke: "#F39C12"
  }
  call_handler: "Call C Handler\nisr_common_handler" {
    shape: rectangle
    style.fill: "#FFF3CD"
    style.stroke: "#F39C12"
  }
}
# C handler layer
c_handler_layer: {
  label: "C Handler Layer"
  style.fill: "#E8F6FF"
  style.stroke: "#3498DB"
  style.stroke-width: 2
  identify_exception: "Identify Exception\nint_no == 8" {
    shape: diamond
    style.fill: "#D6EAF8"
    style.stroke: "#3498DB"
  }
  print_banner: |md
    **Print Banner**
    "!!! DOUBLE FAULT !!!"
    "System Halted"
  | {
    shape: rectangle
    style.fill: "#D6EAF8"
    style.stroke: "#3498DB"
  }
  print_registers: |md
    **Print All Registers**
    EIP, CS, EFLAGS
    EAX, EBX, ECX, EDX
    ESI, EDI, EBP, ESP
    DS, ES, FS, GS
    Error Code
  | {
    shape: rectangle
    style.fill: "#E8F8E8"
    style.stroke: "#27AE60"
    style.bold: true
  }
  print_diagnostic: |md
    **Print Diagnostic Info**
    "This usually indicates:"
    "- Kernel stack corruption"
    "- Exception in exception handler"
  | {
    shape: rectangle
    style.fill: "#D6EAF8"
    style.stroke: "#3498DB"
  }
}
# Halt layer
halt_layer: {
  label: "Halt Layer"
  style.fill: "#FFEBEE"
  style.stroke: "#E74C3C"
  style.stroke-width: 2
  cli: "cli\nDisable Interrupts" {
    shape: rectangle
    style.fill: "#FFCDD2"
    style.stroke: "#E74C3C"
  }
  hlt: "hlt\nHalt CPU" {
    shape: rectangle
    style.fill: "#EF9A9A"
    style.stroke: "#C0392B"
    style.bold: true
    style.font-color: "#B71C1C"
  }
  prevent_triple: |md
    **Prevents Triple Fault**
    CPU would reset on
    unhandled exception
  | {
    shape: rectangle
    style.fill: "#FFEBEE"
    style.stroke: "#E74C3C"
    style.stroke-dash: 3
  }
}
# Stack visualization
stack_layout: {
  label: "Stack Layout at Handler Entry"
  style.fill: "#F5F5F5"
  style.stroke: "#9E9E9E"
  style.stroke-width: 2
  stack_high: "High Addresses ↑" {
    shape: text
    style.font-size: 12
    style.font-color: "#757575"
  }
  ss_frame: "SS (if privilege change)" {
    shape: rectangle
    style.fill: "#E3F2FD"
    style.stroke: "#1976D2"
    width: 180
  }
  esp_frame: "User ESP (if privilege change)" {
    shape: rectangle
    style.fill: "#E3F2FD"
    style.stroke: "#1976D2"
    width: 180
  }
  eflags_frame: "EFLAGS" {
    shape: rectangle
    style.fill: "#E8F5E9"
    style.stroke: "#388E3C"
    width: 180
  }
  cs_frame: "CS" {
    shape: rectangle
    style.fill: "#E8F5E9"
    style.stroke: "#388E3C"
    width: 180
  }
  eip_frame: "EIP (return address)" {
    shape: rectangle
    style.fill: "#E8F5E9"
    style.stroke: "#388E3C"
    width: 180
  }
  error_frame: "**Error Code** (CPU pushed)" {
    shape: rectangle
    style.fill: "#FFCDD2"
    style.stroke: "#D32F2F"
    style.bold: true
    style.font-color: "#B71C1C"
    width: 180
  }
  stub_pushes: "Stub pushes:\nint_no, regs, segments" {
    shape: rectangle
    style.fill: "#FFF8E1"
    style.stroke: "#F9A825"
    width: 180
  }
  stack_low: "Low Addresses ↓\nESP points here" {
    shape: text
    style.font-size: 12
    style.font-color: "#757575"
  }
}
# Flow connections
hardware_layer.cpu_exception -> hardware_layer.error_code_push: "always"
hardware_layer.error_code_push -> assembly_layer.stub_entry: "ISR stub"
assembly_layer.stub_entry -> assembly_layer.push_state
assembly_layer.push_state -> assembly_layer.call_handler
assembly_layer.call_handler -> c_handler_layer.identify_exception
c_handler_layer.identify_exception -> c_handler_layer.print_banner: "int_no == 8"
c_handler_layer.print_banner -> c_handler_layer.print_registers
c_handler_layer.print_registers -> c_handler_layer.print_diagnostic
c_handler_layer.print_diagnostic -> halt_layer.cli
halt_layer.cli -> halt_layer.hlt
halt_layer.hlt -> halt_layer.prevent_triple: "prevents"
# Stack connections
stack_layout.stack_high -> stack_layout.ss_frame
stack_layout.ss_frame -> stack_layout.esp_frame
stack_layout.esp_frame -> stack_layout.eflags_frame
stack_layout.eflags_frame -> stack_layout.cs_frame
stack_layout.cs_frame -> stack_layout.eip_frame
stack_layout.eip_frame -> stack_layout.error_frame
stack_layout.error_frame -> stack_layout.stub_pushes
stack_layout.stub_pushes -> stack_layout.stack_low
# Annotations (using constant near values for ELK compatibility)
note_error: |md
  **Error Code Format**
  Always 0 for Double Fault
  Indicates exception occurred
  while handling another
  exception
| {
  near: center-left
  shape: text
  style.font-size: 11
  style.font-color: "#666"
}
note_prevention: |md
  **Why Halt?**
  - Double fault is unrecoverable
  - Returning would cause triple fault
  - CPU reset is the only option
  - At least print diagnostics first!
| {
  near: center-right
  shape: text
  style.font-size: 11
  style.font-color: "#666"
}