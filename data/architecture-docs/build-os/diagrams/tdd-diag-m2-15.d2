vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#8B5CF6"
    segment: "#F97316"
    general: "#3B82F6"
    metadata: "#10B981"
    cpu_pushed: "#EF4444"
    user: "#F59E0B"
    label: "#64748B"
  }
}
title: |md
  # Interrupt Handler Register Structure
  `struct cpu_state` — 76 bytes total
| {near: top-center}
container: {
  style.fill: transparent
  direction: right
  stack_layout: {
    direction: down
    style.fill: transparent
    seg_header: "Segment Registers\n(pushed by our stub)" {
      style.fill: "${colors.header}"
      style.font-color: white
      style.bold: true
      width: 280
    }
    gs: {
      grid-columns: 3
      gs_offset: "0x00" {style.fill: "${colors.segment}" style.font: mono}
      gs_name: "gs" {style.fill: "${colors.segment}" style.bold: true}
      gs_desc: "GS segment register" {style.fill: "${colors.segment}"}
    }
    fs: {
      grid-columns: 3
      fs_offset: "0x04" {style.fill: "${colors.segment}" style.font: mono}
      fs_name: "fs" {style.fill: "${colors.segment}" style.bold: true}
      fs_desc: "FS segment register" {style.fill: "${colors.segment}"}
    }
    es: {
      grid-columns: 3
      es_offset: "0x08" {style.fill: "${colors.segment}" style.font: mono}
      es_name: "es" {style.fill: "${colors.segment}" style.bold: true}
      es_desc: "ES segment register" {style.fill: "${colors.segment}"}
    }
    ds: {
      grid-columns: 3
      ds_offset: "0x0C" {style.fill: "${colors.segment}" style.font: mono}
      ds_name: "ds" {style.fill: "${colors.segment}" style.bold: true}
      ds_desc: "DS segment register" {style.fill: "${colors.segment}"}
    }
    gen_header: "General Purpose Registers\n(pusha: EDI,ESI,EBP,ESP,EBX,EDX,ECX,EAX)" {
      style.fill: "${colors.general}"
      style.font-color: white
      style.bold: true
      width: 280
    }
    edi: {
      grid-columns: 3
      edi_offset: "0x10" {style.fill: "${colors.general}" style.font: mono}
      edi_name: "edi" {style.fill: "${colors.general}" style.bold: true}
      edi_desc: "Destination index" {style.fill: "${colors.general}"}
    }
    esi: {
      grid-columns: 3
      esi_offset: "0x14" {style.fill: "${colors.general}" style.font: mono}
      esi_name: "esi" {style.fill: "${colors.general}" style.bold: true}
      esi_desc: "Source index" {style.fill: "${colors.general}"}
    }
    ebp: {
      grid-columns: 3
      ebp_offset: "0x18" {style.fill: "${colors.general}" style.font: mono}
      ebp_name: "ebp" {style.fill: "${colors.general}" style.bold: true}
      ebp_desc: "Base pointer" {style.fill: "${colors.general}"}
    }
    esp: {
      grid-columns: 3
      esp_offset: "0x1C" {style.fill: "${colors.general}" style.font: mono}
      esp_name: "esp" {style.fill: "${colors.general}" style.bold: true}
      esp_desc: "Stack pointer (pre-pusha)" {style.fill: "${colors.general}"}
    }
    ebx: {
      grid-columns: 3
      ebx_offset: "0x20" {style.fill: "${colors.general}" style.font: mono}
      ebx_name: "ebx" {style.fill: "${colors.general}" style.bold: true}
      ebx_desc: "Base register" {style.fill: "${colors.general}"}
    }
    edx: {
      grid-columns: 3
      edx_offset: "0x24" {style.fill: "${colors.general}" style.font: mono}
      edx_name: "edx" {style.fill: "${colors.general}" style.bold: true}
      edx_desc: "Data register" {style.fill: "${colors.general}"}
    }
    ecx: {
      grid-columns: 3
      ecx_offset: "0x28" {style.fill: "${colors.general}" style.font: mono}
      ecx_name: "ecx" {style.fill: "${colors.general}" style.bold: true}
      ecx_desc: "Count register" {style.fill: "${colors.general}"}
    }
    eax: {
      grid-columns: 3
      eax_offset: "0x2C" {style.fill: "${colors.general}" style.font: mono}
      eax_name: "eax" {style.fill: "${colors.general}" style.bold: true}
      eax_desc: "Accumulator / return value" {style.fill: "${colors.general}"}
    }
    meta_header: "Interrupt Metadata\n(pushed by our stub)" {
      style.fill: "${colors.metadata}"
      style.font-color: white
      style.bold: true
      width: 280
    }
    int_no: {
      grid-columns: 3
      int_offset: "0x30" {style.fill: "${colors.metadata}" style.font: mono}
      int_name: "int_no" {style.fill: "${colors.metadata}" style.bold: true}
      int_desc: "Interrupt vector number" {style.fill: "${colors.metadata}"}
    }
    err_code: {
      grid-columns: 3
      err_offset: "0x34" {style.fill: "${colors.metadata}" style.font: mono}
      err_name: "err_code" {style.fill: "${colors.metadata}" style.bold: true}
      err_desc: "CPU error code (0 if N/A)" {style.fill: "${colors.metadata}"}
    }
    cpu_header: "CPU-Pushed State\n(automatic on interrupt)" {
      style.fill: "${colors.cpu_pushed}"
      style.font-color: white
      style.bold: true
      width: 280
    }
    eip: {
      grid-columns: 3
      eip_offset: "0x38" {style.fill: "${colors.cpu_pushed}" style.font: mono}
      eip_name: "eip" {style.fill: "${colors.cpu_pushed}" style.bold: true}
      eip_desc: "Instruction pointer (return addr)" {style.fill: "${colors.cpu_pushed}"}
    }
    cs: {
      grid-columns: 3
      cs_offset: "0x3C" {style.fill: "${colors.cpu_pushed}" style.font: mono}
      cs_name: "cs" {style.fill: "${colors.cpu_pushed}" style.bold: true}
      cs_desc: "Code segment selector" {style.fill: "${colors.cpu_pushed}"}
    }
    eflags: {
      grid-columns: 3
      flags_offset: "0x40" {style.fill: "${colors.cpu_pushed}" style.font: mono}
      flags_name: "eflags" {style.fill: "${colors.cpu_pushed}" style.bold: true}
      flags_desc: "CPU flags register" {style.fill: "${colors.cpu_pushed}"}
    }
    user_header: "Privilege Change Only\n(ring 3 → ring 0)" {
      style.fill: "${colors.user}"
      style.font-color: white
      style.bold: true
      width: 280
    }
    useresp: {
      grid-columns: 3
      uesp_offset: "0x44" {style.fill: "${colors.user}" style.font: mono}
      uesp_name: "useresp" {style.fill: "${colors.user}" style.bold: true}
      uesp_desc: "User mode stack pointer" {style.fill: "${colors.user}"}
    }
    ss: {
      grid-columns: 3
      ss_offset: "0x48" {style.fill: "${colors.user}" style.font: mono}
      ss_name: "ss" {style.fill: "${colors.user}" style.bold: true}
      ss_desc: "User mode stack segment" {style.fill: "${colors.user}"}
    }
  }
  stack_viz: {
    direction: down
    style.fill: "#1E293B"
    style.stroke: "#475569"
    style.border-radius: 8
    width: 180
    stack_title: "Stack Growth" {
      style.fill: "#334155"
      style.font-color: white
      style.bold: true
    }
    high_label: "High addresses" {
      shape: text
      style.font-color: "${colors.label}"
      style.font-size: 12
    }
    user_box: "ss\nuseresp" {
      style.fill: "${colors.user}"
      style.font: mono
      style.stroke: "${colors.user}"
    }
    cpu_box: "eflags\ncs\neip" {
      style.fill: "${colors.cpu_pushed}"
      style.font: mono
    }
    meta_box: "err_code\nint_no" {
      style.fill: "${colors.metadata}"
      style.font: mono
    }
    gen_box: "eax...edi" {
      style.fill: "${colors.general}"
      style.font: mono
    }
    seg_box: "ds...gs" {
      style.fill: "${colors.segment}"
      style.font: mono
    }
    esp_arrow: "ESP" {
      shape: text
      style.font-color: "#22D3EE"
      style.bold: true
      style.font: mono
    }
    low_label: "Low addresses" {
      shape: text
      style.font-color: "${colors.label}"
      style.font-size: 12
    }
  }
}
size_note: |md
  **Total: 76 bytes** (19 × 4-byte fields)
  struct cpu_state {
      uint32_t gs, fs, es, ds;     // 16 bytes
      uint32_t edi, esi, ebp;      // 12 bytes
      uint32_t esp, ebx, edx;      // 12 bytes
      uint32_t ecx, eax;           // 8 bytes
      uint32_t int_no, err_code;   // 8 bytes
      uint32_t eip, cs, eflags;    // 12 bytes
      uint32_t useresp, ss;        // 8 bytes
  } __attribute__((packed));
| {near: bottom-center}