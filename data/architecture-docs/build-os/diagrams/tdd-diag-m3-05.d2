vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Virtual Address Bit Breakdown
  **32-bit x86 Two-Level Page Table Translation**
| {near: top-center}
direction: right
# Virtual Address Container
virtual_addr: "Virtual Address (32 bits)" {
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  style.stroke-width: 2
  # Bit positions header
  bits_row: {
    grid-columns: 3
    grid-gap: 0
    pd_bits: "Bits 31-22\nPage Directory Index" {
      style.fill: "#9B59B6"
      style.stroke: "#7D3C98"
      style.font-color: white
      style.bold: true
      width: 200
    }
    pt_bits: "Bits 21-12\nPage Table Index" {
      style.fill: "#3498DB"
      style.stroke: "#2980B9"
      style.font-color: white
      style.bold: true
      width: 200
    }
    offset_bits: "Bits 11-0\nPage Offset" {
      style.fill: "#27AE60"
      style.stroke: "#1E8449"
      style.font-color: white
      style.bold: true
      width: 200
    }
  }
  # Size indicators
  size_row: {
    grid-columns: 3
    grid-gap: 0
    pd_size: "10 bits\n1024 entries" {
      style.fill: "#D7BDE2"
      style.stroke: "#7D3C98"
      style.font-size: 14
    }
    pt_size: "10 bits\n1024 entries" {
      style.fill: "#AED6F1"
      style.stroke: "#2980B9"
      style.font-size: 14
    }
    offset_size: "12 bits\n4096 bytes" {
      style.fill: "#A9DFBF"
      style.stroke: "#1E8449"
      style.font-size: 14
    }
  }
  # Coverage
  coverage_row: {
    grid-columns: 3
    grid-gap: 0
    pd_cov: "Coverage:\n4 MB per entry" {
      style.fill: "#F5EEF8"
      style.stroke: "#7D3C98"
      style.font-size: 12
    }
    pt_cov: "Coverage:\n4 KB per entry" {
      style.fill: "#EBF5FB"
      style.stroke: "#2980B9"
      style.font-size: 12
    }
    offset_cov: "Coverage:\n1 byte per entry" {
      style.fill: "#E9F7EF"
      style.stroke: "#1E8449"
      style.font-size: 12
    }
  }
}
# Translation Process
translation: "Translation Process" {
  style.fill: "#FDFEFE"
  style.stroke: "#BDC3C7"
  step1: "1. Extract PD Index" {
    shape: text
    style.fill: transparent
    style.font-color: "#7D3C98"
    style.bold: true
  }
  step2: "2. Look up Page Directory" {
    shape: text
    style.fill: transparent
    style.font-color: "#7D3C98"
  }
  step3: "3. Extract PT Index" {
    shape: text
    style.fill: transparent
    style.font-color: "#2980B9"
    style.bold: true
  }
  step4: "4. Look up Page Table" {
    shape: text
    style.fill: transparent
    style.font-color: "#2980B9"
  }
  step5: "5. Add Offset" {
    shape: text
    style.fill: transparent
    style.font-color: "#1E8449"
    style.bold: true
  }
  step6: "6. Physical Address" {
    shape: text
    style.fill: transparent
    style.font-color: "#1E8449"
  }
}
# Page Directory
page_dir: "Page Directory" {
  style.fill: "#D7BDE2"
  style.stroke: "#7D3C98"
  style.stroke-width: 2
  pd_entries: |md
    **1024 entries × 4 bytes = 4 KB**
    Entry contains:
    - Page table base address
    - Present, R/W, U/S flags
    - Accessed, dirty bits
  |
}
# Page Table
page_table: "Page Table" {
  style.fill: "#AED6F1"
  style.stroke: "#2980B9"
  style.stroke-width: 2
  pt_entries: |md
    **1024 entries × 4 bytes = 4 KB**
    Entry contains:
    - Physical frame address
    - Present, R/W, U/S flags
    - Accessed, dirty bits
  |
}
# Physical Frame
phys_frame: "Physical Frame" {
  style.fill: "#A9DFBF"
  style.stroke: "#1E8449"
  style.stroke-width: 2
  frame_info: |md
    **4096 bytes (4 KB)**
    Frame base + offset
    = Final physical address
  |
}
# Physical Address Result
phys_addr: "Physical Address (32 bits)" {
  style.fill: "#F39C12"
  style.stroke: "#D68910"
  style.stroke-width: 2
  style.font-color: white
  style.bold: true
  phys_breakdown: {
    grid-columns: 2
    grid-gap: 0
    frame_addr: "Frame Base\n(Bits 31-12)" {
      style.fill: "#E67E22"
      style.font-color: white
    }
    phys_offset: "Offset\n(Bits 11-0)" {
      style.fill: "#D35400"
      style.font-color: white
    }
  }
}
# Connections
virtual_addr.bits_row.pd_bits -> page_dir: "Index" {
  style.stroke: "#7D3C98"
  style.stroke-width: 2
}
page_dir -> page_table: "Base addr" {
  style.stroke: "#7D3C98"
  style.stroke-width: 2
}
virtual_addr.bits_row.pt_bits -> page_table: "Index" {
  style.stroke: "#2980B9"
  style.stroke-width: 2
}
page_table -> phys_frame: "Frame addr" {
  style.stroke: "#2980B9"
  style.stroke-width: 2
}
virtual_addr.bits_row.offset_bits -> phys_frame: "Add" {
  style.stroke: "#1E8449"
  style.stroke-width: 2
}
phys_frame -> phys_addr: "Result" {
  style.stroke: "#D68910"
  style.stroke-width: 2
  style.animated: true
}
# Example
example: "Example Translation" {
  style.fill: "#FDFEFE"
  style.stroke: "#BDC3C7"
  near: bottom-center
  ex_content: |md
    **Virtual: 0xC0101234**
    - PD Index: 0x300 (768) → Maps to kernel space
    - PT Index: 0x101 (257)
    - Offset: 0x234 (564 bytes)
    **Translation:**
    PD[768] → PT at frame 0x0001F
    PT[257] → Frame 0x00A5B
    Physical = 0x00A5B234
  |
}
# Legend
legend: {
  near: bottom-right
  style.fill: "#F8F9F9"
  style.stroke: "#BDC3C7"
  leg_title: "Legend" {
    style.bold: true
    style.fill: transparent
    style.stroke: transparent
  }
  purple: "Purple: Page Directory" {
    shape: text
    style.fill: transparent
    style.font-color: "#7D3C98"
  }
  blue: "Blue: Page Table" {
    shape: text
    style.fill: transparent
    style.font-color: "#2980B9"
  }
  green: "Green: Offset/Frame" {
    shape: text
    style.fill: transparent
    style.font-color: "#1E8449"
  }
  orange: "Orange: Physical Result" {
    shape: text
    style.fill: transparent
    style.font-color: "#D68910"
  }
}