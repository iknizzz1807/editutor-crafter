vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Dual Mapping: Identity + Higher-Half Kernel
  Same physical frames mapped at both 0x00100000 and 0xC0100000
| {near: top-center}
direction: right
classes: {
  physical_frame: {
    shape: rectangle
    style: {
      fill: "#E8F5E9"
      stroke: "#2E7D32"
      stroke-width: 2
    }
  }
  virtual_addr: {
    shape: rectangle
    style: {
      fill: "#E3F2FD"
      stroke: "#1565C0"
      stroke-width: 2
    }
  }
  page_table: {
    shape: rectangle
    style: {
      fill: "#FFF3E0"
      stroke: "#E65100"
      stroke-width: 2
    }
  }
  arrow_mapping: {
    style: {
      stroke: "#7B1FA2"
      stroke-width: 2
    }
  }
  arrow_identity: {
    style: {
      stroke: "#00695C"
      stroke-width: 2
      stroke-dash: 4
    }
  }
}
# Virtual Address Space
virtual_space: "Virtual Address Space (32-bit)" {
  style.fill: "#FAFAFA"
  style.stroke: "#9E9E9E"
  identity_region: "Identity Mapping\n(Virtual = Physical)" {
    style.fill: "#E3F2FD"
    vga: "0x000B8000\nVGA Buffer" {
      class: virtual_addr
      width: 140
    }
    kernel_low: "0x00100000\nKernel Code" {
      class: virtual_addr
      width: 140
      style.fill: "#BBDEFB"
      style.bold: true
    }
  }
  higher_half_region: "Higher-Half Mapping\n(0xC0000000+)" {
    style.fill: "#F3E5F5"
    kernel_high: "0xC0100000\nKernel Code" {
      class: virtual_addr
      width: 140
      style.fill: "#E1BEE7"
      style.bold: true
    }
    kernel_data: "0xC0100000+\nKernel Data" {
      class: virtual_addr
      width: 140
    }
  }
}
# Page Tables
page_tables: "Page Tables" {
  style.fill: "#FFF8E1"
  style.stroke: "#FF8F00"
  pd: "Page Directory\n(CR3)" {
    class: page_table
    width: 120
  }
  pt_low: "Page Table 0\n(entries 0-255)" {
    class: page_table
    width: 140
  }
  pt_high: "Page Table 768\n(entries 0-255)" {
    class: page_table
    width: 140
  }
}
# Physical Memory
physical_memory: "Physical Memory" {
  style.fill: "#E8F5E9"
  style.stroke: "#2E7D32"
  vga_phys: "0x000B8000\nVGA Buffer\n(Video RAM)" {
    class: physical_frame
    width: 120
    style.fill: "#FFCDD2"
    style.stroke: "#C62828"
  }
  kernel_phys: "0x00100000\nKernel Binary\n(Code + Data)" {
    class: physical_frame
    width: 120
    style.fill: "#C8E6C9"
    style.bold: true
  }
}
# Mappings - Identity
virtual_space.identity_region.vga -> page_tables.pt_low: "PDE[0]\nPT[184]" {
  class: arrow_identity
}
virtual_space.identity_region.kernel_low -> page_tables.pt_low: "PDE[0]\nPT[256]" {
  class: arrow_identity
  style.stroke: "#00695C"
  style.bold: true
}
page_tables.pt_low -> physical_memory.vga_phys: "PTE → 0xB8000" {
  class: arrow_identity
}
page_tables.pt_low -> physical_memory.kernel_phys: "PTE → 0x100000" {
  class: arrow_identity
  style.stroke: "#00695C"
  style.bold: true
}
# Mappings - Higher-Half
virtual_space.higher_half_region.kernel_high -> page_tables.pt_high: "PDE[768]\nPT[256]" {
  class: arrow_mapping
  style.bold: true
}
virtual_space.higher_half_region.kernel_data -> page_tables.pt_high: "PDE[768]" {
  class: arrow_mapping
}
page_tables.pt_high -> physical_memory.kernel_phys: "PTE → 0x100000\n(Same Frame!)" {
  class: arrow_mapping
  style.bold: true
}
# Page Directory connections
page_tables.pd -> page_tables.pt_low: "Entry 0" {
  style.stroke: "#E65100"
  style.stroke-dash: 3
}
page_tables.pd -> page_tables.pt_high: "Entry 768" {
  style.stroke: "#E65100"
  style.stroke-dash: 3
}
# Legend
legend: |md
  **Legend:**
  - **Green boxes**: Physical RAM frames
  - **Blue boxes**: Virtual addresses (identity-mapped)
  - **Purple boxes**: Virtual addresses (higher-half)
  - **Orange boxes**: Page table structures
  - **Dashed arrows**: Identity mapping path
  - **Solid purple arrows**: Higher-half mapping path
  **Key Insight**: Both `0x00100000` and `0xC0100000` 
  translate to the **same physical frame** at `0x100000`.
| {
  near: bottom-center
  shape: text
  style.font-size: 14
}