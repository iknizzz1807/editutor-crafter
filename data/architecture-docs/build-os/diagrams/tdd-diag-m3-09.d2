vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Paging Enable Sequence
  Load CR3 → Set CR0.PG → Far Jump → Reload Segments
| {near: top-center}
direction: right
step1: {
  label: "1. Load CR3"
  style.fill: "#E4DBFE"
  style.stroke: "#B5AFF6"
  cr3_op: |md
    
    mov eax, page_dir_addr
    mov cr3, eax
    
  |
  cr3_desc: |md
    Loads page directory base
    address into CR3 register.
    TLB is flushed on CR3 write.
  | {style.fill: "transparent"}
}
step2: {
  label: "2. Set CR0.PG"
  style.fill: "#E4DBFE"
  style.stroke: "#B5AFF6"
  cr0_op: |md
    
    mov eax, cr0
    or eax, 0x80000000
    mov cr0, eax
    
  |
  cr0_desc: |md
    Sets bit 31 (PG) to enable
    paging. CPU is now in paged
    mode but CS still has old selector.
  | {style.fill: "transparent"}
}
step3: {
  label: "3. Far Jump"
  style.fill: "#ACE1AF"
  style.stroke: "#228B22"
  farjump_op: |md
    
    jmp 0x08:pm_entry
    
  |
  farjump_desc: |md
    Flushes pipeline and loads
    CS with protected-mode
    selector. CRITICAL: code
    MUST be identity-mapped!
  | {style.fill: "transparent"}
}
step4: {
  label: "4. Reload Segments"
  style.fill: "#E4DBFE"
  style.stroke: "#B5AFF6"
  reload_op: |md
    
    mov ax, 0x10
    mov ds, ax
    mov es, ax
    mov fs, ax
    mov gs, ax
    mov ss, ax
    
  |
  reload_desc: |md
    Load all data segment
    registers with kernel
    data selector (index 2).
  | {style.fill: "transparent"}
}
step1 -> step2: {
  label: "CR3 loaded"
  style.stroke: "#6A5ACD"
}
step2 -> step3: {
  label: "Paging ON"
  style.stroke: "#228B22"
  style.stroke-width: 3
}
step3 -> step4: {
  label: "In 32-bit PM"
  style.stroke: "#6A5ACD"
}
warning: |md
  ⚠️ **CRITICAL**: Between `mov cr0` and `jmp`, code executes in undefined state.
  The instruction at the jump target MUST be identity-mapped or CPU will triple fault.
| {
  near: bottom-center
  style.fill: "#FFE4E1"
  style.stroke: "#DC143C"
  style.border-radius: 8
}