vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Page Fault Error Code Decode
  Exception 14 - CR2 contains faulting address
| {near: top-center}
direction: right
error_code: "Error Code (4 bytes pushed by CPU)" {
  style.fill: "#E8E4F0"
  style.stroke: "#7B68EE"
  style.stroke-width: 2
  bit_layout: {
    grid-columns: 5
    grid-gap: 0
    b0: "0" {
      style.fill: "#FFE4B5"
      style.stroke: "#FF8C00"
    }
    b1: "1" {
      style.fill: "#FFE4B5"
      style.stroke: "#FF8C00"
    }
    b2: "2" {
      style.fill: "#FFE4B5"
      style.stroke: "#FF8C00"
    }
    b3: "3" {
      style.fill: "#E6E6FA"
      style.stroke: "#9370DB"
    }
    b4: "4" {
      style.fill: "#E6E6FA"
      style.stroke: "#9370DB"
    }
    bit0_label: "P" {
      style.bold: true
      style.font-size: 14
    }
    bit1_label: "W" {
      style.bold: true
      style.font-size: 14
    }
    bit2_label: "U" {
      style.bold: true
      style.font-size: 14
    }
    bit3_label: "R" {
      style.bold: true
      style.font-size: 14
    }
    bit4_label: "I" {
      style.bold: true
      style.font-size: 14
    }
  }
  reserved: "Bits 5-31: Reserved" {
    style.fill: "#D3D3D3"
    style.stroke: "#808080"
    style.font-color: "#696969"
  }
}
decoding: "Decode Logic" {
  style.fill: "#F0F8FF"
  style.stroke: "#4682B4"
  present: {
    shape: diamond
    label: "P=0?"
    style.fill: "#FFFACD"
  }
  present_yes: "Page NOT Present\n(need to map or load)" {
    style.fill: "#90EE90"
    style.stroke: "#228B22"
  }
  present_no: {
    shape: diamond
    label: "W=1?"
    style.fill: "#FFFACD"
  }
  write_yes: "Write Access\n(attempted write to RO page)" {
    style.fill: "#FFB6C1"
    style.stroke: "#DC143C"
  }
  write_no: "Read Access\n(attempted read)" {
    style.fill: "#ADD8E6"
    style.stroke: "#4169E1"
  }
  user_check: {
    shape: diamond
    label: "U=1?"
    style.fill: "#FFFACD"
  }
  user_yes: "User Mode\n(ring 3 access)" {
    style.fill: "#DDA0DD"
    style.stroke: "#8B008B"
  }
  user_no: "Kernel Mode\n(ring 0 access)" {
    style.fill: "#B0C4DE"
    style.stroke: "#4682B4"
  }
  present -> present_yes: "Yes" {style.stroke: "#228B22"}
  present -> present_no: "No" {style.stroke: "#4682B4"}
  present_no -> write_yes: "Yes" {style.stroke: "#DC143C"}
  present_no -> write_no: "No" {style.stroke: "#4169E1"}
  write_no -> user_check
  user_check -> user_yes: "Yes" {style.stroke: "#8B008B"}
  user_check -> user_no: "No" {style.stroke: "#4682B4"}
}
special_bits: "Special Bits" {
  style.fill: "#FFF8DC"
  style.stroke: "#DAA520"
  r_bit: "R (bit 3)" {
    style.fill: "#E6E6FA"
    style.stroke: "#9370DB"
  }
  r_desc: |md
    Reserved bit set in page table
    0: Reserved bits clear
    1: Reserved bit violation
  |
  i_bit: "I (bit 4)" {
    style.fill: "#E6E6FA"
    style.stroke: "#9370DB"
  }
  i_desc: |md
    Instruction Fetch (NX/Execute-Disable)
    0: Data access
    1: Instruction fetch from NX page
  |
}
handler_action: "Handler Actions" {
  style.fill: "#F5F5F5"
  style.stroke: "#2F4F4F"
  step1: "1. Read CR2 for faulting address"
  step2: "2. Decode error code bits"
  step3: "3. Check page tables for mapping"
  step4: "4. Handle: map page, kill process, or signal"
  step1 -> step2 -> step3 -> step4
}
error_code -> decoding
decoding -> handler_action
special_bits -> handler_action
legend: ||md
  **Error Code Bit Summary:**
  | Bit | Name | 0 = | 1 = |
  |-----|------|-----|-----|
  | 0 | P (Present) | Page not present | Protection violation |
  | 1 | W (Write) | Read access | Write access |
  | 2 | U (User) | Supervisor mode | User mode |
  | 3 | R (Reserved) | Reserved clear | Reserved set |
  | 4 | I (Instruction) | Data access | Instruction fetch |
||
{near: bottom-center}