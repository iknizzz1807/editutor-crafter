vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
classes: {
  step: {
    shape: rectangle
    style: {
      fill: "#E8E8E8"
      stroke: "#666666"
      stroke-width: 2
      font-size: 14
    }
  }
  hardware: {
    shape: rectangle
    style: {
      fill: "#B8D4E8"
      stroke: "#2E6B8A"
      stroke-width: 2
      font-size: 14
    }
  }
  decision: {
    shape: diamond
    style: {
      fill: "#FFF2CC"
      stroke: "#D6B656"
      stroke-width: 2
      font-size: 12
    }
  }
  data: {
    shape: cylinder
    style: {
      fill: "#D5E8D4"
      stroke: "#82B366"
      stroke-width: 2
      font-size: 12
    }
  }
  output: {
    shape: parallelogram
    style: {
      fill: "#F8CECC"
      stroke: "#B85450"
      stroke-width: 2
      font-size: 12
    }
  }
  halt: {
    shape: circle
    style: {
      fill: "#333333"
      stroke: "#000000"
      stroke-width: 3
      font-color: white
      font-size: 14
      font: mono
    }
  }
}
title: |md
  # Page Fault Handler Flow
  Exception 14 → CR2 → Error Decode → Page Table Walk → Diagnostics → Halt
| {near: top-center}
direction: down
# Entry point
entry: "Exception 14\n(Page Fault)" {class: hardware}
# Step 1: Read CR2
read_cr2: "Read CR2 Register\n(MOV EAX, CR2)" {class: step}
cr2_value: "CR2 = 0xDEADBEEF\n(Faulting Virtual Address)" {class: data}
# Step 2: Get Error Code
get_error: "Read Error Code\nfrom Stack [ESP+34]" {class: step}
error_code: "Error Code = 0x0007\n(P=1, W=1, U=1)" {class: data}
# Step 3: Decode Error Code
decode: "Decode Error Bits" {class: step}
# Decision: Present bit
check_present: "P Bit?" {class: decision}
present_msg: '"Protection\nViolation"' {class: output}
not_present_msg: '"Page Not\nPresent"' {class: output}
# Decision: Write bit
check_write: "W Bit?" {class: decision}
write_msg: '"Write Access"' {class: output}
read_msg: '"Read Access"' {class: output}
# Decision: User bit
check_user: "U Bit?" {class: decision}
user_msg: '"User Mode"' {class: output}
kernel_msg: '"Kernel Mode"' {class: output}
# Step 4: Page Table Walk
extract_indices: "Extract PD/PT Indices\nPD = (addr >> 22) & 0x3FF\nPT = (addr >> 12) & 0x3FF" {class: step}
read_pde: "Read PDE\npd->entries[pd_index]" {class: step}
pde_value: "PDE = 0x00C01027\n(Present, User, RW)" {class: data}
check_pde_present: "PDE\nPresent?" {class: decision}
pde_missing: '"Page Table\nNot Present"' {class: output}
get_pt_addr: "Get Page Table Address\npt = PDE & 0xFFFFF000" {class: step}
read_pte: "Read PTE\npt->entries[pt_index]" {class: step}
pte_value: "PTE = 0x00000000\n(Not Present)" {class: data}
# Step 5: Print Diagnostics
print_header: |md
  kprintf("\n!!! PAGE FAULT !!!\n")
| {class: output}
print_cr2: |md
  kprintf("CR2: 0x%08x\n", cr2)
| {class: output}
print_error: |md
  kprintf("Error: %s, %s, %s\n", cause, access, mode)
| {class: output}
print_pde: |md
  kprintf("PDE[%d]: 0x%08x\n", pd_idx, pde)
| {class: output}
print_pte: |md
  kprintf("PTE[%d]: 0x%08x\n", pt_idx, pte)
| {class: output}
print_regs: |md
  kprintf("EIP: 0x%08x  CS: 0x%04x\n", regs->eip, regs->cs)
  kprintf("EAX: 0x%08x  EBX: 0x%08x\n", regs->eax, regs->ebx)
| {class: output}
# Step 6: Halt
halt: "CLI; HLT\n(System Halted)" {class: halt}
# Connections
entry -> read_cr2
read_cr2 -> cr2_value
cr2_value -> get_error
get_error -> error_code
error_code -> decode
decode -> check_present
check_present -> present_msg: "P=1"
check_present -> not_present_msg: "P=0"
present_msg -> check_write
not_present_msg -> check_write
check_write -> write_msg: "W=1"
check_write -> read_msg: "W=0"
write_msg -> check_user
read_msg -> check_user
check_user -> user_msg: "U=1"
check_user -> kernel_msg: "U=0"
user_msg -> extract_indices
kernel_msg -> extract_indices
extract_indices -> read_pde
read_pde -> pde_value
pde_value -> check_pde_present
check_pde_present -> pde_missing: "No"
check_pde_present -> get_pt_addr: "Yes"
pde_missing -> print_header
get_pt_addr -> read_pte
read_pte -> pte_value
pte_value -> print_header
print_header -> print_cr2
print_cr2 -> print_error
print_error -> print_pde
print_pde -> print_pte
print_pte -> print_regs
print_regs -> halt
# Error code bit layout annotation
error_layout: |md
  **Error Code Bit Layout:**
  
  Bit 0 (P): 0 = Page not present
             1 = Protection violation
  Bit 1 (W): 0 = Read access
             1 = Write access  
  Bit 2 (U): 0 = Supervisor mode
             1 = User mode
  Bit 3 (R): Reserved bit set
  Bit 4 (I): Instruction fetch
  
| {near: bottom-left}