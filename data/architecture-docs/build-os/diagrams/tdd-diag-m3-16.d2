vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#7B2D8E"
    data: "#2563EB"
    free: "#16A34A"
    pointer: "#EA580C"
    reserved: "#DC2626"
    text: "#1F2937"
    border: "#6B7280"
    heap_virtual: "#F59E0B"
    heap_physical: "#8B5CF6"
  }
}
title: |md
  # Kernel Heap Virtual Address Range
  ### 0xD0000000 - 0xE0000000 (256 MB)
  On-Demand Page Mapping Architecture
| {near: top-center}
direction: right
# Virtual Address Space
virtual_space: {
  label: "Virtual Address Space"
  style.fill: "#F3F4F6"
  style.stroke: "${colors.border}"
  # High addresses
  kernel_high: {
    label: "0xFFFFFFFF\n─────────────\nKernel Space\n(1 GB)"
    shape: rectangle
    style.fill: "${colors.header}"
    style.font-color: white
    width: 180
    height: 80
  }
  # Heap region - highlighted
  heap_region: {
    label: "0xE0000000\n─────────────\n\n0xD0000000\nHEAP_START\n\n─────────────\n\nHeap Virtual Range\n256 MB (0x10000000)"
    shape: rectangle
    style.fill: "${colors.heap_virtual}"
    style.stroke: "${colors.border}"
    style.stroke-width: 3
    width: 180
    height: 200
  }
  # User space
  user_space: {
    label: "0xC0000000\n─────────────\nUser Space\n(3 GB)\n─────────────\n0x00000000"
    shape: rectangle
    style.fill: "${colors.data}"
    style.font-color: white
    width: 180
    height: 120
  }
}
# Page Table Mapping
page_tables: {
  label: "Page Table Layer"
  style.fill: "#F9FAFB"
  style.stroke: "${colors.border}"
  pd_entry: {
    label: "Page Directory\nEntry 832\n(0xD0000000 / 4MB)"
    shape: rectangle
    style.fill: "${colors.header}"
    style.font-color: white
    width: 140
    height: 60
  }
  pt: {
    label: "Page Tables\n(On-Demand)"
    shape: rectangle
    style.fill: "${colors.data}"
    style.font-color: white
    width: 140
    height: 60
  }
  mapping_note: |md
    **Mapping Strategy:**
    - Pages mapped on kmalloc()
    - Not pre-allocated
    - frame_alloc() per page
    - PTE_PRESENT | PTE_WRITABLE
  |
  pd_entry -> pt: "points to"
}
# Physical Memory
physical_memory: {
  label: "Physical Memory (Frames)"
  style.fill: "#F3F4F6"
  style.stroke: "${colors.border}"
  frame_allocator: {
    label: "Frame Allocator\n(Bitmap)"
    shape: rectangle
    style.fill: "${colors.free}"
    style.font-color: white
    width: 140
    height: 50
  }
  allocated_frames: {
    label: "Allocated Frames\n(4 KB each)"
    shape: rectangle
    style.fill: "${colors.heap_physical}"
    style.font-color: white
    width: 140
    height: 80
  }
  free_frames: {
    label: "Free Frames\n(Available Pool)"
    shape: rectangle
    style.fill: "${colors.free}"
    width: 140
    height: 60
  }
  frame_allocator -> allocated_frames: "allocates"
  allocated_frames -> free_frames: "returns on\nheap expansion"
}
# Heap Data Structure
heap_structure: {
  label: "Heap Block Structure"
  style.fill: "#F9FAFB"
  style.stroke: "${colors.border}"
  block_header: {
    shape: sql_table
    size: uint32_t
    free_flag: uint8_t
    magic: uint8_t
    reserved: "uint8_t[2]"
    next_ptr: "struct heap_block*"
    prev_ptr: "struct heap_block*"
  }
  user_data: {
    label: "User Data\n(kmalloc returned ptr)"
    shape: rectangle
    style.fill: "${colors.data}"
    style.font-color: white
    width: 140
    height: 50
  }
  block_header -> user_data: "precedes"
}
# On-Demand Mapping Flow
mapping_flow: {
  label: "On-Demand Page Mapping Flow"
  style.fill: "#FEF3C7"
  style.stroke: "${colors.border}"
  step1: {
    label: "1. kmalloc(size)"
    shape: rectangle
    style.fill: "${colors.heap_virtual}"
    width: 120
  }
  step2: {
    label: "2. No free block?\nExpand heap"
    shape: diamond
    style.fill: "${colors.data}"
    style.font-color: white
  }
  step3: {
    label: "3. frame_alloc()\nGet 4KB frame"
    shape: rectangle
    style.fill: "${colors.free}"
    width: 120
  }
  step4: {
    label: "4. paging_map_page()\nheap_end_virtual\n→ physical frame"
    shape: rectangle
    style.fill: "${colors.heap_physical}"
    style.font-color: white
    width: 140
  }
  step5: {
    label: "5. heap_end_virtual\n+= PAGE_SIZE"
    shape: rectangle
    style.fill: "${colors.header}"
    style.font-color: white
    width: 120
  }
  step1 -> step2
  step2 -> step3: "yes"
  step3 -> step4
  step4 -> step5
}
# Connections
virtual_space.heap_region -> page_tables.pd_entry: "virtual\naddress" {
  style.stroke: "${colors.heap_virtual}"
  style.stroke-width: 2
}
page_tables.pt -> physical_memory.allocated_frames: "maps to\nphysical" {
  style.stroke: "${colors.heap_physical}"
  style.stroke-width: 2
  style.stroke-dash: 3
}
# Constants box
constants: {
  label: "Constants"
  shape: rectangle
  style.fill: "#F3F4F6"
  style.stroke: "${colors.border}"
  code: |md
    c
    #define HEAP_START    0xD0000000
    #define HEAP_SIZE     0x10000000  // 256 MB
    #define PAGE_SIZE     4096
    #define HEAP_MAGIC    0xAB
    
  |
}
# Legend
legend: {
  label: "Legend"
  shape: rectangle
  style.fill: "#F9FAFB"
  style.stroke: "${colors.border}"
  leg_heap: {
    label: "Heap Virtual"
    shape: rectangle
    style.fill: "${colors.heap_virtual}"
    width: 80
  }
  leg_phys: {
    label: "Physical Frame"
    shape: rectangle
    style.fill: "${colors.heap_physical}"
    width: 80
  }
  leg_free: {
    label: "Free/Available"
    shape: rectangle
    style.fill: "${colors.free}"
    width: 80
  }
}