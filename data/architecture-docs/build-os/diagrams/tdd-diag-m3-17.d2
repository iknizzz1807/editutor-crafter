vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Higher-Half Linker Script Layout
  Kernel at 0xC0000000 virtual, loaded at 0x100000 physical
|
direction: right
classes: {
  header_section: {
    style: {
      fill: "#9B59B6"
      font-color: white
      bold: true
    }
  }
  text_section: {
    style: {
      fill: "#3498DB"
      font-color: white
      bold: true
    }
  }
  rodata_section: {
    style: {
      fill: "#1ABC9C"
      font-color: white
    }
  }
  data_section: {
    style: {
      fill: "#E67E22"
      font-color: white
    }
  }
  bss_section: {
    style: {
      fill: "#27AE60"
      font-color: white
    }
  }
  padding: {
    style: {
      fill: "#95A5A6"
      font-color: white
    }
  }
}
physical_memory: Physical Memory {
  style.fill: white
  style.stroke: "#34495E"
  style.stroke-width: 2
  bios_area: 0x00000-0xFFFFF {
    style.fill: "#E74C3C"
    style.font-color: white
  }
  kernel_physical: 0x100000 (1MB) {
    style.fill: "#ECF0F1"
    style.stroke: "#34495E"
    style.stroke-dash: 3
    phys_multiboot: .multiboot {
      class: header_section
      width: 180
    }
    phys_text: .text {
      class: text_section
      width: 180
    }
    phys_rodata: .rodata {
      class: rodata_section
      width: 180
    }
    phys_data: .data {
      class: data_section
      width: 180
    }
    phys_bss: .bss {
      class: bss_section
      width: 180
    }
  }
}
virtual_memory: Virtual Address Space {
  style.fill: white
  style.stroke: "#34495E"
  style.stroke-width: 2
  user_space: 0x00000000 - 0xBFFFFFFF {
    style.fill: "#FAFAFA"
    label: "User Space\n(3 GB)"
  }
  kernel_virtual: 0xC0000000 (3 GB) {
    style.fill: "#ECF0F1"
    style.stroke: "#8E44AD"
    style.stroke-width: 3
    virt_offset: VIRTUAL_BASE = 0xC0000000 {
      style.fill: "#8E44AD"
      style.font-color: white
      shape: diamond
    }
    virt_multiboot: .multiboot {
      class: header_section
      width: 180
    }
    virt_text: .text {
      class: text_section
      width: 180
    }
    virt_rodata: .rodata {
      class: rodata_section
      width: 180
    }
    virt_data: .data {
      class: data_section
      width: 180
    }
    virt_bss: .bss {
      class: bss_section
      width: 180
    }
    kernel_end: _kernel_end {
      style.fill: "#2C3E50"
      style.font-color: white
    }
  }
}
linker_script: Linker Script {
  style.fill: "#2C3E50"
  style.font-color: white
  width: 350
  vars_block: Variables {
    style.fill: "#34495E"
    kernel_vb: KERNEL_VIRTUAL_BASE = 0xC0000000
    kernel_pb: KERNEL_PHYSICAL_BASE = 0x100000
  }
  entry_point: ENTRY(kernel_entry) {
    style.fill: "#16A085"
  }
  sections_block: SECTIONS {
    style.fill: "#34495E"
    dot_assign: ". = KERNEL_PHYSICAL_BASE" {
      style.fill: "#7F8C8D"
      style.font: mono
      style.font-size: 12
    }
    multiboot_section: ".multiboot ALIGN(4K)" {
      style.fill: "#9B59B6"
      style.font: mono
      style.font-size: 11
    }
    offset_add: ". += KERNEL_VIRTUAL_BASE" {
      style.fill: "#E74C3C"
      style.font: mono
      style.font-size: 12
      style.bold: true
    }
    text_section_block: ".text ALIGN(4K) : AT(ADDR(.text) - VIRTUAL_BASE)" {
      style.fill: "#3498DB"
      style.font: mono
      style.font-size: 10
    }
    rodata_section_block: ".rodata ALIGN(4K) : AT(ADDR(.rodata) - VIRTUAL_BASE)" {
      style.fill: "#1ABC9C"
      style.font: mono
      style.font-size: 10
    }
    data_section_block: ".data ALIGN(4K) : AT(ADDR(.data) - VIRTUAL_BASE)" {
      style.fill: "#E67E22"
      style.font: mono
      style.font-size: 10
    }
    bss_section_block: ".bss ALIGN(4K) : AT(ADDR(.bss) - VIRTUAL_BASE)" {
      style.fill: "#27AE60"
      style.font: mono
      style.font-size: 10
    }
  }
}
at_mechanism: AT() Mechanism {
  style.fill: "#1A1A2E"
  style.font-color: white
  width: 300
  explanation: |md
    **AT(ADDR(.text) - VIRTUAL_BASE)**
    - `ADDR(.text)` = virtual address of section
    - Subtract `VIRTUAL_BASE` to get physical
    - Result = load address in binary
    Example:
    - Virtual: 0xC0100000
    - Physical: 0x00100000
  |
}
physical_memory.kernel_physical.phys_multiboot -> virtual_memory.kernel_virtual.virt_multiboot: identity {
  style.stroke: "#9B59B6"
  style.stroke-dash: 5
}
physical_memory.kernel_physical.phys_text -> virtual_memory.kernel_virtual.virt_text: maps to {
  style.stroke: "#3498DB"
  style.stroke-width: 2
}
physical_memory.kernel_physical.phys_rodata -> virtual_memory.kernel_virtual.virt_rodata: maps to {
  style.stroke: "#1ABC9C"
  style.stroke-width: 2
}
physical_memory.kernel_physical.phys_data -> virtual_memory.kernel_virtual.virt_data: maps to {
  style.stroke: "#E67E22"
  style.stroke-width: 2
}
physical_memory.kernel_physical.phys_bss -> virtual_memory.kernel_virtual.virt_bss: maps to {
  style.stroke: "#27AE60"
  style.stroke-width: 2
}
linker_script.sections_block.offset_add -> virtual_memory.kernel_virtual.virt_offset: applies {
  style.stroke: "#E74C3C"
  style.stroke-dash: 3
  style.animated: true
}
at_mechanism -> linker_script.sections_block.text_section_block: enables {
  style.stroke: "#F39C12"
}
legend: |md
  **Color Legend:**
  ğŸŸ£ Header (.multiboot) - Must stay at physical address
  ğŸ”µ Code (.text) - Executable instructions
  ğŸŸ¢ Read-only data (.rodata) - Constants
  ğŸŸ  Data (.data) - Initialized globals
  ğŸŸ¢ BSS (.bss) - Uninitialized data (zeroed)
  **Key Insight:** `AT()` tells linker where to place
  section in the binary file, while virtual address
  is what code sees at runtime.
| {
  near: bottom-center
  style.fill: "#F8F9FA"
  style.stroke: "#DEE2E6"
}