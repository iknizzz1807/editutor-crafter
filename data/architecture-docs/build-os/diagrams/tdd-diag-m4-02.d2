vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # cpu_state: Complete Register Save Structure
  Interrupt Stack Frame (76 bytes total)
| {near: top-center}
direction: right
stack_frame: {
  label: "cpu_state Structure\n(76 bytes)"
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a6a"
  style.stroke-width: 2
  seg_group: "Segment Registers (16 bytes)" {
    style.fill: "#9b59b6"
    style.stroke: "#8e44ad"
    style.font-color: white
    gs: "gs\n0x00"
    fs: "fs\n0x04"
    es: "es\n0x08"
    ds: "ds\n0x0C"
  }
  gp_group: "General Purpose (32 bytes)" {
    style.fill: "#3498db"
    style.stroke: "#2980b9"
    style.font-color: white
    edi: "edi\n0x10"
    esi: "esi\n0x14"
    ebp: "ebp\n0x18"
    esp: "esp\n0x1C"
    ebx: "ebx\n0x20"
    edx: "edx\n0x24"
    ecx: "ecx\n0x28"
    eax: "eax\n0x2C"
  }
  meta_group: "Interrupt Metadata (8 bytes)" {
    style.fill: "#e67e22"
    style.stroke: "#d35400"
    style.font-color: white
    int_no: "int_no\n0x30"
    err_code: "err_code\n0x34"
  }
  cpu_group: "CPU-Pushed State (12 bytes)" {
    style.fill: "#e74c3c"
    style.stroke: "#c0392b"
    style.font-color: white
    eip: "eip\n0x38"
    cs: "cs\n0x3C"
    eflags: "eflags\n0x40"
  }
  user_group: "User Stack (8 bytes)\nPrivilege Change Only" {
    style.fill: "#27ae60"
    style.stroke: "#1e8449"
    style.font-color: white
    useresp: "useresp\n0x44"
    ss: "ss\n0x48"
  }
  seg_group -> gp_group -> meta_group -> cpu_group -> user_group
}
legend: {
  near: top-right
  header: |md
    ### Legend
  |
  legend_seg: "Segment Registers" {
    style.fill: "#9b59b6"
    shape: square
  }
  legend_gp: "General Purpose" {
    style.fill: "#3498db"
    shape: square
  }
  legend_meta: "Interrupt Metadata" {
    style.fill: "#e67e22"
    shape: square
  }
  legend_cpu: "CPU-Pushed" {
    style.fill: "#e74c3c"
    shape: square
  }
  legend_user: "User Stack (Ring 3→0)" {
    style.fill: "#27ae60"
    shape: square
  }
}
note: |md
  **Push Order:**
  1. CPU pushes: SS, ESP, EFLAGS, CS, EIP
     (SS/ESP only on privilege change)
  2. Stub pushes: err_code, int_no
  3. pusha pushes: EDI, ESI, EBP, ESP, EBX, EDX, ECX, EAX
  4. Stub pushes: GS, FS, ES, DS
| {near: bottom-right}
annotations: |md
  **Critical Offsets:**
  - `eip` at offset 0x38 → Return address
  - `cs` at offset 0x3C → Code segment selector
  - `eflags` at offset 0x40 → CPU flags (IF, etc.)
  - `useresp` at offset 0x44 → User stack (if ring change)
  - `ss` at offset 0x48 → User stack segment (if ring change)
  **iret Restoration Order:** eip → cs → eflags → [useresp → ss]
| {near: bottom-center}