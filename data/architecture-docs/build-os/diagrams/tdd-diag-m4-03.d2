vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Context Switch: Complete Flow
  Timer Interrupt → State Save → Scheduler → TSS Update → CR3 Switch → State Load → iret
| {near: top-center}
shape: sequence_diagram
Timer_HW
Timer_ISR
Scheduler
TSS_Manager
MMU
Old_Process
New_Process
# Step 1: Timer Hardware Interrupt
Timer_HW -> Timer_ISR: IRQ0 fires (100 Hz tick) {
  style.stroke: red
  style.stroke-width: 2
}
# Step 2: ISR Entry - CPU pushes state
Timer_ISR.1 -> Timer_ISR.1: CPU pushes:\nEFLAGS, CS, EIP\n(if user mode: SS, ESP too) {
  style.fill: "#ffcccc"
  style.stroke: red
  style.bold: true
}
# Step 3: Assembly stub saves registers
Timer_ISR.1 -> Timer_ISR.1: Assembly stub:\npusha (8 regs)\npush DS, ES, FS, GS {
  style.fill: "#ffcccc"
  style.stroke: red
  style.bold: true
}
# Step 4: Call scheduler
Timer_ISR.1 -> Scheduler: scheduler_tick(regs) {
  style.stroke: blue
}
# Step 5: Time slice check
Scheduler.1 -> Scheduler.1: Decrement time_slice\nif == 0: trigger switch {
  style.fill: "#cce5ff"
  style.stroke: blue
}
# Step 6: Pick next process
Scheduler.1 -> Scheduler.1: scheduler_pick_next()\nRound-robin dequeue {
  style.fill: "#cce5ff"
  style.stroke: blue
}
# Step 7: Save old process state
Scheduler.1 -> Old_Process: current->kernel_stack = regs {
  style.stroke: orange
  style.stroke-dash: 3
}
Old_Process.1 -> Old_Process.1: State saved to PCB\n(cpu_state struct) {
  style.fill: "#ffe6cc"
  style.stroke: orange
}
# Step 8: Update TSS (CRITICAL!)
Scheduler.1 -> TSS_Manager: tss_set_kernel_stack(\n  next->kernel_stack_top) {
  style.stroke: "#990000"
  style.stroke-width: 3
  style.bold: true
}
TSS_Manager.1 -> TSS_Manager.1: kernel_tss.esp0 = esp0\n(For ring3→ring0 transitions) {
  style.fill: "#ff9999"
  style.stroke: "#990000"
  style.bold: true
}
# Step 9: Switch page directory if different
Scheduler.1 -> MMU: if (new_pd != old_pd):\n  mov cr3, new_pd {
  style.stroke: purple
}
MMU.1 -> MMU.1: CR3 loaded\nTLB flushed {
  style.fill: "#e6ccff"
  style.stroke: purple
}
# Step 10: Update current_process pointer
Scheduler.1 -> New_Process: current_process = next {
  style.stroke: green
}
# Step 11: Assembly context switch
Timer_ISR.2 -> Timer_ISR.2: switch_to()\nmov esp, new->kernel_stack {
  style.fill: "#ccffcc"
  style.stroke: green
  style.bold: true
}
# Step 12: Restore new process state
Timer_ISR.2 -> New_Process: Stack now has\nsaved cpu_state {
  style.stroke: green
}
New_Process.2 -> New_Process.2: pop GS, FS, ES, DS\npopa (8 regs)\nadd esp, 8 {
  style.fill: "#ccffcc"
  style.stroke: green
  style.bold: true
}
# Step 13: Return from interrupt
Timer_ISR.2 -> Timer_HW: iret {
  style.stroke: "#006600"
  style.stroke-width: 3
  style.bold: true
}
Timer_HW.2 -> Timer_HW.2: iret restores:\nEIP, CS, EFLAGS\n(if ring change: ESP, SS)\n→ Resume new process {
  style.fill: "#99ff99"
  style.stroke: "#006600"
  style.bold: true
}
# Annotations
Timer_ISR.1: |md
  **ISR Entry**
  - CLI (interrupts disabled)
  - Save all registers
|
Timer_ISR.2: |md
  **ISR Exit**
  - Restore all registers
  - iret to new process
|
Scheduler.1: |md
  **Scheduler**
  - Pick next READY process
  - Update TSS (CRITICAL!)
  - Switch CR3 if needed
|
TSS_Manager.1: |md
  **TSS Update**
  ⚠️ MUST happen before
  any possible return
  to user mode!
|
MMU.1: |md
  **CR3 Switch**
  - New page directory
  - TLB invalidation
  - ~100-500 cycle penalty
|
Old_Process.1: |md
  **Old Process**
  State: RUNNING → READY
  Saved to kernel_stack
|
New_Process.2: |md
  **New Process**
  State: READY → RUNNING
  Registers restored
|
Timer_HW.2: |md
  **Execution Resumes**
  New process runs as if
  nothing happened!
|
# Legend
legend: {
  near: bottom-right
  shape: rectangle
  style.fill: white
  style.stroke: black
  red_step: "Red = State Save" {
    shape: text
    style.font-color: red
  }
  blue_step: "Blue = Scheduling" {
    shape: text
    style.font-color: blue
  }
  orange_step: "Orange = Old Process" {
    shape: text
    style.font-color: orange
  }
  purple_step: "Purple = Memory Switch" {
    shape: text
    style.font-color: purple
  }
  green_step: "Green = State Restore" {
    shape: text
    style.font-color: "#006600"
  }
  critical: "⚠️ Bold Red = CRITICAL" {
    shape: text
    style.font-color: "#990000"
    style.bold: true
  }
}