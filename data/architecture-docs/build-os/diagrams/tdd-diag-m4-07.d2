vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right
title: |md
  # Process State Machine
  Process lifecycle transitions in the scheduler
| {near: top-center}
classes: {
  normal_state: {
    style: {
      fill: "#E8F4FD"
      stroke: "#2E86AB"
      stroke-width: 2
      font-color: "#1A1A2E"
    }
  }
  initial_state: {
    shape: circle
    style: {
      fill: "#2E86AB"
      stroke: "#1A1A2E"
      stroke-width: 2
    }
  }
  running_state: {
    style: {
      fill: "#C8E6C9"
      stroke: "#388E3C"
      stroke-width: 3
      bold: true
      font-color: "#1B5E20"
    }
  }
  error_state: {
    style: {
      fill: "#FFCDD2"
      stroke: "#D32F2F"
      stroke-width: 2
      font-color: "#B71C1C"
    }
  }
  terminal_state: {
    style: {
      fill: "#F5F5F5"
      stroke: "#757575"
      stroke-width: 2
      stroke-dash: 3
      font-color: "#424242"
    }
  }
  valid_transition: {
    style: {
      stroke: "#388E3C"
      stroke-width: 2
      font-color: "#1B5E20"
    }
  }
  illegal_transition: {
    style: {
      stroke: "#D32F2F"
      stroke-width: 2
      stroke-dash: 5
      font-color: "#B71C1C"
    }
  }
}
# Initial pseudo-state
initial: â— {
  class: initial_state
  label: ""
}
# Process states
unused: UNUSED {
  class: terminal_state
  label: |md
    **UNUSED**
    ---
    PCB slot available
    No process occupying
  |
}
ready: READY {
  class: normal_state
  label: |md
    **READY**
    ---
    Invariant: In run queue
    Waiting for CPU time
    All resources allocated
  |
}
running: RUNNING {
  class: running_state
  label: |md
    **RUNNING**
    ---
    Invariant: current_process
    Actively executing
    Not in run queue
  |
}
blocked: BLOCKED {
  class: normal_state
  label: |md
    **BLOCKED**
    ---
    Invariant: wake_time set
    Waiting for I/O/event
    Not in run queue
  |
}
zombie: ZOMBIE {
  class: error_state
  label: |md
    **ZOMBIE**
    ---
    Invariant: exit_code set
    Terminated, awaiting
    parent wait()
  |
}
# Final pseudo-state
final: â— {
  class: initial_state
  label: ""
  shape: circle
  style: {
    fill: "#757575"
    stroke: "#424242"
  }
}
# Transitions from initial
initial -> unused: process_init() {
  class: valid_transition
  label: |md
    System startup
    Idle process created
  |
}
# Transitions from UNUSED
unused -> ready: process_create_*() {
  class: valid_transition
  label: |md
    **Trigger:** Create new process
    **Guard:** Free PCB slot exists
    **Action:** Allocate PCB, stack
  |
}
# Transitions from READY
ready -> running: scheduler_pick_next() {
  class: valid_transition
  label: |md
    **Trigger:** Context switch
    **Guard:** Process at queue head
    **Action:** Remove from queue
  |
}
ready -> unused: "ILLEGAL" {
  class: illegal_transition
  label: |md
    Cannot skip RUNNING
    Must be scheduled first
  |
}
# Transitions from RUNNING
running -> ready: time_slice_expired {
  class: valid_transition
  label: |md
    **Trigger:** Timer tick
    **Guard:** Time slice = 0
    **Action:** Add to queue tail
  |
}
running -> ready: sys_yield() {
  class: valid_transition
  label: |md
    **Trigger:** Yield syscall
    **Guard:** None
    **Action:** Voluntary switch
  |
}
running -> blocked: I/O_request {
  class: valid_transition
  label: |md
    **Trigger:** Blocking syscall
    **Guard:** Resource unavailable
    **Action:** Set wake_time
  |
}
running -> zombie: sys_exit() {
  class: valid_transition
  label: |md
    **Trigger:** Exit syscall
    **Guard:** None
    **Action:** Store exit_code
  |
}
running -> zombie: exception {
  class: valid_transition
  label: |md
    **Trigger:** Unhandled fault
    **Guard:** No handler
    **Action:** Kill process
  |
}
# Transitions from BLOCKED
blocked -> ready: event_complete {
  class: valid_transition
  label: |md
    **Trigger:** I/O complete
    **Guard:** wake_time reached
    **Action:** Add to queue
  |
}
blocked -> ready: timeout_expired {
  class: valid_transition
  label: |md
    **Trigger:** Timer tick
    **Guard:** ticks >= wake_time
    **Action:** Wake process
  |
}
blocked -> zombie: "ILLEGAL" {
  class: illegal_transition
  label: |md
    Cannot exit while blocked
    Must wake first
  |
}
# Transitions from ZOMBIE
zombie -> unused: parent_wait() {
  class: valid_transition
  label: |md
    **Trigger:** wait() syscall
    **Guard:** Parent reaps child
    **Action:** Free PCB slot
  |
}
zombie -> final: resources_freed {
  class: valid_transition
  label: |md
    Process terminated
    Memory reclaimed
  |
}
# Self-transitions (state invariants)
running -> running: timer_interrupt {
  class: valid_transition
  label: |md
    **Trigger:** Timer tick
    **Guard:** Time slice > 0
    **Action:** Decrement counter
  |
  style.stroke-dash: 3
}
# Legend
legend: {
  near: bottom-right
  label: |md
    ## Transition Types
    ðŸŸ¢ **Valid** - Normal state transitions
    ðŸ”´ **ILLEGAL** - Invalid transitions
    (shown with dashed line)
    ---
    ## Key Invariants
    - **READY**: Always in run queue
    - **RUNNING**: `current_process` points here
    - **BLOCKED**: `wake_time` is set
    - **ZOMBIE**: `exit_code` is set
  |
  shape: rectangle
  style: {
    fill: "#FAFAFA"
    stroke: "#E0E0E0"
    stroke-width: 1
  }
}