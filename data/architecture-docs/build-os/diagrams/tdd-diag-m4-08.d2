vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Timer-Driven Preemption: Timeline
  **Time slices across multiple processes showing timer interrupt points and context switches**
| {near: top-center}
direction: right
# Timeline axis
timeline: {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a6a"
  t0: {
    shape: text
    label: "t=0ms"
    style.font-color: "#8892b0"
  }
  t10: {
    shape: text
    label: "t=10ms"
    style.font-color: "#8892b0"
  }
  t20: {
    shape: text
    label: "t=20ms"
    style.font-color: "#8892b0"
  }
  t30: {
    shape: text
    label: "t=30ms"
    style.font-color: "#8892b0"
  }
  t40: {
    shape: text
    label: "t=40ms"
    style.font-color: "#8892b0"
  }
}
# CPU execution timeline
cpu_timeline: {
  label: "CPU Execution"
  style.fill: "#0d1117"
  style.stroke: "#30363d"
  # Process A time slice
  proc_a_slice1: {
    label: "Process A\nRunning"
    shape: rectangle
    style.fill: "#238636"
    style.stroke: "#2ea043"
    style.font-color: "#ffffff"
    width: 180
    height: 60
  }
  # Context switch marker
  ctx_sw1: {
    label: "CTX\nSWITCH"
    shape: diamond
    style.fill: "#f85149"
    style.stroke: "#da3633"
    style.font-color: "#ffffff"
    width: 60
    height: 60
  }
  # Process B time slice
  proc_b_slice1: {
    label: "Process B\nRunning"
    shape: rectangle
    style.fill: "#1f6feb"
    style.stroke: "#388bfd"
    style.font-color: "#ffffff"
    width: 180
    height: 60
  }
  # Context switch marker
  ctx_sw2: {
    label: "CTX\nSWITCH"
    shape: diamond
    style.fill: "#f85149"
    style.stroke: "#da3633"
    style.font-color: "#ffffff"
    width: 60
    height: 60
  }
  # Process C time slice
  proc_c_slice1: {
    label: "Process C\nRunning"
    shape: rectangle
    style.fill: "#8957e5"
    style.stroke: "#a371f7"
    style.font-color: "#ffffff"
    width: 180
    height: 60
  }
  # Context switch marker
  ctx_sw3: {
    label: "CTX\nSWITCH"
    shape: diamond
    style.fill: "#f85149"
    style.stroke: "#da3633"
    style.font-color: "#ffffff"
    width: 60
    height: 60
  }
  # Process A time slice 2
  proc_a_slice2: {
    label: "Process A\nRunning"
    shape: rectangle
    style.fill: "#238636"
    style.stroke: "#2ea043"
    style.font-color: "#ffffff"
    width: 180
    height: 60
  }
  proc_a_slice1 -> ctx_sw1 -> proc_b_slice1 -> ctx_sw2 -> proc_c_slice1 -> ctx_sw3 -> proc_a_slice2: {
    style.stroke: "#30363d"
    style.stroke-width: 2
  }
}
# Timer interrupt events
timer_events: {
  label: "Timer Interrupts (IRQ0 @ 100Hz)"
  style.fill: "#161b22"
  style.stroke: "#30363d"
  irq1: {
    label: "IRQ0\nTick #10"
    shape: circle
    style.fill: "#f0883e"
    style.stroke: "#d29922"
    style.font-color: "#000000"
  }
  irq2: {
    label: "IRQ0\nTick #20"
    shape: circle
    style.fill: "#f0883e"
    style.stroke: "#d29922"
    style.font-color: "#000000"
  }
  irq3: {
    label: "IRQ0\nTick #30"
    shape: circle
    style.fill: "#f0883e"
    style.stroke: "#d29922"
    style.font-color: "#000000"
  }
  irq4: {
    label: "IRQ0\nTick #40"
    shape: circle
    style.fill: "#f0883e"
    style.stroke: "#d29922"
    style.font-color: "#000000"
  }
  irq1 -> irq2 -> irq3 -> irq4: {
    style.stroke: "#f0883e"
    style.stroke-dash: 3
    style.stroke-width: 2
  }
}
# Connect timer events to context switches
irq1 -> cpu_timeline.ctx_sw1: {
  style.stroke: "#f0883e"
  style.stroke-dash: 5
  label: "triggers\nschedule"
  style.font-color: "#f0883e"
}
irq2 -> cpu_timeline.ctx_sw2: {
  style.stroke: "#f0883e"
  style.stroke-dash: 5
  label: "triggers\nschedule"
  style.font-color: "#f0883e"
}
irq3 -> cpu_timeline.ctx_sw3: {
  style.stroke: "#f0883e"
  style.stroke-dash: 5
  label: "triggers\nschedule"
  style.font-color: "#f0883e"
}
# Process states
process_states: {
  label: "Process States"
  style.fill: "#0d1117"
  style.stroke: "#30363d"
  ready_queue: {
    label: "Ready Queue"
    shape: rectangle
    style.fill: "#21262d"
    style.stroke: "#30363d"
    state_legend: |md
      **State Transitions:**
      - RUNNING → READY (on time slice expiry)
      - READY → RUNNING (when scheduled)
      - RUNNING → BLOCKED (on I/O)
      - BLOCKED → READY (on I/O complete)
    |
  }
  running_state: {
    label: "Running\n(current_process)"
    shape: rectangle
    style.fill: "#238636"
    style.stroke: "#2ea043"
    style.font-color: "#ffffff"
  }
  ready_queue -> running_state: {
    label: "schedule"
    style.stroke: "#2ea043"
  }
  running_state -> ready_queue: {
    label: "preempt"
    style.stroke: "#f85149"
    style.stroke-dash: 3
  }
}
# Context switch detail
ctx_switch_detail: {
  label: "Context Switch Detail"
  style.fill: "#161b22"
  style.stroke: "#30363d"
  detail: |md
    **Context Switch Steps:**
    1. Timer interrupt fires (IRQ0)
    2. CPU pushes state to stack
    3. ISR stub saves all registers
    4. `scheduler_tick()` decrements counter
    5. Counter=0 → `scheduler_schedule()`
    6. Save ESP to `current->kernel_stack`
    7. Update TSS.ESP0 to `next->kernel_stack_top`
    8. Switch page directory if different
    9. `switch_to()` changes kernel stack
    10. `iret` restores next process state
  |
}
# Performance metrics
metrics: {
  label: "Timing Metrics"
  style.fill: "#161b22"
  style.stroke: "#30363d"
  timing: |md
    **Preemption Timing:**
    - Timer frequency: 100 Hz (10ms period)
    - Time slice: 100ms (10 timer ticks)
    - Context switch overhead: ~1000-2000 cycles
    - At 2 GHz: ~0.5-1 μs per switch
    - Overhead: ~0.01% of CPU time
  |
}
# Legend
legend: {
  label: "Legend"
  style.fill: "#0d1117"
  style.stroke: "#30363d"
  proc_a_leg: {
    label: "Process A"
    shape: rectangle
    style.fill: "#238636"
    width: 40
    height: 20
  }
  proc_b_leg: {
    label: "Process B"
    shape: rectangle
    style.fill: "#1f6feb"
    width: 40
    height: 20
  }
  proc_c_leg: {
    label: "Process C"
    shape: rectangle
    style.fill: "#8957e5"
    width: 40
    height: 20
  }
  timer_leg: {
    label: "Timer IRQ"
    shape: circle
    style.fill: "#f0883e"
    width: 20
    height: 20
  }
  ctx_leg: {
    label: "Context Switch"
    shape: diamond
    style.fill: "#f85149"
    width: 25
    height: 25
  }
}
# Annotations
annotation1: |md
  **Round-Robin Scheduling:**
  Each process gets equal time slice,
  then moves to back of ready queue.
| {near: center-left}
annotation2: |md
  **Preemption Point:**
  Timer interrupt forces switch
  regardless of process state.
| {near: center-right}