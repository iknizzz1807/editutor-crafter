vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Initial Process Stack Frame
  Stack top with cpu_state pre-populated for first context switch return
| {near: top-center}
direction: right
stack_frame: {
  label: "Kernel Stack (4KB allocated via frame_alloc)"
  style.fill: "#E8F5E9"
  style.stroke: "#2E7D32"
  unused: "Unused stack space\n(grows down from top)" {
    style.fill: "#F5F5F5"
    style.stroke-dash: 3
  }
  cpu_state_region: "cpu_state Structure (76 bytes)" {
    style.fill: "#E3F2FD"
    style.stroke: "#1565C0"
    gs: "gs: 0x10" {
      style.fill: "#BBDEFB"
    }
    fs: "fs: 0x10" {
      style.fill: "#BBDEFB"
    }
    es: "es: 0x10" {
      style.fill: "#BBDEFB"
    }
    ds: "ds: 0x10" {
      style.fill: "#BBDEFB"
    }
    edi: "edi: 0x00000000" {
      style.fill: "#C8E6C9"
    }
    esi: "esi: 0x00000000" {
      style.fill: "#C8E6C9"
    }
    ebp: "ebp: 0x00000000" {
      style.fill: "#C8E6C9"
    }
    esp: "esp: kernel_stack_top" {
      style.fill: "#C8E6C9"
    }
    ebx: "ebx: 0x00000000" {
      style.fill: "#C8E6C9"
    }
    edx: "edx: 0x00000000" {
      style.fill: "#C8E6C9"
    }
    ecx: "ecx: 0x00000000" {
      style.fill: "#C8E6C9"
    }
    eax: "eax: 0x00000000" {
      style.fill: "#C8E6C9"
    }
    int_no: "int_no: 0x00000000" {
      style.fill: "#FFF9C4"
    }
    err_code: "err_code: 0x00000000" {
      style.fill: "#FFF9C4"
    }
    eip: "eip: entry_point" {
      style.fill: "#FFCDD2"
      style.bold: true
    }
    cs: "cs: 0x08 (kernel) / 0x1B (user)" {
      style.fill: "#FFCDD2"
    }
    eflags: "eflags: 0x00000202 (IF=1)" {
      style.fill: "#FFCDD2"
    }
    useresp: "useresp: USER_STACK_TOP" {
      style.fill: "#D1C4E9"
    }
    ss: "ss: 0x10 (kernel) / 0x23 (user)" {
      style.fill: "#D1C4E9"
    }
  }
  unused -> cpu_state_region: "kernel_stack points here"
}
pcb: "Process Control Block" {
  style.fill: "#FFF3E0"
  style.stroke: "#E65100"
  kernel_stack_field: "kernel_stack: pointer to cpu_state" {
    style.fill: "#FFE0B2"
  }
  kernel_stack_top_field: "kernel_stack_top: frame_addr + 4096" {
    style.fill: "#FFE0B2"
  }
}
pcb.kernel_stack_field -> stack_frame.cpu_state_region: "points to" {
  style.stroke: "#E65100"
  style.stroke-dash: 3
}
offsets: {
  label: ""
  style.fill: transparent
  style.stroke: transparent
  offset_00: "+0x00: gs"
  offset_04: "+0x04: fs"
  offset_08: "+0x08: es"
  offset_0c: "+0x0C: ds"
  offset_10: "+0x10: edi"
  offset_14: "+0x14: esi"
  offset_18: "+0x18: ebp"
  offset_1c: "+0x1C: esp"
  offset_20: "+0x20: ebx"
  offset_24: "+0x24: edx"
  offset_28: "+0x28: ecx"
  offset_2c: "+0x2C: eax"
  offset_30: "+0x30: int_no"
  offset_34: "+0x34: err_code"
  offset_38: "+0x38: eip ← CRITICAL"
  offset_3c: "+0x3C: cs"
  offset_40: "+0x40: eflags"
  offset_44: "+0x44: useresp (user mode only)"
  offset_48: "+0x48: ss (user mode only)"
  offset_00 -> offset_04 -> offset_08 -> offset_0c -> offset_10 -> offset_14 -> offset_18 -> offset_1c -> offset_20 -> offset_24 -> offset_28 -> offset_2c -> offset_30 -> offset_34 -> offset_38 -> offset_3c -> offset_40 -> offset_44 -> offset_48 {
    style.opacity: 0
  }
}
legend: {
  style.fill: "#FAFAFA"
  style.stroke: "#9E9E9E"
  seg_label: "Segment Registers" {
    style.fill: "#BBDEFB"
  }
  gen_label: "General Purpose" {
    style.fill: "#C8E6C9"
  }
  meta_label: "Interrupt Metadata" {
    style.fill: "#FFF9C4"
  }
  ret_label: "Return State (CPU-pushed)" {
    style.fill: "#FFCDD2"
  }
  priv_label: "Privilege Change Only" {
    style.fill: "#D1C4E9"
  }
  seg_label -> gen_label -> meta_label -> ret_label -> priv_label {
    style.opacity: 0
  }
}
note: |md
  **First Context Switch Return:**
  1. `iret` pops eip, cs, eflags from stack
  2. If CS.RPL ≠ CPL: also pops useresp, ss
  3. CPU begins executing at entry_point
  **Kernel Process:** CS=0x08, SS=0x10
  **User Process:** CS=0x1B, SS=0x23 (RPL=3)
| {near: bottom-center}