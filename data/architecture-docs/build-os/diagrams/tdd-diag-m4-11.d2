vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#7C3AED"
    data: "#3B82F6"
    free: "#22C55E"
    padding: "#9CA3AF"
    pointer: "#F97316"
    kernel: "#DC2626"
    code: "#8B5CF6"
    heap: "#10B981"
    stack: "#F59E0B"
    guard: "#6B7280"
  }
}
title: |md
  # User-Mode Process Memory Layout
| {
  near: top-center
}
direction: right
user_space: "User Address Space (0x00000000 - 0xBFFFFFFF)" {
  style.fill: "#1E293B"
  style.stroke: "#475569"
  style.font-color: "#E2E8F0"
  null_guard: "NULL Guard\n(0x00000000 - 0x00000FFF)\nUnmapped" {
    style.fill: "${colors.guard}"
    style.font-color: "#F8FAFC"
    style.stroke: "#4B5563"
    width: 180
    height: 80
  }
  code_segment: "Code Segment\n(0x08048000+)\n.text .rodata .data .bss" {
    style.fill: "${colors.code}"
    style.font-color: "#F8FAFC"
    style.stroke: "#7C3AED"
    width: 180
    height: 120
  }
  heap_region: "User Heap\n(0x40000000 - 0x7FFFFFFF)\nGrows upward" {
    style.fill: "${colors.heap}"
    style.font-color: "#F8FAFC"
    style.stroke: "#059669"
    width: 180
    height: 100
  }
  stack_region: "User Stack\n(0xB0000000 - 0xBFFFFFFF)\nGrows downward" {
    style.fill: "${colors.stack}"
    style.font-color: "#F8FAFC"
    style.stroke: "#D97706"
    width: 180
    height: 100
  }
}
kernel_space: "Kernel Space (0xC0000000 - 0xFFFFFFFF)" {
  style.fill: "#7F1D1D"
  style.stroke: "#B91C1C"
  style.font-color: "#FCA5A5"
  kernel_mapping: "Kernel Mapped\n(Supervisor-Only)\n\nPage Directory Entries\n768-1023 copied from\nkernel_page_directory" {
    style.fill: "${colors.kernel}"
    style.font-color: "#F8FAFC"
    style.stroke: "#991B1B"
    width: 200
    height: 140
  }
}
null_guard -> code_segment: "128 MB gap" {
  style.stroke-dash: 3
  style.stroke: "#64748B"
}
code_segment -> heap_region: "~900 MB gap" {
  style.stroke-dash: 3
  style.stroke: "#64748B"
}
heap_region -> stack_region: "~750 MB gap" {
  style.stroke-dash: 3
  style.stroke: "#64748B"
}
user_space -> kernel_space: "User/Kernel Boundary\n(0xC0000000)" {
  style.stroke: "#EF4444"
  style.stroke-width: 3
}
addr_null: "0x00000000" {
  style.font-color: "#94A3B8"
  style.font-size: 12
}
addr_code: "0x08048000" {
  style.font-color: "#94A3B8"
  style.font-size: 12
}
addr_heap_start: "0x40000000" {
  style.font-color: "#94A3B8"
  style.font-size: 12
}
addr_stack: "0xBFFFF000" {
  style.font-color: "#94A3B8"
  style.font-size: 12
}
addr_kernel: "0xC0000000" {
  style.font-color: "#FCA5A5"
  style.font-size: 12
}
addr_max: "0xFFFFFFFF" {
  style.font-color: "#FCA5A5"
  style.font-size: 12
}
legend: |md
  **Memory Protection**
  - **PTE_USER** flag set for user-accessible pages
  - **PTE_PRESENT | PTE_WRITABLE | PTE_USER** for stack/heap
  - Kernel pages: supervisor-only (no PTE_USER)
  - NULL page unmapped (catches null pointer derefs)
|
legend.near: bottom-center
legend.style.fill: "#1E293B"
legend.style.stroke: "#475569"
legend.style.font-color: "#CBD5E1"
notes: |md
  **Per-Process Page Directory**
  paging_create_user_directory():
    1. Allocate new page directory frame
    2. Clear all 1024 entries
    3. Copy entries 768-1023 from kernel PD
    4. Return new directory
  Each process sees kernel at same virtual addresses but has isolated user space.
|
notes.near: bottom-right
notes.style.fill: "#1E293B"
notes.style.stroke: "#475569"
notes.style.font-color: "#CBD5E1"