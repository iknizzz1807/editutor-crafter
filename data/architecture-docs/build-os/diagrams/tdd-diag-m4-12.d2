vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # User Process Page Directory Setup
| {near: top-center}
direction: right
# Legend
legend: {
  near: bottom-right
  shape: rectangle
  style.fill: transparent
  style.stroke: "#666666"
  kernel_space: "Kernel Space\n(0xC0000000+)\nSupervisor-only" {
    shape: rectangle
    style.fill: "#E8D5E8"
    style.stroke: "#8B5A8B"
    width: 140
  }
  user_space: "User Space\n(0x00000000-0xBFFFFFFF)\nUser-accessible" {
    shape: rectangle
    style.fill: "#D5E8D5"
    style.stroke: "#5A8B5A"
    width: 140
  }
  kernel_entry: "Copied from\nKernel PD" {
    shape: rectangle
    style.fill: "#E8D5E8"
    style.stroke: "#8B5A8B"
    width: 140
  }
}
# Page Directory (1024 entries)
page_directory: {
  label: "Page Directory\n(1024 entries × 4 bytes = 4KB)"
  style.fill: "#F5F5DC"
  style.stroke: "#8B7355"
  style.stroke-width: 2
  # User entries (0-767)
  user_entries: {
    label: "Entries 0-767\n(User Space)"
    style.fill: "#D5E8D5"
    style.stroke: "#5A8B5A"
    null_region: {
      label: "Entry 0\n(NULL\nUnmapped"
      style.fill: "#FFCCCC"
      style.stroke: "#CC0000"
      width: 80
    }
    user_code: {
      label: "Entry ~32\nUser Code\n0x08048000"
      style.fill: "#90EE90"
      style.stroke: "#228B22"
      width: 80
    }
    user_heap: {
      label: "Entry ~256\nUser Heap\n0x40000000"
      style.fill: "#90EE90"
      style.stroke: "#228B22"
      width: 80
    }
    user_stack: {
      label: "Entry ~768\nUser Stack\n0xBFFFF000"
      style.fill: "#90EE90"
      style.stroke: "#228B22"
      width: 80
    }
  }
  # Kernel entries (768-1023)
  kernel_entries: {
    label: "Entries 768-1023\n(Kernel Space)"
    style.fill: "#E8D5E8"
    style.stroke: "#8B5A8B"
    kernel_text: {
      label: "Entry 768+\nKernel .text\n0xC0000000"
      style.fill: "#DDA0DD"
      style.stroke: "#8B008B"
      width: 80
    }
    kernel_data: {
      label: "Entry 770+\nKernel .data\n0xC0100000"
      style.fill: "#DDA0DD"
      style.stroke: "#8B008B"
      width: 80
    }
    kernel_heap: {
      label: "Entry 832+\nKernel Heap\n0xD0000000"
      style.fill: "#DDA0DD"
      style.stroke: "#8B008B"
      width: 80
    }
  }
}
# Virtual Address Space
virtual_space: {
  label: "Virtual Address Space\n(4GB per process)"
  style.fill: "#F0F8FF"
  style.stroke: "#4682B4"
  style.stroke-width: 2
  # User region
  user_region: {
    label: "User Region\n(0x00000000 - 0xBFFFFFFF)\nRing 3 Accessible"
    style.fill: "#E8F5E8"
    style.stroke: "#2E8B2E"
    style.stroke-dash: 3
    null_guard: {
      label: "NULL Guard\n(Unmapped)"
      style.fill: "#FFE4E1"
      style.stroke: "#DC143C"
    }
    code_region: {
      label: "User Code\n0x08048000\nPTE_USER"
      style.fill: "#98FB98"
      style.stroke: "#228B22"
    }
    heap_region: {
      label: "User Heap\n0x40000000\nPTE_USER | PTE_RW"
      style.fill: "#98FB98"
      style.stroke: "#228B22"
    }
    stack_region: {
      label: "User Stack\n0xBFFFF000\nPTE_USER | PTE_RW\n(grows down ↓)"
      style.fill: "#98FB98"
      style.stroke: "#228B22"
    }
  }
  # Kernel region
  kernel_region: {
    label: "Kernel Region\n(0xC0000000 - 0xFFFFFFFF)\nRing 0 Only (Supervisor)"
    style.fill: "#E6E6FA"
    style.stroke: "#4B0082"
    ktext: {
      label: "Kernel Code\n0xC0000000"
      style.fill: "#DDA0DD"
      style.stroke: "#8B008B"
    }
    kdata: {
      label: "Kernel Data\n0xC0100000"
      style.fill: "#DDA0DD"
      style.stroke: "#8B008B"
    }
    kheap: {
      label: "Kernel Heap\n0xD0000000"
      style.fill: "#DDA0DD"
      style.stroke: "#8B008B"
    }
  }
}
# Physical Frames
physical_frames: {
  label: "Physical Memory"
  style.fill: "#FFFACD"
  style.stroke: "#DAA520"
  style.stroke-width: 2
  user_code_frame: {
    label: "User Code Frame\n(allocated per process)"
    style.fill: "#90EE90"
    style.stroke: "#228B22"
    width: 100
  }
  user_stack_frame: {
    label: "User Stack Frame\n(allocated per process)"
    style.fill: "#90EE90"
    style.stroke: "#228B22"
    width: 100
  }
  kernel_frames: {
    label: "Kernel Frames\n(shared across all processes)"
    style.fill: "#DDA0DD"
    style.stroke: "#8B008B"
    width: 100
  }
}
# Connections - User mappings
page_directory.user_entries.user_code -> virtual_space.user_region.code_region: "maps to"
virtual_space.user_region.code_region -> physical_frames.user_code_frame: "PTE_USER"
page_directory.user_entries.user_stack -> virtual_space.user_region.stack_region: "maps to"
virtual_space.user_region.stack_region -> physical_frames.user_stack_frame: "PTE_USER | PTE_RW"
# Connections - Kernel mappings (shared)
page_directory.kernel_entries.kernel_text -> virtual_space.kernel_region.ktext: "maps to"
virtual_space.kernel_region.ktext -> physical_frames.kernel_frames: "Supervisor-only\n(shared)"
# Copy operation annotation
copy_annotation: |md
  **paging_create_user_directory()**
  // Copy kernel entries (768-1023)
  for (int i = 768; i < 1024; i++) {
      user_pd->entries[i] = kernel_pd->entries[i];
  }
| {
  near: bottom-left
  shape: text
  style.fill: "#FFF8DC"
  style.stroke: "#DAA520"
  style.font-size: 14
}
# Isolation note
isolation_note: |md
  **Memory Isolation**
  - User process **cannot** access kernel memory
  - Page fault triggers if PTE_USER bit not set
  - Each process has **own** page directory
  - Kernel mappings identical in **all** processes
| {
  near: bottom-center
  shape: text
  style.fill: "#F0FFF0"
  style.stroke: "#228B22"
  style.font-size: 14
}