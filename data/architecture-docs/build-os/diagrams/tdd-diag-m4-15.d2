vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # System Call Handler Stack Frame
  Assembly stub saves all registers, calls C handler, preserves EAX return value through iret
| {near: top-center}
direction: right
stack_frame: {
  label: "Kernel Stack\n(Grows Down ↓)"
  user_ss: "SS (User)\n0x23" {
    style.fill: "#E8D4F8"
    style.stroke: "#8B5CF6"
  }
  user_esp: "ESP (User)\n0xBFFFF000" {
    style.fill: "#E8D4F8"
    style.stroke: "#8B5CF6"
  }
  eflags: "EFLAGS\n0x00000202" {
    style.fill: "#FEE2E2"
    style.stroke: "#EF4444"
  }
  cs: "CS (User)\n0x1B" {
    style.fill: "#FEE2E2"
    style.stroke: "#EF4444"
  }
  eip: "EIP (Return Addr)\nUser code" {
    style.fill: "#FEE2E2"
    style.stroke: "#EF4444"
  }
  separator1: "─────────────────" {
    shape: text
    style.font-color: "#6B7280"
  }
  gs: "GS" {
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
  fs: "FS" {
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
  es: "ES" {
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
  ds: "DS" {
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
  separator2: "─────────────────" {
    shape: text
    style.font-color: "#6B7280"
  }
  edi: "EDI" {
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
  }
  esi: "ESI" {
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
  }
  ebp: "EBP" {
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
  }
  esp: "ESP (pre-pusha)" {
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
  }
  ebx: "EBX (arg1)" {
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
    style.bold: true
  }
  edx: "EDX (arg3)" {
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
    style.bold: true
  }
  ecx: "ECX (arg2)" {
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
    style.bold: true
  }
  eax: "EAX (syscall# → ret)" {
    style.fill: "#FEF3C7"
    style.stroke: "#F59E0B"
    style.bold: true
  }
  separator3: "─────────────────" {
    shape: text
    style.font-color: "#6B7280"
  }
  push_edx: "push edx (arg3)" {
    style.fill: "#F3E8FF"
    style.stroke: "#A855F7"
  }
  push_ecx: "push ecx (arg2)" {
    style.fill: "#F3E8FF"
    style.stroke: "#A855F7"
  }
  push_ebx: "push ebx (arg1)" {
    style.fill: "#F3E8FF"
    style.stroke: "#A855F7"
  }
  push_eax: "push eax (syscall#)" {
    style.fill: "#F3E8FF"
    style.stroke: "#A855F7"
  }
  ret_addr: "Return Addr\n(to stub)" {
    style.fill: "#F3E8FF"
    style.stroke: "#A855F7"
  }
  esp_ptr: "ESP →" {
    shape: text
    style.font-color: "#DC2626"
    style.bold: true
  }
}
flow: {
  label: "Execution Flow"
  step1: "1. User executes INT 0x80" {
    shape: rectangle
    style.fill: "#FEE2E2"
    style.stroke: "#EF4444"
  }
  step2: "2. CPU pushes:\n   SS, ESP, EFLAGS, CS, EIP" {
    shape: rectangle
    style.fill: "#FEE2E2"
    style.stroke: "#EF4444"
  }
  step3: "3. Stub pushes:\n   GS, FS, ES, DS" {
    shape: rectangle
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
  step4: "4. pusha saves:\n   EDI, ESI, EBP, ESP,\n   EBX, EDX, ECX, EAX" {
    shape: rectangle
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
  }
  step5: "5. Push args &\n   call C handler" {
    shape: rectangle
    style.fill: "#F3E8FF"
    style.stroke: "#A855F7"
  }
  step6: "6. C handler returns\n   value in EAX" {
    shape: rectangle
    style.fill: "#FEF3C7"
    style.stroke: "#F59E0B"
    style.bold: true
  }
  step7: "7. popa restores all\n   (EAX has ret value)" {
    shape: rectangle
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
  }
  step8: "8. pop GS, FS, ES, DS" {
    shape: rectangle
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
  step9: "9. iret returns to\n   user mode" {
    shape: rectangle
    style.fill: "#FEE2E2"
    style.stroke: "#EF4444"
  }
  step1 -> step2 -> step3 -> step4 -> step5 -> step6 -> step7 -> step8 -> step9
}
code: {
  label: "Assembly Stub (syscall_asm.asm)"
  code_block: |go
    syscall_entry:
        ; CPU pushed: SS,ESP,EFLAGS,CS,EIP
        push ds, es, fs, gs
        mov ax, 0x10        ; kernel data
        mov ds, ax
        mov es, ax
        mov fs, ax
        mov gs, ax
        pusha               ; save all GPRs
        ; Args already in EBX,ECX,EDX
        push edx            ; arg3
        push ecx            ; arg2
        push ebx            ; arg1
        push eax            ; syscall#
        call syscall_dispatch
        add esp, 16         ; clean args
        ; EAX = return value (PRESERVED!)
        popa                ; restore GPRs
        pop gs, fs, es, ds
        iret                ; return to user
  | {
    shape: code
    language: go
    style.fill: "#1E293B"
    style.font-color: "#E2E8F0"
    style.font: mono
  }
}
legend: {
  label: "Legend"
  cpu_push: "CPU Pushed" {
    style.fill: "#FEE2E2"
    style.stroke: "#EF4444"
  }
  seg_regs: "Segment Regs" {
    style.fill: "#DBEAFE"
    style.stroke: "#3B82F6"
  }
  gen_regs: "General Regs (pusha)" {
    style.fill: "#D1FAE5"
    style.stroke: "#10B981"
  }
  args: "Args for C handler" {
    style.fill: "#F3E8FF"
    style.stroke: "#A855F7"
  }
  ret_val: "Return Value (EAX)" {
    style.fill: "#FEF3C7"
    style.stroke: "#F59E0B"
    style.bold: true
  }
  user_ctx: "User Context" {
    style.fill: "#E8D4F8"
    style.stroke: "#8B5CF6"
  }
  cpu_push -> seg_regs -> gen_regs -> args -> ret_val -> user_ctx
}
note: |md
  **Key Insight:** The `popa` instruction restores EAX from the stack,
  but the C return value is already IN EAX at that point. Since `pusha`
  saved the original EAX and `popa` restores what's on the stack,
  the return value would be lost...
  **Solution:** The C calling convention returns in EAX. After `call`
  returns, EAX holds the result. We do NOT modify EAX before `popa`.
  The `popa` restores other registers but the return value in EAX
  was pushed AFTER pusha's EAX slot, so it survives!
  Actually: `popa` restores EAX from stack, overwriting return value.
  The stub must either: (a) save return value, popa, restore return
  value; or (b) adjust stack to skip EAX restoration.
| {
  near: bottom-center
  shape: text
  style.fill: "#FEF3C7"
  style.stroke: "#F59E0B"
}