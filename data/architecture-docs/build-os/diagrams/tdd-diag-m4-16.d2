vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # IDT Entry 0x80: Syscall Gate Configuration
  Trap gate with DPL=3 for user-mode system calls
| {near: top-center}
direction: right
idt_entry: {
  label: "IDT Entry [0x80]\n8 bytes"
  style.fill: "#E8D5F0"
  style.stroke: "#7B4B94"
  style.stroke-width: 2
  offset_low: {
    label: "Offset Low\n[15:0]"
    shape: rectangle
    style.fill: "#B8D4E8"
    width: 120
  }
  selector: {
    label: "Selector\n0x08"
    shape: rectangle
    style.fill: "#D4E8B8"
    width: 120
  }
  zero: {
    label: "Reserved\n0x00"
    shape: rectangle
    style.fill: "#E8E8E8"
    width: 120
  }
  type_attr: {
    label: "Type/Attr\n0xEF"
    shape: rectangle
    style.fill: "#E8B8B8"
    style.stroke: "#C44"
    style.stroke-width: 2
    width: 120
  }
  offset_high: {
    label: "Offset High\n[31:16]"
    shape: rectangle
    style.fill: "#B8D4E8"
    width: 120
  }
}
type_attr_detail: {
  label: "Attribute Byte 0xEF\n(11101111b)"
  style.fill: "#FFF0F0"
  style.stroke: "#C44"
  bit7_6: "P=1, DPL=11"
  bit5: "S=0 (system)"
  bit4_0: "Type=1111 (32-bit trap)"
  breakdown: |md
    Bit 7: Present     = 1 ✓
    Bit 6-5: DPL       = 11 (ring 3)
    Bit 4: System      = 0 (gate)
    Bit 3-0: Type      = 1111 (trap)
  |
}
handler: {
  label: "syscall_entry\n(Assembly Stub)"
  shape: hexagon
  style.fill: "#FFE4B5"
  style.stroke: "#D2691E"
  handler_steps: |md
    1. Save DS, ES, FS, GS
    2. Load kernel segments
    3. pusha (save GPRs)
    4. Push args (EDX, ECX, EBX, EAX)
    5. call syscall_dispatch
    6. popa, restore segments
    7. iret
  |
}
syscall_dispatch: {
  label: "syscall_dispatch()"
  shape: diamond
  style.fill: "#E6E6FA"
  dispatch_table: {
    label: "Dispatch Table"
    shape: class
    "SYS_EXIT (0)": "sys_exit"
    "SYS_READ (1)": "sys_read"
    "SYS_WRITE (2)": "sys_write"
    "SYS_GETPID (3)": "sys_getpid"
    "SYS_YIELD (4)": "sys_yield"
  }
}
user_mode: {
  label: "User Mode (Ring 3)"
  shape: oval
  style.fill: "#90EE90"
  style.stroke: "#228B22"
  call_sequence: |md
    mov eax, SYSCALL_NUM
    mov ebx, arg1
    mov ecx, arg2
    mov edx, arg3
    int 0x80        ; → IDT[0x80]
    ; EAX = return value
  |
}
kernel_mode: {
  label: "Kernel Mode (Ring 0)"
  shape: oval
  style.fill: "#FFB6C1"
  style.stroke: "#DC143C"
}
idt_register: {
  label: "IDTR"
  shape: cylinder
  style.fill: "#D3D3D3"
  limit: "Limit: 2047 (256×8-1)"
  base: "Base: IDT address"
}
idt_array: {
  label: "IDT Array (256 entries)"
  shape: rectangle
  style.fill: "#F5F5F5"
  style.stroke-dash: 3
  entry_0_31: "0-31: CPU Exceptions"
  entry_32_47: "32-47: Hardware IRQs"
  entry_80: {
    label: "0x80: Syscall"
    style.fill: "#E8B8B8"
    style.stroke: "#C44"
    style.stroke-width: 3
  }
  entry_48_255: "48-255: Available"
}
# Connections
user_mode -> idt_array.entry_80: "INT 0x80\n(DPL=3 allows)" {
  style.stroke: "#228B22"
  style.stroke-width: 2
  style.animated: true
}
idt_array.entry_80 -> idt_entry: "Entry details"
idt_entry.type_attr -> type_attr_detail: "Decoded"
idt_entry.offset_low -> handler: "Handler address"
idt_entry.offset_high -> handler
handler -> syscall_dispatch: "Calls"
syscall_dispatch -> syscall_dispatch.dispatch_table: "Lookup"
syscall_dispatch -> kernel_mode: "Returns via iret"
kernel_mode -> user_mode: "Resume\nEAX=result" {
  style.stroke: "#DC143C"
  style.stroke-dash: 3
}
idt_register -> idt_array: "Points to" {
  style.stroke-dash: 5
}
# Legend
legend: {
  near: bottom-right
  label: "Gate Types"
  interrupt_gate: {
    label: "Interrupt Gate (0x8E)\nDisables interrupts"
    shape: rectangle
    style.fill: "#E8E8E8"
  }
  trap_gate: {
    label: "Trap Gate (0x8F/0xEF)\nKeeps interrupt flag"
    shape: rectangle
    style.fill: "#E8B8B8"
  }
  note: |md
    **DPL=3** allows user-mode (ring 3) code
    to execute INT 0x80 without GPF.
    Trap gate preserves IF so interrupts
    remain enabled during syscall handling.
  |
}