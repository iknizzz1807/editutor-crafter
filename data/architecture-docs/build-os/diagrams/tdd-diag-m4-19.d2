vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Three Concurrent Kernel Processes
  Demonstrating preemptive multitasking via timer-driven context switches
| {near: top-center}
direction: right
classes: {
  process: {
    shape: rectangle
    style: {
      fill: "#E8F4FD"
      stroke: "#2563EB"
      stroke-width: 2
      font: mono
    }
  }
  active: {
    style: {
      fill: "#DBEAFE"
      stroke: "#1D4ED8"
      stroke-width: 3
      bold: true
    }
  }
  vga: {
    shape: rectangle
    style: {
      fill: "#1F2937"
      stroke: "#374151"
      font-color: "#F9FAFB"
      font: mono
    }
  }
  timer: {
    shape: diamond
    style: {
      fill: "#FEF3C7"
      stroke: "#D97706"
    }
  }
  switch: {
    style: {
      fill: "#DCFCE7"
      stroke: "#16A34A"
      stroke-width: 2
    }
  }
}
VGA: "VGA Text Buffer (0xB8000)" {
  class: vga
  width: 350
  line0: "Line 0: [A] [B] [C] ..." {
    style: {
      fill: "#1F2937"
      font-color: "#22C55E"
      font: mono
    }
  }
  line1: "Line 1: [0] [1] [2] ..." {
    style: {
      fill: "#1F2937"
      font-color: "#3B82F6"
      font: mono
    }
  }
  line2: "Line 2: [a] [b] [c] ..." {
    style: {
      fill: "#1F2937"
      font-color: "#EF4444"
      font: mono
    }
  }
}
Process_A: "Process A (PID 1)" {
  class: [process; active]
  code: |md
    c
    void process_a(void) {
      int x = 0;
      while (1) {
        vga[0] = 'A' + (x % 26);
        x++;
        delay();
      }
    }
  |
  state: "State: RUNNING"
  stack: "Kernel Stack: 0x901000" {
    style.fill: "#FEE2E2"
  }
}
Process_B: "Process B (PID 2)" {
  class: process
  code: |md
    c
    void process_b(void) {
      int x = 0;
      while (1) {
        vga[160] = '0' + (x % 10);
        x++;
        delay();
      }
    }
  |
  state: "State: READY"
  stack: "Kernel Stack: 0x902000" {
    style.fill: "#DBEAFE"
  }
}
Process_C: "Process C (PID 3)" {
  class: process
  code: |md
    c
    void process_c(void) {
      int x = 0;
      while (1) {
        vga[320] = 'a' + (x % 26);
        x++;
        delay();
      }
    }
  |
  state: "State: READY"
  stack: "Kernel Stack: 0x903000" {
    style.fill: "#FEF3C7"
  }
}
Timer: "Timer Interrupt\n(IRQ0 @ 100Hz)" {
  class: timer
}
Scheduler: "Round-Robin\nScheduler" {
  class: switch
  queue: "Run Queue: B → C → A"
  tss: "TSS.ESP0 = 0x902000"
}
Process_A -> VGA: "vga[0] = 'A'+'x'%26\n(green)" {
  style: {
    stroke: "#22C55E"
    stroke-width: 2
    animated: true
  }
}
Process_B -> VGA: "vga[160] = '0'+'x'%10\n(blue)" {
  style: {
    stroke: "#3B82F6"
    stroke-width: 2
    animated: true
  }
}
Process_C -> VGA: "vga[320] = 'a'+'x'%26\n(red)" {
  style: {
    stroke: "#EF4444"
    stroke-width: 2
    animated: true
  }
}
Timer -> Scheduler: "Tick!\nTime slice expired" {
  style: {
    stroke: "#D97706"
    stroke-dash: 4
  }
}
Scheduler -> Process_A: "Context Switch: Save ESP → PCB\nSet READY" {
  style: {
    stroke: "#16A34A"
  }
}
Scheduler -> Process_B: "Next Process: Load ESP from PCB\nSet RUNNING" {
  style: {
    stroke: "#16A34A"
  }
}
legend: |md
  **Preemptive Multitasking Flow:**
  1. Timer interrupt fires every 10ms (100Hz)
  2. Scheduler saves current process state to PCB
  3. TSS.ESP0 updated to next process's kernel stack
  4. Context switch loads next process's saved state
  5. `iret` resumes execution in new process
  Each process writes to a different VGA line,
  creating visible concurrent execution.
| {near: bottom-center}