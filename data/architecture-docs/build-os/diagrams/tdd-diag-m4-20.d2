vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#9B59B6"
    kernel: "#3498DB"
    user: "#2ECC71"
    error: "#E74C3C"
    memory: "#F39C12"
  }
}
title: |md
  # User Process Isolation Check
  ### User Mode Access to Kernel Address → Page Fault
| {near: top-center}
direction: right
UserProcess: "User Process" {
  style.fill: "${colors.user}"
  style.stroke: "#27AE60"
  UserCode: "User Code" {
    shape: rectangle
    style.fill: "#E8F8F5"
    attempt: |md
      c
      // Attempt to read kernel memory
      int *kernel_ptr = (int*)0xC0100000;
      int value = *kernel_ptr;  // ❌ VIOLATION
    |
  }
  user_state: "Process State" {
    shape: rectangle
    style.fill: "#D5F5E3"
    cs: "CS = 0x1B (Ring 3)" {style.fill: "${colors.user}"}
    ss: "SS = 0x23 (Ring 3)" {style.fill: "${colors.user}"}
    cr3: "CR3 = User Page Directory" {style.fill: "${colors.user}"}
    cpl: "CPL = 3 (User Mode)" {style.fill: "${colors.user}"}
  }
}
UserPageDirectory: "User Page Directory" {
  style.fill: "${colors.user}"
  style.stroke: "#27AE60"
  entries: "Page Directory Entries" {
    shape: rectangle
    pd_0_767: "Entries 0-767\n(User Space)" {
      style.fill: "#D5F5E3"
    }
    pd_768_1023: "Entries 768-1023\n(Kernel Space)" {
      style.fill: "${colors.kernel}"
      note: |md
        Copied from kernel PD
        **PTE_USER = 0** (supervisor only)
      |
    }
  }
  lookup: "Lookup: Index 768\n(VA 0xC0100000)" {
    shape: diamond
    style.fill: "${colors.memory}"
  }
  pde: "PDE Value:\n0x00CFxxxx\n(Supervisor, Present)" {
    style.fill: "${colors.kernel}"
    style.stroke: "#2980B9"
  }
}
PageTable: "Page Table" {
  style.fill: "${colors.kernel}"
  pte_check: "PTE Check" {
    shape: diamond
    style.fill: "${colors.memory}"
    flags: |md
      **PTE Flags:**
      - Present (P) = 1
      - User/Supervisor (U/S) = **0**
      - Read/Write (R/W) = 1
    |
  }
  access_check: "CPL vs U/S Check" {
    shape: diamond
    style.fill: "${colors.error}"
    result: |md
      **VIOLATION DETECTED:**
      - CPL = 3 (User Mode)
      - U/S bit = 0 (Supervisor Only)
      - **3 > 0 → ACCESS DENIED**
    |
  }
}
CPU: "CPU Hardware" {
  style.fill: "${colors.header}"
  fault_gen: "Page Fault Generation" {
    shape: rectangle
    style.fill: "${colors.error}"
    trigger: |md
      **Exception 14 (#PF) Triggered**
      CPU pushes to stack:
      - EIP (faulting instruction)
      - CS = 0x1B
      - EFLAGS
      - User ESP
      - User SS = 0x23
    |
  }
  cr2: "CR2 ← 0xC0100000\n(Faulting Address)" {
    style.fill: "${colors.memory}"
  }
  error_code: "Error Code pushed:\n0bxxxxx101" {
    style.fill: "${colors.error}"
    decode: |md
      **Error Code Decode:**
      - Bit 0 (P) = 1: Protection violation
      - Bit 1 (W) = 0: Read access
      - Bit 2 (U) = 1: User mode
      - Bit 3 (R) = 0: Reserved bit OK
      - Bit 4 (I) = 0: Not instruction fetch
    |
  }
}
PageFaultHandler: "Page Fault Handler\n(Exception 14)" {
  style.fill: "${colors.header}"
  style.stroke: "#8E44AD"
  handler: "isr14_handler()" {
    shape: rectangle
    style.fill: "#D7BDE2"
    code: |md
      c
      void page_fault_handler(regs_t *r) {
          uint32_t fault_addr;
          asm volatile("mov %%cr2, %0" 
                       : "=r"(fault_addr));
          uint32_t err = r->err_code;
          kprintf("!!! PAGE FAULT !!!\n");
          kprintf("Address: 0x%08x\n", fault_addr);
          kprintf("Cause: %s\n",
              (err & 1) ? "Protection" : "Not Present");
          kprintf("Mode: %s\n",
              (err & 4) ? "User" : "Kernel");
          // Terminate offending process
          process_exit(-1);  // SIGSEGV equivalent
      }
    |
  }
  output: "Diagnostic Output" {
    shape: rectangle
    style.fill: "#FADBD8"
    console: |md
      !!! PAGE FAULT !!!
      Faulting address (CR2): 0xC0100000
      Cause: Protection violation
      Access: Read
      Mode: User
      PD Entry [768]: 0x00CFxxxx
      PT Entry [xxx]: 0x00CFxxxx
      Error code: 0x00000005
      Process 'user_hello' (PID 3) terminated
    |
  }
}
KernelSpace: "Kernel Space\n(0xC0000000+)" {
  style.fill: "${colors.kernel}"
  style.stroke-dash: 3
  protected: |md
    **Protected Memory Region**
    All pages marked:
    - Present = 1
    - User/Supervisor = 0
    - Only accessible from Ring 0
  |
}
UserSpace: "User Space\n(0x00000000 - 0xBFFFFFFF)" {
  style.fill: "${colors.user}"
  style.stroke-dash: 3
  accessible: |md
    **Accessible Memory Region**
    User pages marked:
    - Present = 1
    - User/Supervisor = 1
    - Accessible from Ring 3
  |
}
ProtectionSummary: "Isolation Enforcement" {
  style.fill: "${colors.header}"
  protection_steps: |md
    ## Protection Mechanism Sequence
    1. **User code attempts access** to 0xC0100000
    2. **MMU walks page tables** for translation
    3. **PTE U/S bit checked** against current CPL
    4. **CPL (3) > U/S (0)** → Protection violation
    5. **CPU generates #PF** with error code
    6. **CR2 loaded** with faulting address
    7. **Handler reads CR2**, decodes error
    8. **Process terminated** to protect system
    **Result:** User process cannot access kernel memory
  |
}
UserProcess.UserCode.attempt -> UserPageDirectory.lookup: "1. Virtual Address\n0xC0100000" {style.stroke: "${colors.user}"}
UserPageDirectory.lookup -> UserPageDirectory.pde: "2. PD Index = 768" {style.stroke: "${colors.memory}"}
UserPageDirectory.pde -> PageTable.pte_check: "3. Get Page Table" {style.stroke: "${colors.kernel}"}
PageTable.pte_check -> PageTable.access_check: "4. Check U/S bit" {style.stroke: "${colors.memory}"}
PageTable.access_check -> CPU.fault_gen: "5. CPL(3) > U/S(0)\nVIOLATION!" {style.stroke: "${colors.error}"; style.animated: true}
CPU.fault_gen -> CPU.cr2: "6. Save fault addr" {style.stroke: "${colors.error}"}
CPU.fault_gen -> CPU.error_code: "7. Push error code" {style.stroke: "${colors.error}"}
CPU.fault_gen -> PageFaultHandler.handler: "8. Jump to #PF handler" {style.stroke: "${colors.header}"}
PageFaultHandler.handler -> PageFaultHandler.output: "9. Print diagnostics" {style.stroke: "${colors.header}"}
KernelSpace -> UserPageDirectory.pd_768_1023: "Mapped with\nU/S=0" {style.stroke: "${colors.kernel}"; style.stroke-dash: 5}
UserSpace -> UserPageDirectory.pd_0_767: "Mapped with\nU/S=1" {style.stroke: "${colors.user}"; style.stroke-dash: 5}