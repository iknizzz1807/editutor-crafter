vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#9B7ED9"
    registers: "#5C9EDC"
    pointers: "#E8903D"
    metadata: "#4CAF7C"
    padding: "#9E9E9E"
    cache_line: "#666666"
  }
}

direction: right

title: ||md
  # Process Control Block (PCB) Memory Layout
  `sizeof(struct pcb) = 128 bytes (2 cache lines)`
|| {near: top-center}

pcb: {
  label: ""
  
  row0_15: {
    label: ""
    grid-rows: 1
    grid-columns: 2
    grid-gap: 0
    
    offset0: {
      label: ||md
        **Offset 0x00**
        (Header)
||
      style.fill: ${colors.header}
      style.stroke: "#333"
      width: 120
      height: 200
    }
    
    fields0: {
      label: ||md
        **pid**: `uint32_t`
        **state**: `uint32_t`
        **priority**: `uint32_t`
        **flags**: `uint32_t`
||
      style.fill: ${colors.header}
      style.stroke: "#333"
      style.font: mono
      width: 180
      height: 200
    }
  }
  
  row16_31: {
    label: ""
    grid-rows: 1
    grid-columns: 2
    grid-gap: 0
    
    offset1: {
      label: ||md
        **Offset 0x10**
        (Metadata)
||
      style.fill: ${colors.metadata}
      style.stroke: "#333"
      width: 120
      height: 200
    }
    
    fields1: {
      label: ||md
        **name[16]**: `char[]`
        *(16 bytes)*
||
      style.fill: ${colors.metadata}
      style.stroke: "#333"
      style.font: mono
      width: 180
      height: 200
    }
  }
  
  row32_47: {
    label: ""
    grid-rows: 1
    grid-columns: 2
    grid-gap: 0
    
    offset2: {
      label: ||md
        **Offset 0x20**
        (Registers)
||
      style.fill: ${colors.registers}
      style.stroke: "#333"
      width: 120
      height: 200
    }
    
    fields2: {
      label: ||md
        **eax**: `uint32_t`
        **ebx**: `uint32_t`
        **ecx**: `uint32_t`
        **edx**: `uint32_t`
||
      style.fill: ${colors.registers}
      style.stroke: "#333"
      style.font: mono
      width: 180
      height: 200
    }
  }
  
  row48_63: {
    label: ""
    grid-rows: 1
    grid-columns: 2
    grid-gap: 0
    
    offset3: {
      label: ||md
        **Offset 0x30**
        (Registers)
||
      style.fill: ${colors.registers}
      style.stroke: "#333"
      width: 120
      height: 200
    }
    
    fields3: {
      label: ||md
        **esi**: `uint32_t`
        **edi**: `uint32_t`
        **ebp**: `uint32_t`
        **esp**: `uint32_t`
||
      style.fill: ${colors.registers}
      style.stroke: "#333"
      style.font: mono
      width: 180
      height: 200
    }
  }
  
  row64_79: {
    label: ""
    grid-rows: 1
    grid-columns: 2
    grid-gap: 0
    
    offset4: {
      label: ||md
        **Offset 0x40**
        (System)
||
      style.fill: ${colors.registers}
      style.stroke: "#333"
      width: 120
      height: 200
    }
    
    fields4: {
      label: ||md
        **eip**: `uint32_t`
        **eflags**: `uint32_t`
        **cs**: `uint16_t`
        **ds**: `uint16_t`
        **es**: `uint16_t`
        **fs**: `uint16_t`
||
      style.fill: ${colors.registers}
      style.stroke: "#333"
      style.font: mono
      width: 180
      height: 200
    }
  }
  
  row80_95: {
    label: ""
    grid-rows: 1
    grid-columns: 2
    grid-gap: 0
    
    offset5: {
      label: ||md
        **Offset 0x50**
        (Segments)
||
      style.fill: ${colors.registers}
      style.stroke: "#333"
      width: 120
      height: 200
    }
    
    fields5: {
      label: ||md
        **gs**: `uint16_t`
        **ss**: `uint16_t`
        *_padding*: `uint32_t`
        **cr3**: `uint32_t`
||
      style.fill: ${colors.registers}
      style.stroke: "#333"
      style.font: mono
      width: 180
      height: 200
    }
  }
  
  row96_111: {
    label: ""
    grid-rows: 1
    grid-columns: 2
    grid-gap: 0
    
    offset6: {
      label: ||md
        **Offset 0x60**
        (Pointers)
||
      style.fill: ${colors.pointers}
      style.stroke: "#333"
      width: 120
      height: 200
    }
    
    fields6: {
      label: ||md
        **kernel_stack**: `void*`
        **user_stack**: `void*`
        **page_dir**: `uint32_t*`
        *_padding*: `uint32_t`
||
      style.fill: ${colors.pointers}
      style.stroke: "#333"
      style.font: mono
      width: 180
      height: 200
    }
  }
  
  row112_127: {
    label: ""
    grid-rows: 1
    grid-columns: 2
    grid-gap: 0
    
    offset7: {
      label: ||md
        **Offset 0x70**
        (Scheduler)
||
      style.fill: ${colors.pointers}
      style.stroke: "#333"
      width: 120
      height: 200
    }
    
    fields7: {
      label: ||md
        **prev**: `struct pcb*`
        **next**: `struct pcb*`
        **time_slice**: `uint32_t`
        **runtime**: `uint32_t`
||
      style.fill: ${colors.pointers}
      style.stroke: "#333"
      style.font: mono
      width: 180
      height: 200
    }
  }
}

cache_line_1: {
  label: ||md
    ──────────── Cache Line 1 (0x00-0x3F) ────────────
||
  shape: text
  style.font: mono
  style.font-size: 14
  near: top-center
}

cache_line_2: {
  label: ||md
    ──────────── Cache Line 2 (0x40-0x7F) ────────────
||
  shape: text
  style.font: mono
  style.font-size: 14
  near: top-center
}

legend: {
  near: bottom-center
  grid-columns: 4
  grid-gap: 10
  
  header_legend: {
    label: "Header"
    style.fill: ${colors.header}
    width: 80
    height: 30
  }
  
  registers_legend: {
    label: "Registers"
    style.fill: ${colors.registers}
    width: 80
    height: 30
  }
  
  pointers_legend: {
    label: "Pointers"
    style.fill: ${colors.pointers}
    width: 80
    height: 30
  }
  
  metadata_legend: {
    label: "Metadata"
    style.fill: ${colors.metadata}
    width: 80
    height: 30
  }
}

size_annotation: {
  label: ||md
    **Total: 128 bytes (2 cache lines)**
    
    | Field Range | Size | Purpose |
    |-------------|------|---------|
    | 0x00-0x0F | 16B | Process identification |
    | 0x10-0x1F | 16B | Process name |
    | 0x20-0x3F | 32B | General purpose registers |
    | 0x40-0x5F | 32B | System registers + segments |
    | 0x60-0x7F | 32B | Pointers + scheduling |
||
  shape: text
  near: bottom-right
}

growth: {
  label: ||md
    **Growth Direction: ↑**
    Stack grows toward lower addresses
||
  shape: text
  near: center-right
  style.font-size: 12
}