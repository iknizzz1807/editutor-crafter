vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # PIC Remapping: IRQ to Vector Mapping
| {near: top-center}

direction: right

before: "Before Remap (Conflict State)" {
  style.fill: "#2a1a1a"
  style.stroke: "#ff4444"
  style.stroke-width: 3
  
  irq_default: "IRQ Lines" {
    style.fill: "#333"
    
    irq0: "IRQ0 (Timer)" {
      style.fill: "#ff6666"
      style.font-color: white
    }
    irq1: "IRQ1 (Keyboard)" {
      style.fill: "#ff6666"
      style.font-color: white
    }
    irq2: "IRQ2 (Cascade)" {
      style.fill: "#666"
      style.font-color: white
    }
    irq7: "IRQ7" {
      style.fill: "#666"
      style.font-color: white
    }
    irq8: "IRQ8 (RTC)" {
      style.fill: "#ff6666"
      style.font-color: white
    }
  }
  
  vectors_default: "IDT Vectors" {
    style.fill: "#333"
    
    v0_7: "Vectors 0-7\n(Exceptions)" {
      style.fill: "#4a4a8a"
      style.font-color: white
    }
    v8_15: "Vectors 8-15\n(Exceptions + IRQ)" {
      style.fill: "#8a4a4a"
      style.font-color: white
      style.stroke: "#ff4444"
      style.stroke-width: 2
    }
  }
  
  irq_default.irq0 -> vectors_default.v8_15: "Vector 8\n(CONFLICT!)" {
    style.stroke: "#ff4444"
    style.stroke-width: 3
    style.stroke-dash: 4
    style.animated: true
  }
  
  irq_default.irq8 -> vectors_default.v8_15: "Vector 40" {
    style.stroke: "#aa4444"
    style.stroke-dash: 3
  }
}

conflict_box: |md
  **⚠️ CONFLICT**
  
  IRQ0 → Vector 8
  (Double Fault Exception)
  
  IRQ8 → Vector 40
  (reserved but confusing)
| {
  near: top-right
  style.fill: "#4a1a1a"
  style.stroke: "#ff4444"
  style.font-color: "#ff8888"
}

arrow: "->" {
  shape: text
  style.font-size: 48
  style.font-color: "#44ff44"
  style.bold: true
}

after: "After Remap (Clean State)" {
  style.fill: "#1a2a1a"
  style.stroke: "#44ff44"
  style.stroke-width: 3
  
  irq_remap: "IRQ Lines" {
    style.fill: "#333"
    
    irq0_r: "IRQ0 (Timer)" {
      style.fill: "#66ff66"
      style.font-color: black
    }
    irq1_r: "IRQ1 (Keyboard)" {
      style.fill: "#66ff66"
      style.font-color: black
    }
    irq2_r: "IRQ2 (Cascade)" {
      style.fill: "#666"
      style.font-color: white
    }
    irq7_r: "IRQ7" {
      style.fill: "#666"
      style.font-color: white
    }
    irq8_r: "IRQ8 (RTC)" {
      style.fill: "#66ff66"
      style.font-color: black
    }
  }
  
  vectors_remap: "IDT Vectors" {
    style.fill: "#333"
    
    v0_7_r: "Vectors 0-7\n(Exceptions)" {
      style.fill: "#4a4a8a"
      style.font-color: white
    }
    v8_15_r: "Vectors 8-15\n(Exceptions Only)" {
      style.fill: "#4a4a8a"
      style.font-color: white
    }
    v32_39_r: "Vectors 32-39\n(Master PIC IRQs)" {
      style.fill: "#4a8a4a"
      style.font-color: white
      style.stroke: "#44ff44"
      style.stroke-width: 2
    }
    v40_47_r: "Vectors 40-47\n(Slave PIC IRQs)" {
      style.fill: "#4a8a4a"
      style.font-color: white
    }
  }
  
  irq_remap.irq0_r -> vectors_remap.v32_39_r: "Vector 32" {
    style.stroke: "#44ff44"
    style.stroke-width: 2
  }
  
  irq_remap.irq8_r -> vectors_remap.v40_47_r: "Vector 40" {
    style.stroke: "#44aa44"
    style.stroke-width: 2
  }
}

success_box: |md
  **✓ CLEAN MAPPING**
  
  IRQ0 → Vector 32
  IRQ1 → Vector 33
  ...
  IRQ8 → Vector 40
  
  No conflicts with CPU exceptions!
| {
  near: bottom-right
  style.fill: "#1a4a1a"
  style.stroke: "#44ff44"
  style.font-color: "#88ff88"
}

remap_detail: "Remap Sequence (ICW1-4)" {
  near: bottom-center
  style.fill: "#1a1a2a"
  style.stroke: "#4444aa"
  
  master: "Master PIC (8259A)" {
    style.fill: "#2a2a4a"
    
    m_cmd: "I/O Port 0x20 (Command)" {
      style.fill: "#3a3a5a"
      style.font: mono
    }
    m_data: "I/O Port 0x21 (Data)" {
      style.fill: "#3a3a5a"
      style.font: mono
    }
  }
  
  slave: "Slave PIC (8259A)" {
    style.fill: "#2a2a4a"
    
    s_cmd: "I/O Port 0xA0 (Command)" {
      style.fill: "#3a3a5a"
      style.font: mono
    }
    s_data: "I/O Port 0xA1 (Data)" {
      style.fill: "#3a3a5a"
      style.font: mono
    }
  }
  
  icw1: |md
    **ICW1: 0x11**
    - Initialize
    - ICW4 needed
    - Edge triggered
  | {
    style.fill: "#2a3a2a"
    style.font: mono
  }
  
  icw2_m: |md
    **ICW2 Master: 0x20**
    - Vector base = 32
    - IRQ0 → Vector 32
  | {
    style.fill: "#2a3a2a"
    style.font: mono
  }
  
  icw2_s: |md
    **ICW2 Slave: 0x28**
    - Vector base = 40
    - IRQ8 → Vector 40
  | {
    style.fill: "#2a3a2a"
    style.font: mono
  }
  
  icw3_m: |md
    **ICW3 Master: 0x04**
    - Slave on IRQ2
  | {
    style.fill: "#2a3a2a"
    style.font: mono
  }
  
  icw3_s: |md
    **ICW3 Slave: 0x02**
    - Slave ID = 2
  | {
    style.fill: "#2a3a2a"
    style.font: mono
  }
  
  icw4: |md
    **ICW4: 0x01**
    - 8086 mode
    - Non-AEOI
  | {
    style.fill: "#2a3a2a"
    style.font: mono
  }
}

note: |md
  **Why Remap?**
  
  The 8259A PIC defaults to mapping IRQ0-7 to vectors 8-15, which
  conflicts with CPU exceptions (Double Fault at 8, GPF at 13, etc.).
  
  Remapping moves IRQs to vectors 32-47, leaving 0-31 for CPU exceptions.
| {
  near: bottom-right
  style.fill: "#1a1a1a"
  style.font-color: "#aaaaaa"
}