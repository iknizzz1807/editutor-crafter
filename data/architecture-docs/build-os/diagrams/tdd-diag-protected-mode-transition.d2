vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: Protected Mode Transition State Machine {
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
  }
}

RealMode: Real Mode {
  shape: circle
  style: {
    fill: "#E8E8E8"
    stroke: "#666666"
  }
  tooltip: |md
    CPU state after reset
    - CS:IP = F000:FFF0
    - CR0.PE = 0
    - 20-bit addressing
    - No memory protection
  |
}

GDTLoaded: GDT Loaded {
  shape: circle
  style: {
    fill: "#C8E6C9"
    stroke: "#388E3C"
  }
  tooltip: |md
    GDTR points to valid GDT
    - Null descriptor at offset 0
    - Kernel CS at offset 0x08
    - Kernel DS at offset 0x10
  |
}

CR0Set: CR0.PE Set {
  shape: circle
  style: {
    fill: "#C8E6C9"
    stroke: "#388E3C"
  }
  tooltip: |md
    Protection Enable bit set
    - mov cr0, eax with PE=1
    - CPU now in protected mode
    - Segments still have old values!
  |
}

PipelineFlushed: Pipeline Flushed {
  shape: circle
  style: {
    fill: "#C8E6C9"
    stroke: "#388E3C"
  }
  tooltip: |md
    Far jump flushes prefetch
    - jmp 0x08:protected_entry
    - Clears 16-bit instruction queue
    - Reloads CS with selector 0x08
  |
}

SegmentsReloaded: Segments Reloaded {
  shape: circle
  style: {
    fill: "#C8E6C9"
    stroke: "#388E3C"
  }
  tooltip: |md
    All segment registers valid
    - DS, ES, FS, GS = 0x10
    - SS = 0x10
    - All using protected mode selectors
  |
}

ProtectedMode: Protected Mode {
  shape: circle
  style: {
    fill: "#4CAF50"
    stroke: "#1B5E20"
    font-color: white
    bold: true
  }
  tooltip: |md
    Full protected mode operation
    - 32-bit addressing
    - Memory protection active
    - Privilege levels enforced
    - Ready for paging setup
  |
}

init: {
  label: ●
  shape: circle
  style: {
    fill: "#333333"
    stroke: "#333333"
  }
}

init -> RealMode: Power On / Reset

RealMode -> GDTLoaded: {
  label: |md
    **Action:** `lgdt [gdtr]`
    
    **Guard:** GDTR points to valid GDT structure
    
    **Notes:** GDT must contain at least null + code + data descriptors
  |
}

GDTLoaded -> CR0Set: {
  label: |md
    **Action:** Set CR0.PE bit
    
    **Guard:** GDT loaded and valid
    
    **Critical:** CPU is NOW in protected mode but segments still have real-mode values!
  |
}

CR0Set -> PipelineFlushed: {
  label: |md
    **Action:** Far jump to flush pipeline
    
    **Guard:** CR0.PE = 1
    
    **Required:** Must be FAR jump to reload CS and flush 16-bit prefetch queue
  |
}

PipelineFlushed -> SegmentsReloaded: {
  label: |md
    **Action:** Load all data segment registers
    
    **Guard:** CS already reloaded by far jump
    
    **Sequence:** DS → ES → FS → GS → SS
  |
}

SegmentsReloaded -> ProtectedMode: {
  label: |md
    **Action:** None (state achieved)
    
    **Guard:** All segment selectors valid
    
    **Result:** Full 32-bit protected mode
  |
}

# Illegal Transitions
RealMode -> ProtectedMode: {
  style: {
    stroke: "#D32F2F"
    stroke-dash: 5
    font-color: "#D32F2F"
  }
  label: |md
    **ILLEGAL: MISSING STEPS**
    
    - No GDT loaded → #GP on any segment access
    - No PE bit set → Still in real mode
    - No pipeline flush → Executes garbage
  |
}

CR0Set -> ProtectedMode: {
  style: {
    stroke: "#D32F2F"
    stroke-dash: 5
    font-color: "#D32F2F"
  }
  label: |md
    **ILLEGAL: TRIPLE FAULT RISK**
    
    Pipeline contains 16-bit code
    Segments still have real-mode base values
    Any memory access uses wrong addressing
  |
}

GDTLoaded -> SegmentsReloaded: {
  style: {
    stroke: "#D32F2F"
    stroke-dash: 5
    font-color: "#D32F2F"
  }
  label: |md
    **ILLEGAL: WRONG ORDER**
    
    PE bit not set → CPU still in real mode
    Protected mode selectors in real mode = unpredictable behavior
  |
}

RealMode -> CR0Set: {
  style: {
    stroke: "#D32F2F"
    stroke-dash: 5
    font-color: "#D32F2F"
  }
  label: |md
    **ILLEGAL: #GP FAULT**
    
    Setting PE without GDT causes immediate fault on next segment access
    IDT not set up → triple fault
  |
}

PipelineFlushed -> CR0Set: {
  style: {
    stroke: "#D32F2F"
    stroke-dash: 5
    font-color: "#D32F2F"
  }
  label: |md
    **ILLEGAL: WRONG ORDER**
    
    Cannot go backwards
    Pipeline already flushed
    CS already loaded with protected selector
  |
}

# State Invariants Box
invariants: State Invariants {
  near: bottom-right
  style: {
    fill: "#FFF3E0"
    stroke: "#FF9800"
    border-radius: 8
  }

  real_mode_inv: |md
    **Real Mode Invariants:**
    - CR0.PE = 0
    - Segments: base=selector×16
    - 20-bit addresses (A0-A19)
    - No privilege checks
  |
  
  protected_inv: |md
    **Protected Mode Invariants:**
    - CR0.PE = 1
    - Segments: base from GDT entry
    - 32-bit addresses (A0-A31)
    - Privilege levels (CPL/DPL/RPL)
    - Segment limit checking
  |
}

# Error State
error: {
  label: "#GP / Triple Fault"
  shape: circle
  style: {
    fill: "#FFCDD2"
    stroke: "#D32F2F"
    font-color: "#B71C1C"
  }
  near: bottom-left
}

RealMode -> error: {
  style.stroke: "#D32F2F"
  label: |md
    **Trigger:** `lgdt` with null pointer
    
    **Result:** #GP with no IDT → Triple Fault → Reset
  |
}

CR0Set -> error: {
  style.stroke: "#D32F2F"
  label: |md
    **Trigger:** Continue execution linearly
    
    **Result:** Pipeline has mixed 16/32-bit code → #UD or #GP
  |
}