direction: right

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Ring 3 → Ring 0 Transition: Stack Switch via TSS
| {near: top-center}

before: {
  label: "BEFORE: User Mode Execution"
  style: {
    fill: "#E8F4FD"
    stroke: "#2196F3"
    stroke-width: 2
    border-radius: 8
  }

  user_stack: {
    label: "User Stack (SS=0x23)"
    style: {
      fill: "#BBDEFB"
      stroke: "#1976D2"
      border-radius: 4
    }
    
    us_high: |md
      0xBFFFFFFC
    |
    
    us_local1: "local_var_1: 0x12345678"
    us_local2: "local_var_2: 0xDEADBEEF"
    us_ret: "return_addr (to user code)"
    us_ebp: "saved EBP"
    
    us_esp: |md
      **ESP = 0xBFFFF000** ◄── ESP3
    | {
      style: {
        fill: "#FF5722"
        font-color: white
        bold: true
      }
    }
    
    us_low: |md
      0xBFFFF000
    |
  }

  tss_state: {
    label: "TSS (Task State Segment)"
    style: {
      fill: "#E1BEE7"
      stroke: "#7B1FA2"
      border-radius: 4
    }
    
    tss_ss0: "SS0: 0x10 (kernel data)"
    tss_esp0: |md
      **ESP0: 0x0010FFF0** ◄── Kernel stack top
    | {
      style: {
        fill: "#9C27B0"
        font-color: white
        bold: true
      }
    }
  }

  cpu_state: {
    label: "CPU State"
    style: {
      fill: "#C8E6C9"
      stroke: "#388E3C"
      border-radius: 4
    }
    
    cs_reg: "CS: 0x1B (CPL=3, GDT index 3)"
    ss_reg: "SS: 0x23 (user data segment)"
    cpl: "CPL: 3 (User Mode)"
  }
}

trigger: {
  label: |md
    **INT 0x80** (syscall)
    
    CPU detects:
    • Gate DPL ≥ CPL ✓
    • Target CS DPL < CPL
    • Privilege escalation required
  |
  style: {
    fill: "#FFEB3B"
    stroke: "#F57C00"
    stroke-width: 3
    bold: true
  }
}

after: {
  label: "AFTER: Kernel Mode (in syscall handler)"
  style: {
    fill: "#FFECB3"
    stroke: "#FF9800"
    stroke-width: 2
    border-radius: 8
  }

  kernel_stack: {
    label: "Kernel Stack (SS=0x10)"
    style: {
      fill: "#FFE0B2"
      stroke: "#E65100"
      border-radius: 4
    }
    
    ks_high: |md
      0x0010FFF0 ◄── TSS.ESP0
    |
    
    ks_ss: |md
      **SS: 0x23** (CPU pushed)
    | {
      style: {
        fill: "#FF5722"
        font-color: white
        bold: true
      }
    }
    ks_esp: |md
      **ESP: 0xBFFFF000** (CPU pushed)
    | {
      style: {
        fill: "#FF5722"
        font-color: white
        bold: true
      }
    }
    ks_eflags: "EFLAGS (with IOPL=0)"
    ks_cs: "CS: 0x08 (kernel code)"
    ks_eip: "EIP: return to user code"
    
    ks_padding: |md
      ─────────────────────
    |
    
    ks_handler: "handler_pushed_ebp: ..."
    ks_handler2: "handler_pushed_ebx: ..."
    ks_handler3: "handler_saved_esi: ..."
    
    ks_esp_now: |md
      **ESP = 0x0010FFD0** ◄── current
    | {
      style: {
        fill: "#4CAF50"
        font-color: white
        bold: true
      }
    }
    
    ks_low: |md
      0x0010F000
    |
  }

  tss_updated: {
    label: "TSS (unchanged)"
    style: {
      fill: "#E1BEE7"
      stroke: "#7B1FA2"
      border-radius: 4
    }
    
    tss_ss0_2: "SS0: 0x10"
    tss_esp0_2: "ESP0: 0x0010FFF0"
  }

  cpu_updated: {
    label: "CPU State (updated)"
    style: {
      fill: "#C8E6C9"
      stroke: "#388E3C"
      border-radius: 4
    }
    
    cs_updated: |md
      **CS: 0x08 (CPL=0)** 
    | {style.bold: true}
    ss_updated: |md
      **SS: 0x10 (kernel data)**
    | {style.bold: true}
    cpl_updated: |md
      **CPL: 0 (Kernel Mode)**
    | {style.bold: true}
  }
}

before -> trigger: "syscall\nrequest"
trigger -> after: "CPU performs\nstack switch"

arrow_annotation: |md
  ## Stack Switch Sequence:
  
  1. **CPU reads TSS.ESP0** → New ESP = 0x0010FFF0
  2. **CPU reads TSS.SS0** → New SS = 0x10
  3. **CPU pushes to NEW stack** (SS, ESP, EFLAGS, CS, EIP)
  4. **CPU loads CS:EIP** from IDT gate (kernel handler)
  5. **Handler pushes** callee-saved registers
  
  Total frame: **20 bytes** (5 × 4-byte values)
  Handler adds: **12-20 bytes** more
| {near: bottom-center}

note_alignment: |md
  Stack after INT 0x80:
  
  0x0010FFF0:  SS    = 0x23
  0x0010FFEC:  ESP   = 0xBFFFF000
  0x0010FFE8:  EFLAGS
  0x0010FFE4:  CS    = 0x08
  0x0010FFE0:  EIP   = user_eip
  0x0010FFDC:  EBP   (handler pushed)
  0x0010FFD8:  EBX   (handler pushed)
  0x0010FFD4:  ESI   (handler pushed)
  0x0010FFD0:  EDI   (handler pushed)
  
  ESP → 0x0010FFD0
| {near: bottom-right}