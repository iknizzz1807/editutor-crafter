vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Round-Robin Ready Queue
  ## Doubly-linked list of PCBs with timer-driven rotation
| {near: top-center}

direction: right

classes: {
  pcb: {
    shape: rectangle
    style: {
      fill: "#E8F4FD"
      stroke: "#2563EB"
      stroke-width: 2
      border-radius: 4
    }
  }
  pcb_current: {
    shape: rectangle
    style: {
      fill: "#FEE2E2"
      stroke: "#DC2626"
      stroke-width: 3
      border-radius: 4
      bold: true
    }
  }
  pointer: {
    shape: diamond
    width: 60
    style: {
      fill: "#FCD34D"
      stroke: "#B45309"
      stroke-width: 2
    }
  }
  arrow_style: {
    style: {
      stroke-width: 2
      animated: true
    }
  }
  next_ptr: {
    style: {
      stroke: "#22C55E"
      stroke-width: 2
    }
  }
  prev_ptr: {
    style: {
      stroke: "#A855F7"
      stroke-width: 2
      stroke-dash: 4
    }
  }
}

legend: {
  near: top-right
  label: "Legend"
  next: "next →" {
    class: next_ptr
    shape: text
    style.font-size: 14
  }
  prev: "← prev" {
    class: prev_ptr
    shape: text
    style.font-size: 14
  }
  running: "RUNNING" {
    class: pcb_current
    shape: text
    style.font-size: 14
  }
  ready: "READY" {
    class: pcb
    shape: text
    style.font-size: 14
  }
}

running_ptr: "running" {
  class: pointer
}

timer: |md
  **Timer Tick**
  `scheduler_tick()`
| {
  shape: rectangle
  style: {
    fill: "#DBEAFE"
    stroke: "#1D4ED8"
    stroke-width: 2
    border-radius: 6
  }
}

pcb1: "PCB[1]\npid=1\nstate=RUNNING\npriority=0\nquantum=10\nticks=8" {
  class: pcb_current
  width: 140
}

pcb2: "PCB[2]\npid=2\nstate=READY\npriority=0\nquantum=10\nticks=0" {
  class: pcb
  width: 140
}

pcb3: "PCB[3]\npid=3\nstate=READY\npriority=0\nquantum=10\nticks=0" {
  class: pcb
  width: 140
}

pcb4: "PCB[4]\npid=4\nstate=READY\npriority=0\nquantum=10\nticks=0" {
  class: pcb
  width: 140
}

running_ptr -> pcb1: "current" {
  style: {
    stroke: "#B45309"
    stroke-width: 2
  }
}

timer -> pcb1: "ticks++\nif (ticks >= quantum)\n  schedule()" {
  style: {
    stroke: "#1D4ED8"
    stroke-dash: 3
  }
}

pcb1 -> pcb2: "next" {class: next_ptr}
pcb2 -> pcb3: "next" {class: next_ptr}
pcb3 -> pcb4: "next" {class: next_ptr}
pcb4 -> pcb1: "next" {class: next_ptr}

pcb1 <- pcb2: "prev" {class: prev_ptr}
pcb2 <- pcb3: "prev" {class: prev_ptr}
pcb3 <- pcb4: "prev" {class: prev_ptr}
pcb4 <- pcb1: "prev" {class: prev_ptr}

rotation: |md
  **Rotation on Quantum Expiry:**
  1. current->state = READY
  2. current->ticks = 0
  3. current = current->next
  4. current->state = RUNNING
  5. context_switch(current)
| {
  near: bottom-center
  shape: rectangle
  style: {
    fill: "#FEF3C7"
    stroke: "#B45309"
    border-radius: 6
    stroke-width: 2
  }
}

data_structure: |md
  c
  struct pcb {
    int pid;
    enum { READY, RUNNING, BLOCKED, ZOMBIE } state;
    int priority;
    int quantum;
    int ticks;
    struct pcb *prev;
    struct pcb *next;
    // ... registers, stacks, etc.
  };
  
  struct pcb *running = NULL;
  
| {
  near: center-left
  shape: rectangle
  style: {
    fill: "#F3F4F6"
    stroke: "#6B7280"
    border-radius: 4
    font: mono
  }
}