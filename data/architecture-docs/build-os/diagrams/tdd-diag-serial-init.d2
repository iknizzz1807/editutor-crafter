vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

title: |md
  # Serial Port Initialization Sequence
  COM1 Base: 0x3F8
| {near: top-center}

# Step containers showing register state progression
step1: "Step 1: Disable Interrupts" {
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  style.border-radius: 4
  
  reg1: IER (0x3F9) {
    shape: rectangle
    style.fill: "#FFE4B5"
    style.stroke: "#D2691E"
    width: 120
    
    ier_bits: |md
      
      ┌─────────────────────┐
      │ 7 6 5 4 3 2 1 0     │
      ├─────────────────────┤
      │ X X X X X X X 0     │
      │         │ │ │ │     │
      │         │ │ │ └─ 0: RX int disabled
      │         │ │ └─── 0: TX int disabled
      │         │ └───── 0: Line stat disabled
      │         └─────── 0: Modem stat disabled
      └─────────────────────┘
      Value: 0x00
      
    |
  }
}

code1: |md
  c
  outb(0x00, 0x3F9);  // IER
  
|

step2: "Step 2: Enable DLAB" {
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  style.border-radius: 4
  
  reg2: LCR (0x3FB) {
    shape: rectangle
    style.fill: "#E6E6FA"
    style.stroke: "#9370DB"
    width: 120
    
    lcr_bits: |md
      
      ┌─────────────────────┐
      │ 7 6 5 4 3 2 1 0     │
      ├─────────────────────┤
      │ 1 X X X X X X X     │
      │ │                   │
      │ └─ 1: DLAB enabled  │
      │    (access divisor) │
      └─────────────────────┘
      Value: 0x80
      
    |
  }
}

code2: |md
  c
  outb(0x80, 0x3FB);  // LCR
  
|

step3: "Step 3: Set Baud Rate (115200)" {
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  style.border-radius: 4
  
  reg3a: DLL (0x3F8) {
    shape: rectangle
    style.fill: "#98FB98"
    style.stroke: "#228B22"
    width: 120
    
    dll_bits: |md
      
      ┌─────────────────────┐
      │ Divisor Low Byte    │
      ├─────────────────────┤
      │ 115200 baud:        │
      │ 115200 / 115200 = 1 │
      │                     │
      │ 7 6 5 4 3 2 1 0     │
      │ 0 0 0 0 0 0 0 1     │
      └─────────────────────┘
      Value: 0x01
      
    |
  }
  
  reg3b: DLH (0x3F9) {
    shape: rectangle
    style.fill: "#98FB98"
    style.stroke: "#228B22"
    width: 120
    
    dlh_bits: |md
      
      ┌─────────────────────┐
      │ Divisor High Byte   │
      ├─────────────────────┤
      │ 115200 baud:        │
      │                     │
      │ 7 6 5 4 3 2 1 0     │
      │ 0 0 0 0 0 0 0 0     │
      └─────────────────────┘
      Value: 0x00
      
    |
  }
  
  reg3a -> reg3b: "DLAB=1\nmaps ports"
}

code3: |md
  c
  outb(0x01, 0x3F8);  // DLL (divisor low)
  outb(0x00, 0x3F9);  // DLH (divisor high)
  
|

step4: "Step 4: Configure Line (8N1)" {
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  style.border-radius: 4
  
  reg4: LCR (0x3FB) {
    shape: rectangle
    style.fill: "#87CEEB"
    style.stroke: "#4169E1"
    width: 120
    
    lcr_bits2: |md
      
      ┌─────────────────────┐
      │ 7 6 5 4 3 2 1 0     │
      ├─────────────────────┤
      │ 0 0 0 0 0 0 1 1     │
      │         │ │ │ │     │
      │         │ │ │ └─ 11: 8 data bits
      │         │ │ └─── 0: 1 stop bit
      │         │ └───── 0: no parity
      │         └─────── 0: DLAB off
      └─────────────────────┘
      Value: 0x03
      
    |
  }
}

code4: |md
  c
  outb(0x03, 0x3FB);  // LCR: 8N1
  
|

step5: "Step 5: Enable FIFO" {
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  style.border-radius: 4
  
  reg5: FCR (0x3FA) {
    shape: rectangle
    style.fill: "#DDA0DD"
    style.stroke: "#9932CC"
    width: 120
    
    fcr_bits: |md
      
      ┌─────────────────────┐
      │ 7 6 5 4 3 2 1 0     │
      ├─────────────────────┤
      │ 1 1 X X X 0 1 1     │
      │ │ │           │ │   │
      │ │ │           │ └─ 1: Enable FIFO
      │ │ │           └─── 1: Clear RX FIFO
      │ │ └─────────────── 0: No 64B mode
      │ └───────────────── 11: 14-byte trigger
      └─────────────────────┘
      Value: 0xC7
      
    |
  }
}

code5: |md
  c
  outb(0xC7, 0x3FA);  // FCR
  
|

step6: "Step 6: Enable Interrupts" {
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
  style.border-radius: 4
  
  reg6: IER (0x3F9) {
    shape: rectangle
    style.fill: "#F0E68C"
    style.stroke: "#BDB76B"
    width: 120
    
    ier_bits2: |md
      
      ┌─────────────────────┐
      │ 7 6 5 4 3 2 1 0     │
      ├─────────────────────┤
      │ X X X X X 0 0 1     │
      │             │   │   │
      │             │   └─ 1: RX int enabled
      │             └───── 0: TX int disabled
      │                 0: Line stat disabled
      └─────────────────────┘
      Value: 0x01
      
    |
  }
}

code6: |md
  c
  outb(0x01, 0x3F9);  // IER
  
|

# Flow arrows between steps
step1 -> step2: {
  style.stroke: "#333333"
  style.stroke-width: 2
  label: "DLAB\nsetup"
}
step2 -> step3: {
  style.stroke: "#333333"
  style.stroke-width: 2
  label: "Set\ndivisor"
}
step3 -> step4: {
  style.stroke: "#333333"
  style.stroke-width: 2
  label: "Line\nconfig"
}
step4 -> step5: {
  style.stroke: "#333333"
  style.stroke-width: 2
  label: "FIFO\nsetup"
}
step5 -> step6: {
  style.stroke: "#333333"
  style.stroke-width: 2
  label: "Enable\nIRQ4"
}

# Register map reference
register_map: "COM1 Register Map (Base: 0x3F8)" {
  style.fill: "#F5F5F5"
  style.stroke: "#CCCCCC"
  
  map: |md
    
    Offset  DLAB=0     DLAB=1    Read/Write
    ───────────────────────────────────────
    +0      DATA       DLL       R/W
    +1      IER        DLH       R/W
    +2      IIR        FCR       R (IIR) / W (FCR)
    +3      LCR        LCR       R/W
    +4      MCR        MCR       R/W
    +5      LSR        LSR       R
    +6      MSR        MSR       R
    +7      SCR        SCR       R/W
    
    IRQ Line: COM1 → IRQ4 → IDT Vector 36 (0x24)
    
|
}

# Timing annotation
timing: |md
  **Timing Constraints:**
  - 8 transmit clocks per byte at 115200 baud
  - ~87 µs per character transmission
  - FIFO fills at 14-byte threshold triggers interrupt
| {near: center-right}