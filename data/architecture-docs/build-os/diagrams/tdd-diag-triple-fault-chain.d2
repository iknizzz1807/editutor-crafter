vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Triple Fault Cause Chain
| {near: top-center}

direction: down

step1: "1. First Exception" {
  style.fill: "#E8D5E0"
  style.stroke: "#8B4789"
  
  cause1: |md
    **Trigger**: Invalid opcode, page fault, GPF, etc.
    
    CPU actions:
    - Push SS, ESP, EFLAGS, CS, EIP to stack
    - Look up IDT entry
    - Load handler CS:EIP
  |
}

step1_arrow: step1 -> step2a: "Handler invoked" {
  style.stroke: "#8B4789"
  style.stroke-width: 2
}

step2a: "2A. Handler Executes Normally" {
  style.fill: "#D4EDDA"
  style.stroke: "#28A745"
  
  normal: |md
    **Success path**:
    - Handler runs with interrupts disabled
    - Saves context, handles exception
    - `iret` returns to interrupted code
    
    → **System continues**
  |
}

step2b: "2B. Handler Crashes" {
  style.fill: "#F8D7DA"
  style.stroke: "#DC3545"
  style.bold: true
  
  crash: |md
    **Handler fault causes**:
    - Stack corruption (bad SS:ESP)
    - Page fault on handler code
    - Invalid IDT entry (selector not in GDT)
    - Handler accesses unmapped memory
  |
}

step1_to_crash: step1 -> step2b: "Handler faults" {
  style.stroke: "#DC3545"
  style.stroke-width: 3
  style.animated: true
}

step2b_arrow: step2b -> step3: "CPU raises Double Fault (INT 0x08)" {
  style.stroke: "#DC3545"
  style.stroke-width: 3
  style.animated: true
}

step3: "3. Double Fault (INT 0x08)" {
  style.fill: "#FFF3CD"
  style.stroke: "#856404"
  style.bold: true
  
  double: |md
    **Exception 0x08 - Double Fault**
    
    Triggered when:
    - First exception handler causes another exception
    - Stack switch fails during first exception
    - IDT entry for first exception is invalid
    
    CPU actions:
    - Push error code = 0
    - Load INT 0x08 handler
  |
}

step3_to_step4a: step3 -> step4a: "Double fault handler OK" {
  style.stroke: "#28A745"
  style.stroke-dash: 3
}

step4a: "4A. Recovery Possible" {
  style.fill: "#D4EDDA"
  style.stroke: "#28A745"
  
  recover: |md
    **If double fault handler exists**:
    - Dump CPU state
    - Kill offending process
    - Continue with other processes
    
    → **Kernel survives**
  |
}

step3_to_step4b: step3 -> step4b: "Double fault handler crashes" {
  style.stroke: "#DC3545"
  style.stroke-width: 3
  style.animated: true
}

step4b: "4B. Handler Crashes Again" {
  style.fill: "#F8D7DA"
  style.stroke: "#DC3545"
  style.bold: true
  
  crash2: |md
    **Double fault handler faults**:
    - Kernel stack overflow
    - Corrupted TSS (SS0:ESP0 invalid)
    - Double fault IDT entry invalid
    - Memory corruption in handler
  |
}

step4b_arrow: step4b -> step5: "CPU raises Triple Fault" {
  style.stroke: "#722C4C"
  style.stroke-width: 4
  style.animated: true
}

step5: "5. TRIPLE FAULT → CPU RESET" {
  style.fill: "#722C4C"
  style.stroke: "#4A1730"
  style.font-color: white
  style.bold: true
  
  triple: |md
    **CATASTROPHIC FAILURE**
    
    CPU has no valid handler to invoke:
    - No further exception mechanism
    - No stack to push state to
    - No code path to execute
    
    **Result**: CPU enters shutdown state
  |
}

step5_arrow: step5 -> step6: "" {
  style.stroke: "#4A1730"
  style.stroke-width: 4
}

step6: "6. System Reset" {
  style.fill: "#2C2C2C"
  style.font-color: white
  style.stroke: "#1A1A1A"
  
  reset: |md
    **CPU triggers RESET**:
    
    On real hardware:
    - CPU asserts RESET# pin
    - All registers cleared
    - Execution begins at 0xFFFFFFF0
    
    In emulator (QEMU/Bochs):
    - Triple fault detected
    - CPU halts or reboots
    - Debug output shows "Triple fault"
  |
}

legend: {
  near: bottom-right
  
  legend_title: "Fault Cascade Legend"
  
  normal_path: "Normal execution" {
    style.fill: "#D4EDDA"
    style.stroke: "#28A745"
  }
  
  fault_path: "Exception raised" {
    style.fill: "#E8D5E0"
    style.stroke: "#8B4789"
  }
  
  crash_path: "Handler crash" {
    style.fill: "#F8D7DA"
    style.stroke: "#DC3545"
  }
  
  fatal: "Triple fault (fatal)" {
    style.fill: "#722C4C"
    style.font-color: white
    style.stroke: "#4A1730"
  }
}

prevention: {
  near: bottom-left
  style.fill: "#E8F4FD"
  style.stroke: "#0066CC"
  
  tips: |md
    ## Prevention Strategies
    
    1. **Valid IDT**: All 256 entries must have valid handlers
    2. **Valid TSS**: SS0:ESP0 must point to valid kernel stack
    3. **Kernel Stack Guard**: Detect overflow before crash
    4. **Double Fault Handler**: Must be bulletproof (use separate stack)
    5. **ISR Validation**: Test all exception handlers
  |
}