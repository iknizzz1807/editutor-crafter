vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # User vs Kernel Address Space Layout
  Per-process page directories with kernel mapping at 0xC0000000+
| {near: top-center}

direction: right

user_process: "User Process (PID: N)" {
  style.fill: "#E8F4FD"
  style.stroke: "#4A90D9"
  style.stroke-width: 2
  
  user_space: |md
    ## User Space (Ring 3)
    **0x00000000 - 0xBFFFFFFF**
    
    - Per-process virtual addresses
    - User-mode accessible (U/S=1)
    - Each process has isolated mapping
    - Code, Data, Heap, Stack
    
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ 0xBFFFFFFF  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
    ‚îÇ             User Stack (‚Üì)          ‚îÇ
    ‚îÇ             ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
    ‚îÇ             (unmapped guard page)   ‚îÇ
    ‚îÇ             ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
    ‚îÇ             mmap() region           ‚îÇ
    ‚îÇ             ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
    ‚îÇ             Heap (‚Üë)                ‚îÇ
    ‚îÇ             ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
    ‚îÇ             .bss                    ‚îÇ
    ‚îÇ             .data                   ‚îÇ
    ‚îÇ             .text (ELF)             ‚îÇ
    ‚îÇ 0x08048000  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
    ‚îÇ 0x00000000  (NULL - unmapped)       ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  | {
    style.fill: "#D4EDFC"
    style.stroke: "#4A90D9"
  }
  
  kernel_space: |md
    ## Kernel Space (Ring 0)
    **0xC0000000 - 0xFFFFFFFF**
    
    - Identical mapping in ALL processes
    - Supervisor-only (U/S=0)
    - Shared across all page directories
    
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ 0xFFFFFFFF  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
    ‚îÇ 4GB - 4KB   Reserved                ‚îÇ
    ‚îÇ             ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
    ‚îÇ             Device MMIO             ‚îÇ
    ‚îÇ             ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
    ‚îÇ 0xFFC00000  Page Tables            ‚îÇ
    ‚îÇ             (recursive mapping)     ‚îÇ
    ‚îÇ             ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
    ‚îÇ 0xE0000000  Kernel Heap            ‚îÇ
    ‚îÇ             ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
    ‚îÇ 0xC0100000  Kernel Code (.text)    ‚îÇ
    ‚îÇ 0xC0000000  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  | {
    style.fill: "#F0E6F6"
    style.stroke: "#8B5CF6"
  }
}

page_directory: "Page Directory Entry Layout" {
  style.fill: "#FFF3E0"
  style.stroke: "#FF9800"
  style.stroke-width: 2
  
  pde_table: {
    shape: sql_table
    label: "Page Directory (CR3)"
    
    "Index": "Address Range"
    "0x000": "0x00000000-0x003FFFFF {constraint: primary_key}"
    "0x001": "0x00400000-0x007FFFFF"
    "0x002": "0x00800000-0x00BFFFFF"
    "...": "..."
    "0x2FF": "0xBFC00000-0xBFFFFFFF"
    "0x300": "0xC0000000-0xC03FFFFF {constraint: foreign_key}"
    "0x301": "0xC0400000-0xC07FFFFF"
    "...": "..."
    "0x3FF": "0xFFC00000-0xFFFFFFFF"
  }
}

page_directory_legend: |md
  **Entry Types:**
  - üü¶ **User entries (0x000-0x2FF)**: Per-process, U/S=1
  - üü£ **Kernel entries (0x300-0x3FF)**: Shared, U/S=0
  - Total: 1024 entries √ó 4MB = 4GB
| {near: bottom-center}

pde_format: "PDE Format (4 bytes)" {
  style.fill: "#E8F5E9"
  style.stroke: "#4CAF50"
  
  bits: |md
    
    Bit 31    12 11     9 8   7 6   5 4   3 2   1 0
    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    ‚îÇ Page    ‚îÇ Avail   ‚îÇ G   ‚îÇ PS  ‚îÇ A   ‚îÇ PCD ‚îÇ     ‚îÇ
    ‚îÇ Table   ‚îÇ         ‚îÇ     ‚îÇ     ‚îÇ     ‚îÇ PWT ‚îÇ U/S ‚îÇ P ‚îÇ
    ‚îÇ Addr    ‚îÇ         ‚îÇ     ‚îÇ     ‚îÇ     ‚îÇ     ‚îÇ     ‚îÇ
    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    ‚îÇ 31-12: Page Table Base Address (4KB aligned)   ‚îÇ
    ‚îÇ 8: G - Global (ignored if CR4.PGE=0)           ‚îÇ
    ‚îÇ 7: PS - Page Size (0=4KB, 1=4MB)               ‚îÇ
    ‚îÇ 6: A - Accessed                                ‚îÇ
    ‚îÇ 5,4: PCD/PWT - Cache controls                  ‚îÇ
    ‚îÇ 3: U/S - User/Supervisor (0=Ring0, 1=Ring3)    ‚îÇ
    ‚îÇ 2: R/W - Read/Write (0=RO, 1=RW)               ‚îÇ
    ‚îÇ 1: P - Present (1=mapped)                      ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    
  | {shape: rectangle}
}

process_isolation: "Process Isolation Guarantee" {
  style.fill: "#FFF8E1"
  style.stroke: "#FFC107"
  
  proc_a: "Process A" {
    style.fill: "#BBDEFB"
    
    pd_a: "PD_A" {
      shape: cylinder
      style.fill: "#90CAF9"
    }
    pd_a -> user_a: "maps\n0x0-0xBFFF"
    user_a: "User Space A\n(code, data, heap)" {
      style.fill: "#64B5F6"
    }
    pd_a -> kernel_shared: "maps\n0xC0000000+"
  }
  
  proc_b: "Process B" {
    style.fill: "#C8E6C9"
    
    pd_b: "PD_B" {
      shape: cylinder
      style.fill: "#81C784"
    }
    pd_b -> user_b: "maps\n0x0-0xBFFF"
    user_b: "User Space B\n(completely different)" {
      style.fill: "#66BB6A"
    }
    pd_b -> kernel_shared: "maps\n0xC0000000+"
  }
  
  kernel_shared: "Kernel (Shared)" {
    style.fill: "#E1BEE7"
    style.stroke: "#9C27B0"
    style.stroke-width: 3
    
    shared_desc: |md
      **Identical in ALL page directories**
      
      - Kernel code at 0xC0100000
      - Kernel heap at 0xE0000000
      - Page tables at 0xFFC00000
      - Supervisor-only (U/S=0)
      - CR3 reload preserves kernel mapping
    |
  }
}

memory_regions: "Critical Memory Regions" {
  grid-columns: 2
  grid-gap: 0
  
  header1: "Address" {
    style.fill: "#3F51B5"
    style.font-color: white
    style.bold: true
  }
  header2: "Description" {
    style.fill: "#3F51B5"
    style.font-color: white
    style.bold: true
  }
  
  addr_null: "0x00000000" {style.fill: "#FFCDD2"}
  desc_null: "NULL pointer (unmapped)" {style.fill: "#FFCDD2"}
  
  addr_text: "0x08048000" {style.fill: "#C8E6C9"}
  desc_text: "ELF .text load address" {style.fill: "#C8E6C9"}
  
  addr_user_end: "0xBFFFFFFF" {style.fill: "#BBDEFB"}
  desc_user_end: "User space upper bound" {style.fill: "#BBDEFB"}
  
  addr_kernel: "0xC0000000" {style.fill: "#E1BEE7"}
  desc_kernel: "Kernel base (3GB mark)" {style.fill: "#E1BEE7"}
  
  addr_kcode: "0xC0100000" {style.fill: "#E1BEE7"}
  desc_kcode: "Kernel code entry" {style.fill: "#E1BEE7"}
  
  addr_kheap: "0xE0000000" {style.fill: "#E1BEE7"}
  desc_kheap: "Kernel heap (kmalloc)" {style.fill: "#E1BEE7"}
  
  addr_pt: "0xFFC00000" {style.fill: "#FFE0B2"}
  desc_pt: "Recursive page tables" {style.fill: "#FFE0B2"}
  
  addr_end: "0xFFFFFFFF" {style.fill: "#FFCCBC"}
  desc_end: "End of 32-bit address space" {style.fill: "#FFCCBC"}
}

protection_check: "Protection Mechanism" {
  style.fill: "#FCE4EC"
  style.stroke: "#E91E63"
  
  user_access: |md
    ### User Code Accessing 0x12345678 ‚úÖ
    
    CPL = 3 (Current Privilege Level)
    PDE[0x48].U/S = 1 (User accessible)
    PTE[0x345].U/S = 1 (User accessible)
    ‚Üí Access PERMITTED
    
  | {style.fill: "#C8E6C9"}
  
  kernel_access: |md
    ### User Code Accessing 0xC0100000 ‚ùå
    
    CPL = 3 (Current Privilege Level)
    PDE[0x300].U/S = 0 (Supervisor only)
    ‚Üí Page Fault (#PF)
    ‚Üí Error Code: P=1, U/S=1 (user access to supervisor page)
    
  | {style.fill: "#FFCDD2"}
  
  kernel_ok: |md
    ### Kernel Code Accessing 0xC0100000 ‚úÖ
    
    CPL = 0 (Current Privilege Level)
    PDE[0x300].U/S = 0 (Supervisor only)
    ‚Üí Access PERMITTED (CPL ‚â§ U/S)
    
  | {style.fill: "#C8E6C9"}
}

size_annotation: |md
  **sizeof(Page Directory) = 4096 bytes (one page)**
  **1024 entries √ó 4 bytes each = 4096 bytes**
| {near: bottom-center}