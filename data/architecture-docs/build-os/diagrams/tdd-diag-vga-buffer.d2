vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # VGA Text Buffer Memory Layout
  **Address: 0xB8000 | Size: 4000 bytes (80x25x2)**
| {
  near: top-center
}

direction: right

buffer_overview: {
  label: "VGA Text Buffer\n0xB8000 - 0xB8FA0"
  style.fill: "#E8E4F0"
  style.stroke: "#6B5B95"
  style.stroke-width: 2
  
  cell_0: {
    label: "Cell[0,0]"
    style.fill: "#B8D4E3"
    style.stroke: "#4A90A4"
  }
  cell_1: {
    label: "Cell[0,1]"
    style.fill: "#B8D4E3"
    style.stroke: "#4A90A4"
  }
  cell_dots: {
    label: "..."
    style.fill: transparent
    style.stroke: transparent
  }
  cell_79: {
    label: "Cell[0,79]"
    style.fill: "#B8D4E3"
    style.stroke: "#4A90A4"
  }
  cell_80: {
    label: "Cell[1,0]"
    style.fill: "#F5E6D3"
    style.stroke: "#C4956A"
  }
  cell_dots2: {
    label: "..."
    style.fill: transparent
    style.stroke: transparent
  }
  cell_end: {
    label: "Cell[24,79]"
    style.fill: "#D4EDDA"
    style.stroke: "#5A8F5A"
  }
}

cell_detail: {
  label: "Cell Structure (2 bytes)"
  style.fill: "#FFF8E7"
  style.stroke: "#D4A574"
  style.stroke-width: 2
  
  offset_0: |md
    **Offset +0**
    Character Byte
    
    ASCII code (0-127)
    or extended (128-255)
    
    Example: 'A' = 0x41
  |
  offset_0.style.fill: "#C5CAE9"
  offset_0.style.stroke: "#3F51B5"
  
  offset_1: |md
    **Offset +1**
    Attribute Byte
    
    Bits 0-3: Foreground
    Bits 4-6: Background
    Bit 7: Blink/Intensity
  |
  offset_1.style.fill: "#FFCCBC"
  offset_1.style.stroke: "#E64A19"
}

attribute_byte: {
  label: "Attribute Byte Breakdown"
  style.fill: "#F0F4F8"
  style.stroke: "#2C3E50"
  style.stroke-width: 2
  
  bits_layout: {
    grid-columns: 8
    grid-gap: 0
    
    b7: {
      label: "7"
      style.fill: "#FFCDD2"
      style.stroke: "#C62828"
    }
    b6: {
      label: "6"
      style.fill: "#C8E6C9"
      style.stroke: "#388E3C"
    }
    b5: {
      label: "5"
      style.fill: "#C8E6C9"
      style.stroke: "#388E3C"
    }
    b4: {
      label: "4"
      style.fill: "#C8E6C9"
      style.stroke: "#388E3C"
    }
    b3: {
      label: "3"
      style.fill: "#BBDEFB"
      style.stroke: "#1976D2"
    }
    b2: {
      label: "2"
      style.fill: "#BBDEFB"
      style.stroke: "#1976D2"
    }
    b1: {
      label: "1"
      style.fill: "#BBDEFB"
      style.stroke: "#1976D2"
    }
    b0: {
      label: "0"
      style.fill: "#BBDEFB"
      style.stroke: "#1976D2"
    }
  }
  
  legend: |md
    **Bit 7**: Blink (or bright bg with mode)
    **Bits 6-4**: Background color (0-7)
    **Bits 3-0**: Foreground color (0-15)
  |
}

color_table: {
  label: "Standard VGA Colors"
  style.fill: "#FAFAFA"
  style.stroke: "#BDBDBD"
  
  grid-columns: 4
  grid-gap: 2
  
  c0: {
    label: "0: Black"
    style.fill: "#000000"
    style.font-color: white
  }
  c1: {
    label: "1: Blue"
    style.fill: "#0000AA"
    style.font-color: white
  }
  c2: {
    label: "2: Green"
    style.fill: "#00AA00"
    style.font-color: white
  }
  c3: {
    label: "3: Cyan"
    style.fill: "#00AAAA"
    style.font-color: white
  }
  c4: {
    label: "4: Red"
    style.fill: "#AA0000"
    style.font-color: white
  }
  c5: {
    label: "5: Magenta"
    style.fill: "#AA00AA"
    style.font-color: white
  }
  c6: {
    label: "6: Brown"
    style.fill: "#AA5500"
    style.font-color: white
  }
  c7: {
    label: "7: L.Gray"
    style.fill: "#AAAAAA"
    style.font-color: black
  }
  c8: {
    label: "8: D.Gray"
    style.fill: "#555555"
    style.font-color: white
  }
  c9: {
    label: "9: L.Blue"
    style.fill: "#5555FF"
    style.font-color: white
  }
  c10: {
    label: "10: L.Green"
    style.fill: "#55FF55"
    style.font-color: black
  }
  c11: {
    label: "11: L.Cyan"
    style.fill: "#55FFFF"
    style.font-color: black
  }
  c12: {
    label: "12: L.Red"
    style.fill: "#FF5555"
    style.font-color: black
  }
  c13: {
    label: "13: L.Magenta"
    style.fill: "#FF55FF"
    style.font-color: black
  }
  c14: {
    label: "14: Yellow"
    style.fill: "#FFFF55"
    style.font-color: black
  }
  c15: {
    label: "15: White"
    style.fill: "#FFFFFF"
    style.font-color: black
  }
}

address_calc: {
  label: "Address Calculation"
  style.fill: "#E3F2FD"
  style.stroke: "#1565C0"
  
  formula: |md
    Cell Address = 0xB8000 + (row x 80 + col) x 2
    
    Example: row=5, col=10
    Address = 0xB8000 + (5 x 80 + 10) x 2
            = 0xB8000 + 820
            = 0xB8334
  |
}

memory_map: {
  label: "Linear Memory View"
  style.fill: "#FFF3E0"
  style.stroke: "#E65100"
  
  grid-columns: 1
  
  row0: {
    label: "Row 0: 0xB8000 - 0xB809F (160 bytes)"
    style.fill: "#B8D4E3"
    style.stroke: "#4A90A4"
  }
  row1: {
    label: "Row 1: 0xB80A0 - 0xB813F (160 bytes)"
    style.fill: "#F5E6D3"
    style.stroke: "#C4956A"
  }
  row_dots: {
    label: "..."
    style.fill: transparent
    style.stroke: transparent
    style.font-size: 24
  }
  row24: {
    label: "Row 24: 0xB8F00 - 0xB8F9F (160 bytes)"
    style.fill: "#D4EDDA"
    style.stroke: "#5A8F5A"
  }
  cursor: {
    label: "Cursor: 0xB8FA0-0xB8FA3 (4 bytes, I/O)"
    style.fill: "#FFCDD2"
    style.stroke: "#C62828"
  }
}

buffer_overview -> cell_detail: "each cell"
cell_detail -> attribute_byte: "byte +1"
attribute_byte -> color_table: "maps to"
buffer_overview -> address_calc: "indexing"
buffer_overview -> memory_map: "layout"

annotation_cache_line: |md
  Cache Line Boundary (64 bytes)
|
annotation_cache_line.near: buffer_overview
annotation_cache_line.style.fill: transparent
annotation_cache_line.style.stroke: transparent
annotation_cache_line.style.font-color: "#888888"

annotation_total: |md
  **Total Size: 4000 bytes**
  80 columns x 25 rows x 2 bytes/cell
  (Last 8 cells unused in 4KB page)
|
annotation_total.near: memory_map
annotation_total.style.fill: "#E8F5E9"
annotation_total.style.stroke: "#4CAF50"