direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- CLASSES & STYLES ---
classes: {
  page_node: {
    style: {
      stroke-width: 2
      border-radius: 4
    }
  }
  header: {
    style: {
      fill: "#E4DBFE" # Purple for Metadata
      bold: true
    }
  }
  cell_ptr: {
    style: {
      fill: "#C7F1FF" # Light Blue for pointers
      font: mono
    }
  }
  payload: {
    style: {
      fill: "#DEE1EB" # Gray for data
    }
  }
  highlight: {
    style: {
      stroke: "#FF7070"
      stroke-width: 4
      animated: true
    }
  }
}

# --- STEP 1: BEFORE SPLIT ---
step_1: "STATE A: Overflow Trigger (Page 5 Full)" {
  page_5: {
    class: page_node
    header: "Page Header (Offsets 0-11)" {
      class: header
      type: "0x0D (Leaf)"
      cells: "Count: 4"
      unallocated: "Gap: 12 bytes"
    }
    
    pointers: "Cell Pointers (Offset 12+)" {
      ptr_0: "Ptr0: 4050"
      ptr_1: "Ptr1: 4000"
      ptr_2: "Ptr2: 3950"
      ptr_3: "Ptr3: 3900"
    }

    content: "Cell Content (Bottom-Up)" {
      cell_0: "Key: 10 | RowID: 1"
      cell_1: "Key: 20 | RowID: 2"
      cell_2: "Key: 30 | RowID: 3"
      cell_3: "Key: 40 | RowID: 4"
    }

    trigger: "INSERT Key: 25" {
      class: highlight
    }
  }
}

# --- STEP 2: THE SPLIT ACTION ---
step_2: "STATE B: Median Selection & Allocation" {
  median_calc: "Split Logic" {
    shape: diamond
    label: "Determine Median\n(Key 25)"
  }

  new_page: "Page 6 (Allocated)" {
    class: page_node
    header: "0x0D (Leaf)" { class: header }
    status: "Empty Frame"
  }
}

# --- STEP 3: AFTER SPLIT ---
step_3: "STATE C: Balanced Result" {
  parent_2: "Page 2 (Parent Internal)" {
    class: page_node
    header: "0x05 (Internal)" { class: header }
    cell_0: "Key: 25 | Left: P5"
    right_ptr: "RightChild: P6"
  }

  page_5_updated: "Page 5 (Left)" {
    class: page_node
    content: {
      c0: "Key: 10"
      c1: "Key: 20"
    }
  }

  page_6_updated: "Page 6 (Right)" {
    class: page_node
    content: {
      c2: "Key: 30"
      c3: "Key: 40"
    }
  }
}

# --- ANNOTATED TRANSITIONS ---
step_1.page_5.trigger -> step_2.median_calc: "1. Payload exceeds unallocated gap"
step_2.median_calc -> step_3.parent_2: "2. Promote Median Key to Parent"
step_2.median_calc -> step_3.page_6_updated: "3. Move upper half of cells"

step_3.parent_2.cell_0 -> step_3.page_5_updated: "B-tree Pointer (Left Child)" {
  style: {
    stroke-dash: 3
  }
}
step_3.parent_2.right_ptr -> step_3.page_6_updated: "B-tree Pointer (Right Child)" {
  style: {
    stroke-dash: 3
  }
}

# --- CONTEXT LINKING ---
back_to_map: "Back to Satellite Map" {
  link: "#l0-satellite-map"
  shape: package
  style.fill: "#F6F9FC"
}

# Documentation block for the engineer
# Fixed: Moved to root and set constant near key
tech_note: |md
  ### Split Mechanics
  - **Type Affinity**: Metadata preserved in 12-byte header.
  - **Pointer Stability**: Slotted page pointers 0-1 are preserved in P5, while 2-3 are re-indexed in P6.
  - **Promotion**: Median key 25 is inserted into Parent Page 2. If P2 is full, recursion triggers a Root Split.
| {
  near: top-right
}