vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- CLASSES ---
classes: {
  barrier: {
    style: {
      stroke: red
      stroke-width: 4
      stroke-dash: 3
      fill: "#fff0f0"
      bold: true
    }
  }
  storage_media: {
    shape: cylinder
    style: {
      fill: "#f3f3f3"
      stroke: "#333333"
    }
  }
  process_node: {
    style: {
      fill: "#e1f5fe"
      stroke: "#01579b"
      border-radius: 5
    }
  }
  metadata: {
    style: {
      fill: "#f3e5f5"
      stroke: "#7b1fa2"
      font-color: "#7b1fa2"
    }
  }
}

# --- GLOBAL LAYOUT ELEMENTS ---
title: "Atomic Write Choreography: The Rollback Journal Protocol" {
  shape: text
  style: {
    font-size: 24
    bold: true
  }
}

back_to_map: "Back to Satellite Map" {
  link: "#anchor-id"
  near: top-left
}

# --- COMPONENTS ---
runtime: Runtime Memory {
  buffer_pool: "Buffer Pool (RAM)" {
    dirty_page_42: "Dirty Page #42\n(New Content)" {
      tooltip: "4096 bytes in RAM waiting for commit"
      style.fill: "#fff9c4"
    }
  }
}

pager: "Pager (Transaction Coordinator)" {
  class: process_node
  fsm: "Atomic Commit FSM" {
    shape: oval
    label: "State: EXCLUSIVE_LOCK"
  }
}

disk: "Physical Storage (Disk)" {
  style.fill: "#fafafa"
  
  journal: "sqlite-journal" {
    class: storage_media
    header: "Journal Header\n(Size, Checksum, Magic)" { class: metadata }
    page_42_old: "Page #42 (Original Image)\n[Offset: 0x2800]" {
      style.fill: "#eeeeee"
    }
  }

  main_db: "database.db" {
    class: storage_media
    header: "DB Header [100 bytes]" { class: metadata }
    page_42_disk: "Page #42 (Current/Torn)\n[Offset: 0xA000]" {
      style.stroke: red
    }
  }
}

# --- THE CHOREOGRAPHY (STEPS) ---

# STEP 1: JOURNALING
runtime.buffer_pool -> pager: "1. COMMIT Request triggered (VFS layer)"
pager -> disk.journal: "2. WRITE Original Image" {
  label: "Copy 4KB from Main DB -> Journal (Undo Log)"
  style: {
    stroke: "#7b1fa2"
    stroke-width: 2
    animated: true
  }
}

# STEP 2: FIRST BARRIER
barrier_1: "CRITICAL BARRIER: fsync(journal)" {
  class: barrier
  near: top-center
}

pager -> barrier_1: "3. Harden Journal" {
  label: "Ensure Undo log is physical before touching Main DB"
}

# STEP 3: MAIN WRITE
pager -> disk.main_db: "4. WRITE Dirty Pages" {
  label: "Overwrite Main DB Page 42 at 0xA000"
  style: {
    stroke: "#01579b"
    stroke-width: 3
  }
}

# STEP 4: SECOND BARRIER
barrier_2: "CRITICAL BARRIER: fsync(db)" {
  class: barrier
  near: bottom-center
}

pager -> barrier_2: "5. Harden Main DB" {
  label: "Ensure B-Tree modifications are permanent on platter"
}

# STEP 5: CLEANUP
pager -> disk.journal: "6. DELETE / TRUNCATE" {
  label: "Atomic Point of No Return: Unlink journal file"
  style: {
    stroke: "#2e7d32"
    bold: true
  }
}

# --- ANNOTATIONS ---
note_durability: |md
  ### The 10-Second Logic
  - **Before Step 5**: Any power failure or crash triggers **Rollback**. The 'Hot Journal' exists on disk and is used to overwrite main DB with original images on next restart.
  - **After Step 5**: Transaction is **Committed**.
  - **The Guard**: If we skip Step 2, a crash during Step 4 results in a **Torn Page** (partial write) with no valid backup in the journal.
| {
  near: center-right
}

# --- SCALE INDICATORS ---
scale: "Scale Reference" {
  near: bottom-right
  page_size: "4096 Bytes (Standard Page)"
  sector_size: "512B (Atomic HDD Sector)"
  page_size -> sector_size: "1 Page = 8 Sectors"
}

# --- STATE EVOLUTION INDICATOR ---
evolution: "State Transition" {
  near: bottom-left
  state_A: "PENDING" {
    style.fill: gray
  }
  state_B: "COMMITTED" {
    style.fill: "#4caf50"
    style.font-color: white
  }
  state_A -> state_B: "fsync() -> unlink()" {
    style.stroke-dash: 5
  }
}