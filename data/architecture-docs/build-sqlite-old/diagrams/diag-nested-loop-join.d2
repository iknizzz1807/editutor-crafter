direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- Classes & Styling ---
classes: {
  page_node: {
    style: {
      stroke-width: 2
      fill: "#f8f9fa"
      border-radius: 4
    }
  }
  hot_path: {
    style: {
      stroke: "#d0021b"
      stroke-width: 4
      animated: true
    }
  }
  register: {
    shape: box
    style: {
      fill: "#eef"
      stroke: "#336"
      font: mono
    }
  }
  metadata: {
    style: {
      fill: "#f3e5f5"
      stroke: "#7b1fa2"
    }
  }
  data_payload: {
    style: {
      fill: "#e3f2fd"
      stroke: "#1976d2"
    }
  }
}

# --- Diagram Header ---
title: |md
  ### NESTED LOOP JOIN (NLJ) EXECUTION TRACE
  **Query:** `SELECT * FROM users JOIN orders ON users.id = orders.user_id`
  **Strategy:** Indexed Nested Loop (Driving: Users)
| {near: top-center}

# --- Outer Loop: Users Table (Table B-Tree) ---
outer_storage: "TABLE: users (Driving Table)" {
  style.fill: "#fff9c4"
  
  users_page_50: "Page #50 (Leaf)" {
    class: page_node
    header: "Header [8b]" {class: metadata}
    ptr_array: "Ptrs [0, 24, 48...]" {class: metadata}
    
    records: {
      row_41: "RowID 41: {name: 'Alice'...}" {class: data_payload}
      row_42: "RowID 42: {name: 'Bob'...}" {
        class: [data_payload; hot_path]
        tooltip: "Current Outer Row"
      }
      row_43: "RowID 43: {name: 'Charlie'...}" {class: data_payload}
    }
  }
}

# --- VM Execution State ---
vm_state: "VDBE Registers" {
  pc: "PC: 0x04 (OP_Column)" {class: metadata}
  
  reg_file: {
    grid-columns: 1
    r1: "R[1] = 42 (Join Key)" {class: [register; hot_path]}
    r2: "R[2] = 'Bob'" {class: register}
    r3: "R[3] = NULL" {class: register}
  }
}

# --- Inner Loop: Orders Index + Table ---
inner_logic: "INNER LOOP: orders (Probe Table)" {
  
  idx_probe: "INDEX: idx_orders_user_id" {
    style.fill: "#e1f5fe"
    
    idx_root: "Index Root (Page 2)" {class: page_node}
    idx_leaf: "Index Leaf (Page 10)" {
      class: [page_node; hot_path]
      entry_1: "Key: 41 | RID: 101"
      entry_2: "Key: 42 | RID: 102" {class: hot_path}
      entry_3: "Key: 42 | RID: 105" {class: hot_path}
    }
    
    idx_root -> idx_leaf: "Binary Search"
  }

  orders_table: "TABLE: orders" {
    style.fill: "#fff9c4"
    
    orders_page_200: "Page #200 (Leaf)" {
      class: page_node
      cell_102: "RowID 102: {user_id: 42, item: 'A'}" {class: [data_payload; hot_path]}
      cell_105: "RowID 105: {user_id: 42, item: 'B'}" {class: [data_payload; hot_path]}
    }
  }
}

# --- Join Output Buffer ---
result_set: "ResultRow Output" {
  shape: sql_table
  style.fill: "#c8e6c9"
  
  row_1: "Alice | Order A"
  row_2: "Bob   | Order A" {style.bold: true}
  row_3: "Bob   | Order B" {style.bold: true; class: hot_path}
}

# --- Coordination / Flow ---

# 1. Extraction: Move data from storage page to VM Register
outer_storage.users_page_50.records.row_42 -> vm_state.reg_file.r1: "1. OP_Column(0, 0, R1): Extract user_id" {
  class: hot_path
}

# 2. Index Seek: Use VM register value to probe Inner Index
vm_state.reg_file.r1 -> inner_logic.idx_probe.idx_leaf.entry_2: "2. OP_IdxGE(1, R1): Seek B+Tree" {
  class: hot_path
}

# 3. Double Lookup: Resolve RID from Index to Table Row
inner_logic.idx_probe.idx_leaf.entry_2 -> inner_logic.orders_table.orders_page_200.cell_102: "3. OP_SeekRowid(1, RID)" {
  class: hot_path
}

# 4. Result Construction: Emit joined record to cursor
inner_logic.orders_table.orders_page_200.cell_102 -> result_set.row_2: "4. OP_ResultRow: Combine(Users.R, Orders.R)" {
  class: hot_path
}

# 5. Iteration: Advance index cursor for many-to-one matches
inner_logic.idx_probe.idx_leaf.entry_2 -> inner_logic.idx_probe.idx_leaf.entry_3: "5. OP_Next(IdxCursor): Scan same key" {
  style.stroke-dash: 3
}

# Legend/Context for Engineers
legend: {
  direction: right
  t1: "O(1) Register Access" {shape: text; style.font-color: "#336"}
  t2: "O(log N) Index Search" {shape: text; style.font-color: "#7b1fa2"}
  t3: "Sequential Page Read" {shape: text; style.font-color: "#1976d2"}
}
legend.near: bottom-right

# Navigation Link to Satellite Map
nav: "Back to Map" {
  shape: rectangle
  link: "#anchor-id"
  style.fill: "#eee"
  label.near: top-center
}
nav.near: top-left