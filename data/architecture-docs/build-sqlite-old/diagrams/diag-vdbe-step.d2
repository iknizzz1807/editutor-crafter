direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- CLASSES ---
classes: {
  ast_node: {
    shape: rectangle
    style: {
      fill: "#E4DBFE"
      stroke: "#3b1e7b"
      stroke-width: 2
      border-radius: 4
    }
  }
  opcode_entry: {
    shape: sql_table
    style: {
      fill: "#DEE1EB"
      stroke: "#2b3442"
    }
  }
  register: {
    shape: square
    width: 60
    height: 60
    style: {
      fill: "#C7F1FF"
      font-size: 14
      bold: true
    }
  }
  hot_path: {
    style: {
      stroke: "#ca052b"
      stroke-width: 4
      animated: true
    }
  }
}

# --- DIAGRAM TOP ---
title: |md
  # VDBE EXECUTION TRACE: Query Flattening & Runtime Lifecycle
  **Query:** `SELECT name FROM users WHERE id > 100`
| {near: top-center}

# --- SECTION 1: AST (LOGICAL INTENT) ---
ast_layer: "1. Abstract Syntax Tree (Frontend)" {
  link: "#milestone-2"
  root: SelectStatement {
    class: ast_node
    projection: "ResultColumn: 'name'" { class: ast_node }
    source: "Table: 'users'" { class: ast_node }
    filter: "BinaryExpr: '>'" {
      class: ast_node
      lhs: "Identifier: 'id'" { class: ast_node }
      rhs: "Literal: 100" { class: ast_node }
    }
  }
}

# --- SECTION 2: COMPILER (FLATTENING) ---
compiler: "2. Bytecode Compiler" {
  style.fill: "#F6F9FC"
  process: "Recursive Walk & Register Allocation" {
    shape: parallelogram
  }
}

ast_layer.root -> compiler.process: "Flattening AST Nodes"

# --- SECTION 3: VDBE ROM (INSTRUCTION LIST) ---
vdbe_instructions: "3. VDBE Program Memory (Instruction Set)" {
  link: "#milestone-3"
  program: {
    shape: sql_table
    0: "Init | P1:0 | P2:8 | P3:0 | Jump to end for init logic"
    1: "OpenRead | P1:0 | P2:2 | P3:0 | Open cursor 0 on root page 2"
    2: "Rewind | P1:0 | P2:8 | P3:0 | Move to start, jump to 8 if empty"
    3: "Column | P1:0 | P2:0 | P3:1 | Extract 'id' (col 0) -> R1"
    4: "Le | P1:1 | P2:7 | P3:100 | If R1 <= 100, jump to addr 7 (SKIP)"
    5: "Column | P1:0 | P2:1 | P3:2 | Extract 'name' (col 1) -> R2"
    6: "ResultRow | P1:2 | P2:1 | P3:0 | Emit result from R2"
    7: "Next | P1:0 | P2:3 | P3:0 | Advance cursor, jump to 3 if rows"
    8: "Halt | P1:0 | P2:0 | P3:0 | Execution Finished"
  }
}

compiler.process -> vdbe_instructions.program: "Emit Bytecode"

# --- SECTION 4: RUNTIME STATE (CPU ANALOG) ---
runtime: "4. Virtual Machine Runtime Environment" {
  
  pc: "Program Counter (PC)" {
    shape: circle
    style.fill: "#F4B76C"
    label: "PC: 4"
  }

  registers: "Register File (Fixed Slots)" {
    grid-columns: 4
    r0: "R0: NULL" { class: register }
    r1: "R1: 105" { 
      class: register
      style.fill: "#88DCF7"
      tooltip: "Loaded 'id' value"
    }
    r2: "R2: 'Alice'" { 
      class: register
      style.fill: "#88DCF7"
    }
    r3: "R3: NULL" { class: register }
  }

  cursors: "Cursor Array (B-Tree Pointers)" {
    link: "#milestone-6"
    c0: "Cursor 0" {
      shape: cylinder
      label: "C0: users\nPage: 12\nSlot: 4"
      style.fill: "#ACE1AF"
    }
  }
}

# --- DATA FLOW TRACING ---
vdbe_instructions.program.3 -> runtime.registers.r1: "Column Extraction" { class: hot_path }
runtime.registers.r1 -> vdbe_instructions.program.4: "Predicate Input"
vdbe_instructions.program.7 -> vdbe_instructions.program.3: "Loop Jump (P2=3)" {
  class: hot_path
  style.stroke-dash: 5
}

# --- ANNOTATIONS ---
note: |md
  ### The 10-Second Logic
  - **Filter Inversion**: SQL `id > 100` is compiled as `Le 100` (Less or Equal). 
  - If comparison is true, we jump **over** the `ResultRow` instruction to the `Next` loop, effectively skipping the record.
| {
  near: bottom-left
  style.font-size: 14
}

# --- ATOMS ---
storage: B-Tree Pages {
  link: "#milestone-5"
  shape: package
  style.stroke-dash: 3
}

runtime.cursors.c0 -> storage: "read(offset)"
storage -> runtime.registers.r1: "Raw Bytes -> Deserialized Value"

# Navigation
back_to_map: "Back to Map (L0)" {
  link: "#anchor-id-map"
  near: top-left
  style.opacity: 0.6
}