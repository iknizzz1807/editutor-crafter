direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

IndexInternalPage: {
  shape: class
  label: "Index Internal Page\nsizeof=4096 bytes"
  tooltip: "Used for B+tree navigation"
  
  "0x00: type": "uint8 (0x02)" {style.fill: "#E1D5E7"}
  "0x01: free_ptr": "uint16" {style.fill: "#E1D5E7"}
  "0x03: cell_count": "uint16" {style.fill: "#E1D5E7"}
  "0x05: content_start": "uint16" {style.fill: "#E1D5E7"}
  "0x07: frag_free": "uint8" {style.fill: "#E1D5E7"}
  "0x08: right_child": "uint32 (Page ID)" {style.fill: "#FFE6CC"; style.bold: true}
  "0x0C: cell_pointers": "uint16[cell_count]" {style.fill: "#DAE8FC"}
}

IndexLeafPage: {
  shape: class
  label: "Index Leaf Page\nsizeof=4096 bytes"
  tooltip: "Used for data storage and range scans"
  
  "0x00: type": "uint8 (0x0A)" {style.fill: "#E1D5E7"}
  "0x01: free_ptr": "uint16" {style.fill: "#E1D5E7"}
  "0x03: cell_count": "uint16" {style.fill: "#E1D5E7"}
  "0x05: content_start": "uint16" {style.fill: "#E1D5E7"}
  "0x07: frag_free": "uint8" {style.fill: "#E1D5E7"}
  "0x08: next_leaf": "uint32 (Sibling Page ID)" {style.fill: "#FFE6CC"; style.bold: true}
  "0x0C: cell_pointers": "uint16[cell_count]" {style.fill: "#DAE8FC"}
}

IndexCell: {
  shape: class
  label: "Index Cell (Search Key)\nVariable Size"
  
  "payload_size": "varint" {style.fill: "#DAE8FC"}
  "index_values": "record (ST1...STn)" {style.fill: "#DAE8FC"}
  "rowid_tiebreaker": "varint (int64)" {style.fill: "#FFF2CC"}
}

InternalToLeaf: {
  IndexInternalPage."0x08: right_child" -> IndexLeafPage: "descend" {
    style: {
      stroke: orange
      stroke-dash: 5
    }
  }
}

LeafToLeaf: {
  IndexLeafPage."0x08: next_leaf" -> IndexLeafPage: "range scan" {
    style: {
      stroke: orange
      stroke-dash: 5
    }
  }
}

Composition: {
  IndexLeafPage -- IndexCell: "contains" {
    source-arrowhead: 1
    target-arrowhead: * {
      shape: diamond
    }
  }
  
  IndexInternalPage -- IndexCell: "contains" {
    source-arrowhead: 1
    target-arrowhead: * {
      shape: diamond
    }
  }
}

Legend: {
  near: bottom-right
  Header: {style.fill: "#E1D5E7"}
  Pointers: {style.fill: "#FFE6CC"}
  Data: {style.fill: "#DAE8FC"}
}

annotation: |md
  ### B+tree Page Invariants
  - **Shared Offset 0x08**: This byte offset is architecturally overloaded. In Internal pages, it stores the `right_child` Page ID. In Leaf pages, it stores the `next_leaf` pointer to enable $O(N)$ sequential range scans.
  - **Slotted Logic**: `cell_pointers` grow downwards from 0x0C; `IndexCell` data grows upwards from the end of the 4096B buffer.
| {near: top-left}