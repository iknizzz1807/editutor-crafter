vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# SQL String Escape Logic (Algorithm State Diagram)
# Process: Handling '' within a string literal

Step_1: {
  label: "1. Encounter Internal Quote"
  
  Buffer: {
    grid-columns: 12
    grid-gap: 0
    
    c0: "S" {style.fill: "#6c757d"} # Padding (Gray)
    c1: "E" {style.fill: "#6c757d"}
    c2: "L" {style.fill: "#6c757d"}
    c3: "E" {style.fill: "#6c757d"}
    c4: "C" {style.fill: "#6c757d"}
    c5: "T" {style.fill: "#6c757d"}
    c6: " " {style.fill: "#6c757d"}
    c7: "'" {style.fill: "#6a0dad"} # Header (Purple)
    c8: "O" {style.fill: "#007bff"} # Data (Blue)
    c9: "'" {style.fill: "#dc3545"; style.bold: true} # Current Focus (Red + Bold)
    c10: "'" {style.fill: "#007bff"} # Peek Target
    c11: "R" {style.fill: "#007bff"}

    tooltip: "Total Size: 12 Bytes"
  }

  Scanner_State: {
    start_ptr: "Offset 0x07" {style.stroke: "#fd7e14"} # Pointers (Orange)
    current_ptr: "Offset 0x09" {style.stroke: "#dc3545"; style.stroke-width: 4}
  }

  Scanner_State.current_ptr -> Buffer.c9
  Scanner_State.start_ptr -> Buffer.c7

  Invariants: |md
    - `State`: STRING_LITERAL
    - `Action`: Peek `current + 1`
  |
}

Step_2: {
  label: "2. Consume Escaped Pair"
  
  Buffer: {
    grid-columns: 12
    grid-gap: 0
    
    c0: "S" {style.fill: "#6c757d"}
    c1: "E" {style.fill: "#6c757d"}
    c2: "L" {style.fill: "#6c757d"}
    c3: "E" {style.fill: "#6c757d"}
    c4: "C" {style.fill: "#6c757d"}
    c5: "T" {style.fill: "#6c757d"}
    c6: " " {style.fill: "#6c757d"}
    c7: "'" {style.fill: "#6a0dad"}
    c8: "O" {style.fill: "#007bff"}
    c9: "'" {style.fill: "#28a745"; style.bold: true} # Changed: Consumed (Green + Bold)
    c10: "'" {style.fill: "#28a745"; style.bold: true} # Changed: Consumed (Green + Bold)
    c11: "R" {style.fill: "#dc3545"; style.bold: true} # Focus: New Current (Red + Bold)
  }

  Scanner_State: {
    start_ptr: "Offset 0x07" {style.stroke: "#fd7e14"}
    current_ptr: "Offset 0x0B" {style.stroke: "#dc3545"; style.stroke-width: 4}
  }

  Scanner_State.current_ptr -> Buffer.c11
  Scanner_State.start_ptr -> Buffer.c7

  Token_Construction: {
    literal_value: "O'R..." {style.fill: "#007bff"}
    note: "Single quote appended to literal"
  }

  Invariants: |md
    - `Match`: `current` == `'` && `peek` == `'`
    - `Transition`: Advance 2, stay in STRING_LITERAL
  |
}

Step_1 -> Step_2: "Match: ''" {
  style.stroke: "#fd7e14"
  style.animated: true
}

Annotation: |md
  ## String Tokenization (M1)
  **Pointer Logic**:
  - `start`: Marks lexeme beginning.
  - `current`: Scans for terminator.
  - Doubled quotes `''` are treated as a single data character, preventing premature termination.
| {
  near: top-left
}