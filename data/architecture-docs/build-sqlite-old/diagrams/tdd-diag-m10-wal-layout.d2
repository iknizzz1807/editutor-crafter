layout-engine: elk
theme-id: 200
direction: down

WAL_FILE_LAYOUT: {
  shape: package
  label: "WAL File Binary Layout (v3007000)"

  # --- WAL HEADER SECTION ---
  WAL_HEADER: {
    label: "WAL HEADER (32 Bytes)"
    style: {
      fill: "#E1D5E7" # Purple (Header)
      stroke: "#9673A6"
      stroke-width: 4
    }
    
    H_MAGIC: "0x00 | Magic Number (0x377f0682) | 4B"
    H_VERSION: "0x04 | WAL Version (3007000) | 4B"
    H_PAGE_SIZE: "0x08 | Page Size (e.g. 4096) | 4B"
    H_CHECKPOINT: "0x0C | Checkpoint Sequence | 4B"
    H_SALT_1: "0x10 | Salt 1 (Random Nonce) | 4B"
    H_SALT_2: "0x14 | Salt 2 (Random Nonce) | 4B"
    H_CHKSUM_1: "0x18 | Cumulative Checksum 1 | 4B"
    H_CHKSUM_2: "0x1C | Cumulative Checksum 2 | 4B"
  }

  # --- WAL FRAME 1 ---
  WAL_FRAME_1: {
    FRAME_1_HEADER: {
      label: "FRAME 1 HEADER (24 Bytes)"
      style: {
        fill: "#FFE6CC" # Orange (Pointers/Metadata)
        stroke: "#D79B00"
      }
      F1_PAGE_NO: "0x20 | Page ID (B-tree Page Number) | 4B"
      F1_DB_SIZE: "0x24 | Post-Commit DB Size (Pages) | 4B"
      F1_SALT_1: "0x28 | Salt 1 (Copy from H_SALT_1) | 4B"
      F1_SALT_2: "0x2C | Salt 2 (Copy from H_SALT_2) | 4B"
      F1_CHKSUM_1: "0x30 | Cumulative Frame Checksum 1 | 4B"
      F1_CHKSUM_2: "0x34 | Cumulative Frame Checksum 2 | 4B"
    }

    # Cache line boundary (64B) occurs 8 bytes into Page Data
    CACHE_LINE_SEP: "---------------- 64B Cache Line Boundary ----------------" {
      shape: text
      style.stroke-dash: 3
    }

    FRAME_1_DATA: {
      label: "FRAME 1 PAGE DATA (4096 Bytes)"
      style: {
        fill: "#DAE8FC" # Blue (Data)
        stroke: "#6C8EBF"
        stroke-dash: 0
        stroke-width: 6 # Bold boundary for Page Data (4096B)
      }
      F1_PAGE_DATA: "0x38 | Raw B-tree Page Content | 4096B"
    }
  }

  # --- WAL FRAME N ---
  WAL_FRAME_NEXT: {
    label: "WAL FRAME N"
    style.opacity: 0.6
    HEADER: "4152 | Frame Header N | 24B" {
      style.fill: "#FFE6CC"
    }
    DATA: "4176 | Page Data N | 4096B" {
      style.fill: "#DAE8FC"
      style.stroke-width: 4
    }
  }
}

# Fixed: Moved constant 'near' key to root level shape
ANN: |md
  ### WAL Architecture Constraints
  - **Checksumming**: Frame N checksum is a function of (Header + Frame 1 ... Frame N).
  - **Page Boundary**: Data is exactly 4096B (aligned with Pager).
  - **Endianness**: Magic dictates native vs big-endian parsing.
| {
  near: top-right
}

# Cumulative checksum chain linkage
WAL_FILE_LAYOUT.WAL_HEADER.H_CHKSUM_2 -> WAL_FILE_LAYOUT.WAL_FRAME_1.FRAME_1_HEADER.F1_CHKSUM_1: "Cumulative Chain" {
  style: {
    stroke: orange
    stroke-width: 2
    animated: true
  }
}

# Sequential frame offset pointer
WAL_FILE_LAYOUT.WAL_FRAME_1.FRAME_1_DATA.F1_PAGE_DATA -> WAL_FILE_LAYOUT.WAL_FRAME_NEXT.HEADER: "Offset: 4152" {
  style.stroke-dash: 5
}

# Total Size Annotation (Root level)
TOTAL_SIZE: "sizeof = 32 + (24 + PageSize) * N bytes" {
  shape: text
  near: bottom-center
}