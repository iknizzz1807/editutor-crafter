layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# STATE MACHINE: AGGREGATE FUNCTION LIFECYCLE
# INVARIANT: ACCUMULATOR REGISTERS MUST BE INITIALIZED PER GROUP

"●" -> INITIALIZE: "OP_Null / New Group"

INITIALIZE: "INITIALIZE (NULL/ZERO)" {
  style: {
    fill: "#B5AFF6" # Header Purple
    stroke: "#333333"
    stroke-width: 2
  }
  tooltip: "Initial state of the AggContext structure"
  
  "INVARIANTS": |md
    - `AggContext.count` = 0
    - `AggContext.has_data` = false
    - `AggContext.sum` = 0.0
  |
}

INITIALIZE -> STEP: "OP_AggStep(val) [val != NULL] / Init Context" {
  style: {
    stroke: "#2196F3" # Normal Blue
  }
}

STEP: "STEP (ACCUMULATING)" {
  style: {
    fill: "#C7F1FF" # Data Blue
    stroke: "#333333"
    stroke-width: 2
  }
  "INVARIANTS": |md
    - `AggContext.has_data` = true
    - `AggContext.func_type` verified
  |
  "ACTION": |md
    - `count` = <b style="color:red">count + 1</b>
    - `sum` = <b style="color:red">sum + val</b>
  |
}

STEP -> STEP: "OP_AggStep(val) [val != NULL] / Update Accumulator" {
  style: {
    stroke: "#2196F3"
    animated: true
  }
}

STEP -> FINALIZE: "OP_AggFinalize / Compute Result" {
  style: {
    stroke: "#2196F3"
  }
}

FINALIZE: "FINALIZE (OUTPUT)" {
  style: {
    fill: "#ACE1AF" # Green (Free/Success)
    stroke: "#333333"
    stroke-width: 2
  }
  "COMPUTATION": |md
    - `AVG`: return <b style="color:red">sum / count</b>
    - `SUM`: return **sum**
    - `COUNT`: return **count**
  |
}

FINALIZE -> "●": "ResultRow / Reset Register"

# ERROR STATES
ERROR: "TYPE_MISMATCH_ERROR" {
  style: {
    fill: "#FE7070" # Error Red
    stroke: "#ca052b"
    stroke-width: 3
  }
  label: "ERROR: INVALID_TYPE"
}

STEP -> ERROR: "OP_AggStep(val) [type(val) != numeric] / Halt VM" {
  style: {
    stroke: "#ca052b"
    stroke-width: 2
  }
}

# ILLEGAL TRANSITIONS
STEP -> INITIALIZE: "ILLEGAL" {
  style: {
    stroke: "#ca052b"
    stroke-dash: 5
    opacity: 0.5
  }
}

# LEGEND / ANNOTATIONS
# FIXED: Changed 'near: FINALIZE' to 'near: bottom-right' for ELK compatibility
ANNOTATION: |md
  ### Aggregate Execution Notes (M11)
  - **3-Phase Lifecycle**: Init -> Step -> Finalize.
  - **NULL Handling**: `AggStep` is skipped if input is `NULL`.
  - **Isolation**: Group-by uses a **Hash Map** to store contexts.
| {
  near: bottom-right
  shape: rectangle
  style: {
    stroke-dash: 3
    fill: "#FFF9C9"
  }
}

# Memory Layout: Exact byte offsets and field sizes
# Colors: Header=Purple, Data=Blue, Padding=Gray, Pointers=Orange
AGG_CONTEXT_MEM: "AggContext Layout (Size=40B)" {
  shape: sql_table
  style: {
    fill: "#B5AFF6" # Header Purple
    stroke: "#333333"
    stroke-width: 2
  }
  
  "0x00": "count (uint64)" { 
    constraint: "8B"
    style.fill: "#C7F1FF" # Data Blue
  }
  "0x08": "sum (double)" { 
    constraint: "8B"
    style.fill: "#C7F1FF" # Data Blue
  }
  "0x10": "min_max (Value Union)" { 
    constraint: "16B"
    style.fill: "#C7F1FF" # Data Blue
  }
  "0x20": "has_data (bool)" { 
    constraint: "1B"
    style.fill: "#C7F1FF" # Data Blue
  }
  "0x21": "func_type (enum)" { 
    constraint: "1B"
    style.fill: "#C7F1FF" # Data Blue
  }
  "0x22": "padding" { 
    constraint: "6B"
    style.fill: "#D3D3D3" # Padding Gray
  }
}

# Pointer reference annotation
STEP -> AGG_CONTEXT_MEM: "AggContext* ctx" {
  style: {
    stroke: "#F69E03" # Pointer Orange
    stroke-dash: 3
    stroke-width: 2
  }
}