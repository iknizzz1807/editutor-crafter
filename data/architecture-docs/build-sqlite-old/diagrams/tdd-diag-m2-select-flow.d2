vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# SELECT Statement Transformation: Tokens to AST
# Technical Design: Milestone 2 - SQL Parser Implementation

title: |md
  ### SQL PARSER DATA FLOW: SELECT STATEMENT
  **Transformation:** Token Stream $\rightarrow$ Abstract Syntax Tree (AST)
| {
  near: top-center
}

# --- INPUT: TOKEN STREAM (FIFO) ---
token_stream: {
  label: "INPUT: TOKEN STREAM (FIFO)"
  style.stroke-dash: 3

  t1: "TK_SELECT\n'SELECT'" {shape: parallelogram}
  t2: "TK_STAR\n'*'" {shape: parallelogram}
  t3: "TK_FROM\n'FROM'" {shape: parallelogram}
  t4: "TK_IDENTIFIER\n'users'" {shape: parallelogram}
  t5: "TK_WHERE\n'WHERE'" {shape: parallelogram}
  t6: "TK_IDENTIFIER\n'id'" {shape: parallelogram}
  t7: "TK_EQUAL\n'='" {shape: parallelogram}
  t8: "TK_INTEGER\n'5'" {shape: parallelogram}

  t1 -> t2 -> t3 -> t4 -> t5 -> t6 -> t7 -> t8
}

# --- PROCESS: PARSER LOGIC ---
parser_logic: "PARSER (RECURSIVE DESCENT)" {
  shape: rectangle
  style: {
    fill: "#E4DBFE"
    border-radius: 20
  }
  
  methods: |md
    - `parse_select()`
    - `parse_result_columns()`
    - `parse_expression(min_prec)`
    - `consume(token_type)`
  |
}

# --- OUTPUT: AST NODE MEMORY LAYOUT ---
# sizeof(AST_SELECT) = 64 bytes (1 Cache Line)
ast_memory_layout: {
  label: "OUTPUT: AST_NODE (SELECT_STMT) MEMORY MAP"
  
  grid-columns: 3
  grid-gap: 0
  
  # Row 1: Header - Type
  off1: "0x00" {style.font: mono}
  f1: "TYPE (AST_SELECT)" {style.fill: "#B5AFF6"; style.bold: true}
  s1: "4B"

  # Row 2: Header - Line
  off2: "0x04" {style.font: mono}
  f2: "LINE_NUMBER" {style.fill: "#B5AFF6"}
  s2: "4B"

  # Row 3: Header - Col
  off3: "0x08" {style.font: mono}
  f3: "COL_NUMBER" {style.fill: "#B5AFF6"}
  s3: "4B"

  # Row 4: Padding
  off4: "0x0C" {style.font: mono}
  f4: "PADDING / ALIGNMENT" {style.fill: "#DEE1EB"}
  s4: "4B"

  # Row 5: Pointers - Result Columns
  off5: "0x10" {style.font: mono}
  f5: "RESULT_COLUMNS_PTR" {style.fill: "#FFD8B1"}
  s5: "8B"

  # Row 6: Pointers - Table Name
  off6: "0x18" {style.font: mono}
  f6: "TABLE_NAME_PTR" {style.fill: "#FFD8B1"}
  s6: "8B"

  # Row 7: Pointers - Where Clause
  off7: "0x20" {style.font: mono}
  f7: "WHERE_CLAUSE_PTR" {style.fill: "#FFD8B1"}
  s7: "8B"

  # Row 8: Pointers - Limit Clause
  off8: "0x28" {style.font: mono}
  f8: "LIMIT_CLAUSE_PTR" {style.fill: "#FFD8B1"}
  s8: "8B"

  # Row 9: Data - Distinct
  off9: "0x30" {style.font: mono}
  f9: "IS_DISTINCT (BOOL)" {style.fill: "#C7F1FF"}
  s9: "1B"

  # Row 10: Footer Padding
  off10: "0x31" {style.font: mono}
  f10: "RESERVED / PADDING" {style.fill: "#DEE1EB"}
  s10: "15B"
}

# --- CONNECTIONS & FLOW ---
token_stream.t1 -> parser_logic: "1. Match TK_SELECT"
token_stream.t2 -> parser_logic: "2. Parse Expressions"
token_stream.t3 -> parser_logic: "3. Match TK_FROM"
token_stream.t4 -> parser_logic: "4. Store Identifier"

parser_logic -> ast_memory_layout: "EMIT AST_NODE" {
  style: {
    stroke-width: 2
    stroke: orange
  }
}

# --- LEGEND & ANNOTATIONS ---
legend: {
  near: bottom-right
  
  h: "Header (Metadata)" { style.fill: "#B5AFF6" }
  p: "Pointers (Ownership)" { style.fill: "#FFD8B1" }
  d: "Data (Scalars)" { style.fill: "#C7F1FF" }
  pad: "Padding" { style.fill: "#DEE1EB" }
}

# Fixed near reference to avoid descendant constraint on grid objects
annotation: |md
  **sizeof(AST_SELECT) = 64 bytes**
  *Aligned to 64B Cache Line Boundary*
| {
  near: bottom-left
}