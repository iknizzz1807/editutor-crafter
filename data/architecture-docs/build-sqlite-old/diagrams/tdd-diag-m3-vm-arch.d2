direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

vdbe: "VDBE Runtime Context" {
  style: {
    stroke: "#673AB7"
    stroke-width: 4
  }

  control_unit: "Control Unit" {
    shape: class
    style.fill: "#673AB7"
    style.font-color: white
    
    pc: "int32_t (Program Counter)"
    nOp: "int32_t (Total Instructions)"
    nReg: "int32_t (Total Registers)"
    nCsr: "int32_t (Total Cursors)"
    
    +step(): "VdbeResult"
    +halt(): "void"
    
    label: "Control Unit (sizeof=32 bytes | 0.5 Cache Line)"
  }

  instruction_stream: "Instruction Stream (Opcode Array)" {
    shape: sql_table
    style.fill: "#673AB7"
    
    0x00: "opcode (uint8_t)" {constraint: "1B"}
    0x01: "p1 (int8_t)" {constraint: "1B"}
    0x02: "p2 (int16_t)" {constraint: "2B"}
    0x04: "p3 (int32_t)" {constraint: "4B"}
    0x08: "p4 (void* / metadata)" {
        constraint: "8B"
        style.fill: "#FF9800"
    }
    
    label: "Instruction Word (sizeof=16B | 4 per 64B Cache Line)"
  }

  register_file: "Register File (Mem Array)" {
    shape: sql_table
    style.fill: "#2196F3"
    
    0x00: "type (uint8_t)" {constraint: "1B"}
    0x01: "_pad (uint8_t[7])" {
        constraint: "7B"
        style.fill: "#E0E0E0"
    }
    0x08: "u (union: i64, double, ptr)" {constraint: "8B"}
    
    label: "Register (Mem) (sizeof=16B x 256 slots)"
  }

  cursor_set: "Cursor Set" {
    shape: sql_table
    style.fill: "#2196F3"
    
    0x00: "root_page (uint32_t)" {constraint: "4B"}
    0x04: "curr_page (uint32_t)" {constraint: "4B"}
    0x08: "cell_idx (uint16_t)" {constraint: "2B"}
    0x0A: "is_eof (bool)" {constraint: "1B"}
    0x0B: "_pad (uint8_t[21])" {
        constraint: "21B"
        style.fill: "#E0E0E0"
    }
    
    label: "VdbeCursor (sizeof=32B x 16 slots)"
  }
}

storage: "Storage Engine" {
  pager: "Buffer Pool Manager (Pager)" {
    shape: class
    style.fill: "#673AB7"
    style.font-color: white
    
    num_frames: "uint32_t"
    fd: "int"
    
    +fetch_page(id): "void*"
    +unpin_page(id, dirty): "void"
    
    label: "Pager (sizeof=128 bytes metadata)"
  }
}

# Ownership and Reference Links
vdbe.control_unit -> vdbe.instruction_stream: "fetches" {
    style.stroke-dash: 5
}
vdbe.control_unit -> vdbe.register_file: "manages" {
    style.stroke-width: 2
}
vdbe.instruction_stream -> vdbe.register_file: "p1/p3 index" {
  style.stroke: "#FF9800"
  target-arrowhead: triangle
}

vdbe.instruction_stream -> vdbe.cursor_set: "p1 (Csr index)" {
  style.stroke: "#FF9800"
  target-arrowhead: triangle
}

vdbe.cursor_set -> storage.pager: "requests pages" {
  style.stroke-dash: 5
}

vdbe.control_unit -> vdbe.instruction_stream: "exec_opcode"

# Annotations & Metadata
legend: {
  near: bottom-right
  header: "Header/Control" {
    style.fill: "#673AB7"
    style.font-color: white
  }
  data: "Data/State" {
    style.fill: "#2196F3"
    style.font-color: white
  }
  ptr: "Pointers/Indices" {
    style.fill: "#FF9800"
    style.font-color: white
  }
  pad: "Padding" {
    style.fill: "#E0E0E0"
    style.font-color: black
  }
}

info: |md
  ### VDBE Runtime Architecture
  - **Memory Layout**: 16-byte aligned instruction words.
  - **Registers**: Fixed array of 256 Mem units.
  - **Cursors**: B-Tree iterators mapped to Pager frames.
  - **Cache Line Alignment**: instruction_stream optimized for 4 words per 64B line.
| {
  near: top-left
}