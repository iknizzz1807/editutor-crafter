layout-engine: elk
vars: {
  d2-config: {
    theme-id: 200
  }
}

# Style Definitions
classes: {
  header: { style: { fill: "#6f42c1"; font-color: white; stroke-width: 2; bold: true } }
  data: { style: { fill: "#007bff"; font-color: white; stroke-width: 2 } }
  free: { style: { fill: "#28a745"; font-color: white; stroke-width: 2 } }
  padding: { style: { fill: "#6c757d"; font-color: white; stroke-dash: 3 } }
  pointers: { style: { fill: "#fd7e14"; font-color: white; stroke-width: 2 } }
}

page_frame: "MEMORY LAYOUT: BUFFER POOL PAGE FRAME\nTotal Size: 4160 Bytes (64B Descriptor + 4096B Data)" {
  style: { stroke-width: 4; stroke: black } # Page boundary bold lines

  descriptor: "PAGE DESCRIPTOR (Metadata)" {
    style: { stroke-dash: 5; fill: transparent } # Cache line boundary dashed

    table: {
      shape: sql_table
      0x00: "PageID | 4 Bytes" { class: header }
      0x04: "PinCount | 4 Bytes" { class: header }
      0x08: "Dirty Bit | 1 Byte" { class: header }
      0x09: "Valid Bit | 1 Byte" { class: header }
      0x0A: "Alignment Padding | 6 Bytes" { class: padding }
      0x10: "DataPtr (*void) | 8 Bytes" { class: pointers }
      0x18: "LRU Prev (*node) | 8 Bytes" { class: pointers }
      0x20: "LRU Next (*node) | 8 Bytes" { class: pointers }
      0x28: "Cache Alignment Padding | 24 Bytes" { class: padding }
    }
  }

  data_block: "PAGE DATA (4096B Buffer)" {
    style: { stroke-width: 2; fill: transparent }

    content: {
      shape: sql_table
      0x0040: "Raw Binary Page Data (Fixed 4KB) | 4096 Bytes" { class: data }
    }
  }
}

# Footer moved to root level to satisfy D2 'near' constraint for constant positioning
page_footer: |md
  ### Implementation Details
  - **Alignment**: Descriptor is cache-line aligned (64 bytes).
  - **Persistence**: `is_dirty` triggers `pwrite` to disk on eviction.
  - **Safety**: `pin_count > 0` locks frame against LRU eviction logic.
| {
  near: bottom-center
}

# Address Reference Pointer
page_frame.descriptor.table.0x10 -> page_frame.data_block.content.0x0040: "Points to 0x0040" {
  style: { 
    stroke: "#fd7e14"
    stroke-width: 3
    animated: true 
  }
}