vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# AGENT: TECHNICAL DESIGN ARTIST - LRU Eviction Algorithm
# Step 1: Accessing Page 42 (Currently LRU)
# Step 2: Relocating Node to MRU position

BEFORE_STATE: {
  label: "1. BEFORE: Page 42 is at LRU (Tail)"
  
  HASH_MAP: {
    shape: sql_table
    style.fill: "#612996"
    label: "Page Table (Hash Map)"
    
    entry_0: "Page 10 | Frame 0"
    entry_1: "Page 25 | Frame 1"
    entry_target: "Page 42 | Frame 2" {
      style.stroke: "#e67e22"
      style.stroke-width: 4
    }
  }

  LIST: {
    direction: right
    
    MRU: "Node A\n(Page 10)" {
      style.fill: "#1a5fb4"
    }
    
    NODE_B: "Node B\n(Page 25)" {
      style.fill: "#1a5fb4"
    }
    
    LRU: "Node C\n(Page 42)" {
      style.fill: "#1a5fb4"
      style.stroke: "#e67e22"
      style.stroke-width: 4
    }

    MRU <-> NODE_B <-> LRU
  }

  HASH_MAP.entry_target -> LIST.LRU: "O(1) Lookup" {
    style.stroke: "#e67e22"
    style.animated: true
  }
}

AFTER_STATE: {
  label: "2. AFTER: Page 42 Splice to Head (MRU)"
  
  HASH_MAP: {
    shape: sql_table
    style.fill: "#612996"
    label: "Page Table (Hash Map)"
    
    entry_0: "Page 10 | Frame 0"
    entry_1: "Page 25 | Frame 1"
    entry_target: "Page 42 | Frame 2" {
      style.font-color: red
      style.stroke: red
      style.bold: true
    }
  }

  LIST: {
    direction: right
    
    MRU_NEW: "Node C\n(Page 42)" {
      style.fill: "#1a5fb4"
      style.stroke: red
      style.stroke-width: 4
      style.font-color: red
      style.bold: true
    }
    
    NODE_A: "Node A\n(Page 10)" {
      style.fill: "#1a5fb4"
    }
    
    LRU_NEW: "Node B\n(Page 25)" {
      style.fill: "#1a5fb4"
    }

    MRU_NEW <-> NODE_A: "NEW MRU PTR" {
      style.stroke: red
      style.font-color: red
      style.bold: true
    }
    NODE_A <-> LRU_NEW: "NEW LRU PTR" {
      style.stroke: red
      style.font-color: red
      style.bold: true
    }
  }

  HASH_MAP.entry_target -> LIST.MRU_NEW: "Direct Pointer" {
    style.stroke: "#e67e22"
  }
}

# MEMORY LAYOUT OF THE DESCRIPTOR (NODE)
# Colors: Header=Purple, Data=Blue, Free=Green, Padding=Gray, Pointers=Orange
NODE_STRUCTURE: {
  shape: sql_table
  style.fill: "#612996"
  label: "LRU Node Memory Layout | sizeof=32B"

  "0x00": "page_id (uint32_t)" { label: "4 bytes"; style.fill: "#1a5fb4" }
  "0x04": "pin_count (uint32_t)" { label: "4 bytes"; style.fill: "#1a5fb4" }
  "0x08": "prev_ptr (void*)" { label: "8 bytes"; style.fill: "#e67e22" }
  "0x10": "next_ptr (void*)" { label: "8 bytes"; style.fill: "#e67e22" }
  "0x18": "dirty_flag (bool)" { label: "1 byte"; style.fill: "#26a269" }
  "0x19": "padding (uint8_t[7])" { label: "7 bytes"; style.fill: "#77767b" }
}

ANNOTATION: |md
### LRU Access Algorithm (O(1))
1. **Lookup**: Retrieve `Node*` from `HashMap` using `PageID`.
2. **Splice**:
   - Set `Node->prev->next = Node->next`
   - Set `Node->next->prev = Node->prev`
3. **Re-attach**: 
   - Set `Node->next = current_head`
   - Set `current_head->prev = Node`
   - Set `p->head = Node`
| {
  near: top-center
}

BEFORE_STATE -> AFTER_STATE: "Access(42)" {
  style.stroke-width: 4
  style.animated: true
}