direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# State Definitions
Uninitialized: {
  shape: package
  label: "UNINITIALIZED"
  |md
  **Invariants:**
  - `pPage == NULL`
  - `iCell == 0`
  - `is_eof == false`
  |
}

ValidRow: {
  shape: package
  label: "VALID_ROW"
  |md
  **Invariants:**
  - `pPage != NULL`
  - `pPage->pin_count > 0`
  - `iCell < pPage->nCell`
  - `is_eof == false`
  |
}

EOF: {
  shape: package
  label: "EOF (End of File)"
  |md
  **Invariants:**
  - `is_eof == true`
  - `pPage == NULL`
  |
}

Invalidated: {
  shape: package
  label: "INVALIDATED_BY_WRITE"
  style: {
    fill: "#ffcccc"
    stroke: red
  }
  |md
  **Invariants:**
  - `needs_reset == true`
  - `pPage == NULL`
  - *State occurs after B-tree mutation*
  |
}

# Entry Point
START: â— {
  width: 20
  height: 20
  style.fill: black
}

START -> Uninitialized: "sqlite3_prepare()"

# Transitions
Uninitialized -> ValidRow: "OP_Rewind / [Table not empty] / btreeMoveto(first)"
Uninitialized -> EOF: "OP_Rewind / [Table empty] / set is_eof=true"

ValidRow -> ValidRow: "OP_Next / [HasMoreCells] / iCell++"
ValidRow -> EOF: "OP_Next / [AtEndOfLeaf] / set is_eof=true"
ValidRow -> Invalidated: "BtreeMutation / [Any] / clear pointers"

Invalidated -> ValidRow: "OP_Rewind / [Success] / btreeMoveto(first)"
Invalidated -> EOF: "OP_Rewind / [TableEmpty] / set is_eof=true"

EOF -> ValidRow: "OP_Rewind / [Not empty] / btreeMoveto(first)"

# Illegal Operations
EOF -> EOF: "OP_Column / [is_eof == true] / ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 3
  }
}

Uninitialized -> Uninitialized: "OP_Column / [pPage == NULL] / ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 3
  }
}

# Size Annotation
Annotation: |md
### Cursor State Machine Invariants
**Total Size:** `sizeof(VdbeCursor) = 128 bytes` (Two cache lines)
**Alignment:** 64-byte boundary
| {
  near: top-right
}