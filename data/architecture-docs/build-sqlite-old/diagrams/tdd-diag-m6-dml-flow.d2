direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- STAGE 1: SQL AST ---
ast: "SQL Abstract Syntax Tree" {
  style.fill: "#f3e5f5"
  header: "AST_INSERT_STMT" {
    style.fill: "#9c27b0"
    style.font-color: white
  }
  table_name: "IDENTIFIER: 'users'"
  cols: "LIST: [id, name]"
  vals: "LIST: [1, 'Alice']"
}

# --- STAGE 2: VDBE COMPILER ---
vdbe: "VDBE Bytecode Implementation" {
  style.fill: "#e3f2fd"
  
  opcodes: "Register-Based Instruction Set" {
    shape: sql_table
    style.fill: "#9c27b0" # Header Purple
    style.stroke: "#9c27b0"
    "addr | opcode | p1 | p2 | p3": "p4 / comment"
    "00 | Integer | 1 | 1 | 0": "R1 = 1"
    "01 | String | 0 | 2 | 0": "R2 = 'Alice'"
    "02 | MakeRecord | 1 | 2 | 3": "Pack R1..R2 -> R3"
    "03 | Insert | 0 | 3 | 1": "Csr0.ins(R3, key=R1)"
    "04 | Halt | 0 | 0 | 0": ""
  }
}

# --- STAGE 3: RECORD PACKER ---
record: "Binary Record Layout" {
  style.fill: "#ffffff"
  
  layout: {
    grid-columns: 1
    grid-gap: 0
    
    header: "Record Header" {
      style.fill: "#9c27b0"
      style.font-color: white
      label: "Header (Size=3 bytes)"
    }
    
    metadata: {
      grid-columns: 3
      grid-gap: 0
      h_size: "Offset 0: 0x03" { style.fill: "#cfd8dc" } # Padding/Meta Gray
      type_1: "Offset 1: 0x01 (Int8)" { style.fill: "#cfd8dc" }
      type_2: "Offset 2: 0x17 (Str, len=5)" { style.fill: "#cfd8dc" }
    }
    
    data_payload: {
      grid-columns: 2
      grid-gap: 0
      val_1: "Offset 3: 0x01 (ID)" { style.fill: "#bbdefb" } # Data Blue
      val_2: "Offset 4: 'Alice'" { style.fill: "#bbdefb" }
    }
    
    annotation: |md
      **Total Size: 9 Bytes**
      Formula: `(SerialType - 13) / 2` for strings.
    | {
      shape: text
    }
  }
}

# --- STAGE 4: B-TREE STORAGE ---
btree: "B-Tree Leaf Page (4096B)" {
  style.fill: "#e8f5e9"
  
  page: {
    grid-columns: 1
    grid-gap: 0
    
    header: "Page Header (Offset 0x00)" {
      style.fill: "#9c27b0"
      style.font-color: white
      label: "Type: 0x0D (Leaf) | Cells: 1 | ContentStart: 4087"
    }
    
    ptr_array: "Cell Pointer Array" {
      style.fill: "#ffe0b2" # Pointers Orange
      label: "Offset 0x08: [ 0x0FF7 ]"
    }
    
    unallocated: "Unallocated Space (4077 bytes)" {
      style.fill: "#c8e6c9" # Free Green
      style.stroke-dash: 5
    }
    
    cell_content: "Cell Content Area (Grows Up)" {
      style.fill: "#bbdefb" # Data Blue
      label: "Offset 0x0FF7: [ PayloadSize=9 | RowID=1 | Data... ]"
    }
  }
  
  footer: "sizeof=4096 bytes (one cache line aligned)" {
    shape: text
    style.font-size: 10
  }
}

# --- PIPELINE CONNECTIONS ---
ast -> vdbe.opcodes: "Compiler Traversal" {
  style.stroke: orange
  style.stroke-width: 2
}

vdbe.opcodes -> record: "OP_MakeRecord (R1, R2)" {
  style.stroke: "#2196f3"
  style.animated: true
}

record -> btree.page.cell_content: "OP_Insert (Csr0, R3)" {
  style.stroke: "#4caf50"
  style.stroke-width: 3
}

# --- LEGEND ---
legend: {
  near: bottom-left
  header: "Legend" {
    style.fill: "#9c27b0"
    style.font-color: white
  }
  data: "Data Content" { style.fill: "#bbdefb" }
  ptr: "Pointers / Offsets" { style.fill: "#ffe0b2" }
  free: "Free/Unallocated" { style.fill: "#c8e6c9" }
}