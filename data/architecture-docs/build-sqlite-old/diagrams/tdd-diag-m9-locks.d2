direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- Database Locking State Machine (Milestone 9) ---

UNLOCKED: "â— UNLOCKED" {
  shape: circle
  style: {
    fill: "#6c757d"
    font-color: white
    stroke-width: 2
  }
  invariant: "No file locks held. Disk idle."
}

SHARED: "SHARED" {
  style: {
    fill: "#007bff"
    font-color: white
    stroke-width: 2
  }
  invariant: "N Readers permitted. 0 Writers."
}

RESERVED: "RESERVED" {
  style: {
    fill: "#fd7e14"
    font-color: white
    stroke-width: 2
  }
  invariant: "1 Pending Writer. N Readers active."
}

PENDING: "PENDING" {
  style: {
    fill: "#6a0dad"
    font-color: white
    stroke-width: 2
  }
  invariant: "No new SHARED locks. Waiting for readers."
}

EXCLUSIVE: "EXCLUSIVE" {
  style: {
    fill: "#dc3545"
    font-color: white
    stroke-width: 2
    double-border: true
  }
  invariant: "0 Readers. 1 Active Writer. I/O Allowed."
}

# --- VALID TRANSITIONS ---

UNLOCKED -> SHARED: "1. Reader: BEGIN\n(F_RDLCK bytes 100-101)"

SHARED -> RESERVED: "2. Writer: BEGIN\n(F_WRLCK byte 102)" {
  style.stroke: "#fd7e14"
}

RESERVED -> PENDING: "3. Writer: COMMIT\n(F_WRLCK byte 103)" {
  style.stroke: "#6a0dad"
}

PENDING -> EXCLUSIVE: "4. Last Reader Exits\n(F_WRLCK bytes 100-101)" {
  style.stroke: "#dc3545"
}

EXCLUSIVE -> UNLOCKED: "5. COMMIT COMPLETE\n(Delete Journal + Release All)"

SHARED -> UNLOCKED: "Reader: FINISH\n(Release 100-101)"

RESERVED -> UNLOCKED: "Writer: ROLLBACK\n(Release 102)"

# --- ILLEGAL TRANSITIONS ---

SHARED -> EXCLUSIVE: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

UNLOCKED -> EXCLUSIVE: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

# --- ANNOTATIONS ---

annotation: |md
  ## Locking Invariants
  1. **Atomicity**: No page mutation occurs outside `EXCLUSIVE`.
  2. **Starvation**: `PENDING` prevents new readers from indefinitely blocking a writer.
  3. **Isolation**: `SHARED` ensures B-tree structural integrity during scans.
| {
  near: bottom-right
}

Legend: {
  near: top-left
  Unlocked: "Idle State" { style.fill: "#6c757d" }
  Read: "Shared / Data" { style.fill: "#007bff" }
  Intent: "Reserved / Pointer" { style.fill: "#fd7e14" }
  Final: "Exclusive / Header" { style.fill: "#dc3545" }
}