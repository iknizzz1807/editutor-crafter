direction: right
layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# CRASH RECOVERY ALGORITHM: ROLLBACK JOURNAL
# Numbered steps representing complete state transitions

Step_01: {
  label: "1. Detection: Search for Hot Journal"
  
  FS: File System {
    db: "mydb.db" {
      style.fill: "#dae8fc"
      status: "INCONSISTENT (Torn Pages)"
    }
    journal: "mydb.db-journal" {
      style.fill: "#e1d5e7"
      status: "EXISTING"
      # Changed element
      style.stroke: "#ff0000"
      style.stroke-width: 4
    }
  }
  
  LockManager: {
    state: "UNLOCKED"
    proc: "Recovery Process"
  }
}

Step_02: {
  label: "2. Locking: Acquire Exclusive Access"
  
  FS: File System {
    db: "mydb.db" {
      style.fill: "#dae8fc"
    }
    journal: "mydb.db-journal" {
      style.fill: "#e1d5e7"
    }
  }
  
  LockManager: {
    # Changed element
    state: "**EXCLUSIVE**" {
      style.font-color: "#ff0000"
      style.bold: true
    }
    style.stroke: "#ff0000"
    style.stroke-width: 4
  }
}

Step_03: {
  label: "3. Restoration: Copying Undo Log to DB"
  
  FS: File System {
    db: "mydb.db" {
      # Changed element
      page_1: "RESTORED" 
      page_5: "RESTORED"
      style.stroke: "#ff0000"
      style.stroke-width: 4
      style.bold: true
    }
    journal: "mydb.db-journal" {
      style.fill: "#e1d5e7"
      ptr: "Reading Page 5..." {
        style.stroke: "#f08705"
      }
    }
  }
  
  VFS: "I/O Bridge" {
    journal -> db: "Bit-for-bit overwrite" {
      style.stroke: "#ff0000"
      style.animated: true
    }
  }
}

Step_04: {
  label: "4. Finalization: Truncate & Commit"
  
  FS: File System {
    db: "mydb.db" {
      style.fill: "#d5e8d4"
      status: "CONSISTENT"
      # Changed element
      size: "TRUNCATED TO HEADER.db_size" {
        style.font-color: "#ff0000"
        style.bold: true
      }
    }
    # Changed element
    journal: "DELETED" {
      style.fill: "#f5f5f5"
      style.stroke-dash: 5
      style.opacity: 0.5
    }
  }
  
  Sync: "Barrier" {
    db -> Disk: "fsync()" {
      style.stroke: "#f08705"
    }
  }
}

Step_01 -> Step_02: "Journal found & Shared Lock possible"
Step_02 -> Step_03: "Header validated"
Step_03 -> Step_04: "Checksums pass & All pages copied"