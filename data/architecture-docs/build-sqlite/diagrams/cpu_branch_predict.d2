vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right

title: "The Branch Cost: Hardware Perspective"
link: "#ms-repl"

# 1. RAM LAYOUT
ram: Main Memory {
  link: "#ms-repl"
  shape: package
  tooltip: "Input Buffer Address: 0x7FFF0040"
  style: {
    stroke: "#2D3748"
    fill: "#EDF2F7"
  }

  buffer: {
    layout: grid
    
    b0: "s" {shape: square; width: 40; height: 40; style.fill: "#FBD38D"}
    b1: "e" {shape: square; width: 40; height: 40}
    b2: "l" {shape: square; width: 40; height: 40}
    b3: "e" {shape: square; width: 40; height: 40}
    b4: "c" {shape: square; width: 40; height: 40}
    b5: "t" {shape: square; width: 40; height: 40}
    b6: "\\0" {shape: square; width: 40; height: 40; style.fill: "#CBD5E0"}
  }
}

# 2. PATH A: SENTINEL CHECK (Optimized)
path_a: Path A: Sentinel Check (Hardware) {
  link: "#ms-repl"
  style: {
    fill: "#F0FFF4"
    stroke: "#2F855A"
    stroke-width: 2
  }

  register: CPU Register (AL) {
    shape: square
    label: "LOAD 's'"
    style.fill: "#FBD38D"
  }

  alu_op: ALU Operation {
    shape: step
    label: "CMP AL, '.'"
    tooltip: "1 CPU Cycle"
  }

  branch: Zero Flag? {
    shape: diamond
    label: "Is Dot?"
    style.fill: "#9AE6B4"
  }

  register -> alu_op: "Fetch"
  alu_op -> branch: "Execute"
}

# 3. PATH B: STRMP (Naive)
path_b: Path B: strcmp (Software) {
  link: "#ms-repl"
  style: {
    fill: "#FFF5F5"
    stroke: "#C53030"
    stroke-width: 2
  }

  stack: Stack Setup {
    label: "PUSH &arg1\nPUSH &arg2"
    shape: queue
  }
  
  call: CALL strcmp {
    shape: step
  }
  
  loop: Memory Fetch Loop {
    shape: cylinder
    style.multiple: true
    label: "Fetch char[i]\nFetch constant[i]\nCompare"
  }

  result: Return Result {
    shape: circle
  }

  stack -> call: "Overhead"
  call -> loop: "L1/L2 Cache Misses"
  loop -> result: "50+ Cycles"
}

# 4. DESTINATION
parser: SQL Parser {
  link: "#ms-parser"
  shape: package
  style: {
    fill: "#BEE3F8"
    stroke: "#2B6CB0"
  }
  
  ast: AST Builder
}

# CONNECTIONS
ram.buffer.b0 -> path_a.register: "Direct Byte Load" {
  style.stroke: "#2F855A"
  style.animated: true
}

path_a.branch -> parser: "FALSE (Jump to SQL)" {
  style: {
    stroke: "#2F855A"
    stroke-width: 3
  }
}

path_a.branch -> path_b: "TRUE (Check Meta)" {
  style: {
    stroke-dash: 3
    opacity: 0.5
  }
}

ram.buffer -> path_b.stack: "Pointer Reference" {
  style: {
    stroke: "#C53030"
    stroke-dash: 3
  }
}

path_b.result -> parser: "Return != 0" {
  style: {
    stroke: "#C53030"
    stroke-width: 3
  }
}