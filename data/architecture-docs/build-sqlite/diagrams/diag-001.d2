vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  frontend_subsystem: {
    style: {
      fill: "#e3f2fd"
      stroke: "#1565c0"
      stroke-width: 2
      border-radius: 8
    }
  }
  vm_subsystem: {
    style: {
      fill: "#f3e5f5"
      stroke: "#7b1fa2"
      stroke-width: 3
      double-border: true
    }
  }
  backend_subsystem: {
    style: {
      fill: "#fff3e0"
      stroke: "#ef6c00"
      stroke-width: 2
      border-radius: 8
    }
  }
  storage_media: {
    shape: cylinder
    style: {
      fill: "#cfd8dc"
      stroke: "#37474f"
    }
  }
  data_flow: {
    style: {
      stroke-width: 2
      animated: true
    }
  }
  sentinel_style: {
    style: {
      fill: "#fce4ec"
      stroke: "#c2185b"
      stroke-dash: 5
    }
  }
}

"User Interface": {
  shape: person
  link: "#milestone-1"
}

"REPL / API Gateway": {
  class: frontend_subsystem
  link: "#milestone-1"
  tooltip: "Read-Eval-Print Loop & C API Interface"
}

"SQLite Frontend": {
  class: frontend_subsystem
  link: "#milestone-2"
  
  "Tokenizer": "Lexer (Tokenizer)" {
    link: "#milestone-2"
    tooltip: "Converts SQL string into tokens"
  }
  
  "Parser": "Parser" {
    link: "#milestone-2"
    tooltip: "Analyzes token grammar and generates AST"
  }
  
  "Optimizer": "Query Planner / Optimizer" {
    link: "#milestone-5"
    tooltip: "Cost-based search for efficient execution paths"
  }
  
  "Code Generator": "Code Generator" {
    link: "#milestone-3"
    tooltip: "Translates AST to VDBE Bytecode"
  }

  "Tokenizer" -> "Parser": "Token Stream" {class: data_flow}
  "Parser" -> "Optimizer": "AST" {class: data_flow}
  "Optimizer" -> "Code Generator": "Execution Plan" {class: data_flow}
}

"Virtual Machine Layer": {
  class: vm_subsystem
  link: "#milestone-3"
  
  "VDBE": "VDBE Engine" {
    link: "#milestone-3"
    tooltip: "Virtual Database Engine - Executes Opcodes"
  }
  
  "Registers": "Registers & Stack" {
    link: "#milestone-7"
    tooltip: "Internal VM state & row serialization"
  }
  
  "VDBE" <-> "Registers": "Data Flow"
}

"Storage Engine": {
  class: backend_subsystem
  link: "#milestone-4"
  
  "B-Tree Manager": {
    link: "#milestone-4"
    tooltip: "Organizes data in balanced trees"
  }
  
  "Pager": "Pager (Cache Manager)" {
    link: "#milestone-4"
    tooltip: "Handles 4KB Page I/O & LRU Cache"
  }
  
  "VFS Interface": {
    link: "#milestone-10"
    tooltip: "Virtual File System for OS abstraction"
  }
  
  "B-Tree Manager" -> "Pager": "Page Requests" {class: data_flow}
  "Pager" -> "VFS Interface": "Sector I/O" {class: data_flow}
}

"Database Files": {
  "Main Database (.db)": {
    class: storage_media
    link: "#milestone-4"
  }
  
  "Write-Ahead Log (.wal)": {
    class: storage_media
    link: "#milestone-6"
    style.fill: "#ffebee"
  }
}

# Cross-cutting Sentinel Logic
"Sentinel": "Concurrency Sentinel" {
  class: sentinel_style
  link: "#milestone-9"
  tooltip: "Locking & Latches (ACID Control)"
}

# Core Pipeline Connections
"User Interface" -> "REPL / API Gateway": "SQL Text" {class: data_flow}
"REPL / API Gateway" -> "SQLite Frontend"."Tokenizer": "Input Buffer" {class: data_flow}
"SQLite Frontend"."Code Generator" -> "Virtual Machine Layer"."VDBE": "Opcode Bytecode" {class: data_flow}
"Virtual Machine Layer"."VDBE" -> "Storage Engine"."B-Tree Manager": "Cursor API" {class: data_flow}
"Storage Engine"."VFS Interface" -> "Database Files"."Main Database (.db)": "pwrite()"
"Storage Engine"."VFS Interface" -> "Database Files"."Write-Ahead Log (.wal)": "WAL Append" {
  style.stroke: red
  style.stroke-dash: 3
}

# Sentinel Interference
"Virtual Machine Layer" -- "Sentinel": "Transaction Locks"
"Storage Engine" -- "Sentinel": "Page Latches"

"The Metropolis View": |md
  ### The SQLite Architecture Stack
  - **Frontend**: Converts human SQL into machine Bytecode.
  - **Virtual Machine**: A register-based VM executing instructions.
  - **Storage Engine**: Manages logical indices (B-Trees) and physical caching (Pager).
  - **OS Interface**: VFS layer ensuring ACID persistence.
| {
  near: top-right
}

# Legend for States
"Legend": {
  near: bottom-right
  "Frontend Process": { style.fill: "#e3f2fd" }
  "Execution Process": { style.fill: "#f3e5f5" }
  "Storage Process": { style.fill: "#fff3e0" }
}