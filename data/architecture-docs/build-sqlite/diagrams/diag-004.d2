vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- THE SYSTEM ANCHOR (Satellite Map) ---
SystemMap: "THE SYSTEM MAP: ARCHITECTING SQLITE" {
  link: "#satellite-map"
  shape: package
  style: {
    stroke-width: 4
    fill: "#f8f9fa"
    stroke: "#212529"
  }
}

# --- MILESTONE 2: THE ARCHITECT (TOKENIZER) ---
Milestone2: "MILESTONE 2: THE ARCHITECT (TOKENIZER)" {
  link: "#milestone-2"
  tooltip: "The Lexical Analysis Phase: Character to Token Conversion"

  # 1. THE MICROSCOPE: MEMORY LAYOUT
  MemoryLayout: "Microscope: Raw SQL Memory Scan" {
    input_buffer: "InputBuffer (Heap Allocated)" {
      style.fill: "#e9ecef"
      
      bytes: {
        grid-columns: 14
        grid-gap: 0
        
        c0: "I" {style.font: mono; style.fill: "#d0ebff"}
        c1: "N" {style.font: mono; style.fill: "#d0ebff"}
        c2: "S" {style.font: mono; style.fill: "#d0ebff"}
        c3: "E" {style.font: mono; style.fill: "#d0ebff"}
        c4: "R" {style.font: mono; style.fill: "#d0ebff"}
        c5: "T" {style.font: mono; style.fill: "#d0ebff"}
        c6: " " {style.font: mono; style.fill: "#fff3bf"}
        c7: "1" {style.font: mono; style.fill: "#d3f9d8"}
        c8: "0" {style.font: mono; style.fill: "#d3f9d8"}
        c9: " " {style.font: mono; style.fill: "#fff3bf"}
        c10: "'" {style.font: mono; style.fill: "#ffdeeb"}
        c11: "A" {style.font: mono; style.fill: "#ffdeeb"}
        c12: "'" {style.font: mono; style.fill: "#ffdeeb"}
        c13: "\0" {style.font: mono; style.fill: "#adb5bd"}
      }
    }

    pointer_logic: "Scanner Metadata" {
      cursor: "char *pCursor" {
        shape: person
        link: "#milestone-2"
      }
      cursor -> input_buffer.bytes.c0: "Current Pointer" {
        style.stroke: "#228be6"
        style.animated: true
      }
    }

    token_meta: "Resulting C Struct" {
      shape: sql_table
      link: "#milestone-2"
      column_header: "Token Struct"
      type: "TokenType: TK_INSERT"
      start: "char* start_ptr"
      len: "int length: 6"
    }

    token_meta.start -> input_buffer.bytes.c0: "Points To" {
      style.stroke: "#40c057"
      style.stroke-dash: 3
    }
  }

  # 2. STATE TRANSITIONS: FINITE STATE MACHINE
  TokenizerFSM: "Lexer Finite State Machine" {
    link: "#milestone-2"
    style.fill: "#f8f9fa"

    START_NODE: "START" {
      shape: circle
      style.double-border: true
      style.fill: "#e7f5ff"
    }

    IDENT: "IDENTIFIER\n[a-zA-Z_]" {
      shape: circle
      style.fill: "#d0ebff"
    }

    NUM: "NUMERIC\n[0-9.]" {
      shape: circle
      style.fill: "#d3f9d8"
    }

    STR: "STRING\n['...']" {
      shape: circle
      style.fill: "#ffdeeb"
    }

    SYM: "SYMBOL\n[=, <, >, (]" {
      shape: circle
      style.fill: "#fff3bf"
    }

    EMIT: "EMIT_TOKEN" {
      shape: package
      style.fill: "#40c057"
      style.font-color: white
    }

    # Transitions
    START_NODE -> IDENT: "is_alpha(c)"
    START_NODE -> NUM: "is_digit(c)"
    START_NODE -> STR: "c == '\''"
    START_NODE -> SYM: "is_operator(c)"
    
    IDENT -> IDENT: "is_alnum(c)"
    IDENT -> EMIT: "Non-Alnum"

    NUM -> NUM: "is_digit(c)"
    NUM -> EMIT: "Non-Digit"

    STR -> STR: "c != '\''"
    STR -> EMIT: "c == '\''"

    SYM -> EMIT: "Terminal"
    
    EMIT -> START_NODE: "Reset Cursor"
  }

  # 3. OPERATION: BEFORE & AFTER FLOW
  Transformation: "Operation: Tokenizing Intent" {
    link: "#milestone-2"
    direction: right
    
    Before: "Raw ASCII Stream" {
      shape: rectangle
      label: |'md
        `INSERT INTO users VALUES (1, 'Alice');`
      '|
    }

    Engine: "Tokenizer" {
      shape: step
      style.fill: "#339af0"
      style.font-color: white
    }

    After: "Token Stream" {
      shape: sql_table
      t1: "ID: 0 | Type: TK_INSERT | Val: 'INSERT'"
      t2: "ID: 1 | Type: TK_INTO   | Val: 'INTO'"
      t3: "ID: 2 | Type: TK_ID     | Val: 'users'"
      t4: "ID: 3 | Type: TK_VALUES | Val: 'VALUES'"
      t5: "ID: 4 | Type: TK_INT    | Val: '1'"
    }

    Before -> Engine -> After
  }

  # 4. HARDWARE SOUL: THE COST OF BRANCHING
  HardwareSoul: "Hardware Soul: Branch Prediction" {
    style.fill: "#fff5f5"
    link: "#milestone-2"
    
    pipeline: "CPU Pipeline Stages" {
      grid-columns: 4
      F: "FETCH"
      D: "DECODE"
      E: "EXEC"
      W: "WB"
    }

    predictor: "Branch Predictor" {
      shape: cloud
      label: "Assume Digit?\n(Looping numbers)"
    }

    predictor -> pipeline.F: "Speculative Load" {
      style.stroke: "#fa5252"
      style.animated: true
    }

    penalty: "Pipeline Flush Analysis" {
      shape: rectangle
      label: |'md
        ### Branch Mispredict
        - **Latency**: 15-20 cycles
        - **Impact**: Random token types (Intermixed String/Int)
        - **Solution**: Hand-tuned 'switch' density
      '|
    }
    
    # Corrected placement using absolute path to ID within container
    penalty.near: pipeline
  }
}

# --- INTERCONNECTEDNESS ---
SystemMap -> Milestone2: "Architectural Intent"
Milestone2.MemoryLayout -> Milestone2.TokenizerFSM: "Feed Stream"
Milestone2.TokenizerFSM -> Milestone2.Transformation: "State Logic"
Milestone2.Transformation -> Milestone2.HardwareSoul: "Performance Tuning"

# --- GLOBAL REFINEMENTS ---
"**": {
  style: {
    font-size: 14
    stroke-width: 2
  }
}

"Milestone2.TokenizerFSM.**": {
  width: 140
  height: 140
  style.font: mono
}

"Milestone2.MemoryLayout.input_buffer.bytes.**": {
  width: 35
  height: 35
  style.bold: true
}

"Milestone2.HardwareSoul.pipeline.**": {
  style.fill: white
  style.stroke: "#fa5252"
  style.bold: true
}