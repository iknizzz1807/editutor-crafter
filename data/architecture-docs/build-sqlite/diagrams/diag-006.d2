vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    keyword: "#B5AFF6"
    terminal: "#C7F1FF"
    non_terminal: "#DEE1EB"
    accent: "#88DCF7"
    logic: "#E4DBFE"
  }
}

classes: {
  rail_keyword: {
    shape: step
    style: {
      fill: "${colors.keyword}"
      stroke-width: 2
      bold: true
    }
  }
  rail_terminal: {
    shape: rectangle
    style: {
      fill: "${colors.terminal}"
      border-radius: 10
      font: mono
    }
  }
  rail_non_terminal: {
    shape: rectangle
    style: {
      double-border: true
      fill: "${colors.non_terminal}"
    }
  }
  rail_junction: {
    shape: circle
    label: ""
    width: 10
    height: 10
    style: {
      fill: "#333333"
    }
  }
}

# -----------------------------------------------------------------------------
# HIGH-LEVEL: THE ARCHITECT'S RAILROAD ATLAS
# -----------------------------------------------------------------------------

SQL_Grammar_Atlas: {
  label: "The Architect: SQL Grammar Railroad Diagrams"
  link: "#milestone-2"

  SELECT_Flow: {
    label: "SELECT Statement Grammar"
    direction: right
    link: "#milestone-2"

    S: "" { shape: circle; width: 10 }
    select_kw: "SELECT" { 
      class: rail_keyword
      link: "#milestone-2"
    }
    
    j1: { class: rail_junction }
    distinct_kw: "DISTINCT" { 
      class: rail_keyword 
      link: "#milestone-2"
    }
    j1_out: { class: rail_junction }
    
    cols: "result_column" { 
      class: rail_non_terminal
      style.multiple: true
      link: "#milestone-2"
    }
    
    from_kw: "FROM" { 
      class: rail_keyword 
      link: "#milestone-2"
    }
    table_ref: "table_name" { 
      class: rail_terminal 
      link: "#milestone-4"
    }
    
    j2: { class: rail_junction }
    where_kw: "WHERE" { 
      class: rail_keyword 
      link: "#milestone-5"
    }
    cond: "expression" { 
      class: rail_non_terminal
      link: "#milestone-5"
    }
    j2_out: { class: rail_junction }
    
    E: "" { shape: circle; width: 10 }

    S -> select_kw -> j1
    j1 -> distinct_kw -> j1_out
    j1 -> j1_out: "Bypass" { style.stroke-dash: 3 }
    j1_out -> cols -> from_kw -> table_ref -> j2
    
    j2 -> where_kw -> cond -> j2_out
    j2 -> j2_out: "Bypass" { style.stroke-dash: 3 }
    j2_out -> E
  }

  INSERT_Flow: {
    label: "INSERT Statement Grammar"
    direction: right
    link: "#milestone-2"

    S: "" { shape: circle; width: 10 }
    ins_kw: "INSERT INTO" { class: rail_keyword; link: "#milestone-2" }
    tbl: "table_name" { class: rail_terminal; link: "#milestone-4" }
    
    j1: { class: rail_junction }
    col_list: "(columns...)" { class: rail_terminal; link: "#milestone-2" }
    j1_out: { class: rail_junction }
    
    val_kw: "VALUES" { class: rail_keyword; link: "#milestone-2" }
    vals: "(expr...)" { class: rail_non_terminal; link: "#milestone-7" }
    
    E: "" { shape: circle; width: 10 }

    S -> ins_kw -> tbl -> j1
    j1 -> col_list -> j1_out
    j1 -> j1_out: "Bypass"
    j1_out -> val_kw -> vals -> E
  }

  UPDATE_Flow: {
    label: "UPDATE Statement Grammar"
    direction: right
    link: "#milestone-2"

    S: "" { shape: circle; width: 10 }
    upd_kw: "UPDATE" { class: rail_keyword; link: "#milestone-2" }
    tbl: "table_name" { class: rail_terminal; link: "#milestone-4" }
    set_kw: "SET" { class: rail_keyword; link: "#milestone-2" }
    assign: "col = expr" { class: rail_non_terminal; link: "#milestone-7" }
    
    j1: { class: rail_junction }
    whr: "WHERE expr" { class: rail_non_terminal; link: "#milestone-5" }
    j1_out: { class: rail_junction }
    
    E: "" { shape: circle; width: 10 }

    S -> upd_kw -> tbl -> set_kw -> assign -> j1
    j1 -> whr -> j1_out
    j1 -> j1_out: "Bypass"
    j1_out -> E
  }
}

# -----------------------------------------------------------------------------
# MICROSCOPE: TOKEN MEMORY LAYOUT
# -----------------------------------------------------------------------------

Token_Memory_Microscope: {
  label: "Microscope: Token C-Struct Memory Layout (64-bit)"
  link: "#milestone-2"

  Token_Struct: {
    shape: sql_table
    label: "struct Token"
    
    type: "TokenType (enum)" { constraint: "0-3 [4B]" }
    pad: "Alignment Padding" { constraint: "4-7 [4B]" }
    ptr: "char *lexeme" { constraint: "8-15 [8B]" }
    len: "size_t length" { constraint: "16-23 [8B]" }
    pos: "int line / col" { constraint: "24-31 [8B]" }
  }

  Heap_Buffer: {
    shape: queue
    label: "Raw Input Buffer (Heap Allocated)"
    link: "#milestone-1"
    "S" | "E" | "L" | "E" | "C" | "T" | " " | "i" | "d" | " " | "F" | "R" | "O" | "M"
  }

  Token_Struct.ptr -> Heap_Buffer: "Points to Start of Lexeme" {
    style: {
      stroke: "${colors.accent}"
      stroke-dash: 3
      animated: true
    }
  }
}

# -----------------------------------------------------------------------------
# STATE TRANSITION: THE COMPILATION PIPELINE
# -----------------------------------------------------------------------------

Compilation_Pipeline: {
  label: "State Transition: SQL Compilation Pipeline"
  direction: right
  link: "#milestone-3"

  State_0: {
    label: "1. Raw SQL String"
    link: "#milestone-1"
    sql: "SELECT id FROM users;" {
      shape: rectangle
      style.font: mono
      style.fill: "#f8f9fa"
    }
  }

  State_1: {
    label: "2. Lexical Tokens"
    link: "#milestone-2"
    t1: "TK_SELECT" { class: rail_keyword }
    t2: "TK_ID(id)" { class: rail_terminal }
    t3: "TK_FROM" { class: rail_keyword }
    t1 -> t2 -> t3
  }

  State_2: {
    label: "3. Abstract Syntax Tree"
    link: "#milestone-2"
    root: "SelectStmt" { shape: diamond }
    root -> col: "Column(id)"
    root -> tbl: "Table(users)"
  }

  State_3: {
    label: "4. VDBE Bytecode"
    link: "#milestone-3"
    bytecode: {
      shape: sql_table
      i0: "Init" { constraint: "Jump 5" }
      i1: "OpenRead" { constraint: "Table 0" }
      i2: "Rewind" { constraint: "Cursor 0" }
      i3: "Column" { constraint: "C0, R1" }
      i4: "ResultRow" { constraint: "R1" }
    }
  }

  State_0.sql -> State_1.t1: "Tokenizer"
  State_1.t3 -> State_2.root: "Parser"
  State_2.root -> State_3.bytecode: "Code Generator"
}

# -----------------------------------------------------------------------------
# LEGEND & DOCS
# -----------------------------------------------------------------------------

Legend: |'md
### SQL Railroad Legend
- **Step (Purple)**: SQL Keyword (Fixed Command).
- **Rounded Rect (Blue)**: Terminal (User-defined name).
- **Double Border (Gray)**: Non-Terminal (Sub-rule).
- **Dashed Lines**: Optional paths in the grammar.
'| {
  near: bottom-right
  style.font-size: 14
}

# Global Global overrides
***.style.font-size: 16
(*** -> ***)[*]: {
  style.stroke: "#333333"
}