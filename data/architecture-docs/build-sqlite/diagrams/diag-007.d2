vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# -------------------------------------------------------------------------------------------
# AST ARCHITECTURE: THE BLUEPRINT OF LOGIC
# -------------------------------------------------------------------------------------------

ast_context_header: |'md
### Milestone 2: The Abstract Syntax Tree (AST)
The **Architect** (Parser) transforms raw tokens into a hierarchical blueprint. 
Each node is a C++ class instance representing an operation or value.
'| {
  near: top-center
}

# --- Main Class Hierarchy ---
ast_nodes: "AST Class Hierarchy" {
  style: {
    stroke-width: 0
    fill: transparent
  }

  ast_base: ASTNode {
    shape: class
    +line: uint32_t
    +column: uint32_t
    +get_type(): NodeType
    link: "#milestone-2"
  }

  statements: "Statements" {
    style: {
      fill: "#E1F5FE"
      stroke: "#01579B"
      double-border: true
    }

    base_stmt: Statement {
      shape: class
      +type: StmtType
      +execute(vm: VDBE*): Result
    }

    select_stmt: SelectStatement {
      shape: class
      +columns: List<Expression*>
      +from: TableRef*
      +where: Expression*
      +limit: int64_t
      link: "#milestone-3"
    }

    insert_stmt: InsertStatement {
      shape: class
      +table: TableRef*
      +columns: List<Identifier>
      +values: List<Expression*>
    }
  }

  expressions: "Expressions" {
    style: {
      fill: "#F1F8E9"
      stroke: "#33691E"
      double-border: true
    }

    base_expr: Expression {
      shape: class
      +eval(ctx: Row*): Value
      +data_type: DataType
    }

    binary_expr: BinaryExpression {
      shape: class
      +left: Expression*
      +right: Expression*
      +op: BinaryOp
    }

    literal_expr: LiteralExpression {
      shape: class
      +val: Value
      +type: LiteralType
    }
  }

  schema: "Schema Objects" {
    style: {
      fill: "#FFF3E0"
      stroke: "#E65100"
    }

    table_ref: TableRef {
      shape: class
      +name: string
      +alias: string
      link: "#milestone-4"
    }

    column_def: ColumnDef {
      shape: class
      +name: string
      +type: DataType
      +constraints: List<Constraint*>
      link: "#milestone-7"
    }
  }

  # --- Inheritance Connections (UML Triangle) ---
  statements.base_stmt -> ast_base: {
    target-arrowhead: * { shape: triangle; style.filled: false }
  }
  expressions.base_expr -> ast_base: {
    target-arrowhead: * { shape: triangle; style.filled: false }
  }
  statements.select_stmt -> statements.base_stmt: {
    target-arrowhead: * { shape: triangle; style.filled: false }
  }
  statements.insert_stmt -> statements.base_stmt: {
    target-arrowhead: * { shape: triangle; style.filled: false }
  }
  expressions.binary_expr -> expressions.base_expr: {
    target-arrowhead: * { shape: triangle; style.filled: false }
  }
  expressions.literal_expr -> expressions.base_expr: {
    target-arrowhead: * { shape: triangle; style.filled: false }
  }

  # --- Composition Links ---
  statements.select_stmt -> expressions.base_expr: "Projected Columns" {
    style.stroke-dash: 3
  }
  statements.select_stmt -> schema.table_ref: "Source" {
    style.stroke-dash: 3
  }
}

# -------------------------------------------------------------------------------------------
# MICROSCOPE VIEW: MEMORY LAYOUT
# -------------------------------------------------------------------------------------------

ast_memory_map: "Microscope View: SelectStatement Heap Allocation" {
  near: bottom-right
  
  description: |'md
  **Memory Alignment**:
  Pointers are 8-byte aligned on 64-bit systems.
  The VTable pointer allows for dynamic dispatch
  of the `execute()` method.
  '|

  memory_block: {
    grid-columns: 1
    grid-gap: 0
    style.stroke: "#455A64"

    vtable: "VTable Pointer (8 bytes)" {
      style.fill: "#CFD8DC"
      tooltip: "Address of SelectStatement method table"
    }
    
    loc: {
      grid-columns: 2
      grid-gap: 0
      line: "line: uint32 (4B)" { style.fill: "#ECEFF1" }
      col: "col: uint32 (4B)" { style.fill: "#ECEFF1" }
    }

    ptr_cols: "columns_ptr (8B) -> [Expr1*, Expr2*]" {
      style.fill: "#FFFFFF"
      style.font: mono
    }

    ptr_from: "from_ptr (8B) -> TableRef*" {
      style.fill: "#FFFFFF"
      style.font: mono
    }

    ptr_where: "where_ptr (8B) -> Expression*" {
      style.fill: "#FFFFFF"
      style.font: mono
    }

    limit: "limit: int64 (8B)" {
      style.fill: "#ECEFF1"
    }
  }
}

# Connecting high-level class to low-level memory view
ast_nodes.statements.select_stmt -> ast_memory_map.memory_block: "instantiates as" {
  style: {
    stroke-dash: 5
    opacity: 0.4
    animated: true
  }
}

# -------------------------------------------------------------------------------------------
# GLOBAL STYLING
# -------------------------------------------------------------------------------------------

***.style.font: mono
(*** -> ***)[*]: {
  style.stroke: "#37474F"
  style.font-size: 14
}