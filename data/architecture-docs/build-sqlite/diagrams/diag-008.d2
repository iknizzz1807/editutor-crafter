vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# -------------------------------------------------------------------------------------------
# GLOBAL STYLING & CLASSES
# -------------------------------------------------------------------------------------------
classes: {
  logic_component: {
    style: {
      fill: "#f8f9fa"
      stroke: "#212529"
      stroke-width: 2
      shadow: true
    }
  }
  call_frame: {
    style: {
      fill: "#e7f5ff"
      stroke: "#228be6"
      border-radius: 4
      double-border: true
    }
  }
  error_highlight: {
    style: {
      fill: "#fff5f5"
      stroke: "#fa5252"
      stroke-width: 2
      font-color: "#fa5252"
      bold: true
    }
  }
  memory_segment: {
    style: {
      font: mono
      fill: "#fff9db"
      stroke: "#fab005"
    }
  }
  pointer_link: {
    style: {
      stroke: "#4dabf7"
      stroke-width: 2
      animated: true
    }
  }
}

# -------------------------------------------------------------------------------------------
# SATELLITE VIEW: THE PARSER ARCHITECTURE
# -------------------------------------------------------------------------------------------
Parser_Satellite: {
  label: "PARSER PIPELINE: TEXT TO AST"
  link: "#milestone-2"
  
  direction: right

  Source: "Raw String Buffer" {
    shape: page
    style.fill: "#f1f3f5"
    link: "#milestone-2"
  }

  Scanner: "Lexer (DFA)" {
    class: logic_component
    tooltip: "Scans ASCII bytes into Token structs"
    link: "#milestone-2"
  }

  Parser: "Recursive Descent Engine" {
    class: logic_component
    style.fill: "#e7f5ff"
    link: "#milestone-2"
  }

  AST: "Abstract Syntax Tree" {
    shape: cloud
    class: logic_component
    link: "#milestone-2"
  }

  Source -> Scanner: "char*" { link: "#milestone-2" }
  Scanner -> Parser: "Token stream" { link: "#milestone-2" }
  Parser -> AST: "malloc()" { link: "#milestone-2" }
  
  Error_Manager: "Panic Mode Recovery" {
    shape: diamond
    class: error_highlight
    link: "#milestone-2"
  }
  
  Parser <-> Error_Manager: "Sync Signal" { link: "#milestone-2" }
}

# -------------------------------------------------------------------------------------------
# MICROSCOPE: TOKEN MEMORY LAYOUT
# -------------------------------------------------------------------------------------------
Token_Memory_Layout: {
  label: "MEMORY LAYOUT: Token Struct (32-bit Alignment)"
  link: "#milestone-2"

  Layout: {
    shape: sql_table
    class: memory_segment
    
    "Offset 00": "uint32_t type" {constraint: "TOKEN_SELECT"}
    "Offset 04": "int32_t length" {constraint: "6"}
    "Offset 08": "const char* start" {constraint: "0x7ffee1"}
    "Offset 12": "int32_t line" {constraint: "1"}
    "Offset 16": "int32_t col" {constraint: "0"}
    "Offset 20": "uint32_t padding" {style.opacity: 0.4}
  }
  
  "Input Buffer": "SELECT * FROM users" {
    style.font: mono
    link: "#milestone-2"
  }
  
  Layout."Offset 08" -> "Input Buffer": "Points to 'S'" { class: pointer_link }
}

# -------------------------------------------------------------------------------------------
# EXECUTION VIEW: RECURSIVE DESCENT CALL STACK
# -------------------------------------------------------------------------------------------
Call_Stack_Trace: {
  label: "RD PARSER EXECUTION STACK"
  link: "#milestone-2"

  Stack_Frames: {
    parse_statement: "parse_statement()" {
      class: call_frame
      link: "#milestone-2"
      
      parse_query: "parse_query()" {
        class: call_frame
        link: "#milestone-2"
        
        parse_select: "parse_select_stmt()" {
          class: call_frame
          link: "#milestone-2"
          
          consume: "consume(TOKEN_FROM)" {
            class: error_highlight
            label: "SYNTAX ERROR: Expected 'FROM'"
            link: "#milestone-2"
          }
        }
      }
    }
  }
  
  Stack_Frames.parse_statement.parse_query.parse_select.consume -> Parser_Satellite.Error_Manager: "throw exception" {
    style.stroke: "#fa5252"
    style.animated: true
    link: "#milestone-2"
  }
}

# -------------------------------------------------------------------------------------------
# STATE TRANSITION: PANIC MODE ERROR RECOVERY
# -------------------------------------------------------------------------------------------
Error_Recovery_Transition: {
  label: "STATE TRANSITION: PANIC MODE SYNCHRONIZATION"
  link: "#milestone-2"
  
  grid-columns: 2
  grid-gap: 50

  Before_Panic: {
    label: "BEFORE: Syntax Error Hit"
    link: "#milestone-2"
    
    Code: "SELECT * user_id FROM t;" { style.font: mono }
    Error_Pointer: "         ^" {
      style.font-color: "#fa5252"
      style.bold: true
    }
    Code -> Error_Pointer: "Missing 'FROM'" { style.stroke: "#fa5252" }
    
    Status: "PanicMode = TRUE" { class: error_highlight }
  }

  After_Sync: {
    label: "AFTER: Scanning for Semicolon"
    link: "#milestone-2"
    
    Code: "SELECT * user_id FROM t; SELECT..." { style.font: mono }
    Sync_Pointer: "                       ^" {
      style.font-color: "#40c057"
      style.bold: true
    }
    Code -> Sync_Pointer: "Sync at Boundary" { style.stroke: "#40c057" }
    
    Status: "PanicMode = FALSE" { 
      style.fill: "#ebfbee"
      style.stroke: "#40c057"
      style.font-color: "#40c057"
    }
  }

  Before_Panic -> After_Sync: "advance() loop" {
    style.animated: true
    style.stroke-width: 4
    link: "#milestone-2"
  }
}

# -------------------------------------------------------------------------------------------
# HEAP LAYOUT: AST NODE STRUCTURE
# -------------------------------------------------------------------------------------------
AST_Node_Heap: {
  label: "HEAP MEMORY: AST Nodes"
  link: "#milestone-2"
  
  BaseNode: {
    shape: sql_table
    class: memory_segment
    "type": "NodeType_Enum"
    "token": "Token*"
    "left": "Node*"
    "right": "Node*"
  }

  BinaryOpNode: {
    shape: sql_table
    class: memory_segment
    "operator": "TOKEN_PLUS"
    "lhs": "Node*"
    "rhs": "Node*"
  }

  BaseNode -> BinaryOpNode: "Child reference" { class: pointer_link }
}

# -------------------------------------------------------------------------------------------
# TECHNICAL EXPLANATION
# -------------------------------------------------------------------------------------------
Technical_Context: |'md
### THE ARCHITECT'S ENGINE: RECURSIVE DESCENT
This diagram illustrates the "Second Milestone" where raw ASCII turns into a logical tree.

1.  **Token Memory Layout**: Note the alignment. By storing pointers (`const char* start`) to the original input buffer instead of copying strings, we minimize heap fragmentation.
2.  **Recursive Descent Stack**: Each function call represents a **Production Rule** in the formal SQL grammar.
3.  **Panic Mode**: When `consume()` fails, the parser enters a special state where it suppresses further errors and "synchronizes" by skipping tokens until it finds a statement terminator (`;`). This prevents a single typo from generating hundreds of cascading errors.
4.  **AST Nodes**: The final output. These nodes reside on the heap and are passed to the **VDBE Compiler** in Milestone 3.
'| {
  near: top-right
  link: "#milestone-2"
}

# -------------------------------------------------------------------------------------------
# INTER-DIAGRAM LINKS
# -------------------------------------------------------------------------------------------
Parser_Satellite.Scanner -> Token_Memory_Layout: "Defined by" { style.stroke-dash: 5 }
Call_Stack_Trace.Stack_Frames -> Error_Recovery_Transition: "Triggers" { style.stroke: "#fa5252" }
Parser_Satellite.AST -> AST_Node_Heap: "Allocates" { style.stroke-dash: 5 }