vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# THE SATELLITE NAVIGATION
navigation: "SYSTEM ARCHITECTURE MAP" {
  shape: diamond
  style.fill: "#264653"
  style.font-color: "#ffffff"
  link: "#satellite-map"
}

# MILESTONE 3: VIRTUAL MACHINE ARCHITECTURE (VDBE)
vdbe_vm: "VDBE: REGISTER-BASED VIRTUAL MACHINE" {
  link: "#milestone-3"
  style.fill: "#fefae0"
  style.stroke: "#bc6c25"
  style.stroke-width: 4

  # INSTRUCTION PIPELINE
  instruction_pipeline: "Instruction & Control Plane" {
    pc: "Program Counter (PC)" {
      shape: rectangle
      style.fill: "#e76f51"
      style.font-color: "#ffffff"
      style.bold: true
      label: "PC: 0x000E (Opcode 14)"
    }

    instruction_register: "Instruction Register" {
      shape: sql_table
      style.fill: "#f4a261"
      op: "OPCODE" {constraint: "Column"}
      p1: "P1 (Cursor)" {constraint: "0"}
      p2: "P2 (Col Index)" {constraint: "1"}
      p3: "P3 (Dest Reg)" {constraint: "r[1]"}
      p4: "P4 (Metadata)" {constraint: "NULL"}
    }

    dispatcher: "Opcode Dispatcher" {
      shape: step
      style.fill: "#e9c46a"
      label: "Computed Goto Logic"
      tooltip: |'md
        Uses an array of labels to jump directly to C-code handlers, 
        bypassing the overhead of standard switch-case branch misprediction.
      '|
    }

    pc -> instruction_register: "Fetch"
    instruction_register -> dispatcher: "Decode"
  }

  # DATA PLANE (REGISTERS & STACK)
  data_plane: "Memory & State Plane" {
    registers: "VDBE Register File" {
      shape: sql_table
      style.fill: "#2a9d8f"
      style.font-color: "#ffffff"
      r0: "r[0]" {constraint: "Int64: 42"}
      r1: "r[1]" {constraint: "Text: 'Alice'"}
      r2: "r[2]" {constraint: "Real: 102.5"}
      r3: "r[3]" {constraint: "Blob: 0xFF.."}
      r4: "r[4]" {constraint: "Null"}
      
      link: "#milestone-3"
    }

    stack_area: "Private Memory / Sorting" {
      shape: rectangle
      style.stroke-dash: 3
      style.fill: "#ffffff"
      label: "Heap-allocated Sort Buffers\n& Aggregate States"
    }
  }

  # STORAGE INTERFACE (CURSORS)
  cursor_management: "Cursor Management Block" {
    style.fill: "#e9edc9"
    
    cur0: "Cursor 0 (Table: users)" {
      shape: rectangle
      style.multiple: true
      label: "B-Tree Page: 45\nCell Offset: 120"
    }

    cur1: "Cursor 1 (Index: idx_id)" {
      shape: rectangle
      style.multiple: true
      label: "B-Tree Page: 12\nKey: 5"
    }

    label: "I/O Cursors"
    link: "#milestone-4"
  }

  # RESULT PIPELINE
  result_pipeline: "Output Result Pipeline" {
    materializer: "Row Materializer" {
      shape: queue
      label: "Current Row Buffer"
      style.fill: "#ccd5ae"
    }

    api_hook: "sqlite3_step()" {
      shape: circle
      style.fill: "#faedcd"
      label: "API HOOK"
    }

    materializer -> api_hook: "SQLITE_ROW"
  }

  # INTERNAL EXECUTION FLOWS
  instruction_pipeline.dispatcher -> data_plane.registers: "R/W Operands"
  instruction_pipeline.dispatcher -> cursor_management: "Seek/Next/Rewind"
  cursor_management -> result_pipeline.materializer: "Unpack B-Tree Cell"
  data_plane.registers -> result_pipeline.materializer: "Assemble Columns"
}

# UPSTREAM: THE BYTECODE PROGRAM
bytecode_source: "Milestone 2: Prepared Statement" {
  link: "#milestone-2"
  program: "Opcode Program" {
    shape: sql_table
    style.fill: "#d4a373"
    0: "0: Init" {constraint: "Jump 14"}
    1: "1: OpenRead" {constraint: "Cursor 0"}
    2: "2: Rewind" {constraint: "Cursor 0"}
    3: "3: Column" {constraint: "Reg 1"}
    4: "4: ResultRow" {constraint: "Reg 1"}
    5: "5: Next" {constraint: "Jump 3"}
    6: "6: Halt" {constraint: "0"}
  }
}

# DOWNSTREAM: THE STORAGE ENGINE
warehouse: "Milestone 4: Pager & B-Tree" {
  link: "#milestone-4"
  shape: cylinder
  style.fill: "#f8f9fa"
}

# CROSS-MILESTONE CONNECTIVITY
bytecode_source.program -> vdbe_vm.instruction_pipeline.pc: "Load Program"
vdbe_vm.cursor_management -> warehouse: "Page Requests (Pager)"
vdbe_vm.result_pipeline.api_hook -> navigation: "Return Control"

# REPL BRIDGE
repl: "Milestone 1: REPL Gateway" {
  link: "#milestone-1"
  shape: rectangle
}
repl -> bytecode_source: "SQL String"

# ANNOTATIONS (MICROSCOPE VIEW)
vdbe_vm.instruction_pipeline.instruction_register.tooltip: "Fixed-size 8-byte opcode structure in memory."
vdbe_vm.data_plane.registers.tooltip: "Register-based architecture avoids the push/pop overhead of stack machines."
vdbe_vm.cursor_management.cur0.tooltip: "Cursors maintain state for traversing B-Trees, holding current page and cell indices."