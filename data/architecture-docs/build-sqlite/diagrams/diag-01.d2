vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: down

User: {
  shape: person
  style.fill: "#6366f1"
  style.stroke: "#312e81"
  style.font-color: white
}

Database Engine: {
  style.fill: "#1e293b"
  style.stroke: "#475569"
  style.stroke-width: 2
  style.shadow: true

  Frontend: {
    style.fill: "#334155"
    style.stroke: "#94a3b8"
    style.stroke-dash: 3
    
    REPL: "REPL (Input Loop)" {
      link: "#ms-repl"
      shape: step
      style.fill: "#0ea5e9"
      style.font-color: white
      tooltip: "Handles input buffer and meta-commands"
    }

    Parser: "SQL Parser" {
      link: "#ms-parser"
      shape: hexagon
      style.fill: "#0ea5e9"
      style.font-color: white
      tooltip: "Lexer -> Tokens -> AST"
    }

    Optimizer: "Query Optimizer" {
      link: "#ms-optimize"
      shape: diamond
      style.fill: "#0ea5e9"
      style.font-color: white
      tooltip: "Generates Cost-Based Execution Plan"
    }

    REPL -> Parser: "1. Raw SQL"
    Parser -> Optimizer: "2. AST"
  }

  Backend: {
    style.fill: "#334155"
    style.stroke: "#94a3b8"
    style.stroke-dash: 3

    Executor: "Virtual Machine" {
      link: "#ms-executor"
      shape: package
      style.fill: "#8b5cf6"
      style.font-color: white
      tooltip: "Executes bytecode using Cursors"
      
      Cursor: {
        shape: class
        style.fill: "#a78bfa"
        +page_num
        +cell_num
      }
    }

    TransactionManager: "Tx Manager" {
      link: "#ms-transactions"
      shape: square
      style.fill: "#8b5cf6"
      style.font-color: white
      tooltip: "Locking & WAL Protocol"
    }

    Frontend.Optimizer -> Executor: "3. Bytecode / Plan"
    Executor <-> TransactionManager: "4. Acquire Lock"
  }

  Storage: {
    style.fill: "#334155"
    style.stroke: "#94a3b8"
    style.stroke-dash: 3

    B-Tree: "B-Tree Engine" {
      link: "#ms-btree"
      shape: class
      style.fill: "#f59e0b"
      style.font-color: black
      tooltip: "Navigates Internal & Leaf Nodes"
      
      +InternalNode
      +LeafNode
    }

    Pager: "Pager (Cache)" {
      link: "#ms-pager"
      shape: queue
      style.fill: "#f59e0b"
      style.font-color: black
      tooltip: "Manages 4KB Pages in RAM"
    }

    Backend.Executor -> B-Tree: "5. Seek / Next"
    B-Tree -> Pager: "6. Get Page #N"
  }
}

Disk: {
  link: "#ms-pager"
  shape: cylinder
  style.fill: "#10b981"
  style.stroke: "#047857"
  style.font-color: white
  
  Files: {
    shape: class
    style.fill: "#34d399"
    style.font-color: black
    "database.db": "Main Data"
    "database.db.wal": "Write-Ahead Log"
  }
}

User -> Database Engine.Frontend.REPL: "SQL Command"
Database Engine.Storage.Pager <-> Disk: "7. read/write(4KB)"

Database Engine.Backend.TransactionManager -> Database Engine.Storage.Pager: "Force WAL Sync" {
  style.stroke: "#ef4444"
  style.stroke-dash: 3
}