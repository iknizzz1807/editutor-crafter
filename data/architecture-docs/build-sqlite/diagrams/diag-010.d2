vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- CLASSES ---
classes: {
  opcode_box: {
    style: {
      fill: "#1a1a1a"
      stroke: "#00ffcc"
      stroke-width: 2
      font-color: "#00ffcc"
      bold: true
    }
  }
  operand_label: {
    style: {
      font-size: 10
      font-color: "#cccccc"
      italic: true
    }
  }
  register_set: {
    style: {
      fill: "#2d2d2d"
      stroke: "#ffcc00"
      stroke-dash: 3
    }
  }
}

# --- ARCHITECTURE OVERVIEW ---
vdbe_engine: "VDBE BYTECODE EXECUTOR" {
  link: "#milestone-3"
  
  instruction_pointer: "PROGRAM COUNTER (PC)" {
    shape: step
    style.fill: "#ff4444"
  }

  registers: "VIRTUAL REGISTERS" {
    shape: sql_table
    link: "#milestone-3"
    r0: "0x00"
    r1: "100 (Int)"
    r2: "'Alice' (String)"
    r3: "NULL"
    r4: "0.45 (Float)"
  }

  cursors: "B-TREE CURSORS" {
    shape: sql_table
    link: "#milestone-4"
    c0: "Root: Page 2 | Pos: 0"
    c1: "Index: Page 5 | Pos: 12"
  }
}

# --- THE INSTRUCTION SET ---
bytecode_listing: "INSTRUCTION PIPELINE" {
  grid-columns: 1
  
  instr_0: "0: Init" {
    class: opcode_box
    p2: "5" { class: operand_label; label: "Jump to PC 5" }
  }

  instr_1: "1: OpenRead" {
    class: opcode_box
    link: "#milestone-4"
    p1: "0" { class: operand_label; label: "Cursor ID" }
    p2: "2" { class: operand_label; label: "Root Page Number" }
    p3: "0" { class: operand_label; label: "Database Index" }
    tooltip: "Opens a read-only cursor on a B-Tree"
  }

  instr_2: "2: Rewind" {
    class: opcode_box
    p1: "0" { class: operand_label; label: "Cursor ID" }
    p2: "5" { class: operand_label; label: "If Empty, Jump to PC 5" }
    tooltip: "Moves cursor to the first entry"
  }

  instr_3: "3: Column" {
    class: opcode_box
    link: "#milestone-7"
    p1: "0" { class: operand_label; label: "Cursor ID" }
    p2: "1" { class: operand_label; label: "Column Index" }
    p3: "1" { class: operand_label; label: "Store in Register R1" }
    tooltip: "Extracts data from the current row"
  }

  instr_4: "4: ResultRow" {
    class: opcode_box
    link: "#milestone-8"
    p1: "1" { class: operand_label; label: "Start Register" }
    p2: "1" { class: operand_label; label: "Number of Columns" }
    tooltip: "Hands current register set to the API"
  }

  instr_5: "5: Next" {
    class: opcode_box
    p1: "0" { class: operand_label; label: "Cursor ID" }
    p2: "3" { class: operand_label; label: "If Not EOF, Jump to PC 3" }
    p3: "0" { class: operand_label; label: "Hint: Sequential" }
  }

  instr_6: "6: Halt" {
    class: opcode_box
    p1: "0" { class: operand_label; label: "Result Code" }
  }
}

# --- DATA FLOW VISUALIZATION ---
microscope_view: "MICRO-OPERATION FLOW" {
  style.fill: "#0f172a"
  
  raw_storage: "B-TREE PAGE DATA" {
    shape: cylinder
    link: "#milestone-4"
    style.fill: "#1e293b"
  }

  op_column_logic: "OP_COLUMN LOGIC" {
    link: "#milestone-7"
    process: |md
    1. Locate **Cursor 0** position.
    2. Read **Record Header** for types.
    3. Calculate **Offset** for Column P2.
    4. Move bytes to **Register P3**.
    |
  }

  raw_storage -> vdbe_engine.cursors.c0: "1. Reference"
  vdbe_engine.cursors.c0 -> op_column_logic: "2. Fetch Row"
  op_column_logic -> vdbe_engine.registers.r1: "3. Serialize & Store"
  vdbe_engine.registers -> user_api: "4. OpResultRow"
}

# --- CONTROL FLOW ---
bytecode_listing.instr_0 -> bytecode_listing.instr_5: "Init Jump" {
  style.stroke: "#ffcc00"
  style.stroke-dash: 5
}

bytecode_listing.instr_5 -> bytecode_listing.instr_3: "Loop Back" {
  style.stroke: "#00ffcc"
  style.animated: true
}

user_api: "EXTERNAL HANDSHAKE" {
  shape: person
  link: "#milestone-8"
}

legend: {
  near: bottom-right
  p1: "P1: Usually Cursor ID"
  p2: "P2: Usually Jump Target or Page"
  p3: "P3: Usually Register ID"
  p4: "P4: Pointer (Strings/Regex)"
}