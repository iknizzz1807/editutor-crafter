vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

"VDBE Instruction Architecture": {
  link: "#milestone-3"
  
  "Instruction Register Map": {
    shape: sql_table
    style: {
      stroke-width: 2
      fill: "#f8f9fa"
    }

    "Offset": "Field (VdbeOp)" {constraint: "Width"}
    "0x00": "Opcode" {constraint: "8-bit uint"}
    "0x01": "P4 Type" {constraint: "8-bit int"}
    "0x02": "P5 Flags" {constraint: "16-bit uint"}
    "0x04": "P1 Operand" {constraint: "32-bit int"}
    "0x08": "P2 Operand" {constraint: "32-bit int"}
    "0x0C": "P3 Operand" {constraint: "32-bit int"}
    "0x10": "P4 Union Pointer" {constraint: "64-bit ptr"}
  }

  "Field Logic Microscope": {
    grid-columns: 2
    
    "Opcode": {
      label: "Opcode (Operation)"
      description: |'md
        The verb of the instruction.
        Ex: `Column`, `Next`, `Halt`.
      '|
      style.fill: "#e1f5fe"
    }
    
    "P1": {
      label: "P1 (Register/Cursor)"
      description: |'md
        Usually the cursor index or
        the source register.
      '|
      style.fill: "#fff9c4"
    }

    "P2": {
      label: "P2 (Jump/Output)"
      description: |'md
        Target address for jumps
        or the output register.
      '|
      style.fill: "#fff9c4"
    }

    "P4": {
      label: "P4 (Complex Data)"
      description: |'md
        A union holding strings,
        functions, or sub-queries.
      '|
      style.fill: "#f8bbd0"
    }
  }

  "Instruction Transformation": {
    "SQL Intent": "SELECT col1 FROM table" {
      style.stroke: "#4caf50"
    }
    
    "VDBE Bytecode": {
      shape: code
      language: "vdbe"
      value: "Column 0 1 2"
    }
    
    "Binary Encoding": {
      grid-columns: 6
      grid-gap: 0
      
      "Op": "0x32" { style.fill: "#e1f5fe" }
      "P1": "0x00" { style.fill: "#fff9c4" }
      "P2": "0x01" { style.fill: "#fff9c4" }
      "P3": "0x02" { style.fill: "#fff9c4" }
      "P4": "NULL" { style.fill: "#f8bbd0" }
      "P5": "0x00" { style.fill: "#e0e0e0" }
    }

    "SQL Intent" -> "VDBE Bytecode": "Compiled"
    "VDBE Bytecode" -> "Binary Encoding": "Encoded in Memory"
  }
}

"VDBE Instruction Architecture"."Instruction Register Map"."0x00" -> "VDBE Instruction Architecture"."Field Logic Microscope"."Opcode": "Mapping"
"VDBE Instruction Architecture"."Instruction Register Map"."0x10" -> "VDBE Instruction Architecture"."Field Logic Microscope"."P4": "Pointer Access"

# Inter-component linking
"VDBE Instruction Architecture" -> "milestone-3": "Part of VDBE Engine" {
  style.stroke-dash: 5
}