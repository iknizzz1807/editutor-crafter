vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  btree_node: {
    shape: sql_table
    style: {
      stroke-width: 2
      border-radius: 4
      fill: "#ffffff"
    }
  }
  highlight: {
    style: {
      fill: "#B6DDF6"
      stroke: "#3f87a6"
      bold: true
    }
  }
  addition: {
    style: {
      fill: "#ebf3e6"
      stroke: "#167c3c"
      bold: true
    }
  }
  removal: {
    style: {
      fill: "#ffcfcf"
      stroke: "#ca052b"
      bold: true
    }
  }
}

"B-Tree Operations Atlas": {
  link: "#milestone-4"
  
  "I. THE SEARCH TRAVERSAL": {
    link: "#milestone-4"
    "Search Algorithm Logic": |'md
    ### O(log N) Search
    1. Start at **Root**.
    2. Binary search keys within page.
    3. Follow pointer to **Internal Node**.
    4. Repeat until **Leaf** reached.
    5. Linear/Binary search Leaf for final row.
    '| {
      shape: text
    }

    "Root Page 100": {
      class: btree_node
      link: "#milestone-4"
      "ptr_0": "ptr"
      "key_20": "20"
      "ptr_1": "ptr" {class: highlight}
      "key_50": "50"
      "ptr_2": "ptr"
    }

    "Internal Page 105": {
      class: btree_node
      link: "#milestone-4"
      "ptr_0": "ptr"
      "key_30": "30" {class: highlight}
      "ptr_1": "ptr" {class: highlight}
      "key_40": "40"
      "ptr_2": "ptr"
    }

    "Leaf Page 110": {
      class: btree_node
      link: "#milestone-4"
      "key_32": "32"
      "key_35": "35 (MATCH)" {class: highlight}
      "key_38": "38"
    }

    "Root Page 100"."ptr_1" -> "Internal Page 105": "20 < X < 50" {style.stroke: "#3f87a6"}
    "Internal Page 105"."ptr_1" -> "Leaf Page 110": "30 < X < 40" {style.stroke: "#3f87a6"}
  }

  "II. INSERTION STATE TRANSITION": {
    link: "#milestone-4"
    
    "Before State": {
      "Full Leaf Node": {
        class: btree_node
        "k1": "10"
        "k2": "20"
        "k3": "30"
      }
      "Pending Data": "INSERT 25" {
        shape: package
        class: addition
      }
    }

    "Transition": "Split Logic" {
      shape: step
      style.animated: true
      link: "#milestone-4"
    }

    "After State": {
      "Parent Node": {
        class: btree_node
        "p_left": "ptr"
        "key_middle": "20" {class: highlight}
        "p_right": "ptr"
      }
      "New Leaf L": {
        class: btree_node
        "k1": "10"
      }
      "New Leaf R": {
        class: btree_node
        "k1": "25" {class: addition}
        "k2": "30"
      }
      "Parent Node"."p_left" -> "New Leaf L"
      "Parent Node"."p_right" -> "New Leaf R"
    }

    "Before State" -> "Transition" -> "After State"
  }

  "III. DELETION REBALANCING": {
    link: "#milestone-4"

    "Borrow Scenario": "Rotation from Sibling" {
      "P": "Parent" {
        class: btree_node
        "k": "50"
      }
      "L": "Left (Underflow)" {
        class: btree_node
        "k": "DEL 40" {class: removal}
      }
      "R": "Right (Rich Sibling)" {
        class: btree_node
        "k1": "60" {class: highlight}
        "k2": "70"
      }
      "P" -> "L"
      "P" -> "R"

      ("R"."k1" -> "P"."k"): "1. Sibling Key Up" {style.animated: true; style.stroke: blue}
      ("P"."k" -> "L"."k"): "2. Parent Key Down" {style.animated: true; style.stroke: blue}
    }

    "Merge Scenario": "Combining Sparse Pages" {
      "P_M": "Parent" {class: btree_node; "k": "100"}
      "L_M": "Empty" {class: btree_node; "k": "EMPTY"}
      "R_M": "Sibling" {class: btree_node; "k": "110"}
      
      "Merged Result": {
        class: btree_node
        "k1": "100" {class: highlight}
        "k2": "110"
      }

      "L_M" -> "Merged Result": "Coalesce" {style.stroke-dash: 3}
      "R_M" -> "Merged Result": "Coalesce" {style.stroke-dash: 3}
    }
  }

  "IV. PAGE MEMORY LAYOUT": {
    link: "#milestone-4"
    "4KB Page Anatomy": {
      grid-columns: 1
      grid-gap: 0

      "Header": "SQLite Page Header (100 Bytes)" {
        tooltip: "Flags, Freeblock Offset, Cell Count, Content Start"
        style.fill: "#DEE1EB"
        link: "#milestone-4"
      }

      "PtrArray": "Cell Pointer Array (Sorted)" {
        style.fill: "#C7F1FF"
        "p0": "0x0F80"
        "p1": "0x0F20"
        "pn": "..."
      }

      "Gap": "Free Space / High-Water Mark" {
        style.stroke-dash: 5
        style.fill: transparent
        "description": "Pointers grow DOWN, Cells grow UP" {shape: text}
      }

      "Cells": "Cell Payloads (Records)" {
        style.fill: "#E4DBFE"
        "cell_n": "Record N (ID: 38)"
        "cell_1": "Record 1 (ID: 35)"
        "cell_0": "Record 0 (ID: 32)"
      }
    }

    "4KB Page Anatomy"."PtrArray"."p0" -> "4KB Page Anatomy"."Cells"."cell_0"
    "4KB Page Anatomy"."PtrArray"."p1" -> "4KB Page Anatomy"."Cells"."cell_1"
  }
}

"Atlas Legend": {
  near: bottom-center
  "S1": "Active Search Path" {class: highlight}
  "S2": "New Data/Allocation" {class: addition}
  "S3": "Deletion/Underflow" {class: removal}
}

"B-Tree Operations Atlas"."I. THE SEARCH TRAVERSAL"."Leaf Page 110"."key_35" -> "B-Tree-Operations-Atlas"."IV. PAGE MEMORY LAYOUT"."4KB Page Anatomy"."Cells"."cell_1": "Physical Map" {
  style.stroke-dash: 5
  style.opacity: 0.5
}