vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

pager_architecture: "Pager Subsystem: The I/O Sentinel" {
  link: "#milestone-4"
  tooltip: "Manages the translation between logical B-Tree pages and physical disk blocks."
  style: {
    stroke-width: 4
    fill: "#f8f9fa"
  }

  page_cache_ram: "Page Cache (Volatile RAM)" {
    link: "#milestone-4"
    style: {
      fill: "#e3f2fd"
      stroke: "#1565c0"
    }

    cache_grid: "" {
      grid-columns: 4
      p1: "Page 1" { 
        style: { fill: "#bbdefb"; stroke-width: 2 }
        status: "CLEAN" { shape: text; style: { font-color: green; font-size: 10 } }
      }
      p2: "Page 2" { 
        style: { fill: "#ffccbc"; stroke: "#d84315"; stroke-width: 3 }
        status: "DIRTY" { shape: text; style: { font-color: red; font-size: 10; bold: true } }
      }
      p3: "Page 3" { 
        style: { fill: "#bbdefb" }
        status: "PINNED" { shape: text; style: { font-color: blue; font-size: 10 } }
      }
      p4: "Page 4" { style: { fill: "#f5f5f5"; stroke-dash: 3 } }
    }

    microscope_page_view: "Microscope View: Page #2 Buffer" {
      style: { stroke-dash: 5 }
      layout: |'md
        | Offset | Content | Size |
        | :--- | :--- | :--- |
        | 0x00 | Page Header (Flags, Checksum) | 100B |
        | 0x64 | Cell Pointer Array | Var |
        | ... | Unallocated Space | Var |
        | 0xFF | Cell Content Area (Row Data) | Var |
      '|
    }
  }

  control_structures: "Control Metadata (The Tracker)" {
    link: "#milestone-4"
    
    page_control_block: {
      shape: sql_table
      style: { fill: "#fff9c4" }
      pg_no: uint32 {constraint: PK}
      cache_idx: int {constraint: pointer}
      is_dirty: boolean
      pin_count: int
      last_access: timestamp
    }

    lru_eviction_queue: "LRU Eviction Queue" {
      shape: queue
      direction: right
      style: { fill: "#fce4ec" }
      least_recent -> "..." -> most_recent
    }
  }

  dirty_page_tracking: "Dirty Page Pipeline" {
    link: "#milestone-4"
    direction: right
    
    mutator: "VDBE Writer" {
      shape: person
    }

    write_flow: "Mark Dirty" {
      style: { stroke: red; animated: true; bold: true }
    }

    mutator -> page_cache_ram.cache_grid.p2: write_flow
    page_cache_ram.cache_grid.p2 -> control_structures.page_control_block.is_dirty: "Set True"
  }

  disk_io_coordinator: "Disk I/O Coordinator" {
    link: "#milestone-4"
    
    os_interface: "OS VFS Layer" {
      shape: package
      style: { fill: "#cfd8dc" }
      open: "open()"
      read: "pread()"
      write: "pwrite()"
      sync: "fsync()"
    }

    flush_logic: "Flush / Checkpoint" {
      shape: step
      style: { fill: "#ffe0b2" }
    }

    wal_file: "Write-Ahead Log (WAL)" {
      shape: cylinder
      style: { fill: "#b2dfdb" }
    }

    main_db: "Main Database (.db)" {
      shape: cylinder
      style: { fill: "#80cbc4" }
    }
  }

  # Orchestration Connections
  control_structures.page_control_block -> page_cache_ram.cache_grid: "Lookup Index"
  page_cache_ram.cache_grid.p2 -> disk_io_coordinator.flush_logic: "Eviction / Commit"
  disk_io_coordinator.flush_logic -> disk_io_coordinator.wal_file: "1. Append Log"
  disk_io_coordinator.wal_file -> disk_io_coordinator.main_db: "2. Checkpoint"
  disk_io_coordinator.main_db -> disk_io_coordinator.os_interface: "Hardware Sync"
}

legend: "State Legend" {
  near: bottom-right
  clean: "Clean (In Sync with Disk)" {
    style: { fill: "#bbdefb" }
  }
  dirty: "Dirty (RAM Modified)" {
    style: { fill: "#ffccbc"; stroke: "#d84315" }
  }
  pinned: "Pinned (Active Process Use)" {
    style: { fill: "#bbdefb"; stroke: blue }
  }
}