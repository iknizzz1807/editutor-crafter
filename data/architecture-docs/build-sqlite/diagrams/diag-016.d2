vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# ARCHITECTURAL CLASSES
classes: {
  page_frame: {
    shape: rectangle
    width: 250
    height: 320
    style: {
      stroke-width: 2
      border-radius: 4
      fill: "#ffffff"
      shadow: true
    }
  }
  pinned_active: {
    style: {
      double-border: true
      stroke: "#1976d2"
      stroke-width: 4
    }
  }
  dirty_modified: {
    style: {
      fill: "#fff3e0"
      stroke: "#ef6c00"
    }
  }
  eviction_candidate: {
    style: {
      fill: "#f5f5f5"
      stroke: "#9e9e9e"
      stroke-dash: 5
    }
  }
  thread_context: {
    shape: person
    style: {
      fill: "#e8f5e9"
      stroke: "#2e7d32"
    }
  }
}

# SYSTEM TITLE
title: |'md
### PAGE CACHE INTERNALS: LRU & PINNING
**Microscope View**: Memory management between **Milestone 4** and **Milestone 9**.
'| {
  near: top-center
  link: "#satellite-map"
}

# BUFFER POOL (THE RAM WAREHOUSE)
buffer_pool: "RAM: PAGE CACHE / BUFFER POOL" {
  link: "#milestone-4"
  style: {
    fill: "#eceff1"
    stroke: "#607d8b"
    stroke-width: 3
  }

  pages: {
    grid-columns: 3
    grid-gap: 20

    # PAGE 102: THE HOT ROOT
    p102: "PAGE_102 (B-Tree Root)" {
      class: [page_frame; pinned_active; dirty_modified]
      link: "#milestone-4"

      header: "PAGE_CONTROL_BLOCK (PCB)" {
        shape: sql_table
        style.fill: "#cfd8dc"
        id: "PG_ID: 102"
        addr: "MEM_ADDR: 0x7FFF001"
        pins: "PIN_COUNT: 2" {style.bold: true; style.font-color: "#1976d2"}
        dirty: "DIRTY_BIT: 1" {style.bold: true; style.font-color: "#ef6c00"}
        lsn: "LOG_SEQ_NUM: 8840"
      }

      content: "HEX_DUMP (4KB)" {
        style.font: mono
        style.font-size: 10
        |'c
        [0000] 0D 00 00 00 01 04 00 00
        [0008] 0F C0 00 00 00 00 00 00
        [0010] 21 44 52 4F 4F 54 5F 58
        '|
      }
    }

    # PAGE 405: INTERNAL NODE
    p405: "PAGE_405 (Index Node)" {
      class: [page_frame; pinned_active]
      link: "#milestone-4"

      header: "PAGE_CONTROL_BLOCK (PCB)" {
        shape: sql_table
        style.fill: "#cfd8dc"
        id: "PG_ID: 405"
        addr: "MEM_ADDR: 0x8A22004"
        pins: "PIN_COUNT: 1" {style.bold: true}
        dirty: "DIRTY_BIT: 0"
        lsn: "LOG_SEQ_NUM: 8812"
      }

      content: "HEX_DUMP (4KB)" {
        style.font: mono
        style.font-size: 10
        |'c
        [0000] 05 00 00 00 04 01 02 00
        [0008] 00 00 01 95 00 00 01 AE
        '|
      }
    }

    # PAGE 012: STALE DATA
    p012: "PAGE_012 (Inactive Leaf)" {
      class: [page_frame; eviction_candidate]
      link: "#milestone-4"

      header: "PAGE_CONTROL_BLOCK (PCB)" {
        shape: sql_table
        style.fill: "#cfd8dc"
        id: "PG_ID: 12"
        addr: "MEM_ADDR: 0x1122009"
        pins: "PIN_COUNT: 0" {style.bold: true; style.font-color: "#d32f2f"}
        dirty: "DIRTY_BIT: 0"
        lsn: "LOG_SEQ_NUM: 1020"
      }

      content: "HEX_DUMP (4KB)" {
        style.font: mono
        style.font-size: 10
        |'c
        [0000] 0A 00 00 00 00 00 00 00
        '|
      }
    }
  }
}

# EXECUTORS (THE THREADS)
executors: "VDBE THREADS (Milestone 3/9)" {
  link: "#milestone-3"
  
  tx_alpha: "Thread Alpha\n(Writer)" {
    class: thread_context
    link: "#milestone-9"
  }
  
  tx_beta: "Thread Beta\n(Reader)" {
    class: thread_context
    link: "#milestone-9"
  }
}

# INTERACTION: PINNING
executors.tx_alpha -> buffer_pool.pages.p102.header.pins: "1. Lock Exclusive\n2. atomic_inc(pins)" {
  style: {
    stroke: "#1976d2"
    stroke-width: 3
    animated: true
  }
  link: "#milestone-9"
}

executors.tx_beta -> buffer_pool.pages.p102.header.pins: "atomic_inc(pins)" {
  style: {
    stroke: "#1976d2"
    stroke-dash: 3
  }
}

# EVICTION LOGIC (THE SENTINEL)
lru_logic: "LRU EVICTION MANAGER" {
  link: "#milestone-4"
  
  stack: {
    shape: queue
    mru: "MRU (Most Recent)"
    mid: "..."
    lru: "LRU (Least Recent)"
    
    mru -> mid -> lru
  }

  rule: |'md
  **Victim Selection**
  IF `pin_count == 0`
  AND `dirty == 0`
  THEN **EVICT**
  '|
}

lru_logic.stack.lru -> buffer_pool.pages.p012: "Select Victim" {
  style: {
    stroke: "#d32f2f"
    stroke-width: 2
  }
  target-arrowhead: cross
}

# DISK PERSISTENCE
disk: "DISK (Milestone 4)" {
  shape: cylinder
  link: "#milestone-4"
  db_file: "sqlite_db_pages" {
    shape: sql_table
    p1: "Root B-Tree Page"
    p12: "Leaf Page 12"
    p405: "Internal Node 405"
  }
}

# DATA FLOWS
buffer_pool.pages.p102 -> disk.db_file.p1: "Checkpoint: Flush Dirty" {
  link: "#milestone-6"
  style: {
    stroke: "#ef6c00"
    stroke-dash: 5
    animated: true
  }
}

disk.db_file.p405 -> buffer_pool.pages.p405: "Pager: Fault In" {
  style: {
    stroke: "#4caf50"
    stroke-width: 2
  }
}

# KNOWLEDGE ANNOTATIONS
annotation: |'md
### ARCHITECTURAL NOTES
- **Atomic Operations**: `pin_count` must be modified using **Atomic Compare-and-Swap (CAS)** to prevent a Thread (M3) from using a page as it is being evicted by the LRU Manager (M4).
- **Temporal Locality**: The LRU Queue ensures that the "B-Tree Root" (M4) remains in RAM while "Stale Leaves" are recycled.
- **Write-Ahead Log (M6)**: Dirty pages (like P102) are only flushed to disk *after* the corresponding WAL entry is `fsync()`'d.
'| {
  near: bottom-right
  style.fill: "#fffde7"
  style.stroke: "#fbc02d"
}

# STYLING GLOBALS
***.style.font: mono
(*** -> ***)[*]: {
  style.font-size: 11
}<ctrl63>