vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# ----------------------------------------------------------------------------------
# THE DATABASE HEADER ATLAS
# ----------------------------------------------------------------------------------

sqlite_header_blueprint: "DATABASE FILE HEADER (100-BYTE LAYOUT)" {
  link: "#milestone-4"
  style: {
    stroke-width: 4
    fill: "#1a1a1a"
    font-color: "#ffffff"
    shadow: true
  }

  layout: {
    shape: sql_table
    link: "#milestone-4"
    style.fill: "#2d2d2d"

    "Byte Offset": "Field Name / Purpose" {constraint: "Data Type"}
    "0-15": "Magic String: 'SQLite format 3\\0'" {constraint: "Text[16B]"}
    "16-17": "Page Size (512 to 65536)" {
      constraint: "uint16[BigEndian]"
      link: "#milestone-4"
    }
    "18": "File format write version" {constraint: "uint8"}
    "19": "File format read version" {constraint: "uint8"}
    "20": "Reserved space per page" {constraint: "uint8"}
    "24-27": "File Change Counter" {
      constraint: "uint32"
      link: "#milestone-6"
    }
    "28-31": "Database size in pages" {constraint: "uint32"}
    "40-43": "Schema Cookie" {
      constraint: "uint32"
      link: "#milestone-5"
    }
    "44-47": "Schema Format Number" {constraint: "uint32"}
    "64-67": "Incremental-vacuum mode" {constraint: "uint32"}
    "92-95": "Version-valid-for number" {constraint: "uint32"}
  }
}

# ----------------------------------------------------------------------------------
# MICROSCOPE VIEW: BYTE-TO-BIT RESOLUTION
# ----------------------------------------------------------------------------------

endian_resolution: "MICROSCOPE: PAGE_SIZE ENDIANNESS" {
  near: top-right
  link: "#milestone-4"
  style.stroke: "#4a2e2e"

  memory_bits: {
    grid-columns: 2
    grid-gap: 15

    byte_16: "BYTE 0x10 (MSB)" {
      grid-columns: 8
      style.fill: "#3d1e1e"
      b7: "0"; b6: "0"; b5: "0"; b4: "1"; b3: "0"; b2: "0"; b1: "0"; b0: "0"
    }
    byte_17: "BYTE 0x11 (LSB)" {
      grid-columns: 8
      style.fill: "#3d1e1e"
      b7: "0"; b6: "0"; b5: "0"; b4: "0"; b3: "0"; b2: "0"; b1: "0"; b0: "0"
    }
  }

  math: |'md
    ### Big-Endian Recombination
    In SQLite, numbers are stored MSB-first.
    
    **Formula:**
    `val = (Byte[16] << 8) | Byte[17]`
    
    **Calculation:**
    `(0x10 << 8) | 0x00` = `0x1000` = **4096 Bytes**
  '|
}

# ----------------------------------------------------------------------------------
# STATE TRANSITION: THE FILE CHANGE COUNTER
# ----------------------------------------------------------------------------------

atomicity_view: "STATE TRANSITION: DURABLE COUNTER UPDATE" {
  near: bottom-left
  link: "#milestone-6"
  direction: right

  before_state: "RAM CACHE (Dirty)" {
    shape: rectangle
    style: {
      fill: "#2d2d2d"
      stroke: "#f39c12"
      stroke-dash: 3
    }
    offset_24: "0x00 0x00 0x04 0x12" {
      link: "#milestone-6"
      label: "Value: 1042"
    }
  }

  write_op: "WAL_LOG_APPEND" {
    shape: step
    style.animated: true
    link: "#milestone-6"
  }

  after_state: "DISK PERSISTENCE (Sync'd)" {
    shape: rectangle
    style: {
      fill: "#1e3a1e"
      stroke: "#2ecc71"
      stroke-width: 3
    }
    offset_24: "0x00 0x00 0x04 0x13" {
      link: "#milestone-6"
      label: "Value: 1043"
    }
  }

  before_state -> write_op: "COMMIT Issued"
  write_op -> after_state: "fsync() Barrier"
}

# ----------------------------------------------------------------------------------
# KNOWLEDGE INTERCONNECTIONS
# ----------------------------------------------------------------------------------

sqlite_header_blueprint.layout."16-17" -> endian_resolution: "Bitwise Interpretation" {
  style.stroke: "#e74c3c"
  style.stroke-width: 2
}

sqlite_header_blueprint.layout."24-27" -> atomicity_view: "Transaction Logic" {
  style.stroke: "#3498db"
  style.stroke-width: 2
  style.stroke-dash: 5
}

# ----------------------------------------------------------------------------------
# LEGEND & CONTEXT
# ----------------------------------------------------------------------------------

legend: "KNOWLEDGE PILLARS" {
  near: bottom-right
  
  pager: "Milestone 4: The Pager" {
    link: "#milestone-4"
    style.fill: "#4a2e2e"
  }
  acid: "Milestone 6: ACID/WAL" {
    link: "#milestone-6"
    style.fill: "#b35900"
  }
  schema: "Milestone 5: The Planner" {
    link: "#milestone-5"
    style.fill: "#4a2e4a"
  }
}