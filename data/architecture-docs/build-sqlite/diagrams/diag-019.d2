vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# -----------------------------------------------------------------------------
# THE STRATEGIST: QUERY PLANNER COMPONENTS
# -----------------------------------------------------------------------------

QueryPlanner: "THE STRATEGIST (Query Planner)" {
  link: "#milestone-5"
  style: {
    stroke: "#4a90e2"
    stroke-width: 4
    fill: "#1a1a2e"
    font-color: "#ffffff"
  }

  # --- 1. PARSER INTEGRATION ---
  ParserIntegration: "1. Parser Integration & Normalizer" {
    link: "#milestone-2"
    AST: "Abstract Syntax Tree" {
      shape: diamond
      style.fill: "#16213e"
    }
    Rewriter: "Query Rewriter" {
      tooltip: "Converts subqueries to joins, collapses constants (e.g., 1+1 to 2)"
    }
    AST -> Rewriter: "Raw Tree"
    Rewriter -> NormalizedTree: "Canonical Form"
    
    NormalizedTree: "Normalized AST" {
      shape: parallelogram
      style.stroke-dash: 3
    }
  }

  # --- 2. STATISTICS COLLECTOR ---
  StatsCollector: "2. Statistics Collector (The Librarian)" {
    link: "#milestone-4"
    Metadata: "Internal Statistics Table" {
      shape: sql_table
      style.fill: "#0f3460"
      table_name: string {constraint: PK}
      row_count: int
      index_selectivity: float
      avg_row_width: int
      last_vacuum: timestamp
    }

    SamplingEngine: "Sampler" {
      tooltip: "Performs Reservoir Sampling on B-Tree pages"
      shape: step
    }

    SamplingEngine -> Metadata: "Update Histograms"
  }

  # --- 3. COST ESTIMATOR ---
  CostEstimator: "3. Cost-Based Estimator (The Mathematician)" {
    CostFunction: |'md
      ### Estimator Weights
      - **W_IO**: 1.0 (Sequential)
      - **W_RAND_IO**: 40.0 (Random)
      - **W_CPU**: 0.01 (Processing)
      
      `Cost = (Pages * W_IO) + (Rows * W_CPU)`
    '|

    ComparisonMatrix: "Plan Candidates" {
      grid-columns: 2
      Plan_A: "Full Scan" {
        style.fill: "#e94560"
        Cost: "940.2"
      }
      Plan_B: "Index Seek" {
        style.fill: "#00d1ff"
        Cost: "12.5"
      }
    }
    
    StatsCollector.Metadata -> ComparisonMatrix: "Provide Cardinality"
    CostFunction -> ComparisonMatrix: "Apply Weights"
  }

  # --- 4. PLAN GENERATOR ---
  PlanGenerator: "4. Plan Generator & Bytecode Emitter" {
    link: "#milestone-3"
    OpcodeFactory: "Opcode Factory" {
      shape: hexagon
    }
    
    EmitBuffer: "VDBE Program Counter Queue" {
      shape: queue
      "0: OpenRead"
      "1: Rewind"
      "2: Column"
      "3: ResultRow"
      "4: Next"
    }

    OpcodeFactory -> EmitBuffer: "Serialize"
  }
}

# -----------------------------------------------------------------------------
# STATE TRANSITION: BEFORE VS AFTER OPTIMIZATION
# -----------------------------------------------------------------------------

TransformView: "PLAN TRANSFORMATION (Microscope View)" {
  style.fill: "#16213e"

  InputQuery: "Unoptimized Join Tree" {
    UsersTable: "SCAN [users]"
    OrdersTable: "SCAN [orders]"
    Join: "NESTED LOOP JOIN"
    
    UsersTable -> Join
    OrdersTable -> Join
    style.stroke: "#e94560"
  }

  OptimizerProcess: "Cost-Based Choice" {
    shape: diamond
    style.fill: "#0f3460"
  }

  OutputQuery: "Optimized Physical Plan" {
    IndexIdx: "SEARCH [idx_user_id]"
    MainTable: "ROWID LOOKUP [users]"
    Join: "INDEX JOIN"
    
    IndexIdx -> MainTable: "Pointer"
    MainTable -> Join
    style.stroke: "#00d1ff"
  }

  InputQuery -> OptimizerProcess: "AST"
  OptimizerProcess -> OutputQuery: "Pick Lowest Cost"
}

# -----------------------------------------------------------------------------
# INTER-MILESTONE CONNECTIVITY
# -----------------------------------------------------------------------------

"Parser (M2)" -> QueryPlanner.ParserIntegration: "AST" {
  link: "#milestone-2"
  style.stroke: "#00d1ff"
  style.animated: true
}

QueryPlanner.PlanGenerator -> "VDBE (M3)": "Bytecode" {
  link: "#milestone-3"
  style.stroke: "#00d1ff"
  style.stroke-width: 3
}

QueryPlanner.StatsCollector -> "Warehouse (M4)": "Disk I/O" {
  link: "#milestone-4"
  style.stroke-dash: 5
}

# Legend and Global Context
Legend: {
  near: bottom-right
  IndexSeek: "Index Seek Plan" {
    style.fill: "#00d1ff"
  }
  FullScan: "Table Scan (Slow)" {
    style.fill: "#e94560"
  }
}