vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: down

User: {
  shape: person
  link: "#anchor-repl"
}

REPL_Process: "REPL Infinite Loop" {
  link: "#anchor-repl"
  style: {
    fill: "#f7f9fb"
    stroke: "#555"
    stroke-width: 2
    shadow: true
  }

  Prompt: "printf('db > ')" {
    shape: parallelogram
    link: "#anchor-repl"
  }

  Input_Handling: {
    style: {
      fill: "transparent"
      stroke: transparent
      stroke-width: 0
    }
    
    GetLine: "getline()" {
      shape: step
      tooltip: "Dynamic Buffer Allocation"
      link: "#anchor-repl"
    }

    # Microscope View: Memory Layout
    Memory_State: "InputBuffer State" {
      shape: package
      link: "#anchor-repl"
      style.fill: "#ffffff"
      
      Struct: "struct InputBuffer" {
        shape: class
        # Representation of the C struct fields
        +buffer: "char* (0x00F4)"
        +buffer_len: "size_t (128)"
        +input_len: "ssize_t (6)"
      }

      Heap: "Heap Memory (0x00F4)" {
        shape: queue
        style.fill: "#e1e4e8"
        
        # Visualizing the bytes in memory
        content: |c
          ['.', 'e', 'x', 'i', 't', '\0', ...]
        | {
            shape: text
            style.font: mono
        }
      }
      
      Struct -> Heap: "points to"
    }
  }

  # Hardware Optimization Logic
  Router: "Command Router" {
    shape: diamond
    label: "buffer[0] == '.'"
    tooltip: "Branch Prediction Optimization"
    link: "#anchor-repl"
  }

  # Path 1: Meta Commands
  Meta_Path: "Meta-Command Handler" {
    style: {
      fill: "#ffebee"
      stroke: "#ef9a9a"
    }
    link: "#anchor-repl"
    
    Logic: |c
      switch (command) {
        case ".exit": exit(0);
        case ".tables": list_tables();
      }
    |
  }

  # Path 2: SQL Statements
  SQL_Path: "SQL Compiler" {
    style: {
      fill: "#e8f5e9"
      stroke: "#a5d6a7"
    }
    link: "#anchor-repl"
    
    Phases: {
      grid-rows: 1
      Tokenizer -> Parser -> Generator -> VM
    }
  }

  Output: "Format & Print" {
    shape: document
    link: "#anchor-repl"
  }
}

# Data Flow Connections
User -> REPL_Process.Prompt: "Stdin"
REPL_Process.Prompt -> REPL_Process.Input_Handling.GetLine: "Wait for input"
REPL_Process.Input_Handling.GetLine -> REPL_Process.Input_Handling.Memory_State: "Populates"
REPL_Process.Input_Handling.Memory_State -> REPL_Process.Router: "Read buffer[0]"

# Routing Logic
REPL_Process.Router -> REPL_Process.Meta_Path: "True (Meta)" {
  style: {
    stroke: "#d32f2f"
    stroke-width: 2
    stroke-dash: 3
  }
}

REPL_Process.Router -> REPL_Process.SQL_Path: "False (SQL)" {
  style: {
    stroke: "#388e3c"
    stroke-width: 2
  }
}

# Convergence & Loop
REPL_Process.Meta_Path -> REPL_Process.Output: "Result"
REPL_Process.SQL_Path -> REPL_Process.Output: "Result"

REPL_Process.Output -> REPL_Process.Prompt: "Loop Continue" {
  style: {
    stroke: "#555"
    stroke-dash: 3
  }
}