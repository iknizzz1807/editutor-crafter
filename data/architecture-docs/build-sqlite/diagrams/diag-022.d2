vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# GLOBAL STYLES & CLASSES
classes: {
  engine_opcode: {
    shape: step
    style: {
      fill: "#f1f5f9"
      stroke: "#475569"
      font: mono
    }
  }
  metric_stat: {
    style: {
      stroke-width: 0
      fill: transparent
      font-size: 12
    }
  }
  hot_path: {
    style: {
      stroke: "#ef4444"
      stroke-width: 2
      animated: true
    }
  }
  cold_path: {
    style: {
      stroke: "#10b981"
      stroke-width: 2
    }
  }
}

# THE EXECUTION PLAN COMPARISON
"Execution Plan Comparison": {
  link: "#satellite-map"
  tooltip: "Return to System Atlas"

  # UNOPTIMIZED EXECUTION (PLAN A)
  "Plan A: Full Table Scan": {
    link: "#milestone-3"
    direction: right
    style: {
      fill: "#fff1f2"
      stroke: "#be123c"
      stroke-width: 2
    }

    "M3: VDBE Instructions": {
      "Op 0: OpenRead": "Cursor 0 -> Table 'users'" {class: engine_opcode}
      "Op 1: Rewind": "Start at Row 0" {class: engine_opcode}
      "Op 2: Column": "R[1] = row.id" {class: engine_opcode}
      "Op 3: Eq": "if R[1] == 500 jump 5" {class: engine_opcode}
      "Op 4: Next": "Advance row, jump 2" {class: engine_opcode}
      "Op 5: Result": "Return R[1]" {class: engine_opcode}

      "Op 0: OpenRead" -> "Op 1: Rewind"
      "Op 1: Rewind" -> "Op 2: Column"
      "Op 2: Column" -> "Op 3: Eq"
      "Op 3: Eq" -> "Op 4: Next": "MISMATCH" {class: hot_path}
      "Op 4: Next" -> "Op 2: Column": "N iterations" {style.stroke-dash: 3}
      "Op 3: Eq" -> "Op 5: Result": "MATCH"
    }

    "M4: Physical Cost": {
      link: "#milestone-4"
      grid-rows: 1
      "I/O Operations": "100,000 Reads" {style.font-color: "#be123c"; style.bold: true}
      "Cache impact": "Total Flush"
      "Complexity": "O(N)"
    }
  }

  # THE OPTIMIZER INTERVENTION
  "Strategist (M5)": {
    shape: diamond
    label: "Cost-Based\nOptimizer"
    link: "#milestone-5"
    style: {
      fill: "#fef9c3"
      stroke: "#ca8a04"
      stroke-width: 4
    }
  }

  # OPTIMIZED EXECUTION (PLAN B)
  "Plan B: Index Seek": {
    link: "#milestone-3"
    direction: right
    style: {
      fill: "#f0fdf4"
      stroke: "#15803d"
      stroke-width: 2
    }

    "M3: VDBE Instructions": {
      "Op 0: OpenRead": "Cursor 0 -> Index 'idx_id'" {class: engine_opcode}
      "Op 1: SeekGe": "B-Tree Binary Search(500)" {class: engine_opcode}
      "Op 2: IdxRowid": "R[1] = PagePtr" {class: engine_opcode}
      "Op 3: SeekRowid": "Point Cursor 1 to R[1]" {class: engine_opcode}
      "Op 4: Result": "Return row" {class: engine_opcode}

      "Op 0: OpenRead" -> "Op 1: SeekGe"
      "Op 1: SeekGe" -> "Op 2: IdxRowid": "Log(N) depth" {class: cold_path}
      "Op 2: IdxRowid" -> "Op 3: SeekRowid"
      "Op 3: SeekRowid" -> "Op 4: Result"
    }

    "M4: Physical Cost": {
      link: "#milestone-4"
      grid-rows: 1
      "I/O Operations": "3-4 Reads" {style.font-color: "#15803d"; style.bold: true}
      "Cache impact": "Surgical"
      "Complexity": "O(log N)"
    }
  }

  "Plan A: Full Table Scan" -> "Strategist (M5)": "Query Parser Tree"
  "Strategist (M5)" -> "Plan B: Index Seek": "Verified Path"
}

# WAREHOUSE MICROSCOPE (M4)
"Warehouse Memory Layout (B-Tree)": {
  near: top-center
  link: "#milestone-4"
  
  "Index Page #12 (Sorted)": {
    shape: sql_table
    style: {stroke: "#0ea5e9"}
    header: "B+Tree Internal Node"
    key_490: "490 | Ptr: Page 100"
    key_500: "500 | Ptr: Page 402" {style.fill: "#bae6fd"; style.bold: true}
    key_510: "510 | Ptr: Page 102"
  }

  "Data Page #402 (Heap)": {
    shape: sql_table
    style: {stroke: "#64748b"}
    header: "B+Tree Leaf Node (Actual Row)"
    row_A: "ID: 499 | User: 'Eve'"
    row_B: "ID: 500 | User: 'Bob'" {style.fill: "#bbf7d0"; style.bold: true}
    row_C: "ID: 501 | User: 'Zoe'"
  }

  "Index Page #12 (Sorted)".key_500 -> "Data Page #402 (Heap)".row_B: "Pointer Dereference" {
    style: {stroke: "#0ea5e9"; stroke-width: 2; stroke-dash: 4; animated: true}
  }
}

# SERIALIZATION MICROSCOPE (M7)
"M7 Microscope: Record Serialization": {
  near: bottom-left
  link: "#milestone-7"
  
  "Row Data In-Memory": {
    style.fill: "#f8fafc"
    "Header Segment": {
      grid-columns: 3
      style.fill: "#e2e8f0"
      h1: "Size: 0x03"
      h2: "Type: VarInt(1)"
      h3: "Type: VarInt(13)"
    }
    "Body Segment": {
      grid-columns: 2
      style.fill: "#f1f5f9"
      b1: "Data: 0x01F4 (500)"
      b2: "Data: 'Bob'"
    }
    "Header Segment" -> "Body Segment": "Offset Mapping"
  }
}

# PERFORMANCE METRICS TABLE
"Comparison Metrics": |'md
### Benchmarking: Scan vs. Seek
| Dimension | Table Scan (M4/M3) | Index Seek (M5/M4) | Î” Efficiency |
| :--- | :--- | :--- | :--- |
| **B-Tree Access** | Linear Iterator | Root-to-Leaf Path | **99,997% less work** |
| **Instruction Count** | ~500k Opcodes | ~15 Opcodes | **Massive CPU relief** |
| **Disk Thrashing** | High (Sequential) | Low (Random) | **N/A (Cache Friendly)** |
| **Memory Footprint** | Page Cache Eviction | Single Page Load | **Minimal** |
'| {
  near: top-right
  shape: text
}

"Execution Plan Comparison".style.fill: "#fafafa"
"Warehouse Memory Layout (B-Tree)".style.stroke: "#94a3b8"
"M7 Microscope: Record Serialization".style.stroke: "#94a3b8"