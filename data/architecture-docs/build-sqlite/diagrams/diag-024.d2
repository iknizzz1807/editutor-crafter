vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# ARCHITECTURAL VISUALIZATION: THE SENTINEL (MILESTONE 9)
# Mapping the transition of SQLite's locking states and hardware synchronization.

direction: right

title: |md
  # MILESTONE 9: THE SENTINEL
  ## Concurrency, Latches, and Lock Hierarchies
| {
  near: top-center
  link: "#milestone-9"
}

# --- LOCK STATE TRANSITION MACHINE ---
# Illustrates the "Before" and "After" of lock acquisition.

locking_state_machine: {
  label: "SQLite Lock State Machine"
  link: "#milestone-9"

  unlocked: "UNLOCKED" {
    shape: circle
    style.stroke-width: 4
    link: "#milestone-9"
  }

  shared: "SHARED (S)" {
    tooltip: "Multiple readers, zero writers. Disk is Read-Only."
    style.fill: "#D1E7DD"
    link: "#milestone-9"
  }

  reserved: "RESERVED (R)" {
    tooltip: "One writer preparing to work. Existing readers continue."
    style.fill: "#FFF3CD"
    link: "#milestone-9"
  }

  pending: "PENDING (P)" {
    tooltip: "Writer waiting for readers to exit. New readers BLOCKED."
    style.fill: "#F8D7DA"
    link: "#milestone-9"
  }

  exclusive: "EXCLUSIVE (X)" {
    tooltip: "Writer has total control. No readers, no other writers."
    style.fill: "#F5C2C7"
    style.stroke: "#842029"
    link: "#milestone-9"
  }

  unlocked -> shared: "sqlite3_step() (Read)" {
    link: "#milestone-9"
  }
  shared -> reserved: "BEGIN IMMEDIATE (Write Intent)" {
    link: "#milestone-9"
  }
  reserved -> pending: "COMMIT (Enter Queue)" {
    link: "#milestone-9"
  }
  pending -> exclusive: "Last Reader Exits (All Clear)" {
    link: "#milestone-9"
    style.stroke: red
    style.animated: true
  }
  exclusive -> unlocked: "Finalize / Rollback" {
    link: "#milestone-9"
  }
}

# --- THE COMPATIBILITY MATRIX ---
# Using a Grid to represent the truth table for lock interactions.

compatibility_matrix: "Lock Compatibility Matrix" {
  link: "#milestone-9"
  grid-columns: 5
  grid-gap: 0
  
  # Header Row
  c_label: "" { style.fill: "#EEE" }
  c_s: "SHARED" { style.fill: "#EEE"; style.bold: true }
  c_r: "RESERVED" { style.fill: "#EEE"; style.bold: true }
  c_p: "PENDING" { style.fill: "#EEE"; style.bold: true }
  c_x: "EXCLUSIVE" { style.fill: "#EEE"; style.bold: true }

  # Shared Row
  r_s: "SHARED" { style.bold: true }
  s_s: "✅ OK" { style.fill: "#D1E7DD" }
  s_r: "✅ OK" { style.fill: "#D1E7DD" }
  s_p: "❌ CONFLICT" { style.fill: "#F8D7DA" }
  s_x: "❌ CONFLICT" { style.fill: "#F8D7DA" }

  # Reserved Row
  r_r: "RESERVED" { style.bold: true }
  res_s: "✅ OK" { style.fill: "#D1E7DD" }
  res_r: "❌ CONFLICT" { style.fill: "#F8D7DA" }
  res_p: "❌ CONFLICT" { style.fill: "#F8D7DA" }
  res_x: "❌ CONFLICT" { style.fill: "#F8D7DA" }

  # Pending Row
  r_p: "PENDING" { style.bold: true }
  pen_s: "❌ CONFLICT" { style.fill: "#F8D7DA" }
  pen_r: "❌ CONFLICT" { style.fill: "#F8D7DA" }
  pen_p: "❌ CONFLICT" { style.fill: "#F8D7DA" }
  pen_x: "❌ CONFLICT" { style.fill: "#F8D7DA" }

  # Exclusive Row
  r_x: "EXCLUSIVE" { style.bold: true }
  exc_s: "❌ CONFLICT" { style.fill: "#F8D7DA" }
  exc_r: "❌ CONFLICT" { style.fill: "#F8D7DA" }
  exc_p: "❌ CONFLICT" { style.fill: "#F8D7DA" }
  exc_x: "❌ CONFLICT" { style.fill: "#F8D7DA" }
}

# --- MICROSCOPE VIEW: MEMORY LATCH LAYOUT ---
# How the Sentinel looks in a 64-byte L1 Cache Line.

memory_layout: {
  label: "CPU Cache Line (64 Bytes) - Latch Alignment"
  link: "#milestone-9"
  
  cache_line: {
    grid-columns: 8
    grid-gap: 2
    
    # 64 bytes total, shown as 8-byte segments
    seg_0: "0x00: Mutex" {
      style.fill: "#FFC107"
      style.bold: true
      tooltip: "Atomic Latch Bit"
      link: "#milestone-9"
    }
    seg_1: "0x08: Flags" { link: "#milestone-9" }
    seg_2: "0x10: OwnerID" { link: "#milestone-9" }
    seg_3: "0x18: Padding" { style.opacity: 0.4 }
    seg_4: "0x20: Waiters" { link: "#milestone-9" }
    seg_5: "0x28: Waiters" { link: "#milestone-9" }
    seg_6: "0x30: Padding" { style.opacity: 0.4 }
    seg_7: "0x38: Checksum" { link: "#milestone-9" }
  }

  atomic_op: "LOCK CMPXCHG" {
    shape: step
    style.stroke: blue
    style.animated: true
  }

  atomic_op -> cache_line.seg_0: "Compare-And-Swap"
}

# --- INTERCONNECTIONS ---

locking_state_machine.exclusive -> compatibility_matrix.r_x: "Governs"
memory_layout.cache_line.seg_0 -> locking_state_machine.unlocked: "Physically Implements"

# --- LEGEND ---

legend: {
  near: bottom-right
  note: |md
    **Sentinel Rules**
    - S: Shared (Reader)
    - R: Reserved (Pending Writer)
    - P: Pending (Writer Gate)
    - X: Exclusive (Active Writer)
  | {
    shape: text
  }
}