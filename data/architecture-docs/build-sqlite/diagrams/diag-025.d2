vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  header_struct: {
    style: {
      fill: "#1e1e2e"
      stroke: "#89b4fa"
      stroke-width: 2
      font-color: "#cdd6f4"
      font: mono
    }
  }
  data_blob: {
    shape: cylinder
    style: {
      fill: "#313244"
      stroke: "#94e2d5"
      font-color: "#cdd6f4"
      fill-pattern: grain
    }
  }
  checksum_node: {
    shape: diamond
    style: {
      fill: "#f38ba8"
      stroke: "#eba0ac"
      font-color: "#11111b"
      bold: true
    }
  }
  binary_field: {
    style: {
      font: mono
      font-size: 10
    }
  }
  step_marker: {
    shape: circle
    style: {
      fill: "#fab387"
      font-color: "#11111b"
      bold: true
    }
  }
}

WAL_SYSTEM: "WAL ARCHITECTURE: THE PROTECTOR" {
  link: "#milestone-6"
  tooltip: "Write-Ahead Log Binary Structure & Integrity Chain"

  # HEADER DEFINITION
  WAL_HEADER: "WAL FILE HEADER (32 Bytes)" {
    shape: sql_table
    class: header_struct
    link: "#milestone-6"

    magic: "Magic Number (4B)" {constraint: "0x377f0682"}
    version: "Format (4B)" {constraint: "3007000"}
    pg_size: "Page Size (4B)" {constraint: "4096"}
    checkpoint: "Checkpoint (4B)" {constraint: "Sequence"}
    salt1: "Salt-1 (4B)"
    salt2: "Salt-2 (4B)"
    ck1: "Checksum-1 (4B)" {style.fill: "#f38ba8"}
    ck2: "Checksum-2 (4B)" {style.fill: "#f38ba8"}
  }

  # FRAME STREAM
  LOG_STREAM: "APPEND-ONLY LOG STREAM" {
    direction: right
    
    FRAME_N: "WAL FRAME [N]" {
      F_HEADER: "Frame Header (24B)" {
        shape: sql_table
        class: header_struct
        link: "#milestone-6"
        pg_no: "Page ID" {constraint: "42"}
        db_size: "Commit Mark" {constraint: "Size/0"}
        s1: "Salt-1"
        s2: "Salt-2"
        c1: "Ck-1" {style.fill: "#f38ba8"}
        c2: "Ck-2" {style.fill: "#f38ba8"}
      }
      F_DATA: "PAGE PAYLOAD (4096B)" {
        class: data_blob
        link: "#milestone-4"
      }
      F_HEADER -> F_DATA: "Metadata"
    }

    FRAME_NEXT: "WAL FRAME [N+1]" {
      F_HEADER: "Frame Header (24B)" {
        shape: sql_table
        class: header_struct
        pg_no: "Page ID" {constraint: "101"}
        db_size: "Commit Mark" {constraint: "Final"}
        s1: "Salt-1"
        s2: "Salt-2"
        c1: "Ck-1" {style.fill: "#f38ba8"}
        c2: "Ck-2" {style.fill: "#f38ba8"}
      }
      F_DATA: "PAGE PAYLOAD (4096B)" {
        class: data_blob
      }
      F_HEADER -> F_DATA
    }

    FRAME_N -> FRAME_NEXT: "Sequential Append" {
      style.stroke-width: 4
      style.animated: true
    }
  }

  # INTEGRITY PROPAGATION
  CHKSUM_CHAIN: "INTEGRITY PROPAGATION CHAIN" {
    near: top-right
    H_HASH: "Header Checksum" {class: checksum_node}
    F1_HASH: "Frame N Checksum" {class: checksum_node}
    F2_HASH: "Frame N+1 Checksum" {class: checksum_node}

    H_HASH -> F1_HASH: "Seeds next"
    F1_HASH -> F2_HASH: "Cumulative"

    NOTE: |'md
      ### Chained Hashing
      Checksums are calculated 
      using the previous frame's 
      result as the seed.
    '| {near: top-center}
  }

  WAL_HEADER.ck1 -> CHKSUM_CHAIN.H_HASH
  LOG_STREAM.FRAME_N.F_HEADER.c1 -> CHKSUM_CHAIN.F1_HASH
  LOG_STREAM.FRAME_NEXT.F_HEADER.c1 -> CHKSUM_CHAIN.F2_HASH
}

# STATE TRANSITION: CHECKPOINTING
CHECKPOINT_PROCESS: "STATE TRANSITION: THE CHECKPOINT" {
  link: "#milestone-4"
  direction: right

  WAL_FILE: "WAL FILE" {
    class: data_blob
    style.fill: "#1e1e2e"
    p42: "Updated Page 42"
  }

  PAGER: "PAGER ENGINE" {
    shape: package
    style.fill: "#f9e2af"
    style.font-color: "#11111b"
    link: "#milestone-4"
  }

  MAIN_DB: "MAIN DATABASE (.db)" {
    shape: cylinder
    style.fill: "#313244"
    p42: "Original Page 42"
  }

  WAL_FILE.p42 -> PAGER: "1. Read Frame"
  PAGER -> MAIN_DB.p42: "2. Overwrite Page" {
    style.stroke: "#fab387"
    style.stroke-width: 3
    style.animated: true
  }
}

# MICROSCOPE: VARINT RECORD FORMAT
SERIALIZATION_VIEW: "MICROSCOPE: RECORD SERIALIZATION" {
  near: bottom-right
  link: "#milestone-7"
  
  MEMORY_LAYOUT: "BINARY RECORD FORMAT" {
    grid-columns: 6
    grid-gap: 0
    
    H0: "Hdr Len" {style.fill: "#b4befe"; class: binary_field}
    T1: "Type: Int" {style.fill: "#fab387"; class: binary_field}
    T2: "Type: Text" {style.fill: "#a6e3a1"; class: binary_field}
    P1: "Data: 0x05" {style.fill: "#fab387"; class: binary_field}
    P2_0: "Data: 'A'" {style.fill: "#a6e3a1"; class: binary_field}
    P2_1: "Data: 'L'" {style.fill: "#a6e3a1"; class: binary_field}
  }

  DESC: |'md
    **Varint Encoding**
    Variable-length integers 
    save space by using only 
    necessary bytes.
  '| {near: top-center}
}

# LEGEND & LOGIC
LOGIC_NOTES: |'md
  ## The WAL Protocol
  1. **Atomicity**: Changes are written to the WAL first. The main DB remains untouched.
  2. **Commit Marker**: A transaction is "Live" only when a frame with `db_size > 0` is synced.
  3. **Durability**: `fsync()` is called on the WAL file before the API returns success.
  4. **Recovery**: If the system crashes, the Pager replays the WAL from the last checkpoint.
'| {
  near: top-left
}

# NAVIGATION LINKS
FOOTER: "SYSTEM NAVIGATION" {
  near: bottom-center
  direction: right
  MAP: "System Map" {link: "#satellite-map"}
  M6: "Protector (WAL)" {link: "#milestone-6"}
  M4: "Warehouse (Pager)" {link: "#milestone-4"}
  M7: "Assembly (Record)" {link: "#milestone-7"}
}

# CONNECTING THE MICROSCOPE TO THE LOG
WAL_SYSTEM.LOG_STREAM.FRAME_N.F_DATA -> SERIALIZATION_VIEW: "Deep Dive" {
  style.stroke-dash: 5
}