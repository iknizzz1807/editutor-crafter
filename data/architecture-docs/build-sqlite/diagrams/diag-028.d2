vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  subsystem: {
    style: {
      stroke-width: 2
      border-radius: 12
      font-size: 16
      bold: true
      fill: "#f8f9fa"
      shadow: true
    }
  }
  hardware_layer: {
    style: {
      fill: "#2d3436"
      stroke: "#636e72"
      stroke-dash: 4
      font-color: "#dfe6e9"
    }
  }
  memory_segment: {
    style: {
      font: mono
      fill: "#636e72"
      font-color: "#ffffff"
    }
  }
  logical_flow: {
    style: {
      stroke: "#00b894"
      stroke-width: 4
      animated: true
    }
  }
  io_path: {
    style: {
      stroke: "#0984e3"
      stroke-dash: 5
      stroke-width: 2
    }
  }
}

# --- THE METROPOLIS: INTEGRATED ARCHITECTURE ---

direction: down

UserApp: "End-User Application" {
  shape: person
  link: "#milestone-1"
}

Gateway: "MILESTONE 1 & 8: THE INTERFACE" {
  class: subsystem
  link: "#milestone-8"
  
  API: "C API (sqlite3_step)" {
    shape: package
    link: "#milestone-8"
  }
  
  REPL: "REPL / Shell" {
    Buffer: "Input Buffer" {
      shape: sql_table
      ptr: "*char (heap)"
      len: "size_t"
      cap: "size_t"
      link: "#milestone-1"
    }
  }
}

Compiler: "MILESTONE 2 & 5: THE COMPILER" {
  class: subsystem
  link: "#milestone-2"
  
  Tokenizer: "Tokenizer (Lexer)" {
    link: "#milestone-2"
    Scanner: "Pointer Scan"
  }
  
  Parser: "Parser (BNF/Lemon)" {
    link: "#milestone-2"
    Grammar: "Recursive Rules"
  }
  
  Optimizer: "Query Planner" {
    link: "#milestone-5"
    Heuristics: "Greedy/Cost-Based"
  }
  
  Tokenizer -> Parser: "Tokens"
  Parser -> Optimizer: "Logical Tree"
}

Engine: "MILESTONE 3: THE VDBE" {
  class: subsystem
  link: "#milestone-3"
  
  VM: "Register-Based VM" {
    PC: "Program Counter"
    Registers: "VM Regs (R0-R9)" {
      style.multiple: true
    }
    Bytecode: |'md
    - `OpenRead`
    - `Column`
    - `ResultRow`
    - `Next`
    '|
  }
}

StorageBackend: "MILESTONE 4, 7, 9: BACKEND" {
  class: subsystem
  link: "#milestone-4"
  
  BTree: "B+Tree Manager" {
    link: "#milestone-4"
    Cursors: "Table/Index Cursors"
  }
  
  Record: "Row Serializer" {
    link: "#milestone-7"
    shape: step
    label: "Header + Varint Payload"
  }
  
  Pager: "Pager (4KB Pages)" {
    link: "#milestone-4"
    PageCache: "LRU Buffer" {
      style.fill-pattern: dots
    }
  }
  
  Locking: "Lock Manager" {
    link: "#milestone-9"
    States: "S | IS | R | P | X"
  }
  
  BTree <-> Record: "Pack/Unpack"
  BTree -> Pager: "Request Page"
  Pager <-> Locking: "Acquire Latch"
}

Integrity: "MILESTONE 6: PROTECTOR" {
  class: subsystem
  link: "#milestone-6"
  
  WAL: "Write-Ahead Log" {
    shape: queue
    label: "WAL File (v2)"
    link: "#milestone-6"
  }
  
  Checkpoint: "Checkpointing" {
    shape: diamond
  }
}

OS_Layer: "MILESTONE 10: VFS" {
  class: subsystem
  link: "#milestone-10"
  
  VFS: "Virtual File System" {
    link: "#milestone-10"
    Unix: "OS/Unix"
    Faults: "Siege Fault Injector"
  }
}

# --- HARDWARE REALITY LAYER ---

Hardware: "PHYSICAL INFRASTRUCTURE" {
  class: hardware_layer
  
  CPU: "Silicon" {
    L1: "L1 Cache (64B Lines)" { class: memory_segment }
    ALU: "Arithmetic Unit"
  }
  
  RAM: "Volatile RAM" {
    class: memory_segment
  }
  
  Disk: "Persistent Disk" {
    shape: cylinder
    Sectors: "4KB Physical Block"
  }
}

# --- MICROSCOPE VIEW: MEMORY LAYOUT ---

PageMicroscope: "Microscope: 4KB SQLite Page" {
  link: "#milestone-4"
  near: top-right
  
  Structure: {
    grid-rows: 5
    grid-gap: 0
    Header: "Page Header (8-12B)" { style.fill: "#74b9ff" }
    Ptrs: "Cell Pointer Array" { style.fill: "#81ecec" }
    Gap: "Unallocated (Free Space)" { style.stroke-dash: 2 }
    Cells: "Cell Content (Rows)" { style.fill: "#55efc4" }
    Check: "Checksum (Integrity)" { style.fill: "#fab1a0" }
  }
}

# --- STATE TRANSITION: ATOMIC COMMIT ---

CommitLogic: "Atomic Commit Stages" {
  link: "#milestone-6"
  near: bottom-right
  direction: right
  
  Stage1: "1. Write WAL" { shape: step }
  Stage2: "2. Fsync(WAL)" { shape: step }
  Stage3: "3. Commit Marker" { shape: step }
  
  Stage1 -> Stage2 -> Stage3
}

# --- SYSTEM-WIDE INTEGRATION FLOWS ---

UserApp -> Gateway.API: {class: logical_flow}
Gateway.API -> Compiler.Tokenizer: "SQL Query" {class: logical_flow}
Compiler.Optimizer -> Engine.VM: "Bytecode" {class: logical_flow}
Engine.VM -> StorageBackend.BTree: "Seek/Cursor" {class: logical_flow}
StorageBackend.Pager -> Integrity.WAL: "Log Entry" {class: io_path}
Integrity.WAL -> OS_Layer.VFS: "Raw Write" {class: io_path}
OS_Layer.VFS -> Hardware.Disk: "SATA/NVMe" {class: io_path}

# Explicit Flow Descriptions
(UserApp -> Gateway.API): "1. Prepare"
(Gateway.API -> Compiler.Tokenizer): "2. Compile"
(Compiler.Optimizer -> Engine.VM): "3. Dispatch"
(Engine.VM -> StorageBackend.BTree): "4. Execute"

# --- LEGEND ---

Legend: "System Metadata" {
  near: bottom-left
  
  C1: "Control Flow" {
    style: { stroke: "#00b894"; stroke-width: 4 }
  }
  C2: "Disk I/O Path" {
    style: { stroke: "#0984e3"; stroke-dash: 5 }
  }
}

SynthesisNote: |'md
### M11: The Grand Synthesis
This integrated map tracks the query lifecycle from raw ASCII to NAND sectors.
1. **The Gateway** holds heap-allocated buffers for raw strings.
2. **The Compiler** performs token analysis and heuristic cost-based planning.
3. **The Engine** acts as a virtualized RISC CPU for data processing.
4. **The Backend** maps logical rows to physical B-Tree cells and Pager slots.
5. **The Protector** ensures that `fsync` barriers are respected via the WAL.
'| {
  near: top-left
  shape: text
}