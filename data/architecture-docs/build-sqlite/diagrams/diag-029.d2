vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- GLOBAL STYLES & CLASSES ---
classes: {
  memory_segment: {
    style: {
      stroke-width: 1
      border-radius: 2
      font: mono
    }
  }
  allocated_block: {
    style: {
      fill: "#ff8787"
      stroke: "#c92a2a"
      double-border: true
    }
  }
  available_block: {
    style: {
      fill: "#b2f2bb"
      stroke: "#2b8a3e"
    }
  }
  hardware_bit: {
    shape: square
    width: 25
    height: 25
    style: {
      fill: "#fff3bf"
      font-size: 8
    }
  }
  internal_header: {
    style: {
      fill: "#343a40"
      font-color: "#f8f9fa"
      bold: true
    }
  }
}

# --- THE MEMORY MANAGEMENT ATLAS ---
memory_management_atlas: "SQLITE MEMORY & ALLOCATION ARCHITECTURE" {
  link: "#satellite-map"

  # --- CONNECTION HANDLES (M1) ---
  conn_pool: "Connection Handle Pool" {
    link: "#milestone-1"
    tooltip: "Management of opaque sqlite3* structures"

    handle_array: {
      grid-columns: 2
      h1: "sqlite3_hndl_0x1" { class: [memory_segment; allocated_block] }
      h2: "sqlite3_hndl_0x2" { class: [memory_segment; allocated_block] }
      h3: "FREE_SLOT" { class: [memory_segment; available_block] }
      h4: "FREE_SLOT" { class: [memory_segment; available_block] }
    }
  }

  # --- STATEMENT CACHE (M2/M3) ---
  stmt_cache: "Prepared Statement Cache" {
    link: "#milestone-2"
    
    schema_map: "SQL Text Hash -> VDBE Bytecode" {
      shape: sql_table
      hash_key: "UINT32 (SQL Hash)" { constraint: primary_key }
      bytecode_ref: "VDBE_PTR (Instruction Set)" { constraint: foreign_key }
      hit_count: "INT (LRU Priority)"
    }

    lru_queue: "Eviction Queue" {
      shape: queue
      "Stmt_A" -> "Stmt_B" -> "Stmt_C"
    }
  }

  # --- SCRATCH & LOOKASIDE (M3) ---
  lookaside_arena: "Lookaside & Scratch Allocator" {
    link: "#milestone-3"
    tooltip: "Fast path heap-bypass for small VDBE allocations"
    
    arena_grid: {
      grid-rows: 2
      grid-columns: 8
      grid-gap: 4
      
      sb1; sb2; sb3; sb4; sb5; sb6; sb7; sb8
      sb9; sb10; sb11; sb12; sb13; sb14; sb15; sb16
    }
    arena_grid.** { class: memory_segment }
    arena_grid.sb1.style.fill: "#74c0fc"
    arena_grid.sb2.style.fill: "#74c0fc"
    arena_grid.sb3.style.fill: "#74c0fc"
    arena_grid.sb4.style.fill: "#d0ebff"
  }

  # --- PAGER BUFFER CACHE (M4) ---
  pager_memory: "Pager Cache & Page Buffer" {
    link: "#milestone-4"

    # INTERNAL PAGE ANATOMY
    page_struct: "4KB Page Buffer Microscope" {
      header_area: "Page Header (8-12 Bytes)" { class: [memory_segment; internal_header] }
      
      content_split: {
        grid-columns: 1
        ptr_array: "Cell Pointer Array" { style.fill: "#ffec99" }
        gap: "Free Space (Fragment)" { class: available_block }
        cells: "B-Tree Cell Storage" { 
          style.fill: "#eebefa"
          style.multiple: true
        }
      }
    }

    # STATE TRANSITION
    state_machine: "Page Dirtying Transition" {
      direction: right
      pg_clean: "Page 409 (Clean)" {
        tooltip: "Synced with Storage"
        style.fill: "#f1f3f5"
      }
      pg_dirty: "Page 409 (Dirty)" {
        tooltip: "In-Memory Change Only"
        style: {
          fill: "#fff5f5"
          stroke: "#f03e3e"
          stroke-width: 2
        }
      }
      pg_clean -> pg_dirty: "VDBE OP: Insert" {
        style.animated: true
        style.stroke: "#f03e3e"
      }
    }
  }
}

# --- MICROSCOPE: REGISTER BIT VIEW ---
register_micro: "Microscope: VDBE Register Byte-Layout" {
  link: "#milestone-3"
  near: memory_management_atlas.lookaside_arena

  val_type: "Register Meta: [TYPE_TEXT]" { class: internal_header }

  bits: "Memory Alignment (64-bit Word)" {
    grid-columns: 8
    "0"; "1"; "1"; "0"; "1"; "0"; "0"; "1"
    "0"; "0"; "0"; "0"; "0"; "0"; "0"; "0"
  }
  bits.** { class: hardware_bit }
}

# --- CROSS-LAYER DATA FLOW ---
memory_management_atlas.conn_pool.handle_array.h1 -> memory_management_atlas.stmt_cache: "Fetch Cached Bytecode"
memory_management_atlas.stmt_cache.schema_map -> memory_management_atlas.lookaside_arena: "Request Lookaside Buffer"
memory_management_atlas.lookaside_arena -> memory_management_atlas.pager_memory: "Map Cursor to Buffer"

# --- DEEP-DIVE DOCUMENTATION ---
memory_explanation: ||md
### Memory Strategy Objectives
1. **Heap Minimization**: Use Lookaside arenas to prevent `malloc` fragmentation.
2. **Deterministic Paging**: Maintain 4KB alignment to match hardware sectors.
3. **Prepared Reuse**: Statement cache prevents redundant parsing/tokenization cycles.
|| {
  near: memory_management_atlas
}

# --- FINAL GLOBAL STYLING ---
***.style.font: mono
(memory_management_atlas.** -> **): {
  style: {
    stroke: "#495057"
    font-size: 11
  }
}

memory_management_atlas.style: {
  fill: "#f8f9fa"
  stroke: "#212529"
  stroke-width: 2
  border-radius: 8
}