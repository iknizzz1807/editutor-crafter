vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- GLOBAL CLASSES ---
classes: {
  fault: {
    style: {
      fill: "#ff8787"
      stroke: "#c92a2a"
      stroke-width: 4
      font-color: "#ffffff"
      bold: true
      shadow: true
    }
  }
  hardware_layer: {
    style: {
      fill: "#f8f9fa"
      stroke: "#dee2e6"
      stroke-width: 2
    }
  }
  vm_layer: {
    style: {
      fill: "#f1f3ff"
      stroke: "#4c6ef5"
      stroke-width: 2
    }
  }
  api_layer: {
    style: {
      fill: "#fff9db"
      stroke: "#fcc419"
      stroke-width: 2
    }
  }
  bit_on: {
    style: {
      fill: "#e03131"
      font-color: "#ffffff"
      bold: true
    }
  }
}

# --- MAIN ARCHITECTURE MAP ---
"Error Strategy": {
  
  "Milestone 4: Storage Warehouse": {
    class: hardware_layer
    link: "#milestone-4"
    
    "Physical Media": {
      shape: cylinder
      "Bad Sector": "Disk Block 0xFA (Corrupt)" {
        class: fault
      }
    }
    
    "Pager": {
      shape: package
      "Checksum": "sqlite3PagerVerifyChecksum()" {
        class: fault
        tooltip: "Calculated CRC != Stored Footer"
      }
      "Error Map": "OS EIO -> SQLITE_IOERR" {
        style.double-border: true
      }
    }

    "Physical Media"."Bad Sector" -> "Pager"."Checksum": "Raw Read"
    "Pager"."Checksum" -> "Pager"."Error Map": "Trigger Fault"
  }

  "Milestone 3: VDBE Engine": {
    class: vm_layer
    link: "#milestone-3"
    
    "VM State": {
      shape: sql_table
      "ProgramCounter": "0x42 (OP_Column)"
      "CurrentRegister": "R[1]"
      "pVm->rc": "SQLITE_IOERR (10)" {
        class: fault
      }
    }

    "Execution Flow": {
      "FetchRow": "OP_Next / OP_Column" { class: fault }
      "HaltLoop": "Abort Bytecode Loop"
    }

    "Execution Flow"."FetchRow" -> "VM State"."pVm->rc": "Write Error Code"
    "VM State"."pVm->rc" -> "Execution Flow"."HaltLoop": "Signal Abort"
  }

  "Milestone 1: The Gateway": {
    class: api_layer
    link: "#milestone-1"
    
    "Library Handle": {
      shape: sql_table
      "db->errCode": "10"
      "db->zErrMsg": "'disk I/O error'"
    }

    "Terminal REPL": {
      style: {
        fill: "#212529"
        font-color: "#ff6b6b"
        font: mono
      }
      label: ||md
        sqlite> SELECT * FROM users;
        [X] Error: disk I/O error (10)
      ||
    }

    "Library Handle" -> "Terminal REPL": "sqlite3_step() returns 10"
  }
}

# --- INTER-LAYER PROPAGATION ---
"Error Strategy"."Milestone 4: Storage Warehouse"."Pager"."Error Map" -> "Error Strategy"."Milestone 3: VDBE Engine"."Execution Flow"."FetchRow": "Bubble Result Code" {
  style: {
    stroke: "#c92a2a"
    stroke-width: 5
    animated: true
  }
}

"Error Strategy"."Milestone 3: VDBE Engine"."Execution Flow"."HaltLoop" -> "Error Strategy"."Milestone 1: The Gateway"."Library Handle": "API Boundary Cross" {
  style: {
    stroke: "#c92a2a"
    stroke-dash: 5
    stroke-width: 2
  }
}

# --- MICROSCOPE VIEW: MEMORY LAYOUT ---
"Register View": "MICROSCOPE: SQLITE_IOERR Binary (10)" {
  near: "Error Strategy"."Milestone 3: VDBE Engine"."VM State"
  
  "8-Bit Register": {
    grid-columns: 8
    grid-gap: 0
    
    "bit7": "0"
    "bit6": "0"
    "bit5": "0"
    "bit4": "0"
    "bit3": "1" { class: bit_on }
    "bit2": "0"
    "bit1": "1" { class: bit_on }
    "bit0": "0"
    
    style.stroke: "#4c6ef5"
  }
  
  "Logic": |md
    **Decimal Calculation:**
    (Bit 3 = 8) + (Bit 1 = 2)
    **Total = 10**
  |
}

# --- STATE TRANSITION: BEFORE vs AFTER ---
"State Transition": {
  near: "Error Strategy"."Milestone 4: Storage Warehouse"
  
  "T0: Operational": {
    "Pager": "OK" { style.fill: "#d4edda" }
    "VDBE": "RUNNING" { style.fill: "#d4edda" }
    "Pager" -> "VDBE": "Data Payload"
  }

  "T1: Fault Detected": {
    "Pager_F": "IO_ERR" { class: fault }
    "VDBE_F": "HALTED" { class: fault }
    "Pager_F" -> "VDBE_F": "Halt Signal" { style.stroke: "#c92a2a" }
  }

  "T0: Operational" -> "T1: Fault Detected": "Hardware Failure Event" {
    style: {
      bold: true
      font-color: "#c92a2a"
    }
  }
}

# --- LEGEND ---
"Legend": {
  near: bottom-right
  "Error Path": {
    style: {
      stroke: "#c92a2a"
      stroke-width: 5
    }
  }
  "Control Flow": {
    style: {
      stroke: "#adb5bd"
      stroke-dash: 3
    }
  }
}