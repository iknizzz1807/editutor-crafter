vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  affinity_group: {
    style: {
      stroke-width: 2
      border-radius: 10
      fill: "#fdfdfd"
      font-size: 14
    }
  }
  storage_class: {
    shape: cylinder
    style: {
      bold: true
      stroke-width: 3
    }
  }
  microscope: {
    style: {
      fill: "#fff8e1"
      stroke: "#ffa000"
      stroke-width: 2
    }
  }
}

title: "THE ATOMIC MAPPING: SQL TYPES TO DISK BYTES" {
  shape: text
  style: {
    font-size: 28
    bold: true
  }
}

# --- STAGE 1: THE FRONTEND (LEXER & PARSER) ---
sql_frontend: "Milestone 2: SQL Frontend (Lexical Tokens)" {
  link: "#milestone-2"
  tooltip: "The Parser identifies these string patterns in the CREATE TABLE or CAST statements."
  
  int_pattern: "Integer Affinity" {
    class: affinity_group
    label: "Pattern: *INT*\n(TINYINT, BIGINT, INTEGER)"
    style.stroke: "#3498db"
  }
  
  text_pattern: "Text Affinity" {
    class: affinity_group
    label: "Pattern: *CHAR*, *CLOB*, *TEXT*\n(VARCHAR, CHARACTER)"
    style.stroke: "#2ecc71"
  }
  
  blob_pattern: "Blob Affinity" {
    class: affinity_group
    label: "Pattern: *BLOB* or Empty\n(Binary Data)"
    style.stroke: "#9b59b6"
  }
  
  real_pattern: "Real Affinity" {
    class: affinity_group
    label: "Pattern: *REAL*, *FLOA*, *DOUB*\n(FLOAT, DOUBLE PRECISION)"
    style.stroke: "#e67e22"
  }
  
  num_pattern: "Numeric Affinity" {
    class: affinity_group
    label: "Default / Other\n(DECIMAL, BOOLEAN, DATE)"
    style.stroke: "#e74c3c"
  }
}

# --- STAGE 2: THE STRATEGIST (AFFINITY RESOLUTION) ---
affinity_engine: "Affinity Rule Engine" {
  shape: diamond
  link: "#milestone-5"
  label: "Decision Tree:\nType String Matching"
  style.fill: "#fff9c4"
}

sql_frontend.int_pattern -> affinity_engine
sql_frontend.text_pattern -> affinity_engine
sql_frontend.blob_pattern -> affinity_engine
sql_frontend.real_pattern -> affinity_engine
sql_frontend.num_pattern -> affinity_engine

# --- STAGE 3: THE ASSEMBLY LINE (INTERNAL STORAGE) ---
storage: "Milestone 7: Internal Storage Classes" {
  link: "#milestone-7"
  
  sc_null: "NULL" {
    class: storage_class
    style.fill: "#eeeeee"
  }
  sc_int: "INTEGER" {
    class: storage_class
    style.fill: "#bbdefb"
    style.stroke: "#3498db"
  }
  sc_real: "REAL" {
    class: storage_class
    style.fill: "#ffe0b2"
    style.stroke: "#e67e22"
  }
  sc_text: "TEXT" {
    class: storage_class
    style.fill: "#c8e6c9"
    style.stroke: "#2ecc71"
  }
  sc_blob: "BLOB" {
    class: storage_class
    style.fill: "#e1bee7"
    style.stroke: "#9b59b6"
  }
}

affinity_engine -> storage.sc_int: "Priority 1"
affinity_engine -> storage.sc_text: "Priority 2"
affinity_engine -> storage.sc_blob: "Priority 3"
affinity_engine -> storage.sc_real: "Priority 4"
affinity_engine -> storage.sc_null: "Priority 5"

# --- STAGE 4: MICROSCOPE (BINARY RECORD FORMAT) ---
record_format: "Milestone 7: Binary Record Serialization" {
  link: "#milestone-7"
  
  serial_map: {
    shape: sql_table
    label: "Serial Type ID -> Physical Representation"
    class: microscope
    id0: "0" {constraint: "Value: NULL | Size: 0 bytes"}
    id1: "1" {constraint: "8-bit Twos-Complement Int"}
    id2: "2" {constraint: "16-bit Twos-Complement Int"}
    id4: "4" {constraint: "32-bit Twos-Complement Int"}
    id6: "6" {constraint: "64-bit Twos-Complement Int"}
    id7: "7" {constraint: "Big-endian IEEE 754 Float"}
    id8: "8" {constraint: "Integer Constant 0"}
    id9: "9" {constraint: "Integer Constant 1"}
    id_b: "N >= 12 (even)" {constraint: "BLOB | Size: (N-12)/2"}
    id_t: "N >= 13 (odd)" {constraint: "TEXT | Size: (N-13)/2"}
  }

  record_visual: "Physical Row in Memory" {
    direction: right
    header: "Record Header" {
      grid-columns: 4
      h_len: "H-Size (Varint)"
      type_1: "Type 1"
      type_2: "Type 2"
      type_n: "Type N..."
      style.fill: "#fce4ec"
    }
    payload: "Payload Data" {
      grid-columns: 3
      data_1: "Data 1"
      data_2: "Data 2"
      data_n: "Data N..."
      style.fill: "#f3e5f5"
    }
    header -> payload: "Parallel Map"
  }
}

# --- STAGE 5: THE WAREHOUSE (DISK PAGE) ---
warehouse: "Milestone 4: Page Storage" {
  link: "#milestone-4"
  
  pager_layout: "4KB B-Tree Leaf Page" {
    direction: right
    style.fill: "#ffffff"
    
    p_header: "Page Header\n(8-12 Bytes)" {
      style.fill: "#cfd8dc"
    }
    ptr_array: "Cell Pointer Array\n(Indirection)" {
      style.fill: "#b2dfdb"
    }
    unallocated: "Free Space\n(High Water Mark)" {
      style.fill-pattern: grain
      style.opacity: 0.4
    }
    cell_data: "Cell (Record)\n[Grows Upward]" {
      style.fill: "#fce4ec"
      style.stroke-width: 4
      style.double-border: true
    }
  }
}

# --- CONNECTIONS & STATE TRANSITIONS ---
storage.sc_null -> record_format.serial_map.id0
storage.sc_int -> record_format.serial_map.id1: "Range 1-6, 8-9"
storage.sc_real -> record_format.serial_map.id7
storage.sc_text -> record_format.serial_map.id_t
storage.sc_blob -> record_format.serial_map.id_b

record_format.serial_map -> record_format.record_visual.header: "Defines Metadata"
record_format.record_visual -> warehouse.pager_layout.cell_data: "Written as Cell"

# --- LEGEND & CONTEXT ---
legend: |'md
### THE SYSTEM TRACE
1. **Frontend**: The Lexer extracts type strings from SQL.
2. **Affinity**: Rules define "Preferred" behavior for type conversion.
3. **M7 Assembly**: The VDBE serializes data into Variable-Length Integers (Varints) and Type IDs.
4. **M4 Warehouse**: The Pager stores packed binary records into fixed-size 4KB pages matching disk sectors.
'| {
  near: top-right
  style.stroke-width: 0
  style.fill: "#fafafa"
}

# Style Globs
(sql_frontend -> affinity_engine)[*]: {
  style.stroke: "#90a4ae"
  style.stroke-dash: 5
}

(storage -> record_format.serial_map)[*]: {
  style.animated: true
  style.stroke-width: 2
}

(record_format -> warehouse)[*]: {
  style.stroke: "#e91e63"
  style.stroke-width: 3
}