vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Row Storage Layout (Microscopic View)" {
  shape: text
  style.font-size: 32
  style.bold: true
}

# -----------------------------------------------------------------------
# LOGICAL LAYER: The User's Mental Model
# -----------------------------------------------------------------------
logical: "Logical Tuple (Struct)" {
  link: "#anchor-table"
  style: {
    fill: "#e3f2fd"
    stroke: "#1565c0"
    stroke-width: 2
  }
  
  id: "ID (Integer)" {
    shape: class
    label: "id: 42"
    link: "#anchor-table"
    style.fill: "#bbdefb"
  }
  username: "Username (Varchar)" {
    shape: class
    label: "username: 'alice'"
    link: "#anchor-table"
    style.fill: "#bbdefb"
  }
  email: "Email (Varchar)" {
    shape: class
    label: "email: 'alice@example.com'"
    link: "#anchor-table"
    style.fill: "#bbdefb"
  }
  
  # Invisible ordering edges
  id -> username: {style.opacity: 0}
  username -> email: {style.opacity: 0}
}

# -----------------------------------------------------------------------
# PHYSICAL LAYER: The Bytes on the Heap
# -----------------------------------------------------------------------
physical: "Physical Memory Layout (Contiguous Byte Stream)" {
  link: "#anchor-table"
  direction: right
  style: {
    fill: "#263238"
    stroke: "#37474f"
    font-color: "#eceff1"
  }
  
  # Stream container
  stream: {
    link: "#anchor-table"
    direction: right
    style.fill: transparent
    style.stroke-width: 0

    # 1. Header Section
    header_block: {
      link: "#anchor-table"
      label: "Header"
      direction: right
      style: {
        fill: "#ff6f00"
        stroke: "#ff8f00"
        border-radius: 5
      }
      
      cc: "0x03" {
        shape: square
        label: "COLS\n03"
        tooltip: "Column Count: 3"
        link: "#anchor-table"
        style: {
          fill: "#ffca28"
          stroke: "#333"
          font-size: 10
        }
      }
      
      t1: "0x01" {
        shape: square
        label: "TYPE\nINT"
        tooltip: "Type Code: Integer"
        link: "#anchor-table"
        style: {
          fill: "#ffe082"
          stroke: "#333"
          font-size: 10
        }
      }
      
      t2: "0x04" {
        shape: square
        label: "TYPE\nVAR"
        tooltip: "Type Code: Varchar"
        link: "#anchor-table"
        style: {
          fill: "#ffe082"
          stroke: "#333"
          font-size: 10
        }
      }
      
      t3: "0x04" {
        shape: square
        label: "TYPE\nVAR"
        tooltip: "Type Code: Varchar"
        link: "#anchor-table"
        style: {
          fill: "#ffe082"
          stroke: "#333"
          font-size: 10
        }
      }
      
      cc -> t1 -> t2 -> t3
    }

    # 2. Data Section
    data_block: {
      link: "#anchor-table"
      label: "Data Payload"
      direction: right
      style: {
        fill: "#00695c"
        stroke: "#00897b"
        border-radius: 5
      }

      # Integer Value
      val_id: "DATA 1" {
        shape: package
        label: "0x0000002A"
        tooltip: "Value: 42 (4 bytes)"
        link: "#anchor-table"
        style: {
          fill: "#80cbc4"
          stroke: "#333"
          font-size: 12
        }
      }
      
      # Varchar 1
      len_1: "LEN" {
        shape: square
        label: "0x05"
        tooltip: "Length: 5 bytes"
        link: "#anchor-table"
        style: {
          fill: "#a5d6a7"
          stroke: "#333"
          font-size: 10
        }
      }
      val_1: "DATA 2" {
        shape: queue
        label: "'alice'"
        tooltip: "String payload"
        link: "#anchor-table"
        style: {
          fill: "#80cbc4"
          stroke: "#333"
          font-size: 12
        }
      }
      
      # Varchar 2
      len_2: "LEN" {
        shape: square
        label: "0x11"
        tooltip: "Length: 17 bytes"
        link: "#anchor-table"
        style: {
          fill: "#a5d6a7"
          stroke: "#333"
          font-size: 10
        }
      }
      val_2: "DATA 3" {
        shape: queue
        label: "'alice@example.com'"
        tooltip: "String payload"
        link: "#anchor-table"
        style: {
          fill: "#80cbc4"
          stroke: "#333"
          font-size: 12
        }
      }
      
      val_id -> len_1 -> val_1 -> len_2 -> val_2
    }
    
    header_block -> data_block: {style.stroke-width: 0}
  }
}

# -----------------------------------------------------------------------
# CONNECTIONS & ANNOTATIONS
# -----------------------------------------------------------------------

# Mapping Logical to Physical
logical.id -> physical.stream.data_block.val_id: "Serializes To" {
  style: {
    stroke: "#ffca28"
    stroke-dash: 3
    stroke-width: 2
  }
}

logical.username -> physical.stream.data_block.val_1: "Packed" {
  style: {
    stroke: "#ffca28"
    stroke-dash: 3
    stroke-width: 2
  }
}

logical.email -> physical.stream.data_block.val_2: "Packed" {
  style: {
    stroke: "#ffca28"
    stroke-dash: 3
    stroke-width: 2
  }
}

# Annotations
note_header: "Header overhead\nis constant per row" {
  shape: text
  style.font-size: 14
  style.font-color: "#ffca28"
}
note_header -> physical.stream.header_block: {
  style: {
    stroke: "#ffca28"
    stroke-dash: 3
  }
}

note_data: "Variable length strings\nsave space (no padding)" {
  shape: text
  style.font-size: 14
  style.font-color: "#80cbc4"
}
note_data -> physical.stream.data_block.val_2: {
  style: {
    stroke: "#80cbc4"
    stroke-dash: 3
  }
}