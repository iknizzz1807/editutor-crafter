vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right

Logical: {
  link: "#anchor-table"
  style: {
    fill: transparent
    stroke-width: 0
  }

  TableStruct: {
    shape: class
    label: "struct Table"
    
    # Fields
    "uint32_t num_rows"
    "void* pages[MAX_PAGES]"
    
    # Methods
    "void* row_slot(row_num)"
  }

  RowStruct: {
    shape: class
    label: "struct Row (Transient)"
    style.fill: "#c8e6c9"
    
    "uint32_t id"
    "char username[32]"
    "char email[255]"
  }

  Cursor: {
    shape: class
    label: "Row Iterator (Logic)"
    style.fill: "#fff9c4"
    
    "uint32_t row_num"
    "bool end_of_table"
  }
}

Memory: {
  link: "#anchor-table"
  label: "Heap Memory"
  style.fill: "#f5f5f5"

  PageArray: {
    shape: class
    label: "Page Directory"
    tooltip: "Table->pages array"
    
    "pages[0]": "0x7FA..."
    "pages[1]": "NULL"
    "pages[N]": "NULL"
  }

  PageBlock: {
    shape: package
    label: "Active Page (4096 Bytes)"
    style.fill: "#e1f5fe"
    
    RowSlot0: {
      label: "Row 0 (Bytes 0-291)"
      shape: rectangle
      style.fill: "#ffecb3"
    }
    
    RowSlot1: {
      label: "Row 1 (Bytes 291-582)"
      shape: rectangle
      style.fill: "#ffecb3"
    }
    
    FreeSpace: {
      label: "Fragmentation / Free Space"
      shape: rectangle
      style: {
        stroke-dash: 3
        fill: "#eeeeee"
        font-color: "#999999"
      }
    }

    RowSlot0 -> RowSlot1 -> FreeSpace {
        style.opacity: 0
    }
  }
}

Serializer: {
  link: "#anchor-table"
  shape: step
  label: "Serializer (memcpy)"
  style.fill: "#ffcc80"
  
  Offsets: |md
    **Layout Map**
    - ID: 4 bytes (Offset 0)
    - Username: 32 bytes (Offset 4)
    - Email: 255 bytes (Offset 36)
  |
  
  Offsets.shape: text
}

# Connections
Logical.TableStruct -> Memory.PageArray: "manages"
Memory.PageArray."pages[0]" -> Memory.PageBlock: "points to"

# Data Flow Interaction
Logical.RowStruct -> Serializer: "Serialize"
Serializer -> Memory.PageBlock.RowSlot0: "Write Packed Bytes"
Memory.PageBlock.RowSlot0 -> Serializer: "Read Packed Bytes"
Serializer -> Logical.RowStruct: "Deserialize"

# Iterator Logic
Logical.Cursor -> Logical.TableStruct: "Iterates Rows"
Logical.Cursor -> Memory.PageBlock.RowSlot0: "Points to (Virtual)" {
  style.stroke-dash: 3
  style.opacity: 0.5
}