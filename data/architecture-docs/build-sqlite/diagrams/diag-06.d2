vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Database File Format (Satellite View)
  The physical alignment of 4KB pages on disk vs. logical structures.
| {
  near: top-center
  link: "#anchor-pager"
}

classes: {
  page: {
    shape: package
    width: 250
    style: {
      stroke-width: 2
      fill: "#fcfcfc"
      shadow: true
    }
  }
  struct: {
    shape: class
    style: {
      font-size: 14
    }
  }
}

Disk Stream: {
  direction: right
  label: "Physical Disk Layout (database.db)"
  style: {
    fill: "#e0e0e0"
    stroke: "#333"
    stroke-width: 2
  }

  # PAGE 0: The Superblock
  Page 0: {
    class: page
    label: "Page 0\n(DB Header & Root)"
    link: "#anchor-pager"
    
    File Header: {
      class: struct
      label: "File Header (100 bytes)"
      style: {
        fill: "#ffecb3"
        stroke: "#ff6f00"
      }
      
      "Offset 0": "Magic String"
      "Offset 16": "Page Size (4096)"
      "Offset 32": "Free List Trunk"
      "Offset 36": "Total Pages"
    }

    Root Node: {
      shape: rectangle
      style: {
        fill: "#e1bee7"
        stroke: "#4a148c"
      }
      label: "B-Tree Root Node\n(Internal Keys)"
    }
    
    File Header -> Root Node: "offset 100" {
      style: {
        stroke-dash: 3
        stroke: "#757575"
        font-size: 10
      }
    }
  }

  # PAGE 1: Data Page
  Page 1: {
    class: page
    label: "Page 1\n(Leaf Node)"
    link: "#anchor-pager"
    
    Node Header: {
      class: struct
      label: "Page Metadata"
      Type: "Leaf (0x0D)"
      Cells: "2"
      FreeBlock: "0"
    }
    
    Cell Pointers: {
      shape: queue
      style.fill: "#b2dfdb"
      label: "Offsets (Array)"
    }
    
    Cell Content: {
      shape: package
      label: "Packed Rows (grows up)"
      style.fill: "#b2dfdb"
      
      Row 1: {
        shape: rectangle
        label: "ID: 1 | User: 'Alice'..."
      }
    }

    Node Header -> Cell Pointers: "offset 8"
    Cell Pointers -> Cell Content: "indirection"
  }

  # PAGE 2: Free List Trunk
  Page 2: {
    class: page
    label: "Page 2\n(Free List Trunk)"
    link: "#anchor-pager"
    style: {
      fill: "#ffccbc"
      stroke: "#bf360c"
    }

    Trunk Header: {
      class: struct
      label: "Trunk Header"
      Next Trunk: "0 (NULL)"
      Leaf Count: "1"
    }

    Free Page Pointers: {
      class: struct
      style.fill: "#ffab91"
      "Pointer 0": "Page 4"
    }

    Trunk Header -> Free Page Pointers
  }

  # PAGE 3: Internal Node
  Page 3: {
    class: page
    label: "Page 3\n(Internal Node)"
    link: "#anchor-pager"
    
    Internal Data: {
      class: struct
      label: "Router"
      "Key 1": "ID >= 500"
      "Left Ptr": "Page 1"
    }
  }

  # PAGE 4: Free Leaf
  Page 4: {
    class: page
    label: "Page 4\n(Free Page)"
    link: "#anchor-pager"
    style: {
      fill: "#ffebee"
      stroke: "#c62828"
      stroke-dash: 5
    }
    
    Content: "Reclaimable Garbage" {
      shape: text
    }
  }
  
  # Physical Layout Connections (The Stream)
  Page 0 -> Page 1: "offset 4096" {style.stroke-width: 4}
  Page 1 -> Page 2: "offset 8192" {style.stroke-width: 4}
  Page 2 -> Page 3: "offset 12288" {style.stroke-width: 4}
  Page 3 -> Page 4: "offset 16384" {style.stroke-width: 4}
}

# LOGICAL OVERLAYS (The Hidden Structure)

# 1. Free List Logic (Red)
Disk Stream.Page 0.File Header."Offset 32" -> Disk Stream.Page 2.Trunk Header: "Logical Link: Free List Head" {
  style: {
    stroke: "#bf360c"
    stroke-width: 3
    stroke-dash: 3
    animated: true
  }
}

Disk Stream.Page 2.Free Page Pointers."Pointer 0" -> Disk Stream.Page 4: "Logical Link: Free Page" {
  style: {
    stroke: "#bf360c"
    stroke-width: 3
    stroke-dash: 3
    animated: true
  }
}

# 2. B-Tree Logic (Purple)
Disk Stream.Page 3.Internal Data."Left Ptr" -> Disk Stream.Page 1: "B-Tree Routing" {
  style: {
    stroke: "#4a148c"
    stroke-width: 3
    animated: true
  }
}