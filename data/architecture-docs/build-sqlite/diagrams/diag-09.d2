vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  c: {
    root: "#FFD700"
    internal: "#87CEFA"
    leaf: "#98FB98"
    ptr: "#FF6347"
    key: "#F0E68C"
    header: "#D3D3D3"
  }
}

direction: down

# ----------------------------------------------------------------------
# CLASSES
# ----------------------------------------------------------------------
classes: {
  page: {
    label: ""
    style: {
      stroke-width: 2
      shadow: true
      border-radius: 8
    }
  }
  
  cell_ptr: {
    shape: rectangle
    width: 40
    height: 30
    style: {
      fill: ${c.ptr}
      stroke: "#333"
      font-size: 10
      bold: true
    }
  }

  cell_key: {
    shape: rectangle
    width: 60
    height: 30
    style: {
      fill: ${c.key}
      stroke: "#333"
      font-size: 12
    }
  }

  header_block: {
    label: "Page Header\n(Flags, Cell Count)"
    shape: rectangle
    height: 30
    style: {
      fill: ${c.header}
      font-size: 10
    }
  }

  leaf_data: {
    shape: rectangle
    style: {
      fill: "#ffffff"
      stroke-dash: 3
    }
  }
}

# ----------------------------------------------------------------------
# TITLE & LEGEND
# ----------------------------------------------------------------------
title: |md
  # B+ Tree Structure (Page Size: 4KB)
  **Fan-out**: High branching factor reduces depth.
  **Logarithmic Search**: $O(log_B N)$
| {
  near: top-center
  shape: text
  link: "#anchor-btree"
}

explanation: |md
  ### Search Example: 650
  1. **Root**: Key 500. $650 \ge 500 \to$ Right Ptr.
  2. **Internal (Pg3)**: Key 800. $650 < 800 \to$ Left Ptr.
  3. **Leaf (Pg6)**: Scan list. Found 650.
| {
  near: bottom-center
  style: {
    fill: "#fff"
    stroke: "#333"
    shadow: true
    font-size: 14
  }
  link: "#anchor-btree"
}

# ----------------------------------------------------------------------
# NODES
# ----------------------------------------------------------------------

Root: Root Node (Page 1) {
  class: page
  style.fill: ${c.root}
  link: "#anchor-btree"
  
  grid-rows: 2
  grid-columns: 1
  
  header: {
    class: header_block
  }

  body: {
    grid-rows: 1
    grid-gap: 5
    
    p0: Ptr: Pg2 { class: cell_ptr }
    k0: Key: 500 { class: cell_key }
    p1: Ptr: Pg3 { class: cell_ptr }
  }
}

Level1: {
  style: {
    fill: transparent
    stroke-width: 0
  }
  
  LNode: Internal Node (Page 2) {
    class: page
    style.fill: ${c.internal}
    link: "#anchor-btree"
    
    header: {
      class: header_block
    }
    
    body: {
      grid-rows: 1
      grid-gap: 5
      p0: Ptr: Pg4 { class: cell_ptr }
      k0: Key: 200 { class: cell_key }
      p1: Ptr: Pg5 { class: cell_ptr }
    }
    label_range: "Keys < 500" { shape: text; style.font-size: 10 }
  }

  RNode: Internal Node (Page 3) {
    class: page
    style.fill: ${c.internal}
    link: "#anchor-btree"

    header: {
      class: header_block
    }
    
    body: {
      grid-rows: 1
      grid-gap: 5
      p0: Ptr: Pg6 { class: cell_ptr }
      k0: Key: 800 { class: cell_key }
      p1: Ptr: Pg7 { class: cell_ptr }
    }
    label_range: "Keys >= 500" { shape: text; style.font-size: 10 }
  }
}

Level2: {
  style: {
    fill: transparent
    stroke-width: 0
  }

  LeafA: Leaf Node (Page 4) {
    class: page
    style.fill: ${c.leaf}
    link: "#anchor-btree"
    header: {
      class: header_block
    }
    
    content: |md
      - ID: 10
      - ID: 100
      - ID: 199
    | { class: leaf_data }
    
    range: "< 200" { shape: text; style.font-size: 10 }
  }

  LeafB: Leaf Node (Page 5) {
    class: page
    style.fill: ${c.leaf}
    link: "#anchor-btree"
    header: {
      class: header_block
    }
    
    content: |md
      - ID: 200
      - ID: 350
      - ID: 499
    | { class: leaf_data }
    
    range: "200-499" { shape: text; style.font-size: 10 }
  }

  LeafC: Leaf Node (Page 6) {
    class: page
    style.fill: ${c.leaf}
    link: "#anchor-btree"
    header: {
      class: header_block
    }
    
    content: |md
      - ID: 500
      - ID: 650
      - ID: 799
    | { class: leaf_data }
    
    range: "500-799" { shape: text; style.font-size: 10 }
  }

  LeafD: Leaf Node (Page 7) {
    class: page
    style.fill: ${c.leaf}
    link: "#anchor-btree"
    header: {
      class: header_block
    }
    
    content: |md
      - ID: 800
      - ID: 900
      - ID: 999
    | { class: leaf_data }
    
    range: ">= 800" { shape: text; style.font-size: 10 }
  }
}

# ----------------------------------------------------------------------
# CONNECTIONS
# ----------------------------------------------------------------------

# Root to Level 1
Root.body.p0 -> Level1.LNode: {
  source-arrowhead: none
  target-arrowhead: triangle
  style.stroke: ${c.ptr}
}
Root.body.p1 -> Level1.RNode: {
  source-arrowhead: none
  target-arrowhead: triangle
  style.stroke: ${c.ptr}
}

# Level 1 to Level 2
Level1.LNode.body.p0 -> Level2.LeafA: {
  source-arrowhead: none
  target-arrowhead: triangle
  style.stroke: ${c.ptr}
}
Level1.LNode.body.p1 -> Level2.LeafB: {
  source-arrowhead: none
  target-arrowhead: triangle
  style.stroke: ${c.ptr}
}
Level1.RNode.body.p0 -> Level2.LeafC: {
  source-arrowhead: none
  target-arrowhead: triangle
  style.stroke: ${c.ptr}
}
Level1.RNode.body.p1 -> Level2.LeafD: {
  source-arrowhead: none
  target-arrowhead: triangle
  style.stroke: ${c.ptr}
}

# Leaf Sibling Pointers (B-Link / B+ Tree property)
Level2.LeafA -> Level2.LeafB: next { style.stroke-dash: 3 }
Level2.LeafB -> Level2.LeafC: next { style.stroke-dash: 3 }
Level2.LeafC -> Level2.LeafD: next { style.stroke-dash: 3 }