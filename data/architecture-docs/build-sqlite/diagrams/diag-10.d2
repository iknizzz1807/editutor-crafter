vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "B-Tree Leaf Node Memory Layout (4KB)" {
  shape: text
  near: top-center
  style.font-size: 30
}

leaf_page: "Leaf Page (Page #42)" {
  link: "#anchor-btree"
  style: {
    fill: "#f8f9fa"
    stroke: "#333"
    stroke-width: 2
  }

  # --- PAGE HEADER ---
  header: "Page Header (Offset 0)" {
    shape: class
    "NodeType": "0x0D (Leaf Table)"
    "FreeBlock": "First Free Block Offset"
    "NumCells": "Cell Count (N)"
    "StartCellContent": "Start of Content Area"
    "FragmentedFreeBytes": "Fragmented Bytes"
    
    style: {
      fill: "#e1bee7"
      stroke: "#4a148c"
    }
  }

  # --- CELL POINTER ARRAY ---
  pointers: "Cell Pointer Array" {
    style: {
      fill: "#bbdefb"
      stroke: "#0d47a1"
    }
    
    p1: "Ptr[0]" {
      tooltip: "Offset to Cell 1"
    }
    p2: "Ptr[1]" {
      tooltip: "Offset to Cell 2"
    }
    p3: "..." {
      style.stroke-width: 0
      style.fill: transparent
    }
    pN: "Ptr[N]"
  }

  # --- FREE SPACE ---
  free_space: "Unallocated Space" {
    shape: rectangle
    style: {
      fill: "#ffffff"
      fill-pattern: lines
      stroke-dash: 3
      opacity: 0.5
    }
    label: "Free Space\n(Growth Area)"
  }

  # --- CELL CONTENT AREA ---
  # Cells grow from the end of the page towards the start
  cells: "Cell Content Area (High Memory)" {
    style: {
      fill: "#c8e6c9"
      stroke: "#1b5e20"
    }

    cell_1: "Cell 1 (Row ID: 10)" {
      shape: package
      style.fill: "#fff"
    }

    cell_2: "Cell 2 (Row ID: 45)" {
      shape: package
      style.fill: "#fff"
    }

    cell_N: "Cell N (Row ID: 99)" {
      shape: package
      style.fill: "#fff"
    }
  }
}

# --- EXPLODED VIEW OF A CELL ---
cell_detail: "Microscope: Anatomy of a Leaf Cell" {
  link: "#anchor-btree"
  style: {
    fill: "#fff3e0"
    stroke: "#e65100"
    shadow: true
  }

  varint_payload: "Payload Size" {
    shape: square
    style.fill: "#ffcc80"
    tooltip: "Varint encoding of total data size"
  }
  
  varint_rowid: "Row ID (Key)" {
    shape: square
    style.fill: "#ffe0b2"
    tooltip: "The Primary Key (B-Tree Key)"
  }

  payload: "Payload (Serialized Row)" {
    shape: queue
    style.fill: "#ffecb3"
    
    "Header Len"
    "Serial Types"
    "Col 1: ID"
    "Col 2: User"
    "Col 3: Email"
  }
  
  varint_payload -> varint_rowid
  varint_rowid -> payload
}

# --- CONNECTIONS ---

# Structure flow
leaf_page.header -> leaf_page.pointers: "grows down" {
  style: {
    stroke: "#666"
    stroke-dash: 3
  }
}

leaf_page.pointers -> leaf_page.free_space: "pushes boundary"
leaf_page.free_space -> leaf_page.cells: "consumed by"

# Specific pointers to specific cells
leaf_page.pointers.p1 -> leaf_page.cells.cell_1: "offset 100" {
  style.stroke: "#0d47a1"
}
leaf_page.pointers.p2 -> leaf_page.cells.cell_2: "offset 250" {
  style.stroke: "#0d47a1"
}
leaf_page.pointers.pN -> leaf_page.cells.cell_N: "offset 4000" {
  style.stroke: "#0d47a1"
}

# Magnification
leaf_page.cells.cell_2 -> cell_detail: "magnify" {
  style: {
    stroke-width: 4
    stroke: "#e65100"
    stroke-dash: 3
    animated: true
  }
}