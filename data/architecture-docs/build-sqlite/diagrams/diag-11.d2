vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

classes: {
  byte_block: {
    style: {
      stroke-width: 1
      fill: "#fdf6e3"
      stroke: "#586e75"
      font-size: 14
    }
  }
  header_field: {
    style: {
      fill: "#eee8d5"
      stroke: "#b58900"
      stroke-width: 2
    }
  }
  ptr_arrow: {
    style: {
      stroke: "#cb4b16"
      stroke-width: 2
      stroke-dash: 3
    }
  }
}

Title: |md
  # Internal Node Layout (4KB Page)
  The internal node acts as a traffic controller.
  It stores **N Keys** and **N+1 Pointers**.
| {
  near: top-center
  link: "#anchor-btree"
}

InternalPage: {
  label: "Page 5 (Internal Node)"
  link: "#anchor-btree"
  style: {
    fill: "#fff"
    stroke: "#333"
    stroke-width: 2
    shadow: true
  }

  Header: {
    label: "Page Header (12 Bytes)"
    shape: class
    
    "Offset 0": "NodeType: INTERNAL (0x05)" {class: header_field}
    "Offset 1": "FreeBlockOffset: 0x00" {class: header_field}
    "Offset 2": "NumCells: 2" {class: header_field}
    "Offset 4": "StartOfCells: 4076" {class: header_field}
    "Offset 8": "RightMostPtr: Page 12" {
      class: header_field
      style.fill: "#ffcccc"
    }
  }

  CellPointers: {
    label: "Cell Pointer Array"
    shape: class
    style.fill: "#e0e0e0"
    
    "Offset 12": "Ptr[0]: 4088"
    "Offset 14": "Ptr[1]: 4076"
    "...": "Empty Space"
  }

  Cells: {
    label: "Cell Content Area"
    style.fill: "transparent"
    style.stroke-width: 0

    Cell2: "Offset 4076 (Cell 1)" {
      shape: sql_table
      style.fill: "#fafafa"
      
      LeftChildPtr: uint32 (Page 33) {
        constraint: "Bytes 0-3"
      }
      Key: uint32 (500) {
        constraint: "Bytes 4-7"
        style.font-color: "blue"
        style.bold: true
      }
    }

    Cell1: "Offset 4088 (Cell 0)" {
      shape: sql_table
      style.fill: "#fafafa"
      
      LeftChildPtr: uint32 (Page 20) {
        constraint: "Bytes 0-3"
      }
      Key: uint32 (100) {
        constraint: "Bytes 4-7"
        style.font-color: "blue"
        style.bold: true
      }
    }
  }
}

LogicLayer: {
  style: {
    fill: "transparent"
    stroke-width: 0
  }
  
  Page20: "Page 20\n(Keys < 100)" {
    shape: package
    style.fill: "#d0f0c0"
    link: "#anchor-btree"
  }
  
  Page33: "Page 33\n(100 <= Keys < 500)" {
    shape: package
    style.fill: "#d0f0c0"
    link: "#anchor-btree"
  }
  
  Page12: "Page 12\n(Keys >= 500)" {
    shape: package
    style.fill: "#ffcccc"
    link: "#anchor-btree"
  }
}

InternalPage.Cells.Cell1.LeftChildPtr -> LogicLayer.Page20: "If Key < 100" {
  class: ptr_arrow
}

InternalPage.Cells.Cell2.LeftChildPtr -> LogicLayer.Page33: "If 100 <= Key < 500" {
  class: ptr_arrow
}

InternalPage.Header."Offset 8" -> LogicLayer.Page12: "If Key >= 500 (Right-Most)" {
  class: ptr_arrow
  style.stroke: "#d33682"
}

InternalPage.Header -> InternalPage.CellPointers
InternalPage.CellPointers -> InternalPage.Cells: "..." {
  style.stroke-dash: 3
  style.opacity: 0.5
}