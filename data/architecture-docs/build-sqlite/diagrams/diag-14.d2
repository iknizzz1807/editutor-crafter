vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Lexer Token Types
  *Microscopic Analysis of SQL Atomization*
| {
  near: top-center
  shape: text
  link: "#anchor-lexer"
}

# --------------------------------------------------------
# 1. The Raw Input (Memory View)
# --------------------------------------------------------
Raw_Input: {
  link: "#anchor-lexer"
  tooltip: "Input Buffer"
  style: {
    stroke-dash: 3
    fill: "#1e1e1e"
    stroke: "#abb2bf"
  }
  
  Memory_Map: |c
    char* source = "SELECT * FROM 'users' WHERE id = 1;";
    // indices:     01234567890123456789012345678901234
  | {
    shape: text
  }
  
  # Token Stream Visualization
  Stream: {
    direction: right
    style.stroke: transparent
    
    t1: "SELECT" {
      shape: package
      style: {
        stroke: "#61afef"
        font-color: "#61afef"
        stroke-width: 2
      }
    }
    
    t2: "*" {
      shape: square
      style: {
        stroke: "#e06c75"
        font-color: "#e06c75"
        stroke-width: 2
      }
    }

    t3: "FROM" {
      shape: package
      style: {
        stroke: "#61afef"
        font-color: "#61afef"
        stroke-width: 2
      }
    }
    
    t4: "'users'" {
      shape: package
      style: {
        stroke: "#98c379"
        font-color: "#98c379"
        stroke-width: 2
      }
    }

    t5: "WHERE" {
      shape: package
      style: {
        stroke: "#61afef"
        font-color: "#61afef"
        stroke-width: 2
      }
    }

    t6: "id" {
      shape: package
      style: {
        stroke: "#d19a66"
        font-color: "#d19a66"
        stroke-width: 2
      }
    }

    t7: "=" {
      shape: square
      style: {
        stroke: "#e06c75"
        font-color: "#e06c75"
        stroke-width: 2
      }
    }

    t8: "1" {
      shape: square
      style: {
        stroke: "#c678dd"
        font-color: "#c678dd"
        stroke-width: 2
      }
    }

    t9: ";" {
      shape: square
      style: {
        stroke: "#abb2bf"
        font-color: "#abb2bf"
        stroke-width: 2
      }
    }

    t1 -> t2 -> t3 -> t4 -> t5 -> t6 -> t7 -> t8 -> t9
  }
}

# --------------------------------------------------------
# 2. The Internal Structures (Blueprints)
# --------------------------------------------------------
Internal_Structures: {
  link: "#anchor-lexer"
  style: {
    stroke: transparent
    fill: transparent
  }

  Enum_TokenType: {
    shape: class
    # Enumeration values
    TOKEN_KEYWORD
    TOKEN_IDENTIFIER
    TOKEN_STRING
    TOKEN_NUMBER
    TOKEN_SYMBOL
    TOKEN_EOF
  }

  Struct_Token: {
    shape: class
    tooltip: "The Slice View (Non-destructive)"
    # Fields
    type: TokenType
    start: "char*"
    length: int
    
    # Method
    "make_token()": Token
  }
  
  Enum_TokenType -> Struct_Token: defines type
}

# --------------------------------------------------------
# 3. Token Taxonomy (The Microscopic View)
# --------------------------------------------------------
Taxonomy: {
  link: "#anchor-lexer"
  direction: right
  
  # Group: Keywords
  Keywords: {
    style: {
      fill: "#61afef"
      stroke: "#61afef"
      font-color: black
      shadow: true
    }
    Example: |c
      Token {
        type: TOKEN_KEYWORD,
        start: &source[0],
        length: 6 // "SELECT"
      }
    |
    Logic: "is_alpha() && check_keyword()"
  }

  # Group: Symbols (Operators & Punctuation)
  Symbols: {
    style: {
      fill: "#e06c75"
      stroke: "#e06c75"
      font-color: black
      shadow: true
    }
    Example: |c
      Token {
        type: TOKEN_SYMBOL,
        start: &source[7], // "*"
        length: 1
      }
    |
    Logic: "switch(c) { case '*': ... }"
  }

  # Group: String Literals
  Strings: {
    style: {
      fill: "#98c379"
      stroke: "#98c379"
      font-color: black
      shadow: true
    }
    Example: |c
      Token {
        type: TOKEN_STRING,
        start: &source[14], // '
        length: 7           // 'users'
      }
    |
    Logic: "if (c == '\\'') read_string()"
  }

  # Group: Identifiers
  Identifiers: {
    style: {
      fill: "#d19a66"
      stroke: "#d19a66"
      font-color: black
      shadow: true
    }
    Example: |c
      Token {
        type: TOKEN_IDENTIFIER,
        start: &source[29], // id
        length: 2
      }
    |
    Logic: "is_alpha() && !check_keyword()"
  }

  # Group: Numeric Literals
  Numbers: {
    style: {
      fill: "#c678dd"
      stroke: "#c678dd"
      font-color: black
      shadow: true
    }
    Example: |c
      Token {
        type: TOKEN_NUMBER,
        start: &source[34], // 1
        length: 1
      }
    |
    Logic: "is_digit()"
  }
}

# --------------------------------------------------------
# 4. Wiring (Input -> Blueprint -> Instance)
# --------------------------------------------------------

# Connect Input stream to specific Types
Raw_Input.Stream.t1 -> Taxonomy.Keywords
Raw_Input.Stream.t3 -> Taxonomy.Keywords
Raw_Input.Stream.t5 -> Taxonomy.Keywords

Raw_Input.Stream.t2 -> Taxonomy.Symbols
Raw_Input.Stream.t7 -> Taxonomy.Symbols
Raw_Input.Stream.t9 -> Taxonomy.Symbols

Raw_Input.Stream.t4 -> Taxonomy.Strings

Raw_Input.Stream.t6 -> Taxonomy.Identifiers

Raw_Input.Stream.t8 -> Taxonomy.Numbers

# Connect Blueprint to Instances
Internal_Structures.Struct_Token -> Taxonomy.Keywords: instantiates {
  style: {
    stroke-dash: 3
    opacity: 0.5
  }
}