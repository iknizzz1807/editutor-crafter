vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  ast_node: {
    shape: class
    link: "#anchor-parser"
    style: {
      stroke-width: 2
      border-radius: 4
      shadow: true
    }
  }
  pointer: {
    source-arrowhead: circle
    style: {
      stroke: "#78909c"
      stroke-dash: 3
    }
  }
}

# ----------------------------------------------------------------------
# Visual Context: The Source SQL
# ----------------------------------------------------------------------
SourceSQL: |sql
  SELECT id, name 
  FROM users 
  WHERE id > 10 
  ORDER BY name DESC 
  LIMIT 5
| {
  near: top-center
  link: "#anchor-parser"
  style: {
    font-size: 14
  }
}

# ----------------------------------------------------------------------
# Root: The Select Statement Struct
# ----------------------------------------------------------------------
SelectStmt: {
  class: ast_node
  label: SelectStatement
  type: STMT_SELECT
  "+columns": Vector*
  "+from": TableRef*
  "+where": Expression*
  "+order": OrderBy*
  "+limit": Expression*
  
  style.fill: "#e3f2fd"
  style.stroke: "#1565c0"
}

# ----------------------------------------------------------------------
# Branch 1: Column List
# ----------------------------------------------------------------------
ColumnsVec: {
  class: ast_node
  label: Vector<Expression>
  length: 2
  capacity: 8
  style.fill: "#f3e5f5"
  style.stroke: "#7b1fa2"
}

SelectStmt -> ColumnsVec: columns {
  class: pointer
}

ColID: {
  class: ast_node
  label: ColumnExpr
  type: EXPR_COLUMN
  table: null
  name: "id"
  style.fill: "#f3e5f5"
}

ColName: {
  class: ast_node
  label: ColumnExpr
  type: EXPR_COLUMN
  table: null
  name: "name"
  style.fill: "#f3e5f5"
}

ColumnsVec -> ColID: "[0]"
ColumnsVec -> ColName: "[1]"

# ----------------------------------------------------------------------
# Branch 2: From Clause (Table)
# ----------------------------------------------------------------------
TableRef: {
  class: ast_node
  label: TableRef
  type: TABLE_DIRECT
  name: "users"
  alias: null
  style.fill: "#e8f5e9"
  style.stroke: "#2e7d32"
}

SelectStmt -> TableRef: from {
  class: pointer
}

# ----------------------------------------------------------------------
# Branch 3: Where Clause (Expression Tree)
# ----------------------------------------------------------------------
BinaryExpr: {
  class: ast_node
  label: BinaryExpr
  type: EXPR_BINARY
  op: "OP_GREATER (>)"
  "+left": Expression*
  "+right": Expression*
  
  style.fill: "#fff3e0"
  style.stroke: "#ef6c00"
}

SelectStmt -> BinaryExpr: where {
  class: pointer
}

LeftOp: {
  class: ast_node
  label: ColumnExpr
  type: EXPR_COLUMN
  name: "id"
  style.fill: "#fff3e0"
}

RightOp: {
  class: ast_node
  label: LiteralExpr
  type: EXPR_LITERAL
  value_type: VAL_INT
  value: 10
  style.fill: "#fff3e0"
}

BinaryExpr -> LeftOp: left
BinaryExpr -> RightOp: right

# ----------------------------------------------------------------------
# Branch 4: Order By
# ----------------------------------------------------------------------
OrderNode: {
  class: ast_node
  label: OrderDef
  type: ORDER_DEF
  "direction": DESC
  "+expr": Expression*
  style.fill: "#e0f7fa"
  style.stroke: "#006064"
}

SelectStmt -> OrderNode: order_by {
  class: pointer
}

OrderExpr: {
  class: ast_node
  label: ColumnExpr
  type: EXPR_COLUMN
  name: "name"
  style.fill: "#e0f7fa"
}

OrderNode -> OrderExpr: expr

# ----------------------------------------------------------------------
# Branch 5: Limit
# ----------------------------------------------------------------------
LimitExpr: {
  class: ast_node
  label: LiteralExpr
  type: EXPR_LITERAL
  value_type: VAL_INT
  value: 5
  style.fill: "#ffebee"
  style.stroke: "#c62828"
}

SelectStmt -> LimitExpr: limit {
  class: pointer
}