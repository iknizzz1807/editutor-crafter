vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Abstract Syntax Tree (AST): Expression Parsing" {
  shape: text
  style: {
    font-size: 32
    bold: true
  }
  near: top-center
  link: "#anchor-parser"
}

sql_context: |sql
  SELECT * FROM users
  WHERE id = 1 AND (age > 25 OR status = 'active')
| {
  shape: code
  style: {
    stroke: "#66b2b2"
    stroke-width: 2
  }
  link: "#anchor-parser"
}

# Legend/Key for the memory layout
legend: {
  grid-rows: 3
  grid-gap: 5
  near: bottom-right
  link: "#anchor-parser"
  
  Operator: {
    shape: class
    style: {
      fill: "#2d2d2d"
      stroke: "#66b2b2"
      stroke-width: 2
    }
  }
  Literal: {
    shape: square
    style: {
      fill: "#4a3b59"
      stroke: "#d4a5d4"
    }
  }
  Identifier: {
    shape: square
    style: {
      fill: "#3b4a3b"
      stroke: "#a5d4a5"
    }
  }
}

heap_memory: "Heap Memory (AST Nodes)" {
  style: {
    fill: "#111111"
    stroke: "#444444"
    stroke-dash: 3
  }
  link: "#anchor-parser"

  # Root Node: AND
  node_root: {
    shape: class
    label: "BinaryExpr (Root)"
    
    # Simulating C-Struct Memory Layout
    addr: "0x1000" {constraint: primary_key}
    type: "EXPR_BINARY"
    op: "TOKEN_AND"
    left_ptr: "0x1040"
    right_ptr: "0x1080"
    
    style: {
      stroke: "#66b2b2"
      stroke-width: 3
    }
    link: "#anchor-parser"
  }

  # Left Child: id = 1
  node_left: {
    shape: class
    label: "BinaryExpr"
    
    addr: "0x1040"
    type: "EXPR_BINARY"
    op: "TOKEN_EQUAL"
    left_ptr: "0x2000"
    right_ptr: "0x2010"
    
    link: "#anchor-parser"
  }

  # Right Child: OR clause
  node_right: {
    shape: class
    label: "BinaryExpr"
    
    addr: "0x1080"
    type: "EXPR_BINARY"
    op: "TOKEN_OR"
    left_ptr: "0x10C0"
    right_ptr: "0x1100"
    
    link: "#anchor-parser"
  }

  # OR -> Left: age > 25
  node_or_left: {
    shape: class
    label: "BinaryExpr"
    
    addr: "0x10C0"
    type: "EXPR_BINARY"
    op: "TOKEN_GREATER"
    left_ptr: "0x2020"
    right_ptr: "0x2030"
    
    link: "#anchor-parser"
  }

  # OR -> Right: status = 'active'
  node_or_right: {
    shape: class
    label: "BinaryExpr"
    
    addr: "0x1100"
    type: "EXPR_BINARY"
    op: "TOKEN_EQUAL"
    left_ptr: "0x2040"
    right_ptr: "0x2050"
    
    link: "#anchor-parser"
  }
}

# Leaf Nodes (Atoms)
atoms: {
  link: "#anchor-parser"
  
  id_atom: "id" {
    shape: square
    style: {
      fill: "#3b4a3b"
      stroke: "#a5d4a5"
    }
  }
  
  val_1: "1" {
    shape: square
    style: {
      fill: "#4a3b59"
      stroke: "#d4a5d4"
    }
  }
  
  age_atom: "age" {
    shape: square
    style: {
      fill: "#3b4a3b"
      stroke: "#a5d4a5"
    }
  }
  
  val_25: "25" {
    shape: square
    style: {
      fill: "#4a3b59"
      stroke: "#d4a5d4"
    }
  }
  
  status_atom: "status" {
    shape: square
    style: {
      fill: "#3b4a3b"
      stroke: "#a5d4a5"
    }
  }
  
  val_active: "'active'" {
    shape: square
    style: {
      fill: "#4a3b59"
      stroke: "#d4a5d4"
    }
  }
}

# Connectivity
# Root -> L/R
heap_memory.node_root.left_ptr -> heap_memory.node_left
heap_memory.node_root.right_ptr -> heap_memory.node_right

# Left Branch (id = 1)
heap_memory.node_left.left_ptr -> atoms.id_atom
heap_memory.node_left.right_ptr -> atoms.val_1

# Right Branch (OR)
heap_memory.node_right.left_ptr -> heap_memory.node_or_left
heap_memory.node_right.right_ptr -> heap_memory.node_or_right

# OR Left (age > 25)
heap_memory.node_or_left.left_ptr -> atoms.age_atom
heap_memory.node_or_left.right_ptr -> atoms.val_25

# OR Right (status = 'active')
heap_memory.node_or_right.left_ptr -> atoms.status_atom
heap_memory.node_or_right.right_ptr -> atoms.val_active

# Context connection
sql_context -> heap_memory.node_root: "Parsed Into" {
  style: {
    stroke-dash: 3
    stroke: "#66b2b2"
  }
}