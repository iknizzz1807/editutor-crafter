vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
    sketch: true
  }
}

classes: {
  process: {
    style: {
      border-radius: 8
      stroke-width: 2
      shadow: true
    }
    link: "#anchor-executor"
  }
  memory: {
    shape: package
    style: {
      stroke: "#333"
      font-color: "#333"
      fill: "#f4f4f4"
    }
    link: "#anchor-executor"
  }
  bitstream: {
    shape: class
    style: {
      font: mono
      fill: "#e1e4e8"
    }
    link: "#anchor-executor"
  }
}

direction: right

Input: |sql
  INSERT INTO users (id, name)
  VALUES (42, 'Alice')
| {
  shape: code
  link: "#anchor-executor"
}

1. Validation: {
  class: process
  label: "1. Schema Validation"
  
  Schema Check: |md
    - Check table `users` exists
    - Check constraints (NOT NULL)
    - Check types (Int, Varchar)
  | {
    shape: text
    link: "#anchor-executor"
  }
  
  sqlite_master: {
    shape: cylinder
    label: "Schema Definition"
    link: "#anchor-executor"
  }

  Schema Check <-> sqlite_master: Lookup
}

2. Serialization: {
  class: process
  label: "2. Row Serialization"
  
  Logical Row: {
    id: "42 (int)"
    name: "'Alice' (varchar)"
    link: "#anchor-executor"
  }

  Varint Encoding: {
    class: bitstream
    header: "Payload Size: 0x0C"
    id_type: "Type: Int8 (0x01)"
    name_type: "Type: Str5 (0x17)"
    id_val: "0x2A"
    name_val: "0x41 6C 69 63 65"
  }

  Logical Row -> Varint Encoding: Compact
}

3. Navigation: {
  class: process
  label: "3. Find Insert Position"
  
  Cursor: {
    label: "B-Tree Cursor"
    shape: diamond
    link: "#anchor-executor"
  }

  Traversal: |md
    1. Start at **Root Page**
    2. Binary Search Keys
    3. Follow Child Pointers
    4. Stop at **Leaf Page**
  | {
    shape: text
    link: "#anchor-executor"
  }
  
  Cursor -> Traversal
}

4. Mutation: {
  class: memory
  label: "4. Modification Strategy"

  Target Page: {
    link: "#anchor-executor"
    
    Header: {
      shape: queue
      label: "Page Header\n(Offset, Cells)"
    }
    
    Layout: {
      grid-rows: 1
      grid-gap: 0
      
      Pointers: "Cell Pointers (Sorted)" {
        style.fill: "#ffe0b2"
      }
      Free: "Free Space" {
        style.fill: "#ffffff"
        style.stroke-dash: 3
      }
      Cells: "Cell Content (Unsorted)" {
        style.fill: "#c8e6c9"
      }
    }
  }

  Decision: {
    shape: diamond
    label: Fits?
    link: "#anchor-executor"
  }

  Target Page -> Decision: Check Free Space

  Normal Path: {
    label: "Space Available"
    style.stroke: green
    
    Op: "memmove()"
    Desc: "Shift pointers, append cell bytes"
    link: "#anchor-executor"
  }

  Split Path: {
    label: "Page Full (Node Split)"
    style.stroke: red
    style.stroke-dash: 3
    
    Action: {
      grid-columns: 3
      Original: "Page N (Full)"
      New Sibling: "Page N+1 (New)"
      Parent: "Promote Divider Key"
    }
    link: "#anchor-executor"
  }

  Decision -> Normal Path: Yes
  Decision -> Split Path: No
}

5. Persistence: {
  class: process
  label: "5. Write to Cache"
  
  Pager Cache: {
    grid-columns: 4
    Page 1: Clean
    Page 2: Clean
    Page 42: DIRTY {
      style.fill: "#ffcdd2"
      style.stroke: red
    }
    Page 99: Clean
    link: "#anchor-executor"
  }
}

Input -> 1. Validation
1. Validation -> 2. Serialization: Valid
2. Serialization -> 3. Navigation: Binary Blob
3. Navigation -> 4. Mutation: Cursor at Leaf
4. Mutation -> 5. Persistence: Update Memory