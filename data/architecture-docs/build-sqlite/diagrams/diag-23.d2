vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    index: "#E1F5FE"
    table: "#FFF3E0"
    memory: "#F5F5F5"
    highlight: "#FF6D00"
    pointer: "#2962FF"
  }
}

direction: right

title: "Index Architecture: The Double Jump" {
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
  }
}

query_context: |sql
  SELECT * FROM users 
  WHERE email = 'alice@dao.com'
| {
  shape: code
  style: {
    stroke: ${colors.pointer}
    stroke-width: 2
  }
  link: "#anchor-index"
}

# ----------------------------------------------------------------------
# LEFT: Secondary Index B-Tree
# ----------------------------------------------------------------------
idx_tree: Secondary Index (B-Tree: email) {
  link: "#anchor-index"
  style: {
    fill: ${colors.index}
    stroke: ${colors.pointer}
  }
  
  idx_root: Page 50 (Root) {
    shape: class
    keys: "['m@dao.com', 'z@dao.com']"
    ptrs: "[Page 100, Page 200, Page 300]"
  }

  idx_leaf: Page 200 (Leaf) {
    shape: class
    "alice@dao.com": "42 (RowID)"
    "bob@dao.com": "105 (RowID)"
  }

  idx_root -> idx_leaf: "Binary Search keys"
}

# ----------------------------------------------------------------------
# ACTION: Indirection
# ----------------------------------------------------------------------
indirection: Indirection Step {
  shape: step
  label: "Found 'alice@dao.com'\nExtract RowID: 42"
  style: {
    fill: ${colors.highlight}
    font-color: white
    shadow: true
  }
  link: "#anchor-index"
}

# ----------------------------------------------------------------------
# RIGHT: Main Table B-Tree
# ----------------------------------------------------------------------
table_tree: Main Table (Clustered: id) {
  link: "#anchor-index"
  style: {
    fill: ${colors.table}
    stroke: ${colors.highlight}
  }

  tbl_root: Page 1 (Root) {
    shape: class
    keys: "[50, 100]"
    ptrs: "[Page 10, Page 20, Page 30]"
  }

  tbl_leaf: Page 10 (Leaf) {
    shape: class
    "ID 42": "alice | alice@dao.com | Admin"
    "ID 43": "charlie | charlie@dao.com | User"
  }

  tbl_root -> tbl_leaf: "Traverse to ID=42"
}

# ----------------------------------------------------------------------
# BOTTOM: Physical Memory Layout (Microscope View)
# ----------------------------------------------------------------------
memory_microscope: Memory Layout Comparison {
  link: "#anchor-index"
  style: {
    fill: ${colors.memory}
    stroke-dash: 3
  }
  
  index_cell: Index Cell Layout (Compact) {
    shape: class
    "0": "RowID (4B)"
    "4": "KeySize (4B)"
    "8": "KeyBytes (Var)"
  }

  table_cell: Table Row Layout (Full) {
    shape: class
    "0": "ID (4B)"
    "4": "User (32B)"
    "36": "Email (255B)"
    "291": "Role (Var)"
  }

  note: |md
    **Optimization Note**:
    Index pages fit more entries
    because they exclude full row data.
    This increases *Fan-out*.
  | {
    shape: rectangle
    style.fill: "#FFF9C4"
    style.stroke: "#FBC02D"
    width: 250
  }
  
  # Invisible connection to position note near index_cell in ELK layout
  index_cell -> note: {style.opacity: 0}
}

# ----------------------------------------------------------------------
# CONNECTIONS (The Flow)
# ----------------------------------------------------------------------
query_context -> idx_tree.idx_root: "1. Index Scan"

idx_tree.idx_leaf -> indirection: "Pointer"

indirection -> table_tree.tbl_root: "2. Table Seek (Random I/O)" {
  style: {
    stroke: ${colors.highlight}
    stroke-width: 3
    stroke-dash: 3
    animated: true
  }
}

table_tree.tbl_leaf -> result_set: "3. Result"

result_set: Result Set {
  shape: package
  style.fill: "#C8E6C9"
  row: "{id: 42, email: 'alice...'}"
  link: "#anchor-index"
}

# Link memory view to logical view for context
idx_tree.idx_leaf -> memory_microscope.index_cell: "Physical Format" {
  style: {
    opacity: 0.3
    stroke-dash: 5
  }
}
table_tree.tbl_leaf -> memory_microscope.table_cell: "Physical Format" {
  style: {
    opacity: 0.3
    stroke-dash: 5
  }
}