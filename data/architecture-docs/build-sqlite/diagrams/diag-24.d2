vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Index Entry Format (Microscope View)" {
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
  }
}

# -------------------------------------------------------------------------
# 1. The Index Page (The "Shadow" B-Tree)
# -------------------------------------------------------------------------
IndexNode: "Index Leaf Page (4KB)" {
  link: "#ms-index"
  style: {
    fill: "#f0f4f8"
    stroke: "#333"
    stroke-width: 2
  }

  # Visual header of the page
  Header: Page Header {
    shape: rectangle
    height: 40
    style: {
      fill: "#dce4ef"
      stroke: "#333"
    }
    label: "Page Type: LEAF | Num Cells: 3 | Parent: 50"
  }

  # The Cells packed in the page
  CellArray: {
    layout: horizontal
    style: {
        stroke-width: 0
        fill: transparent
    }

    Cell1: "Offset 0x0040" {
      shape: package
      label: "Cell 0\nKey: alice@ex.."
      style.fill: "#fff"
      width: 120
    }
    
    Cell2: "Offset 0x0080" {
      shape: package
      label: "Cell 1\nKey: bob@ex.."
      style.fill: "#fff"
      width: 120
    }

    Cell3: "Offset 0x00C0" {
      shape: package
      label: "Cell 2\nKey: bob@ex.."
      style.fill: "#fff"
      width: 120
      tooltip: "Duplicate Key Example"
    }
  }
}

# -------------------------------------------------------------------------
# 2. Microscopic View of a Single Cell
# -------------------------------------------------------------------------
Microscope: "Microscope View: IndexCell Struct" {
  link: "#ms-index"
  style: {
    fill: "#e3f2fd"
    stroke: "#1e88e5"
    stroke-dash: 3
  }

  # Byte layout representation
  Bytes: {
    layout: horizontal
    
    RowID: "RowID (4 bytes)" {
      shape: class
      style: {
        fill: "#ffccbc" # Red/Orange for pointer
      }
      "Value: 15"
    }

    KeySize: "Key Size (4 bytes)" {
      shape: class
      style: {
        fill: "#fff9c4" # Yellow for metadata
      }
      "Value: 15"
    }

    KeyPayload: "Key Data (Variable)" {
      shape: class
      style: {
        fill: "#c8e6c9" # Green for data
      }
      "Value: 'bob@example.com'"
    }
  }
}

# -------------------------------------------------------------------------
# 3. Handling Duplicates (Concept)
# -------------------------------------------------------------------------
DuplicateLogic: "Duplicate Key Handling" {
  link: "#ms-index"
  style: {
    fill: "#fff3e0"
    stroke: "#ef6c00"
  }
  
  Explanation: |md
    When keys are identical, the **RowID** acts as the tie-breaker.
    The effective composite key becomes `(Key, RowID)`.
  | {
    shape: text
  }

  Comparison: {
    layout: horizontal
    
    EntryA: "Entry A" {
      shape: sql_table
      key: "bob@example.com"
      row_id: 15
    }

    Operator: "<" {
      shape: text
      style.font-size: 30
    }

    EntryB: "Entry B" {
      shape: sql_table
      key: "bob@example.com"
      row_id: 99
    }
  }
}

# -------------------------------------------------------------------------
# 4. The Target (Main Table)
# -------------------------------------------------------------------------
MainTable: "Main Table Page (Clustered Storage)" {
  link: "#ms-index"
  style: {
    fill: "#fbe9e7"
    stroke: "#d84315"
  }

  Row15: "Row 15" {
    shape: rectangle
    label: "ID: 15 | Name: Bob | Email: bob@example.com | ..."
    style.fill: "#ffab91"
  }
  
  Row99: "Row 99" {
    shape: rectangle
    label: "ID: 99 | Name: Bob (Duplicate Name) | Email: bob@example.com | ..."
    style.fill: "#ffab91"
  }
}

# -------------------------------------------------------------------------
# Connections
# -------------------------------------------------------------------------

# Zoom lines from Page to Microscope
IndexNode.CellArray.Cell2 -> Microscope.Bytes: "Zoom In" {
  style: {
    stroke-dash: 3
    stroke: "#1e88e5"
    opacity: 0.6
  }
}

# Pointer logic
Microscope.Bytes.RowID -> MainTable.Row15: "Points to Location" {
  style: {
    stroke: "#d84315"
    stroke-width: 3
    animated: true
  }
}

# Duplicate logic connection
DuplicateLogic.Comparison.EntryA -> IndexNode.CellArray.Cell2: "Represents" {
  style: {
    stroke-dash: 3
    opacity: 0.5
  }
}
DuplicateLogic.Comparison.EntryB -> IndexNode.CellArray.Cell3: "Represents" {
  style: {
    stroke-dash: 3
    opacity: 0.5
  }
}

# Main table connection for duplicates
IndexNode.CellArray.Cell3 -> MainTable.Row99: "Points to" {
  style: {
    stroke: "#d84315"
    stroke-width: 2
  }
}