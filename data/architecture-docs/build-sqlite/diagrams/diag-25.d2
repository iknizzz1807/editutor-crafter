vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right

# Global Styles
classes: {
  element: {
    link: "#anchor-index"
  }
  process: {
    shape: rectangle
    style.border-radius: 5
    style.fill: "#f4f4f4"
    style.stroke: "#333"
    link: "#anchor-index"
  }
  datastruct: {
    shape: sql_table
    style.fill: "#fff"
    style.stroke: "#333"
    style.shadow: true
    link: "#anchor-index"
  }
  container_box: {
    style.fill: "#fafafa"
    style.stroke: "#ccc"
    style.stroke-width: 2
    link: "#anchor-index"
  }
}

# -------------------------------------------------------------------------
# 1. THE TRIGGER
# -------------------------------------------------------------------------
User: {
  shape: person
  style.fill: "#FFD700"
  class: element
}

Query: |md
  sql
  SELECT * FROM users
  WHERE email = 'alice@example.com'
  
| {
  class: element
}

User -> Query

# -------------------------------------------------------------------------
# 2. THE BRAIN (Parsing & Planning)
# -------------------------------------------------------------------------
Query Processor: {
  class: container_box
  label: "Query Processor"
  
  Parser: "Lexer & Parser" {
    class: process
    tooltip: "Extracts WHERE predicates"
  }
  
  Catalog: "System Catalog" {
    shape: cylinder
    style.fill: "#D7BDE2"
    label: "Metadata:\n- idx_email (B-Tree)\n- idx_id (PK)"
    class: element
  }

  Optimizer: "Cost-Based Optimizer" {
    class: process
    tooltip: "Compares SeqScan vs IndexScan"
  }

  Plan: |md
    **Execution Plan**
    1. IndexScan(idx_email)
    2. TableSeek(users)
  | {
    class: element
    style.fill: "#FCF3CF"
  }

  Parser -> Optimizer: "AST"
  Catalog -> Optimizer: "Stats"
  Optimizer -> Plan: "Selected Path"
}

Query -> Query Processor.Parser

# -------------------------------------------------------------------------
# 3. THE ENGINE (Storage & Access)
# -------------------------------------------------------------------------
Storage Engine: {
  class: container_box
  style.fill: "#EAFAF1"
  style.stroke: "#82E0AA"

  # VISUALIZATION: SECONDARY INDEX
  Secondary Index: "Secondary Index B-Tree (idx_email)" {
    style.fill: "#D6EAF8"
    class: element
    
    Index Root: {
      class: datastruct
      "separator": "m"
      "left_ptr": "Page 20"
      "right_ptr": "Page 30"
    }

    Index Leaf: {
      class: datastruct
      label: "Leaf Page 20"
      "key": "alice@example.com"
      "row_id": "105" {constraint: "Pointer"}
    }
    
    Index Root -> Index Leaf: "Tree Traversal"
  }

  # VISUALIZATION: MAIN TABLE
  Main Table: "Main Table B-Tree (Clustered)" {
    style.fill: "#D5F5E3"
    class: element

    Data Page: {
      class: datastruct
      label: "Data Page 500"
      "row_id": "105" {constraint: "PK"}
      "username": "Alice"
      "email": "alice@example.com"
      "balance": "100.00"
    }
  }

  # THE CRITICAL STEP: The "Double Jump"
  Secondary Index.Index Leaf.row_id -> Main Table.Data Page.row_id: "Random I/O Seek" {
    style.stroke: "#C0392B"
    style.stroke-width: 4
    style.stroke-dash: 3
    style.animated: true
    source-arrowhead: {
      shape: circle
      style.filled: true
    }
    target-arrowhead: {
      shape: diamond
      style.filled: true
    }
  }
}

Query Processor.Plan -> Storage Engine.Secondary Index.Index Root: "Execute Scan"

# -------------------------------------------------------------------------
# 4. CONTEXT & EXPLANATION
# -------------------------------------------------------------------------
Analysis: |md
  # The Indirection Cost
  
  1. **Index Seek**: $O(\log N)$
     - Finds the Key ('alice...')
     - Retrieves the `row_id` (105)
  
  2. **Table Seek**: $O(\log N)$
     - Uses `row_id` to jump to the Main Table.
     - Fetches full row data.
  
  *Warning*: High selectivity (fetching many rows) causes
  pointer chasing, which is slower than a full sequential scan.
| {
  class: element
  style.fill: "#FEF9E7"
}

# Connect Analysis lightly to Storage Engine to position it relatively close in Elk
Storage Engine -- Analysis: {
  style: {
    stroke: transparent
  }
}