vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: down

classes: {
  process: {
    shape: step
    style: {
      border-radius: 5
    }
  }
  state: {
    shape: oval
  }
  storage: {
    shape: cylinder
  }
}

Client: {
  shape: person
  link: "#anchor-transactions"
}

Transaction Manager: {
  style: {
    fill: "#f7f7f7"
    stroke: "#333"
    stroke-width: 2
    shadow: true
  }
  link: "#anchor-transactions"

  BEGIN: {
    class: state
    style.fill: "#ADE1AF"
    link: "#anchor-transactions"
  }

  Acquire Locks: {
    class: process
    label: "Acquire Locks\n(Growing Phase)"
    tooltip: "Strict 2PL: Wait for S-Lock (Read) or X-Lock (Write)"
    link: "#anchor-transactions"
  }

  Execute: {
    class: process
    label: "Execute SQL\n(Read/Modify Pages)"
    tooltip: "Operations happen in memory (Buffer Pool)"
    link: "#anchor-transactions"
  }

  Validate: {
    shape: diamond
    label: "Commit?"
    link: "#anchor-transactions"
  }

  WAL Flush: {
    class: process
    label: "Flush WAL Buffer\n(fsync)"
    style.fill: "#F9D8A7"
    tooltip: "Durability Barrier: Must hit physical disk"
    link: "#anchor-transactions"
  }

  Apply Commit: {
    class: state
    label: "COMMITTED"
    style.fill: "#ADE1AF"
    link: "#anchor-transactions"
  }

  Rollback Logic: {
    class: process
    label: "Undo Changes\n(Discard Dirty Pages)"
    style.fill: "#FFB3BA"
    link: "#anchor-transactions"
  }

  Release Locks: {
    class: process
    label: "Release Locks\n(Shrinking Phase)"
    tooltip: "Release all locks at once to prevent cascading aborts"
    link: "#anchor-transactions"
  }

  END: {
    class: state
    style.fill: "#eee"
    link: "#anchor-transactions"
  }

  # Flow
  BEGIN -> Acquire Locks: "Start"
  Acquire Locks -> Execute: "Locks Granted"
  Execute -> Validate: "Operations Done"

  # Commit Path
  Validate -> WAL Flush: "Yes (Success)"
  WAL Flush -> Apply Commit: "Persisted"
  Apply Commit -> Release Locks

  # Rollback Path
  Validate -> Rollback Logic: "No / Error"
  Rollback Logic -> Release Locks: "State Restored"

  Release Locks -> END
}

# External Interaction
Client -> Transaction Manager.BEGIN: "BEGIN TRANSACTION"
Client -> Transaction Manager.Validate: "COMMIT / ROLLBACK"

# Disk Interaction
Disk: {
  class: storage
  label: "WAL File\n(Append Only)"
  link: "#anchor-transactions"
  style.fill: "#F4B76C"
}

Transaction Manager.WAL Flush -> Disk: "Append Log Frame" {
  style: {
    stroke: "#F4B76C"
    stroke-width: 3
    animated: true
  }
}