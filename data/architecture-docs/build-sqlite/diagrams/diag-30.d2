vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  shared: {
    style: {
      fill: "#e6f4ea"
      stroke: "#1e8e3e"
      font-color: "#1e8e3e"
      stroke-width: 2
    }
  }
  exclusive: {
    style: {
      fill: "#fce8e6"
      stroke: "#d93025"
      font-color: "#d93025"
      stroke-width: 2
    }
  }
  intent: {
    style: {
      fill: "#fff8e1"
      stroke: "#f9ab00"
      font-color: "#e37400"
      stroke-dash: 3
    }
  }
  resource: {
    shape: package
    style: {
      fill: "#f8f9fa"
      stroke: "#5f6368"
      shadow: true
    }
  }
}

title: "LOCK HIERARCHY & COMPATIBILITY" {
  shape: text
  style: {
    font-size: 32
    bold: true
  }
  link: "#anchor-transactions"
}

Hierarchy: Granularity Protocol {
  direction: down
  link: "#anchor-transactions"
  
  tooltip: |'md
    To lock a node, transactions must lock all ancestors with an **Intent** lock.
    This prevents scanning the whole tree to detect conflicts.
  '|

  Database: Database (db.sqlite) {
    class: resource
    link: "#anchor-transactions"
    lock: "Lock: IX (Intent Exclusive)" {
      class: intent
      shape: hexagon
      link: "#anchor-transactions"
    }
  }

  Table: Table (Users) {
    class: resource
    link: "#anchor-transactions"
    lock: "Lock: IX" {
      class: intent
      shape: hexagon
      link: "#anchor-transactions"
    }
  }

  Page: Page (ID: 405) {
    class: resource
    link: "#anchor-transactions"
    lock: "Lock: SIX (Shared + Intent Exclusive)" {
      class: intent
      shape: hexagon
      link: "#anchor-transactions"
    }
  }

  Row1: Row (id=1) {
    class: resource
    link: "#anchor-transactions"
    lock: "Lock: S (Shared)" {
      class: shared
      shape: circle
      link: "#anchor-transactions"
    }
  }

  Row2: Row (id=2) {
    class: resource
    link: "#anchor-transactions"
    lock: "Lock: X (Exclusive)" {
      class: exclusive
      shape: circle
      link: "#anchor-transactions"
    }
  }

  Database -> Table
  Table -> Page
  Page -> Row1
  Page -> Row2
}

Matrix: Compatibility Matrix {
  link: "#anchor-transactions"
  style: {
    stroke-width: 0
    fill: transparent
  }
  
  CompatibilityTable: |'md
    | Req \ Held | IS | IX | S | SIX | X |
    | :--- | :-: | :-: | :-: | :-: | :-: |
    | **IS** | ✅ | ✅ | ✅ | ✅ | ❌ |
    | **IX** | ✅ | ✅ | ❌ | ❌ | ❌ |
    | **S**  | ✅ | ❌ | ✅ | ❌ | ❌ |
    | **SIX**| ✅ | ❌ | ❌ | ❌ | ❌ |
    | **X**  | ❌ | ❌ | ❌ | ❌ | ❌ |
  '|
  CompatibilityTable.shape: text
  CompatibilityTable.link: "#anchor-transactions"
}

Scenario: Microscopic Lock Manager {
  link: "#anchor-transactions"
  
  Resource: Target Page (0xAF) {
    shape: sql_table
    link: "#anchor-transactions"
    style: {
      fill: "#f8f9fa"
      stroke: "#5f6368"
    }
    Row A: string
    Row B: string
    Row C: string
  }

  Queue: Lock Queue {
    shape: queue
    link: "#anchor-transactions"
    
    T1: Tx #101 {
      label: "Tx #101\n(Reader)"
      class: shared
      status: GRANTED
      link: "#anchor-transactions"
    }
    
    T2: Tx #102 {
      label: "Tx #102\n(Reader)"
      class: shared
      status: GRANTED
      link: "#anchor-transactions"
    }

    T3: Tx #103 {
      label: "Tx #103\n(Writer)"
      class: exclusive
      status: WAITING
      link: "#anchor-transactions"
    }
    
    T1 -> T2 -> T3
  }

  Queue.T1 -> Resource: "Holds S-Lock"
  Queue.T2 -> Resource: "Holds S-Lock (Compatible)"
  Queue.T3 -> Resource: "Requesting X-Lock... BLOCKED" {
    style: {
      stroke: red
      stroke-dash: 3
      animated: true
    }
  }
}

Hierarchy -> Matrix: "Defines Rules" {
  style: {
    stroke: transparent
  }
}

Matrix -> Scenario: "Applied Logic" {
  style: {
    stroke: transparent
  }
}