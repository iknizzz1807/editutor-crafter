vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    bg: "#1e1e1e"
    tx: "#e1bee7"
    atom: "#ffcdd2"
    cons: "#c8e6c9"
    iso: "#bbdefb"
    dur: "#fff9c4"
    text: "#212121"
    code: "#cfd8dc"
  }
}

title: |md
  # ACID Guarantees Map
  *The Four Pillars of Transactional Safety*
| {
  near: top-center
  shape: text
  style: {
    font-size: 32
    font-color: ${colors.code}
  }
}

direction: down

# Central Coordinator
TransactionManager: {
  link: "#anchor-transactions"
  label: "Transaction Manager"
  shape: package
  style: {
    fill: ${colors.tx}
    stroke-width: 2
    shadow: true
  }

  State: Active {
    shape: oval
    style.fill: white
  }
  
  TxContext: {
    shape: class
    TxID: 1042
    Status: RUNNING
    StartTime: 1699982000
    ModifiedPages: "[50, 102]"
    HeldLocks: "[Page50(X), Page102(X)]"
  }
}

# -------------------------------------------------------------------------
# ATOMICITY: All or Nothing
# -------------------------------------------------------------------------
Atomicity: {
  link: "#anchor-transactions"
  label: "A: ATOMICITY"
  style: {
    fill: ${colors.atom}
    stroke-dash: 3
  }

  RollbackMechanism: {
    shape: step
    label: "Rollback (Undo)"
    tooltip: "Restores previous state on failure"
  }

  CommitProtocol: {
    shape: diamond
    label: "Commit Decision"
  }

  StateTransition: |md
    **States:**
    1. Active
    2. Committing
    3. Aborted / Committed
  | {
    shape: text
    style.font-size: 10
  }
}

# -------------------------------------------------------------------------
# CONSISTENCY: Rules & Constraints
# -------------------------------------------------------------------------
Consistency: {
  link: "#anchor-transactions"
  label: "C: CONSISTENCY"
  style: {
    fill: ${colors.cons}
    stroke-dash: 3
  }

  Validator: {
    shape: hexagon
    label: "State Validator"
  }

  Constraints: {
    shape: class
    style: {
      stroke: "#2e7d32"
    }
    # Using class fields to represent rules instead of nested children
    "PRIMARY KEY": "(id)"
    "CHECK": "balance >= 0"
    "FK": "REFERENCES users(id)"
    "UNIQUE": "email MUST BE UNIQUE"
  }
}

# -------------------------------------------------------------------------
# ISOLATION: Visibility & Locking
# -------------------------------------------------------------------------
Isolation: {
  link: "#anchor-transactions"
  label: "I: ISOLATION"
  style: {
    fill: ${colors.iso}
    stroke-dash: 3
  }

  LockManager: {
    shape: package
    style: {
      stroke: "#1565c0"
    }
    
    # Memory Layout of Lock Table using nested classes/packages
    LockTable: {
      label: "Hash Map (PageID -> Lock)"
      shape: rectangle
      style.fill: white

      Bucket_50: {
        shape: class
        PageID: 50
        Mode: "X-LOCK (Exclusive)"
        Owner: Tx_1042
        WaitQueue: "[Tx_1045, Tx_1088]"
      }

      Bucket_102: {
        shape: class
        PageID: 102
        Mode: "S-LOCK (Shared)"
        Owner: Tx_1042
        WaitQueue: "[]"
      }
    }
  }

  Protocol: "Strict 2PL" {
    tooltip: "Hold all locks until Commit"
    shape: step
  }
}

# -------------------------------------------------------------------------
# DURABILITY: Persistence
# -------------------------------------------------------------------------
Durability: {
  link: "#anchor-transactions"
  label: "D: DURABILITY"
  style: {
    fill: ${colors.dur}
    stroke-dash: 3
  }

  WAL: {
    shape: cylinder
    label: "Write-Ahead Log (WAL)"
    
    # Dense view of WAL Frame on disk
    Frame_N: {
      shape: package
      style.stroke-width: 2
      style.fill: white
      
      Header: {
        shape: class
        CRC32: 0xA1B2C3D4
        PageID: 50
        TxID: 1042
      }
      Payload: {
        shape: rectangle
        label: "4096 Bytes of Page Data"
        style.fill: "#eeeeee"
      }
    }
  }

  HardwareBarrier: {
    shape: queue
    label: "fsync() Barrier"
    style: {
      fill: "#ffcc80"
      stroke: "#ef6c00"
    }
  }

  Disk: {
    shape: cylinder
    label: "Magnetic/SSD Storage"
    style: {
      opacity: 0.6
      fill: "#bdbdbd"
    }
  }
}

# -------------------------------------------------------------------------
# CONNECTIONS & FLOWS
# -------------------------------------------------------------------------

# Atomicity Logic
TransactionManager -> Atomicity.CommitProtocol: "1. Request Commit"
Atomicity.CommitProtocol -> Durability.WAL: "2. Write Commit Record"
Atomicity.RollbackMechanism -> TransactionManager: "Aborts"

# Consistency Checks
TransactionManager -> Consistency.Validator: "Pre-Write Check"
Consistency.Validator -> Consistency.Constraints: "Verify"

# Isolation Enforcement
TransactionManager -> Isolation.LockManager: "Acquire Locks"
Isolation.LockManager -> Isolation.Protocol: "Enforces"
Isolation.LockManager -> TransactionManager: "Grant / Block"

# Durability Flow
TransactionManager -> Durability.WAL.Frame_N: "Append Updates"
Durability.WAL -> Durability.HardwareBarrier: "Sync"
Durability.HardwareBarrier -> Atomicity.CommitProtocol: "3. Acknowledge"
Durability.WAL -> Durability.Disk: "Checkpoint (Async)"

# Implicit Dependencies
Isolation.LockManager -> Durability.WAL: "Protects access to" {
  style: {
    stroke-dash: 3
    opacity: 0.5
  }
}

# Legend / Explanation
Explanation: |md
  **The ACID Flow:**
  1. **T** starts, acquires **I** locks.
  2. **T** modifies data, checks **C** rules.
  3. **T** writes to **D** WAL.
  4. **D** confirms fsync.
  5. **A** marks as Committed.
| {
  near: bottom-right
  style: {
    fill: ${colors.code}
    stroke-width: 1
  }
}