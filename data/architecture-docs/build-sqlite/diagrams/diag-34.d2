vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  component: {
    style: {
      stroke-width: 2
      shadow: true
      border-radius: 5
    }
    link: "#anchor-optimize"
  }
  data: {
    shape: cylinder
    style: {
      fill: "#e1f5fe"
      stroke: "#01579b"
    }
    link: "#anchor-optimize"
  }
  calc: {
    shape: step
    style: {
      fill: "#fff3e0"
      stroke: "#ef6c00"
    }
    link: "#anchor-optimize"
  }
}

Title: Cost Estimation Model (Cost-Based Optimizer) {
  shape: text
  style.font-size: 24
  near: top-center
}

# Inputs Section
Inputs: {
  style.stroke-width: 0
  
  Query: "SELECT * FROM users\nWHERE status = 'banned'" {
    shape: document
    class: component
  }

  Stats: Table Statistics {
    class: data
    rows: |md
      - **N_rows**: 1,000,000
      - **N_pages**: 50,000
      - **Distinct(status)**: 100
      - **Min/Max**: A..Z
    |
  }
  
  Config: Cost Constants {
    class: component
    shape: package
    vals: |md
      - **C_seq**: 1.0 (Seq Read)
      - **C_rand**: 4.0 (Rand Read)
      - **C_cpu**: 0.01 (Tuple Process)
    |
  }
}

# The Brain
Optimizer: The Cost Model {
  style: {
    fill: "#fcfcfc"
    stroke: "#333"
    stroke-dash: 3
  }
  link: "#anchor-optimize"

  Selectivity: Selectivity Estimation {
    class: calc
    label: "Step 1: Estimate Selectivity"
    logic: |md
      Formula: 1 / Distinct Count
      Value: 1 / 100
      Result: **1%** (0.01)
      Est. Rows: 10,000
    |
  }

  PlanA: Sequential Scan {
    class: calc
    label: "Plan A: Full Table Scan"
    math: |md
      **IO Cost**: 50,000 * 1.0 = 50,000
      **CPU Cost**: 1M * 0.01 = 10,000
      **Total**: **60,000**
    |
  }

  PlanB: Index Scan {
    class: calc
    label: "Plan B: Index Lookups"
    math: |md
      **IO Cost**: (10,000 * 4.0) = 40,000
      **CPU Cost**: 10,000 * 0.01 = 100
      **B-Tree Descent**: ~12 (Log N)
      **Total**: **~40,112**
    |
  }

  Comparator: {
    shape: diamond
    label: "Min(Cost)"
    class: component
    style.fill: "#e8f5e9"
  }

  Selectivity -> PlanA: "Input: N_rows (1M)"
  Selectivity -> PlanB: "Input: Filtered Rows (10k)"
  PlanA -> Comparator: 60,000
  PlanB -> Comparator: 40,112
}

# Output Section
Result: Execution Plan {
  class: component
  shape: document
  label: "SELECTED PLAN"
  content: |md
    # Index Scan
    - Index: idx_status
    - Cost: 40,112
    - Reason: 40k < 60k
  |
  style.fill: "#c8e6c9"
}

# Global Connections
Inputs.Query -> Optimizer.Selectivity: "AST"
Inputs.Stats -> Optimizer.Selectivity: "Metadata"
Inputs.Stats -> Optimizer.PlanA: "Pages=50k"
Inputs.Config -> Optimizer.PlanA: "Consts"
Inputs.Config -> Optimizer.PlanB: "Consts"

Optimizer.Comparator -> Result: "Winner"