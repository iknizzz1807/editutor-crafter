vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  memory_page: {
    shape: sql_table
    style: {
      fill: "#fdcb6e"
      stroke: "#e17055"
      stroke-width: 2
    }
  }
  disk_storage: {
    shape: cylinder
    style: {
      fill: "#2d3436"
      stroke: "#636e72"
      font-color: white
    }
  }
  logic_gate: {
    shape: diamond
    style: {
      fill: "#6c5ce7"
      stroke: "#a29bfe"
      font-color: white
    }
  }
  bit_field: {
    style: {
      font: mono
      fill: "#dfe6e9"
      stroke: "#636e72"
    }
  }
}

"THE ACID SAFEGUARD": {
  link: "#satellite-map"
  tooltip: "Atomicity and Durability ensuring Consistency"

  ram_stage: "1. VOLATILE STATE (RAM)" {
    link: "#milestone-4"
    
    page_cache: "PAGE CACHE" {
      dirty_p42: "Dirty Page #42" {
        class: memory_page
        header: "RowID | Value | Status"
        r1: "5 | 'Alice_Upd' | DIRTY"
      }
    }

    wal_buffer: "WAL BUFFER" {
      frame_101: "Frame 101" {
        class: memory_page
        header: "PageNo | CRC | Data"
        data: "42 | 0xAF22 | [...]"
      }
    }

    page_cache.dirty_p42 -> wal_buffer.frame_101: "Journaling" {
      style.animated: true
    }
  }

  io_barrier: "2. I/O BARRIER (FSYNC)" {
    link: "#milestone-6"
    
    os_kernel: "Kernel Write Queue" {
      fsync: "fsync()" {
        shape: parallelogram
        style.fill: "#00b894"
      }
    }
    
    hardware_fault: "POWER LOSS EVENT" {
      shape: diamond
      style.fill: "#d63031"
      style.font-color: white
    }

    os_kernel.fsync -> hardware_fault: "Interruption" {
      style.stroke: red
      style.stroke-width: 4
      target-arrowhead.shape: cross
    }
  }

  recovery_logic: "3. RECOVERY SENTINEL" {
    link: "#beyond-the-atlas"
    
    scan_wal: "Scan WAL" {shape: step}
    atomic_check: "Check Commit Marker" {class: logic_gate}
    
    scan_wal -> atomic_check
    
    redo: "DURABILITY: REDO" {
      style.fill: "#00b894"
      style.font-color: white
    }
    
    rollback: "ATOMICITY: ROLLBACK" {
      style.fill: "#d63031"
      style.font-color: white
    }

    atomic_check -> redo: "Marker Found"
    atomic_check -> rollback: "Torn Page (Invalid)"
  }

  disk_state: "4. PERSISTENT STATE (DISK)" {
    link: "#milestone-4"
    main_db: "database.sqlite" {
      class: disk_storage
      p42_committed: "Page #42" {
        class: memory_page
        header: "RowID | Value"
        r1: "5 | 'Alice_Upd'"
      }
    }
  }
}

"WAL FRAME MICROSCOPE": {
  link: "#milestone-7"
  
  frame_anatomy: {
    shape: sql_table
    header: "Byte Offset | Field Name | Size | Function"
    b0: "0 | Page Number | 4B | Target Page Map"
    b4: "4 | Checksum | 8B | Integrity Verification"
    b12: "12 | Page Data | 4096B | Raw B-Tree Payload"
    b4108: "4108 | Commit | 4B | ATOMICITY SENTINEL"
    
    b0.class: bit_field
    b4.class: bit_field
    b12.class: bit_field
    b4108.class: bit_field
  }
}

# Cross-container visualization
"THE ACID SAFEGUARD".ram_stage.wal_buffer.frame_101 -> "THE ACID SAFEGUARD".io_barrier.os_kernel.fsync: "Flushing"
"THE ACID SAFEGUARD".recovery_logic.redo -> "THE ACID SAFEGUARD".disk_state.main_db.p42_committed: "Safe Replay" {
  style.stroke: "#00b894"
  style.stroke-width: 3
}

# Documentation positioning fix
acid_note: ||md
### The Transactional Contract
- **Atomicity**: The `Commit Sentinel` at byte 4108 ensures that a partial write (Torn Page) is never treated as valid.
- **Durability**: Once `fsync()` returns, the WAL entry is permanent.
- **Consistency**: The Recovery Sentinel ensures the DB transitions from `State N` to `State N+1` without corruption.
|| {
  near: top-right
}

# Global Density Styling
***.style.font-size: 12
(*** -> ***)[*]: {
  style.font-size: 10
}