vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#4A5568"
    null_cell: "#FED7AA"
    data_cell: "#C6F6D5"
    result_good: "#48BB78"
    result_null: "#E53E3E"
    arrow_skip: "#3182CE"
    arrow_include: "#38A169"
  }
}

title: |md
  # Aggregate NULL Handling
  ### COUNT(*) vs COUNT(col) and NULL-skipping in SUM/AVG
| {near: top-center}

direction: right

source_table: {
  label: "Source Table: employees"
  shape: sql_table
  style.fill: white
  style.stroke: ${colors.header}

  id: INTEGER {constraint: primary_key}
  name: TEXT
  department: TEXT
  bonus: INTEGER
}

example_data: {
  label: "Example Data"
  shape: sql_table
  style.fill: white
  style.stroke: ${colors.header}

  row1: "1 | 'Alice'   | 'Sales'   | 5000"
  row2: "2 | 'Bob'     | 'Sales'   | NULL"
  row3: "3 | 'Charlie' | 'Eng'     | 3000"
  row4: "4 | 'Diana'   | 'Eng'     | NULL"
  row5: "5 | 'Eve'     | 'Sales'   | 2000"
}

source_table -> example_data: "5 rows total\n3 with bonus values\n2 with NULL bonus"

count_comparison: {
  direction: right
  
  count_star: {
    label: "COUNT(*)"
    style.fill: "${colors.data_cell}"
    style.stroke: "${colors.result_good}"
    
    explanation: |md
      Counts **ALL rows**
      regardless of NULLs
|
    
    result: {
      label: "= 5"
      shape: circle
      style.fill: "${colors.result_good}"
      style.font-color: white
      style.bold: true
    }
  }
  
  count_col: {
    label: "COUNT(bonus)"
    style.fill: "${colors.data_cell}"
    style.stroke: "${colors.arrow_skip}"
    
    explanation: |md
      Counts only **NON-NULL**
      values in bonus column
|
    
    result: {
      label: "= 3"
      shape: circle
      style.fill: "${colors.arrow_include}"
      style.font-color: white
      style.bold: true
    }
    
    null_rows: {
      label: "NULL rows\nSKIPPED"
      style.font-color: "${colors.result_null}"
      style.italic: true
    }
  }
}

example_data -> count_comparison: "Aggregate\nFunctions"

sum_avg_section: {
  label: "SUM and AVG: NULL Skipping Behavior"
  
  sum_behavior: {
    label: "SUM(bonus)"
    style.fill: "${colors.data_cell}"
    
    calc: |md
      5000 + NULL + 3000 + NULL + 2000
      
      **NULLs are SKIPPED** (not treated as 0)
      
      = 5000 + 3000 + 2000 = **10000**
|
    
    result: {
      label: "= 10000"
      shape: rectangle
      style.fill: "${colors.result_good}"
      style.font-color: white
    }
  }
  
  avg_behavior: {
    label: "AVG(bonus)"
    style.fill: "${colors.data_cell}"
    
    calc: |md
      (5000 + 3000 + 2000) / 3
      
      **Division by COUNT of non-NULL values**
      (NOT by total row count!)
      
      = 10000 / 3 = **3333.33**
|
    
    result: {
      label: "= 3333.33"
      shape: rectangle
      style.fill: "${colors.result_good}"
      style.font-color: white
    }
  }
  
  null_arithmetic_note: {
    label: |md
      ### Important Distinction
      
      **In expressions:** `NULL + 5 = NULL`
      (NULL propagates)
      
      **In aggregates:** `SUM` skips NULLs
      (NULLs excluded from calculation)
|
    style.fill: "#EDF2F7"
  }
}

example_data -> sum_avg_section: "Accumulation"

truth_table: {
  label: "Aggregate NULL Behavior Truth Table"
  
  grid-columns: 3
  grid-gap: 0
  
  header_agg: {
    label: "Aggregate"
    style.fill: "${colors.header}"
    style.font-color: white
    style.bold: true
  }
  header_input: {
    label: "Input Contains NULLs?"
    style.fill: "${colors.header}"
    style.font-color: white
    style.bold: true
  }
  header_result: {
    label: "Result"
    style.fill: "${colors.header}"
    style.font-color: white
    style.bold: true
  }
  
  row1_agg: "COUNT(*)"
  row1_input: "Yes/No"
  row1_result: {
    label: "Row count (ignores NULLs)"
    style.fill: "${colors.data_cell}"
  }
  
  row2_agg: "COUNT(col)"
  row2_input: "Yes"
  row2_result: {
    label: "Non-NULL count only"
    style.fill: "${colors.data_cell}"
  }
  
  row3_agg: "COUNT(col)"
  row3_input: "No"
  row3_result: {
    label: "Same as COUNT(*)"
    style.fill: "${colors.data_cell}"
  }
  
  row4_agg: "SUM(col)"
  row4_input: "All NULL"
  row4_result: {
    label: "NULL"
    style.fill: "${colors.null_cell}"
  }
  
  row5_agg: "SUM(col)"
  row5_input: "Some NULL"
  row5_result: {
    label: "Sum of non-NULL values"
    style.fill: "${colors.data_cell}"
  }
  
  row6_agg: "AVG(col)"
  row6_input: "All NULL"
  row6_result: {
    label: "NULL"
    style.fill: "${colors.null_cell}"
  }
  
  row7_agg: "AVG(col)"
  row7_input: "Some NULL"
  row7_result: {
    label: "Avg of non-NULL values only"
    style.fill: "${colors.data_cell}"
  }
  
  row8_agg: "MIN/MAX(col)"
  row8_input: "Some NULL"
  row8_result: {
    label: "Min/Max of non-NULL values"
    style.fill: "${colors.data_cell}"
  }
  
  row9_agg: "MIN/MAX(col)"
  row9_input: "All NULL"
  row9_result: {
    label: "NULL"
    style.fill: "${colors.null_cell}"
  }
}

empty_table_section: {
  label: "Empty Table Edge Cases"
  
  empty_case: {
    label: |md
      sql
      SELECT COUNT(*), SUM(bonus), AVG(bonus)
      FROM employees WHERE 1=0;
      
|
    
    results: {
      label: "Results"
      
      count_result: {
        label: "COUNT(*) = 0"
        shape: rectangle
        style.fill: "${colors.result_good}"
        style.font-color: white
      }
      
      sum_result: {
        label: "SUM(bonus) = NULL"
        shape: rectangle
        style.fill: "${colors.null_cell}"
      }
      
      avg_result: {
        label: "AVG(bonus) = NULL"
        shape: rectangle
        style.fill: "${colors.null_cell}"
      }
    }
    
    explanation: |md
      **Why NULL for SUM/AVG?**
      
      - SUM of no values is "unknown" → NULL
      - AVG of no values is "unknown" → NULL
      - COUNT(*) of no rows is definitively 0
      
      This is **not** the same as SUM of NULLs!
|
    style.fill: "#EDF2F7"
  }
}

truth_table -> empty_table_section: "Edge Cases"

key_takeaway: {
  label: |md
    ## Key Takeaways
    
    1. **COUNT(*)** counts rows, **COUNT(col)** counts non-NULL values
    2. **SUM/AVG** skip NULLs entirely—they don't propagate NULL
    3. **Empty set** returns NULL for SUM/AVG, 0 for COUNT(*)
    4. **AVG divides by non-NULL count**, not total row count
|
  near: bottom-center
  style.fill: "#EBF8FF"
  style.stroke: "${colors.arrow_skip}"
}