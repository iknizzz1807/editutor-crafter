vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  memory: {
    style: {
      fill: "#e1f5fe"
      stroke: "#01579b"
      stroke-width: 2
    }
  }
  logic: {
    style: {
      fill: "#fff3e0"
      stroke: "#e65100"
      stroke-dash: 0
    }
  }
  bytecode: {
    style: {
      font: mono
      fill: "#f3e5f5"
      stroke: "#4a148c"
    }
  }
}

direction: down

title: "SQLITE STATEMENT LIFECYCLE: THE NORTHBOUND TRAVERSAL" {
  shape: text
  style.font-size: 24
  style.bold: true
}

# --- STAGE 1: INGESTION ---
gateway: {
  label: "1. The Gateway (REPL)"
  link: "#milestone-1"
  
  input_buffer: {
    shape: sql_table
    style.fill: "#f1f8e9"
    "char* buffer": "0x7ffee1"
    "size_t length": "1024"
    "ssize_t input_len": "42"
  }
  
  raw_sql: "UPDATE users SET pts = 10 WHERE id = 5;" {
    shape: text
    style.italic: true
  }
}

gateway.input_buffer -> architect.tokenizer: "ASCII Stream"

# --- STAGE 2: LEXICAL & SEMANTIC ANALYSIS ---
architect: {
  label: "2. The Architect"
  link: "#milestone-2"
  
  tokenizer: "Tokenizer (State Machine)" {
    class: logic
    tooltip: "Lexer identifies Keywords vs Identifiers"
  }
  
  token_stream: {
    grid-columns: 5
    t1: "T_UPDATE"
    t2: "T_ID(users)"
    t3: "T_SET"
    t4: "T_ID(pts)"
    t5: "T_EQUALS"
  }
  
  parser: "Parser (Lemon/BNF)" {
    shape: package
    link: "#milestone-2"
  }
  
  tokenizer -> token_stream
  token_stream -> parser
}

architect.parser -> strategist.optimizer: "Abstract Syntax Tree (AST)"

# --- STAGE 3: QUERY PLANNING ---
strategist: {
  label: "3. The Strategist"
  link: "#milestone-5"
  
  optimizer: "Cost-Based Optimizer" {
    class: logic
  }
  
  plan_search: "Index Selection" {
    shape: diamond
    label: "Scan vs Index?"
  }
  
  optimizer -> plan_search
  plan_search -> engine.compiler: "Selected Plan: idx_user_id"
}

# --- STAGE 4: BYTECODE GENERATION ---
engine: {
  label: "4. The Engine (VDBE)"
  link: "#milestone-3"
  
  compiler: "VDBE Compiler"
  
  bytecode: {
    shape: sql_table
    class: bytecode
    "addr": "opcode | p1 | p2 | p3"
    "0": "Transaction | 0 | 1 | 0"
    "1": "VerifyCookie | 0 | 42 | 0"
    "2": "OpenRead | 0 | 2 | 0"
    "3": "Integer | 5 | 1 | 0"
    "4": "NotExists | 0 | 9 | 1"
    "5": "Column | 0 | 2 | 2"
  }
  
  compiler -> bytecode
}

engine.bytecode -> interface.vm_init: "sqlite3_prepare_v2()"

# --- STAGE 5: EXECUTION LOOP ---
interface: {
  label: "5. The Interface & VM"
  link: "#milestone-8"
  
  vm_init: "VM Initialized" {
    shape: step
  }
  
  step_loop: "sqlite3_step()" {
    shape: circle
    style.stroke-width: 4
    style.animated: true
  }
  
  vm_state: {
    label: "VDBE Machine State"
    pc: "Program Counter: 0x03" {
      style.font: mono
    }
    
    registers: {
      shape: sql_table
      class: memory
      "Reg 0": "0x00"
      "Reg 1": "5 (Int)"
      "Reg 2": "10 (Int)"
      "Reg 3": "NULL"
    }
    
    cursor: "B-Tree Cursor" {
      shape: cylinder
      link: "#milestone-4"
    }
  }
  
  finalize: "sqlite3_finalize()" {
    shape: step
  }
  
  vm_init -> step_loop
  step_loop -> vm_state: "Execute Opcode"
  vm_state -> step_loop: "Next Instruction"
  step_loop -> finalize: "SQLITE_DONE"
}

# --- STAGE 6: THE PROTECTOR (STORAGE) ---
warehouse: {
  label: "6. The Protector (WAL/Disk)"
  link: "#milestone-6"
  
  wal_log: {
    shape: queue
    label: "Write-Ahead Log"
    page_102: "Dirty Page 102"
    commit: "COMMIT MARKER"
  }
  
  pager: "Pager (Cache Manager)" {
    class: memory
  }
  
  pager -> wal_log: "fsync() barrier"
}

interface.vm_state.cursor -> warehouse.pager: "Request Page 102"

# --- MICRO-VIEW OVERLAYS ---
legend: {
  near: bottom-right
  class_logic: "Logic/Code" {
    class: logic
  }
  class_memory: "Memory/Storage" {
    class: memory
  }
  class_bytecode: "Opcodes" {
    class: bytecode
  }
}

# --- STATE TRANSITION VISUALIZATION ---
"Data State Transformation": {
  near: center-right
  
  before: "Page 102 (Old)" {
    shape: rectangle
    style.fill-pattern: dots
    pts_val: "pts = 0"
  }
  
  after: "Page 102 (Modified)" {
    shape: rectangle
    style.double-border: true
    pts_val: "pts = 10"
  }
  
  before -> after: "VDBE Execution" {
    style.stroke-width: 5
    style.stroke: green
  }
}