vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    ast_blue: "#4A90D9"
    compiler_purple: "#9B59B6"
    bytecode_orange: "#E67E22"
    vm_green: "#27AE60"
    data_flow: "#3498DB"
    control_flow: "#E74C3C"
    gray: "#7F8C8D"
  }
}
title: |md
  # Compilation Pipeline: AST â†’ Bytecode
  ### Data Walk: SELECT Statement Transformation
| {near: top-center}
direction: right
ast_layer: {
  label: "Abstract Syntax Tree (AST)"
  style.fill: "${colors.ast_blue}"
  style.stroke: "#2C3E50"
  style.font-color: white
  select_node: {
    label: "SelectStatement"
    shape: rectangle
    style.fill: "#2980B9"
    style.font-color: white
    style.bold: true
    link: "#select-stmt-details"
  }
  select_node.columns: {
    label: "columns: [*, name, age]"
    shape: rectangle
    style.fill: "#3498DB"
  }
  select_node.table: {
    label: "table: \"users\""
    shape: rectangle
    style.fill: "#3498DB"
  }
  select_node.where: {
    label: "where: BinaryExpr\n  op: AND\n  left: age > 18\n  right: status = 'active'"
    shape: rectangle
    style.fill: "#3498DB"
  }
  select_node -> select_node.columns: "select_list"
  select_node -> select_node.table: "from_clause"
  select_node -> select_node.where: "where_clause"
}
compiler_layer: {
  label: "Bytecode Compiler"
  style.fill: "${colors.compiler_purple}"
  style.stroke: "#2C3E50"
  style.font-color: white
  entry: {
    label: "compile_select(stmt)"
    shape: rectangle
    style.fill: "#8E44AD"
    style.bold: true
  }
  step1: {
    label: "1. Allocate Cursor\ncursor = allocate_cursor()"
    shape: rectangle
    style.fill: "#9B59B6"
  }
  step2: {
    label: "2. Emit OpenRead\nemit(OP_OpenRead, cursor, table_root)"
    shape: rectangle
    style.fill: "#9B59B6"
  }
  step3: {
    label: "3. Emit Rewind\nemit(OP_Rewind, cursor, end_label)"
    shape: rectangle
    style.fill: "#9B59B6"
  }
  step4: {
    label: "4. Compile WHERE\ncompile_expression(where, skip_label)"
    shape: rectangle
    style.fill: "#9B59B6"
  }
  step5: {
    label: "5. Emit Column ops\nfor each output column:\n  emit(OP_Column, cursor, col_idx, reg)"
    shape: rectangle
    style.fill: "#9B59B6"
  }
  step6: {
    label: "6. Emit ResultRow\nemit(OP_ResultRow, start_reg, count)"
    shape: rectangle
    style.fill: "#9B59B6"
  }
  step7: {
    label: "7. Emit Next\nemit(OP_Next, cursor, loop_start)"
    shape: rectangle
    style.fill: "#9B59B6"
  }
  step8: {
    label: "8. Emit Halt\nemit(OP_Halt)"
    shape: rectangle
    style.fill: "#9B59B6"
  }
  entry -> step1 -> step2 -> step3 -> step4 -> step5 -> step6 -> step7 -> step8
}
bytecode_layer: {
  label: "Bytecode Program"
  style.fill: "${colors.bytecode_orange}"
  style.stroke: "#2C3E50"
  style.font-color: white
  bytecode_table: ||md
    | addr | opcode | p1 | p2 | p3 |
    |------|--------|----|----|-----|
    | 0 | **OpenRead** | 0 | 2 | 0 |
    | 1 | **Rewind** | 0 | 9 | 0 |
    | 2 | **Column** | 0 | 1 | r1 |
    | 3 | **Le** | r1 | 18 | 8 |
    | 4 | **Column** | 0 | 2 | r2 |
    | 5 | **Ne** | r2 | 'active' | 8 |
    | 6 | **ResultRow** | r1 | 3 | |
    | 7 | **Next** | 0 | 2 | 0 |
    | 8 | **Halt** | 0 | 0 | 0 |
  ||
}
vm_layer: {
  label: "Virtual Machine (VDBE)"
  style.fill: "${colors.vm_green}"
  style.stroke: "#2C3E50"
  style.font-color: white
  fetch: {
    label: "Fetch\ninstr = code[pc]"
    shape: rectangle
    style.fill: "#1E8449"
  }
  decode: {
    label: "Decode\nswitch(instr.opcode)"
    shape: diamond
    style.fill: "#27AE60"
  }
  execute: {
    label: "Execute\nexecute_instruction(vm, instr)"
    shape: rectangle
    style.fill: "#2ECC71"
  }
  update_pc: {
    label: "Update PC\npc++ or pc = jump_target"
    shape: rectangle
    style.fill: "#1E8449"
  }
  fetch -> decode -> execute -> update_pc
  update_pc -> fetch: "loop"
}
ast_layer.select_node -> compiler_layer.entry: "compile(ast)" {
  style.stroke: "${colors.data_flow}"
  style.stroke-width: 3
  style.animated: true
  label: "AST traversal"
}
compiler_layer.step8 -> bytecode_layer: "emit()" {
  style.stroke: "${colors.data_flow}"
  style.stroke-width: 3
  label: "instruction\nstream"
}
bytecode_layer -> vm_layer.fetch: "load program" {
  style.stroke: "${colors.data_flow}"
  style.stroke-width: 3
}
control_flow_annotation: {
  label: |md
    **Control Flow:**
    - p2 in Rewind: jump to addr 9 if empty
    - p3 in Le/Ne: jump to addr 8 (skip row)
    - p2 in Next: jump to addr 2 (loop)
  |
  shape: text
  style.font-color: "${colors.control_flow}"
  style.font-size: 14
}
legend: {
  style.fill: white
  style.stroke: "${colors.gray}"
  data: "Data Flow" {style.fill: "${colors.data_flow}"}
  control: "Control Flow (jumps)" {style.fill: "${colors.control_flow}"}
  data -> control: "Legend" {style.opacity: 0}
}
layers: {
  select_stmt_details: {
    link_label: "SelectStatement Details"
    structure: {
      shape: class
      +type: AST_SELECT_STMT
      +columns: ColumnList
      +from_table: TableRef
      +where: Expression
      +group_by: ExpressionList
      +having: Expression
      +order_by: OrderByList
      +limit: Expression
    }
    example_sql: |md
      sql
      SELECT * FROM users 
      WHERE age > 18 AND status = 'active'
      
    |
  }
}