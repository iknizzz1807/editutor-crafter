vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    hit: "#4CAF50"
    miss: "#FF5722"
    dirty: "#FFC107"
    disk: "#2196F3"
    neutral: "#9E9E9E"
  }
}
title: |md
  # Buffer Pool: FetchPage Flow
  ### Cache Hit vs Miss Decision Tree with Dirty Page Write-Back
| {near: top-center}
direction: right
classes: {
  start_end: {
    shape: oval
    style: {
      fill: "${colors.neutral}"
      stroke: "#333"
      font-color: white
      bold: true
    }
  }
  decision: {
    shape: diamond
    width: 160
    height: 100
    style: {
      fill: "#E3F2FD"
      stroke: "#1976D2"
      stroke-width: 2
    }
  }
  action: {
    shape: rectangle
    style: {
      fill: "#FAFAFA"
      stroke: "#666"
      stroke-width: 2
      border-radius: 4
    }
  }
  hit_action: {
    shape: rectangle
    style: {
      fill: "${colors.hit}"
      stroke: "#2E7D32"
      stroke-width: 2
      border-radius: 4
      font-color: white
    }
  }
  miss_action: {
    shape: rectangle
    style: {
      fill: "${colors.miss}"
      stroke: "#D84315"
      stroke-width: 2
      border-radius: 4
      font-color: white
    }
  }
  dirty_action: {
    shape: rectangle
    style: {
      fill: "${colors.dirty}"
      stroke: "#F57F17"
      stroke-width: 2
      border-radius: 4
      font-color: black
    }
  }
  disk_action: {
    shape: rectangle
    style: {
      fill: "${colors.disk}"
      stroke: "#1565C0"
      stroke-width: 2
      border-radius: 4
      font-color: white
    }
  }
}
START: FetchPage(page_id) {
  class: start_end
}
check_table: Page in\nPage Table? {
  class: decision
}
increment_hit: HIT!\nIncrement hit counter {
  class: hit_action
}
move_lru: Move frame to\nLRU head {
  class: hit_action
}
increment_pin: Increment pin_count {
  class: hit_action
}
return_frame_hit: Return frame\n(Cache Hit Path) {
  class: hit_action
}
find_free: Find free frame {
  class: miss_action
}
free_available: Free frame\navailable? {
  class: decision
}
select_victim: Select LRU victim\n(pin_count == 0) {
  class: miss_action
}
check_dirty: Victim\nis dirty? {
  class: decision
}
write_disk: Write page\nto disk {
  class: dirty_action
}
remove_table: Remove from\nPage Table {
  class: miss_action
}
read_disk: Read page\nfrom disk {
  class: disk_action
}
init_frame: Initialize frame\n(pin=1, dirty=false) {
  class: miss_action
}
add_table: Add to Page Table\nand LRU head {
  class: miss_action
}
increment_miss: MISS!\nIncrement miss counter {
  class: miss_action
}
return_frame_miss: Return frame\n(Cache Miss Path) {
  class: miss_action
}
END: Frame returned\nto caller {
  class: start_end
}
# Flow connections
START -> check_table: "1. Lookup"
check_table -> increment_hit: "YES\n(HIT)" {
  style: {
    stroke: "${colors.hit}"
    stroke-width: 3
  }
}
check_table -> increment_miss: "NO\n(MISS)" {
  style: {
    stroke: "${colors.miss}"
    stroke-width: 3
  }
}
# Hit path (green)
increment_hit -> move_lru
move_lru -> increment_pin
increment_pin -> return_frame_hit
# Miss path (red/orange)
increment_miss -> find_free
find_free -> free_available
free_available -> init_frame: "YES" {
  style: {
    stroke: "${colors.miss}"
  }
}
free_available -> select_victim: "NO\n(Eviction)" {
  style: {
    stroke: "${colors.miss}"
  }
}
# Eviction sub-path
select_victim -> check_dirty
check_dirty -> write_disk: "YES\n(Write-Back)" {
  style: {
    stroke: "${colors.dirty}"
    stroke-width: 3
  }
}
check_dirty -> remove_table: "NO\n(Clean)" {
  style: {
    stroke: "${colors.miss}"
  }
}
write_disk -> remove_table
# Continue miss path
remove_table -> read_disk
init_frame -> read_disk
read_disk -> add_table
add_table -> return_frame_miss
# Both paths converge
return_frame_hit -> END {
  style: {
    stroke: "${colors.hit}"
    stroke-width: 3
  }
}
return_frame_miss -> END {
  style: {
    stroke: "${colors.miss}"
    stroke-width: 3
  }
}
# Legend
legend: {
  near: bottom-right
  style.fill: white
  style.stroke: "#333"
  style.stroke-dash: 3
  legend_title: Legend
  hit_path: HIT Path {
    style.fill: "${colors.hit}"
    style.font-color: white
  }
  miss_path: MISS Path {
    style.fill: "${colors.miss}"
    style.font-color: white
  }
  dirty_op: Dirty Write-Back {
    style.fill: "${colors.dirty}"
  }
  disk_op: Disk I/O {
    style.fill: "${colors.disk}"
    style.font-color: white
  }
  legend_title -> hit_path -> miss_path -> dirty_op -> disk_op {
    style.opacity: 0
  }
}
# Timing annotations - integrated into legend
timing_info: {
  near: bottom-left
  style.fill: white
  style.stroke: "#333"
  style.stroke-dash: 3
  timing_hit: |md
    **HIT Path: ~100ns**
    - Hash table lookup: O(1)
    - LRU list update: O(1)
    - Pin increment: O(1)
  | {
    style.fill: "#E8F5E9"
    style.stroke: "${colors.hit}"
  }
  timing_miss: |md
    **MISS Path: ~100,000ns**
    - Disk read dominates
    - Possible write-back adds ~100,000ns
  | {
    style.fill: "#FFEBEE"
    style.stroke: "${colors.miss}"
  }
  timing_hit -> timing_miss {
    style.opacity: 0
  }
}