vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Buffer Pool: Hit vs Miss Paths
  **Critical Performance Difference: ~50ns (hit) vs ~100μs (miss) = 2000x slower**
| {near: top-center}

classes: {
  fast: {
    style: {
      fill: "#ACE1AF"
      stroke: "#167c3c"
      stroke-width: 2
    }
  }
  slow: {
    style: {
      fill: "#FEE2E2"
      stroke: "#DC2626"
      stroke-width: 2
    }
  }
  neutral: {
    style: {
      fill: "#E5E7EB"
      stroke: "#6B7280"
    }
  }
  storage: {
    shape: cylinder
    style: {
      fill: "#DBEAFE"
      stroke: "#2563EB"
    }
  }
  timing: {
    shape: text
    style: {
      font-size: 14
      font-color: "#6B7280"
      italic: true
    }
  }
  decision: {
    shape: diamond
    width: 100
    style: {
      fill: "#FEF3C7"
      stroke: "#D97706"
    }
  }
}

direction: right

HIT_PATH: {
  label: ""
  style.stroke: "#167c3c"
  style.stroke-width: 3
  
  hit_title: |md
    ## ✅ CACHE HIT
  |
  
  hit_timing: "~50-100 nanoseconds" {class: timing}
  
  request1: "FetchPage(42)" {
    class: fast
    style.bold: true
  }
  
  lookup1: "pageTable[42]" {
    label: "Hash Table\nLookup"
    class: fast
  }
  
  found1: "FOUND!" {
    class: decision
    style.fill: "#ACE1AF"
  }
  
  frame1: "Frame #7" {
    class: fast
    style.multiple: true
  }
  
  update_lru: "Update LRU\nTimestamp" {
    class: neutral
  }
  
  pin1: "PinCount++" {
    class: neutral
  }
  
  return1: "Return Page*" {
    class: fast
    style.bold: true
  }
  
  request1 -> lookup1: "1. Check map" {style.stroke: "#167c3c"}
  lookup1 -> found1: "2. Exists" {style.stroke: "#167c3c"}
  found1 -> frame1: "3. Get frame" {style.stroke: "#167c3c"}
  frame1 -> update_lru: "4a. Touch" {style.stroke: "#6B7280"; style.stroke-dash: 3}
  frame1 -> pin1: "4b. Pin" {style.stroke: "#6B7280"; style.stroke-dash: 3}
  update_lru -> return1: "5. Done" {style.stroke: "#167c3c"}
  pin1 -> return1
}

vs: "VS" {
  shape: text
  style: {
    font-size: 32
    font-color: "#9CA3AF"
    bold: true
  }
}

MISS_PATH: {
  label: ""
  style.stroke: "#DC2626"
  style.stroke-width: 3
  
  miss_title: |md
    ## ❌ CACHE MISS
  |
  
  miss_timing: "~25-100 microseconds (SSD)" {class: timing}
  miss_timing_hdd: "~5-10 milliseconds (HDD)" {class: timing}
  
  request2: "FetchPage(99)" {
    class: slow
    style.bold: true
  }
  
  lookup2: "pageTable[99]" {
    label: "Hash Table\nLookup"
    class: slow
  }
  
  notfound: "NOT FOUND" {
    class: decision
    style.fill: "#FEE2E2"
  }
  
  find_victim: "Find LRU Victim" {
    class: slow
    label: "Scan Frames\nfor Eviction\nCandidate"
  }
  
  check_dirty: "Dirty?" {
    class: decision
  }
  
  writeback: "WritePage()\nto Disk" {
    class: slow
    label: "⏱️ WRITEBACK\n~100μs"
  }
  
  evict: "Evict Old\nPage" {
    class: slow
  }
  
  read_disk: "ReadPage()\nfrom Disk" {
    class: storage
    label: "⏱️ DISK READ\n~100μs SSD\n~5-10ms HDD"
  }
  
  update_meta: "Update\nPageTable\n+ Metadata" {
    class: neutral
  }
  
  return2: "Return Page*" {
    class: slow
    style.bold: true
  }
  
  request2 -> lookup2: "1. Check map" {style.stroke: "#DC2626"}
  lookup2 -> notfound: "2. Missing" {style.stroke: "#DC2626"}
  notfound -> find_victim: "3. Scan frames" {style.stroke: "#DC2626"}
  find_victim -> check_dirty: "4. Check victim" {style.stroke: "#DC2626"}
  check_dirty -> writeback: "Yes: flush" {style.stroke: "#DC2626"; label: "dirty"}
  check_dirty -> evict: "No: skip" {style.stroke: "#6B7280"; label: "clean"}
  writeback -> evict
  evict -> read_disk: "5. Load new" {style.stroke: "#DC2626"}
  read_disk -> update_meta: "6. Install" {style.stroke: "#DC2626"}
  update_meta -> return2: "7. Done" {style.stroke: "#DC2626"}
}

HIT_PATH -> vs -> MISS_PATH {style.opacity: 0}

timing_comparison: {
  near: bottom-center
  grid-columns: 3
  grid-gap: 20
  
  hit_box: "HIT:\n~50ns" {
    class: fast
    style.bold: true
  }
  miss_box: "MISS:\n~100μs" {
    class: slow
    style.bold: true
  }
  ratio: "2000x\nDifference" {
    style: {
      fill: "#FEF3C7"
      stroke: "#D97706"
      bold: true
    }
  }
}

explanation: |md
  **Key Insight:** Every cache miss costs as much as **2000+ cache hits**.
  A 99% hit rate means 1 in 100 page requests goes to disk.
  A 90% hit rate means 10x more disk I/O — potentially 10x slower.
| {near: bottom-center}