vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    frame: "#E8F4F8"
    frame_header: "#B8D4E3"
    page_table: "#FFF9E6"
    disk: "#F0F0F0"
    dirty: "#FFE6E6"
    pinned: "#E6F3FF"
    free: "#E8F8E8"
    lru_hot: "#FF6B6B"
    lru_cold: "#4ECDC4"
    arrow_data: "#3498DB"
    arrow_meta: "#9B59B6"
  }
}

title: {
  label: Buffer Pool Architecture
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

direction: right

buffer_pool: {
  label: "Buffer Pool Manager\n(N Frames in Memory)"
  style: {
    fill: ${colors.frame}
    stroke: "#2C3E50"
    stroke-width: 3
    border-radius: 8
  }

  header: {
    label: |md
      **Configuration**
      - Frame Count: N
      - Page Size: 4096 bytes
      - Policy: LRU Eviction
    |
    shape: rectangle
    style: {
      fill: ${colors.frame_header}
      stroke: "#2C3E50"
      border-radius: 4
    }
  }

  frames: {
    label: "Frame Array (Memory)"
    style: {
      fill: ${colors.frame}
      stroke: "#2C3E50"
      stroke-dash: 2
      border-radius: 6
    }

    grid-columns: 4
    grid-gap: 8

    frame_0: {
      label: "Frame 0\n[4096 bytes]"
      style: {
        fill: ${colors.dirty}
        stroke: "#E74C3C"
        stroke-width: 2
      }
    }
    frame_1: {
      label: "Frame 1\n[4096 bytes]"
      style: {
        fill: ${colors.pinned}
        stroke: "#3498DB"
        stroke-width: 2
      }
    }
    frame_2: {
      label: "Frame 2\n[4096 bytes]"
      style: {
        fill: ${colors.free}
        stroke: "#27AE60"
        stroke-width: 2
        stroke-dash: 3
      }
    }
    frame_3: {
      label: "Frame 3\n[4096 bytes]"
      style: {
        fill: ${colors.dirty}
        stroke: "#E74C3C"
        stroke-width: 2
      }
    }
    frame_4: {
      label: "Frame 4\n[4096 bytes]"
      style: {
        fill: ${colors.frame}
        stroke: "#2C3E50"
      }
    }
    frame_5: {
      label: "Frame 5\n[4096 bytes]"
      style: {
        fill: ${colors.pinned}
        stroke: "#3498DB"
        stroke-width: 2
      }
    }
    frame_6: {
      label: "Frame 6\n[4096 bytes]"
      style: {
        fill: ${colors.free}
        stroke: "#27AE60"
        stroke-width: 2
        stroke-dash: 3
      }
    }
    frame_7: {
      label: "Frame N-1\n[4096 bytes]"
      style: {
        fill: ${colors.frame}
        stroke: "#2C3E50"
      }
    }
  }

  metadata: {
    label: "Frame Metadata Array"
    style: {
      fill: ${colors.page_table}
      stroke: "#F39C12"
      border-radius: 6
    }

    meta_0: {
      label: "[0] Page 5\nPin: 0 | Dirty: Y"
      style.fill: ${colors.dirty}
    }
    meta_1: {
      label: "[1] Page 12\nPin: 2 | Dirty: N"
      style.fill: ${colors.pinned}
    }
    meta_2: {
      label: "[2] EMPTY\nPin: 0 | Dirty: N"
      style.fill: ${colors.free}
    }
    meta_3: {
      label: "[3] Page 42\nPin: 0 | Dirty: Y"
      style.fill: ${colors.dirty}
    }
    meta_4: {
      label: "[4] Page 8\nPin: 0 | Dirty: N"
    }
    meta_5: {
      label: "[5] Page 3\nPin: 1 | Dirty: N"
      style.fill: ${colors.pinned}
    }
    meta_6: {
      label: "[6] EMPTY\nPin: 0 | Dirty: N"
      style.fill: ${colors.free}
    }
    meta_7: {
      label: "[N-1] Page 99\nPin: 0 | Dirty: N"
    }
  }
}

page_table: {
  label: "Page Table (Hash Map)\npage_id to frame_index"
  style: {
    fill: ${colors.page_table}
    stroke: "#F39C12"
    stroke-width: 2
    border-radius: 8
  }

  pt_header: {
    label: "O(1) Lookup"
    shape: rectangle
    style: {
      fill: "#F39C12"
      font-color: white
      bold: true
    }
  }

  entries: {
    grid-columns: 2
    grid-gap: 4

    e1: "Page 5 -> Frame 0"
    e2: "Page 12 -> Frame 1"
    e3: "Page 42 -> Frame 3"
    e4: "Page 8 -> Frame 4"
    e5: "Page 3 -> Frame 5"
    e6: "Page 99 -> Frame N-1"
  }
}

lru_list: {
  label: "LRU Eviction List\n(Doubly Linked)"
  style: {
    fill: "#2C3E50"
    stroke: "#1ABC9C"
    stroke-width: 2
    border-radius: 8
    font-color: white
  }

  lru_dir: {
    label: "MRU (Most Recent) to LRU (Least Recent)"
    shape: text
    style.font-color: "#1ABC9C"
  }

  lru_nodes: {
    direction: right

    node_mru: {
      label: "Page 3\n(Frame 5)"
      shape: circle
      style: {
        fill: ${colors.lru_hot}
        stroke: "#C0392B"
        stroke-width: 2
      }
    }
    n1: {
      label: "Page 8\n(Frame 4)"
      shape: circle
      style.fill: "#3498DB"
    }
    n2: {
      label: "Page 5\n(Frame 0)"
      shape: circle
      style.fill: "#3498DB"
    }
    n3: {
      label: "Page 42\n(Frame 3)"
      shape: circle
      style.fill: "#3498DB"
    }
    node_lru: {
      label: "Page 99\n(Frame N-1)"
      shape: circle
      style: {
        fill: ${colors.lru_cold}
        stroke: "#16A085"
        stroke-width: 2
      }
    }

    node_mru -> n1 -> n2 -> n3 -> node_lru
  }

  lru_note: {
    label: "Eviction Candidate: Page 99\nPin count = 0 | Not dirty | Oldest access"
    shape: rectangle
    style: {
      fill: ${colors.lru_cold}
      stroke: "#16A085"
      font-color: "#2C3E50"
    }
  }
}

disk: {
  label: "Disk Storage\n(Database File)"
  style: {
    fill: ${colors.disk}
    stroke: "#7F8C8D"
    stroke-width: 2
    border-radius: 8
  }

  disk_icon: {
    label: "Persistent Storage"
    shape: cylinder
    style: {
      fill: "#BDC3C7"
      stroke: "#7F8C8D"
      stroke-width: 2
      multiple: true
    }
  }

  pages: {
    grid-columns: 5
    grid-gap: 2

    p1: {label: "P1"; style.fill: "#BDC3C7"}
    p2: {label: "P2"; style.fill: "#BDC3C7"}
    p3: {label: "P3"; style.fill: "#3498DB"}
    p4: {label: "P4"; style.fill: "#BDC3C7"}
    p5: {label: "P5"; style.fill: "#E74C3C"}
    p6: {label: "..."; style.fill: transparent}
    p7: {label: "P8"; style.fill: "#3498DB"}
    p8: {label: "..."; style.fill: transparent}
    p9: {label: "P12"; style.fill: "#3498DB"}
    p10: {label: "..."; style.fill: transparent}
  }

  disk_note: {
    label: "Blue = Cached | Red = Dirty | Gray = Not in memory"
    shape: text
    style.font-size: 12
  }
}

free_list: {
  label: "Free Frame List"
  style: {
    fill: ${colors.free}
    stroke: "#27AE60"
    stroke-width: 2
    border-radius: 8
  }

  free_header: "Available for immediate use:"
  free_frames: {
    grid-columns: 2
    f1: "Frame 2"
    f2: "Frame 6"
    f3: "..."
  }
}

dirty_tracker: {
  label: "Dirty Page Tracking"
  style: {
    fill: ${colors.dirty}
    stroke: "#E74C3C"
    stroke-width: 2
    border-radius: 8
  }

  dirty_header: "Pages requiring writeback:"
  dirty_pages: {
    dp1: "Page 5 (Frame 0)"
    dp2: "Page 42 (Frame 3)"
  }

  flush_btn: {
    label: "FlushAll - Write to disk"
    shape: rectangle
    style: {
      fill: "#E74C3C"
      font-color: white
      bold: true
    }
  }
}

operations: {
  label: "Core Operations"
  style: {
    fill: "#ECF0F1"
    stroke: "#2C3E50"
    border-radius: 8
  }

  fetch: {
    label: "FetchPage(page_id)\n1. Check page_table O(1)\n2. If hit: increment pin\n3. If miss: find victim\n4. Read from disk"
    style.fill: "#3498DB"
    style.font-color: white
  }

  unpin: {
    label: "UnpinPage(page_id)\n1. Decrement pin count\n2. Set dirty flag if needed\n3. Add to LRU if pin=0"
    style.fill: "#9B59B6"
    style.font-color: white
  }

  flush: {
    label: "FlushPage(page_id)\n1. Look up frame\n2. If dirty: write to disk\n3. Clear dirty flag"
    style.fill: "#E74C3C"
    style.font-color: white
  }
}

page_table.pt_header -> buffer_pool.frames.frame_0: {
  label: "page_id to frame"
  style: {
    stroke: ${colors.arrow_meta}
    stroke-width: 2
    animated: true
  }
}

lru_list.lru_nodes.node_lru -> buffer_pool.frames.frame_7: {
  label: "Victim selection"
  style: {
    stroke: ${colors.lru_cold}
    stroke-dash: 3
  }
}

disk -> buffer_pool.frames.frame_2: {
  label: "ReadPage(4096 bytes)"
  style: {
    stroke: ${colors.arrow_data}
    stroke-width: 3
    animated: true
  }
}

buffer_pool.frames.frame_0 -> disk: {
  label: "WritePage (on eviction)"
  style: {
    stroke: "#E74C3C"
    stroke-width: 2
    stroke-dash: 5
  }
}

legend: {
  near: bottom-center
  label: "Legend: Red=Dirty | Blue=Pinned | Green=Free | White=Clean"
  shape: text
  style: {
    font-size: 14
    bold: true
  }
}

buffer_pool.header -> buffer_pool.frames
buffer_pool.frames -> buffer_pool.metadata: "Metadata per frame"
page_table -> buffer_pool.metadata: "Maps page_id"
lru_list -> buffer_pool.metadata: "Eviction order"
free_list -> buffer_pool.frames: "Available frames"
dirty_tracker -> buffer_pool.frames: "Needs writeback"
operations -> buffer_pool: "API calls"