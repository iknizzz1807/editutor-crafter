vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Trace Example: SELECT * FROM users WHERE id > 5
  **Step-by-step execution through the entire query pipeline**
| {near: top-center}

direction: right

# ============================================
# LEFT: AST STRUCTURE
# ============================================

ast_container: {
  label: "Abstract Syntax Tree (AST)"
  style.fill: "#E8F4FD"
  style.stroke: "#2196F3"
  style.stroke-width: 2
  
  select_stmt: SelectStatement {
    shape: rectangle
    style.fill: "#BBDEFB"
    style.stroke: "#1976D2"
    
    columns: "Columns[*]" {
      style.fill: "#90CAF9"
    }
    
    from: "FromTable[users]" {
      style.fill: "#90CAF9"
    }
    
    where: WhereClause {
      style.fill: "#FFCDD2"
      style.stroke: "#E53935"
      
      binary: BinaryExpr {
        operator: ">" {
          style.fill: "#FF8A80"
          style.font-color: "#B71C1C"
          style.bold: true
        }
        left_id: "Identifier[id]" {
          style.fill: "#90CAF9"
        }
        right_5: "Literal[5]" {
          style.fill: "#C8E6C9"
        }
      }
    }
  }
  
  columns -> from
  from -> where
}

# ============================================
# MIDDLE: COMPILED BYTECODE
# ============================================

bytecode_container: {
  label: "Compiled Bytecode Program"
  style.fill: "#FFF3E0"
  style.stroke: "#FF9800"
  style.stroke-width: 2
  
  bytecode_table: {
    grid-columns: 5
    grid-gap: 0
    
    header_addr: |md
      **addr**
    | {style.fill: "#FFE0B2"; style.stroke: "#FF9800"}
    
    header_op: |md
      **opcode**
    | {style.fill: "#FFE0B2"; style.stroke: "#FF9800"}
    
    header_p1: |md
      **P1**
    | {style.fill: "#FFE0B2"; style.stroke: "#FF9800"}
    
    header_p2: |md
      **P2**
    | {style.fill: "#FFE0B2"; style.stroke: "#FF9800"}
    
    header_comment: |md
      **comment**
    | {style.fill: "#FFE0B2"; style.stroke: "#FF9800"}
    
    # Row 0
    r0_addr: "0"
    r0_op: "OpenTable"
    r0_p1: "0"
    r0_p2: "2"
    r0_comment: "Open cursor on users"
    
    # Row 1
    r1_addr: "1"
    r1_op: "Rewind"
    r1_p1: "0"
    r1_p2: "10"
    r1_comment: "Position before first; jump to 10 if empty"
    
    # Row 2
    r2_addr: "2"
    r2_op: "Column"
    r2_p1: "0"
    r2_p2: "0"
    r2_comment: "Read id into r0"
    
    # Row 3
    r3_addr: "3"
    r3_op: "Integer"
    r3_p1: "5"
    r3_p2: "1"
    r3_comment: "Load 5 into r1"
    
    # Row 4 - THE CONDITIONAL JUMP
    r4_addr: "4" {style.fill: "#FFCDD2"}
    r4_op: "Le" {style.fill: "#FFCDD2"}
    r4_p1: "0" {style.fill: "#FFCDD2"}
    r4_p2: "8" {style.fill: "#FFCDD2"}
    r4_comment: "if r0<=r1, skip to Next" {style.fill: "#FFCDD2"}
    
    # Row 5
    r5_addr: "5"
    r5_op: "Column"
    r5_p1: "0"
    r5_p2: "0"
    r5_comment: "Read id into r2"
    
    # Row 6
    r6_addr: "6"
    r6_op: "Column"
    r6_p1: "0"
    r6_p2: "1"
    r6_comment: "Read name into r3"
    
    # Row 7
    r7_addr: "7"
    r7_op: "ResultRow"
    r7_p1: "2"
    r7_p2: "2"
    r7_comment: "Output r2, r3"
    
    # Row 8
    r8_addr: "8"
    r8_op: "Next"
    r8_p1: "0"
    r8_p2: "2"
    r8_comment: "Advance cursor; loop to 2"
    
    # Row 9
    r9_addr: "9"
    r9_op: "Halt"
    r9_p1: "0"
    r9_p2: "0"
    r9_comment: "End execution"
  }
  
  legend: |md
    **Key Instruction:**
    `Le 0 8` - If id <= 5, jump to address 8 (Next)
    This **skips ResultRow** for non-matching rows
  |
}

# ============================================
# RIGHT: EXECUTION TRACE
# ============================================

trace_container: {
  label: "Execution Trace (3 rows: id=3, 7, 2)"
  style.fill: "#E8F5E9"
  style.stroke: "#4CAF50"
  style.stroke-width: 2
  
  # Execution steps
  step1: {
    label: "Step 1: Open & Rewind"
    style.fill: "#C8E6C9"
    
    pc0: "PC=0: OpenTable cursor 0 on page 2"
    pc1: "PC=1: Rewind → cursor positioned before row 1"
    
    state1: |md
      **State:**
      - PC: 2
      - Cursor: before first row
      - Registers: [empty]
    |
  }
  
  step2: {
    label: "Step 2: Process Row 1 (id=3)"
    style.fill: "#FFCDD2"
    style.stroke: "#E53935"
    
    pc2a: "PC=2: Column → r0 = 3"
    pc3a: "PC=3: Integer → r1 = 5"
    pc4a: "PC=4: Le(3, 5) → TRUE, JUMP TO 8!"
    
    state2: |md
      **State:**
      - PC: 8 (jumped!)
      - r0: 3
      - r1: 5
      - **SKIPPED ResultRow**
    |
  }
  
  step3: {
    label: "Step 3: Process Row 2 (id=7)"
    style.fill: "#C8E6C9"
    style.stroke: "#2E7D32"
    
    pc8a: "PC=8: Next → cursor at row 2"
    pc2b: "PC=2: Column → r0 = 7"
    pc3b: "PC=3: Integer → r1 = 5"
    pc4b: "PC=4: Le(7, 5) → FALSE, continue"
    pc5b: "PC=5: Column → r2 = 7"
    pc6b: "PC=6: Column → r3 = 'Bob'"
    pc7b: "PC=7: ResultRow → OUTPUT (7, 'Bob')"
    
    state3: |md
      **State:**
      - PC: 8
      - r0: 7, r1: 5
      - r2: 7, r3: 'Bob'
      - **OUTPUT EMITTED ✓**
    |
  }
  
  step4: {
    label: "Step 4: Process Row 3 (id=2)"
    style.fill: "#FFCDD2"
    style.stroke: "#E53935"
    
    pc8c: "PC=8: Next → cursor at row 3"
    pc2c: "PC=2: Column → r0 = 2"
    pc3c: "PC=3: Integer → r1 = 5"
    pc4c: "PC=4: Le(2, 5) → TRUE, JUMP TO 8!"
    
    state4: |md
      **State:**
      - PC: 8 (jumped!)
      - r0: 2, r1: 5
      - **SKIPPED ResultRow**
    |
  }
  
  step5: {
    label: "Step 5: End"
    style.fill: "#E1BEE7"
    
    pc8d: "PC=8: Next → no more rows"
    pc9: "PC=9: Halt → execution complete"
    
    state5: |md
      **Final Result:**
      
      (7, 'Bob')
      
      1 row returned
    |
  }
  
  step1 -> step2 -> step3 -> step4 -> step5
}

# ============================================
# FLOW ARROWS
# ============================================

ast_container -> bytecode_container: "Compiler\ntraverses AST" {
  style.stroke: "#1976D2"
  style.stroke-width: 2
  style.animated: true
}

bytecode_container -> trace_container: "VM executes\nopcodes" {
  style.stroke: "#4CAF50"
  style.stroke-width: 2
  style.animated: true
}

# ============================================
# REGISTER STATE DETAIL
# ============================================

register_detail: {
  label: "Register State During Row 2 (id=7)"
  style.fill: "#F3E5F5"
  style.stroke: "#9C27B0"
  style.stroke-width: 2
  
  grid-columns: 4
  grid-gap: 0
  
  reg_header: |md
    **Register**
  | {style.fill: "#E1BEE7"}
  
  val_header: |md
    **Value**
  | {style.fill: "#E1BEE7"}
  
  type_header: |md
    **Type**
  | {style.fill: "#E1BEE7"}
  
  note_header: |md
    **Note**
  | {style.fill: "#E1BEE7"}
  
  r0_row: "r0"
  r0_val: "7"
  r0_type: "INTEGER"
  r0_note: "Column id value"
  
  r1_row: "r1"
  r1_val: "5"
  r1_type: "INTEGER"
  r1_note: "Comparison constant"
  
  r2_row: "r2"
  r2_val: "7"
  r2_type: "INTEGER"
  r2_note: "Output column 1"
  
  r3_row: "r3"
  r3_val: "'Bob'"
  r3_type: "TEXT"
  r3_note: "Output column 2"
}

# ============================================
# CONDITIONAL JUMP HIGHLIGHT
# ============================================

jump_highlight: {
  label: "Conditional Jump Logic"
  style.fill: "#FFF8E1"
  style.stroke: "#FFC107"
  style.stroke-width: 2
  
  explanation: |md
    Address 4: Le r0 r1  →  Jump to 8 if r0 <= r1
    
    Row 1 (id=3): 3 <= 5 → TRUE  → JUMP (skip output)
    Row 2 (id=7): 7 <= 5 → FALSE → Continue to output
    Row 3 (id=2): 2 <= 5 → TRUE  → JUMP (skip output)
    
    
    **The conditional jump is the WHERE clause in action!**
    Each row's id is tested; only rows passing the test
    reach the ResultRow instruction.
  |
}

trace_container -> register_detail {
  style.stroke: "#9C27B0"
  style.stroke-dash: 3
}

register_detail -> jump_highlight {
  style.stroke: "#FFC107"
  style.stroke-dash: 3
}