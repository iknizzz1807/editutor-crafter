vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    hot: "#DC3545"
    success: "#28A745"
    data: "#007BFF"
    meta: "#6C757D"
    code: "#343A40"
  }
}
title: |md
  # WHERE Clause Bytecode Pattern
  **Query:** `SELECT * FROM t WHERE col > 5`
| {near: top-center}
direction: right
bytecode_flow: {
  style.fill: transparent
  loop_start: {
    shape: circle
    style.fill: ${colors.success}
    width: 40
    label: ""
  }
  step1: {
    shape: rectangle
    style: {
      fill: "#CCE5FF"
      stroke: ${colors.data}
      stroke-width: 2
      border-radius: 4
    }
    label: |md
      **Column** `cursor=0 col=col r1`
      *Read column value into r1*
    |
  }
  step2: {
    shape: rectangle
    style: {
      fill: "#E2E3E5"
      stroke: ${colors.meta}
      stroke-width: 2
      border-radius: 4
    }
    label: |md
      **Integer** `5 → r2`
      *Load comparison constant*
    |
  }
  step3: {
    shape: diamond
    style: {
      fill: "#F8D7DA"
      stroke: ${colors.hot}
      stroke-width: 2
    }
    label: |md
      **Le** `r1 ≤ r2 ?`
      *Inverted comparison*
    |
  }
  skip_path: {
    shape: rectangle
    style: {
      fill: "#F8D7DA"
      stroke: ${colors.hot}
      stroke-dash: 3
      border-radius: 4
    }
    label: |md
      **Goto** `NEXT_ROW`
      *Condition FALSE → skip*
    |
  }
  output_path: {
    shape: rectangle
    style: {
      fill: "#D4EDDA"
      stroke: ${colors.success}
      stroke-width: 2
      border-radius: 4
    }
    label: |md
      **ResultRow** `r_start, count`
      *Condition TRUE → output*
    |
  }
  next_row: {
    shape: rectangle
    style: {
      fill: "#E2E3E5"
      stroke: ${colors.meta}
      stroke-width: 2
      border-radius: 4
    }
    label: |md
      **Next** `cursor=0`
      *Advance cursor, loop*
    |
  }
  loop_start -> step1: "1. Enter loop" {style.stroke-width: 2}
  step1 -> step2: "2. Column loaded" {style.stroke: ${colors.data}}
  step2 -> step3: "3. Compare" {style.stroke: ${colors.meta}}
  step3 -> skip_path: "TRUE\n(col ≤ 5)" {
    style: {
      stroke: ${colors.hot}
      stroke-width: 2
      animated: true
    }
  }
  step3 -> output_path: "FALSE\n(col > 5)" {
    style: {
      stroke: ${colors.success}
      stroke-width: 2
    }
  }
  skip_path -> next_row
  output_path -> next_row
  next_row -> loop_start: "Loop back\nif more rows" {
    style: {
      stroke-dash: 5
      stroke: ${colors.meta}
    }
  }
}
bytecode_listing: {
  near: center-right
  style: {
    fill: ${colors.code}
    stroke: ${colors.code}
    border-radius: 8
  }
  label: |md
    addr  opcode      p1    p2    p3
    ────  ──────────  ────  ────  ────
    0     Rewind      0     8           → if empty, goto 8
    1     Column      0     0     1     → r1 = col value
    2     Integer     5     2           → r2 = 5
    3     Le          1     2     7     → if r1 ≤ r2, goto 7
    4     Column      0     0     3     → output col
    5     Column      0     1     4     → output col2
    6     ResultRow   3     2           → emit row
    7     Next        0     1           → next row, goto 1
    8     Halt
  |
}
legend: {
  near: bottom-center
  style.fill: transparent
  label: |md
    ### Key Insight: Inverted Comparison
    - WHERE says `col > 5` (keep if greater)
    - Bytecode checks `col ≤ 5` (skip if NOT greater)
    - Jump to `Next` on TRUE → row filtered out
    - Fall through on FALSE → row kept
  |
}
trace_example: {
  near: bottom-right
  direction: down
  style.fill: transparent
  header: {
    label: |md
      ## Trace: Row-by-Row Execution
    |
  }
  row1: {
    shape: rectangle
    style: {
      fill: "#D4EDDA"
      stroke: ${colors.success}
      border-radius: 4
    }
    label: |md
      **Row 1: col = 10**
      - Column: r1 = 10
      - Integer: r2 = 5
      - Le: 10 ≤ 5? → FALSE → fall through
      - ResultRow: ✓ OUTPUT
    |
  }
  row2: {
    shape: rectangle
    style: {
      fill: "#F8D7DA"
      stroke: ${colors.hot}
      border-radius: 4
    }
    label: |md
      **Row 2: col = 3**
      - Column: r1 = 3
      - Integer: r2 = 5
      - Le: 3 ≤ 5? → TRUE → goto Next
      - SKIPPED
    |
  }
  row3: {
    shape: rectangle
    style: {
      fill: "#D4EDDA"
      stroke: ${colors.success}
      border-radius: 4
    }
    label: |md
      **Row 3: col = 7**
      - Column: r1 = 7
      - Integer: r2 = 5
      - Le: 7 ≤ 5? → FALSE → fall through
      - ResultRow: ✓ OUTPUT
    |
  }
  null_row: {
    shape: rectangle
    style: {
      fill: "#E2E3E5"
      stroke: ${colors.meta}
      border-radius: 4
    }
    label: |md
      **Row 4: col = NULL**
      - Column: r1 = NULL
      - Integer: r2 = 5
      - Le: NULL ≤ 5? → NULL (treated as FALSE*)
      - *NULL comparisons don't trigger jump
      - But also don't pass WHERE → SKIPPED
    |
  }
}