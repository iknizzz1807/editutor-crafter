vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# THE CHECKSUM GUARD: BIT-ROT DETECTION PIPELINE
# Milestone 10: The Siege (Fault Tolerance)

classes: {
  memory_block: {
    style: {
      stroke: "#4a4e69"
      fill: "#22223b"
      font-size: 14
      stroke-width: 1
    }
  }
  corrupted: {
    style: {
      fill: "#9a031e"
      stroke: "#fb8500"
      bold: true
      animated: true
    }
  }
  valid: {
    style: {
      fill: "#06d6a0"
      stroke: "#000000"
    }
  }
  microscope: {
    style: {
      stroke-dash: 5
      stroke: "#ffb703"
      border-radius: 10
    }
  }
}

pager_sentinel: "Milestone 10: The Pager Sentinel" {
  link: "#milestone-10"
  
  # 1. PHYSICAL DISK PAGE (4KB)
  warehouse_page: "Disk Page 0x1A4F (4096 Bytes)" {
    shape: sql_table
    header: "Page Header (Metadata)" {constraint: "8 Bytes"}
    p1: "Data Payload [0..1023]"
    p2: "Data Payload [1024..2047]"
    corrupt_byte: "Byte 2048: 0x51 (01010001)" {class: corrupted}
    p3: "Data Payload [2049..4087]"
    checksum_field: "Stored Checksum: 0xDEADBEEF" {constraint: "4 Bytes"}
  }

  # 2. THE MICROSCOPE VIEW: BIT ROT EVENT
  microscope: "Microscope: Atomic Interference" {
    class: microscope
    before: "Initial State" {
      bits: "01010001 (0x51)"
      style.fill: "#1b4332"
    }
    event: "Cosmic Ray / Bit Flip" {
      shape: step
      style.stroke: red
    }
    after: "Corrupted State" {
      bits: "01010011 (0x53)"
      class: corrupted
    }
    before -> event -> after
  }

  # 3. VERIFICATION LOGIC (STATE TRANSITION)
  verification_engine: "Checksum Verification Cycle" {
    read_op: "1. Read Page from Disk" {
      link: "#milestone-4"
    }
    
    algo: "2. CRC32 Algorithm" {
      shape: diamond
      tooltip: "Polynomial: 0x04C11DB7"
    }

    comparator: "3. Identity Match?" {
      shape: diamond
    }

    result_ok: "PASS: Load to Cache" {
      class: valid
      link: "#milestone-4"
    }

    result_fail: "FAIL: Corrupt Page Error" {
      class: corrupted
      tooltip: "Panic: Database Image is Malformed"
    }

    read_op -> algo: "Stream Bytes 0-4091"
    algo -> comparator: "Calculated: 0xBAADF00D"
    warehouse_page.checksum_field -> comparator: "Stored: 0xDEADBEEF"
    
    comparator -> result_ok: "Match"
    comparator -> result_fail: "Mismatch!"
  }
}

# INTER-COMPONENT LINKS
pager_sentinel.warehouse_page.corrupt_byte -> pager_sentinel.microscope.event: "Trigger"
pager_sentinel.warehouse_page -> pager_sentinel.verification_engine.read_op: "I/O Request"

# LEGEND & CONTEXT
legend: {
  near: bottom-right
  note: |md
    ### The Math of Detection
    In a 4KB page, the probability of an 
    undetected bit flip using CRC32 is 
    approximately **1 in 4.3 billion**.
  |
}

satellite_nav: {
  near: top-left
  link: "#satellite-map"
  label: "â†‘ Return to System Map"
}