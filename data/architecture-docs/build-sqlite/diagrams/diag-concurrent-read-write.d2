vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # WAL Mode: Concurrent Readers and Writer
  ## Timeline showing simultaneous read/write access
| {near: top-center}
direction: right
classes: {
  writer: {
    style: {
      fill: "#FFE4E1"
      stroke: "#DC143C"
      stroke-width: 2
      font: mono
    }
  }
  reader: {
    style: {
      fill: "#E0FFE0"
      stroke: "#228B22"
      stroke-width: 2
      font: mono
    }
  }
  wal_frame: {
    shape: rectangle
    style: {
      fill: "#FFE4B5"
      stroke: "#FF8C00"
      stroke-width: 2
    }
  }
  db_page: {
    shape: cylinder
    style: {
      fill: "#E6E6FA"
      stroke: "#4B0082"
    }
  }
  snapshot: {
    shape: diamond
    style: {
      fill: "#87CEEB"
      stroke: "#4682B4"
    }
  }
  timeline: {
    style: {
      stroke: "#333333"
      stroke-width: 3
    }
  }
}
TIME_AXIS: {
  shape: rectangle
  style.fill: transparent
  style.stroke: transparent
  T0: T=0 {shape: text}
  T1: T=1 {shape: text}
  T2: T=2 {shape: text}
  T3: T=3 {shape: text}
  T4: T=4 {shape: text}
  T0 -> T1 -> T2 -> T3 -> T4: "time →" {
    class: timeline
    style.stroke-dash: 0
  }
}
WRITER_PROCESS: Writer Thread {
  class: writer
  W1: "Write\nFrame 1\n(page 42)" {
    class: wal_frame
    link: "#frame1"
  }
  W2: "Write\nFrame 2\n(page 17)" {
    class: wal_frame
    link: "#frame2"
  }
  W3: "COMMIT\nmarker" {
    class: wal_frame
    style.fill: "#90EE90"
    link: "#commit"
  }
  W4: "Write\nFrame 3\n(page 55)" {
    class: wal_frame
    link: "#frame3"
  }
  W1 -> W2 -> W3 -> W4: "append →" {
    style: {
      stroke: "#DC143C"
      animated: true
      stroke-width: 2
    }
  }
}
WRITER_NOTE: |md
  Writer appends frames
  to WAL file sequentially.
  Never blocks on readers!
| {near: bottom-left}
READER_1: Reader A (T=0 snapshot) {
  class: reader
  R1_snap: "Snapshot\nmax_frame=0" {
    class: snapshot
    link: "#snap1"
  }
  R1_q1: "Query\npages 42,17" {
    shape: rectangle
    style.fill: "#98FB98"
  }
  R1_result: "Sees:\nDB only\n(no WAL)" {
    shape: rectangle
    style.fill: "#DDA0DD"
  }
  R1_snap -> R1_q1 -> R1_result: "read →" {
    style.stroke: "#228B22"
  }
}
READER_2: Reader B (T=2 snapshot) {
  class: reader
  R2_snap: "Snapshot\nmax_frame=2" {
    class: snapshot
    link: "#snap2"
  }
  R2_q1: "Query\npage 42" {
    shape: rectangle
    style.fill: "#98FB98"
  }
  R2_result: "Sees:\nWAL Frame 1\n(committed)" {
    shape: rectangle
    style.fill: "#DDA0DD"
  }
  R2_snap -> R2_q1 -> R2_result: "read →" {
    style.stroke: "#228B22"
  }
}
READER_3: Reader C (T=3 snapshot) {
  class: reader
  R3_snap: "Snapshot\nmax_frame=3" {
    class: snapshot
    link: "#snap3"
  }
  R3_q1: "Query\npages 17,55" {
    shape: rectangle
    style.fill: "#98FB98"
  }
  R3_result: "Sees:\nFrame 2 (17) ✓\nFrame 4 (55) ✗\n(uncommitted)" {
    shape: rectangle
    style.fill: "#DDA0DD"
  }
  R3_snap -> R3_q1 -> R3_result: "read →" {
    style.stroke: "#228B22"
  }
}
WAL_FILE: WAL File (append-only) {
  style: {
    fill: "#FFF8DC"
    stroke: "#8B4513"
    stroke-width: 2
  }
  header: Header {
    shape: rectangle
    style.fill: "#DEB887"
  }
  frame1: Frame 1: page=42 {
    class: wal_frame
  }
  frame2: Frame 2: page=17 {
    class: wal_frame
  }
  commit: Frame 3: COMMIT {
    class: wal_frame
    style.fill: "#90EE90"
    label: "COMMIT\n(commit_size=100)"
  }
  frame3: Frame 4: page=55 {
    class: wal_frame
    style.fill: "#FFB6C1"
    label: "UNCOMMITTED\n(no commit marker)"
  }
  header -> frame1 -> frame2 -> commit -> frame3: "offset →" {
    style.stroke: "#8B4513"
    style.stroke-dash: 3
  }
}
DB_FILE: Main Database {
  class: db_page
  p42_old: "Page 42\n(old)" {
    shape: cylinder
    style.fill: "#D3D3D3"
  }
  p17_old: "Page 17\n(old)" {
    shape: cylinder
    style.fill: "#D3D3D3"
  }
  p55_old: "Page 55\n(old)" {
    shape: cylinder
    style.fill: "#D3D3D3"
  }
}
DB_NOTE: |md
  Database file unchanged
  during transaction.
  Only updated at checkpoint.
| {near: bottom-right}
CONCURRENCY_DIAGRAM: Concurrency View {
  style.fill: transparent
  style.stroke: "#333333"
  grid-columns: 5
  time_label: "Time →" {shape: text}
  t0: "T0" {shape: text}
  t1: "T1" {shape: text}
  t2: "T2" {shape: text}
  t3: "T3" {shape: text}
  writer_row: "Writer:" {shape: text}
  w_t0: "WRITE" {
    class: writer
    style.fill: "#DC143C"
    style.font-color: white
  }
  w_t1: "WRITE" {
    class: writer
    style.fill: "#DC143C"
    style.font-color: white
  }
  w_t2: "COMMIT" {
    class: writer
    style.fill: "#228B22"
    style.font-color: white
  }
  w_t3: "WRITE" {
    class: writer
    style.fill: "#DC143C"
    style.font-color: white
  }
  reader_a_row: "Reader A:" {shape: text}
  ra_t0: "START" {
    class: reader
  }
  ra_t1: "READ" {
    class: reader
  }
  ra_t2: "READ" {
    class: reader
  }
  ra_t3: "DONE" {
    class: reader
    style.fill: "#90EE90"
  }
  reader_b_row: "Reader B:" {shape: text}
  rb_t0: "WAIT" {
    shape: rectangle
    style.fill: "#D3D3D3"
  }
  rb_t1: "WAIT" {
    shape: rectangle
    style.fill: "#D3D3D3"
  }
  rb_t2: "START" {
    class: reader
  }
  rb_t3: "READ" {
    class: reader
  }
  reader_c_row: "Reader C:" {shape: text}
  rc_t0: "WAIT" {
    shape: rectangle
    style.fill: "#D3D3D3"
  }
  rc_t1: "WAIT" {
    shape: rectangle
    style.fill: "#D3D3D3"
  }
  rc_t2: "WAIT" {
    shape: rectangle
    style.fill: "#D3D3D3"
  }
  rc_t3: "START" {
    class: reader
  }
}
KEY_INSIGHT: |md
  ## Key Insight: Snapshot Isolation
  Each reader captures `max_frame` at transaction start:
  - **Reader A** (max=0): Sees only database, ignores all WAL frames
  - **Reader B** (max=2): Sees frames 1-2 (committed at frame 3)
  - **Reader C** (max=3): Sees frames 1-3, but frame 4 is uncommitted
  **No blocking!** Writers append while readers query.
| {near: bottom-center}
COMPARISON: Rollback Journal vs WAL {
  direction: right
  rollback: Rollback Journal {
    style.fill: "#FFE4E1"
    r_blocked: Readers BLOCKED {
      style.fill: "#FF6347"
      style.font-color: white
    }
    during_write: during write {
      style.fill: transparent
    }
  }
  wal: WAL Mode {
    style.fill: "#E0FFE0"
    w_concurrent: Readers ACTIVE {
      style.fill: "#32CD32"
      style.font-color: white
    }
    during_write: during write {
      style.fill: transparent
    }
  }
  rollback -> wal: "10x-100x\nthroughput" {
    style: {
      stroke: "#4169E1"
      stroke-width: 3
      animated: true
    }
  }
}
LEGEND: {
  near: bottom-right
  wal_legend: WAL Frame {
    class: wal_frame
  }
  commit_legend: Commit Marker {
    class: wal_frame
    style.fill: "#90EE90"
  }
  uncommitted_legend: Uncommitted {
    class: wal_frame
    style.fill: "#FFB6C1"
  }
  snapshot_legend: Reader Snapshot {
    class: snapshot
  }
}