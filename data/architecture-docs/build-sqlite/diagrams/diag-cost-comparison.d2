vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#1a365d"
    scan_bg: "#ebf8ff"
    index_bg: "#f0fff4"
    formula: "#2d3748"
    crossover: "#c53030"
    highlight: "#ed8936"
  }
}
title: |md
  # Cost Model: Table Scan vs Index Scan
  ## Query Planner Decision Framework
| {near: top-center}
direction: right
# ========== TABLE SCAN SECTION ==========
table_scan: {
  label: "TABLE SCAN\n(Full Scan)"
  style.fill: "${colors.scan_bg}"
  style.stroke: "#3182ce"
  style.stroke-width: 2
  header: {
    shape: rectangle
    label: |md
      ### Sequential I/O
      Read all pages
    |
    style.fill: "${colors.header}"
    style.font-color: white
    style.stroke-width: 0
  }
  cost_formula: {
    shape: rectangle
    label: |md
      **Cost Formula:**
      Cost = pages × SEQ_IO_COST
           = pages × 1.0 (baseline)
    |
    style.fill: white
    style.stroke: "#a0aec0"
  }
  visual: {
    label: "Pages Read"
    style.fill: white
    p1: {label: "P1"; shape: square; style.fill: "#bee3f8"}
    p2: {label: "P2"; shape: square; style.fill: "#bee3f8"}
    p3: {label: "P3"; shape: square; style.fill: "#bee3f8"}
    p4: {label: "P4"; shape: square; style.fill: "#bee3f8"}
    p5: {label: "..."; shape: square; style.fill: "#e2e8f0"}
    p6: {label: "PN"; shape: square; style.fill: "#bee3f8"}
    p1 -> p2 -> p3 -> p4 -> p5 -> p6: {
      style.stroke: "#3182ce"
      style.animated: true
    }
  }
  result: {
    shape: rectangle
    label: |md
      **Example:** 10,000 pages
      Cost = 10,000 × 1.0 = 10,000
    |
    style.fill: "#fed7d7"
    style.font-color: "${colors.crossover}"
  }
  header -> cost_formula -> visual -> result: {style.stroke-width: 0}
}
# ========== INDEX SCAN SECTION ==========
index_scan: {
  label: "INDEX SCAN\n(Double Lookup)"
  style.fill: "${colors.index_bg}"
  style.stroke: "#38a169"
  style.stroke-width: 2
  header: {
    shape: rectangle
    label: |md
      ### Random + Sequential I/O
      Index traversal + row lookups
    |
    style.fill: "${colors.header}"
    style.font-color: white
    style.stroke-width: 0
  }
  cost_formula: {
    shape: rectangle
    label: |md
      **Cost Formula:**
      Cost = index_height × SEQ_IO_COST
           + matching_rows × RANDOM_IO_COST
           + leaf_pages × SEQ_IO_COST
    |
    style.fill: white
    style.stroke: "#a0aec0"
  }
  components: {
    label: "Cost Components"
    style.fill: white
    index_tree: {
      label: "Index Traversal"
      style.fill: "#c6f6d5"
      root: {label: "Root"; shape: diamond; style.fill: "#68d391"}
      l1: {label: "L1"; shape: diamond; style.fill: "#9ae6b4"}
      l2: {label: "L2"; shape: diamond; style.fill: "#9ae6b4"}
      leaf: {label: "Leaf"; shape: rectangle; style.fill: "#48bb78"; style.font-color: white}
      root -> l1 -> l2 -> leaf: {style.stroke: "#38a169"}
    }
    plus1: {
      shape: text
      label: "+"
    }
    lookups: {
      label: "Table Lookups\n(Random I/O)"
      style.fill: "#feebc8"
      r1: {label: "R1"; shape: circle; style.fill: "${colors.highlight}"}
      r2: {label: "R2"; shape: circle; style.fill: "${colors.highlight}"}
      r3: {label: "R3"; shape: circle; style.fill: "${colors.highlight}"}
      r1 -> r2 -> r3: {style.stroke: "${colors.highlight}"; style.stroke-dash: 3}
    }
  }
  result: {
    shape: rectangle
    label: |md
      **Example:** 0.1% selectivity, 10,000 pages
      Matching rows = 10,000,000 × 0.001 = 10,000
      Cost = 3 × 1.0           (index height)
           + 10,000 × 4.0      (row lookups)
           + 10 × 1.0          (leaf pages)
           = 40,013
    |
    style.fill: "#c6f6d5"
  }
  header -> cost_formula -> components -> result: {style.stroke-width: 0}
}
# ========== COMPARISON ARROW ==========
table_scan -> index_scan: "Compare\nCosts" {
  style.stroke: "#718096"
  style.stroke-width: 2
  style.stroke-dash: 5
}
# ========== CROSSOVER POINT ==========
crossover_section: {
  style.fill: "#fff5f5"
  style.stroke: "${colors.crossover}"
  style.stroke-width: 2
  crossover_title: {
    shape: rectangle
    label: |md
      ## The Crossover Point
      When does index scan become cheaper?
    |
    style.fill: "${colors.crossover}"
    style.font-color: white
    style.stroke-width: 0
  }
  crossover_formula: {
    shape: rectangle
    label: |md
      **Find selectivity where costs are equal:**
      Table_Scan_Cost = Index_Scan_Cost
      pages × SEQ_IO = height × SEQ_IO + selectivity × rows × RANDOM_IO
      Solving for selectivity:
      selectivity = (pages - height) / (rows × RANDOM_IO_RATIO)
      With RANDOM_IO_COST = 4× SEQ_IO_COST:
      selectivity ≈ pages / (rows × 4)
      selectivity ≈ 1 / (4 × rows_per_page)
    |
    style.fill: white
    style.stroke: "${colors.crossover}"
  }
  crossover_visual: {
    grid-columns: 3
    grid-gap: 20
    style.fill: white
    low_sel: {
      label: "Low Selectivity\n(< 1%)"
      style.fill: "#c6f6d5"
      style.stroke: "#38a169"
      indicator: {
        shape: text
        label: "USE INDEX"
      }
    }
    crossover: {
      label: "Crossover\n(~6-10%)"
      style.fill: "${colors.highlight}"
      style.stroke: "${colors.crossover}"
      style.stroke-width: 3
      indicator: {
        shape: text
        label: "MARGINAL"
      }
    }
    high_sel: {
      label: "High Selectivity\n(> 20%)"
      style.fill: "#bee3f8"
      style.stroke: "#3182ce"
      indicator: {
        shape: text
        label: "USE TABLE SCAN"
      }
    }
  }
  crossover_summary: {
    shape: rectangle
    label: ||md
      ### Decision Rule (SSD, 4KB pages, ~100 rows/page)
      | Selectivity | Rows Matching | Better Choice |
      |-------------|---------------|---------------|
      | 0.01% (1 in 10K) | 100 of 1M | **Index Scan** |
      | 1% (1 in 100) | 10K of 1M | **Index Scan** |
      | 6% (crossover) | 60K of 1M | **Either** |
      | 10% | 100K of 1M | **Table Scan** |
      | 50% | 500K of 1M | **Table Scan** |
      > **Key Insight:** Sequential I/O (table scan) becomes faster than random I/O (index lookups) when matching rows exceed ~6-10% of total rows.
    ||
    style.fill: white
    style.stroke: "#a0aec0"
  }
  crossover_title -> crossover_formula -> crossover_visual -> crossover_summary: {style.stroke-width: 0}
}
# ========== KEY FACTORS ==========
factors: {
  label: "Factors Affecting Crossover"
  style.fill: "#faf5ff"
  style.stroke: "#805ad5"
  factor_list: {
    shape: rectangle
    label: ||md
      ### Cost Constants (Hardware Dependent)
      | Storage | SEQ_IO | RANDOM_IO | Ratio |
      |---------|--------|-----------|-------|
      | **NVMe SSD** | 0.025ms | 0.1ms | 4:1 |
      | **SATA SSD** | 0.05ms | 0.2ms | 4:1 |
      | **HDD** | 0.5ms | 10ms | **20:1** |
      ### Impact on Crossover
      - **SSD**: Crossover at ~6-10% selectivity
      - **HDD**: Crossover at ~1-2% selectivity (random I/O very expensive)
      ### Additional Factors
      1. **Rows per page**: More rows = lower crossover point
      2. **Index covering**: If all columns in index, no table lookup needed
      3. **Cache hit rate**: Cached pages reduce effective cost
      4. **Prefetching**: Sequential scans benefit from read-ahead
    ||
    style.fill: white
    style.stroke: "#805ad5"
  }
}
# ========== CONNECTIONS ==========
table_scan -> crossover_section: "feeds into" {style.stroke: "#a0aec0"; style.stroke-dash: 3}
index_scan -> crossover_section: "feeds into" {style.stroke: "#a0aec0"; style.stroke-dash: 3}
crossover_section -> factors: "depends on" {style.stroke: "#805ad5"; style.stroke-dash: 3}