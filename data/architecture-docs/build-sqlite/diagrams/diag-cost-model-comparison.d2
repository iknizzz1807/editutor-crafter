vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: Cost Model: Table Scan vs Index Scan {
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

# Left side: Table Scan
table_scan: {
  label: TABLE SCAN
  style: {
    fill: "#E8F5E9"
    stroke: "#2E7D32"
    stroke-width: 2
  }
  
  formula: |md
    **Cost Formula:**
    
    `Cost = Total_Pages × Page_Read_Cost`
    
    • Sequential I/O (fast)
    • Reads ALL pages
    • No index overhead
  | {
    shape: rectangle
    style: {
      fill: white
      stroke: "#2E7D32"
    }
  }
  
  calc_example: {
    label: |md
      **Example: 10,000 rows, 500 pages**
      
      Cost = 500 × 1.0 = **500**
    |
    shape: rectangle
    style: {
      fill: "#C8E6C9"
      stroke: "#2E7D32"
    }
  }
  
  pages: {
    label: "Pages\n(Sequential Read)"
    shape: rectangle
    style: {
      fill: white
      stroke: "#2E7D32"
      stroke-dash: 3
      multiple: true
    }
  }
  
  arrow_label: "Read all\n500 pages"
  formula -> calc_example
  calc_example -> pages: {
    style: {
      stroke: "#2E7D32"
      stroke-width: 2
    }
  }
}

# Right side: Index Scan
index_scan: {
  label: INDEX SCAN
  style: {
    fill: "#E3F2FD"
    stroke: "#1565C0"
    stroke-width: 2
  }
  
  formula: |md
    **Cost Formula:**
    
    `Cost = Index_Traverse + (Selectivity × Rows × Random_IO)`
    
    • Random I/O per matching row
    • Depends on selectivity
    • Double lookup (index + table)
  | {
    shape: rectangle
    style: {
      fill: white
      stroke: "#1565C0"
    }
  }
  
  calc_example: {
    label: |md
      **Example: 10,000 rows, 10% selectivity**
      
      Cost = 4 + (0.10 × 10,000 × 0.5)
      Cost = 4 + 500 = **504**
    |
    shape: rectangle
    style: {
      fill: "#BBDEFB"
      stroke: "#1565C0"
    }
  }
  
  index_structure: {
    label: Index B-tree\n(3-4 levels)
    shape: hexagon
    style: {
      fill: white
      stroke: "#1565C0"
    }
  }
  
  table_pages: {
    label: "Table Pages\n(Random Access)"
    shape: rectangle
    style: {
      fill: white
      stroke: "#1565C0"
      stroke-dash: 3
      multiple: true
    }
  }
  
  formula -> calc_example
  calc_example -> index_structure: "Traverse\nindex"
  index_structure -> table_pages: "Fetch rows\n(1000 random I/Os)" {
    style: {
      stroke: "#1565C0"
      stroke-width: 2
      animated: true
    }
  }
}

# Center: Crossover Analysis
crossover: {
  style: {
    fill: "#FFF8E1"
    stroke: "#F57C00"
    stroke-width: 2
  }
  
  crossover_title: "SELECTIVITY THRESHOLD" {
    shape: text
    style: {
      font-size: 20
      bold: true
    }
  }
  
  crossover_visual: {
    grid-columns: 3
    grid-gap: 0
    
    low_sel: {
      label: "LOW\n< 20%"
      style: {
        fill: "#BBDEFB"
        stroke: "#1565C0"
        font-color: "#1565C0"
        bold: true
      }
    }
    
    threshold: {
      label: "THRESHOLD\n~20%"
      style: {
        fill: "#FFE0B2"
        stroke: "#F57C00"
        font-color: "#E65100"
        bold: true
      }
    }
    
    high_sel: {
      label: "HIGH\n> 20%"
      style: {
        fill: "#C8E6C9"
        stroke: "#2E7D32"
        font-color: "#2E7D32"
        bold: true
      }
    }
  }
  
  recommendation: |md
    **Decision Rule:**
    
    • **Selectivity < 20%** → Use Index Scan
      (Few rows match, random I/O is worth it)
    
    • **Selectivity > 20%** → Use Table Scan  
      (Many rows match, sequential I/O is faster)
  | {
    shape: rectangle
    style: {
      fill: white
      stroke: "#F57C00"
    }
  }
  
  crossover_title -> crossover_visual -> recommendation
}

# Bottom: Cost Comparison Chart
cost_chart: {
  label: "COST COMPARISON (10,000 row table)"
  style: {
    fill: "#FAFAFA"
    stroke: "#9E9E9E"
    stroke-width: 2
  }
  
  chart_header: {
    grid-columns: 4
    grid-gap: 10
    
    selectivity_header: "Selectivity" {
      style: {
        bold: true
        fill: "#E0E0E0"
      }
    }
    matching_header: "Matching Rows" {
      style: {
        bold: true
        fill: "#E0E0E0"
      }
    }
    index_header: "Index Scan Cost" {
      style: {
        bold: true
        fill: "#E3F2FD"
      }
    }
    table_header: "Table Scan Cost" {
      style: {
        bold: true
        fill: "#E8F5E9"
      }
    }
  }
  
  row_1: {
    grid-columns: 4
    grid-gap: 10
    
    sel_1: "1%"
    match_1: "100"
    idx_1: "54" {
      style: {
        fill: "#BBDEFB"
        bold: true
      }
    }
    tbl_1: "500"
  }
  
  row_5: {
    grid-columns: 4
    grid-gap: 10
    
    sel_5: "5%"
    match_5: "500"
    idx_5: "254" {
      style: {
        fill: "#BBDEFB"
        bold: true
      }
    }
    tbl_5: "500"
  }
  
  row_10: {
    grid-columns: 4
    grid-gap: 10
    
    sel_10: "10%"
    match_10: "1,000"
    idx_10: "504"
    tbl_10: "500" {
      style: {
        fill: "#C8E6C9"
        bold: true
      }
    }
  }
  
  row_20: {
    grid-columns: 4
    grid-gap: 10
    
    sel_20: "20%"
    match_20: "2,000"
    idx_20: "1,004"
    tbl_20: "500" {
      style: {
        fill: "#C8E6C9"
        bold: true
      }
    }
  }
  
  row_50: {
    grid-columns: 4
    grid-gap: 10
    
    sel_50: "50%"
    match_50: "5,000"
    idx_50: "2,504"
    tbl_50: "500" {
      style: {
        fill: "#C8E6C9"
        bold: true
      }
    }
  }
}

legend: |md
  **Cost Assumptions:**
  • Page Read Cost (sequential): 1.0
  • Random I/O Cost: 0.5 per row
  • Index Traversal: 4 page reads
  • Total Pages: 500
| {
  near: bottom-center
  shape: text
  style: {
    font-size: 14
    italic: true
    font-color: "#616161"
  }
}

# Arrows connecting sections
table_scan -> crossover: "Compare cost" {
  style: {
    stroke: "#757575"
    stroke-dash: 5
  }
}

index_scan -> crossover: "Compare cost" {
  style: {
    stroke: "#757575"
    stroke-dash: 5
  }
}

crossover -> cost_chart: "Example calculations" {
  style: {
    stroke: "#757575"
    stroke-dash: 5
  }
}

# Key insight annotation
insight: |md
  **KEY INSIGHT:** The crossover point occurs when
  `selectivity × rows × random_IO_cost ≈ total_pages × seq_IO_cost`
  
  Below this threshold, index scan wins.
  Above it, table scan wins.
| {
  near: bottom-right
  shape: rectangle
  style: {
    fill: "#FFECB3"
    stroke: "#FF8F00"
    stroke-width: 2
    bold: true
  }
}