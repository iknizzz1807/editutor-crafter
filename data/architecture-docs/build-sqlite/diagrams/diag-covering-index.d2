vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    table: "#E8F5E9"
    index: "#E3F2FD"
    result: "#FFF3E0"
    highlight: "#C8E6C9"
    hot: "#FFCDD2"
    arrow: "#546E7A"
    skip: "#9E9E9E"
  }
}

title: |md
  # Covering Index: Eliminating the Double Lookup
| {near: top-center}

direction: right

before: {
  label: "REGULAR INDEX SCAN\n(Double Lookup Required)"
  
  sql_before: |md
    sql
    SELECT name FROM users 
    WHERE email = 'alice@example.com';
    
    -- Index on (email) only
    -- Must fetch full row for 'name'
    
  | {
    shape: rectangle
    style.fill: transparent
  }
  
  idx_regular: "Index on (email)\n┌─────────────────┬─────────┐\n│ email            │ rowid   │\n├─────────────────┼─────────┤\n│ alice@...        │ 42      │\n│ bob@...          │ 17      │\n│ charlie@...      │ 89      │\n└─────────────────┴─────────┘" {
    shape: rectangle
    style.fill: ${colors.index}
    style.stroke: "#1976D2"
    style.stroke-width: 2
  }
  
  table_regular: "Table B-tree\n┌────────┬─────────┬───────┬─────┐\n│ rowid  │ email   │ name  │ age │\n├────────┼─────────┼───────┼─────┤\n│ 42     │ alice@  │ Alice │ 30  │\n│ 17     │ bob@    │ Bob   │ 25  │\n│ 89     │ charlie@│ Charlie│28  │\n└────────┴─────────┴───────┴─────┘" {
    shape: rectangle
    style.fill: ${colors.table}
    style.stroke: "#388E3C"
    style.stroke-width: 2
  }
  
  result_before: "Result\n┌───────┐\n│ name  │\n├───────┤\n│ Alice │\n└───────┘" {
    shape: rectangle
    style.fill: ${colors.result}
    style.stroke: "#F57C00"
    style.stroke-width: 2
  }
  
  step1: "Step 1\nIndex Seek\nO(log n)" {
    shape: text
    style.font-color: "#1976D2"
    style.bold: true
  }
  
  step2: "Step 2\nTable Lookup\nO(log n)" {
    shape: text
    style.font-color: "#388E3C"
    style.bold: true
  }
  
  step3: "Step 3\nExtract name" {
    shape: text
    style.font-color: "#F57C00"
    style.bold: true
  }
  
  idx_regular -> table_regular: "rowid=42\nfetch row" {
    label.near: center-right
    style.stroke: ${colors.arrow}
    style.stroke-width: 2
    style.animated: true
  }
  
  table_regular -> result_before: "name column" {
    label.near: center-right
    style.stroke: ${colors.arrow}
    style.stroke-width: 2
  }
  
  io_cost_before: |md
    **I/O Cost: 2 B-tree traversals**
    - Index pages: ~3-4 reads
    - Table pages: ~3-4 reads
    - **Total: ~6-8 page reads**
  | {
    shape: rectangle
    style.fill: ${colors.hot}
    style.stroke: "#D32F2F"
  }
}

after: {
  label: "COVERING INDEX SCAN\n(Single Lookup - Table Skipped!)"
  
  sql_after: |md
    sql
    SELECT name FROM users 
    WHERE email = 'alice@example.com';
    
    -- Covering index on (email, name)
    -- All needed columns in index!
    
  | {
    shape: rectangle
    style.fill: transparent
  }
  
  idx_covering: "Covering Index on (email, name)\n┌─────────────────┬─────────┬───────┐\n│ email            │ name    │ rowid │\n├─────────────────┼─────────┼───────┤\n│ alice@...        │ Alice   │ 42    │\n│ bob@...          │ Bob     │ 17    │\n│ charlie@...      │ Charlie │ 89    │\n└─────────────────┴─────────┴───────┘" {
    shape: rectangle
    style.fill: ${colors.highlight}
    style.stroke: "#2E7D32"
    style.stroke-width: 3
    style.shadow: true
  }
  
  table_skipped: "Table B-tree\n(SKIPPED)" {
    shape: rectangle
    style.fill: "#F5F5F5"
    style.stroke: ${colors.skip}
    style.stroke-dash: 3
    style.opacity: 0.4
  }
  
  result_after: "Result\n┌───────┐\n│ name  │\n├───────┤\n│ Alice │\n└───────┘" {
    shape: rectangle
    style.fill: ${colors.result}
    style.stroke: "#F57C00"
    style.stroke-width: 2
  }
  
  step1_only: "Single Step\nIndex Seek + Read\nO(log n)" {
    shape: text
    style.font-color: "#2E7D32"
    style.bold: true
  }
  
  idx_covering -> result_after: "name already\nin index!" {
    label.near: center-right
    style.stroke: "#2E7D32"
    style.stroke-width: 3
    style.animated: true
  }
  
  idx_covering -> table_skipped: "❌ No lookup\nneeded!" {
    style.stroke: ${colors.skip}
    style.stroke-dash: 5
    style.font-color: ${colors.skip}
  }
  
  io_cost_after: |md
    **I/O Cost: 1 B-tree traversal**
    - Index pages: ~3-4 reads
    - Table pages: **0 reads**
    - **Total: ~3-4 page reads**
  | {
    shape: rectangle
    style.fill: ${colors.highlight}
    style.stroke: "#2E7D32"
  }
}

before -> after: "50% I/O reduction!" {
  style.stroke: "#2E7D32"
  style.stroke-width: 4
  style.bold: true
  style.animated: true
}

legend: {
  shape: rectangle
  style.fill: "#FAFAFA"
  style.stroke: "#BDBDBD"
  
  key: |md
    ### Covering Index Rule
    An index **covers** a query when it contains all columns referenced in:
    - `SELECT` clause (projection)
    - `WHERE` clause (predicates)
    - `ORDER BY` clause (sorting)
    - `JOIN` conditions
    
    **No table lookup needed → Faster query!**
  |
}

example_queries: {
  shape: rectangle
  style.fill: "#FAFAFA"
  style.stroke: "#BDBDBD"
  
  ex: |md
    ### When Covering Indexes Help
    
    ✅ **Covered** (index on `status, created_at`):
    sql
    SELECT created_at FROM orders 
    WHERE status = 'pending';
    
    
    ✅ **Covered** (index on `email, name`):
    sql
    SELECT name FROM users 
    WHERE email = 'alice@example.com';
    
    
    ❌ **Not Covered** (needs `age` not in index):
    sql
    SELECT name, age FROM users 
    WHERE email = 'alice@example.com';
    
    
    ✅ **Covered** (index on `category, price`):
    sql
    SELECT COUNT(*) FROM products 
    WHERE category = 'electronics';
    -- COUNT(*) only needs index entries!
    
  |
}