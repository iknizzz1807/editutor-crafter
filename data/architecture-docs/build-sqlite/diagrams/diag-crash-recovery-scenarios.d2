vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    safe: "#3DDC84"
    danger: "#DC3545"
    warning: "#FFC107"
    info: "#17A2B8"
    neutral: "#6C757D"
  }
}

title: |md
  # Crash Recovery: All Failure Modes
  ## Write Ordering Guarantees Consistent State After Any Crash
| {near: top-center}

# Timeline showing crash points
timeline: {
  grid-columns: 5
  grid-gap: 0
  
  # Row 1: Phase labels
  phase_label: Phase {
    style.fill: "${colors.neutral}"
    style.font-color: white
    style.bold: true
  }
  
  t1_label: T1: Journal Write {
    style.fill: "${colors.info}"
    style.font-color: white
  }
  
  t2_label: T2: Journal Sync {
    style.fill: "${colors.warning}"
    style.font-color: black
    style.bold: true
  }
  
  t3_label: T3: Database Write {
    style.fill: "${colors.info}"
    style.font-color: white
  }
  
  t4_label: T4: Journal Delete {
    style.fill: "${colors.safe}"
    style.font-color: white
  }
  
  # Row 2: Operations
  op_label: Operation {
    style.fill: "${colors.neutral}"
    style.font-color: white
    style.bold: true
  }
  
  t1_op: Write original\npages to journal {
    style.fill: "#E8F4FD"
  }
  
  t2_op: fsync()\njournal file {
    style.fill: "#FFF3CD"
    style.bold: true
  }
  
  t3_op: Write modified\npages to DB {
    style.fill: "#E8F4FD"
  }
  
  t4_op: Delete\njournal {
    style.fill: "#D4EDDA"
  }
  
  # Row 3: Crash points
  crash_label: Crash Point {
    style.fill: "${colors.neutral}"
    style.font-color: white
    style.bold: true
  }
  
  crash_a: CRASH A {
    style.fill: "${colors.danger}"
    style.font-color: white
    style.bold: true
  }
  
  crash_b: CRASH B {
    style.fill: "${colors.danger}"
    style.font-color: white
    style.bold: true
  }
  
  crash_c: CRASH C {
    style.fill: "${colors.danger}"
    style.font-color: white
    style.bold: true
  }
  
  crash_d: CRASH D {
    style.fill: "${colors.danger}"
    style.font-color: white
    style.bold: true
  }
  
  # Row 4: Journal state
  journal_label: Journal State {
    style.fill: "${colors.neutral}"
    style.font-color: white
    style.bold: true
  }
  
  j_a: In OS cache\n(not durable) {
    style.fill: "#F8D7DA"
  }
  
  j_b: On disk\n(durable) {
    style.fill: "#D4EDDA"
    style.bold: true
  }
  
  j_c: On disk\n(durable) {
    style.fill: "#D4EDDA"
  }
  
  j_d: Deleted {
    style.fill: "#D4EDDA"
  }
  
  # Row 5: DB state
  db_label: Database State {
    style.fill: "${colors.neutral}"
    style.font-color: white
    style.bold: true
  }
  
  d_a: Unchanged {
    style.fill: "#D4EDDA"
  }
  
  d_b: Unchanged {
    style.fill: "#D4EDDA"
  }
  
  d_c: Partially\nwritten {
    style.fill: "#F8D7DA"
  }
  
  d_d: Fully\nwritten {
    style.fill: "#D4EDDA"
  }
  
  # Row 6: Recovery needed
  recovery_label: Recovery {
    style.fill: "${colors.neutral}"
    style.font-color: white
    style.bold: true
  }
  
  r_a: None needed {
    style.fill: "${colors.safe}"
    style.font-color: white
  }
  
  r_b: Rollback\nfrom journal {
    style.fill: "${colors.warning}"
    style.font-color: black
    style.bold: true
  }
  
  r_c: Rollback\nfrom journal {
    style.fill: "${colors.warning}"
    style.font-color: black
    style.bold: true
  }
  
  r_d: Committed\nNo action {
    style.fill: "${colors.safe}"
    style.font-color: white
  }
  
  # Row 7: Result state
  result_label: Result {
    style.fill: "${colors.neutral}"
    style.font-color: white
    style.bold: true
  }
  
  res_a: Original DB\n(consistent) {
    style.fill: "${colors.safe}"
    style.font-color: white
  }
  
  res_b: Original DB\n(rolled back) {
    style.fill: "${colors.safe}"
    style.font-color: white
  }
  
  res_c: Original DB\n(rolled back) {
    style.fill: "${colors.safe}"
    style.font-color: white
  }
  
  res_d: New state\n(consistent) {
    style.fill: "${colors.safe}"
    style.font-color: white
  }
}

# Critical boundary marker
critical_boundary: |md
  ## ⚠️ CRITICAL BOUNDARY
  Journal must be durable BEFORE database is modified
| {
  style.fill: "#FFF3CD"
  style.stroke: "${colors.warning}"
  style.stroke-width: 3
}

# Detailed failure mode boxes
failure_modes: {
  crash_a_detail: Crash A - Before Journal Sync {
    link: "#crash-a-analysis"
    style.fill: "#F8D7DA"
    style.stroke: "${colors.danger}"
    
    trigger: Trigger: Power loss {
      shape: diamond
      style.fill: "${colors.danger}"
      style.font-color: white
    }
    
    journal_state: Journal in OS cache {
      style.fill: "${colors.warning}"
    }
    
    db_state: Database unchanged {
      style.fill: "${colors.safe}"
    }
    
    recovery: No hot journal detected {
      style.fill: "${colors.safe}"
    }
    
    outcome: Transaction never happened {
      style.fill: "${colors.safe}"
      style.bold: true
    }
    
    trigger -> journal_state: on crash
    journal_state -> db_state: DB safe
    db_state -> recovery: Restart
    recovery -> outcome: Result
  }
  
  crash_b_detail: Crash B - After Journal Sync {
    link: "#crash-b-analysis"
    style.fill: "#D4EDDA"
    style.stroke: "${colors.safe}"
    
    trigger: Trigger: Power loss {
      shape: diamond
      style.fill: "${colors.danger}"
      style.font-color: white
    }
    
    journal_state: Journal on disk {
      style.fill: "${colors.safe}"
    }
    
    db_state: Database unchanged {
      style.fill: "${colors.safe}"
    }
    
    recovery: Hot journal detected\nRestore pages {
      style.fill: "${colors.warning}"
      style.bold: true
    }
    
    outcome: Original state restored {
      style.fill: "${colors.safe}"
      style.bold: true
    }
    
    trigger -> journal_state: on crash
    journal_state -> db_state: DB safe
    db_state -> recovery: Restart
    recovery -> outcome: Result
  }
  
  crash_c_detail: Crash C - During Database Write {
    link: "#crash-c-analysis"
    style.fill: "#D4EDDA"
    style.stroke: "${colors.safe}"
    
    trigger: Trigger: Power loss {
      shape: diamond
      style.fill: "${colors.danger}"
      style.font-color: white
    }
    
    journal_state: Journal on disk {
      style.fill: "${colors.safe}"
    }
    
    db_state: Torn pages\nPartial writes {
      style.fill: "${colors.danger}"
      style.bold: true
    }
    
    recovery: Hot journal detected\nRestore originals {
      style.fill: "${colors.warning}"
      style.bold: true
    }
    
    outcome: Original state restored {
      style.fill: "${colors.safe}"
      style.bold: true
    }
    
    trigger -> journal_state: on crash
    journal_state -> db_state: DB corrupt!
    db_state -> recovery: Restart
    recovery -> outcome: Result
  }
  
  crash_d_detail: Crash D - After Journal Delete {
    link: "#crash-d-analysis"
    style.fill: "#D4EDDA"
    style.stroke: "${colors.safe}"
    
    trigger: Trigger: Power loss {
      shape: diamond
      style.fill: "${colors.danger}"
      style.font-color: white
    }
    
    journal_state: Journal deleted {
      style.fill: "${colors.safe}"
    }
    
    db_state: Database fully written {
      style.fill: "${colors.safe}"
    }
    
    recovery: No journal exists\nNo action needed {
      style.fill: "${colors.safe}"
    }
    
    outcome: Transaction committed {
      style.fill: "${colors.safe}"
      style.bold: true
    }
    
    trigger -> journal_state: on crash
    journal_state -> db_state: DB committed
    db_state -> recovery: Restart
    recovery -> outcome: Result
  }
}

# Torn page illustration
torn_page_example: Torn Page Example {
  style.fill: "#F8D7DA"
  style.stroke: "${colors.danger}"
  
  label: |md
    ### 4096-byte page write interrupted
    
    Bytes 0-2048: New data ✓
    Bytes 2049-4095: Old data ✗
    
    Result: Corrupt page structure
    Invalid cell pointers
    Broken B-tree invariants
  |
}

# Recovery algorithm
recovery_algorithm: |md
  ## Recovery Algorithm (Pseudocode)
  
  on_database_open(path):
    journal_path = path + "-journal"
    
    if not exists(journal_path):
      return  // No recovery needed
    
    journal = open_journal(journal_path)
    
    if not validate_header(journal):
      delete(journal_path)
      return  // Invalid journal, ignore
    
    // Hot journal exists - rollback needed
    for each page_record in journal:
      if validate_checksum(page_record):
        write_page(database, 
                   page_record.page_num,
                   page_record.data)
    
    sync(database)
    delete(journal_path)
    sync(directory)
  
| {
  style.fill: "#E8F4FD"
  style.stroke: "${colors.info}"
}

# Key insight
key_insight: |md
  ## Key Insight: Write Ordering
  The **order** of writes guarantees consistency:
  
  1. **Journal first** → Original pages preserved
  2. **fsync journal** → Preservation is durable
  3. **Then modify DB** → Can always undo
  4. **Delete journal last** → Commit is final
  
  This is the **WAL protocol** (Write-Ahead Logging):
  > "Never modify a page until its original
  > contents have been logged to stable storage"
| {
  style.fill: "#D4EDDA"
  style.stroke: "${colors.safe}"
  style.stroke-width: 2
}

# fsync cost annotation
fsync_note: |md
  ### fsync() Cost
  SSD: 25-100 μs
  HDD: 5-10 ms
  
  This is why transactions
  feel "slow" - durability has
  a real cost.
| {
  style.fill: "#FFF3CD"
  style.stroke: "${colors.warning}"
}

# Connect timeline phases
timeline.t1_label -> timeline.t2_label: must complete {
  style.stroke: "${colors.danger}"
  style.stroke-width: 3
  style.animated: true
}

timeline.t2_label -> timeline.t3_label: then proceed {
  style.stroke: "${colors.safe}"
  style.stroke-width: 2
}

timeline.t3_label -> timeline.t4_label: then cleanup {
  style.stroke: "${colors.safe}"
  style.stroke-width: 2
}