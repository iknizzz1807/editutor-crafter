vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    danger: "#E74C3C"
    success: "#27AE60"
    warning: "#F39C12"
    neutral: "#3498DB"
    bg: "#2C3E50"
    bg-light: "#34495E"
  }
}
direction: right
title: |md
  # Crash Recovery: Hot Journal Protocol
  Rollback Journal Recovery Flow
| {near: top-center}
# === STARTUP PHASE ===
startup: {
  style.fill: "${colors.bg}"
  style.stroke: "${colors.neutral}"
  style.font-color: white
  style.border-radius: 8
  label: "Database Startup\n(power on / restart)"
}
# === JOURNAL DETECTION ===
detect: {
  style.fill: "${colors.bg-light}"
  style.stroke: "${colors.warning}"
  style.font-color: white
  style.border-radius: 8
  question: {
    shape: diamond
    width: 180
    height: 120
    label: "Hot Journal\nExists?"
    style.fill: "${colors.warning}"
    style.font-color: white
    style.stroke: "${colors.warning}"
  }
  no_journal: {
    label: "No Journal\n(Clean Shutdown)"
    style.fill: "${colors.success}"
    style.font-color: white
    style.border-radius: 6
  }
  yes_journal: {
    label: "Journal Found\n(Crash Detected!)"
    style.fill: "${colors.danger}"
    style.font-color: white
    style.border-radius: 6
  }
}
# === VALIDATION PHASE ===
validate: {
  style.fill: "${colors.bg-light}"
  style.stroke: "${colors.neutral}"
  style.font-color: white
  style.border-radius: 8
  label: "Validate Journal"
  checks: {
    grid-rows: 4
    grid-gap: 0
    magic: {
      label: "1. Magic Number\n0xd9d505f9"
      style.fill: "${colors.neutral}"
      style.font-color: white
      style.border-radius: 4
    }
    checksum: {
      label: "2. Header Checksum"
      style.fill: "${colors.neutral}"
      style.font-color: white
      style.border-radius: 4
    }
    salts: {
      label: "3. Salt Values"
      style.fill: "${colors.neutral}"
      style.font-color: white
      style.border-radius: 4
    }
    pages: {
      label: "4. Page Records"
      style.fill: "${colors.neutral}"
      style.font-color: white
      style.border-radius: 4
    }
  }
}
# === RESTORATION PHASE ===
restore: {
  style.fill: "${colors.bg-light}"
  style.stroke: "${colors.success}"
  style.font-color: white
  style.border-radius: 8
  label: "Restore Original Pages"
  note: |md
    **Recovery Properties:**
    - **Idempotent**: Can be run multiple times safely
    - **Atomic**: Either full rollback or no change
    - **Safe**: Original pages preserved until sync completes
  | {
    style.fill: "${colors.bg}"
    style.font-color: white
    style.border-radius: 6
    style.opacity: 0.9
  }
  journal_file: {
    label: "Journal File\n(.db-journal)"
    shape: cylinder
    style.fill: "${colors.warning}"
    style.font-color: white
    records: {
      direction: down
      rec1: "Page 42 (original)"
      rec2: "Page 17 (original)"
      rec3: "Page 55 (original)"
      *.style.fill: "${colors.bg}"
      *.style.font-color: white
      *.style.border-radius: 4
      *.style.font-size: 12
    }
  }
  arrow_copy: {
    shape: text
    label: "Copy Original\nPages Back"
    style.fill: transparent
    style.font-color: "${colors.success}"
    style.font-size: 14
  }
  db_file: {
    label: "Database File\n(.db)"
    shape: cylinder
    style.fill: "${colors.danger}"
    style.font-color: white
    modified: {
      direction: down
      mod1: "Page 42 (modified!)"
      mod2: "Page 17 (modified!)"
      mod3: "Page 55 (modified!)"
      *.style.fill: "${colors.danger}"
      *.style.font-color: white
      *.style.border-radius: 4
      *.style.font-size: 12
      *.style.opacity: 0.6
    }
  }
  after_restore: {
    label: "After Restoration"
    style.fill: "${colors.success}"
    style.font-color: white
    style.border-radius: 6
  }
}
# === CLEANUP PHASE ===
cleanup: {
  style.fill: "${colors.bg-light}"
  style.stroke: "${colors.neutral}"
  style.font-color: white
  style.border-radius: 8
  sync: {
    label: "fsync(Database)"
    style.fill: "${colors.neutral}"
    style.font-color: white
    style.border-radius: 4
  }
  delete: {
    label: "Delete Journal File\nunlink(.db-journal)"
    style.fill: "${colors.neutral}"
    style.font-color: white
    style.border-radius: 4
  }
}
# === RESULT STATE ===
result: {
  style.fill: "${colors.bg}"
  style.font-color: white
  style.border-radius: 8
  consistent: {
    label: "Database Consistent\n(Transaction Rolled Back)"
    style.fill: "${colors.success}"
    style.font-color: white
    style.border-radius: 8
  }
  ready: {
    label: "Ready for\nConnections"
    style.fill: "${colors.success}"
    style.font-color: white
    style.border-radius: 8
  }
}
# === CONNECTIONS ===
startup -> detect.question: "Initialize" {
  style.stroke: "${colors.neutral}"
  style.stroke-width: 2
}
detect.question -> detect.no_journal: "No" {
  style.stroke: "${colors.success}"
  style.stroke-width: 2
  target-arrowhead.shape: triangle
}
detect.question -> detect.yes_journal: "Yes\n(Crash!)" {
  style.stroke: "${colors.danger}"
  style.stroke-width: 2
  target-arrowhead.shape: triangle
}
detect.yes_journal -> validate: "Begin Recovery" {
  style.stroke: "${colors.danger}"
  style.stroke-width: 2
}
validate -> restore.journal_file: "Valid Journal" {
  style.stroke: "${colors.success}"
  style.stroke-width: 2
}
restore.journal_file -> restore.arrow_copy: {
  style.stroke: transparent
}
restore.arrow_copy -> restore.db_file: {
  style.stroke: "${colors.success}"
  style.stroke-width: 2
  style.animated: true
  label: "Overwrite\nModified Pages"
}
restore.db_file -> restore.after_restore: {
  style.stroke: "${colors.success}"
  style.stroke-width: 2
}
restore.after_restore -> cleanup.sync: {
  style.stroke: "${colors.success}"
  style.stroke-width: 2
}
cleanup.sync -> cleanup.delete: {
  style.stroke: "${colors.neutral}"
  style.stroke-width: 2
}
cleanup.delete -> result.consistent: {
  style.stroke: "${colors.success}"
  style.stroke-width: 2
}
detect.no_journal -> result.ready: {
  style.stroke: "${colors.success}"
  style.stroke-width: 2
}
result.consistent -> result.ready: {
  style.stroke: "${colors.success}"
  style.stroke-width: 2
}
# === KEY INSIGHT BOX ===
insight: {
  style.fill: "${colors.bg}"
  style.stroke: "${colors.warning}"
  style.font-color: white
  style.border-radius: 8
  style.double-border: true
  width: 280
  header: |md
    **KEY INSIGHT**
  |
  content: |md
    The journal contains **ORIGINAL** page
    contents (before modification).
    Recovery = UNDO operation
    - Rollback incomplete transactions
    - Restore pre-crash state
    - Database is consistent
  |
}
detect -> insight: {
  style.stroke: transparent
}