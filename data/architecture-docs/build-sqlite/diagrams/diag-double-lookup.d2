content, end output with `|md
` block and validate JSON. NO preambles. NO conversation.
layout-engine: elk
theme-id: 200
vars: {
  d2-config: {
    pad: 30
  }
  colors: {
    header: "#4A5568"
    module: "#2D3748"
    component: "#4A5568"
    dataflow: "#38A169"
    storage: "#805AD5"
    vm: "#DD6B20"
    accent: "#E53E3A"
  }
}
classes: {
  module: {
    style: {
      fill: "${colors.module}"
      stroke: "#1A202C"
      stroke-width: 2
      font-color: white
      bold: true
      font-size: 16
      border-radius: 8
    }
  }
  component: {
    style: {
      fill: "${colors.component}"
      stroke: "#2D3748"
      stroke-width: 1
      font-color: white
      font-size: 12
      border-radius: 4
    }
  }
  dataflow: {
    style: {
      stroke: "${colors.dataflow}"
      stroke-width: 2
      animated: true
    }
  }
}
title: |md
  # SQLite Architecture: Complete System Map
| {near: top-center}
direction: right
// === FRONTEND LAYER ===
Frontend: {
  class: module
  Tokenizer: {
    class: component
    label: "Tokenizer\n(FSM)\n\n• Character stream\n• Token stream\n• Position tracking"
  }
  Parser: {
    class: component
    label: "Parser\n(Recursive Descent)\n\n• AST generation\n• Precedence climbing\n• Error recovery"
  }
  Compiler: {
    class: component
    label: "Bytecode Compiler\n\n• AST → VDBE bytecode\n• Register allocation\n• Jump patching"
  }
  Planner: {
    class: component
    label: "Query Planner\n\n• Cost estimation\n• Index selection\n• Join ordering"
  }
  Tokenizer -> Parser: "tokens" {class: dataflow}
  Parser -> Compiler: "AST" {class: dataflow}
  Compiler -> Planner: "bytecode" {class: dataflow; style.animated: false}
}
// === EXECUTION LAYER ===
Execution: {
  class: module
  style.fill: "#744210"
  VDBE: {
    class: component
    style.fill: "${colors.vm}"
    label: "VDBE Virtual Machine\n\n• Fetch-decode-execute\n• Register file\n• Cursor management"
  }
  Aggregates: {
    class: component
    label: "Aggregate Engine\n\n• COUNT/SUM/AVG/MIN/MAX\n• Hash-based GROUP BY\n• HAVING filter"
  }
  Joins: {
    class: component
    label: "Join Executor\n\n• Nested loop join\n• Index seek optimization\n• Multi-table combine"
  }
  VDBE -> Aggregates: "aggregate ops" {class: dataflow}
  VDBE -> Joins: "join ops" {class: dataflow}
  Aggregates <-> Joins: "composite queries" {style.stroke-dash: 3}
}
// === STORAGE LAYER ===
Storage: {
  class: module
  style.fill: "#553C9A"
  BTree: {
    class: component
    style.fill: "${colors.storage}"
    label: "B-tree Layer\n\n• Page format (slotted)\n• Node split/merge\n• Varint encoding\n• Row serialization"
  }
  Indexes: {
    class: component
    label: "Secondary Indexes\n\n• B+tree structure\n• (key, rowid) pairs\n• Range scans\n• Covering index"
  }
  BufferPool: {
    class: component
    label: "Buffer Pool\n\n• LRU eviction\n• Pin counts\n• Dirty page tracking\n• O(1) page lookup"
  }
  BTree <-> Indexes: "index maintenance" {style.stroke-dash: 3}
  BufferPool -> BTree: "page frames" {class: dataflow}
}
// === TRANSACTION LAYER ===
Transactions: {
  class: module
  style.fill: "#9C4221"
  RollbackJournal: {
    class: component
    style.fill: "${colors.accent}"
    label: "Rollback Journal\n\n• Original pages\n• Write-before-modify\n• fsync ordering\n• Crash recovery"
  }
  WAL: {
    class: component
    label: "WAL Mode\n\n• Modified pages (redo)\n• Snapshot isolation\n• Concurrent readers\n• Checkpoint"
  }
  RollbackJournal <-> WAL: "mode switch" {style.stroke-dash: 3}
}
// === DISK ===
Disk: {
  shape: cylinder
  style: {
    fill: "#1A202C"
    stroke: "#4A5568"
    stroke-width: 2
    font-color: white
  }
  label: "Disk Storage\n\n• Database file (.db)\n• Journal file (.db-journal)\n• WAL file (.db-wal)"
}
// === CONNECTIONS BETWEEN LAYERS ===
Frontend.Planner -> Execution.VDBE: "optimized bytecode" {
  class: dataflow
  style.stroke-width: 3
}
Execution.VDBE -> Storage.BufferPool: "page requests" {
  class: dataflow
  style.stroke: "${colors.storage}"
}
Storage.BufferPool -> Disk: "read/write pages" {
  style: {
    stroke: "#4A5568"
    stroke-width: 2
  }
}
Transactions.RollbackJournal -> Disk: "journal writes" {
  style: {
    stroke: "${colors.accent}"
    stroke-dash: 3
  }
}
Transactions.WAL -> Disk: "WAL appends" {
  style: {
    stroke: "#ED8936"
    stroke-dash: 3
  }
}
Execution.VDBE -> Transactions: "BEGIN/COMMIT/ROLLBACK" {
  style: {
    stroke: "${colors.accent}"
    stroke-width: 2
  }
}
Storage.BTree -> Transactions: "page modifications" {
  style: {
    stroke: "${colors.accent}"
    stroke-dash: 5
  }
}
// === DATA FLOW ANNOTATIONS ===
explanation: |md
  **Data Flow**: SQL → Tokenizer → Parser → Compiler → Planner → VDBE → B-tree → Buffer Pool → Disk
  **Transaction Flow**: VDBE → Transaction Manager → Journal/WAL → Disk (with fsync ordering)
  **Concurrency**: WAL mode enables concurrent readers during writes via snapshot isolation
| {
  near: bottom-center
  shape: text
  style: {
    font-size: 14
    font-color: "#4A5568"
  }
}
// === KEY MODULE HIGHLIGHTS ===
highlights: {
  near: top-right
  shape: text
  style: {
    fill: "#EDF2F7"
    stroke: "#CBD5E0"
    border-radius: 8
    font-size: 12
  }
  label: |md
    **Key Components**
    • **Tokenizer**: FSM for lexical analysis
    • **Parser**: Recursive descent + precedence climbing
    • **VDBE**: Register-based bytecode VM
    • **B-tree**: Slotted page format, varint encoding
    • **Buffer Pool**: LRU with pin counts
    • **WAL**: Snapshot isolation for concurrency
  |
}