vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  execution_logic: {
    style: {
      fill: "#f3e5f5"
      stroke: "#7b1fa2"
      stroke-width: 2
      border-radius: 10
    }
  }
  memory_layout: {
    style: {
      fill: "#e8f5e9"
      stroke: "#2e7d32"
      stroke-width: 1
      font: mono
    }
  }
  storage_layer: {
    style: {
      fill: "#fff3e0"
      stroke: "#e65100"
      stroke-width: 2
      shadow: true
    }
  }
}

# --- THE COMPLETED MACHINE ---

"THE COMPLETED SQLITE MACHINE": {
  
  # --- FRONT-END ARCHITECTURE ---
  REPL_Gateway: "Milestone 1: The Gateway" {
    class: execution_logic
    link: "#milestone-1"
    
    Input_Buffer: "struct InputBuffer" {
      shape: sql_table
      class: memory_layout
      "char* buffer": "0x55aa... 'UPDATE users SET...'"
      "size_t length": "1024"
      "ssize_t input_len": "42"
    }
  }

  # --- COMPILATION PIPELINE ---
  Compiler: "Milestones 2 & 5: Architect & Strategist" {
    class: execution_logic
    link: "#milestone-2"

    Tokenizer: "Lexer Scanner" {
      Stream: {
        shape: queue
        "UPDATE"; "users"; "SET"; "points"; "="; "10"; "WHERE"; "id"; "="; "5"
      }
    }

    Optimizer: "Query Planner (CBO)" {
      link: "#milestone-5"
      Plan: |'md
      - **Access**: B-Tree Index Scan
      - **Index**: `idx_users_id`
      - **Scan Type**: EQ_SEARCH
      '|
    }

    Tokenizer.Stream -> Optimizer: "Token stream"
  }

  # --- THE VIRTUAL MACHINE ---
  VDBE_Engine: "Milestone 3: VDBE VM" {
    class: execution_logic
    link: "#milestone-3"

    Registers: "Virtual CPU Registers" {
      shape: sql_table
      class: memory_layout
      "R0 (SearchVal)": "5"
      "R1 (UpdateVal)": "10"
      "R2 (TablePtr)": "0x0A22"
      "R3 (Status)": "SUCCESS"
    }

    Bytecode: "Compiled OpCodes" {
      shape: sql_table
      "0": "Transaction | 1 | 0"
      "1": "VerifyCookie | 0 | 40"
      "2": "Integer | 5 | R0"
      "3": "SeekGE | 0 | 7 | R0"
      "4": "IdxUpdate | 0 | R1"
      "5": "Halt | 0 | 0"
    }
  }

  # --- STORAGE SUBSYSTEM ---
  Warehouse: "Milestones 4, 7 & 10: Warehouse" {
    class: storage_layer
    link: "#milestone-4"

    B_Tree: "B+Tree Logic & Record Format" {
      link: "#milestone-7"
      Internal: "Branch Node" { shape: diamond }
      
      Leaf: "Leaf Page (ID=5)" {
        shape: sql_table
        class: memory_layout
        "Page Header": "0x0D (Leaf) | Free: 240B"
        "Cell Map": "[0:0x0F00, 1:0x0E80...]"
        "Record 5": "Manifest: [INT, STR, INT] | Data: [5, 'Alice', 10]"
      }
      
      Internal -> Leaf: "Binary Seek"
    }

    Pager_System: "Pager & VFS Layer" {
      link: "#milestone-10"
      
      Page_Cache: "LRU RAM Cache" {
        grid-rows: 2
        "Page 1: Root"
        "Page 5: Active" { style.fill: "#fff9c4" }
        "Page 12: Free"
        "Page 8: Dirty" { style.stroke: red }
      }

      VFS: "Virtual File System" {
        "Methods": "xRead() | xWrite() | xSync()"
      }
    }
  }

  # --- DURABILITY & ATOMICITY ---
  Protector: "Milestone 6: WAL Durability" {
    class: storage_layer
    link: "#milestone-6"

    WAL_File: "WAL Journal (.wal)" {
      shape: cylinder
      "Frame 1": "Page 5 Image (Points=10)"
      "Frame 2": "Checksum 0xAABB"
      "Commit": "Atomic TX Marker"
    }

    Main_DB: "Main Storage (.db)" {
      shape: cylinder
      style.multiple: true
    }
  }
}

# --- THE SYSTEM HANDSHAKES (Denoting Density) ---

"THE COMPLETED SQLITE MACHINE".REPL_Gateway.Input_Buffer -> "THE COMPLETED SQLITE MACHINE".Compiler.Tokenizer: "Milestone 1 to 2"
"THE COMPLETED SQLITE MACHINE".Compiler.Optimizer -> "THE COMPLETED SQLITE MACHINE".VDBE_Engine.Bytecode: "Milestone 5 to 3"
"THE COMPLETED SQLITE MACHINE".VDBE_Engine.Bytecode -> "THE COMPLETED SQLITE MACHINE".Warehouse.B_Tree: "OpCode Dispatch"
"THE COMPLETED SQLITE MACHINE".Warehouse.B_Tree.Leaf -> "THE COMPLETED SQLITE MACHINE".Warehouse.Pager_System.Page_Cache: "Pin Page"
"THE COMPLETED SQLITE MACHINE".Warehouse.Pager_System.Page_Cache -> "THE COMPLETED SQLITE MACHINE".Protector.WAL_File: "Log-Before-Write"
"THE COMPLETED SQLITE MACHINE".Protector.WAL_File -> "THE COMPLETED SQLITE MACHINE".Protector.Main_DB: "Checkpoint Task"

# --- STATE HIGHLIGHT: UPDATE CYCLE ---

( "THE COMPLETED SQLITE MACHINE".VDBE_Engine -> "THE COMPLETED SQLITE MACHINE".Warehouse )[*]: {
  style: {
    stroke: "#c62828"
    stroke-width: 5
    animated: true
  }
}

# --- FLOATING ANNOTATION ---

Architect_Summary: |'md
### The Architectural Pulse
1. **Frontend**: REPL & Tokenizer ingest human intent.
2. **Virtual Machine**: Registers simulate a CPU for high-speed logic.
3. **B-Tree**: Page-aligned storage enables log(N) lookup.
4. **Pager/VFS**: Abstracting hardware ensures portable I/O.
5. **WAL**: Write-Ahead Logging protects against power loss.
'| {
  near: bottom-right
  style.fill: "#fafafa"
  style.border-radius: 5
}

***.style.font-size: 14
(*** -> ***)[*]: {
  style.font-color: "#455a64"
}