vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right
title: |md
  # Write Ordering: Why fsync Matters
  **The Critical Sequence for Crash Safety**
| {near: top-center}
# ============================================
# CORRECT ORDERING (LEFT SIDE)
# ============================================
correct: {
  label: "âœ“ CORRECT ORDERING\nJournal fsync BEFORE database write"
  timeline_correct: {
    direction: down
    grid-gap: 0
    step1: {
      label: "1. Write Journal"
      style.fill: "#E4DBFE"
      style.stroke: "#88DCF7"
      style.stroke-width: 2
    }
    step2: {
      label: "2. fsync(journal)"
      style.fill: "#ACE1AF"
      style.stroke: "#4CAF50"
      style.stroke-width: 3
      style.bold: true
    }
    step3: {
      label: "3. Write Database"
      style.fill: "#FFE7CB"
      style.stroke: "#FF9800"
      style.stroke-width: 2
    }
    step4: {
      label: "4. fsync(database)"
      style.fill: "#FFF9C9"
      style.stroke: "#FFC107"
      style.stroke-width: 2
    }
    step5: {
      label: "5. Delete Journal"
      style.fill: "#E4DBFE"
      style.stroke: "#88DCF7"
      style.stroke-width: 2
    }
    step1 -> step2: "critical\nguarantee"
    step2 -> step3: "now safe\nto modify"
    step3 -> step4: "ensure\ndurability"
    step4 -> step5: "commit\ncomplete"
  }
  crash_scenarios_correct: {
    direction: down
    label: "Crash Scenarios"
    crash_after_journal: {
      label: |md
        **Crash after step 2**
        - Journal: âœ“ On disk
        - Database: Unchanged
        - **Recovery:** Restore from journal
      |
      style.fill: "#ACE1AF"
      style.border-radius: 8
    }
    crash_after_db: {
      label: |md
        **Crash after step 4**
        - Journal: âœ“ On disk
        - Database: âœ“ Modified on disk
        - **Recovery:** Delete journal (committed)
      |
      style.fill: "#ACE1AF"
      style.border-radius: 8
    }
    crash_after_journal -> crash_after_db
  }
  timeline_correct -> crash_scenarios_correct: {
    style.stroke-dash: 3
    style.stroke: "#666"
  }
}
# ============================================
# INCORRECT ORDERING (RIGHT SIDE)
# ============================================
incorrect: {
  label: "âœ— INCORRECT ORDERING\nDatabase write BEFORE journal fsync"
  timeline_incorrect: {
    direction: down
    grid-gap: 0
    step1_bad: {
      label: "1. Write Journal"
      style.fill: "#E4DBFE"
      style.stroke: "#88DCF7"
      style.stroke-width: 2
    }
    step2_bad: {
      label: "2. Write Database"
      style.fill: "#FFCDD2"
      style.stroke: "#F44336"
      style.stroke-width: 3
      style.bold: true
    }
    step3_bad: {
      label: "3. fsync(database)"
      style.fill: "#FFE7CB"
      style.stroke: "#FF9800"
      style.stroke-width: 2
    }
    step4_bad: {
      label: "4. fsync(journal)"
      style.fill: "#FFF9C9"
      style.stroke: "#FFC107"
      style.stroke-width: 2
    }
    step1_bad -> step2_bad: "DANGER:\nmodified pages"
    step2_bad -> step3_bad: "changes\non disk"
    step3_bad -> step4_bad: "too late!"
  }
  crash_scenarios_incorrect: {
    direction: down
    label: "Crash Scenarios"
    danger_zone: {
      label: |md
        **âš ï¸ DANGER ZONE**
        **Crash between steps 2-4:**
        - Journal: NOT on disk (in OS cache)
        - Database: MODIFIED on disk
        - **Recovery:** IMPOSSIBLE!
        Original page data is LOST.
        Database is CORRUPTED.
      |
      style.fill: "#FFCDD2"
      style.stroke: "#D32F2F"
      style.stroke-width: 3
      style.border-radius: 8
    }
    corruption_example: {
      label: |md
        **Example: Money Transfer**
        Original: Alice=$100, Bob=$0
        Intent: Alice â†’ Bob $50
        After crash:
        - Alice: $50 (database modified)
        - Bob: $0 (not yet updated)
        - Journal: LOST
        **$50 destroyed. No recovery.**
      |
      style.fill: "#FFE0B2"
      style.stroke: "#E65100"
      style.border-radius: 8
    }
    danger_zone -> corruption_example
  }
  timeline_incorrect -> crash_scenarios_incorrect: {
    style.stroke-dash: 3
    style.stroke: "#D32F2F"
  }
}
# ============================================
# CENTER COMPARISON
# ============================================
vs_node: {
  shape: diamond
  label: "vs"
  style.fill: "#333"
  style.font-color: white
  style.stroke: "#666"
  style.stroke-width: 2
  width: 60
  height: 60
}
correct -> vs_node -> incorrect: {
  style.stroke-width: 2
  style.stroke: "#333"
}
# ============================================
# KEY INSIGHT BOX
# ============================================
insight: {
  label: |md
    ## ðŸ”‘ The Key Insight
    **fsync is not about performance â€” it's about CORRECTNESS.**
    The OS caches writes in RAM. A power failure loses everything in RAM.
    Without fsync, your "committed" transaction might not survive a crash.
    **The ordering rule:**
    > Journal MUST be on disk BEFORE any database page it protects is modified.
    This is the foundation of **Write-Ahead Logging (WAL)** protocols.
  |
  style.fill: "#E3F2FD"
  style.stroke: "#1976D2"
  style.stroke-width: 2
  style.border-radius: 12
  near: bottom-center
}
# ============================================
# LATENCY CONTEXT
# ============================================
latency_context: {
  direction: right
  label: "Why This Matters: Latency Context"
  operations: {
    direction: down
    grid-columns: 2
    grid-gap: 0
    op1: "write() syscall\n~0.001ms"
    op2: "fsync() on SSD\n~1-5ms"
    op3: "fsync() on HDD\n~10-50ms"
    op4: "Power failure\n~instant"
    op1.style.fill: "#E8F5E9"
    op2.style.fill: "#FFF3E0"
    op3.style.fill: "#FFEBEE"
    op4.style.fill: "#212121"
    op4.style.font-color: white
  }
  explanation: {
    label: |md
      **fsync is expensive** (milliseconds),
      but **data loss is catastrophic**.
      The 1-5ms cost of fsync is the
      price of ACID durability.
    |
    style.fill: "#FFF8E1"
    style.border-radius: 8
  }
  operations -> explanation
}
insight -> latency_context: {
  style.stroke-dash: 2
  style.stroke: "#1976D2"
}