vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  milestone_box: {
    style: {
      stroke-width: 2
      border-radius: 8
    }
  }
  memory_segment: {
    style: {
      fill: "#e1f5fe"
      stroke: "#01579b"
      font: mono
    }
  }
  microscope: {
    style: {
      stroke-dash: 3
      fill: "#fffde7"
    }
  }
}

title: "THE GRAND SYNTHESIS: LIFE OF A SQLITE QUERY" {
  shape: text
  style: {
    font-size: 32
    bold: true
  }
}

"User Interface": {
  user: "Systems Programmer" {
    shape: person
  }
  repl: "REPL Gateway" {
    link: "#milestone-1"
    class: milestone_box
    input_buffer: "InputBuffer struct" {
      class: memory_segment
      label: |md
        c
        char* buffer;
        size_t len;
        
      |
    }
  }
  user -> repl.input_buffer: "UPDATE users SET pts=10..."
}

"Compiler Layer": {
  tokenizer: "Tokenizer (Lexer)" {
    link: "#milestone-2"
    class: milestone_box
    state_machine: "State Machine" {
      class: microscope
      "S0" -> "S1": "'U'"
      "S1" -> "S2": "'P'"
      "S2" -> "TOKEN_UPDATE"
    }
  }

  parser: "Parser & Optimizer" {
    link: "#milestone-5"
    class: milestone_box
    ast: "Abstract Syntax Tree" {
      shape: cloud
      "UPDATE" -> "SET"
      "UPDATE" -> "WHERE"
    }
  }

  "User Interface".repl -> tokenizer: "Raw String Stream"
  tokenizer -> parser: "Token Stream"
}

"Virtual Machine (VDBE)": {
  link: "#milestone-3"
  class: milestone_box
  
  registers: "Register File" {
    grid-columns: 2
    r0: "0x0A (10)" {class: memory_segment}
    r1: "0x05 (ID)" {class: memory_segment}
    r2: "Cursor_Ptr" {class: memory_segment}
    r3: "Page_Ref" {class: memory_segment}
  }

  bytecode: "Opcode Execution" {
    shape: step
    "0: Transaction"
    "1: VerifyCookie"
    "2: OpenWrite"
    "3: Found"
  }
  
  "Compiler Layer".parser -> bytecode: "Compiled Bytecode"
}

"Storage & Pager": {
  link: "#milestone-4"
  pager: "Pager (Cache Manager)" {
    class: milestone_box
    page_cache: "Page Cache (RAM)" {
      page_1: "Root Node" {style.fill: "#c8e6c9"}
      page_2: "Internal Node" {style.fill: "#c8e6c9"}
      page_5: "Leaf (Target)" {
        style.fill: "#ffccbc"
        style.double-border: true
      }
    }
  }

  btree: "B-Tree (Warehouse)" {
    node_microscope: "Node Layout (4KB)" {
      class: microscope
      header: "Header (Flags/Pointers)"
      cell_ptr: "Cell Pointers"
      free_space: "Unallocated" {style.opacity: 0.5}
      content: "Record Payload"
      header -> cell_ptr -> content
    }
  }

  "Virtual Machine (VDBE)".bytecode -> pager: "Page Request (ID: 5)"
  pager -> btree: "B-Tree Traversal"
}

"Journaling (WAL)": {
  link: "#milestone-6"
  wal_file: "Write-Ahead Log" {
    shape: queue
    frame_1: "Page 5 (Old)"
    frame_2: "Page 5 (New)"
    frame_3: "Commit Marker" {style.fill: "#ffecb3"}
  }

  fsync: "OS Fsync Barrier" {
    shape: diamond
    style.fill: "#f44336"
    style.font-color: white
  }

  "Storage & Pager".pager -> wal_file: "Append Frame"
  wal_file -> fsync: "Atomic Durability"
}

"Disk Platter": {
  shape: cylinder
  style.fill: "#37474f"
  style.font-color: white
  db_file: "main.sqlite"
}

"Journaling (WAL)".fsync -> "Disk Platter": "Physical Flush"

# Connections across layers
"Virtual Machine (VDBE)".registers -> "Storage & Pager".pager: "Cursor Read/Write"
"Storage & Pager".pager.page_cache.page_5 -> "Journaling (WAL)".wal_file: "Dirty Page Dirty"

legend: {
  shape: package
  near: bottom-right
  "Logical Flow": {style.stroke: black}
  "Memory Map": {class: memory_segment}
  "Hardware Sync": {style.stroke: red; style.animated: true}
}

( "Journaling (WAL)".fsync -> "Disk Platter" )[0].style: {
  stroke: red
  stroke-width: 4
  animated: true
}

# Documentation linking notes
repl.tooltip: "Click to explore Milestone 1: The Gateway"
tokenizer.tooltip: "Click to explore Milestone 2: The Architect"
bytecode.tooltip: "Click to explore Milestone 3: The Engine"
pager.tooltip: "Click to explore Milestone 4: The Warehouse"
parser.tooltip: "Click to explore Milestone 5: The Strategist"
wal_file.tooltip: "Click to explore Milestone 6: The Protector"