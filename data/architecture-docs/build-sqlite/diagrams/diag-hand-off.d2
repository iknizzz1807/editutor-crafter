vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

classes: {
  milestone_container: {
    style: {
      stroke-width: 2
      border-radius: 8
      shadow: true
    }
  }
  memory_block: {
    style: {
      font: mono
      fill: "#f5f5f5"
      stroke-dash: 2
    }
  }
  handoff_label: {
    style: {
      font-size: 14
      italic: true
      font-color: "#2e7d32"
      bold: true
    }
  }
  ownership_tag: {
    shape: text
    style: {
      font-size: 10
      font-color: "#d32f2f"
    }
  }
}

# --- MILESTONE 2: THE ARCHITECT (PARSER) ---
M2: "Milestone 2: The Architect" {
  class: milestone_container
  link: "#milestone-2"
  
  sql_buffer: |'md
    ### Memory: Input String
    `0x55 AA ...`
    "UPDATE users SET pts = 10"
  '| {
    shape: rectangle
    style.fill: "#fff3e0"
  }

  ast: "Abstract Syntax Tree (AST)" {
    shape: cloud
    root -> update_node
    update_node -> table_id
    update_node -> set_list
    set_list -> assignment
  }

  sql_buffer -> ast: "Lexical Scan & Parse"
  
  tag: "OWNER: REPL/Parser" { class: ownership_tag }
}

# --- HANDOFF: AST TO BYTECODE ---
M2.ast -> M3.bytecode_program: "Code Generation (Compiler)" {
  class: handoff_label
}

# --- MILESTONE 3: THE ENGINE (VDBE) ---
M3: "Milestone 3: The Engine" {
  class: milestone_container
  link: "#milestone-3"

  bytecode_program: {
    shape: sql_table
    label: "VDBE Program (OpCodes)"
    0: "Transaction  | 0 | 1 | 0"
    1: "VerifyCookie | 0 | 40 | 0"
    2: "Integer      | 10 | 1 | 0  # Val -> R1"
    3: "Column       | 0 | 2 | 2   # Col2 -> R2"
    4: "Halt         | 0 | 0 | 0"
  }

  registers: "VDBE Register Set" {
    grid-rows: 1
    r0: "NULL" { class: memory_block }
    r1: "10 (int)" { class: memory_block; style.fill: "#bbdefb" }
    r2: "'Alice' (str)" { class: memory_block; style.fill: "#bbdefb" }
  }

  bytecode_program -> registers: "VM Execution Cycle"
  
  tag: "OWNER: VDBE Runtime" { class: ownership_tag }
}

# --- HANDOFF: REGISTERS TO SERIALIZER ---
M3.registers -> M7.record_builder: "Register-to-Payload" {
  class: handoff_label
}

# --- MILESTONE 7: THE ASSEMBLY LINE (SERIALIZER) ---
M7: "Milestone 7: The Assembly Line" {
  class: milestone_container
  link: "#milestone-7"

  record_builder: "Row Serialization (Compact Format)" {
    grid-columns: 1
    
    header: "Header Area (Manifest)" {
      grid-rows: 1
      h_len: "0x03" { tooltip: "Total Header Length" }
      t1: "0x01" { tooltip: "Type: 1-byte Int" }
      t2: "0x0C" { tooltip: "Type: String (Len 5)" }
      style.fill: "#e8f5e9"
    }

    payload: "Payload Area (Data)" {
      grid-rows: 1
      d1: "0x0A" { tooltip: "Value: 10" }
      d2: "41 6C 69 63 65" { tooltip: "Value: 'Alice'" }
      style.fill: "#c8e6c9"
    }
    
    header -> payload: "Contiguous Memory"
  }

  tag: "OWNER: Serializer Buffer" { class: ownership_tag }
}

# --- HANDOFF: RECORD TO PAGER ---
M7.record_builder -> M4.page_structure.cells.row_5: "Page Packing" {
  class: handoff_label
}

# --- MILESTONE 4: THE WAREHOUSE (PAGER/B-TREE) ---
M4: "Milestone 4: The Warehouse" {
  class: milestone_container
  link: "#milestone-4"

  page_structure: "B-Tree Leaf Page (4096 Bytes)" {
    header: "Page Header (12 bytes)" { style.fill: "#e1f5fe" }
    
    cell_ptrs: "Cell Pointers [0x0FE2, ...]" {
      grid-rows: 1
      p1: "PTR_1"
      p2: "PTR_2"
      style.fill: "#b3e5fc"
    }

    free_space: "Unallocated (Gap)" {
      style: {
        fill: transparent
        stroke-dash: 5
      }
    }

    cells: "Cell Content (Bottom-Up)" {
      row_5: "New Record (M7 Output)" { style.fill: "#81c784" }
      row_4: "Record ID: 4"
      row_3: "Record ID: 3"
    }
  }
  
  tag: "OWNER: Page Cache (RAM)" { class: ownership_tag }
}

# --- PERSISTENCE LAYER ---
M4.page_structure -> disk: "Milestone 6: fsync()" {
  link: "#milestone-6"
  style: {
    stroke-width: 4
    animated: true
  }
}

disk: "Persistent Storage (.db file)" {
  shape: cylinder
  style.fill: "#455a64"
  style.font-color: white
}

# --- GLOBAL SUMMARY ---
summary: |'md
  ### THE MILESTONE HANDOFF: DATA OWNERSHIP
  
  | Phase | Data Structure | Memory Location |
  | :--- | :--- | :--- |
  | **M2 (Architect)** | Raw SQL String | Heap (Input Buffer) |
  | **M3 (Engine)** | Register Set | Stack/VM Internal |
  | **M7 (Assembly)** | Byte Stream | Temp Serialization Buffer |
  | **M4 (Warehouse)** | 4KB Page Buffer | Pager Cache (RAM) |
'| {
  near: bottom-center
  style: {
    fill: "#fefefe"
    stroke: "#2e7d32"
    border-radius: 4
  }
}