vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right
title: |md
  # HAVING vs WHERE: Filter Timing
  **WHERE filters rows â€¢ HAVING filters groups**
| {near: top-center}
before_section: {
  label: "Input: products table\n(6 rows)"
  raw_data: {
    shape: sql_table
    id: int {constraint: primary_key}
    category: text
    price: real
    style.fill: "#E8E8E8"
  }
  note1: |md
    id | category | price
    1  | A        | 10
    2  | A        | NULL
    3  | B        | 50
    4  | B        | 30
    5  | C        | 5
    6  | C        | 15
  |
}
where_path: {
  label: "WHERE Clause Path"
  style.fill: "#E3F2FD"
  style.stroke: "#1565C0"
  step1_where: {
    label: "1. WHERE price > 20"
    style.fill: "#BBDEFB"
    filtered_rows: {
      shape: sql_table
      id: int
      category: text
      price: real
      style.fill: "#90CAF9"
    }
    note: |md
      id | category | price
      3  | B        | 50
      4  | B        | 30
      **2 rows survive**
      âŒ Rows 1,2,5,6 filtered
      âœ… NULL prices excluded
    |
  }
  step2_group: {
    label: "2. GROUP BY category"
    style.fill: "#BBDEFB"
    groups: {
      shape: rectangle
      label: "Hash Table\n\nB â†’ [row3, row4]"
      style.fill: "#90CAF9"
    }
    note: |md
      Only 1 group:
      - **B**: 2 rows
      Groups A and C were
      eliminated by WHERE
    |
  }
  step1_where -> step2_group: {
    label: "Surviving rows"
    style.stroke: "#1565C0"
    style.stroke-width: 2
  }
  step3_agg: {
    label: "3. Aggregate"
    style.fill: "#BBDEFB"
    result: {
      shape: rectangle
      label: "category | COUNT | SUM\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nB         | 2      | 80"
      style.fill: "#90CAF9"
    }
  }
  step2_group -> step3_agg: {
    label: "Groups"
    style.stroke: "#1565C0"
    style.stroke-width: 2
  }
  error_box: {
    shape: rectangle
    label: |md
      ## âŒ INVALID SYNTAX
      `WHERE COUNT(*) > 1`
      **Error:** Aggregate functions
      not allowed in WHERE clause!
      WHERE runs BEFORE grouping,
      so COUNT(*) doesn't exist yet.
    |
    style.fill: "#FFCDD2"
    style.stroke: "#C62828"
    style.stroke-width: 2
  }
}
having_path: {
  label: "HAVING Clause Path"
  style.fill: "#E8F5E9"
  style.stroke: "#2E7D32"
  h_step1_group: {
    label: "1. GROUP BY category\n(No WHERE filter)"
    style.fill: "#C8E6C9"
    h_groups: {
      shape: rectangle
      label: "Hash Table\n\nA â†’ [row1, row2]\nB â†’ [row3, row4]\nC â†’ [row5, row6]"
      style.fill: "#A5D6A7"
    }
    h_note: |md
      All 3 groups formed:
      - **A**: 2 rows
      - **B**: 2 rows  
      - **C**: 2 rows
    |
  }
  h_step2_agg: {
    label: "2. Compute Aggregates\nper group"
    style.fill: "#C8E6C9"
    h_result: {
      shape: rectangle
      label: "category | COUNT | SUM(price)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nA         | 2      | 10\nB         | 2      | 80\nC         | 2      | 20"
      style.fill: "#A5D6A7"
    }
  }
  h_step1_group -> h_step2_agg: {
    label: "All groups"
    style.stroke: "#2E7D32"
    style.stroke-width: 2
  }
  h_step3_having: {
    label: "3. HAVING SUM(price) > 15"
    style.fill: "#C8E6C9"
    h_filtered: {
      shape: rectangle
      label: "category | COUNT | SUM\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nB         | 2      | 80\nC         | 2      | 20"
      style.fill: "#81C784"
    }
    h_note: |md
      âœ… B: SUM=80 > 15 â†’ KEEP
      âœ… C: SUM=20 > 15 â†’ KEEP
      âŒ A: SUM=10 â‰¤ 15 â†’ REMOVE
    |
  }
  h_step2_agg -> h_step3_having: {
    label: "Grouped data\nwith aggregates"
    style.stroke: "#2E7D32"
    style.stroke-width: 2
  }
}
insight: {
  shape: rectangle
  label: |md
    ## ðŸŽ¯ The Critical Difference
    | Clause | Operates On | Can Use Aggregates? | Timing |
    |--------|-------------|---------------------|--------|
    | **WHERE** | Individual rows | âŒ NO | Before GROUP BY |
    | **HAVING** | Groups | âœ… YES | After GROUP BY |
    sql
    -- âœ… CORRECT: Filter rows first, then groups
    SELECT category, SUM(price)
    FROM products
    WHERE price IS NOT NULL      -- Row-level filter
    GROUP BY category
    HAVING SUM(price) > 15;      -- Group-level filter
    -- âŒ WRONG: Aggregate in WHERE
    SELECT category
    FROM products
    WHERE COUNT(*) > 1;          -- SYNTAX ERROR!
    
  |
  style.fill: "#FFF9C4"
  style.stroke: "#F9A825"
  style.stroke-width: 2
  near: bottom-center
}
before_section -> where_path: "WHERE\nPath" {
  style.stroke: "#1565C0"
  style.stroke-width: 3
  style.animated: true
}
before_section -> having_path: "HAVING\nPath" {
  style.stroke: "#2E7D32"
  style.stroke-width: 3
  style.animated: true
}
timeline: {
  near: bottom-right
  shape: text
  label: |md
    ### Execution Order
    FROM/JOIN â†’ WHERE â†’ GROUP BY â†’ HAVING â†’ SELECT â†’ ORDER BY
                    â†‘                      â†‘
               Row filter            Group filter
            (no aggregates)       (aggregates OK)
  |
}