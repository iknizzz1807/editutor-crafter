vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Index Lookup: The Double Lookup Pattern
| {near: top-center}

legend: |md
  **Legend**
  - ðŸ”µ Blue arrows: Index traversal path
  - ðŸŸ¢ Green arrows: Table lookup path
  - Page count: Pages touched at each step
| {near: bottom-center}

direction: right

query_flow: {
  label: "Query: SELECT * FROM users\nWHERE email = 'alice@example.com'"
  style.fill: "#E8F4FD"
  style.stroke: "#2196F3"
  style.stroke-width: 2
  
  step1: "1. Search Index"
  step2: "2. Get Rowid"
  step3: "3. Fetch Row"
  
  step1 -> step2 -> step3: "â†’"
}

index_btree: "Index B+tree\n(idx_email)" {
  style.fill: "#E3F2FD"
  style.stroke: "#1976D2"
  
  root: "Root Page\n(Page 10)" {
    style.fill: "#BBDEFB"
    entries: |md
      'alice@...' â†’ Page 15
      'bob@...' â†’ Page 16
      'charlie@...' â†’ Page 17
    |
  }
  
  leaf: "Leaf Page\n(Page 15)" {
    style.fill: "#90CAF9"
    result: |md
      **Found!**
      'alice@example.com' â†’ rowid: 42
    |
    style.stroke: "#1976D2"
    style.stroke-width: 3
  }
  
  root -> leaf: "Binary Search\nO(log n)"
}

table_btree: "Table B-tree\n(users table)" {
  style.fill: "#E8F5E9"
  style.stroke: "#388E3C"
  
  table_root: "Root Page\n(Page 2)" {
    style.fill: "#C8E6C9"
    entries: |md
      rowid 1-50 â†’ Page 5
      rowid 51-100 â†’ Page 6
    |
  }
  
  table_leaf: "Leaf Page\n(Page 5)" {
    style.fill: "#A5D6A7"
    result: |md
      **Row Found!**
      rowid: 42
      id: 42, name: 'Alice'
      email: 'alice@example.com'
    |
    style.stroke: "#388E3C"
    style.stroke-width: 3
  }
  
  table_root -> table_leaf: "Seek rowid 42"
}

query_flow.step1 -> index_btree.root: "Index\nLookup" {
  style.stroke: "#1976D2"
  style.stroke-width: 2
}

query_flow.step2 -> table_btree.table_root: "Table\nLookup" {
  style.stroke: "#388E3C"
  style.stroke-width: 2
}

index_btree.leaf -> table_btree.table_root: "rowid: 42" {
  style.stroke: "#FF9800"
  style.stroke-width: 2
  style.stroke-dash: 3
}

comparison: {
  near: bottom-right
  
  index_lookup: "Index Lookup\n(Selective Query)" {
    style.fill: "#C8E6C9"
    style.stroke: "#388E3C"
    
    pages: |md
      **Pages Touched: ~3-4**
      - Index root: 1 page
      - Index leaf: 1 page
      - Table root: 1 page
      - Table leaf: 1 page
      
      **Total: 4 page reads**
    |
  }
  
  table_scan: "Full Table Scan\n(Non-Selective Query)" {
    style.fill: "#FFCDD2"
    style.stroke: "#D32F2F"
    
    pages2: |md
      **Pages Touched: ~10,000**
      - All leaf pages: 10,000+
      - Internal pages: ~50
      
      **Total: ~10,050 page reads**
    |
  }
  
  note: |md
    **Key Insight:**
    Index wins when selectivity < 20%
    (less than 20% of rows match)
    
    For 1 row in 1 million:
    - Index: 4 pages âœ“
    - Scan: 50,000 pages âœ—
  | {
    style.fill: "#FFF9C4"
    style.stroke: "#F9A825"
  }
}