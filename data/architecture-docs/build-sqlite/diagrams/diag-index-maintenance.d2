vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # INSERT: Index Maintenance
  Write Amplification Visualization
| {near: top-center}
direction: right
classes: {
  table: {
    style: {
      fill: "#E8F5E9"
      stroke: "#2E7D32"
      stroke-width: 2
      border-radius: 4
    }
  }
  index: {
    style: {
      fill: "#E3F2FD"
      stroke: "#1565C0"
      stroke-width: 2
      border-radius: 4
    }
  }
  row: {
    shape: rectangle
    style: {
      fill: "#C8E6C9"
      stroke: "#388E3C"
      stroke-width: 1
    }
  }
  entry: {
    shape: rectangle
    style: {
      fill: "#BBDEFB"
      stroke: "#1976D2"
      stroke-width: 1
    }
  }
  operation: {
    shape: diamond
    style: {
      fill: "#FFF3E0"
      stroke: "#E65100"
      stroke-width: 2
    }
  }
  complete: {
    style: {
      fill: "#E8F5E9"
      stroke: "#2E7D32"
      stroke-width: 3
      bold: true
    }
  }
}
before: "BEFORE: Empty State" {
  table_btree: "Table B-tree\n(users table)" {
    class: table
    root_page: "Page 1 (root)\n[empty]" {
      class: row
      style.fill: "#F5F5F5"
      style.stroke: "#9E9E9E"
    }
  }
  idx_email: "Index B+tree\n(idx_email)" {
    class: index
    root_page: "Page 5 (root)\n[empty]" {
      class: entry
      style.fill: "#F5F5F5"
      style.stroke: "#9E9E9E"
    }
  }
  idx_status: "Index B+tree\n(idx_status)" {
    class: index
    root_page: "Page 8 (root)\n[empty]" {
      class: entry
      style.fill: "#F5F5F5"
      style.stroke: "#9E9E9E"
    }
  }
}
arrow1: "INSERT INTO users\nVALUES (42, 'alice@email.com', 'active')" {
  shape: text
  style: {
    font-size: 14
    bold: true
  }
}
step1: "Step 1: Table Insert" {
  operation_node: "INSERT\nRow" {class: operation}
  table_btree: "Table B-tree\n(users)" {
    class: table
    root_page: "Page 1 (root)" {
      class: row
      row_data: ||md
        **Row Data:**
        rowid: 42
        id: 42
        email: 'alice@email.com'
        status: 'active'
      ||
      style.fill: "#C8E6C9"
    }
  }
  idx_email: "Index B+tree\n(idx_email)" {
    class: index
    root_page: "Page 5\n[still empty]" {
      class: entry
      style.fill: "#F5F5F5"
      style.stroke-dash: 3
      style.opacity: 0.5
    }
  }
  idx_status: "Index B+tree\n(idx_status)" {
    class: index
    root_page: "Page 8\n[still empty]" {
      class: entry
      style.fill: "#F5F5F5"
      style.stroke-dash: 3
      style.opacity: 0.5
    }
  }
  write1: "Write #1" {
    shape: text
    style.font-color: "#E65100"
    style.bold: true
  }
}
step2: "Step 2: Index 1 Insert" {
  operation_node: "INSERT\n(email, rowid)" {class: operation}
  table_btree: "Table B-tree" {
    class: table
    root_page: "Page 1" {
      class: row
      row_data: ||md
        rowid: 42
        email: 'alice@email.com'
        status: 'active'
      ||
      style.fill: "#C8E6C9"
    }
  }
  idx_email: "Index B+tree\n(idx_email)" {
    class: index
    root_page: "Page 5 (root)" {
      class: entry
      entry_data: ||md
        **Index Entry:**
        key: 'alice@email.com'
        rowid: 42
      ||
      style.fill: "#BBDEFB"
    }
  }
  idx_status: "Index B+tree\n(idx_status)" {
    class: index
    root_page: "Page 8\n[still empty]" {
      class: entry
      style.fill: "#F5F5F5"
      style.stroke-dash: 3
      style.opacity: 0.5
    }
  }
  write2: "Write #2" {
    shape: text
    style.font-color: "#E65100"
    style.bold: true
  }
}
step3: "Step 3: Index 2 Insert" {
  operation_node: "INSERT\n(status, rowid)" {class: operation}
  table_btree: "Table B-tree" {
    class: table
    root_page: "Page 1" {
      class: row
      row_data: ||md
        rowid: 42
        email: 'alice@email.com'
        status: 'active'
      ||
      style.fill: "#C8E6C9"
    }
  }
  idx_email: "Index B+tree\n(idx_email)" {
    class: index
    root_page: "Page 5" {
      class: entry
      entry_data: ||md
        key: 'alice@email.com'
        rowid: 42
      ||
      style.fill: "#BBDEFB"
    }
  }
  idx_status: "Index B+tree\n(idx_status)" {
    class: index
    root_page: "Page 8 (root)" {
      class: entry
      entry_data: ||md
        **Index Entry:**
        key: 'active'
        rowid: 42
      ||
      style.fill: "#BBDEFB"
    }
  }
  write3: "Write #3" {
    shape: text
    style.font-color: "#E65100"
    style.bold: true
  }
}
after: "AFTER: Transaction Complete" {
  class: complete
  summary: ||md
    ## Write Amplification Summary
    | Operation | B-tree Writes | Pages Modified |
    |-----------|---------------|----------------|
    | Table INSERT | 1 | 1 |
    | idx_email INSERT | 1 | 1 |
    | idx_status INSERT | 1 | 1 |
    | **Total** | **3** | **3** |
    **Amplification Factor: 3x**
    For a table with **N indexes**, each INSERT requires **N+1** B-tree operations.
  ||
}
before -> step1: "Begin\nTransaction" {
  style: {
    stroke: "#1565C0"
    stroke-width: 2
    animated: true
  }
}
step1 -> step2: "Table write\ncomplete" {
  style: {
    stroke: "#2E7D32"
    stroke-width: 2
  }
}
step2 -> step3: "idx_email\ncomplete" {
  style: {
    stroke: "#1976D2"
    stroke-width: 2
  }
}
step3 -> after: "All indexes\nupdated" {
  style: {
    stroke: "#2E7D32"
    stroke-width: 3
    animated: true
  }
}
step1.operation_node -> step1.table_btree.root_page: "Page write" {
  style.stroke: "#E65100"
  style.stroke-width: 2
}
step2.operation_node -> step2.idx_email.root_page: "Page write" {
  style.stroke: "#E65100"
  style.stroke-width: 2
}
step3.operation_node -> step3.idx_status.root_page: "Page write" {
  style.stroke: "#E65100"
  style.stroke-width: 2
}
legend: {
  near: bottom-right
  legend_box: {
    grid-rows: 4
    grid-gap: 8
    table_legend: "Table B-tree" {
      style.fill: "#E8F5E9"
      width: 120
    }
    index_legend: "Index B+tree" {
      style.fill: "#E3F2FD"
      width: 120
    }
    operation_legend: "Write Operation" {
      style.fill: "#FFF3E0"
      width: 120
    }
    cost_legend: ||md
      **Cost Model:**
      - Sequential I/O: 1x
      - Random I/O: 4x
      - Each B-tree op: ~1-3 page writes
    ||
    cost_legend.width: 200
  }
}