vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header-bg: "#E8E8E8"
    index-node: "#C5E1FF"
    index-leaf: "#B5FFB5"
    table-page: "#FFE4B5"
    highlight: "#FF6B6B"
    arrow-blue: "#2196F3"
    arrow-green: "#4CAF50"
    arrow-orange: "#FF9800"
  }
}
title: |md
  # Secondary Index: B+tree Structure
  ### Index stores (column_value, rowid) pairs | Leaves linked for range scans
| {near: top-center}
direction: right
index_btree: {
  label: "Index B+tree\n(idx_users_email)"
  root: {
    label: "Internal Node\n(Page 10)"
    style.fill: ${colors.index-node}
    sep_m: |md
      Separator: 'm'
      (50-64 byte offset)
    |
    sep_m.shape: text
    child_ptr_d: |md
      Child Ptr: 20
      (4 bytes, big-endian)
    |
    child_ptr_d.shape: text
    child_ptr_t: |md
      Child Ptr: 30
      (4 bytes, big-endian)
    |
    child_ptr_t.shape: text
  }
  level_1_left: {
    label: "Internal Node\n(Page 20)"
    style.fill: ${colors.index-node}
    sep_d: |md
      Sep: 'd'
    |
    sep_d.shape: text
  }
  level_1_right: {
    label: "Internal Node\n(Page 30)"
    style.fill: ${colors.index-node}
    sep_t: |md
      Sep: 't'
    |
    sep_t.shape: text
  }
  leaf_alice: {
    label: "Leaf Page 40\n(Linked List Node)"
    style.fill: ${colors.index-leaf}
    header: {
      label: |md
        **Page Header** (8 bytes)
        - Type: 0x0A (index leaf)
        - Cell Count: 3
        - Right Sibling: 41
      |
      shape: rectangle
      style.fill: ${colors.header-bg}
    }
    cell_ptr_array: {
      label: |md
        **Cell Pointer Array**
        Offset[0]: 4080 -> Cell 0
        Offset[1]: 4064 -> Cell 1
        Offset[2]: 4048 -> Cell 2
      |
      shape: rectangle
      style.fill: "#F5F5F5"
    }
    cell_0: {
      label: |md
        **Cell 0** (23 bytes)
        Payload Size (varint): 19
        Key: 'alice@ex.com' (13B)
        Rowid (varint): 1
      |
      shape: rectangle
      style.fill: "#E8F5E9"
    }
    cell_1: {
      label: |md
        **Cell 1** (19 bytes)
        Payload Size: 15
        Key: 'bob@mail.com' (11B)
        Rowid: 2
      |
      shape: rectangle
      style.fill: "#E8F5E9"
    }
    cell_2: {
      label: |md
        **Cell 2** (20 bytes)
        Payload Size: 16
        Key: 'carol@site.org' (12B)
        Rowid: 3
      |
      shape: rectangle
      style.fill: "#E8F5E9"
    }
    free_space: {
      label: |md
        **Free Space**
        (4048 - Header - Pointers)
      |
      shape: rectangle
      style.fill: "#FAFAFA"
      style.stroke-dash: 3
    }
  }
  leaf_dave: {
    label: "Leaf Page 41\n(Linked List Node)"
    style.fill: ${colors.index-leaf}
    header_d: {
      label: |md
        **Page Header** (8 bytes)
        - Right Sibling: 42
      |
      shape: rectangle
      style.fill: ${colors.header-bg}
    }
    cell_dave: {
      label: |md
        **Cell 0**
        Key: 'dave@test.net'
        Rowid: 4
      |
      shape: rectangle
      style.fill: "#E8F5E9"
    }
    cell_eve: {
      label: |md
        **Cell 1**
        Key: 'eve@domain.io'
        Rowid: 5
      |
      shape: rectangle
      style.fill: "#E8F5E9"
    }
  }
  leaf_zoe: {
    label: "Leaf Page 42"
    style.fill: ${colors.index-leaf}
    cell_zoe: {
      label: |md
        Key: 'zoe@example.com'
        Rowid: 10
      |
      shape: rectangle
      style.fill: "#E8F5E9"
    }
  }
  root -> level_1_left: "lte m"
  root -> level_1_right: "gt m"
  level_1_left -> leaf_alice: "lte d"
  level_1_left -> leaf_dave: "gt d"
  level_1_right -> leaf_zoe: "gt t"
  leaf_alice -> leaf_dave: {
    label: "right_sibling\n(linked list)"
    style.stroke: ${colors.arrow-green}
    style.stroke-width: 3
  }
  leaf_dave -> leaf_zoe: {
    style.stroke: ${colors.arrow-green}
    style.stroke-width: 3
  }
}
lookup_flow: {
  label: |md
    ## Equality Lookup: 'bob@mail.com'
    1. **Root (Page 10)**: 'bob' < 'm' - go left
    2. **Internal (Page 20)**: 'bob' > 'd' - go right
    3. **Leaf (Page 40)**: Binary search cells
       - Cell 0: 'alice' < 'bob' - no match
       - Cell 1: 'bob' = 'bob' - MATCH!
    4. **Extract Rowid**: 2
    5. **Table Lookup**: Fetch rowid 2 from table B-tree
  |
  near: index_btree
  shape: rectangle
  style.fill: "#FFF9C4"
  style.stroke: "#FBC02D"
}
range_scan: {
  label: |md
    ## Range Scan: 'c' to 'm'
    1. **SeekGE('c')**: Traverse to first key >= 'c'
       - Lands on 'carol@site.org' in Page 40
    2. **Scan forward**: Follow right_sibling pointers
       - Page 40: 'carol', 'dave', 'eve' - in range
       - Page 41: 'frank', 'grace' - in range
       - Page 42: 'zoe' - out of range, stop
    3. **Result**: All entries in ['c', 'm'] range
       - No need to traverse tree again!
       - O(k) where k = entries in range
  |
  near: lookup_flow
  shape: rectangle
  style.fill: "#E3F2FD"
  style.stroke: ${colors.arrow-blue}
}
table_btree: {
  label: |md
    ## Table B-tree (users)
    After index lookup returns rowid:
    - SeekRowid cursor to rowid=2
    - Fetch complete row from table page
    - This is the "double lookup" pattern
    **Index Entry**: (email, rowid)
    **Table Row**: (id, name, email, age, ...)
    Only indexed column + rowid stored in index.
    Full row data remains in table B-tree.
  |
  shape: rectangle
  style.fill: ${colors.table-page}
  style.stroke: "#FF9800"
}
byte_layout: {
  label: |md
    ## Index Leaf Cell Byte Layout
    - Payload Size: varint (1-2 bytes)
    - Key Data: N bytes (serialized)
    - Rowid: varint (1-4 bytes)
    **Key Serialization**:
    - TEXT: UTF-8 bytes with length prefix
    - INTEGER: Variable-length encoding
    - NULL: Special marker (0x00)
    **Ordering**: Keys sorted in B-tree order
    (lexicographic for text, numeric for numbers)
  |
  shape: rectangle
  style.fill: "#FAFAFA"
  style.stroke: "#9E9E9E"
  style.font: mono
}
legend: {
  label: |md
    ### Legend
    - Blue: Internal index nodes
    - Green: Leaf pages (data storage)
    - Orange: Table B-tree reference
    - Arrow (solid): Tree traversal
    - Arrow (thick green): Leaf links (range scan)
  |
  shape: rectangle
  style.fill: "#FAFAFA"
}
lookup_flow -> table_btree: {
  label: "Double\nLookup"
  style.stroke: ${colors.arrow-orange}
  style.stroke-dash: 5
}