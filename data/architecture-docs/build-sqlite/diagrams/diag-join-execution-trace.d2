vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # JOIN Execution: Inner to Outer Row Mapping
| {near: top-center}

direction: right

classes: {
  table-box: {
    style: {
      fill: "#E8F4FD"
      stroke: "#2563EB"
      stroke-width: 2
      border-radius: 4
    }
  }
  header-cell: {
    style: {
      fill: "#3B82F6"
      font-color: white
      bold: true
    }
  }
  data-cell: {
    style: {
      fill: white
      stroke: "#BFDBFE"
    }
  }
  highlight-row: {
    style: {
      fill: "#FEF3C7"
      stroke: "#F59E0B"
      stroke-width: 2
    }
  }
  result-row: {
    style: {
      fill: "#D1FAE5"
      stroke: "#10B981"
      stroke-width: 2
    }
  }
  arrow-label: {
    style: {
      font-size: 14
      bold: true
    }
  }
}

left_table: customers {
  class: table-box
  
  header: {
    grid-columns: 2
    id_label: id {class: header-cell}
    name_label: name {class: header-cell}
  }
  
  row1: {
    grid-columns: 2
    r1_id: 1 {class: data-cell}
    r1_name: Alice {class: data-cell}
  }
  
  row2: {
    grid-columns: 2
    r2_id: 2 {class: highlight-row}
    r2_name: Bob {class: highlight-row}
  }
  
  row3: {
    grid-columns: 2
    r3_id: 3 {class: data-cell}
    r3_name: Charlie {class: data-cell}
  }
}

current_outer: |md
  **Outer Loop**
  Current: Row 2
  `c.id = 2`
  `c.name = 'Bob'`
| {
  style.fill: "#FEF3C7"
  style.stroke: "#F59E0B"
}

right_table: orders {
  class: table-box
  
  header: {
    grid-columns: 3
    oid_label: id {class: header-cell}
    cust_label: customer_id {class: header-cell}
    amt_label: amount {class: header-cell}
  }
  
  or1: {
    grid-columns: 3
    or1_id: 101 {class: data-cell}
    or1_cust: 1 {class: data-cell}
    or1_amt: 100 {class: data-cell}
  }
  
  or2: {
    grid-columns: 3
    or2_id: 102 {class: data-cell}
    or2_cust: 1 {class: data-cell}
    or2_amt: 200 {class: data-cell}
  }
  
  or3: {
    grid-columns: 3
    or3_id: 103 {class: highlight-row}
    or3_cust: 2 {class: highlight-row}
    or3_amt: 50 {class: highlight-row}
  }
  
  or4: {
    grid-columns: 3
    or4_id: 104 {class: highlight-row}
    or4_cust: 2 {class: highlight-row}
    or4_amt: 75 {class: highlight-row}
  }
}

current_inner: |md
  **Inner Loop**
  Scanning for matches
  `o.customer_id = 2`
| {
  style.fill: "#FEF3C7"
  style.stroke: "#F59E0B"
}

condition_check: JOIN Condition {
  style: {
    fill: "#F3E8FF"
    stroke: "#9333EA"
    stroke-width: 2
    border-radius: 8
  }
  
  cond_label: ||md
    **Evaluating:**
    `c.id = o.customer_id`
    
    `2 = 2` → ✓ **TRUE**
    Emit joined row
  ||
}

column_mapping: Column Mapping {
  style: {
    fill: "#ECFDF5"
    stroke: "#059669"
    stroke-width: 2
    border-radius: 8
  }
  
  map_label: ||md
    **Result Row Construction:**

    | Position | Source | Value |
    |----------|--------|-------|
    | 0 | c.id | 2 |
    | 1 | c.name | Bob |
    | 2 | o.id | 103 |
    | 3 | o.customer_id | 2 |
    | 4 | o.amount | 50 |
  ||
}

result_output: Output Row {
  class: result-row
  style: {
    border-radius: 8
  }
  
  out_label: ||md
    **Emitted Result:**
    `(2, 'Bob', 103, 2, 50)`
  ||
}

left_table -> current_outer: outer row context {class: arrow-label; style.stroke: "#F59E0B"}
current_outer -> condition_check: outer row {class: arrow-label; style.stroke: "#F59E0B"}
right_table -> current_inner: inner row context {class: arrow-label; style.stroke: "#F59E0B"}
current_inner -> condition_check: inner row {class: arrow-label; style.stroke: "#F59E0B"}
condition_check -> column_mapping: match {class: arrow-label; style.stroke: "#9333EA"}
column_mapping -> result_output: emit {class: arrow-label; style.stroke: "#10B981"}

legend: ||md
  ## Execution Trace
  
  1. **Outer loop** iterates customers table
  2. **Inner loop** scans orders for each customer
  3. **Condition check**: `c.id = o.customer_id`
  4. **Match found**: Construct combined row
  5. **Emit**: Send to result set
  
  **Complexity**: O(n × m) comparisons
  - n = rows in left table
  - m = rows in right table
|| {
  near: bottom-center
  style.fill: white
  style.stroke: "#6B7280"
  style.stroke-dash: 3
}