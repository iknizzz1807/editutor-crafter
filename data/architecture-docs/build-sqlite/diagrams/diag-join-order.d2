vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    fast: "#4ade80"
    slow: "#f87171"
    table_a: "#60a5fa"
    table_b: "#a78bfa"
    highlight: "#fbbf24"
    green: "#4ade80"
  }
}
title: |md
  # Join Order Impact: Why Order Matters
| {near: top-center}
direction: right
before: {
  label: "❌ SLOW: Large Table Outer"
  style.fill: "#fef2f2"
  style.stroke: "${colors.slow}"
  style.stroke-width: 3
  large_outer: "Orders\n1,000,000 rows" {
    shape: cylinder
    style.fill: "${colors.table_a}"
    style.font-color: white
    width: 160
    height: 120
  }
  inner_small: "Customers\n10,000 rows" {
    shape: cylinder
    style.fill: "${colors.table_b}"
    style.font-color: white
    width: 120
    height: 100
  }
  loop_label: "For EACH of 1M orders:\n  Scan 10K customers\n  = 10 BILLION comparisons" {
    shape: text
    style.font-color: "${colors.slow}"
    style.font-size: 14
  }
  large_outer -> inner_small: "Nested Loop\n1,000,000 × 10,000\n= O(N×M)" {
    style.stroke: "${colors.slow}"
    style.stroke-width: 3
    label.near: outside-bottom-center
  }
}
after: {
  label: "✓ FAST: Small Table Outer"
  style.fill: "#f0fdf4"
  style.stroke: "${colors.fast}"
  style.stroke-width: 3
  small_outer: "Customers\n10,000 rows" {
    shape: cylinder
    style.fill: "${colors.table_b}"
    style.font-color: white
    width: 120
    height: 100
  }
  inner_large: "Orders\n1,000,000 rows\n(+ index)" {
    shape: cylinder
    style.fill: "${colors.table_a}"
    style.font-color: white
    width: 160
    height: 120
  }
  fast_label: "For EACH of 10K customers:\n  Index seek in orders\n  = ~50K page reads total" {
    shape: text
    style.font-color: "${colors.green}"
    style.font-size: 14
  }
  small_outer -> inner_large: "Index Lookup\n10,000 × log(1M)\n≈ O(N log M)" {
    style.stroke: "${colors.fast}"
    style.stroke-width: 3
    label.near: outside-bottom-center
  }
}
before -> after: "Query Planner\nOptimization" {
  style.stroke: "${colors.highlight}"
  style.stroke-width: 4
  style.stroke-dash: 5
  label: "60x faster!\nSame query,\nsame data"
  label.near: outside-top-center
}
comparison: {
  near: bottom-center
  metrics: {
    grid-columns: 2
    grid-gap: 40
    slow_box: {
      label: "Large Outer"
      style.fill: "${colors.slow}"
      style.font-color: white
      slow_content: |md
        **Outer loop**: 1,000,000 iterations
        **Inner lookups**: 1M × full scan
        **Page reads**: ~3,000,000
        **Time**: ~30 seconds
      | {shape: text}
    }
    fast_box: {
      label: "Small Outer"
      style.fill: "${colors.fast}"
      style.font-color: white
      fast_content: |md
        **Outer loop**: 10,000 iterations
        **Inner lookups**: 10K × index seek
        **Page reads**: ~50,000
        **Time**: ~0.5 seconds
      | {shape: text}
    }
  }
}
key_insight: |md
  ### The Query Planner's Critical Decision
  The optimizer must estimate table sizes and choose the smaller table as the outer loop.
  With proper statistics (ANALYZE), it knows:
  - `customers` has 10,000 rows
  - `orders` has 1,000,000 rows
  - Index exists on `orders.customer_id`
  **Wrong order**: O(N × M) = O(10¹⁰) operations
  **Right order**: O(K × log M) = O(10⁴ × 20) = O(2×10⁵) operations
| {near: bottom-center}