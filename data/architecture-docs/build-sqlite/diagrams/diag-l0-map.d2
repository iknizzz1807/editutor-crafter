direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- GLOBAL STYLES & CLASSES ---
classes: {
  frontend: {
    style: {
      fill: "#E1F5FE"
      stroke: "#01579B"
      stroke-width: 2
    }
  }
  vm: {
    style: {
      fill: "#FFF3E0"
      stroke: "#E65100"
      stroke-width: 2
    }
  }
  storage: {
    style: {
      fill: "#E8F5E9"
      stroke: "#1B5E20"
      stroke-width: 2
    }
  }
  persistence: {
    style: {
      fill: "#F5F5F5"
      stroke: "#212121"
      stroke-width: 2
    }
  }
  milestone_link: {
    style: {
      font-color: "#0D47A1"
      bold: true
      italic: true
    }
  }
  metadata: {
    style: {
      fill: "#F3E5F5"
      stroke: "#4A148C"
      font-size: 10
    }
  }
}

# --- THE SATELLITE MAP (L0) ---

sql_input: "SQL Query String\n\"SELECT name FROM users...\"" {
  shape: text
  style.font-size: 18
  style.bold: true
}

# 1. FRONTEND: STRING TO PLAN
frontend: {
  class: frontend
  label: "FRONTEND: Query Compilation"

  tokenizer: "Lexer (M1)" {
    link: "#build-sqlite-m1"
    tooltip: "Converts stream of bytes to typed tokens using FSM."
  }
  parser: "Parser (M2)" {
    link: "#build-sqlite-m2"
    tooltip: "Recursive Descent + Pratt Parsing for AST generation."
  }
  planner: "Query Planner (M8)" {
    link: "#build-sqlite-m8"
    tooltip: "Cost-Based Optimizer (CBO) using table statistics."
  }
  compiler: "Bytecode Compiler (M3)" {
    link: "#build-sqlite-m3"
    tooltip: "Translates AST to VDBE Opcodes."
  }

  tokenizer -> parser: "Token Stream\n(TOKEN_SELECT, ID, ...)"
  parser -> planner: "Abstract Syntax Tree (AST)"
  planner -> compiler: "Optimized Logical Plan"
}

sql_input -> frontend.tokenizer

# 2. VDBE: THE VIRTUAL MACHINE
vdbe: {
  class: vm
  label: "VDBE: Virtual Database Engine"

  execution_loop: "Fetch-Decode-Execute (M3/M6)" {
    link: "#build-sqlite-m3"
  }
  
  registers: "Register File" {
    shape: sql_table
    reg_0: "Value A"
    reg_1: "Value B"
    reg_n: "..."
  }

  cursors: "Cursors (M6)" {
    link: "#build-sqlite-m6"
    tooltip: "Stateful pointers to B-Tree positions."
  }

  execution_loop <-> registers: "Read/Write"
  execution_loop -> cursors: "Control"
}

frontend.compiler -> vdbe.execution_loop: "Bytecode (Opcodes)\n(OpenRead, Rewind, Column, ...)"

# 3. BACKEND: STORAGE ENGINE
storage_engine: {
  class: storage
  label: "BACKEND: Storage Architecture"

  btree: "B-Tree / B+Tree (M5/M7)" {
    link: "#build-sqlite-m5"
    tooltip: "Clustered Table B-Trees & Secondary Indexes."
  }

  pager: "Pager (M4)" {
    link: "#build-sqlite-m4"
    tooltip: "Manages logical-to-physical page mapping."
  }

  buffer_pool: "Buffer Pool / Cache" {
    # FIX: "grid" is not a shape type. Grid layouts are defined by grid keywords.
    grid-columns: 4
    p1: "Page 1 (Pinned)" { style.fill: "#FFCDD2" }
    p2: "Page 2 (Dirty)" { style.fill: "#FFF9C4" }
    p3: "Page 3"
    p4: "Page 4"
  }

  btree -> pager: "Page Requests\n(Page ID, Lock Type)"
  pager <-> buffer_pool: "LRU Eviction / Flush"
}

vdbe.cursors -> storage_engine.btree: "Point Lookups / Range Scans"

# 4. PERSISTENCE: DISK I/O
disk_layer: {
  class: persistence
  label: "PERSISTENCE: OS File System"

  db_file: "Database File (.db)" {
    shape: cylinder
    tooltip: "Pages: [Header | Slotted Page Data]"
  }

  journal_mode: {
    rollback: "Rollback Journal (M9)" {
      link: "#build-sqlite-m9"
      style.stroke-dash: 3
    }
    wal: "Write-Ahead Log (M10)" {
      link: "#build-sqlite-m10"
      style.stroke-dash: 3
    }
  }

  vfs: "Virtual File System (VFS)" {
    tooltip: "Interface for OS-specific pread/pwrite/fsync."
  }
}

storage_engine.pager -> disk_layer.vfs: "Raw Page I/O"
disk_layer.vfs -> disk_layer.db_file: "pwrite/pread"
disk_layer.vfs -> disk_layer.journal_mode: "Sync Safety"

# --- ANNOTATIONS ---
legend: {
  near: bottom-right
  m1: "M1-M11: Milestone Deep-Dives" { class: milestone_link }
  blue: "Data Flow" { style.font-color: "#01579B" }
  purple: "Metadata/Control" { style.font-color: "#4A148C" }
}

# Cross-layer connections for clarity
storage_engine.btree -> frontend.planner: "Statistics (M8)\n(Cardinality/Selectivity)" {
  style: {
    stroke: "#4A148C"
    stroke-dash: 5
  }
}

storage_engine.pager -> disk_layer.journal_mode.rollback: "Original Page Backup"
disk_layer.journal_mode.wal -> storage_engine.pager: "Redo Log Recovery"