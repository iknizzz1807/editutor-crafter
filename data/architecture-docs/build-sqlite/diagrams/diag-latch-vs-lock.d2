vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  logical_node: {
    style: {
      fill: "#E3F2FD"
      stroke: "#1565C0"
      stroke-width: 2
      border-radius: 8
    }
  }
  physical_node: {
    style: {
      fill: "#F1F8E9"
      stroke: "#2E7D32"
      stroke-width: 2
      border-radius: 4
    }
  }
  danger_state: {
    style: {
      fill: "#FFEB3B"
      stroke: "#FBC02D"
      bold: true
    }
  }
  memory_block: {
    shape: cylinder
    style: {
      fill: "#FAFAFA"
      stroke: "#424242"
    }
  }
}

"CONCURRENCY ARCHITECTURE: LOCKS VS LATCHES": {
  link: "#milestone-9"

  "DATABASE LOGICAL LAYER": {
    class: logical_node
    label: "Logical Layer (Transactions)"
    link: "#milestone-9"

    "LOCK_MANAGER": {
      shape: sql_table
      label: "Global Lock Table"
      column_header: "Resource | Lock Type | Owner"
      row_1: "Row_55 | EXCLUSIVE (X) | Txn_A"
      row_2: "Row_99 | SHARED (S) | Txn_B"
      row_3: "Table_Metadata | INTENT (IS) | Txn_C"
    }

    "ROW_DATA_ABSTRACTION": {
      label: "Table: Users"
      row_55: "User: Dave | State: LOCKED" {
        style: {
          fill: "#FFCDD2"
          stroke: "#B71C1C"
        }
      }
      row_56: "User: Eve | State: FREE"
    }

    "LOCK_MANAGER".row_1 -> "ROW_DATA_ABSTRACTION".row_55: "Logical Protection" {
      style.stroke: "#1565C0"
      style.stroke-dash: 5
    }
  }

  "SYSTEM PHYSICAL LAYER": {
    class: physical_node
    label: "Physical Layer (RAM & CPU)"
    link: "#milestone-9"

    "PAGE_CACHE_RAM": {
      label: "Page Cache (Memory Segments)"
      
      "PAGE_0xAF12": {
        class: memory_block
        "HEADER": {
          "LATCH_BIT": "0x01 (BUSY)" {
            class: danger_state
          }
          "PIN_COUNT": "2"
        }
        "DATA_ARRAY": "[ 0x55, 0x44, 0x61, 0x76, 0x65, ... ]"
      }
    }

    "CPU_CORES": {
      "CORE_0": {
        shape: person
        label: "Core 0 (Writer)"
      }
      "CORE_1": {
        shape: person
        label: "Core 1 (Reader)"
      }
    }

    "CPU_CORES"."CORE_0" -> "PAGE_CACHE_RAM"."PAGE_0xAF12"."HEADER"."LATCH_BIT": "Atomic CAS Write" {
      style.stroke: "#2E7D32"
      style.animated: true
    }
    
    "CPU_CORES"."CORE_1" -> "PAGE_CACHE_RAM"."PAGE_0xAF12"."HEADER"."LATCH_BIT": "Spin-Wait Polling" {
      style.stroke: "#F57C00"
      style.stroke-dash: 2
    }
  }

  "DATABASE LOGICAL LAYER" -> "SYSTEM PHYSICAL LAYER": "Locks use Latches\nfor internal state" {
    style.stroke-width: 4
    style.font-size: 14
  }
}

"MICROSCOPE: ATOMIC CAS OPERATION": {
  link: "#milestone-9"
  label: "Microscope: Compare-And-Swap (CAS) State Transition"
  
  "BEFORE_TICK": {
    label: "State: T=0 (Evaluation)"
    "CPU_REGISTER": "Expected: 0"
    "NEW_VALUE": "Target: 1"
    
    "RAM_CELL": {
      shape: circle
      label: "Value: 0"
      style.fill: "#E0E0E0"
    }

    "CPU_REGISTER" -> "RAM_CELL": "Compare"
  }

  "TRANSITION": {
    shape: step
    label: "Hardware Atomic Match"
    style.fill: "#FFF9C4"
  }

  "AFTER_TICK": {
    label: "State: T+1 (Commit)"
    "CPU_STATUS": "ZF=1 (Success)"
    
    "RAM_CELL_UPDATED": {
      shape: circle
      label: "Value: 1"
      style.fill: "#C8E6C9"
    }

    "RAM_CELL_UPDATED" -> "CPU_STATUS": "Signal Completion"
  }

  "BEFORE_TICK" -> "TRANSITION" -> "AFTER_TICK": "One CPU Cycle" {
    style.stroke-width: 3
    style.animated: true
  }
}

"LOCK_VS_LATCH_SUMMARY": {
  near: bottom-center
  grid-columns: 2
  grid-gap: 50
  
  "LOCK_DEF": ||md
    ### SQL Lock (Logical)
    - **Scope**: Database Entities (Rows, Tables)
    - **Duration**: Transaction Lifetime
    - **Deadlocks**: Possible (Detection Required)
    - **Storage**: Lock Manager Hash Table
  || {
    style.fill: "#E3F2FD"
  }

  "LATCH_DEF": ||md
    ### Latch/Mutex (Physical)
    - **Scope**: Internal Structures (Pages, Buffers)
    - **Duration**: Microseconds
    - **Deadlocks**: Impossible (Strict Order)
    - **Storage**: Bit in Memory Header
  || {
    style.fill: "#F1F8E9"
  }
}

"VDBE_CONCURRENCY_NOTES": |md
  ## Implementation Checklist (M9)
  1. **Spinlocks**: Use `_mm_pause()` in spin loops to save power.
  2. **Intent Locks**: Always acquire `IS` on table before `S` on row.
  3. **Ordering**: Latches must always be acquired in the same physical order (Page ID ASC) to prevent low-level deadlocks.
| {
  near: top-right
  style.font-size: 12
}

"LEGEND": {
  near: bottom-left
  "Logical Connection": {
    style.stroke: "#1565C0"
    style.stroke-dash: 5
  }
  "Physical/Atomic Action": {
    style.stroke: "#2E7D32"
    style.animated: true
  }
}