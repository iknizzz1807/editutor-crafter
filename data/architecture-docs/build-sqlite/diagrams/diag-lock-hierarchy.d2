vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  lock_shared: {
    style: {
      fill: "#e8f5e9"
      stroke: "#2e7d32"
      font-color: "#2e7d32"
    }
  }
  lock_exclusive: {
    style: {
      fill: "#ffebee"
      stroke: "#c62828"
      font-color: "#c62828"
    }
  }
  intent: {
    style: {
      stroke-dash: 3
      fill: "#e3f2fd"
      stroke: "#1565c0"
    }
  }
  process: {
    shape: person
    style: {
      fill: "#eceff1"
      stroke: "#455a64"
    }
  }
}

# --- TOP LEVEL COMPONENTS ---

title: "THE INTENT HIERARCHY: MULTI-GRANULAR LOCKING (MGL)" {
  shape: text
  link: "#satellite-map"
  style: {
    font-size: 28
    bold: true
  }
}

explanation: |'md
### The "Breadcrumb" Strategy
To avoid a **Table Scan** every time a lock is requested, database engines use **Intent Locks**. 
1. **TX A** (Writer) wants to update one row. It places an **IX** (Intent Exclusive) lock on the Table.
2. **TX B** (Auditor) wants to read the *entire* table. It checks the Table Header for existing locks.
3. Since **IX** and **S** (Shared) are incompatible, TX B is blocked **instantly** at the header level without scanning millions of rows.
'| {
  near: top-left
  link: "#milestone-9"
}

# --- LOCK COMPATIBILITY MATRIX ---

matrix_container: "Lock Compatibility Matrix" {
  link: "#milestone-9"
  grid-columns: 5
  grid-gap: 0
  
  " ": { style.bold: true }
  "IS": { style.bold: true; class: intent }
  "IX": { style.bold: true; class: intent }
  "S": { style.bold: true; class: lock_shared }
  "X": { style.bold: true; class: lock_exclusive }

  "IS_row": "IS" { style.bold: true; class: intent }
  "c1": "✅" { style.fill: "#c8e6c9" }
  "c2": "✅" { style.fill: "#c8e6c9" }
  "c3": "✅" { style.fill: "#c8e6c9" }
  "c4": "❌" { style.fill: "#ffcdd2" }

  "IX_row": "IX" { style.bold: true; class: intent }
  "c5": "✅" { style.fill: "#c8e6c9" }
  "c6": "✅" { style.fill: "#c8e6c9" }
  "c7": "❌" { style.fill: "#ffcdd2" }
  "c8": "❌" { style.fill: "#ffcdd2" }

  "S_row": "S" { style.bold: true; class: lock_shared }
  "c9": "✅" { style.fill: "#c8e6c9" }
  "c10": "❌" { style.fill: "#ffcdd2" }
  "c11": "✅" { style.fill: "#c8e6c9" }
  "c12": "❌" { style.fill: "#ffcdd2" }

  "X_row": "X" { style.bold: true; class: lock_exclusive }
  "c13": "❌" { style.fill: "#ffcdd2" }
  "c14": "❌" { style.fill: "#ffcdd2" }
  "c15": "❌" { style.fill: "#ffcdd2" }
  "c16": "❌" { style.fill: "#ffcdd2" }
}

# --- THE HIERARCHY STATE VIEW ---

storage_engine: "Storage Engine State" {
  link: "#milestone-4"
  
  db_file: "Database File (On-Disk)" {
    shape: cylinder
    link: "#milestone-4"
    
    users_table: "Table: USERS" {
      link: "#milestone-9"
      
      table_header: "Table Control Block (TCB)" {
        shape: rectangle
        style.double-border: true
        label: "USERS_HEADER\nActive Lock: IX (Intent Exclusive)"
        class: intent
      }

      data_pages: "B-Tree Pages" {
        page_402: "Page #402 (Leaf)" {
          link: "#milestone-4"
          style.fill: "#f1f8e9"
          
          row_5: "Row ID: 5" {
            label: "RECORD: Alice\nLock: X (Exclusive)"
            class: lock_exclusive
            link: "#milestone-7"
          }
          
          row_6: "Row ID: 6" {
            label: "RECORD: Bob\nLock: NONE"
            style.opacity: 0.5
          }
        }
      }
    }
  }
}

# --- ACTORS & INTERACTION FLOW ---

tx_a: "Transaction A (Writer)" {
  class: process
  link: "#milestone-3"
}

tx_b: "Transaction B (Auditor)" {
  class: process
  link: "#milestone-3"
}

# Sequence of Operations
tx_a -> storage_engine.db_file.users_table.table_header: "1. Place IX Lock" {
  style.stroke: "#c62828"
  style.animated: true
}

storage_engine.db_file.users_table.table_header -> storage_engine.db_file.users_table.data_pages.page_402.row_5: "2. Secure X Lock on Row" {
  style.stroke: "#c62828"
  style.stroke-dash: 4
}

tx_b -> storage_engine.db_file.users_table.table_header: "3. Request S Lock (Full Scan)" {
  style.stroke: "#1565c0"
}

# --- THE MICROSCOPE: MEMORY LAYOUT ---

memory_layout: "Microscope: Latch Memory Control Word" {
  link: "#milestone-1"
  near: bottom-left
  
  latch_struct: {
    shape: sql_table
    style.fill: "#fffde7"
    
    offset_00: "uint32_t mutex_word" {constraint: "0x00000001 (HELD)"}
    offset_04: "uint32_t owner_id" {constraint: "TX_A_PID (0xAF31)"}
    offset_08: "uint16_t intent_counts" {constraint: "IX: 1, IS: 0"}
    offset_0A: "uint16_t wait_queue_len" {constraint: "1 (TX_B)"}
    offset_0C: "void* wait_event_ptr" {constraint: "0x7FFF0012"}
  }
}

# --- HARDWARE ATOMICITY ---

cpu_core: "Hardware Execution" {
  near: bottom-center
  cpu: "Intel x86_64 Core" {
    shape: rectangle
    class: intent
    
    cache_line: "L1 Cache Line (64-Bytes)" {
      style.stroke-dash: 2
      cas_instruction: "LOCK CMPXCHG" {
        shape: step
        style.fill: "#bbdefb"
      }
    }
  }
}

cpu_core.cpu.cache_line.cas_instruction -> memory_layout.latch_struct.offset_00: "Atomic CAS" {
  style.stroke: "#1565c0"
  style.animated: true
  label: "Verify and Swap"
}

# --- BLOCKING LOGIC ---

blocking_point: "CONFLICT DETECTED" {
  shape: diamond
  style.fill: "#ffcdd2"
  link: "#milestone-9"
  near: center-right
}

storage_engine.db_file.users_table.table_header -> blocking_point: "IX is incompatible with S"
tx_b -> blocking_point: "Waiting for TX_A"

# --- LEGEND ---

legend: "Legend: Lock Hierarchy" {
  near: bottom-right
  ix_label: "Intent Exclusive (Hierarchy Path)" { class: intent }
  x_label: "Exclusive (Direct Row Lock)" { class: lock_exclusive }
  s_label: "Shared (Reader Access)" { class: lock_shared }
}

# Global Connection Rules
blocking_point -> tx_b: "Block Process" {
  style.stroke: red
  target-arrowhead: cross
}

# Styling globs for consistent density
"storage_engine.**": {
  style.font-size: 11
}
"matrix_container.**": {
  style.font-size: 12
  style.text-transform: uppercase
}
"memory_layout.**": {
  style.font: mono
  style.font-size: 10
}