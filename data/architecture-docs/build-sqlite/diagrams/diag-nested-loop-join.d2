vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Nested Loop Join Algorithm
  `SELECT * FROM orders o JOIN customers c ON o.customer_id = c.id`
| {near: top-center}
direction: right
# Legend
legend: {
  near: top-right
  label: |md
    **Legend**
    - ðŸ” Outer Loop (Table A)
    - ðŸ” Inner Loop (Index Seek)
    - âœ… Match Found
    - âŒ No Match
  |
  style: {
    fill: "#f0f4f8"
    stroke: "#94a3b8"
    border-radius: 8
  }
}
# Outer Table (Table A - Orders)
outer_table: "Table A: orders\n(smaller table = outer)" {
  style: {
    fill: "#dbeafe"
    stroke: "#3b82f6"
    stroke-width: 2
    border-radius: 8
  }
  header: |md
    **orders** (3 rows)
    | id | customer_id | total |
    |----|-------------|-------|
  |
  header.shape: text
  row1: "Row 1: id=1, customer_id=100, total=50" {
    style: {
      fill: "#bfdbfe"
      stroke: "#3b82f6"
      border-radius: 4
    }
  }
  row2: "Row 2: id=2, customer_id=100, total=75" {
    style: {
      fill: "#bfdbfe"
      stroke: "#3b82f6"
      border-radius: 4
    }
  }
  row3: "Row 3: id=3, customer_id=200, total=100" {
    style: {
      fill: "#bfdbfe"
      stroke: "#3b82f6"
      border-radius: 4
    }
  }
  header -> row1 -> row2 -> row3: "iterate" {
    style: {
      stroke: "#3b82f6"
      stroke-width: 2
      animated: true
    }
  }
}
# Outer Loop Arrow
outer_loop: "Outer Loop\nFor each row in orders" {
  shape: diamond
  style: {
    fill: "#fef3c7"
    stroke: "#f59e0b"
    stroke-width: 2
  }
}
outer_table.row1 -> outer_loop: "process row 1" {
  style: {stroke: "#3b82f6"; stroke-width: 2}
}
outer_table.row2 -> outer_loop: "process row 2" {
  style: {stroke: "#3b82f6"; stroke-width: 2}
}
outer_table.row3 -> outer_loop: "process row 3" {
  style: {stroke: "#3b82f6"; stroke-width: 2}
}
# Index on Inner Table
inner_index: "Index on customers.id\n(B+tree)" {
  style: {
    fill: "#fce7f3"
    stroke: "#ec4899"
    stroke-width: 2
    border-radius: 8
  }
  root: "Root: [150]" {shape: circle; style.fill: "#fbcfe8"}
  left: "Left: [100, 120]" {shape: circle; style.fill: "#fbcfe8"}
  right: "Right: [200, 250]" {shape: circle; style.fill: "#fbcfe8"}
  root -> left
  root -> right
}
outer_loop -> inner_index: "Index Lookup O(log n)" {
  style: {
    stroke: "#ec4899"
    stroke-width: 2
    stroke-dash: 4
  }
}
# Inner Table (Table B - Customers)
inner_table: "Table B: customers\n(larger table = inner)" {
  style: {
    fill: "#dcfce7"
    stroke: "#22c55e"
    stroke-width: 2
    border-radius: 8
  }
  cust_header: |md
    **customers** (5 rows)
    | id | name | country |
    |----|------|---------|
  |
  cust_header.shape: text
  cust1: "id=100, name='Alice', country='US'" {
    style: {
      fill: "#bbf7d0"
      stroke: "#22c55e"
      border-radius: 4
    }
  }
  cust2: "id=120, name='Bob', country='CA'" {
    style: {
      fill: "#bbf7d0"
      stroke: "#22c55e"
      border-radius: 4
    }
  }
  cust3: "id=200, name='Carol', country='UK'" {
    style: {
      fill: "#bbf7d0"
      stroke: "#22c55e"
      border-radius: 4
    }
  }
  cust4: "id=250, name='Dave', country='AU'" {
    style: {
      fill: "#bbf7d0"
      stroke: "#22c55e"
      border-radius: 4
    }
  }
  cust5: "id=300, name='Eve', country='DE'" {
    style: {
      fill: "#bbf7d0"
      stroke: "#22c55e"
      border-radius: 4
    }
  }
}
inner_index.left -> inner_table.cust1: "rowid" {style.stroke: "#ec4899"}
inner_index.left -> inner_table.cust2: "rowid" {style.stroke: "#ec4899"}
inner_index.right -> inner_table.cust3: "rowid" {style.stroke: "#ec4899"}
inner_index.right -> inner_table.cust4: "rowid" {style.stroke: "#ec4899"}
# Match Results
matches: "Matched Rows\n(Joined Output)" {
  style: {
    fill: "#fef9c3"
    stroke: "#eab308"
    stroke-width: 2
    border-radius: 8
  }
  match1: "(order.id=1, cid=100) (cust.id=100, Alice)" {
    style: {
      fill: "#fef08a"
      stroke: "#ca8a04"
      border-radius: 4
    }
  }
  match2: "(order.id=2, cid=100) (cust.id=100, Alice)" {
    style: {
      fill: "#fef08a"
      stroke: "#ca8a04"
      border-radius: 4
    }
  }
  match3: "(order.id=3, cid=200) (cust.id=200, Carol)" {
    style: {
      fill: "#fef08a"
      stroke: "#ca8a04"
      border-radius: 4
    }
  }
}
inner_table.cust1 -> matches.match1: "JOIN match" {
  style: {stroke: "#22c55e"; stroke-width: 2}
}
inner_table.cust1 -> matches.match2: "JOIN match" {
  style: {stroke: "#22c55e"; stroke-width: 2}
}
inner_table.cust3 -> matches.match3: "JOIN match" {
  style: {stroke: "#22c55e"; stroke-width: 2}
}
# Complexity Box
complexity: |md
  **Complexity Analysis**
  | Scenario | Complexity | Explanation |
  |----------|------------|-------------|
  | No index | O(N x M) | Full scan per outer row |
  | With index | O(N x log M) | Index seek per outer row |
  For this example: N=3 (orders), M=5 (customers)
|
complexity.near: bottom-center
complexity.style: {
  fill: "#f1f5f9"
  stroke: "#64748b"
  border-radius: 8
}
# Flow annotations
flow_note: "Algorithm:\n1. Read row from outer table\n2. Seek matching rows in inner table\n3. For each match, emit joined row\n4. Repeat until outer exhausted" {
  near: outer_loop
  style: {
    fill: "#fff7ed"
    stroke: "#ea580c"
    border-radius: 8
  }
}