vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # B-tree Node Split Sequence
  State Evolution: Leaf Overflow → Redistribute → Promote
| {near: top-center}
direction: right
classes: {
  page: {
    shape: rectangle
    style: {
      fill: "#E8F4FD"
      stroke: "#2563EB"
      stroke-width: 2
      border-radius: 4
    }
  }
  page_full: {
    shape: rectangle
    style: {
      fill: "#FEE2E2"
      stroke: "#DC2626"
      stroke-width: 3
      border-radius: 4
    }
  }
  page_new: {
    shape: rectangle
    style: {
      fill: "#DCFCE7"
      stroke: "#16A34A"
      stroke-width: 2
      border-radius: 4
    }
  }
  cell: {
    shape: rectangle
    style: {
      fill: "#FEF3C7"
      stroke: "#D97706"
      border-radius: 2
      font-size: 12
    }
  }
  pointer: {
    shape: circle
    width: 24
    height: 24
    style: {
      fill: "#DBEAFE"
      stroke: "#3B82F6"
      font-size: 10
    }
  }
  separator: {
    shape: diamond
    style: {
      fill: "#F3E8FF"
      stroke: "#9333EA"
      stroke-width: 2
      font-size: 11
    }
  }
  state_label: {
    shape: text
    style: {
      font-size: 14
      bold: true
      font-color: "#374151"
    }
  }
}
# State 1: Before Split (Overflow Detected)
state_1: {
  label: "STATE 1: Leaf Overflow Detected"
  class: state_label
  parent_1: {
    class: page
    label: "Parent Page\n(page 10)"
    ptr_a_1: {class: pointer; label: "→"}
    sep_1: {class: separator; label: "50"}
    ptr_b_1: {class: pointer; label: "→"}
  }
  parent_1.ptr_b_1 -> leaf_1: "child pointer"
  leaf_1: {
    class: page_full
    label: "Leaf Page (page 42)\n**OVERFLOW - No Space**"
    cells_1: {
      grid-columns: 4
      grid-gap: 2
      c1: {class: cell; label: "10"}
      c2: {class: cell; label: "20"}
      c3: {class: cell; label: "30"}
      c4: {class: cell; label: "40"}
      c5: {class: cell; label: "50"}
      c6: {class: cell; label: "60"}
      c7: {class: cell; label: "70"}
      c8: {class: cell; label: "80"}
      c_new: {
        class: cell
        label: "55"
        style: {
          fill: "#EF4444"
          font-color: white
        }
      }
    }
  }
}
# State 2: During Split (New Page Allocated)
state_2: {
  label: "STATE 2: Allocate & Redistribute"
  class: state_label
  parent_2: {
    class: page
    label: "Parent Page\n(page 10)"
    ptr_a_2: {class: pointer; label: "→"}
    sep_old_2: {class: separator; label: "50"}
    ptr_b_2: {class: pointer; label: "→"}
  }
  parent_2.ptr_b_2 -> leaf_orig_2: "still points here"
  leaf_orig_2: {
    class: page
    label: "Original Leaf\n(page 42)\nLower Half"
    cells_lower: {
      grid-columns: 4
      grid-gap: 2
      cl1: {class: cell; label: "10"}
      cl2: {class: cell; label: "20"}
      cl3: {class: cell; label: "30"}
      cl4: {class: cell; label: "40"}
      cl5: {class: cell; label: "50"}
    }
  }
  leaf_orig_2 -> leaf_new_2: "right_sibling\npointer" {
    style: {
      stroke: "#16A34A"
      stroke-width: 2
      animated: true
    }
  }
  leaf_new_2: {
    class: page_new
    label: "New Leaf\n(page 99)\nUpper Half"
    cells_upper: {
      grid-columns: 4
      grid-gap: 2
      cu1: {class: cell; label: "55"}
      cu2: {class: cell; label: "60"}
      cu3: {class: cell; label: "70"}
      cu4: {class: cell; label: "80"}
    }
  }
}
# State 3: After Split (Parent Updated)
state_3: {
  label: "STATE 3: Promote Separator to Parent"
  class: state_label
  parent_3: {
    class: page
    label: "Parent Page\n(page 10)\n**Updated**"
    ptr_a_3: {class: pointer; label: "→"}
    sep_a_3: {class: separator; label: "50"}
    ptr_b_3: {class: pointer; label: "→"}
    sep_new_3: {
      class: separator
      label: "55"
      style: {
        fill: "#16A34A"
        stroke: "#16A34A"
        font-color: white
      }
    }
    ptr_c_3: {
      class: pointer
      label: "→"
      style: {
        fill: "#16A34A"
        stroke: "#16A34A"
      }
    }
  }
  parent_3.ptr_b_3 -> leaf_final_3: ""
  parent_3.ptr_c_3 -> leaf_new_final_3: "new child\npointer" {
    style: {
      stroke: "#16A34A"
      stroke-width: 3
      animated: true
    }
  }
  leaf_final_3: {
    class: page
    label: "Left Leaf\n(page 42)"
    cells_final_lower: {
      grid-columns: 5
      grid-gap: 2
      cfl1: {class: cell; label: "10"}
      cfl2: {class: cell; label: "20"}
      cfl3: {class: cell; label: "30"}
      cfl4: {class: cell; label: "40"}
      cfl5: {class: cell; label: "50"}
    }
  }
  leaf_new_final_3: {
    class: page_new
    label: "Right Leaf\n(page 99)"
    cells_final_upper: {
      grid-columns: 4
      grid-gap: 2
      cfu1: {class: cell; label: "55"}
      cfu2: {class: cell; label: "60"}
      cfu3: {class: cell; label: "70"}
      cfu4: {class: cell; label: "80"}
    }
  }
}
# Flow arrows between states
state_1 -> state_2: "1. Detect overflow\n2. Allocate page 99\n3. Copy upper cells" {
  style: {
    stroke: "#6366F1"
    stroke-width: 2
    font-size: 11
  }
}
state_2 -> state_3: "4. Promote separator (55)\n5. Insert into parent\n6. Update child pointer" {
  style: {
    stroke: "#6366F1"
    stroke-width: 2
    font-size: 11
  }
}
# Legend
legend: {
  near: bottom-center
  label: ""
  shape: rectangle
  style.fill: transparent
  full_cell: {
    label: "= Full/Old"
    shape: text
  }
  new_cell: " = New Page" {
    shape: text
    style.font-color: "#16A34A"
  }
  sep_legend: " = Separator Key" {
    shape: text
    style.font-color: "#9333EA"
  }
}
# Algorithm notes
algorithm: |md
  **Split Algorithm:**
  1. **Detect overflow**: New cell (55) doesn't fit in page 42
  2. **Allocate sibling**: New page 99 created
  3. **Redistribute cells**: 
     - Lower half stays in page 42 (10, 20, 30, 40, 50)
     - Upper half moves to page 99 (55, 60, 70, 80)
  4. **Promote separator**: First key of right page (55) goes to parent
  5. **Update parent**: Insert (55, ptr→99) after existing (50, ptr→42)
  6. **Link siblings**: page 42 → page 99 via right_sibling pointer
| {near: bottom-center}