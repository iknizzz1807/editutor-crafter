vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right
title: NULL Handling in Aggregate Functions {
  near: top-center
  shape: text
  style: {
    font-size: 28
    bold: true
  }
}
# Example Table with NULL values
example_table: {
  label: "products table"
  style.fill: "#E8F4FD"
  style.stroke: "#2196F3"
  header: {
    shape: rectangle
    label: "| id | price |"
    style.fill: "#BBDEFB"
    style.bold: true
    style.font: mono
  }
  row1: {
    label: "|  1 |   10  |"
    shape: rectangle
    style.font: mono
  }
  row2: {
    label: "|  2 |  NULL |"
    shape: rectangle
    style.font: mono
    style.fill: "#FFCDD2"
  }
  row3: {
    label: "|  3 |   30  |"
    shape: rectangle
    style.font: mono
  }
  row4: {
    label: "|  4 |  NULL |"
    shape: rectangle
    style.font: mono
    style.fill: "#FFCDD2"
  }
  row5: {
    label: "|  5 |   50  |"
    shape: rectangle
    style.font: mono
  }
  header -> row1 -> row2 -> row3 -> row4 -> row5: {style.opacity: 0}
}
# COUNT(*) explanation
count_star: {
  label: "COUNT(*)"
  style.fill: "#C8E6C9"
  style.stroke: "#4CAF50"
  result: {
    label: "= 5"
    shape: rectangle
    style.fill: "#A5D6A7"
    style.bold: true
    style.font-size: 20
  }
  explanation: ||md
    Counts ALL rows
    including NULLs
  ||
  result -> explanation: {style.opacity: 0}
}
# COUNT(col) explanation  
count_col: {
  label: "COUNT(price)"
  style.fill: "#FFF9C4"
  style.stroke: "#FFC107"
  result: {
    label: "= 3"
    shape: rectangle
    style.fill: "#FFF59D"
    style.bold: true
    style.font-size: 20
  }
  explanation: ||md
    Counts only NON-NULL
    values (excludes 2 rows)
  ||
  result -> explanation: {style.opacity: 0}
}
# SUM(col) explanation
sum_col: {
  label: "SUM(price)"
  style.fill: "#E1BEE7"
  style.stroke: "#9C27B0"
  result: {
    label: "= 90"
    shape: rectangle
    style.fill: "#CE93D8"
    style.bold: true
    style.font-size: 20
  }
  explanation: ||md
    10 + 30 + 50 = 90
    NULLs are skipped
  ||
  result -> explanation: {style.opacity: 0}
}
# AVG(col) explanation
avg_col: {
  label: "AVG(price)"
  style.fill: "#FFCCBC"
  style.stroke: "#FF5722"
  result: {
    label: "= 30.0"
    shape: rectangle
    style.fill: "#FFAB91"
    style.bold: true
    style.font-size: 20
  }
  explanation: ||md
    90 / 3 = 30.0
    (divides by non-NULL count)
  ||
  result -> explanation: {style.opacity: 0}
}
# Connections
example_table -> count_star: "processes\nall rows" {
  style.stroke: "#4CAF50"
  style.stroke-width: 2
}
example_table -> count_col: "skips\nNULL rows" {
  style.stroke: "#FFC107"
  style.stroke-width: 2
  style.stroke-dash: 3
}
example_table -> sum_col: "sums\nnon-NULL" {
  style.stroke: "#9C27B0"
  style.stroke-width: 2
}
example_table -> avg_col: "avg of\nnon-NULL" {
  style.stroke: "#FF5722"
  style.stroke-width: 2
}
# Key insight box
key_insight: ||md
  ### Key Insight
  `COUNT(*)` â‰  `COUNT(price)` when NULLs exist!
  - `COUNT(*)` = 5 (all rows)
  - `COUNT(price)` = 3 (only non-NULL prices)
  This is why `AVG(price)` = `SUM(price)` / `COUNT(price)` = 90/3 = 30
  NOT 90/5 = 18
||
key_insight.near: bottom-center
# Aggregate function semantics table
semantics: {
  label: "Aggregate Semantics"
  style.fill: "#ECEFF1"
  table: ||md
    | Function | NULL Behavior | Empty Table |
    |----------|---------------|-------------|
    | COUNT(*) | Counts all    | 0           |
    | COUNT(c) | Skips NULLs   | 0           |
    | SUM(c)   | Skips NULLs   | NULL        |
    | AVG(c)   | Skips NULLs   | NULL        |
    | MIN(c)   | Skips NULLs   | NULL        |
    | MAX(c)   | Skips NULLs   | NULL        |
  ||
}
example_table -> semantics: {style.opacity: 0}
semantics -> key_insight: {style.opacity: 0}