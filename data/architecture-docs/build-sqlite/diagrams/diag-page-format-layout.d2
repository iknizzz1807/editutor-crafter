vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: B-tree Page Format: Slotted Page Layout {
  near: top-center
  shape: text
  style: {
    font-size: 28
    bold: true
    underline: true
  }
}

page: "4096-byte Page (4KB)" {
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a6a"
    stroke-width: 3
    border-radius: 4
    font-color: white
  }

  header: "Page Header (8-12 bytes)" {
    style: {
      fill: "#7c3aed"
      stroke: "#9d5cf5"
      stroke-width: 2
      font-color: white
      font-size: 16
    }

    type: "PageType: uint8" {
      shape: text
      style: {
        font-size: 11
        font-color: "#e0d4ff"
      }
    }
    cell_count: "CellCount: uint16" {
      shape: text
      style: {
        font-size: 11
        font-color: "#e0d4ff"
      }
    }
    free_space: "CellContentStart: uint16" {
      shape: text
      style: {
        font-size: 11
        font-color: "#e0d4ff"
      }
    }
    right_child: "RightMostPtr: uint32 (internal only)" {
      shape: text
      style: {
        font-size: 11
        font-color: "#c4a8ff"
        italic: true
      }
    }
  }

  pointer_array: "Cell Pointer Array (2 bytes each)" {
    style: {
      fill: "#0891b2"
      stroke: "#22d3ee"
      stroke-width: 2
      font-color: white
      font-size: 16
    }

    ptr0: "ptr[0] → cell offset" {
      shape: text
      style: {
        font-size: 11
        font-color: "#cffafe"
      }
    }
    ptr1: "ptr[1] → cell offset" {
      shape: text
      style: {
        font-size: 11
        font-color: "#cffafe"
      }
    }
    ptr2: "ptr[2] → cell offset" {
      shape: text
      style: {
        font-size: 11
        font-color: "#cffafe"
      }
    }
    ptrN: "... ptr[N]" {
      shape: text
      style: {
        font-size: 11
        font-color: "#a5f3fc"
        italic: true
      }
    }
  }

  free_space: "Free Space (grows ←→)" {
    style: {
      fill: "#1e293b"
      stroke: "#475569"
      stroke-width: 2
      stroke-dash: 4
      font-color: "#94a3b8"
      font-size: 16
    }

    free_note: "Unallocated space between\npointer array and cell content" {
      shape: text
      style: {
        font-size: 11
        font-color: "#64748b"
        italic: true
      }
    }
  }

  cell_content: "Cell Content Area (variable size)" {
    style: {
      fill: "#059669"
      stroke: "#34d399"
      stroke-width: 2
      font-color: white
      font-size: 16
    }

    cellN: "Cell N (most recent insert)" {
      shape: text
      style: {
        font-size: 11
        font-color: "#d1fae5"
      }
    }
    cell2: "Cell 2" {
      shape: text
      style: {
        font-size: 11
        font-color: "#d1fae5"
      }
    }
    cell1: "Cell 1" {
      shape: text
      style: {
        font-size: 11
        font-color: "#d1fae5"
      }
    }
    cell0: "Cell 0 (oldest insert)" {
      shape: text
      style: {
        font-size: 11
        font-color: "#d1fae5"
      }
    }
  }
}

# Direction arrows
growth_pointers: "Cell Pointers grow →" {
  near: top-right
  shape: text
  style: {
    font-size: 14
    font-color: "#22d3ee"
    bold: true
  }
}

growth_content: "← Cell Content grows" {
  near: bottom-right
  shape: text
  style: {
    font-size: 14
    font-color: "#34d399"
    bold: true
  }
}

# Offset labels
offset_0: |md
  **Offset 0**
  (Page start)
| {
  near: top-left
  style: {
    fill: transparent
    font-color: "#64748b"
    font-size: 12
  }
}

offset_4095: |md
  **Offset 4095**
  (Page end)
| {
  near: bottom-left
  style: {
    fill: transparent
    font-color: "#64748b"
    font-size: 12
  }
}

# Legend
legend: "Legend" {
  near: bottom-right
  style: {
    fill: "#1e1e2e"
    stroke: "#4a4a6a"
    border-radius: 8
    font-color: white
  }

  legend_header: "Page Types:" {
    shape: text
    style: {
      font-size: 12
      bold: true
      font-color: "#e0e0e0"
    }
  }

  type_0d: "0x0D = Table Leaf" {
    shape: text
    style: {
      font-size: 10
      font-color: "#a0a0a0"
    }
  }

  type_05: "0x05 = Table Internal" {
    shape: text
    style: {
      font-size: 10
      font-color: "#a0a0a0"
    }
  }

  type_0a: "0x0A = Index Leaf" {
    shape: text
    style: {
      font-size: 10
      font-color: "#a0a0a0"
    }
  }

  type_02: "0x02 = Index Internal" {
    shape: text
    style: {
      font-size: 10
      font-color: "#a0a0a0"
    }
  }
}

# Connection arrows showing pointer to cell relationship
page.pointer_array.ptr0 -> page.cell_content.cell0: "points to" {
  style: {
    stroke: "#22d3ee"
    stroke-width: 2
    stroke-dash: 3
    animated: true
  }
}

page.pointer_array.ptr2 -> page.cell_content.cell2: "points to" {
  style: {
    stroke: "#22d3ee"
    stroke-width: 2
    stroke-dash: 3
    animated: true
  }
}

# Key insight box
insight: |md
  **Key Insight:** Cell pointers are stored in **sorted order by key**,
  but cell content is stored in **insertion order**.
  
  This enables O(log n) binary search on pointers while
  avoiding O(n) shifting of large cell content on inserts.
| {
  near: center-right
  style: {
    fill: "#1e293b"
    stroke: "#f59e0b"
    stroke-width: 2
    border-radius: 8
    font-color: "#fef3c7"
    font-size: 13
  }
}