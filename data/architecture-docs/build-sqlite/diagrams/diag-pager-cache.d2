vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- CLASSES ---
classes: {
  memory_page: {
    shape: sql_table
    style: {
      stroke: "#334155"
      stroke-width: 2
      fill: "#f8fafc"
    }
  }
  hardware_component: {
    style: {
      fill: "#0f172a"
      font-color: "#f8fafc"
      stroke-width: 4
      stroke: "#38bdf8"
    }
  }
  logic_step: {
    shape: step
    style: {
      fill: "#38bdf8"
      font-color: "#0f172a"
      bold: true
    }
  }
}

# --- DIAGRAM HEADER ---
header: "PAGER CACHE ARCHITECTURE: THE DATA LIFECYCLE" {
  shape: text
  near: top-center
  style: {
    font-size: 28
    bold: true
  }
}

# --- LAYER 1: THE WAREHOUSE ---
warehouse: "WAREHOUSE (Persistent Storage)" {
  class: hardware_component
  link: "#milestone-4"
  
  disk_platter: "Physical Storage (SSD/HDD)" {
    shape: cylinder
    style.fill: "#1e293b"
    
    page_101_disk: "Page #101" {
      tooltip: "Raw 4KB Block on Disk"
      link: "#milestone-4"
    }
    page_102_disk: "Page #102"
    page_103_disk: "Page #103"
  }
}

# --- LAYER 2: THE KERNEL BRIDGE ---
kernel: "OS KERNEL SPACE" {
  style: {
    fill: "#cbd5e1"
    stroke-dash: 5
    stroke: "#64748b"
  }
  
  io_buffer: "Kernel Page Buffer" {
    class: memory_page
    "Header": "Flags | Permissions"
    "0x00": "DMA Data Segment A"
    "0x08": "DMA Data Segment B"
    "0x10": "..."
    
    link: "#milestone-4"
  }
}

# --- LAYER 3: SQLITE PAGER CACHE ---
pager_system: "SQLITE PAGER MODULE (M4)" {
  link: "#milestone-4"
  
  pager_logic: "Pager Control Logic" {
    class: logic_step
  }

  page_cache: "PAGE CACHE (LRU Implementation)" {
    style: {
      fill: "#e2e8f0"
      stroke: "#94a3b8"
    }

    slot_a: "Cache Slot: Clean" {
      class: memory_page
      "PageID": "101"
      "Dirty": "0" {style.fill: "#4ade80"}
      "Pins": "1"
      "Data": "4KB Payload" {
        link: "#milestone-7"
      }
    }

    slot_b: "Cache Slot: Dirty" {
      class: memory_page
      "PageID": "42"
      "Dirty": "1" {style.fill: "#f87171"}
      "Pins": "0"
      "Data": "Modified Payload" {
        link: "#milestone-7"
      }
    }
  }
}

# --- LAYER 4: VDBE EXECUTION ---
vdbe_layer: "VDBE ENGINE (M3)" {
  class: hardware_component
  link: "#milestone-3"
  
  cpu_registers: "Execution Context" {
    r0: "Opcode Pointer"
    r1: "Memory Address: Page 101" {
      style.fill: "#38bdf8"
      style.font-color: "#0f172a"
    }
    r2: "Record Offset"
  }
}

# --- FLOW: COLD PATH (DISK -> CACHE) ---
warehouse.disk_platter.page_101_disk -> kernel.io_buffer: "1. DMA Read" {
  style: {
    stroke: "#ef4444"
    stroke-dash: 3
    animated: true
  }
}

kernel.io_buffer -> pager_system.pager_logic: "2. Syscall copy" {
  style: {
    stroke: "#ef4444"
    stroke-dash: 3
  }
}

pager_system.pager_logic -> pager_system.page_cache.slot_a: "3. Cache Warm-up" {
  style: {
    stroke: "#ef4444"
    stroke-dash: 3
  }
}

# --- FLOW: HOT PATH (CACHE -> CPU) ---
pager_system.page_cache.slot_a -> vdbe_layer.cpu_registers.r1: "4. Memory Map/Direct Access" {
  style: {
    stroke: "#22c55e"
    stroke-width: 4
    animated: true
  }
}

# --- THE MICROSCOPE VIEW ---
microscope: |'md
  ### The 4KB Pager Handshake
  
  **Temporal Locality**: 
  The Pager keeps `slot_a` in memory because Milestone 3 (VDBE) is likely to request it again in the next cycle.
  
  **Dirty Bit Strategy**:
  When `vdbe_layer` modifies a value, `Dirty` is flipped to `1` in `slot_b`. The **Protector (M6)** ensures this isn't written to the **Warehouse** until the **WAL (Write Ahead Log)** is finalized.
  
  **Memory Alignment**:
  Data at `pager_system.page_cache.slot_a.Data` is aligned to 4KB boundaries to ensure the OS Kernel can perform zero-copy transfers.
'| {
  near: bottom-left
  style: {
    font-size: 14
    stroke: "#38bdf8"
    fill: "#f8fafc"
  }
}

# --- LEGEND ---
legend: {
  near: bottom-right
  "Cold Path (I/O)": {
    style: {
      stroke: "#ef4444"
      stroke-dash: 3
    }
  }
  "Hot Path (Memory)": {
    style: {
      stroke: "#22c55e"
      stroke-width: 4
    }
  }
}

# --- CROSS-MILESTONE LINKS ---
pager_system.page_cache.slot_a.Data.link: "#milestone-7"
pager_system.page_cache.slot_b.Data.link: "#milestone-7"
vdbe_layer.cpu_registers.r0.link: "#milestone-3"
warehouse.disk_platter.link: "#milestone-4"