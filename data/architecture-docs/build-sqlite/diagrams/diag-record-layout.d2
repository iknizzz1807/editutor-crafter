vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  byte_unit: {
    style: {
      stroke-width: 2
      border-radius: 1
      font: mono
      font-size: 14
      text-transform: uppercase
    }
  }
  header_area: {
    style: {
      fill: "#C7F1FF"
      stroke: "#525F7F"
      bold: true
    }
  }
  payload_area: {
    style: {
      fill: "#FFE7CB"
      stroke: "#9E2146"
      bold: true
    }
  }
  annotation: {
    shape: text
    style: {
      font-size: 12
      italic: true
    }
  }
}

record_anatomy: "RECORD ANATOMY: THE BINARY BLUEPRINT" {
  link: "#milestone-7"
  tooltip: "Deep dive into row serialization and record format"

  logical_state: "1. LOGICAL INPUT (SQL ROW)" {
    link: "#milestone-7"
    row_data: {
      shape: sql_table
      "Column": "Value" {constraint: "Type"}
      "id": "5" {constraint: "INT8"}
      "name": "'Alice'" {constraint: "TEXT"}
      "bio": "NULL" {constraint: "NULL"}
    }
  }

  packer: "Serialization Engine (Varint Encoder)" {
    shape: step
    style.fill: "#E4DBFE"
    link: "#milestone-7"
  }

  physical_layout: "2. PHYSICAL MEMORY LAYOUT (MICROSCOPE VIEW)" {
    link: "#milestone-7"
    
    header_block: "Record Header (Manifest)" {
      grid-columns: 4
      grid-gap: 2
      
      h_size: "0x04" {
        class: [byte_unit; header_area]
        tooltip: "Total Header Size: 4 bytes (Varint)"
      }
      t_id: "0x01" {
        class: [byte_unit; header_area]
        tooltip: "Serial Type 1: 1-byte Signed Integer"
      }
      t_name: "0x17" {
        class: [byte_unit; header_area]
        tooltip: "Serial Type 23: String of length 5 [(23-13)/2]"
      }
      t_bio: "0x00" {
        class: [byte_unit; header_area]
        tooltip: "Serial Type 0: NULL (Takes 0 bytes in payload)"
      }
    }

    payload_block: "Record Payload (Raw Data)" {
      grid-columns: 6
      grid-gap: 2

      d_id: "0x05" {
        class: [byte_unit; payload_area]
        tooltip: "Value of 'id' column"
      }
      d_c1: "0x41" { class: [byte_unit; payload_area]; tooltip: "ASCII 'A'" }
      d_c2: "0x6C" { class: [byte_unit; payload_area]; tooltip: "ASCII 'l'" }
      d_c3: "0x69" { class: [byte_unit; payload_area]; tooltip: "ASCII 'i'" }
      d_c4: "0x63" { class: [byte_unit; payload_area]; tooltip: "ASCII 'c'" }
      d_c5: "0x65" { class: [byte_unit; payload_area]; tooltip: "ASCII 'e'" }
    }
  }

  decoding_logic: "DECODING FORMULAS" {
    link: "#milestone-7"
    formula_box: |'md
      ### Serial Type $N$ Calculation
      | Value of $N$ | Meaning | Content Size |
      | :--- | :--- | :--- |
      | 0 | NULL | 0 bytes |
      | 1 | Int8 | 1 byte |
      | 12 | BLOB | $(N-12)/2$ bytes |
      | 13+ | String | $(N-13)/2$ bytes |
    '|
  }

  hardware_context: "HARDWARE SOUL: ALIGNMENT & STRADDLING" {
    link: "#milestone-7"
    style: {
      stroke: "#9E2146"
      stroke-dash: 3
      fill: "#F6F9FC"
    }
    note: |'md
      **CPU Cache Boundary (64 Bytes)**
      
      If the header `0x17` starts at offset 63, the CPU must fetch **two cache lines** 
      and perform a bitwise merge to decode the field length. This is the 
      "Alignment Tax" paid for compact storage.
    '|
  }

  # --- INTERCONNECTIONS ---
  logical_state.row_data -> packer: "Pack"
  packer -> physical_layout: "Output Buffer"

  physical_layout.header_block.t_name -> decoding_logic.formula_box: "Parser Logic" {
    style: {
      stroke: "#525F7F"
      stroke-dash: 4
    }
  }

  decoding_logic.formula_box -> physical_layout.payload_block: "Defines Slices" {
    style: {
      stroke: "#9E2146"
      animated: true
    }
  }

  physical_layout -> hardware_context: "Memory Access Pattern"
}

# --- SATELLITE SYSTEM LINKAGE ---
satellite_map: "SYSTEM ARCHITECTURE" {
  link: "#satellite-map"
  shape: cylinder
}

pager_m4: "PAGER / STORAGE (MILESTONE 4)" {
  link: "#milestone-4"
  shape: package
}

record_anatomy -> pager_m4: "Serialized Row" {
  style: {
    stroke: "#ACE1AF"
    stroke-width: 4
  }
}

vdbe_m3: "VDBE ENGINE (MILESTONE 3)" {
  link: "#milestone-3"
  shape: package
}

vdbe_m3 -> record_anatomy.packer: "OP_MakeRecord" {
  style.animated: true
}