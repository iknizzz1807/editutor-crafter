vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: {
  label: "Row Record Format: Variable-Length Columns"
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

# Main record structure
record: {
  label: ""
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a6a"
    stroke-width: 2
  }

  # Header section
  header: {
    label: "Record Header"
    style: {
      fill: "#16213e"
      stroke: "#0f3460"
      stroke-width: 2
    }

    header_size: {
      label: "Header\nSize\n(varint)"
      shape: rectangle
      width: 80
      height: 60
      style: {
        fill: "#e94560"
        stroke: "#ff6b6b"
        font-color: white
        bold: true
      }
    }

    type1: {
      label: "Type\nCol 0\n(varint)"
      shape: rectangle
      width: 70
      height: 60
      style: {
        fill: "#7b2cbf"
        stroke: "#9d4edd"
        font-color: white
      }
    }

    type2: {
      label: "Type\nCol 1\n(varint)"
      shape: rectangle
      width: 70
      height: 60
      style: {
        fill: "#7b2cbf"
        stroke: "#9d4edd"
        font-color: white
      }
    }

    type3: {
      label: "Type\nCol 2\n(varint)"
      shape: rectangle
      width: 70
      height: 60
      style: {
        fill: "#7b2cbf"
        stroke: "#9d4edd"
        font-color: white
      }
    }

    type4: {
      label: "Type\nCol 3\n(varint)"
      shape: rectangle
      width: 70
      height: 60
      style: {
        fill: "#7b2cbf"
        stroke: "#9d4edd"
        font-color: white
      }
    }

    type5: {
      label: "Type\nCol 4\n(varint)"
      shape: rectangle
      width: 70
      height: 60
      style: {
        fill: "#7b2cbf"
        stroke: "#9d4edd"
        font-color: white
      }
    }

    header_size -> type1 -> type2 -> type3 -> type4 -> type5: {style.opacity: 0}
  }

  # Body section
  body: {
    label: "Record Body"
    style: {
      fill: "#16213e"
      stroke: "#0f3460"
      stroke-width: 2
    }

    col0: {
      label: "Col 0\nINT\n(8 bytes)"
      shape: rectangle
      width: 90
      height: 60
      style: {
        fill: "#006d77"
        stroke: "#83c5be"
        font-color: white
      }
    }

    col1: {
      label: "Col 1\nNULL\n(0 bytes)"
      shape: rectangle
      width: 90
      height: 60
      style: {
        fill: "#3d405b"
        stroke: "#6b705c"
        font-color: "#aaaaaa"
        stroke-dash: 3
      }
    }

    col2: {
      label: "Col 2\nFLOAT\n(8 bytes)"
      shape: rectangle
      width: 90
      height: 60
      style: {
        fill: "#006d77"
        stroke: "#83c5be"
        font-color: white
      }
    }

    col3: {
      label: "Col 3\nTEXT\n(N bytes)"
      shape: rectangle
      width: 140
      height: 60
      style: {
        fill: "#2d6a4f"
        stroke: "#52b788"
        font-color: white
      }
    }

    col4: {
      label: "Col 4\nBLOB\n(M bytes)"
      shape: rectangle
      width: 120
      height: 60
      style: {
        fill: "#7f5539"
        stroke: "#b08968"
        font-color: white
      }
    }

    col0 -> col1 -> col2 -> col3 -> col4: {style.opacity: 0}
  }

  header -> body: "Payload\nOrder" {
    style: {
      stroke: "#4cc9f0"
      stroke-width: 2
      animated: true
    }
  }
}

# Byte offset ruler
offsets: {
  label: ""
  style.fill: transparent

  off0: {
    label: "0"
    shape: text
    style: {font: mono}
  }
  off1: {
    label: "1"
    shape: text
    style: {font: mono}
  }
  off2: {
    label: "2"
    shape: text
    style: {font: mono}
  }
  off3: {
    label: "3"
    shape: text
    style: {font: mono}
  }
  off4: {
    label: "4"
    shape: text
    style: {font: mono}
  }
  off5: {
    label: "5"
    shape: text
    style: {font: mono}
  }
  off6: {
    label: "..."
    shape: text
    style: {font: mono}
  }

  off0 -> off1 -> off2 -> off3 -> off4 -> off5 -> off6: {style.opacity: 0}
}

offsets -> record.header: {style.opacity: 0}

# Serial Type Reference Table
serial_types: {
  label: "Serial Type Codes"
  style: {
    fill: "#0d1b2a"
    stroke: "#1b263b"
    stroke-width: 2
  }

  |`md
  | Code | Meaning | Size |
  |------|---------|------|
  | 0 | NULL | 0 bytes |
  | 1 | 8-bit int | 1 byte |
  | 2 | 16-bit int | 2 bytes |
  | 3 | 24-bit int | 3 bytes |
  | 4 | 32-bit int | 4 bytes |
  | 5 | 48-bit int | 6 bytes |
  | 6 | 64-bit int | 8 bytes |
  | 7 | IEEE 754 float | 8 bytes |
  | 8 | Integer 0 | 0 bytes |
  | 9 | Integer 1 | 0 bytes |
  | N≥12, even | BLOB | (N-12)/2 bytes |
  | N≥13, odd | TEXT | (N-13)/2 bytes |
  `|
}

# Example row
example: {
  label: "Example Row: (42, NULL, 3.14, 'Hello', x'CAFE')"
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a6a"
    stroke-width: 2
  }

  ex_header: {
    label: ""
    style.fill: transparent

    ex_h1: {
      label: "12"
      shape: rectangle
      width: 40
      style: {fill: "#e94560"; font-color: white; font: mono; font-size: 12}
    }
    ex_t1: {
      label: "6"
      shape: rectangle
      width: 35
      style: {fill: "#7b2cbf"; font-color: white; font: mono; font-size: 12}
    }
    ex_t2: {
      label: "0"
      shape: rectangle
      width: 35
      style: {fill: "#7b2cbf"; font-color: white; font: mono; font-size: 12}
    }
    ex_t3: {
      label: "7"
      shape: rectangle
      width: 35
      style: {fill: "#7b2cbf"; font-color: white; font: mono; font-size: 12}
    }
    ex_t4: {
      label: "23"
      shape: rectangle
      width: 35
      style: {fill: "#7b2cbf"; font-color: white; font: mono; font-size: 12}
    }
    ex_t5: {
      label: "16"
      shape: rectangle
      width: 35
      style: {fill: "#7b2cbf"; font-color: white; font: mono; font-size: 12}
    }

    ex_h1 -> ex_t1 -> ex_t2 -> ex_t3 -> ex_t4 -> ex_t5: {style.opacity: 0}
  }

  ex_body: {
    label: ""
    style.fill: transparent

    ex_v1: {
      label: "42"
      shape: rectangle
      width: 60
      style: {fill: "#006d77"; font-color: white; font: mono; font-size: 11}
    }
    ex_v2: {
      label: "∅"
      shape: rectangle
      width: 40
      style: {fill: "#3d405b"; font-color: "#666"; font-size: 14; stroke-dash: 2}
    }
    ex_v3: {
      label: "3.14"
      shape: rectangle
      width: 60
      style: {fill: "#006d77"; font-color: white; font: mono; font-size: 11}
    }
    ex_v4: {
      label: "Hello"
      shape: rectangle
      width: 70
      style: {fill: "#2d6a4f"; font-color: white; font: mono; font-size: 11}
    }
    ex_v5: {
      label: "CA FE"
      shape: rectangle
      width: 60
      style: {fill: "#7f5539"; font-color: white; font: mono; font-size: 11}
    }

    ex_v1 -> ex_v2 -> ex_v3 -> ex_v4 -> ex_v5: {style.opacity: 0}
  }

  ex_header -> ex_body: {style.opacity: 0}
}

# NULL encoding detail
null_detail: {
  label: "NULL Encoding Detail"
  style: {
    fill: "#1a1a2e"
    stroke: "#e94560"
    stroke-width: 2
  }

  null_box: {
    label: "Type=0\nNo body bytes"
    shape: rectangle
    width: 120
    height: 50
    style: {
      fill: "#2d2d44"
      stroke-dash: 3
      stroke: "#e94560"
    }
  }

  |`md
  **NULL is encoded as:**
  - Serial type code: 0
  - Body size: 0 bytes
  - No value stored
  `|
}

# Varint encoding note
varint_note: |`md
  **Varint (Variable Integer):**
  - 1 byte for values 0-127
  - 2+ bytes for larger values
  - High bit indicates continuation
`|

# Text length calculation
text_calc: {
  label: "TEXT Length Formula"
  style: {
    fill: "#16213e"
    stroke: "#2d6a4f"
    stroke-width: 2
  }

  |`md
  For TEXT of length L bytes:
  
  `Serial Type = (L × 2) + 13`
  
  Example: "Hello" (5 bytes)
  `Serial Type = 5×2 + 13 = 23`
  `|
}

# BLOB length calculation
blob_calc: {
  label: "BLOB Length Formula"
  style: {
    fill: "#16213e"
    stroke: "#7f5539"
    stroke-width: 2
  }

  |`md
  For BLOB of length L bytes:
  
  `Serial Type = (L × 2) + 12`
  
  Example: x'CAFE' (2 bytes)
  `Serial Type = 2×2 + 12 = 16`
  `|
}

# Layout connections
record -> serial_types: "Reference" {
  style: {
    stroke: "#4cc9f0"
    stroke-dash: 3
  }
}

serial_types -> example: "Applied" {
  style: {
    stroke: "#4cc9f0"
    stroke-dash: 3
  }
}

record -> null_detail: "NULL\nHandling" {
  style: {
    stroke: "#e94560"
    stroke-dash: 3
  }
}

# Legend
legend: {
  label: "Legend"
  style: {
    fill: "#0d1b2a"
    stroke: "#1b263b"
  }

  l1: {
    label: "Header Field"
    shape: rectangle
    style: {fill: "#e94560"; font-size: 10}
  }
  l2: {
    label: "Serial Type"
    shape: rectangle
    style: {fill: "#7b2cbf"; font-size: 10}
  }
  l3: {
    label: "Numeric Data"
    shape: rectangle
    style: {fill: "#006d77"; font-size: 10}
  }
  l4: {
    label: "Text Data"
    shape: rectangle
    style: {fill: "#2d6a4f"; font-size: 10}
  }
  l5: {
    label: "Blob Data"
    shape: rectangle
    style: {fill: "#7f5539"; font-size: 10}
  }
  l6: {
    label: "NULL (empty)"
    shape: rectangle
    style: {fill: "#3d405b"; stroke-dash: 3; font-size: 10}
  }

  l1 -> l2 -> l3 -> l4 -> l5 -> l6: {style.opacity: 0}
}