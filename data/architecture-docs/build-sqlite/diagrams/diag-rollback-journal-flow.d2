vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: Rollback Journal Write Ordering {
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

# Timeline
timeline: {
  shape: sequence_diagram
  
  # Actors
  Transaction
  Journal: "-journal file"
  Database: ".db file"
  Disk
  
  # Phase 1: Transaction Start
  "1. BEGIN": {
    Transaction -> Transaction: Start transaction\nstate=ACTIVE
  }
  
  # Phase 2: Journal Phase
  "2. Journal Original Pages": {
    Transaction -> Journal: Write original\npage images
    Journal -> Journal: Page 42 (original)
    Journal -> Journal: Page 15 (original)
    Journal -> Journal: Page 7 (original)
  }
  
  "3. fsync Journal": {
    Transaction -> Disk: fsync(journal)
    Disk -> Transaction: ACK
    Transaction.CRITICAL_POINT: |md
      **Journal is now durable**
      
      Recovery is possible
      if crash occurs
    |
  }
  
  # Phase 3: Database Modification
  "4. Modify Database": {
    Transaction -> Database: Write modified\npage 42
    Transaction -> Database: Write modified\npage 15
    Transaction -> Database: Write modified\npage 7
  }
  
  "5. fsync Database": {
    Transaction -> Disk: fsync(database)
    Disk -> Transaction: ACK
  }
  
  # Phase 4: Commit
  "6. COMMIT": {
    Transaction -> Journal: Delete journal\nfile
    Transaction -> Disk: fsync(directory)\n(ensure deletion durable)
    Transaction -> Transaction: state=COMMITTED
  }
}

# Crash Scenarios
crash_scenarios: "Crash Recovery Scenarios" {
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a6a"
    border-radius: 8
  }
  
  crash_point_a: |md
    ### Crash Point A
    **Before journal fsync**
    
    - Journal may be incomplete
    - Database unchanged
    - **Result**: No recovery needed
    - Database is consistent
  | {
    style: {
      fill: "#2d5a27"
      stroke: "#4a8a44"
    }
  }
  
  crash_point_b: |md
    ### Crash Point B
    **After journal fsync, before COMMIT**
    
    - Journal is durable ✓
    - Database may be partial
    - **Result**: Hot journal detected
    - Restore original pages
    - Database rolled back
  | {
    style: {
      fill: "#8a6a27"
      stroke: "#ba9a44"
    }
  }
  
  crash_point_c: |md
    ### Crash Point C
    **After COMMIT (journal deleted)**
    
    - All changes in database
    - Journal deleted
    - **Result**: Transaction committed
    - No recovery needed
  | {
    style: {
      fill: "#2d5a27"
      stroke: "#4a8a44"
    }
  }
  
  crash_point_a -> crash_point_b
  crash_point_b -> crash_point_c
}

# Write Ordering Diagram
ordering: "Write Ordering Guarantees" {
  direction: right
  
  style: {
    fill: "#1e1e2e"
    stroke: "#6272a4"
    border-radius: 8
  }
  
  step1: "1. Write Journal" {
    shape: rectangle
    style: {
      fill: "#6272a4"
      font-color: white
    }
  }
  
  step2: "2. fsync Journal" {
    shape: rectangle
    style: {
      fill: "#ff79c6"
      font-color: white
      bold: true
    }
  }
  
  step3: "3. Write Database" {
    shape: rectangle
    style: {
      fill: "#6272a4"
      font-color: white
    }
  }
  
  step4: "4. fsync Database" {
    shape: rectangle
    style: {
      fill: "#6272a4"
      font-color: white
    }
  }
  
  step5: "5. Delete Journal" {
    shape: rectangle
    style: {
      fill: "#50fa7b"
      font-color: black
    }
  }
  
  step1 -> step2: "MUST\ncomplete" {
    style: {
      stroke: "#ff79c6"
      stroke-width: 3
      bold: true
    }
  }
  
  step2 -> step3: "before\nthis starts" {
    style: {
      stroke: "#ff79c6"
      stroke-width: 3
      bold: true
    }
  }
  
  step3 -> step4
  step4 -> step5
}

# Key insight box
insight: |md
  ### Why This Order Matters
  
  **The journal must be durable BEFORE any database modification.**
  
  If the journal is not on stable storage when a crash occurs, there is no
  way to undo partial writes. The database would be corrupt.
  
  This is why `fsync(journal)` is the **critical point** in the transaction
  lifecycle—it's the moment recovery becomes possible.
| {
  style: {
    fill: "#2a2a3e"
    stroke: "#ff79c6"
    stroke-width: 2
    border-radius: 8
    font-color: "#f8f8f2"
  }
}

# Legend
legend: "Legend" {
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a6a"
    border-radius: 8
  }
  
  green: "Safe crash point" {
    shape: rectangle
    style: {
      fill: "#2d5a27"
      stroke: "#4a8a44"
    }
  }
  
  yellow: "Recovery required" {
    shape: rectangle
    style: {
      fill: "#8a6a27"
      stroke: "#ba9a44"
    }
  }
  
  critical: "Critical operation" {
    shape: rectangle
    style: {
      fill: "#ff79c6"
      font-color: white
    }
  }
}