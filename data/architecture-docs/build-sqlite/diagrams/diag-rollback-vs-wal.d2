vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Rollback Journal vs WAL: Architecture Comparison
| {near: top-center}

direction: right

rollback: {
  label: "ROLLBACK JOURNAL MODE"
  style.fill: "#FEE2E2"
  style.stroke: "#DC2626"
  style.stroke-width: 3
  
  db_file: "Database File\n(main.db)" {
    shape: cylinder
    style.fill: "#DBEAFE"
    style.stroke: "#2563EB"
  }
  
  journal: "Rollback Journal\n(main.db-journal)" {
    shape: cylinder
    style.fill: "#FEF3C7"
    style.stroke: "#D97706"
  }
  
  db_file -> journal: "1. Copy original\npages here" {
    style.stroke: "#059669"
    style.stroke-width: 2
  }
  
  journal -> db_file: "2. Modify pages\nin place" {
    style.stroke: "#DC2626"
    style.stroke-width: 2
    style.stroke-dash: 3
  }
  
  timeline: {
    label: ""
    shape: sequence_diagram
    
    Writer
    Reader1
    Reader2
    
    Writer.t1 -> Reader1.t1: "BEGIN WRITE"
    Writer.t1.style.fill: "#FEE2E2"
    
    Reader1.t1: "BLOCKED" {
      style.fill: "#FEE2E2"
      style.stroke: "#DC2626"
    }
    
    Reader2.t1: "BLOCKED" {
      style.fill: "#FEE2E2"
      style.stroke: "#DC2626"
    }
    
    Writer.t2 -> Reader1.t2: "COMMIT"
    
    Reader1.t2: "UNBLOCKED" {
      style.fill: "#DCFCE7"
      style.stroke: "#16A34A"
    }
    
    Reader2.t2: "UNBLOCKED" {
      style.fill: "#DCFCE7"
      style.stroke: "#16A34A"
    }
  }
  
  blocking_note: |md
    **Writer blocks ALL readers**
    during transaction
  |
}

vs_separator: "VS"

wal: {
  label: "WRITE-AHEAD LOGGING MODE"
  style.fill: "#DCFCE7"
  style.stroke: "#16A34A"
  style.stroke-width: 3
  
  db_file: "Database File\n(main.db)" {
    shape: cylinder
    style.fill: "#DBEAFE"
    style.stroke: "#2563EB"
  }
  
  wal_file: "WAL File\n(main.db-wal)" {
    shape: cylinder
    style.fill: "#DCFCE7"
    style.stroke: "#16A34A"
  }
  
  wal_index: "WAL-Index\n(main.db-shm)" {
    shape: hexagon
    style.fill: "#E0E7FF"
    style.stroke: "#4F46E5"
  }
  
  wal_file -> wal_index: "Page â†’ Frame\nmapping" {
    style.stroke: "#4F46E5"
    style.stroke-dash: 2
  }
  
  db_file -> wal_file: "Append changes\n(never modify DB)" {
    style.stroke: "#16A34A"
    style.stroke-width: 2
  }
  
  wal_file -> db_file: "Checkpoint\n(batch merge)" {
    style.stroke: "#D97706"
    style.stroke-dash: 3
  }
  
  timeline: {
    label: ""
    shape: sequence_diagram
    
    Writer
    Reader1
    Reader2
    
    Writer.t1 -> Reader1.t1: "BEGIN WRITE"
    Writer.t1.style.fill: "#DCFCE7"
    
    Reader1.t1: "READING" {
      style.fill: "#DCFCE7"
      style.stroke: "#16A34A"
    }
    
    Reader2.t1: "READING" {
      style.fill: "#DCFCE7"
      style.stroke: "#16A34A"
    }
    
    Writer.t2 -> Reader1.t2: "COMMIT"
    
    Reader1.t2: "STILL READING" {
      style.fill: "#DCFCE7"
      style.stroke: "#16A34A"
    }
    
    Reader2.t2: "STILL READING" {
      style.fill: "#DCFCE7"
      style.stroke: "#16A34A"
    }
  }
  
  concurrent_note: |md
    **Readers and writers**
    **run concurrently!**
  |
}

# Comparison table
comparison: {
  label: "Key Differences"
  
  grid-columns: 3
  grid-gap: 0
  
  header_metric: "Metric" {
    class: header
  }
  header_rollback: "Rollback Journal" {
    class: header
  }
  header_wal: "WAL" {
    class: header
  }
  
  metric1: "Reader/Writer"
  rb1: "Exclusive" {
    style.fill: "#FEE2E2"
  }
  wal1: "Concurrent" {
    style.fill: "#DCFCE7"
  }
  
  metric2: "Write Location"
  rb2: "Database file"
  wal2: "WAL file (append)"
  
  metric3: "Recovery"
  rb3: "Restore from journal"
  wal3: "Replay WAL frames"
  
  metric4: "Files Required"
  rb4: "2 (db + journal)"
  wal4: "3 (db + wal + shm)"
  
  metric5: "Best For"
  rb5: "Write-heavy, few readers"
  wal5: "Mixed read/write workloads"
}

classes: {
  header: {
    style.underline: true
    style.bold: true
  }
}

# Write ordering detail
write_ordering: {
  label: "Write Ordering (Both Modes)"
  style.fill: "#F5F5F5"
  style.stroke: "#737373"
  
  step1: "1. Log changes to journal/WAL" {
    style.fill: "#DCFCE7"
  }
  step2: "2. fsync journal/WAL" {
    style.fill: "#FEF3C7"
    style.stroke: "#D97706"
    style.bold: true
  }
  step3: "3. Write to database" {
    style.fill: "#DBEAFE"
  }
  step4: "4. Delete journal / Checkpoint WAL" {
    style.fill: "#E5E7EB"
  }
  
  step1 -> step2 -> step3 -> step4
}

# Snapshot isolation detail
snapshot: {
  label: "WAL Snapshot Isolation"
  style.fill: "#E0E7FF"
  style.stroke: "#4F46E5"
  
  wal_frames: {
    grid-columns: 6
    grid-gap: 2
    
    f1: "Frame 1" {
      style.fill: "#DCFCE7"
    }
    f2: "Frame 2" {
      style.fill: "#DCFCE7"
    }
    f3: "Frame 3" {
      style.fill: "#DCFCE7"
    }
    f4: "Frame 4" {
      style.fill: "#DBEAFE"
    }
    f5: "Frame 5" {
      style.fill: "#DBEAFE"
    }
    f6: "Frame 6" {
      style.fill: "#E5E7EB"
    }
  }
  
  reader_a: "Reader A\n(snapshot=3)" {
    shape: person
    style.fill: "#DCFCE7"
  }
  
  reader_b: "Reader B\n(snapshot=5)" {
    shape: person
    style.fill: "#DBEAFE"
  }
  
  writer: "Writer\n(appending)" {
    shape: person
    style.fill: "#E5E7EB"
  }
  
  reader_a -> wal_frames.f3: "sees"
  reader_b -> wal_frames.f5: "sees"
  writer -> wal_frames.f6: "writes"
  
  note: |md
    Each reader sees a consistent
    snapshot at a specific WAL position
  |
}