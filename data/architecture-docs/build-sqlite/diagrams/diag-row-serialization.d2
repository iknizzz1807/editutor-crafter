vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header-bg: "#E4DBFE"
    data-bg: "#DEE1EB"
    null-bg: "#FFB4AB"
    int-bg: "#B5AFF6"
    text-bg: "#C7F1FF"
    blob-bg: "#88DCF7"
    border: "#525F7F"
    label-color: "#1A1A2E"
  }
}
title: |md
  # Row Record Format
  ### Type-Length-Value Encoding with Variable-Width Integers
| {near: top-center}
direction: right
record_overview: {
  label: ""
  style.fill: transparent
  style.stroke: transparent
  overview_box: {
    label: "Complete Record Structure"
    style.fill: "${colors.data-bg}"
    style.stroke: "${colors.border}"
    style.border-radius: 8
    header_section: {
      label: "Record Header"
      style.fill: "${colors.header-bg}"
      style.stroke: "${colors.border}"
      style.border-radius: 4
      header_size: {
        label: |md
          **Header Size**
          (varint)
          Total bytes in header
          including this field
        |
        style.fill: "${colors.header-bg}"
        style.stroke: "${colors.border}"
        width: 180
      }
      type_codes: {
        label: |md
          **Serial Type Codes**
          (one varint per column)
          Type 0: NULL (0 bytes)
          Type 1: 8-bit int
          Type 2: 16-bit int
          Type 3: 24-bit int
          Type 4: 32-bit int
          Type 5: 48-bit int
          Type 6: 64-bit int
          Type 7: IEEE 754 float
          Type 8: Integer 0 (0 bytes)
          Type 9: Integer 1 (0 bytes)
          Type Nâ‰¥12 even: BLOB
          Type Nâ‰¥13 odd: TEXT
        |
        style.fill: "${colors.header-bg}"
        style.stroke: "${colors.border}"
        width: 180
      }
      header_size -> type_codes: "followed by"
    }
    data_section: {
      label: "Column Data Section"
      style.fill: "${colors.data-bg}"
      style.stroke: "${colors.border}"
      style.border-radius: 4
      data_desc: {
        label: |md
          **Serialized Column Values**
          Each column's bytes follow
          in declaration order.
          Size determined by serial
          type code in header.
        |
        style.fill: "${colors.data-bg}"
        style.stroke: "${colors.border}"
        width: 180
      }
    }
    header_section -> data_section: "immediately\nfollows"
  }
}
spacer: {width: 40; style.fill: transparent; style.stroke: transparent}
serial_types: {
  label: ""
  style.fill: transparent
  style.stroke: transparent
  types_title: {
    label: |md
      ### Serial Type Reference
    |
  }
  null_type: {
    label: |md
      **Type 0: NULL**
      Value: NULL
      Size: 0 bytes
      No data bytes consumed.
      NULL presence encoded
      purely in type code.
    |
    style.fill: "${colors.null-bg}"
    style.stroke: "#B3261E"
    style.border-radius: 6
    width: 160
  }
  int_types: {
    label: |md
      **Integer Types (1-6)**
      Type 1: 8-bit   (1 byte)
      Type 2: 16-bit  (2 bytes)
      Type 3: 24-bit  (3 bytes)
      Type 4: 32-bit  (4 bytes)
      Type 5: 48-bit  (6 bytes)
      Type 6: 64-bit  (8 bytes)
      Big-endian signed integers.
      Type chosen by value range.
    |
    style.fill: "${colors.int-bg}"
    style.stroke: "${colors.border}"
    style.border-radius: 6
    width: 160
  }
  special_int: {
    label: |md
      **Special Integer Types**
      Type 8: Integer 0
      Type 9: Integer 1
      Size: 0 bytes each
      Common values 0 and 1
      encoded in type alone.
      No data bytes needed.
    |
    style.fill: "${colors.int-bg}"
    style.stroke: "${colors.border}"
    style.border-radius: 6
    width: 160
  }
  float_type: {
    label: |md
      **Type 7: IEEE 754 Float**
      Value: 64-bit float
      Size: 8 bytes
      Standard IEEE 754
      double-precision format.
      Big-endian byte order.
    |
    style.fill: "${colors.int-bg}"
    style.stroke: "${colors.border}"
    style.border-radius: 6
    width: 160
  }
  text_type: {
    label: |md
      **Type Nâ‰¥13 (odd): TEXT**
      Formula: (N - 13) / 2
      Example: N=23 â†’ 5 bytes
      Length encoded in type.
      For 5-byte string:
      serial_type = 13 + (5 Ã— 2) = 23
    |
    style.fill: "${colors.text-bg}"
    style.stroke: "${colors.border}"
    style.border-radius: 6
    width: 160
  }
  blob_type: {
    label: |md
      **Type Nâ‰¥12 (even): BLOB**
      Formula: (N - 12) / 2
      Example: N=20 â†’ 4 bytes
      Binary data of any length.
      For 4-byte blob:
      serial_type = 12 + (4 Ã— 2) = 20
    |
    style.fill: "${colors.blob-bg}"
    style.stroke: "${colors.border}"
    style.border-radius: 6
    width: 160
  }
  null_type -> int_types -> special_int -> float_type -> text_type -> blob_type: {style.opacity: 0}
}
spacer2: {width: 40; style.fill: transparent; style.stroke: transparent}
example: {
  label: ""
  style.fill: transparent
  style.stroke: transparent
  example_title: {
    label: |md
      ### Example: `INSERT INTO users VALUES (42, 'Alice', 30)`
    |
  }
  example_record: {
    label: "Serialized Record (11 bytes total)"
    style.fill: "${colors.data-bg}"
    style.stroke: "${colors.border}"
    style.border-radius: 8
    width: 400
    grid-rows: 2
    grid-columns: 4
    grid-gap: 4
    byte_0: {
      label: |md
        **Byte 0**
        `0x04`
        Header size = 4
      |
      style.fill: "${colors.header-bg}"
      style.stroke: "${colors.border}"
      style.border-radius: 4
    }
    byte_1: {
      label: |md
        **Byte 1**
        `0x01`
        id: type 1 (8-bit int)
      |
      style.fill: "${colors.header-bg}"
      style.stroke: "${colors.border}"
      style.border-radius: 4
    }
    byte_2: {
      label: |md
        **Byte 2**
        `0x17` (23)
        name: TEXT(5)
        13 + 5Ã—2 = 23
      |
      style.fill: "${colors.header-bg}"
      style.stroke: "${colors.border}"
      style.border-radius: 4
    }
    byte_3: {
      label: |md
        **Byte 3**
        `0x01`
        age: type 1 (8-bit int)
      |
      style.fill: "${colors.header-bg}"
      style.stroke: "${colors.border}"
      style.border-radius: 4
    }
    byte_4: {
      label: |md
        **Byte 4**
        `0x2A` (42)
        id value (1 byte)
      |
      style.fill: "${colors.int-bg}"
      style.stroke: "${colors.border}"
      style.border-radius: 4
    }
    bytes_5_9: {
      label: |md
        **Bytes 5-9**
        `Alice`
        name value (5 bytes)
        ASCII encoding
      |
      style.fill: "${colors.text-bg}"
      style.stroke: "${colors.border}"
      style.border-radius: 4
    }
    byte_10: {
      label: |md
        **Byte 10**
        `0x1E` (30)
        age value (1 byte)
      |
      style.fill: "${colors.int-bg}"
      style.stroke: "${colors.border}"
      style.border-radius: 4
    }
    legend: {
      label: |md
        **Color Legend**
        ðŸŸ£ Header bytes (4 total)
        ðŸ”µ Data bytes (7 total)
      |
      style.fill: transparent
      style.stroke: transparent
    }
  }
  null_example: {
    label: "NULL Value Example"
    style.fill: "${colors.null-bg}"
    style.stroke: "#B3261E"
    style.border-radius: 8
    width: 400
    null_desc: {
      label: |md
        **Row with NULL:**
        `INSERT INTO users VALUES (99, NULL, 25)`
        **Serialized:**
        03 00 01  63  19
        â”‚  â”‚  â”‚   â”‚   â””â”€ age: 25 (0x19)
        â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€ id: 99 (0x63)
        â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ age: type 1
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ name: type 0 (NULL)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ header size: 3
        **Key Insight:** NULL occupies 0 data bytes.
        Only the type code (0) is stored in header.
      |
      style.fill: "${colors.null-bg}"
      style.stroke: "#B3261E"
      style.border-radius: 4
    }
  }
  varint_example: {
    label: "Varint Encoding"
    style.fill: "${colors.int-bg}"
    style.stroke: "${colors.border}"
    style.border-radius: 8
    width: 400
    varint_desc: {
      label: |md
        **Variable-Length Integers**
        Value 0-127:     1 byte   [0xxxxxxx]
        Value 128-16383: 2 bytes  [1xxxxxxx][0xxxxxxx]
        Value 16384+:    3+ bytes [1xxxxxxx][1xxxxxxx][0xxxxxxx]
        ...
        Max (2â¶â´-1):     9 bytes
        High bit = 1: more bytes follow
        High bit = 0: last byte
        **Example: 300**
        300 = 0b10 0101100
        Encoded: [1 0000010] [0 0101100]
                 = 0x82 0x2C
      |
      style.fill: "${colors.int-bg}"
      style.stroke: "${colors.border}"
      style.border-radius: 4
    }
  }
  example_record -> null_example -> varint_example: {style.opacity: 0}
}
legend_box: {
  near: bottom-center
  label: ""
  style.fill: transparent
  style.stroke: "${colors.border}"
  style.border-radius: 8
  grid-columns: 6
  grid-gap: 8
  l1: {
    label: "Header"
    style.fill: "${colors.header-bg}"
    style.border-radius: 4
  }
  l2: {
    label: "NULL"
    style.fill: "${colors.null-bg}"
    style.border-radius: 4
  }
  l3: {
    label: "Integer"
    style.fill: "${colors.int-bg}"
    style.border-radius: 4
  }
  l4: {
    label: "TEXT"
    style.fill: "${colors.text-bg}"
    style.border-radius: 4
  }
  l5: {
    label: "BLOB"
    style.fill: "${colors.blob-bg}"
    style.border-radius: 4
  }
  l6: {
    label: "Data"
    style.fill: "${colors.data-bg}"
    style.border-radius: 4
  }
}