vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#E8E8E8"
    table-bg: "#FFFFFF"
    stats-bg: "#F0F8FF"
    selectivity-bg: "#FFF8DC"
    highlight: "#4169E1"
    formula-bg: "#F5F5F5"
  }
}
classes: {
  header: {
    style: {
      fill: ${colors.header}
      bold: true
      font-size: 11
    }
  }
}
title: |md
  # Selectivity Estimation
  How ANALYZE enables cardinality prediction
| {near: top-center}
direction: right
source_data: "Source Data (users table)" {
  style.fill: ${colors.table-bg}
  style.stroke: "#666666"
  data_sample: {
    grid-columns: 3
    grid-gap: 0
    style.fill: ${colors.table-bg}
    header_id: "id" {
      class: header
    }
    header_name: "name" {
      class: header  
    }
    header_status: "status" {
      class: header
    }
    row1_id: "1"
    row1_name: "Alice"
    row1_status: "active"
    row2_id: "2"
    row2_name: "Bob"
    row2_status: "inactive"
    row3_id: "3"
    row3_name: "..."
    row3_status: "..."
    row4_id: "10000"
    row4_name: "Zoe"
    row4_status: "pending"
    ellipsis: "..." {
      style.fill: transparent
    }
    ellipsis2: "..." {
      style.fill: transparent
    }
    ellipsis3: "..." {
      style.fill: transparent
    }
  }
  source_note: |md
    10,000 total rows
    `status` column has
    10 distinct values
  | {
    shape: text
    style.font-size: 12
    style.italic: true
  }
}
analyze_process: "ANALYZE Process" {
  style.fill: ${colors.stats-bg}
  style.stroke: ${colors.highlight}
  scan: "Full Table Scan" {
    shape: text
    style.font-size: 14
    style.bold: true
  }
  stats: "Column Statistics" {
    shape: sql_table
    status_col: "status" {
      style.bold: true
    }
    distinct_val: "distinct_count: 10"
    min_val: "min_value: 'active'"
    max_val: "max_value: 'suspended'"
    null_val: "null_count: 0"
  }
  store: "Store in sqlite_stat1" {
    shape: text
    style.font-size: 11
    style.italic: true
  }
}
query_input: "Query Input" {
  style.fill: ${colors.formula-bg}
  style.stroke: "#888888"
  predicate: |md
    sql
    WHERE status = 'active'
    
  | {
    shape: text
    style.font-size: 16
  }
}
estimation: "Selectivity Estimation" {
  style.fill: ${colors.selectivity-bg}
  style.stroke: "#DAA520"
  formula_box: {
    label: "Formula"
    formula: |md
      **Equality Selectivity:**
      `selectivity = 1 / distinct_count`
      For `status` column:
      `selectivity = 1 / 10 = 0.10` (10%)
    | {
      shape: text
      style.font-size: 13
    }
  }
  assumption: "Assumption: Uniform Distribution" {
    shape: text
    style.font-size: 11
    style.italic: true
    style.font-color: "#666666"
  }
  calc_box: {
    label: "Cardinality Estimation"
    calc: |md
      **Estimated Rows:**
      `rows = total_rows × selectivity`
      `rows = 10,000 × 0.10`
      `rows = 1,000`
    | {
      shape: text
      style.font-size: 13
    }
  }
}
decision: "Planner Decision" {
  style.fill: "#E8F5E9"
  style.stroke: "#4CAF50"
  threshold: |md
    **Cost Comparison:**
    - Table scan: 10,000 page reads
    - Index scan: ~1,000 lookups
    1,000 < 10,000 → **Use Index**
  | {
    shape: text
    style.font-size: 12
  }
  result: "✓ Index Scan Selected" {
    shape: text
    style.font-size: 16
    style.bold: true
    style.font-color: "#2E7D32"
  }
}
source_data -> analyze_process: "1. Collect\nStatistics" {
  style.stroke: ${colors.highlight}
  style.stroke-width: 2
}
analyze_process -> query_input: "2. Statistics\nAvailable" {
  style.stroke-dash: 3
}
query_input -> estimation: "3. Estimate\nSelectivity" {
  style.stroke: "#DAA520"
  style.stroke-width: 2
}
estimation -> decision: "4. Choose\nPlan" {
  style.stroke: "#4CAF50"
  style.stroke-width: 2
}
accuracy_note: |md
  **Accuracy depends on:**
  - Fresh statistics (re-run ANALYZE after data changes)
  - Uniform distribution assumption
  - No correlation between columns
  Skewed data → Estimation errors → Suboptimal plans
| {near: bottom-center}