direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- GLOBAL STYLES ---
classes: {
  header_box: {
    style: {
      fill: "#E4DBFE"
      stroke: "#B5AFF6"
      stroke-width: 2
      font-color: "#000000"
    }
  }
  pointer_box: {
    style: {
      fill: "#D5E8D4"
      stroke: "#82B366"
      stroke-width: 2
    }
  }
  data_box: {
    style: {
      fill: "#DAE8FC"
      stroke: "#6C8EBF"
      stroke-width: 2
    }
  }
  gap_box: {
    style: {
      fill: "#F5F5F5"
      stroke: "#666666"
      stroke-dash: 3
    }
  }
  offset_label: {
    shape: text
    style: {
      font: mono
      font-size: 11
      font-color: "#444444"
    }
  }
}

# --- NAVIGATION ---
context: "Context: Milestone 5 - Storage" {
  link: "#build-sqlite-m5"
  back: "Back to Satellite Map" {
    link: "#anchor-id"
  }
}

# --- MAIN DIAGRAM: SLOTTED PAGE STRUCTURE ---
slotted_page: "4KB DATABASE PAGE (Binary Layout)" {
  
  # Offsets Column - Byte-accurate indicators
  offsets: {
    grid-columns: 1
    grid-gap: 0
    
    t0: "0x000" {class: offset_label}
    t1: "0x001" {class: offset_label}
    t3: "0x003" {class: offset_label}
    t5: "0x005" {class: offset_label}
    t7: "0x007" {class: offset_label}
    t8: "0x008" {class: offset_label}
    t12: "0x00C" {class: offset_label}
    gap_ptr: "..." {class: offset_label}
    mid: "FREE" {class: offset_label}
    gap_cell: "..." {class: offset_label}
    bottom: "0xFFF" {class: offset_label}
  }

  # Physical Layout
  layout: {
    grid-columns: 1
    grid-gap: 4

    header: "PAGE HEADER (12 Bytes Metadata)" {
      class: header_box
      grid-columns: 2
      
      type: "Type (1B): 0x0D Leaf / 0x05 Int"
      free_ptr: "Freeblock Off (2B): List head"
      count: "Count (2B): N entries"
      content_start: "Content Start (2B): High Watermark"
      frag: "Frag Bytes (1B): Discarded holes"
      reserved: "Reserved/Right Child (4B)"
    }

    pointer_array: "CELL POINTER ARRAY (2n Bytes)" {
      class: pointer_box
      grid-columns: 4
      
      ptr0: "Ptr[0]\nOffset A"
      ptr1: "Ptr[1]\nOffset B"
      ptr2: "Ptr[2]\nOffset C"
      ptrN: "Ptr[N]\nOffset ..."
    }

    unallocated: "UNALLOCATED SPACE / FRAGMENTATION GAP" {
      class: gap_box
      height: 120
      
      growth_dir: "FREE MEMORY POOL" {
        shape: diamond
        style.fill: white
      }
    }

    cell_content: "CELL CONTENT AREA (Slotted Heap)" {
      class: data_box
      grid-columns: 1
      
      cellN: "Cell N: [Payload (v) + RowID (key)]"
      cell2: "Cell 2: [Payload (v) + RowID (key)]"
      cell1: "Cell 1: [Payload (v) + RowID (key)]"
      cell0: "Cell 0: [Payload (v) + RowID (key)]"
    }
  }
}

# --- ANNOTATED RELATIONSHIPS ---

# Pointer growth
slotted_page.layout.pointer_array -> slotted_page.layout.unallocated: "Array grows DOWNWARDS from offset 0x0C" {
  style: {
    stroke-width: 3
    stroke: "#228B22"
    animated: true
  }
}

# Content growth
slotted_page.layout.cell_content -> slotted_page.layout.unallocated: "Heap grows UPWARDS from page tail 0xFFF" {
  style: {
    stroke-width: 3
    stroke: "#4682B4"
    animated: true
  }
}

# Logical Links (Pointer to Content)
slotted_page.layout.pointer_array.ptr0 -> slotted_page.layout.cell_content.cell0: "Offset Ref: Absolute Pos in Page" {
  style: {
    stroke-dash: 5
    opacity: 0.8
    stroke: "#228B22"
  }
}
slotted_page.layout.pointer_array.ptr1 -> slotted_page.layout.cell_content.cell1: "Relative Jump" {
  style: {
    stroke-dash: 5
    opacity: 0.8
    stroke: "#228B22"
  }
}

# Header link to boundaries
slotted_page.layout.header.content_start -> slotted_page.layout.cell_content: "ContentStart tracks top-most byte" {
  style.stroke: "#6A5ACD"
}

# Scale Indicators
legend: "Technical Specification" {
  near: bottom-right
  
  spec1: "Fixed Page Size: 4,096 Bytes (Standard)"
  spec2: "Pointer Precision: 16-bit Unsigned Integer"
  spec3: "Endianness: Big-Endian (Network Order)"
  spec4: "Compaction: Required when FreeSpace < NewCell"
  
  style: {
    fill: "#FFF2CC"
    stroke: "#D6B656"
  }
}

# Legend for growth
growth_key: "Growth Dynamics" {
  near: center-right
  
  down: "Metadata Expansion (v)" {
    shape: parallelogram
    style.stroke: "#228B22"
    style.fill: "#D5E8D4"
  }
  up: "Payload Accumulation (^)" {
    shape: parallelogram
    style.stroke: "#4682B4"
    style.fill: "#DAE8FC"
  }
}