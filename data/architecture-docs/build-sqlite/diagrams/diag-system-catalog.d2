vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # System Catalog: sqlite_master Table
| {near: top-center}

direction: right

sqlite_master: {
  label: "sqlite_master (Page 1)"
  style.fill: "#E8F5E9"
  style.stroke: "#2E7D32"
  style.stroke-width: 2
  
  header: |md
    **Root Page: 1**
    Special system table
  | {
    style.fill: "#C8E6C9"
    style.stroke: "#2E7D32"
  }
  
  schema: {
    shape: sql_table
    label: "sqlite_master Schema"
    style.fill: "#FAFAFA"
    
    type: TEXT {constraint: "'table', 'index', 'trigger', 'view'"}
    name: TEXT {constraint: "Object name"}
    tbl_name: TEXT {constraint: "Parent table (for indexes)"}
    rootpage: INTEGER {constraint: "B-tree root page #"}
    sql: TEXT {constraint: "Original CREATE statement"}
  }
  
  example_rows: {
    label: "Example Rows"
    style.fill: "#FFF8E1"
    
    row1: ||md
      | type | name | tbl_name | rootpage | sql |
      |------|------|----------|----------|-----|
      | table | users | users | 2 | CREATE TABLE users... |
      | table | orders | orders | 5 | CREATE TABLE orders... |
      | index | idx_email | users | 8 | CREATE INDEX idx_email... |
    ||
  }
}

mapping: {
  label: "Catalog Lookup"
  style.fill: "#E3F2FD"
  style.stroke: "#1565C0"
  style.stroke-width: 2
  
  lookup_flow: {
    shape: sequence_diagram
    
    QueryParser
    Catalog
    BTree
    
    QueryParser -> Catalog: "GetTableRootPage('users')"
    Catalog -> Catalog: "SELECT rootpage FROM sqlite_master WHERE name='users'"
    Catalog -> BTree: "Return page 2"
    QueryParser -> BTree: "OpenTable(cursor, rootPage=2)"
  }
  
  note: ||md
    **Lookup Process:**
    1. Parse table name from SQL
    2. Query sqlite_master for rootpage
    3. Use rootpage to open B-tree cursor
  || {
    style.fill: "#E3F2FD"
    style.stroke: "#1565C0"
    style.stroke-dash: 3
  }
}

pages: {
  label: "Database Pages"
  style.fill: "#FCE4EC"
  style.stroke: "#C2185B"
  style.stroke-width: 2
  
  page1: {
    label: "Page 1\nsqlite_master"
    shape: rectangle
    style.fill: "#E8F5E9"
    style.stroke: "#2E7D32"
    style.bold: true
  }
  
  page2: {
    label: "Page 2\nusers table"
    shape: rectangle
    style.fill: "#FFF3E0"
    style.stroke: "#E65100"
  }
  
  page5: {
    label: "Page 5\norders table"
    shape: rectangle
    style.fill: "#FFF3E0"
    style.stroke: "#E65100"
  }
  
  page8: {
    label: "Page 8\nidx_email"
    shape: rectangle
    style.fill: "#E1F5FE"
    style.stroke: "#0277BD"
  }
  
  more: {
    label: "..."
    shape: text
  }
}

create_flow: {
  label: "CREATE TABLE Flow"
  style.fill: "#F3E5F5"
  style.stroke: "#7B1FA2"
  style.stroke-width: 2
  
  step1: "1. Parse CREATE TABLE statement"
  step2: "2. Allocate new root page (e.g., page 2)"
  step3: "3. Initialize page as empty table leaf"
  step4: "4. INSERT INTO sqlite_master\n   VALUES ('table', 'users', 'users', 2, 'CREATE TABLE...')"
  step5: "5. Commit transaction"
  
  step1 -> step2 -> step3 -> step4 -> step5: {
    style.stroke: "#7B1FA2"
    style.stroke-width: 2
  }
}

sqlite_master.schema -> mapping.lookup_flow: "Schema defines\nlookup structure" {
  style.stroke: "#2E7D32"
  style.stroke-dash: 3
}

mapping.lookup_flow -> pages.page2: "rootpage=2\npoints to users" {
  style.stroke: "#1565C0"
  style.stroke-width: 2
  style.animated: true
}

mapping.lookup_flow -> pages.page5: "rootpage=5\npoints to orders" {
  style.stroke: "#1565C0"
  style.stroke-width: 2
}

mapping.lookup_flow -> pages.page8: "rootpage=8\npoints to index" {
  style.stroke: "#1565C0"
  style.stroke-width: 2
}

create_flow.step4 -> sqlite_master.example_rows: "Inserts metadata\ninto catalog" {
  style.stroke: "#7B1FA2"
  style.stroke-dash: 3
}

legend: {
  near: bottom-center
  style.fill: "#FAFAFA"
  style.stroke: "#BDBDBD"
  
  item1: "Catalog (Page 1)" {
    style.fill: "#E8F5E9"
    shape: rectangle
  }
  item2: "Table Data" {
    style.fill: "#FFF3E0"
    shape: rectangle
  }
  item3: "Index Data" {
    style.fill: "#E1F5FE"
    shape: rectangle
  }
}