vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # Cursor-Based Table Scan: Data Walk
  Tracing cursor movement through B-tree leaf pages
| {near: top-center}
direction: right
legend: {
  near: bottom-center
  cursor_states: {
    shape: sequence_diagram
    label: Cursor State Transitions
    init: Cursor Init
    page1: Page 5, Cell 0, Rowid 1
    page1_next: Page 5, Cell 1, Rowid 2
    page2: Page 8, Cell 0, Rowid 3
    eof: EOF (complete)
    init -> page1: Rewind()
    page1 -> page1_next: Next()
    page1_next -> page2: Next() (page boundary)
    page2 -> eof: Next() (no more rows)
  }
}
step_0_init: {
  label: "STEP 0: Initialize Cursor"
  style.fill: "#E8F5E9"
  style.stroke: "#4CAF50"
  cursor_state: {
    shape: class
    root_page: int
    current_page: int
    current_cell: int
    current_rowid: int
    eof: bool
  }
  action: |md
    `cursor_first(cursor)`
    - Navigate to leftmost leaf
    - Follow leftmost child pointers
  |
}
step_1_page5_cell0: {
  label: "STEP 1: First Row"
  style.fill: "#E3F2FD"
  style.stroke: "#2196F3"
  btree_leaf_1: {
    label: "Leaf Page 5\n(rowid range: 1-2)"
    style.fill: "#BBDEFB"
    style.stroke: "#1976D2"
    header: {
      shape: class
      page_type: "0x0D (leaf)"
      cell_count: int
      right_sibling: int
    }
    cell_0: {
      label: "Cell 0 ◀ CURSOR"
      style.fill: "#FFEB3B"
      style.stroke: "#F57C00"
      style.stroke-width: 3
      content: |md
        **rowid: 1**
        payload: {id=1, name="Alice", age=30}
      |
    }
    cell_1: {
      label: "Cell 1"
      style.fill: "#FAFAFA"
      style.stroke: "#BDBDBD"
      content: |md
        rowid: 2
        payload: {id=2, name="Bob", age=25}
      |
    }
    header -> cell_0 -> cell_1
  }
  cursor_state_1: {
    shape: class
    current_page: int
    current_cell: int
    current_rowid: int
    eof: bool
  }
  row_output_1: {
    label: "Row Output:\n{id=1, name='Alice', age=30}"
    style.fill: "#C8E6C9"
    shape: diamond
  }
  btree_leaf_1.cell_0 -> cursor_state_1: read
  cursor_state_1 -> row_output_1: emit
}
step_2_page5_cell1: {
  label: "STEP 2: Next Row (Same Page)"
  style.fill: "#FFF3E0"
  style.stroke: "#FF9800"
  btree_leaf_2: {
    label: "Leaf Page 5"
    style.fill: "#BBDEFB"
    style.stroke: "#1976D2"
    cell_0_done: {
      label: "Cell 0 ✓"
      style.fill: "#E0E0E0"
      style.stroke: "#9E9E9E"
      style.opacity: 0.6
      content: |md
        rowid: 1 (emitted)
      |
    }
    cell_1_cursor: {
      label: "Cell 1 ◀ CURSOR"
      style.fill: "#FFEB3B"
      style.stroke: "#F57C00"
      style.stroke-width: 3
      content: |md
        **rowid: 2**
        payload: {id=2, name="Bob", age=25}
      |
    }
    cell_0_done -> cell_1_cursor
  }
  cursor_state_2: {
    shape: class
    current_page: int
    current_cell: int
    current_rowid: int
    eof: bool
  }
  row_output_2: {
    label: "Row Output:\n{id=2, name='Bob', age=25}"
    style.fill: "#C8E6C9"
    shape: diamond
  }
  btree_leaf_2.cell_1_cursor -> cursor_state_2: read
  cursor_state_2 -> row_output_2: emit
  transition_2: {
    label: "cursor_next()\ncell_index++"
    shape: text
    style.font-size: 12
    style.italic: true
  }
}
step_3_page_boundary: {
  label: "STEP 3: Page Boundary Cross"
  style.fill: "#FCE4EC"
  style.stroke: "#E91E63"
  btree_leaf_3: {
    label: "Leaf Page 5 (exhausted)"
    style.fill: "#FFCDD2"
    style.stroke: "#C62828"
    style.opacity: 0.7
    exhausted: |md
      cell_index (2) >= cell_count (2)
      → Follow right_sibling pointer
      → right_sibling = 8
    |
  }
  transition_logic: {
    shape: class
    cell_index_incr: "cell_index = 2"
    check: "2 >= 2 (cell_count)"
    action: "current_page = right_sibling"
    result: "current_page = 8"
    reset: "cell_index = 0"
  }
  btree_leaf_3 -> transition_logic
}
step_4_page8_cell0: {
  label: "STEP 4: New Page"
  style.fill: "#E8EAF6"
  style.stroke: "#3F51B5"
  btree_leaf_4: {
    label: "Leaf Page 8\n(rowid range: 3-4)"
    style.fill: "#C5CAE9"
    style.stroke: "#303F9F"
    cell_0_cursor: {
      label: "Cell 0 ◀ CURSOR"
      style.fill: "#FFEB3B"
      style.stroke: "#F57C00"
      style.stroke-width: 3
      content: |md
        **rowid: 3**
        payload: {id=3, name="Carol", age=28}
      |
    }
    cell_1: {
      label: "Cell 1"
      style.fill: "#FAFAFA"
      style.stroke: "#BDBDBD"
      content: |md
        rowid: 4
        payload: {id=4, name="Dave", age=35}
      |
    }
    cell_0_cursor -> cell_1
  }
  cursor_state_4: {
    shape: class
    current_page: int
    current_cell: int
    current_rowid: int
    eof: bool
  }
  row_output_4: {
    label: "Row Output:\n{id=3, name='Carol', age=28}"
    style.fill: "#C8E6C9"
    shape: diamond
  }
  btree_leaf_4.cell_0_cursor -> cursor_state_4: read
  cursor_state_4 -> row_output_4: emit
}
step_5_eof: {
  label: "STEP 5: End of Table"
  style.fill: "#FFEBEE"
  style.stroke: "#F44336"
  final_page: {
    label: "Last Leaf Page"
    style.fill: "#FFCDD2"
    style.stroke: "#C62828"
    exhausted: |md
      Page 8: right_sibling = 0 (null)
      cell_index (2) >= cell_count (2)
      → No more pages
      → Set eof = true
    |
  }
  cursor_state_final: {
    shape: class
    current_page: int
    current_cell: int
    current_rowid: int
    eof: bool
    style.fill: "#FFCDD2"
  }
  eof_signal: {
    label: "EOF SIGNAL\nScan Complete"
    style.fill: "#B71C1C"
    style.font-color: white
    shape: diamond
  }
  final_page -> cursor_state_final
  cursor_state_final -> eof_signal
}
step_0_init -> step_1_page5_cell0: "Rewind\n→"
step_1_page5_cell0 -> step_2_page5_cell1: "Next\n→"
step_2_page5_cell1 -> step_3_page_boundary: "Next\n→"
step_3_page_boundary -> step_4_page8_cell0: "Page cross\n→"
step_4_page8_cell0 -> step_5_eof: "Next (no more)\n→"
page_link: {
  label: "right_sibling\npointer chain"
  style.stroke: "#9C27B0"
  style.stroke-dash: 3
  style.stroke-width: 2
  style.animated: true
  step_1_page5_cell0.btree_leaf_1 -> step_4_page8_cell0.btree_leaf_4
}
code_reference: {
  near: bottom-right
  label: |go
    // Cursor state machine
    type Cursor struct {
        pool         *BufferPool
        rootPage     PageId
        currentPage  PageId
        cellIndex    int
        eof          bool
    }
    func (c *Cursor) Next() {
        c.cellIndex++
        page := fetchPage(c.pool, c.currentPage)
        if c.cellIndex >= page.cellCount {
            if page.rightSibling == 0 {
                c.eof = true
                return
            }
            c.currentPage = page.rightSibling
            c.cellIndex = 0
        }
    }
  |
  shape: code
  style.fill: "#263238"
  style.font-color: "#ECEFF1"
  style.font-size: 11
}