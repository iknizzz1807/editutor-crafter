vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Token Stream: SELECT Statement Transformation" {
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

classes: {
  raw_sql: {
    style: {
      fill: "#E8E8E8"
      stroke: "#666666"
      stroke-width: 2
      font: mono
      font-size: 16
    }
  }
  
  token_keyword: {
    style: {
      fill: "#B5AFF6"
      stroke: "#7B68EE"
      stroke-width: 2
    }
  }
  
  token_operator: {
    style: {
      fill: "#FFB6C1"
      stroke: "#DC143C"
      stroke-width: 2
    }
  }
  
  token_identifier: {
    style: {
      fill: "#98FB98"
      stroke: "#228B22"
      stroke-width: 2
    }
  }
  
  token_literal: {
    style: {
      fill: "#87CEEB"
      stroke: "#4682B4"
      stroke-width: 2
    }
  }
  
  token_punctuation: {
    style: {
      fill: "#F5DEB3"
      stroke: "#D2691E"
      stroke-width: 2
    }
  }
  
  header_box: {
    style: {
      fill: "#2C3E50"
      font-color: white
      bold: true
      font-size: 20
    }
  }
}

before: "BEFORE: Raw SQL Text" {
  class: header_box
  width: 400
}

raw_sql_box: |`
  SELECT * FROM users 
         WHERE id = 42
`| {
  class: raw_sql
  width: 400
  height: 120
}

arrow_base: "→" {
  shape: text
  style: {
    font-size: 36
    bold: true
  }
}

after: "AFTER: Token Stream" {
  class: header_box
  width: 500
}

# Token stream - arranged vertically
tokens_container: {
  style.fill: transparent
  style.stroke: transparent
  
  # Index 0
  t0: {
    grid-columns: 4
    grid-gap: 4
    idx0: "[0]" {
      style: {
        fill: "#333"
        font-color: white
        bold: true
        font: mono
      }
    }
    type0: "KEYWORD" {
      class: token_keyword
      width: 90
    }
    val0: "\"SELECT\"" {
      class: token_keyword
      width: 80
    }
    pos0: "1:1" {
      style: {
        fill: "#F0F0F0"
        font: mono
        font-size: 12
      }
      width: 50
    }
  }
  
  # Index 1
  t1: {
    grid-columns: 4
    grid-gap: 4
    idx1: "[1]" {
      style: {
        fill: "#333"
        font-color: white
        bold: true
        font: mono
      }
    }
    type1: "OPERATOR" {
      class: token_operator
      width: 90
    }
    val1: "\"*\"" {
      class: token_operator
      width: 80
    }
    pos1: "1:8" {
      style: {
        fill: "#F0F0F0"
        font: mono
        font-size: 12
      }
      width: 50
    }
  }
  
  # Index 2
  t2: {
    grid-columns: 4
    grid-gap: 4
    idx2: "[2]" {
      style: {
        fill: "#333"
        font-color: white
        bold: true
        font: mono
      }
    }
    type2: "KEYWORD" {
      class: token_keyword
      width: 90
    }
    val2: "\"FROM\"" {
      class: token_keyword
      width: 80
    }
    pos2: "1:10" {
      style: {
        fill: "#F0F0F0"
        font: mono
        font-size: 12
      }
      width: 50
    }
  }
  
  # Index 3
  t3: {
    grid-columns: 4
    grid-gap: 4
    idx3: "[3]" {
      style: {
        fill: "#333"
        font-color: white
        bold: true
        font: mono
      }
    }
    type3: "IDENTIFIER" {
      class: token_identifier
      width: 90
    }
    val3: "\"users\"" {
      class: token_identifier
      width: 80
    }
    pos3: "1:15" {
      style: {
        fill: "#F0F0F0"
        font: mono
        font-size: 12
      }
      width: 50
    }
  }
  
  # Index 4
  t4: {
    grid-columns: 4
    grid-gap: 4
    idx4: "[4]" {
      style: {
        fill: "#333"
        font-color: white
        bold: true
        font: mono
      }
    }
    type4: "KEYWORD" {
      class: token_keyword
      width: 90
    }
    val4: "\"WHERE\"" {
      class: token_keyword
      width: 80
    }
    pos4: "2:9" {
      style: {
        fill: "#F0F0F0"
        font: mono
        font-size: 12
      }
      width: 50
    }
  }
  
  # Index 5
  t5: {
    grid-columns: 4
    grid-gap: 4
    idx5: "[5]" {
      style: {
        fill: "#333"
        font-color: white
        bold: true
        font: mono
      }
    }
    type5: "IDENTIFIER" {
      class: token_identifier
      width: 90
    }
    val5: "\"id\"" {
      class: token_identifier
      width: 80
    }
    pos5: "2:15" {
      style: {
        fill: "#F0F0F0"
        font: mono
        font-size: 12
      }
      width: 50
    }
  }
  
  # Index 6
  t6: {
    grid-columns: 4
    grid-gap: 4
    idx6: "[6]" {
      style: {
        fill: "#333"
        font-color: white
        bold: true
        font: mono
      }
    }
    type6: "OPERATOR" {
      class: token_operator
      width: 90
    }
    val6: "\"=\"" {
      class: token_operator
      width: 80
    }
    pos6: "2:18" {
      style: {
        fill: "#F0F0F0"
        font: mono
        font-size: 12
      }
      width: 50
    }
  }
  
  # Index 7
  t7: {
    grid-columns: 4
    grid-gap: 4
    idx7: "[7]" {
      style: {
        fill: "#333"
        font-color: white
        bold: true
        font: mono
      }
    }
    type7: "NUMBER" {
      class: token_literal
      width: 90
    }
    val7: "\"42\"" {
      class: token_literal
      width: 80
    }
    pos7: "2:20" {
      style: {
        fill: "#F0F0F0"
        font: mono
        font-size: 12
      }
      width: 50
    }
  }
}

# Transformation arrow
raw_sql_box -> tokens_container: "Tokenizer\nState Machine" {
  style: {
    stroke: "#333"
    stroke-width: 3
    animated: true
  }
}

# Legend
legend: "LEGEND" {
  near: bottom-center
  style: {
    fill: "#FAFAFA"
    stroke: "#CCC"
    stroke-dash: 3
  }
  
  grid-columns: 5
  grid-gap: 8
  
  l1: "KEYWORD" {
    class: token_keyword
  }
  l2: "IDENTIFIER" {
    class: token_identifier
  }
  l3: "OPERATOR" {
    class: token_operator
  }
  l4: "NUMBER" {
    class: token_literal
  }
}

# Annotation: Case insensitivity note
note_case: |md
  **Case-Insensitive Matching:**
  Keywords recognized regardless of case
  (SELECT, select, Select → all KEYWORD)
| {
  near: center-right
  shape: text
  style: {
    font-size: 11
    italic: true
    font-color: "#666"
  }
}

# Annotation: Position tracking note
note_pos: |md
  **Position Tracking:**
  (line:column) enables precise
  error reporting in parser
| {
  near: bottom-right
  shape: text
  style: {
    font-size: 11
    italic: true
    font-color: "#666"
  }
}