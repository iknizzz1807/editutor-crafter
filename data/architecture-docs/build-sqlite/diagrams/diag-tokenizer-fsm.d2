vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right
title: |md
  # SQL Tokenizer State Machine
  Character-by-character FSM with state transitions
| {
  near: top-center
}
classes: {
  state: {
    shape: rectangle
    style: {
      fill: "#E8F4FD"
      stroke: "#2E86AB"
      stroke-width: 2
      border-radius: 8
    }
  }
  accept: {
    shape: rectangle
    style: {
      fill: "#D4EDDA"
      stroke: "#28A745"
      stroke-width: 2
      border-radius: 8
    }
  }
  escape: {
    shape: diamond
    style: {
      fill: "#FFF3CD"
      stroke: "#856404"
      stroke-width: 2
    }
  }
  error: {
    shape: rectangle
    style: {
      fill: "#F8D7DA"
      stroke: "#DC3545"
      stroke-width: 2
      border-radius: 8
    }
  }
}
START: {
  class: state
  label: "START\n(entry point)"
}
IN_IDENTIFIER: {
  class: state
  label: "IN_IDENTIFIER\n→ check keyword table"
}
IN_NUMBER: {
  class: state
  label: "IN_NUMBER\n(int or float)"
}
IN_STRING: {
  class: state
  label: "IN_STRING\n(single-quoted)"
}
IN_QUOTED_ID: {
  class: state
  label: "IN_QUOTED_ID\n(double-quoted)"
}
IN_OPERATOR: {
  class: state
  label: "IN_OPERATOR\n(may be 2-char)"
}
IN_COMMENT: {
  class: state
  label: "IN_COMMENT\n( -- style)"
}
IN_BLOCK_COMMENT: {
  class: state
  label: "IN_BLOCK_COMMENT\n( /* */ style)"
}
ESCAPE_STRING: {
  class: escape
  label: "ESCAPE\n('' detected)"
}
ESCAPE_QUOTED: {
  class: escape
  label: "ESCAPE_QUOTED\n(\"\" detected)"
}
CHECK_SECOND: {
  class: escape
  label: "CHECK_2ND\n(lookahead)"
}
EMIT_TOKEN: {
  class: accept
  label: "EMIT_TOKEN\n→ return to START"
}
ERROR_STATE: {
  class: error
  label: "ERROR\n(unexpected char)"
}
# Transitions from START
START -> IN_IDENTIFIER: "letter or _" {
  style.stroke: "#2E86AB"
}
START -> IN_NUMBER: "digit or ." {
  style.stroke: "#2E86AB"
}
START -> IN_STRING: " ' (single quote)" {
  style.stroke: "#2E86AB"
}
START -> IN_QUOTED_ID: " \" (double quote)" {
  style.stroke: "#2E86AB"
}
START -> IN_OPERATOR: "operator char\n(+ - * / < > = !)" {
  style.stroke: "#2E86AB"
}
START -> IN_COMMENT: "- (check 2nd)" {
  style.stroke: "#856404"
}
START -> IN_BLOCK_COMMENT: "/ (check *)" {
  style.stroke: "#856404"
}
START -> EMIT_TOKEN: "whitespace\n(skip & restart)" {
  style.stroke: "#28A745"
  style.stroke-dash: 3
}
START -> EMIT_TOKEN: "punctuation\nemit immediately" {
  style.stroke: "#28A745"
}
# Identifier transitions
IN_IDENTIFIER -> IN_IDENTIFIER: "alnum or _" {
  style.stroke: "#2E86AB"
}
IN_IDENTIFIER -> EMIT_TOKEN: "other char\n(emit, don't consume)" {
  style.stroke: "#28A745"
}
# Number transitions
IN_NUMBER -> IN_NUMBER: "digit" {
  style.stroke: "#2E86AB"
}
IN_NUMBER -> IN_NUMBER: ". (decimal)" {
  style.stroke: "#2E86AB"
}
IN_NUMBER -> IN_NUMBER: "e/E (exponent)" {
  style.stroke: "#2E86AB"
}
IN_NUMBER -> EMIT_TOKEN: "other char\n(emit NUMBER)" {
  style.stroke: "#28A745"
}
# String literal with escape handling
IN_STRING -> ESCAPE_STRING: " ' (check escape)" {
  style.stroke: "#856404"
}
IN_STRING -> IN_STRING: "any other char" {
  style.stroke: "#2E86AB"
}
ESCAPE_STRING -> IN_STRING: "second '\n(escaped)" {
  style.stroke: "#28A745"
}
ESCAPE_STRING -> EMIT_TOKEN: "not '\n(close string)" {
  style.stroke: "#28A745"
}
# Quoted identifier with escape handling
IN_QUOTED_ID -> ESCAPE_QUOTED: " \" (check escape)" {
  style.stroke: "#856404"
}
IN_QUOTED_ID -> IN_QUOTED_ID: "any other char" {
  style.stroke: "#2E86AB"
}
ESCAPE_QUOTED -> IN_QUOTED_ID: "second \"\n(escaped)" {
  style.stroke: "#28A745"
}
ESCAPE_QUOTED -> EMIT_TOKEN: "not \"\n(close ident)" {
  style.stroke: "#28A745"
}
# Operator with potential 2-char forms
IN_OPERATOR -> CHECK_SECOND: "check next char" {
  style.stroke: "#856404"
}
CHECK_SECOND -> EMIT_TOKEN: "2-char operator\n(<= >= <> != ||)" {
  style.stroke: "#28A745"
}
CHECK_SECOND -> EMIT_TOKEN: "1-char operator\n(emit, unconsume)" {
  style.stroke: "#28A745"
}
# Comment handling
IN_COMMENT -> EMIT_TOKEN: "newline/EOF\n(discard, restart)" {
  style.stroke: "#28A745"
}
IN_COMMENT -> IN_COMMENT: "any char" {
  style.stroke: "#856404"
}
IN_BLOCK_COMMENT -> IN_BLOCK_COMMENT: "any char" {
  style.stroke: "#856404"
}
IN_BLOCK_COMMENT -> EMIT_TOKEN: "*/ (end comment)\n(discard, restart)" {
  style.stroke: "#28A745"
}
# Error handling
IN_STRING -> ERROR_STATE: "unterminated\nstring" {
  style.stroke: "#DC3545"
}
IN_QUOTED_ID -> ERROR_STATE: "unterminated\nidentifier" {
  style.stroke: "#DC3545"
}
IN_BLOCK_COMMENT -> ERROR_STATE: "unterminated\nblock comment" {
  style.stroke: "#DC3545"
}
# Legend
legend: |md
  ## State Machine Legend
  **Input Processing:**
  - Each character examined once
  - State determines interpretation
  - Context resolves ambiguity
  **Escape Sequences:**
  - `''` → single quote in string
  - `""` → double quote in identifier
  - Check next char before emitting
  **2-Char Operators:**
  - Lookahead required for:
    `<=` `>=` `<>` `!=` `||`
  - Emit single char if no match
|
legend.near: bottom-right
legend.shape: rectangle
legend.style.fill: "#F8F9FA"
legend.style.stroke: "#DEE2E6"
legend.style.stroke-width: 1
legend.style.border-radius: 4
# Example flow annotation
example: |md
  ## Example: `'it''s'`
  
  START ──'──► IN_STRING
  IN_STRING ──i──► IN_STRING
  IN_STRING ──t──► IN_STRING
  IN_STRING ──'──► ESCAPE_STRING
  ESCAPE_STRING ──'──► IN_STRING (add ')
  IN_STRING ──s──► IN_STRING
  IN_STRING ──'──► ESCAPE_STRING
  ESCAPE_STRING ──(EOF)──► EMIT_TOKEN
  
  Result: STRING token with value `it's`
|
example.near: bottom-left
example.shape: rectangle
example.style.fill: "#F8F9FA"
example.style.stroke: "#DEE2E6"
example.style.stroke-width: 1
example.style.border-radius: 4