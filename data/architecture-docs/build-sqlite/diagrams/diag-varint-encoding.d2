vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
  }
  colors: {
    c1: "#1a365d"
    c2: "#377f1f"
    c3: "#f4a261"
    c4: "#70e24e"
    c5: "#e4dbfe"
  }
}
title: SQLite Architecture Overview {
  near: top-center
  shape: text
  style: {
    font-size: 48
    bold: true
    underline: true
  }
}
Frontend: Frontend Layer {
  style.fill: "${colors.c4}"
  link: "#frontend-layer"
  SQL Query: "SELECT * FROM users WHERE id = 42" {
    shape: text
    style.font: mono
    style.font-size: 14
  }
}
Compilation: Compilation Layer {
  style.fill: "${colors.c3}"
  link: "#compilation-layer"
}
Storage: Storage Layer {
  style.fill: "${colors.c2}"
  link: "#storage-layer"
}
Transactions: Transaction Layer {
  style.fill: "${colors.c1}"
  link: "#transaction-layer"
}
Frontend -> Compilation: "Tokens → AST"
Compilation -> Storage: "Bytecode → Data Access"
Storage -> Transactions: "Page Reads → ACID"
Transactions -> Frontend: "Durability" {
  style.stroke-dash: 3
}
Frontend: {
  Tokenizer: {
    shape: rectangle
    style.fill: "${colors.c4}"
    label: Tokenizer\n\nLexical Analysis\n\nCharacter → Token
  }
  Parser: {
    shape: rectangle
    style.fill: "${colors.c4}"
    label: Parser\n\nSyntax Analysis\n\nToken → AST
  }
  Query Planner: {
    shape: rectangle
    style.fill: "${colors.c4}"
    label: Query Planner\n\nOptimization\n\nAST → Execution Plan
  }
  Tokenizer -> Parser: "Token Stream"
  Parser -> Query Planner: "AST"
}
Compilation: {
  Bytecode Compiler: {
    shape: rectangle
    style.fill: "${colors.c3}"
    label: Bytecode Compiler\n\nAST → Bytecode
  }
  VDBE: {
    shape: rectangle
    style.fill: "${colors.c3}"
    label: VDBE\n\nVirtual Machine\n\nRegister-based Interpreter
  }
  Bytecode Compiler -> VDBE: "Instruction Stream"
}
Storage: {
  Buffer Pool: {
    shape: rectangle
    style.fill: "${colors.c2}"
    label: Buffer Pool\n\nPage Cache\n\nLRU Eviction
  }
  B-Tree Layer: {
    shape: rectangle
    style.fill: "${colors.c2}"
    label: B-Tree Layer\n\nPage Format\n\nNode Operations
  }
  Pager: {
    shape: rectangle
    style.fill: "${colors.c2}"
    label: Pager\n\nFile I/O\n\nPage Reads/Writes
  }
  Buffer Pool -> B-Tree Layer: "Page Frames"
  B-Tree Layer -> Pager: "Disk I/O"
}
Transactions: {
  Rollback Journal: {
    shape: rectangle
    style.fill: "${colors.c1}"
    label: Rollback Journal\n\nUndo Logging\n\nAtomicity
  }
  WAL: {
    shape: rectangle
    style.fill: "${colors.c1}"
    label: WAL Mode\n\nRedo Logging\n\nConcurrent Readers
  }
  Lock Manager: {
    shape: rectangle
    style.fill: "${colors.c1}"
    label: Lock Manager\n\nIsolation\n\nRead/Write Locks
  }
  Rollback Journal -> WAL: "Mode Switch"
}
VDBE -> Buffer Pool: "Page Requests"
VDBE -> B-Tree Layer: "Row Operations"
Query Planner -> Bytecode Compiler: "Optimized Plan"
Byte_Offset_Legend: {
  near: bottom-right
  shape: rectangle
  style.fill: "#f8f9fa"
  label: |md
    **Key Byte Offsets**
    - Page Header: 0-11 bytes
    - Cell Pointer Array: 12+ bytes
    - Varint: 1-9 bytes
    - Record Header: Variable
  |
}
Performance_Metrics: {
  near: bottom-left
  shape: rectangle
  style.fill: "#e8f5e9"
  label: |md
    **Performance Targets**
    - Tokenizer: <1ms per query
    - Parser: <5ms per query
    - Query Plan: <10ms per query
    - VDBE: 1000 rows in <100ms
  |
}