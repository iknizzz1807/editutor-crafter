vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
title: |md
  # VDBE Virtual Machine Architecture
  Register-Based Bytecode Interpreter
| {near: top-center}
direction: right
# Main VDBE Structure
vdbe: VDBE Virtual Machine {
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a6a"
    stroke-width: 2
    font-color: "#e0e0e0"
  }
  # Program Storage
  program: Compiled Program {
    style.fill: "#16213e"
    instructions: Instruction Array {
      grid-columns: 1
      grid-gap: 2
      i0: "0: OpenRead 0 2 0" {
        style: {
          fill: "#0f3460"
          font: mono
          font-size: 14
        }
      }
      i1: "1: Rewind 0 9 0" {
        style: {
          fill: "#0f3460"
          font: mono
          font-size: 14
        }
      }
      i2: "2: Column 0 1 1" {
        style: {
          fill: "#0f3460"
          font: mono
          font-size: 14
        }
      }
      i3: "3: Le 1 8 2 18" {
        style: {
          fill: "#0f3460"
          font: mono
          font-size: 14
        }
      }
      i4: "4: ResultRow 2 2" {
        style: {
          fill: "#0f3460"
          font: mono
          font-size: 14
        }
      }
      i5: "5: Next 0 2" {
        style: {
          fill: "#0f3460"
          font: mono
          font-size: 14
        }
      }
      i6: "6: Halt 0 0 0" {
        style: {
          fill: "#0f3460"
          font: mono
          font-size: 14
        }
      }
    }
    pc_arrow: "PC ->" {
      shape: text
      style: {
        font-color: "#ff6b6b"
        font-size: 16
        bold: true
      }
    }
  }
  # Execution State
  state: Execution State {
    style.fill: "#16213e"
    pc: Program Counter {
      style.fill: "#e94560"
      style.font-color: white
      pc_value: "pc = 2" {
        shape: text
        style: {
          font: mono
          font-size: 18
          bold: true
        }
      }
    }
    halted: "halted = false" {
      shape: text
      style.font: mono
    }
    error: "error = NULL" {
      shape: text
      style.font: mono
    }
  }
  # Register File
  registers: Register File {
    style.fill: "#16213e"
    reg_header: "**r# | Type | Value**" {
      shape: text
      style: {font: mono; font-size: 12}
    }
    r0: "r0 | NULL | -" {style: {fill: "#1a1a2e"; font: mono; font-size: 12}}
    r1: "r1 | INT | 42" {style: {fill: "#1a1a2e"; font: mono; font-size: 12}}
    r2: "r2 | INT | 1" {style: {fill: "#1a1a2e"; font: mono; font-size: 12}}
    r3: "r3 | STR | Alice" {style: {fill: "#1a1a2e"; font: mono; font-size: 12}}
    r4: "r4 | FLOAT | 3.14" {style: {fill: "#1a1a2e"; font: mono; font-size: 12}}
    r5: "r5 | BLOB | 0x..." {style: {fill: "#1a1a2e"; font: mono; font-size: 12}}
    reg_ellipsis: "..." {style: {font: mono; font-color: "#666"}}
    note: "Dynamic allocation\nby compiler" {
      shape: text
      style: {
        font-color: "#888"
        font-size: 11
        italic: true
      }
    }
  }
  # Cursor Array
  cursors: Cursor Array {
    style.fill: "#16213e"
    cursor_header: "**cursor | table | page | cell | eof**" {
      shape: text
      style: {font: mono; font-size: 11}
    }
    c0: "0 | users | 42 | 5 | false" {style: {fill: "#1a1a2e"; font: mono; font-size: 11}}
    c1: "1 | idx_age | 17 | 0 | false" {style: {fill: "#1a1a2e"; font: mono; font-size: 11}}
    c2: "2 | - | - | - | -" {style: {fill: "#1a1a2e"; font: mono; font-size: 11; font-color: "#666"}}
    cursor_note: "B-tree traversal\nposition state" {
      shape: text
      style: {
        font-color: "#888"
        font-size: 11
        italic: true
      }
    }
  }
}
# Execution Loop
loop: Fetch-Decode-Execute Loop {
  style: {
    fill: "#0d1b2a"
    stroke: "#1b263b"
    stroke-width: 2
  }
  step1: "1. FETCH" {
    style: {
      fill: "#415a77"
      font-color: white
      border-radius: 4
    }
    desc1: "instr = code[pc]" {
      shape: text
      style: {font: mono; font-size: 12; font-color: "#a0a0a0"}
    }
  }
  step2: "2. DECODE" {
    style: {
      fill: "#415a77"
      font-color: white
      border-radius: 4
    }
    desc2: "opcode = instr.opcode\np1, p2, p3 = operands" {
      shape: text
      style: {font: mono; font-size: 12; font-color: "#a0a0a0"}
    }
  }
  step3: "3. EXECUTE" {
    style: {
      fill: "#778da9"
      font-color: "#0d1b2a"
      border-radius: 4
    }
    desc3: "switch(opcode) {...}" {
      shape: text
      style: {font: mono; font-size: 12; font-color: "#333"}
    }
  }
  step4: "4. UPDATE PC" {
    style: {
      fill: "#415a77"
      font-color: white
      border-radius: 4
    }
    desc4: "pc++ OR pc = jump_target" {
      shape: text
      style: {font: mono; font-size: 12; font-color: "#a0a0a0"}
    }
  }
  step1 -> step2 -> step3 -> step4
  step4 -> step1: "loop if !halted" {
    style: {
      stroke: "#e94560"
      stroke-width: 2
      animated: true
    }
  }
}
# Opcode Handler Example
opcode_example: Opcode Handler Detail {
  style: {
    fill: "#1b263b"
    stroke: "#415a77"
  }
  header: ||c
    case OP_Column: {
      int cursor_id = instr->p1;
      int col_index = instr->p2;
      int dest_reg  = instr->p3;
      Cursor* c = &vm->cursors[cursor_id];
      Row* row = cursor_get_row(c);
      copy_value(&vm->registers[dest_reg],
                 &row->columns[col_index]);
      vm->pc++;
      break;
    }
  ||
  header.shape: text
}
# Data Flow
vdbe.program.instructions.i2 -> vdbe.state.pc: "fetch" {
  style: {
    stroke: "#ff6b6b"
    stroke-dash: 3
  }
}
vdbe.state.pc -> loop.step1: "current PC" {
  style: {
    stroke: "#4cc9f0"
    stroke-dash: 2
  }
}
loop.step3 -> vdbe.registers: "read/write" {
  style: {
    stroke: "#4cc9f0"
    stroke-width: 2
  }
}
loop.step3 -> vdbe.cursors: "position" {
  style: {
    stroke: "#7b2cbf"
    stroke-width: 2
  }
}
# Legend
legend: {
  near: bottom-right
  title: "Data Types" {shape: text}
  int: "INT: 64-bit signed" {
    style: {fill: "#2d6a4f"; font-size: 11}
  }
  float: "FLOAT: IEEE 754" {
    style: {fill: "#1d4e89"; font-size: 11}
  }
  str: "STR: null-terminated" {
    style: {fill: "#7b2cbf"; font-size: 11}
  }
  null: "NULL: absent value" {
    style: {fill: "#495057"; font-size: 11}
  }
  blob: "BLOB: raw bytes" {
    style: {fill: "#6c757d"; font-size: 11}
  }
}