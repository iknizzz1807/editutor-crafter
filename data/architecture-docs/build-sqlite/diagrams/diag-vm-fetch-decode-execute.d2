vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # VDBE Execution Cycle
  Virtual Database Engine - Fetch-Decode-Execute Loop
| {near: top-center}

style: {
  fill: "#0d1117"
  stroke: "#30363d"
  font-color: "#c9d1d9"
}

classes: {
  state-box: {
    style: {
      fill: "#161b22"
      stroke: "#30363d"
      border-radius: 8
      font-color: "#c9d1d9"
    }
  }
  vm-state: {
    style: {
      fill: "#21262d"
      stroke: "#f0883e"
      stroke-width: 2
      border-radius: 6
      font-color: "#f0883e"
    }
  }
  cycle-node: {
    style: {
      fill: "#238636"
      stroke: "#3fb950"
      border-radius: 50
      font-color: "#ffffff"
      font-size: 20
      bold: true
    }
  }
  halt-node: {
    style: {
      fill: "#da3633"
      stroke: "#f85149"
      border-radius: 6
      font-color: "#ffffff"
    }
  }
  error-node: {
    style: {
      fill: "#6e3700"
      stroke: "#d29922"
      border-radius: 6
      font-color: "#ffffff"
    }
  }
  flow-arrow: {
    style: {
      stroke: "#58a6ff"
      stroke-width: 2
      animated: true
    }
  }
  data-arrow: {
    style: {
      stroke: "#8b949e"
      stroke-dash: 3
    }
  }
}

VM_State: "VM State" {
  class: state-box
  
  Registers: "Register File\n─────────────\nr0: Value\nr1: Value\nr2: Value\n...\nr255: Value" {
    class: vm-state
  }
  
  PC: "Program Counter\n─────────────\nPC: 0x0004" {
    class: vm-state
  }
  
  Cursors: "Cursor Array\n─────────────\nc0: TableCursor\n    page=42, cell=5\nc1: IndexCursor\n    page=17, cell=0" {
    class: vm-state
  }
  
  Program: "Bytecode Program\n─────────────────────\n[0] OpenTable 0 2 0\n[1] Rewind 0 5 0\n[2] Column 0 0 r1\n[3] ResultRow 1 1 0\n[4] Next 0 2 0\n[5] Halt 0 0 0" {
    class: vm-state
    style.font: mono
    style.font-size: 11
  }
  
  PC -> Program: "points to" {class: data-arrow}
}

Cycle: "Fetch-Decode-Execute Cycle" {
  class: state-box
  
  START: "START" {class: cycle-node; shape: circle}
  
  FETCH: "FETCH\n───────────────\ninstr = Program[PC]\nExtract opcode, P1-P4" {
    class: state-box
    style.fill: "#1f6feb"
    style.stroke: "#58a6ff"
  }
  
  DECODE: "DECODE\n───────────────\nParse operands:\n• P1, P2, P3: integers\n• P4: string/pointer" {
    class: state-box
    style.fill: "#1f6feb"
    style.stroke: "#58a6ff"
  }
  
  EXECUTE: "EXECUTE\n───────────────\nswitch(opcode) {\n  case 'OpenTable': ...\n  case 'Column': ...\n  case 'Next': ...\n}" {
    class: state-box
    style.fill: "#1f6feb"
    style.stroke: "#58a6ff"
  }
  
  UPDATE_PC: "UPDATE PC\n───────────────\nif (!jumped) PC++\nelse PC = target" {
    class: state-box
    style.fill: "#238636"
    style.stroke: "#3fb950"
  }
  
  CHECK_HALT: "Halted?" {shape: diamond; class: state-box}
  
  HALT: "HALT\n───────────────\nExecution complete\nReturn results" {
    class: halt-node
  }
  
  ERROR_HANDLER: "ERROR\n───────────────\n• Constraint violation\n• I/O error\n• Invalid opcode" {
    class: error-node
  }
  
  START -> FETCH: "begin" {class: flow-arrow}
  FETCH -> DECODE: "instr fetched" {class: flow-arrow}
  DECODE -> EXECUTE: "operands ready" {class: flow-arrow}
  EXECUTE -> UPDATE_PC: "op complete" {class: flow-arrow}
  UPDATE_PC -> CHECK_HALT: "continue" {class: flow-arrow}
  CHECK_HALT -> FETCH: "No" {class: flow-arrow; label: "No"}
  CHECK_HALT -> HALT: "Yes" {class: flow-arrow; label: "Yes"}
  
  EXECUTE -> ERROR_HANDLER: "error" {
    style: {
      stroke: "#d29922"
      stroke-width: 2
      animated: true
    }
    label: "exception"
  }
}

VM_State.Cycle -> Cycle.FETCH: "read" {
  style: {
    stroke: "#8b949e"
    stroke-dash: 5
  }
}

Cycle.UPDATE_PC -> VM_State.PC: "update" {
  style: {
    stroke: "#f0883e"
    stroke-dash: 5
  }
}

Cycle.EXECUTE -> VM_State.Registers: "R/W" {
  style: {
    stroke: "#f0883e"
    stroke-dash: 5
  }
}

Cycle.EXECUTE -> VM_State.Cursors: "R/W" {
  style: {
    stroke: "#f0883e"
    stroke-dash: 5
  }
}

legend: |md
  ## Execution Flow
  **Blue arrows**: Control flow through cycle  
  **Orange dashed**: Data access to VM state  
  **Green**: PC update path  
  **Red**: Termination  
  **Yellow**: Error handling
| {near: bottom-center}