vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header-bg: "#1a1a2e"
    header-fg: "#cdd6f4"
    data-bg: "#16161e"
    data-fg: "#e4e4e7"
    ptr-bg: "#313244"
    ptr-fg: "#94b2d5"
    wal-bg: "#1e1e2e"
    wal-fg: "#a6e3a8"
    db-bg: "#0d1117"
    db-fg: "#6ee7b7"
    label-bg: "#27272a"
    label-fg: "#a1a1aa"
    annotate: "#7c3aed"
    annotate-fg: "#c4b5fd"
  }
}

title: |md
  # WAL Checkpoint Process
| {near: top-center}

title.style: {
  font-size: 32
  font-color: ${colors.label-fg}
  bold: true
}

subtitle: |md
  Merging committed WAL frames back to the main database file
| {near: top-center}

subtitle.style: {
  font-size: 16
  font-color: ${colors.label-fg}
  italic: true
}

direction: right

legend: {
  near: bottom-left
  legend-title: Legend {
    shape: text
    style: {
      font-size: 14
      bold: true
      font-color: ${colors.label-fg}
    }
  }
  
  legend-frame: Frame {
    shape: rectangle
    width: 20
    height: 14
    style.fill: ${colors.ptr-bg}
    style.stroke: ${colors.ptr-fg}
  }
  
  legend-page: Page {
    shape: rectangle
    width: 20
    height: 14
    style.fill: ${colors.db-bg}
    style.stroke: ${colors.db-fg}
  }
  
  legend-frame.label: WAL Frame
  legend-page.label: DB Page
  
  legend-title -> legend-frame
  legend-frame -> legend-page
}

step_label: Step 1: Identify Checkpoint Boundary {
  shape: text
  near: top-left
  style: {
    font-size: 18
    font-color: ${colors.annotate-fg}
    bold: true
  }
}

step2_label: Step 2: Copy Frames to Database {
  shape: text
  near: center-left
  style: {
    font-size: 18
    font-color: ${colors.annotate-fg}
    bold: true
  }
}

step3_label: Step 3: Sync & Truncate {
  shape: text
  near: bottom-left
  style: {
    font-size: 18
    font-color: ${colors.annotate-fg}
    bold: true
  }
}

WAL: Write-Ahead Log {
  style: {
    fill: ${colors.wal-bg}
    stroke: ${colors.wal-fg}
    stroke-width: 2
    border-radius: 8
  }
  
  header: WAL Header {
    style: {
      fill: ${colors.header-bg}
      font-color: ${colors.header-fg}
      font-size: 12
    }
  }
  
  f1: Frame 1 {
    style: {
      fill: ${colors.ptr-bg}
      font-color: ${colors.ptr-fg}
    }
    tooltip: "Page 5 v1"
  }
  
  f2: Frame 2 {
    style: {
      fill: ${colors.ptr-bg}
      font-color: ${colors.ptr-fg}
    }
    tooltip: "Page 12 v1"
  }
  
  f3: Frame 3 {
    style: {
      fill: ${colors.ptr-bg}
      font-color: ${colors.ptr-fg}
    }
    tooltip: "Page 5 v2 (COMMIT)"
  }
  
  f4: Frame 4 {
    style: {
      fill: ${colors.ptr-bg}
      font-color: ${colors.ptr-fg}
    }
    tooltip: "Page 8 v1"
  }
  
  f5: Frame 5 {
    style: {
      fill: "#3f3f46"
      font-color: "#a1a1aa"
    }
    label: "..."
  }
  
  f_checkpoint: Checkpoint Boundary {
    style: {
      fill: ${colors.annotate}
      stroke: ${colors.annotate-fg}
      stroke-width: 2
      stroke-dash: 4
    }
  }
  
  header -> f1 -> f2 -> f3 -> f4 -> f5 -> f_checkpoint
}

DB: Database File {
  style: {
    fill: ${colors.db-bg}
    stroke: ${colors.db-fg}
    stroke-width: 2
    border-radius: 8
  }
  
  db_header: DB Header {
    style: {
      fill: ${colors.header-bg}
      font-color: ${colors.header-fg}
      font-size: 12
    }
  }
  
  p1: Page 1 {
    style: {
      fill: ${colors.data-bg}
      font-color: ${colors.data-fg}
    }
  }
  
  p2: Page 2 {
    style: {
      fill: ${colors.data-bg}
      font-color: ${colors.data-fg}
    }
  }
  
  p5: Page 5 {
    style: {
      fill: ${colors.data-bg}
      font-color: ${colors.data-fg}
      stroke: "#ef4444"
      stroke-width: 2
    }
    tooltip: "Will be overwritten"
  }
  
  p8: Page 8 {
    style: {
      fill: ${colors.data-bg}
      font-color: ${colors.data-fg}
      stroke: "#ef4444"
      stroke-width: 2
    }
    tooltip: "Will be overwritten"
  }
  
  p12: Page 12 {
    style: {
      fill: ${colors.data-bg}
      font-color: ${colors.data-fg}
      stroke: "#ef4444"
      stroke-width: 2
    }
    tooltip: "Will be overwritten"
  }
  
  free1: Free Space {
    style: {
      fill: ${colors.label-bg}
      font-color: ${colors.label-fg}
    }
  }
  
  db_header -> p1 -> p2 -> p5 -> p8 -> p12 -> free1
}

readers: Active Readers {
  near: top-right
  style: {
    fill: ${colors.label-bg}
    stroke: ${colors.label-fg}
    border-radius: 4
  }
  
  r1: Reader 1 {
    shape: person
    style: {
      fill: "#22c55e"
      font-color: white
    }
    tooltip: "Snapshot at frame 3"
  }
  
  r2: Reader 2 {
    shape: person
    style: {
      fill: "#22c55e"
      font-color: white
    }
    tooltip: "Snapshot at frame 5"
  }
  
  r1 -> r2
}

arrow1: Identify min snapshot {
  shape: text
  style: {
    font-color: ${colors.annotate-fg}
    font-size: 11
  }
  label: "min_snapshot = frame 3"
}

arrow2: Copy frames 1-3 {
  shape: text
  style: {
    font-color: ${colors.annotate-fg}
    font-size: 11
  }
  label: "copy pages 5, 12, 5"
}

arrow3: fsync database {
  shape: text
  style: {
    font-color: ${colors.annotate-fg}
    font-size: 11
  }
  label: "fsync(DB)"
}

arrow4: Update pointers {
  shape: text
  style: {
    font-color: ${colors.annotate-fg}
    font-size: 11
  }
  label: "advance read ptr"
}

WAL.f_checkpoint -> DB.p5: Overwrite page 5 {
  style: {
    stroke: ${colors.annotate-fg}
    stroke-width: 2
    animated: true
  }
  label: "v2"
}

WAL.f1 -> DB.p5: Original v1 {
  style: {
    stroke: "#6b7280"
    stroke-dash: 3
  }
}

WAL.f2 -> DB.p12: Overwrite page 12 {
  style: {
    stroke: ${colors.annotate-fg}
    stroke-width: 2
    animated: true
  }
}

WAL.f4 -> DB.p8: Overwrite page 8 {
  style: {
    stroke: ${colors.annotate-fg}
    stroke-width: 2
    animated: true
  }
}

readers.r1 -> WAL.f3: Blocks checkpoint past frame 3 {
  style: {
    stroke: "#ef4444"
    stroke-dash: 3
  }
  label: "still needed"
}

step_label -> arrow1 -> readers.r1
step2_label -> arrow2 -> WAL.f_checkpoint
arrow2 -> DB.p5
step3_label -> arrow3 -> DB.free1
arrow3 -> arrow4

annotation: |md
  **Key Points:**
  • Checkpoint only copies frames not needed by active readers
  • Frame 3 is the checkpoint boundary (min_snapshot)
  • Frames 4+ remain in WAL until readers release them
  • Database sync (fsync) ensures durability before truncating
| {
  near: bottom-right
  style: {
    fill: ${colors.label-bg}
    font-color: ${colors.label-fg}
    border-radius: 4
    font-size: 12
  }
}