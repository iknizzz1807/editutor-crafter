vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    wal_color: "#E8D4F8"
    db_color: "#D4E8F8"
    active: "#4CAF50"
    complete: "#8BC34A"
    threshold: "#FF9800"
    text_muted: "#666666"
  }
}
title: |md
  # WAL Checkpoint Process
  **State Evolution: Copying WAL Frames to Main Database**
| {near: top-center}
direction: right
# ============================================
# STATE 1: Before Checkpoint
# ============================================
state1_label: |md
  **STATE 1: Before Checkpoint**
  WAL contains uncommitted + committed frames
  Main database lags behind
| {
  near: top-center
  shape: text
  style.font-size: 14
}
state1: "T=0: WAL Growing" {
  style.fill: "transparent"
  style.stroke: "transparent"
  wal1: "WAL File (.db-wal)" {
    style.fill: ${colors.wal_color}
    style.stroke: "#9C27B0"
    style.stroke-width: 2
    header1: "Header\n(32 bytes)" {
      shape: rectangle
      style.fill: "#F3E5F5"
    }
    frames1: "Committed Frames\n(Frames 1..N)\n\n• Page 42 (v2)\n• Page 17 (v1)\n• Page 55 (v1)\n• ..." {
      shape: rectangle
      style.fill: "#E1BEE7"
    }
    uncommitted1: "Uncommitted Frames\n(No commit marker)\n\n• Page 99 (partial)" {
      shape: rectangle
      style.fill: "#FFCDD2"
      style.stroke-dash: 3
    }
    header1 -> frames1 -> uncommitted1
  }
  db1: "Main Database\n(.db file)" {
    style.fill: ${colors.db_color}
    style.stroke: "#1976D2"
    style.stroke-width: 2
    db_pages1: "Pages (old versions)\n\n• Page 42 (v1) ← stale\n• Page 17 (original)\n• Page 55 (original)\n• Page 99 (original)" {
      shape: rectangle
      style.fill: "#BBDEFB"
    }
  }
  wal1 -> db1: "Checkpoint needed\n(WAL > threshold)" {
    style.stroke: ${colors.threshold}
    style.stroke-width: 2
    style.stroke-dash: 4
    style.font-color: ${colors.threshold}
    label: "Auto-checkpoint\nthreshold: 1000 pages"
  }
}
# ============================================
# STATE 2: Checkpoint In Progress
# ============================================
state2_label: |md
  **STATE 2: Checkpoint In Progress**
  Reading WAL frames → Writing to database
  Readers still see consistent snapshot
| {
  near: top-center
  shape: text
  style.font-size: 14
}
state2: "T=1: Checkpoint Active" {
  style.fill: "transparent"
  style.stroke: "transparent"
  process2: "Checkpoint Process" {
    style.fill: "#FFF8E1"
    style.stroke: "#FFC107"
    step1: "1. Identify commit boundary\n   (last committed frame)" {
      shape: rectangle
      style.fill: "#FFECB3"
    }
    step2: "2. Build page list\n   (latest version per page)" {
      shape: rectangle
      style.fill: "#FFE082"
    }
    step3: "3. Copy pages to database\n   (sequential writes)" {
      shape: rectangle
      style.fill: "#FFD54F"
    }
    step4: "4. fsync() database\n   (ensure durability)" {
      shape: rectangle
      style.fill: "#FFCA28"
    }
    step1 -> step2 -> step3 -> step4
  }
  wal2: "WAL File" {
    style.fill: ${colors.wal_color}
    frame_reading: "Reading...\nFrame: Page 42\nOffset: 1024" {
      style.fill: ${colors.active}
      style.font-color: white
    }
  }
  db2: "Main Database" {
    style.fill: ${colors.db_color}
    db_writing: "Writing...\nPage 42 (v2)" {
      style.fill: ${colors.active}
      style.font-color: white
    }
  }
  process2.step3 -> wal2: "Read frame" {
    style.stroke: ${colors.active}
    style.animated: true
  }
  process2.step3 -> db2: "Write page" {
    style.stroke: ${colors.active}
    style.animated: true
  }
}
# ============================================
# STATE 3: After Checkpoint
# ============================================
state3_label: |md
  **STATE 3: After Checkpoint Complete**
  WAL truncated, database updated
  New salt values invalidate old frames
| {
  near: top-center
  shape: text
  style.font-size: 14
}
state3: "T=2: Checkpoint Complete" {
  style.fill: "transparent"
  style.stroke: "transparent"
  wal3: "WAL File (Reset)" {
    style.fill: ${colors.wal_color}
    style.stroke: ${colors.complete}
    style.stroke-width: 2
    header3: "Header (NEW)\n• checkpoint_seq++\n• salt_1 = random()\n• salt_2 = random()" {
      shape: rectangle
      style.fill: "#C8E6C9"
    }
    empty3: "(Empty - ready for\n new transactions)" {
      shape: rectangle
      style.fill: "#E8F5E9"
      style.stroke-dash: 2
      style.font-color: ${colors.text_muted}
    }
    header3 -> empty3
  }
  db3: "Main Database (Updated)" {
    style.fill: ${colors.db_color}
    style.stroke: ${colors.complete}
    style.stroke-width: 2
    db_pages3: "Pages (current versions)\n\n• Page 42 (v2) ← updated ✓\n• Page 17 (v1) ← updated ✓\n• Page 55 (v1) ← updated ✓\n• Page 99 (original)\n  (uncommitted, not copied)" {
      shape: rectangle
      style.fill: "#C8E6C9"
    }
  }
  wal3 -> db3: "Checkpoint complete\n(Database synced)" {
    style.stroke: ${colors.complete}
    style.stroke-width: 2
  }
}
# ============================================
# Flow Between States
# ============================================
state1 -> state2: "Checkpoint triggered\n(WAL ≥ threshold)" {
  style.stroke: "#333"
  style.stroke-width: 3
}
state2 -> state3: "Checkpoint complete\n(fsync + truncate)" {
  style.stroke: ${colors.complete}
  style.stroke-width: 3
}
# ============================================
# Auto-Checkpoint Details
# ============================================
auto_checkpoint: |md
  ## Auto-Checkpoint Configuration
  
  PRAGMA wal_autocheckpoint = 1000;
  
  **Triggers checkpoint when:**
  - WAL contains ≥ 1000 frames
  **Checkpoint modes:**
  - `PASSIVE`: No blocking (default)
  - `FULL`: Wait for readers
  - `RESTART`: Block new readers
  - `TRUNCATE`: Also truncate file
| {
  near: bottom-center
  shape: rectangle
  style.fill: "#FAFAFA"
  style.stroke: "#E0E0E0"
  width: 400
}
# ============================================
# Checkpoint Mode Comparison
# ============================================
modes: "Checkpoint Modes" {
  style.fill: "transparent"
  passive: "PASSIVE\n• No blocking\n• Best effort\n• May leave frames" {
    shape: rectangle
    style.fill: "#E3F2FD"
  }
  full: "FULL\n• Wait for readers\n• Complete checkpoint\n• Brief blocking" {
    shape: rectangle
    style.fill: "#FFF3E0"
  }
  restart: "RESTART\n• Block new readers\n• Full checkpoint\n• Reset WAL" {
    shape: rectangle
    style.fill: "#FCE4EC"
  }
  truncate: "TRUNCATE\n• Full blocking\n• Truncate WAL file\n• Reset to zero size" {
    shape: rectangle
    style.fill: "#F3E5F5"
  }
  passive -> full -> restart -> truncate
}