vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    request: "#3B82F6"
    buffer_pool: "#10B981"
    wal_index: "#8B5CF6"
    wal_file: "#F59E0B"
    response: "#10B981"
    snapshot: "#EC4899"
  }
}

title: {
  label: "WAL Page Lookup: Finding the Latest Version"
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

# Legend
legend: {
  near: top-right
  style.fill: "#F8FAFC"
  style.stroke: "#CBD6E1"
  label: "Legend"
  
  step1: "1. Request" {
    shape: text
    style.font-color: ${colors.request}
  }
  step2: "2. Check Buffer Pool" {
    shape: text
    style.font-color: ${colors.buffer_pool}
  }
  step3: "3. Check WAL-Index" {
    shape: text
    style.font-color: ${colors.wal_index}
  }
  step4: "4. Read WAL Frame" {
    shape: text
    style.font-color: ${colors.wal_file}
  }
  step5: "5. Return Page" {
    shape: text
    style.font-color: ${colors.response}
  }
}

# Input
request: {
  label: "Page Request\n\nPageID: 42\nSnapshot: {maxFrame: 150}"
  shape: rectangle
  style: {
    fill: ${colors.request}
    font-color: white
    bold: true
    stroke: "#1D4ED8"
    shadow: true
  }
}

# Step 1: Check Buffer Pool
buffer_pool: {
  label: "Buffer Pool\n(Cache)"
  shape: cylinder
  style: {
    fill: "#D1FAE5"
    stroke: ${colors.buffer_pool}
    stroke-width: 3
  }
  
  frame_42: "Frame 42\n(Page 5)" {
    shape: rectangle
    style.fill: "#FEE2E2"
    style.stroke: "#EF4444"
    style.stroke-dash: 3
  }
  frame_17: "Frame 17\n(Page 42)" {
    shape: rectangle
    style.fill: white
    style.stroke: "#D1D5DB"
  }
  frame_8: "Frame 8\n(Page 100)" {
    shape: rectangle
    style.fill: white
    style.stroke: "#D1D5DB"
  }
}

buffer_pool_result: {
  label: "Page 42\nNOT in cache"
  shape: diamond
  style: {
    fill: "#FEF3C7"
    stroke: "#F59E0B"
    stroke-width: 2
  }
}

# Step 2: Check WAL-Index
wal_index: {
  label: "WAL-Index\n(Hash Table)\n\nO(1) hash lookup"
  shape: rectangle
  style: {
    fill: "#EDE9FE"
    stroke: ${colors.wal_index}
    stroke-width: 3
    shadow: true
  }
  
  hash_table: {
    label: ""
    grid-columns: 2
    grid-gap: 0
    
    header_page: "Page#" {
      style.fill: ${colors.wal_index}
      style.font-color: white
      style.bold: true
    }
    header_frame: "Frame" {
      style.fill: ${colors.wal_index}
      style.font-color: white
      style.bold: true
    }
    
    row1_page: "5"
    row1_frame: "45"
    row2_page: "42"
    row2_frame: "147"
    row3_page: "100"
    row3_frame: "12"
    
    row1_page.style.stroke: "#D1D5DB"
    row1_frame.style.stroke: "#D1D5DB"
    row2_page.style: {
      fill: "#FEF3C7"
      stroke: "#F59E0B"
      stroke-width: 3
      bold: true
    }
    row2_frame.style: {
      fill: "#FEF3C7"
      stroke: "#F59E0B"
      stroke-width: 3
      bold: true
    }
    row3_page.style.stroke: "#D1D5DB"
    row3_frame.style.stroke: "#D1D5DB"
  }
}

index_lookup: {
  label: |md
    **Lookup: Page 42**
    
    Hash: `42 % 256 = 42`
    
    Entry found: Frame 147
    
    **Snapshot Check:**
    `147 ≤ 150` ✓
    
    Frame is visible!
  |
  shape: rectangle
  style: {
    fill: "#ECFDF5"
    stroke: ${colors.response}
    stroke-width: 2
  }
}

# Step 3: WAL File
wal_file: {
  label: "WAL File\n(.db-wal)"
  shape: rectangle
  style: {
    fill: "#FEF3C7"
    stroke: ${colors.wal_file}
    stroke-width: 3
    shadow: true
  }
  
  header: "WAL Header\n(32 bytes)" {
    style.fill: "#FCD34D"
    style.stroke: "#B45309"
  }
  
  frames: {
    label: "Frames\n\nOnly frames ≤ maxFrame\nare visible to this reader"
    
    frame_145: "F145\n(Page 5)" {
      style.fill: white
      style.stroke: "#D1D5DB"
      style.font-size: 10
    }
    frame_146: "F146\n(Page 88)" {
      style.fill: white
      style.stroke: "#D1D5DB"
      style.font-size: 10
    }
    frame_147: "F147\n(Page 42)\n✓ TARGET" {
      style: {
        fill: "#D1FAE5"
        stroke: ${colors.response}
        stroke-width: 3
        bold: true
      }
    }
    frame_148: "F148\n(Page 5)" {
      style.fill: white
      style.stroke: "#D1D5DB"
      style.font-size: 10
    }
    frame_149: "F149\n(Page 17)" {
      style.fill: "#FEE2E2"
      style.stroke: "#EF4444"
      style.stroke-dash: 2
      style.font-size: 10
    }
    frame_150: "F150\n(Page 42)\n✗ Beyond snapshot" {
      style: {
        fill: "#FEE2E2"
        stroke: "#EF4444"
        stroke-dash: 3
        font-color: "#991B1B"
      }
    }
  }
}

# Frame Detail
frame_detail: {
  label: |md
    **Frame 147 Contents**
    
    
    ┌────────────────────────────┐
    │ Page Number: 42            │
    │ Commit Size: 0             │
    │ Salt-1: 0x7A3F             │
    │ Salt-2: 0x2B91             │
    │ Checksum-1: 0xA4C7         │
    │ Checksum-2: 0x8E23         │
    ├────────────────────────────┤
    │                            │
    │   Page Data (4096 bytes)   │
    │                            │
    │   [B-tree node content]    │
    │                            │
    │                            │
    └────────────────────────────┘
    
  |
  shape: rectangle
  style: {
    fill: "#F0FDF4"
    stroke: ${colors.response}
    stroke-width: 2
    font: mono
  }
}

# Output
result: {
  label: "Page 42 Data\n(4096 bytes)\n\nReturned to Buffer Pool\nfor query execution"
  shape: rectangle
  style: {
    fill: ${colors.response}
    font-color: white
    bold: true
    stroke: "#047857"
    shadow: true
  }
}

# Snapshot Context
snapshot_box: {
  near: bottom-center
  label: |md
    **Snapshot Isolation Principle**
    
    Each reader captures `maxFrame` at transaction start.
    
    - Reader sees frames 0..maxFrame
    - Newer frames are invisible
    - Enables concurrent readers + writers
    
    This reader (maxFrame=150):
    - Can read Frame 147 ✓
    - Cannot see Frame 150 (same page, newer version)
  |
  shape: rectangle
  style: {
    fill: "#FDF2F8"
    stroke: ${colors.snapshot}
    stroke-width: 2
  }
}

# Connections
request -> buffer_pool: "1. Check cache" {
  style: {
    stroke: ${colors.request}
    stroke-width: 3
    animated: true
  }
}

buffer_pool -> buffer_pool_result: "Cache miss" {
  style.stroke: "#EF4444"
}

buffer_pool_result -> wal_index: "2. Lookup in WAL-Index" {
  style: {
    stroke: ${colors.wal_index}
    stroke-width: 3
    animated: true
  }
}

wal_index -> index_lookup: "Found:\nFrame 147" {
  style: {
    stroke: ${colors.wal_index}
    stroke-width: 2
  }
}

index_lookup -> wal_file: "3. Read frame from WAL" {
  style: {
    stroke: ${colors.wal_file}
    stroke-width: 3
    animated: true
  }
}

wal_file -> frame_detail: "Extract\npage data" {
  style.stroke: ${colors.response}
}

frame_detail -> result: "4. Return page" {
  style: {
    stroke: ${colors.response}
    stroke-width: 3
    animated: true
  }
}

# Alternative path: Page in database file
db_file: {
  label: "Database File\n(.db)"
  shape: cylinder
  style: {
    fill: "#E0E7FF"
    stroke: "#6366F1"
    stroke-width: 2
  }
}

buffer_pool_result -> db_file: "If not in WAL:\nread from DB file" {
  style: {
    stroke: "#6366F1"
    stroke-dash: 5
  }
}

db_file -> result: "Fallback path" {
  style: {
    stroke: "#6366F1"
    stroke-dash: 5
  }
}