direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# Metadata and Atlas Linking
title: |md
  # WAL Concurrency Architecture (Snapshot Isolation)
  **Status**: Concurrent Read/Write (Non-blocking)
  **Isolation Level**: Snapshot (MVCC-like)
| {near: top-center}

# Context Navigation
back_to_map: "Back to Satellite Map (L0)" {
  link: "#l0-satellite-map"
  shape: rectangle
  style: {
    stroke-dash: 3
    fill: "#f8f9fa"
  }
}

# --- GLOBAL STYLES ---
***.style.font: mono

# --- ACTIVE PROCESSES ---
processes: {
  reader: "Reader Process (VM)" {
    shape: person
    style.fill: "#e7f3ff"
    style.stroke: "#007bff"
    
    state: "READ_MARK = Frame 0" {
      tooltip: "Reader is pinned to the DB state prior to current WAL appends"
      style.font-color: "#007bff"
    }
  }

  writer: "Writer Process (VM)" {
    shape: person
    style.fill: "#fff0f0"
    style.stroke: "#dc3545"
    
    state: "TRANSACTION_ACTIVE" {
      style.font-color: "#dc3545"
    }
  }
}

# --- SHARED MEMORY (WAL INDEX) ---
shm: "WAL Index (example.db-shm)" {
  style.fill: "#f3e5f5"
  style.stroke: "#6a1b9a"
  link: "#milestone-10-shm"

  header: "Index Header (Hash Table)" {
    shape: sql_table
    page_id: "Page ID (4B)"
    wal_frame: "WAL Frame Pointer (4B)"
    entry_1: "Page 1 -> Frame 0"
  }

  mapping_logic: "Logic: If PageID in Index AND Frame <= ReadMark -> Use WAL" {
    shape: text
    style.font-size: 10
  }
}

# --- MEMORY LAYER ---
buffer_pool: "Buffer Pool (RAM)" {
  style.fill: "#f8f9fa"
  
  frame_1: "Frame A (Page 1, v1)" {
    style.stroke: "#007bff"
    style.stroke-width: 3
    tooltip: "Cached for Reader: Balance=100"
  }
  
  frame_2: "Frame B (Page 1, v2)" {
    style.stroke: "#dc3545"
    style.stroke-width: 3
    tooltip: "Dirty page being written by Writer: Balance=200"
  }
}

# --- DISK LAYER ---
disk: "Disk Storage" {
  
  main_db: "Main Database (example.db)" {
    style.double-border: true
    
    ann2: "Reader looks here" {
      shape: text
      style.font-color: "#007bff"
      style.bold: true
    }

    p1_v1: "Page 1 (Version 1)" {
      tooltip: "Original Data: [Balance=100]"
      style.fill: "#e7f3ff"
    }
    p2_v1: "Page 2 (Static)"
  }

  wal_file: "Write-Ahead Log (example.db-wal)" {
    style.fill: "#fffde7"
    style.stroke: "#fbc02d"
    link: "#milestone-10-wal-format"

    ann1: "Writer appends here" {
      shape: text
      style.font-color: "#dc3545"
      style.bold: true
    }

    header: "WAL Header (32 bytes)" {
      tooltip: "0x00: Magic, 0x08: PageSize, 0x12: Checksum"
      style.fill: "#fbc02d"
    }

    frame_1: "Frame 1 (Page 1, v2)" {
      tooltip: "New Data: [Balance=200]"
      style.fill: "#fff0f0"
      style.stroke: "#dc3545"
    }
  }
}

# --- INTERCONNECTIONS (THE DATA WALK) ---

# Reader Walk (Snapshot Isolation)
processes.reader -> shm.header: "1. Lookup Page 1 (ReadMark=0)" {
  style.stroke: "#007bff"
  style.animated: true
}

shm.header -> processes.reader: "2. Result: NOT FOUND in Snapshot" {
  style.stroke: "#007bff"
  style.stroke-dash: 3
}

processes.reader -> disk.main_db.p1_v1: "3. pread() Page 1 from Main DB" {
  style.stroke: "#007bff"
  target-arrowhead: arrow
}

disk.main_db.p1_v1 -> buffer_pool.frame_1: "4. Load 4KB Page into Cache" {
  style.stroke: "#007bff"
}

# Writer Walk (Append Logic)
processes.writer -> buffer_pool.frame_2: "1. Modify Page 1 in RAM" {
  style.stroke: "#dc3545"
}

buffer_pool.frame_2 -> disk.wal_file.frame_1: "2. pwrite() Sequential Append" {
  style.stroke: "#dc3545"
  style.animated: true
  label: "4096 bytes + Checksum"
}

disk.wal_file.frame_1 -> shm.header: "3. Update Hash Table" {
  style.stroke: "#6a1b9a"
  label: "Page 1 -> Frame 1"
}

# Visual Legend / Constraints
legend: {
  near: bottom-right
  
  r: "Reader (v1 Snapshot)" {
    style.fill: "#e7f3ff"
    style.stroke: "#007bff"
  }
  w: "Writer (v2 Append)" {
    style.fill: "#fff0f0"
    style.stroke: "#dc3545"
  }
  
  logic: |md
    **Snapshot Rule:**
    Readers are isolated from
    writers because the main 
    file is immutable during
    the WAL append.
  |
}