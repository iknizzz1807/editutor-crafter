vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#E8D5B7"
    frame: "#B8D4E3"
    page_num: "#F0B7B7"
    checksum: "#D5E8D4"
    page_data: "#C3E8C3"
    wal_index: "#E1D5E7"
    reader: "#FFF2CC"
    arrow_blue: "#3B82F6"
    arrow_green: "#10B981"
  }
}
title: |md
  # WAL File Format
  Write-Ahead Log Structure for Concurrent Reads
| {near: top-center}
direction: right
wal_file: {
  label: "WAL File (.db-wal)"
  style.fill: white
  style.stroke: "#666"
  style.stroke-width: 2
  header: {
    label: "WAL Header\n(32 bytes)"
    style.fill: ${colors.header}
    style.stroke: "#8B7355"
    magic: "Magic: 0x377f0682\n(Big/Little Endian)"
    format: "Format Version"
    page_size: "Page Size (4KB)"
    checkpoint: "Checkpoint Seq"
    salts: "Salt₁, Salt₂\n(Random)"
    checksum: "Checksum₁, Checksum₂"
  }
  frames: {
    label: "Frame Sequence (Append-Only)"
    style.fill: ${colors.frame}
    style.stroke: "#5B9BD5"
    frame1: {
      label: "Frame 1"
      style.fill: white
      f1_header: {
        label: "Frame Header\n(24 bytes)"
        style.fill: ${colors.page_num}
        f1_page: "Page #: 42"
        f1_commit: "Commit: 0\n(non-commit)"
        f1_salts: "Salts (match header)"
        f1_checksum: "Checksums\n(Cumulative)"
      }
      f1_data: {
        label: "Page Data\n(4096 bytes)"
        style.fill: ${colors.page_data}
        style.stroke: "#228B22"
        f1_content: "Modified Page 42\n(Version 1)"
      }
      f1_header -> f1_data
    }
    frame2: {
      label: "Frame 2"
      style.fill: white
      f2_header: {
        label: "Frame Header"
        style.fill: ${colors.page_num}
        f2_page: "Page #: 17"
        f2_commit: "Commit: 100\n(COMMIT MARKER)"
        f2_salts: "Salts"
        f2_checksum: "Checksums"
      }
      f2_data: {
        label: "Page Data"
        style.fill: ${colors.page_data}
        f2_content: "Modified Page 17"
      }
      f2_header -> f2_data
    }
    frame3: {
      label: "Frame 3"
      style.fill: white
      f3_header: {
        label: "Frame Header"
        style.fill: ${colors.page_num}
        f3_page: "Page #: 42"
        f3_commit: "Commit: 0"
        f3_salts: "Salts"
        f3_checksum: "Checksums"
      }
      f3_data: {
        label: "Page Data"
        style.fill: ${colors.page_data}
        f3_content: "Modified Page 42\n(Version 2 - NEWER)"
      }
      f3_header -> f3_data
    }
    ellipsis: "..." {
      shape: text
      style.font-size: 24
    }
    frame1 -> frame2 -> frame3 -> ellipsis
  }
  header -> frames
}
wal_index: {
  label: "WAL Index (In-Memory)"
  style.fill: ${colors.wal_index}
  style.stroke: "#7B68EE"
  style.stroke-width: 2
  index_title: |md
    Hash Table: Page# → Frame Offset
    (Most recent version only)
  | {shape: text}
  index_entries: {
    label: ""
    style.fill: transparent
    entry1: {
      label: "Page 42 → Frame 3"
      style.fill: "#E8D5E7"
    }
    entry2: {
      label: "Page 17 → Frame 2"
      style.fill: "#E8D5E7"
    }
  }
  index_title -> index_entries
}
reader_flow: {
  label: "Reader Page Lookup"
  style.fill: ${colors.reader}
  style.stroke: "#D4A017"
  style.stroke-width: 2
  step1: "1. Capture snapshot\n(max_frame = 3)"
  step2: "2. Check WAL Index\nfor page 42"
  step3: "3. Frame 3 offset ≤ max_frame?\nYES → Read from WAL"
  step4: "4. If not in WAL or too new:\nRead from main DB"
  step1 -> step2 -> step3 -> step4
}
version_logic: {
  label: "Version Selection Logic"
  style.fill: "#F5F5F5"
  style.stroke: "#666"
  scenario: |md
    **Scenario: Reader needs Page 42**
    WAL contains:
    • Frame 1: Page 42 v1 (offset 32)
    • Frame 3: Page 42 v2 (offset 4160)
    Reader snapshot: max_frame = 2
    • Frame 3 is TOO NEW (4160 > 2)
    • Index points to Frame 3
    • Reader falls back to main DB
    Reader snapshot: max_frame = 3
    • Frame 3 is VISIBLE (4160 ≤ 3)
    • Reader gets Page 42 v2
  | {shape: text}
}
wal_file -> wal_index: "Build index\non startup" {
  style.stroke: ${colors.arrow_blue}
  style.stroke-width: 2
  style.animated: true
}
wal_index -> reader_flow: "Query index" {
  style.stroke: ${colors.arrow_green}
  style.stroke-width: 2
}
reader_flow -> version_logic: "Apply snapshot" {
  style.stroke: "#666"
  style.stroke-dash: 3
}
legend: {
  label: "Key Concepts"
  style.fill: white
  style.stroke: "#999"
  commit_marker: {
    label: "Commit Marker\n(commit_size > 0)"
    style.fill: ${colors.page_num}
  }
  cumulative: {
    label: "Cumulative Checksums\n(each frame includes all prior)"
    style.fill: ${colors.checksum}
  }
  snapshot: {
    label: "Snapshot Isolation\n(readers see point-in-time)"
    style.fill: ${colors.reader}
  }
  commit_marker -> cumulative -> snapshot
}
legend.near: bottom-right