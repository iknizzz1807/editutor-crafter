vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    rollback: "#E8D5B7"
    rollback_accent: "#C9A66B"
    wal: "#B5D8EB"
    wal_accent: "#5BA3C0"
    database: "#D4E5D4"
    database_accent: "#7BC47B"
    danger: "#E57373"
    success: "#81C784"
    warning: "#FFB74D"
    header_bg: "#F5F5F5"
    text_dark: "#333333"
  }
}
title: |md
  # Rollback Journal vs Write-Ahead Log
  ### Architectural Difference: Undo vs Redo Logging
| {near: top-center}
direction: right
comparison: {
  grid-columns: 2
  grid-gap: 40
  rollback_container: Rollback Journal (UNDO Log) {
    style.fill: "${colors.rollback}"
    style.stroke: "${colors.rollback_accent}"
    style.stroke-width: 3
    style.border-radius: 12
    rollback_header: |md
      **Stores ORIGINAL pages**
      *Before modification*
    |
    direction: down
    rollback_flow: {
      direction: down
      style.fill: "transparent"
      style.stroke: "transparent"
      step1_r: {
        style.fill: "white"
        style.stroke: "${colors.rollback_accent}"
        style.border-radius: 8
        label: "1. Read original page"
        style.font-size: 14
      }
      step2_r: {
        style.fill: "${colors.rollback}"
        style.stroke: "${colors.rollback_accent}"
        style.border-radius: 8
        label: "2. Write to Journal\n(ORIGINAL data)"
        style.font-size: 14
        style.bold: true
      }
      step3_r: {
        style.fill: "${colors.danger}"
        style.stroke: "#C62828"
        style.border-radius: 8
        label: "3. fsync(journal)\n⚡ BLOCKING"
        style.font-size: 14
        style.font-color: "white"
      }
      step4_r: {
        style.fill: "${colors.database}"
        style.stroke: "${colors.database_accent}"
        style.border-radius: 8
        label: "4. Modify Database\n(new data in place)"
        style.font-size: 14
      }
      step5_r: {
        style.fill: "white"
        style.stroke: "${colors.rollback_accent}"
        style.border-radius: 8
        label: "5. fsync(database)"
        style.font-size: 14
      }
      step6_r: {
        style.fill: "${colors.success}"
        style.stroke: "#2E7D32"
        style.border-radius: 8
        label: "6. Delete Journal\n✓ COMMIT"
        style.font-size: 14
        style.font-color: "white"
      }
      step1_r -> step2_r: "original"
      step2_r -> step3_r: "sync"
      step3_r -> step4_r: "modify"
      step4_r -> step5_r: "sync"
      step5_r -> step6_r: "commit"
    }
    rollback_problem: {
      style.fill: "${colors.danger}"
      style.stroke: "#B71C1C"
      style.border-radius: 8
      style.font-color: "white"
      label: "⚠️ READERS BLOCKED\nduring entire transaction"
    }
  }
  wal_container: Write-Ahead Log (REDO Log) {
    style.fill: "${colors.wal}"
    style.stroke: "${colors.wal_accent}"
    style.stroke-width: 3
    style.border-radius: 12
    wal_header: |md
      **Stores MODIFIED pages**
      *After modification*
    |
    direction: down
    wal_flow: {
      direction: down
      style.fill: "transparent"
      style.stroke: "transparent"
      step1_w: {
        style.fill: "white"
        style.stroke: "${colors.wal_accent}"
        style.border-radius: 8
        label: "1. Modify page in memory"
        style.font-size: 14
      }
      step2_w: {
        style.fill: "${colors.wal}"
        style.stroke: "${colors.wal_accent}"
        style.border-radius: 8
        label: "2. Append to WAL\n(MODIFIED data)"
        style.font-size: 14
        style.bold: true
      }
      step3_w: {
        style.fill: "${colors.warning}"
        style.stroke: "#F57C00"
        style.border-radius: 8
        label: "3. fsync(WAL)"
        style.font-size: 14
      }
      step4_w: {
        style.fill: "${colors.success}"
        style.stroke: "#2E7D32"
        style.border-radius: 8
        label: "4. ✓ COMMIT\n(readers can proceed)"
        style.font-size: 14
        style.font-color: "white"
      }
      step5_w: {
        style.fill: "${colors.database}"
        style.stroke: "${colors.database_accent}"
        style.border-radius: 8
        label: "5. Checkpoint\n(copy WAL to DB)"
        style.font-size: 14
      }
      step6_w: {
        style.fill: "white"
        style.stroke: "${colors.wal_accent}"
        style.border-radius: 8
        label: "6. Truncate WAL"
        style.font-size: 14
      }
      step1_w -> step2_w: "modify"
      step2_w -> step3_w: "append"
      step3_w -> step4_w: "sync"
      step4_w -> step5_w: "later"
      step5_w -> step6_w: "cleanup"
    }
    wal_benefit: {
      style.fill: "${colors.success}"
      style.stroke: "#2E7D32"
      style.border-radius: 8
      style.font-color: "white"
      label: "✓ READERS UNBLOCKED\ncheck WAL for newer pages"
    }
  }
}
recovery_section: {
  direction: right
  style.fill: "${colors.header_bg}"
  style.stroke: "#CCCCCC"
  style.border-radius: 12
  recovery_title: |md
    ### Crash Recovery Semantics
  |
  grid-columns: 2
  grid-gap: 30
  undo_recovery: {
    style.fill: "${colors.rollback}"
    style.stroke: "${colors.rollback_accent}"
    style.border-radius: 8
    style.stroke-width: 2
    label: "UNDO Recovery"
    direction: down
    undo_desc: |md
      If journal exists on startup:
      1. Restore original pages from journal
      2. Delete journal
      3. Database = pre-transaction state
    |
    undo_type: {
      label: "ROLLBACK"
      shape: rectangle
      style.fill: "${colors.rollback_accent}"
      style.font-color: "white"
      style.bold: true
    }
  }
  redo_recovery: {
    style.fill: "${colors.wal}"
    style.stroke: "${colors.wal_accent}"
    style.border-radius: 8
    style.stroke-width: 2
    label: "REDO Recovery"
    direction: down
    redo_desc: |md
      If WAL exists on startup:
      1. Replay committed frames to database
      2. Ignore uncommitted frames
      3. Database = all committed transactions
    |
    redo_type: {
      label: "ROLL FORWARD"
      shape: rectangle
      style.fill: "${colors.wal_accent}"
      style.font-color: "white"
      style.bold: true
    }
  }
}
concurrency_section: {
  direction: right
  grid-columns: 2
  grid-gap: 30
  rollback_concurrency: {
    label: "Rollback Journal\nConcurrency"
    direction: down
    style.fill: "${colors.danger}"
    style.stroke: "#B71C1C"
    style.border-radius: 8
    style.font-color: "white"
    r_explain: |md
      **Single Writer Lock**
      - Writers block ALL readers
      - Readers block writers
      - No concurrent access
    |
  }
  wal_concurrency: {
    label: "WAL Mode\nConcurrency"
    direction: down
    style.fill: "${colors.success}"
    style.stroke: "#2E7D32"
    style.border-radius: 8
    style.font-color: "white"
    w_explain: |md
      **Concurrent Readers**
      - Readers check WAL index
      - See snapshot at start time
      - Writer appends to WAL
      - No blocking!
    |
  }
}
key_insight: {
  near: bottom-center
  style.fill: "#FFF8E1"
  style.stroke: "${colors.warning}"
  style.border-radius: 8
  style.stroke-width: 2
  style.font-size: 14
  label: |md
    **Key Insight:** WAL enables snapshot isolation — each reader sees a consistent point-in-time view
    without blocking writers. The WAL acts as a version history for modified pages.
  |
}