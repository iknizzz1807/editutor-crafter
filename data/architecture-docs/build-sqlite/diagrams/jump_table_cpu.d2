direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Hardware Soul: The Jump Table Optimization" {
  shape: text
  style.font-size: 32
  near: top-center
}

# --------------------------------------------------------
# 1. Source Code
# --------------------------------------------------------
source: "Source Code (C)" {
  link: "#ms-lexer"
  shape: code
  label: |c
    char c = input[i]; // 'a'
    switch (c) {
      case '0': handle_digit();
      case 'a': handle_alpha();
      // ... 256 cases
    }
  |
  style: {
    fill: "#e3f2fd"
    stroke: "#1565c0"
    stroke-width: 2
  }
}

# --------------------------------------------------------
# 2. Naive Path (The Comparison Hell)
# --------------------------------------------------------
naive: "Naive Assembly (O(N))" {
  link: "#ms-lexer"
  shape: code
  label: |asm
    CMP AL, '0'
    JE 0x500100
    CMP AL, '1'
    JE 0x...
    ...
    CMP AL, 'a' ; 97th Check
    JE 0x500250
  |
  style: {
    opacity: 0.6
    stroke-dash: 5
    fill: "#ffebee"
    stroke: "#c62828"
  }
}

# --------------------------------------------------------
# 3. Optimized Path (The O(1) Jump)
# --------------------------------------------------------
optimized: "Optimized Assembly (O(1))" {
  link: "#ms-lexer"
  style: {
    fill: "#e8f5e9"
    stroke: "#2e7d32"
    stroke-width: 2
  }
  
  cpu: "CPU Registers" {
    shape: class
    RAX: "97 ('a')"
    RIP: "0x400500"
  }
  
  instr: "JMP [TABLE + RAX*8]" {
    shape: step
    style.fill: "#a5d6a7"
    style.stroke: "#2e7d32"
    tooltip: "Uses the character value as a direct memory offset"
  }
  
  cpu -> instr: "Execute"
}

# --------------------------------------------------------
# 4. Memory Layout (.rodata) - Simulating Array
# --------------------------------------------------------
memory: "Jump Table Array (.rodata)" {
  link: "#ms-lexer"
  style: {
    fill: "#f3e5f5"
    stroke: "#7b1fa2"
  }
  
  # Grid layout to look like a memory column
  grid-columns: 1
  grid-gap: 0
  
  slot_0: "Index 0 [NULL]\nTarget: 0x0000" {
    width: 200
    height: 50
    style.fill: "#e1bee7"
  }
  
  slot_dots1: "..." {
    shape: text
    height: 20
  }
  
  slot_48: "Index 48 ('0')\nTarget: 0x500100" {
    width: 200
    height: 50
    style.fill: "#e1bee7"
  }
  
  slot_dots2: "..." {
    shape: text
    height: 20
  }
  
  slot_97: "Index 97 ('a')\nTarget: 0x500250" {
    width: 200
    height: 50
    style: {
      fill: "#fff9c4" # Highlight
      stroke: "#fbc02d"
      stroke-width: 3
      bold: true
    }
  }
  
  slot_dots3: "..." {
    shape: text
    height: 20
  }
}

# --------------------------------------------------------
# 5. Code Segment (.text) - Destinations
# --------------------------------------------------------
text_segment: "Code Segment (.text)" {
  link: "#ms-lexer"
  style: {
    fill: "#fff3e0"
    stroke: "#ef6c00"
  }
  
  func_digit: "0x500100\nhandle_digit()" {
    shape: package
    style.fill: "#ffcc80"
  }
  
  func_alpha: "0x500250\nhandle_alpha()" {
    shape: package
    style: {
      fill: "#ffcc80"
      stroke: "#ef6c00"
      stroke-width: 3
    }
  }
}

# --------------------------------------------------------
# Connections
# --------------------------------------------------------

source -> naive: "Compiler (-O0)" {
  style: {
    stroke-dash: 3
    opacity: 0.5
  }
}

source -> optimized: "Compiler (-O2)" {
  style: {
    stroke-width: 3
  }
}

# The Jump Logic
optimized.instr -> memory.slot_97: "1. Index Lookup" {
  style: {
    stroke: "#7b1fa2"
    stroke-width: 3
    animated: true
  }
}

memory.slot_97 -> text_segment.func_alpha: "2. Jump to Function" {
  style: {
    stroke: "#ef6c00"
    stroke-width: 3
    animated: true
  }
}

# Ghost connection for context
memory.slot_48 -> text_segment.func_digit: {
  style: {
    opacity: 0.3
    stroke-dash: 3
  }
}