vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  header_style: {
    style: {
      fill: "#6e40aa"
      font-color: white
      bold: true
    }
  }
  data_style: {
    style: {
      fill: "#2eb5e5"
      font-color: white
    }
  }
  pointer_style: {
    style: {
      fill: "#ff9632"
      font-color: black
      stroke-dash: 2
    }
  }
  free_style: {
    style: {
      fill: "#ACE1AF"
      stroke-dash: 3
    }
  }
  padding_style: {
    style: {
      fill: "#d4d4d4"
    }
  }
}

# --- STATE 1: ROOT OVERFLOW ---
STATE_1: "STEP 1: ROOT OVERFLOW (Page ID: 1)" {
  ROOT_FULL: {
    shape: sql_table
    label: "Page 1: Root (Leaf Type 0x0D) [4096 bytes]"
    
    00_header: "Header (8B)" {class: header_style}
    08_pointers: "Cell Pointers [0..N]" {class: pointer_style}
    gap: "FREE SPACE (Insufficient for next cell)" {class: free_style}
    cells: "CELL CONTENT (Grows Upward)" {class: data_style}
  }
}

# --- STATE 2: THE SPLIT ACTION ---
STATE_2: "STEP 2: ALLOCATE & REDISTRIBUTE" {
  PAGE_1_REMAIN: {
    shape: sql_table
    label: "Page 1: Original (Lower 50% Keys)"
    
    header: "Header: cell_count=N/2" {class: header_style}
    ptr: "Pointers [0..N/2]" {class: pointer_style}
    gap: "FREE SPACE (Reclaimed)" {class: free_style}
    content: "Cells 0..N/2" {class: data_style}
  }

  PAGE_2_NEW: {
    shape: sql_table
    label: "Page 2: New Sibling (Upper 50% Keys)"
    
    header: "Header: type=0x0D" {class: header_style}
    ptr: "Pointers [0..N/2]" {class: pointer_style}
    gap: "FREE SPACE" {class: free_style}
    content: "Cells (N/2)+1..N" {class: data_style}
  }
}

# Cross-container Split Actions
STATE_1.ROOT_FULL -> STATE_2.PAGE_1_REMAIN: "1. Truncate" {style.stroke: red}
STATE_1.ROOT_FULL -> STATE_2.PAGE_2_NEW: "2. Move Cells" {style.stroke: blue; style.animated: true}

# --- STATE 3: FINAL HIERARCHY ---
STATE_3: "STEP 3: PARENT PROMOTION" {
  PAGE_3_ROOT: {
    shape: sql_table
    label: "Page 3: New Root (Internal Type 0x05) [4096 bytes]"
    
    header: "Header: cell_count=1" {class: header_style}
    ptr: "Pointers[0]" {class: pointer_style}
    gap: "FREE SPACE" {class: free_style}
    cell_0: "Separator: RowID=Median, Child=Page 1" {class: data_style}
    r_child: "Rightmost Child = Page 2" {style.fill: "#ff9632"}
  }

  PAGE_1_LEAF: {
    shape: sql_table
    label: "Page 1: Leaf Node"
    content: "Keys < Median" {class: data_style}
  }

  PAGE_2_LEAF: {
    shape: sql_table
    label: "Page 2: Leaf Node"
    content: "Keys >= Median" {class: data_style}
  }

  PAGE_3_ROOT.cell_0 -> PAGE_1_LEAF: "Left Child Pointer" {style.stroke: orange}
  PAGE_3_ROOT.r_child -> PAGE_2_LEAF: "Right Child Pointer" {style.stroke: orange}
}

# Structural Annotations
STATE_3.PAGE_3_ROOT.header -> STATE_3.PAGE_3_ROOT.cell_0: "owns"
STATE_3.PAGE_1_LEAF.content -- STATE_3.PAGE_2_LEAF.content: "references (Next Leaf Pointer)" {style.stroke-dash: 5}

# Manual Byte Layout Definitions
LAYOUT_SPECS: |md
### Slotted Page Structure (Milestone 5)
- **Header (8 bytes)**: 
  - `0x00`: Type (1B)
  - `0x01`: Freeblock (2B)
  - `0x03`: Cell Count (2B)
  - `0x05`: Content Start (2B)
  - `0x07`: Fragmented Free (1B)
- **Internal Cell (Varint RowID + 4B Child)**:
  - `left_child`: 4 bytes (Big-Endian)
  - `rowid`: 1-9 bytes (Varint)
| {
  near: bottom-center
}