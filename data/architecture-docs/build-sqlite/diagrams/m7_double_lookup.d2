vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    header: "#9b59b6"
    data: "#3498db"
    free: "#2ecc71"
    padding: "#95a5a6"
    pointer: "#e67e22"
  }
}

double_lookup_sequence: "Double Lookup Execution Architecture" {
  direction: right

  vdbe: "VDBE Execution Core" {
    style.stroke-width: 2
    
    registers: "Register File" {
      reg_0: "R[0]: Search Key" {style.fill: ${colors.data}}
      reg_1: "R[1]: Extracted RowID" {style.fill: ${colors.pointer}}
      reg_2: "R[2]: Final Column" {style.fill: ${colors.data}}
    }

    program: "Instruction Pipeline" {
      instr_1: "0: IdxGE(Csr0, L10, R0)"
      instr_2: "1: IdxRowid(Csr0, R1)"
      instr_3: "2: SeekRowid(Csr1, R1)"
      instr_4: "3: Column(Csr1, 0, R2)"
      instr_5: "4: ResultRow(R2)"
    }
  }

  cursors: "Cursor State" {
    idx_csr: "Index Cursor (Csr0)" {
      shape: sql_table
      root_page: "pgno" {constraint: "5"}
      curr_page: "pgno" {constraint: "12"}
      cell_idx: "int" {constraint: "4"}
      style.fill: "#f8f9f9"
    }

    tbl_csr: "Table Cursor (Csr1)" {
      shape: sql_table
      root_page: "pgno" {constraint: "2"}
      curr_page: "pgno" {constraint: "45"}
      cell_idx: "int" {constraint: "2"}
      style.fill: "#f8f9f9"
    }
  }

  storage: "B-tree Storage Layers" {
    
    index_leaf: "Index B+tree Leaf (Page 12)" {
      header: "Header (0x0A)" {style.fill: ${colors.header}}
      pointers: "Cell Pointers" {style.fill: ${colors.padding}}
      
      cell_4: "Cell[4]: ('Alice', RowID: 50)" {
        key: "'Alice'" {style.fill: ${colors.data}}
        rowid: "50" {style.fill: ${colors.pointer}}
      }
      
      free: "Unallocated" {style.fill: ${colors.free}}
    }

    table_leaf: "Table B-tree Leaf (Page 45)" {
      header: "Header (0x0D)" {style.fill: ${colors.header}}
      pointers: "Cell Pointers" {style.fill: ${colors.padding}}
      
      cell_2: "Cell[2]: (RowID: 50)" {
        rowid: "50" {style.fill: ${colors.pointer}}
        payload: "Payload: {Name: 'Alice', Age: 30}" {style.fill: ${colors.data}}
      }
      
      free: "Unallocated" {style.fill: ${colors.free}}
    }
  }

  # Orchestration Flow
  vdbe.program.instr_1 -> cursors.idx_csr: "Initialize Search"
  cursors.idx_csr -> storage.index_leaf: "SeekGE('Alice')"
  
  storage.index_leaf.cell_4.rowid -> vdbe.registers.reg_1: "1. Extract RowID" {
    style.stroke: ${colors.pointer}
    style.stroke-width: 3
  }

  vdbe.registers.reg_1 -> cursors.tbl_csr: "2. SeekRowid(50)" {
    style.stroke: ${colors.pointer}
    style.stroke-dash: 3
  }

  cursors.tbl_csr -> storage.table_leaf: "Navigate to ID 50"
  
  storage.table_leaf.cell_2.payload -> vdbe.registers.reg_2: "3. Project Column" {
    style.stroke: ${colors.data}
    style.stroke-width: 2
  }

  vdbe.registers.reg_2 -> output: "4. Emit Result" {
    style.animated: true
  }
  
  output: "Query Result Set" {
    shape: sql_table
    Name: "Alice"
  }
}

# Architectural Note moved to root level to satisfy D2 positioning constraints
double_lookup_note: |md
  ### Architectural Note
  The **Double Lookup** pattern incurs a $O(\log N_{idx} + \log N_{tbl})$ cost. 
  The Index B+tree provides the **RowID**, which acts as the physical address 
  for the clustered Table B-tree.
| {
  near: bottom-center
}