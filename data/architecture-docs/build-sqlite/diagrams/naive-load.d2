vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

# Title
Title: |md
  # The RAM Bottleneck
  Why `malloc(file_size)` is a fatal error.
| {
  near: top-center
  link: "#ms-pager"
}

# The Massive Disk
Persistent_Storage: Disk (HDD/SSD) {
  link: "#ms-pager"
  style: {
    fill: "#2d3436"
    stroke: "#b2bec3"
    stroke-width: 2
  }
  
  database_file: database.db {
    shape: cylinder
    style: {
      fill: "#636e72"
      stroke: "#dfe6e9"
      font-size: 20
    }
    
    # Visualizing the massive size
    capacity: |md
      **Capacity: 1 TB**
      (1,000,000,000,000 bytes)
      ~250,000,000 Pages
    |
    
    # Blocks to represent data chunks
    Block_0: Page 0 {shape: square; width: 20}
    Block_1: ... {shape: text}
    Block_N: Page N {shape: square; width: 20}
    
    Block_0 -> Block_1 -> Block_N: {style: {opacity: 0.3}}
  }
}

# The Tiny RAM
Volatile_Memory: System Memory (RAM) {
  link: "#ms-pager"
  style: {
    fill: "#2d3436"
    stroke: "#74b9ff"
    stroke-width: 2
  }

  ram_stick: Available Heap {
    shape: package
    style: {
      fill: "#0984e3"
      stroke: "#74b9ff"
      font-size: 20
    }
    
    capacity: |md
      **Capacity: 16 GB**
      (Physical Limit)
    |
    
    # Visualizing the stack/heap space
    stack: Stack {
      height: 40
      style: {fill: "#74b9ff"}
    }
    heap: Heap Space {
      height: 60
      style: {fill: "#a29bfe"}
    }
  }
}

# The Catastrophic Action
Persistent_Storage.database_file -> Volatile_Memory.ram_stick: "fread(all_data)" {
  link: "#ms-pager"
  style: {
    stroke: "#ff7675"
    stroke-width: 5
    animated: true
    font-size: 16
    bold: true
  }
  source-arrowhead: {
    shape: circle
    style.filled: true
  }
}

# The Consequence
Outcome: {
  link: "#ms-pager"
  near: bottom-right
  
  Process_State: {
    shape: cloud
    style: {
      fill: "#d63031"
      stroke: "#ff7675"
      font-color: white
      bold: true
    }
    
    label: |md
      # ☠️ SEGFAULT / OOM
      
      OS Kernel: "Kill process 1042"
      Reason: Out of Memory
    |
  }
}

Volatile_Memory.ram_stick -> Outcome.Process_State: Overflows {
  style: {
    stroke: "#d63031"
    stroke-dash: 3
    stroke-width: 3
  }
}