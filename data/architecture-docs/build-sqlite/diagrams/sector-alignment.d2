vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: down

title: "THE ALIGNMENT TAX" {
  shape: text
  style.font-size: 40
}

aligned_scenario: "SCENARIO A: ALIGNED WRITE (Efficiency Nirvana)" {
  link: "#ms-pager"
  direction: right
  style: {
    fill: "#f0fff4"
    stroke: "#2f855a"
    font-color: "#2f855a"
    stroke-width: 2
  }
  
  ram: "RAM (Buffer Pool)" {
    db_page: "DB Page #1\n(4096 bytes)" {
      shape: package
      style: {
        fill: "#48bb78"
        stroke: "#2f855a"
        font-color: white
      }
    }
  }

  hardware: "Disk Hardware" {
    sector: "Physical Sector #100\n(4096 bytes)" {
      shape: cylinder
      style: {
        fill: "#48bb78"
        stroke: "#2f855a"
        font-color: white
      }
    }
  }

  ram.db_page -> hardware.sector: "1. Direct Overwrite" {
    style: {
      stroke: "#48bb78"
      stroke-width: 4
      font-size: 14
    }
  }
}

misaligned_scenario: "SCENARIO B: MISALIGNED WRITE (The 3KB Tax)" {
  link: "#ms-pager"
  direction: right
  style: {
    fill: "#fff5f5"
    stroke: "#c53030"
    font-color: "#c53030"
    stroke-width: 2
  }

  ram: "RAM (Buffer Pool)" {
    db_page: "DB Page #2\n(3000 bytes)" {
      shape: package
      tooltip: "Starts at offset 3000, ends at 6000"
      style: {
        fill: "#f56565"
        stroke: "#c53030"
        font-color: white
      }
    }
  }

  controller: "Disk Controller\n(Read-Modify-Write)" {
    shape: diamond
    style: {
      fill: "#fc8181"
      font-color: white
    }
  }

  hardware: "Disk Hardware" {
    sector_a: "Sector N\n(Bytes 0-4096)" {
      shape: cylinder
      style: {
        fill: "#feb2b2"
        stroke: "#9b2c2c"
      }
    }
    sector_b: "Sector N+1\n(Bytes 4096-8192)" {
      shape: cylinder
      style: {
        fill: "#feb2b2"
        stroke: "#9b2c2c"
      }
    }
  }

  ram.db_page -> controller: "Write 3000 bytes"
  
  controller -> hardware.sector_a: "1. Read Sector N\n2. Modify Tail\n3. Write Sector N" {
    style: {
      stroke: "#c53030"
      stroke-dash: 3
    }
  }
  
  controller -> hardware.sector_b: "4. Read Sector N+1\n5. Modify Head\n6. Write Sector N+1" {
    style: {
      stroke: "#c53030"
      stroke-dash: 3
    }
  }
}

explanation: |md
  # The Hardware Penalty
  
  When a **Logical Page** crosses a **Physical Sector** boundary:
  1. **Latency Doubles**: The drive must perform two seek/write operations instead of one.
  2. **Atomicity Breaks**: If power fails after writing Sector N but before Sector N+1, the database page is corrupted (Torn Page).
  3. **Overhead**: The disk controller must read the old data to preserve the bytes surrounding our write.
| {
  link: "#ms-pager"
  shape: rectangle
  style: {
    fill: "#fffaf0"
    stroke: "#dd6b20"
    font-color: "#2d3748"
  }
}

# Invisible edge to force order: Title -> Aligned -> Misaligned -> Explanation
title -> aligned_scenario -> misaligned_scenario -> explanation: {
  style: {
    opacity: 0
  }
}