vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  c-safe: "#2ecc71"
  c-warn: "#f1c40f"
  c-danger: "#e74c3c"
  c-mem: "#2c3e50"
}

Title: |md
  # The Stack Peril
  Recursive Descent & Stack Overflow Protection
| {
  near: top-center
  shape: text
  link: "#ms-parser"
}

Parser_Logic: {
  shape: class
  link: "#ms-parser"
  style.stroke-width: 2
  
  Code: |c
    Expression* parse(depth) {
      // 1. GUARD RAIL CHECK
      if (depth > MAX_DEPTH) {
         return error("Stack Overflow");
      }
      // 2. RECURSE
      return parse(depth + 1);
    }
  |
}

RAM: System Memory Space {
  link: "#ms-parser"
  style: {
    fill: "${c-mem}"
    stroke: white
    stroke-width: 2
    border-radius: 5
  }
  direction: down

  High_Address: 0xFFFFFFFF (Top of Stack) {
    shape: text
    style.font-color: "#bdc3c7"
    link: "#ms-parser"
  }

  Stack_Frames: {
    link: "#ms-parser"
    style.fill: transparent
    style.stroke-width: 0
    
    Frame_0: "parse(depth=0)" {
      link: "#ms-parser"
      style.fill: "${c-safe}"
      style.font-color: black
      tooltip: "Root Call"
    }

    Frame_1: "parse(depth=1)" {
      link: "#ms-parser"
      style.fill: "${c-safe}"
      style.font-color: black
    }

    Frame_Gap: "..." {
      link: "#ms-parser"
      shape: text
      style.font-size: 20
      style.font-color: white
    }

    Frame_999: "parse(depth=999)" {
      link: "#ms-parser"
      style.fill: "${c-warn}"
      style.font-color: black
    }

    Frame_1000: "parse(depth=1000)" {
      link: "#ms-parser"
      style.fill: "${c-danger}"
      style.font-color: white
      
      Logic: "depth > MAX?" {
        link: "#ms-parser"
        shape: diamond
        style.fill: white
        style.font-color: black
        height: 40
      }
    }
    
    Frame_0 -> Frame_1 -> Frame_Gap -> Frame_999 -> Frame_1000
  }

  Guard_Rail: "SOFTWARE LIMIT (Guard Rail)" {
    link: "#ms-parser"
    shape: rectangle
    height: 15
    style: {
      fill: yellow
      stroke: transparent
      font-color: black
      bold: true
    }
  }

  Unmapped_Memory: "UNMAPPED MEMORY (SEGFAULT)" {
    link: "#ms-parser"
    height: 80
    style: {
      fill-pattern: lines
      fill: "#c0392b"
      stroke: red
      font-color: white
      bold: true
    }
  }

  Low_Address: 0x00000000 (Bottom) {
    shape: text
    style.font-color: "#bdc3c7"
    link: "#ms-parser"
  }

  # Layout ordering inside RAM
  High_Address -> Stack_Frames
  Stack_Frames -> Guard_Rail
  Guard_Rail -> Unmapped_Memory
  Unmapped_Memory -> Low_Address
}

# Flow Connections
Parser_Logic -> RAM.Stack_Frames.Frame_0: "Initial Call" {
  style.stroke: white
  style.stroke-dash: 3
}

# The Critical Check
RAM.Stack_Frames.Frame_1000.Logic -> Parser_Logic: "Return Error (Safe)" {
  style: {
    stroke: "${c-safe}"
    stroke-width: 3
  }
}

# The Prevention
RAM.Stack_Frames.Frame_1000 -> RAM.Guard_Rail: "Blocked" {
  style: {
    stroke: yellow
    stroke-width: 3
  }
  target-arrowhead: {
    shape: diamond
    style.filled: true
  }
}

RAM.Guard_Rail -> RAM.Unmapped_Memory: "Prevents Crash" {
  style: {
    stroke: red
    stroke-dash: 5
    opacity: 0.6
  }
  target-arrowhead: {
    shape: circle
    style.filled: true
  }
}