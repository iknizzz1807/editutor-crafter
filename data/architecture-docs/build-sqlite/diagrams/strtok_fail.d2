vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

link: "#ms-lexer"

title: "The Strtok Collapse"
title.shape: text
title.style.font-size: 32
title.near: top-center

# -----------------------------------------------------------------------
# Classes for styling
# -----------------------------------------------------------------------
classes: {
  code_block: {
    style: {
      font: mono
      border-radius: 5
      fill: "#2d3436"
      stroke: "#636e72"
      font-color: "#81ecec"
    }
  }
  token_ok: {
    style: {
      fill: "#55efc4"
      stroke: "#00b894"
      font-color: "#2d3436"
      border-radius: 4
    }
  }
  token_bad: {
    style: {
      fill: "#ff7675"
      stroke: "#d63031"
      font-color: "#2d3436"
      border-radius: 4
      stroke-dash: 3
    }
  }
  byte_char: {
    width: 30
    height: 30
    style: {
      fill: "#dfe6e9"
      stroke: "#b2bec3"
      font-color: "#2d3436"
    }
  }
  byte_null: {
    width: 30
    height: 30
    label: "\\0"
    style: {
      fill: "#d63031"
      stroke: "#ff7675"
      font-color: white
      bold: true
    }
  }
}

# -----------------------------------------------------------------------
# Top Layer: The Logic
# -----------------------------------------------------------------------
Logic: {
  style.fill: transparent
  style.stroke-width: 0

  Input: {
    label: User Input
    shape: package
    style.fill: "#0984e3"
    style.stroke: white
    style.font-color: white
    
    Query: 'SELECT * FROM "my table"' {
      shape: text
      style.font-size: 20
      style.font: mono
    }
  }

  Function: "strtok(input, \" \")" {
    class: code_block
    tooltip: "Splits string by replacing delimiter with NULL byte"
  }

  Input -> Function: "1. Pass String"

  Result: {
    label: "Token Stream"
    style.stroke-dash: 3
    
    t1: SELECT { class: token_ok }
    t2: * { class: token_ok }
    t3: FROM { class: token_ok }
    
    t4: "\"my" { 
      class: token_bad
      label: "\"my"
    }
    
    t5: "table\"" { 
      class: token_bad 
      label: "table\""
    }

    t1 -> t2 -> t3 -> t4 -> t5: "next()"
  }

  Function -> Result.t1: "2. Returns Tokens"
}

# -----------------------------------------------------------------------
# Bottom Layer: The Memory Layout (The Hardware Reality)
# -----------------------------------------------------------------------
Memory: {
  label: "RAM View (Destructive Modification)"
  style.fill: "#2d3436"
  style.stroke: "#dfe6e9"
  
  # Visualizing the Byte Array with the inserted NULLs
  Bytes: {
    grid-rows: 1
    grid-gap: 2
    
    c1: S { class: byte_char }
    c2: E { class: byte_char }
    c3: L { class: byte_char }
    c4: E { class: byte_char }
    c5: C { class: byte_char }
    c6: T { class: byte_char }
    
    n1: { class: byte_null }
    
    c7: * { class: byte_char }
    
    n2: { class: byte_null }
    
    c8: F { class: byte_char }
    c9: R { class: byte_char }
    c10: O { class: byte_char }
    c11: M { class: byte_char }
    
    n3: { class: byte_null }
    
    q1: "\"" { class: byte_char }
    m1: m { class: byte_char }
    y1: y { class: byte_char }
    
    # THE FATAL SPLIT
    n4: { 
      class: byte_null 
      label: "\\0"
      tooltip: "Space inside quotes replaced by NULL"
    }
    
    t0: t { class: byte_char }
    a0: a { class: byte_char }
    b0: b { class: byte_char }
    l0: l { class: byte_char }
    e0: e { class: byte_char }
    q2: "\"" { class: byte_char }
  }
}

# -----------------------------------------------------------------------
# Explanatory Text
# -----------------------------------------------------------------------
Explanation: |md
  # Why it fails
  `strtok` is context-blind. It sees a **Space** (0x20) and blindly replaces it with a **Null Terminator** (0x00).
  
  1. It correctly terminates `SELECT`, `*`, and `FROM`.
  2. It encounters the space inside `"my table"`.
  3. **CRASH**: It terminates the string there, splitting the quoted value into two garbage tokens:
     - ` "my ` (Unterminated quote)
     - ` table" ` (Garbage start)
| {
  shape: text
  style.font-size: 16
}

# -----------------------------------------------------------------------
# Connections between Logic and Memory
# -----------------------------------------------------------------------
Logic.Result.t4 -> Memory.Bytes.q1: "Reads until \\0" {
  style: {
    stroke: "#ff7675"
    stroke-dash: 3
    stroke-width: 2
  }
}

Logic.Result.t5 -> Memory.Bytes.t0: "Next token starts here" {
  style: {
    stroke: "#ff7675"
    stroke-dash: 3
    stroke-width: 2
  }
}

# Invisible edge to force layout of explanation below Result
Logic.Result -> Explanation: {style: {opacity: 0}}