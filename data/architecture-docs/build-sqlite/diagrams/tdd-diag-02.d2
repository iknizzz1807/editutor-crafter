direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  logic_component: {
    style: {
      fill: "#e7f3ff"
      stroke: "#007bff"
      stroke-width: 2
      border-radius: 8
    }
  }
  data_struct: {
    style: {
      fill: "#fff4e6"
      stroke: "#fd7e14"
      stroke-width: 2
    }
  }
}

SQL_Compiler: {
  label: "SQL Front-End & Compiler"
  
  Lexical_Analyzer: {
    class: logic_component
    Lexer: {
      shape: class
      -cursor: "const char*"
      -start: "const char*"
      +next_token(): Token
      -skip_whitespace(): void
      -scan_identifier(): TokenType
      -scan_literal(): TokenType
    }
  }

  Syntactic_Analyzer: {
    class: logic_component
    Parser: {
      shape: class
      -lexer: Lexer*
      -lookahead: Token
      +parse_statement(): ASTNode*
      -expect(type): void
      -parse_select(): ASTNode*
      -parse_where(): ASTNode*
      -parse_expression(): ASTNode*
    }
  }

  Semantic_Optimizer: {
    class: logic_component
    Analyzer: {
      shape: class
      +analyze(ASTNode*): void
      -resolve_identifiers(): void
      -type_check(): void
      -fold_constants(): void
    }
  }

  Bytecode_Generator: {
    class: logic_component
    Assembler: {
      shape: class
      -program: VDBE_Program*
      +generate(ASTNode*): VDBE_Program
      -emit_op(opcode, p1, p2, p3): uint32
      -allocate_register(): int
      -resolve_jumps(): void
    }
  }

  Intermediate_Representation: {
    label: "Data Structures (IR)"
    
    Token: {
      shape: sql_table
      class: data_struct
      type: TokenType {constraint: enum}
      start_ptr: "const char*"
      length: uint32
      line_meta: uint32
    }

    ASTNode: {
      shape: sql_table
      class: data_struct
      node_type: OpType
      pLeft: "ASTNode*"
      pRight: "ASTNode*"
      pList: "NodeList*"
      token_ref: Token
    }

    VDBE_Op: {
      shape: sql_table
      class: data_struct
      opcode: uint8 {constraint: PK}
      p1: int32
      p2: int32
      p3: int32
      p4: "void*"
    }
  }

  # Internal Relationships
  Syntactic_Analyzer.Parser -> Lexical_Analyzer.Lexer: "calls next_token()"
  Syntactic_Analyzer.Parser -> Intermediate_Representation.ASTNode: "builds tree"
  Semantic_Optimizer.Analyzer -> Intermediate_Representation.ASTNode: "validates/decorates"
  Bytecode_Generator.Assembler -> Intermediate_Representation.ASTNode: "walks tree"
  Bytecode_Generator.Assembler -> Intermediate_Representation.VDBE_Op: "emits opcodes"
  Lexical_Analyzer.Lexer -> Intermediate_Representation.Token: "instantiates"
}

# External Module Connections
Schema_Manager: {
  shape: cylinder
  style.fill: "#d4edda"
  label: "Schema Catalog"
}

VDBE_Engine: {
  shape: package
  style.fill: "#f8d7da"
  label: "VDBE Execution Engine"
}

SQL_Compiler.Semantic_Optimizer.Analyzer -> Schema_Manager: "lookup table/column defs"
SQL_Compiler.Bytecode_Generator.Assembler -> VDBE_Engine: "load VDBE_Program"

# Layout Hints
SQL_Compiler.Lexical_Analyzer -> SQL_Compiler.Syntactic_Analyzer -> SQL_Compiler.Semantic_Optimizer -> SQL_Compiler.Bytecode_Generator: "Pipeline Flow" {
  style: {
    stroke-width: 4
    animated: true
  }
}