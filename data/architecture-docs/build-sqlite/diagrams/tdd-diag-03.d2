direction: right
vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
  }
}

classes: {
  component: {
    style: {
      fill: "#f8f9fa"
      stroke: "#212529"
      stroke-width: 2
      border-radius: 8
    }
  }
  data_type: {
    shape: class
    style: {
      fill: "#e7f5ff"
      stroke: "#1971c2"
    }
  }
}

Compilation_Engine: {
  style.fill: "#f1f3f5"

  FrontEnd: {
    label: "SQL Front-End (The Architect)"
    
    Lexer: {
      shape: class
      class: component
      -source: "const char*"
      -cursor: "uint32_t"
      -line: "uint32_t"
      +next_token(): "Token"
      -skip_whitespace(): void
      -scan_identifier(): "Token"
    }

    Parser: {
      shape: class
      class: component
      -lexer: "Lexer*"
      -lookahead: "Token"
      +parse_statement(): "ASTNode*"
      -match(type: TokenType): bool
      -parse_expression(): "ExprNode*"
    }

    SemanticAnalyzer: {
      shape: class
      class: component
      +validate(ast: ASTNode*): bool
      -check_schema(table: string): void
      -resolve_types(node: ASTNode*): void
    }

    Lexer -> Parser: "Token Stream"
    Parser -> SemanticAnalyzer: "Abstract Syntax Tree (AST)"
  }

  BackEnd: {
    label: "Bytecode Generation (The Assembler)"

    Optimizer: {
      shape: class
      class: component
      +optimize(ast: ASTNode*): "OptimizedPlan*"
      -reorder_joins(): void
      -constant_folding(): void
    }

    CodeGenerator: {
      shape: class
      class: component
      -program: "VDBE_Program*"
      +emit(plan: OptimizedPlan*): void
      -allocate_register(): "uint32_t"
      -generate_bytecode(node: ASTNode*): void
    }

    Optimizer -> CodeGenerator: "Optimized Logic Plan"
  }

  SemanticAnalyzer -> BackEnd.Optimizer: "Validated AST"
}

Data_Structures: {
  Token: {
    class: data_type
    +type: "TokenType"
    +start: "char*"
    +length: "int"
  }

  VDBE_Op: {
    class: data_type
    +opcode: "uint8_t"
    +p1: "int32_t"
    +p2: "int32_t"
    +p3: "int32_t"
    +p4: "void*"
  }

  VDBE_Program: {
    class: data_type
    +instructions: "VDBE_Op[]"
    +reg_count: "int"
    +cursor_count: "int"
  }
}

Compilation_Sequence: {
  shape: sequence_diagram
  
  User: {shape: person}
  Compiler: SQLCompiler
  Frontend: {
    Lexer
    Parser
  }
  Backend: {
    Optimizer
    CodeGen
  }
  
  User -> Compiler: compile("SELECT * FROM users")
  Compiler -> Frontend.Lexer: tokenize()
  loop: Tokens
    Frontend.Lexer -> Frontend.Parser: emit(Token)
  end
  Frontend.Parser -> Backend.Optimizer: create_ast()
  Backend.Optimizer -> Backend.CodeGen: query_plan
  Backend.CodeGen -> Compiler: VDBE_Program (Bytecode)
  Compiler -> User: handle_to_statement
}

# Cross-module relationships
Compilation_Engine.FrontEnd.SemanticAnalyzer -> Schema_Manager: "Link: Validate Table/Column" {
  link: "layers.schema_manager"
  style.stroke-dash: 5
}

Compilation_Engine.BackEnd.CodeGenerator -> Data_Structures.VDBE_Program: "Populates"
Compilation_Engine.BackEnd.CodeGenerator -> VDBE_Module: "Link: Execute Bytecode" {
  link: "layers.vdbe_engine"
}

Compilation_Engine.FrontEnd.Lexer -> Data_Structures.Token: "Generates"