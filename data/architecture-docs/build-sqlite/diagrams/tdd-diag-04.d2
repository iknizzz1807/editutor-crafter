direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  struct: {
    shape: class
    style: {
      stroke-width: 2
      fill: "#f1f5f9"
    }
  }
  enumeration: {
    shape: class
    style: {
      fill: "#e2e8f0"
      stroke-dash: 3
    }
  }
  logic: {
    shape: rectangle
    style: {
      fill: "#dcfce7"
      border-radius: 8
    }
  }
}

VDBE_Module: {
  label: "Virtual Database Engine (VDBE) Register Architecture"
  
  MemType: {
    class: enumeration
    MEM_Null
    MEM_Int
    MEM_Real
    MEM_Str
    MEM_Blob
    MEM_Undefined
  }

  Mem: {
    class: struct
    tooltip: "24-byte Register Structure"
    link: "https://github.com/sqlite/sqlite/blob/master/src/vdbeInt.h"

    u: "union { i: int64; r: double; z: char* }"
    n: "uint32 (size of z)"
    flags: "uint16 (MemType bits)"
    _padding: "uint8[6]"

    +vdbe_get_int(): int64
    +vdbe_set_str(z: char*, n: int)
  }

  Vdbe: {
    class: struct
    pProg: "*VDBE_Program"
    aReg: "*Mem (Register File)"
    apCsr: "**VdbeCursor"
    pc: "int32 (Program Counter)"
    status: "uint8"

    +vdbe_step(): int
    -vdbe_exec(): int
  }

  Register_File: {
    grid-columns: 4
    style.fill: "#f8fafc"
    
    R0: { label: "Reg[0]"; class: struct }
    R1: { label: "Reg[1]"; class: struct }
    R2: { label: "Reg[2]"; class: struct }
    Rn: { label: "Reg[n]"; class: struct; style.multiple: true }
  }

  Opcode_Logic: {
    class: logic
    label: "Instruction Dispatcher"
    
    fetch: "Fetch Opcode(pc)"
    decode: "Identify Reg Indices (P1, P2, P3)"
    execute: "Apply Union Math/Logic"
  }
}

# Relationships
VDBE_Module.Vdbe.aReg -> VDBE_Module.Register_File: "allocates array"
VDBE_Module.Register_File.R0 -> VDBE_Module.Mem: "instance of"
VDBE_Module.Register_File.R1 -> VDBE_Module.Mem: "instance of"
VDBE_Module.Register_File.R2 -> VDBE_Module.Mem: "instance of"

VDBE_Module.Opcode_Logic -> VDBE_Module.Vdbe.pc: "updates"
VDBE_Module.Opcode_Logic -> VDBE_Module.Register_File: "reads/writes"

VDBE_Module.Mem.flags -> VDBE_Module.MemType: "typed by"

# Layout hints
VDBE_Module.Vdbe.pc -> VDBE_Module.Opcode_Logic: "input" {
  style.stroke-width: 2
  target-arrowhead: triangle
}

VDBE_Module.Register_File.style: {
  stroke: "#64748b"
  stroke-dash: 5
}