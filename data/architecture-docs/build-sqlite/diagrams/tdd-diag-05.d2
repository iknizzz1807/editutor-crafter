direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# Instruction Cycle Module: VDBE Core
VDBE_Instruction_Cycle: {
  label: "VDBE Execution Engine (mod-vdbe)"
  tooltip: "The register-based VM responsible for the Fetch-Decode-Execute cycle."
  link: "mod-vdbe"

  # VM State Container
  Control_Unit: {
    shape: class
    label: "Virtual Machine State"
    
    pc: "int32 (Program Counter)"
    status: "uint8 (HALT | RUNNING)"
    errorMask: "uint8"
    
    + vdbe_step(): int
    - fetch_op(): VDBE_Op
    - dispatch(op: VDBE_Op): void
  }

  # Instruction Set Definition
  Instruction_Storage: {
    VDBE_Op: {
      shape: sql_table
      opcode: uint8 {constraint: "OP_OpenRead | OP_Column | OP_Next"}
      p1: int32 {constraint: "Cursor/Reg Index"}
      p2: int32 {constraint: "Jump Target"}
      p3: int32 {constraint: "Dest Reg"}
      p4: "void*" {constraint: "String/Blob ptr"}
    }
  }

  # Execution Components
  Execution_Context: {
    Register_File: {
      shape: class
      label: "Register File (aReg)"
      
      registers: "Mem[]"
      
      + get_int(idx: uint32): int64
      + set_str(idx: uint32, val: char*): void
    }

    Cursor_Pool: {
      shape: class
      label: "Cursor Set (apCsr)"
      
      cursors: "VdbeCursor[]"
      
      + seek(csr_idx: int, key: int64): int
    }
  }

  # Cycle Logic Flow
  FSM: {
    shape: sequence_diagram
    Control_Unit -> Instruction_Storage: 1. FETCH (using PC)
    Instruction_Storage -> Control_Unit: Load VDBE_Op
    Control_Unit -> Control_Unit: 2. DECODE (Identify Handler)
    
    Control_Unit -> Execution_Context.Register_File: 3a. EXECUTE (Load/Store)
    Control_Unit -> Execution_Context.Cursor_Pool: 3b. EXECUTE (B-Tree Ops)
    
    Control_Unit -> Control_Unit: 4. ADVANCE (PC++ or Jump)
  }
}

# Data Structure Details
Data_Types: {
  near: bottom-right
  
  Mem: {
    shape: sql_table
    u_i: "int64"
    u_r: "double"
    u_z: "*char"
    n: "uint32 (size)"
    flags: "uint16 (type)"
  }

  VdbeCursor: {
    shape: sql_table
    pCursor: "*BtCursor"
    eState: "uint8"
    iPage: "int32"
    nFields: "uint32"
  }
}

# External Module Links
Storage_Layer: {
  label: "Pager & B-Tree (mod-storage)"
  link: "mod-storage"
  style: {
    stroke-dash: 5
    fill: transparent
  }
}

# High-level connections
VDBE_Instruction_Cycle.Execution_Context.Cursor_Pool -> Storage_Layer: "btree_cursor_next()"
VDBE_Instruction_Cycle.Control_Unit -> Data_Types.Mem: "Operates on"
VDBE_Instruction_Cycle.Execution_Context.Cursor_Pool -> Data_Types.VdbeCursor: "Manages instances"

# Global Styles
VDBE_Instruction_Cycle.style.fill: "#f8f9fa"
VDBE_Instruction_Cycle.Control_Unit.style.fill: "#e7f5ff"
VDBE_Instruction_Cycle.Instruction_Storage.style.fill: "#fff4e6"
VDBE_Instruction_Cycle.Execution_Context.style.fill: "#ebfbee"