direction: right
vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
    sketch: false
  }
}

classes: {
  structure: {
    style: {
      stroke-width: 2
      border-radius: 8
    }
  }
  logic: {
    style: {
      fill: "#e1f5fe"
      stroke: "#01579b"
    }
  }
}

VDBE_Internals: {
  Vdbe_Context: {
    shape: class
    class: structure
    pc: int32
    aOp: VdbeOp*
    aReg: Mem*
    apCsr: VdbeCursor**
    db: sqlite3*
    + vdbe_exec(): int
  }

  Vdbe_Op: {
    shape: class
    class: structure
    opcode: uint8
    p1: int32
    p2: int32
    p3: int32
    p4: void*
    zComment: char*
  }
}

Computed_Goto_Dispatch: {
  label: "Computed Goto Dispatch Sequence"
  shape: sequence_diagram

  VM_Core: VDBE Core Loop {
    shape: person
  }
  
  Dispatch_Table: Labels Array {
    shape: sql_table
    style.fill: "#fff9c4"
    0: "&&L_OP_Init"
    1: "&&L_OP_OpenRead"
    2: "&&L_OP_Column"
    3: "&&L_OP_ResultRow"
    4: "&&L_OP_Next"
    n: "..."
  }

  Op_Handler: Opcode Handlers {
    style.fill: "#c8e6c9"
  }

  VM_Core -> VM_Core: "Fetch: pOp = &p->aOp[p->pc]"
  
  VM_Core -> Dispatch_Table: "Lookup: addr = labels[pOp->opcode]"
  Dispatch_Table -> VM_Core: "Memory Address (void*)"
  
  VM_Core -> Op_Handler: "Indirect Jump: goto *addr"
  
  group Instruction Execution {
    Op_Handler -> Op_Handler: "Populate Registers (aReg)"
    Op_Handler -> Op_Handler: "Seek B-Tree Cursors (apCsr)"
  }

  Op_Handler -> VM_Core: "Update PC & Continue"
}

Memory_Map: {
  grid-columns: 1
  
  Dispatch_Logic: ||c
    /* The C implementation of Computed Gotos */
    static const void *labels[] = {
        &&L_OP_Init, &&L_OP_OpenRead, &&L_OP_Column, ...
    };

    /* Jump directly to handler */
    goto *labels[pOp->opcode];
  || {
    shape: code
  }
}

VDBE_Internals.Vdbe_Context.aOp -> VDBE_Internals.Vdbe_Op: "Array of Instructions"
Computed_Goto_Dispatch.VM_Core -> VDBE_Internals.Vdbe_Context: "Operates on state"
Memory_Map.Dispatch_Logic -> Computed_Goto_Dispatch: "Implementation link" {
  style.stroke-dash: 5
}