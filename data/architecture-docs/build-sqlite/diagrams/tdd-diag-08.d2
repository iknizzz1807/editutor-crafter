direction: right
vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
  }
}

classes: {
  module_box: {
    style: {
      stroke: "#2e3440"
      stroke-width: 2
      fill: "#eceff4"
      border-radius: 8
    }
  }
  struct_item: {
    shape: class
    style: {
      fill: "#ffffff"
      stroke: "#5e81ac"
    }
  }
  method_call: {
    style: {
      stroke: "#81a1c1"
      animated: true
      font-size: 12
    }
  }
}

storage_subsystem: Pager Engine {
  class: module_box
  
  Pager: {
    class: struct_item
    + nPages: uint32
    + pageSize: uint16
    + mxCache: uint32
    + nRef: uint32
    
    + pager_acquire(pgno): Page*
    + pager_release(page): void
    + pager_flush_dirty(): int
    + pager_write_page(page): int
  }

  Page: {
    class: struct_item
    + pgno: pgno_t
    + pData: void*
    + flags: uint16
    + nRef: uint16
    - pNext: Page*
    - pPrev: Page*
    
    + is_dirty(): bool
    + is_pinned(): bool
  }
}

cache_management: LRU Strategy {
  class: module_box
  
  LRU_Manager: {
    class: struct_item
    - pHead: Page*
    - pTail: Page*
    - nCurrent: uint32
    
    + touch(page): void
    + evict(): Page*
    + remove(page): void
  }

  HashIndex: {
    class: struct_item
    - apHash: Page**
    - nHash: uint32
    
    + find(pgno): Page*
    + insert(page): void
    + delete(pgno): void
  }
}

External_Modules: {
  VDBE: Virtual Machine {
    shape: rectangle
    style.fill: "#d8dee9"
  }

  VFS: OS Interface {
    shape: rectangle
    style.fill: "#d8dee9"
  }
}

# Relationships
External_Modules.VDBE -> storage_subsystem.Pager.pager_acquire: Request Data {class: method_call}
storage_subsystem.Pager -> cache_management.HashIndex.find: Cache Lookup {class: method_call}
storage_subsystem.Pager -> cache_management.LRU_Manager.touch: Update Recency {class: method_call}

cache_management.LRU_Manager -- storage_subsystem.Page: Manages Pointers
cache_management.HashIndex -- storage_subsystem.Page: Indexes

storage_subsystem.Pager -> External_Modules.VFS: pager_write_page (on evict/commit) {class: method_call}
External_Modules.VFS -> storage_subsystem.Pager: Page Data (on miss)

# Internal Structure Links
storage_subsystem.Pager -> storage_subsystem.Page: owns array of

# Visual Grouping
cache_management.LRU_Manager -> cache_management.LRU_Manager.evict: "if nCurrent > mxCache" {
  style.stroke-dash: 3
}

cache_management.LRU_Manager.evict -> storage_subsystem.Pager.pager_write_page: "if dirty" {
  class: method_call
}