direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  state_node: {
    shape: circle
    style: {
      stroke-width: 2
      fill: "#e7f3ff"
    }
  }
  logic_gate: {
    shape: diamond
    style: {
      fill: "#fff4e6"
    }
  }
  process_step: {
    shape: rectangle
    style: {
      border-radius: 4
      fill: "#f3f0ff"
    }
  }
}

B-Tree_Engine: {
  label: B-Tree Node Split Controller
  
  Steady_State: {
    class: state_node
    label: "IDLE / STEADY\nNode accepts inserts"
  }

  Capacity_Check: {
    class: logic_gate
    label: "Check Free Space"
    fields: {
      available: uint16
      required: uint16
    }
  }

  Allocation_Phase: {
    class: process_step
    label: "ALLOCATE SIBLING"
    methods: {
      pager_acquire(new_pgno): Page*
      bt_init_header(BtPageHeader): void
    }
  }

  Redistribution: {
    class: process_step
    label: "CELL REDISTRIBUTION"
    fields: {
      mid_point: uint16
      divider_key: uint64
    }
    methods: {
      move_cells(src, dst, range): void
      update_cell_pointers(): void
    }
  }

  Parent_Link: {
    class: process_step
    label: "UPDATE PARENT"
    methods: {
      btree_insert_internal(parent_pg, divider_key, child_pg): void
    }
  }

  Root_Promotion: {
    class: process_step
    label: "NEW ROOT CREATION"
    style.double-border: true
  }
}

Storage_Pager: {
  label: Pager Module
  Free_List: {
    shape: cylinder
    label: "SQLite Free List / Trunk"
  }
  WAL_Journal: {
    shape: queue
    label: "Write-Ahead Log"
  }
}

# State Transitions
B-Tree_Engine.Steady_State -> B-Tree_Engine.Capacity_Check: vdbe_insert()
B-Tree_Engine.Capacity_Check -> B-Tree_Engine.Steady_State: space >= required
B-Tree_Engine.Capacity_Check -> B-Tree_Engine.Allocation_Phase: space < required (Overflow)

B-Tree_Engine.Allocation_Phase <-> Storage_Pager.Free_List: pager_acquire()
B-Tree_Engine.Allocation_Phase -> B-Tree_Engine.Redistribution: new_pgno allocated

B-Tree_Engine.Redistribution -> B-Tree_Engine.Parent_Link: split point found
B-Tree_Engine.Parent_Link -> B-Tree_Engine.Root_Promotion: if target was root
B-Tree_Engine.Parent_Link -> Storage_Pager.WAL_Journal: tx_commit_structure()
B-Tree_Engine.Root_Promotion -> Storage_Pager.WAL_Journal: tx_commit_structure()

Storage_Pager.WAL_Journal -> B-Tree_Engine.Steady_State: fsync() success

# Styling
(B-Tree_Engine.Capacity_Check -> B-Tree_Engine.Allocation_Phase)[0].style.stroke: red
(B-Tree_Engine.Parent_Link -> Storage_Pager.WAL_Journal)[0].style.animated: true