vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right
title: Tokenizer State Machine\nLexical Analysis FSM

# State definitions
states: {
  default: {
    shape: circle
    label: "DEFAULT\n(Start)"
    style.fill: "#E3F2FD"
  }
  
  in_string: {
    shape: circle
    label: "IN_STRING"
    style.fill: "#FFF3E0"
  }
  
  in_quoted_id: {
    shape: circle
    label: "IN_QUOTED_ID"
    style.fill: "#F3E5F5"
  }
  
  in_number: {
    shape: circle
    label: "IN_NUMBER"
    style.fill: "#E8F5E9"
  }
  
  in_identifier: {
    shape: circle
    label: "IN_IDENTIFIER"
    style.fill: "#FCE4EC"
  }
  
  in_line_comment: {
    shape: circle
    label: "IN_LINE_COMMENT"
    style.fill: "#ECEFF1"
  }
  
  in_block_comment: {
    shape: circle
    label: "IN_BLOCK_COMMENT"
    style.fill: "#E0E0E0"
  }
  
  escape_check: {
    shape: diamond
    label: "Escape?\nLookahead"
    style.fill: "#FFEB3B"
  }
  
  emit_token: {
    shape: rectangle
    label: "EMIT_TOKEN\n(Output)"
    style.fill: "#4CAF50"
    style.font-color: white
  }
}

# Transitions from DEFAULT
states.default -> states.in_string: "single quote\nBegin string literal"
states.default -> states.in_quoted_id: "double quote\nOr backtick"
states.default -> states.in_number: "0-9, dot\nBegin numeric"
states.default -> states.in_identifier: "A-Z, a-z, underscore\nBegin identifier"
states.default -> states.in_line_comment: "--\nLine comment start"
states.default -> states.in_block_comment: "/*\nBlock comment start"
states.default -> states.emit_token: "Operators, punct\n; ( ) , = less greater + - * / %"

# IN_STRING transitions with escape handling
states.in_string -> states.escape_check: "quote"
states.escape_check -> states.in_string: "Yes:\nEscaped quote\n(lookahead)"
states.escape_check -> states.emit_token: "No:\nEnd string ->\nTK_STRING"
states.in_string -> states.in_string: "Any char\nAppend to buffer"

# IN_QUOTED_ID transitions
states.in_quoted_id -> states.in_quoted_id: "Any char\nAppend to buffer"
states.in_quoted_id -> states.emit_token: "double quote or backtick\nEnd -> TK_ID"

# IN_NUMBER transitions
states.in_number -> states.in_number: "0-9, dot, e, E, +, -"
states.in_number -> states.emit_token: "Non-numeric\nUnget char ->\nTK_NUMERIC"

# IN_IDENTIFIER transitions
states.in_identifier -> states.in_identifier: "A-Z, a-z, 0-9, underscore"
states.in_identifier -> states.emit_token: "Non-identifier\nUnget char ->\nCheck keyword\nor TK_ID"

# IN_LINE_COMMENT transitions
states.in_line_comment -> states.in_line_comment: "Any char"
states.in_line_comment -> states.default: "newline or EOF\nEnd comment"

# IN_BLOCK_COMMENT transitions
states.in_block_comment -> states.in_block_comment: "Any char"
states.in_block_comment -> states.default: "*/\nEnd block comment"

# Return to DEFAULT after emit
states.emit_token -> states.default: "Continue\nscanning"

# Legend
legend: |md
  **Legend**
  
  - TK_STRING: String literal token
  - TK_ID: Identifier token  
  - TK_NUMERIC: Numeric literal token
  - Keywords auto-detected from TK_ID
  - Lookahead used for escape sequences
  - Unget char returns char to input stream
|
legend.near: bottom-left

# Token type reference
token_types: |md
  **Token Categories**
  
  **Keywords:** SELECT, FROM, WHERE, INSERT,
  UPDATE, DELETE, CREATE, DROP, etc.
  
  **Literals:** TK_STRING, TK_NUMERIC
  
  **Identifiers:** TK_ID (tables, columns)
  
  **Operators:** +, -, *, /, =, less, greater, less-eq, greater-eq, not-eq, concat
  
  **Punctuation:** (, ), comma, semicolon, dot
|
token_types.style.fill: "#E8EAF6"
token_types.near: bottom-center

# Notes
notes: |md
  **Implementation Notes**
  
  1. Single quote for strings: apostrophe text apostrophe
  2. Double quote/backtick for IDs: quote table quote or backtick column backtick
  3. Escape quote by doubling: apostrophe it apostrophe apostrophe s apostrophe becomes it-apostrophe-s
  4. Numbers: integer, float, scientific notation
  5. Comments stripped (not tokenized)
  6. Keywords recognized via lookup table
|
notes.style.fill: "#FFFDE7"
notes.style.stroke: "#FBC02D"
notes.near: bottom-right