direction: right
vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
  }
}

classes: {
  state_node: {
    shape: circle
    style: {
      stroke-width: 2
      font-size: 14
      bold: true
      shadow: true
    }
  }
  logic_component: {
    style: {
      fill: "#f4f4f9"
      stroke: "#2c3e50"
      border-radius: 8
    }
  }
}

TransactionController: {
  class: logic_component
  
  TxContext: {
    shape: sql_table
    tx_id: uint64_t {constraint: PK}
    lock_level: LockLevel
    wal_index_pos: uint32_t
    dirty_flag: uint8_t
    _padding: "uint8_t[46]"
  }

  LockManager: {
    shape: class
    +tcc_acquire_lock(ctx: TxContext*, req: LockLevel): int
    +tcc_commit(ctx: TxContext*): int
    -atomic_inc_if_not_exclusive(ptr: uint32_t*): bool
    -shm_sync(): void
  }
}

LifecycleStates: Transaction Lifecycle State Machine {
  UNLOCKED: {
    class: state_node
    style.fill: "#e8f5e9"
  }
  SHARED: {
    class: state_node
    style.fill: "#e3f2fd"
    tooltip: "Multiple Concurrent Readers"
  }
  RESERVED: {
    class: state_node
    style.fill: "#fff3e0"
    tooltip: "Single Write Intent; Readers Persist"
  }
  PENDING: {
    class: state_node
    style.fill: "#fce4ec"
    tooltip: "Blocking New Readers"
  }
  EXCLUSIVE: {
    class: state_node
    style.fill: "#ffebee"
    style.stroke: "#c62828"
    tooltip: "Sole Owner of DB"
  }

  UNLOCKED -> SHARED: "Read Request" {
    style: {
      stroke-width: 2
      animated: true
    }
  }
  
  SHARED -> RESERVED: "Write Intent" {
    style.stroke: "#fb8c00"
  }
  
  RESERVED -> PENDING: "Commit Initiated" {
    style.stroke: "#e91e63"
  }
  
  PENDING -> EXCLUSIVE: "Readers Exit\n(read_count == 0)" {
    style: {
      stroke: "#c62828"
      bold: true
    }
  }
  
  EXCLUSIVE -> UNLOCKED: "fsync() & Finalize" {
    style.stroke-dash: 5
  }
  
  RESERVED -> UNLOCKED: "Rollback" {
    style.stroke-dash: 3
  }
}

WAL_Subsystem: {
  class: logic_component
  
  WalDirector: {
    shape: class
    +wal_append(pg: pgno_t, data: void*): int
    +wal_checkpoint(): int
    -write_frame_header(h: WalFrameHeader*): void
  }
  
  WalFrame: {
    shape: sql_table
    pgno: uint32_t
    commit_flag: uint32_t
    sequence: uint64_t
    checksum: uint64_t
  }
}

TransactionController.LockManager -> LifecycleStates: "Mutates LockLevel"
LifecycleStates.EXCLUSIVE -> WAL_Subsystem.WalDirector: "Triggers Frame Write"
WAL_Subsystem.WalDirector -> WAL_Subsystem.WalFrame: "Serializes"

legend: {
  near: bottom-right
  note: "ACID Enforcement Layer\n(SQLite-style 5-State Locking)"
}