direction: right

title: VM Fetch-Decode-Execute Cycle

# States
fetch: Fetch Instruction {
  description: Load instruction at Program Counter (PC)
  style.fill: "#E3F2FD"
}

decode: Decode Opcode {
  description: Parse opcode and parameters P1-P4
  style.fill: "#FFF3E0"
}

execute: Execute Handler {
  description: Dispatch to opcode-specific handler
  style.fill: "#E8F5E9"
}

update_pc: Update PC {
  description: Increment PC or set to jump target
  style.fill: "#FCE4EC"
}

check_halt: Check Halt {
  description: Test Halted flag or halt instruction
  style.fill: "#F3E5F5"
}

halt: Halted {
  style.fill: "#FFEBEE"
  shape: circle
}

# Transitions
fetch -> decode: Instruction loaded {
  label: "instr = Program[PC]"
}

decode -> execute: Opcode decoded {
  label: "switch(instr.Opcode)"
}

execute -> update_pc: Handler complete {
  label: result received
}

update_pc -> check_halt: PC updated {
  label: "PC = PC + 1 OR PC = jump_target"
}

check_halt -> fetch: Continue {
  label: "!Halted && PC < len(Program)"
  style.stroke: "#4CAF50"
}

check_halt -> halt: Terminate {
  label: "Halted || Halt instruction"
  style.stroke: "#F44336"
}

# Initial state indicator
start: {
  shape: circle
  style.fill: "#000"
}
start -> fetch

# Jump path annotation
execute_jump: {
  shape: text
  label: "*** Jump Instructions ***\nGoto, If, IfNot\nSet PC to P2 directly"
}
execute_jump -> execute: {
  style.stroke-dash: 3
  style.opacity: 0.5
}

# Error handling path
error: Error {
  style.fill: "#FFCDD2"
  shape: diamond
}

execute -> error: Handler error {
  style.stroke: "#F44336"
  style.stroke-dash: 3
}

error -> halt: Fatal error {
  label: return err
  style.stroke: "#F44336"
}