direction: right

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  module: {
    style: {
      fill: "#f8f9fa"
      stroke: "#212529"
      stroke-width: 2
      border-radius: 8
    }
  }
  storage: {
    shape: cylinder
    style: {
      fill: "#e9ecef"
      stroke: "#495057"
    }
  }
  logic_step: {
    shape: rectangle
    style: {
      fill: "#ffffff"
      stroke: "#adb5bd"
      border-radius: 4
    }
  }
  critical: {
    style: {
      stroke: "#dc3545"
      fill: "#fff5f5"
      bold: true
    }
  }
}

Checkpointing_System: {
  label: "Checkpointing & Recovery Subsystem"
  
  Control_Plane: {
    class: module
    
    Checkpointer: {
      class: logic_step
      1: "Scan WAL Index"
      2: "Acquire EXCLUSIVE Lock"
      3: "Read WAL Frames"
      4: "Transfer to Main DB"
      5: "Fsync & Reset"
      
      1 -> 2 -> 3 -> 4 -> 5
    }

    Recovery_Engine: {
      class: module
      style.fill: "#fff3cd"
      label: "Crash Recovery Engine"
      
      Analysis: "Scan WAL for Valid Headers"
      Redo: "Apply Committed Frames to DB"
      Verification: "Checksum Validation" {class: critical}
      
      Analysis -> Verification -> Redo
    }
  }

  Storage_Layer: {
    label: "Physical Persistence"
    
    Main_DB: "Main Database File (.db)" {
      class: storage
    }
    
    WAL_File: "Write-Ahead Log (.wal)" {
      class: storage
      style.fill: "#d1ecf1"
    }
    
    SHM_Index: "Shared Memory Index (.wal-index)" {
      shape: parallelogram
      style.fill: "#d4edda"
    }
  }

  # Checkpointing Interactions
  Control_Plane.Checkpointer.1 -> Storage_Layer.SHM_Index: "Query frame offsets"
  Control_Plane.Checkpointer.3 -> Storage_Layer.WAL_File: "Read page blobs"
  Control_Plane.Checkpointer.4 -> Storage_Layer.Main_DB: "Write-through VFS"
  
  # Recovery Interactions
  Control_Plane.Recovery_Engine.Analysis -> Storage_Layer.WAL_File: "Locate last commit"
  Control_Plane.Recovery_Engine.Redo -> Storage_Layer.Main_DB: "Restore consistency"

  # External Link
  VFS_Layer: "Virtual File System" {
    link: "https://sqlite.org/vfs.html"
  }
  
  Storage_Layer -> VFS_Layer: "O_DIRECT / Fsync"
}

# Documentation / Legend near the diagram
Legend: {
  near: bottom-right
  WAL_Definition: "WAL: Write-Ahead Log. Changes are appended here first." {shape: text}
  Checkpoint_Def: "Checkpoint: Periodic migration from WAL to Main DB." {shape: text}
  Recovery_Def: "Recovery: Replaying WAL after power loss to ensure ACID." {shape: text}
}

# Style for connections
(Control_Plane.Checkpointer -> Storage_Layer.Main_DB): {
  style: {
    stroke: "#007bff"
    animated: true
  }
}

(Control_Plane.Recovery_Engine -> Storage_Layer.Main_DB): {
  style: {
    stroke: "#dc3545"
    stroke-dash: 5
  }
}