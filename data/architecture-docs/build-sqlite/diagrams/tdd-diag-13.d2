direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# ----------------------------------------------------------------------------------
# CLASSES & STYLES
# ----------------------------------------------------------------------------------
classes: {
  struct: {
    shape: sql_table
    style: {
      stroke: "#334155"
      stroke-width: 2
      fill: "#f8f9fa"
    }
  }
  header_cell: {
    style: {
      fill: "#dcfce7"
      stroke: "#166534"
    }
  }
  payload_cell: {
    style: {
      fill: "#dbeafe"
      stroke: "#1e40af"
    }
  }
  logic_block: {
    style: {
      fill: "#f1f5f9"
      stroke: "#475569"
      stroke-dash: 3
    }
  }
}

# ----------------------------------------------------------------------------------
# COMPONENT: VDBE REGISTERS (INPUT)
# ----------------------------------------------------------------------------------
vdbe_registers: VDBE Virtual Registers {
  shape: sql_table
  class: struct
  reg_0: "Mem { type: INT, val: 500 }"
  reg_1: "Mem { type: STRING, val: 'Atlas' }"
  reg_2: "Mem { type: NULL }"
}

# ----------------------------------------------------------------------------------
# COMPONENT: RECORD ANATOMY (PHYSICAL LAYOUT)
# ----------------------------------------------------------------------------------
record_anatomy: Record Binary Format {
  style.fill: transparent

  header: Header Array {
    grid-columns: 4
    header_len: "Header Size" {
      class: header_cell
      tooltip: "Varint: Total size of header including this field"
    }
    st_0: "Serial Type 0" {
      class: header_cell
      tooltip: "Varint: ID 2 (Int16)"
    }
    st_1: "Serial Type 1" {
      class: header_cell
      tooltip: "Varint: ID 23 (String len 5)"
    }
    st_2: "Serial Type 2" {
      class: header_cell
      tooltip: "Varint: ID 0 (NULL)"
    }
  }

  payload: Payload Data {
    grid-columns: 2
    data_0: "0x01F4" {
      class: payload_cell
      tooltip: "2 bytes for Integer 500"
    }
    data_1: "'Atlas'" {
      class: payload_cell
      tooltip: "5 bytes for UTF-8 String"
    }
    # NULL consumes no bytes in payload
  }
}

# ----------------------------------------------------------------------------------
# COMPONENT: SERIAL TYPE DEFINITIONS
# ----------------------------------------------------------------------------------
type_manifest: Serial Type IDs {
  shape: sql_table
  "0": "NULL (0 bytes)"
  "1": "Int8 (1 byte)"
  "2": "Int16 (2 bytes)"
  "3": "Int24 (3 bytes)"
  "4": "Int32 (4 bytes)"
  "12+": "String/Blob (Var length)"
}

# ----------------------------------------------------------------------------------
# RELATIONSHIPS & LOGIC FLOW
# ----------------------------------------------------------------------------------
serialization_engine: record_pack() {
  class: logic_block
}

vdbe_registers -> serialization_engine
serialization_engine -> record_anatomy.header: "Calculates offsets"
serialization_engine -> record_anatomy.payload: "Packs bytes"

# Mapping indicators
record_anatomy.header.st_0 -> record_anatomy.payload.data_0: "Type 2 defines length" {
  style.stroke: "#64748b"
  style.stroke-dash: 5
}
record_anatomy.header.st_1 -> record_anatomy.payload.data_1: "Type 23 defines length" {
  style.stroke: "#64748b"
  style.stroke-dash: 5
}
record_anatomy.header.st_2 -> type_manifest."0": "Null reference"

# Links to other modules
record_anatomy.link: "layers.storage"
vdbe_registers.link: "layers.vdbe"

# Labels/Annotations
explanation: |md
  ### Record Format Constraints
  - **Zero-copy**: Unpacking only requires header parsing.
  - **Varint**: All metadata uses variable-length encoding.
  - **Alignment**: No padding between fields; optimized for disk space.
| {
  near: record_anatomy
}