direction: right

title: Buffer Pool Architecture {
  shape: text
  style: {
    font-size: 24
    bold: true
    underline: true
  }
}

# Main BufferPool container
BufferPool: {
  style.fill: "#E3F2FD"
  style.stroke: "#1976D2"
  label: "BufferPool Manager"
  
  # Frames Array
  frames_array: {
    label: "Frames Array\n(1000 × 4KB)"
    style.fill: "#FFF3E0"
    style.stroke: "#F57C00"
    
    frame_0: {
      label: "Frame 0\n4096 bytes"
      style.fill: "#FFE0B2"
    }
    frame_1: {
      label: "Frame 1\n4096 bytes"
      style.fill: "#FFE0B2"
    }
    frame_dots: {
      label: "..."
      shape: text
    }
    frame_999: {
      label: "Frame 999\n4096 bytes"
      style.fill: "#FFE0B2"
    }
    
    frame_0 -> frame_1 -> frame_dots -> frame_999: {style.stroke-dash: 3}
  }
  
  # Metadata Array
  metadata_array: {
    label: "Metadata Array"
    style.fill: "#E8F5E9"
    style.stroke: "#388E3C"
    
    meta_header: {
      label: "FrameMetadata"
      style.fill: "#C8E6C9"
      
      fields: {
        shape: class
        PageID: "PageID (int64)"
        PinCount: "PinCount (int)"
        Dirty: "Dirty (bool)"
        LastAccess: "LastAccess (time)"
      }
    }
    
    meta_0: {label: "Meta[0]"; style.fill: "#A5D6A7"}
    meta_1: {label: "Meta[1]"; style.fill: "#A5D6A7"}
    meta_dots: {label: "..."; shape: text}
    meta_999: {label: "Meta[999]"; style.fill: "#A5D6A7"}
    
    meta_0 -> meta_1 -> meta_dots -> meta_999: {style.stroke-dash: 3}
  }
  
  # Page Table (Hash Map)
  pageTable: {
    label: "PageTable\nmap[PageID]FrameIndex"
    style.fill: "#F3E5F5"
    style.stroke: "#7B1FA2"
    
    kv_pairs: {
      shape: sql_table
      PageID: int64
      FrameIndex: int
    }
    
    kv_row1: {
      label: "101 → 0"
      style.fill: "#E1BEE7"
    }
    kv_row2: {
      label: "205 → 3"
      style.fill: "#E1BEE7"
    }
    kv_row3: {
      label: "... → ..."
      style.fill: "#E1BEE7"
    }
    
    kv_row1 -> kv_row2 -> kv_row3: {style.stroke-dash: 3}
  }
  
  # Internal connections
  frames_array.frame_0 -- metadata_array.meta_0: {
    label: "corresponds"
    style.stroke: "#666"
    style.stroke-dash: 4
  }
  
  pageTable.kv_pairs -- metadata_array: {
    label: "O(1) lookup"
    style.stroke: "#7B1FA2"
  }
}

# Disk Manager (external)
DiskManager: {
  style.fill: "#FFEBEE"
  style.stroke: "#D32F2F"
  
  interface: {
    shape: class
    style.fill: "#FFCDD2"
    ReadPage: "ReadPage(pageID PageID) ([]byte, error)"
    WritePage: "WritePage(pageID PageID, data []byte) error"
    AllocatePage: "AllocatePage() PageID"
  }
  
  disk: {
    label: "Disk Storage\n(.db files)"
    shape: cylinder
    style.fill: "#EF9A9A"
  }
  
  interface -> disk: {
    label: "I/O"
    style.stroke: "#D32F2F"
  }
}

# Connections between BufferPool and DiskManager
BufferPool.frames_array <-> DiskManager.interface: {
  label: "Page I/O\n(Evict/Load)"
  style.stroke: "#1565C0"
  style.stroke-width: 3
}

# LRU Eviction Policy
LRU_Eviction: {
  label: "LRU Eviction Policy\n(Based on LastAccess)"
  style.fill: "#FFFDE7"
  style.stroke: "#FBC02D"
  shape: diamond
}

BufferPool.metadata_array -> LRU_Eviction: {
  label: "find victim"
  style.stroke: "#F9A825"
  style.stroke-dash: 4
}

LRU_Eviction -> BufferPool.frames_array: {
  label: "evict frame"
  style.stroke: "#F9A825"
  style.stroke-dash: 4
}

# Legend
legend: {
  label: "Legend"
  style.fill: "#FAFAFA"
  style.stroke: "#9E9E9E"
  
  item1: "PinCount > 0: Page is protected from eviction"
  item2: "Dirty = true: Page must be written to disk before eviction"
  item3: "LastAccess: Used for LRU eviction policy"
}

BufferPool -- legend