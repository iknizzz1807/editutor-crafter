direction: right
title: Varint Encoding Algorithm\nModule 5: B-tree Page Format & Table Storage

vars: {
  box_fill: "#E3F2FD"
  decision_fill: "#FFF3E0"
  encode_fill: "#E8F5E9"
  decode_fill: "#FCE4EC"
  terminal_fill: "#F3E5F5"
}

ENCODE_START: {
  shape: oval
  style.fill: ${terminal_fill}
  label: "Input Value\n(v int64)"
}

RANGE_CHECK: {
  shape: diamond
  style.fill: ${decision_fill}
  label: "Value Range\nCheck"
}

ENCODE_1: {
  shape: rectangle
  style.fill: ${encode_fill}
  label: "1 Byte\n0xxxxxxx\n(0-127)"
}

ENCODE_2: {
  shape: rectangle
  style.fill: ${encode_fill}
  label: "2 Bytes\n10xxxxxx xxxxxxxx\n(128-16383)"
}

ENCODE_3: {
  shape: rectangle
  style.fill: ${encode_fill}
  label: "3 Bytes\n110xxxxx ...\n(16384-2097151)"
}

ENCODE_4: {
  shape: rectangle
  style.fill: ${encode_fill}
  label: "4 Bytes\n1110xxxx ...\n(2^21 - 2^28)"
}

ENCODE_5_8: {
  shape: rectangle
  style.fill: ${encode_fill}
  label: "5-8 Bytes\n1111xxxx ...\n(larger values)"
}

ENCODE_9: {
  shape: rectangle
  style.fill: ${encode_fill}
  label: "9 Bytes\n0xFF + 8 bytes\n(max int64)"
}

ENCODE_END: {
  shape: oval
  style.fill: ${terminal_fill}
  label: "Encoded\nBytes []"
}

DECODE_START: {
  shape: oval
  style.fill: ${terminal_fill}
  label: "Input Bytes\n([]byte)"
}

LEADING_BITS: {
  shape: diamond
  style.fill: ${decision_fill}
  label: "Count Leading\n1 Bits"
}

DECODE_1: {
  shape: rectangle
  style.fill: ${decode_fill}
  label: "0 leading 1s\n→ 1 byte total\nMask: 0x7F"
}

DECODE_2: {
  shape: rectangle
  style.fill: ${decode_fill}
  label: "1 leading 1\n→ 2 bytes total\nMask: 0x3F, 0xFF"
}

DECODE_3: {
  shape: rectangle
  style.fill: ${decode_fill}
  label: "2 leading 1s\n→ 3 bytes total\nMask: 0x1F, 0xFF, 0xFF"
}

DECODE_4: {
  shape: rectangle
  style.fill: ${decode_fill}
  label: "3 leading 1s\n→ 4 bytes total"
}

DECODE_N: {
  shape: rectangle
  style.fill: ${decode_fill}
  label: "4-8 leading 1s\n→ N bytes total"
}

DECODE_RAW: {
  shape: rectangle
  style.fill: ${decode_fill}
  label: "0xFF prefix\n→ 9 bytes total\nRead 8-byte int"
}

DECODE_END: {
  shape: oval
  style.fill: ${terminal_fill}
  label: "Decoded\nValue (int64)"
}

ENCODE_START -> RANGE_CHECK

RANGE_CHECK -> ENCODE_1: "v ≤ 127"
RANGE_CHECK -> ENCODE_2: "v ≤ 16383"
RANGE_CHECK -> ENCODE_3: "v ≤ 2097151"
RANGE_CHECK -> ENCODE_4: "v < 2²⁸"
RANGE_CHECK -> ENCODE_5_8: "v < 2⁵⁶"
RANGE_CHECK -> ENCODE_9: "v ≥ 2⁵⁶"

ENCODE_1 -> ENCODE_END
ENCODE_2 -> ENCODE_END
ENCODE_3 -> ENCODE_END
ENCODE_4 -> ENCODE_END
ENCODE_5_8 -> ENCODE_END
ENCODE_9 -> ENCODE_END

DECODE_START -> LEADING_BITS

LEADING_BITS -> DECODE_1: "0 leading"
LEADING_BITS -> DECODE_2: "1 leading"
LEADING_BITS -> DECODE_3: "2 leading"
LEADING_BITS -> DECODE_4: "3 leading"
LEADING_BITS -> DECODE_N: "4-8 leading"
LEADING_BITS -> DECODE_RAW: "all 1s (0xFF)"

DECODE_1 -> DECODE_END
DECODE_2 -> DECODE_END
DECODE_3 -> DECODE_END
DECODE_4 -> DECODE_END
DECODE_N -> DECODE_END
DECODE_RAW -> DECODE_END

LEGEND: {
  label: "Bit Pattern Legend\n━━━━━━━━━━━━━━\n0xxxxxxx = 1 byte (0-127)\n10xxxxxx = 2 bytes (128-16383)\n110xxxxx = 3 bytes (16384-2097151)\n1110xxxx = 4 bytes\n11110xxx = 5 bytes\n111110xx = 6 bytes\n1111110x = 7 bytes\n11111110 = 8 bytes\n11111111 = 9 bytes (raw int64)"
  shape: rectangle
  style.fill: "#FAFAFA"
  style.stroke: "#666666"
}

LEGEND -> ENCODE_START: {
  style.stroke: "transparent"
}