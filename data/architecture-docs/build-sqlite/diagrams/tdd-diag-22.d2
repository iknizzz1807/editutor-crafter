direction: right

title: Node Split Operation Algorithm {
  shape: text
  near: top-center
}

step1: Find Median Key {
  shape: rectangle
  style.fill: "#E3F2FD"
  style.stroke: "#1976D2"
}

step1_detail: {
  shape: sequence_diagram
  overflowing_node: "Full Node [n keys]" {
    style.fill: "#FFCDD2"
  }
  median: "Median = keys[n/2]" {
    style.fill: "#C8E6C9"
  }
  overflowing_node -> median: "Select middle key"
}

step2: Create New Page {
  shape: rectangle
  style.fill: "#E8F5E9"
  style.stroke: "#388E3C"
}

step2_detail: {
  shape: sequence_diagram
  buffer_pool: "Buffer Pool" {
    style.fill: "#B3E5FC"
  }
  new_page: "New Page (PageID)" {
    style.fill: "#C8E6C9"
  }
  buffer_pool -> new_page: "Allocate page\nInitialize header"
}

step3: Move Half Cells {
  shape: rectangle
  style.fill: "#FFF3E0"
  style.stroke: "#F57C00"
}

step3_detail: {
  shape: sequence_diagram
  left_node: "Left Node\n[0..mid-1]" {
    style.fill: "#BBDEFB"
  }
  right_node: "Right Node\n[mid+1..n]" {
    style.fill: "#C8E6C9"
  }
  cells_moving: "Cells Moving" {
    style.fill: "#FFE0B2"
  }
  left_node -> cells_moving: "Copy upper half"
  cells_moving -> right_node: "Insert cells"
}

step4: Promote Separator {
  shape: rectangle
  style.fill: "#F3E5F5"
  style.stroke: "#7B1FA2"
}

step4_detail: {
  shape: sequence_diagram
  parent: "Parent Node" {
    style.fill: "#E1BEE7"
  }
  separator: "Separator Key\n(median)" {
    style.fill: "#FFCC80"
  }
  left_ptr: "Left PageID" {
    style.fill: "#BBDEFB"
  }
  right_ptr: "Right PageID" {
    style.fill: "#C8E6C9"
  }
  separator -> parent: "Insert at position i"
  parent -> left_ptr: "Update child ptr"
  parent -> right_ptr: "Add new child ptr"
}

step5: Handle Parent Overflow {
  shape: rectangle
  style.fill: "#FFEBEE"
  style.stroke: "#D32F2F"
}

step5_detail: {
  check: "Parent Full?" {
    shape: diamond
    style.fill: "#FFCDD2"
  }
  yes: "YES" {
    shape: text
  }
  no: "NO" {
    shape: text
  }
  complete: "Split Complete" {
    shape: rectangle
    style.fill: "#C8E6C9"
  }
  cascade: "Cascade Split\n(Go to Step 1)" {
    shape: rectangle
    style.fill: "#FFCDD2"
  }
  
  check -> yes: "overflow"
  check -> no: "space"
  yes -> cascade
  no -> complete
}

step1 -> step2 -> step3 -> step4 -> step5: "" {
  style.stroke: "#455A64"
  style.stroke-width: 3
}

legend: {
  shape: rectangle
  style.fill: "#FAFAFA"
  style.stroke: "#BDBDBD"
  
  before: "Before: [k0|k1|k2|k3|k4]" {
    shape: rectangle
    style.fill: "#FFCDD2"
  }
  after: "After:  [k0|k1] up k2 up [k3|k4]" {
    shape: rectangle
    style.fill: "#C8E6C9"
  }
  
  before -> after: "Split Operation"
}

step5 -> step1: "RECURSE\n(if cascade)" {
  style.stroke: "#D32F2F"
  style.stroke-dash: 4
  style.stroke-width: 2
}