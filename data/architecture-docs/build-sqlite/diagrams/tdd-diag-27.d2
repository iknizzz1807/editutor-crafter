vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

title: Index Entry Format - Memory Layout {
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    font-color: "#74b9ff"
  }
}

index_leaf_cell: {
  style.fill: "#1a1a2e"
  style.stroke: "#4a9eff"
  
  payload_size: {
    label: "Payload Size\n(varint)"
    width: 120
    height: 60
    style.fill: "#16213e"
    style.stroke: "#4a9eff"
    style.font-color: "#74b9ff"
  }
  
  indexed_value: {
    label: "Indexed Value\n(serialized)"
    width: 160
    height: 60
    style.fill: "#0f3460"
    style.stroke: "#4a9eff"
    style.font-color: "#74b9ff"
  }
  
  rowid: {
    label: "Rowid\n(varint)"
    width: 100
    height: 60
    style.fill: "#16213e"
    style.stroke: "#4a9eff"
    style.font-color: "#74b9ff"
  }
  
  payload_size -> indexed_value -> rowid
}

byte_detail: {
  label: "Varint Encoding Detail"
  style.fill: "#0d0d1a"
  style.stroke: "#6c757d"
  
  varint_example: {
    byte1: {
      label: "0x81"
      width: 40
      height: 30
      style.fill: "#2d3436"
      style.stroke: "#6c757d"
      style.font-color: "#adb5bd"
    }
    
    byte2: {
      label: "0x3F"
      width: 40
      height: 30
      style.fill: "#2d3436"
      style.stroke: "#6c757d"
      style.font-color: "#adb5bd"
    }
    
    continuation: {
      label: "..."
      width: 40
      height: 30
      style.fill: "#2d3436"
      style.stroke: "#6c757d"
      style.font-color: "#888"
    }
    
    byte1 -> byte2 -> continuation
  }
  
  note: |md
    MSB=1: more bytes follow
    MSB=0: final byte
    7 bits payload per byte
  |
}

serial_type_detail: {
  label: "Serial Type Encoding"
  style.fill: "#0d0d1a"
  style.stroke: "#6c757d"
  
  type_header: {
    label: "Type\n(varint)"
    width: 60
    height: 50
    style.fill: "#2d3436"
    style.stroke: "#00cec9"
    style.font-color: "#00cec9"
  }
  
  type_value: {
    label: "Value\n(variable)"
    width: 80
    height: 50
    style.fill: "#2d3436"
    style.stroke: "#00cec9"
    style.font-color: "#00cec9"
  }
  
  type_header -> type_value
}

key_ordering: {
  label: "Composite Key Ordering"
  style.fill: "#0d0d1a"
  style.stroke: "#fd79a8"
  
  order_desc: {
    shape: text
    label: "Sort Order: (Column Value, Rowid)"
    style.font-color: "#fd79a8"
    style.bold: true
  }
  
  entry_1: {
    label: "('Alice', 5)"
    width: 100
    height: 35
    style.fill: "#2d3436"
    style.stroke: "#00b894"
    style.font-color: "#00b894"
  }
  
  entry_2: {
    label: "('Alice', 12)"
    width: 100
    height: 35
    style.fill: "#2d3436"
    style.stroke: "#00b894"
    style.font-color: "#00b894"
  }
  
  entry_3: {
    label: "('Bob', 3)"
    width: 100
    height: 35
    style.fill: "#2d3436"
    style.stroke: "#00b894"
    style.font-color: "#00b894"
  }
  
  entry_1 -> entry_2 -> entry_3
  
  arrow_label: {
    shape: text
    label: "↑ Ascending Order"
    style.font-color: "#00b894"
  }
}

uniqueness: {
  label: "Uniqueness Guarantee\n\n• Same column value → sorted by rowid\n• (value, rowid) pair is always unique\n• Enables efficient range scans"
  style.fill: "#0d0d1a"
  style.stroke: "#a29bfe"
  style.font-color: "#dfe6e9"
}

address_bar: {
  label: "Offset: 0x0000                                                              →"
  style.fill: "#1a1a2e"
  style.stroke: "#4a9eff"
  style.font-color: "#74b9ff"
  style.font-size: 12
}

legend: {
  label: "Legend"
  style.fill: "#0d0d1a"
  style.stroke: "#636e72"
  
  varint_key: {
    label: ""
    width: 20
    height: 15
    style.fill: "#16213e"
  }
  
  varint_label: {
    shape: text
    label: "Varint (1-9 bytes)"
    style.font-color: "#adb5bd"
  }
  
  value_key: {
    label: ""
    width: 20
    height: 15
    style.fill: "#0f3460"
  }
  
  value_label: {
    shape: text
    label: "Serialized Value"
    style.font-color: "#adb5bd"
  }
}

sizes: {
  shape: text
  label: "Field Sizes:\n• Payload Size: 1-9 bytes (varint)\n• Indexed Value: variable (per serial type)\n• Rowid: 1-9 bytes (varint)"
  style.font-color: "#74b9ff"
}

address_bar -> index_leaf_cell: {style.stroke-dash: 3}
index_leaf_cell -> byte_detail
index_leaf_cell -> serial_type_detail
index_leaf_cell -> key_ordering
key_ordering -> uniqueness
legend.varint_key -> legend.varint_label
legend.value_key -> legend.value_label