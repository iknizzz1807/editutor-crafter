direction: right

# Transaction State Machine
# Module: M9 - Transactions (Rollback Journal)

title: Transaction State Machine {
  shape: text
  near: top-center
  style: {
    font-size: 24
    bold: true
    underline: true
  }
}

# State definitions
None: {
  shape: circle
  style: {
    fill: "#E8F5E9"
    stroke: "#2E7D32"
    stroke-width: 3
  }
}

Active: {
  shape: circle
  style: {
    fill: "#FFF3E0"
    stroke: "#E65100"
    stroke-width: 3
  }
}

Committed: {
  shape: circle
  style: {
    fill: "#E3F2FD"
    stroke: "#1565C0"
    stroke-width: 3
  }
}

RolledBack: {
  shape: circle
  style: {
    fill: "#FFEBEE"
    stroke: "#C62828"
    stroke-width: 3
  }
}

# Terminal state indicators
Committed_terminator: {
  shape: circle
  style: {
    fill: "#1565C0"
    stroke: "#1565C0"
  }
}
Committed_terminator -- Committed

RolledBack_terminator: {
  shape: circle
  style: {
    fill: "#C62828"
    stroke: "#C62828"
  }
}
RolledBack_terminator -- RolledBack

# Initial state indicator
initial_indicator: {
  shape: circle
  style: {
    fill: "#2E7D32"
    stroke: "#2E7D32"
  }
}
initial_indicator -> None

# Valid transitions
None -> Active: BEGIN {
  style: {
    stroke: "#2E7D32"
    stroke-width: 2
    animated: true
  }
}

Active -> Committed: COMMIT {
  style: {
    stroke: "#1565C0"
    stroke-width: 2
    animated: true
  }
}

Active -> RolledBack: ROLLBACK {
  style: {
    stroke: "#C62828"
    stroke-width: 2
    animated: true
  }
}

# State labels
None.label: "IDLE\n(no transaction)"
Active.label: "ACTIVE\n(transaction in progress)"
Committed.label: "COMMITTED\n(changes saved)"
RolledBack.label: "ROLLED BACK\n(changes undone)"

# Legend
legend: {
  shape: rectangle
  style: {
    fill: "#FAFAFA"
    stroke: "#9E9E9E"
    stroke-dash: 3
  }
  
  valid_transition: "→ Valid Transition"
  valid_transition.style.stroke: "#2E7D32"
  
  invalid_note: "Invalid Transitions:"
  invalid_note.style: {
    font-size: 12
    italic: true
  }
  
  inv1: "• Active → Active (no nested BEGIN)"
  inv1.style.fill: "#FFCDD2"
  
  inv2: "• Committed → Rollback (final state)"
  inv2.style.fill: "#FFCDD2"
}

# Invalid transitions documentation (shown as text, not connected)
invalid_transitions: {
  shape: rectangle
  style: {
    fill: "#FFEBEE"
    stroke: "#C62828"
    stroke-dash: 4
  }
  
  note: "⚠ INVALID TRANSITIONS"
  note.style: {
    bold: true
    fill: "#FFCDD2"
  }
  
  inv1: "BEGIN during Active → SQLITE_ERROR"
  inv2: "ROLLBACK after COMMIT → SQLITE_ERROR"
}