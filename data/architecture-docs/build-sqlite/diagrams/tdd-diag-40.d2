direction: down

title: WAL-Index Hash Table Structure {
  near: top-center
  shape: text
  style.font-size: 24
  style.bold: true
}

WALIndex: {
  shape: rectangle
  style.fill: "#E3F2FD"
  style.stroke: "#1976D2"
  style.stroke-width: 2
  
  shmData: {
    label: "shmData []byte\n(Memory-Mapped .db-shm)"
    shape: rectangle
    style.fill: "#BBDEFB"
    style.stroke: "#1976D2"
  }
  
  hashTables: {
    label: "hashTables []*WALIndexHash"
    shape: rectangle
    style.fill: "#BBDEFB"
    style.stroke: "#1976D2"
  }
  
  shmData -> hashTables: "contains pointers to"
}

HashTable_0: {
  label: "WALIndexHash[0]\n(Snapshot 0)"
  shape: rectangle
  style.fill: "#E8F5E9"
  style.stroke: "#388E3C"
  style.stroke-width: 2
  
  Entries_0: {
    label: "Entries [256]WALIndexEntry"
    shape: rectangle
    style.fill: "#C8E6C9"
    style.stroke: "#388E3C"
  }
}

HashTable_1: {
  label: "WALIndexHash[1]\n(Snapshot 1)"
  shape: rectangle
  style.fill: "#E8F5E9"
  style.stroke: "#388E3C"
  style.stroke-width: 2
  
  Entries_1: {
    label: "Entries [256]WALIndexEntry"
    shape: rectangle
    style.fill: "#C8E6C9"
    style.stroke: "#388E3C"
  }
}

HashTable_N: {
  label: "WALIndexHash[N]\n(Snapshot N)"
  shape: rectangle
  style.fill: "#E8F5E9"
  style.stroke: "#388E3C"
  style.stroke-width: 2
  
  Entries_N: {
    label: "Entries [256]WALIndexEntry"
    shape: rectangle
    style.fill: "#C8E6C9"
    style.stroke: "#388E3C"
  }
}

WALIndex.hashTables -> HashTable_0: {
  style.stroke-dash: 3
}
WALIndex.hashTables -> HashTable_1: {
  style.stroke-dash: 3
}
WALIndex.hashTables -> HashTable_N: {
  style.stroke-dash: 3
  label: "..."
}

Entry_Detail: {
  label: "WALIndexEntry Structure"
  shape: rectangle
  style.fill: "#FFF3E0"
  style.stroke: "#F57C00"
  style.stroke-width: 2
  
  PageNumber: {
    label: "PageNumber: uint32\n(Database page)"
    shape: rectangle
    style.fill: "#FFE0B2"
    style.stroke: "#F57C00"
  }
  
  FrameIndex: {
    label: "FrameIndex: uint32\n(0 = not in WAL,\n1+ = frame number)"
    shape: rectangle
    style.fill: "#FFE0B2"
    style.stroke: "#F57C00"
  }
  
  PageNumber -> FrameIndex: "maps to"
}

Lookup_Flow: {
  label: "Lookup Flow"
  shape: rectangle
  style.fill: "#FCE4EC"
  style.stroke: "#C2185B"
  style.stroke-width: 2
  
  step1: "1. Hash(pageNumber) → index (0-255)" {
    shape: text
    style.font-size: 12
  }
  
  step2: "2. Check hashTable[i].Entries[index]" {
    shape: text
    style.font-size: 12
  }
  
  step3: "3. If PageNumber matches → return FrameIndex" {
    shape: text
    style.font-size: 12
  }
  
  step4: "4. If collision → linear probe next slot" {
    shape: text
    style.font-size: 12
  }
  
  step5: "5. If not found → page not in WAL" {
    shape: text
    style.font-size: 12
  }
}

Entry_Example: {
  label: "Example Entry"
  shape: rectangle
  style.fill: "#F3E5F5"
  style.stroke: "#7B1FA2"
  
  ex_page: "PageNumber: 42" {
    shape: text
    style.font-size: 14
    style.bold: true
  }
  
  ex_frame: "FrameIndex: 7" {
    shape: text
    style.font-size: 14
    style.bold: true
  }
  
  ex_meaning: "= Page 42 is in WAL frame 7" {
    shape: text
    style.font-size: 11
    style.italic: true
  }
}

Lookup_Flow -> Entry_Detail: "uses"
Entry_Detail -> Entry_Example: "example"