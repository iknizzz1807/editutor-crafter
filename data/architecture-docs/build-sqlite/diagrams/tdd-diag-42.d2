direction: right

M1: Tokenizer & Parser: {
  style.fill: "#E3F2FD"
  style.stroke: "#1976D2"
  
  Core: {
    style.fill: "#BBDEFB"
    
    Tokenizer: {
      style.fill: "#90CAF9"
      Input: "Raw SQL String"
      Lexer: "Character Analysis"
      Token: "Output Tokens"
    }
    
    Parser: {
      style.fill: "#90CAF9"
      Tokens: "Token Stream"
      Grammar: "Syntax Rules"
      AST: "Abstract Syntax Tree"
    }
  }
  
  Dependencies: {
    style.fill: "#E1F5FE"
    
    Keywords: "SQLite Keywords"
    Operators: "SQL Operators"
    DataTypes: "Type System"
  }
  
  Flow: {
    Input -> Tokenizer
    Tokenizer -> Parser
    Parser -> AST
  }
}

M2: Virtual Database Engine (VDBE): {
  style.fill: "#E8F5E9"
  style.stroke: "#388E3C"
  
  Core: {
    style.fill: "#C8E6C9"
    
    Compiler: {
      style.fill: "#A5D6A7"
      Input: "AST from Parser"
      CodeGen: "Bytecode Generation"
      Instructions: "VDBE Program"
    }
    
    Executor: {
      style.fill: "#A5D6A7"
      Fetch: "Instruction Fetch"
      Decode: "Operation Decode"
      Execute: "Run Instruction"
    }
  }
  
  Dependencies: {
    style.fill: "#E8F5E9"
    
    OpCodes: "Instruction Set"
    Registers: "Value Storage"
    Cursors: "Table Navigation"
  }
}

M3: B-Tree Storage: {
  style.fill: "#FFF3E0"
  style.stroke: "#F57C00"
  
  Core: {
    style.fill: "#FFE0B2"
    
    TableBTree: {
      style.fill: "#FFCC80"
      Pages: "Data Pages"
      Keys: "Row IDs"
      Records: "Row Data"
    }
    
    IndexBTree: {
      style.fill: "#FFCC80"
      IndexPages: "Index Structure"
      IndexKeys: "Indexed Columns"
      Pointers: "Row References"
    }
  }
  
  Dependencies: {
    style.fill: "#FFF8E1"
    
    PageFormat: "Page Layout"
    CellFormat: "Cell Structure"
    Overflow: "Overflow Handling"
  }
}

M4: Page Cache & Buffer Pool: {
  style.fill: "#F3E5F5"
  style.stroke: "#7B1FA2"
  
  Core: {
    style.fill: "#E1BEE7"
    
    Cache: {
      style.fill: "#CE93D8"
      Pages: "Cached Pages"
      Hash: "Page Lookup"
      LRU: "Eviction Policy"
    }
    
    IOModule: {
      style.fill: "#CE93D8"
      Read: "Page Read"
      Write: "Page Write"
      Sync: "Disk Sync"
    }
  }
  
  Dependencies: {
    style.fill: "#F3E5F5"
    
    Pager: "Pager Interface"
    WAL: "Write-Ahead Log"
    Locking: "File Locks"
  }
}

M5: Query Planner: {
  style.fill: "#FFEBEE"
  style.stroke: "#D32F2F"
  
  Core: {
    style.fill: "#FFCDD2"
    
    Analyzer: {
      style.fill: "#EF9A9A"
      Parse: "Query Analysis"
      Stats: "Table Statistics"
      Constraints: "WHERE Clauses"
    }
    
    Optimizer: {
      style.fill: "#EF9A9A"
      Index: "Index Selection"
      Join: "Join Ordering"
      Cost: "Cost Estimation"
    }
  }
  
  Dependencies: {
    style.fill: "#FFEBEE"
    
    Schema: "Table Schema"
    Indexes: "Available Indexes"
    Stats2: "Query Statistics"
  }
}

M6: Expression Evaluation: {
  style.fill: "#E0F2F1"
  style.stroke: "#00796B"
  
  Core: {
    style.fill: "#B2DFDB"
    
    Evaluator: {
      style.fill: "#80CBC4"
      Stack: "Value Stack"
      Operators2: "Op Functions"
      Functions: "Scalar Functions"
    }
    
    TypeSystem: {
      style.fill: "#80CBC4"
      Affinity: "Type Affinity"
      Coercion: "Type Conversion"
      Null: "NULL Handling"
    }
  }
  
  Dependencies: {
    style.fill: "#E0F2F1"
    
    Collations: "Sort Orders"
      Aggregates: "Aggregate Functions"
      BuiltIns: "Built-in Functions"
  }
}

M7: Transaction Management: {
  style.fill: "#ECEFF1"
  style.stroke: "#455A64"
  
  Core: {
    style.fill: "#CFD8DC"
    
    Journal: {
      style.fill: "#B0BEC5"
      Rollback: "Rollback Journal"
      Begin: "Transaction Start"
      Commit: "Transaction End"
    }
    
    Locking2: {
      style.fill: "#B0BEC5"
      Shared: "Read Locks"
      Exclusive: "Write Locks"
      Deadlock: "Deadlock Detection"
    }
  }
  
  Dependencies: {
    style.fill: "#ECEFF1"
    
    ACID: "ACID Properties"
    Isolation: "Isolation Levels"
    Recovery: "Crash Recovery"
  }
}

M8: Write-Ahead Logging: {
  style.fill: "#FFF8E1"
  style.stroke: "#FFA000"
  
  Core: {
    style.fill: "#FFECB3"
    
    WALManager: {
      style.fill: "#FFE082"
      Frames: "WAL Frames"
      Header: "WAL Header"
      Index2: "WAL Index"
    }
    
    Checkpoint: {
      style.fill: "#FFE082"
      Merge: "Merge to DB"
      Truncate: "WAL Truncate"
      Restart: "Checkpoint Restart"
    }
  }
  
  Dependencies: {
    style.fill: "#FFF8E1"
    
    SharedMem: "Shared Memory"
    Sync2: "FS Sync"
    Readers: "Read Markers"
  }
}

M9: SQL Frontend: {
  style.fill: "#F1F8E9"
  style.stroke: "#689F38"
  
  Core: {
    style.fill: "#DCEDC8"
    
    Prepare: {
      style.fill: "#C5E1A5"
      Statement: "Prepared Stmt"
      Bind: "Parameter Binding"
      Reset: "Statement Reset"
    }
    
    Execute2: {
      style.fill: "#C5E1A5"
      Step: "Execute Step"
      Row: "Row Callback"
      Finalize: "Cleanup"
    }
  }
  
  Dependencies: {
    style.fill: "#F1F8E9"
    
    Connection: "DB Connection"
    Errors: "Error Handling"
    Schema3: "Schema Cache"
  }
}

M10: Record Format: {
  style.fill: "#FBE9E7"
  style.stroke: "#E64A19"
  
  Core: {
    style.fill: "#FFCCBC"
    
    Serializer: {
      style.fill: "#FFAB91"
      Encode: "Value Encode"
      Varint: "Varint Encoding"
      Record2: "Record Assembly"
    }
    
    Deserializer: {
      style.fill: "#FFAB91"
      Decode: "Value Decode"
      Parse2: "Record Parse"
      Extract: "Column Extract"
    }
  }
  
  Dependencies: {
    style.fill: "#FBE9E7"
    
    SerialTypes: "Serial Type Codes"
    Header2: "Record Header"
    Payload: "Payload Size"
  }
}

M11: File Format: {
  style.fill: "#E8EAF6"
  style.stroke: "#3F51B5"
  
  Core: {
    style.fill: "#C5CAE9"
    
    Database: {
      style.fill: "#9FA8DA"
      Header3: "DB Header"
      Pages2: "Page Structure"
      Freelist: "Free Pages"
    }
    
    Layout: {
      style.fill: "#9FA8DA"
      Page1: "Schema Table"
      Page2: "Root Pages"
      Overflow2: "Overflow Pages"
    }
  }
  
  Dependencies: {
    style.fill: "#E8EAF6"
    
    PageSize: "Page Size Config"
    Encoding: "Text Encoding"
    Version: "Format Version"
  }
}

# Relationships
M1 -> M2: "AST"
M2 -> M5: "Bytecode"
M5 -> M3: "Query Plan"
M3 -> M4: "Page Requests"
M4 -> M8: "Write Operations"
M7 -> M4: "Transaction Control"
M6 -> M2: "Expression Eval"
M9 -> M1: "SQL Input"
M10 -> M3: "Record I/O"
M11 -> M4: "File Structure"