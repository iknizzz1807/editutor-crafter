direction: right
title: HAVING vs WHERE Execution Order

# Input data source
source_data: {
  label: FROM
  shape: cylinder
  style: {
    fill: "#E3F2FD"
  }
}

# Stage 1: WHERE - Row-level filtering
where_stage: {
  label: "WHERE\n(filter rows)"
  shape: rectangle
  style: {
    fill: "#FFECB3"
    stroke: "#FF9800"
    bold: true
  }
}

where_description: {
  label: "Filters individual rows\nbefore grouping"
  shape: text
  style: {
    font-size: 12
    italic: true
  }
}

# Stage 2: GROUP BY
groupby_stage: {
  label: GROUP BY
  shape: rectangle
  style: {
    fill: "#E8F5E9"
  }
}

# Stage 3: Aggregate Functions
aggregate_stage: {
  label: AGGREGATE\n(COUNT, SUM, etc.)
  shape: rectangle
  style: {
    fill: "#F3E5F5"
  }
}

# Stage 4: HAVING - Group-level filtering
having_stage: {
  label: "HAVING\n(filter groups)"
  shape: rectangle
  style: {
    fill: "#FFCDD2"
    stroke: "#F44336"
    bold: true
  }
}

having_description: {
  label: "Filters groups\nafter aggregation"
  shape: text
  style: {
    font-size: 12
    italic: true
  }
}

# Stage 5: SELECT
select_stage: {
  label: SELECT
  shape: rectangle
  style: {
    fill: "#E3F2FD"
  }
}

# Stage 6: ORDER BY
orderby_stage: {
  label: ORDER BY
  shape: rectangle
  style: {
    fill: "#E0E0E0"
  }
}

# Stage 7: LIMIT
limit_stage: {
  label: LIMIT
  shape: rectangle
  style: {
    fill: "#B2DFDB"
  }
}

# Output
result_set: {
  label: Result Set
  shape: cylinder
  style: {
    fill: "#C8E6C9"
  }
}

# Data flow connections
source_data -> where_stage: "Raw table data" {
  style: {
    stroke: "#1976D2"
    stroke-width: 3
  }
}

where_stage -> groupby_stage: "Filtered rows" {
  style: {
    stroke: "#1976D2"
    stroke-width: 3
  }
}

groupby_stage -> aggregate_stage: "Grouped rows" {
  style: {
    stroke: "#1976D2"
    stroke-width: 3
  }
}

aggregate_stage -> having_stage: "Aggregated groups" {
  style: {
    stroke: "#1976D2"
    stroke-width: 3
  }
}

having_stage -> select_stage: "Filtered groups" {
  style: {
    stroke: "#1976D2"
    stroke-width: 3
  }
}

select_stage -> orderby_stage: "Projected columns" {
  style: {
    stroke: "#1976D2"
    stroke-width: 3
  }
}

orderby_stage -> limit_stage: "Sorted rows" {
  style: {
    stroke: "#1976D2"
    stroke-width: 3
  }
}

limit_stage -> result_set: "Final rows" {
  style: {
    stroke: "#1976D2"
    stroke-width: 3
  }
}

# Legend
legend: {
  label: Filter Type Legend
  shape: rectangle

  where_filter: {
    label: "WHERE: Row filter\n(Pre-aggregation)"
    shape: rectangle
    style: {
      fill: "#FFECB3"
      stroke: "#FF9800"
    }
  }

  having_filter: {
    label: "HAVING: Group filter\n(Post-aggregation)"
    shape: rectangle
    style: {
      fill: "#FFCDD2"
      stroke: "#F44336"
    }
  }
}

# Execution order indicator
exec_order: {
  label: "Execution Order: 1 → 2 → 3 → 4 → 5 → 6 → 7 → 8"
  shape: text
  style: {
    font-size: 14
    bold: true
    underline: true
  }
}