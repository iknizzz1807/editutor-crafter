vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

error_detection: {
  label: "Error Detection"
  
  detect: {
    label: "Syntax Error\nDetected"
    shape: diamond
  }
}

position_capture: {
  label: "Position Capture"
  
  capture: {
    label: "Capture Error Position"
    pos_line: "Line Number"
    pos_col: "Column Number"
    pos_token: "Current Token"
    pos_ctx: "Source Context"
  }
}

create_error: {
  label: "Create Error Object"
  err_type: "Error Type (Syntax/Semantic)"
  err_msg: "Error Message"
  err_pos: "Position Info"
}

synchronize: {
  label: "Synchronize"
  
  find_boundary: {
    label: "Find Statement\nBoundary"
    shape: diamond
  }
  
  skip_tokens: "Skip Tokens\nUntil Boundary"
  boundaries: {
    label: "Boundary Tokens"
    semicolon: "; (Semicolon)"
    begin: "BEGIN"
    commit: "COMMIT"
    rollback: "ROLLBACK"
    create: "CREATE"
    select: "SELECT"
    insert: "INSERT"
    update: "UPDATE"
    delete: "DELETE"
  }
}

decision: {
  label: "Continue or Report?"
  shape: diamond
}

continue_parsing: {
  label: "Continue Parsing"
  note: "Resume from\nsynchronization point"
}

report_error: {
  label: "Report Error"
  
  error_report: {
    label: "Error Report"
    msg: "Error Message"
    loc: "Location (line:col)"
    src_snippet: "Source Snippet"
    hint: "Recovery Hint"
  }
}

collect_errors: {
  label: "Error Collection"
  shape: cylinder
  note: "Accumulate multiple\nerrors for batch report"
}

final_check: {
  label: "More Input?"
  shape: diamond
}

done: {
  label: "Return AST + Errors"
  shape: oval
}

input: {
  label: "Token Stream"
  shape: oval
}

input -> error_detection

error_detection.detect -> position_capture: "Yes\n(error found)"
error_detection.detect -> final_check: "No\n(continue)"

position_capture -> create_error
create_error -> synchronize

synchronize.find_boundary -> synchronize.skip_tokens: "Not at\nboundary"
synchronize.skip_tokens -> synchronize.find_boundary

synchronize.find_boundary -> decision: "At boundary"

decision -> continue_parsing: "Can recover"
decision -> report_error: "Fatal error"

continue_parsing -> error_detection
report_error -> collect_errors
collect_errors -> final_check

final_check -> error_detection: "Yes"
final_check -> done: "No"

legend: {
  label: "Legend"
  
  process_legend: "Process" {
    style.fill: "#E3F2FD"
  }
  decision_legend: "Decision" {
    shape: diamond
    style.fill: "#FFF3E0"
  }
  storage_legend: "Storage" {
    shape: cylinder
    style.fill: "#E8F5E9"
  }
  oval_legend: "Terminal" {
    shape: oval
    style.fill: "#F3E5F5"
  }
}

title: {
  label: "Parser Error Recovery Flow\n\nError Detection → Position Capture → Synchronize to Statement Boundary → Continue Parsing or Report"
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
  }
}