direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- SOURCE BUFFER ---
SourceBuffer: "SQL Source String (UTF-8 Buffer)" {
  style.fill: "#add8e6"
  content: |md
    `S E L E C T   *   F R O M   u s e r s ; \0`
  |
}

# --- SCANNER STRUCTURE ---
Scanner: {
  label: "struct Scanner"
  style.stroke: "#6a0dad"
  style.stroke-width: 4

  header: "Scanner Descriptor" {
    style.fill: "#6a0dad"
    style.font-color: white
  }

  layout: {
    shape: sql_table
    style.fill: "#6a0dad"
    "0x00": "source: const char*" {constraint: "8 bytes"}
    "0x08": "start: const char*" {constraint: "8 bytes"}
    "0x10": "current: const char*" {constraint: "8 bytes"}
    "0x18": "line: uint32_t" {constraint: "4 bytes"}
    "0x1C": "col: uint32_t" {constraint: "4 bytes"}
    "0x20": "padding/reserved" {constraint: "32 bytes"}
  }

  # Apply Technical Design Artist Color Rules
  # Header=Purple, Data=Blue, Free=Green, Padding=Gray, Pointers=Orange
  layout."0x00".style.fill: "#ffa500"
  layout."0x08".style.fill: "#ffa500"
  layout."0x10".style.fill: "#ffa500"
  layout."0x18".style.fill: "#add8e6"
  layout."0x1C".style.fill: "#add8e6"
  layout."0x20".style.fill: "#808080"

  # Visual boundary for cache line
  layout.style.stroke-dash: 5

  footer: |md
    **sizeof=64 bytes (one cache line)**
  |
}

# --- STATE MACHINE DISPATCH ---
FSM: "State Machine Dispatch" {
  style.fill: white
  style.stroke-dash: 3

  dispatch: "scanner_next_token()" {
    shape: rectangle
    style.bold: true
  }

  classify: "switch (*current)" {
    shape: diamond
  }

  states: {
    string: "scan_string()"
    number: "scan_number()"
    ident: "scan_identifier()"
    symbol: "TK_SYMBOL"
  }

  dispatch -> classify
  classify -> states.string: "c == '\''"
  classify -> states.number: "IS_DIGIT(c)"
  classify -> states.ident: "IS_ALPHA(c)"
  classify -> states.symbol: "default"
}

# --- POINTER REFERENCES ---
Scanner.layout."0x00" -> SourceBuffer: "references" {
  style.stroke-dash: 3
  style.stroke: "#ffa500"
}
Scanner.layout."0x08" -> SourceBuffer: "lexeme start" {
  style.stroke: "#ffa500"
}
Scanner.layout."0x10" -> SourceBuffer: "lookahead" {
  style.stroke: "#ffa500"
}

# --- ARCHITECTURE RELATIONS ---
# Hollow triangle = implements
Scanner -> FSM.dispatch: "implements" {
  style.stroke-dash: 5
  target-arrowhead: * {
    shape: triangle
    style.filled: false
  }
}

# --- ANNOTATIONS ---
# Fixed ELK error: 'near' now uses a constant position
Annotations: |md
### Lexer Invariants
- **O(1) Memory**: Zero-copy tokens using pointer/length views.
- **O(N) Time**: Single-pass scanning with no backtracking.
- **UTF-8 Aware**: Handles multi-byte sequences via pointer arithmetic.
| {
  near: bottom-right
}