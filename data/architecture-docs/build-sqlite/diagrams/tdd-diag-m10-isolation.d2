vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

snapshot_isolation_flow: {
  shape: sequence_diagram
  
  app: User_Application
  pager: Pager_Subsystem
  wal: Wal_Manager
  shm: Wal_Index_Shared_Memory
  disk: Wal_File_Disk_Store
  writer: Background_Writer

  # --- Reader Start Phase ---
  "T=0ms: Reader Transaction Begin"
  app -> pager: "pager_begin_read() -> void" {
    style.stroke: "#0000FF"
  }
  pager -> wal: "wal_snapshot_open() -> u32 read_mark" {
    style.stroke: "#0000FF"
  }
  wal -> shm: "▼ acquire_shm_lock(SHARED) -> void" {
    style.stroke: "#0000FF"
  }
  wal -> shm: "read_mx_frame() -> 10" {
    style.stroke: "#0000FF"
  }
  wal -> shm: "set_read_mark(slot=0, val=10) -> void" {
    style.stroke: "#0000FF"
  }
  wal -> shm: "▲ release_shm_lock() -> void" {
    style.stroke: "#0000FF"
  }
  pager <- wal: "10" {
    style.stroke: "#0000FF"
  }

  # --- Reader Page Retrieval (In WAL) ---
  "T=5ms: Fetch Page 5 (Present in WAL @ Frame 2)"
  app -> pager: "pager_fetch_page(page_id=5) -> void*" {
    style.stroke: "#0000FF"
  }
  pager -> wal: "wal_find_page(page_no=5, read_mark=10) -> u32 2" {
    style.stroke: "#0000FF"
  }
  wal -> disk: "pread(offset=8224, size=4096) -> bytes" {
    style.stroke: "#0000FF"
  }
  pager <- wal: "buffer_ptr" {
    style.stroke: "#0000FF"
  }

  # --- Concurrent Writer Activity (Async/Parallel) ---
  "T=10ms: Concurrent Writer Appends Frames 11-20"
  writer -> wal: "wal_append_frames(n=10, db_size=100) -> void" {
    style.stroke-dash: 5
  }
  wal -> disk: "pwrite(frames_11_20) -> void" {
    style.stroke-dash: 5
  }
  wal -> shm: "▼ acquire_shm_lock(EXCLUSIVE) -> void" {
    style.stroke-dash: 5
  }
  wal -> shm: "update_mx_frame(20) -> void" {
    style.stroke-dash: 5
  }
  wal -> shm: "▲ release_shm_lock() -> void" {
    style.stroke-dash: 5
  }

  # --- Reader Page Retrieval (New version ignored) ---
  "T=15ms: Fetch Page 8 (Updated by writer to Frame 15)"
  app -> pager: "pager_fetch_page(page_id=8) -> void*" {
    style.stroke: "#0000FF"
  }
  pager -> wal: "wal_find_page(page_no=8, read_mark=10) -> SQLITE_NOTFOUND" {
    style.stroke: "#0000FF"
  }
  wal."Frame 15 > ReadMark 10; Result ignored to preserve snapshot"
  pager -> disk: "pread_main_db(page_no=8) -> bytes" {
    style.stroke: "#0000FF"
  }

  # --- Reader Cleanup ---
  "T=20ms: Reader Transaction Finish"
  app -> pager: "pager_end_read() -> void" {
    style.stroke: "#0000FF"
  }
  pager -> wal: "wal_snapshot_close() -> void" {
    style.stroke: "#0000FF"
  }
  wal -> shm: "▼ acquire_shm_lock(SHARED) -> void" {
    style.stroke: "#0000FF"
  }
  wal -> shm: "clear_read_mark(slot=0) -> void" {
    style.stroke: "#0000FF"
  }
  wal -> shm: "▲ release_shm_lock() -> void" {
    style.stroke: "#0000FF"
  }
}