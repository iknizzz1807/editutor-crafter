vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# PARTICIPANTS (Headers = Purple, Data = Blue)
vm: "VDBE (Virtual Machine)" {
  shape: person
  style: {
    stroke: "#7015B1"
    fill: "#E4DBFE" # Purple Header
  }
}

c_out: "VdbeCursor (Outer)" {
  shape: rectangle
  style: {
    stroke: "#7015B1"
    fill: "#E4DBFE" # Purple Header
  }
}

c_in: "VdbeCursor (Inner)" {
  shape: rectangle
  style: {
    stroke: "#7015B1"
    fill: "#E4DBFE" # Purple Header
  }
}

bt_out: "B-Tree (Table A)" {
  shape: cylinder
  style: {
    stroke: "#0000FF"
    fill: "#C7F1FF" # Blue Data
  }
}

bt_in: "B-Tree (Table B)" {
  shape: cylinder
  style: {
    stroke: "#0000FF"
    fill: "#C7F1FF" # Blue Data
  }
}

reg: "Register File" {
  shape: package
  style: {
    stroke: "#0000FF"
    fill: "#C7F1FF" # Blue Data
  }
}

# EXECUTION SEQUENCE
nested_loop_join: {
  shape: sequence_diagram

  # Ensure consistent actor order
  vm; c_out; c_in; bt_out; bt_in; reg

  # LOCKING PHASE (Pointers/Locks = Orange)
  vm -> vm: "▼ Acquire SHARED_LOCK" {
    style: {
      stroke: "#FFA500" # Orange Lock
      font-color: "#FFA500"
    }
  }

  # OUTER LOOP INITIALIZATION (Normal = Blue)
  vm -> c_out: "Rewind(int cursor=0, int jump_pc=10)" {
    style.stroke: "#0000FF"
  }
  c_out -> bt_out: "btree_find_leaf(uint32_t root_id)" {
    style.stroke: "#0000FF"
  }
  bt_out -> c_out: "Page #5 (Leaf)" {
    style.stroke: "#0000FF"
  }
  c_out -> vm: "SQLITE_OK" {
    style.stroke: "#0000FF"
  }

  # OUTER LOOP BODY
  vm -> c_out: "Column(int cursor=0, int col=0, int reg=1)" {
    style.stroke: "#0000FF"
  }
  c_out -> reg: "Store [users.id] -> Reg[1]" {
    style.stroke: "#0000FF"
  }

  # INNER LOOP (INDEXED OPTIMIZATION)
  vm -> c_in: "SeekGE(int cursor=1, int jump_pc=9, Value reg[1])" {
    style.stroke: "#0000FF"
    tooltip: "O(log N) jump using index if available"
  }
  c_in -> bt_in: "btree_find_leaf(Value key)" {
    style.stroke: "#0000FF"
  }
  bt_in -> c_in: "Page #22 (Leaf)" {
    style.stroke: "#0000FF"
  }
  c_in -> vm: "SQLITE_OK" {
    style.stroke: "#0000FF"
  }

  # PREDICATE EVALUATION
  vm -> c_in: "Column(int cursor=1, int col=1, int reg=2)" {
    style.stroke: "#0000FF"
  }
  c_in -> reg: "Store [orders.amount] -> Reg[2]" {
    style.stroke: "#0000FF"
  }

  vm -> reg: "Evaluate Join Predicate (A.id == B.user_id)" {
    style.stroke: "#0000FF"
  }
  reg -> vm: "TRUE (3-Valued Logic)" {
    style.stroke: "#0000FF"
  }

  # RESULT EMISSION (Data = Blue, Bold)
  vm -> vm: "ResultRow(Reg[1..2])" {
    style: {
      stroke: "#0000FF"
      stroke-width: 4
      bold: true
    }
  }

  # INNER LOOP ITERATION (Async/Iteration = Dashed)
  vm -> c_in: "Next(int cursor=1, int loop_pc=5)" {
    style.stroke: "#0000FF"
    style.stroke-dash: 3
  }
  c_in -> vm: "SQLITE_OK (Next Match)" {
    style.stroke: "#0000FF"
    style.stroke-dash: 3
  }

  # OUTER LOOP ITERATION
  vm -> c_out: "Next(int cursor=0, int loop_pc=3)" {
    style.stroke: "#0000FF"
  }
  c_out -> vm: "SQLITE_DONE (EOF)" {
    style.stroke: "#0000FF"
  }

  # CLEANUP
  vm -> vm: "▲ Release SHARED_LOCK" {
    style: {
      stroke: "#FFA500" # Orange Lock
      font-color: "#FFA500"
    }
  }

  vm -> vm: "Halt()" {
    style.stroke: "#FF0000" # Error/End = Red
  }
}

# TIMING ANNOTATIONS
analysis: |md
  ### Critical Path Analysis
  - **Outer Scan**: O(N) pages.
  - **Inner Lookup**: O(log M) per outer row.
  - **Total Complexity**: O(N * log M).
  - **Buffer Pressure**: Requires (Height_A + Height_B) resident pages to avoid thrashing.
| {
  near: bottom-right
}