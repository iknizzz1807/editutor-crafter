direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# PRATT PARSING ALGORITHM: PRECEDENCE CLIMBING
# Input: 5 + 3 * 2

step1: {
  label: "Step 1: Initial Call"
  annotation: |md
    `parse_expression(min_bp=0)`
    Consume **5** via `parse_prefix()`.
  |
  token_stream: {
    t0: "5" {style.fill: "#3182bd"; style.bold: true; style.stroke: "#d62728"}
    t1: "+"
    t2: "3"
    t3: "*"
    t4: "2"
    ptr: "^" {style.font-color: "#e6550d"}
    ptr -> t0
  }
  ast_state: {
    node: "**Node(5)**" {style.font-color: "#d62728"; style.bold: true}
  }
}

step2: {
  label: "Step 2: Infix Check (+)"
  annotation: |md
    `peek()` is **+** (BP=60).
    60 > 0, so consume **+**.
    Call `parse_expression(min_bp=60)`.
  |
  token_stream: {
    t0: "5"
    t1: "+" {style.fill: "#3182bd"; style.bold: true; style.stroke: "#d62728"}
    t2: "3"
    t3: "*"
    t4: "2"
    ptr: "^" {style.font-color: "#e6550d"}
    ptr -> t1
  }
  ast_state: {
    plus: "+"
    plus -> "Node(5)"
    plus -> "**Pending...**" {style.stroke-dash: 3; style.font-color: "#d62728"}
  }
}

step3: {
  label: "Step 3: Recursive Call (*)"
  annotation: |md
    Inside `parse_expression(60)`.
    Consume **3**. `peek()` is ***** (BP=70).
    70 > 60, so recurse again:
    `parse_expression(min_bp=70)`.
  |
  token_stream: {
    t0: "5"
    t1: "+"
    t2: "3" {style.fill: "#3182bd"; style.bold: true}
    t3: "*" {style.fill: "#3182bd"; style.bold: true; style.stroke: "#d62728"}
    t4: "2"
    ptr: "^" {style.font-color: "#e6550d"}
    ptr -> t3
  }
  ast_state: {
    plus: "+"
    plus -> "Node(5)"
    plus -> star: "*" {style.font-color: "#d62728"}
    star -> "Node(3)"
    star -> "**Pending...**" {style.stroke-dash: 3; style.font-color: "#d62728"}
  }
}

step4: {
  label: "Step 4: Completion"
  annotation: |md
    `parse_expression(70)` consumes **2**.
    `peek()` is EOF. Unwind stack.
    Result: `5 + (3 * 2)`
  |
  token_stream: {
    t0: "5"
    t1: "+"
    t2: "3"
    t3: "*"
    t4: "2" {style.fill: "#3182bd"; style.bold: true}
    t_eof: "EOF" {style.stroke: "#d62728"}
    ptr: "^" {style.font-color: "#e6550d"}
    ptr -> t_eof
  }
  ast_state: {
    plus: "+" {style.fill: "#6e41ab"; style.font-color: "white"}
    plus -> n5: "Node(5)"
    plus -> star: "*" {style.fill: "#6e41ab"; style.font-color: "white"}
    star -> n3: "Node(3)"
    star -> n2: "**Node(2)**" {style.font-color: "#d62728"; style.bold: true}
    
    n5.style.fill: "#3182bd"
    n3.style.fill: "#3182bd"
    n2.style.fill: "#3182bd"
  }
}

step1 -> step2 -> step3 -> step4