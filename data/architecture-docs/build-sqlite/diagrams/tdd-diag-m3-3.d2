direction: right
# Input AST Node
ast_input: {
  shape: code
  language: python
  ast_input: |python
    {
      type: SELECT_STMT,
      columns: ["id", "name"],
      table: "users",
      where: null
    }
  |
}
# Compiler Process
compiler: {
  shape: rectangle
  label: "Bytecode\nCompiler"
  style.fill: "#E3F2FD"
}
# Bytecode Generation Steps
bytecode_gen: {
  label: "Bytecode Generation"
  step1: {
    shape: rectangle
    label: "Generate OpenRead"
    style.fill: "#FFF3E0"
  }
  step2: {
    shape: rectangle
    label: "Generate Rewind\n(save jump slot)"
    style.fill: "#FFF3E0"
  }
  step3: {
    shape: rectangle
    label: "Generate Column\noperations"
    style.fill: "#E8F5E9"
  }
  step4: {
    shape: rectangle
    label: "Generate ResultRow"
    style.fill: "#E8F5E9"
  }
  step5: {
    shape: rectangle
    label: "Generate Next\n(jump to Column)"
    style.fill: "#FCE4EC"
  }
  step6: {
    shape: rectangle
    label: "Generate Halt"
    style.fill: "#F3E5F5"
  }
  step1 -> step2 -> step3 -> step4 -> step5 -> step6
}
# Jump Patching
patching: {
  label: "Jump Target Patching"
  patch_table: {
    shape: sql_table
    Opcode: string
    PatchLocation: string
    Target: string
  }
  resolution: {
    shape: rectangle
    label: "Resolve\nForward Refs"
    style.fill: "#FFEBEE"
  }
  patch_table -> resolution
}
# Final Bytecode Output
bytecode_output: {
  shape: code
  language: python
  bytecode_output: |python
    0: OpenRead  0  users  0
    1: Rewind    0  [6]        ; patched: jump to Halt
    2: Column    0  0      r0  ; id
    3: Column    0  1      r1  ; name
    4: ResultRow r0 r1    2
    5: Next      0  [2]        ; patched: loop to Column
    6: Halt      0  0
  |
}
# Connections
ast_input -> compiler: "compile()"
compiler -> bytecode_gen.step1: "emit"
bytecode_gen.step5 -> patching.patch_table: "record slots"
bytecode_gen.step6 -> patching.resolution: "trigger patch"
patching.resolution -> bytecode_output: "resolved"
bytecode_gen.step6 -> bytecode_output: "finalize"
# Loop visualization
bytecode_output.5 -> bytecode_output.2: loop {
  style.stroke: "#E91E63"
  style.stroke-dash: 3
}