direction: right
vars: {
  d2-config: {
    layout-engine: elk
  }
}
title: {
  label: WHERE Clause Bytecode Pattern
  shape: text
  near: top-center
  style.font-size: 24
  style.bold: true
}
subtitle: {
  label: Bytecode sequence for "WHERE age > 18" showing inverted comparison logic
  shape: text
  near: top-center
  style.font-size: 14
  style.italic: true
}
# Instruction boxes
instr_0: {
  label: "0: Column\n\nP1: cursor(0)\nP2: reg[1]\nP3: col_idx(2)\n\n→ reg[1] = age"
  shape: class
  style.fill: "#E3F2FD"
  style.stroke: "#1976D2"
}
instr_1: {
  label: "1: Integer\n\nP1: 18\nP2: reg[2]\n\n→ reg[2] = 18"
  shape: class
  style.fill: "#E3F2FD"
  style.stroke: "#1976D2"
}
instr_2: {
  label: "2: Le (INVERTED)\n\nP1: reg[1]\nP2: reg[2]\nP3: 5 (SKIP)\nP4: INVERT\n\nIF age <= 18\n  JUMP to 5"
  shape: class
  style.fill: "#FFECB3"
  style.stroke: "#FF8F00"
  style.stroke-width: 3
}
instr_3: {
  label: "3: ResultRow\n\nP1: reg[0]\nP2: num_cols\n\n→ OUTPUT ROW"
  shape: class
  style.fill: "#C8E6C9"
  style.stroke: "#388E3C"
}
instr_4: {
  label: "4: Next\n\nP1: cursor(0)\nP2: 0 (loop)\n\n→ advance cursor\n→ goto 0 if more rows"
  shape: class
  style.fill: "#E1BEE7"
  style.stroke: "#7B1FA2"
}
instr_5: {
  label: "5: SKIP\n(Next instruction\nor Halt)"
  shape: class
  style.fill: "#FFCDD2"
  style.stroke: "#D32F2F"
}
# Flow arrows
instr_0 -> instr_1: {
  label: "next"
  style.stroke: "#1976D2"
}
instr_1 -> instr_2: {
  label: "next"
  style.stroke: "#1976D2"
}
instr_2 -> instr_3: {
  label: "age > 18\n(condition PASS)"
  style.stroke: "#388E3C"
  style.bold: true
}
instr_3 -> instr_4: {
  label: "next"
  style.stroke: "#1976D2"
}
instr_4 -> instr_0: {
  label: "more rows"
  style.stroke: "#7B1FA2"
  style.stroke-dash: 3
}
# Jump arrow (the key concept)
instr_2 -> instr_5: {
  label: "age <= 18\n(condition FAIL)"
  style.stroke: "#D32F2F"
  style.bold: true
  style.stroke-dash: 5
}
instr_4 -> instr_5: {
  label: "no more rows"
  style.stroke: "#D32F2F"
}
# Legend
legend: {
  label: |md
    **Key Concept: Inverted Comparison**
    Le with INVERT flag checks if age <= 18
    If TRUE, we SKIP (condition failed)
    If FALSE, we continue (condition passed)
    This is OPPOSITE of normal logic!
  |
  shape: rectangle
  style.fill: "#FAFAFA"
  style.stroke: "#666"
}
legend -> instr_2: {
  style.stroke: "#FF8F00"
  style.stroke-dash: 3
}
# Register visualization
registers: {
  label: "VDBE Registers"
  shape: rectangle
  style.fill: "#F5F5F5"
  style.stroke: "#666"
  reg0: {
    label: "reg[0]\nrowid"
    shape: class
  }
  reg1: {
    label: "reg[1]\nage"
    shape: class
    style.fill: "#E3F2FD"
  }
  reg2: {
    label: "reg[2]\n18"
    shape: class
    style.fill: "#E3F2FD"
  }
}
registers -> instr_2: {
  label: "compares"
  style.stroke: "#999"
  style.stroke-dash: 2
}