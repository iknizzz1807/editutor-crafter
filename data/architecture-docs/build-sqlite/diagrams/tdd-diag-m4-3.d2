direction: down
title: FetchPage Flow: Hit vs Miss
vars: {
  hit-color: "#22c55e"
  miss-color: "#f59e0b"
  decision-color: "#6366f1"
  action-color: "#3b82f6"
  return-color: "#8b5cf6"
}
start: {
  shape: oval
  label: "FetchPage(page_id)"
}
lookup_hash: {
  shape: diamond
  label: "Hash Lookup\npage_table_lookup()"
  style.fill: "${decision-color}"
}
hit_path: {
  label: "CACHE HIT"
  style.stroke: "${hit-color}"
  style.fill: "#dcfce7"
  hit_label: {
    label: "✓ HIT"
    shape: text
    style.font-color: "${hit-color}"
    style.bold: true
  }
  increment_pin: {
    shape: rectangle
    label: "pin_count++"
    style.fill: "${hit-color}"
  }
  update_stats: {
    shape: rectangle
    label: "pool->hits++"
    style.fill: "${action-color}"
  }
  move_lru_hit: {
    shape: rectangle
    label: "Move to LRU Head\n(if pin_count was 0)"
    style.fill: "${action-color}"
  }
}
miss_path: {
  label: "CACHE MISS"
  style.stroke: "${miss-color}"
  style.fill: "#fef3c7"
  miss_label: {
    label: "✗ MISS"
    shape: text
    style.font-color: "${miss-color}"
    style.bold: true
  }
  find_free: {
    shape: diamond
    label: "Find Free Frame?"
    style.fill: "${decision-color}"
  }
  free_found: {
    label: "YES - Free Frame"
    shape: text
    style.font-color: "${hit-color}"
  }
  no_free: {
    label: "NO - Need Eviction"
    shape: text
    style.font-color: "${miss-color}"
  }
  evict_frame: {
    shape: rectangle
    label: "Evict LRU Frame\n• Write if dirty\n• Remove from hash"
    style.fill: "#ef4444"
  }
  disk_read: {
    shape: rectangle
    label: "Disk Read\nfile_manager_read_page()"
    style.fill: "${action-color}"
  }
  init_frame: {
    shape: rectangle
    label: "Init Frame\n• Set page_id\n• pin_count = 1\n• is_dirty = false"
    style.fill: "${action-color}"
  }
  hash_insert: {
    shape: rectangle
    label: "Hash Insert\npage_table_insert()"
    style.fill: "${action-color}"
  }
  move_lru_miss: {
    shape: rectangle
    label: "Add to LRU Head"
    style.fill: "${action-color}"
  }
  update_miss_stats: {
    shape: rectangle
    label: "pool->misses++"
    style.fill: "${action-color}"
  }
}
return_frame: {
  shape: oval
  label: "Return Frame*\n(pinned)"
  style.fill: "${return-color}"
}
return_null: {
  shape: oval
  label: "Return NULL\n(error)"
  style.fill: "#dc2626"
}
start -> lookup_hash: {label: "lookup page_id"}
lookup_hash -> hit_path.hit_label: {
  label: "found"
  style.stroke: "${hit-color}"
}
lookup_hash -> miss_path.miss_label: {
  label: "not found"
  style.stroke: "${miss-color}"
}
hit_path.hit_label -> hit_path.update_stats
hit_path.update_stats -> hit_path.increment_pin
hit_path.increment_pin -> hit_path.move_lru_hit
hit_path.move_lru_hit -> return_frame: {
  style.stroke: "${hit-color}"
  label: "return frame"
}
miss_path.miss_label -> miss_path.find_free
miss_path.find_free -> miss_path.free_found: {label: "yes"}
miss_path.find_free -> miss_path.no_free: {label: "no"}
miss_path.no_free -> miss_path.evict_frame
miss_path.evict_frame -> miss_path.disk_read: {label: "evicted"}
miss_path.free_found -> miss_path.disk_read: {label: "use free"}
miss_path.disk_read -> miss_path.init_frame
miss_path.init_frame -> miss_path.hash_insert
miss_path.hash_insert -> miss_path.move_lru_miss
miss_path.move_lru_miss -> miss_path.update_miss_stats
miss_path.update_miss_stats -> return_frame: {
  style.stroke: "${miss-color}"
  label: "return frame"
}