direction: right
title: LRU List Operations | Buffer Pool Manager (M4)
# Initial State
initial_state: {
  label: "Initial LRU List State"
  head: "HEAD"
  tail: "TAIL"
  frame_1: {
    label: "Frame A\n(page_id: 1)"
    shape: rectangle
  }
  frame_2: {
    label: "Frame B\n(page_id: 5)"
    shape: rectangle
  }
  frame_3: {
    label: "Frame C\n(page_id: 3)"
    shape: rectangle
  }
  frame_4: {
    label: "Frame D\n(page_id: 9)"
    shape: rectangle
  }
  head -> frame_1: "â† prev"
  frame_1 -> frame_2: "next â†’"
  frame_2 -> frame_1: "â† prev"
  frame_2 -> frame_3: "next â†’"
  frame_3 -> frame_2: "â† prev"
  frame_3 -> frame_4: "next â†’"
  frame_4 -> frame_3: "â† prev"
  frame_4 -> tail: "next â†’"
}
# Operation 1: move_to_head
move_to_head_op: {
  label: "OPERATION 1: move_to_head(page_id)"
  step_1_unlink: {
    label: "Step 1: Unlink from current position"
    note: "Remove Frame C from list\nUpdate B.next = D\nUpdate D.prev = B"
  }
  step_2_insert: {
    label: "Step 2: Insert at head"
    note: "Frame C.next = Frame A\nFrame A.prev = Frame C\nHEAD = Frame C"
  }
  result: {
    label: "Result"
    shape: rectangle
    style.fill: "#E8F5E9"
    "HEAD â†’ [C] â†” [A] â†” [B] â†” [D] â†’ TAIL"
  }
  step_1_unlink -> step_2_insert -> result
}
# Operation 2: find_victim
find_victim_op: {
  label: "OPERATION 2: find_victim()"
  scan_process: {
    label: "Scan from tail"
    check_1: "Check Frame D"
    check_2: "Check Frame B"
    check_3: "Check Frame A"
    check_4: "Check Frame C"
    check_1 -> check_2: "pin_count > 0\nSKIP"
    check_2 -> check_3: "pin_count > 0\nSKIP"
    check_3 -> check_4: "pin_count == 0\nRETURN Frame A"
  }
  victim_selection: {
    label: "Victim Selection Logic"
    shape: code
    language: c
    value: ||c
Frame* find_victim() {
  Frame* cur = lru_list.tail;
  while (cur != NULL) {
    if (cur->pin_count == 0) {
      return cur; // Found victim
    }
    cur = cur->lru_prev; // Skip pinned
  }
  return NULL; // All frames pinned
}
||
  }
  state_diagram: {
    label: "Pin States"
    pinned: "PINNED\n(pin_count > 0)"
    unpinned: "UNPINNED\n(pin_count == 0)"
    victim: "VICTIM\n(selected)"
    pinned -> pinned: "still in use"
    pinned -> unpinned: "unpin_page()"
    unpinned -> victim: "find_victim()"
  }
}
# Operation 3: eviction
eviction_op: {
  label: "OPERATION 3: evict_frame(frame)"
  check_dirty: {
    label: "Check Dirty Flag"
    shape: diamond
    style.fill: "#FFF3E0"
  }
  write_if_dirty: {
    label: "write_page_to_disk()\npersist changes"
    shape: rectangle
    style.fill: "#FFCDD2"
  }
  skip_write: {
    label: "Skip write\n(page clean)"
    shape: rectangle
    style.fill: "#C8E6C9"
  }
  unlink_from_list: {
    label: "lru_list_remove(frame)\nUpdate neighbors' pointers"
    shape: rectangle
  }
  remove_from_hash: {
    label: "hash_table_remove(\n  page_id)"
    shape: rectangle
  }
  reset_frame: {
    label: "Reset frame:\n  - page_id = 0\n  - is_dirty = false\n  - pin_count = 0"
    shape: rectangle
    style.fill: "#E3F2FD"
  }
  check_dirty -> write_if_dirty: "is_dirty == true"
  check_dirty -> skip_write: "is_dirty == false"
  write_if_dirty -> unlink_from_list
  skip_write -> unlink_from_list
  unlink_from_list -> remove_from_hash
  remove_from_hash -> reset_frame
}
# Complete Eviction Flow
complete_flow: {
  label: "Complete Eviction Flow"
  start: "Buffer Full\nNeed Free Frame" {
    shape: oval
  }
  find: "find_victim()" {
    shape: rectangle
  }
  decision: "Found?" {
    shape: diamond
  }
  evict: "evict_frame(victim)" {
    shape: rectangle
    style.fill: "#FFEB3B"
  }
  error: "Return\nSQLITE_BUSY" {
    shape: oval
    style.fill: "#F44336"
    style.font-color: white
  }
  done: "Frame Available" {
    shape: oval
    style.fill: "#4CAF50"
    style.font-color: white
  }
  start -> find -> decision
  decision -> evict: "Yes"
  decision -> error: "No (all pinned)"
  evict -> done
}
# Legend
legend: {
  label: "Legend"
  shape: rectangle
  pinned_icon: "ğŸ”´ PINNED (in use, cannot evict)" {
    shape: text
    style.font-color: "#C62828"
  }
  unpinned_icon: "ğŸŸ¢ UNPINNED (available for eviction)" {
    shape: text
    style.font-color: "#2E7D32"
  }
  dirty_icon: "ğŸŸ¡ DIRTY (modified, must write before evict)" {
    shape: text
    style.font-color: "#F9A825"
  }
  clean_icon: "âšª CLEAN (no disk write needed)" {
    shape: text
    style.font-color: "#616161"
  }
}
# Connections between sections
initial_state -> move_to_head_op: "Operation"
move_to_head_op -> find_victim_op: "Operation"
find_victim_op -> eviction_op: "Operation"
eviction_op -> complete_flow: "Integration"
complete_flow -> legend