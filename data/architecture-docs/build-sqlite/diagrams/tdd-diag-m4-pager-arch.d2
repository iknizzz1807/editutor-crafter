direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

pager_subsystem: "Pager Architecture (Buffer Pool Manager)" {
  style: {
    stroke: "#800080"
    stroke-width: 2
  }

  pager_struct: "struct Pager" {
    grid-columns: 3
    grid-gap: 0
    
    # Header: Purple
    off: "Offset" {style.fill: "#800080"; style.font-color: white}
    fld: "Field" {style.fill: "#800080"; style.font-color: white}
    sz: "Size" {style.fill: "#800080"; style.font-color: white}

    # Rows: Blue=Data, Orange=Pointers
    o00: "0x00"; n00: "int fd" {style.fill: "#ADD8E6"}; s00: "4B"
    o04: "0x04"; n04: "uint32_t num_frames" {style.fill: "#ADD8E6"}; s04: "4B"
    o08: "0x08"; n08: "PageDescriptor* frames" {style.fill: "#FFA500"}; s08: "8B"
    o10: "0x10"; n10: "void* buffer_pool_mem" {style.fill: "#FFA500"}; s10: "8B"
    o18: "0x18"; n18: "LRUCache* lru" {style.fill: "#FFA500"}; s18: "8B"
    o20: "0x20"; n20: "HashTable* page_table" {style.fill: "#FFA500"}; s20: "8B"
    o28: "0x28"; n28: "pthread_mutex_t latch" {style.fill: "#ADD8E6"}; s28: "40B"

    # Footer
    pager_size: "sizeof = 80 bytes" {
      grid-column-span: 3
      style.italic: true
      style.stroke-width: 0
    }
  }

  page_descriptor: "struct PageDescriptor (Frame Metadata)" {
    grid-columns: 3
    grid-gap: 0

    # Header: Purple
    doff: "Offset" {style.fill: "#800080"; style.font-color: white}
    dfld: "Field" {style.fill: "#800080"; style.font-color: white}
    dsz: "Size" {style.fill: "#800080"; style.font-color: white}

    # Rows: Green=Free/Pin, Gray=Padding, Orange=Pointers, Blue=Data
    do00: "0x00"; dn00: "uint32_t page_id" {style.fill: "#ADD8E6"}; ds00: "4B"
    do04: "0x04"; dn04: "uint32_t pin_count" {style.fill: "#90EE90"}; ds04: "4B"
    do08: "0x08"; dn08: "bool is_dirty" {style.fill: "#ADD8E6"}; ds08: "1B"
    do09: "0x09"; dn09: "bool is_valid" {style.fill: "#ADD8E6"}; ds09: "1B"
    do0A: "0x0A"; dn0A: "uint8_t _pad[6]" {style.fill: "#D3D3D3"}; ds0A: "6B"
    do10: "0x10"; dn10: "void* data" {style.fill: "#FFA500"}; ds10: "8B"
    do18: "0x18"; dn18: "LRUNode* lru_node" {style.fill: "#FFA500"}; ds18: "8B"

    # Footer
    desc_size: "sizeof = 32 bytes (1/2 cache line)" {
      grid-column-span: 3
      style.italic: true
      style.stroke-width: 0
    }
  }

  buffer_pool: "Buffer Pool (Memory Area)" {
    style.fill: "#f1f3f5"
    frame_0: "Frame 0 (4096B)" {
      style.fill: "#ADD8E6"
      style.stroke-dash: 3
    }
    frame_1: "Frame 1 (4096B)" {
      style.fill: "#ADD8E6"
      style.stroke-dash: 3
    }
    frame_n: "Frame N (4096B)" {
      style.fill: "#ADD8E6"
      style.stroke-dash: 3
    }
  }

  page_table_map: "Page Table (Hash Map)" {
    shape: rectangle
    style.fill: "#FFFACD"
    label: "PageID -> FrameIndex"
  }

  eviction_policy: "LRU List (Doubly Linked)" {
    node_mru: "MRU (Head)" {shape: circle; style.fill: "#90EE90"}
    node_mid: "..." {shape: text}
    node_lru: "LRU (Tail / Victim)" {shape: circle; style.fill: "#FFB6C1"}
    
    node_mru <-> node_mid <-> node_lru: "Pointers" {style.stroke: "#FFA500"}
  }
}

disk_storage: "Disk (.db file)" {
  shape: cylinder
  style.fill: "#D3D3D3"
  page_5: "Page 5"
}

# Relationships
"B-tree Layer" -> pager_subsystem.pager_struct: "pager_fetch_page(id)"
pager_subsystem.pager_struct -> pager_subsystem.page_table_map: "1. Lookup PageID"
pager_subsystem.page_table_map -> pager_subsystem.page_descriptor: "2. Resolve FrameIndex"
pager_subsystem.page_descriptor -> pager_subsystem.buffer_pool.frame_0: "3. Access Buffer"
pager_subsystem.page_descriptor -> pager_subsystem.eviction_policy: "4. Update Recency"

pager_subsystem.pager_struct -> disk_storage: "Page Fault / Flush" {
  style.stroke: "#FF0000"
  style.animated: true
}

# Pointers
pager_subsystem.buffer_pool.frame_0 -> pager_subsystem.page_descriptor.dn10: "Points to" {
  style.stroke: "#FFA500"
  style.stroke-dash: 5
}

notes: |md
  ### Pager Constraints
  - **Pinning**: If `pin_count > 0`, LRU must skip eviction.
  - **Dirty**: If `is_dirty == true`, `pwrite()` must precede repurposing.
  - **Alignment**: `buffer_pool_mem` should be 4KB aligned for Direct I/O.
| {
  near: bottom-center
}