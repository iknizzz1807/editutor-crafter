vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right
title: |md
  # Row Record Format
  ## SQLite B-Tree Leaf Cell Payload Layout
| {near: top-center}
# Memory layout showing byte offsets
layout: {
  grid-columns: 1
  grid-gap: 0
  header_zone: {
    grid-columns: 4
    grid-gap: 0
    style.fill: "#E8EAF6"
    style.stroke: "#3F51B5"
    offset_label: {
      style.fill: "#C5CAE9"
      label: "Offset"
      style.bold: true
    }
    field_label: {
      style.fill: "#C5CAE9"
      label: "Field"
      style.bold: true
    }
    type_label: {
      style.fill: "#C5CAE9"
      label: "Type"
      style.bold: true
    }
    size_label: {
      style.fill: "#C5CAE9"
      label: "Size"
      style.bold: true
    }
    row0_offset: {label: "0"; style.fill: "#E8EAF6"}
    row0_field: {label: "header_size"; style.fill: "#E8EAF6"}
    row0_type: {label: "varint"; style.fill: "#E8EAF6"}
    row0_size: {label: "1-9 bytes"; style.fill: "#E8EAF6"}
    row1_offset: {label: "1"; style.fill: "#E8EAF6"}
    row1_field: {label: "serial_type[0]"; style.fill: "#E8EAF6"}
    row1_type: {label: "varint"; style.fill: "#E8EAF6"}
    row1_size: {label: "1-9 bytes"; style.fill: "#E8EAF6"}
    row2_offset: {label: "N"; style.fill: "#E8EAF6"}
    row2_field: {label: "serial_type[n]"; style.fill: "#E8EAF6"}
    row2_type: {label: "varint"; style.fill: "#E8EAF6"}
    row2_size: {label: "1-9 bytes"; style.fill: "#E8EAF6"}
  }
  data_zone: {
    grid-columns: 4
    grid-gap: 0
    style.fill: "#E8F5E9"
    style.stroke: "#388E3C"
    data_offset_label: {
      style.fill: "#C8E6C9"
      label: "Offset"
      style.bold: true
    }
    data_field_label: {
      style.fill: "#C8E6C9"
      label: "Field"
      style.bold: true
    }
    data_type_label: {
      style.fill: "#C8E6C9"
      label: "Type"
      style.bold: true
    }
    data_size_label: {
      style.fill: "#C8E6C9"
      label: "Size"
      style.bold: true
    }
    drow0_offset: {label: "header_size"; style.fill: "#E8F5E9"}
    drow0_field: {label: "column[0]"; style.fill: "#E8F5E9"}
    drow0_type: {label: "per serial"; style.fill: "#E8F5E9"}
    drow0_size: {label: "variable"; style.fill: "#E8F5E9"}
    drow1_offset: {label: "offset[1]"; style.fill: "#E8F5E9"}
    drow1_field: {label: "column[1]"; style.fill: "#E8F5E9"}
    drow1_type: {label: "per serial"; style.fill: "#E8F5E9"}
    drow1_size: {label: "variable"; style.fill: "#E8F5E9"}
    drow2_offset: {label: "offset[n]"; style.fill: "#E8F5E9"}
    drow2_field: {label: "column[n]"; style.fill: "#E8F5E9"}
    drow2_type: {label: "per serial"; style.fill: "#E8F5E9"}
    drow2_size: {label: "variable"; style.fill: "#E8F5E9"}
  }
}
header_zone_label: {
  label: "HEADER ZONE\n(Purple)"
  shape: text
  style.fill: "#7986CB"
  style.font-color: white
  style.bold: true
}
data_zone_label: {
  label: "DATA ZONE\n(Green)"
  shape: text
  style.fill: "#66BB6A"
  style.font-color: white
  style.bold: true
}
header_zone_label -> data_zone_label: {
  label: "sequential\nlayout"
  style.stroke-dash: 3
  style.stroke: "#455A64"
}
example: {
  label: "EXAMPLE: Row (42, 'Alice', 30)"
  style.fill: "#FFF3E0"
  style.stroke: "#E65100"
  sql: |md
    sql
    INSERT INTO users VALUES (42, 'Alice', 30)
  |
  bytes: {
    grid-columns: 8
    grid-gap: 2
    style.fill: "#FFE0B2"
    b0: {label: "0x06"; style.fill: "#FFCC80"; width: 60}
    b1: {label: "0x01"; style.fill: "#FFCC80"; width: 60}
    b2: {label: "0x0D"; style.fill: "#FFCC80"; width: 60}
    b3: {label: "0x01"; style.fill: "#FFCC80"; width: 60}
    b4: {label: "0x2A"; style.fill: "#A5D6A7"; width: 60}
    b5_9: {label: "Alice"; style.fill: "#A5D6A7"; width: 80}
    b10: {label: "0x1E"; style.fill: "#A5D6A7"; width: 60}
    l0: {label: "hdr"; style.fill: "transparent"; style.font-size: 10}
    l1: {label: "s0"; style.fill: "transparent"; style.font-size: 10}
    l2: {label: "s1"; style.fill: "transparent"; style.font-size: 10}
    l3: {label: "s2"; style.fill: "transparent"; style.font-size: 10}
    l4: {label: "col0"; style.fill: "transparent"; style.font-size: 10}
    l5: {label: "col1"; style.fill: "transparent"; style.font-size: 10}
    l6: {label: "col2"; style.fill: "transparent"; style.font-size: 10}
  }
}
breakdown: ||md
  | byte_offset | hex | meaning | size |
  |-------------|-----|---------|------|
  | 0 | 0x06 | header_size = 6 bytes | 1 |
  | 1 | 0x01 | serial_type[0] = 1 (INT8) | 1 |
  | 2 | 0x0D | serial_type[1] = 13 (TEXT, len=5) | 1 |
  | 3 | 0x01 | serial_type[2] = 1 (INT8) | 1 |
  | 4 | 0x2A | column[0] = 42 (0x2A) | 1 |
  | 5-9 | Alice | column[1] = 'Alice' UTF-8 | 5 |
  | 10 | 0x1E | column[2] = 30 (0x1E) | 1 |
||
serial_ref: ||md
  | type_code | datatype | size_formula |
  |-----------|----------|--------------|
  | 0 | NULL | 0 bytes |
  | 1 | INT8 | 1 byte |
  | 2 | INT16 | 2 bytes |
  | 3 | INT24 | 3 bytes |
  | 4 | INT32 | 4 bytes |
  | 5 | INT48 | 6 bytes |
  | 6 | INT64 | 8 bytes |
  | 7 | FLOAT64 | 8 bytes |
  | 8 | CONST 0 | 0 bytes |
  | 9 | CONST 1 | 0 bytes |
  | 12+ | BLOB | (N-12)/2 bytes |
  | 13+ | TEXT | (N-13)/2 bytes |
||
calculation: {
  style.fill: "#E0F7FA"
  style.stroke: "#006064"
  label: "SIZE CALCULATION"
  calc: |md
    **Total Record Size = 11 bytes**
    **Header Zone (4 bytes):**
    - header_size: 1 byte (value 6)
    - serial_type[0]: 1 byte (value 1 → INT8)
    - serial_type[1]: 1 byte (value 13 → TEXT len=5)
    - serial_type[2]: 1 byte (value 1 → INT8)
    **Data Zone (7 bytes):**
    - column[0]: 1 byte (42 as INT8)
    - column[1]: 5 bytes ('Alice' UTF-8)
    - column[2]: 1 byte (30 as INT8)
  |
}
legend: {
  style.fill: "#FAFAFA"
  style.stroke: "#9E9E9E"
  note1: |md
    - **Varint**: 1-9 bytes, MSB continuation bit
    - **Serial Type**: Encodes datatype & size
    - **Growth**: Header → Data (left to right)
  |
}
layout -> example: {
  style.stroke-dash: 3
  style.stroke: "#BDBDBD"
}
example -> breakdown: {
  style.stroke-dash: 3
  style.stroke: "#BDBDBD"
}
breakdown -> serial_ref: {
  style.stroke-dash: 3
  style.stroke: "#BDBDBD"
}
serial_ref -> calculation: {
  style.stroke-dash: 3
  style.stroke: "#BDBDBD"
}
calculation -> legend: {
  style.stroke-dash: 3
  style.stroke: "#BDBDBD"
}