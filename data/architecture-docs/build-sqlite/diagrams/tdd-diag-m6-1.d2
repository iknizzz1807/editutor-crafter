direction: right
title: Cursor-Based Table Scan
# Main cursor states
INIT: {
  label: "INIT\n(Cursor Created)"
}
POSITIONING: {
  label: "POSITIONING\n(Navigate to First Row)"
}
READY: {
  label: "READY\n(Positioned on Row)"
}
FETCHING: {
  label: "FETCHING\n(Get Current Row)"
}
ADVANCING: {
  label: "ADVANCING\n(Move to Next)"
}
EOF_STATE: {
  style.fill: "#FFE4E1"
  label: "EOF\n(Scan Complete)"
}
# State transitions
INIT -> POSITIONING: {
  label: "cursor_first()\nRewind opcode"
}
POSITIONING -> READY: {
  label: "Found leftmost\nleaf cell"
}
POSITIONING -> EOF_STATE: {
  label: "Empty table\nNo root entries"
  style.stroke-dash: 3
}
READY -> FETCHING: {
  label: "cursor_get_row()\nColumn opcode"
}
FETCHING -> READY: {
  label: "Return row data\n(processing)"
}
READY -> ADVANCING: {
  label: "cursor_next()\nNext opcode"
}
ADVANCING -> READY: {
  label: "More rows?\n✓ Yes"
}
ADVANCING -> EOF_STATE: {
  label: "More rows?\n✗ No"
  style.stroke-dash: 3
}
# B-tree page traversal detail
BTREE_TRAVERSAL: {
  label: "B-tree Page Traversal"
  ROOT_PAGE: {
    label: "Root Page\n(Page 1)"
  }
  INTERIOR_PAGE: {
    label: "Interior Page\n(Child Ptrs)"
  }
  LEAF_PAGE: {
    label: "Leaf Page\n(Row Data)"
  }
  CELL_1: {
    shape: diamond
    label: "Cell 1"
  }
  CELL_2: {
    shape: diamond
    label: "Cell 2"
  }
  CELL_N: {
    shape: diamond
    label: "Cell N"
  }
  ROOT_PAGE -> INTERIOR_PAGE: {
    label: "Follow leftmost\nchild pointer"
  }
  INTERIOR_PAGE -> LEAF_PAGE: {
    label: "Descend to\nleftmost leaf"
  }
  LEAF_PAGE -> CELL_1
  CELL_1 -> CELL_2: {label: "next"}
  CELL_2 -> CELL_N: {label: "...next"}
}
# Cursor data structure
CURSOR_STRUCT: {
  label: "Cursor Structure"
  cursor: {
    shape: class
    page_id: u32
    current_page: "*Page"
    current_cell: u16
    eof: bool
    row_id: i64
  }
}
# Positioning connects to B-tree
POSITIONING -> BTREE_TRAVERSAL.ROOT_PAGE: {
  style.stroke: "#4A90D9"
  style.stroke-dash: 5
  label: "Traverse"
}
# EOF terminal
EOF_TERMINAL: {
  shape: circle
  label: "●"
}
EOF_STATE -> EOF_TERMINAL: {
  label: "Close\nCursor"
}