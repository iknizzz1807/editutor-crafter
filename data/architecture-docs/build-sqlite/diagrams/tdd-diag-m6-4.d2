direction: right
shape: sequence_diagram
vdb: VDBE
registers: Register File
cursor_0: Cursor 0
# Instruction 0: OpenWrite
instr_0: "OpenWrite P1=0, P2='users', P3=0" {
    shape: text
    style.font: mono
    style.bold: true
}
vdb -> cursor_0: Open cursor 0 on table 'users' for writing
# Instruction 1-3: Load values into registers
instr_1: "Integer P1=42, P2=R1" {
    shape: text
    style.font: mono
    style.bold: true
}
vdb -> registers: R1 ← 42 (id value)
instr_2: "String8 P1='Alice', P2=R2" {
    shape: text
    style.font: mono
    style.bold: true
}
vdb -> registers: R2 ← 'Alice' (name value)
instr_3: "Integer P1=30, P2=R3" {
    shape: text
    style.font: mono
    style.bold: true
}
vdb -> registers: R3 ← 30 (age value)
# Register state box
reg_state: {
    shape: class
    style.fill: "#E8F4FD"
    R0: "R0: (unused)"
    R1: "R1: 42 (INTEGER)"
    R2: "R2: 'Alice' (TEXT)"
    R3: "R3: 30 (INTEGER)"
    R4: "R4: (reserved)"
    R5: "R5: (reserved)"
}
# Instruction 4: MakeRecord
instr_4: "MakeRecord P1=R1, P2=3, P3=R4" {
    shape: text
    style.font: mono
    style.bold: true
}
vdb -> registers: Build record from R1..R3 → R4
make_record_detail: {
    shape: rectangle
    style.fill: "#FFF3E0"
    record_layout: "Record Format: [header-size|type1|type2|type3|val1|val2|val3]"
    type_codes: "Type Codes: 1(INT), 14(TEXT-5), 1(INT)"
    payload: "Payload: 42 | 'Alice' | 30"
}
# Instruction 5: NewRowid
instr_5: "NewRowid P1=0, P2=R5" {
    shape: text
    style.font: mono
    style.bold: true
}
vdb -> cursor_0: Find next available rowid
cursor_0 -> vdb: Return rowid = 1
vdb -> registers: R5 ← 1 (new rowid)
# Instruction 6: Insert
instr_6: "Insert P1=0, P2=R4, P3=R5" {
    shape: text
    style.font: mono
    style.bold: true
}
vdb -> cursor_0: Seek to rowid R5=1
vdb -> cursor_0: Write record R4 to leaf page
cursor_0 -> cursor_0: Update B-tree structure
insert_flow: {
    shape: rectangle
    style.fill: "#FFF8E1"
    step1: "1. Record in R4"
    step2: "2. Seek cursor to rowid=1"
    step3: "3. Write to leaf page"
    step4: "4. Balance B-tree if needed"
    step5: "5. Insert complete"
}
# Instruction 7: Close
instr_7: "Close P1=0" {
    shape: text
    style.font: mono
    style.bold: true
}
vdb -> cursor_0: Release cursor 0
cursor_0 -> vdb: Cursor destroyed
# Instruction 8: Halt
instr_8: "Halt P1=0, P2=0" {
    shape: text
    style.font: mono
    style.bold: true
}
vdb -> vdb: Stop execution, return SQLITE_OK
# Final register summary
final_state: {
    shape: class
    style.fill: "#E8F8E8"
    R0: "R0: (unused)"
    R1: "R1: 42"
    R2: "R2: 'Alice'"
    R3: "R3: 30"
    R4: "R4: [serialized record]"
    R5: "R5: 1 (rowid)"
}
# SQL context
sql_source: {
    shape: rectangle
    style.fill: "#F5F5F5"
    style.stroke: "#999"
    label: "SQL: INSERT INTO users (id, name, age) VALUES (42, 'Alice', 30)"
}
# Legend
legend: {
    shape: rectangle
    style.fill: "#FAFAFA"
    title: "Register Usage Legend" {
        style.bold: true
    }
    p1: "P1 = Source value / cursor ID"
    p2: "P2 = Destination register / rowid reg"
    p3: "P3 = Record register / start column"
    r1_desc: "R1-R3: Column values"
    r4_desc: "R4: Serialized record"
    r5_desc: "R5: Generated rowid"
}
# Flow arrows
sql_source -> instr_0: "Compile"
instr_0 -> instr_1 -> instr_2 -> instr_3 -> instr_4 -> instr_5 -> instr_6 -> instr_7 -> instr_8