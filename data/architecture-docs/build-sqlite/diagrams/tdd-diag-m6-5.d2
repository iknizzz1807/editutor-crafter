direction: right
title: DELETE Two-Pass Algorithm {
  shape: text
  style: {
    font-size: 28
    bold: true
    underline: true
  }
}
problem_section: {
  label: Why Single-Pass Fails
  cursor_state: {
    shape: sequence_diagram
    label: Cursor Corruption Scenario
    api_call: {
      style.stroke-dash: 3
    }
    iter_1: "cursor_next() -> rowid=5"
    delete_1: "btree_delete(rowid=5)"
    iter_2: "cursor_next() -> GARBAGE"
    note_1: "Cursor position invalidated!\nB-tree structure changed"
  }
  problem_explain: {
    shape: class
    style.multiple: true
    label: Problem
    p1: "Deleting row shifts subsequent rows"
    p2: "Cursor's internal position becomes stale"
    p3: "May skip rows or visit deleted memory"
  }
}
pass1: {
  label: Pass 1: Collect Rowids
  pass1_desc: {
    shape: text
    label: "Scan table WITHOUT modifying\nCollect matching rowids into temp array"
    style.font-size: 14
  }
  table_before: {
    label: "users table (B-tree)"
    shape: class
    style.multiple: true
    row1: "rowid=1 | name='Alice'"
    row2: "rowid=3 | name='Bob'"
    row3: "rowid=5 | name='Charlie'"
    row4: "rowid=7 | name='Diana'"
    row5: "rowid=9 | name='Eve'"
  }
  where_clause: {
    shape: text
    label: "WHERE age > 30"
    style.italic: true
  }
  temp_array: {
    label: "temp_rowids[]"
    shape: class
    style.fill: "#E8F5E9"
    slot0: "[0] -> 5"
    slot1: "[1] -> 7"
    slot2: "[2] -> 9"
  }
  cursor_icon: {
    shape: text
    label: "cursor scans\n   READ-ONLY"
    style.font-size: 12
  }
}
pass2: {
  label: Pass 2: Delete by Rowid
  pass2_desc: {
    shape: text
    label: "Iterate collected rowids\nDelete each by direct rowid lookup"
    style.font-size: 14
  }
  delete_loop: {
    label: "Deletion Loop"
    shape: sequence_diagram
    d1: "i=0: btree_delete(rowid=5)"
    d2: "i=1: btree_delete(rowid=7)"
    d3: "i=2: btree_delete(rowid=9)"
    done: "Complete"
  }
  table_after: {
    label: "users table (after)"
    shape: class
    style.multiple: true
    style.fill: "#FFF3E0"
    row1: "rowid=1 | name='Alice'"
    row2: "rowid=3 | name='Bob'"
    empty1: "(rowid 5 deleted)"
    empty2: "(rowid 7 deleted)"
    empty3: "(rowid 9 deleted)"
  }
  optimization: {
    shape: text
    label: "Optimization: Delete in\nreverse order (9,7,5) to\nminimize B-tree disruption"
    style.font-size: 11
    style.italic: true
  }
}
algorithm: |python
  # DELETE FROM users WHERE age > 30
  # Pass 1: Collect rowids (read-only scan)
  temp_rowids = []
  cursor = btree_cursor_open(table)
  while cursor_valid(cursor):
      row = cursor_get_row(cursor)
      if evaluate_where_clause(row):  # age > 30
          temp_rowids.append(cursor.rowid)
      cursor_next(cursor)
  cursor_close(cursor)
  # Pass 2: Delete collected rowids
  for rowid in temp_rowids:  # or reversed(temp_rowids)
      btree_delete_by_rowid(table, rowid)
|
benefits: {
  label: Benefits
  shape: class
  style.fill: "#E3F2FD"
  style.multiple: true
  b1: "Cursor never sees modified B-tree"
  b2: "No rows skipped or double-visited"
  b3: "Idempotent for crash recovery"
  b4: "Deterministic deletion order"
}
problem_section.cursor_state -> pass1: "Solution:\nTwo-Pass Approach" {
  style.stroke: "#4CAF50"
  style.stroke-width: 3
}
pass1.table_before -> pass1.temp_array: "collect" {
  style.stroke-dash: 3
  label: "rowids matching\nWHERE clause"
}
pass1.temp_array -> pass2.delete_loop: "iterate array" {
  style.stroke: "#2196F3"
  style.stroke-width: 2
}
pass2 -> benefits: "guarantees" {
  style.stroke: "#9C27B0"
  style.stroke-dash: 3
}
pass1.cursor_icon -> pass1.table_before {
  style.stroke: "#FF9800"
  style.stroke-dash: 2
}