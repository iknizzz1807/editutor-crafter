direction: right
title: Index Maintenance on DML | tdd-diag-m7-4
# INSERT Flow
insert_flow: {
  label: "INSERT Flow"
  shape: sequence_diagram
  start: {
    shape: circle
    label: "BEGIN"
  }
  insert_table: {
    label: "INSERT INTO\nTable B-tree"
    shape: rectangle
  }
  table_success: {
    label: "Row inserted\nrowid assigned"
    shape: diamond
  }
  insert_loop: {
    label: "For each\nindex on table"
    shape: rectangle
  }
  build_key: {
    label: "Build index key\nfrom row values"
    shape: rectangle
  }
  check_unique: {
    label: "UNIQUE\nconstraint?"
    shape: diamond
  }
  unique_fail: {
    label: "Return\nSQLITE_CONSTRAINT"
    shape: rectangle
    style.fill: "#ffcccc"
  }
  insert_index: {
    label: "INSERT into\nIndex B-tree\n(key, rowid)"
    shape: rectangle
  }
  insert_done: {
    label: "All indexes\nupdated"
    shape: oval
  }
  start -> insert_table -> table_success
  table_success -> insert_loop: "success"
  table_success -> unique_fail: "fail"
  insert_loop -> build_key -> check_unique
  check_unique -> insert_index: "pass / not unique"
  check_unique -> unique_fail: "violation"
  insert_index -> insert_done
}
# DELETE Flow
delete_flow: {
  label: "DELETE Flow"
  shape: sequence_diagram
  start_del: {
    shape: circle
    label: "BEGIN"
  }
  read_row: {
    label: "READ row data\nfrom cursor"
    shape: rectangle
  }
  delete_loop: {
    label: "For each\nindex on table"
    shape: rectangle
  }
  extract_key: {
    label: "Extract index key\nfrom row data"
    shape: rectangle
  }
  delete_index: {
    label: "DELETE from\nIndex B-tree\n(key, rowid)"
    shape: rectangle
  }
  delete_table: {
    label: "DELETE from\nTable B-tree"
    shape: rectangle
  }
  delete_done: {
    label: "Row fully\nremoved"
    shape: oval
  }
  start_del -> read_row -> delete_loop
  delete_loop -> extract_key -> delete_index -> delete_table -> delete_done
}
# UPDATE Flow
update_flow: {
  label: "UPDATE Flow"
  shape: sequence_diagram
  start_upd: {
    shape: circle
    label: "BEGIN"
  }
  read_old: {
    label: "READ old row\nvalues"
    shape: rectangle
  }
  detect_change: {
    label: "Detect changed\ncolumns"
    shape: rectangle
  }
  affected_check: {
    label: "Any indexed\ncolumn changed?"
    shape: diamond
  }
  no_index_maint: {
    label: "Skip index\nmaintenance"
    shape: rectangle
    style.fill: "#e0e0e0"
  }
  affected_loop: {
    label: "For each\naffected index"
    shape: rectangle
  }
  delete_old: {
    label: "DELETE old entry\n(old_key, rowid)"
    shape: rectangle
    style.fill: "#ffe0e0"
  }
  build_new: {
    label: "Build new key\nfrom updated values"
    shape: rectangle
  }
  check_upd_unique: {
    label: "UNIQUE\ncheck"
    shape: diamond
  }
  upd_unique_fail: {
    label: "Return\nSQLITE_CONSTRAINT"
    shape: rectangle
    style.fill: "#ffcccc"
  }
  insert_new: {
    label: "INSERT new entry\n(new_key, rowid)"
    shape: rectangle
    style.fill: "#e0ffe0"
  }
  update_table: {
    label: "UPDATE\nTable B-tree"
    shape: rectangle
  }
  update_done: {
    label: "Row & indexes\nupdated"
    shape: oval
  }
  start_upd -> read_old -> detect_change -> affected_check
  affected_check -> affected_loop: "yes"
  affected_check -> no_index_maint: "no"
  no_index_maint -> update_table -> update_done
  affected_loop -> delete_old -> build_new -> check_upd_unique
  check_upd_unique -> insert_new: "pass"
  check_upd_unique -> upd_unique_fail: "violation"
  insert_new -> update_table
}
# Legend
legend: {
  label: "Legend"
  idx_entry: {
    label: "Index Entry: (key_columns, rowid)"
    shape: text
  }
  order_note: {
    label: "Order matters:\n• DELETE: indexes first, then table\n• INSERT: table first, then indexes\n• UPDATE: delete old, insert new per index"
    shape: text
  }
  constraint_note: {
    label: "UNIQUE constraints\nchecked at index level"
    shape: text
    style.fill: "#fff3cd"
  }
}
insert_flow -> delete_flow -> update_flow -> legend