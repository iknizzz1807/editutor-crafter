direction: right
title: COMMIT Write Ordering
# Actors
Client: {
  shape: circle
  label: "Client"
}
TransactionManager: {
  shape: rectangle
  label: "Transaction\nManager"
}
JournalFile: {
  shape: cylinder
  label: "Journal\nFile"
}
DatabaseFile: {
  shape: cylinder
  label: "Database\nFile"
}
FileSystem: {
  shape: diamond
  label: "FileSystem\n(fsync)"
}
# Phase 1: Journal Write & Sync
Client -> TransactionManager: "commit()"
TransactionManager -> JournalFile: "1. write journal pages\n   (original page data)"
JournalFile -> TransactionManager: "pages written"
TransactionManager -> FileSystem: "2. fsync(journal)"
FileSystem -> TransactionManager: "✓ journal persisted"
# Crash Point 1
crash_point_1: {
  shape: diamond
  label: "CRASH\nPOINT 1"
  style.fill: "#FFE5E5"
}
TransactionManager -> crash_point_1: {
  style.stroke-dash: 3
  style.stroke: "#CC0000"
}
recovery_1: {
  shape: rectangle
  label: "Recovery: Transaction not committed\nJournal incomplete → ignored\nDatabase unchanged → safe"
  style.fill: "#E5FFE5"
}
crash_point_1 -> recovery_1: {
  style.stroke-dash: 3
  style.stroke: "#00AA00"
}
# Phase 2: Database Write
TransactionManager -> DatabaseFile: "3. write database pages\n   (modified data)"
DatabaseFile -> TransactionManager: "pages written"
# Crash Point 2
crash_point_2: {
  shape: diamond
  label: "CRASH\nPOINT 2"
  style.fill: "#FFE5E5"
}
TransactionManager -> crash_point_2: {
  style.stroke-dash: 3
  style.stroke: "#CC0000"
}
recovery_2: {
  shape: rectangle
  label: "Recovery: Hot journal exists\nRollback restores original pages\nTransaction rolled back"
  style.fill: "#E5FFE5"
}
crash_point_2 -> recovery_2: {
  style.stroke-dash: 3
  style.stroke: "#00AA00"
}
# Phase 3: Database Sync
TransactionManager -> FileSystem: "4. fsync(database)"
FileSystem -> TransactionManager: "✓ database persisted"
# Crash Point 3
crash_point_3: {
  shape: diamond
  label: "CRASH\nPOINT 3"
  style.fill: "#FFE5E5"
}
TransactionManager -> crash_point_3: {
  style.stroke-dash: 3
  style.stroke: "#CC0000"
}
recovery_3: {
  shape: rectangle
  label: "Recovery: Hot journal exists\nPartial db writes possible\nRollback restores original pages\nTransaction rolled back"
  style.fill: "#E5FFE5"
}
crash_point_3 -> recovery_3: {
  style.stroke-dash: 3
  style.stroke: "#00AA00"
}
# Phase 4: Journal Deletion (Commit Point)
TransactionManager -> JournalFile: "5. delete journal"
JournalFile -> TransactionManager: "journal removed"
TransactionManager -> Client: "✓ COMMIT COMPLETE"
# Crash Point 4
crash_point_4: {
  shape: diamond
  label: "CRASH\nPOINT 4"
  style.fill: "#E5FFE5"
}
TransactionManager -> crash_point_4: {
  style.stroke-dash: 3
  style.stroke: "#00AA00"
}
recovery_4: {
  shape: rectangle
  label: "Recovery: No journal found\nDatabase already persisted\nTransaction committed ✓"
  style.fill: "#E5FFE5"
}
crash_point_4 -> recovery_4: {
  style.stroke-dash: 3
  style.stroke: "#00AA00"
}
# Legend
legend: {
  label: "Legend"
  shape: rectangle
  safe: {
    label: "✓ Green = Safe\n(Transaction not committed)"
    style.fill: "#E5FFE5"
  }
  danger: {
    label: "✗ Red = Danger zone\n(Journal enables recovery)"
    style.fill: "#FFE5E5"
  }
  commit_point: {
    label: "★ Journal delete = Commit point\n(No recovery possible/necessary)"
    style.fill: "#E5E5FF"
  }
}
# Write ordering constraint annotation
write_ordering_constraint: {
  label: "CRITICAL: fsync(journal) MUST complete\nBEFORE any database writes begin"
  shape: rectangle
  style.fill: "#FFFFCC"
  style.stroke: "#CC9900"
  style.stroke-width: 2
}
write_ordering_constraint -> FileSystem: {
  style.stroke: "#CC9900"
  style.stroke-width: 2
}