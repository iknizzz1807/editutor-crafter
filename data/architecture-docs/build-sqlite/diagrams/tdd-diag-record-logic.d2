RecordSerialization: {
  style: {
    stroke: "#2b2b2b"
    fill: "#f3f4f6"
    stroke-width: 2
  }

  RecordDescriptor: {
    shape: class
    header_len: uint32_t
    payload_len: uint32_t
    p_header: "uint8_t*"
    p_payload: "uint8_t*"
    num_columns: uint16_t

    record_pack(Mem *aReg, uint32_t nReg): int
    record_unpack_column(uint8_t *data, uint32_t idx): Mem
  }

  ColumnDef: {
    shape: class
    name: "char*"
    affinity: uint8_t
    is_pk: uint8_t
    not_null: uint8_t
    default_reg: uint32_t
  }

  VarintCodec: {
    shape: rectangle
    style: {
      fill: "#e0f2fe"
      stroke: "#0369a1"
    }
    encode_varint(uint64_t): int
    decode_varint(uint8_t*): uint64_t
  }

  RecordFormat: {
    grid-columns: 1
    style.fill: "#ffffff"
    
    Header: {
      style.fill: "#dcfce7"
      grid-columns: 4
      HeaderLen: "Varint: Header Size"
      Type1: "Serial Type 1"
      Type2: "Serial Type 2"
      TypeN: "Serial Type N"
    }

    Payload: {
      style.fill: "#fef3c7"
      grid-columns: 3
      Data1: "Data Field 1"
      Data2: "Data Field 2"
      DataN: "Data Field N"
    }
  }

  # Relationships
  RecordDescriptor -> VarintCodec: uses
  RecordDescriptor -> RecordFormat: maps to
  ColumnDef -> RecordDescriptor: defines schema for

  RecordFormat.Header.Type1 -> RecordFormat.Payload.Data1: "Determines length/type" {
    style.stroke-dash: 5
  }
  RecordFormat.Header.Type2 -> RecordFormat.Payload.Data2: "Determines length/type" {
    style.stroke-dash: 5
  }
}

VDBE: {
  Registers: {
    shape: class
    Mem_1: "Integer"
    Mem_2: "String"
    Mem_3: "Null"
  }
}

BTree: {
  Cell: {
    shape: cylinder
    label: "B-Tree Leaf Cell"
  }
}

# Cross-module interaction
VDBE.Registers -> RecordSerialization.RecordDescriptor: "Input for packing"
RecordSerialization.RecordDescriptor -> BTree.Cell: "Writes serialized bytes"
BTree.Cell -> RecordSerialization.RecordDescriptor: "Reads for unpacking"

# External Link
RecordSerialization.link: "https://sqlite.org/fileformat.html#record_format"

# Styles
***.style.font-size: 14
RecordSerialization.RecordDescriptor.style.fill: "#eff6ff"
RecordSerialization.ColumnDef.style.fill: "#eff6ff"