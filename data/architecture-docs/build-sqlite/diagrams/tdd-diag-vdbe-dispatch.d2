direction: right

vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
  }
}

classes: {
  struct: {
    shape: class
    style: {
      fill: "#f8f9fa"
      stroke: "#212529"
      stroke-width: 2
    }
  }
  logic_block: {
    style: {
      fill: "#e7f5ff"
      stroke: "#1971c2"
      border-radius: 8
    }
  }
  opcode: {
    shape: parallelogram
    style: {
      fill: "#fff4e6"
      stroke: "#fd7e14"
    }
  }
}

VDBE_Module: {
  label: "Virtual Database Engine (VDBE) Core"
  
  Data_Structures: {
    Vdbe: {
      class: struct
      pProg: "*VDBE_Program"
      aReg: "*Mem[] (Registers)"
      apCsr: "**VdbeCursor[]"
      pc: "int32 (Program Counter)"
      nResColumn: "uint16"
      errorMask: "uint8"
      
      step(): "int (ResultCode)"
      halt(): "void"
      rewindCursor(idx: int): "void"
    }

    VDBE_Program: {
      class: struct
      aOp: "VDBE_Op[]"
      nOp: "uint32"
      nMem: "uint32 (Reg Count)"
      nCursor: "uint32"
    }

    VDBE_Op: {
      class: struct
      opcode: "uint8"
      p1: "int32"
      p2: "int32"
      p3: "int32"
      p4: "void*"
      p5: "uint16"
    }

    Mem: {
      class: struct
      u: "union (i64, double, *char)"
      flags: "uint16 (MEM_Int|MEM_Str|...)"
      n: "int (String Length)"
      enc: "uint8 (Encoding)"
    }

    VdbeCursor: {
      class: struct
      pCursor: "*BtCursor"
      eState: "uint8 (VALID|INVALID|EOF)"
      iPage: "int32"
      nField: "uint16"
      aType: "uint32[] (Serial Types)"
    }
  }

  Execution_Engine: {
    label: "Instruction Dispatcher"
    
    Dispatch_Loop: {
      class: logic_block
      label: "Main Step Loop\n(Computed Gotos)"
      
      Fetch: "Fetch Opcode at PC"
      Decode: "Extract P1, P2, P3 operands"
      Jump: "Jump to Opcode Handler"
      
      Fetch -> Decode -> Jump
    }

    Handlers: {
      OP_Init: {
        class: opcode
        label: "OP_Init\nStart Program"
      }
      OP_OpenRead: {
        class: opcode
        label: "OP_OpenRead\nOpen B-Tree Cursor"
      }
      OP_Column: {
        class: opcode
        label: "OP_Column\nExtract Row Field"
      }
      OP_Next: {
        class: opcode
        label: "OP_Next\nAdvance Cursor"
      }
      OP_Halt: {
        class: opcode
        label: "OP_Halt\nExit VM"
      }
    }
  }
}

# Internal Connections
VDBE_Module.Data_Structures.Vdbe.pProg -> VDBE_Module.Data_Structures.VDBE_Program: "points to"
VDBE_Module.Data_Structures.VDBE_Program.aOp -> VDBE_Module.Data_Structures.VDBE_Op: "contains"
VDBE_Module.Data_Structures.Vdbe.aReg -> VDBE_Module.Data_Structures.Mem: "manages"
VDBE_Module.Data_Structures.Vdbe.apCsr -> VDBE_Module.Data_Structures.VdbeCursor: "tracks"

VDBE_Module.Execution_Engine.Dispatch_Loop.Jump -> VDBE_Module.Execution_Engine.Handlers: "Dispatch"
VDBE_Module.Execution_Engine.Handlers.OP_Column -> VDBE_Module.Data_Structures.Mem: "write to"
VDBE_Module.Execution_Engine.Handlers.OP_OpenRead -> VDBE_Module.Data_Structures.VdbeCursor: "initialize"

# External Module Links
VDBE_Module.Execution_Engine.Handlers.OP_OpenRead -> BTree_Module: "btree_cursor_open()" {
  link: "layers.storage"
}
VDBE_Module.Execution_Engine.Handlers.OP_Column -> Serialization_Module: "record_unpack()" {
  link: "layers.serialization"
}
VDBE_Module.Execution_Engine.Handlers.OP_Next -> BTree_Module: "btree_cursor_next()"

# Styling
VDBE_Module.Data_Structures.style.stroke-dash: 5
VDBE_Module.Execution_Engine.style.fill: "#f1f3f5"