direction: right

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  header_style: {
    style: {
      fill: "#E1F5FE"
      stroke: "#01579B"
      stroke-width: 2
    }
  }
  logic_style: {
    style: {
      fill: "#FFF3E0"
      stroke: "#E65100"
      stroke-width: 2
    }
  }
}

# -----------------------------------------------------------------------------
# PAGE ANATOMY: THE PHYSICAL BYTE LAYOUT
# -----------------------------------------------------------------------------
PhysicalPage: {
  label: "Database Page (4096 Bytes)"
  style: {
    stroke: "#455A64"
    stroke-width: 4
    fill: "#ECEFF1"
    shadow: true
  }

  BtPageHeader: {
    shape: sql_table
    class: header_style
    type: "uint8_t | Node Type (0x0D=Leaf, 0x05=Int)"
    free_start: "uint16_t | First Freeblock Offset"
    cell_count: "uint16_t | Number of Cells"
    content_start: "uint16_t | Start of Content Area"
    frag_bytes: "uint8_t | Fragmented Free Bytes"
    right_child: "uint32_t | Right-most Child (Internal Only)"
  }

  CellPointerArray: {
    label: "Cell Pointer Array (Sorted)"
    style.fill: "#FFFFFF"
    ptr_0: "uint16_t | Offset to Cell 0"
    ptr_1: "uint16_t | Offset to Cell 1"
    ptr_n: "uint16_t | Offset to Cell N"
    
    ptr_0 -> PhysicalPage.CellContentArea.Cell_0
    ptr_n -> PhysicalPage.CellContentArea.Cell_N
  }

  FreeSpace: "Unallocated Free Space" {
    style: {
      stroke-dash: 5
      fill: transparent
      font-color: "#90A4AE"
    }
  }

  CellContentArea: {
    label: "Cell Content Area (Allocated from Bottom)"
    style.fill: "#E8F5E9"

    Cell_N: {
      shape: class
      class: logic_style
      payload_size: "varint"
      rowid: "varint"
      payload: "bytes"
    }

    Cell_0: {
      shape: class
      class: logic_style
      payload_size: "varint"
      rowid: "varint"
      payload: "bytes"
    }
  }
}

# -----------------------------------------------------------------------------
# MANAGEMENT MODULES
# -----------------------------------------------------------------------------
StorageManager: {
  Pager: {
    shape: class
    - pPCache: "PCache*"
    - fd: "int"
    - dbSize: "pgno_t"
    + acquire(pgno): "Page*"
    + release(Page*): void
    + write(Page*): int
    + sync(): void
  }

  BTree: {
    shape: class
    - pPager: "Pager*"
    - root: "pgno_t"
    + find(key): "BtCursor*"
    + insert(key, data): int
    + delete(key): int
    + balance(): void
  }

  BtCursor: {
    shape: class
    + pPage: "Page*"
    + iCell: "uint16_t"
    + eState: "CursorState"
    + next(): int
    + prev(): int
    + moveToKey(key): int
  }
}

# -----------------------------------------------------------------------------
# RELATIONSHIPS
# -----------------------------------------------------------------------------
StorageManager.BTree -> StorageManager.Pager: "has-a"
StorageManager.BtCursor -> StorageManager.Pager: "uses"
StorageManager.BtCursor -> PhysicalPage: "points to"
StorageManager.Pager -> PhysicalPage: "manages cache for"

# External Linkage
VFS: "Virtual File System (OS)" {
  shape: cloud
  icon: https://icons.terrastruct.com/tech/022-server.svg
}

StorageManager.Pager -> VFS: "pread / pwrite"

# Visual Logic Flow
PhysicalPage.BtPageHeader.content_start -> PhysicalPage.CellContentArea: "bounds"
PhysicalPage.CellPointerArray.style.stroke: "#F57C00"
PhysicalPage.CellContentArea.style.stroke: "#388E3C"

(StorageManager.BTree -> StorageManager.Pager)[0].style.stroke: "#1976D2"