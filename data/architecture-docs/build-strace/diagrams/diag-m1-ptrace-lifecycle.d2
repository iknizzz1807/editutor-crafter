direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- ACTORS & LAYERS ---

tracer: {
  label: "PARENT: TRACER (tracer.c)"
  direction: down

  init: {
    shape: code
    label: "Step 1: Process Setup"
    language: c
    content: |md
      pid_t child = fork();
      if (child == 0) { /* child logic */ }
      waitpid(child, &status, 0);
    |
  }

  set_opts: {
    shape: code
    label: "Step 4: Configure ptrace"
    language: c
    content: |md
      ptrace(PTRACE_SETOPTIONS, child, NULL, 
             PTRACE_O_TRACESYSGOOD);
    |
  }

  loop_entry: {
    shape: rectangle
    label: "SYSCALL_ENTRY STOP"
    style.fill: "#C7F1FF"
    
    action: |md
      c
      ptrace(PTRACE_GETREGS, child, NULL, &regs);
      // orig_rax = syscall number
      in_syscall = 1;
      
    |
  }

  loop_exit: {
    shape: rectangle
    label: "SYSCALL_EXIT STOP"
    style.fill: "#E4DBFE"
    
    action: |md
      c
      ptrace(PTRACE_GETREGS, child, NULL, &regs);
      // rax = return value
      in_syscall = 0;
      
    |
  }

  wait_block: {
    label: "waitpid(-1, &status, 0)"
    shape: circle
    style.stroke-dash: 3
  }
}

kernel: {
  label: "LINUX KERNEL (arch/x86/entry/entry_64.S)"
  direction: down
  style.fill: "#DEE1EB"

  ptrace_logic: {
    shape: sql_table
    label: "struct task_struct (ptrace state)"
    ptrace_flags: "0x00 | unsigned long | ptrace (PT_TRACED)"
    options: "0x08 | unsigned long | ptrace_options"
    last_sig: "0x10 | int | exit_code (SIGTRAP)"
  }

  trap_handler: {
    label: "handle_syscall_trace"
    shape: diamond
  }

  mem_bridge: {
    shape: sql_table
    label: "struct user_regs_struct (sys/user.h)"
    r15: "0x00 | u64 | r15"
    rdi: "0x68 | u64 | rdi (Arg 1)"
    rsi: "0x70 | u64 | rsi (Arg 2)"
    rdx: "0x60 | u64 | rdx (Arg 3)"
    rax: "0x50 | u64 | rax (Return/Call)"
    orig_rax: "0x78 | u64 | orig_rax (Authoritative Call #)"
    label_bottom: "Total Size: 216 Bytes"
  }
}

tracee: {
  label: "CHILD: TRACEE (tracee.c)"
  direction: down

  startup: {
    shape: code
    label: "Step 2: Request Tracing"
    language: c
    content: |md
      ptrace(PTRACE_TRACEME, 0, NULL, NULL);
      execvp(argv[1], &argv[1]);
    |
  }

  user_code: {
    label: "User Application Logic"
    shape: rectangle
    style.fill: "#ACE1AF"
    
    instr: |md
      asm
      mov rax, 1      ; write
      mov rdi, 1      ; stdout
      syscall         ; <--- Trigger
      
    |
  }

  running: {
    label: "PROCESS RUNNING"
    shape: cylinder
    style.animated: true
  }
}

# --- FLOW & LIFECYCLE ---

# 1. Initialization
tracer.init -> tracee.startup: "fork() | pid_t | 4 bytes"
tracee.startup -> kernel.ptrace_logic: "PTRACE_TRACEME | Set PT_TRACED"

# 2. Exec & Initial Stop
tracee.startup -> kernel.trap_handler: "execvp() syscall"
kernel.trap_handler -> tracer.wait_block: "SIGTRAP | 0x05 | Post-exec stop"
tracer.wait_block -> tracer.set_opts: "waitpid returns"

# 3. Enter Tracing Loop
tracer.set_opts -> kernel.ptrace_logic: "PTRACE_SETOPTIONS | PTRACE_O_TRACESYSGOOD"
tracer.set_opts -> tracer.wait_block: "ptrace(PTRACE_SYSCALL, ...)"
tracer.wait_block -> tracee.running: "Wake child"

# 4. Syscall Entry Stop
tracee.user_code -> kernel.trap_handler: "SYSCALL Instruction"
kernel.trap_handler -> tracer.wait_block: "SIGTRAP | 0x85 (Bit 7 set)"
tracer.wait_block -> tracer.loop_entry: "Entry Stop Noticed"
tracer.loop_entry -> kernel.mem_bridge: "PTRACE_GETREGS | Read orig_rax"

# 5. Syscall Execution
tracer.loop_entry -> kernel.trap_handler: "PTRACE_SYSCALL | Resume"
kernel.trap_handler -> tracee.running: "Execute Syscall Body"

# 6. Syscall Exit Stop
tracee.running -> kernel.trap_handler: "Syscall Completion"
kernel.trap_handler -> tracer.wait_block: "SIGTRAP | 0x85 | Exit Stop"
tracer.wait_block -> tracer.loop_exit: "Exit Stop Noticed"
tracer.loop_exit -> kernel.mem_bridge: "PTRACE_GETREGS | Read rax (Result)"

# 7. Resume
tracer.loop_exit -> tracee.user_code: "PTRACE_SYSCALL | Continue App"

# --- LEGEND & ANNOTATIONS ---

legend: {
  near: bottom-right
  
  entry_color: "Entry Stop" {
    style.fill: "#C7F1FF"
  }
  exit_color: "Exit Stop" {
    style.fill: "#E4DBFE"
  }
  kernel_color: "Kernel Context" {
    style.fill: "#DEE1EB"
  }
}

annotation_1: |md
  **10-Second Rule Key:**
  1. Child requests TRACEME.
  2. Parent waits.
  3. Every syscall stops TWICE (Entry & Exit).
  4. Stop 1 (Entry): `orig_rax` = Syscall Number.
  5. Stop 2 (Exit): `rax` = Return Value.
| {
  near: top-left
}