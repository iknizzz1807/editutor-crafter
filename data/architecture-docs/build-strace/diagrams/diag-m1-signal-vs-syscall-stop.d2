direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# -----------------------------------------------------------------------------
# L1 Component: waitpid Status Decoder & Decision Logic
# -----------------------------------------------------------------------------

tracer_loop: {
  label: "Tracer Event Loop (main.c)"
  direction: down

  wait_call: {
    shape: code
    label: |md
      c
      int status;
      pid_t pid = waitpid(-1, &status, 0);
      
    |
  }

  status_word: {
    shape: sql_table
    label: "waitpid Status (uint32_t)"
    row_1: "31-24 | Unused (0x00)"
    row_2: "23-16 | PTRACE_EVENT_*"
    row_3: "15-08 | WSTOPSIG (Signal Number)"
    row_4: "07-00 | Exit Status / Stop Indicator"
  }

  wait_call -> status_word: "returns status | 4 bytes | 0x0001057f"
}

logic_tree: {
  label: "Status Decision Tree"
  direction: right

  wifexited: {
    shape: diamond
    label: "WIFEXITED(status)?"
  }

  wifsignaled: {
    shape: diamond
    label: "WIFSIGNALED(status)?"
  }

  wifstopped: {
    shape: diamond
    label: "WIFSTOPPED(status)?"
  }

  # Terminal states
  handle_exit: {
    style.fill: "#f8cecc"
    style.stroke: "#b85450"
    label: "EXIT: Cleanup PID state\nprintf('+++ exited with %d +++')"
  }

  handle_term: {
    style.fill: "#f8cecc"
    style.stroke: "#b85450"
    label: "TERMINATED: Cleanup PID state\nprintf('+++ killed by signal %d +++')"
  }

  # Stop Handling
  stop_logic: {
    label: "Stop Reason Dispatch"
    direction: down
    style.stroke-dash: 3

    extract_vals: {
      shape: code
      label: |md
        c
        int sig = WSTOPSIG(status);
        int event = (status >> 16) & 0xff;
        
      |
    }

    branch_checks: {
      direction: right
      
      is_event: {
        shape: diamond
        label: "event != 0?"
      }

      is_syscall: {
        shape: diamond
        label: "sig == (SIGTRAP | 0x80)?"
      }

      is_plain_trap: {
        shape: diamond
        label: "sig == SIGTRAP?"
      }
    }

    extract_vals -> branch_checks
  }
}

# -----------------------------------------------------------------------------
# Decision Branches
# -----------------------------------------------------------------------------

outcomes: {
  direction: down

  ptrace_event: {
    label: "PTRACE_EVENT_STOP"
    tooltip: "Fork, VFork, Clone, Exec"
    style.fill: "#dae8fc"
    style.stroke: "#6c8ebf"
    details: "Call ptrace(PTRACE_GETEVENTMSG, ...)"
  }

  syscall_logic: {
    label: "SYSCALL_STOP"
    style.fill: "#d5e8d4"
    style.stroke: "#82b366"
    details: "Toggle in_syscall\nRead orig_rax/rax"
  }

  re_inject: {
    label: "SIGNAL-DELIVERY STOP"
    style.fill: "#fff2cc"
    style.stroke: "#d6b656"
    
    ptrace_call: {
      shape: code
      label: |md
        c
        // MUST re-inject the signal
        ptrace(PTRACE_SYSCALL, pid, NULL, (void*)(long)sig);
        
      |
    }
  }

  danger_zone: {
    label: "CRITICAL IMPLEMENTATION BUG"
    style.fill: "#f8cecc"
    style.stroke: "#b85450"
    style.bold: true
    label_bottom: "Consequence: Signal is 'eaten' by tracer"
    
    bug_desc: |md
      c
      // ERROR: passing 0 suppresses the signal
      ptrace(PTRACE_SYSCALL, pid, NULL, 0); 
      
    |
  }
}

# -----------------------------------------------------------------------------
# Connections
# -----------------------------------------------------------------------------

tracer_loop.status_word -> logic_tree.wifexited: "Dispatch"

logic_tree.wifexited -> logic_tree.handle_exit: "Yes"
logic_tree.wifexited -> logic_tree.wifsignaled: "No"

logic_tree.wifsignaled -> logic_tree.handle_term: "Yes"
logic_tree.wifsignaled -> logic_tree.wifstopped: "No"

logic_tree.wifstopped -> logic_tree.stop_logic.extract_vals: "Yes"

# Inside Stop Logic
logic_tree.stop_logic.branch_checks.is_event -> outcomes.ptrace_event: "Yes"
logic_tree.stop_logic.branch_checks.is_event -> logic_tree.stop_logic.branch_checks.is_syscall: "No"

logic_tree.stop_logic.branch_checks.is_syscall -> outcomes.syscall_logic: "Yes (TRACESYSGOOD bit set)"
logic_tree.stop_logic.branch_checks.is_syscall -> logic_tree.stop_logic.branch_checks.is_plain_trap: "No"

logic_tree.stop_logic.branch_checks.is_plain_trap -> outcomes.syscall_logic: "No: Signal Delivery (SIGINT, SIGSEGV, etc.)" {
  style.stroke: "#d6b656"
  style.stroke-width: 2
}

logic_tree.stop_logic.branch_checks.is_plain_trap -> logic_tree.stop_logic.extract_vals: "Yes: Post-exec / Bp (ignore)" {
  style.stroke-dash: 5
}

# Re-injection Outcome
outcomes.re_inject -> outcomes.danger_zone: "Passing 0 instead of sig" {
  style.stroke: red
  target-arrowhead: * {
    shape: diamond
  }
}

# Annotations
logic_tree.wifstopped -> logic_tree.handle_exit: "No: Unexpected state" {
  style.stroke-dash: 3
}

outcomes.re_inject.ptrace_call -> tracer_loop.wait_call: "Continue Loop" {
  style.animated: true
}

outcomes.syscall_logic -> tracer_loop.wait_call: "Continue Loop" {
  style.animated: true
}