direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# SATELLITE CONTEXT: Milestone 1 - Basic ptrace Syscall Intercept
# DOCUMENT: wait.h / ptrace.h

waitpid_status_layout: {
  shape: sql_table
  label: "int status (32-bit waitpid status word)"

  header: "Bits | Content | Description"
  
  unused: "31..24 | 0x00 | Reserved/Unused"
  
  ptrace_event: "23..16 | PTRACE_EVENT | Event Type (if event stop)"
  
  high_status: "15..8 | WEXITSTATUS / WSTOPSIG | Exit Code or Stop Signal (SIGTRAP, etc)"
  
  bit_7: "7 | TRACESYSGOOD / CORE | 0x80 bit (Syscall stop) or Core Dump flag"
  
  low_status: "6..0 | 0x7f / WTERMSIG | 0x7f (if stopped) or Termination Signal"

  # label_bottom: "Total: 4 bytes (Standard int)"  # removed: label_bottom is not valid D2
}

macro_definitions: {
  direction: down
  label: "Macro Logic (sys/wait.h)"

  wifexited: {
    shape: code
    label: "WIFEXITED(status)"
    code: |md
      c
      #define WIFEXITED(s) (((s) & 0x7f) == 0)
      
    |
  }

  wifstopped: {
    shape: code
    label: "WIFSTOPPED(status)"
    code: |md
      c
      #define WIFSTOPPED(s) (((s) & 0xff) == 0x7f)
      
    |
  }

  wifsignaled: {
    shape: code
    label: "WIFSIGNALED(status)"
    code: |md
      c
      #define WIFSIGNALED(s) (((s) & 0x7f) != 0x7f && ((s) & 0x7f) != 0)
      
    |
  }

  extraction: {
    shape: code
    label: "Value Extraction"
    code: |md
      c
      WEXITSTATUS(s)   // (s >> 8) & 0xff
      WSTOPSIG(s)      // (s >> 8) & 0xff
      WTERMSIG(s)      // (s & 0x7f)
      GET_EVENT(s)     // (s >> 16) & 0xff
      
    |
  }
}

ptrace_logic: {
  direction: down
  label: "Syscall Distinguishing Logic"

  sysgood_check: {
    shape: code
    label: "PTRACE_O_TRACESYSGOOD Check"
    code: |'md
      c
      // If PTRACE_O_TRACESYSGOOD is set:
      // Syscall stop delivers SIGTRAP | 0x80
      
      int sig = WSTOPSIG(status);
      if (sig == (SIGTRAP | 0x80)) {
          // Guaranteed Syscall Stop
      }
      
    '|
  }

  event_stop: {
    shape: sql_table
    label: "PTRACE_EVENT Values (status >> 16)"
    
    e1: "1 | PTRACE_EVENT_FORK"
    e2: "2 | PTRACE_EVENT_VFORK"
    e3: "3 | PTRACE_EVENT_CLONE"
    e4: "4 | PTRACE_EVENT_EXEC"
  }
}

# Data Flows and Extraction Links
waitpid_status_layout.low_status -> macro_definitions.wifexited: "== 0x00 | bool"
waitpid_status_layout.low_status -> macro_definitions.wifstopped: "== 0x7f | bool"

waitpid_status_layout.high_status -> macro_definitions.extraction: "Shifted 8 | uint8_t"
waitpid_status_layout.ptrace_event -> macro_definitions.extraction: "Shifted 16 | uint8_t"

waitpid_status_layout.bit_7 -> ptrace_logic.sysgood_check: "0x80 Mask | {is_syscall: true}"
macro_definitions.extraction -> ptrace_logic.event_stop: "Match | PTRACE_EVENT_*"

# Legend / Scale Indicators
legend: {
  near: bottom-right
  note: "1 Byte = 8 bits" {
    style.stroke-dash: 3
  }
  hot_path: "Red = Critical Stop Logic" {
    style.font-color: red
  }
}

waitpid_status_layout.bit_7: {
  style: {
    stroke: red
    fill: "#ffcccc"
    bold: true
  }
}

ptrace_logic.sysgood_check: {
  style: {
    stroke: red
    stroke-width: 2
  }
}