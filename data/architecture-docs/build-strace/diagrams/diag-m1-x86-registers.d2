direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# LEGEND & CONTEXT
legend: {
  shape: rectangle
  label: "x86_64 Syscall ABI\nRegisters are 8 bytes (64-bit)\nTotal Size: 216 bytes"
  near: top-left
  style: {
    fill: "#FFF9C9"
    stroke: "#9D341E"
    stroke-dash: 2
  }
}

# DATA STRUCTURE DEFINITION
user_regs: {
  shape: sql_table
  label: "struct user_regs_struct (sys/user.h)"

  "0x00": "0x00 | unsigned long | r15"
  "0x08": "0x08 | unsigned long | r14"
  "0x10": "0x10 | unsigned long | r13"
  "0x18": "0x18 | unsigned long | r12"
  "0x20": "0x20 | unsigned long | rbp"
  "0x28": "0x28 | unsigned long | rbx"
  "0x30": "0x30 | unsigned long | r11"
  arg4: "0x38 | unsigned long | r10 (Arg 4)" {
    style: {
      fill: "#E4DBFE"
      bold: true
    }
  }
  arg6: "0x40 | unsigned long | r9  (Arg 6)" {
    style: {
      fill: "#E4DBFE"
      bold: true
    }
  }
  arg5: "0x48 | unsigned long | r8  (Arg 5)" {
    style: {
      fill: "#E4DBFE"
      bold: true
    }
  }
  ret_val: "0x50 | unsigned long | rax (Return / Syscall #)" {
    style: {
      fill: "#C7F1FF"
      bold: true
    }
  }
  "0x58": "0x58 | unsigned long | rcx"
  arg3: "0x60 | unsigned long | rdx (Arg 3)" {
    style: {
      fill: "#E4DBFE"
      bold: true
    }
  }
  arg2: "0x68 | unsigned long | rsi (Arg 2)" {
    style: {
      fill: "#E4DBFE"
      bold: true
    }
  }
  arg1: "0x70 | unsigned long | rdi (Arg 1)" {
    style: {
      fill: "#E4DBFE"
      bold: true
    }
  }
  orig_rax: "0x78 | unsigned long | orig_rax (Syscall #)" {
    style: {
      fill: "#FFE7CB"
      bold: true
    }
  }
  "0x80": "0x80 | unsigned long | rip (Instruction Pointer)"
  "0x88": "0x88 | unsigned long | cs"
  "0x90": "0x90 | unsigned long | eflags"
  "0x98": "0x98 | unsigned long | rsp (Stack Pointer)"
  "...": "..."
  label_bottom: "Total: 216 bytes (Register File Snapshot)"
}

# SYSTEM CALL PHASES
phases: {
  direction: down
  
  entry_stop: {
    label: "SYSCALL ENTRY STOP"
    style: {
      fill: "#FFF9C9"
      stroke: "#9D341E"
    }
    logic: |md
    c
    // Read Syscall Number
    long num = regs.orig_rax;
    
    // Extract Arguments
    long a1 = regs.rdi; // Arg 1
    long a2 = regs.rsi; // Arg 2
    long a3 = regs.rdx; // Arg 3
    long a4 = regs.r10; // Arg 4
    long a5 = regs.r8;  // Arg 5
    long a6 = regs.r9;  // Arg 6
    
    |
  }

  exit_stop: {
    label: "SYSCALL EXIT STOP"
    style: {
      fill: "#E1F5FE"
      stroke: "#01579B"
    }
    logic: |md
    c
    // Read Result
    long result = regs.rax;
    
    // Check for Error (-4096 to -1)
    if (result < 0) {
        int err = (int)-result;
    }
    
    |
  }
}

# DATA FLOW CONNECTIONS
user_regs.orig_rax -> phases.entry_stop: "uint64_t | 8 bytes | syscall_nr" {
  style: {
    stroke: "#9D341E"
    stroke-width: 2
  }
}

user_regs.arg1 -> phases.entry_stop: "struct user_regs_struct | 216B"
user_regs.arg2 -> phases.entry_stop
user_regs.arg3 -> phases.entry_stop
user_regs.arg4 -> phases.entry_stop
user_regs.arg5 -> phases.entry_stop
user_regs.arg6 -> phases.entry_stop

user_regs.ret_val -> phases.exit_stop: "int64_t | 8 bytes | result" {
  style: {
    stroke: "#01579B"
    stroke-width: 2
    animated: true
  }
}

# FILE REFERENCE
footer: "Definition: /usr/include/x86_64-linux-gnu/sys/user.h" {
  shape: text
  near: bottom-right
}