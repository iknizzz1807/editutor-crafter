direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- ABI DEFINITION LAYER ---
abi_definition: {
  label: "x86_64 Syscall ABI (Linux)"
  direction: down

  register_struct: {
    shape: sql_table
    label: "struct user_regs_struct (sys/user.h)"
    
    rdi: "0x68 | unsigned long | rdi (Arg 1)"
    rsi: "0x70 | unsigned long | rsi (Arg 2)"
    rdx: "0x60 | unsigned long | rdx (Arg 3)"
    r10: "0xa0 | unsigned long | r10 (Arg 4)"
    r8:  "0x50 | unsigned long | r8  (Arg 5)"
    r9:  "0x48 | unsigned long | r9  (Arg 6)"
    orig_rax: "0x78 | unsigned long | orig_rax (Syscall #)"
    rax: "0x58 | unsigned long | rax (Return Value)"
    
    label_bottom: "Total size: 216 bytes"
  }

  mapping_logic: {
    shape: code
    label: "Argument Extraction (tracer.c)"
    language: c
    content: |md
      unsigned long long args[6] = {
          regs.rdi, regs.rsi, regs.rdx,
          regs.r10, regs.r8,  regs.r9
      };
      long syscall_nr = regs.orig_rax;
    |
  }

  register_struct -> mapping_logic: "PTRACE_GETREGS"
}

# --- EXAMPLE TRACE LAYER ---
examples: {
  label: "Syscall Argument Decoding Examples"
  direction: down

  # EXAMPLE 1: OPEN
  example_open: {
    shape: sql_table
    label: "open(\"/etc/passwd\", O_RDONLY, 0)"
    
    header: "Register | Raw Value | Decoded (milestone-2.c)"
    orig_rax: "orig_rax | 2 | SYS_open"
    arg1: "rdi | 0x7ffd1234 | \"/etc/passwd\" (via PEEKDATA)"
    arg2: "rsi | 0x0 | O_RDONLY"
    arg3: "rdx | 0x0 | mode: 000"
    
    style.stroke: blue
  }

  # EXAMPLE 2: READ
  example_read: {
    shape: sql_table
    label: "read(3, buf, 4096)"
    
    header: "Register | Raw Value | Decoded"
    orig_rax: "orig_rax | 0 | SYS_read"
    arg1: "rdi | 3 | fd: 3"
    arg2: "rsi | 0x55ab44ef | 0x55ab44ef (Buffer Address)"
    arg3: "rdx | 4096 | count: 4096 bytes"
    
    style.stroke: purple
  }

  # EXAMPLE 3: MMAP
  example_mmap: {
    shape: sql_table
    label: "mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0)"
    
    header: "Register | Raw Value | Decoded"
    orig_rax: "orig_rax | 9 | SYS_mmap"
    arg1: "rdi | 0x0 | addr: NULL"
    arg2: "rsi | 4096 | len: 4KB"
    arg3: "rdx | 0x3 | PROT_READ | PROT_WRITE"
    arg4: "r10 | 0x22 | MAP_PRIVATE | MAP_ANONYMOUS"
    arg5: "r8  | -1 | fd: -1"
    arg6: "r9  | 0 | offset: 0"
    
    style.stroke: orange
  }
}

# --- CONNECTIONS ---
abi_definition.mapping_logic -> examples.example_open: "Schema: ARG_STR, ARG_OPEN_FLAGS, ARG_INT"
abi_definition.mapping_logic -> examples.example_read: "Schema: ARG_INT, ARG_PTR, ARG_UINT"
abi_definition.mapping_logic -> examples.example_mmap: "Schema: ARG_PTR, ARG_UINT, ARG_MMAP_PROT, ARG_MMAP_FLAGS, ARG_INT, ARG_UINT"

# --- LEGEND / ANNOTATIONS ---
legend: {
  near: bottom-right
  
  note: |md
    ### Register Soul
    - **R10 vs RCX**: Hardware clobbers `rcx` to save `RIP` during `syscall` instruction.
    - **orig_rax**: Kernel preserves original `rax` here as `rax` is used for return value.
    - **PEEKDATA**: Required for `rdi` in `open()` because pointers exist in tracee space.
  |
}