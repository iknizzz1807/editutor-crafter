direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# L0: DATA WALK - BITMASK DECODING LOGIC
# Implementation: decode_flags() in mile2.c

input_register: {
  shape: sql_table
  label: "Input: rsi (Argument 2)"
  
  val: "0x00 | uint64_t | raw_bits: 0x241"
  binary: "0x08 | bitset    | 0000 0010 0100 0001"
  label_bottom: "Total: 16 bytes"
}

logic_flow: {
  label: "Flag Iteration Loop: decode_flags(char* buf, uint32_t flags)"
  direction: down

  initial_state: {
    shape: sql_table
    label: "T=0: Initial State"
    row1: "uint32_t | current_val | 0x241"
    row2: "char*    | output_str  | \"\""
  }

  step_1: {
    shape: sql_table
    label: "T=1: Check O_WRONLY (0x1)"
    logic: "0x241 & 0x0001 == 0x0001"
    action: "MATCH -> strcat(buf, \"O_WRONLY\")"
    state: "current_val | 0x240 (val &= ~0x1)"
  }

  step_2: {
    shape: sql_table
    label: "T=2: Check O_CREAT (0x40)"
    logic: "0x240 & 0x0040 == 0x0040"
    action: "MATCH -> strcat(buf, \"|O_CREAT\")"
    state: "current_val | 0x200 (val &= ~0x40)"
  }

  step_3: {
    shape: sql_table
    label: "T=3: Check O_TRUNC (0x200)"
    logic: "0x200 & 0x0200 == 0x0200"
    action: "MATCH -> strcat(buf, \"|O_TRUNC\")"
    state: "current_val | 0x000 (val &= ~0x200)"
  }

  initial_state -> step_1: "next iteration"
  step_1 -> step_2: "next iteration"
  step_2 -> step_3: "next iteration"
}

special_handling: {
  shape: sql_table
  label: "Zero-Value Special Case (O_RDONLY)"
  
  case: "if (val == 0 && table[0].val == 0)"
  logic: "O_RDONLY is 0x0, cannot be masked."
  fix: "If total bits == 0, return table[0].name"
  style.fill: "#fff3cd"
}

output_result: {
  shape: code
  label: "Final Decoded String (char* buf)"
  language: "text"
  value: "O_WRONLY|O_CREAT|O_TRUNC"
}

# Connections
input_register -> logic_flow.initial_state: "uint64_t | 8 bytes | 0x241"
logic_flow.step_3 -> output_result: "char* | formatted string"
logic_flow.step_1 -> special_handling: "Check if val==0" {style.stroke-dash: 3}

# Legend/Annotation - FIXED: Used constant position for elk
bitmask_annotation: |md
  ### Bitwise Logic (x86_64)
  - **O_WRONLY** (0x0001) 
  - **O_CREAT**  (0x0040)
  - **O_TRUNC**  (0x0200)
  
  **Combined Argument:** 0x241
| {
  near: top-left
}

internal_table: {
  shape: sql_table
  label: "Flag Definitions (fcntl.h)"
  
  f1: "0x0000 | O_RDONLY"
  f2: "0x0001 | O_WRONLY"
  f3: "0x0002 | O_RDWR"
  f4: "0x0040 | O_CREAT"
  f5: "0x0200 | O_TRUNC"
  f6: "0x8000 | O_CLOEXEC"
  
  # FIXED: Used constant position for elk
  near: bottom-left
}