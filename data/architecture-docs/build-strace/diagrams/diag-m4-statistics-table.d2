direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# 1. INPUT SOURCE: SYSCALL EVENTS
event_source: {
  shape: circle
  label: "Syscall Exit Stop (ptrace.c)"
  style: {
    fill: "#B6DDF6"
    stroke-width: 2
  }
}

# 2. ACCUMULATION LAYER: PER-SYSCALL STATS
stats_subsystem: {
  label: "Syscall Statistics Engine"
  direction: down

  # Memory structure for accumulation
  memory_layout: {
    shape: sql_table
    label: "struct SyscallStats stats[336] (stats.c)"
    
    "0x00": "uint64_t | total_ns"
    "0x08": "uint64_t | call_count"
    "0x10": "uint64_t | error_count"
    
  # label_bottom: "Total: 24 bytes per syscall entry | ~8KB total array"  # removed: label_bottom is not valid D2
  }

  # Accumulation logic implementation
  logic: {
    label: "Accumulation Logic (stats.c)"
    
    update_func: |'md
      c
      void stats_record(long num, long long ns, int is_err) {
          if (num < 0 || num > 335) return;
          stats[num].total_ns += ns;
          stats[num].call_count++;
          if (is_err) stats[num].error_count++;
      }
      
    '|
  }

  memory_layout -> logic: "R/W Access" {
    style.stroke-dash: 3
  }
}

# 3. PROCESSING LAYER: SORTING & AGGREGATION
processing: {
  direction: down
  label: "Processing Layer"
  
  sort_logic: {
    shape: code
    label: "Sort & Aggregate (stats.c)"
    value: |md
      c
      // 1. Calculate grand_total_ns for percentage basis
      // 2. Filter syscalls where call_count > 0
      // 3. qsort(indices, count, sizeof(int), cmp_ns_desc)
      
    |
  }
}

# 4. OUTPUT VIEW: FORMATTED SUMMARY TABLE
output_view: {
  label: "Summary Table Output View"
  direction: down
  
  summary_table: {
    shape: sql_table
    label: "strace -c Output (Sample Rendering)"
    
    "syscall": "% time | seconds | usecs/call | calls | errors"
    "read": "64.32 | 0.031423 | 12 | 2619 | 0"
    "openat": "21.17 | 0.010342 | 41 | 252 | 3"
    "write": "10.44 | 0.005103 | 4 | 1277 | 0"
    "total": "100.00 | 0.048857 | - | 4170 | 21"
  }
}

# DATA FLOWS WITH SIZE AND TYPE ANNOTATIONS
event_source -> stats_subsystem.logic: "SyscallData | 24B | {nr: 1, ns: 5000, err: 0}"
stats_subsystem.memory_layout -> processing.sort_logic: "SyscallStats[] | ~8KB | Raw Array"
processing.sort_logic -> output_view.summary_table: "ASCII Stream | ~1KB | Formatted Text"

# FORMULA REFERENCE TOOLTIP
output_view.summary_table -> output_view.summary_table: "Metric Calculation Logic" {
  style: {
    stroke-dash: 5
    stroke: gray
  }
  tooltip: |md
    ### strace -c Field Calculations
    - **% time**: `(stats[i].total_ns / sum(all_total_ns)) * 100`
    - **seconds**: `stats[i].total_ns / 1,000,000,000.0`
    - **usecs/call**: `(stats[i].total_ns / 1,000) / stats[i].call_count`
  |
}