layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

shape: sequence_diagram

# Participants
tracer: "Tracer (Parent)" {
  shape: person
  style: {
    stroke: "#2980b9"
    fill: "#ebf5fb"
  }
}

kernel: "Linux Kernel" {
  shape: cylinder
  style: {
    stroke: "#7f8c8d"
    fill: "#f2f3f4"
  }
}

tracee: "Tracee (Child)" {
  shape: person
  style: {
    stroke: "#27ae60"
    fill: "#eafaf1"
  }
}

# Sequence
tracer -> kernel: "fork()" {
  style: {
    stroke: "#2980b9"
    stroke-width: 2
  }
}

kernel -> tracee: "clone_task()" {
  style.stroke-dash: 5
}

tracee -> kernel: "ptrace(PTRACE_TRACEME, 0, 0, 0)" {
  style.stroke: "#27ae60"
}

kernel -> kernel: "Set PT_TRACED flag\non task_struct" {
  style.stroke: "#c0392b"
}

tracee -> kernel: "execvp(path, argv)" {
  style.stroke: "#27ae60"
}

kernel -> kernel: "Load ELF, Replace Address Space"

kernel -> tracee: "Deliver SIGTRAP (Post-Exec Stop)" {
  style.stroke: "#c0392b"
}

tracee -> tracee: "State: TASK_STOPPED" {
  style: {
    fill: "#fadbd8"
    stroke: "#c0392b"
    bold: true
  }
}

tracer -> kernel: "waitpid(-1, &status, 0)" {
  style.stroke: "#2980b9"
}

kernel -> tracer: "return child_pid (status=0x057f)" {
  style.stroke: "#2980b9"
}

tracer -> kernel: "ptrace(PTRACE_SETOPTIONS, child, ..., PTRACE_O_TRACESYSGOOD)" {
  style.stroke: "#2980b9"
}

kernel -> kernel: "Enable Syscall Marking (Bit 7)"

tracer -> kernel: "ptrace(PTRACE_SYSCALL, child, 0, 0)" {
  style.stroke: "#2980b9"
}

kernel -> tracee: "Set TASK_RUNNING" {
  style.stroke: "#27ae60"
}

# Loop Indicators
tracee -> kernel: "SYSCALL Instruction" {
  style: {
    stroke: "#e67e22"
    stroke-width: 3
  }
}

kernel -> tracee: "Deliver SIGTRAP | 0x80 (Entry Stop)" {
  style.stroke: "#c0392b"
}

tracee -> tracee: "State: TASK_STOPPED" {
  style.fill: "#fadbd8"
}

tracer -> kernel: "waitpid(-1, &status, 0)"

# Metadata
annote: |md
  ### ptrace Lifecycle Notes
  1. **PT_TRACED**: Atomic flag checked by kernel during all syscall boundaries.
  2. **Post-Exec SIGTRAP**: A one-time trap delivered *after* successful image replacement but *before* first instruction.
  3. **TRACESYSGOOD**: Modifies signal to 0x85 so tracer can distinguish from breakpoints.
| {
  near: top-right
  style: {
    stroke: "#7f8c8d"
    fill: "#fdfefe"
    font-size: 12
  }
}