direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# CLASSES FOR INTEL-MANUAL QUALITY
classes: {
  state_table: {
    shape: sql_table
    style: {
      stroke: "#007FFF" # Data=Blue (Border)
      fill: "#6A0DAD"   # Header=Purple
      font-color: white
    }
  }
}

# ALGORITHM: PTRACE_PEEKDATA Ambiguity Resolution
# This diagram visualizes the critical requirement to pre-clear errno 
# to distinguish between a word of all 0xFFs and an actual kernel error.

Scenario_A: "Scenario A: Valid Data (Return value -1)" {
  1: "1. Initialize" {
    state: {
      class: state_table
      "errno": "GARBAGE (e.g. 2)"
      "word": "UNDEFINED"
      "ptrace_target": "0x7ffd1234 (Valid Page)"
    }
  }
  2: "2. Pre-clear Errno" {
    state: {
      class: state_table
      "errno": "**0**" {style.font-color: red}
      "word": "UNDEFINED"
      "ptrace_target": "0x7ffd1234"
    }
  }
  3: "3. Kernel PEEKDATA" {
    state: {
      class: state_table
      "errno": "0"
      "word": "**-1 (0xFFFFFFFFFFFFFFFF)**" {style.font-color: red}
      "ptrace_target": "0x7ffd1234"
    }
  }
  4: "4. Logic Check" {
    state: {
      class: state_table
      "word == -1": "TRUE"
      "errno != 0": "**FALSE (0 == 0)**" {style.font-color: red}
      "INTERPRETATION": "SUCCESS: DATA IS VALID" {style.fill: "#D5E8D4"; style.font-color: black}
    }
  }
  1 -> 2 -> 3 -> 4
}

Scenario_B: "Scenario B: Actual Error (Return value -1)" {
  1: "1. Initialize" {
    state: {
      class: state_table
      "errno": "GARBAGE (e.g. 2)"
      "word": "UNDEFINED"
      "ptrace_target": "0x00000000 (Unmapped)"
    }
  }
  2: "2. Pre-clear Errno" {
    state: {
      class: state_table
      "errno": "**0**" {style.font-color: red}
      "word": "UNDEFINED"
      "ptrace_target": "0x00000000"
    }
  }
  3: "3. Kernel PEEKDATA" {
    state: {
      class: state_table
      "errno": "**EIO (5)**" {style.font-color: red}
      "word": "**-1**" {style.font-color: red}
      "ptrace_target": "0x00000000"
    }
  }
  4: "4. Logic Check" {
    state: {
      class: state_table
      "word == -1": "TRUE"
      "errno != 0": "**TRUE (5 != 0)**" {style.font-color: red}
      "INTERPRETATION": "FAILURE: MEMORY UNREADABLE" {style.fill: "#F8CECC"; style.font-color: black}
    }
  }
  1 -> 2 -> 3 -> 4
}

# Annotation for Engineers
Note: |md
  ### Byte-Level Logic
  On x86_64, `ptrace(PTRACE_PEEKDATA, ...)` returns a `long`.
  If the memory contains `0xFF` bytes, the return is `-1`.
  Without the `errno = 0` pre-clear, any stale `errno` from previous 
  library calls would result in a **False Positive** error detection.
| {
  near: top-center
}

Scenario_A.3 -> Scenario_B.3: "Both return -1" {
  style: {
    stroke-dash: 5
    stroke: orange
  }
}