vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# Syscall Table Architecture
SyscallTable: "Syscall Table Architecture (Parallel Array Mapping)" {
  shape: package
  style: {
    stroke-width: 2
    fill: "#f8fafc"
  }

  Indices: "Array Index [i]" {
    style.fill: "#94a3b8" # Padding/Gray
    grid-columns: 1
    i0: "0x00 [0]"
    i1: "0x01 [1]"
    i2: "0x02 [2]"
    i_gap1: "..."
    i9: "0x09 [9]"
    i_gap2: "..."
    i39: "0x27 [39]"
    i_gap3: "..."
    i64: "0x40 [64]"
    i_gap4: "..."
    i335: "0x14F [335]"

    *.shape: text
    *.style.font: mono
    *.style.bold: true
    *.style.font-color: white
  }

  NamesArray: "syscall_names[] (Pointer Table)" {
    tooltip: "Array of 336 pointers to string literals"
    style.fill: "#6e41ab" # Header/Purple
    
    annotation: |md
      **Type:** `const char*`
      **Offset:** +0B
      **Size:** 336 × 8B = 2,688B
    | {
      shape: text
    }
    
    n0: "\"read\"" { style.fill: "#f59e0b" } # Pointers/Orange
    n1: "\"write\"" { style.fill: "#f59e0b" }
    n2: "\"open\"" { style.fill: "#f59e0b" }
    ng1: "..." {shape: text; style.font-color: "#94a3b8"}
    n9: "\"mmap\"" { style.fill: "#f59e0b" }
    ng2: "..." {shape: text; style.font-color: "#94a3b8"}
    n39: "\"getpid\"" { style.fill: "#f59e0b" }
    ng3: "..." {shape: text; style.font-color: "#94a3b8"}
    n64: "NULL" {style.fill: "#94a3b8"} # Padding/Gray
    ng4: "..." {shape: text; style.font-color: "#94a3b8"}
    n335: "\"...\"" { style.fill: "#f59e0b" }

    *.style.font-color: white
    *.style.bold: true
  }

  NumArgsArray: "desc_table[i].num_args (Metadata)" {
    style.fill: "#6e41ab" # Header/Purple
    
    c0: "3" { style.fill: "#3b82f6" } # Data/Blue
    c1: "3" { style.fill: "#3b82f6" }
    c2: "3" { style.fill: "#3b82f6" }
    cg1: "..." {shape: text; style.font-color: "#94a3b8"}
    c9: "6" { style.fill: "#3b82f6" }
    cg2: "..." {shape: text; style.font-color: "#94a3b8"}
    c39: "0" { style.fill: "#3b82f6" }
    cg3: "..." {shape: text; style.font-color: "#94a3b8"}
    c64: "0" {style.fill: "#94a3b8"} # Padding/Gray
    cg4: "..." {shape: text; style.font-color: "#94a3b8"}
    c335: "N" { style.fill: "#3b82f6" }

    *.style.font: mono
    *.style.bold: true
    *.style.font-color: white
  }

  ArgTypesArray: "desc_table[i].arg_types[0..5]" {
    style.fill: "#6e41ab" # Header/Purple
    
    annotation: |md
      **Type:** `ArgType[6]` (Enum)
      **Offset:** +2,688B
      **Size:** 336 × 24B = 8,064B
    | {
      shape: text
    }
    
    t0: "ARG_INT, ARG_PTR, ARG_UINT, ..." { style.fill: "#3b82f6" } # Data/Blue
    t1: "ARG_INT, ARG_STR, ARG_UINT, ..." { style.fill: "#3b82f6" }
    t2: "ARG_STR, ARG_OPEN_FLAGS, ARG_UINT, ..." { style.fill: "#3b82f6" }
    tg1: "..." {shape: text; style.font-color: "#94a3b8"}
    t9: "ARG_PTR, ARG_UINT, ARG_PROT, ..." { style.fill: "#3b82f6" }
    tg2: "..." {shape: text; style.font-color: "#94a3b8"}
    t39: "IGNORE, IGNORE, ..." { style.fill: "#3b82f6" }
    tg3: "..." {shape: text; style.font-color: "#94a3b8"}
    t64: "IGNORE, IGNORE, ..." {style.fill: "#94a3b8"} # Padding/Gray
    tg4: "..." {shape: text; style.font-color: "#94a3b8"}
    t335: "..." { style.fill: "#3b82f6" }

    *.style.font: mono
    *.style.bold: true
    *.style.font-color: white
    *.style.font-size: 10
  }

  # Mapping connections
  Indices.i0 -> NamesArray.n0
  NamesArray.n0 -> NumArgsArray.c0
  NumArgsArray.c0 -> ArgTypesArray.t0

  Indices.i9 -> NamesArray.n9
  NamesArray.n9 -> NumArgsArray.c9
  NumArgsArray.c9 -> ArgTypesArray.t9

  # Invisible connections to force horizontal row alignment in ELK
  (Indices.i0 -> NamesArray.n0)[0].style.opacity: 0
  (NamesArray.n0 -> NumArgsArray.c0)[0].style.opacity: 0
  (NumArgsArray.c0 -> ArgTypesArray.t0)[0].style.opacity: 0
}

# Metadata Annotations
Metadata: {
  near: top-right
  label: |md
    ### Memory Footprint
    - **Pointers:** 2,688 Bytes
    - **Metadata:** 9,408 Bytes
    - **Total:** ~12,096 Bytes
    
    *Fits entirely within L1 Data Cache (32KB)*
  |
  style: {
    stroke-dash: 3
    fill: "#fffbeb"
  }
}

Legend: {
  near: bottom-center
  label: "Manual Specification Legend"
  grid-columns: 4
  
  h: "Header" {style.fill: "#6e41ab"; style.font-color: white}
  d: "Data" {style.fill: "#3b82f6"; style.font-color: white}
  p: "Pointer" {style.fill: "#f59e0b"; style.font-color: white}
  g: "Padding" {style.fill: "#94a3b8"; style.font-color: white}
}