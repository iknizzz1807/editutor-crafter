direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- REGISTER MAPPING TABLE ---

register_mapping: {
  shape: sql_table
  label: "x86_64 Syscall Argument Register Mapping"
  style: {
    stroke: "#6c5ce7" # Purple Header
    fill: "#6c5ce7"
  }
  
  # Header row
  "Arg Position": "Register" {constraint: "ptrace field (Offset)"}

  "1 (Arg 1)": "RDI" {constraint: "regs.rdi (112)"}
  "2 (Arg 2)": "RSI" {constraint: "regs.rsi (104)"}
  "3 (Arg 3)": "RDX" {constraint: "regs.rdx (96)"}
  "4 (Arg 4)": "R10" {constraint: "regs.r10 (56)"}
  "5 (Arg 5)": "R8"  {constraint: "regs.r8 (72)"}
  "6 (Arg 6)": "R9"  {constraint: "regs.r9 (64)"}
}

# --- CLOBBER EXPLANATION ---

clobber_note: |md
  ### Why R10 for Argument 4?
  The standard C calling convention uses **RCX** for the 4th argument. 
  However, the x86_64 `syscall` instruction:
  1. Saves the return `RIP` into **RCX**.
  2. Saves `RFLAGS` into **R11**.
  
  To prevent the hardware from clobbering the 4th argument, the Linux ABI redirects it to **R10**.
| {
  # ELK requires constant near values (top-left, top-right, etc.)
  near: top-right
  style: {
    stroke: orange
    stroke-dash: 3
    fill: "#fff7e6"
    font-size: 12
  }
}

# --- CONCRETE EXAMPLES ---

examples: {
  label: "Concrete Syscall Argument Examples"
  
  # Example 1: openat
  openat_call: {
    label: "openat(AT_FDCWD, \"/etc/passwd\", O_RDONLY|O_CLOEXEC, 0)"
    style.fill: "#e6f7ff"

    regs: {
      orig_rax: "orig_rax: 257 (openat)"
      rdi: "rdi: -100 (AT_FDCWD)" { style.fill: "#bae7ff" }
      rsi: "rsi: 0x7ffd... (String Ptr)" { style.fill: "#ffd8bf" }
      rdx: "rdx: 0x80000 (O_CLOEXEC)" { style.fill: "#efdbff" }
      r10: "r10: 0 (mode)" { style.fill: "#bae7ff" }
    }
  }

  # Example 2: mmap
  mmap_call: {
    label: "mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0)"
    style.fill: "#f6ffed"

    regs: {
      orig_rax: "orig_rax: 9 (mmap)"
      rdi: "rdi: 0 (NULL)" { style.fill: "#bae7ff" }
      rsi: "rsi: 4096 (length)" { style.fill: "#bae7ff" }
      rdx: "rdx: 3 (PROT_R|W)" { style.fill: "#efdbff" }
      r10: "r10: 34 (MAP_PRIV|ANON)" { style.fill: "#efdbff" }
      r8: "r8: -1 (fd)" { style.fill: "#bae7ff" }
      r9: "r9: 0 (offset)" { style.fill: "#bae7ff" }
    }
  }
}

# Layout constraints
register_mapping -> examples: "Encoding Logic" {style.stroke-dash: 5}

# Global Styles for technical distinction
register_mapping.*: {
  style.font-size: 14
}