direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- GLOBAL STYLES ---
classes: {
  register_set: {
    shape: sql_table
    style: {
      stroke: "#333333"
      stroke-width: 2
      fill: "white"
    }
  }
  data_payload: {
    style: {
      fill: "#E3F2FD"
      stroke: "#2196F3"
      font-color: "#0D47A1"
    }
  }
  pointer: {
    style: {
      stroke: "#EF6C00"
      stroke-width: 2
      font-color: "#E65100"
    }
  }
}

# --- STAGE 1: SYSCALL ENTRY ---
entry: "SYSCALL ENTRY STOP (SIGTRAP | 0x80)" {
  style.fill: "#F3E5F5"
  
  regs: "CPU Registers" {
    class: register_set
    orig_rax: "2 (open)" {style.fill: "#D1C4E9"}
    rdi: "0x7ffd1000" {class: pointer}
    rsi: "0x80000" {class: data_payload}
    rdx: "0" {class: data_payload}
  }

  cache: "ProcessState (Per-PID)" {
    entry_regs: "Snapshot" {
      shape: rectangle
      style.fill: "#EEEEEE"
    }
    timestamp: "clock_gettime(MONOTONIC)" {
      shape: parallelogram
    }
  }
  
  regs.orig_rax -> cache.entry_regs: "Copy (PTRACE_GETREGS)"
  regs.rdi -> cache.entry_regs
  regs.rsi -> cache.entry_regs
  regs.rdx -> cache.entry_regs
}

# --- STAGE 2: SYSCALL EXIT ---
exit: "SYSCALL EXIT STOP (SIGTRAP | 0x80)" {
  style.fill: "#FFF3E0"
  
  regs_exit: "CPU Registers" {
    class: register_set
    rax: "3" {style.fill: "#C8E6C9"}
  }
}

# --- STAGE 3: DECODING ENGINE ---
decoder: "Tracer Decoding Logic" {
  
  metadata: "Syscall Table Lookup" {
    shape: sql_table
    id: 2
    name: "open"
    arg_count: 3
    arg0: "ARG_STR"
    arg1: "ARG_OPEN_FLAGS"
    arg2: "ARG_UINT"
  }

  memory_walk: "PTRACE_PEEKDATA Loop" {
    ptr: "0x7ffd1000" {class: pointer}
    word0: "0x737361702f637465" # /etc/pass
    word1: "0x0000000000006477" # wd\0
    string: "\"/etc/passwd\"" {class: data_payload}
    
    ptr -> word0: "Read Word 1"
    word0 -> word1: "Read Word 2"
    word1 -> string: "NUL found"
  }

  flag_decode: "Flag Bitmask Logic" {
    val: "0x80000"
    table: "open_flags[]" {
      shape: sql_table
      item: "O_CLOEXEC (0x80000)"
      item2: "O_RDONLY (0x0)"
    }
    result: "\"O_CLOEXEC\"" {class: data_payload}
    
    val -> table: "Bitwise AND"
    table -> result: "Match"
  }
}

# --- STAGE 4: OUTPUT ---
final_output: "Stdout/Stderr Buffer" {
  line: "|'md **open(\"/etc/passwd\", O_CLOEXEC, 0) = 3** '|"
  style.stroke: "#4CAF50"
  style.stroke-width: 4
}

# --- DATA FLOW CONNECTIONS ---
entry.cache.entry_regs -> decoder.metadata: "orig_rax"
decoder.metadata.arg0 -> decoder.memory_walk: "Trigger STR read"
entry.regs.rdi -> decoder.memory_walk.ptr

entry.regs.rsi -> decoder.flag_decode.val
decoder.metadata.arg1 -> decoder.flag_decode: "Trigger FLAG decode"

exit.regs_exit.rax -> final_output: "Success Result (>= 0)"
decoder.metadata.name -> final_output
decoder.memory_walk.string -> final_output
decoder.flag_decode.result -> final_output

# --- ANNOTATIONS ---
entry.regs.rdi -> entry.regs.rdi: {
  tooltip: "Virtual address in tracee space"
}

decoder.memory_walk -> decoder.memory_walk: {
  label: "Cost: ~1500 cycles/word"
  style.stroke-dash: 3
}

ann: |md
  ### Data Transformation Sequence
  1. **Capture**: Snapshot `entry_regs` at syscall entry.
  2. **Wait**: Tracer blocks on `PTRACE_SYSCALL` while kernel executes.
  3. **Result**: `rax` populated with return code at exit.
  4. **Dereference**: Tracer uses `PEEKDATA` to bridge address space isolation.
  5. **Formatting**: Semantic assembly of names, strings, and flags.
| {
  near: bottom-center
}