direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

ForkEventSeq: "Fork Event Sequence: Multi-Process Attachment" {
  shape: sequence_diagram

  parent: "Tracee (Parent)\nPID 12345" {
    style.fill: "#dae8fc"
  }
  kernel: "Linux Kernel\nx86_64" {
    style.fill: "#e1d5e7"
  }
  tracer: "Tracer (strace)\nPID 12344" {
    style.fill: "#ffe6cc"
  }
  child: "New Child\nPID 12346" {
    style.fill: "#dae8fc"
  }

  parent -> kernel: "syscall(57) [fork]" {
    style.stroke: blue
  }
  
  kernel -> tracer: "SIGTRAP | 0x80 (Syscall Entry Stop)" {
    style.stroke: blue
  }
  
  tracer -> kernel: "ptrace(PTRACE_SYSCALL, 12345, ...)" {
    style.stroke: blue
  }
  
  kernel -> kernel: "do_fork()" {
    tooltip: "Kernel internal process creation"
  }
  
  kernel -> child: "alloc task_struct" {
    style: {
      stroke-dash: 5
      stroke: blue
    }
  }
  
  kernel -> child: "set PT_TRACED" {
    style.stroke: blue
  }
  kernel -> child: "state = TASK_STOPPED" {
    style.stroke: blue
  }
  
  kernel -> tracer: "waitpid(-1) returns PTRACE_EVENT_FORK" {
    style.stroke: blue
  }
  
  tracer -> kernel: "ptrace(PTRACE_GETEVENTMSG, 12345, ...)" {
    style.stroke: blue
  }
  kernel -> tracer: "msg: 12346 (Child PID)" {
    style.stroke: blue
  }
  
  tracer -> tracer: "state_map_insert(12346)"
  
  tracer -> kernel: "ptrace(PTRACE_SYSCALL, 12346, ...)" {
    style.stroke: blue
  }
  tracer -> kernel: "ptrace(PTRACE_SYSCALL, 12345, ...)" {
    style.stroke: blue
  }
  
  kernel -> child: "TASK_RUNNING" {
    style.stroke: blue
  }
  kernel -> parent: "TASK_RUNNING" {
    style.stroke: blue
  }
  
  child -> kernel: "execve(...) [First Syscall]" {
    style.stroke: blue
  }
  kernel -> tracer: "SIGTRAP | 0x80 (Child Entry Stop)" {
    style.stroke: blue
  }
}

# Documentation Annotations
TimingNote: |md
  ### Atomic Attachment Guarantee
  The child (12346) is created in `TASK_STOPPED`. 
  It cannot execute userspace code until the `Tracer` 
  explicitly sends `PTRACE_SYSCALL` to the child's PID.
  
  **Key Transitions:**
  1. `do_fork()` creates task.
  2. Child process inherits `PT_TRACED` flag.
  3. Parent receives `PTRACE_EVENT_FORK`.
  4. Child remains stopped until Tracer acknowledgment.
| {
  near: bottom-center
}