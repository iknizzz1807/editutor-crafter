layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- GLOBAL STYLES ---
classes: {
  header: {
    style: {
      fill: "#634791" # Purple
      font-color: white
      bold: true
    }
  }
  data: {
    style: {
      fill: "#3B82F6" # Blue
      font-color: white
    }
  }
  padding: {
    style: {
      fill: "#9CA3AF" # Gray
      opacity: 0.5
    }
  }
  pointer: {
    style: {
      stroke: "#F59E0B" # Orange
      stroke-width: 2
    }
  }
  changed: {
    style: {
      stroke: "#EF4444"
      stroke-width: 3
      font-color: "#EF4444"
      bold: true
    }
  }
}

# --- DIAGRAM LAYOUT ---
direction: right

BEFORE: "BEFORE: Syscall Entry (execve)" {
  style.stroke: "#94A3B8"
  
  State: {
    shape: sql_table
    label: "ProcessState [PID 12345] (sizeof=256B / 4 cache lines)"
    
    "0x00": "pid: 12345 | 4B" {class: data}
    "0x04": "in_syscall: **1** | 4B" {class: changed}
    "0x08": "entry_regs.orig_rax: 59 (execve) | 8B" {class: data}
    "0x10": "entry_regs.rdi: 0x7ffd1000 | 8B" {class: data}
    "0xE0": "entry_time: T1 (Monotonic) | 16B" {class: data}
    "0xF0": "valid: 1 | 4B" {class: data}
  }

  VMem: "Tracee Address Space (Old)" {
    Stack: {
      label: "0x7ffd1000: \"/usr/bin/python3\\0\""
      style.fill: "#D1FAE5"
    }
  }

  State."0x10" -> VMem.Stack: "points to" {class: pointer; style.stroke-dash: 3}
}

TRANSITION: "Kernel performs execve()\nAddress Space Purge" {
  shape: package
  style.stroke-dash: 5
}

AFTER: "AFTER: PTRACE_EVENT_EXEC Stop" {
  style.stroke: "#10B981"

  State: {
    shape: sql_table
    label: "ProcessState [PID 12345] (State Reset Triggered)"
    
    "0x00": "pid: 12345 | 4B" {class: data}
    "0x04": "in_syscall: **0** | 4B" {class: changed}
    "0x08": "entry_regs.orig_rax: **0** | 8B" {class: changed}
    "0x10": "entry_regs.rdi: **0** | 8B" {class: changed}
    "0xE0": "entry_time: **0** | 16B" {class: changed}
    "0xF0": "valid: 1 | 4B" {class: data}
  }

  VMem: "Tracee Address Space (NEW)" {
    NewStack: {
      label: "0x7ffd1000: [New Python Stack]"
      style.fill: "#FEE2E2"
    }
    Annotation: |md
      **DANGLING POINTER**
      Old virtual address 
      0x7ffd1000 now contains
      new stack frame.
    | {
      shape: text
      style.font-color: "#B91C1C"
    }
  }

  State."0x10" -> VMem.NewStack: "Dangling/Zeroed" {class: pointer; style.stroke-dash: 5}
}

BEFORE -> TRANSITION -> AFTER

# --- ANNOTATIONS ---
note: |md
  ### PTRACE_EVENT_EXEC Invariants
  1. **PID Continuity**: The process ID `12345` remains identical across the replacement.
  2. **Memory Discontinuity**: The entire MMU context (CR3) is replaced. 
  3. **Tracer State**: `in_syscall` must be reset to **0**.
  4. **Registers**: `entry_regs` from the `execve` call are now invalid for the new program context.
| {
  near: top-center
}