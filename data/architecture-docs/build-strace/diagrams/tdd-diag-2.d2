layout-engine: elk
theme-id: 6

# Syscall Entry/Exit Toggle State Machine
# Purpose: Maintain synchronization with the ptrace double-stop mechanism.

initial_node: "" {
  shape: circle
  style.fill: black
  width: 20
}

EXPECT_ENTRY: {
  shape: rectangle
  style.border-radius: 8
  label: "EXPECT_ENTRY\n(Invar: in_syscall == 0)"
}

EXPECT_EXIT: {
  shape: rectangle
  style.border-radius: 8
  label: "EXPECT_EXIT\n(Invar: in_syscall == 1)"
}

TERMINATED: "PROCESS_TERMINATED" {
  shape: rectangle
  style.border-radius: 8
  style.fill: "#eeeeee"
}

ERROR_PATH: "FATAL_ERROR (ESRCH)" {
  shape: rectangle
  style.border-radius: 8
  style: {
    fill: red
    font-color: white
    bold: true
  }
}

initial_node -> EXPECT_ENTRY: "fork() / PTRACE_TRACEME"

EXPECT_ENTRY -> EXPECT_EXIT: "SIGTRAP | 0x80 [in_syscall == 0] / save orig_rax; in_syscall=1"

EXPECT_EXIT -> EXPECT_ENTRY: "SIGTRAP | 0x80 [in_syscall == 1] / read rax; print; in_syscall=0"

# Normal Exit Paths
EXPECT_ENTRY -> TERMINATED: "WIFEXITED / WIFSIGNALED"
EXPECT_EXIT -> TERMINATED: "WIFEXITED / WIFSIGNALED"

# Error Handling
EXPECT_ENTRY -> ERROR_PATH: "PTRACE_GETREGS returns ESRCH" {
  style.stroke: red
}
EXPECT_EXIT -> ERROR_PATH: "PTRACE_GETREGS returns ESRCH" {
  style.stroke: red
}

# Illegal Transitions (Out of Sync)
EXPECT_ENTRY -> EXPECT_ENTRY: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

EXPECT_EXIT -> EXPECT_EXIT: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

# Documentation Annotations
annot: |md
  ### State Invariants
  - **EXPECT_ENTRY**: Process is at syscall-entry. `rax` contains syscall number. `orig_rax` is initialized by kernel.
  - **EXPECT_EXIT**: Process is at syscall-exit. `rax` contains return value or `-errno`.
| {
  near: bottom-right
}