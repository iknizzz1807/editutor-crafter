direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# State Definitions
NOT_PRESENT: "NOT_PRESENT" {
  shape: package
  tooltip: "valid == 0"
  style: {
    stroke-dash: 3
  }
}

PRESENT_EXPECT_ENTRY: "PRESENT_EXPECT_ENTRY" {
  style.border-radius: 15
  tooltip: |md
    - **valid**: 1
    - **in_syscall**: 0
    - **Invariants**: Waiting for syscall initiation
  |
}

PRESENT_EXPECT_EXIT: "PRESENT_EXPECT_EXIT" {
  style.border-radius: 15
  tooltip: |md
    - **valid**: 1
    - **in_syscall**: 1
    - **Invariants**: Syscall is executing in kernel
  |
}

ILLEGAL_STATE: "ILLEGAL TRANSITION" {
  style: {
    fill: red
    font-color: white
    stroke: darkred
    bold: true
  }
}

# Lifecycle Transitions
start: "â—"
start -> NOT_PRESENT

NOT_PRESENT -> PRESENT_EXPECT_ENTRY: "fork/clone event or initial fork()" {
  tooltip: "Action: state_map_insert(pid); active_count++;"
}

PRESENT_EXPECT_ENTRY -> PRESENT_EXPECT_EXIT: "Entry Syscall Stop (SIGTRAP|0x80)" {
  tooltip: "Action: save entry_regs; record entry_time; in_syscall = 1;"
}

PRESENT_EXPECT_EXIT -> PRESENT_EXPECT_ENTRY: "Exit Syscall Stop (SIGTRAP|0x80)" {
  tooltip: "Action: print_syscall(); stats_record(); in_syscall = 0;"
}

# Exec Reset Logic
PRESENT_EXPECT_EXIT -> PRESENT_EXPECT_ENTRY: "PTRACE_EVENT_EXEC" {
  style: {
    stroke: orange
    animated: true
  }
  tooltip: "Action: Reset state (in_syscall=0); Address space replaced."
}

# Exit/Termination
PRESENT_EXPECT_ENTRY -> NOT_PRESENT: "WIFEXITED / WIFSIGNALED" {
  tooltip: "Action: state_map_remove(pid); active_count--;"
}

PRESENT_EXPECT_EXIT -> NOT_PRESENT: "WIFEXITED / WIFSIGNALED" {
  tooltip: "Action: state_map_remove(pid); active_count--; (Unusual exit during kernel exec)"
}

# Illegal Transitions
(PRESENT_EXPECT_EXIT -> ILLEGAL_STATE): "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

# Internal Annotations
note: |md
  ### State Invariants
  The `state_map` uses open-addressing. `valid` flags are checked 
  at every `waitpid(-1)` return to dispatch to the correct 
  `ProcessState` slot.
| {
  near: top-left
}