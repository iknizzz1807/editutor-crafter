direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# CLOCK_MONOTONIC vs CLOCK_REALTIME: Why Monotonic is Mandatory
# Sequential timing comparison across clock sources

CLOCK_REALTIME: {
  label: "CLOCK_REALTIME (Wall Time / NTP Controlled)"
  style: {
    stroke: purple
    stroke-width: 4
    fill: "#f5f5f5"
  }

  step1: "1. Syscall Entry (T1)" {
    shape: rectangle
    style.fill: "#dae8fc" # Data Blue
    label: |md
      **T1: 1700000000.500s**
      `clock_gettime(CLOCK_REALTIME, ...)`
    |
  }

  step2: "2. External NTP Event" {
    shape: oval
    style: {
      fill: "#f8cecc"
      stroke: red
      bold: true
    }
    label: "**CRITICAL: NTP Step Back (-100ms)**"
  }

  step3: "3. Syscall Exit (T2)" {
    shape: rectangle
    style.fill: "#dae8fc" # Data Blue
    label: |md
      **T2: 1700000000.450s**
      `clock_gettime(CLOCK_REALTIME, ...)`
    |
  }

  step4: "4. Delta Calculation" {
    shape: rectangle
    style: {
      fill: "#f8cecc"
      stroke: red
      stroke-dash: 2
    }
    label: |md
      **Result: T2 < T1**
      elapsed: **<span style="color: red">-50,000,000 ns</span>**
      *CRITICAL FAILURE: Timestamps move backwards*
    |
  }

  step1 -> step2 -> step3 -> step4
}

CLOCK_MONOTONIC: {
  label: "CLOCK_MONOTONIC (Hardware Counter / vDSO)"
  style: {
    stroke: purple
    stroke-width: 4
    fill: "#f5f5f5"
  }

  step1: "1. Syscall Entry (T1)" {
    shape: rectangle
    style.fill: "#dae8fc" # Data Blue
    label: |md
      **T1: 5000.500s**
      `clock_gettime(CLOCK_MONOTONIC, ...)`
    |
  }

  step2: "2. External NTP Event" {
    shape: oval
    style: {
      fill: "#d5e8d4" # Free Green (Stable)
      stroke: "#82b366"
      bold: true
    }
    label: "NTP Slew: Freq Adjustment Only (Stable)"
  }

  step3: "3. Syscall Exit (T2)" {
    shape: rectangle
    style.fill: "#dae8fc" # Data Blue
    label: |md
      **T2: 5000.550s**
      `clock_gettime(CLOCK_MONOTONIC, ...)`
    |
  }

  step4: "4. Delta Calculation" {
    shape: rectangle
    style: {
      fill: "#d5e8d4" # Free Green
      stroke-dash: 2
    }
    label: |md
      **Result: T2 > T1**
      elapsed: **+50,000,000 ns**
      *GUARANTEED progression*
    |
  }

  step1 -> step2 -> step3 -> step4
}

# Fixed: near set to constant 'bottom-right' as required by ELK engine
annotation: |md
  ### vDSO Fast Path Implementation
  On x86_64, `clock_gettime(CLOCK_MONOTONIC)` uses the **vDSO** (virtual Dynamic Shared Object).
  - Reads **TSC (Time Stamp Counter)** directly from CPU.
  - No Kernel context switch.
  - Latency: **~30-40 ns**.
| {
  near: bottom-right
  style: {
    stroke: orange # Pointer Orange
    stroke-width: 2
    fill: "#fff2cc"
    font-size: 14
  }
}

CLOCK_REALTIME -> CLOCK_MONOTONIC: "Clock Comparison" {
  style: {
    stroke: orange
    stroke-dash: 5
  }
}