direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# SYSCALL STATS ARRAY MEMORY SPECIFICATION
# Total Size: 336 * 24 bytes = 8,064 bytes (~1.97 Pages)
# Cache Residency: 100% L1d for hot paths

memory_space: {
  label: "Physical Memory Layout: SyscallStats stats[336]"
  
  header: {
    shape: sql_table
    style: {
      stroke: "#6e41e2"
      stroke-width: 4
      fill: "#6e41e2"
    }
    
    offset: "Offset"
    content: "Field Mapping"
    size: "Size"
  }

  stats_0: "Index 0: read (24B)" {
    style.stroke: "#2b6cb0"
    shape: sql_table
    
    t_ns: "0x0000 | total_ns (int64_t) | 8B" {style.fill: "#2b6cb0"; style.font-color: white}
    c_ct: "0x0008 | call_count (long)    | 8B" {style.fill: "#2b6cb0"; style.font-color: white}
    e_ct: "0x0010 | error_count (long)   | 8B" {style.fill: "#2b6cb0"; style.font-color: white}
  }

  stats_1: "Index 1: write (24B)" {
    style.stroke: "#2b6cb0"
    shape: sql_table
    
    t_ns: "0x0018 | total_ns (int64_t) | 8B" {style.fill: "#2b6cb0"; style.font-color: white}
    c_ct: "0x0020 | call_count (long)    | 8B" {style.fill: "#2b6cb0"; style.font-color: white}
    e_ct: "0x0028 | error_count (long)   | 8B" {style.fill: "#2b6cb0"; style.font-color: white}
  }

  cache_boundary_0: {
    shape: text
    label: "---------------- L1 Cache Line Boundary (64B Offset 0x0040) ----------------"
    style.font-color: "#a0aec0"
    style.stroke-dash: 5
  }

  stats_2: "Index 2: open (24B)" {
    style.stroke: "#2b6cb0"
    shape: sql_table
    
    t_ns: "0x0030 | total_ns (int64_t) | 8B" {style.fill: "#2b6cb0"; style.font-color: white}
    c_ct: "0x0038 | call_count (long)    | 8B" {style.fill: "#2b6cb0"; style.font-color: white}
    e_ct: "0x0040 | error_count (long)   | 8B" {style.fill: "#ed8936"; style.font-color: white; tooltip: "Straddles cache line"}
  }

  stats_gap: "... [Indices 3 - 334] ..." {
    style.fill: "#a0aec0"
    style.stroke-dash: 3
  }

  stats_335: "Index 335: last (24B)" {
    style.stroke: "#2b6cb0"
    shape: sql_table
    
    t_ns: "0x1F68 | total_ns (int64_t) | 8B" {style.fill: "#2b6cb0"; style.font-color: white}
    c_ct: "0x1F70 | call_count (long)    | 8B" {style.fill: "#2b6cb0"; style.font-color: white}
    e_ct: "0x1F78 | error_count (long)   | 8B" {style.fill: "#2b6cb0"; style.font-color: white}
  }

  page_boundary: {
    label: "================ OS PAGE BOUNDARY (4096B Offset 0x1000) ================"
    style.stroke-width: 6
    style.bold: true
  }
}

access_logic: {
  label: "Atomic Update Path: stats_record()"
  
  cpu_pipeline: {
    load: "MOV RAX, [stats + offset]"
    inc: "ADD RAX, duration_ns"
    store: "MOV [stats + offset], RAX"
    
    load -> inc -> store
  }
  
  note: |md
    ### Performance Characteristics
    - **Zero Heap Allocation**: Array is statically allocated in `.bss` or `.data`.
    - **Zero Pointer Chasing**: Direct indexing `stats[num]` replaces linked-list lookups.
    - **High Locality**: Hot syscalls (0, 1, 2) occupy the same 64B cache line.
    - **Alignment**: 24B struct size means 8 entries consume exactly 3 cache lines (192B).
  |
}

memory_space.stats_0 -> access_logic.cpu_pipeline.load: "O(1) Indexed Access" {
  style.stroke: "#ed8936"
  style.animated: true
}

# Footer Annotations
annotation: |md
  **Total Array Size**: 8,064 Bytes
  **Architecture**: x86_64
  **Clock Source**: CLOCK_MONOTONIC
| {
  near: bottom-center
}