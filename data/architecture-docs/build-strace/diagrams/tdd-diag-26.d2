vars: {
  d2-config: {
    theme-id: 4
    layout-engine: elk
  }
}

ptrace_lifecycle_comparison: {
  grid-columns: 2
  grid-gap: 50

  fork_exec: "1. Fork + TRACEME Lifecycle" {
    shape: sequence_diagram
    tracer: "Tracer (Parent)" {
      shape: person
      style.fill: "#f4b76c"
    }
    kernel: "Linux Kernel" {
      style.fill: "#DEE1EB"
    }
    child: "Child (Tracee)" {
      style.fill: "#C7F1FF"
    }

    tracer -> kernel: "fork()"
    kernel -> child: "clone_task()"
    child -> kernel: "ptrace(PTRACE_TRACEME, 0, 0, 0) = 0"
    child -> kernel: "execvp(argv[0], argv)"
    
    kernel -> kernel: "check PT_TRACED flag"
    kernel -.-> child: "deliver SIGTRAP (post-exec)" {
      style: {
        stroke-dash: 3
        stroke: blue
      }
    }
    
    child -> child: "▼ TASK_STOPPED" {
      style.font-color: red
    }
    
    tracer -> kernel: "waitpid(child_pid, &status, 0)"
    kernel -> tracer: "return child_pid (status: WIFSTOPPED)"
    
    tracer -> kernel: "ptrace(PTRACE_SETOPTIONS, child, ...)"
    tracer -> kernel: "ptrace(PTRACE_SYSCALL, child, ...)"
    
    kernel -> child: "resume execution"
    child -> child: "▲ TASK_RUNNING" {
      style.font-color: green
    }
  }

  attach: "2. PTRACE_ATTACH Lifecycle" {
    shape: sequence_diagram
    tracer: "Tracer" {
      shape: person
      style.fill: "#f4b76c"
    }
    kernel: "Linux Kernel" {
      style.fill: "#DEE1EB"
    }
    target: "Target (Running)" {
      style.fill: "#B5AFF6"
    }

    tracer -> kernel: "ptrace(PTRACE_ATTACH, target_pid) = 0"
    
    kernel -.-> target: "send SIGSTOP (Asynchronous)" {
      style: {
        stroke-dash: 5
        stroke: orange
      }
    }
    
    target -> target: "signal processed"
    target -> target: "▼ TASK_STOPPED" {
      style.font-color: red
    }
    
    tracer -> kernel: "waitpid(target_pid, &status, 0)"
    kernel -> tracer: "return target_pid (status: WIFSTOPPED/SIGSTOP)"
    
    tracer -> kernel: "ptrace(PTRACE_SETOPTIONS, target, ...)"
    tracer -> kernel: "ptrace(PTRACE_SYSCALL, target, ...)"
    
    kernel -> target: "resume execution"
    target -> target: "▲ TASK_RUNNING" {
      style.font-color: green
    }
  }
}

architecture_note: |md
  ### TECHNICAL DESIGN NOTE: SYNCHRONIZATION
  - **Fork+TRACEME**: Deterministic. The child is stopped by the kernel *immediately* after the `execve` transition before a single instruction of the new image executes.
  - **PTRACE_ATTACH**: Non-deterministic. The attachment is a request. The target continues to run until the `SIGSTOP` is delivered and handled. 
  - **Mandatory Sync**: The `waitpid()` call is the only valid synchronization point. Calling `PTRACE_SETREGS` or `PTRACE_SYSCALL` immediately after `PTRACE_ATTACH` without a successful `waitpid` will result in `ESRCH` or `EIO`.
| {
  near: bottom-center
  style: {
    stroke: orange
    fill: "#FFF9C9"
  }
}