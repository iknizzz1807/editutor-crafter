vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

shape: sequence_diagram

# Participants Definition
User: "User (Keyboard/TTY)" {
  style.fill: "#f8f9fa" # Padding/Gray
}

Tracer: "strace_clone (Tracer Process)" {
  style.fill: "#e1d5e7" # Header/Purple
}

Kernel: "Linux Kernel (ring 0)" {
  style.fill: "#dae8fc" # Data/Blue
}

Target: "Target Process (Tracee)" {
  style.fill: "#d5e8d4" # Free/Green
}

# 1. SIGINT Interrupt
User -> Tracer: "SIGINT (Ctrl+C)" {
  style: {
    stroke: red
    stroke-width: 4
  }
}

# 2. Signal Handler execution
Tracer."Signal Handler": "volatile sig_atomic_t g_interrupted = 1" {
  style: {
    stroke: red
    stroke-dash: 3
    bold: true
  }
}
Tracer."Signal Handler" -> Tracer."Signal Handler": "|'md **[NOTE]** ONLY async-signal-safe operation allowed here'|"

# 3. Kernel interrupts waitpid()
Kernel -> Tracer."Main Loop": "waitpid() returns -1 (errno=EINTR)" {
  style.stroke: red
}

# 4. Main loop evaluates flag
Tracer."Main Loop" -> Tracer."Main Loop": "if (g_interrupted == 1) handle_interrupt()"

# 5. Tracer initiates stop for detach
Tracer."Main Loop" -> Kernel: "kill(target_pid, SIGSTOP)" {
  style.stroke: blue
}

# 6. Kernel delivers signal
Kernel -> Target: "SIGSTOP delivery" {
  style.stroke-dash: 3
}

# 7. Target transitions state
Target -> Target: "TASK_STOPPED" {
  style: {
    fill: "#f8cecc"
    stroke: red
  }
}

# 8. Tracer waits for stop confirmation
Kernel -> Tracer."Main Loop": "waitpid() returns status (WIFSTOPPED, SIGSTOP)" {
  style.stroke: blue
}

# 9. Tracer performs the detach
Tracer."Main Loop" -> Kernel: "ptrace(PTRACE_DETACH, pid, NULL, NULL)" {
  style.stroke: blue
}

# 10. Kernel performs cleanup
Kernel -> Kernel: "|'md **Atomic Cleanup:**\n1. Clear PT_TRACED flag\n2. Reparent to orig_ppid\n3. Deliver SIGCONT'|" {
  style.stroke-dash: 5
}

# 11. Target resumes untraced
Kernel -> Target: "Resume Execution" {
  style: {
    stroke: green
    stroke-dash: 3
  }
}

# 12. Final state
Target -> Target: "Running (untraced)"

# 13. Tracer Finalization
Tracer."Main Loop" -> Tracer."Main Loop": "stats_print(stderr)" {
  style.stroke: blue
}

Tracer."Main Loop" -> Tracer: "exit(0)" {
  target-arrowhead: * {
    shape: circle
  }
}

# Timing & Logic Annotations
# Changed invalid '.note' key to '.tooltip' to fix compilation while preserving metadata
(User -> Tracer)[0].tooltip: "T + 0ms"
(Tracer."Main Loop" -> Kernel)[0].tooltip: "T + 15ms (SIGSTOP issued)"
(Kernel -> Target)[0].tooltip: "T + 17ms (Signal Delivery)"
(Target -> Target)[0].tooltip: "Target is frozen in ptrace-stop"
(Kernel -> Target)[1].tooltip: "T + 25ms (Tracee released to wild)"