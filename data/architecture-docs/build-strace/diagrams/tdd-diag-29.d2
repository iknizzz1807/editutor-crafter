vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ALGORITHM: stats_print() Summary Table Generation
stats_print_algo: {
  shape: package
  label: "Algorithm: stats_print() Pipeline"

  # --- STEP 1: COLLECTION ---
  step_1: {
    label: "1. Collection & Summation"
    
    input_stats: {
      shape: sql_table
      label: "stats[0..335] (Input)"
      0: "read | 31.4ms | 2619 calls"
      1: "write | 5.1ms | 1277 calls"
      257: "openat | 10.3ms | 252 calls"
      others: "... (call_count == 0)"
    }

    logic: |md
      c
      for (i=0; i<=335; i++) {
        if (stats[i].call_count > 0) {
          indices[count++] = i;
          grand_total_ns += stats[i].total_ns;
        }
      }
      
    |

    state_after_1: {
      shape: sql_table
      label: "Computed State"
      indices: "**[0, 1, 257]**" {style.font-color: red}
      grand_total_ns: "**46,868,000**" {style.font-color: red}
      grand_calls: "**4148**" {style.font-color: red}
    }

    input_stats -> logic -> state_after_1
  }

  # --- STEP 2: SORTING ---
  step_2: {
    label: "2. Descending Sort (qsort)"
    
    comparator: |md
      **Sort Key**: `stats[i].total_ns`
      **Order**: DESC
      c
      // read (31.4) vs openat (10.3)
      return (10.3 > 31.4) ? 1 : -1; 
      
    |

    indices_before: "[0, 1, 257]"
    indices_after: "**[0, 257, 1]**" {
      style: {
        stroke: red
        stroke-width: 2
      }
    }

    indices_before -> comparator -> indices_after: "qsort()"
  }

  # --- STEP 3: FORMATTING ---
  step_3: {
    label: "3. Row Calculation"
    
    math: {
      shape: sql_table
      pct: "100.0 * ns / grand_ns"
      secs: "ns / 1e9"
      usecs: "ns / 1000 / calls"
    }

    calc_read: "Row[0]: **67.04% | 0.031s | 12us**" {style.font-color: red}
    calc_open: "Row[1]: **22.06% | 0.010s | 41us**" {style.font-color: red}
    calc_write: "Row[2]: **10.90% | 0.005s | 4us**" {style.font-color: red}

    math -> calc_read
    math -> calc_open
    math -> calc_write
  }

  # --- STEP 4: RENDERING ---
  step_4: {
    label: "4. Final ASCII Render"
    
    output: |md
      text
      % time     seconds  usecs/call     calls    errors  syscall
      ------ ----------- ----------- --------- --------- ----------------
       67.04    0.031423          12      2619         0  read
       22.06    0.010342          41       252         3  openat
       10.90    0.005103           4      1277         0  write
      ------ ----------- ----------- --------- --------- ----------------
      100.00    0.046868                  4148         3  total
      
    | {
      style: {
        stroke: green
        fill: "#f0fff0"
      }
    }
  }

  # Flow between steps
  step_1 -> step_2 -> step_3 -> step_4
}

# Data Movement Annotations
stats_print_algo.step_1.state_after_1.indices -> stats_print_algo.step_2.indices_before: "Pass indices"
stats_print_algo.step_2.indices_after -> stats_print_algo.step_3.math: "Iterate sorted"
stats_print_algo.step_3.calc_write -> stats_print_algo.step_4.output: "Buffer lines"