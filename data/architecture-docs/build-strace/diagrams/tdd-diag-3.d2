layout-engine: elk
vars: {
  d2-config: {
    theme-id: 0
  }
}

# WAITPID STATUS WORD MEMORY LAYOUT
# Colors: Header=Purple, Data=Blue, Free=Green, Padding=Gray, Pointers=Orange
status_word: "waitpid(2) Status Word (int32)" {
  shape: sql_table
  style: {
    stroke: "#b19cd9"
    stroke-width: 4
  }

  byte_3: "8 bits" {
    label: "Unused / Padding"
    constraint: "[31:24]"
    style: {
      fill: "#d3d3d3"
      stroke-dash: 5
    }
  }

  byte_2: "8 bits" {
    label: "Ptrace Event (PTRACE_EVENT_*)"
    constraint: "[23:16]"
    style.fill: "#7fa3ff"
  }

  byte_1: "8 bits" {
    label: "Stop Signal / Exit Code"
    constraint: "[15:8]"
    style.fill: "#7fa3ff"
  }

  byte_0: "8 bits" {
    label: "Wait Status Flag / Term Signal"
    constraint: "[7:0]"
    style.fill: "#b19cd9"
  }
}

# Bit Offsets (Left Margin Representation)
offsets: |md
  ### Byte Offsets
  - **0x03**: [31:24]
  - **0x02**: [23:16]
  - **0x01**: [15:08]
  - **0x00**: [07:00]
|
offsets.near: status_word

# Widths (Right Margin Representation)
widths: |md
  ### Field Widths
  - **Byte 3**: 8 bits
  - **Byte 2**: 8 bits
  - **Byte 1**: 8 bits
  - **Byte 0**: 8 bits
|
widths.near: status_word

# Macro Decoding Logic
wifstopped: "WIFSTOPPED(s)" {
  shape: parallelogram
  label: "Check (s & 0xFF) == 0x7F"
  style.stroke: orange
}

wifexited: "WIFEXITED(s)" {
  shape: parallelogram
  label: "Check (s & 0x7F) == 0"
  style.stroke: orange
}

wstopsig: "WSTOPSIG(s)" {
  shape: parallelogram
  label: "Extract (s >> 8) & 0xFF"
  style.stroke: orange
}

pevent: "PTRACE_EVENT(s)" {
  shape: parallelogram
  label: "Extract (s >> 16) & 0xFF"
  style.stroke: orange
}

# Signal Constants
constants: |md
  ### Register Context
  - `SIGTRAP` = **0x05**
  - `SIGTRAP | 0x80` = **0x85**
  - **rax** = Return Value
|
constants.near: status_word
constants.style.fill: "#fce7c6"

# Detail element for Core Dump
b7_core: "Bit 7: Core Dump" {
  style: {
    fill: orange
    bold: true
  }
}

# Connections and Logical Flow
wifstopped -> status_word.byte_0: "Evaluates"
wstopsig -> status_word.byte_1: "Extracts"
pevent -> status_word.byte_2: "Extracts"
status_word.byte_0 -> b7_core: "Contains"

# Layout Flow
status_word.byte_3 -> status_word.byte_2: "" {
  style.stroke-dash: 3
}
status_word.byte_2 -> status_word.byte_1: "" {
  style.stroke-dash: 3
}
status_word.byte_1 -> status_word.byte_0: "" {
  style.stroke-dash: 3
}

# Metadata Footer
info: |md
  **Total Size**: 32 bits (4 bytes)
  **Endianness**: Little-Endian (x86_64)
  **Growth**: Byte-aligned boundaries
|
info.near: status_word