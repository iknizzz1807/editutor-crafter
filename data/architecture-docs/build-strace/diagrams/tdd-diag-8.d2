layout-engine: elk
theme-id: 4

# VIRTUAL ADDRESS SPACE ISOLATION ARCHITECTURE
# Goal: Visualize why PTRACE_PEEKDATA is required for cross-process memory access.

direction: right

tracer_process: "Tracer Process (PID 5000)" {
  style: {
    stroke: "#6a0dad" # Purple Header
    stroke-width: 4
  }
  
  cr3_reg: "CR3 Register" {
    shape: rectangle
    label: "CR3 -> Page Table A\n(sizeof=8 bytes)"
    style.fill: "#DEE1EB"
  }

  virt_addr: "Virtual Address: 0x7ffd1234abcd" {
    shape: rectangle
    label: "VA: 0x7ffd...abcd\n(size=8 bytes)"
    style.fill: "#B6DDF6" # Blue Data
  }

  deref_attempt: "Direct Dereference\n*0x7ffd...abcd" {
    shape: cloud
    style.fill: "#FE7070" # Red Error
  }

  ptrace_call: "ptrace(PEEKDATA, ...)" {
    style.fill: "#fce7c6" # Orange Pointer logic
  }

  deref_attempt -> virt_addr: "1. Attempt access"
  virt_addr -> segv: "2. Lookup Table A" {style.stroke: red}
  segv: "SIGSEGV" {
    shape: diamond
    style.fill: red
    style.font-color: white
  }
}

kernel_space: "Linux Kernel (Ring 0)" {
  style: {
    stroke: "#6a0dad"
    stroke-dash: 5
  }

  ptrace_handler: "sys_ptrace (PTRACE_PEEKDATA)" {
    shape: rectangle
    style.fill: "#fce7c6" # Orange Pointer logic
  }

  mm_proxy: "mm_struct (Tracee)" {
    shape: rectangle
    label: "Proxy Tracee Page Tables\n(sizeof ≈ 1KB)"
    style.fill: "#B6DDF6"
  }

  ptrace_handler -> mm_proxy: "Switches Address Context"
}

tracee_process: "Tracee Process (PID 5001)" {
  style: {
    stroke: "#6a0dad"
    stroke-width: 4
  }

  cr3_reg: "CR3 Register" {
    shape: rectangle
    label: "CR3 -> Page Table B"
    style.fill: "#DEE1EB"
  }

  virt_addr: "Virtual Address: 0x7ffd1234abcd" {
    shape: rectangle
    style.fill: "#B6DDF6"
  }

  virt_addr -> ram.p1: "Valid Mapping (Table B)" {
    style.stroke: "#167c3c" # Success Green
  }
}

ram: "Physical Memory (DRAM)" {
  style.fill: "#ebf3e6" # Green Free/Mem
  p1: "Physical Page P1" {
    label: "P1: [ 'h' 'e' 'l' 'l' 'o' '\\0' ]"
    style.fill: "#B6DDF6"
  }
}

# The PTRACE path
tracer_process.ptrace_call -> kernel_space.ptrace_handler: "3. Syscall" {
  style.stroke: orange
  style.stroke-width: 3
}

kernel_space.mm_proxy -> ram.p1: "4. Resolve & Read" {
  style.stroke: orange
  style.stroke-dash: 3
}

ram.p1 -> kernel_space.ptrace_handler: "5. Return 8 bytes"
kernel_space.ptrace_handler -> tracer_process: "6. Return to rax"

# Context Switch Legend
legend: {
  label: |md
    ### Hardware Soul: Context Switch
    - **CR3 Switch**: Hardware-enforced isolation.
    - **Isolation**: VA 0x7ffd... in Tracer is NOT VA 0x7ffd... in Tracee.
    - **Cost**: PTRACE_PEEKDATA requires 2 context switches + kernel page walk.
  |
  near: bottom-right
}

# Sizing annotations as discrete properties for metadata extraction
tracer_process.cr3_reg.sizeof: "8 bytes"
tracer_process.virt_addr.sizeof: "8 bytes (word)"
kernel_space.mm_proxy.sizeof: "sizeof(struct mm_struct) ≈ 1KB"