layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

# --- PTRACE_PEEKDATA WORD-BY-WORD STRING EXTRACTION ---

classes: {
  tracer: {
    style: {
      fill: "#f8f9fa"
      stroke: "#6f42c1"
      stroke-width: 2
    }
  }
  tracee: {
    style: {
      fill: "#e7f3ff"
      stroke: "#007bff"
      stroke-dash: 3
    }
  }
  changed_text: {
    style: {
      font-color: red
      bold: true
    }
  }
}

step_0: {
  label: "0. INITIAL STATE"
  tracer_stack: {
    class: tracer
    label: "Tracer Context (Stack)"
    buf: "0x00 | buf: [ ] (empty) | size: 32B"
    ptr_i: "0x20 | i: 0 | size: 8B"
    ptr_addr: "0x28 | addr: 0x7ffd1000 | size: 8B"
  }
  tracee_mem: {
    class: tracee
    label: "Tracee Memory (RAM)"
    w1: "0x7ffd1000: [ / | e | t | c | / | p | a | s ]"
    w2: "0x7ffd1008: [ s | w | d | \\0 | ? | ? | ? | ? ]"
  }
}

step_1: {
  label: "1. FIRST WORD READ"
  tracer_stack: {
    class: tracer
    label: "Tracer Context"
    peek: "PEEKDATA(0x7ffd1000) -> 0x7361702f6374652f"
    extract: "bytes = (unsigned char*)&word"
    buf: |'md
      **<font color="red">0x00 | buf: [ / | e | t | c | / | p | a | s ]</font>**
    '|
    ptr_i: |'md
      **<font color="red">0x20 | i: 8</font>**
    '|
    ptr_addr: |'md
      **<font color="red">0x28 | addr: 0x7ffd1008</font>**
    '|
  }
  tracer_stack.peek -> tracer_stack.extract: "Little-Endian Parse"
  tracer_stack.extract -> tracer_stack.buf: "i < maxlen? OK"
}

step_2: {
  label: "2. SECOND WORD & TERMINATION"
  tracer_stack: {
    class: tracer
    label: "Tracer Context"
    peek: "PEEKDATA(0x7ffd1008) -> 0x0064777773"
    scan: "Scanning b=0..7"
    found: |'md
      **<font color="red">bytes[3] == '\0' !!</font>**
    '|
    buf: |'md
      **<font color="red">0x00 | buf: [ / | e | t | c | / | p | a | s | s | w | d | \0 ]</font>**
    '|
    ptr_i: |'md
      **<font color="red">0x20 | i: 11</font>**
    '|
    status: "RESULT: SUCCESS"
  }
  tracer_stack.peek -> tracer_stack.scan: "Little-Endian Parse"
  tracer_stack.scan -> tracer_stack.found: "Check each byte"
  tracer_stack.found -> tracer_stack.buf: "Terminate string"
}

# Connect steps to show flow
step_0 -> step_1: "ptrace loop iteration 1"
step_1 -> step_2: "ptrace loop iteration 2"

# Global Styles
***.style.font: mono
step_0.tracer_stack.ptr_addr.style.font-color: orange
step_1.tracer_stack.ptr_addr.style.font-color: orange
step_2.tracer_stack.ptr_i.style.font-color: orange

# Legend / Annotations
# FIX: 'near' in ELK must be a constant like 'top-left', not an object reference.
annotation: |'md
  ### ALGORITHM INVARIANTS
  1. **Address Isolation**: Tracer cannot dereference `0x7ffd1000` directly due to separate `CR3` page tables.
  2. **Word Alignment**: x86_64 `PTRACE_PEEKDATA` returns 8-byte `long`.
  3. **Endianness**: Least-significant byte of `word` is the first char in memory.
  4. **Boundary Check**: Loop must verify `i < maxlen` before writing to `buf`.
'| {
  near: top-left
}

# Role Mapping Styles
***.style.stroke: "#333333"
step_0.tracee_mem.style.stroke: "#007bff"
step_1.tracer_stack.style.stroke: "#6f42c1"
step_2.tracer_stack.style.stroke: "#6f42c1"