direction: right

vars: {
  d2-config: {
    dark-theme-id: 200
    pad: 20
  }
  primary-fill: "#1a1a2e"
  secondary-fill: "#16213e"
  accent-stroke: "#3fb950"
  text-color: "#e6edf3"
  arrow-color: "#8b949e"
  style.stroke: "#8b949e"
}

record_layer: Record Layer {
  style.fill: ${primary-fill}
  style.stroke: ${accent-stroke}
  style.font-color: ${text-color}
  style.bold: true
  
  tls_record: TLSRecord {
    shape: class
    style.fill: ${secondary-fill}
    style.stroke: ${accent-stroke}
    style.font-color: ${text-color}
    
    +content_type: u8
    +version: ProtocolVersion
    +length: u16
    +fragment: Vec<u8>
    +new(): TLSRecord
    +parse(): Result<Self>
    +serialize(): Vec<u8>
  }
}

handshake_layer: Handshake Layer {
  style.fill: ${primary-fill}
  style.stroke: ${accent-stroke}
  style.font-color: ${text-color}
  style.bold: true
  
  handshake_message: HandshakeMessage {
    shape: class
    style.fill: ${secondary-fill}
    style.stroke: ${accent-stroke}
    style.font-color: ${text-color}
    style.italic: true
    
    +msg_type: HandshakeType
    +length: u24
    +parse(): Result<Self>
    +serialize(): Vec<u8>
  }
  
  client_hello: ClientHello {
    shape: class
    style.fill: ${secondary-fill}
    style.stroke: "#f39c12"
    style.font-color: ${text-color}
    
    +random: [u8; 32]
    +session_id: Vec<u8>
    +cipher_suites: Vec<CipherSuite>
    +extensions: Extensions
  }
  
  server_hello: ServerHello {
    shape: class
    style.fill: ${secondary-fill}
    style.stroke: "#f39c12"
    style.font-color: ${text-color}
    
    +random: [u8; 32]
    +session_id: Vec<u8>
    +cipher_suite: CipherSuite
    +extensions: Extensions
  }
  
  certificate: Certificate {
    shape: class
    style.fill: ${secondary-fill}
    style.stroke: "#f39c12"
    style.font-color: ${text-color}
    
    +certificate_list: Vec<CertData>
    +extensions: Extensions
  }
  
  finished: Finished {
    shape: class
    style.fill: ${secondary-fill}
    style.stroke: "#f39c12"
    style.font-color: ${text-color}
    
    +verify_data: Vec<u8>
  }
}

cert_chain: Certificate Chain {
  style.fill: ${primary-fill}
  style.stroke: ${accent-stroke}
  style.font-color: ${text-color}
  style.bold: true
  
  certificate_chain: CertificateChain {
    shape: class
    style.fill: ${secondary-fill}
    style.stroke: ${accent-stroke}
    style.font-color: ${text-color}
    
    +certificates: Vec<X509Certificate>
    +verify(): Result<()>
    +get_public_key(): PublicKey
    +validate_chain(): Result<()>
  }
  
  x509_cert: X509Certificate {
    shape: class
    style.fill: ${secondary-fill}
    style.stroke: "#e74c3c"
    style.font-color: ${text-color}
    
    +subject: Name
    +issuer: Name
    +public_key: PublicKey
    +signature: Vec<u8>
    +validity: Validity
  }
}

connection_state: Connection State {
  style.fill: ${primary-fill}
  style.stroke: ${accent-stroke}
  style.font-color: ${text-color}
  style.bold: true
  
  tls_connection: ConnectionState {
    shape: class
    style.fill: ${secondary-fill}
    style.stroke: ${accent-stroke}
    style.font-color: ${text-color}
    
    +handshake_state: HandshakeState
    +cipher_suite: CipherSuite
    +keys: TrafficKeys
    +sequence_number: u64
    +encrypt(): Result<Vec<u8>>
    +decrypt(): Result<Vec<u8>>
    +update_keys(): Result<()>
  }
  
  traffic_keys: TrafficKeys {
    shape: class
    style.fill: ${secondary-fill}
    style.stroke: "#9b59b6"
    style.font-color: ${text-color}
    
    +client_write_key: Vec<u8>
    +server_write_key: Vec<u8>
    +client_write_iv: Vec<u8>
    +server_write_iv: Vec<u8>
  }
}

record_layer.tls_record -> handshake_layer.handshake_message: contains {
  style.stroke: ${arrow-color}
}

handshake_layer.handshake_message -> handshake_layer.client_hello: implements {
  style.stroke: "#f39c12"
  style.stroke-dash: 5
}

handshake_layer.handshake_message -> handshake_layer.server_hello: implements {
  style.stroke: "#f39c12"
  style.stroke-dash: 5
}

handshake_layer.handshake_message -> handshake_layer.certificate: implements {
  style.stroke: "#f39c12"
  style.stroke-dash: 5
}

handshake_layer.handshake_message -> handshake_layer.finished: implements {
  style.stroke: "#f39c12"
  style.stroke-dash: 5
}

handshake_layer.certificate -> cert_chain.certificate_chain: uses {
  style.stroke: ${arrow-color}
}

cert_chain.certificate_chain -> cert_chain.x509_cert: composed of {
  style.stroke: "#e74c3c"
}

handshake_layer.handshake_message -> connection_state.tls_connection: updates {
  style.stroke: ${arrow-color}
}

connection_state.tls_connection -> connection_state.traffic_keys: manages {
  style.stroke: "#9b59b6"
}