direction: down

title: Autoregressive Generation Process {
  style.font-size: 24
  style.font-color: "#e6edf3"
}

start: Start Generation {
  shape: circle
  style.fill: "#3fb950"
  style.font-color: "#000000"
  style.bold: true
}

input_prompt: Input Prompt\n(Initial Tokens) {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

process_container: Token Generation Loop {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  forward_pass: Forward Pass\n(Current Sequence) {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  logits: Generate Logits\n(Vocabulary Probs) {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  sampling_decision: Apply Sampling\nStrategy? {
    shape: diamond
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  sampling_strategies: Sampling Methods {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    
    greedy: Greedy\n(argmax)
    nucleus: Nucleus (top-p)
    topk: Top-k
    temperature: Temperature
  }
  
  select_token: Select Next Token {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  append_token: Append to Sequence {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  forward_pass -> logits
  logits -> sampling_decision
  sampling_decision -> sampling_strategies: Yes
  sampling_decision -> select_token: No (greedy)
  sampling_strategies -> select_token
  select_token -> append_token
}

kv_cache: KV Cache\n(Optimization) {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  shape: cylinder
}

stop_condition: Stop Condition\nMet? {
  shape: diamond
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

output_sequence: Generated\nText Sequence {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

end: End {
  shape: circle
  style.fill: "#3fb950"
  style.font-color: "#000000"
  style.bold: true
}

# Flow connections
start -> input_prompt
input_prompt -> process_container.forward_pass
process_container.append_token -> stop_condition
stop_condition -> process_container.forward_pass: No\n(Continue)
stop_condition -> output_sequence: Yes\n(EOS/Max Length)
output_sequence -> end

# KV Cache connections
kv_cache <-> process_container.forward_pass: Store/Retrieve\nAttention Keys & Values {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}