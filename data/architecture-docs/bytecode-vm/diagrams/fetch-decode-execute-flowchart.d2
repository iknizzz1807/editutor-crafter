title: Fetch-Decode-Execute Cycle Flowchart

classes: {
  process: {
    shape: rectangle
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    shape: diamond
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  terminal: {
    shape: oval
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

vm_loop: VM Main Loop {
  start: Start {
    class: terminal
    label: "Start VM Loop"
  }

  fetch: Fetch Opcode {
    class: process
    label: "Fetch next opcode\nfrom bytecode[IP]"
  }

  decode: Decode Instruction {
    class: process
    label: "Decode opcode\nRead operands if any"
  }

  dispatch: Dispatch Handler {
    class: process
    shape: hexagon
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    label: "Switch on opcode\nDispatch to handler"
  }

  execute: Execute Handler {
    class: process
    label: "Execute operation\nMay modify stack/IP"
  }

  check_halt: Check for HALT {
    class: decision
    label: "Opcode == HALT?"
  }

  check_error: Check for ERROR {
    class: decision
    label: "Execution error\nor invalid opcode?"
  }

  increment_ip: Increment IP {
    class: process
    label: "IP += instruction size"
  }

  halt: HALT Reached {
    class: terminal
    label: "Clean Shutdown"
  }

  error: ERROR State {
    class: terminal
    label: "Error Shutdown\nReport error"
  }
}

# Flow connections
vm_loop.start -> vm_loop.fetch: "Initialize"
vm_loop.fetch -> vm_loop.decode
vm_loop.decode -> vm_loop.dispatch
vm_loop.dispatch -> vm_loop.execute
vm_loop.execute -> vm_loop.check_halt

vm_loop.check_halt -> vm_loop.halt: Yes
vm_loop.check_halt -> vm_loop.check_error: No

vm_loop.check_error -> vm_loop.error: Yes
vm_loop.check_error -> vm_loop.increment_ip: No

vm_loop.increment_ip -> vm_loop.fetch: "Continue Loop"

# Additional notes
constants: Constant Pool {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  label: "External Resources"
}

stack: Operand Stack {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  label: "Runtime State"
}

vm_loop.execute -> constants: "Reference"
vm_loop.execute -> stack: "Push/Pop"
constants.near: top-right
stack.near: bottom-right