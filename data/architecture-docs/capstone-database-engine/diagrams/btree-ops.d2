title: "B+ Tree Insert and Page Split"
theme: {
  canvas: {
    style.fill: "#0d1117"
  }
  grid: {
    style.fill: "#0d1117"
  }
}

# Diagram 1: Initial State (Before Insert)
diagram_1: "Step 1: Initial State" {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  root_page: "Root Page (Internal)" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Root Page #100**
      Keys: [15, 30]
      Child Ptrs: [P1, P2, P3]
    |
  }

  leaf_1: "Leaf Page #200" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Leaf Page #200**
      Keys: [5, 10]
      Next: #201
    |
  }

  leaf_2: "Leaf Page #201" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Leaf Page #201**
      Keys: [15, 20, 25]
      Next: #202
    |
  }

  leaf_3: "Leaf Page #202" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Leaf Page #202**
      Keys: [30, 35, 40]
      Next: null
    |
  }

  root_page -> leaf_1: "P1"
  root_page -> leaf_2: "P2"
  root_page -> leaf_3: "P3"
  leaf_1 -> leaf_2: "next"
  leaf_2 -> leaf_3: "next"

  note: |md
    **Initial State**
    - B+ tree with root and 3 leaves
    - Order = 3 (max 3 keys per leaf)
    - Leaf #201 is full (3 keys)
    | {
      shape: page
      style.fill: "#1a1a2e"
      style.stroke: "#3fb950"
    }
}

# Diagram 2: Leaf Split During Insert
diagram_2: "Step 2: Leaf Split" {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  root_page: "Root Page (Internal)" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Root Page #100**
      Keys: [15, 30]
      Child Ptrs: [P1, P2, P3]
    |
  }

  leaf_1: "Leaf Page #200" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Leaf Page #200**
      Keys: [5, 10]
      Next: #201
    |
  }

  leaf_2_old: "Leaf Page #201 (Full)" {
    shape: page
    style.fill: "#1a3c2e"
    style.stroke: "#3fb950"
    style.bold: true
    label: |md
      **Leaf Page #201**
      Keys: [15, 20, 22, 25] ← **OVERFLOW**
      Next: #202
    |
  }

  leaf_3: "Leaf Page #202" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Leaf Page #202**
      Keys: [30, 35, 40]
      Next: null
    |
  }

  new_leaf: "New Leaf Page #203" {
    shape: page
    style.fill: "#2e1a3c"
    style.stroke: "#ff7b72"
    style.bold: true
    label: |md
      **New Leaf Page #203**
      Keys: [22, 25] ← **Split right half**
      Next: #202
    |
  }

  root_page -> leaf_1: "P1"
  root_page -> leaf_2_old: "P2"
  root_page -> leaf_3: "P3"
  leaf_1 -> leaf_2_old: "next"
  leaf_2_old -> new_leaf: "new next"
  new_leaf -> leaf_3: "next"

  note: |md
    **Insert Key 22**
    - Insert 22 into leaf #201
    - Leaf overflows (4 > 3 keys)
    - Allocate new leaf page #203
    - Split keys: [15,20] stay, [22,25] move
    | {
      shape: page
      style.fill: "#1a1a2e"
      style.stroke: "#3fb950"
    }
}

# Diagram 3: Propagate Split to Parent
diagram_3: "Step 3: Propagate to Parent" {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  root_page: "Root Page (Internal)" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Root Page #100**
      Keys: [15, 22, 30] ← **Insert 22**
      Child Ptrs: [P1, P2, P3, P4]
    |
  }

  leaf_1: "Leaf Page #200" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Leaf Page #200**
      Keys: [5, 10]
      Next: #201
    |
  }

  leaf_2: "Leaf Page #201" {
    shape: page
    style.fill: "#1a3c2e"
    style.stroke: "#3fb950"
    label: |md
      **Leaf Page #201**
      Keys: [15, 20]
      Next: #203
    |
  }

  leaf_new: "Leaf Page #203" {
    shape: page
    style.fill: "#2e1a3c"
    style.stroke: "#ff7b72"
    label: |md
      **Leaf Page #203**
      Keys: [22, 25]
      Next: #202
    |
  }

  leaf_3: "Leaf Page #202" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Leaf Page #202**
      Keys: [30, 35, 40]
      Next: null
    |
  }

  root_page -> leaf_1: "P1"
  root_page -> leaf_2: "P2"
  root_page -> leaf_new: "P3 ← New pointer"
  root_page -> leaf_3: "P4"
  
  leaf_1 -> leaf_2: "next"
  leaf_2 -> leaf_new: "next"
  leaf_new -> leaf_3: "next"

  note: |md
    **Propagate Split**
    - Copy up middle key (22) to parent
    - Update parent pointers
    - Parent now has 3 keys (still OK)
    - Leaf chain updated: 200→201→203→202
    | {
      shape: page
      style.fill: "#1a1a2e"
      style.stroke: "#3fb950"
    }
}

# Diagram 4: Root Split (Final State)
diagram_4: "Step 4: Root Split" {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  new_root: "New Root Page #300" {
    shape: page
    style.fill: "#2e1a3c"
    style.stroke: "#ff7b72"
    style.bold: true
    label: |md
      **New Root Page #300**
      Keys: [22] ← **Promoted key**
      Child Ptrs: [P1, P2]
    |
  }

  left_internal: "Internal Page #100" {
    shape: page
    style.fill: "#1a3c2e"
    style.stroke: "#3fb950"
    label: |md
      **Internal Page #100**
      Keys: [15]
      Child Ptrs: [P1, P2]
    |
  }

  right_internal: "New Internal Page #301" {
    shape: page
    style.fill: "#2e1a3c"
    style.stroke: "#ff7b72"
    label: |md
      **New Internal Page #301**
      Keys: [30]
      Child Ptrs: [P1, P2]
    |
  }

  leaf_1: "Leaf Page #200" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Leaf Page #200**
      Keys: [5, 10]
      Next: #201
    |
  }

  leaf_2: "Leaf Page #201" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Leaf Page #201**
      Keys: [15, 20]
      Next: #203
    |
  }

  leaf_3: "Leaf Page #203" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Leaf Page #203**
      Keys: [22, 25]
      Next: #202
    |
  }

  leaf_4: "Leaf Page #202" {
    shape: page
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    label: |md
      **Leaf Page #202**
      Keys: [30, 35, 40]
      Next: null
    |
  }

  # Connections
  new_root -> left_internal: "P1"
  new_root -> right_internal: "P2"
  
  left_internal -> leaf_1: "P1"
  left_internal -> leaf_2: "P2"
  
  right_internal -> leaf_3: "P1"
  right_internal -> leaf_4: "P2"
  
  # Leaf chain
  leaf_1 -> leaf_2: "next"
  leaf_2 -> leaf_3: "next"
  leaf_3 -> leaf_4: "next"

  note: |md
    **Root Split (After further inserts)**
    - Root page #100 overflowed
    - Allocated new root #300
    - Promoted middle key (22) to new root
    - Split old root into #100 and #301
    - Tree height increased from 2 to 3
    | {
      shape: page
      style.fill: "#1a1a2e"
      style.stroke: "#3fb950"
    }
}

# Flow sequence
diagram_1 -> diagram_2: "Insert key 22" {
  style.stroke: "#3fb950"
}
diagram_2 -> diagram_3: "Leaf split & propagate" {
  style.stroke: "#3fb950"
}
diagram_3 -> diagram_4: "Root overflow & split" {
  style.stroke: "#3fb950"
}