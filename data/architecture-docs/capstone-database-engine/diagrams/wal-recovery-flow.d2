title: Flowchart: WAL-Based Crash Recovery

recovery: {
  shape: rectangle
  label: "Crash Detected"
  style: {
    bold: true
    fill: "#0f3460"
    font-color: "#ffffff"
    stroke: "#3fb950"
  }
}
recovery -> find_checkpoint: "Start Recovery"

find_checkpoint: {
  label: "Identify Last Checkpoint Record"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
  }
}
find_checkpoint -> read_wal

read_wal: {
  label: "Read WAL Records from Checkpoint Onward"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
  }
}
read_wal -> analysis_pass

analysis_pass: {
  label: "Analysis Pass\nBuild Dirty Page Table & Active Transaction List"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
  }
}
analysis_pass -> redo_start

redo_start: {
  label: "Start Redo Pass"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
  }
}
redo_start -> redo_decision

redo_decision: {
  label: "More WAL records to process?"
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: "#e6edf3"
    stroke: "#8b949e"
  }
}

redo_decision -> redo_check: "Yes" {
  style.stroke: "#3fb950"
}
redo_decision -> undo_start: "No" {
  style.stroke: "#3fb950"
}

redo_check: {
  label: "Next Record Type?"
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: "#e6edf3"
    stroke: "#8b949e"
  }
}

redo_check -> update_redo: "UPDATE" {
  style.stroke: "#8b949e"
}
redo_check -> commit_redo: "COMMIT" {
  style.stroke: "#8b949e"
}
redo_check -> abort_redo: "ABORT" {
  style.stroke: "#8b949e"
}
redo_check -> checkpoint_redo: "CHECKPOINT" {
  style.stroke: "#8b949e"
}
redo_check -> redo_next: "Other" {
  style.stroke: "#8b949e"
}

update_redo: {
  label: "Check if page in dirty table\nand needs redo (LSN comparison)"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
    stroke-width: 2
  }
}
update_redo -> redo_apply_check

redo_apply_check: {
  label: "Apply update?"
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: "#e6edf3"
    stroke: "#8b949e"
  }
}

redo_apply_check -> apply_update: "Yes (needs redo)" {
  style.stroke: "#3fb950"
}
redo_apply_check -> redo_next: "No (already applied)" {
  style.stroke: "#3fb950"
}

apply_update: {
  label: "Reapply update to page\nUpdate page LSN"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
    stroke-width: 2
  }
}
apply_update -> redo_next

commit_redo: {
  label: "Mark transaction as committed\nRemove from active list"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
  }
}
commit_redo -> redo_next

abort_redo: {
  label: "Add to undo list\nif not already there"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
  }
}
abort_redo -> redo_next

checkpoint_redo: {
  label: "Ignore (already processed in analysis)"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
  }
}
checkpoint_redo -> redo_next

redo_next: {
  label: "Advance to next WAL record"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
  }
}
redo_next -> redo_decision: "Loop"

undo_start: {
  label: "Start Undo Pass (reverse scan)"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
  }
}
undo_start -> undo_decision

undo_decision: {
  label: "More transactions in undo list?"
  shape: diamond
  style: {
    fill: "#1a1a2e"
    font-color: "#e6edf3"
    stroke: "#8b949e"
  }
}

undo_decision -> undo_check: "Yes" {
  style.stroke: "#3fb950"
}
undo_decision -> finalize: "No" {
  style.stroke: "#3fb950"
}

undo_check: {
  label: "Process transaction's records\nbackwards until BEGIN"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
    stroke-width: 2
  }
}
undo_check -> undo_per_record

undo_per_record: {
  label: "For each UPDATE record:\nWrite CLR (Compensation Log Record)\nUndo the update"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
    stroke-width: 2
  }
}
undo_per_record -> undo_write_end

undo_write_end: {
  label: "Write transaction ABORT record"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
  }
}
undo_write_end -> undo_next_transaction

undo_next_transaction: {
  label: "Remove transaction from undo list"
  shape: rectangle
  style: {
    fill: "#16213e"
    font-color: "#e6edf3"
  }
}
undo_next_transaction -> undo_decision: "Loop"

finalize: {
  label: "Finalize Recovery\n- Flush all pages\n- Write recovery completion record\n- Resume normal operations"
  shape: rectangle
  style: {
    bold: true
    fill: "#0f3460"
    font-color: "#ffffff"
    stroke: "#3fb950"
  }
}
finalize -> complete

complete: {
  label: "Recovery Complete"
  shape: rectangle
  style: {
    bold: true
    fill: "#0f3460"
    font-color: "#ffffff"
    stroke: "#3fb950"
  }
}