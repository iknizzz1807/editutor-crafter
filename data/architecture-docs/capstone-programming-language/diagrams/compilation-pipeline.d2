# Complete Compilation Pipeline
direction: right

# Input
source: Source Code {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Lexer Stage
lexer: Lexical Analysis {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  tokenizer: Tokenizer
  tokens: Token Stream {
    shape: queue
  }
  
  tokenizer -> tokens
}

# Parser Stage
parser: Syntax Analysis {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  grammar: Parser
  ast: AST {
    shape: page
  }
  
  grammar -> ast
}

# Type Checker Stage
typechecker: Type Checker {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  inference: Type Inference
  symbols: Symbol Table {
    shape: sql_table
  }
  typed_ast: Typed AST {
    shape: page
  }
  
  inference -> symbols
  inference -> typed_ast
}

# Compiler Stage
compiler: Bytecode Compiler {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  codegen: Code Generator
  optimizer: Optimizer
  bytecode: Bytecode {
    shape: cylinder
  }
  
  codegen -> optimizer
  optimizer -> bytecode
}

# VM Stage
vm: Virtual Machine {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  executor: Executor
  stack: Runtime Stack {
    shape: queue
  }
  gc: Garbage Collector {
    shape: circle
  }
  output: Program Output {
    shape: page
  }
  
  executor -> stack
  executor -> gc
  executor -> output
}

# Main flow connections
source -> lexer.tokenizer: Raw text
lexer.tokens -> parser.grammar: Tokens
parser.ast -> typechecker.inference: Untyped AST
typechecker.typed_ast -> compiler.codegen: Typed AST
compiler.bytecode -> vm.executor: Bytecode instructions
vm.output: Result

# Data transformation labels
lexer -> parser: {
  style.stroke: "#8b949e"
  style.font-color: "#8b949e"
}

parser -> typechecker: {
  style.stroke: "#8b949e"
  style.font-color: "#8b949e"
}

typechecker -> compiler: {
  style.stroke: "#8b949e"
  style.font-color: "#8b949e"
}

compiler -> vm: {
  style.stroke: "#8b949e"
  style.font-color: "#8b949e"
}