shape: sequence_diagram
title: Sequence Diagram: Normal Event Delivery

Source_DB: Source DB {
  class: actor_style
}
Log_Parser: Log Parser {
  class: component_style
}
Event_Builder: Event Builder {
  class: component_style
}
Event_Streamer: Event Streamer (Kafka Producer) {
  class: component_style
}
Kafka_Cluster: Kafka Cluster {
  class: kafka_style
}
Consumer: Consumer {
  class: consumer_style
}

# Sequence of events
Source_DB -> Log_Parser: Transaction Log Entry (after COMMIT)
Log_Parser -> Event_Builder: Raw Change Data
Event_Builder -> Event_Streamer: Validated ChangeEvent
Event_Streamer -> Kafka_Cluster: "send event (with partition key)"
note: Critical for at-least-once: Wait for acknowledgment before marking event as sent {
  near: center-right
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
Kafka_Cluster -> Event_Streamer: "ack (successful write to topic partition)"
note: Event safely persisted in Kafka {
  near: center-right
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}
Event_Streamer -> Event_Builder: "Acknowledged (can advance log position)"
Kafka_Cluster -> Consumer: "Event available (poll)"
Consumer -> Consumer: "Process ChangeEvent"
Consumer -> Kafka_Cluster: "commit offset"
note: Critical for at-least-once: Offset commit ensures no re-processing on restart {
  near: center-right
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

# Style definitions
classes: {
  actor_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  component_style: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  kafka_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  consumer_style: {
    style.fill: "#16213e"
    style.stroke: "#ff7b72"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}