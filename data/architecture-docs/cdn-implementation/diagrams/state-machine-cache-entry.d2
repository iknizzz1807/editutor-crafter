direction: right

classes: {
  state_style: {
    shape: circle
    style.font-color: "#e6edf3"
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    width: 140
    height: 140
  }
  final_state: {
    style.double-border: true
  }
  initial_state: {
    shape: circle
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    width: 24
    height: 24
    label: ""
  }
  transition_style: {
    style.font-color: "#8b949e"
    style.stroke: "#8b949e"
  }
  important_event: {
    style.font-color: "#fcc6b5"
    style.stroke: "#fcc6b5"
    style.bold: true
  }
}

init: {
  class: initial_state
  near: top-left
}

# States
MISS: Cache Miss {
  class: state_style
  style.stroke: "#f85149"
}

FRESH: Fresh (Cached) {
  class: state_style
  style.stroke: "#3fb950"
}

STALE: Stale (Expired) {
  class: state_style
  style.stroke: "#d29922"
}

REVALIDATING: Revalidating {
  class: state_style
  style.stroke: "#a371f7"
}

# Transitions from initial state
init -> MISS: "First Request"

# Normal flow transitions
MISS -> FRESH: "Origin Fetch Success\n[Set TTL]" {
  class: transition_style
}

FRESH -> STALE: "TTL Expiry" {
  class: transition_style
}

STALE -> REVALIDATING: "Request Arrives\n[Background Revalidation]" {
  class: transition_style
}

REVALIDATING -> FRESH: "Revalidation Success\n[Update Cache, Reset TTL]" {
  class: transition_style
}

# Alternative transitions
REVALIDATING -> MISS: "Revalidation Failed\n[Origin Error/404]" {
  class: important_event
}

# Purge transitions (from any state to MISS)
FRESH -> MISS: "Purge Request" {
  class: important_event
  style.stroke-dash: 3
}

STALE -> MISS: "Purge Request" {
  class: important_event
  style.stroke-dash: 3
}

REVALIDATING -> MISS: "Purge Request\n[Cancel Revalidation]" {
  class: important_event
  style.stroke-dash: 3
}

# Stale serving transition
STALE -> STALE: "Request Served Stale\n[Async Revalidation]" {
  class: transition_style
  source-arrowhead: "{shape: diamond}"
  target-arrowhead: "{shape: diamond}"
}

# Self transition for cache hits
FRESH -> FRESH: "Cache Hit\n[TTL Reset]" {
  class: transition_style
  source-arrowhead: "{shape: diamond}"
  target-arrowhead: "{shape: diamond}"
}