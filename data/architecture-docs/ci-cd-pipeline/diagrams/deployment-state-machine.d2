# Deployment State Machine

# State definitions
init: {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  label: ""
}

preparing: Preparing {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

health_checking: Health Checking {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

traffic_shifting: Traffic Shifting {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

monitoring: Monitoring {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

deployed: Deployed {
  shape: circle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.double-border: true
}

rollback: Rollback {
  shape: circle
  style.fill: "#d63031"
  style.stroke: "#e17055"
  style.font-color: "#ffffff"
}

failed: Failed {
  shape: circle
  style.fill: "#d63031"
  style.stroke: "#e17055"
  style.font-color: "#ffffff"
  style.double-border: true
}

# State transitions
init -> preparing: Start Deployment

preparing -> health_checking: Resources Ready
preparing -> failed: Preparation Failed

health_checking -> traffic_shifting: Health Check Passed
health_checking -> rollback: Health Check Failed

traffic_shifting -> monitoring: Traffic Shifted
traffic_shifting -> rollback: Traffic Shift Failed

monitoring -> deployed: Metrics Stable
monitoring -> rollback: Performance Degraded

rollback -> failed: Rollback Complete

# Self-loops for ongoing processes
monitoring -> monitoring: Continue Monitoring {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}

rollback -> rollback: Rolling Back {
  style.stroke: "#e17055"
  style.stroke-dash: 3
}

# Notes for key decision points
health_note: |md
  **Health Check Criteria:**
  - Service responds to readiness probe
  - Database connections healthy  
  - Required dependencies available
| {
  shape: page
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: health_checking
}

monitor_note: |md
  **Monitoring Triggers:**
  - Error rate > threshold
  - Response time degradation
  - Resource exhaustion
| {
  shape: page
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: monitoring
}