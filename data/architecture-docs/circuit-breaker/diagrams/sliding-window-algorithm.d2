title: Sliding Window Algorithm Flow

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  data: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  arrow: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

start: Start {
  shape: circle
  style.fill: "#3fb950"
  style.font-color: "#ffffff"
  label: ""
}

incoming_request: Incoming Request {
  shape: rectangle
  class: process
}

check_time: Check Current Time {
  shape: rectangle
  class: process
}

bucket_expired: Bucket Expired? {
  shape: diamond
  class: decision
}

rotate_bucket: Rotate Bucket {
  shape: rectangle
  class: process
}

create_new_bucket: Create New Bucket {
  shape: rectangle
  class: process
}

discard_old: Discard Oldest Bucket {
  shape: rectangle
  class: process
}

record_request: Record Request in Current Bucket {
  shape: rectangle
  class: process
}

execute_request: Execute Request {
  shape: rectangle
  class: process
}

record_outcome: Record Success/Failure {
  shape: rectangle
  class: process
}

calculate_metrics: Calculate Failure Rate Across Window {
  shape: rectangle
  class: process
}

threshold_check: Failure Rate > Threshold? {
  shape: diamond
  class: decision
}

sufficient_data: Sufficient Request Volume? {
  shape: diamond
  class: decision
}

open_circuit: Open Circuit {
  shape: rectangle
  style.fill: "#d63031"
  style.stroke: "#e17055"
  style.font-color: "#ffffff"
  style.bold: true
}

keep_closed: Keep Circuit Closed {
  shape: rectangle
  style.fill: "#00b894"
  style.stroke: "#00cec9"
  style.font-color: "#ffffff"
  style.bold: true
}

window_data: Sliding Window {
  shape: rectangle
  class: data
  label: "Buckets: [T-4, T-3, T-2, T-1, T]"
}

start -> incoming_request: {class: arrow}
incoming_request -> check_time: {class: arrow}
check_time -> bucket_expired: {class: arrow}
bucket_expired -> rotate_bucket: Yes {class: arrow}
bucket_expired -> record_request: No {class: arrow}
rotate_bucket -> create_new_bucket: {class: arrow}
create_new_bucket -> discard_old: {class: arrow}
discard_old -> record_request: {class: arrow}
record_request -> execute_request: {class: arrow}
execute_request -> record_outcome: {class: arrow}
record_outcome -> calculate_metrics: {class: arrow}
calculate_metrics -> sufficient_data: {class: arrow}
sufficient_data -> threshold_check: Yes {class: arrow}
sufficient_data -> keep_closed: No {class: arrow}
threshold_check -> open_circuit: Yes {class: arrow}
threshold_check -> keep_closed: No {class: arrow}

calculate_metrics <-> window_data: Read Metrics {class: arrow; style.stroke-dash: 3}