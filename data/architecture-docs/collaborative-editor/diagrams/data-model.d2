classes: {
  operation_class: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  document_class: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  user_class: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  relationship: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

title: Data Model Relationships {
  style.font-size: 20
  style.font-color: "#e6edf3"
  style.bold: true
  near: top-center
}

Operation: {
  shape: class
  class: operation_class
  - "id: string"
  - "type: OperationType"
  - "position: number"
  - "content: string"
  - "timestamp: number"
  - "author_id: string"
  - "vector_clock: VectorClock"
  + "apply(document: Document): Document"
  + "transform(other: Operation): Operation"
  + "is_noop(): boolean"
}

OperationType: {
  shape: class
  class: operation_class
  - "INSERT: insert"
  - "DELETE: delete"
  - "RETAIN: retain"
  - "NOOP: noop"
}

Document: {
  shape: class
  class: document_class
  - "content: string"
  - "version: number"
  - "history: Operation[]"
  - "state: DocumentState"
  - "last_modified: timestamp"
  + "apply_operation(op: Operation): Document"
  + "get_operations_since(version: number): Operation[]"
  + "merge_state(other: Document): Document"
}

DocumentState: {
  shape: class
  class: document_class
  - "CLEAN: clean"
  - "DIRTY: dirty"
  - "SYNCING: syncing"
  - "CONFLICT: conflict"
}

UserMetadata: {
  shape: class
  class: user_class
  - "user_id: string"
  - "display_name: string"
  - "color: string"
  - "avatar_url: string"
  - "last_seen: timestamp"
  - "is_online: boolean"
  + "update_presence(): void"
  + "get_display_info(): DisplayInfo"
}

CursorPosition: {
  shape: class
  class: user_class
  - "user_id: string"
  - "position: number"
  - "selection_start: number"
  - "selection_end: number"
  - "timestamp: number"
  + "transform_by_operation(op: Operation): CursorPosition"
  + "is_selection(): boolean"
  + "get_range(): Range"
}

VectorClock: {
  shape: class
  class: operation_class
  - "clocks: Map<string, number>"
  + "increment(site_id: string): void"
  + "compare(other: VectorClock): Ordering"
  + "merge(other: VectorClock): VectorClock"
}

Operation -> OperationType: uses {
  class: relationship
}

Operation -> VectorClock: contains {
  class: relationship
}

Operation -> UserMetadata: authored_by {
  class: relationship
}

Document -> DocumentState: has_state {
  class: relationship
}

Document -> Operation: contains_history {
  class: relationship
  label: "1..*"
}

UserMetadata -> CursorPosition: has_cursor {
  class: relationship
  label: "1..1"
}

CursorPosition -> Operation: transforms_with {
  class: relationship
}