direction: right

# Style classes
classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950" 
    style.font-color: "#e6edf3"
  }
  data: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  critical: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

# Main flow
start: User Triggers Undo {
  shape: circle
  class: critical
}

capture: Capture Current Operation {
  class: process
}

generate: Generate Inverse Operation {
  class: process
}

check_concurrent: Check for Concurrent Edits {
  shape: diamond
  class: decision
}

transform_needed: Transform Inverse Operation {
  class: critical
}

apply_inverse: Apply Inverse Operation {
  class: process
}

broadcast: Broadcast Inverse to Other Users {
  class: process
}

update_history: Update Operation History {
  class: process
}

sync_state: Synchronize Editor State {
  class: process
}

complete: Undo Complete {
  shape: circle
  class: critical
}

# Data stores
op_history: Operation History {
  shape: cylinder
  class: data
}

vector_clock: Vector Clock State {
  shape: cylinder
  class: data
}

# Concurrent edit handling
concurrent_ops: Incoming Concurrent Ops {
  shape: queue
  class: data
}

transform_engine: OT Transform Engine {
  class: critical
}

# Main flow connections
start -> capture
capture -> generate
generate -> check_concurrent

check_concurrent -> apply_inverse: No Conflicts
check_concurrent -> transform_needed: Conflicts Detected

transform_needed -> transform_engine
transform_engine -> apply_inverse

apply_inverse -> broadcast
broadcast -> update_history
update_history -> sync_state
sync_state -> complete

# Data connections
capture -> op_history: Read Last Op
generate -> vector_clock: Check Timestamps
update_history -> op_history: Store Inverse
check_concurrent -> concurrent_ops: Check Queue

# Concurrent operation flow
concurrent_ops -> transform_engine: Concurrent Edits
transform_engine -> sync_state: Transformed Ops

# Labels on key edges
check_concurrent -> apply_inverse: {
  style.stroke: "#3fb950"
  style.bold: true
}

check_concurrent -> transform_needed: {
  style.stroke: "#e17055"
  style.bold: true
}