direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 3
  }
}

kernel_vfs: "Linux Kernel: VFS Capability Scoping (kernel/capability.c)" {
  direction: down

  calling_process: {
    shape: sql_table
    label: "struct task_struct (linux/sched.h)"
    f0: "0x00 | pid_t       | pid // e.g., 47832"
    f1: "0x20 | struct cred* | cred // mapped UID/GID"
    f2: "0x48 | nsproxy*     | nsproxy // namespace links"
    sz: "Total: ~7 KB (Task Descriptor)"
  }

  ns_capable_logic: {
    label: "ns_capable() Logic Gate"
    code: |'c
      bool ns_capable(struct user_namespace *ns, int cap) {
        if (security_capable(ns, cap) != 0) return false;
        // check if 'current' has 'cap' in 'ns' or its parents
        return has_capability(current, ns, cap);
      }
    '|
    width: 450
  }

  user_ns_hierarchy: {
    direction: right
    label: "User Namespace Ownership Tree"
    
    initial_ns: {
      shape: sql_table
      label: "Initial User NS (Host)"
      u0: "0x00 | uid_t | root (0)"
      u1: "0x04 | uid_t | user (1000)"
      lvl: "Level: 0 (Root)"
    }

    child_ns: {
      shape: sql_table
      label: "Child User NS (Container)"
      u0: "0x00 | uid_t | mapped_root (0)"
      u1: "0x04 | uid_t | host_user (1000)"
      lvl: "Level: 1 (Owned by Initial NS)"
    }

    child_ns -> initial_ns: "parent_ptr | 8 bytes | &init_user_ns" {
      style.stroke-dash: 3
    }
  }

  resource_targets: {
    direction: right
    label: "Target Resources for mount() call"

    container_mnt_ns: {
      shape: sql_table
      label: "Container Mount NS"
      owner: "Owner: Child User NS"
      root: "/ (isolated root)"
      style.fill: "#eaffea"
    }

    host_dev_sda: {
      shape: sql_table
      label: "Host Device /dev/sda1"
      owner: "Owner: Initial User NS"
      perm: "Requires Global CAP_SYS_ADMIN"
      style.fill: "#ffeaea"
    }
  }

  # Logic Path A: SUCCESS
  calling_process -> ns_capable_logic: "syscall | SYS_mount | {source, target, type}"
  ns_capable_logic -> resource_targets.container_mnt_ns: "Check Scope | 1 bit | ALLOWED" {
    style: {
      stroke: green
      stroke-width: 3
    }
  }

  # Logic Path B: FAILURE
  ns_capable_logic -> resource_targets.host_dev_sda: "Check Scope | 1 bit | DENIED (EPERM)" {
    style: {
      stroke: red
      stroke-width: 3
    }
  }
}

legend: {
  shape: package
  label: "Security Boundary Legend"
  success: "Green Path: Capability scoped to local namespace" {
    style.font-color: green
  }
  fail: "Red Path: Capability escape to host resource blocked" {
    style.font-color: red
  }
}

legend.near: bottom-right

# Annotations
kernel_vfs.calling_process -> kernel_vfs.user_ns_hierarchy.child_ns: "belongs_to | 8 bytes | task->cred->user_ns"
kernel_vfs.resource_targets.container_mnt_ns -> kernel_vfs.user_ns_hierarchy.child_ns: "owned_by | 8 bytes | mnt_ns->user_ns"
kernel_vfs.resource_targets.host_dev_sda -> kernel_vfs.user_ns_hierarchy.initial_ns: "owned_by | 8 bytes | device->user_ns"