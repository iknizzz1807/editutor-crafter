direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- CHROOT ISOLATION (VULNERABLE) ---
chroot_mechanism: {
  label: "chroot(2) - Weak Path Resolution"
  direction: down

  process_state: {
    shape: sql_table
    label: "struct task_struct (kernel memory)"
    f0: "0x00 | fs_struct* | fs // filesystem info"
    f1: "fs->root | path | /host/container_root"
    f2: "fs->pwd  | path | /"
    info: "Isolation: Process-local pointer change only"
  }

  escape_logic: {
    label: "Double-Chroot Escape Sequence"
    code: |'c
      mkdir("temp", 0755);
      chroot("temp"); // root moves to /temp
      for(int i=0; i<255; i++) chdir(".."); 
      // ".." traversal works because mount 
      // namespace still contains host root
      chroot("."); // root is now host /
    '|
    width: 350
  }

  host_fs: {
    label: "Host Filesystem (Shared Mount Namespace)"
    root: "/" {
      etc: "/etc"
      bin: "/bin"
      cont: "/host/container_root" {
        temp: "/temp"
      }
    }
  }

  process_state.f1 -> host_fs.root.cont: "restricted view"
  escape_logic -> host_fs.root.cont.temp: "1. mkdir/chroot"
  escape_logic -> host_fs.root: "2. chdir(..) escape to REAL root"
}

# --- PIVOT_ROOT ISOLATION (SECURE) ---
pivot_mechanism: {
  label: "pivot_root(2) + umount2 - Hard Boundary"
  direction: down

  mnt_namespace: {
    shape: sql_table
    label: "struct mnt_namespace (Private Copy)"
    m0: "ID: 4026532840 | Inode Number"
    m1: "root | struct mount* | points to NEW_ROOT"
    m2: "old_root | struct mount* | NULL (DETACHED)"
    info: "Isolation: Mount table modification"
  }

  isolation_logic: {
    label: "Secure Initialization (runc/containerd)"
    code: |'c
      mount(rootfs, rootfs, NULL, MS_BIND, NULL);
      syscall(SYS_pivot_root, rootfs, old_root);
      chdir("/");
      umount2(old_root, MNT_DETACH);
      // Host root is physically removed 
      // from the process's mount table.
    '|
    width: 380
  }

  isolated_fs: {
    label: "Container Filesystem (Isolated Mount Namespace)"
    root: "/" {
      bin: "/bin"
      proc: "/proc"
      etc: "/etc"
    }
    dead_path: "HOST_ROOT" {
      style.stroke-dash: 5
      style.opacity: 0.3
    }
  }

  mnt_namespace.m1 -> isolated_fs.root: "new root mount"
  mnt_namespace.m2 -> isolated_fs.dead_path: "MNT_DETACH | Invalidated" {
    style.stroke: red
  }
}

# --- CONNECTIONS & ANNOTATIONS ---
chroot_mechanism -> pivot_mechanism: "Security Evolution" {
  style.stroke-width: 4
}

comparison_note: {
  shape: callout
  label: |md
    ### The Critical Difference
    **chroot** only updates the starting point of path resolution for one process. 
    The host root is still 'present' in the mount namespace.

    **pivot_root** reconfigures the **Mount Namespace** itself. 
    By unmounting the old root, the host filesystem becomes unreachable via any path (no '..' escape possible).
  |
  near: top-center
}

legend: {
  near: bottom-right
  vulnerable: "Vulnerable Path" {
    style.stroke: red
    style.stroke-dash: 3
  }
  secure: "Secure Boundary" {
    style.stroke: green
    style.stroke-width: 2
  }
}