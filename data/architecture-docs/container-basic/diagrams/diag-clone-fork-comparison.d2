direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- STYLES AND CLASSES ---
classes: {
  syscall_card: {
    shape: class
    style: {
      stroke-width: 2
      border-radius: 4
    }
  }
  logic_step: {
    shape: rectangle
    style: {
      fill: "#f8f9fa"
      stroke-dash: 0
    }
  }
  highlight: {
    style: {
      fill: "#e7f3ff"
      stroke: "#007bff"
      bold: true
    }
  }
}

# --- COMPARISON COLUMNS ---

fork_approach: {
  label: "Traditional fork()"
  direction: down

  signature: {
    class: syscall_card
    label: "unistd.h"
    methods: |'c
      pid_t fork(void);
    '|
  }

  process_tree: {
    label: "Process State"
    step1: "Parent (PID 100)"
    step1 -> step2: "fork() | 0 bytes | syscall"
    step2: "Child (PID 101)"
    
    notes: |md
      - **Namespaces**: Exact copy of parent.
      - **Memory**: Copy-on-Write (COW) pages.
      - **File Descriptors**: Shared offsets.
    |
  }
}

clone_approach: {
  label: "Container clone() - ATOMIC"
  direction: down

  signature: {
    class: syscall_card
    label: "sched.h"
    methods: |'c
      int clone(int (*fn)(void *), 
                void *child_stack, 
                int flags, 
                void *arg);
    '|
  }

  stack_setup: {
    shape: sql_table
    label: "Stack Allocation (mmap.h)"
    row0: "0x00 | void* | addr (NULL)"
    row1: "0x08 | size_t | STACK_SIZE (1MB)"
    row2: "0x10 | int | PROT_READ | PROT_WRITE"
    row3: "0x18 | int | MAP_PRIVATE | MAP_ANONYMOUS | MAP_STACK"
    ptr: "arg: stack + STACK_SIZE (High Addr)"
  }

  execution: {
    label: "Namespace Transition"
    logic: |'c
      // Atomic Creation
      flags = CLONE_NEWPID | CLONE_NEWNS | 
              CLONE_NEWNET | SIGCHLD;
      
      pid = clone(container_fn, stack_top, flags, &cfg);
    '|
    
    state: {
      label: "Resulting View"
      style.fill: "#d4edda"
      p1: "Child is PID 1"
      p2: "New Mount Table"
      p3: "Private Net Stack"
    }
  }
  
  stack_setup -> execution: "stack_top | 8 bytes | 0x7fffffffe000"
}

unshare_approach: {
  label: "unshare() + fork() - STEPWISE"
  direction: down

  signature: {
    class: syscall_card
    label: "sched.h / unistd.h"
    methods: |'c
      int unshare(int flags);
      pid_t fork(void);
    '|
  }

  logic_flow: {
    step1: {
      label: "1. unshare(CLONE_NEWPID)"
      code: "Current process modifies nsproxy"
    }
    step2: {
      label: "2. fork()"
      code: "Child enters namespaces"
    }
    
    step1 -> step2: "Next child | - | Implicit"
    
    warning: {
      shape: callout
      label: "CRITICAL: Parent stays in old PID namespace. Only children enter new PID NS."
      style.fill: "#fff3cd"
    }
  }
}

# --- CROSS-COLUMN CONNECTORS ---

clone_approach.execution -> fork_approach.process_tree: "Comparison | - | fork() is clone(SIGCHLD)" {
  style.stroke-dash: 5
}

legend: {
  near: bottom-right
  shape: sql_table
  label: "Kernel Copy Semantics"
  v1: "CLONE_NEWNS | Copy mount table"
  v2: "CLONE_NEWPID | Create empty PID map"
  v3: "SIGCHLD | Signal parent on exit"
}

# --- HARDWARE STACK ILLUSTRATION ---

stack_direction: {
  near: top-right
  shape: rectangle
  label: "x86_64 Stack Growth"
  
  mem_map: {
    shape: sql_table
    high: "0x7FFFFFFFFFFF | [High] stack_top"
    growth: "  â†“  | [Growth Direction]"
    low: "0x7FFFFFFF0000 | [Low] stack_bottom"
  }
  
  note: "clone() arg points to 'high'"
}