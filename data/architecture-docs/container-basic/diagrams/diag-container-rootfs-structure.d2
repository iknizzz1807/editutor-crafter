direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# Root Filesystem Blueprint (Milestone 2 & 5)
container_rootfs: {
  label: "Container Rootfs Layout (rootfs/)"
  
  root: {
    shape: sql_table
    label: "0x00 | / (Root Directory)"
    type: "Type: ext4 / overlayfs"
    source: "Source: Image Layer / Host Dir"
    flags: "Flags: MS_BIND | MS_REC (pre-pivot)"
    perm: "Perms: 0755"
  }

  bin_lib: {
    label: "System Binaries & Runtime"
    
    bin: {
      shape: sql_table
      label: "/bin & /usr/bin"
      src: "Source: Rootfs Image"
      content: "Executables: sh, ls, ip, ps"
      link: "Type: Symlink or Dir"
    }

    lib: {
      shape: sql_table
      label: "/lib & /lib64"
      src: "Source: Rootfs Image"
      content: "Shared Objects: libc.so.6, ld-linux.so"
      usage: "Requirement: Dynamic Linking"
    }
  }

  kernel_interfaces: {
    label: "Pseudo-Filesystems (Kernel Interfaces)"
    
    proc: {
      shape: sql_table
      label: "/proc (procfs)"
      type: "Type: proc"
      flags: "Flags: MS_NOSUID | MS_NOEXEC | MS_NODEV"
      isolation: "Scope: Current PID Namespace"
      code: |'c
        mount("proc", "/proc", "proc", 
              MS_NOSUID|MS_NOEXEC|MS_NODEV, NULL);
      '|
    }

    sys: {
      shape: sql_table
      label: "/sys (sysfs)"
      type: "Type: sysfs"
      flags: "Flags: MS_NOSUID | MS_NOEXEC | MS_NODEV | MS_RDONLY"
      isolation: "Scope: Global (Filtered by UserNS)"
      code: |'c
        mount("sysfs", "/sys", "sysfs", 
              MS_RDONLY|MS_NOSUID|MS_NOEXEC, NULL);
      '|
    }
  }

  devices: {
    label: "Device Nodes (/dev)"
    
    dev_root: {
      shape: sql_table
      label: "/dev (tmpfs)"
      type: "Type: tmpfs"
      source: "Source: Kernel RAM"
      size: "Limit: 64MB (mode=755)"
    }

    null: {
      shape: sql_table
      label: "/dev/null (1,3)"
      type: "Character Device"
      method: "Host Bind-Mount"
      target: "host:/dev/null"
    }

    urandom: {
      shape: sql_table
      label: "/dev/urandom (1,9)"
      type: "Character Device"
      method: "Host Bind-Mount"
      target: "host:/dev/urandom"
    }
  }

  config: {
    label: "Identity & Configuration"
    
    etc: {
      shape: sql_table
      label: "/etc (Directory)"
      resolv: "File: resolv.conf (DNS)"
      hosts: "File: hosts (Local Networking)"
      passwd: "File: passwd (UID 0 Mapping)"
    }
    
    tmp: {
      shape: sql_table
      label: "/tmp (Directory)"
      type: "Type: Local Dir / tmpfs"
      perm: "Perms: 1777 (Sticky Bit)"
    }
  }
}

# Connections defining the hierarchy and mount semantics
container_rootfs.root -> container_rootfs.bin_lib.bin: "Path | 0755 | Static Image Content"
container_rootfs.root -> container_rootfs.bin_lib.lib: "Path | 0755 | Linker & Libraries"

container_rootfs.root -> container_rootfs.kernel_interfaces.proc: "Mount | MS_NODEV | Kernel State" {
  style.stroke: "#88DCF7"
}
container_rootfs.root -> container_rootfs.kernel_interfaces.sys: "Mount | MS_RDONLY | Hardware Info" {
  style.stroke: "#88DCF7"
}

container_rootfs.root -> container_rootfs.devices.dev_root: "Mount | tmpfs | Staging for Nodes"
container_rootfs.devices.dev_root -> container_rootfs.devices.null: "Bind | char 1,3 | Sink" {
  style.stroke: "#B5AFF6"
}
container_rootfs.devices.dev_root -> container_rootfs.devices.urandom: "Bind | char 1,9 | Entropy" {
  style.stroke: "#B5AFF6"
}

container_rootfs.root -> container_rootfs.config.etc: "Path | 0755 | Local Config"
container_rootfs.root -> container_rootfs.config.tmp: "Path | 1777 | Ephemeral Storage"

legend: {
  shape: sql_table
  near: bottom-right
  item1: "Blue Border | Pseudo-Filesystem (Kernel Memory)"
  item2: "Purple Border | Host Bind-Mount (Resource Inheritance)"
  item3: "Black Border | Persistent Image Content"
}
legend.item1.style.stroke: "#88DCF7"
legend.item2.style.stroke: "#B5AFF6"