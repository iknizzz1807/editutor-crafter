direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: "Mount Propagation Evolution (fs/namespace.c)" {
  shape: rectangle
  style: {
    fill: "#f8f9fa"
    stroke-width: 2
    bold: true
  }
}

# Scenario 1: MS_SHARED
shared_mode: {
  label: "Scenario 1: MS_SHARED (Default Legacy/Host)"
  direction: right
  
  host: {
    shape: sql_table
    label: "Host Namespace (init_nsproxy)"
    r1: "0x00 | struct mount* | root_mnt  -> / (sda1)"
    r2: "0x08 | struct mount* | user_mnt1 -> /mnt/a (sdb1)"
    r3: "0x10 | struct mount* | ext_mnt1  -> /mnt/b (sdc1) [IN]"
    status: "Mode: MS_SHARED | Propagation: Bidirectional"
  }

  container: {
    shape: sql_table
    label: "Container Namespace (CLONE_NEWNS)"
    r1: "0x00 | struct mount* | root_mnt  -> / (sda1)"
    r2: "0x08 | struct mount* | ext_mnt1  -> /mnt/a (sdb1) [IN]"
    r3: "0x10 | struct mount* | user_mnt2 -> /mnt/b (sdc1)"
    status: "Mode: MS_SHARED | Leak Risk: HIGH"
  }

  host -> container: "mount /mnt/a | event | propagate OUT" {
    style.stroke: red
    style.animated: true
  }
  container -> host: "mount /mnt/b | event | propagate IN" {
    style.stroke: red
    style.animated: true
  }
}

# Scenario 2: MS_PRIVATE
private_mode: {
  label: "Scenario 2: MS_PRIVATE (Container Isolation Target)"
  direction: right

  isolation_logic: {
    label: "Enforce Isolation (container.c)"
    code: |'c
      // Milestone 2 Core Isolation Step
      // MS_REC: apply to all submounts recursively
      // MS_PRIVATE: prevent any propagation events
      mount(NULL, "/", NULL, MS_REC | MS_PRIVATE, NULL);
    '|
  }

  host: {
    shape: sql_table
    label: "Host Namespace"
    r1: "/ -> sda1"
    r2: "/mnt/c -> sdd1 (LOCAL)"
  }

  container: {
    shape: sql_table
    label: "Container Namespace"
    r1: "/ -> sda1"
    r2: "/mnt/d -> sde1 (LOCAL)"
  }

  host -> container: "mount /mnt/c | BLOCKED | 0 bytes" {
    style.stroke: gray
    style.stroke-dash: 3
  }
  container -> host: "mount /mnt/d | BLOCKED | 0 bytes" {
    style.stroke: gray
    style.stroke-dash: 3
  }
  
  isolation_logic -> container: "Apply MS_PRIVATE"
}

# Scenario 3: MS_SLAVE
slave_mode: {
  label: "Scenario 3: MS_SLAVE (Docker Volume Pattern)"
  direction: right

  host: {
    shape: sql_table
    label: "Master Namespace"
    r1: "/ -> sda1"
    r2: "/var/lib/docker/vol -> sdf1"
  }

  container: {
    shape: sql_table
    label: "Slave Namespace"
    r1: "/ -> sda1"
    r2: "/data -> sdf1 (FROM MASTER)"
    r3: "/tmp/local -> sdg1 (HIDDEN)"
  }

  host -> container: "mount vol | Unidirectional | Update Slave" {
    style.stroke: blue
  }
  container -> host: "mount /tmp/local | BLOCKED | No Upstream Update" {
    style.stroke: red
    style.stroke-dash: 3
  }
}

shared_mode -> private_mode: "Refinement: Milestone 2"
private_mode -> slave_mode: "Optimization: Volumes"