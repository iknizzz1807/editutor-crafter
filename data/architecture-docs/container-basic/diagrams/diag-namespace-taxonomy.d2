direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- CLASSES ---
classes: {
  implemented: {
    style: {
      fill: "#C7F1FF"
      stroke: "#0078D4"
      stroke-width: 2
    }
  }
  skipped: {
    style: {
      fill: "#F3F2F1"
      stroke: "#A19F9D"
      stroke-dash: 3
    }
  }
  kernel_struct: {
    shape: sql_table
    style: {
      fill: "#E1DBFA"
      stroke: "#5C2D91"
    }
  }
}

# --- NAMESPACE TAXONOMY TABLE ---
namespace_table: {
  shape: sql_table
  label: "Linux Namespace Taxonomy (sched.h)"

  header: "Namespace | Clone Flag (Bitmask) | Virtualized Kernel Resources | Project Milestone"
  
  row_user: "User | CLONE_NEWUSER (0x10000000) | UIDs, GIDs, Capability Sets, Keys | Milestone 5" {
    class: implemented
  }
  row_pid: "PID | CLONE_NEWPID (0x20000000) | Process ID Space, Process Tree, Init | Milestone 1" {
    class: implemented
  }
  row_mnt: "Mount | CLONE_NEWNS (0x00020000) | Mount Table, Propagation Modes | Milestone 2" {
    class: implemented
  }
  row_net: "Network | CLONE_NEWNET (0x40000000) | Interfaces, IPv4/v6 Stacks, Routes | Milestone 3" {
    class: implemented
  }
  row_uts: "UTS | CLONE_NEWUTS (0x04000000) | Hostname, NIS Domain Name | Milestone 1" {
    class: implemented
  }
  row_ipc: "IPC | CLONE_NEWIPC (0x08000000) | System V IPC, POSIX Message Queues | Skipped" {
    class: skipped
  }
  row_cgroup: "Cgroup | CLONE_NEWCGROUP (0x02000000) | Cgroup Root Directory Visibility | Skipped" {
    class: skipped
  }
  row_time: "Time | CLONE_NEWTIME (0x00000080) | CLOCK_MONOTONIC, BOOTTIME Offsets | Skipped" {
    class: skipped
  }
}

# --- DEPENDENCY & CAPABILITY SCOPING FLOW ---
dependency_flow: {
  label: "Unprivileged Namespace Creation Dependency (Rootless Flow)"
  direction: down
  
  host_user: {
    label: "Host Process (UID 1000)"
    shape: person
  }

  clone_call: {
    label: "clone() Syscall (kernel/fork.c)"
    width: 380
    code: |'c
      long flags = CLONE_NEWUSER | CLONE_NEWPID | 
                   CLONE_NEWNS   | CLONE_NEWNET | 
                   SIGCHLD;
      pid = clone(container_fn, stack, flags, arg);
    '|
  }

  user_ns_ctx: {
    label: "New User Namespace"
    class: implemented
    direction: down
    
    capability_elevation: {
      label: "Capability Elevation (kernel/user_namespace.c)"
      width: 350
      code: |'c
        // Kernel grants full caps scoped to this NS
        current->cap_effective = CAP_FULL_SET;
        current->cap_permitted = CAP_FULL_SET;
      '|
    }
  }

  resource_ns: {
    label: "Target Namespaces (PID, Mnt, Net)"
    class: implemented
  }

  host_user -> clone_call: "syscall_args | 48 bytes | {flags, stack, arg}"
  clone_call -> user_ns_ctx: "struct cred* | 8 bytes | new_cred->user_ns"
  user_ns_ctx -> resource_ns: "cap_t | 8 bytes | CAP_SYS_ADMIN"
}

# --- KERNEL DATA STRUCTURE ---
nsproxy_struct: {
  class: kernel_struct
  label: "struct nsproxy (include/linux/nsproxy.h)"
  
  f0: "0x00 | atomic_t | count"
  f1: "0x08 | uts_namespace* | uts_ns"
  f2: "0x10 | ipc_namespace* | ipc_ns"
  f3: "0x18 | mnt_namespace* | mnt_ns"
  f4: "0x20 | pid_namespace* | pid_ns_for_children"
  f5: "0x28 | net* | net_ns"
  f6: "0x30 | time_namespace* | time_ns"
  f7: "0x38 | cgroup_namespace* | cgroup_ns"
  
  sz: "Total: 64 bytes (1 cache line)"
}

# --- LEGEND ---
legend: {
  label: "Implementation Legend"
  
  impl: "Implemented Milestone" {
    class: implemented
  }
  skip: "Skipped / Host Context" {
    class: skipped
  }
}
legend.near: bottom-right

# --- GLOBAL CONNECTIONS ---
namespace_table.row_user -> nsproxy_struct: "ns_ptr | 8 bytes | task_struct->nsproxy"
nsproxy_struct -> dependency_flow.resource_ns: "ns_handles | 64 bytes | Pointer Array"