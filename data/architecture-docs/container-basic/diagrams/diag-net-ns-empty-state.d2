direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

network_evolution: {
  label: "Network Namespace: Transition from Isolation to Connectivity"

  before_setup: {
    label: "T0: Initial State (Post-clone)"
    style.fill: "#fff5f5"
    
    iface_table: {
      shape: sql_table
      label: "struct net_device (Initial)"
      lo: "index: 1 | status: DOWN | flags: !IFF_UP | addr: NONE"
      isolation: "0x00 | Total Interfaces: 1 (Isolated)"
    }

    routing_table: {
      shape: sql_table
      label: "struct fib_table (Empty)"
      entry: "No routes defined | destination: NONE"
    }

    failure_warning: {
      label: "CRITICAL: Silent Failure Path"
      content: "Processes binding to 127.0.0.1 (Redis, PG) will fail with EADDRNOTAVAIL"
      style.stroke: red
      style.fill: "#ffebeb"
      style.font-color: red
    }
  }

  after_setup: {
    label: "T1: Final State (Post-veth/Setup)"
    style.fill: "#f0fff4"

    iface_table: {
      shape: sql_table
      label: "struct net_device (Configured)"
      lo: "index: 1 | status: UP | flags: IFF_UP | addr: 127.0.0.1/8"
      veth: "index: 2 | status: UP | flags: IFF_UP | addr: 172.16.0.2/24"
    }

    routing_table: {
      shape: sql_table
      label: "struct fib_table (Active)"
      local: "172.16.0.0/24 | scope: LINK | dev: veth_c0"
      default: "0.0.0.0/0 | via: 172.16.0.1 | dev: veth_c0"
    }

    setup_logic: {
      label: "setup_container_network() (net.c)"
      code: |'c
        // Critical: Bring up loopback or apps fail
        run("ip link set lo up");
        
        // Config veth_c0 (moved from host by parent)
        run("ip addr add 172.16.0.2/24 dev veth_c0");
        run("ip link set veth_c0 up");
        
        // Gateway reachability
        run("ip route add default via 172.16.0.1");
      '|
      width: 450
    }
  }

  before_setup -> after_setup: "Netlink | 48 bytes | RTM_NEWADDR / RTM_NEWROUTE" {
    style.stroke: "#2f855a"
    style.animated: true
  }
}

legend: {
  shape: sql_table
  label: "Packet Path Legend"
  red: "Red | State: FAILED / UNREACHABLE"
  green: "Green | State: SUCCESS / ROUTABLE"
  blue: "Blue | Action: SYSCALL / CONFIG"
}
legend.near: bottom-right

# Style overrides for clarity
network_evolution.before_setup.iface_table.lo: { style.font-color: red }
network_evolution.after_setup.iface_table.lo: { style.font-color: "#2f855a" }
network_evolution.after_setup.iface_table.veth: { style.font-color: "#2f855a" }