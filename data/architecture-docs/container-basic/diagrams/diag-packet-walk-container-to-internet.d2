direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ----------------------------------------------------------------------------------
# Layer 1: Container Namespace (Isolated Stack)
# ----------------------------------------------------------------------------------
container_ns: {
  label: "Network Namespace: Container (CLONE_NEWNET)"
  style: {
    stroke: "#3f87a6"
    stroke-width: 2
    fill: "#f0f8ff"
  }

  app: {
    shape: class
    label: "Application Process (PID 1)"
    methods: |'c
      socket(AF_INET, SOCK_STREAM, 0);
      connect(fd, "8.8.8.8:443");
    '|
  }

  veth_ctr: {
    shape: sql_table
    label: "veth_c0 (172.16.0.2)"
    hwaddr: "0x00 | MAC | 02:42:ac:10:00:02"
    mtu: "0x06 | int | 1500"
    state: "UP / LOWER_UP"
  }

  app -> veth_ctr: "TCP SYN | 60 bytes | src=172.16.0.2:54321 dst=8.8.8.8:443"
}

# ----------------------------------------------------------------------------------
# Layer 2: Kernel VETH Driver (The Virtual Wire)
# ----------------------------------------------------------------------------------
veth_driver: {
  label: "Kernel veth.c"
  shape: package
  style.stroke-dash: 3
  
  xmit: {
    label: "veth_xmit()"
    code: |'c
      struct sk_buff *skb = ...;
      dev_forward_skb(peer_dev, skb);
    '|
  }
}

container_ns.veth_ctr -> veth_driver.xmit: "sk_buff* | ptr | cross-ns pointer handoff"

# ----------------------------------------------------------------------------------
# Layer 3: Host Namespace (Bridge & Routing)
# ----------------------------------------------------------------------------------
host_ns: {
  label: "Network Namespace: Host (Default)"
  style: {
    stroke: "#222a25"
    stroke-width: 2
    fill: "#fdfdfd"
  }

  veth_host: {
    shape: sql_table
    label: "veth_h0 (Bridge Port)"
    master: "ctr0"
    state: "UP"
  }

  bridge_ctr0: {
    shape: class
    label: "Bridge: ctr0 (172.16.0.1)"
    fields: |'c
      FDB Table: {02:42:..:02 -> port1}
      IP Forwarding: enabled
    '|
  }

  routing_engine: {
    shape: class
    label: "L3 Routing Engine"
    code: |'c
      if (dst == 8.8.8.8) {
          next_hop = 192.168.1.1;
          out_dev = eth0;
      }
    '|
  }

  iptables_nat: {
    label: "Netfilter: POSTROUTING"
    style.fill: "#ffe7cb"
    
    conntrack: {
      shape: sql_table
      label: "struct nf_conn (Conntrack Entry)"
      tuple_orig: "172.16.0.2:54321 -> 8.8.8.8:443"
      tuple_reply: "8.8.8.8:443 -> 203.0.113.10:54321"
      status: "IPS_CONFIRMED | 43200s"
    }

    masquerade: {
      label: "MASQUERADE Action"
      code: |'c
        skb->nh.iph->saddr = eth0->ip;
        update_checksum(skb);
      '|
    }
  }

  eth0: {
    shape: sql_table
    label: "eth0 (Public: 203.0.113.10)"
    hwaddr: "0x00 | MAC | 52:54:00:12:34:56"
    gateway: "192.168.1.1"
  }

  veth_host -> bridge_ctr0: "Ethernet Frame | 60 bytes | L2 Forward"
  bridge_ctr0 -> routing_engine: "IPv4 Packet | 40 bytes | L3 Routing"
  routing_engine -> iptables_nat.masquerade: "IPv4 Packet | 40 bytes | src=172.16.0.2"
  iptables_nat.masquerade -> eth0: "IPv4 Packet | 40 bytes | src=203.0.113.10"
}

veth_driver.xmit -> host_ns.veth_host: "sk_buff* | ptr | rcv_queue push"

# ----------------------------------------------------------------------------------
# Layer 4: External Network
# ----------------------------------------------------------------------------------
internet: {
  shape: cloud
  label: "Internet (8.8.8.8)"
}

host_ns.eth0 -> internet: "IPv4/TCP | 60 bytes | SYN src=203.0.113.10:54321"
internet -> host_ns.eth0: "IPv4/TCP | 60 bytes | SYN-ACK dst=203.0.113.10:54321" {
  style.stroke: "#167c3c"
  style.animated: true
}

# ----------------------------------------------------------------------------------
# Return Path: Conntrack Translation
# ----------------------------------------------------------------------------------
host_ns.eth0 -> host_ns.iptables_nat.conntrack: "Lookup | 4-tuple | Match Tuple_Reply" {
  style.stroke: "#9e2146"
}

host_ns.iptables_nat.conntrack -> host_ns.bridge_ctr0: "DNAT | 40 bytes | dst=172.16.0.2:54321" {
  style.stroke: "#167c3c"
}

host_ns.bridge_ctr0 -> container_ns.app: "Reverse Walk | SYN-ACK | Delivered to socket" {
  style.stroke: "#167c3c"
  style.stroke-dash: 4
}

# ----------------------------------------------------------------------------------
# Legend/Metadata
# ----------------------------------------------------------------------------------
legend: {
  near: bottom-right
  l2: "L2: Data Link (Bridge/MAC)" { style.fill: "#dae8fc" }
  l3: "L3: Network (IP/Routing)" { style.fill: "#d5e8d4" }
  l4: "L4: Transport (TCP/NAT)" { style.fill: "#ffe6cc" }
  nat_path: "Red Arrow: Pre-Translation" { style.stroke: "#9e2146" }
  ret_path: "Green Arrow: Post-Translation" { style.stroke: "#167c3c" }
}