direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ─────────────────────────────────────────────────────────────────────────────
# SCENARIO A: RESTRICTED CONTAINER (pids.max = 20)
# ─────────────────────────────────────────────────────────────────────────────

restricted_env: {
  label: "RESTRICTED CONTAINER (Isolated Cgroup)"
  style.fill: "#eef9f3"
  style.stroke: green
  style.stroke-width: 2

  cgroup_v2_pids: {
    shape: sql_table
    label: "Cgroup Controller (/sys/fs/cgroup/pids/)"
    f1: "pids.max     | 20      | Upper bound"
    f2: "pids.current | 20      | Active processes"
    f3: "pids.events  | max 1   | Over-limit counter"
  }

  process_tree: {
    direction: down
    init: "PID 1 (sh)" {
      style.fill: "#ACE1AF"
    }
    bomb_loop: ":(){ :|:& };:" {
      shape: code
      language: bash
    }
    children: "Children (PID 2-20)" {
      style.multiple: true
      style.fill: "#C5C6C7"
    }

    init -> bomb_loop
    bomb_loop -> children: "Successful forks"
  }

  kernel_logic: {
    shape: class
    label: "Kernel Logic (kernel/fork.c)"
    definition: |'c
      if (pids_current(cg) >= pids_max(cg)) {
          return -EAGAIN; 
      }
      // Increment and proceed...
    '|
  }

  failed_fork: "21st Fork Attempt" {
    style.stroke: red
    style.font-color: red
  }

  process_tree.bomb_loop -> kernel_logic: "clone() syscall | - | PID 21"
  kernel_logic -> failed_fork: "errno: EAGAIN | 8 bytes | Resource unavailable"
}

# ─────────────────────────────────────────────────────────────────────────────
# SCENARIO B: UNRESTRICTED HOST (No Limit)
# ─────────────────────────────────────────────────────────────────────────────

unrestricted_env: {
  label: "UNRESTRICTED HOST (Default System)"
  style.fill: "#fff0f0"
  style.stroke: red
  style.stroke-width: 2

  host_pids: {
    shape: sql_table
    label: "Kernel Global Limits"
    f1: "pid_max      | 4,194,304 | System total"
    f2: "pids_active  | 32,768+   | Rapidly climbing"
  }

  disaster: "System Hang / PID Exhaustion" {
    shape: callout
    style.fill: red
    style.font-color: white
  }

  process_explosion: {
    direction: right
    p1: "PID 1000"
    p2: "PID 1001"
    p3: "PID 1002"
    p4: "PID 1003"
    pn: "PID 32768..." {style.multiple: true}
    
    p1 -> p2 -> pn
    p2 -> p3 -> pn
    p3 -> p4 -> pn
  }

  process_explosion -> disaster: "Scheduler Saturation"
}

# ─────────────────────────────────────────────────────────────────────────────
# ANNOTATIONS
# ─────────────────────────────────────────────────────────────────────────────

legend: {
  near: bottom-right
  item1: "Green path = Safety (Cgroup enforced)" {
    style.font-color: green
  }
  item2: "Red path = Danger (Resource exhaustion)" {
    style.font-color: red
  }
}

restricted_env -> unrestricted_env: "Comparison | - | Contained vs Unchecked" {
  style.stroke-dash: 5
}