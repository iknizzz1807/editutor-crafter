direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

proc_fs: {
  label: "/proc/[pid] Filesystem Interface (Kernel VFS)"
  
  ns_dir: {
    shape: sql_table
    label: "/proc/[pid]/ns/ (Namespace Inodes)"
    f1: "cgroup | inode:[4026531835] // Cgroup Namespace"
    f2: "ipc    | inode:[4026531839] // IPC Namespace"
    f3: "mnt    | inode:[4026531840] // Mount Namespace"
    f4: "net    | inode:[4026531993] // Network Namespace"
    f5: "pid    | inode:[4026531836] // PID Namespace"
    f6: "user   | inode:[4026531837] // User Namespace"
    f7: "uts    | inode:[4026531838] // UTS (Hostname) Namespace"
    info: "Comparison: Same inode across PIDs = Same Namespace"
  }

  status_file: {
    shape: sql_table
    label: "/proc/[pid]/status (Identity & Caps)"
    f1: "Name:   | bash                // Process command name"
    f2: "State:  | S (sleeping)        // Process state"
    f3: "NSpid:  | 47832	1             // [Host PID] [Namespace PID]"
    f4: "NStgid: | 47832	1             // [Host TGID] [Namespace TGID]"
    f5: "Uid:    | 1000 0 0 0          // [Real] [Eff] [Saved] [FS]"
    f6: "CapEff: | 000001ffffffffff    // Scoped Capability Bitmask"
    f7: "Seccomp:| 2                   // 0:none, 1:strict, 2:filter"
    info: "Used to: Verify PID virtualization & Capability scoping"
  }

  cgroup_file: {
    shape: sql_table
    label: "/proc/[pid]/cgroup (Cgroup Membership)"
    f1: "0::/mycontainer               // v2: [0]::[Path relative to root]"
    f2: "12:pids:/user.slice/u1000     // v1: [ID]:[Controller]:[Path]"
    f3: "11:memory:/user.slice/u1000   // v1: Hierarchies are separate"
    info: "Used to: Locate limits in /sys/fs/cgroup/"
  }

  mountinfo_file: {
    shape: sql_table
    label: "/proc/[pid]/mountinfo (Mount Details)"
    f1: "36 35 98:0 / /proc rw,nosuid,nodev,noexec"
    f2: "ID: 36 | Parent: 35 | Device: 98:0 | Root: / | Mount: /proc"
    f3: "Options: rw,nosuid,nodev,noexec | Tags: shared:1"
    info: "Check 'shared:X' for Propagation Leaks"
  }

  uid_map_file: {
    shape: sql_table
    label: "/proc/[pid]/uid_map (User Mapping)"
    f1: "Inside_UID | Outside_UID | Count"
    f2: "0          | 1000        | 1"
    f3: "1          | 100000      | 65536"
    info: "Verifies: 'Rootless' Identity Translation"
  }
}

# Relationship Arrows
debugger: Debugger / Runtime Engineer {
  shape: person
}

debugger -> proc_fs.status_file: "read | 4KB | NSpid verification"
debugger -> proc_fs.ns_dir: "stat() | Inode | Namespace parity check"
debugger -> proc_fs.mountinfo_file: "grep | Text | Propagation audit"
debugger -> proc_fs.uid_map_file: "cat | Text | Mapping validation"

proc_fs.cgroup_file -> cgroup_v2_tree: "Path Pointer | string | /sys/fs/cgroup/mycontainer"

cgroup_v2_tree: {
  shape: package
  label: "/sys/fs/cgroup/[path] (Enforcement)"
  mem: "memory.max | 100MB limit"
  cpu: "cpu.max    | 50ms/100ms"
  pids: "pids.max  | 32 count"
}

# Style
proc_fs.status_file.f3: {
  style: {
    stroke: blue
    stroke-width: 2
  }
}

proc_fs.mountinfo_file.f3: {
  style: {
    stroke: red
    stroke-dash: 4
  }
}