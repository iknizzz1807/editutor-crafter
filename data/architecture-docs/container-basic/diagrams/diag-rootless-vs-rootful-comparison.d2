direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 1
  }
}

# ── SHARED CLASSES ───────────────────────────────────────────────────────────
classes: {
  danger: {
    style: {
      fill: "#fee2e2"
      stroke: "#dc2626"
      stroke-width: 2
    }
  }
  secure: {
    style: {
      fill: "#f0fdf4"
      stroke: "#16a34a"
      stroke-width: 2
    }
  }
  syscall: {
    shape: code
    style: {
      font: mono
      fill: "#f8fafc"
    }
  }
}

# ── ROOTFUL STACK (BEFORE) ──────────────────────────────────────────────────
rootful: {
  label: "ROOTFUL STACK (Traditional Docker/runc)"
  class: danger
  direction: down

  host_priv: {
    shape: sql_table
    label: "Host Privilege (Initial Namespace)"
    row1: "UID: 0 | GID: 0"
    row2: "Capabilities: CAP_ALL (Global)"
    row3: "Status: Privileged Execution"
  }

  runtime_op: {
    label: "Runtime Initialization"
    code: |'c
      // Requires host root
      clone(CLONE_NEWPID | CLONE_NEWNS | 
            CLONE_NEWNET | CLONE_NEWUTS | 
            SIGCHLD, stack_top);
    '|
  }

  resource_mgmt: {
    shape: sql_table
    label: "Resource Management"
    net: "Network | veth (Direct Kernel Bridge Setup)"
    cpu: "Cgroups | Direct write /sys/fs/cgroup/*"
    fs:  "Filesystem | pivot_root (Global CAP_SYS_ADMIN)"
  }

  escape_boundary: {
    label: "CONTAINER BOUNDARY"
    shape: parallelogram
    style: {
      stroke-dash: 5
      fill: "#ef4444"
    }
  }

  consequence: {
    shape: callout
    label: "ESCAPE OUTCOME: FULL HOST ROOT"
    style: {
      fill: "#b91c1c"
      font-color: white
      bold: true
    }
  }

  host_priv -> runtime_op: "Exec | 0 bytes | sudo runc"
  runtime_op -> resource_mgmt: "Syscalls | 64-bit | clone_flags"
  resource_mgmt -> escape_boundary: "Isolation | Namespace ID | 4026531840"
  escape_boundary -> consequence: "Exploit | Zero-Day | overwrite /etc/shadow"
}

# ── ROOTLESS STACK (AFTER) ───────────────────────────────────────────────────
rootless: {
  label: "ROOTLESS STACK (Podman/User Namespaces)"
  class: secure
  direction: down

  host_priv: {
    shape: sql_table
    label: "Host Privilege (Initial Namespace)"
    row1: "UID: 1000 | GID: 1000"
    row2: "Capabilities: CAP_NONE"
    row3: "Status: Unprivileged Execution"
  }

  runtime_op: {
    label: "Runtime Initialization"
    code: |'c
      // Permitted for unprivileged users
      clone(CLONE_NEWUSER | CLONE_NEWPID | 
            CLONE_NEWNS | CLONE_NEWNET | 
            SIGCHLD, stack_top);
    '|
  }

  userns_mapping: {
    shape: sql_table
    label: "User Namespace Mapping"
    map1: "uid_map | 0 1000 1 (Inside 0 -> Outside 1000)"
    map2: "gid_map | 0 1000 1 (Inside 0 -> Outside 1000)"
    caps: "Caps | Full Set (Scoped to Namespace)"
  }

  resource_mgmt: {
    shape: sql_table
    label: "Resource Management"
    net: "Network | slirp4netns (User-space TAP)"
    cpu: "Cgroups | systemd --user delegation"
    fs:  "Filesystem | pivot_root (Scoped CAP_SYS_ADMIN)"
  }

  escape_boundary: {
    label: "CONTAINER BOUNDARY"
    shape: parallelogram
    style: {
      stroke-dash: 5
      fill: "#22c55e"
    }
  }

  consequence: {
    shape: callout
    label: "ESCAPE OUTCOME: HOST UID 1000"
    style: {
      fill: "#15803d"
      font-color: white
      bold: true
    }
  }

  host_priv -> runtime_op: "Exec | 0 bytes | podman run"
  runtime_op -> userns_mapping: "Syscall | 32-bit | CLONE_NEWUSER"
  userns_mapping -> resource_mgmt: "Auth | Map Triple | 0 1000 1"
  resource_mgmt -> escape_boundary: "Isolation | Namespace ID | 4026532847"
  escape_boundary -> consequence: "Exploit | Blocked | EPERM on host /etc"
}

# ── LEGEND ───────────────────────────────────────────────────────────────────
legend: {
  shape: sql_table
  near: bottom-right
  label: "Security Semantics"
  red:   "Red Layer | High Risk (Global Capabilities)"
  green: "Green Layer | Low Risk (Scoped Capabilities)"
}

rootful -> rootless: "Evolution | User Namespaces | Linux 3.8+" {
  style: {
    stroke-width: 4
    animated: true
  }
}