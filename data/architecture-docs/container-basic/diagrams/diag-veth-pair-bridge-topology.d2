direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 5
  }
}

internet: {
  shape: cloud
  label: "Public Internet"
}

host_ns: {
  label: "Host Network Namespace (Initial)"
  direction: right
  style: {
    stroke-width: 4
    stroke-dash: 0
  }

  eth0: {
    shape: sql_table
    label: "struct net_device (eth0)"
    f1: "Type | Physical NIC"
    f2: "IPv4 | 192.168.1.100/24"
    f3: "MAC  | 52:54:00:12:34:56"
  }

  iptables_nat: {
    shape: sql_table
    label: "Netfilter NAT Table"
    f1: "Chain | POSTROUTING"
    f2: "Match | -s 172.16.0.0/24 -o eth0"
    f3: "Target| MASQUERADE (SNAT)"
  }

  bridge_ctr0: {
    shape: sql_table
    label: "struct net_device (ctr0 Bridge)"
    f1: "Type | Linux Bridge (L2 Switch)"
    f2: "IPv4 | 172.16.0.1/24 (Gateway)"
    f3: "MAC  | aa:bb:cc:dd:ee:01"
  }

  veth_host_1: {
    shape: sql_table
    label: "veth_h1 (Port 1)"
    f1: "Master | ctr0"
    f2: "State  | UP"
  }

  veth_host_2: {
    shape: sql_table
    label: "veth_h2 (Port 2)"
    f1: "Master | ctr0"
    f2: "State  | UP"
  }

  eth0 -> iptables_nat: "sk_buff | MTU 1500 | Outbound"
  iptables_nat -> bridge_ctr0: "Forwarding | IPv4 | 172.16.0.1"
  bridge_ctr0 -> veth_host_1: "L2 Forward | MAC Table Lookup"
  bridge_ctr0 -> veth_host_2: "L2 Forward | Broadcast/Multicast"
}

container_1: {
  label: "Container 1 (Network Namespace)"
  style: {
    stroke-dash: 5
    fill: "#f0faff"
  }
  veth_c1: {
    shape: sql_table
    label: "eth0 (veth_c1 Peer)"
    f1: "IPv4 | 172.16.0.2/24"
    f2: "MAC  | ee:ff:00:11:22:33"
    f3: "Route| default via 172.16.0.1"
  }
  
  methods: {
    shape: code
    label: "Local Stack"
    code: |'c
      // bind(8080) in this NS
      socket(AF_INET, SOCK_STREAM, 0);
      bind(fd, "0.0.0.0:8080", ...);
    '|
  }
}

container_2: {
  label: "Container 2 (Network Namespace)"
  style: {
    stroke-dash: 5
    fill: "#f0faff"
  }
  veth_c2: {
    shape: sql_table
    label: "eth0 (veth_c2 Peer)"
    f1: "IPv4 | 172.16.0.3/24"
    f2: "MAC  | ee:ff:00:44:55:66"
    f3: "Route| default via 172.16.0.1"
  }
  
  methods: {
    shape: code
    label: "Local Stack"
    code: |'c
      // isolated from C1 port 8080
      socket(AF_INET, SOCK_STREAM, 0);
      bind(fd, "0.0.0.0:8080", ...);
    '|
  }
}

internet <-> host_ns.eth0: "External Traffic | BGP/Fiber | 93.184.216.34"

host_ns.veth_host_1 <-> container_1.veth_c1: {
  label: "veth pair | L1 Virtual Wire | zero-copy skb"
  style: {
    stroke-width: 4
    stroke: blue
  }
}

host_ns.veth_host_2 <-> container_2.veth_c2: {
  label: "veth pair | L1 Virtual Wire | zero-copy skb"
  style: {
    stroke-width: 4
    stroke: blue
  }
}

legend: {
  shape: rectangle
  near: bottom-right
  label: "Network Stack Logic"
  l1: "Blue: Virtual Ethernet (veth) Wire"
  l2: "Dashed: Namespace Boundary (Isolation)"
  l3: "MASQUERADE: Source NAT for Internet Access"
}

host_ns.bridge_ctr0.f2 -> container_1.veth_c1.f3: "Default Gateway Association"
host_ns.bridge_ctr0.f2 -> container_2.veth_c2.f3: "Default Gateway Association"