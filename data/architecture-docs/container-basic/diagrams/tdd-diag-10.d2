direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

chroot_model: "chroot() Isolation (Weak/Pointer-based)" {
  style: {
    stroke: "#6a0dad"
    stroke-width: 4
  }

  process_state: "task_struct" {
    shape: class
    style.fill: "#e1d5e7"
    header: "Process Control Block" {style.fill: "#6a0dad"; style.font-color: white}
    fs_struct: "struct fs_struct *fs" {style.fill: "#007bff"; style.font-color: white}
    root_ptr: "struct path root" {style.fill: "#ffa500"; style.font-color: black}
    pwd_ptr: "struct path pwd" {style.fill: "#ffa500"; style.font-color: black}
  }

  vfs_layer: "Global VFS Tree (Shared)" {
    host_root: "/" {
      etc: "/etc"
      bin: "/bin"
      jail: "/home/user/container_root" {
        style.fill: "#d5e8d4"
        usr: "/usr"
        lib: "/lib"
      }
    }
  }

  process_state.root_ptr -> vfs_layer.host_root.jail: "Points to Subdirectory" {
    style: {
      stroke: "#ffa500"
      stroke-width: 3
    }
  }

  escape_path: "Privileged Escape Path" {
    shape: text
    style.font-color: red
  }

  (vfs_layer.host_root.jail -> vfs_layer.host_root)[*]: "chdir('..') / fchdir()" {
    style: {
      stroke: red
      stroke-dash: 5
      animated: true
    }
  }

  annotation: |md
    ### Security Properties
    - **Mechanism**: Changes path resolution starting point.
    - **Weakness**: Kernel retains references to host root.
    - **Escape**: Root processes can navigate '..' past the jail pointer because the Mount Table is shared.
  |
}

pivot_model: "pivot_root() Isolation (Strong/Namespace-based)" {
  style: {
    stroke: "#6a0dad"
    stroke-width: 4
  }

  mnt_ns: "struct mnt_namespace" {
    shape: class
    style.fill: "#e1d5e7"
    header: "Mount Namespace" {style.fill: "#6a0dad"; style.font-color: white}
    root_mount: "struct mount *root" {style.fill: "#007bff"; style.font-color: white}
    list: "struct list_head list" {style.fill: "#007bff"; style.font-color: white}
  }

  vfs_isolated: "Isolated VFS Tree" {
    container_root: "/" {
      style.fill: "#d5e8d4"
      proc: "/proc"
      sys: "/sys"
      dev: "/dev"
    }
  }

  host_fs_phantom: "Host Filesystem" {
    style: {
      fill: gray
      opacity: 0.3
      stroke-dash: 3
    }
    label: "GHOST / UNREACHABLE"
  }

  mnt_ns.root_mount -> vfs_isolated.container_root: "Atomic Namespace Root" {
    style: {
      stroke: "#007bff"
      stroke-width: 3
    }
  }

  no_escape: "NO PATH TO HOST" {
    shape: text
    style.font-color: green
  }

  vfs_isolated.container_root -> host_fs_phantom: "ILLEGAL" {
    style: {
      stroke: red
      stroke-dash: 2
    }
  }

  cve_callout: "CVE-2024-21626 (Leaky Vessels)" {
    shape: callout
    style.fill: "#f8cecc"
    style.stroke: red
    label: |md
      **Leaky Vessels Bypass**
      If an FD to host is open 
      before `exec()`, process 
      can traverse `/proc/self/fd/N`
      to bypass namespace walls.
    |
  }

  annotation: |md
    ### Security Properties
    - **Mechanism**: Swaps root of the Mount Namespace.
    - **Requirement**: `umount2(old, MNT_DETACH)` removes host ref.
    - **Escape**: Impossible via path walking ('..') as the host tree is absent from the namespace mount table.
  |
}

chroot_model -> pivot_model: "Upgrade to Container Grade" {
  style.stroke-width: 5
}