direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# --- CONTAINER ROOTFS ARCHITECTURE ---

rootfs: "/" {
  label: "Container Root Filesystem (rootfs)"
  tooltip: "Minimal directory structure for pivot_root() and isolation"
  
  proc: "proc/" {
    tooltip: "Mount point for procfs"
    style: {
      fill: "#e1d5e7" # Purple (Header/Mount Point)
      stroke: "#9673a6"
    }
  }

  sys: "sys/" {
    tooltip: "Mount point for sysfs"
    style: {
      fill: "#e1d5e7" # Purple
      stroke: "#9673a6"
    }
  }

  dev: "dev/" {
    tooltip: "Mount point for tmpfs"
    style: {
      fill: "#e1d5e7" # Purple
      stroke: "#9673a6"
    }

    null: "null" {
      tooltip: "Bind-mount target for /dev/null"
      style.fill: "#dae8fc" # Blue (Data/Device Node)
    }
    zero: "zero" {
      tooltip: "Bind-mount target for /dev/zero"
      style.fill: "#dae8fc"
    }
    urandom: "urandom" {
      tooltip: "Bind-mount target for /dev/urandom"
      style.fill: "#dae8fc"
    }
  }

  etc: "etc/" {
    resolv_conf: "resolv.conf" {
      tooltip: "DNS configuration injected by Host runtime"
      style.fill: "#ffe6cc" # Orange (Pointers/External Config)
    }
  }

  tmp: "tmp/" {
    tooltip: "Empty writable scratch space"
    style.fill: "#d5e8d4" # Green (Free/Writable)
  }

  pivot_old: ".pivot_old" {
    tooltip: "Staging directory for old host root"
    style: {
      fill: "#f5f5f5" # Gray (Padding/Temporary)
      stroke-dash: 3
    }
  }
}

# --- LIFECYCLE ANNOTATIONS ---

lifecycle: {
  near: top-right
  
  pre_pivot: |md
    ### PRE-PIVOT REQUIREMENTS
    *Host runtime must ensure these exist:*
    1. **mkdir** `proc`, `sys`, `dev`, `etc`, `tmp`, `.pivot_old`
    2. **touch** `dev/null`, `dev/zero`, `dev/urandom`
    3. **write** `etc/resolv.conf`
  | {
    style.font-size: 14
  }

  post_pivot: |md
    ### POST-PIVOT ACTIONS
    *PID 1 Init performs these inside NS:*
    1. **mount** procfs -> `/proc`
    2. **mount** sysfs -> `/sys`
    3. **mount** tmpfs -> `/dev`
    4. **umount2** `/.pivot_old` (MNT_DETACH)
    5. **rmdir** `/.pivot_old`
  | {
    style.font-size: 14
  }
}

# --- RELATIONSHIPS ---

rootfs -> rootfs.proc: "owns"
rootfs -> rootfs.sys: "owns"
rootfs -> rootfs.dev: "owns"
rootfs.dev -> rootfs.dev.null
rootfs.dev -> rootfs.dev.zero
rootfs.dev -> rootfs.dev.urandom
rootfs -> rootfs.etc: "owns"
rootfs.etc -> rootfs.etc.resolv_conf
rootfs -> rootfs.tmp: "owns"
rootfs -> rootfs.pivot_old: "owns"

rootfs.pivot_old -> lifecycle.post_pivot: "target for umount2" {
  style.stroke-dash: 5
}

legend: {
  near: bottom-center
  
  m_point: "Mount Point" {
    style.fill: "#e1d5e7"
  }
  d_target: "Bind Target" {
    style.fill: "#dae8fc"
  }
  h_config: "Host Injected" {
    style.fill: "#ffe6cc"
  }
  t_staging: "Staging/Temporary" {
    style.fill: "#f5f5f5"
  }
}