vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: {
  shape: text
  near: top-center
  label: |'md
# pivot_root() Preconditions â€” EINVAL Failure Tree
*Intel Manual Quality Engineering Spec*
'|
}

# Decision Tree Flow
root: "pivot_root(new_root, put_old) called" {
  style: {
    fill: "#E1D5E7"
    stroke-width: 2
  }
}

# --- Step 1: Namespace ---
check_ns: "1. Inside mount namespace?\n(CLONE_NEWNS)" {
  shape: diamond
}

ns_fail: "Error: EPERM" {
  style: {
    fill: "#F8CECC"
    stroke: red
    bold: true
  }
}

ns_fix: {
  shape: text
  label: |'md
**CODE FIX:**
c
clone(..., CLONE_NEWNS | SIGCHLD, ...);

*Process must not share host mount table.*
'|
}

root -> check_ns
check_ns -> ns_fail: "No"
ns_fail -- ns_fix: { style.stroke-dash: 3 }
check_ns -> check_mp: "Yes"

# --- Step 2: Mount Point ---
check_mp: "2. Is new_root a mount point?\n(VFS Check)" {
  shape: diamond
}

mp_fail: "Error: EINVAL" {
  style: {
    fill: "#F8CECC"
    stroke: red
    bold: true
  }
}

mp_fix: {
  shape: text
  label: |'md
**CODE FIX:**
c
mount(rootfs, rootfs, NULL, MS_BIND, NULL);

*Standard directories are not in mount table.*
'|
}

check_mp -> mp_fail: "No"
mp_fail -- mp_fix: { style.stroke-dash: 3 }
check_mp -> check_diff: "Yes"

# --- Step 3: Separation ---
check_diff: "3. new_root on different FS\nthan current root?" {
  shape: diamond
}

diff_fail: "Error: EINVAL" {
  style: {
    fill: "#F8CECC"
    stroke: red
    bold: true
  }
}

diff_fix: {
  shape: text
  label: |'md
**CODE FIX:**
Ensure `MS_BIND` was used to create a 
distinct mount-id even on same physical disk.
'|
}

check_diff -> diff_fail: "No"
diff_fail -- diff_fix: { style.stroke-dash: 3 }
check_diff -> check_path: "Yes"

# --- Step 4: Path ---
check_path: "4. put_old directory exists\ninside new_root?" {
  shape: diamond
}

path_fail: "Error: EINVAL" {
  style: {
    fill: "#F8CECC"
    stroke: red
    bold: true
  }
}

path_fix: {
  shape: text
  label: |'md
**CODE FIX:**
c
mkdir(rootfs + "/.pivot_old", 0700);

*Staging area for old root must exist.*
'|
}

check_path -> path_fail: "No"
path_fail -- path_fix: { style.stroke-dash: 3 }
check_path -> success: "Yes"

# --- Success State ---
success: "SUCCESS: Atomic Swap" {
  style: {
    fill: "#D5E8D4"
    stroke: green
    bold: true
  }
}

post_steps: {
  shape: text
  label: |'md
**REQUIRED POST-SYSCALL:**
1. `chdir("/")` - Update CWD pointer.
2. `umount2("/.pivot_old", MNT_DETACH)` - Detach host.
'|
}
success -- post_steps: { style.stroke-dash: 3 }

# Layout constraints for tree appearance
ns_fail -> mp_fail -> diff_fail -> path_fail: {
  style.stroke: transparent
}

# Legend
legend: {
  near: bottom-right
  Header: "Syscall Entry" { 
    style.fill: "#E1D5E7" 
  }
  Check: "Kernel Invariant" { 
    shape: diamond 
  }
  Failure: "Terminal Error" { 
    style.fill: "#F8CECC" 
  }
  Success: "Pointer Commit" { 
    style.fill: "#D5E8D4" 
  }
}