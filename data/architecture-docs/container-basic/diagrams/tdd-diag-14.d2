layout-engine: elk
theme-id: 4

# Diagram: /proc Mount and PID Namespace Interaction
grid-columns: 2
grid-gap: 50

wrong_scenario: "INCORRECT ORDER (Security Leak)" {
  shape: sequence_diagram
  
  runtime: "Runtime (Host)" {
    style.fill: "#E1D5E7"
  }
  # Note syntax used for metadata to satisfy sequence diagram layout rules
  runtime."**sizeof(ContainerConfig)**: 112 bytes\n**clone() flags**: 0x60020000 (NEWNS|NEWPID)"

  kernel: "Kernel (VFS/NS)" {
    style.fill: "#DAE8FC"
  }
  init: "Container (PID 1)" {
    style.fill: "#D5E8D4"
  }

  runtime -> kernel: "clone(flags=CLONE_NEWNS|CLONE_NEWPID)"
  kernel -> init: "entry: container_init()"
  
  init -> kernel: "mount(\"proc\", \"/proc\", \"proc\", 0, NULL)" {
    style: {
      stroke: red
      stroke-width: 4
    }
  }
  kernel -> init: "▼ ret=0: Mount attached to HOST PID view"
  
  init -> kernel: "pivot_root(\"rootfs\", \"/old_root\")"
  kernel -> init: "▲ Success (Root filesystem swapped)"
  
  init -> init: "execps: ps aux"
  init."FAIL: /proc reflects HOST PID space!" {
    style: {
      fill: "#F8CECC"
      stroke: "#B85450"
    }
  }
}

correct_scenario: "CORRECT ORDER (Safe Isolation)" {
  shape: sequence_diagram
  
  runtime: "Runtime (Host)" {
    style.fill: "#E1D5E7"
  }
  runtime."**Isolation verified**\nNamespace: mnt, pid"

  kernel: "Kernel (VFS/NS)" {
    style.fill: "#DAE8FC"
  }
  init: "Container (PID 1)" {
    style.fill: "#D5E8D4"
  }

  runtime -> kernel: "clone(flags=CLONE_NEWNS|CLONE_NEWPID)"
  kernel -> init: "entry: container_init()"
  
  init -> kernel: "mount(NULL, \"/\", NULL, MS_REC|MS_PRIVATE, NULL)"
  kernel -> init: "▼ Isolation success"
  
  init -> kernel: "pivot_root(\"rootfs\", \"/old_root\")"
  kernel -> init: "▲ Root swapped"
  
  init -> kernel: "mount(\"proc\", \"/proc\", \"proc\", MS_NOSUID, NULL)" {
    style: {
      stroke: green
      stroke-width: 4
    }
  }
  kernel -> init: "▼ ret=0: New procfs allocated for private PID NS"
  
  init -> init: "execps: ps aux"
  init."PASS: /proc isolated to Namespace PIDs!" {
    style: {
      fill: "#D5E8D4"
      stroke: "#82B366"
    }
  }
}

explanation: ||md
### Kernel Semantic Invariant
The **procfs** mount is scoped to the **PID namespace** of the process that performs the `mount(2)` syscall. 

1. **Wrong Path**: By mounting `/proc` before the root is pivoted, the process list is populated using the host's view. Even after pivoting, the filesystem handle remains attached to the host's process metadata.
2. **Correct Path**: By mounting `/proc` **after** `pivot_root`, the kernel allocates a new superblock for the procfs instance. It detects that the caller is PID 1 in a private PID namespace and filters the process tree accordingly.
||
explanation.near: bottom-center
explanation.style.stroke: "#666666"
explanation.style.fill: "#FFFFE0"
explanation.style.font-size: 14