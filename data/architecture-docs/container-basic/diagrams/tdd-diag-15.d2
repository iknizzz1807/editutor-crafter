direction: right
layout-engine: elk
theme-id: 4

internet: Internet {
  shape: cloud
}

host: Host (Initial Network Namespace) {
  style: {
    stroke-width: 2
    fill: "#f8f9fa"
  }

  eth0: "eth0\n(Physical NIC)" {
    shape: rectangle
    |md
      ### struct net_device
      - **IP**: 192.168.1.100/24
      - **MAC**: aa:bb:cc:dd:ee:ff
      - **Type**: ARPHRD_ETHER
    |
  }

  nat: "iptables\n(NAT Engine)" {
    shape: diamond
    |md
      ### netfilter: MASQUERADE
      - **Table**: nat
      - **Chain**: POSTROUTING
      - **Logic**: SNAT to eth0 IP
    |
  }

  routing: "Host Routing Table" {
    |md
      - 0.0.0.0/0 -> eth0 gateway
      - 172.20.0.0/24 -> ctr0
    |
  }

  bridge: "ctr0\n(Linux Bridge)" {
    |md
      ### struct net_device (BRIDGE)
      - **IP**: 172.20.0.1/24
      - **Gateway**: 172.20.0.1
    |
  }

  veth_h0: "veth_h0\n(Bridge Port)" {
    |md
      ### struct net_device (VETH)
      - **Master**: ctr0
      - **Peer**: veth_c0
    |
  }

  routing -> bridge: internal route
  bridge -> veth_h0: owns port
  routing -> nat: packets for egress
  nat -> eth0: transformed
}

container_ns: Container Namespace {
  style: {
    stroke-dash: 5
    stroke: "#fd7e14"
    fill: "#fff4e6"
  }
  
  label: "CLONE_NEWNET boundary"

  veth_c0: "veth_c0\n(Container Endpoint)" {
    |md
      ### struct net_device (VETH)
      - **IP**: 172.20.0.2/24
      - **Peer**: veth_h0
    |
  }

  lo: "lo\n(Loopback)" {
    |md
      - **IP**: 127.0.0.1/8
    |
  }

  def_route: "Default Route" {
    shape: parallelogram
    label: "default via 172.20.0.1"
  }

  veth_c0 -> lo: internal
  def_route -> veth_c0: egress path
}

# Physical/Virtual Links
host.veth_h0 <-> container_ns.veth_c0: Virtual Ethernet Cable (veth pair) {
  style: {
    stroke-width: 4
    stroke: "#adb5bd"
  }
}

host.eth0 <-> internet: Physical Link

# Packet Flow Annotations
outbound: Outbound Flow {
  style: {
    stroke: "#fa5252"
    stroke-width: 2
    animated: true
  }
}

return: Return Flow {
  style: {
    stroke: "#228be6"
    stroke-dash: 3
    stroke-width: 2
    animated: true
  }
}

# Routing arrows for flow
container_ns.veth_c0 -> host.veth_h0: outbound {class: outbound}
host.veth_h0 -> container_ns.veth_c0: return {class: return}

host.bridge -> host.routing: outbound {class: outbound}
host.routing -> host.bridge: return {class: return}

host.routing -> host.nat: outbound {class: outbound}
host.nat -> host.routing: return {class: return}

host.nat -> host.eth0: outbound {class: outbound}
host.eth0 -> host.nat: return {class: return}

legend: {
  near: bottom-right
  out: Outbound (SNAT) {
    style.font-color: "#fa5252"
  }
  in: Return (Un-NAT) {
    style.font-color: "#228be6"
  }
}