layout-engine: elk
theme-id: 4

setup_sequence: {
  shape: sequence_diagram

  host: "HOST\n(Parent Process)" {
    style: {
      stroke: "#2196F3"
      fill: "#E3F2FD"
    }
  }
  kernel: "KERNEL\n(Linux Subsystems)" {
    style: {
      stroke: "#9C27B0"
      fill: "#F3E5F5"
    }
  }
  container: "CONTAINER\n(Namespace PID 1)" {
    style: {
      stroke: "#4CAF50"
      fill: "#E8F5E9"
    }
  }

  host -> kernel: "clone(CLONE_NEWNET | SIGCHLD, ...)"
  kernel -> kernel: "alloc_net_ns()"
  kernel -> host: "return container_pid"
  kernel -> container: "child starts executing container_init()"
  
  container -> kernel: "read(sync_pipe[0], &buf, 1)"
  kernel -> container: "process BLOCKED (sleeping)" {
    style.stroke-dash: 3
  }

  group: "Critical Handoff Window" {
    host -> kernel: "RTM_NEWLINK (create veth pair veth_h0 <-> veth_c0)"
    host -> kernel: "RTM_SETLINK (veth_c0, IFLA_NET_NS_PID = container_pid)"
    kernel -> kernel: "dev_change_net_namespace(veth_c0)"
    
    # Corrected: Sequence diagrams define notes by nesting a shape under an actor.
    # Standard 'near' positioning with relative keys is restricted in nested scopes.
    kernel.handoff_note: |md
      **CRITICAL**
      veth interface must be physically
      present in container namespace 
      BEFORE the sync signal is sent.
    |
  }

  host -> kernel: "RTM_NEWLINK (bridge ctr0), iptables MASQUERADE"
  host -> kernel: "write(sync_pipe[1], '1')"
  
  kernel -> container: "read() returns (unblocks process)"
  
  container -> kernel: "SIOCSIFFLAGS (lo UP)"
  container -> kernel: "RTM_NEWADDR (veth_c0: 172.20.0.2/24)"
  container -> kernel: "RTM_NEWROUTE (default via 172.20.0.1)"
  
  container -> kernel: "execvp(argv[0], argv)"
  kernel -> container: "Address Space Overwritten"
}

# Legend and Annotations
legend: {
  near: bottom-center
  label: "Two-Phase Network Setup Protocol"
  
  info: |md
    ### Execution Contexts
    - **HOST**: CAP_SYS_ADMIN/CAP_NET_ADMIN in initial user namespace.
    - **KERNEL**: Atomic pointer surgery on `struct net_device`.
    - **CONTAINER**: Empty network stack until unblocked by parent.
  |
}