layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

direction: down

container_ns: "Container Network Namespace" {
  style: {
    stroke-dash: 5
    fill: "#f9f9ff"
  }

  process: "User Application (Process Context)" {
    shape: rectangle
    style.fill: "#e1d5e7" # Purple Header
  }

  routing_child: "IP Routing Table (Namespace Local)" {
    shape: sql_table
    default: "0.0.0.0/0 -> veth_c0"
    local: "172.20.0.0/24 -> dev veth_c0"
  }

  veth_c0: "veth_c0 interface (172.20.0.2)" {
    style.fill: "#dae8fc" # Blue Data
  }

  process -> routing_child: "1. connect(93.184.216.34:443)\n[skb: SYN, src=172.20.0.2:54321]"
  routing_child -> veth_c0: "2. Next Hop: 172.20.0.1\nvia veth_c0"
}

host_ns: "Host Network Namespace" {
  style: {
    stroke-width: 2
    fill: "#ffffff"
  }

  veth_h0: "veth_h0 (Bridge Slave Port)" {
    style.fill: "#dae8fc" # Blue Data
  }

  bridge: "Linux Bridge (ctr0) (Gateway: 172.20.0.1)" {
    shape: rectangle
    style.fill: "#fff2cc"
  }

  routing_host: "IP Routing Table (Host Global)" {
    shape: sql_table
    default: "0.0.0.0/0 -> eth0"
    lan: "192.168.1.0/24 -> dev eth0"
  }

  netfilter: "Netfilter Stack (POSTROUTING Chain)" {
    style.fill: "#f8cecc" # Logic/NAT
    style.stroke: "#b85450"
  }

  eth0: "Physical NIC (eth0) (192.168.1.100)" {
    style.fill: "#d5e8d4" # Green (Free/Egress)
  }

  veth_h0 -> bridge: "4. L2 Forwarding (FDB Lookup)"
  bridge -> routing_host: "5. Host L3 Entry (ip_forward=1)"
  routing_host -> netfilter: "6. MASQUERADE Rule\n[conntrack entry created]"
  netfilter -> eth0: "7. Egress\n[src=192.168.1.100:54321]"
}

# Step 3: Crossing the boundary
container_ns.veth_c0 -> host_ns.veth_h0: "3. veth_xmit() Kernel Hook" {
  style: {
    stroke: "#ff8c00" # Orange for Pointers/Boundary
    stroke-width: 4
    animated: true
  }
}

boundary_callout: ||md
  ### Namespace Boundary Crossing
  **Mechanism:** Pointer Move
  **Function:** `veth_xmit()` moves `sk_buff` from Cont-TX queue to Host-RX queue.
  **Cost:** 0 Copy overhead.
|| {
  near: top-right
  style: {
    stroke: "#ff8c00"
    fill: "#fff5e6"
  }
}

return_path: "Return Path (8-14)" {
  shape: text
  near: bottom-left
  label: "Reverse Path: eth0 → conntrack (DNAT) → bridge → veth_h0 → veth_c0 → process"
  style.italic: true
}

legend: {
  near: bottom-right
  label: "LEGEND"
  packet: "TCP SYN Packet" {
    style.fill: "#dae8fc"
  }
  logic: "Kernel Logic/NAT" {
    style.fill: "#f8cecc"
  }
  boundary: "NS Crossing" {
    style.stroke: "#ff8c00"
  }
}