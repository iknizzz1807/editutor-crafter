direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: ||md
  # veth Pair Internal State — skb Transfer Across Namespace Boundary
  **sizeof(net_device) ≈ 2.4 KB | sizeof(sk_buff) ≈ 232 bytes**
||
title.shape: text
title.near: top-center

NS_HOST: "struct net (Initial Namespace)" {
  style.stroke-width: 4
  
  veth_h0: "struct net_device (veth_h0)" {
    shape: sql_table
    "0x00": "name [char[16]]" {constraint: "veth_h0"}
    "0x10": "ifindex [int]" {constraint: "4"}
    "0x40": "net [struct net*]" {constraint: "-> NS_HOST"}
    "0x120": "priv [void*]" {constraint: "-> veth_priv_h"}
    
    style.fill: "#e1d5e7"
  }

  veth_priv_h: "struct veth_priv (Host Side)" {
    shape: sql_table
    "0x00": "peer [struct net_device*]" {constraint: "-> veth_c0"}
    "0x08": "rx_rq [struct veth_rq*]"
    
    style.fill: "#dae8fc"
  }
}

NS_CONT: "struct net (Container Namespace)" {
  style.stroke-width: 4
  
  veth_c0: "struct net_device (veth_c0)" {
    shape: sql_table
    "0x00": "name [char[16]]" {constraint: "veth_c0"}
    "0x10": "ifindex [int]" {constraint: "2"}
    "0x40": "net [struct net*]" {constraint: "-> NS_CONT"}
    "0x120": "priv [void*]" {constraint: "-> veth_priv_c"}
    
    style.fill: "#e1d5e7"
  }

  veth_priv_c: "struct veth_priv (Cont Side)" {
    shape: sql_table
    "0x00": "peer [struct net_device*]" {constraint: "-> veth_h0"}
    "0x08": "rx_rq [struct veth_rq*]"
    
    style.fill: "#dae8fc"
  }
}

SKB: "struct sk_buff (In-Flight Packet)" {
  shape: sql_table
  "0x00": "head [unsigned char*]" {constraint: "Cache Line 0 (HOT)"}
  "0x08": "data [unsigned char*]" {constraint: "Pointer to Payload"}
  "0x10": "tail [sk_buff_data_t]"
  "0x18": "end [sk_buff_data_t]"
  "0x20": "len [unsigned int]" {constraint: "1500 bytes"}
  "0x28": "dev [struct net_device*]" {constraint: "REASSIGNED"}
  
  style.fill: "#dae8fc"
  style.stroke: "#d6b656"
}

# Ownership/Reference Connections
NS_HOST -> NS_HOST.veth_h0: owns
NS_CONT -> NS_CONT.veth_c0: owns
NS_HOST.veth_h0."0x120" -> NS_HOST.veth_priv_h: owns
NS_CONT.veth_c0."0x120" -> NS_CONT.veth_priv_c: owns

NS_HOST.veth_priv_h."0x00" -> NS_CONT.veth_c0: peer_ref {style.stroke-dash: 5}
NS_CONT.veth_priv_c."0x00" -> NS_HOST.veth_h0: peer_ref {style.stroke-dash: 5}

# The Transfer Flow
NS_HOST.veth_h0 -> SKB: "1. veth_xmit()" {
  style.stroke: "#ff8c00"
  style.stroke-width: 2
}

SKB -> NS_CONT.veth_c0: "2. veth_forward_skb() \n 3. netif_rx()" {
  style.stroke: "#ff8c00"
  style.stroke-width: 3
  style.animated: true
}

# Annotations
notes: ||md
  ### Physical Constraints & Hardware Soul
  - **No memcpy**: The payload at `skb->data` is never copied. Only the `skb->dev` pointer is updated to `veth_c0`.
  - **Cache Behavior**: 
    - `skb->head`: Cache Line 0 is accessed during header parsing (HOT).
    - `rx_ring spinlock`: Accessed in `netif_rx`. High CPU contention point under 10Gbps+ loads.
  - **Namespace Switch**: Crosses L3 boundary via software-only `netif_rx` interrupt injection.
||
notes.near: bottom-center
notes.shape: text

legend: {
  near: bottom-right
  
  L1: "Device Header" { style.fill: "#e1d5e7" }
  L2: "Data Structure" { style.fill: "#dae8fc" }
  L3: "Transfer Path" { style.stroke: "#ff8c00" }
}