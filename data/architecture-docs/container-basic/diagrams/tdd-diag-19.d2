layout-engine: elk
direction: right
vars: {
  d2-config: {
    theme-id: 0
  }
}

# --- STYLING ---
classes: {
  interface: {
    shape: cylinder
    style: {
      fill: "#ffe5d9"
      stroke: "#d4a373"
      stroke-width: 2
    }
  }
  hook: {
    shape: rectangle
    style: {
      fill: "#e1d5e7"
      stroke: "#9673a6"
      stroke-width: 2
      bold: true
    }
  }
  chain_rule: {
    style: {
      fill: "#dae8fc"
      stroke: "#6c8ebf"
      stroke-width: 2
      font-size: 12
    }
  }
  decision: {
    shape: diamond
    style: {
      fill: "#fff2cc"
      stroke: "#d6b656"
      stroke-width: 2
    }
  }
  conntrack: {
    style: {
      fill: "#d5e8d4"
      stroke: "#82b366"
      stroke-dash: 3
    }
  }
}

# --- OUTBOUND PATH (CONTAINER TO INTERNET) ---
outbound: "OUTBOUND FLOW (veth_h0 -> eth0)" {
  veth_h0: "Interface: veth_h0\n(Bridge Port)" {class: interface}
  pre: "Hook: PREROUTING" {class: hook}
  rout: "Routing Decision" {class: decision}
  
  fwd: "Chain: FORWARD" {
    class: hook
    rule: "-i ctr0 -o eth0 -j ACCEPT" {class: chain_rule}
  }
  
  post: "Hook: POSTROUTING" {
    class: hook
    rule: "-t nat MASQUERADE\n-s 172.20.0.0/24 -o eth0" {class: chain_rule}
  }
  
  eth0: "Interface: eth0\n(Host Egress)" {class: interface}

  veth_h0 -> pre: "SRC: 172.20.0.2\nDST: 93.184.216.34"
  pre -> rout
  rout -> fwd
  fwd -> post
  post -> eth0: "SRC: <Host_IP>\nDST: 93.184.216.34"
}

# --- INBOUND PATH (INTERNET TO CONTAINER) ---
inbound: "INBOUND FLOW (eth0 -> veth_h0)" {
  eth0_in: "Interface: eth0\n(Host Ingress)" {class: interface}
  
  pre_in: "Hook: PREROUTING" {
    class: hook
    rule: "conntrack DNAT:\ndst rewritten to 172.20.0.2" {class: chain_rule}
  }
  
  rout_in: "Routing Decision" {class: decision}
  
  fwd_in: "Chain: FORWARD" {
    class: hook
    rule: "-i eth0 -o ctr0\n-m state ESTABLISHED -j ACCEPT" {class: chain_rule}
  }
  
  veth_h0_in: "Interface: veth_h0\n(Bridge Port)" {class: interface}

  eth0_in -> pre_in: "SRC: 93.184.216.34\nDST: <Host_IP>"
  pre_in -> rout_in
  rout_in -> fwd_in
  fwd_in -> veth_h0_in: "SRC: 93.184.216.34\nDST: 172.20.0.2"
}

# --- CONNTRACK TABLE ---
ct_table: "CONNTRACK TABLE" {
  class: conntrack
  entry: |`md
| Protocol | Internal SRC | External DST | Mapped Port |
| :--- | :--- | :--- | :--- |
| TCP | 172.20.0.2:54321 | 93.184.216.34:443 | 192.168.1.100:54321 |
`|
}

# --- CONNECTIONS & ANNOTATIONS ---
outbound.post.rule -> ct_table.entry: "1. CREATE ENTRY\n(MASQUERADE)" {
  style: {
    stroke: "#82b366"
    stroke-width: 2
    animated: true
  }
}

ct_table.entry -> inbound.pre_in.rule: "2. LOOKUP / DNAT\n(Reverse Map)" {
  style: {
    stroke: "#82b366"
    stroke-width: 2
    animated: true
  }
}

legend: {
  near: bottom-center
  h: "Hook (Netfilter Point)" {class: hook}
  r: "Iptables Rule" {class: chain_rule}
  i: "Interface" {class: interface}
}

# Metadata
title: {
  near: top-center
  shape: rectangle
  label: |md
    ### iptables Netfilter Hook Points â€” FORWARD and POSTROUTING Chains
    **Namespace Boundary Crossing and Stateful NAT (MASQUERADE) Mechanics**
  |
}