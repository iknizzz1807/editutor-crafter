layout-engine: elk
vars: {
  d2-config: {
    theme-id: 0
    pad: 20
  }
}

title: |md
  ### clone() Stack Memory Layout â€” x86-64
  **Hardware Constraint:** Stack grows DOWN (High -> Low Address)
| {near: top-center}

# Memory Layout Container
# Intel-quality memory table following specific byte-offset/size rules
memory_map: {
  grid-columns: 3
  grid-gap: 0

  # --- HEADER ROW (Purple) ---
  h_off: "Offset (Byte)" { style.fill: "#673ab7"; style.font-color: white; style.bold: true }
  h_field: "Region Name / Protection" { style.fill: "#673ab7"; style.font-color: white; style.bold: true }
  h_size: "Size (Bytes)" { style.fill: "#673ab7"; style.font-color: white; style.bold: true }

  # --- ADJACENT MEMORY (Gray/Red) ---
  adj_off: "[-0x????]" { style.font-color: red }
  adj_field: "Adjacent Program Data / Heap" {
    style: {
      fill: "#eeeeee"
      stroke: red
      stroke-dash: 3
    }
  }
  adj_size: "???" { style.font-color: red }

  # --- PAGE BOUNDARY (Bold) ---
  pb1_1: "" { grid-columns: 3; style.stroke-width: 4; height: 2 }

  # --- GUARD PAGE (Gray) ---
  g_off: "0x000000"
  guard_page: "Guard Page (PROT_NONE)" {
    style: {
      fill: "#9e9e9e"
      stroke-width: 2
    }
  }
  g_size: "4096 (4 KB)"

  # --- PAGE BOUNDARY (Bold) ---
  pb2_1: "" { grid-columns: 3; style.stroke-width: 4; height: 2 }

  # --- USABLE STACK (Blue) ---
  s_off: "0x001000"
  usable_region: "Usable Stack (PROT_READ | PROT_WRITE)" {
    style: {
      fill: "#2196f3"
      font-color: white
      stroke-width: 2
    }
  }
  s_size: "1044480 (1020 KB)"

  # --- STACK TOP / BASE (Orange) ---
  t_off: "0x100000" { style.bold: true }
  stack_top: "stack_top (Allocation Base + STACK_SIZE)" {
    tooltip: "Target address for clone() child_stack param"
    style: {
      fill: "#ff9800"
      bold: true
      stroke-width: 3
    }
  }
  t_size: "0"
}

# Dynamics and Annotations
controls: {
  near: center-right
  
  success_ptr: "CORRECT: pass stack_top" {
    shape: person
    style.fill: "#4caf50"
  }
  
  error_ptr: "FATAL ERROR: pass mmap base" {
    shape: person
    style.fill: "#f44336"
  }
}

# Logic Flow
controls.success_ptr -> memory_map.stack_top: "Target for clone()" {
  style: {
    stroke: "#4caf50"
    stroke-width: 6
  }
}

controls.error_ptr -> memory_map.guard_page: "Immediate SIGSEGV" {
  style: {
    stroke: "#f44336"
    stroke-width: 4
    stroke-dash: 5
  }
}

# Stack Growth Annotation (Fixing the shape: arrow error)
growth_dir: {
  near: center-left
  high: "High Addr" { style.stroke-width: 0 }
  low: "Low Addr" { style.stroke-width: 0 }
  
  high -> low: "STACK GROWTH" {
    style: {
      stroke: "#ff9800"
      stroke-width: 6
      bold: true
    }
  }
}

# Technical Specification Annotation
annotation: |md
  **Hardware Constraints:**
  1. **Stack Direction:** x86-64 `push` decrements `%rsp`.
  2. **clone() syscall:** Expects pointer to the *highest* address of the stack.
  3. **Protection:** Guard page at the lowest address (bottom) triggers `SIGSEGV` on overflow.
  
  **Total Allocation:** 1,048,576 Bytes (1 MiB)
| {
  near: bottom-center
}

# Interaction Logic
memory_map.usable_region -> memory_map.adj_field: "Overflow Protection" {
  style: {
    stroke: red
    stroke-dash: 3
    animated: true
  }
}