vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
    pad: 20
  }
}

cgroups_v2: "cgroups v2 Unified Hierarchy" {
  style.stroke-width: 2

  root: "/sys/fs/cgroup/ (Initial User Namespace Root)" {
    style.fill: "#f3f4f6"
    
    controllers: "cgroup.controllers" {
      shape: sql_table
      style.fill: "#e1d5e7"
      "Mode": "Read-Only (RO)"
      "Content": "'cpu io memory pids'"
    }

    subtree: "cgroup.subtree_control" {
      shape: sql_table
      style.fill: "#dae8fc"
      "Mode": "Read-Write (RW)"
      "Content": "'+memory +cpu +pids'"
    }

    delegation_logic: ||md
      ### Controller Delegation
      Parent must explicitly write `+<controller>` to `subtree_control` 
      to generate resource files in child directories.
    || {
      style.font-size: 12
      style.stroke-dash: 3
    }

    container_dir: "mycontainer/ (Child Cgroup)" {
      style.fill: "#ffffff"
      
      procs: "cgroup.procs" {
        shape: sql_table
        style.fill: "#dae8fc"
        "Mode": "RW"
        "Value": "Container PID (e.g., 47832)"
      }

      mem_limit: "memory.max" {
        shape: sql_table
        style.fill: "#dae8fc"
        "Mode": "RW"
        "Value": "104857600 (100MB)"
      }

      mem_usage: "memory.current" {
        shape: sql_table
        style.fill: "#e1d5e7"
        "Mode": "RO"
        "Value": "Live Usage (bytes)"
      }

      swap_limit: "memory.swap.max" {
        shape: sql_table
        style.fill: "#dae8fc"
        "Mode": "RW"
        "Value": "0 (Disabled)"
      }

      cpu_limit: "cpu.max" {
        shape: sql_table
        style.fill: "#dae8fc"
        "Mode": "RW"
        "Value": "'50000 100000' (50ms/100ms)"
      }

      cpu_stats: "cpu.stat" {
        shape: sql_table
        style.fill: "#e1d5e7"
        "Mode": "RO"
        "Metrics": "usage_usec\nthrottled_usec\nnr_throttled"
      }

      pid_limit: "pids.max" {
        shape: sql_table
        style.fill: "#dae8fc"
        "Mode": "RW"
        "Value": "32"
      }

      pid_usage: "pids.current" {
        shape: sql_table
        style.fill: "#e1d5e7"
        "Mode": "RO"
        "Value": "Live Task Count"
      }
    }
  }

  # Dependencies inside Hierarchy
  root.subtree -> root.container_dir: "Delegates Control" {
    style: {
      stroke: orange
      stroke-width: 2
      animated: true
    }
  }
}

# LEGEND: Moved to root level to resolve 'near' constant key restriction
legend: "Filesystem Permission Key" {
  near: bottom-right
  rw: "Read-Write (Configuration)" {
    style.fill: "#dae8fc"
  }
  ro: "Read-Only (Accounting/Stats)" {
    style.fill: "#e1d5e7"
  }
}

# ANNOTATIONS: Positioned at root level
annotate: ||md
  **Implementation Note**:
  - `mkdir` creates the directory.
  - `write()` to `cgroup.procs` migrates the task.
  - Resource files appear only if enabled in `subtree_control`.
|| {
  near: top-right
}