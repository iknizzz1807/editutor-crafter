direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: {
  label: |md
    # cgroups v1 vs v2 Architecture
    ### Unified vs Fragmented Hierarchy
  |
  near: top-center
}

# --- CGROUPS V1: FRAGMENTED HIERARCHY ---
v1: "cgroups v1 (Fragmented)" {
  style: {
    stroke-width: 2
    fill: "#f8f9fa"
  }

  mem_tree: "/sys/fs/cgroup/memory/" {
    mycontainer: "mycontainer/" {
      procs: "cgroup.procs" {
        shape: rectangle
        style.fill: "#d0bcff" # Header (Purple)
      }
      limit: "memory.limit_in_bytes" {
        shape: rectangle
        style.fill: "#8da9f9" # Data (Blue)
      }
    }
  }

  cpu_tree: "/sys/fs/cgroup/cpu/" {
    mycontainer: "mycontainer/" {
      procs: "cgroup.procs" {
        shape: rectangle
        style.fill: "#d0bcff" # Header (Purple)
      }
      quota: "cpu.cfs_quota_us" {
        shape: rectangle
        style.fill: "#8da9f9" # Data (Blue)
      }
      period: "cpu.cfs_period_us" {
        shape: rectangle
        style.fill: "#8da9f9" # Data (Blue)
      }
    }
  }

  pids_tree: "/sys/fs/cgroup/pids/" {
    mycontainer: "mycontainer/" {
      procs: "cgroup.procs" {
        shape: rectangle
        style.fill: "#d0bcff" # Header (Purple)
      }
      max: "pids.max" {
        shape: rectangle
        style.fill: "#8da9f9" # Data (Blue)
      }
    }
  }

  v1_invariant: {
    label: |md
      **FRAGMENTED INVARIANT**
      Process must be explicitly 
      written to every controller 
      hierarchy independently.
    |
    near: bottom-center
    style.stroke-dash: 3
  }
}

# --- CGROUPS V2: UNIFIED HIERARCHY ---
v2: "cgroups v2 (Unified)" {
  style: {
    stroke-width: 4
    fill: "#f8f9fa"
  }

  unified_tree: "/sys/fs/cgroup/" {
    mycontainer: "mycontainer/" {
      procs: "cgroup.procs" {
        shape: rectangle
        style.fill: "#d0bcff" # Header (Purple)
      }
      mem_max: "memory.max" {
        shape: rectangle
        style.fill: "#8da9f9" # Data (Blue)
      }
      cpu_max: "cpu.max" {
        shape: rectangle
        style.fill: "#8da9f9" # Data (Blue)
      }
      pids_max: "pids.max" {
        shape: rectangle
        style.fill: "#8da9f9" # Data (Blue)
      }
      stat: "cpu.stat" {
        shape: rectangle
        style.fill: "#8df9a9" # Performance Data (Green)
      }
    }
  }

  v2_invariant: {
    label: |md
      **UNIFIED INVARIANT**
      One write to `cgroup.procs` 
      assigns process to ALL 
      active controllers.
    |
    near: bottom-center
    style.stroke-width: 2
  }
}

# --- PROCESS REPRESENTATION ---
host_process: "Process (PID 47832)" {
  shape: person
  style.fill: "#fff2cc"
}

# --- CONNECTIONS ---
host_process -> v1.mem_tree.mycontainer.procs: "1. write(PID)" {
  style.stroke: red
  style.animated: true
}
host_process -> v1.cpu_tree.mycontainer.procs: "2. write(PID)" {
  style.stroke: red
  style.animated: true
}
host_process -> v1.pids_tree.mycontainer.procs: "3. write(PID)" {
  style.stroke: red
  style.animated: true
}

host_process -> v2.unified_tree.mycontainer.procs: "Atomic write(PID)" {
  style.stroke: green
  style.stroke-width: 4
}

# --- COMPARISON TABLE ---
mapping_table: {
  label: |'md
    ### File Name & API Migration
    | Function | cgroups v1 (Legacy) | cgroups v2 (Unified) |
    | :--- | :--- | :--- |
    | **Memory Limit** | `memory.limit_in_bytes` | `memory.max` |
    | **CPU Quota** | `cpu.cfs_quota_us` | `cpu.max` (quota part) |
    | **CPU Period** | `cpu.cfs_period_us` | `cpu.max` (period part) |
    | **CPU Usage** | `cpuacct.usage` | `cpu.stat` |
    | **Process Max** | `pids.max` | `pids.max` |
    | **Hierarchy** | Multiple mounts (per-subsys) | Single mount (unified) |
  '|
  near: bottom-center
}