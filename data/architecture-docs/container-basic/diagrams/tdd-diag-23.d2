direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

memory_oom_sequence: {
  shape: sequence_diagram

  process: "Container Process\n(Namespace-Local PID 1)" {
    style: {
      fill: "#E1F5FE"
      stroke: "#01579B"
    }
  }
  cpu_mmu: "Hardware CPU / MMU\n(Level 3)" {
    style: {
      fill: "#FFF3E0"
      stroke: "#E65100"
    }
  }
  kernel_pf: "Kernel PF Handler\n(do_page_fault)" {
    style: {
      fill: "#F3E5F5"
      stroke: "#4A148C"
    }
  }
  cgroup_mem: "Memory Cgroup Controller\n(mem_cgroup_charge)" {
    style: {
      fill: "#F3E5F5"
      stroke: "#4A148C"
    }
  }
  oom_killer: "Kernel OOM Killer\n(Out-of-Memory)" {
    style: {
      fill: "#FFEBEE"
      stroke: "#B71C1C"
    }
  }

  # --- VIRTUAL ALLOCATION ---
  process -> kernel_pf: "malloc(10MB) / mmap(2)" {
    style.stroke: "#01579B"
  }
  process."Success via overcommit;\nno physical pages assigned yet."
  kernel_pf -> process: "return virt_addr"

  # --- PHYSICAL ACCESS ---
  process -> cpu_mmu: "memset(virt_addr, 0, 10MB)" {
    style.stroke: "#E65100"
  }
  cpu_mmu -> kernel_pf: "#PF Exception (Access unmapped page)" {
    style.stroke: red
  }

  # --- KERNEL HANDLING ---
  kernel_pf -> kernel_pf: "handle_mm_fault()"
  kernel_pf -> kernel_pf: "do_anonymous_page()"
  
  kernel_pf -> cgroup_mem: "▼ mem_cgroup_charge(page)"
  cgroup_mem -> cgroup_mem: "Read memory.current vs memory.max"

  # --- BRANCH: LIMIT EXCEEDED ---
  oom_failure: {
    cgroup_mem -> cgroup_mem: "try_charge_memcg()" {
      style.stroke: red
    }
    cgroup_mem."Attempt to free page cache..."
    cgroup_mem -> oom_killer: "out_of_memory(cgroup)" {
      style.stroke: red
    }
    
    oom_killer -> process: "send SIGKILL" {
      style: {
        stroke: red
        stroke-width: 4
        animated: true
      }
    }
    
    process -> process: "! CEASE EXECUTION !" {
      style: {
        fill: red
        bold: true
      }
    }
    
    oom_killer -> kernel_pf: "dmesg: CONSTRAINT_MEMCG"
    kernel_pf."Process reaped by host;\nno errno returned."
  }
  
  cgroup_mem -> kernel_pf: "▲ Charge Complete"
}

# Moved to root level to resolve compiler error: constant near keys can only be set on root level shapes
footer: |md
  ### OOM Semantics
  - **Invisibility**: `malloc()` returns success; the crash occurs at access time.
  - **Physicality**: Enforcement is tied to hardware `#PF` exceptions.
  - **Finality**: `SIGKILL` cannot be handled; process table entry cleared.
| {
  near: bottom-center
}