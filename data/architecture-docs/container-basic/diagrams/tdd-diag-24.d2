direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: "CFS CPU Throttling: 50ms Quota / 100ms Period" {
  shape: text
  style: {
    font-size: 24
    bold: true
  }
}

# --- TIMELINE CONTAINER ---
timeline: {
  style.stroke-width: 0
  
  # X-Axis Markers
  axis: {
    grid-columns: 4
    grid-gap: 0
    t0: "0ms" { shape: text }
    t50: "50ms" { shape: text }
    t100: "100ms" { shape: text }
    t150: "150ms" { shape: text }
  }

  # ROW 1: CPU Activity
  cpu_activity: "Container CPU Activity" {
    grid-columns: 4
    grid-gap: 2
    
    p1_run: "RUNNING" {
      width: 200
      style: { fill: "#d1e7dd"; stroke: "#0f5132"; font-color: "#0f5132"; bold: true }
    }
    p1_pause: "**THROTTLED**" {
      width: 200
      style: { fill: "#f8d7da"; stroke: "#842029"; font-color: "#842029"; bold: true }
    }
    p2_run: "RUNNING" {
      width: 200
      style: { fill: "#d1e7dd"; stroke: "#0f5132"; font-color: "#0f5132"; bold: true }
    }
    p2_pause: "**THROTTLED**" {
      width: 200
      style: { fill: "#f8d7da"; stroke: "#842029"; font-color: "#842029"; bold: true }
    }
  }

  # ROW 2: Counter State
  runtime_counter: "runtime_remaining (μs)" {
    grid-columns: 4
    grid-gap: 2
    
    c1_drop: "50000 ↘ 0" {
      width: 200
      shape: parallelogram
      style: { fill: "#cfe2ff"; stroke: "#084298" }
    }
    c1_zero: "0 (Exhausted)" {
      width: 200
      style: { fill: "#e2e3e5"; stroke: "#41464b"; stroke-dash: 3 }
    }
    c2_refill: "Refill: 50000 ↘ 0" {
      width: 200
      shape: parallelogram
      style: { fill: "#cfe2ff"; stroke: "#084298" }
    }
    c2_zero: "0 (Exhausted)" {
      width: 200
      style: { fill: "#e2e3e5"; stroke: "#41464b"; stroke-dash: 3 }
    }
  }

  # ROW 3: Run Queue
  run_queue: "Scheduler Run Queue" {
    grid-columns: 4
    grid-gap: 2
    
    q1_active: "Thread: ACTIVE" {
      width: 200
      style: { fill: "#d1e7dd"; stroke: "#0f5132" }
    }
    q1_removed: "Thread: REMOVED" {
      width: 200
      style: { opacity: 0.3; stroke-dash: 5 }
    }
    q2_active: "Thread: ACTIVE" {
      width: 200
      style: { fill: "#d1e7dd"; stroke: "#0f5132" }
    }
    q2_removed: "Thread: REMOVED" {
      width: 200
      style: { opacity: 0.3; stroke-dash: 5 }
    }
  }
}

# --- ANNOTATIONS ---

throttled_inc: |md
  ### cpu.stat metrics
  `throttled_usec` increments 
  continuously during **RED** bars.
  `nr_throttled` += 1 at 50ms.
| {
  near: top-right
  style.font-size: 12
}

latency_spike: |md
  ### Boundary-Straddling Request
  1. **Start (40ms):** Process begins work.
  2. **Stall (50ms):** Quota hits 0. Removed from Queue.
  3. **Wait (50-100ms):** Blocked for 50ms.
  4. **Resume (100ms):** hrtimer refilled quota.
  5. **Finish (110ms):** Completes final 10ms work.
  **Total Latency: 70ms** (Baseline: 20ms)
| {
  near: bottom-left
  style: {
    stroke: "#842029"
    stroke-width: 2
    fill: "#fff3cd"
  }
}

# --- ALGORITHM STEPS ---
steps: {
  grid-columns: 1
  near: bottom-right

  1: "0ms: hrtimer triggers. runtime_remaining = 50000. Threads moved to Run Queue."
  2: "0-50ms: CPU cycles consumed. runtime_remaining decrements via scheduler accounting."
  3: "50ms: runtime_remaining == 0. Threads removed from Run Queue. **nr_throttled** increments."
  4: "50-100ms: Threads sleep in 'throttle' list. CPU sits idle even if available."
  5: "100ms: Next period starts. Cycle repeats."
}

# --- CONNECTIONS TO SHOW FLOW ---
timeline.cpu_activity.p1_pause -> throttled_inc: "Causes" { style.stroke: red }
timeline.runtime_counter.c1_zero -> timeline.cpu_activity.p1_pause: "Trigger" { style.stroke-dash: 3 }
timeline.axis.t100 -> timeline.runtime_counter.c2_refill: "hrtimer refill" { style.animated: true }