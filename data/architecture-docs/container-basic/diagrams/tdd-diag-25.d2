direction: right
layout-engine: elk
theme-id: 4

# Metadata: Milestone 4 - Cgroup pids.max Enforcement
# Function: copy_process() kernel path validation

unconstrained: "SCENARIO A: No Resource Limits" {
  step_1: "Step 1: t=0ms" {
    label: "Processes: 1\nStatus: OK"
  }
  step_2: "Step 2: t=100ms" {
    label: "Processes: 2\nStatus: Initializing"
  }
  step_3: "Step 3: t=500ms" {
    label: "Processes: 1024\nStatus: High Load"
  }
  step_4: "Step 4: t=1000ms" {
    label: "Processes: **32,768**\nStatus: PID EXHAUSTION"
    style: {
      fill: "#ffcccc"
      stroke: red
      font-color: red
    }
  }
  step_5: "Step 5: Final" {
    label: "SYSTEM HANG\nKernel Unresponsive"
    style: {
      fill: red
      font-color: white
      bold: true
    }
  }

  step_1 -> step_2 -> step_3 -> step_4 -> step_5: "Exponential Growth"
}

constrained: "SCENARIO B: pids.max=32 Enforcement" {
  step_1: "Step 1: t=0ms" {
    label: "Processes: 1\nStatus: OK"
  }
  step_2: "Step 2: t=100ms" {
    label: "Processes: 2\nStatus: Forking..."
  }
  step_3: "Step 3: t=200ms" {
    label: "Processes: 16\nStatus: Contained"
  }
  step_4: "Step 4: t=300ms" {
    label: "Processes: **32**\nStatus: LIMIT HIT"
    style: {
      fill: "#e6f3ff"
      stroke: blue
      font-color: blue
    }
  }
  step_5: "Step 5: t=400ms+" {
    label: "Processes: **32**\nStatus: STABLE / EAGAIN"
    style: {
      fill: "#ccffcc"
      stroke: green
      font-color: "#006600"
      bold: true
    }
  }

  step_1 -> step_2 -> step_3 -> step_4 -> step_5: "Ceiling Reach"
}

kernel_logic: ||md
  ### Kernel Enforcement Path: `kernel/fork.c`
  1. `fork()` / `clone()` called in container.
  2. `copy_process()` initiated.
  3. **Check**: `task_pids_current(cgroup)` vs `pids_max`.
  4. **Decision**: If `count >= 32`, return **-EAGAIN**.
  5. **Userland**: `errno` set to `EAGAIN`.
  6. **Output**: `bash: fork: Resource temporarily unavailable`.
|| {
  near: top-right
  style: {
    stroke: blue
    stroke-dash: 3
  }
}

unconstrained.step_4 -> kernel_logic: "Global PID Table Full" {
  style: {
    stroke: red
    opacity: 0.5
  }
}

constrained.step_4 -> kernel_logic: "Atomic Counter Block" {
  style: {
    stroke: green
    stroke-width: 2
  }
}

# Total size annotation
sizeof_metadata: |md
  **Physical Constraint**: 
  - Atomic comparison cost: ~15ns
  - Memory overhead: 8 bytes (counter)
  - Recovery: Immediate (shell process persists)
| {
  near: bottom-right
}