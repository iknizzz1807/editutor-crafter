vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# States with Invariants
UNCREATED: "â— UNCREATED" {
  shape: circle
  description: "Invariant: Path does not exist in /sys/fs/cgroup hierarchy."
}

CREATED: "CREATED" {
  description: "Invariant: Directory exists; controllers enabled; cgroup.procs is empty."
}

ACTIVE: "ACTIVE" {
  description: "Invariant: Container PID 1 assigned; Resource counters hot; Limits enforced."
}

DRAINING: "DRAINING" {
  description: "Invariant: PID 1 terminated; Namespace cleanup in progress; Orphans exist."
}

DEAD: "DEAD" {
  description: "Invariant: Task count is 0; No active kernel references; Ready for rmdir."
}

CLEANED: "CLEANED" {
  description: "Invariant: Directory removed; Kernel slab memory released."
}

# Valid Transitions: Trigger [Guard] / Action
UNCREATED -> CREATED: "mkdir() / VFS node created"
CREATED -> ACTIVE: "write(cgroup.procs, pid) [pid_valid] / Task migration"
ACTIVE -> DRAINING: "SIGKILL / exit() / Kernel triggers cgroup_exit"
DRAINING -> DEAD: "waitpid() [return == ECHILD] / Reaper loop complete"
DEAD -> CLEANED: "rmdir() / Directory removal"

# Illegal Transitions
ACTIVE -> CLEANED: "rmdir() [ILLEGAL]" {
  label: "EBUSY: Processes still in group"
  style: {
    stroke: red
    stroke-dash: 5
    font-color: red
  }
}

CLEANED -> ACTIVE: "write(cgroup.procs) [ILLEGAL]" {
  label: "ENOENT: Path does not exist"
  style: {
    stroke: red
    stroke-dash: 5
    font-color: red
  }
}

# Formatting
UNCREATED.style.fill: "#f0f0f0"
ACTIVE.style.stroke-width: 4
CLEANED.style.stroke-dash: 3