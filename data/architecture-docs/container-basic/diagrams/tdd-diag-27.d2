direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

memory_layout: "Part 1: cgroup_config_t Memory Layout" {
  style: {
    stroke: "#8e44ad"
    stroke-width: 2
    fill: "#f8f0fb"
  }

  layout: {
    grid-columns: 1
    grid-gap: 0

    h: "0x00 | memory_limit_bytes | 8B" {
      style: { fill: "#3498db"; font-color: white }
    }
    c1: "0x08 | cpu_quota_us | 8B" {
      style: { fill: "#3498db"; font-color: white }
    }
    c2: "0x10 | cpu_period_us | 8B" {
      style: { fill: "#3498db"; font-color: white }
    }
    p: "0x18 | pids_max | 4B" {
      style: { fill: "#3498db"; font-color: white }
    }
    pad: "0x1C | padding | 4B" {
      style: { fill: "#95a5a6"; font-color: white }
    }
  }
}

# Fix: Moved near-constrained shape to root level
layout_annotation: |md
  ### sizeof = 32 bytes
  **Cache Line Boundary (64B)**
  The struct occupies 50% of a single L1 cache line.
| {
  near: bottom-center
}

data_flow: "Part 2: cg_write Data Flow" {
  style: {
    stroke: "#8e44ad"
    fill: "#f8f9fa"
  }

  struct: "cgroup_config_t" {
    style.fill: "#3498db"
    style.font-color: white
    mem: "memory_limit_bytes"
    cpu_q: "cpu_quota_us"
    cpu_p: "cpu_period_us"
    pids: "pids_max"
  }

  format: "Formatting (sprintf)" {
    f1: "snprintf(buf, '%ld')"
    f2: "snprintf(buf, '%ld %ld')"
    f3: "snprintf(buf, '%d')"
  }

  helper: "cg_write_str(dir, file, value)" {
    style.fill: "#8e44ad"
    style.font-color: white
    
    op: "1. open(path, O_WRONLY)"
    wr: "2. write(fd, value, len)"
    cl: "3. close(fd)"
    
    op -> wr -> cl
  }

  vfs: "VFS (/sys/fs/cgroup/...)" {
    m_max: "memory.max"
    c_max: "cpu.max"
    p_max: "pids.max"
    
    m_max.style.fill: "#2ecc71"
    c_max.style.fill: "#2ecc71"
    p_max.style.fill: "#2ecc71"
  }

  # Connections
  struct.mem -> format.f1
  struct.cpu_q -> format.f2
  struct.cpu_p -> format.f2
  struct.pids -> format.f3

  format.f1 -> helper: "file='memory.max'"
  format.f2 -> helper: "file='cpu.max'"
  format.f3 -> helper: "file='pids.max'"

  helper -> vfs.m_max: { style.stroke: "#e67e22" }
  helper -> vfs.c_max: { style.stroke: "#e67e22" }
  helper -> vfs.p_max: { style.stroke: "#e67e22" }
}

memory_layout -> data_flow: "Field Access" {
  style.stroke: "#e67e22"
  style.stroke-dash: 3
}