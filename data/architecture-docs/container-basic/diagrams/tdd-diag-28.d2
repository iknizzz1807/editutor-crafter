direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  # UID/GID Mapping â€” Inside vs Outside Translation Table
  *Milestone 5: User Namespace Transformation*
| {near: top-center}

mapping_table: {
  grid-columns: 3
  grid-gap: 50
  
  inside: Inside Container (user namespace) {
    style.fill: "#E4DBFE"
    root_in: "UID 0\n(root)" {
      style.fill: "#B6DDF6"
      style.bold: true
    }
    unmapped_in: "UID 1\n(unmapped)" {
      style.fill: "#DEE1EB"
    }
  }

  kernel: Kernel Translation Engine {
    style.stroke-dash: 3
    
    map_struct: struct user_namespace {
      shape: sql_table
      uid_map: "uid_gid_map_entry[]" {constraint: "0 1000 1"}
      gid_map: "uid_gid_map_entry[]" {constraint: "0 1000 1"}
      parent: "struct user_namespace*"
      flags: "deny_setgroups"
    }

    logic: |md
      ### Translation Algorithm
      **Forward (Process):**
      `target = entry.outside + (uid - entry.inside)`
      **Reverse (VFS/Stat):**
      `target = entry.inside + (disk_uid - entry.outside)`
    |

    memory_layout: ||md
      ### struct uid_gid_map_entry (kernel internal)
      c
      struct uid_gid_extent {
          u32 first;       /* Inside ID */
          u32 lower_first; /* Outside ID */
          u32 count;
      };
      
      *Size:* 12 bytes per entry. 
      *Max entries:* 340 (Linear scan complexity: O(N))
    || {
      style.font-size: 12
    }
  }

  outside: Outside Host (initial namespace) {
    style.fill: "#C7F1FF"
    alice_out: "UID 1000\n(alice)" {
      style.fill: "#B6DDF6"
      style.bold: true
    }
    nobody_out: "UID 65534\n(nobody)" {
      style.fill: "#DEE1EB"
    }
  }

  # Forward Path: Process Identity
  inside.root_in -> kernel.map_struct: "1. getuid() syscall" {
    style.stroke: orange
    style.stroke-width: 2
    style.animated: true
  }
  kernel.map_struct -> outside.alice_out: "2. mapped identity" {
    style.stroke: orange
    style.stroke-width: 2
  }

  # Reverse Path: Filesystem Stat
  outside.alice_out -> kernel.map_struct: "1. stat() disk_uid=1000" {
    style.stroke: blue
    style.stroke-width: 2
    style.animated: true
  }
  kernel.map_struct -> inside.root_in: "2. returns UID 0" {
    style.stroke: blue
    style.stroke-width: 2
  }

  # Fallback Path
  inside.unmapped_in -> kernel.map_struct: "lookup fails" {style.stroke-dash: 2}
  kernel.map_struct -> outside.nobody_out: "overflow_uid" {style.stroke-dash: 2}
}

footer: |md
  **Write Format:** `echo "inside_start outside_start count" > /proc/<pid>/uid_map`
  **Security Invariant:** Effective capabilities (`CapEff`) are elevated to full set *only* within the scope of the target user namespace resources.
| {near: bottom-center}