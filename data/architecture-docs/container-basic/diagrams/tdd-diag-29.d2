direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# Mandatory ordering state machine for unprivileged user namespace setup
# Milestone 5: User Namespace and Rootless Containers

kernel_rules: |md
  ### Kernel Enforcement Context
  - **Linux 3.19+**: Mandatory `setgroups=deny` before `gid_map` for unprivileged creators (CVE-2014-8989).
  - **Atomic Elevation**: Capabilities are granted when the `gid_map` file descriptor is closed.
  - **Write-Once Policy**: `uid_map` and `gid_map` allow exactly one `write()` call per lifetime.
| {
  near: top-right
}

states: {
  START: "â— START" {
    shape: circle
    tooltip: "Born into new namespace via clone(CLONE_NEWUSER)"
    style: {
      fill: "#f8f9fa"
      stroke: "#343a40"
      stroke-width: 2
    }
  }

  UID_MAPPED: "UID_MAPPED" {
    tooltip: "Host UID mapped to Namespace UID 0"
    "Invariant": |md
      - `getuid()` returns 65534 (nobody)
      - `CapEff` is still empty
    |
  }

  SETGROUPS_DENIED: "SETGROUPS_DENIED" {
    tooltip: "Supplementary group changes disabled"
    "Invariant": |md
      - `setgroups()` syscall returns `EPERM`
      - Prerequisite for `gid_map` satisfied
    |
  }

  GID_MAPPED: "GID_MAPPED" {
    tooltip: "Host GID mapped to Namespace GID 0"
    "Invariant": |md
      - **CAPABILITIES ELEVATED**
      - `getuid()` returns 0
      - `CapEff` bitmask fully populated
    |
  }

  FULLY_CONFIGURED: "FULLY_CONFIGURED" {
    style: {
      double-border: true
      fill: "#d4edda"
      stroke: "#28a745"
    }
  }

  ERROR_EPERM: "EPERM / INVALID" {
    style: {
      fill: "#f8d7da"
      stroke: "#dc3545"
      font-color: "#721c24"
    }
  }
}

# Happy Path Transitions
states.START -> states.UID_MAPPED: "write(uid_map, '0 1000 1')" {
  style: {
    stroke: "#007bff"
    bold: true
  }
}

states.UID_MAPPED -> states.SETGROUPS_DENIED: "write(setgroups, 'deny')" {
  style: {
    stroke: "#007bff"
    bold: true
  }
}

states.UID_MAPPED -> states.ERROR_EPERM: "write(gid_map)" {
  label: "ILLEGAL: Missing setgroups"
  style: {
    stroke: "#dc3545"
    stroke-dash: 5
  }
}

states.SETGROUPS_DENIED -> states.GID_MAPPED: "write(gid_map, '0 1000 1')" {
  style: {
    stroke: "#007bff"
    bold: true
  }
}

states.GID_MAPPED -> states.FULLY_CONFIGURED: "write(sync_pipe, '1')" {
  style: {
    stroke: "#28a745"
    bold: true
  }
}

# Illegal / Error Transitions
states.UID_MAPPED -> states.ERROR_EPERM: "write(uid_map)" {
  label: "ILLEGAL: Write Once Policy"
  style: {
    stroke: "#dc3545"
    stroke-dash: 5
  }
}

states.UID_MAPPED -> states.FULLY_CONFIGURED: "write(sync_pipe)" {
  label: "RACE: Container starts as 'nobody'"
  style: {
    stroke: "#ffc107"
    stroke-dash: 3
  }
}

legend: {
  near: bottom-center
  label: "State Definitions & Security Invariants"
  
  blue_arrow: "Valid Procedural Call" {
    style.stroke: "#007bff"
  }
  red_dashed: "Kernel-Blocked Transition (EPERM)" {
    style: {
      stroke: "#dc3545"
      stroke-dash: 5
    }
  }
  yellow_dashed: "Race Condition / Insecure State" {
    style: {
      stroke: "#ffc107"
      stroke-dash: 3
    }
  }
}