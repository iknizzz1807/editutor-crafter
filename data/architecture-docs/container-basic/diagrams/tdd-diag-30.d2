layout-engine: elk
theme-id: 4

capability_scoping: {
  label: "Capability Scoping â€” Container Process Kernel Capability Check"

  # Step 1: Input / Syscall Trigger
  step1: |md
    ### 1. SYSCALL ENTRY
    **Call**: `mount(source, target, ...)`
    **Required**: `CAP_SYS_ADMIN` (bit 21)
  | {
    shape: rectangle
    style: {
      stroke: "#6a0dad"
      stroke-width: 4
    }
  }

  # Step 2: Internal Process Bitmask Check
  step2: |md
    ### 2. EFFECTIVE SET CHECK
    Kernel inspects `current->cred->cap_effective`
    **State**: Bit 21 is **SET** (Full caps in USERNs)
    **Result**: Continue to scoping check
  | {
    shape: rectangle
    style: {
      stroke: "#0000ff"
      stroke-width: 2
    }
  }

  # Step 3: Resource Ownership Resolution
  step3: "3. RESOURCE OWNER LOOKUP" {
    grid-columns: 2
    
    path_success: |md
      **SCENARIO A: Private Resource**
      **Target**: Private Mount Namespace
      **Owner**: `container_user_ns`
      (Created via `CLONE_NEWNS`)
    | {
      style.fill: "#e6fffa"
    }
    
    path_failure: |md
      **SCENARIO B: Host Resource**
      **Target**: `/dev/sda1` (Physical Disk)
      **Owner**: `initial_user_ns` (Host Root)
    | {
      style.fill: "#fff5f5"
    }
  }

  # Step 4: Namespace Comparison Logic
  step4: "4. NAMESPACE COMPARISON" {
    shape: diamond
    label: "ns_capable(target_ns, CAP_SYS_ADMIN)?"
  }

  # Step 5: Final Outcomes
  outcome_allow: |md
    **5a. PERMITTED**
    Operation allowed in scope of User Namespace
  | {
    style: {
      fill: "#c6f6d5"
      stroke: "#2f855a"
      bold: true
    }
  }

  outcome_deny: |md
    **5b. EPERM**
    Operation Denied: Cross-Namespace Privilege Escalation
  | {
    style: {
      fill: "#fed7d7"
      stroke: "#c53030"
      bold: true
    }
  }

  # Connections
  step1 -> step2
  step2 -> step3
  step3.path_success -> step4: "Caller NS == Target NS"
  step3.path_failure -> step4: "Caller NS != Target NS"
  
  step4 -> outcome_allow: "MATCH" {
    style.stroke: "#2f855a"
  }
  step4 -> outcome_deny: "MISMATCH" {
    style: {
      stroke: "#c53030"
      stroke-dash: 5
    }
  }
}

# Annotation (Moved to root level to support 'near' key)
annotation: |md
  **Technical Invariant**: 
  Capability scoping is not about having the bit; it is about the bit being valid for the 
  **target resource's owning namespace**.
| {
  near: bottom-center
  style: {
    stroke: gray
    fill: "#f7fafc"
    font-size: 14
  }
}

# Documentation Metadata
total_size: "sizeof=Logic Flow (O(1) Kernel Path)" {
  near: top-right
  shape: text
}