direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

rootful: "ROOTFUL CONTAINER (Legacy)" {
  runtime: "Host Runtime" {
    shape: class
    "UID": "uint32: 0 (root)"
    "Privilege": "string: Global CAP_SYS_ADMIN"
    "sizeof": "Global Scope"
  }

  kernel: "Linux Kernel Boundary" {
    style.stroke-dash: 5
    style.stroke: "#666666"
  }

  container: "Container Process" {
    shape: class
    "CAP_EFF": "uint64: 0x3FFFFFFFFF"
    "UID_MAP": "int: 0 -> 0"
    "clone(flags)": "NEWPID|NEWNS|NEWNET"
    "sizeof": "4096B (Page Boundary)"
  }

  escape: "CONTAINER ESCAPE" {
    style.fill: "#ffcfcf"
    style.stroke: red
    impact: |md
      - **FULL HOST ROOT ACCESS**
      - Load Kernel Modules
      - Mount Physical Disks
      - Kill Host Processes
    |
  }

  runtime -> kernel -> container
  container -> escape: "CRITICAL FAILURE" {
    style.stroke: red
    style.animated: true
  }
}

rootless: "ROOTLESS CONTAINER (Modern)" {
  runtime: "Host Runtime" {
    shape: class
    "UID": "uint32: 1000 (user)"
    "Privilege": "string: Unprivileged"
    "sizeof": "User Scope"
  }

  kernel: "Linux Kernel Boundary" {
    style.stroke-dash: 5
    style.stroke: "#666666"
  }

  container: "Container Process" {
    shape: class
    "CAP_EFF": "uint64: 0x00000000"
    "UID_MAP": "int: 0 -> 1000"
    "clone(flags)": "NEWUSER|NEWPID|NEWNS|NEWNET"
    "sizeof": "4096B (Page Boundary)"
  }

  escape: "CONTAINER ESCAPE" {
    style.fill: "#d5f5e3"
    style.stroke: green
    impact: |md
      - **UNPRIVILEGED USER ACCESS**
      - Bounded Blast Radius (UID 1000)
      - Cannot Modify Kernel
      - Host Files Protected
    |
  }

  runtime -> kernel -> container
  container -> escape: "MITIGATED RISK" {
    style.stroke: green
  }
}

isolation_note: |md
  ### Security Analysis
  Both architectures provide the **same visibility isolation** (PID, Mount, Network, UTS).
  However, they have **categorically different escape consequences** due to the user namespace mapping.
| {
  near: bottom-center
}

# Technical Design Artist: Intel Manual Color Scheme
# Header=Purple, Data=Blue
rootful.runtime.style.fill: "#e1d5e7"
rootful.container.style.fill: "#dae8fc"
rootless.runtime.style.fill: "#fff2cc"
rootless.container.style.fill: "#dae8fc"

# Page Boundary Annotation
rootful.container.style.stroke-width: 4
rootless.container.style.stroke-width: 4