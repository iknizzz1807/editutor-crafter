direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# --- Pointer Chain ---
pointer_chain: {
  direction: right
  task_struct: "task_struct\n(PID 47832)" {
    style.fill: "#E1D5E7"
  }
  cred: "struct cred\n(Effective IDs)" {
    style.fill: "#DAE8FC"
  }
  user_ns_ptr: "user_ns*" {
    shape: circle
    style.fill: "#FFE6CC"
  }

  task_struct -> cred: "current->cred" {style.stroke: "#FFA500"}
  cred -> user_ns_ptr: "cred->user_ns" {style.stroke: "#FFA500"}
}

# --- Memory Layout of user_namespace ---
user_namespace: "struct user_namespace (sizeof=~400B)" {
  style.fill: "#E1D5E7"
  
  # Cache Line 1
  cl1: "CACHE LINE 0 (64B)" {
    style.stroke-dash: 5
    
    uid_map: {
      shape: sql_table
      style.stroke: "#DAE8FC"
      0x00: "nr_extents" {constraint: "4B"}
      0x04: "extent[0].first (inside)" {constraint: "4B"}
      0x08: "extent[0].lower (outside)" {constraint: "4B"}
      0x0C: "extent[0].count" {constraint: "4B"}
      0x10: "extent[1..4] / Padding" {
        constraint: "48B"
        style.fill: "#F5F5F5"
      }
    }
  }

  # Cache Line 2
  cl2: "CACHE LINE 1 (128B)" {
    style.stroke-dash: 5
    
    gid_map: {
      shape: sql_table
      style.stroke: "#DAE8FC"
      0x40: "nr_extents" {constraint: "4B"}
      0x44: "extent[0].first" {constraint: "4B"}
      0x48: "extent[0].lower" {constraint: "4B"}
      0x4C: "extent[0].count" {constraint: "4B"}
      0x50: "extent[1..4] / Padding" {
        constraint: "48B"
        style.fill: "#F5F5F5"
      }
    }
  }

  # Cache Line 3 - Core Metadata
  cl3: "CACHE LINE 2 (192B)" {
    style.stroke-dash: 5
    
    metadata: {
      shape: sql_table
      style.stroke: "#DAE8FC"
      0x80: "projid_map" {constraint: "64B"; style.fill: "#F5F5F5"}
      0xC0: "parent*" {constraint: "8B"; style.fill: "#FFE6CC"}
      0xC8: "owner (kuid_t)" {constraint: "4B"}
      0xCC: "level (int)" {constraint: "4B"}
      0xD0: "flags (uint)" {constraint: "4B"}
      0xD4: "ucounts*" {constraint: "8B"; style.fill: "#FFE6CC"}
    }
  }

  # Remaining Structure
  cl_remaining: "CACHE LINES 3-6 (Remainder)" {
    style.fill: "#D5E8D4"
    content: "Keyrings, proc_inum, work_struct, etc. (~200B)"
  }
}

# --- Connections ---
pointer_chain.user_ns_ptr -> user_namespace: "dereference" {
  style.stroke: "#FFA500"
  style.stroke-width: 4
}

# --- Page Boundary Marker ---
page_boundary: "PAGE BOUNDARY (4096B)" {
  height: 20
  style.stroke-width: 8
  style.stroke: black
  style.fill: black
  style.font-color: white
}

user_namespace -> page_boundary: "SLAB offset alignment" {style.stroke-dash: 3}

# --- Annotations ---
annotation: |md
  ### Analysis: UID Translation Path
  - **UID Mapping**: The `uid_map` contains `uid_gid_extent` structs. 
  - **Typical Case**: Only 1 entry is used (e.g., 0 1000 1).
  - **Translation**: Kernel performs a linear scan of `extents`.
  - **Latency**: Single entry check is ~3-10ns.
  - **Security**: The `parent` pointer ensures hierarchical capability checks.
| {
  near: top-right
}