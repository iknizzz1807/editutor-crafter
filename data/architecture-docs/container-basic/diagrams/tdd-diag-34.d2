layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

title: |md
  # Rootless Networking Alternatives
  ### slirp4netns vs pasta vs Host Network
| {near: top-center}

boundary_note: |md
  **THE HARD BOUNDARY OF USER NAMESPACES**
  `CAP_NET_ADMIN` in the *initial* network namespace is required for cross-namespace `veth` moves. 
  Unprivileged user namespaces lack this authority, necessitating userspace stacks or direct sharing.
| {
  near: top-right
  style: {
    stroke: red
    stroke-width: 2
    fill: "#FFF2CC"
  }
}

trad: "veth + bridge (Host Root Required)" {
  perf: "Performance: 15-40μs RTT"
  case: "Use Case: Standard Docker/K8s"
  
  eth0: "eth0: interface" {
    type: physical_nic
    mtu: 1500
    state: UP
  }
  
  ctr0: "ctr0: bridge" {
    type: linux_bridge
    ip: "172.20.0.1/24"
    mode: L2_switch
  }
  
  veth_h: "veth_h0: endpoint" {
    type: veth_pair
    peer: veth_c0
    master: ctr0
  }
  
  ns_gate: "Namespace Boundary (Root Needed to Cross)" {
    shape: text
    style.stroke-dash: 5
  }
  
  veth_c: "veth_c0: endpoint" {
    type: veth_pair
    ip: "172.20.0.2/24"
    ns: container_netns
  }

  eth0 <-> ctr0: "Routing/NAT"
  ctr0 <-> veth_h: "L2 Forward"
  veth_h <-> veth_c: "Kernel Skb Handoff"
  
  style.fill: "#f8f9fa"
}

slirp: "slirp4netns (Fully Rootless)" {
  perf: "Performance: 40-80% Lower Throughput"
  case: "Use Case: Rootless Podman/CI"

  socket: "Host Sockets: syscall" {
    api: BSD_socket
    context: unprivileged_user
    privilege: NONE
  }
  
  binary: "slirp4netns: process" {
    engine: "User-space TCP/IP Stack"
    buffer: "double_copy_overhead"
    logic: "translate_to_syscalls()"
  }
  
  tap: "tap0: device" {
    type: tuntap
    mode: TAP
    ns: container_netns
  }

  socket <-> binary: "Host Network Access"
  binary <-> tap: "L2 Frame Injection"
  
  style.fill: "#fff5f5"
}

hostnet: "Host Network (--network=host)" {
  perf: "Performance: 5-10μs RTT (Native)"
  case: "Use Case: High-Perf Services"

  shared: "Host Network Stack: resource" {
    interfaces: "eth0, wlan0, lo"
    routing: "Host Table"
    ports: "Global Port Space"
  }
  
  proc: "Container: process" {
    isolation: "PID/Mount/UTS ONLY"
    netns: "INITIAL (Host)"
  }

  proc <-> shared: "Direct Access (No Boundary)"
  
  style.fill: "#f3f0ff"
}

# Layout constraints to force 3 columns
trad -> slirp: {style.opacity: 0}
slirp -> hostnet: {style.opacity: 0}

# Styling
trad.eth0.style.fill: "#E1D5E7"
trad.ctr0.style.fill: "#DAE8FC"
trad.veth_h.style.fill: "#FFF2CC"
trad.veth_c.style.fill: "#D5E8D4"

slirp.socket.style.fill: "#E1D5E7"
slirp.binary.style.fill: "#F8CECC"
slirp.tap.style.fill: "#D5E8D4"

hostnet.shared.style.fill: "#DAE8FC"
hostnet.proc.style.fill: "#D5E8D4"

trad.perf.style.font-color: "#2B6CB0"
slirp.perf.style.font-color: "#C53030"
hostnet.perf.style.font-color: "#2F855A"