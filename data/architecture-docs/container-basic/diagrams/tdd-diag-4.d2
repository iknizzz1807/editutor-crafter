direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# State Definitions with Invariants
start: "" {
  shape: circle
  width: 20
  height: 20
  style.fill: black
}

INIT: {
  label: |md
    **INIT**
    ---
    **Invariant:** 
    - Inside Namespace
    - UID=65534 (Unmapped)
    - Effective Caps: 0
  |
}

RUNNING: {
  label: |md
    **RUNNING**
    ---
    **Invariant:** 
    - UID=0 (Mapped)
    - Full Capabilities
    - Main Child Process Alive
  |
}

DRAINING: {
  label: |md
    **DRAINING**
    ---
    **Invariant:** 
    - Main Child PID Reaped
    - Collecting Orphans
  |
}

DONE: {
  shape: rectangle
  style.double-border: true
  label: |md
    **DONE**
    ---
    **Invariant:** 
    - errno == ECHILD
    - Process Table Clean
  |
}

ERROR: "ZOMBIE_LEAK" {
  style.fill: red
  style.font-color: white
}

# Transitions: Trigger + [Guard] + Action
start -> INIT

INIT -> RUNNING: "Pipe Signal + fork()" {
  label: "Trigger: Host writes sync pipe\nAction: fork() + execvp() workload"
}

RUNNING -> RUNNING: "SIGCHLD / WNOHANG" {
  label: "Trigger: Orphan child terminates\nAction: waitpid() to release PID slot"
}

RUNNING -> DRAINING: "waitpid(main_pid) returns" {
  label: "Trigger: Primary workload exits\nAction: Set exit_status, enter final reap"
}

DRAINING -> DRAINING: "while(waitpid(-1) > 0)" {
  label: "Action: Reap all adopted orphans"
}

DRAINING -> DONE: "waitpid() == -1 [ECHILD]" {
  label: "Guard: No children remaining\nAction: exit(exit_status)"
}

# Illegal Transitions
RUNNING -> DONE: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
  style.font-color: red
}

RUNNING -> ERROR: "exit() while children > 0" {
  style: {
    stroke: red
    stroke-dash: 5
  }
  style.font-color: red
}

# Kernel Property Annotations
PID1_IMMUNITY: |md
  ### PID 1 System Properties
  - **Signal Shield**: Kernel ignores `SIGKILL` / `SIGTERM` from outside namespace unless explicitly handled.
  - **Adoption**: Any process whose parent dies is re-parented to this PID 1.
  - **Namespace Death**: When this process exits, the kernel immediately `SIGKILL`s all remaining processes in the namespace.
| {
  near: top-right
  style.fill: "#f8f0ff"
}

ANNOTATION: |md
  **TDD Spec Ref:** container-basic-m1 / Milestone 1
  **Total sizeof(ContainerConfig):** 88 bytes
| {
  near: top-left
}