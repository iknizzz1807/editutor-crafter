vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  # Zombie Reaping â€” WNOHANG Loop Algorithm
  **Mechanism:** Non-blocking status collection of orphaned children.
  **sizeof=Task Table Row (~1.2KB)**
| {near: top-center}

States: {
  grid-columns: 2
  horizontal-gap: 100

  before: "STATE: BEFORE REAPING (0x000)" {
    table: {
      shape: sql_table
      style.fill: "#f3f4f6"
      header: "Kernel Process Table" {
        style: {
          fill: "#6b21a8"
          font-color: white
        }
      }
      0: "0x00 | PID 1 (Init) | Running"
      1: "0x40 | PID 101      | <defunct> (Zombie)" {
        style: {
          fill: "#ef4444"
          font-color: white
          bold: true
          stroke-dash: 3 # Cache line boundary (64B)
        }
      }
      2: "0x80 | PID 102      | <defunct> (Zombie)" {
        style: {
          fill: "#ef4444"
          font-color: white
          bold: true
        }
      }
      3: "0xC0 | PID 103      | <defunct> (Zombie)" {
        style: {
          fill: "#ef4444"
          font-color: white
          bold: true
        }
      }
      4: "0x100 | PID 104      | Running"
    }
    legend: "PID Slots 101-103 consumed" {
      shape: text
    }
  }

  after: "STATE: AFTER REAPING (0x000)" {
    table: {
      shape: sql_table
      style.fill: "#f3f4f6"
      header: "Kernel Process Table" {
        style: {
          fill: "#6b21a8"
          font-color: white
        }
      }
      0: "0x00 | PID 1 (Init) | Running"
      1: "0x40 | **[FREE]**" {
        style: {
          fill: "#22c55e"
          font-color: white
          bold: true
          stroke: red
          stroke-width: 4
        }
      }
      2: "0x80 | **[FREE]**" {
        style: {
          fill: "#22c55e"
          font-color: white
          bold: true
          stroke: red
          stroke-width: 4
        }
      }
      3: "0xC0 | **[FREE]**" {
        style: {
          fill: "#22c55e"
          font-color: white
          bold: true
          stroke: red
          stroke-width: 4
        }
      }
      4: "0x100 | PID 104      | Running"
    }
    legend: "Resources released to Kernel" {
      shape: text
    }
  }
}

algorithm: "Wait Loop (WNOHANG)" {
  grid-columns: 1
  
  step1: "1. call waitpid(-1, &status, WNOHANG)" {
    shape: rectangle
    style.fill: "#dbeafe"
  }

  branch: "Check Return (rax)" {
    shape: diamond
    style.fill: "#fef3c7"
  }

  step2: "2. ret > 0: **Child Reaped**" {
    shape: rectangle
    style.stroke: "#ef4444"
    style.stroke-width: 4
    label: |md
      - Log: reaped PID {ret}
      - **Loop back to Step 1**
    |
  }

  step3: "3. ret == 0: **No more dead children**" {
    shape: rectangle
    label: |md
      - No status change detected
      - **Exit Loop**
    |
  }

  step4: "4. ret == -1 && errno == ECHILD" {
    shape: rectangle
    label: |md
      - No children exist in namespace
      - **Exit Loop**
    |
  }

  step5: "5. ret == -1 && errno == EINTR" {
    shape: rectangle
    label: |md
      - Call interrupted by signal
      - **Retry Step 1**
    |
  }

  step1 -> branch
  branch -> step2: "pid_t"
  branch -> step3: "0"
  branch -> step4: "-1 (ECHILD)"
  branch -> step5: "-1 (EINTR)"
  
  step2 -> step1: "Continue Reaping" {style.stroke-dash: 3; style.animated: true}
  step5 -> step1: "Retry" {style.stroke-dash: 3}
}

# Connections between states and logic
States.before -> algorithm.step1: "Algorithm Trigger"
algorithm.step3 -> States.after: "Reaping Complete"
algorithm.step4 -> States.after: "No Children"

# Annotations
notes: |md
  ### Algorithm Invariants
  - **WNOHANG (0x01)**: Ensures PID 1 does not block if no children are dead.
  - **-1 Target**: Reaps *any* child that has changed state (orphans adopted by Init).
  - **Memory Cleanup**: Kernel removes `task_struct` and `stack` only after this call.
| {
  near: bottom-center
}