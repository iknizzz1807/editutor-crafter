vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
    sketch: false
  }
}

proc_fs: "/proc/<pid>/" {
  shape: package
  style: {
    fill: "#E1D5E7"
    stroke-width: 2
    bold: true
  }

  status_node: "status" {
    shape: rectangle
    style.fill: "#DAE8FC"
    
    nspid_data: {
      label: ||md
        ### Field: NSpid
        | Context | Value | Encoding |
        | :--- | :--- | :--- |
        | **Host Namespace** | `47832 1` | `Tab-separated` |
        | **Child Namespace** | `1` | `Inner-most only` |
      ||
    }
  }

  ns_subdir: "ns/" {
    shape: package
    style.fill: "#DAE8FC"

    pid_link: "pid" {
      label: "pid -> pid:[4026532189]"
      style: {
        font: mono
        stroke-dash: 3
      }
    }
    
    uts_link: "uts" {
      label: "uts -> uts:[4026532190]"
      style: {
        font: mono
        stroke-dash: 3
      }
    }
    
    mnt_link: "mnt" {
      label: "mnt -> mnt:[4026531840]"
      style: {
        font: mono
        stroke-dash: 3
      }
    }
  }
}

# Syscall/Tool Interaction
nsenter_tool: "nsenter(1)" {
  shape: parallelogram
  style.fill: "#FFE6CC"
}

nsenter_tool -> proc_fs.ns_subdir: "1. open(path, O_RDONLY)" {
  style: {
    stroke: orange
    animated: true
  }
}

setns_call: "setns(fd, nstype)" {
  shape: package
  style.fill: "#D5E8D4"
}

proc_fs.ns_subdir -> setns_call: "2. Passing FD to kernel" {
  style.stroke: green
}

# Annotations
legend: {
  near: bottom-right
  label: ||md
    ## Namespace Debugging Mechanics
    - **NSpid**: In `status`, the kernel reports the task's PID in every namespace level it belongs to, from the root (initial) namespace to the innermost.
    - **Inode Links**: In `ns/`, the values represent the unique kernel inode identifying the namespace instance. Processes with matching numbers share that namespace.
    - **nsenter**: This utility joins namespaces by opening these file descriptors and invoking the `setns()` syscall.
  ||
  style: {
    font-size: 14
  }
}

# Component grouping for ELK - Invisible connection to help layout
proc_fs.status_node -> proc_fs.ns_subdir: {
  style: {
    stroke-width: 0
    opacity: 0
  }
}