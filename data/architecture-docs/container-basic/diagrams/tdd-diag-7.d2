vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  # container_config_t (Memory Layout)
  **sizeof = 120 bytes (Aligned to 8B boundary)**
  Growth Direction: ↓ (Struct Members) / ↑ (Stack Pointer)
| {
  near: top-center
}

legend: {
  near: bottom-right
  pointer: "Pointers (x86-64)" {
    style.fill: "#FFA500"
  }
  data: "Data/Buffers" {
    style.fill: "#ADD8E6"
  }
  padding: "Padding" {
    style.fill: "#D3D3D3"
  }
}

# --- STRUCT CONTAINER ---
struct_layout: "struct container_config_t" {
  style.fill: "#A020F0" # Header Purple
  
  # CACHE LINE 1: 0 - 64B
  CL1: "Cache Line 1 (0-63B)" {
    style: {
      stroke-dash: 5
      fill: white
    }
    
    argv: "0x00 | argv (char**) | 8B" {
      style.fill: "#FFA500"
    }
    
    hostname_p1: "0x08 | hostname [0:55] | 56B" {
      style.fill: "#ADD8E6"
    }
  }

  # CACHE LINE 2: 64 - 119B
  CL2: "Cache Line 2 (64-119B)" {
    style: {
      stroke-dash: 5
      fill: white
    }
    
    hostname_p2: "0x40 | hostname [56:63] | 8B" {
      style.fill: "#ADD8E6"
    }
    
    rootfs: "0x48 | rootfs (char*) | 8B" {
      style.fill: "#FFA500"
    }
    
    outbound_if: "0x50 | outbound_if (char*) | 8B" {
      style.fill: "#FFA500"
    }
    
    sync_pipe: "0x58 | sync_pipe (int) | 4B" {
      style.fill: "#ADD8E6"
    }
    
    host_uid: "0x5C | host_uid (uid_t) | 4B" {
      style.fill: "#ADD8E6"
    }
    
    host_gid: "0x60 | host_gid (gid_t) | 4B" {
      style.fill: "#ADD8E6"
    }
    
    pad: "0x64 | Alignment Padding | 4B" {
      style.fill: "#D3D3D3"
    }
    
    stack_base: "0x68 | stack_base (void*) | 8B" {
      style.fill: "#FFA500"
    }
    
    stack_size: "0x70 | stack_size (size_t) | 8B" {
      style.fill: "#ADD8E6"
    }
  }
}

# --- ANNOTATIONS ---
annotation_argv: |md
  #### CLONE_VM Semantics
  `argv` is passed as `void* arg` to `clone()`.
  Because `CLONE_VM` is **NOT** used, the child receives a
  **Copy-on-Write (CoW)** view of the memory.
| {
  near: top-right
}

annotation_stack: |md
  #### ABI Compliance
  `stack_base` must be 16-byte aligned
  for x86-64 ABI compatibility during
  the initial stack pointer setup.
| {
  near: center-right
}

# --- CONNECTIONS ---
struct_layout.CL1.argv -> annotation_argv: {
  style: {
    stroke: "#FFA500"
    stroke-dash: 3
  }
}

struct_layout.CL2.stack_base -> annotation_stack: {
  style: {
    stroke: "#FFA500"
    stroke-dash: 3
  }
}

struct_layout.CL1 -> struct_layout.CL2: "L1 Cache Boundary (64B)" {
  style: {
    stroke-width: 2
    stroke-dash: 2
  }
}