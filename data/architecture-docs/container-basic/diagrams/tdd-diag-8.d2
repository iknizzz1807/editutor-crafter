direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# Global Process/Namespace Stylings
classes: {
  process: {
    shape: class
    style: {
      stroke: "#333333"
      stroke-width: 2
    }
  }
  signal_flow: {
    style: {
      stroke: orange
      stroke-dash: 3
      animated: true
    }
  }
  ns_boundary: {
    style: {
      stroke: purple
      stroke-width: 4
      stroke-dash: 5
      fill: "#f8f0ff"
    }
  }
}

host: "HOST OS VIEW (Initial PID Namespace)" {
  systemd: "systemd" {
    class: process
    pid: "uint32_t (4 bytes) = 1"
    comm: "char[16] (16 bytes) = 'systemd'"
    sizeof: "task_struct ≈ 9 KB"
  }

  sudo: "sudo" {
    class: process
    pid: "uint32_t (4 bytes) = 47830"
    comm: "char[16] (16 bytes) = 'sudo'"
  }

  runtime: "container_m1 (The Runtime)" {
    class: process
    pid: "uint32_t (4 bytes) = 47831"
    comm: "char[16] (16 bytes) = 'container_m1'"
    sizeof: "task_struct ≈ 9 KB"
  }

  container_ns: "PID NAMESPACE SCOPE" {
    class: ns_boundary
    
    init: "container_init (PID 1)" {
      class: process
      pid: "uint32_t (4 bytes) = 47832"
      nspid: "uint32_t (4 bytes) = 1"
      state: "int32_t (4 bytes) = TASK_INTERRUPTIBLE"
    }

    bash: "/bin/bash" {
      class: process
      pid: "uint32_t (4 bytes) = 47833"
      nspid: "uint32_t (4 bytes) = 2"
      state: "int32_t (4 bytes) = TASK_RUNNING"
    }
  }

  # Ownership / Spawn relationships
  systemd -> sudo: "fork/exec"
  sudo -> runtime: "fork/exec"
  runtime -> container_ns.init: "clone(CLONE_NEWPID)"
  container_ns.init -> container_ns.bash: "fork/exec"

  # Signal Flows
  container_ns.bash -> container_ns.init: "SIGCHLD (Orphan re-parenting target)" { class: signal_flow }
  container_ns.init -> runtime: "SIGCHLD" { class: signal_flow }
}

container_view: "CONTAINER INTERNAL VIEW" {
  style: {
    fill: "#e6f3ff"
    stroke: "#004080"
    double-border: true
  }
  
  c_init: "container_init" {
    class: process
    pid: "uint32_t (4 bytes) = 1"
  }

  c_bash: "/bin/bash" {
    class: process
    pid: "uint32_t (4 bytes) = 2"
  }

  c_init -> c_bash: "owns"
}

# Logical Mapping Link
host.container_ns.init <-> container_view.c_init: "Same Kernel task_struct" {
  style.stroke-dash: 2
}

# Corrected Annotations (ELK supports constant strings for 'near')
note: |md
  ### Namespace Death Invariant
  - If **PID 1 (47832)** exits:
  - Kernel walks `child_reaper` list.
  - Sends **SIGKILL** to all members.
  - Result: **47833** is forcibly terminated.
| {
  near: top-right
}

reaper_logic: |md
  ### Init Responsibilities
  1. **Signal Immunity**: Ignores SIGKILL from outside unless handler installed.
  2. **Zombie Reaping**: Must call `waitpid(-1, ...)` to clear task_structs.
| {
  near: bottom-right
}

# Reparenting Arrow - Implements reparenting logic (Dashed references)
host.container_ns.bash -> host.container_ns.init: "Adopted if parent exits" {
  style.stroke-dash: 3
  target-arrowhead: triangle
}