# Log Compaction Process
title: Log Compaction Process {
  style.font-color: "#e6edf3"
  style.bold: true
}

# Named styles
classes: {
  decision: {
    style.fill: "#d63031"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
    style.bold: true
  }
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  storage: {
    style.fill: "#16213e"
    style.stroke: "#74b9ff"
    style.font-color: "#e6edf3"
  }
  rpc: {
    style.fill: "#0f3460"
    style.stroke: "#fd79a8"
    style.font-color: "#e6edf3"
  }
}

# Start node
start: {
  shape: circle
  style.fill: "#3fb950"
  label: ""
}

# Decision: Check log size
check_log: Check Log Size {
  shape: diamond
  class: decision
}

# Decision: Snapshot threshold reached?
threshold: Log Size > Threshold? {
  shape: diamond
  class: decision
}

# Snapshot creation process
snapshot_create: Create Snapshot {
  class: process
}

# Snapshot components
snapshot_meta: Save Snapshot\nMetadata {
  class: process
}

snapshot_data: Serialize State\nMachine Data {
  class: process
}

# Storage
disk_storage: {
  shape: cylinder
  label: Disk Storage
  class: storage
}

# Decision: Follower needs snapshot?
follower_check: Follower Behind\nSnapshot Index? {
  shape: diamond
  class: decision
}

# InstallSnapshot RPC flow
install_rpc: Send InstallSnapshot\nRPC {
  class: rpc
}

follower_receive: Follower Receives\nSnapshot Chunks {
  class: rpc
}

follower_apply: Apply Snapshot\nto State Machine {
  class: process
}

# Log truncation decision
truncate_check: Safe to Truncate\nOld Logs? {
  shape: diamond
  class: decision
}

truncate_logs: Truncate Log Entries\nBefore Snapshot {
  class: process
}

# End states
wait_state: Wait for Next\nCompaction Cycle {
  class: process
}

complete: Compaction\nComplete {
  shape: circle
  style.fill: "#00b894"
  style.font-color: "#ffffff"
  style.bold: true
}

# Flow connections
start -> check_log
check_log -> threshold
threshold -> wait_state: No
threshold -> snapshot_create: Yes

snapshot_create -> snapshot_meta
snapshot_create -> snapshot_data
snapshot_meta -> disk_storage
snapshot_data -> disk_storage

disk_storage -> follower_check

follower_check -> truncate_check: No
follower_check -> install_rpc: Yes

install_rpc -> follower_receive
follower_receive -> follower_apply
follower_apply -> truncate_check

truncate_check -> wait_state: No
truncate_check -> truncate_logs: Yes

truncate_logs -> complete
wait_state -> check_log
complete -> check_log

# Edge labels for clarity
threshold -> wait_state: {
  style.stroke: "#fd79a8"
  style.font-color: "#fd79a8"
}

threshold -> snapshot_create: {
  style.stroke: "#00b894"
  style.font-color: "#00b894"
}

follower_check -> truncate_check: {
  label: All followers\nup to date
  style.font-color: "#74b9ff"
}

follower_check -> install_rpc: {
  label: Follower needs\nsnapshot
  style.font-color: "#fd79a8"
}

truncate_check -> truncate_logs: {
  label: All nodes have\nsnapshot
  style.font-color: "#00b894"
}