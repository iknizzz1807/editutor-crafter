title: Collector Processing Flow

classes: {
  primary: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  storage: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  queue: {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  error: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
  }
}

ingestion: Span Ingestion {
  shape: rectangle
  class: primary
}

batch_buffer: Batch Buffer {
  shape: queue
  class: queue
}

validation: Validation {
  shape: diamond
  class: decision
}

enrichment: Enrichment {
  shape: rectangle
  class: primary
}

sampling: Sampling Decision {
  shape: diamond
  class: decision
}

storage_prep: Storage Preparation {
  shape: rectangle
  class: primary
}

hot_storage: Hot Storage {
  shape: cylinder
  class: storage
}

cold_storage: Cold Storage {
  shape: cylinder
  class: storage
}

error_queue: Error Queue {
  shape: queue
  class: error
}

dead_letter: Dead Letter Queue {
  shape: queue
  class: error
}

ingestion -> batch_buffer: batch spans
batch_buffer -> validation: process batch
validation -> enrichment: valid spans
validation -> error_queue: invalid spans {style.stroke: "#d63031"}
enrichment -> sampling: add metadata
sampling -> storage_prep: sampled spans
sampling -> cold_storage: background traces {style.stroke: "#8b949e"}
storage_prep -> hot_storage: store spans
error_queue -> dead_letter: retry failed {style.stroke: "#d63031"}
error_queue -> validation: retry {style.stroke: "#e17055"; style.stroke-dash: 3}

validation_note: |md
  **Validation Checks:**
  - Trace ID format
  - Span relationships  
  - Required fields
  - Timestamp ordering
| {
  shape: page
  near: top-right
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
}

sampling_note: |md
  **Sampling Rules:**
  - Error traces: 100%
  - Slow traces: 100% 
  - Normal traces: 10%
  - Health checks: 1%
| {
  shape: page
  near: bottom-right
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
}