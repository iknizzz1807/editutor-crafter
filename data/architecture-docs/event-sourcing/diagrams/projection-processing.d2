direction: down

title: Projection Processing Flow {
  near: top-center
  style.font-size: 24
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  container_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  process_style: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  decision_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  error_style: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  
  storage_style: {
    style.fill: "#2d3748"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

event_store: Event Store {
  shape: cylinder
  class: storage_style
}

subscription: Event Subscription {
  class: process_style
}

event_processor: Event Processor {
  class: container_style
  
  receive_event: Receive Event {
    class: process_style
  }
  
  check_processed: Already Processed? {
    shape: diamond
    class: decision_style
  }
  
  transform_event: Transform Event {
    class: process_style
  }
  
  update_read_model: Update Read Model {
    class: process_style
  }
  
  record_checkpoint: Record Checkpoint {
    class: process_style
  }
}

error_handler: Error Handler {
  class: container_style
  
  retry_logic: Retry Logic {
    class: error_style
  }
  
  dead_letter: Dead Letter Queue {
    shape: queue
    class: error_style
  }
}

checkpoint_store: Checkpoint Store {
  shape: cylinder
  class: storage_style
}

read_model_store: Read Model Store {
  shape: cylinder
  class: storage_style
}

# Main flow
event_store -> subscription: stream events
subscription -> event_processor.receive_event: event batch

event_processor.receive_event -> event_processor.check_processed: validate event

event_processor.check_processed -> event_processor.transform_event: no {
  style.stroke: "#3fb950"
}

event_processor.check_processed -> event_processor.record_checkpoint: yes (skip) {
  style.stroke: "#8b949e"
  style.stroke-dash: 3
}

event_processor.transform_event -> event_processor.update_read_model: domain logic

event_processor.update_read_model -> event_processor.record_checkpoint: success

event_processor.record_checkpoint -> checkpoint_store: update position

event_processor.update_read_model -> read_model_store: persist changes

# Error handling flows
event_processor.transform_event -> error_handler.retry_logic: processing error {
  style.stroke: "#d63031"
}

event_processor.update_read_model -> error_handler.retry_logic: storage error {
  style.stroke: "#d63031"
}

error_handler.retry_logic -> event_processor.transform_event: retry attempt {
  style.stroke: "#e17055"
  style.stroke-dash: 3
}

error_handler.retry_logic -> error_handler.dead_letter: max retries exceeded {
  style.stroke: "#d63031"
}

# Checkpoint recovery
checkpoint_store -> subscription: last position {
  style.stroke: "#8b949e"
}