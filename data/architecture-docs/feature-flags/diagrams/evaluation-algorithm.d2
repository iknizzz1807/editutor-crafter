direction: down

classes: {
  decision: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  process: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  fallback: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  result: {
    style.fill: "#3fb950"
    style.stroke: "#1a1a2e"
    style.font-color: "#1a1a2e"
    style.bold: true
  }
}

start: Start {
  shape: circle
  class: result
}

validate: Validate User Context {
  class: process
}

invalid_context: Return Default Variant {
  class: fallback
}

check_rules: Targeting Rules Exist? {
  shape: diamond
  class: decision
}

evaluate_rules: Evaluate Targeting Rules {
  class: process
}

rules_match: Rules Match User? {
  shape: diamond
  class: decision
}

get_rule_variant: Get Rule Variant {
  class: process
}

check_percentage: Percentage Rollout? {
  shape: diamond
  class: decision
}

hash_user: Hash User ID + Flag Key {
  class: process
}

calculate_bucket: Calculate Bucket (0-100) {
  class: process
}

in_rollout: User in Rollout %? {
  shape: diamond
  class: decision
}

get_rollout_variant: Get Rollout Variant {
  class: process
}

fallback_variant: Return Fallback Variant {
  class: fallback
}

return_variant: Return Final Variant {
  class: result
}

start -> validate
validate -> check_rules: Valid
validate -> invalid_context: Invalid

check_rules -> evaluate_rules: Yes
check_rules -> check_percentage: No

evaluate_rules -> rules_match
rules_match -> get_rule_variant: Yes
rules_match -> check_percentage: No

get_rule_variant -> return_variant

check_percentage -> hash_user: Yes
check_percentage -> fallback_variant: No

hash_user -> calculate_bucket
calculate_bucket -> in_rollout

in_rollout -> get_rollout_variant: Yes
in_rollout -> fallback_variant: No

get_rollout_variant -> return_variant
fallback_variant -> return_variant

evaluation_note: |md
  **Rule Precedence:**
  1. Targeting Rules (highest)
  2. Percentage Rollouts
  3. Fallback Variant (lowest)
  
  **Consistency:** Hash-based assignment 
  ensures same user gets same variant
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  near: top-right
}