title: Flag Evaluation Sequence
shape: sequence_diagram

Client SDK
Flag Service
Evaluation Engine
Rule Engine
Hasher
Cache
Config Store

Client SDK -> Flag Service: evaluate_flag(user_context, flag_key)
Flag Service -> Cache: get_flag_config(flag_key)
Cache -> Flag Service: config | cache_miss
Cache -> Config Store: fetch_flag_config(flag_key)
Config Store -> Cache: flag_configuration
Cache -> Flag Service: flag_configuration
Flag Service -> Evaluation Engine: evaluate(user_context, flag_config)
Evaluation Engine -> Rule Engine: match_targeting_rules(user_context, rules)
Rule Engine -> Evaluation Engine: matched_rule | default_rule
Evaluation Engine -> Hasher: calculate_hash(user_id, flag_key, salt)
Hasher -> Evaluation Engine: hash_value
Evaluation Engine -> Evaluation Engine: determine_variant(hash, percentages)
Evaluation Engine -> Flag Service: evaluation_result{variant, reason}
Flag Service -> Cache: cache_result(user_id, flag_key, result)
Flag Service -> Client SDK: variant_assignment

classes: {
  service: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  engine: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  storage: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

Client SDK.class: service
Flag Service.class: service
Evaluation Engine.class: engine
Rule Engine.class: engine
Hasher.class: engine
Cache.class: storage
Config Store.class: storage