direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# --- PROCESS ARROW ---
mkfs_process: {
  label: "mkfs utility (mkfs.c)"
  shape: step
  style: {
    fill: "#ACE1AF"
    stroke-width: 2
  }
}

# --- BEFORE STATE ---
before: "BEFORE: RAW DISK IMAGE" {
  style: {
    stroke-dash: 5
    fill: "#f9f9f9"
  }
  
  raw_file: {
    shape: cylinder
    label: "disk.img (Unformatted)"
    content: |md
      - Offset 0x00: 00 00 00 00 ...
      - Offset 0x1000: 00 00 00 00 ...
      - Status: Unusable Blob
    |
  }
  
  note: {
    label: "Empty byte array\n4096 blocks * 4KB\n(Created via ftruncate)"
    style: {
      font-size: 12
      stroke-width: 0
      fill: transparent
    }
  }
}

# --- AFTER STATE ---
after: "AFTER: FORMATTED FILESYSTEM" {
  direction: down
  style: {
    fill: "#e1f5fe"
  }

  # Block 0: Superblock
  sb: {
    shape: sql_table
    label: "Superblock (Block 0)"
    row1: "0x00 | uint32_t | magic (0xDEADC0DE)"
    row2: "0x04 | uint32_t | version (1)"
    row3: "0x08 | uint32_t | block_size (4096)"
    row4: "0x0C | uint32_t | total_blocks (4096)"
    row5: "0x1C | uint32_t | inode_table_start (3)"
    row6: "0x2C | uint32_t | data_block_start (35)"
    total: "Total: 4096 bytes (Packed)"
    style.fill: "#d1c4e9"
  }

  # Meta Blocks
  meta_region: {
    direction: right
    label: "Metadata Blocks (B1 - B34)"
    
    block_bitmap: {
      label: "Block Bitmap (B1)"
      content: "Bit 0 = 1 (Root Dir)\nBits 1..N = 0"
      style.fill: "#bbdefb"
    }
    
    inode_bitmap: {
      label: "Inode Bitmap (B2)"
      content: "Bit 0 = 1 (Inode 1)\nBits 1..N = 0"
      style.fill: "#bbdefb"
    }
    
    inode_table: {
      label: "Inode Table (B3-B34)"
      root_inode: "Inode 1: Mode=DIR, nlinks=2, size=4096"
      style.fill: "#c8e6c9"
    }
  }

  # Data Region
  data_region: {
    direction: right
    label: "Data Region (B35+)"
    
    root_dir_data: {
      label: "Root Data Block (B35)"
      entry1: ".  -> Inode 1"
      entry2: ".. -> Inode 1"
      style.fill: "#fff9c4"
    }
    
    unwritten_space: {
      label: "Blocks 36 - 4095"
      content: "[UNWRITTEN - Remains Zeros]"
      style: {
        fill: "#eeeeee"
        stroke-dash: 3
      }
    }
  }
}

# --- CONNECTIONS ---
before -> mkfs_process: "Raw File | 16MB | disk.img"
mkfs_process -> after: "struct superblock_t | 4KB | magic=0xDEADC0DE"

# --- LEGEND ---
legend: {
  near: bottom-right
  metadata: "Metadata Region" { style.fill: "#d1c4e9" }
  data: "Allocated Data" { style.fill: "#fff9c4" }
  sparse: "Unwritten Region" { style.fill: "#eeeeee" }
}