direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

superblock_memory: {
  label: "struct superblock_t (fs.h)"
  
  sb_table: {
    shape: sql_table
    header: "Offset | Type | Field Name // Purpose"
    
    row0: "0x00 | uint32_t | magic // FS_MAGIC (0xDEADC0DE)"
    row1: "0x04 | uint32_t | version // Filesystem format version"
    row2: "0x08 | uint32_t | block_size // Fixed at 4096 bytes"
    row3: "0x0C | uint32_t | total_blocks // Image size in blocks"
    row4: "0x10 | uint32_t | total_inodes // Maximum inode capacity"
    row5: "0x14 | uint32_t | free_blocks // Available data blocks"
    row6: "0x18 | uint32_t | free_inodes // Available inode slots"
    row7: "0x1C | uint32_t | inode_table_start // Block offset to table"
    row8: "0x20 | uint32_t | journal_start // Block offset to journal"
    row9: "0x24 | uint32_t | data_start // Block offset to data region"
    row10: "0x28 | uint32_t | root_inode // Inode number of /"
    row11: "0x2C | uint8_t[36] | reserved // Padding to cache line"
    
    footer: "Total: 64 bytes (Single x86-64 Cache Line)"

    row0.style.fill: "#ffcccc"
  }
}

mount_process: {
  label: "Mount Validation (mount.c)"
  
  step_1: {
    label: "Verify Identity"
    code: |'c
      superblock_t sb;
      read_block(fd, 0, &sb);
      
      // Safety gate: first check on mount
      if (sb.magic != FS_MAGIC) {
          return -EINVAL;
      }
    '|
    width: 350
  }
}

mount_process.step_1 -> superblock_memory.sb_table.row0: "uint32_t | 4 bytes | 0xDEADC0DE" {
  style: {
    stroke: red
    stroke-width: 2
  }
}

legend: {
  shape: package
  label: "Implementation Note"
  note: "Packed struct (__attribute__((packed))) ensures zero padding between fields for cross-platform image compatibility."
}

legend.near: bottom-right