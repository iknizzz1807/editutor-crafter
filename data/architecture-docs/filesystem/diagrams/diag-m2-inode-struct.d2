direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- INODE STRUCTURE LAYOUT ---
inode_layout: {
  shape: sql_table
  label: "struct inode (fs.h)"
  
  header: "Offset | Type | Name | Description"
  
  # --- CACHE LINE 1 (0x00 - 0x3F) ---
  r0: "0x00 | uint16_t | i_type | File type (REG=1, DIR=2, LNK=7)" {style.stroke: "#336699"}
  r1: "0x02 | uint16_t | i_mode | POSIX Permissions (e.g. 0755)"
  r2: "0x04 | uint16_t | i_nlinks | Hard link reference count"
  r3: "0x06 | uint16_t | i_uid | Owner User ID"
  r4: "0x08 | uint16_t | i_gid | Owner Group ID"
  r5: "0x0A | uint16_t | _pad1 | Alignment padding (2B)" {style.fill: "#eeeeee"}
  r6: "0x0C | uint32_t | _pad2 | Alignment padding (4B)" {style.fill: "#eeeeee"}
  
  r7: "0x10 | uint64_t | i_size | Logical file size in bytes" {style.stroke: "#cc0000"}
  r8: "0x18 | uint64_t | i_atime | Last Access Time (seconds)" {style.stroke: "#996633"}
  r9: "0x20 | uint64_t | i_mtime | Last Data Modification Time" {style.stroke: "#996633"}
  r10: "0x28 | uint64_t | i_ctime | Last Metadata Change Time" {style.stroke: "#996633"}
  
  r11: "0x30 | uint32_t[4] | i_blocks[0..3] | Direct Pointers (CL1 Ends at 0x3F)" {style.stroke: "#0066cc"}

  # --- CACHE LINE 2 (0x40 - 0x7F) ---
  r12: "0x40 | uint32_t[8] | i_blocks[4..11]| Direct Pointers (CL2 Start)" {style.stroke: "#0066cc"}
  r13: "0x60 | uint32_t | i_s_ind | Single Indirect Pointer (4MB)" {style.stroke: "#663399"}
  r14: "0x64 | uint32_t | i_d_ind | Double Indirect Pointer (4GB)" {style.stroke: "#663399"}
  r15: "0x68 | uint8_t[24] | i_reserved | Padding to 128B boundary" {style.fill: "#eeeeee"}
  
  sz: "Total Size: 128 Bytes (Exactly 32 Inodes per 4KB Block)"
}

# --- IMPLEMENTATION DETAILS ---
logic_summary: {
  label: "Implementation Requirements"
  direction: down
  
  definition: {
    label: "C Definition"
    code: |'c
      typedef struct __attribute__((packed)) {
          uint16_t i_type, i_mode;
          uint16_t i_nlinks, i_uid, i_gid;
          uint8_t  _pad[6];
          uint64_t i_size;
          uint64_t i_atime, i_mtime, i_ctime;
          uint32_t i_blocks[12];
          uint32_t i_s_ind, i_d_ind;
          uint8_t  i_reserved[24];
      } inode_t;
    '|
  }

  thresholds: {
    shape: rectangle
    style.fill: "#fff4dd"
    label: |md
      ### Capacity Thresholds
      - **Direct Only**: ≤ 48 KB (12 * 4KB)
      - **Single Indirect**: ≤ 4.04 MB (48KB + 1024 * 4KB)
      - **Double Indirect**: ≤ 4.004 GB (4MB + 1024^2 * 4KB)
    |
  }
}

# --- PERFORMANCE ANNOTATIONS ---
cache_analysis: {
  direction: down
  label: "CPU Cache Line Distribution"
  
  cl1: "Cache Line 1 (0x00 - 0x3F)" {
    label: "Hot Path: Type, Size, Mod Times, 16KB Direct Data"
    style.fill: "#e1f5fe"
  }
  
  cl2: "Cache Line 2 (0x40 - 0x7F)" {
    label: "Cold Path: Remaining Pointers & Indirect Blocks"
    style.fill: "#f3e5f5"
  }
}

# --- CONNECTIONS & FLOW ---
inode_layout.r7 -> logic_summary.thresholds: "Determines"
inode_layout.r11 -> cache_analysis.cl1: "Inhabits"
inode_layout.r12 -> cache_analysis.cl2: "Inhabits"

legend: {
  near: bottom-right
  metadata: "Red = High Frequency Writes (Size/Time)" {
    style.font-color: "#cc0000"
  }
  pointers: "Blue = Direct Data Pointers" {
    style.font-color: "#0066cc"
  }
}