direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: {
  label: "Inode Pointers vs. x86-64 Page Table â€” Structural Parallel"
  shape: rectangle
  style: {
    fill: "#f1f1f1"
    stroke-width: 2
    bold: true
    font-size: 20
  }
}

shared_concept: {
  label: "RADIX TREE / MULTI-LEVEL TRANSLATION TABLE"
  note: |md
    Both systems use a fixed-width fanout tree to translate an index (file offset or virtual address) 
    into a physical resource (disk block or RAM frame).
  |
  shape: callout
}
shared_concept.near: top-center

filesystem_translation: {
  label: "FILESYSTEM: FILE OFFSET TO BLOCK (inode.h)"
  direction: down

  inode: {
    shape: sql_table
    label: "struct inode_t"
    f0: "0x00 | uint16_t | mode // S_IFREG"
    f1: "0x08 | uint32_t | size // Logical bytes"
    f2: "0x18 | uint32_t | blocks[0..11] // DIRECT"
    f3: "0x48 | uint32_t | single_indirect"
    f4: "0x4C | uint32_t | double_indirect"
    sz: "Total: 128 bytes"
  }

  indirect_l1: {
    shape: sql_table
    label: "Single Indirect Block"
    row1: "0x0000 | uint32_t | ptr_0"
    row2: "0x0004 | uint32_t | ptr_1"
    row3: "... | ..."
    row4: "0x0FFC | uint32_t | ptr_1023"
    sz: "Total: 4096 bytes (1024 entries)"
  }

  indirect_l2: {
    shape: sql_table
    label: "Double Indirect Block"
    row1: "0x0000 | uint32_t | l1_ptr_0"
    row2: "0x0004 | uint32_t | l1_ptr_1"
    row3: "... | ..."
    row4: "0x0FFC | uint32_t | l1_ptr_1023"
    sz: "Total: 4096 bytes (1024 entries)"
  }

  data_block: {
    shape: cylinder
    label: "Data Block (4KB)"
    style.fill: "#e1f5fe"
  }

  sparse_hole: {
    label: "SPARSE HOLE (NULL)"
    style.stroke-dash: 4
    style.fill: "#eeeeee"
  }

  inode.f2 -> data_block: "uint32_t | 4 bytes | [0..48KB)"
  inode.f3 -> indirect_l1: "uint32_t | 4 bytes | [48KB..4MB)"
  inode.f4 -> indirect_l2: "uint32_t | 4 bytes | [4MB..4GB)"
  indirect_l2.row1 -> indirect_l1: "uint32_t | 4 bytes | Phys Block Num"
  indirect_l1.row1 -> data_block: "uint32_t | 4 bytes | Phys Block Num"
  
  inode.f2 -> sparse_hole: "uint32_t | 4 bytes | 0x00000000" {
    style.stroke-dash: 4
  }
}

memory_translation: {
  label: "x86-64 ARCHITECTURE: VADDR TO PHYSICAL FRAME"
  direction: down

  vaddr_struct: {
    shape: sql_table
    label: "64-bit Virtual Address"
    bits1: "47:39 | PML4 Index (9 bits)"
    bits2: "38:30 | PDPT Index (9 bits)"
    bits3: "29:21 | PD Index   (9 bits)"
    bits4: "20:12 | PT Index   (9 bits)"
    bits5: "11:0  | Page Offset (12 bits)"
  }

  pml4_table: {
    shape: sql_table
    label: "PML4 Table"
    row1: "0x00 | uint64_t | PDPT_PTR_0"
    row2: "... | 512 entries"
  }

  pdpt_table: {
    shape: sql_table
    label: "Page Directory Pointer Table"
    row1: "0x00 | uint64_t | PD_PTR_0"
    row2: "... | 512 entries"
  }

  pd_table: {
    shape: sql_table
    label: "Page Directory"
    row1: "0x00 | uint64_t | PT_PTR_0"
    row2: "... | 512 entries"
  }

  pt_table: {
    shape: sql_table
    label: "Page Table"
    row1: "0x00 | uint64_t | FRAME_PTR_0"
    row2: "... | 512 entries"
  }

  physical_frame: {
    shape: cylinder
    label: "Physical Frame (4KB RAM)"
    style.fill: "#e8f5e9"
  }

  page_fault: {
    label: "PAGE FAULT (NOT PRESENT)"
    style.stroke-dash: 4
    style.fill: "#ffebee"
  }

  vaddr_struct.bits1 -> pml4_table: "uint64_t | 8 bytes | CR3 Register"
  pml4_table.row1 -> pdpt_table: "uint64_t | 8 bytes | Phys Addr"
  pdpt_table.row1 -> pd_table: "uint64_t | 8 bytes | Phys Addr"
  pd_table.row1 -> pt_table: "uint64_t | 8 bytes | Phys Addr"
  pt_table.row1 -> physical_frame: "uint64_t | 8 bytes | Phys Addr"

  pt_table.row1 -> page_fault: "uint64_t | 8 bytes | present_bit=0" {
    style.stroke-dash: 4
  }
}

filesystem_translation -> memory_translation: "Structural Mapping | N/A | Radix Tree" {
  style: {
    stroke-width: 4
    stroke-dash: 5
  }
}

legend: {
  shape: package
  label: "Legend"
  metadata: Metadata Pointer {
    style.fill: "#d1c4e9"
  }
  actual_data: Target Resource {
    style.fill: "#e1f5fe"
  }
}
legend.near: bottom-right

filesystem_translation.inode.style.fill: "#d1c4e9"
filesystem_translation.indirect_l1.style.fill: "#d1c4e9"
filesystem_translation.indirect_l2.style.fill: "#d1c4e9"

memory_translation.pml4_table.style.fill: "#d1c4e9"
memory_translation.pdpt_table.style.fill: "#d1c4e9"
memory_translation.pd_table.style.fill: "#d1c4e9"
memory_translation.pt_table.style.fill: "#d1c4e9"