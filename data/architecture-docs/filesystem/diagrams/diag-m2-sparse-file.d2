direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- MAIN SCENARIO ---
sparse_fs: {
  direction: right
  label: "Sparse File Implementation (fs_file.c)"
  
  # Top-level operation summary
  op_summary: {
    label: "T1: Write Sequence"
    code: |'c
      fs_write(ino, 0, "Hello", 5);
      // Large gap: 0x00005 to 0xF423F
      fs_write(ino, 1000000, "World", 5);
    '|
    width: 300
  }

  # The Inode Structure
  inode: {
    shape: sql_table
    label: "struct inode_t (inode.h)"
    f0: "0x00 | uint16_t | mode: S_IFREG | 0644"
    f1: "0x08 | uint32_t | size: 1000005 bytes"
    f2: "0x18 | uint32_t | blocks[0]: 0x00000800"
    f3: "0x1C | uint32_t | blocks[1..11]: 0x00000000 (HOLE)"
    f4: "0x48 | uint32_t | single_indirect: 0x00000801"
    f5: "0x4C | uint32_t | double_indirect: 0x00000000"
    sz: "Total: 128 bytes"
    
    style.fill: "#e1d5e7"
  }

  # The Physical Blocks Layer
  storage: {
    direction: right
    label: "Physical Disk Mapping"

    block_0: {
      label: "Block 2048 (Data)\nLogical Offset 0"
      content: {
        shape: code
        code: |'text
          0000: 48 65 6c 6c 6f 00 00 00  |Hello...|
          0008: 00 00 00 00 00 00 00 00  |........|
          [... 4080 bytes of padding ...]
        '|
      }
      style.fill: "#dae8fc"
    }

    indirect_block: {
      shape: sql_table
      label: "Indirect Block (Ptr Array)"
      slot_0_243: "0x000..0x3CF | 244 * uint32_t | 0x00000000 (HOLE)"
      slot_244: "0x3D0 | uint32_t | 0x00000802 (Data N)"
      slot_245_1023: "0x3D4..0xFFF | 779 * uint32_t | 0x00000000 (HOLE)"
      
      style.fill: "#e1d5e7"
    }

    block_n: {
      label: "Block 2050 (Data)\nLogical Offset 1,000,000"
      content: {
        shape: code
        code: |'text
          0000: 57 6f 72 6c 64 00 00 00  |World...|
          0008: 00 00 00 00 00 00 00 00  |........|
          [... 4080 bytes of padding ...]
        '|
      }
      style.fill: "#dae8fc"
    }
  }

  # Note on Hole handling
  optimization_note: {
    shape: callout
    label: "Hole Optimization Logic"
    code: |'c
      if (ptr == 0) {
          memset(user_buf, 0, BLOCK_SIZE);
          return BLOCK_SIZE; // No Disk I/O
      }
    '|
  }

  # Internal Connections
  inode.f2 -> storage.block_0: "ptr | 4 bytes | 0x800"
  inode.f4 -> storage.indirect_block: "ptr | 4 bytes | 0x801"
  storage.indirect_block.slot_244 -> storage.block_n: "ptr | 4 bytes | 0x802"
}

# --- COMPARISON VIEW ---
comparison: {
  label: "Resource Consumption Comparison"
  direction: right

  sparse_stats: {
    shape: sql_table
    label: "Current (Sparse)"
    row1: "Logical Size | 1,000,005 bytes (~1MB)"
    row2: "Allocated Blocks | 3 blocks (12 KB)"
    row3: "Metadata Overhead | 1 Indirect Block (4KB)"
    row4: "Efficiency | 98.8% disk space saved"
    
    style.stroke: green
    style.stroke-width: 3
  }

  non_sparse_stats: {
    shape: sql_table
    label: "Traditional (Dense / Non-Sparse)"
    row1: "Logical Size | 1,000,005 bytes (~1MB)"
    row2: "Allocated Blocks | 246 blocks (~1.01 MB)"
    row3: "Metadata Overhead | 1 Indirect Block (4KB)"
    row4: "Efficiency | 0% space saved"
    
    style.stroke: red
    style.stroke-dash: 4
  }
}

# --- LEGEND ---
legend: {
  shape: sql_table
  label: "Color Semantics"
  metadata: "Metadata / Pointers (Purple)"
  data_blks: "Active Data Blocks (Blue)"
  holes: "Unallocated / Logical Holes (Gray)"
}

# Placement using root-level constants
legend.near: bottom-right
comparison.near: bottom-center

# Style assignments for legend items using global classes or overrides
legend.metadata.style.fill: "#e1d5e7"
legend.data_blks.style.fill: "#dae8fc"
legend.holes.style.fill: "#f5f5f5"