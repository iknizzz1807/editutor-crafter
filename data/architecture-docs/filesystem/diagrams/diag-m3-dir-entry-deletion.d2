direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --------------------------------------------------------------------------------------------
# BEFORE STATE: file_b exists as an independent record
# --------------------------------------------------------------------------------------------
before: BEFORE: Block Data (dir.c) {
  direction: down
  
  block_0: {
    shape: sql_table
    label: "uint8_t[4096] (Logical View)"
    
    row1: "0x00 | struct dirent | '.' (ino: 1, rec_len: 12)"
    row2: "0x0C | struct dirent | '..' (ino: 1, rec_len: 12)"
    row3: "0x18 | struct dirent | 'file_a' (ino: 10, rec_len: 16)"
    row4: "0x28 | struct dirent | 'file_b' (ino: 11, rec_len: 16)" {
      style.stroke: red
      style.fill: "#ffcccc"
    }
    row5: "0x38 | struct dirent | 'file_c' (ino: 12, rec_len: 4040)"
    
    total: "Total: 4096 bytes (1 block)"
  }

  scan_logic: {
    label: "Scan Logic"
    code: |'c
      // offset = 0x18 (file_a)
      // next = offset + rec_len (16)
      // next = 0x28 (file_b)
    '|
  }
}

# --------------------------------------------------------------------------------------------
# AFTER STATE: file_a absorbs file_b's space by extending rec_len
# --------------------------------------------------------------------------------------------
after: AFTER: Block Data (dir.c) {
  direction: down

  block_1: {
    shape: sql_table
    label: "uint8_t[4096] (Logical View)"
    
    row1: "0x00 | struct dirent | '.'"
    row2: "0x0C | struct dirent | '..'"
    row3: "0x18 | struct dirent | 'file_a' (ino: 10, rec_len: 32)" {
      style.stroke: green
      style.fill: "#ccffcc"
    }
    ghost: "0x28 | (Dead Bytes) | Previously 'file_b'" {
      style.stroke-dash: 3
      style.font-color: gray
    }
    row5: "0x38 | struct dirent | 'file_c' (ino: 12, rec_len: 4040)"
    
    total: "Total: 4096 bytes"
  }

  jump_logic: {
    label: "Updated Scan Logic"
    code: |'c
      // offset = 0x18 (file_a)
      // next = offset + rec_len (32)
      // next = 0x38 (file_c)
      // file_b is now unreachable
    '|
  }
}

# --------------------------------------------------------------------------------------------
# COMPARISON / ANNOTATIONS
# --------------------------------------------------------------------------------------------
before.block_0.row4 -> after.block_1.ghost: "unlink('file_b')" {
  style.stroke: red
  style.animated: true
}

comparison: {
  label: "Why this design?"
  code: |'md
    ### Ext2-style Deletion
    - **No Compaction**: Subsequent entries (file_c) do not move.
    - **Single Write**: Only need to update the `rec_len` of `file_a`.
    - **Reclaimable**: `dir_add_entry` can split this 32-byte slot later.
    - **Atomic**: 2-byte update to `rec_len` is atomic on hardware.
  '|
  width: 400
}

comparison.near: bottom-center

# --------------------------------------------------------------------------------------------
# IMPLEMENTATION DETAIL: dirent_t structure
# --------------------------------------------------------------------------------------------
dirent_struct: {
  shape: sql_table
  label: "struct dirent (dir.h)"
  f0: "0x00 | uint32_t | inode_num // 0 = free"
  f1: "0x04 | uint16_t | rec_len   // distance to next"
  f2: "0x06 | uint8_t  | name_len  // bytes in name"
  f3: "0x07 | uint8_t  | file_type // FT_REG, etc"
  f4: "0x08 | char[]   | name      // variable"
  sz: "Total: 8 + name_len (aligned 4)"
}

dirent_struct.near: top-center