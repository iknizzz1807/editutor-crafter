direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# 1. STRUCT DEFINITION
dirent_format: {
  shape: sql_table
  label: "struct dirent (dir.c)"
  
  f0: "0x00 | uint32_t | inode_num  // Target ID (0 = Deleted)"
  f1: "0x04 | uint16_t | rec_len    // Total record bytes"
  f2: "0x06 | uint8_t  | name_len   // Name length (raw)"
  f3: "0x07 | uint8_t  | file_type  // 1=REG, 2=DIR"
  f4: "0x08 | char[]   | name       // Variable, 4B padded"
  
  sz: "Total: Variable (Minimum 12 bytes)"
  
  style: {
    stroke: "#333333"
    fill: "#f8f9fa"
  }
}

# 2. INITIAL ROOT DIRECTORY STATE
root_initial_state: {
  label: "Root Directory Block 0 (Initial Format)"
  direction: down

  entry_1: {
    shape: sql_table
    label: "Entry: '.'"
    r1: "0x00 | 1      | inode_num"
    r2: "0x04 | 12     | rec_len (8 + 1 + 3 padding)"
    r3: "0x06 | 1      | name_len"
    r4: "0x07 | 2      | FT_DIR"
    r5: "0x08 | '.'    | name + 3B padding"
  }

  entry_2: {
    shape: sql_table
    label: "Entry: '..'"
    r1: "0x00 | 1      | inode_num"
    r2: "0x04 | 4084   | rec_len (Remainder of Block)"
    r3: "0x06 | 2      | name_len"
    r4: "0x07 | 2      | FT_DIR"
    r5: "0x08 | '..'   | name + 2B padding"
  }

  footer: {
    label: "Total: 4096 Bytes (1 Block)"
    style.stroke-dash: 3
  }
}

# 3. DELETION MECHANISM (EXT2 STYLE)
deletion_logic: {
  label: "Deletion: Merging space into Previous Entry"
  direction: right

  before: {
    direction: down
    label: "BEFORE: Two Files"
    
    file_a: {
      shape: rectangle
      label: "Entry A: 'file1.txt'\nrec_len: 20"
      style.fill: "#e3f2fd"
    }
    file_b: {
      shape: rectangle
      label: "Entry B: 'data'\nrec_len: 12"
      style.fill: "#ffebee"
    }
  }

  action: {
    shape: step
    label: "Unlink 'data'"
    code: |'c
      prev_de->rec_len += current_de->rec_len;
      // Inode num set to 0 is optional 
      // if merged into previous.
    '|
  }

  after: {
    direction: down
    label: "AFTER: Single Entry (Merged)"
    
    file_a_merged: {
      shape: rectangle
      label: "Entry A: 'file1.txt'\nrec_len: 32 (20 + 12)"
      style.fill: "#e3f2fd"
    }
    dead_space: {
      label: "Original Entry B space\nnow owned by A"
      style: {
        fill: "#eeeeee"
        stroke-dash: 5
      }
    }
  }

  before -> action -> after
}

# CONNECTIONS & ANNOTATIONS
dirent_format -> root_initial_state: "Implementation Reference"
root_initial_state.entry_1 -> root_initial_state.entry_2: "offset += rec_len | 12 bytes"

legend: {
  near: bottom-right
  metadata: "Purple = Header (8B)" { style.fill: "#d1c4e9" }
  data: "Blue = File Payload" { style.fill: "#bbdefb" }
  unused: "Gray = Padding/Deleted" { style.fill: "#f5f5f5" }
}

root_initial_state.entry_1.r2.style.fill: "#d1c4e9"
root_initial_state.entry_2.r2.style.fill: "#d1c4e9"