direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- GLOBAL CLASSES ---
classes: {
  directory_inode: {
    shape: sql_table
    style: {
      fill: "#e1d5e7"
      stroke: "#9673a6"
      stroke-width: 2
    }
  }
  file_inode: {
    shape: sql_table
    style: {
      fill: "#dae8fc"
      stroke: "#6c8ebf"
      stroke-width: 2
    }
  }
  structural_edge: {
    style: {
      stroke: "#666666"
      stroke-dash: 3
      opacity: 0.6
    }
  }
}

# --- INODE GRAPH NODES ---

Legend: {
  shape: rectangle
  near: top-center
  label: "DIRECTORY TREE AS INODE GRAPH\nNote: Red arrows show cycles (..) | Blue arrows show structure"
}

root: {
  class: directory_inode
  label: "Inode 1 (Root /)"
  f0: "0x00 | uint16_t | mode: S_IFDIR | 0755"
  f1: "0x06 | uint16_t | nlinks: 4"
  f2: "0x08 | uint32_t | size: 4096"
  f3: "0x18 | uint32_t | blocks[0]: 500"
  total: "Total: 128 bytes"
}

home: {
  class: directory_inode
  label: "Inode 2 (/home)"
  f0: "0x00 | uint16_t | mode: S_IFDIR | 0755"
  f1: "0x06 | uint16_t | nlinks: 3"
  f2: "0x08 | uint32_t | size: 4096"
  f3: "0x18 | uint32_t | blocks[0]: 501"
  total: "Total: 128 bytes"
}

tmp: {
  class: directory_inode
  label: "Inode 3 (/tmp)"
  f0: "0x00 | uint16_t | mode: S_IFDIR | 01777"
  f1: "0x06 | uint16_t | nlinks: 3"
  f2: "0x08 | uint32_t | size: 4096"
  f3: "0x18 | uint32_t | blocks[0]: 502"
  total: "Total: 128 bytes"
}

user: {
  class: directory_inode
  label: "Inode 4 (/home/user)"
  f0: "0x00 | uint16_t | mode: S_IFDIR | 0700"
  f1: "0x06 | uint16_t | nlinks: 2"
  f2: "0x08 | uint32_t | size: 4096"
  f3: "0x18 | uint32_t | blocks[0]: 503"
  total: "Total: 128 bytes"
}

scratch: {
  class: directory_inode
  label: "Inode 6 (/tmp/scratch)"
  f0: "0x00 | uint16_t | mode: S_IFDIR | 0777"
  f1: "0x06 | uint16_t | nlinks: 2"
  f2: "0x08 | uint32_t | size: 4096"
  f3: "0x18 | uint32_t | blocks[0]: 504"
  total: "Total: 128 bytes"
}

file_txt: {
  class: file_inode
  label: "Inode 5 (Regular File)"
  f0: "0x00 | uint16_t | mode: S_IFREG | 0644"
  f1: "0x06 | uint16_t | nlinks: 2"
  f2: "0x08 | uint32_t | size: 1024"
  f3: "0x18 | uint32_t | blocks[0]: 900"
  total: "Total: 128 bytes (Target of Hard Link)"
}

# --- DIRECTORY ENTRIES (EDGES) ---

# Structural Tree Edges
root -> home: "dirent_t | 264 B | {name='home', ino=2}" {
  style.stroke: "#0000ff"
  style.stroke-width: 3
}
root -> tmp: "dirent_t | 264 B | {name='tmp', ino=3}" {
  style.stroke: "#0000ff"
  style.stroke-width: 3
}
home -> user: "dirent_t | 264 B | {name='user', ino=4}" {
  style.stroke: "#0000ff"
  style.stroke-width: 3
}
user -> file_txt: "dirent_t | 264 B | {name='file.txt', ino=5}" {
  style.stroke: "#0000ff"
  style.stroke-width: 3
}
tmp -> scratch: "dirent_t | 264 B | {name='scratch', ino=6}" {
  style.stroke: "#0000ff"
  style.stroke-width: 3
}

# Hard Link Convergence
tmp -> file_txt: "dirent_t | 264 B | {name='backup.txt', ino=5}" {
  style.stroke: "#ffa500"
  style.stroke-width: 3
  style.stroke-dash: 5
}

# --- CYCLIC GRAPH EDGES (.. and .) ---

# Root Invariant (.. points to self)
root -> root: "." { class: structural_edge }
root -> root: ".." { 
  class: structural_edge
  style.stroke: "#ff0000"
}

# Home Cycles
home -> home: "." { class: structural_edge }
home -> root: ".." { 
  class: structural_edge
  style.stroke: "#ff0000"
}

# Tmp Cycles
tmp -> tmp: "." { class: structural_edge }
tmp -> root: ".." { 
  class: structural_edge
  style.stroke: "#ff0000"
}

# User Cycles
user -> user: "." { class: structural_edge }
user -> home: ".." { 
  class: structural_edge
  style.stroke: "#ff0000"
}

# Scratch Cycles
scratch -> scratch: "." { class: structural_edge }
scratch -> tmp: ".." { 
  class: structural_edge
  style.stroke: "#ff0000"
}

# --- DOCUMENTATION NODE ---
Explanation: {
  near: bottom-right
  label: "Graph Theory Perspective"
  code: |'md
    ### Not a Strict Tree
    Traditional paths like `/home/user` look like 
    hierarchies, but the underlying inode graph 
    is a **Directed Cyclic Graph**.

    1. **Cycles**: Created by `..` entries pointing 
       to parent inodes.
    2. **Self-Loops**: Created by `.` entries.
    3. **DAG Property**: Filesystem without `..` and 
       hard links is a DAG.
    4. **Hard Links**: Convergence of multiple edges 
       (user/file.txt, tmp/backup.txt) on Inode 5.
  '|
}