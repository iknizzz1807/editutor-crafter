direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

namespace: {
  label: "DIRECTORY NAMESPACE (On-Disk Data Blocks)"

  dir_home: {
    shape: sql_table
    label: "Directory: /home/user/ (Data Block 1024)"
    f0: "0x00 | uint32_t | inode_num = 47"
    f4: "0x04 | uint16_t | rec_len = 16"
    f6: "0x06 | uint8_t  | name_len = 8"
    f7: "0x07 | uint8_t  | file_type = 1 (REG)"
    f8: "0x08 | char[8]  | name = \"file.txt\""
    total: "Total size: 16 bytes (padded)"
  }

  dir_backup: {
    shape: sql_table
    label: "Directory: /backup/ (Data Block 2048)"
    f0: "0x00 | uint32_t | inode_num = 47"
    f4: "0x04 | uint16_t | rec_len = 24"
    f6: "0x06 | uint8_t  | name_len = 13"
    f7: "0x07 | uint8_t  | file_type = 1 (REG)"
    f8: "0x08 | char[13] | name = \"file_copy.txt\""
    total: "Total size: 24 bytes (padded)"
  }

  dir_home_sym: {
    shape: sql_table
    label: "Directory: /home/user/ (Data Block 1024, entry 2)"
    f0: "0x10 | uint32_t | inode_num = 99"
    f4: "0x14 | uint16_t | rec_len = 20"
    f6: "0x16 | uint8_t  | name_len = 8"
    f7: "0x17 | uint8_t  | file_type = 7 (LNK)"
    f8: "0x18 | char[8]  | name = \"sym_link\""
    total: "Total size: 20 bytes (padded)"
  }
}

metadata: {
  label: "INODE TABLE (On-Disk Metadata)"

  inode_47: {
    shape: sql_table
    label: "struct inode_t (Shared Identity: Inode 47)"
    mode: "0x00 | uint16_t | mode = 0100644 (S_IFREG)"
    nlinks: "0x06 | uint16_t | nlinks = 2 // Shared Ref Count"
    size: "0x08 | uint32_t | size = 4096"
    ptr0: "0x18 | uint32_t | blocks[0] = 5000"
    total: "Total: 128 bytes"
  }

  inode_99: {
    shape: sql_table
    label: "struct inode_t (Symlink Identity: Inode 99)"
    mode: "0x00 | uint16_t | mode = 0120777 (S_IFLNK)"
    nlinks: "0x06 | uint16_t | nlinks = 1"
    size: "0x08 | uint32_t | size = 18"
    ptr0: "0x18 | uint32_t | blocks[0] = 6000"
    total: "Total: 128 bytes"
  }
}

storage: {
  label: "DATA BLOCKS (On-Disk Content)"

  block_5000: {
    label: "Data Block 5000 (File Payload)"
    style.fill: "#e1f5fe"
    content: |'md
      # Shared Data
      This data is referenced by both
      "file.txt" and "file_copy.txt".
    '|
  }

  block_6000: {
    label: "Data Block 6000 (Path String)"
    style.fill: "#f3e5f5"
    content: |'text
      /home/user/file.txt
    '|
  }
}

logic_rules: {
  label: "Reference Counting Semantics"
  near: bottom-center
  
  unlink_op: {
    label: "Operation: unlink('/home/user/file.txt')"
    code: |'c
      inode->nlinks--; // 2 -> 1
      if (inode->nlinks == 0) {
          free_inode(ino); 
          free_blocks(inode);
      }
    '|
  }
  
  proof: |md
    - **Hard Link Proof**: `inode_47` contains the only copy of `size` and `blocks[0]`.
    - **Indepedence**: Renaming `file.txt` does not affect `file_copy.txt`.
    - **Deletion**: The inode survives until the *last* name is unlinked.
  |
}

# Connections for Hard Links
namespace.dir_home.f0 -> metadata.inode_47: "uint32_t | 4 bytes | ino=47"
namespace.dir_backup.f0 -> metadata.inode_47: "uint32_t | 4 bytes | ino=47"
metadata.inode_47.ptr0 -> storage.block_5000: "uint32_t | 4 bytes | blk=5000"

# Connections for Symlinks
namespace.dir_home_sym.f0 -> metadata.inode_99: "uint32_t | 4 bytes | ino=99"
metadata.inode_99.ptr0 -> storage.block_6000: "uint32_t | 4 bytes | blk=6000"
storage.block_6000 -> namespace.dir_home.f8: "Symbolic Resolution" {
  style.stroke-dash: 5
  style.stroke: purple
}

# Mutation Logic Indicators
logic_rules.unlink_op -> metadata.inode_47.nlinks: "Decrements" {
  style.stroke: red
  style.animated: true
}