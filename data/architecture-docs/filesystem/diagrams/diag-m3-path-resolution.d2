direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- DATA STRUCTURE DEFINITIONS ---

classes: {
  inode_node: {
    shape: sql_table
    style: {
      fill: "#E1F5FE"
      stroke: "#01579B"
    }
  }
  data_block_node: {
    shape: sql_table
    style: {
      fill: "#FFF9C4"
      stroke: "#FBC02D"
    }
  }
}

# --- RESOLUTION STEPS ---

vfs_input: {
  shape: package
  label: "VFS Path Resolution\n(path_resolve.c)"
  path: |'c
    const char *path = "/home/user/file.txt";
    uint32_t current_ino = sb->root_inode; // 1
  '|
}

step_1_root: {
  label: "STEP 1: Root Inode (/) "
  class: inode_node
  header: "Inode 1 | Block 3 | Offset 0x00"
  f0: "0x00 | mode   | S_IFDIR | 0755"
  f1: "0x08 | size   | 4096 bytes"
  f2: "0x18 | blks[0]| 500 (Disk Block)"
  total: "Read Count: 1 (Inode Table Block)"
}

step_2_root_data: {
  label: "STEP 2: Scan / Entries"
  class: data_block_node
  header: "Disk Block 500 (Directory Data)"
  de0: "ino: 1  | len: 12 | name: '.'"
  de1: "ino: 1  | len: 12 | name: '..'"
  de2: "ino: 5  | len: 16 | name: 'home' <--"
  total: "Read Count: 2 (Data Block)"
}

step_3_home: {
  label: "STEP 3: 'home' Inode"
  class: inode_node
  header: "Inode 5 | Block 3 | Offset 0x200"
  f0: "0x00 | mode   | S_IFDIR | 0755"
  f1: "0x08 | size   | 4096 bytes"
  f2: "0x18 | blks[0]| 820 (Disk Block)"
  total: "Read Count: 3 (Inode Table Block)"
}

step_4_home_data: {
  label: "STEP 4: Scan /home Entries"
  class: data_block_node
  header: "Disk Block 820 (Directory Data)"
  de0: "ino: 5  | len: 12 | name: '.'"
  de1: "ino: 1  | len: 12 | name: '..'"
  de2: "ino: 12 | len: 16 | name: 'user' <--"
  total: "Read Count: 4 (Data Block)"
}

step_5_user: {
  label: "STEP 5: 'user' Inode"
  class: inode_node
  header: "Inode 12 | Block 3 | Offset 0x580"
  f0: "0x00 | mode   | S_IFDIR | 0700"
  f1: "0x08 | size   | 4096 bytes"
  f2: "0x18 | blks[0]| 1044 (Disk Block)"
  total: "Read Count: 5 (Inode Table Block)"
}

step_6_user_data: {
  label: "STEP 6: Scan /home/user Entries"
  class: data_block_node
  header: "Disk Block 1044 (Directory Data)"
  de0: "ino: 12 | len: 12 | name: '.'"
  de1: "ino: 5  | len: 12 | name: '..'"
  de2: "ino: 47 | len: 24 | name: 'file.txt' <--"
  total: "Read Count: 6 (Data Block)"
}

final_result: {
  shape: step
  label: "Resolution Success"
  target: "TARGET_INODE: 47"
  stat: |'c
    inode_t target;
    read_inode(fd, sb, 47, &target);
    return target;
  '|
}

# --- CONNECTIONS & FLOW ---

vfs_input -> step_1_root: "inode_num | 4 bytes | 1"
step_1_root -> step_2_root_data: "uint32_t | 4 bytes | .blocks[0]=500"
step_2_root_data -> step_3_home: "inode_num | 4 bytes | 5"
step_3_home -> step_4_home_data: "uint32_t | 4 bytes | .blocks[0]=820"
step_4_home_data -> step_5_user: "inode_num | 4 bytes | 12"
step_5_user -> step_6_user_data: "uint32_t | 4 bytes | .blocks[0]=1044"
step_6_user_data -> final_result: "inode_num | 4 bytes | 47"

# --- ANNOTATIONS ---

perf_note: {
  label: "PERFORMANCE ANALYSIS"
  cost: "Min Block Reads: 6"
  complexity: "O(depth * entries_per_dir)"
  warning: "Each component incurs (InodeRead + DataRead)"
  optimization: "Linux dcache reduces this to O(1) in RAM"
}
perf_note.near: bottom-right