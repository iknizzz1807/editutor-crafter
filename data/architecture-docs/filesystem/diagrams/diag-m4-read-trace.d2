direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# 1. REQUEST LAYER
request: {
  label: "User Syscall: read(ino, buf, len=5000, off=6000)"
  shape: rectangle
  style: {
    stroke: "#2c3e50"
    fill: "#ecf0f1"
    stroke-width: 2
  }
  call: |'c
    ssize_t fs_read(int fd, superblock_t *sb,
                    uint32_t ino, uint64_t offset,
                    void *buf, size_t length);
  '|
}

# 2. ARITHMETIC LAYER
logic: {
  label: "Offset Arithmetic (file.c)"
  direction: down

  iter1: {
    label: "Iteration 1: Partial Head"
    code: |'c
      cur_offset = 6000;
      block_idx  = 6000 / 4096; // 1
      block_off  = 6000 % 4096; // 1904
      chunk      = 4096 - 1904; // 2192
    '|
  }

  iter2: {
    label: "Iteration 2: Partial Tail"
    code: |'c
      cur_offset = 8192;
      block_idx  = 8192 / 4096; // 2
      block_off  = 8192 % 4096; // 0
      chunk      = 5000 - 2192; // 2808
    '|
  }
}

# 3. RESOLUTION LAYER
metadata: {
  label: "Metadata Resolution"
  direction: down

  inode: {
    shape: sql_table
    label: "struct inode_t (ino=7)"
    f0: "0x00 | uint16_t | mode // S_IFREG"
    f1: "0x08 | uint32_t | size // 15000"
    f2: "0x18 | uint32_t | blocks[0]"
    f3: "0x1C | uint32_t | blocks[1] // points to DB 105"
    f4: "0x20 | uint32_t | blocks[2] // points to DB 106"
    f5: "..."
    sz: "Total: 128 bytes"
    style: {
      fill: "#e1bee7"
    }
  }
}

# 4. DATA PLANE LAYER
storage: {
  label: "Disk Image (Raw Blocks)"
  direction: down

  block_105: {
    shape: sql_table
    label: "Disk Block 105 (Logical Block 1)"
    r0: "0x0000 | [0 - 1903]   | Unread Data"
    r1: "0x0770 | [1904 - 4095] | Target Chunk 1"
    style: {
      fill: "#bbdefb"
    }
  }

  block_106: {
    shape: sql_table
    label: "Disk Block 106 (Logical Block 2)"
    r0: "0x0000 | [0 - 2807]   | Target Chunk 2"
    r1: "0x0AF8 | [2808 - 4095] | Unread Data"
    style: {
      fill: "#bbdefb"
    }
  }
}

# 5. OUTPUT LAYER
memory: {
  label: "User Process Memory"
  
  user_buffer: {
    shape: sql_table
    label: "char *buf (Length: 5000)"
    c1: "Offset 0    | 2192 bytes | From Block 1 (Bytes 6000-8191)"
    c2: "Offset 2192 | 2808 bytes | From Block 2 (Bytes 8192-10999)"
    style: {
      fill: "#c8e6c9"
    }
  }
}

# CONNECTIONS
request -> logic.iter1: "init | size_t | 5000"
logic.iter1 -> metadata.inode.f3: "lookup | index | 1"
logic.iter2 -> metadata.inode.f4: "lookup | index | 2"

metadata.inode.f3 -> storage.block_105: "read_block | 4KB | DB 105"
metadata.inode.f4 -> storage.block_106: "read_block | 4KB | DB 106"

storage.block_105.r1 -> memory.user_buffer.c1: "memcpy | 2192 bytes | buf[0..2191]"
storage.block_106.r0 -> memory.user_buffer.c2: "memcpy | 2808 bytes | buf[2192..4999]"

# ANNOTATIONS
annotation: {
  near: bottom-center
  label: "Cross-Block Read Boundary (Logical Offset 8192)"
  style: {
    stroke-dash: 3
    italic: true
  }
}