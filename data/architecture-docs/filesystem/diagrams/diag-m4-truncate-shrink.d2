direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# LEGEND / ANNOTATIONS
legend: {
  shape: package
  label: "Color Semantics"
  active: "Data / Allocated" {
    style: {
      fill: "#B6DDF6"
      stroke: "#3F87A6"
    }
  }
  freed: "Freed / Zeroed" {
    style: {
      fill: "#FFDADA"
      stroke: "#CA052B"
    }
  }
  meta: "Metadata" {
    style: {
      fill: "#E4DBFE"
      stroke: "#7939A8"
    }
  }
}

# BEFORE STATE
before: {
  label: "BEFORE: size = 20,000 bytes (5 Blocks)"
  direction: down

  sb_before: {
    shape: sql_table
    label: "superblock_t (block 0)"
    f0: "0x0C | uint32_t | total_blocks: 4096"
    f1: "0x14 | uint32_t | free_blocks: 50"
    sz: "Total: 4096 bytes"
    style.fill: "#E4DBFE"
  }

  bmap_before: {
    shape: sql_table
    label: "Block Bitmap (block 1)"
    bits: "Bit Index | State | Phys Block"
    b100: "100 | 1 (Used) | Data Block A"
    b101: "101 | 1 (Used) | Data Block B"
    b102: "102 | 1 (Used) | Data Block C"
    b103: "103 | 1 (Used) | Data Block D"
    b104: "104 | 1 (Used) | Data Block E"
    style.fill: "#E4DBFE"
  }

  inode_before: {
    shape: sql_table
    label: "inode_t (ino: 7)"
    f0: "0x00 | uint16_t | mode: S_IFREG | 0644"
    f1: "0x08 | uint32_t | size: 20000"
    b0: "0x18 | uint32_t | blocks[0]: 100"
    b1: "0x1C | uint32_t | blocks[1]: 101"
    b2: "0x20 | uint32_t | blocks[2]: 102"
    b3: "0x24 | uint32_t | blocks[3]: 103"
    b4: "0x28 | uint32_t | blocks[4]: 104"
    total: "Total: 128 bytes"
    style.fill: "#B6DDF6"
  }

  disk_blocks_before: {
    grid-columns: 5
    b100: "Block 100\n[0..4095]" { style.fill: "#B6DDF6" }
    b101: "Block 101\n[4096..8191]" { style.fill: "#B6DDF6" }
    b102: "Block 102\n[8192..12287]" { style.fill: "#B6DDF6" }
    b103: "Block 103\n[12288..16383]" { style.fill: "#B6DDF6" }
    b104: "Block 104\n[16384..20000]" { style.fill: "#B6DDF6" }
  }
}

# TRANSITION ACTION
before -> after: |'c
  // truncate(7, 5000)
  1. Zero block 101 [904..4095]
  2. Free blocks 102, 103, 104
  3. Update inode->size = 5000
  4. Nullify pointers [2..4]
'| {
  style: {
    stroke-width: 4
    animated: true
  }
}

# AFTER STATE
after: {
  label: "AFTER: size = 5,000 bytes (2 Blocks)"
  direction: down

  sb_after: {
    shape: sql_table
    label: "superblock_t (block 0)"
    f0: "0x0C | uint32_t | total_blocks: 4096"
    f1: "0x14 | uint32_t | free_blocks: 53"
    sz: "Total: 4096 bytes"
    style.fill: "#E4DBFE"
  }

  bmap_after: {
    shape: sql_table
    label: "Block Bitmap (block 1)"
    bits: "Bit Index | State | Phys Block"
    b100: "100 | 1 (Used) | Data Block A"
    b101: "101 | 1 (Used) | Data Block B"
    b102: "102 | 0 (Free) | Reclaimed" { style.stroke: red }
    b103: "103 | 0 (Free) | Reclaimed" { style.stroke: red }
    b104: "104 | 0 (Free) | Reclaimed" { style.stroke: red }
    style.fill: "#E4DBFE"
  }

  inode_after: {
    shape: sql_table
    label: "inode_t (ino: 7)"
    f0: "0x00 | uint16_t | mode: S_IFREG | 0644"
    f1: "0x08 | uint32_t | size: 5000"
    b0: "0x18 | uint32_t | blocks[0]: 100"
    b1: "0x1C | uint32_t | blocks[1]: 101"
    b2: "0x20 | uint32_t | blocks[2]: 0"
    b3: "0x24 | uint32_t | blocks[3]: 0"
    b4: "0x28 | uint32_t | blocks[4]: 0"
    total: "Total: 128 bytes"
    style.fill: "#B6DDF6"
  }

  disk_blocks_after: {
    label: "Physical Block State"
    b100: "Block 100\n[0..4095]\nINTACT" { style.fill: "#B6DDF6" }
    
    b101: {
      direction: right
      label: "Block 101 (Partial)"
      used: "4096..4999\nDATA" { style.fill: "#B6DDF6" }
      zeroed: "5000..8191\nZEROED" { 
        style: {
          fill: "#FFDADA"
          stroke-dash: 3
        }
      }
    }

    freed_region: {
      label: "Freed Pools"
      b102: "102 (Free)"
      b103: "103 (Free)"
      b104: "104 (Free)"
      style.fill: "#FFDADA"
    }
  }
}

# STRUCTURAL POINTERS
after.inode_after.b0 -> after.disk_blocks_after.b100: "uint32 | 4 bytes | 100"
after.inode_after.b1 -> after.disk_blocks_after.b101: "uint32 | 4 bytes | 101"
after.inode_after.b2 -> after.bmap_after.b102: "Reclaimed" { style.stroke-dash: 4 }

# ALGORITHM HIGHLIGHT
logic: {
  near: bottom-right
  label: "Partial-Block Zeroing Logic (file.c)"
  code: |'c
    uint32_t zero_start = new_size % BLOCK_SIZE; // 5000 % 4096 = 904
    uint32_t zero_len = BLOCK_SIZE - zero_start; // 4096 - 904 = 3192
    read_block(fd, 101, buf);
    memset(buf + zero_start, 0, zero_len);
    write_block(fd, 101, buf);
  '|
}