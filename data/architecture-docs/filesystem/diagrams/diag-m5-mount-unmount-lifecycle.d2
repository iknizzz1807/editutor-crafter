direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

lifecycle: {
  label: "FUSE Mount Lifecycle & State Evolution (myfs.c)"

  init: {
    shape: oval
    label: "INIT"
    tooltip: "System bootstrapping and image validation"
    logic: {
      shape: code
      code: |'c
        g_fs.fd = open(image_path, O_RDWR);
        read_block(g_fs.fd, 0, sb_buf);
        if (sb->magic != FS_MAGIC) return -EINVAL;
        journal_load(g_fs.fd, &g_fs.sb);
        journal_recover(g_fs.fd, &g_fs.sb);
      '|
    }
  }

  mount: {
    shape: oval
    label: "MOUNT"
    tooltip: "Kernel-to-Userspace Handshake"
    logic: {
      shape: code
      code: |'c
        static struct fuse_operations ops = {
          .init = myfs_init, .read = myfs_read,
          .write = myfs_write, .destroy = myfs_destroy
        };
        return fuse_main(argc, argv, &ops, NULL);
      '|
    }
  }

  running: {
    shape: oval
    label: "RUNNING"
    tooltip: "Active request dispatch loop"
    style.stroke: blue
    style.stroke-width: 4
    logic: {
      shape: code
      code: |'c
        while(active) {
          req = read_request("/dev/fuse");
          dispatch_callback(req); // e.g. myfs_read
          write_response("/dev/fuse");
        }
      '|
    }
  }

  unmounting: {
    shape: oval
    label: "UNMOUNTING"
    tooltip: "Atomic flush and persistence phase"
    style.fill: "#e1f5fe"
    logic: {
      shape: code
      code: |'c
        journal_checkpoint(g_fs.fd, &g_fs.sb);
        fsync(g_fs.fd); // Flush page cache
        write_block(g_fs.fd, 0, &g_fs.sb); // Sync SB
        close(g_fs.fd);
      '|
    }
  }

  done: {
    shape: oval
    label: "DONE"
    style.double-border: true
  }

  # Transitions: DataType | Size | Example
  init -> mount: "SB_CHECK | 4KB | 0xDEADC0DE"
  mount -> running: "FUSE_SESSION | RPC | session_loop"
  running -> unmounting: "SIGTERM | signal | 15"
  unmounting -> done: "SYNC_STATUS | 0 bytes | success"

  # Error Path
  running -> done: "SIGKILL | signal | 9" {
    style: {
      stroke: red
      stroke-width: 4
      stroke-dash: 5
    }
  }

  data_loss_warning: {
    shape: callout
    label: "CRITICAL: Skipping UNMOUNTING phase causes \npermanent data loss of dirty page cache blocks."
    style.fill: "#ffcdd2"
  }
}

legend: {
  shape: sql_table
  label: "Color Semantics & Flow"
  row1: "Blue | Hot Path / Active Operation"
  row2: "Red | Danger / Unclean Shutdown"
  row3: "Light Blue | Persistence & Sync Phase"
}

legend.near: bottom-right