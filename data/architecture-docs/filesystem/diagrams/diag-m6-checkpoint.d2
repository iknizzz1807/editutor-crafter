direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 1
  }
}

checkpoint_evolution: {
  direction: right
  label: "Journal Checkpoint â€” Reclaiming Journal Space"

  state_1: {
    label: "STATE 1: Journal Occupied (journal.c)"
    note: "T1-T5 committed but not yet checkpointed"
    jsuper: {
      shape: sql_table
      label: "journal_super_t (Offset 0)"
      f0: "0x00 | uint32_t | j_magic = 0x4A4F5552"
      f8: "0x08 | uint32_t | j_sequence = 105"
      f12: "0x0C | uint32_t | j_head = 0 // T1"
      f16: "0x10 | uint32_t | j_tail = 25 // Next write"
      sz: "Total: 4096 bytes"
    }
    block_map: {
      grid-rows: 1
      t1: "TXN 1" {style.fill: "#B6DDF6"}
      t2: "TXN 2" {style.fill: "#B6DDF6"}
      t3: "TXN 3" {style.fill: "#B6DDF6"}
      t4: "TXN 4" {style.fill: "#B6DDF6"}
      t5: "TXN 5" {style.fill: "#B6DDF6"}
      free: "FREE" {style.stroke-dash: 3}
    }
  }

  state_2: {
    label: "STATE 2: Verification & Sync (journal.c:checkpoint)"
    code: |'c
      // Ensure all in-place writes are durable
      // before we invalidate the journal
      if (fsync(fd) != 0) return -EIO;
      
      // Verification (advisory)
      // memcmp(journal_block, disk_block) == 0
    '|
    status: "Barrier reached" {
      shape: diamond
      style.fill: "#FFE7CB"
    }
  }

  state_3: {
    label: "STATE 3: Metadata Update (journal.c:checkpoint)"
    note: "Header pointers reset to tail"
    jsuper_updated: {
      shape: sql_table
      label: "journal_super_t (Updated)"
      f0: "0x00 | uint32_t | j_magic = 0x4A4F5552"
      f8: "0x08 | uint32_t | j_sequence = 105"
      f12: "0x0C | uint32_t | j_head = 25 // WAS 0"
      f16: "0x10 | uint32_t | j_tail = 25"
      sz: "Total: 4096 bytes"
    }
  }

  state_4: {
    label: "STATE 4: Reusable (journal.c)"
    block_map_empty: {
      grid-rows: 1
      free1: "AVAILABLE" {style.stroke-dash: 3}
      free2: "AVAILABLE" {style.stroke-dash: 3}
      free3: "AVAILABLE" {style.stroke-dash: 3}
      free4: "AVAILABLE" {style.stroke-dash: 3}
      free5: "AVAILABLE" {style.stroke-dash: 3}
      free6: "AVAILABLE" {style.stroke-dash: 3}
    }
    footer: "Circular Buffer Reset"
  }

  state_1 -> state_2: "Trigger: Space < 20% | uint32_t | blocks_free=5"
  state_2 -> state_3: "fsync() return | int | 0"
  state_3 -> state_4: "journal_persist_super() | 4KB | j_head=25"
}

# Fix: Moved danger_path to root to satisfy Rule F
danger_path: {
  blocking_event: "CRITICAL: JOURNAL FULL" {
    shape: callout
    style.fill: "#FE7070"
    label: "Writes Blocked: No new transactions can start until checkpoint completes."
  }
}
danger_path.near: bottom-center

legend: {
  metadata: "Metadata (Superblock)" {
    style.fill: "#E4DBFE"
  }
  data: "Committed Data" {
    style.fill: "#B6DDF6"
  }
}
legend.near: top-right

# Connection updated to reflect root-level danger_path
checkpoint_evolution.state_1.block_map.t5 -> danger_path.blocking_event: "If j_tail == j_head | bool | true" {
  style.stroke: red
  style.stroke-width: 2
}