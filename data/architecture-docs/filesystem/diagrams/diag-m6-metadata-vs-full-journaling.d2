direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

full_journaling: {
  label: "STRATEGY A: Full Journaling (ext3 data=journal)"
  direction: down

  flow: {
    shape: sql_table
    label: "Write Sequence (journal.c)"
    step1: "T1 | 4KB Data Block | User Payload (Block N)"
    step2: "T2 | 4KB Metadata   | Inode + Bitmap Updates"
    step3: "T3 | 4KB Commit     | Atomic Transaction End"
    step4: "T4 | 4KB Data Apply | Block N Final Location"
    step5: "T5 | 4KB Meta Apply | Inode Table + Bitmap Final"
    total: "Total: 20KB written for 4KB payload (5x Amplification)"
  }

  code: {
    label: "Logic: data_journal_write()"
    code: |'c
      journal_begin(txn);
      journal_copy_data(txn, data_buf, block_n);
      journal_copy_metadata(txn, inode, bitmap);
      journal_commit(txn); // fsync()
      checkpoint_apply(txn); // Background flush
    '|
  }

  safety_note: {
    label: "CRASH SAFETY: MAX"
    shape: callout
    style: {
      fill: "#d1e7dd"
      stroke: green
    }
    content: "If crash happens mid-write, the journal contains the ACTUAL DATA. Zero data loss for committed txns."
  }
}

metadata_only: {
  label: "STRATEGY B: Metadata-Only (ext4 default data=ordered)"
  direction: down

  flow: {
    shape: sql_table
    label: "Write Sequence (file.c)"
    step1: "T1 | 4KB Data Write | Direct to Data Block N"
    step2: "T2 | 4KB Barrier    | fsync() data blocks"
    step3: "T3 | 4KB Meta Jnl   | Journal Inode + Bitmap"
    step4: "T4 | 4KB Commit     | Atomic Transaction End"
    step5: "T5 | 4KB Meta Apply | Inode Table + Bitmap Final"
    total: "Total: 12KB written for 4KB payload (3x Amplification)"
  }

  code: {
    label: "Logic: data_ordered_write()"
    code: |'c
      write_block(block_n, data_buf);
      fsync(fd); // Ensure data is on platter
      journal_begin(txn);
      journal_copy_metadata(txn, inode, bitmap);
      journal_commit(txn); // Atomic Metadata commit
    '|
  }

  safety_note: {
    label: "CRASH SAFETY: CONSISTENT"
    shape: callout
    style: {
      fill: "#fff3cd"
      stroke: yellow
    }
    content: "Metadata is always valid. Crash may leave file with OLD data but NEW size/mtime if not fsync'd."
  }
}

full_journaling -> metadata_only: {
  label: "Trade-off: 40% Lower Write I/O vs. Data Integrity"
  style: {
    stroke-dash: 5
  }
}

legend: {
  near: bottom-right
  metadata: "Metadata Block" {
    style.fill: "#e1d5e7"
  }
  data: "User Data Block" {
    style.fill: "#dae8fc"
  }
  journal: "Journal Write Path" {
    style.stroke: red
    style.stroke-width: 2
  }
}

# Implementation Details
full_journaling.flow.step1 -> full_journaling.flow.step4: "Data Redundancy" { style.stroke: red }
metadata_only.flow.step1: { style.fill: "#dae8fc" }
metadata_only.flow.step3: { style.fill: "#e1d5e7" }