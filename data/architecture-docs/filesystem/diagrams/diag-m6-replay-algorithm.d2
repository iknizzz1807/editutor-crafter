direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- Data Structures used in Algorithm ---

structs: {
  journal_super: {
    shape: sql_table
    label: "journal_super_t (journal.h)"
    f0: "0x00 | uint32_t | j_magic // 0x4A4F5552"
    f1: "0x08 | uint32_t | j_sequence"
    f2: "0x0C | uint32_t | j_head // oldest commit"
    f3: "0x10 | uint32_t | j_tail // next free"
    sz: "Total: 4096 bytes (1 block)"
  }

  journal_desc: {
    shape: sql_table
    label: "journal_desc_t (journal.h)"
    f0: "0x00 | uint32_t | j_magic"
    f1: "0x04 | uint32_t | j_block_type // DESC"
    f2: "0x08 | uint32_t | j_sequence"
    f3: "0x0C | uint32_t | j_nr_blocks"
    f4: "0x10 | uint64_t[]| j_blocks[510]"
    sz: "Total: 4096 bytes"
  }
}

# --- Recovery Flowchart ---

recovery_algorithm: {
  label: "Journal Replay Algorithm (journal.c:recover)"

  start: {shape: oval; label: "Mount Attempt"}

  read_sb: {
    label: "1. Read Journal Superblock"
    code: |'c
      read_block(fd, sb->journal_start, &js);
      pos = js.j_head;
      tail = js.j_tail;
    '|
  }

  loop_check: {
    shape: diamond
    label: "pos != tail?"
  }

  scan_block: {
    label: "2. Inspect Block"
    code: |'c
      read_block(fd, abs_pos(pos), buf);
      if (buf->type != JB_TYPE_DESC) 
        goto next;
    '|
  }

  find_commit: {
    label: "3. Seek Commit Record"
    code: |'c
      commit_pos = pos + 1 + desc->nr_blocks;
      read_block(fd, abs_pos(commit_pos), &commit);
    '|
  }

  is_committed: {
    shape: diamond
    label: "Valid Commit?"
  }

  replay_blocks: {
    label: "4. Idempotent Replay"
    style.fill: "#D4EDDA"
    code: |'c
      for (i=0; i < nr; i++) {
        data = read_journal(pos + 1 + i);
        write_block(fd, desc->blocks[i], data);
      }
    '|
  }

  discard_txn: {
    label: "Discard Transaction"
    style.fill: "#F8D7DA"
    description: "Incomplete Txn: Atomicity Guaranteed"
  }

  advance: {
    label: "Advance Scan"
    code: |'c
      pos = (pos + 1) % j_total_blocks;
    '|
  }

  checkpoint: {
    label: "5. Checkpoint & Cleanup"
    code: |'c
      js.j_head = js.j_tail;
      journal_persist_super(fd, &js);
      fsync(fd);
    '|
  }

  finish: {shape: oval; label: "Normal Mount Proceed"}

  # Connections
  start -> read_sb
  read_sb -> loop_check
  loop_check -> scan_block: "Yes (Scan Remaining)"
  scan_block -> find_commit: "DESC Found"
  find_commit -> is_committed
  
  is_committed -> replay_blocks: "YES: committed"
  is_committed -> discard_txn: "NO: aborted/crash"
  
  replay_blocks -> advance
  discard_txn -> advance
  
  advance -> loop_check: "Next Block"
  loop_check -> checkpoint: "No (End of Log)"
  checkpoint -> finish
}

# --- Performance Context callout ---

complexity_note: {
  shape: callout
  label: "Performance Analysis"
  content: |md
    ### O(Journal Size) Recovery
    - **Journal Scan**: ~1,024 blocks (4MB journal)
    - **Full FSCK**: ~2,621,440 blocks (10GB disk)
    - **Result**: Recovery takes **~40ms** vs **~10 minutes**
  |
}

# Layout anchors
recovery_algorithm.advance -> recovery_algorithm.loop_check: {style.stroke-dash: 3}
complexity_note.near: top-right

# Arrow Annotations
recovery_algorithm.read_sb -> recovery_algorithm.loop_check: "uint32_t | 4 | j_head"
recovery_algorithm.find_commit -> recovery_algorithm.is_committed: "uint32_t | 4 | j_sequence"
recovery_algorithm.replay_blocks -> recovery_algorithm.advance: "void* | 4KB | block_copy"