direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  ### File Offset â†’ Block Number Translation
  **Logic for `inode_get_block(uint64_t offset)`**
| {
  near: top-center
  shape: text
}

# Decision Nodes
calc: "1. Calculate Logical Block Index\n`bi = offset / 4096`" {
  style.stroke-width: 2
}

check_direct: "2. Is `bi < 12`?\n(Offset < 49,152)" {
  shape: diamond
}

check_single: "3. Is `bi < 1036`?\n(Offset < 4,243,456)" {
  shape: diamond
}

check_si_null: "4. `single_indirect == 0`?" {
  shape: diamond
}

check_di_null: "6. `double_indirect == 0`?" {
  shape: diamond
}

# Result Nodes
ret_direct: "RETURN `inode.blocks[bi]`" {
  style: {
    fill: "#E1F5FE"
    stroke: "#0288D1"
  }
}

ret_hole: "RETURN `0` (Sparse Hole)" {
  style: {
    fill: "#E8F5E9"
    stroke: "#2E7D32"
  }
}

read_si: "5. READ Block `single_indirect` into RAM" {
  style: {
    fill: "#FFF3E0"
    stroke: "#EF6C00"
  }
}

ret_si: "RETURN `ptrs[bi - 12]`" {
  style: {
    fill: "#E1F5FE"
    stroke: "#0288D1"
  }
}

read_di_outer: "7. READ Block `double_indirect` (Outer)" {
  style: {
    fill: "#FFF3E0"
    stroke: "#EF6C00"
  }
}

read_di_inner: "8. READ Block `outer_ptrs[outer_idx]` (Inner)" {
  style: {
    fill: "#FFF3E0"
    stroke: "#EF6C00"
  }
}

ret_di: "RETURN `inner_ptrs[inner_idx]`" {
  style: {
    fill: "#E1F5FE"
    stroke: "#0288D1"
  }
}

# Connections
calc -> check_direct

check_direct -> ret_direct: "Yes (Direct)" {
  label: "**Reads: 0**"
  style.font-color: blue
}

check_direct -> check_single: "No"

check_single -> check_si_null: "Yes (Single Indirect)"

check_si_null -> ret_hole: "Yes" {
  label: "**Reads: 0**"
  style.font-color: green
}

check_si_null -> read_si: "No"
read_si -> ret_si: {
  label: "**Reads: 1**"
  style.font-color: orange
}

check_single -> check_di_null: "No (Double Indirect)"

check_di_null -> ret_hole: "Yes" {
  label: "**Reads: 0**"
  style.font-color: green
}

check_di_null -> read_di_outer: "No"
read_di_outer -> read_di_inner: {
  label: "**Reads: 1**"
  style.font-color: orange
}
read_di_inner -> ret_di: {
  label: "**Total Reads: 2**"
  style.font-color: "#EF6C00"
  style.bold: true
}

# Constraints/Annotations
legend: {
  near: bottom-right
  direct: "N_DIRECT = 12"
  ptrs: "PTRS_PER_BLOCK = 1024"
  b1: "Boundary 1: 49,152 bytes"
  b2: "Boundary 2: 4,243,456 bytes"
  
  style.stroke-dash: 3
}

# Illegal transition check (from Module 5 specification)
check_direct -> check_di_null: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}