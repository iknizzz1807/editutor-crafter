layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

# --- TECHNICAL CLASSES ---
classes: {
  inode_header: {
    style: {
      fill: "#E1D5E7" # Purple (Header)
      stroke: "#9673A6"
      stroke-width: 2
    }
  }
  data_block: {
    style: {
      fill: "#DAE8FC" # Blue (Data)
      stroke: "#6C8EBF"
    }
  }
  free_block: {
    style: {
      fill: "#D5E8D4" # Green (Free)
      stroke: "#82B366"
      stroke-dash: 3
    }
  }
  pointer_block: {
    style: {
      fill: "#FFE6CC" # Orange (Pointers)
      stroke: "#D79B00"
    }
  }
  padding: {
    style: {
      fill: "#F5F5F5" # Gray (Padding)
      stroke: "#CCCCCC"
    }
  }
  changed: {
    style: {
      stroke: "#FF0000"
      stroke-width: 4
      font-color: "#FF0000"
      bold: true
    }
  }
}

# --- ALGORITHM STATE DIAGRAM ---

Step 1: "1. Free Direct Blocks" {
  inode: {
    class: inode_header
    label: "Inode Table Entry\nsize=128B"
    
    offs_0: "0x00: i_mode (2B)" { class: padding }
    offs_4: "0x04: i_size (4B)" { class: padding }
    
    # FIXED: Replaced invalid shape 'line' with 'text' to indicate boundary
    cache_line_break: "---------------- 64B Cache Line Boundary ----------------" {
      shape: text
      style.font-size: 10
    }
    
    i_blocks: "0x28: i_block[0..11] (48B)" {
      class: changed
      label: "**i_block[0..11] -> NULL**"
    }
  }
  
  data_region: "Data Region" {
    b0: "Block 500" { class: free_block; label: "**FREE**" }
    b1: "Block 501" { class: free_block; label: "**FREE**" }
    b11: "Block 511" { class: free_block; label: "**FREE**" }
  }

  inode.i_blocks -> data_region.b0: "unmap" { style.stroke: orange }
  inode.i_blocks -> data_region.b1 { style.stroke: orange }
  inode.i_blocks -> data_region.b11 { style.stroke: orange }
}

Step 2: "2. Free Single Indirect" {
  inode: {
    class: inode_header
    i_single_ind: "0x58: i_block[12] (4B)" { 
      class: changed 
      label: "**i_single_ind -> NULL**"
    }
  }

  indirect_blk: "Indirect Block (4KB)" {
    class: pointer_block
    style.stroke-width: 4 # Page Boundary
    ptrs: "ptrs[0..1023]" { 
      class: changed 
      label: "**ALL PTRS -> NULL**"
    }
  }

  data_region: "Data Region" {
    db: "Blocks 1000..2023" { class: free_block; label: "**FREE**" }
  }

  inode.i_single_ind -> indirect_blk: "1. Read/Invalidate" { style.stroke: orange }
  indirect_blk.ptrs -> data_region.db: "2. Free Data" { style.stroke: orange }
  
  note: |md
    **State Machine Transition:**
    1. Fetch pointer list
    2. Free 1024 leaf blocks
    3. Deallocate Ind-Block
  |
}

Step 3: "3. Free Double Indirect" {
  inode: {
    class: inode_header
    i_double_ind: "0x5C: i_block[13] (4B)" { 
      class: changed 
      label: "**i_double_ind -> NULL**"
    }
  }

  outer: "Outer Ptr Block" { class: pointer_block; label: "Level 2 Pointers"; style.stroke-width: 4 }
  inner: "Inner Ptr Block" { class: pointer_block; label: "Level 1 Pointers"; style.stroke-width: 4 }
  
  data_region: "Data Region" {
    db: "Target Data Blocks" { class: free_block; label: "**FREE**" }
  }

  inode.i_double_ind -> outer: "1. Entry" { style.stroke: orange }
  outer -> inner: "2. Recurse" { style.stroke: orange }
  inner -> data_region.db: "3. Free Leaf" {
    style: {
      stroke: "#FF0000"
      stroke-width: 2
      bold: true
    }
    label: "**RECURSIVE FREE**"
  }
}

Step 4_5: "4 & 5. Cleanup Metadata" {
  inode_table: "Inode Table Page (4KB)" {
    class: inode_header
    style.stroke-width: 4 # Page Boundary
    
    slot: "Inode #123 Slot" {
      class: changed
      label: "**0x00 ... 0x00 (ZEROED)**"
    }
  }

  bitmap: "Inode Bitmap Block" {
    byte: "Byte 15" {
      class: changed
      label: "[111**0**1111] (Bit 3 Cleared)"
    }
  }

  sub_step_4: "4. Zero Inode Struct"
  sub_step_5: "5. Update Bitmap"
  sub_step_4 -> sub_step_5: "Sequential Atomic"
}

# --- FLOW ---
Step 1 -> Step 2: "Depth 0 done"
Step 2 -> Step 3: "Depth 1 done"
Step 3 -> Step 4_5: "Tree Purged"

explanation: |md
  ### FS DEALLOCATION INVARIANTS
  1. **Leaf-to-Root**: Data blocks (Blue) freed before Pointer blocks (Orange).
  2. **Bitmap Priority**: Block bitmap must be updated before Inode Table (Purple) update to prevent data corruption on crash.
  3. **Alignment**: All pointer blocks occupy exactly one 4096B page (Bold borders).
| {
  near: top-right
}