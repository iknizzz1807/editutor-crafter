direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  ### Inode Pointer Tree vs. x86-64 Page Table â€” Structural Parallel
  Both systems implement a **Radix Tree** with fixed fanout to translate a logical index into a physical block/page.
| {
  near: top-center
  shape: text
}

# -----------------------------------------------------------------------------
# FILESYSTEM SIDE (DOUBLE-INDIRECT TRAVERSAL)
# -----------------------------------------------------------------------------
FS: Filesystem Implementation (32-bit logical address) {
  style.fill: "#f0f4f8"
  
  Logical_Addr: "File Offset (32-bit)" {
    shape: sql_table
    style.fill: white
    "Bits 31-22": "Outer Index (10 bits)"
    "Bits 21-12": "Inner Index (10 bits)"
    "Bits 11-0": "Block Offset (12 bits)"
  }

  Inode: "inode_t (on-disk)" {
    shape: sql_table
    style.fill: "#e1d5e7" # Header=Purple
    0x00: "Metadata Fields (76B)"
    0x4C: "i_double_ind (4B pointer)" {style.fill: "#ffe5b4"} # Pointers=Orange
  }

  Outer: "Outer Pointer Block (4KB)" {
    shape: sql_table
    style.fill: "#dae8fc" # Data=Blue
    "0...1023": "Single-Indirect Pointers" {style.fill: "#ffe5b4"}
    fanout: "Fanout: 1024" {shape: text}
  }

  Inner: "Inner Pointer Block (4KB)" {
    shape: sql_table
    style.fill: "#dae8fc" # Data=Blue
    "0...1023": "Data Block Pointers" {style.fill: "#ffe5b4"}
    fanout: "Fanout: 1024" {shape: text}
  }

  Data: "Data Block (4KB)" {
    shape: sql_table
    style.fill: "#d5e8d4" # Free/Data=Green
    "0...4095": "Raw Payload Bytes"
  }

  Logical_Addr."Bits 31-22" -> Outer: "Select Slot" {style.stroke-dash: 3}
  Logical_Addr."Bits 21-12" -> Inner: "Select Slot" {style.stroke-dash: 3}
  Logical_Addr."Bits 11-0" -> Data: "Byte Offset" {style.stroke-dash: 3}

  Inode.0x4C -> Outer: "Points to"
  Outer."0...1023" -> Inner: "Points to"
  Inner."0...1023" -> Data: "Points to"

  annotation: |md
    **Capacity (Double Indirect)**
    - Depth: 2 Indirections
    - Fanout: $1024^2$
    - Coverage: 4 GB
  |
}

# -----------------------------------------------------------------------------
# CPU ARCHITECTURE SIDE (x86-64 PAGING)
# -----------------------------------------------------------------------------
CPU: x86-64 Architecture (48-bit Virtual Address) {
  style.fill: "#fff2cc"
  
  VA: "Virtual Address (48-bit)" {
    shape: sql_table
    style.fill: white
    "47-39": "PML4 Index (9b)"
    "38-30": "PDPT Index (9b)"
    "29-21": "PD Index (9b)"
    "20-12": "PT Index (9b)"
    "11-0": "Page Offset (12b)"
  }

  CR3: "CR3 Register" {
    shape: sql_table
    style.fill: "#e1d5e7" # Header=Purple
    reg: "PML4 Base Address" {style.fill: "#ffe5b4"} # Pointers=Orange
  }

  PML4: "PML4 Table (4KB)" {
    shape: sql_table
    style.fill: "#dae8fc" # Data=Blue
    "0...511": "PDPT Pointers" {style.fill: "#ffe5b4"}
  }

  PT: "Page Table (4KB)" {
    shape: sql_table
    style.fill: "#dae8fc" # Data=Blue
    "0...511": "PTE (Physical Page Pointers)" {style.fill: "#ffe5b4"}
  }

  Frame: "Physical Page (4KB)" {
    shape: sql_table
    style.fill: "#d5e8d4" # Free/Data=Green
    "0...4095": "Physical RAM"
  }

  VA."47-39" -> PML4: "Select Slot" {style.stroke-dash: 3}
  VA."11-0" -> Frame: "Byte Offset" {style.stroke-dash: 3}

  CR3.reg -> PML4: "Points to"
  PML4 -> PT: "..." {style.stroke-dash: 5}
  PT."0...511" -> Frame: "Points to"

  annotation: |md
    **Capacity (4-Level Paging)**
    - Depth: 4 Indirections
    - Fanout: $512^4$
    - Coverage: 256 TB
  |
}

# Structural Identity Link
FS <-> CPU: "Identical multi-level indexing logic" {
  style: {
    stroke-width: 4
    animated: true
  }
}

legend: {
  near: bottom-right
  h: Header {style.fill: "#e1d5e7"}
  p: Pointers {style.fill: "#ffe5b4"}
  d: Data/Pages {style.fill: "#dae8fc"}
  f: Free/RAM {style.fill: "#d5e8d4"}
}