direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

directory_block: "Directory Data Block (4096 bytes)" {
  style: {
    stroke-width: 4
    stroke: black
    double-border: true
  }

  entry_1: "Entry 1: '.'" {
    grid-columns: 3
    grid-gap: 0
    
    o0: "0x00" { shape: text; style.font-size: 10 }
    f0: "inode_num: 7" {
      style: { fill: "#E1D5E7"; stroke: "#9673A6" }
    }
    s0: "4 bytes" { shape: text; style.font-size: 10 }

    o4: "0x04" { shape: text; style.font-size: 10 }
    f4: "rec_len: 12" {
      style: { fill: "#FFE6CC"; stroke: "#FFA500"; stroke-width: 3 }
    }
    s4: "2 bytes" { shape: text; style.font-size: 10 }

    o6: "0x06" { shape: text; style.font-size: 10 }
    f6: "name_len: 1" {
      style: { fill: "#E1D5E7"; stroke: "#9673A6" }
    }
    s6: "1 byte" { shape: text; style.font-size: 10 }

    o7: "0x07" { shape: text; style.font-size: 10 }
    f7: "file_type: 2" {
      style: { fill: "#E1D5E7"; stroke: "#9673A6" }
    }
    s7: "1 byte" { shape: text; style.font-size: 10 }

    o8: "0x08" { shape: text; style.font-size: 10 }
    f8: "name: '.'" {
      style: { fill: "#DAE8FC"; stroke: "#6C8EBF" }
    }
    s8: "1 byte" { shape: text; style.font-size: 10 }

    o9: "0x09" { shape: text; style.font-size: 10 }
    f9: "padding (aligned 4B)" {
      style: { fill: "#F5F5F5"; stroke: "#666666" }
    }
    s9: "3 bytes" { shape: text; style.font-size: 10 }
  }

  entry_2: "Entry 2: '..'" {
    grid-columns: 3
    grid-gap: 0

    o12: "0x0C" { shape: text; style.font-size: 10 }
    f12: "inode_num: 3" {
      style: { fill: "#E1D5E7"; stroke: "#9673A6" }
    }
    s12: "4 bytes" { shape: text; style.font-size: 10 }

    o16: "0x10" { shape: text; style.font-size: 10 }
    f16: "rec_len: 12" {
      style: { fill: "#FFE6CC"; stroke: "#FFA500"; stroke-width: 3 }
    }
    s16: "2 bytes" { shape: text; style.font-size: 10 }

    o18: "0x12" { shape: text; style.font-size: 10 }
    f18: "name_len: 2" {
      style: { fill: "#E1D5E7"; stroke: "#9673A6" }
    }
    s18: "1 byte" { shape: text; style.font-size: 10 }

    o19: "0x13" { shape: text; style.font-size: 10 }
    f19: "file_type: 2" {
      style: { fill: "#E1D5E7"; stroke: "#9673A6" }
    }
    s19: "1 byte" { shape: text; style.font-size: 10 }

    o20: "0x14" { shape: text; style.font-size: 10 }
    f20: "name: '..'" {
      style: { fill: "#DAE8FC"; stroke: "#6C8EBF" }
    }
    s20: "2 bytes" { shape: text; style.font-size: 10 }

    o22: "0x16" { shape: text; style.font-size: 10 }
    f22: "padding (aligned 4B)" {
      style: { fill: "#F5F5F5"; stroke: "#666666" }
    }
    s22: "2 bytes" { shape: text; style.font-size: 10 }
  }

  entry_3: "Entry 3: 'myfile.c'" {
    grid-columns: 3
    grid-gap: 0

    o24: "0x18" { shape: text; style.font-size: 10 }
    f24: "inode_num: 42" {
      style: { fill: "#E1D5E7"; stroke: "#9673A6" }
    }
    s24: "4 bytes" { shape: text; style.font-size: 10 }

    o28: "0x1C" { shape: text; style.font-size: 10 }
    f28: "rec_len: 4072" {
      style: { fill: "#FFE6CC"; stroke: "#FFA500"; stroke-width: 3 }
    }
    s28: "2 bytes" { shape: text; style.font-size: 10 }

    o30: "0x1E" { shape: text; style.font-size: 10 }
    f30: "name_len: 8" {
      style: { fill: "#E1D5E7"; stroke: "#9673A6" }
    }
    s30: "1 byte" { shape: text; style.font-size: 10 }

    o31: "0x1F" { shape: text; style.font-size: 10 }
    f31: "file_type: 1" {
      style: { fill: "#E1D5E7"; stroke: "#9673A6" }
    }
    s31: "1 byte" { shape: text; style.font-size: 10 }

    o32: "0x20" { shape: text; style.font-size: 10 }
    f32: "name: 'myfile.c'" {
      style: { fill: "#DAE8FC"; stroke: "#6C8EBF" }
    }
    s32: "8 bytes" { shape: text; style.font-size: 10 }

    o40: "0x28" { shape: text; style.font-size: 10 }
    f40: "Free Space (Hole)" {
      style: { 
        fill: "#D5E8D4"
        stroke: "#82B366"
        stroke-dash: 5
      }
    }
    s40: "4056 bytes" { shape: text; style.font-size: 10 }
  }

  entry_1.f4 -> entry_2.f12: "rec_len=12" {
    style: { stroke: "#FFA500"; stroke-width: 2; animated: true }
  }
  entry_2.f16 -> entry_3.f24: "rec_len=12" {
    style: { stroke: "#FFA500"; stroke-width: 2; animated: true }
  }
}

legend: "Legend & Annotations" {
  near: bottom-right
  h: "Header Field" { style.fill: "#E1D5E7" }
  p: "rec_len Link (Pointer)" { style.fill: "#FFE6CC" }
  d: "Data (Name)" { style.fill: "#DAE8FC" }
  pad: "Alignment Padding" { style.fill: "#F5F5F5" }
  free: "Free Space" { style.fill: "#D5E8D4" }
  
  info: |md
    - **Total Block Size**: 4096B (4KB Virtual Memory Page)
    - **Alignment**: Standard ext4 directory 4-byte boundaries.
    - **Chain Persistence**: Last entry `rec_len` spans to end of block.
    - **Intel Manual Spec**: All entries shown fit in one **64B Cache Line**.
  |
}

# FIXED: Removed 'near' object reference which is unsupported in ELK.
# Used 'top-left' constant position for the label.
cache_line_label: "64B Cache Line Boundary (Aligned to 0x40)" {
  shape: text
  near: top-left
  style.font-size: 12
  style.bold: true
  style.font-color: gray
}

# Representing the physical boundary as a dashed line
cache_boundary_line: "" {
  style: {
    stroke-dash: 5
    stroke: gray
    stroke-width: 2
  }
}

# Connection showing logical grouping rather than strict positional constraint
directory_block -> cache_line_label: {
  style.stroke-dash: 3
  style.stroke: "#CCCCCC"
  style.opacity: 0.5
}