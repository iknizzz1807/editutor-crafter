vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- Technical Specification Styles ---
classes: {
  inode: {
    shape: class
    style: {
      stroke: "#533483"
      stroke-width: 2
      fill: "#E1D5E7" # Header: Purple
      font-color: "#2D1B4D"
    }
  }
  breakdown: {
    shape: text
    style: {
      font-size: 11
      italic: true
      font-color: "#333333"
    }
  }
  ref_dot: {
    style: {
      stroke: orange
      stroke-dash: 3
      stroke-width: 2
    }
  }
  ref_dotdot: {
    style: {
      stroke: orange
      stroke-dash: 5
      stroke-width: 2
    }
  }
}

# --- System Legend ---
legend: {
  near: top-center
  label: |md
    ### Inode Link Count Invariants (Architecture Spec)
    - **DIR:** $2 + \text{subdirectories}$ (Base: Self + Parent/Root)
    - **REG:** $1 + \text{additional hardlinks}$ (Base: Directory Entry)
    - **sizeof:** 128 bytes (2x Cache Line Alignment)
  |
}

# --- Filesystem Hierarchy Nodes ---

root: {
  meta: {
    label: "Inode 1 (Root /)"
    class: inode
    "0x00 (2B)": "st_mode: DIR | 0755"
    "0x02 (2B)": "st_nlink: 3"
    "0x04 (8B)": "st_size: 4096B"
    "0x0C (128B)": "sizeof=128 bytes"
  }
  analysis: {
    label: |md
      **Ino 1 Reference Count**
      - Mount Point: 1
      - Self Reference (.): 1
      - Child (/home/..): 1
      **Total st_nlink: 3**
    |
    class: breakdown
  }
}

home: {
  meta: {
    label: "Inode 14 (/home)"
    class: inode
    "0x00 (2B)": "st_mode: DIR | 0755"
    "0x02 (2B)": "st_nlink: 4"
    "0x04 (8B)": "st_size: 4096B"
    "0x0C (128B)": "sizeof=128 bytes"
  }
  analysis: {
    label: |md
      **Ino 14 Reference Count**
      - Parent (/home): 1
      - Self Reference (.): 1
      - Child (/user/..): 1
      - Child (/var/..): 1
      **Total st_nlink: 4**
    |
    class: breakdown
  }
}

user: {
  meta: {
    label: "Inode 82 (/home/user)"
    class: inode
    "0x00 (2B)": "st_mode: DIR | 0700"
    "0x02 (2B)": "st_nlink: 3"
    "0x04 (8B)": "st_size: 4096B"
    "0x0C (128B)": "sizeof=128 bytes"
  }
  analysis: {
    label: |md
      **Ino 82 Reference Count**
      - Parent Entry: 1
      - Self Reference (.): 1
      - Child (/projects/..): 1
      **Total st_nlink: 3**
    |
    class: breakdown
  }
}

var: {
  meta: {
    label: "Inode 15 (/home/var)"
    class: inode
    "0x00 (2B)": "st_mode: DIR | 0755"
    "0x02 (2B)": "st_nlink: 2"
    "0x04 (8B)": "st_size: 4096B"
    "0x0C (128B)": "sizeof=128 bytes"
  }
  analysis: {
    label: |md
      **Ino 15 Reference Count**
      - Parent Entry: 1
      - Self Reference (.): 1
      **Total st_nlink: 2**
    |
    class: breakdown
  }
}

projects: {
  meta: {
    label: "Inode 83 (/user/proj)"
    class: inode
    "0x00 (2B)": "st_mode: DIR | 0755"
    "0x02 (2B)": "st_nlink: 2"
    "0x04 (8B)": "st_size: 4096B"
    "0x0C (128B)": "sizeof=128 bytes"
  }
  analysis: {
    label: |md
      **Ino 83 Reference Count**
      - Parent Entry: 1
      - Self Reference (.): 1
      **Total st_nlink: 2**
    |
    class: breakdown
  }
}

file: {
  meta: {
    label: "Inode 1041 (file.txt)"
    class: inode
    "0x00 (2B)": "st_mode: REG | 0644"
    "0x02 (2B)": "st_nlink: 1"
    "0x04 (8B)": "st_size: 142B"
    "0x0C (128B)": "sizeof=128 bytes"
  }
  analysis: {
    label: |md
      **Ino 1041 Reference Count**
      - Directory Entry: 1
      **Total st_nlink: 1**
    |
    class: breakdown
  }
}

# --- Hierarchy: Structural Ownership ---
root.meta -> home.meta: "dentry: home"
home.meta -> user.meta: "dentry: user"
home.meta -> var.meta: "dentry: var"
user.meta -> file.meta: "dentry: file.txt"
user.meta -> projects.meta: "dentry: projects"

# --- Reference Pointers (Orange) ---

# . (Self)
root.meta -> root.meta: "." { class: ref_dot }
home.meta -> home.meta: "." { class: ref_dot }
user.meta -> user.meta: "." { class: ref_dot }
var.meta -> var.meta: "." { class: ref_dot }
projects.meta -> projects.meta: "." { class: ref_dot }

# .. (Parent)
home.meta -> root.meta: ".." { class: ref_dotdot }
user.meta -> home.meta: ".." { class: ref_dotdot }
var.meta -> home.meta: ".." { class: ref_dotdot }
projects.meta -> user.meta: ".." { class: ref_dotdot }

# Root recursive parent
root.meta -> root.meta: ".." { class: ref_dotdot }