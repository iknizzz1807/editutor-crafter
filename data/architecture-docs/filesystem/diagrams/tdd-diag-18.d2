direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

mkdir_projects: {
  label: "fs_mkdir(parent_ino=82, name='projects') â€” Atomic Mutation Sequence"

  before: {
    label: "BEFORE: Filesystem State (Quiescent)"
    style.fill: "#f8f9fa"
    
    ibmap: {
      grid-columns: 8
      label: "Inode Bitmap (Block 1)"
      "0"; "0"; "0"; "0"; "0"; "0"; "0"; "0"
      slot_99: "bit 98: 0" { 
        style.fill: "#dae8fc" # Data Blue
      }
    }

    bbmap: {
      grid-columns: 8
      label: "Block Bitmap (Block 2)"
      slot_B: "bit_B: 0" { style.fill: "#dae8fc" }
      slot_C: "bit_C: 0" { style.fill: "#dae8fc" }
    }

    inode_table: {
      label: "Inode Table (Blocks 3-N)"
      ino_82: "Inode 82 (user)\nmode: DIR\nnlinks: 2\nsize: 4096\nblocks: [A, 0, 0...]" {
        style.fill: "#e1d5e7" # Header Purple
      }
      ino_99: "Inode 99 (FREE)\nmode: 0\nnlinks: 0\nsize: 0\nblocks: [0...]" {
        style.fill: "#d5e8d4" # Free Green
      }
    }

    data_region: {
      blk_A: "Block A (user content)\n[ . -> 82 | .. -> 1 ]" { style.fill: "#dae8fc" }
    }
  }

  after: {
    label: "AFTER: Filesystem State (Post-Commit)"
    style.fill: "#f8f9fa"

    mutation_sequence: {
      grid-columns: 1
      
      s1: "1. Inode Bitmap Write" {
        tooltip: "Mark Inode 99 as USED"
        shape: sql_table
        bit_98: "**1**" { constraint: "SET"; style.fill: "#ffcccc"; style.font-color: red; style.bold: true }
      }

      cw1: "CRASH WINDOW: Inode Leaked" {
        shape: text
        style.font-color: red
      }

      s2: "2. Block Bitmap Write (C)" {
        tooltip: "Reserve Data Block C for projects content"
        shape: sql_table
        bit_C: "**1**" { constraint: "SET"; style.fill: "#ffcccc"; style.font-color: red; style.bold: true }
      }

      s3: "3. Block Bitmap Write (B)" {
        tooltip: "Reserve Data Block B for parent entry"
        shape: sql_table
        bit_B: "**1**" { constraint: "SET"; style.fill: "#ffcccc"; style.font-color: red; style.bold: true }
      }

      cw2: "CRASH WINDOW: Blocks Leaked" {
        shape: text
        style.font-color: red
      }

      s4: "4. Inode 99 Initialization" {
        shape: sql_table
        ino: 99
        mode: "**DIR**" { style.fill: "#ffcccc"; style.font-color: red; style.bold: true }
        nlinks: "**2**" { style.fill: "#ffcccc"; style.font-color: red; style.bold: true }
        size: "**4096**" { style.fill: "#ffcccc"; style.font-color: red; style.bold: true }
        ptr0: "**Block C**" { style.fill: "#ffcccc"; style.font-color: red; style.bold: true }
      }

      cw3: "CRASH WINDOW: Orphaned Inode" {
        shape: text
        style.font-color: red
      }

      s5: "5. Data Block C Initialization" {
        shape: sql_table
        label: "Block C (projects entries)"
        entry0: "**'.' -> 99**" { style.fill: "#ffcccc"; style.font-color: red; style.bold: true }
        entry1: "**'..' -> 82**" { style.fill: "#ffcccc"; style.font-color: red; style.bold: true }
      }

      s6: "6. Parent Data Block B Write" {
        shape: sql_table
        label: "Block B (user extension)"
        entryX: "**'projects' -> 99**" { style.fill: "#ffcccc"; style.font-color: red; style.bold: true }
      }

      cw4: "CRASH WINDOW: Link Inconsistency" {
        shape: text
        style.font-color: red
      }

      s7: "7. Parent Inode 82 Update" {
        shape: sql_table
        ino: 82
        nlinks: "**3**" { style.fill: "#ffcccc"; style.font-color: red; style.bold: true }
        ptr1: "**Block B**" { style.fill: "#ffcccc"; style.font-color: red; style.bold: true }
      }
    }
  }

  before.inode_table.ino_82 -> after.mutation_sequence.s7: "nlinks update (2->3)" {
    style.stroke: orange
    style.animated: true
  }
  
  before.inode_table.ino_99 -> after.mutation_sequence.s4: "Allocated & Formatted" {
    style.stroke: orange
    style.animated: true
  }
}

mkdir_note: ||md
  ### Consistency Rule:
  **Bitmap First, then Metadata, then Directory Link.**
  *   If crash happens early, `fsck` reclaims 'leaked' bits.
  *   If crash happens late, `fsck` resolves 'orphaned' inodes.
  *   Final step (7) completes the POSIX hard link contract.
|| {
  near: bottom-right
}