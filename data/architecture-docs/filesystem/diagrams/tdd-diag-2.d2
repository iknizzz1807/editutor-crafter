direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# --- ATTACHED METADATA ---
legend: {
  shape: package
  label: "Filesystem Physical Layout Spec"
  info: |md
    ### Parameters (Example)
    - **BLOCK_SIZE**: 4096 bytes
    - **TOTAL_BLOCKS**: 4096 (16 MB image)
    - **TOTAL_INODES**: 1024
    - **INODE_SIZE**: 128 bytes (32 per block)
  |
  near: top-left
}

# --- SUPERBLOCK VIEW ---
superblock_meta: {
  shape: sql_table
  label: "Block 0: Superblock Fields"
  style: {
    fill: "#e1d5e7"
    stroke: "#9673a6"
    stroke-width: 2
  }
  magic: "magic (0xDEADC0DE)" {constraint: "4B"}
  it_start: "inode_table_start" {constraint: "4B"}
  it_len: "inode_table_blocks" {constraint: "4B"}
  j_start: "journal_start" {constraint: "4B"}
  j_len: "journal_blocks" {constraint: "4B"}
  d_start: "data_block_start" {constraint: "4B"}
}

# --- PHYSICAL DISK MAP ---
disk_map: {
  label: "Physical Disk Layout (Linear Block Address)"
  
  # Linear segments
  sb: "SUPERBLOCK" {
    tooltip: "Block 0"
    style: { fill: "#e1d5e7"; stroke: "#9673a6"; bold: true }
  }
  
  bb: "BLOCK BITMAP" {
    tooltip: "Block 1"
    style: { fill: "#e1d5e7"; stroke: "#9673a6" }
  }
  
  ib: "INODE BITMAP" {
    tooltip: "Block 2"
    style: { fill: "#e1d5e7"; stroke: "#9673a6" }
  }
  
  it: "INODE TABLE" {
    tooltip: "Blocks 3 to 34"
    style: { fill: "#e1d5e7"; stroke: "#9673a6" }
  }
  
  jr: "JOURNAL REGION" {
    tooltip: "Blocks 35 to 1058"
    style: { fill: "#ffe6cc"; stroke: "#d79b00" }
  }
  
  dr: "DATA BLOCKS" {
    tooltip: "Blocks 1059 to 4095"
    style: { fill: "#dae8fc"; stroke: "#6c8ebf" }
  }

  # Layout Arrangement
  sb -> bb -> ib -> it -> jr -> dr
}

# --- ANNOTATIONS AND OFFSETS ---
annotations: {
  shape: package
  style.stroke-dash: 3
  
  range_0: "Block [0]" { shape: text }
  range_1: "Block [1]" { shape: text }
  range_2: "Block [2]" { shape: text }
  range_it: "Blocks [3 .. 34]" { shape: text }
  range_jr: "Blocks [35 .. 1058]" { shape: text }
  range_dr: "Blocks [1059 .. 4095]" { shape: text }
  
  size_0: "Size: 1 Block" { shape: text }
  size_it: "Size: 32 Blocks" { shape: text }
  size_jr: "Size: 1024 Blocks" { shape: text }
  size_dr: "Size: 3037 Blocks" { shape: text }
}

# --- CONNECTIONS (Derivations) ---
superblock_meta.it_start -> disk_map.it: "Points to Block 3" {
  style: { stroke: "#d79b00"; stroke-width: 2; animated: true }
}
superblock_meta.j_start -> disk_map.jr: "Points to Block 35" {
  style: { stroke: "#d79b00"; stroke-width: 2; animated: true }
}
superblock_meta.d_start -> disk_map.dr: "Points to Block 1059" {
  style: { stroke: "#d79b00"; stroke-width: 2; animated: true }
}

# --- ALIGNMENT CONSTRAINTS ---
disk_map.sb -- annotations.range_0: {style.stroke-width: 0}
disk_map.bb -- annotations.range_1: {style.stroke-width: 0}
disk_map.ib -- annotations.range_2: {style.stroke-width: 0}
disk_map.it -- annotations.range_it: {style.stroke-width: 0}
disk_map.jr -- annotations.range_jr: {style.stroke-width: 0}
disk_map.dr -- annotations.range_dr: {style.stroke-width: 0}

disk_map.sb -- annotations.size_0: {style.stroke-width: 0}
disk_map.it -- annotations.size_it: {style.stroke-width: 0}
disk_map.jr -- annotations.size_jr: {style.stroke-width: 0}
disk_map.dr -- annotations.size_dr: {style.stroke-width: 0}

# Global Annotations
summary: ||md
  | Region | Start Block | Count | Description |
  | :--- | :--- | :--- | :--- |
  | Superblock | 0 | 1 | FS Metadata & Bootstrap |
  | Block Bitmap | 1 | 1 | Data region allocation |
  | Inode Bitmap | 2 | 1 | Inode table allocation |
  | Inode Table | 3 | 32 | 1024 Inodes @ 128B each |
  | Journal | 35 | 1024 | Write-ahead Log (4MB) |
  | Data Blocks | 1059 | 3037 | User file & Dir data |
|| {
  near: bottom-center
}