layout-engine: elk
theme-id: 4

# fs_write Read-Modify-Write (RMW) Cycle
# Parameters: fs_write(inode, offset=5000, length=100)
# Block Math: block_index=1, block_off=904, disk_block=2500

rmw_algorithm: {
  direction: down

  step_1: "STEP 1: read_block(2500) into RAM" {
    shape: package
    disk: {
      block_2500: "Disk Block 2500" {
        style.fill: "#f5f5f5"
        0000: "Existing Data" { style.fill: "#dae8fc" }
        0904: "Existing Data (to be modified)" { style.fill: "#dae8fc"; style.stroke-dash: 3 }
        1004: "Existing Data" { style.fill: "#dae8fc" }
        
        0000.label.near: outside-left-center
        0904.label.near: outside-left-center
        1004.label.near: outside-left-center
      }
    }
    ram: {
      block_buf: "RAM block_buf" {
        style.fill: "#fff2cc"
        0000: "?? garbage ??" { style.stroke-dash: 5 }
      }
    }
    disk.block_2500 -> ram.block_buf: "read(fd, buf, 4096)" {
      style.stroke: "#6c8ebf"
      style.animated: true
    }
  }

  step_2: "STEP 2: memcpy(block_buf + 904, src, 100)" {
    shape: package
    ram: {
      block_buf: "RAM block_buf (Modified)" {
        style.fill: "#fff2cc"
        0000: "Existing Data" { style.fill: "#dae8fc" }
        0904: "**NEW PAYLOAD (100B)**" { 
          style.fill: "#f8cecc"
          style.stroke: "#b85450"
          style.stroke-width: 3
          style.font-color: "#b85450"
        }
        1004: "Existing Data" { style.fill: "#dae8fc" }
        
        0000.label.near: outside-left-center
        0904.label.near: outside-left-center
        1004.label.near: outside-left-center
      }
    }
    app_mem: "Application Buffer" {
      shape: cylinder
      data: "100 Bytes"
    }
    app_mem -> ram.block_buf.0904: "memcpy" {
      style.stroke: "#82b366"
      style.stroke-width: 2
    }
  }

  step_3: "STEP 3: write_block(2500, block_buf)" {
    shape: package
    ram: {
      block_buf: "RAM block_buf" {
        0000: "Data"
        0904: "**NEW DATA**" { style.fill: "#f8cecc" }
        1004: "Data"
      }
    }
    disk: {
      block_2500: "Disk Block 2500 (Durable)" {
        style.fill: "#f5f5f5"
        0000: "Existing Data"
        0904: "**MODIFIED BYTES**" { 
          style.fill: "#f8cecc"
          style.stroke: "#b85450"
          style.bold: true 
        }
        1004: "Existing Data"
      }
    }
    ram.block_buf -> disk.block_2500: "write(fd, buf, 4096)" {
      style.stroke: "#b85450"
      style.animated: true
    }
  }
}

rmw_algorithm.step_1 -> rmw_algorithm.step_2 -> rmw_algorithm.step_3

analysis: "Write Amplification Metrics" {
  near: top-right
  stats: ||md
    | Metric | Value |
    | :--- | :--- |
    | **Application Write** | 100 Bytes |
    | **Disk I/O Transfer** | 8,192 Bytes |
    | **Write Amplification** | **81.92x** |
    | **Disk Operations** | 2 (1 Read + 1 Write) |
    | **Efficiency** | 1.22% |
  ||
}

legend: {
  near: bottom-right
  header: "Color Key" {
    existing: "Old Data (Unchanged)" { style.fill: "#dae8fc" }
    modified: "Changed Segment" { style.fill: "#f8cecc" }
    buffer: "Kernel/RAM Buffer" { style.fill: "#fff2cc" }
  }
}

comparison: "Aligned 4KB Write Comparison" {
  near: bottom-left
  note: |md
    ### Optimized Aligned Path
    If `offset=4096` and `len=4096`:
    1. **NO READ** required.
    2. **1 WRITE** operation only.
    3. Amplification = **1.0x**.
  |
}