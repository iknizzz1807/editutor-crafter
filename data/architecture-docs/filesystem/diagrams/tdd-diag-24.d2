direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  # fs_truncate Shrink (new_size=5000)
  **Scenario:** 12KB file (3 blocks) reduced to 5000 bytes.
| {near: top-center}

Before: {
  label: "STATE: BEFORE (12288 bytes)"
  
  Inode: {
    shape: sql_table
    style.fill: "#9B59B6" # Header: Purple
    size: "12288"
    blocks_0: "ptr: 100 (data_A)"
    blocks_1: "ptr: 101 (data_B)"
    blocks_2: "ptr: 102 (data_C)"
  }

  Blocks: {
    direction: right
    B100: "Block 100 (data_A)" {
      style.fill: "#3366FF" # Data: Blue
    }
    B101: "Block 101 (data_B)" {
      style.fill: "#3366FF"
    }
    B102: "Block 102 (data_C)" {
      style.fill: "#3366FF"
    }
  }
}

After: {
  label: "STATE: AFTER (5000 bytes)"
  
  Inode: {
    shape: sql_table
    style.fill: "#9B59B6" # Header: Purple
    size: "**5000**" {style.font-color: red}
    blocks_0: "ptr: 100 (data_A)"
    blocks_1: "ptr: 101 (data_B)"
    blocks_2: "**0 (NULL)**" {style.font-color: red}
  }

  Blocks: {
    direction: right
    B100: "Block 100 (data_A)" {
      style.fill: "#3366FF"
    }
    B101: {
      grid-columns: 2
      grid-gap: 0
      data: "Data (0-903)" {
        style.fill: "#3366FF"
        width: 100
      }
      zeroed: "Zeroed (904-4095)" {
        style.fill: "#BDC3C7" # Padding/Zeroed: Gray
        style.stroke-dash: 2
        width: 300
      }
    }
    B102: "Block 102 (FREE)" {
      style.fill: "#2ECC71" # Free: Green
      style.stroke-dash: 5
    }
  }
}

Steps: {
  near: bottom-center
  1: "**Step 1: Partial Block Zeroing**\nRead Block 101, memset offset 904..4095 to 0, Write back." {
    style.stroke: orange
  }
  2: "**Step 2: Reclamation**\nCall free_block(102), clear bitmap bit, set blocks[2]=0." {
    style.stroke: orange
  }
  3: "**Step 3: Metadata Commit**\nUpdate i_size to 5000 and i_mtime/i_ctime." {
    style.stroke: orange
  }
}

# Connections showing movement/logic
Before.Inode.blocks_1 -> After.Blocks.B101: "1. RMW Cycle" {
  style: {
    stroke: orange
    stroke-width: 4
    animated: true
  }
}

Before.Inode.blocks_2 -> After.Blocks.B102: "2. Free Block" {
  style: {
    stroke: "#2ECC71"
    stroke-width: 4
    stroke-dash: 3
  }
}

# Fix: Connect to the block container
After.Blocks.B101 -> Steps.1: {style.stroke: gray}

# Security Annotation
# Fix: In 'elk', 'near' must be a constant (top-left, bottom-right, etc.)
SecurityNote: |md
  ### SECURITY ALERT
  **Missing Step 1** leaks previous file data if 
  the file is extended again without writing.
| {
  near: bottom-right
  style: {
    fill: "#FFCCCC"
    stroke: red
  }
}