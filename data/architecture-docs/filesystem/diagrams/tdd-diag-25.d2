layout-engine: elk
direction: right
vars: {
  d2-config: {
    theme-id: 4
  }
}

classes: {
  inode_header: {
    style: {
      fill: "#f3e5f5" # Purple: Header
      stroke: "#7b1fa2"
      stroke-width: 2
      stroke-dash: 5 # Cache Line Boundary (64B)
    }
  }
  data_block: {
    style: {
      fill: "#e3f2fd" # Blue: Data
      stroke: "#1976d2"
    }
  }
  pointer_field: {
    style: {
      fill: "#fff3e0" # Orange: Pointers
      stroke: "#ef6c00"
    }
  }
  free_pool_style: {
    style: {
      fill: "#e8f5e9" # Green: Free
      stroke: "#2e7d32"
    }
  }
  padding_field: {
    style: {
      fill: "#eeeeee" # Gray: Padding
    }
  }
  changed: {
    style: {
      font-color: "#d32f2f" # Red: Changed
      bold: true
      stroke: "#d32f2f"
      stroke-width: 3
    }
  }
}

title: |md
  # fs_truncate: Recursive Indirect Block Cleanup
  **Scenario:** 5MB File (Single-Indirect) → 10KB (Direct Range)
  *sizeof=64 bytes (one cache line)*
| {near: top-center}

# --- STATE: BEFORE ---
Before: {
  label: "1. State BEFORE Truncate (5MB)"
  
  inode: {
    shape: sql_table
    class: inode_header
    "0x00: mode": "S_IFREG | 0644" {constraint: "4B"}
    "0x04: size": "5,242,880 bytes" {constraint: "4B"}
    "0x08: direct[0..2]": "Block 100, 101, 102" {constraint: "12B"; class: data_block}
    "0x14: direct[3..11]": "Block 103...111" {constraint: "36B"; class: data_block}
    "0x38: indirect": "Block 500" {constraint: "4B"; class: pointer_field}
    "0x3C: padding": "0x00000000" {constraint: "4B"; class: padding_field}
  }

  indirect_block: {
    shape: sql_table
    class: pointer_field
    label: "Disk Block 500 (Metadata)"
    "ptr[0]": "Block 1000" {class: data_block}
    "ptr[1]": "Block 1001" {class: data_block}
    "ptr[...]": "..."
    "ptr[1023]": "Block 2023" {class: data_block}
  }

  inode."0x38: indirect" -> indirect_block: "references" {
    style: {
      stroke: "#ef6c00"
      stroke-dash: 3
    }
  }
}

# --- ALGORITHM STEPS ---
# Wrapped grid in a standard container to fix 'near' positioning error
StepContainer: {
  style.stroke-width: 0
  style.fill: transparent
  
  AlgorithmSteps: {
    label: "TRUNCATE LOGIC (tdd_fs.c)"
    grid-rows: 6
    style: {
      fill: "#ffffff"
      stroke: "#333333"
      stroke-width: 2
    }

    s1: "1. Free Direct Blocks 3-11" {class: changed}
    s2: "2. Load Block 500 (Indirect) into RAM"
    s3: "3. Iterate 1024 ptrs: free_block(p[i])" {class: changed}
    s4: "4. free_block(500) // RECLAIM METADATA" {
      style.fill: "#ffcdd2"
      class: changed
    }
    s5: "5. Set inode.indirect = 0" {class: changed}
    s6: "6. Update inode.size = 10240" {class: changed}
  }

  Algorithm_Warning: {
    label: |md
      ### ⚠️ CRITICAL
      Failing **Step 4** causes
      metadata leak (4KB).
    |
    style: {
      fill: "#fff9c4"
      stroke: "#fbc02d"
    }
  }
}

# --- STATE: AFTER ---
After: {
  label: "2. State AFTER Truncate (10KB)"

  inode: {
    shape: sql_table
    class: inode_header
    "0x00: mode": "S_IFREG | 0644" {constraint: "4B"}
    "0x04: size": "**10,240 bytes**" {constraint: "4B"; class: changed}
    "0x08: direct[0..2]": "Block 100, 101, 102" {constraint: "12B"; class: data_block}
    "0x14: direct[3..11]": "**0 (NULL)**" {constraint: "36B"; class: changed}
    "0x38: indirect": "**0 (NULL)**" {constraint: "4B"; class: changed}
    "0x3C: padding": "0x00000000" {constraint: "4B"; class: padding_field}
  }

  free_pool: {
    shape: cylinder
    class: [free_pool_style; changed]
    label: |md
      ### Block Bitmap (Free)
      **Reclaimed:**
      - Blocks 103-111
      - Blocks 1000-2023
      - **Block 500 (Metadata)**
    |
  }
}

# --- TRANSITIONS ---
Before.indirect_block -> StepContainer.AlgorithmSteps.s2: "brelse()"
StepContainer.AlgorithmSteps.s4 -> After.free_pool: "bit_set()"
StepContainer.AlgorithmSteps.s5 -> After.inode."0x38: indirect": "i_write()"
StepContainer.AlgorithmSteps.s6 -> After.inode."0x04: size": "i_write()"