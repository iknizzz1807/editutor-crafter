layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

fs_create_file_sequence: {
  shape: sequence_diagram

  # Participants with exact types
  caller: User Process
  fs: "fs_create_file(uint32_t, char*)"
  lookup: "dir_lookup(uint32_t, char*)"
  alloc: "alloc_inode(int, sb_t*)"
  init: "inode_init_file(inode_t*)"
  table: "write_inode(uint32_t, inode_t*)"
  dirent: "dir_add_entry(uint32_t, char*, uint32_t)"
  disk: "Block Device (4KB)"

  caller -> fs: "fs_create_file(parent_ino=1, name=\"hello.c\")"
  fs."POSIX create() path"

  # Step 1: Uniqueness Check
  fs -> lookup: "dir_lookup(parent_ino=1, name=\"hello.c\")"
  lookup -> fs: "return 0 (ENOENT)"

  # Step 2: Allocation
  fs -> alloc: "alloc_inode()"
  alloc -> disk: "read_block(1) - Read Inode Bitmap"
  alloc -> disk: "write_block(1, bmap) - Mark Bit N Used"
  alloc -> fs: "return new_ino=42"

  # Step 3: Initialization
  fs -> init: "inode_init_file(&inode)"
  init."Set mode=S_IFREG, nlinks=1, size=0"

  # Step 4: Inode Persistence (First Write)
  fs -> table: "write_inode(42, &inode)"
  table -> disk: "write_block(3, buf) - Write Inode Table Block" {
    style.stroke: "#ffa500"
  }

  # Note attached to fs participant
  fs: |md
    ### CRASH ZONE A: Orphaned Inode
    If power fails here:
    - Inode 42 is marked **Used** in bitmap.
    - Inode 42 contains **Valid Metadata** in table.
    - **BUT:** No directory entry points to it.
    - Result: **Leaked Inode** (Recoverable by fsck).
  | {
    style.fill: "#fff4e5"
  }

  # Step 5: Directory Link (Second Write)
  fs -> dirent: "dir_add_entry(1, \"hello.c\", 42)"
  dirent -> disk: "write_block(data_blk, buf) - Update Parent Data" {
    style.stroke: "#0000ff"
  }
  dirent -> disk: "write_block(3, parent_buf) - Update Parent ctime"
  dirent -> fs: "return 0 (Success)"

  # FINAL PERSISTENCE
  fs -> disk: "write_block(0, sb_buf) - Update sb.free_inodes"

  # Note attached to dirent participant
  dirent: |md
    ### CRASH ZONE B: Consistent
    If power fails here:
    - Path resolution finds "hello.c" -> Inode 42.
    - Filesystem is logically consistent.
  | {
    style.fill: "#e5fff4"
  }

  fs -> caller: "return 42"

  # Error Handling Path (Rollback Fragment)
  error_handling: ROLLBACK ON FAILURE {
    style.stroke-dash: 5

    fs -> alloc: "bitmap_clear(42) - Undo on dir_add_entry error"
    alloc -> disk: "write_block(1, bmap)"
  }
}

# Diagram Annotations - Fixed for ELK engine compatibility
legend: {
  near: bottom-center
  metadata: |md
    ## Safe Write Ordering Protocol
    1. **Bitmap First**: Prevent double-allocation.
    2. **Inode Table Second**: Ensure metadata exists.
    3. **Directory Entry Last**: Only reveal file when valid.
    
    **Invariants:**
    - `sizeof(inode_t)` = 128 bytes
    - `parent.i_nlinks` remains same (only child dirs increment parent links)
  |
}