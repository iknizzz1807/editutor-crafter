direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# FUSE Callbacks to Internal Operations Mapping Table
# Purpose: Translation of VFS path-based requests to Inode-based data plane
mapping_table: {
  grid-columns: 4
  grid-gap: 0

  # Header Row
  header_callback: "FUSE Callback Interface" {
    style: {
      fill: "#6a0dad" # Header=Purple
      font-color: white
      bold: true
    }
  }
  header_locking: "Concurrency Control" {
    style: {
      fill: "#6a0dad"
      font-color: white
      bold: true
    }
  }
  header_translation: "Path/Translation Layer" {
    style: {
      fill: "#6a0dad"
      font-color: white
      bold: true
    }
  }
  header_internal: "Internal FS Core Operations" {
    style: {
      fill: "#6a0dad"
      font-color: white
      bold: true
    }
  }

  # getattr Row
  getattr_c: "getattr(path, stat)"
  getattr_l: "fs_lock() ▼ ... fs_unlock() ▲"
  getattr_t: "resolve_path(path) → ino"
  getattr_i: "read_inode(ino) + inode_to_stat()"

  # readdir Row
  readdir_c: "readdir(path, filler)"
  readdir_l: "fs_lock() ▼ ... fs_unlock() ▲"
  readdir_t: "resolve_path(path) → ino"
  readdir_i: "dir_readdir(ino) → filler(name, stat)"

  # open Row
  open_c: "open(path, flags)"
  open_l: "fs_lock() ▼ ... fs_unlock() ▲"
  open_t: "resolve_path(path) → ino"
  open_i: |md
    1. `read_inode(ino)`
    2. `if O_TRUNC: fs_truncate(ino, 0)`
    3. **`fi->fh = ino`** (Cache)
  |

  # create Row
  create_c: "create(path, mode)"
  create_l: "fs_lock() ▼ ... fs_unlock() ▲"
  create_t: "split_path(path) → parent, name\nresolve_path(parent) → p_ino"
  create_i: |md
    1. `fs_create_file(p_ino, name, mode)`
    2. `fi->fh = new_ino`
  |

  # read Row
  read_c: "read(path, size, offset)"
  read_l: "fs_lock() ▼ ... fs_unlock() ▲"
  read_t: "**`ino = (uint32_t)fi->fh`**"
  read_i: "fs_read(ino, offset, buf, size)"

  # write Row
  write_c: "write(path, size, offset)"
  write_l: "fs_lock() ▼ ... fs_unlock() ▲"
  write_t: "**`ino = (uint32_t)fi->fh`**"
  write_i: "fs_write(ino, offset, buf, size)"

  # mkdir Row
  mkdir_c: "mkdir(path, mode)"
  mkdir_l: "fs_lock() ▼ ... fs_unlock() ▲"
  mkdir_t: "split_path(path) → parent, name\nresolve_path(parent) → p_ino"
  mkdir_i: "fs_mkdir(p_ino, name, mode)"

  # rmdir Row
  rmdir_c: "rmdir(path)"
  rmdir_l: "fs_lock() ▼ ... fs_unlock() ▲"
  rmdir_t: "split_path(path) → parent, name\nresolve_path(parent) → p_ino"
  rmdir_i: "fs_rmdir(p_ino, name)"

  # unlink Row
  unlink_c: "unlink(path)"
  unlink_l: "fs_lock() ▼ ... fs_unlock() ▲"
  unlink_t: "split_path(path) → parent, name\nresolve_path(parent) → p_ino"
  unlink_i: "fs_unlink(p_ino, name)"

  # rename Row
  rename_c: "rename(old, new)"
  rename_l: "fs_lock() ▼ ... fs_unlock() ▲"
  rename_t: |md
    `split_path` x2
    `resolve_path` (parents) x2
  |
  rename_i: |md
    1. `dir_add_entry(new_p, new_name, src_ino)`
    2. `dir_remove_entry(old_p, old_name)`
  |

  # truncate Row
  truncate_c: "truncate(path, size)"
  truncate_l: "fs_lock() ▼ ... fs_unlock() ▲"
  truncate_t: "if fi: fi->fh else: resolve_path(path)"
  truncate_i: "fs_truncate(ino, size)"

  # Styling for table appearance
  ** {
    style: {
      stroke: "#cbd6e0"
      border-radius: 0
    }
  }
}

# Global Data styling (Blue) for cell content
mapping_table.*_c, mapping_table.*_l, mapping_table.*_t, mapping_table.*_i: {
  style.fill: "#e3f2fd" # Data=Blue
  style.font-size: 13
}

# Header Label and metadata
mapping_table.label: "FUSE High-Level Callback to Low-Level Operation Vector (sizeof=44 entries)"

legend: {
  near: bottom-center
  l1: "▼ Lock Acquire" { shape: text; style.font-color: "#ed800c" }
  l2: "▲ Lock Release" { shape: text; style.font-color: "#ed800c" }
  l3: "fh = file handle cache" { shape: text; style.font-color: "#3f87a6" }
}

# Apply row alternating fills for clarity
mapping_table.getattr_c.style.fill: "#f8f9fa"
mapping_table.getattr_l.style.fill: "#f8f9fa"
mapping_table.getattr_t.style.fill: "#f8f9fa"
mapping_table.getattr_i.style.fill: "#f8f9fa"

mapping_table.open_c.style.fill: "#f8f9fa"
mapping_table.open_l.style.fill: "#f8f9fa"
mapping_table.open_t.style.fill: "#f8f9fa"
mapping_table.open_i.style.fill: "#f8f9fa"

mapping_table.read_c.style.fill: "#f8f9fa"
mapping_table.read_l.style.fill: "#f8f9fa"
mapping_table.read_t.style.fill: "#f8f9fa"
mapping_table.read_i.style.fill: "#f8f9fa"

mapping_table.mkdir_c.style.fill: "#f8f9fa"
mapping_table.mkdir_l.style.fill: "#f8f9fa"
mapping_table.mkdir_t.style.fill: "#f8f9fa"
mapping_table.mkdir_i.style.fill: "#f8f9fa"

mapping_table.unlink_c.style.fill: "#f8f9fa"
mapping_table.unlink_l.style.fill: "#f8f9fa"
mapping_table.unlink_t.style.fill: "#f8f9fa"
mapping_table.unlink_i.style.fill: "#f8f9fa"

mapping_table.truncate_c.style.fill: "#f8f9fa"
mapping_table.truncate_l.style.fill: "#f8f9fa"
mapping_table.truncate_t.style.fill: "#f8f9fa"
mapping_table.truncate_i.style.fill: "#f8f9fa"