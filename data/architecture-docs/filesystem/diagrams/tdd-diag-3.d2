direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

superblock_mem_layout: {
  shape: package
  label: "Superblock Structure (superblock_t)\nsizeof = 4096 bytes (1 block)"

  # Column Headers
  headers: {
    grid-columns: 3
    grid-gap: 20
    style.stroke-width: 0
    style.fill: transparent

    off: "Offset" { style.font-color: "#666666"; style.italic: true }
    fld: "Field [__attribute__((packed))]" { style.bold: true }
    sz: "Size" { style.font-color: "#666666"; style.italic: true }
  }

  # Field Stack
  fields: {
    grid-columns: 3
    grid-gap: 0
    
    # --- HEADER GROUP (Purple) ---
    m_off: "0x00" { style.font: mono }
    magic: "magic : uint32_t" { 
      style: {
        fill: "#E1BEE7"
        stroke: "#9C27B0"
      }
    }
    m_sz: "4B"

    v_off: "0x04" { style.font: mono }
    version: "version : uint32_t" { 
      style: {
        fill: "#E1BEE7"
        stroke: "#9C27B0"
      }
    }
    v_sz: "4B"

    bs_off: "0x08" { style.font: mono }
    block_size: "block_size : uint32_t" { 
      style: {
        fill: "#E1BEE7"
        stroke: "#9C27B0"
      }
    }
    bs_sz: "4B"

    # --- DATA GROUP (Blue) ---
    tb_off: "0x0C" { style.font: mono }
    total_blocks: "total_blocks : uint32_t" { 
      style: {
        fill: "#BBDEFB"
        stroke: "#2196F3"
      }
    }
    tb_sz: "4B"

    ti_off: "0x10" { style.font: mono }
    total_inodes: "total_inodes : uint32_t" { 
      style: {
        fill: "#BBDEFB"
        stroke: "#2196F3"
      }
    }
    ti_sz: "4B"

    fb_off: "0x14" { style.font: mono }
    free_blocks: "free_blocks : uint32_t" { 
      style: {
        fill: "#BBDEFB"
        stroke: "#2196F3"
      }
    }
    fb_sz: "4B"

    fi_off: "0x18" { style.font: mono }
    free_inodes: "free_inodes : uint32_t" { 
      style: {
        fill: "#BBDEFB"
        stroke: "#2196F3"
      }
    }
    fi_sz: "4B"

    # --- POINTER/LAYOUT GROUP (Orange) ---
    its_off: "0x1C" { style.font: mono }
    inode_table_start: "inode_table_start : uint32_t" { 
      style: {
        fill: "#FFE0B2"
        stroke: "#FB8C00"
      }
    }
    its_sz: "4B"

    itb_off: "0x20" { style.font: mono }
    inode_table_blocks: "inode_table_blocks : uint32_t" { 
      style: {
        fill: "#FFE0B2"
        stroke: "#FB8C00"
      }
    }
    itb_sz: "4B"

    js_off: "0x24" { style.font: mono }
    journal_start: "journal_start : uint32_t" { 
      style: {
        fill: "#FFE0B2"
        stroke: "#FB8C00"
      }
    }
    js_sz: "4B"

    jb_off: "0x28" { style.font: mono }
    journal_blocks: "journal_blocks : uint32_t" { 
      style: {
        fill: "#FFE0B2"
        stroke: "#FB8C00"
      }
    }
    jb_sz: "4B"

    dbs_off: "0x2C" { style.font: mono }
    data_block_start: "data_block_start : uint32_t" { 
      style: {
        fill: "#FFE0B2"
        stroke: "#FB8C00"
      }
    }
    dbs_sz: "4B"

    ri_off: "0x30" { style.font: mono }
    root_inode: "root_inode : uint32_t" { 
      style: {
        fill: "#FFE0B2"
        stroke: "#FB8C00"
      }
    }
    ri_sz: "4B"

    # --- PADDING (Gray) ---
    res_off: "0x34" { style.font: mono }
    reserved: "reserved[4044] : uint8_t" { 
      style: {
        fill: "#F5F5F5"
        stroke: "#9E9E9E"
        stroke-dash: 2
      }
      height: 100
    }
    res_sz: "4044B"
  }
}

annotations: {
  near: bottom-center
  label: |md
    ### Memory Layout Invariants
    - `_Static_assert(sizeof(superblock_t) == 4096)`
    - `__attribute__((packed))` ensures 0 padding between uint32_t fields.
    - Little-endian byte order for all multi-byte fields.
    - Block 0 reserved exclusively for this structure.
    - Total blocks addressable: $2^{32}$.
  |
}