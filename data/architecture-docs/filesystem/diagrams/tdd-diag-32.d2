direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

journal_layout: "Journal Region On-Disk Layout â€” Circular Buffer" {
  style: {
    stroke-width: 2
    fill: white
  }

  # 1. Superblock (Memory Layout)
  # Colors: Header=Purple (#e1d5e7), Padding=Gray (#f5f5f5)
  journal_super: "Block 0: Journal Superblock (journal_super_t)" {
    shape: sql_table
    style.fill: "#e1d5e7" 
    
    "0x00": "j_magic: uint32_t (0x4A4F5552)" {constraint: "4B"}
    "0x04": "j_block_type: uint32_t (0x01)" {constraint: "4B"}
    "0x08": "j_sequence: uint32_t (5)" {constraint: "4B"}
    "0x0C": "j_head: uint32_t (5)" {constraint: "4B"}
    "0x10": "j_tail: uint32_t (13)" {constraint: "4B"}
    "0x14": "j_total_blocks: uint32_t (N)" {constraint: "4B"}
    "0x18": "j_reserved: uint8_t[4072]" {constraint: "4072B"}
    
    superblock_size: "sizeof=4096 bytes (1 Disk Block)" {
      shape: text
      near: bottom-center
    }
  }

  # 2. Circular Buffer Logic
  # Colors: Data=Blue (#dae8fc), Free=Green (#d5e8d4), Padding/Stale=Gray (#f5f5f5)
  buffer_logic: "Circular Data Buffer (Offsets 1 to N)" {
    grid-columns: 8
    grid-gap: 15
    
    # Stale Area (Checkpointed/Gray)
    stale_0: "Offset 1\n(Stale)" { style.fill: "#f5f5f5"; style.stroke-dash: 3 }
    stale_1: "Offset 2\n(Stale)" { style.fill: "#f5f5f5"; style.stroke-dash: 3 }
    stale_2: "Offset 3\n(Stale)" { style.fill: "#f5f5f5"; style.stroke-dash: 3 }
    stale_3: "Offset 4\n(Stale)" { style.fill: "#f5f5f5"; style.stroke-dash: 3 }

    # Active Transactions (Blue Data)
    txn1_desc: "Offset 5\n[DESC|seq=3]" { style.fill: "#dae8fc"; style.stroke-width: 4 }
    txn1_data_a: "Offset 6\n[DATA_A]" { style.fill: "#dae8fc" }
    txn1_data_b: "Offset 7\n[DATA_B]" { style.fill: "#dae8fc" }
    txn1_commit: "Offset 8\n[COMMIT|seq=3]" { style.fill: "#dae8fc"; style.stroke-width: 4 }

    txn2_desc: "Offset 9\n[DESC|seq=4]" { style.fill: "#dae8fc"; style.stroke-width: 4 }
    txn2_data_c: "Offset 10\n[DATA_C]" { style.fill: "#dae8fc" }
    txn2_data_d: "Offset 11\n[DATA_D]" { style.fill: "#dae8fc" }
    txn2_commit: "Offset 12\n[COMMIT|seq=4]" { style.fill: "#dae8fc"; style.stroke-width: 4 }

    # Free Space (Green)
    next_free: "Offset 13\n(Free)" { style.fill: "#d5e8d4" }
    free_n: "Offset ...\n(Free)" { style.fill: "#d5e8d4" }
    free_end: "Offset N\n(Free)" { style.fill: "#d5e8d4" }
  }
}

# 3. Pointers (Orange)
# Logical pointers from header fields to data segments
journal_layout.journal_super."0x0C" -> journal_layout.buffer_logic.txn1_desc: "j_head (Replay Start)" {
  style: {
    stroke: "#ff9900"
    stroke-width: 4
    animated: true
  }
}

journal_layout.journal_super."0x10" -> journal_layout.buffer_logic.next_free: "j_tail (Allocation End)" {
  style: {
    stroke: "#ff9900"
    stroke-width: 4
    animated: true
  }
}

# Wrap-Around Visualization
journal_layout.buffer_logic.free_end -> journal_layout.buffer_logic.stale_0: "Circular Wrap" {
  style: {
    stroke: gray
    stroke-dash: 5
  }
}

# Checkpoint indicator - corrected near target to parent container to avoid grid cell restriction
checkpoint_label: "Checkpoint Boundary (j_head-1)" {
  shape: text
  style.font-color: gray
  near: journal_layout.buffer_logic
}

legend: "Legend & State Invariants" {
  near: bottom-right
  l1: "Purple: Journal Superblock (Block 0)" { shape: text }
  l2: "Blue: Logged Data / Metadata Blocks" { shape: text }
  l3: "Green: Free Space for New Transactions" { shape: text }
  l4: "Gray: Stale Blocks (Safe to Overwrite)" { shape: text }
  l5: "Orange: Dynamic Head/Tail Pointers" { shape: text }
  
  invariant: "INVARIANT: j_tail must not overtake j_head (Journal Full)" { 
    shape: text
    style.font-color: red
    style.bold: true
  }
}

recovery_annotation: |md
  ### Journal Recovery Logic
  - **Checkpointed**: Blocks in range `[1, j_head)` are already flushed to their home locations.
  - **Dirty**: Blocks in range `[j_head, j_tail)` must be replayed on mount if `j_sequence` is inconsistent.
  - **Block Padding**: Every record is aligned to 4096B disk block boundaries.
| {
  near: journal_layout
}