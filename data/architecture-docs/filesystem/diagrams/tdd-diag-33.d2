layout-engine: elk
theme-id: 4

# --- Classes for Memory Layout ---
classes: {
  header: {
    style: {
      fill: "#E1BEE7" # Purple
      stroke: "#7B1FA2"
      stroke-width: 2
    }
  }
  metadata: {
    style: {
      fill: "#BBDEFB" # Blue
      stroke: "#1976D2"
      stroke-width: 2
    }
  }
  padding: {
    style: {
      fill: "#F5F5F5" # Gray
      stroke: "#9E9E9E"
      stroke-dash: 2
    }
  }
  array: {
    style: {
      fill: "#C8E6C9" # Greenish-Blue for Arrays
      stroke: "#388E3C"
      stroke-width: 2
    }
  }
  mem_block: {
    grid-columns: 1
    grid-gap: 0
    width: 400
  }
}

# --- Journal Superblock Layout ---
journal_super_t: {
  label: "journal_super_t (4096 Bytes)"
  class: mem_block
  
  m0: "0x00 | j_magic | 4B" { class: header }
  m4: "0x04 | j_block_type (0x01) | 4B" { class: header }
  m8: "0x08 | j_sequence | 4B" { class: metadata }
  m12: "0x0C | j_head | 4B" { class: metadata }
  m16: "0x10 | j_tail | 4B" { class: metadata }
  m20: "0x14 | j_total_blocks | 4B" { class: metadata }
  m24: "0x18 | j_reserved[...] | 4072B" { class: padding }
}

assertion_super: "`_Static_assert(sizeof(journal_super_t) == 4096)`" {
  shape: text
}

# --- Journal Descriptor Layout ---
journal_desc_t: {
  label: "journal_desc_t (4096 Bytes)"
  class: mem_block
  
  d0: "0x00 | j_magic | 4B" { class: header }
  d4: "0x04 | j_block_type (0x02) | 4B" { class: header }
  d8: "0x08 | j_sequence | 4B" { class: metadata }
  d12: "0x0C | j_nr_blocks | 4B" { class: metadata }
  d16: "0x10 | j_blocks[0..509] (uint64_t) | 4080B" { class: array }
}

assertion_desc: "`_Static_assert(sizeof(journal_desc_t) == 4096)`" {
  shape: text
}

# --- Journal Commit Layout ---
journal_commit_t: {
  label: "journal_commit_t (4096 Bytes)"
  class: mem_block
  
  c0: "0x00 | j_magic | 4B" { class: header }
  c4: "0x04 | j_block_type (0x03) | 4B" { class: header }
  c8: "0x08 | j_sequence | 4B" { class: metadata }
  c12: "0x0C | j_checksum | 4B" { class: metadata }
  c16: "0x10 | j_reserved[...] | 4080B" { class: padding }
}

assertion_commit: "`_Static_assert(sizeof(journal_commit_t) == 4096)`" {
  shape: text
}

# --- Vertical Alignment for Integrity ---
journal_super_t -> assertion_super: {style.stroke-width: 0}
journal_desc_t -> assertion_desc: {style.stroke-width: 0}
journal_commit_t -> assertion_commit: {style.stroke-width: 0}

# --- Global Annotations (Root Level) ---
legend: {
  near: top-center
  h: "Header (Magic/Type)" { class: header }
  m: "Metadata (Indices/Seq)" { class: metadata }
  p: "Reserved/Padding" { class: padding }
  a: "Data Mapping Array" { class: array }
}

annotation: |md
  ### Journal Block Invariants
  - **Sequential Access:** All blocks are written sequentially.
  - **Alignment:** Every structure starts on a `4096B` boundary.
  - **Cache Line Awareness:** First 16-24 bytes contain all "Hot" logic fields.
  - **Endianness:** All fields are strictly **Little-Endian**.
| {
  near: bottom-right
  shape: text
}