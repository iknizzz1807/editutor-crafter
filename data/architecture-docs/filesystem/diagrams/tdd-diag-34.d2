layout-engine: elk
theme-id: 4

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

shape: sequence_diagram

fs: Filesystem Layer {
  shape: person
  label: "Filesystem Layer\n(VFS/Ext4)"
}
journal: Journal Manager {
  style.fill: "#e1d5e7"
  label: "Journal Manager\n(JBD2)"
}
block: Block I/O Layer {
  style.fill: "#dae8fc"
  label: "Block I/O Layer\n(BIO/Request)"
}
disk: Persistent Disk {
  shape: cylinder
  style.fill: "#f5f5f5"
  label: "Persistent Disk\n(NVMe/SSD)"
}

# START OF TRANSACTION COMMIT
fs -> journal: "txn_commit(txn_t)"
journal."**Transaction Context:**\n- Modified: Inode Block (B50)\n- Modified: Bitmap Block (B2)\n- Seq: 104"

journal -> block: "1. write_block(j_tail, desc_buf)"
block."JB_TYPE_DESC | nr_blocks=2 | targets=[50, 2]"
block -> disk: "I/O [Journal Region Offset N]"

journal -> block: "2. write_block(j_tail + 1, inode_data)"
block."Copy of Inode Table Block 50"
block -> disk: "I/O [Journal Region Offset N+1]"

journal -> block: "3. write_block(j_tail + 2, bmap_data)"
block."Copy of Bitmap Block 2"
block -> disk: "I/O [Journal Region Offset N+2]"

journal -> block: "4. fsync(fd) ▼" {
  style.stroke: red
  style.stroke-width: 3
}
block -> disk: "[BARRIER 1] Flush volatile caches"
block <- disk: "ACK Durable"
journal <- block: "Success ▲"

DISCARD_PHASE: {
  journal."CRASH SAFETY: DISCARD\nBefore Step 5, the COMMIT record\nis missing. Recovery will ignore\nthis incomplete transaction."
}

journal -> block: "5. write_block(j_tail + 3, commit_buf)"
block."JB_TYPE_COMMIT | seq=104 | checksum=0xAB..."
block -> disk: "I/O [Journal Region Offset N+3]"

journal -> block: "6. fsync(fd) ▼" {
  label: "6. FSYNC #2 — POINT OF NO RETURN"
  style.stroke: red
  style.stroke-width: 4
}
block -> disk: "[BARRIER 2] Commit record durable"
block <- disk: "ACK Durable"
journal <- block: "Success ▲"

REPLAY_PHASE: {
  journal."CRASH SAFETY: REPLAY\nCommit record is durable.\nAny crash after this point \ntriggers REPLAY on mount."
}

# APPLY IN-PLACE
journal -> block: "7. write_block(50, inode_data)"
block."Update Inode Table (Final Location)"
block -> disk: "I/O [Block 50]"

journal -> block: "8. write_block(2, bmap_data)"
block."Update Bitmap Region (Final Location)"
block -> disk: "I/O [Block 2]"

journal -> block: "9. fsync(fd)"
block."Advisory: Ensures in-place data is current"
block -> disk: "Advisory flush"
block <- disk: "ACK"

# UPDATE JOURNAL SUPERBLOCK
journal -> journal: "10. Advance j_tail & Seq++"
journal -> block: "write_block(j_super_start, j_super_buf)"
block."Persist j_head/j_tail to Journal Superblock"
block -> disk: "I/O [Journal Block 0]"

fs <- journal: "txn_commit() -> Success (0)"

# LEGEND / ANNOTATIONS
legend: {
  near: bottom-center
  barrier: Barrier Operation {
    style.stroke: red
    style.stroke-width: 3
  }
  durable: Durability Guaranteed {
    style.fill: "#d5e8d4"
  }
}