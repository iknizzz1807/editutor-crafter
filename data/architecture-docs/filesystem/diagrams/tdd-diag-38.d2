vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  ### Journaling Mode Comparison: 4KB File Write
  **Impact on Write Amplification and Latency**
| {near: top-center}

full_journaling: "FULL JOURNALING (Data + Metadata)" {
  style.stroke: "#6a1b9a"
  style.fill: "#f3e5f5"

  step1: "1. Write Data to Journal" {
    style.font-color: red
    style.bold: true
  }
  step2: "2. Write Inode to Journal" {
    style.font-color: red
    style.bold: true
  }
  step3: "3. Write Bitmap to Journal" {
    style.font-color: red
    style.bold: true
  }
  step4: "4. FSYNC Barrier (Journal Durable)" {
    shape: parallelogram
  }
  step5: "5. Write COMMIT Record" {
    style.font-color: red
    style.bold: true
  }
  step6: "6. FSYNC Barrier (Transaction Committed)" {
    shape: parallelogram
  }
  step7: "7. Write Data to Final Location" {
    style.font-color: red
    style.bold: true
  }
  step8: "8. Write Inode to Inode Table" {
    style.font-color: red
    style.bold: true
  }
  step9: "9. Write Bitmap to Bitmap Region" {
    style.font-color: red
    style.bold: true
  }
  step10: "10. Update Journal Superblock" {
    style.font-color: red
    style.bold: true
  }

  step1 -> step2 -> step3 -> step4 -> step5 -> step6 -> step7 -> step8 -> step9 -> step10

  summary: |md
    **Stats:**
    - Total Block Writes: **8**
    - Barriers: 2 FSYNCs
    - Write Amp: **8.0x**
    - Safety: Maximum
  |
  # Use an invisible connection to anchor summary to bottom within container
  step10 -> summary: { style.stroke-width: 0; target-arrowhead: none }
}

metadata_only: "METADATA-ONLY (Ordered Mode)" {
  style.stroke: "#1565c0"
  style.fill: "#e3f2fd"

  step1: "1. Write Data to Final Location" {
    style.font-color: red
    style.bold: true
  }
  step2: "2. FSYNC Barrier (Data Durable)" {
    shape: parallelogram
  }
  step3: "3. Write Metadata to Journal" {
    style.font-color: red
    style.bold: true
  }
  step4: "4. FSYNC Barrier (Meta Durable)" {
    shape: parallelogram
  }
  step5: "5. Write COMMIT Record" {
    style.font-color: red
    style.bold: true
  }
  step6: "6. FSYNC Barrier (Committed)" {
    shape: parallelogram
  }
  step7: "7. Apply Metadata In-Place" {
    style.font-color: red
    style.bold: true
  }
  step8: "8. Update Journal Superblock" {
    style.font-color: red
    style.bold: true
  }

  step1 -> step2 -> step3 -> step4 -> step5 -> step6 -> step7 -> step8

  summary: |md
    **Stats:**
    - Total Block Writes: **5**
    - Barriers: 3 FSYNCs
    - Write Amp: **1.0x (Data) / 5.0x (Meta)**
    - Safety: Consistent Meta
  |
  # Use an invisible connection to anchor summary to bottom within container
  step8 -> summary: { style.stroke-width: 0; target-arrowhead: none }
}

full_journaling -> metadata_only: "Performance vs Consistency Tradeoff" {
  style.stroke-dash: 5
}

explanation: |md
  ### Performance Analysis
  - **Full Journaling**: Every byte of user data is written twice. SSD wear-leveling endurance is halved. Latency is high due to journal-then-final data copying.
  - **Metadata-Only**: User data is written once directly to the final block. Only tiny metadata blocks (inodes/bitmaps) incur the journaling overhead.
  - **The Race**: Metadata-only requires an extra FSYNC before journaling to ensure data doesn't point to uninitialized blocks after a crash.
| {near: bottom-right}