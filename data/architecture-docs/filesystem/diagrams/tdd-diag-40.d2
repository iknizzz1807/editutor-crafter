direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

WAL_COMPARISON: "WAL Everywhere -- Cross-Domain Structural Identity" {
  style: {
    stroke-width: 4
  }

  FILESYSTEM_JOURNAL: "Filesystem Journal (Local Block-Level)" {
    API: {
      shape: class
      "txn_begin()": void
      "txn_journal_block(blk: uint32, data: byte*)": int
      "txn_commit()": int {tooltip: "Includes 2x fsync barriers"}
      "journal_recover()": int {tooltip: "Replay on mount"}
      "journal_checkpoint()": int
    }

    METADATA: {
      shape: sql_table
      j_sequence: uint32 {label: "Sequence Number"}
      j_head: uint32 {label: "Consumer Pointer"}
      j_tail: uint32 {label: "Producer Pointer"}
      j_checksum: uint32 {label: "Software Sum"}
    }

    ARTIFACT: "journal_commit_t" {
      label: "Commit Block (4096B)"
      style.fill: "#e1d5e7"
    }

    API -> METADATA: "manages"
    API -> ARTIFACT: "writes"
    
    footer: |md
      **sizeof** = 4MB - 128MB (Circular)
    |
  }

  POSTGRES_WAL: "PostgreSQL WAL (Database Page-Level)" {
    API: {
      shape: class
      "XLogInsert(record: XLogRecPtr)": LSN
      "XLogFlush(lsn: LSN)": void {tooltip: "The durability barrier"}
      "recovery()": void {label: "Redo Log Replay"}
      "checkpoint()": void {label: "Flush Dirty Buffers"}
    }

    METADATA: {
      shape: sql_table
      LSN: uint64 {label: "Log Sequence Number"}
      pg_wal: directory {label: "Segment Files"}
      redo_lsn: uint64 {label: "Recovery Start Point"}
      CRC32: uint32 {label: "Hardware CRC"}
    }

    ARTIFACT: "XLOG_RECORD" {
      label: "Checkpoint Record"
      style.fill: "#e1d5e7"
    }

    API -> METADATA: "updates"
    API -> ARTIFACT: "persists"

    footer: |md
      **sizeof** = 16MB per Segment
    |
  }

  RAFT_LOG: "Raft Consensus (Distributed State)" {
    API: {
      shape: class
      "AppendEntries(entries: Log[])": bool
      "LeaderCommit()": uint64 {label: "Quorum Ack"}
      "apply_to_fsm()": void {label: "State Machine Transition"}
      "snapshot()": void {label: "Log Compaction"}
    }

    METADATA: {
      shape: sql_table
      log_index: uint64 {label: "Monotonic Index"}
      term: uint32 {label: "Election Era"}
      commit_index: uint64 {label: "Durable Pointer"}
      hash: uint256 {label: "Merkle/SHA Integrity"}
    }

    ARTIFACT: "SNAPSHOT" {
      label: "State Snapshot"
      style.fill: "#e1d5e7"
    }

    API -> METADATA: "appends"
    API -> ARTIFACT: "compacts to"

    footer: |md
      **sizeof** = Dynamic (Pruned by Snapshot)
    |
  }

  # Structural Analogies
  FILESYSTEM_JOURNAL.METADATA.j_sequence <-> POSTGRES_WAL.METADATA.LSN: "Monotonic Versioning" {style.stroke-dash: 5}
  POSTGRES_WAL.METADATA.LSN <-> RAFT_LOG.METADATA.log_index: "Monotonic Versioning" {style.stroke-dash: 5}

  FILESYSTEM_JOURNAL.API."txn_commit()" <-> POSTGRES_WAL.API."XLogFlush(lsn: LSN)": "Durability Point" {style.stroke-dash: 5}
  POSTGRES_WAL.API."XLogFlush(lsn: LSN)" <-> RAFT_LOG.API."LeaderCommit()": "Durability Point" {style.stroke-dash: 5}

  FILESYSTEM_JOURNAL.API."journal_checkpoint()" <-> POSTGRES_WAL.API."checkpoint()": "Log Reclamation" {style.stroke-dash: 5}
  POSTGRES_WAL.API."checkpoint()" <-> RAFT_LOG.API."snapshot()": "Log Reclamation" {style.stroke-dash: 5}
}