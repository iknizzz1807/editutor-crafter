direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# LEGEND
legend: {
  shape: package
  near: bottom-right
  
  header: "Color Key" {
    shape: text
  }
  sb: "Superblock (Purple)" {
    style: {
      fill: "#d1c4e9"
      stroke: "#5e35b1"
    }
  }
  bmap: "Bitmaps (Orange)" {
    style: {
      fill: "#ffe0b2"
      stroke: "#e65100"
    }
  }
  meta: "Inode Table (Blue)" {
    style: {
      fill: "#bbdefb"
      stroke: "#0d47a1"
    }
  }
  data: "Data Region (Green)" {
    style: {
      fill: "#c8e6c9"
      stroke: "#1b5e20"
    }
  }
}

# STEP 1: RAW IMAGE
step1: "1. Raw Disk Image (Before mkfs)" {
  style: {
    stroke: "#757575"
    stroke-width: 2
  }
  
  blocks: {
    grid-rows: 10
    grid-gap: 0
    
    b0: "Block 0 (4KB): 0x00..."
    b1: "Block 1 (4KB): 0x00..."
    b2: "Block 2 (4KB): 0x00..."
    b3: "Block 3 (4KB): 0x00..."
    b4: "Block 4 (4KB): 0x00..."
    b5: "Block 5 (4KB): 0x00..."
    b6: "Block 6 (4KB): 0x00..."
    b7: "Block 7 (4KB): 0x00..."
    bn: "... All Zeros / Uninitialized ..." {
      style.stroke-dash: 3
    }
  }
}

# STEP 2: FORMATTED IMAGE
step2: "2. Formatted Image (After mkfs)" {
  style: {
    stroke: "#d32f2f"
    stroke-width: 4
  }

  formatted_blocks: {
    grid-rows: 10
    grid-gap: 0

    sb: "Block 0: Superblock" {
      tooltip: |md
      **verify_filesystem() checks:**
      - Magic == 0xDEADC0DE
      - total_blocks matches file size
      - root_inode == 1
      |
      label: "**magic: 0xDEADC0DE**\nversion: 1\nroot_inode: 1"
      style: {
        fill: "#d1c4e9"
        font-color: "#5e35b1"
      }
    }

    bbmap: "Block 1: Block Bitmap" {
      label: "**bits: [1000...]**\n(Data Block 0 Used)"
      style: {
        fill: "#ffe0b2"
        font-color: "#e65100"
      }
    }

    ibmap: "Block 2: Inode Bitmap" {
      label: "**bits: [1000...]**\n(Inode 1 Used)"
      style: {
        fill: "#ffe0b2"
        font-color: "#e65100"
      }
    }

    itable: "Blocks 3-N: Inode Table" {
      label: "**Inode 1 (Root):**\nmode: S_IFDIR\nlinks: 2\nptr[0]: data_start"
      style: {
        fill: "#bbdefb"
        font-color: "#0d47a1"
      }
    }

    journal: "Blocks N+1-M: Journal" {
      label: "Zeroed Region\n(Reserved for M6)"
      style: {
        fill: "#f5f5f5"
        stroke-dash: 5
      }
    }

    dataregion: "Blocks M+1-End: Data Region" {
      label: "**Data Block 0 (Root Dir):**\n'.' -> Inode 1\n'..' -> Inode 1"
      style: {
        fill: "#c8e6c9"
        font-color: "#1b5e20"
      }
    }
    
    free: "Free Data Blocks" {
      label: "All bits 0 in bitmap"
      style: {
        fill: "#ffffff"
        stroke-dash: 2
      }
    }
  }
}

# TRANSITION
step1 -> step2: "mkfs execution" {
  style: {
    stroke: "#d32f2f"
    stroke-width: 4
    animated: true
  }
}

# VERIFICATION CALLOUT
verification: |md
  ### verify_filesystem() invariants:
  1. `read_block(0)` -> Check `magic`
  2. `read_block(sb.inode_table_start)` -> Verify `Inode 1` is `S_IFDIR`
  3. `read_block(sb.inode_bitmap_start)` -> Verify `bit 0` is set
  4. `read_block(inode1.blocks[0])` -> Verify entries `.` and `..` exist
| {
  near: top-right
  style.stroke: "#1976d2"
}