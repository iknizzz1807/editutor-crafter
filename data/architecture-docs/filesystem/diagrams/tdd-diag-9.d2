direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# 1. Memory Layout / Architecture
inode: "inode_t (sizeof=128 bytes)" {
  shape: class
  style.fill: "#9c27b0" # Header: Purple
  
  "0x00: mode": "uint16_t (type+perms)"
  "0x02: nlinks": "uint16_t (refcount)"
  "0x04: size": "uint32_t (bytes)"
  "0x08: atime": "uint32_t (access)"
  "0x0C: mtime": "uint32_t (modify)"
  "0x10: ctime": "uint32_t (change)"
  "0x14: blocks": "uint32_t[12] (direct)"
  "0x44: single_indirect": "uint32_t (ptr)"
  "0x48: double_indirect": "uint32_t (ptr)"
}

direct_addressing: "Region 1: Direct Addressing" {
  capacity: "|'md **Capacity:** 12 blocks (48 KB) '|"
  
  ptr_0: "blocks[0]"
  ptr_1: "blocks[1]"
  ptr_ellipsis: "..."
  ptr_11: "blocks[11]"
  
  ptr_0 -> data_blk_0: "Offset: 0" { style.stroke: orange }
  ptr_1 -> data_blk_1: "Offset: 4KB" { style.stroke: orange }
  ptr_11 -> data_blk_11: "Offset: 44KB" { style.stroke: orange }
}

single_indirect_addressing: "Region 2: Single Indirect" {
  capacity: "|'md **Capacity:** 1024 blocks (+4 MB) '|"
  
  indirect_block: "Indirect Block (4KB)" {
    shape: class
    style.fill: "#2196f3" # Data: Blue
    p0: "uint32_t[0]"
    p1: "uint32_t[1]"
    p_null: "uint32_t[N]" {
      style: {
        fill: "#ff0000"
        font-color: white
      }
    }
    p1023: "uint32_t[1023]"
  }
  
  indirect_block.p0 -> data_blk_12: "Offset: 48KB" { style.stroke: orange }
  indirect_block.p1 -> data_blk_13: "Offset: 52KB" { style.stroke: orange }
  indirect_block.p_null -> hole: "SPARSE HOLE" {
    style: {
      stroke: "#ff0000"
      stroke-dash: 5
    }
  }
  indirect_block.p1023 -> data_blk_1035: "Offset: 4.04MB" { style.stroke: orange }
}

double_indirect_addressing: "Region 3: Double Indirect" {
  capacity: "|'md **Capacity:** 1,048,576 blocks (~4 GB) '|"
  
  outer_block: "Outer Indirect Block (4KB)" {
    shape: class
    style.fill: "#2196f3" # Data: Blue
    op0: "uint32_t[0]"
    op1: "uint32_t[1]"
    op_ellipsis: "..."
    op1023: "uint32_t[1023]"
  }
  
  inner_block_0: "Inner Block 0 (4KB)" {
    shape: class
    style.fill: "#2196f3"
    ip0: "uint32_t[0]"
    ip_ellipsis: "..."
  }
  
  inner_block_1023: "Inner Block 1023 (4KB)" {
    shape: class
    style.fill: "#2196f3"
    ip1023: "uint32_t[1023]"
  }
  
  outer_block.op0 -> inner_block_0 { style.stroke: orange }
  outer_block.op1 -> inner_block_1023: "References" {
    style: {
        stroke: orange
        stroke-dash: 5
    }
  }
  
  inner_block_0.ip0 -> data_blk_1036: "Offset: 4.04MB + 4KB" { style.stroke: orange }
  inner_block_1023.ip1023 -> data_blk_max: "Max Offset: 4.29GB" { style.stroke: orange }
}

# Master Ownership Connections (Solid arrow = owns)
inode -> direct_addressing.ptr_0
inode -> single_indirect_addressing.indirect_block
inode -> double_indirect_addressing.outer_block

# Data Block Legend (Blue)
data_blk_0: "Data Block" {style.fill: "#e1f5fe"}
data_blk_1: "Data Block" {style.fill: "#e1f5fe"}
data_blk_11: "Data Block" {style.fill: "#e1f5fe"}
data_blk_12: "Data Block" {style.fill: "#e1f5fe"}
data_blk_13: "Data Block" {style.fill: "#e1f5fe"}
data_blk_1035: "Data Block" {style.fill: "#e1f5fe"}
data_blk_1036: "Data Block" {style.fill: "#e1f5fe"}
data_blk_max: "Data Block" {style.fill: "#e1f5fe"}

hole: "Logical Zeroes" {
  shape: diamond # Fixed unknown shape 'octagon'
  style: {
    fill: "#eeeeee" # Padding/Free/Null: Gray
    stroke: "#ff0000"
  }
}

legend: {
  near: bottom-center
  
  direct: "Direct: 0 - 48KB" {
    shape: text
    style.font-color: "#0d47a1"
  }
  single: "Single: 48KB - 4MB" {
    shape: text
    style.font-color: "#1b5e20"
  }
  double: "Double: 4MB - 4GB" {
    shape: text
    style.font-color: "#4a148c"
  }
  sparse: "Orange Line = Pointer Ref" {
    shape: text
    style.font-color: orange
  }
}