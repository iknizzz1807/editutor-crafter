title: Client Retry and Backoff Logic {
  near: top-center
  style.font-size: 18
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  container: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  action: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  error: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  success: {
    style.fill: "#00b894"
    style.stroke: "#00cec9"
    style.font-color: "#ffffff"
    style.bold: true
  }
  start: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
  }
}

start: Start {
  shape: circle
  class: start
}

make_request: Make gRPC Request {
  class: action
}

request_result: Request Success? {
  shape: diamond
  class: decision
}

success_end: Return Response {
  class: success
}

error_type: Retryable Error? {
  shape: diamond
  class: decision
}

max_retries: Max Retries Exceeded? {
  shape: diamond
  class: decision
}

backoff_calc: Calculate Backoff Delay {
  class: action
}

wait: Wait (Exponential Backoff) {
  class: action
}

increment_counter: Increment Retry Counter {
  class: action
}

circuit_breaker: Circuit Breaker Open? {
  shape: diamond
  class: decision
}

fail_fast: Fail Fast {
  class: error
}

final_error: Return Final Error {
  class: error
}

retry_details: {
  backoff_formula: |md
    **Exponential Backoff Formula:**
    delay = base_delay Ã— 2^attempt + jitter
    
    **Retryable Errors:**
    - UNAVAILABLE
    - DEADLINE_EXCEEDED
    - RESOURCE_EXHAUSTED
    - ABORTED (sometimes)
  | {
    shape: page
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

start -> make_request
make_request -> request_result

request_result -> success_end: Yes
request_result -> error_type: No

error_type -> final_error: No (InvalidArgument,\nUnauthenticated, etc.)
error_type -> circuit_breaker: Yes (Unavailable,\nDeadlineExceeded, etc.)

circuit_breaker -> fail_fast: Yes
circuit_breaker -> max_retries: No

max_retries -> final_error: Yes
max_retries -> backoff_calc: No

backoff_calc -> wait
wait -> increment_counter
increment_counter -> make_request

backoff_calc -> retry_details: {
  style.stroke-dash: 3
  style.stroke: "#8b949e"
}