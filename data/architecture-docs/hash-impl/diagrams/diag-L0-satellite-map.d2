direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 3
  }
}

# --- Global Classes ---
classes: {
  milestone_box: {
    style: {
      stroke-width: 2
      border-radius: 8
    }
  }
  data_type: {
    shape: parallelogram
    style: {
      fill: "#e1f5fe"
      stroke: "#01579b"
    }
  }
  logic_component: {
    shape: rectangle
    style: {
      fill: "#f5f5f5"
      stroke: "#424242"
    }
  }
}

# --- L0 SATELLITE MAP: SHA-256 PIPELINE ---

input_source: "Input Message\n(Arbitrary Length)" {
  shape: cylinder
  tooltip: "Raw bytes to be hashed"
}

# MILESTONE 1: PREPROCESSING
m1_preprocessing: {
  class: milestone_box
  label: "Milestone 1: Preprocessing & Padding\n(sha256_pad.c)"
  link: "hash-impl-m1"
  direction: down

  padding_logic: {
    shape: class
    label: "Padding Mechanism"
    definition: |md
      c
      1. Append bit '1' (0x80 byte)
      2. Append 'k' zero bits
      3. Append 64-bit bit_length (BE)
      
    |
  }

  pad_func: {
    shape: code
    label: "sha256_pad"
    language: c
    content: "size_t sha256_pad(uint8_t *out, const uint8_t *msg, size_t msg_len);"
  }
}

# MILESTONE 2: MESSAGE SCHEDULE
m2_schedule: {
  class: milestone_box
  label: "Milestone 2: Message Schedule\n(sha256_schedule.c)"
  link: "hash-impl-m2"
  direction: down

  sigma_logic: {
    shape: class
    label: "Schedule Expansion"
    definition: |md
      c
      // Recurrence for t = 16..63
      W[t] = sigma1(W[t-2]) + W[t-7] + 
             sigma0(W[t-15]) + W[t-16];
      
    |
  }

  schedule_struct: {
    shape: sql_table
    label: "uint32_t W[64]"
    row1: "0x00-0x3F | W[0..15]  | Raw Words (BE)"
    row2: "0x40-0xFF | W[16..63] | Expanded Words"
    label_bottom: "Total: 256 bytes"
  }
}

# MILESTONE 3: COMPRESSION
m3_compression: {
  class: milestone_box
  label: "Milestone 3: Compression Function\n(sha256_compress.c)"
  link: "hash-impl-m3"
  direction: down

  round_logic: {
    shape: class
    label: "64-Round Transformation"
    definition: |md
      c
      T1 = h + Sigma1(e) + Ch(e,f,g) + K[t] + W[t];
      T2 = Sigma0(a) + Maj(a,b,c);
      // Shift variables a..h
      
    |
  }

  k_constants: {
    shape: cylinder
    label: "Round Constants K[64]"
    tooltip: "Fractional parts of cube roots of first 64 primes"
  }
}

# MILESTONE 4: STATE & FINALIZATION
m4_finalization: {
  class: milestone_box
  label: "Milestone 4: Context & Final Output\n(sha256.c)"
  link: "hash-impl-m4"
  direction: down

  sha256_ctx: {
    shape: sql_table
    label: "struct SHA256_CTX"
    row1: "0x00 | uint32_t[8] | H (State)"
    row2: "0x20 | uint8_t[64]  | buf (Partial)"
    row3: "0x60 | size_t      | buf_len"
    row4: "0x68 | uint64_t    | total_len"
    label_bottom: "Total: 112 bytes"
  }

  hex_output: {
    shape: code
    label: "sha256_hex"
    language: c
    content: "void sha256_hex(const uint8_t digest[32], char hex[65]);"
  }
}

final_digest: "256-bit Hash Digest\n(64 Hex Characters)" {
  shape: cylinder
  style: {
    fill: "#c8e6c9"
    stroke: "#2e7d32"
  }
}

# --- Data Flows (Satellite Path) ---

input_source -> m1_preprocessing: "raw bytes | L bits" {
  style: { stroke: "#0288d1"; stroke-width: 2 }
}

m1_preprocessing -> m2_schedule: "512-bit block | uint8_t[64]" {
  style: { stroke: "#0288d1"; stroke-width: 2 }
}

m2_schedule -> m3_compression: "64 words | uint32_t W[64]" {
  style: { stroke: "#0288d1"; stroke-width: 2 }
}

m3_compression -> m4_finalization: "Updated State | H[0..7]" {
  style: { stroke: "#0288d1"; stroke-width: 2 }
}

m4_finalization -> final_digest: "32 bytes | hex string" {
  style: { stroke: "#2e7d32"; stroke-width: 3; animated: true }
}

# Internal feedback for Merkle-DamgÃ¥rd
m4_finalization.sha256_ctx -> m3_compression: "Initial/Running H" {
  style: { stroke: "#7b1fa2"; stroke-dash: 5 }
}

# Legend/Annotations
legend: {
  near: bottom-right
  class: milestone_box
  label: "Pipeline Legend"
  
  blue_flow: "Primary Data Flow" {
    style: { stroke: "#0288d1"; stroke-width: 2 }
  }
  purple_flow: "State Management" {
    style: { stroke: "#7b1fa2"; stroke-dash: 5 }
  }
}