direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# SATELLITE CONTEXT: Milestone 1 - Message Preprocessing
# Implementation of 56-byte message boundary case (2 blocks)

input_stream: {
  label: "Padded Message Buffer (sha256.c)"
  direction: down

  raw_data: {
    shape: sql_table
    label: "Continuous Memory | 128 Bytes"
    
    header: "Offset | Content | Description"
    row0: "0x00..0x37 | uint8_t[56] | Original Message ('abcd...nopq')"
    row1: "0x38 | 0x80 | '1' Bit Separator"
    row2: "0x39..0x3F | uint8_t[7] | Zero Padding (Block 0 Fill)"
    row3: "0x40..0x77 | uint8_t[56] | Zero Padding (Block 1 Start)"
    row4: "0x78..0x7F | uint64_t (BE) | Bit Length (448 bits)"
    
    label_bottom: "Total Size: 1024 bits (2 * 512-bit chunks)"
  }
}

parsing_logic: {
  label: "Block Parser Logic"
  direction: right
  
  slicer: |md
    c
    // sha256_update logic
    while (len >= 64) {
        sha256_compress(ctx->H, (SHA256_Block*)data);
        data += 64;
        len -= 64;
    }
    
  |
}

blocks_layer: {
  label: "512-bit Aligned Blocks"
  direction: down

  block0: {
    shape: sql_table
    label: "struct SHA256_Block 0"
    
    row1: "0x00 | 56 Bytes | Message"
    row2: "0x38 | 0x01 Byte | 0x80"
    row3: "0x39 | 0x07 Bytes | 0x00 Padding"
    
    label_bottom: "64 Bytes (512 bits)"
  }

  block1: {
    shape: sql_table
    label: "struct SHA256_Block 1"
    
    row1: "0x00 | 56 Bytes | 0x00 Padding"
    row2: "0x38 | 0x08 Bytes | Length (0x00..0x01C0)"
    
    label_bottom: "64 Bytes (512 bits)"
  }
}

processing_order: {
  label: "Compression Sequence"
  direction: right
  
  step1: "Initialize H[8] (sqrt primes)"
  step2: "Process Block 0"
  step3: "Process Block 1"
  
  step1 -> step2 -> step3: "Merkle-DamgÃ¥rd Chaining"
}

# Connections
input_stream.raw_data -> parsing_logic.slicer: "Memory Pointer | uint8_t*"
parsing_logic.slicer -> blocks_layer.block0: "Slice 1 | Offset 0x00"
parsing_logic.slicer -> blocks_layer.block1: "Slice 2 | Offset 0x40"

blocks_layer.block0 -> processing_order.step2: "SHA256_Block | 64B"
blocks_layer.block1 -> processing_order.step3: "SHA256_Block | 64B"

# Style annotations
blocks_layer.block0.row2.style.fill: "#DEE1EB" # Purple-ish metadata
blocks_layer.block1.row2.style.fill: "#E4DBFE" # Length field
input_stream.raw_data.row1.style.fill: "#DEE1EB"
input_stream.raw_data.row4.style.fill: "#E4DBFE"