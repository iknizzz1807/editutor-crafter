direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: Big-Endian vs Little-Endian: Length Field Encoding (padding.c) {
  shape: text
  near: top-center
  style: {
    font-size: 18
    bold: true
  }
}

# Source Value
value_source: {
  shape: sql_table
  label: "uint64_t msg_len_bits = 24"
  row: "0x0000000000000018"
}

# The Comparison Container
comparison: {
  direction: right
  
  # WRONG: Little-Endian representation
  le_layout: {
    shape: sql_table
    label: "Little-Endian (Native x86) - WRONG"
    style: {
      stroke: red
      fill: "#ffcccc"
    }
    
    offset0: "0x38 | 0x18 | LSB"
    offset1: "0x39 | 0x00 |"
    offset2: "0x3A | 0x00 |"
    offset3: "0x3B | 0x00 |"
    offset4: "0x3C | 0x00 |"
    offset5: "0x3D | 0x00 |"
    offset6: "0x3E | 0x00 |"
    offset7: "0x3F | 0x00 | MSB"
    
    label_bottom: "Total: 8 bytes (Memory Residue)"
  }

  # CORRECT: Big-Endian representation
  be_layout: {
    shape: sql_table
    label: "Big-Endian (SHA-256 Standard) - CORRECT"
    style: {
      stroke: green
      fill: "#ccffcc"
    }
    
    offset0: "0x38 | 0x00 | MSB"
    offset1: "0x39 | 0x00 |"
    offset2: "0x3A | 0x00 |"
    offset3: "0x3B | 0x00 |"
    offset4: "0x3C | 0x00 |"
    offset5: "0x3D | 0x00 |"
    offset6: "0x3E | 0x00 |"
    offset7: "0x3F | 0x18 | LSB"
    
    label_bottom: "Total: 8 bytes (Big-Endian Aligned)"
  }
}

# Transformation Logic
logic_block: {
  label: "Explicit Byte-Swap Logic (padding.c)"
  implementation: |md
    c
    // Portable Big-Endian Write
    void write_u64_be(uint8_t *dst, uint64_t val) {
        dst[0] = (uint8_t)(val >> 56);
        dst[1] = (uint8_t)(val >> 48);
        dst[2] = (uint8_t)(val >> 40);
        dst[3] = (uint8_t)(val >> 32);
        dst[4] = (uint8_t)(val >> 24);
        dst[5] = (uint8_t)(val >> 16);
        dst[6] = (uint8_t)(val >> 8);
        dst[7] = (uint8_t)(val >> 0);
    }
    
  |
}

# Data Flow
value_source -> comparison.le_layout: "Direct memory cast | 8 bytes"
comparison.le_layout -> logic_block: "Requires reordering"
logic_block -> comparison.be_layout: "Resulting buffer | uint8_t[8]"

# Legend
legend: {
  near: bottom-right
  msb: "MSB: Most Significant Byte" {
    style: { stroke-dash: 2; fill: transparent }
  }
  lsb: "LSB: Least Significant Byte" {
    style: { stroke-dash: 2; fill: transparent }
  }
}