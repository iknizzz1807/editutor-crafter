direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- LAYERS ---

input_layer: {
  label: "INPUT SPECIFICATION"
  direction: down

  msg_meta: {
    shape: sql_table
    label: "Message Metadata (sha256_pad.h)"
    row1: "L | uint64_t | bit_length"
    row2: "msg_len | size_t | byte_length"
    label_bottom: "Total Bits: L = msg_len * 8"
  }

  signatures: |md
    c
    size_t sha256_padded_length(size_t msg_len);
    size_t sha256_pad(uint8_t *out, const uint8_t *msg, size_t msg_len);
    
  |
}

logic_layer: {
  label: "PADDDING DECISION LOGIC"
  direction: down

  boundary_check: {
    shape: diamond
    label: "Is (L + 1 + 64) <= 512?"
    tooltip: "Message + '1' bit + 64-bit length field fits in 64 bytes?"
  }

  formula_box: {
    label: "Zero Padding Formula (NIST FIPS 180-4)"
    direction: right
    
    computation: |md
      c
      // k = smallest non-negative integer
      k = (447 - L) % 512;
      
    |
    
    pitfall: "CRITICAL: Use 447, not 448." {
      style: {
        fill: "#ffcccc"
        stroke: red
        bold: true
      }
      tooltip: "512 (block) - 64 (length) - 1 (separator bit) = 447 bits available for message."
    }
  }

  boundary_check -> formula_box: "True: 1 Block" {
    style: { stroke: green; stroke-width: 2 }
  }
  boundary_check -> formula_box: "False: 2 Blocks" {
    style: { stroke: blue; stroke-width: 2 }
  }
}

output_layer: {
  label: "MEMORY LAYOUT (L2)"
  direction: down

  single_block: {
    shape: sql_table
    label: "Case: L <= 440 bits (55 bytes)"
    
    row1: "0x00 | Message Content | L bits"
    row2: "0x?? | 0x80 (1000 0000) | 8 bits (1 + 7 zeros)"
    row3: "0x?? | Zero Padding (k-7) | k-7 bits"
    row4: "0x38 | Msg Bit Length (L) | 64 bits (Big-Endian)"
    label_bottom: "Total: 64 bytes (1 Block)"
  }

  dual_block: {
    direction: right
    
    block_1: {
      shape: sql_table
      label: "Block 1 (L >= 56 bytes)"
      row1: "0x00 | Message Content | L bits"
      row2: "0x?? | 0x80 Marker | 8 bits"
      row3: "0x?? | Zero Padding | To 512 bits"
    }

    block_2: {
      shape: sql_table
      label: "Block 2"
      row1: "0x00 | Zero Padding | 448 bits"
      row2: "0x38 | Msg Bit Length (L) | 64 bits"
      label_bottom: "Total: 128 bytes (2 Blocks)"
    }
    
    block_1 -> block_2: "Contiguous Memory"
  }
}

# --- DATA FLOW ---

input_layer.msg_meta -> logic_layer.boundary_check: "L bits | 64-bit uint | {L: 448}"

logic_layer.formula_box -> output_layer.single_block: "if L <= 440" {
  style.stroke-dash: 3
}

logic_layer.formula_box -> output_layer.dual_block: "if L > 440" {
  style.stroke-dash: 3
}

# Annotations
logic_layer.boundary_check.tooltip: "Byte-wise equivalent: (msg_len + 1 + 8) > 64"

# Global Styles
***.style.font: mono
(input_layer -> logic_layer): "State Transfer"
(logic_layer -> output_layer): "Resulting Allocation"