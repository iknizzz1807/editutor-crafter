direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# -----------------------------------------------------------------------------
# Global Classes for Semantic Coloring
# -----------------------------------------------------------------------------
classes: {
  msg_layer: {
    style: {
      fill: "#D0E1F9" # Light Blue
      stroke: "#4A90E2"
    }
  }
  separator_layer: {
    style: {
      fill: "#FADBD8" # Light Red
      stroke: "#E74C3C"
    }
  }
  padding_layer: {
    style: {
      fill: "#EBEDEF" # Light Gray
      stroke: "#ABB2B9"
    }
  }
  length_layer: {
    style: {
      fill: "#D5F5E3" # Light Green
      stroke: "#27AE60"
    }
  }
  header_text: {
    style: {
      font-size: 18
      bold: true
    }
  }
}

# -----------------------------------------------------------------------------
# Case 1: Short Message 'abc' (3 bytes)
# -----------------------------------------------------------------------------
case_1: {
  label: "CASE 1: Message 'abc' (3 bytes)"
  class: header_text
  direction: down

  block: {
    shape: sql_table
    label: "Padded Block (64 Bytes / 512 Bits)"
    
    row_msg: "0x00..0x02 | uint8_t[3] | 0x61 0x62 0x63 ('abc')" {class: msg_layer}
    row_sep: "0x03 | uint8_t | 0x80 (Binary 10000000)" {class: separator_layer}
    row_pad: "0x04..0x37 | uint8_t[52] | 0x00 ... (Zero Padding)" {class: padding_layer}
    row_len: "0x38..0x3F | uint64_t (BE) | 0x0000000000000018 (24 bits)" {class: length_layer}
    
    label_bottom: "Total: 64 bytes (1 block)"
  }
  
  annotation: "Message + Separator + Length = 3 + 1 + 8 = 12 bytes.\nRemaining 52 bytes are zero-padding." {
    shape: text
    style.italic: true
  }
}

# -----------------------------------------------------------------------------
# Case 2: Boundary Message (55 bytes)
# -----------------------------------------------------------------------------
case_2: {
  label: "CASE 2: Boundary Message (55 bytes)"
  class: header_text
  direction: down

  block: {
    shape: sql_table
    label: "Padded Block (64 Bytes / 512 Bits)"
    
    row_msg: "0x00..0x36 | uint8_t[55] | Original Message" {class: msg_layer}
    row_sep: "0x37 | uint8_t | 0x80" {class: separator_layer}
    row_len: "0x38..0x3F | uint64_t (BE) | 0x00000000000001B8 (440 bits)" {class: length_layer}
    
    label_bottom: "Total: 64 bytes (1 block)"
  }

  annotation: "55 bytes is the MAX length for a 1-block message.\nNo space for zero-padding bytes (k=0)." {
    shape: text
    style.italic: true
  }
}

# -----------------------------------------------------------------------------
# Case 3: Overflow Message (56 bytes)
# -----------------------------------------------------------------------------
case_3: {
  label: "CASE 3: Overflow Message (56 bytes)"
  class: header_text
  direction: down

  block_1: {
    shape: sql_table
    label: "Padded Block #1 (64 Bytes)"
    
    row_msg: "0x00..0x37 | uint8_t[56] | Original Message" {class: msg_layer}
    row_sep: "0x38 | uint8_t | 0x80" {class: separator_layer}
    row_pad: "0x39..0x3F | uint8_t[7] | 0x00 (Zero Padding)" {class: padding_layer}
    
    label_bottom: "Block 1 Overflow"
  }

  block_2: {
    shape: sql_table
    label: "Padded Block #2 (64 Bytes)"
    
    row_pad: "0x00..0x37 | uint8_t[56] | 0x00 (Zero Padding)" {class: padding_layer}
    row_len: "0x38..0x3F | uint64_t (BE) | 0x00000000000001C0 (448 bits)" {class: length_layer}
    
    label_bottom: "Total: 128 bytes (2 blocks)"
  }

  annotation: "56 bytes requires 2 blocks because 56 + 1 (0x80) + 8 (len) = 65 bytes.\n65 > 64, so it overflows into Block 2." {
    shape: text
    style.italic: true
  }
}

# -----------------------------------------------------------------------------
# Legend (Near Bottom)
# -----------------------------------------------------------------------------
legend: {
  near: bottom-center
  direction: right
  
  l1: "Message" {class: msg_layer}
  l2: "0x80 Separator" {class: separator_layer}
  l3: "Zero Padding" {class: padding_layer}
  l4: "Bit Length (64-bit BE)" {class: length_layer}
}

# -----------------------------------------------------------------------------
# Global Style Overrides
# -----------------------------------------------------------------------------
sql_table: {
  style: {
    stroke-width: 2
  }
}

# Spacing between cases
case_1 -> case_2: {style.stroke-width: 0}
case_2 -> case_3: {style.stroke-width: 0}