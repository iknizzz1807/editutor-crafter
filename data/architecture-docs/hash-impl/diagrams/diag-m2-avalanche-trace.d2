direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- CLASSES FOR STATE ---
classes: {
  clean_word: {
    style: {
      fill: "#f1f3f5"
      stroke: "#adb5bd"
      font-color: "#495057"
    }
  }
  poisoned_word: {
    style: {
      fill: "#fff5f5"
      stroke: "#fa5252"
      font-color: "#c92a2a"
      bold: true
      stroke-width: 4
    }
  }
  poison_source: {
    style: {
      fill: "#ff8787"
      stroke: "#c92a2a"
      font-color: "#ffffff"
      bold: true
      double-border: true
    }
  }
}

# --- SATELLITE VIEW OF PROPAGATION ---
message_schedule: {
  direction: down
  label: "SHA-256 Message Schedule Avalanche Trace (W[0] Bit 0 Flip)"

  input_stage: {
    direction: right
    label: "INPUT: W[0..15] (512-bit block)"
    
    w0: "W[0] | 0x61626381" {
      class: poison_source
      tooltip: "Original: 0x61626380. Bit 0 flipped high."
    }
    w1_15: "W[1..15] | Unmodified" {
      class: clean_word
    }
  }

  early_expansion: {
    direction: right
    label: "EARLY EXPANSION: W[16..22]"
    
    w16: "W[16]" {
      class: poisoned_word
      tooltip: "W[16] = σ1(W[14]) + W[9] + σ0(W[1]) + W[0]"
    }
    w17: "W[17]" { class: clean_word }
    w18: "W[18]" {
      class: poisoned_word
      tooltip: "W[18] = σ1(W[16]) + W[11] + σ0(W[3]) + W[2]"
    }
    w19_22: "W[19..22]" { class: clean_word }
  }

  mid_expansion: {
    direction: right
    label: "MID EXPANSION: W[23..32]"
    
    w23: "W[23]" {
      class: poisoned_word
      tooltip: "W[23] = σ1(W[21]) + W[16] + σ0(W[8]) + W[7]"
    }
    w31: "W[31]" {
      class: poisoned_word
      tooltip: "W[31] = σ1(W[29]) + W[24] + σ0(W[16]) + W[15]"
    }
    w32: "W[32]" {
      class: poisoned_word
      tooltip: "W[32] = σ1(W[30]) + W[25] + σ0(W[17]) + W[16]"
    }
  }

  full_diffusion: {
    direction: right
    label: "FULL DIFFUSION: W[33..63]"
    
    w33_47: "W[33..47]" {
      class: poisoned_word
      style.opacity: 0.7
    }
    w48_63: "W[48..63]" {
      class: poisoned_word
      label: "TOTAL CONTAMINATION"
      tooltip: "Every bit in the schedule now depends on the initial flip of W[0]"
    }
  }
}

# --- DATA FLOW DEPENDENCIES (The Recurrence) ---
# W[t] = σ1(W[t-2]) + W[t-7] + σ0(W[t-15]) + W[t-16]

message_schedule.input_stage.w0 -> message_schedule.early_expansion.w16: "W[t-16] | Primary Injection" {
  style: {
    stroke: "#fa5252"
    stroke-width: 3
    animated: true
  }
}

message_schedule.early_expansion.w16 -> message_schedule.early_expansion.w18: "σ1(W[t-2]) | Bitwise Mixing" {
  style: {
    stroke: "#fa5252"
    stroke-dash: 5
  }
}

message_schedule.early_expansion.w16 -> message_schedule.mid_expansion.w23: "W[t-7] | Linear Carry" {
  style: {
    stroke: "#fa5252"
    stroke-dash: 2
  }
}

message_schedule.early_expansion.w16 -> message_schedule.mid_expansion.w31: "σ0(W[t-15]) | Delayed Mixing" {
  style: {
    stroke: "#fa5252"
  }
}

message_schedule.early_expansion.w16 -> message_schedule.mid_expansion.w32: "W[t-16] | Secondary Injection" {
  style: {
    stroke: "#fa5252"
    stroke-width: 2
  }
}

message_schedule.mid_expansion.w32 -> message_schedule.full_diffusion.w48_63: "Exponential Cascading" {
  style: {
    stroke: "#fa5252"
    stroke-width: 5
  }
}

# --- ANALYSIS ANNOTATION ---
analysis: |md
  ### The Avalanche Invariant
  In the Message Schedule Expansion:
  $W_t = \sigma_1(W_{t-2}) + W_{t-7} + \sigma_0(W_{t-15}) + W_{t-16}$

  - **Phase 1 (Linear)**: $W_{16}$ is contaminated immediately by $W_0$.
  - **Phase 2 (Geometric)**: Contamination spreads through 4 separate terms. 
    By round 32, $W_{16}$ alone has contributed to dozens of future words.
  - **Result**: A single bit change in $W_0$ triggers a complete scramble 
    of the 64-round input sequence. This makes differential cryptanalysis 
    statistically impossible.
| {
  near: bottom-center
  style: {
    stroke: "#adb5bd"
    fill: "#f8f9fa"
  }
}