direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# 2D GRID LAYOUT: INPUT (LEFT) -> TRANSFORMATION (RIGHT)
layer_input: {
  direction: down
  label: "INPUT DATA LAYER (bit_ops.h)"
  style: {
    stroke-width: 2
    fill: "#f8f9fa"
  }

  input_state: {
    direction: down
    
    bits: {
      shape: sql_table
      label: "struct Register32 (0xABCD1234)"
      
      high_25: "uint32_t | [31:7] | 10101011 11001101 00010010 0"
      low_7: "uint8_t  | [6:0]  | 0110100"
      
      label_bottom: "Total: 32-bit dword"
      
      high_25.style.fill: "#B6DDF6"
      low_7.style.fill: "#DEE1EB"
    }

    impl: |md
      c
      uint32_t x = 0xABCD1234;
      int n = 7;
      
    |
  }
}

layer_logic: {
  direction: down
  label: "BITWISE TRANSFORMATION LAYER"

  shr_container: {
    direction: right
    label: "LOGICAL RIGHT SHIFT (SHR)"
    style.stroke-dash: 3

    op_shr: {
      shape: code
      label: "x >> 7"
      style: {
        font-size: 20
        bold: true
      }
    }

    result_shr: {
      shape: sql_table
      label: "SHR Result (Destructive)"
      
      zero_pad: "7 bits | 0000000 | (Zero-fill)"
      data: "25 bits | 10101011 11001101 00010010 0"
      
      label_bottom: "Value: 0x01579A24"
      
      zero_pad.style.fill: "#eeeeee"
      data.style.fill: "#B6DDF6"
    }

    logic_shr: |md
      c
      // Discards LSBs
      // High bits cleared
      uint32_t res = x >> 7;
      
    |
  }

  rotr_container: {
    direction: right
    label: "RIGHT ROTATE (ROTR)"
    style.stroke: "#B5AFF6"

    op_rotr: {
      shape: code
      label: "ROTR32(x, 7)"
      style: {
        font-size: 20
        bold: true
      }
    }

    result_rotr: {
      shape: sql_table
      label: "ROTR Result (Preserved)"
      
      wrapped: "7 bits | 0110100 | (From LSB)"
      data: "25 bits | 10101011 11001101 00010010 0"
      
      label_bottom: "Value: 0x69579A24"
      
      wrapped.style.fill: "#DEE1EB"
      data.style.fill: "#B6DDF6"
    }

    logic_rotr: |md
      c
      // Circular Shift
      uint32_t res = (x >> 7) | 
                     (x << (32 - 7));
      
    |
  }
}

# DATA FLOW TRACING
layer_input.input_state.bits.low_7 -> layer_logic.shr_container.result_shr.zero_pad: "LOST | 7 bits | {0x34}" {
  style: {
    stroke-dash: 5
    stroke: gray
    opacity: 0.5
  }
}

layer_input.input_state.bits.low_7 -> layer_logic.rotr_container.result_rotr.wrapped: "WRAPPED | 7 bits | [6:0] -> [31:25]" {
  style: {
    stroke: "#B5AFF6"
    animated: true
    stroke-width: 2
  }
}

layer_input.input_state.bits.high_25 -> layer_logic.shr_container.result_shr.data: "SHIFTED | 25 bits"
layer_input.input_state.bits.high_25 -> layer_logic.rotr_container.result_rotr.data: "SHIFTED | 25 bits"

# SYSTEM ANNOTATION
annotation: {
  near: bottom-center
  shape: text
  label: "CRITICAL: SHA-256 Message Schedule (Ïƒ) requires ROTR. SHR results in diffusion loss."
  style: {
    font-color: red
    italic: true
    bold: true
    font-size: 14
  }
}