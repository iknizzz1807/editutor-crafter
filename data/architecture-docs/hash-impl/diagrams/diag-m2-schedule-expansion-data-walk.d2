direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# SHA-256 Message Schedule Expansion (sha256_schedule.c)
# Information Density: High - Implementation logic for bit-mixing avalanche.

input_block: {
  label: "INPUT BLOCK (W[0..15]) (sha256_schedule.c)"
  direction: down

  words: {
    shape: sql_table
    label: "struct uint32_t W[64]"
    
    W0: "0x00 | uint32_t | W[0]  | Message Word 0"
    W1: "0x04 | uint32_t | W[1]  | Message Word 1"
    W9: "0x24 | uint32_t | W[9]  | Message Word 9"
    W14: "0x38 | uint32_t | W[14] | Message Word 14"
    W15: "0x3C | uint32_t | W[15] | Message Word 15"
    
    label_bottom: "Total: 64 bytes (16 words) | Source: uint8_t data[64]"
  }
}

mixing_logic: {
  label: "RECURRENCE LOGIC (t=16) (sha256_schedule.c)"
  direction: down

  sigma_ops: {
    direction: right
    
    s1: {
      shape: code
      label: "σ1(x)"
      content: |md
        c
        // ROTR(x,17) ^ ROTR(x,19) ^ SHR(x,10)
        #define SIGMA1(x) (S32(x,17) ^ S32(x,19) ^ (x >> 10))
        uint32_t sigma1(uint32_t x);
        
      |
    }

    s0: {
      shape: code
      label: "σ0(x)"
      content: |md
        c
        // ROTR(x,7) ^ ROTR(x,18) ^ SHR(x,3)
        #define SIGMA0(x) (S32(x,7) ^ S32(x,18) ^ (x >> 3))
        uint32_t sigma0(uint32_t x);
        
      |
    }
  }

  sum_op: {
    shape: rectangle
    label: "W[t] = σ1(W[t-2]) + W[t-7] + σ0(W[t-15]) + W[t-16]"
    style: {
      stroke-width: 2
      fill: "#DEE1EB"
      bold: true
    }
  }
}

expansion_cascade: {
  label: "EXPANDED SCHEDULE (W[16..63])"
  direction: down

  schedule: {
    shape: sql_table
    label: "Extended Message Schedule"
    
    W16: "0x40 | uint32_t | W[16] | Primary Target (t=16)"
    W17: "0x44 | uint32_t | W[17] | Dependent on W16 (t-1)"
    W23: "0x5C | uint32_t | W[23] | Dependent on W16 (t-7)"
    W31: "0x7C | uint32_t | W[31] | Dependent on W16 (t-15)"
    W32: "0x80 | uint32_t | W[32] | Dependent on W16 (t-16)"
    W63: "0xFC | uint32_t | W[63] | Final Expanded Word"
    
    label_bottom: "Memory: 256 bytes total schedule"
  }
}

# --- Data Walk Connections ---

# Dependency paths for W[16]
input_block.words.W14 -> mixing_logic.sigma_ops.s1: "uint32_t | 4B | W[t-2]"
mixing_logic.sigma_ops.s1 -> mixing_logic.sum_op: "σ1 Output"

input_block.words.W1 -> mixing_logic.sigma_ops.s0: "uint32_t | 4B | W[t-15]"
mixing_logic.sigma_ops.s0 -> mixing_logic.sum_op: "σ0 Output"

input_block.words.W9 -> mixing_logic.sum_op: "uint32_t | 4B | W[t-7]"
input_block.words.W0 -> mixing_logic.sum_op: "uint32_t | 4B | W[t-16]"

# Result Storage
mixing_logic.sum_op -> expansion_cascade.schedule.W16: "W[16] = sum result"

# Cascade Dependency Web (W16 Influence mapping)
expansion_cascade.schedule.W16 -> expansion_cascade.schedule.W17: "Source for W[18]" {
  style.stroke-dash: 3
  style.stroke: blue
}
expansion_cascade.schedule.W16 -> expansion_cascade.schedule.W23: "Source for W[23]" {
  style.stroke-dash: 3
  style.stroke: blue
}
expansion_cascade.schedule.W16 -> expansion_cascade.schedule.W31: "Source for W[31]" {
  style.stroke-dash: 3
  style.stroke: blue
}
expansion_cascade.schedule.W16 -> expansion_cascade.schedule.W32: "Source for W[32]" {
  style.stroke-dash: 3
  style.stroke: blue
}

# Transitive Influence Path
expansion_cascade.schedule.W32 -> expansion_cascade.schedule.W63: "Bit Mixing Chain" {
  source-arrowhead: triangle
  target-arrowhead: diamond
  style.animated: true
  style.stroke: purple
}

# Annotations & Legend
legend: {
  shape: rectangle
  label: "AVALANCHE EFFECT\nBy Round 63, a single bit change in W[0]\nflips ~50% of the bits across the schedule."
  style: {
    fill: "#FFF9C9"
    stroke: "#9D341E"
    stroke-dash: 2
  }
  near: bottom-right
}

expansion_cascade.schedule.W63 -> legend: "Final Word Influence" {
  style.opacity: 0.5
}