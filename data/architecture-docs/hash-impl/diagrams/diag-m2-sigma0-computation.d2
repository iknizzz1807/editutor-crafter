direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# L1 COMPONENT DIAGRAM: σ0 Function Logic
# Tracing σ0(x) = ROTR(x, 7) ^ ROTR(x, 18) ^ SHR(x, 3)
# Input Example: W[15] = 0x00000018

sigma0_transformation: {
  direction: down
  label: "σ0 Transformation Pipeline (sha256_impl.c)"

  # Implementation Logic Reference
  logic_definition: {
    shape: class
    label: "uint32_t sigma0(uint32_t x)"
    
    definition: |md
      c
      // ROTR(x, n): (x >> n) | (x << (32 - n))
      // SHR(x, n):  (x >> n)
      // Reference: NIST FIPS 180-4 Section 4.1.2
      #define sigma0(x) (S32(7,x) ^ S32(18,x) ^ R32(3,x))
      
    |
  }

  # Computational Flow
  data_walk: {
    direction: down
    
    input_word: {
      shape: sql_table
      label: "0x3C | uint32_t | W[15]"
      
      row1: "Hex | 0x00000018"
      row2: "Binary | 00000000 00000000 00000000 00011000"
      
      label_bottom: "Total: 32 bits"
    }

    # Three-way parallel shift/rotate operations
    parallel_ops: {
      direction: right
      
      op_rotr7: {
        shape: sql_table
        label: "ROTR(x, 7)"
        row1: "Result | 0x30000000"
        row2: "Bits 31:28 | 0011"
        row3: "Details | Wrap [0:6] to [25:31]"
        style.fill: "#E1F5FE"
      }

      op_rotr18: {
        shape: sql_table
        label: "ROTR(x, 18)"
        row1: "Result | 0x00060000"
        row2: "Bits 18:17 | 11"
        row3: "Details | Wrap [0:17] to [14:31]"
        style.fill: "#E1F5FE"
      }

      op_shr3: {
        shape: sql_table
        label: "SHR(x, 3)"
        row1: "Result | 0x00000003"
        row2: "Bits 1:0 | 11"
        row3: "Details | Logical Right Shift"
        style.fill: "#FFF9C4"
      }
    }

    # XOR Accumulation
    xor_gate: {
      shape: circle
      label: "⊕"
      style: {
        font-size: 40
        stroke-width: 4
        bold: true
        fill: "#D1C4E9"
        stroke: purple
      }
    }

    # Final Output Register
    output_word: {
      shape: sql_table
      label: "Result: σ0(W[15])"
      row1: "Hex | 0x30060003"
      row2: "Binary | 00110000 00000110 00000000 00000011"
      row3: "State | Mixed Entropy"
      label_bottom: "Passed to Message Expansion W[t]"
      style.fill: "#E8F5E9"
    }

    # Data Flow Paths
    input_word -> parallel_ops.op_rotr7: "uint32_t | 4B | 0x18"
    input_word -> parallel_ops.op_rotr18: "uint32_t | 4B | 0x18"
    input_word -> parallel_ops.op_shr3: "uint32_t | 4B | 0x18"

    parallel_ops.op_rotr7 -> xor_gate: "0x30000000"
    parallel_ops.op_rotr18 -> xor_gate: "0x00060000"
    parallel_ops.op_shr3 -> xor_gate: "0x00000003"

    xor_gate -> output_word: "Bitwise XOR sum"
  }

  # Technical Footnote
  analysis: {
    label: "Diffusion Analysis"
    direction: right
    style.stroke-dash: 3
    
    note: |md
      ### Avalanche Foundation
      - **Bit Displacement**: Input bit at pos 4 (val 16) and 3 (val 8) spread to multiple output indices.
      - **Pos 4 shifts to**: 29 (R7), 18 (R18), 1 (S3).
      - **Mixing**: XOR ensures bits from three different linear transformations collide.
    |
  }
}

# Style overrides for specific nodes
sigma0_transformation.data_walk.output_word.row3.style.font-color: gray