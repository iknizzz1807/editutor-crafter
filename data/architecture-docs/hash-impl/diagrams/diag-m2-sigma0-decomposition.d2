direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# L0/L1: MESSAGE SCHEDULE GENERATION (Milestone 2)
# Function: Sigma0 (σ0) - Bitwise Mixing and Diffusion

input_layer: {
  direction: down
  label: "INPUT LAYER (schedule.h)"

  word_x: {
    shape: sql_table
    label: "uint32_t x | 0x12345678"
    
    row1: "0x00 | bits [31-24] | 0x12 | 00010010"
    row2: "0x01 | bits [23-16] | 0x34 | 00110100"
    row3: "0x02 | bits [15-08] | 0x56 | 01010110"
    row4: "0x03 | bits [07-00] | 0x78 | 01111000"
    label_bottom: "Total: 32-bit Word (4 bytes)"
  }
}

processing_layer: {
  direction: down
  label: "BITWISE DIFFUSION"

  op_rotr7: {
    shape: class
    label: "ROTR(x, 7)"
    definition: |'c
(x >> 7) | (x << 25)
    '|
    visual: "0x242468AC"
    style.fill: "#E4DBFE"
  }

  op_rotr18: {
    shape: class
    label: "ROTR(x, 18)"
    definition: |'c
(x >> 18) | (x << 14)
    '|
    visual: "0x59E2048D"
    style.fill: "#E4DBFE"
  }

  op_shr3: {
    shape: class
    label: "SHR(x, 3)"
    definition: |'c
(x >> 3)
    '|
    visual: "0x02468ACF"
    style.fill: "#F4B76C"
  }
}

xor_stage: {
  shape: circle
  label: "⊕\nXOR"
  style: {
    fill: "#B5AFF6"
    font-size: 30
    bold: true
  }
}

output_layer: {
  direction: down
  label: "OUTPUT LAYER (schedule.c)"

  sigma0_result: {
    shape: sql_table
    label: "struct Sigma0Out"
    
    val: "uint32_t | value | 0x7FB006EF"
    logic: "ROTR(x,7) ^ ROTR(x,18) ^ SHR(x,3)"
    style: {
      stroke: "#167c3c"
      stroke-width: 4
    }
    label_bottom: "Final Mixed Word"
  }

  impl_code: {
    shape: code
    label: "static inline uint32_t sigma0(uint32_t x)"
    language: c
    value: |'c
static inline uint32_t sigma0(uint32_t x) {
    return rotr32(x, 7) ^ rotr32(x, 18) ^ (x >> 3);
}
    '|
  }
}

# DATA FLOW (Implementation-Ready Types & Examples)
input_layer.word_x -> processing_layer.op_rotr7: "uint32_t | 4B | 0x12345678"
input_layer.word_x -> processing_layer.op_rotr18: "uint32_t | 4B | 0x12345678"
input_layer.word_x -> processing_layer.op_shr3: "uint32_t | 4B | 0x12345678"

processing_layer.op_rotr7 -> xor_stage: "0x242468AC | ROTR 7" {
  style: { stroke: blue; animated: true }
}
processing_layer.op_rotr18 -> xor_stage: "0x59E2048D | ROTR 18" {
  style: { stroke: blue; animated: true }
}
processing_layer.op_shr3 -> xor_stage: "0x02468ACF | SHR 3" {
  style: { stroke: blue; animated: true }
}

xor_stage -> output_layer.sigma0_result: "uint32_t | 4B | 0x7FB006EF"

# ANNOTATIONS
analysis_note: |md
  ### Diffusion Analysis
  1. **Avalanche Effect**: Every input bit affects multiple output bits via parallel rotations.
  2. **Non-Invertibility**: SHR(3) discards 3 bits, making the function one-way.
  3. **Zero-Filling**: SHR(3) injects 0s at MSB [31:29], modifying the bit distribution.
|
analysis_note.near: bottom-center