direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# SHA-256 Compression Function (64 Rounds Overview)
# NIST FIPS 180-4 Section 6.2.2

input_layer: {
  label: "INPUT STATE & BLOCK"
  direction: down

  hash_state_in: {
    shape: sql_table
    label: "struct SHA256_CTX (sha256.h)"
    row1: "0x00 | uint32_t[8] | H"
    row2: "0x20 | uint8_t[64] | buf"
    row3: "0x60 | size_t      | buf_len"
    row4: "0x68 | uint64_t    | total_len"
    label_bottom: "Total: 112 bytes"
  }

  block_input: {
    shape: cylinder
    label: "512-bit Message Block\n(64 bytes)"
  }
}

processing_layer: {
  label: "COMPRESSION PIPELINE"
  direction: down

  message_schedule: {
    shape: class
    label: "Message Schedule W[0..63] (sha256_schedule.c)"
    definition: |md
      c
      // Recurrence Relation:
      // W[t] = σ1(W[t-2]) + W[t-7] + σ0(W[t-15]) + W[t-16]
      uint32_t W[64]; 
      
    |
  }

  compression_core: {
    label: "64-Round Transformation"
    direction: down
    
    initial_vars: "Initialize (a,b,c,d,e,f,g,h) = H[0..7]" {
      style.fill: "#DEE1EB"
    }

    round_group_1: {
      label: "Rounds 00 - 15"
      style.stroke: "#88DCF7"
      style.stroke-width: 2
      
      r0: "Round 0" { shape: parallelogram }
      r_dots1: "..." { shape: text }
      r15: "Round 15" { shape: parallelogram }
      
      r0 -> r_dots1 -> r15
    }

    round_group_2: {
      label: "Rounds 16 - 31"
      style.stroke: "#C7F1FF"
      
      r16: "Round 16" { shape: parallelogram }
      r_dots2: "..." { shape: text }
      r31: "Round 31" { shape: parallelogram }

      r16 -> r_dots2 -> r31
    }

    round_group_3: {
      label: "Rounds 32 - 47"
      style.stroke: "#B5AFF6"
      
      r32: "Round 32" { shape: parallelogram }
      r_dots3: "..." { shape: text }
      r47: "Round 47" { shape: parallelogram }

      r32 -> r_dots3 -> r47
    }

    round_group_4: {
      label: "Rounds 48 - 63"
      style.stroke: "#E4DBFE"
      
      r48: "Round 48" { shape: parallelogram }
      r_dots4: "..." { shape: text }
      r63: "Round 63" { shape: parallelogram }

      r48 -> r_dots4 -> r63
    }

    initial_vars -> round_group_1 -> round_group_2 -> round_group_3 -> round_group_4
  }
}

constants_feeder: {
  shape: sql_table
  label: "Round Constants K[0..63]"
  k0: "0x00 | 0x428A2F98 (cbrt 2)"
  k1: "0x04 | 0x71374491 (cbrt 3)"
  k_mid: "..."
  k63: "0xFC | 0xC67178F2 (cbrt 311)"
  label_bottom: "Total: 256 bytes"
}

output_layer: {
  label: "STATE FINALIZATION"
  direction: down

  davies_meyer_addition: {
    shape: class
    label: "Final Addition (Davies-Meyer)"
    logic: |md
      c
      H[0] = H[0] + a;
      H[1] = H[1] + b;
      H[2] = H[2] + c;
      H[3] = H[3] + d;
      H[4] = H[4] + e;
      H[5] = H[5] + f;
      H[6] = H[6] + g;
      H[7] = H[7] + h;
      
    |
    style.fill: "#ACE1AF"
  }

  hash_digest: {
    shape: rectangle
    label: "Updated Hash State H'[0..7]"
    style.stroke: green
    style.stroke-width: 4
  }
}

# Data Flows
input_layer.block_input -> processing_layer.message_schedule: "uint8_t[64] | 512-bit block"
input_layer.hash_state_in -> processing_layer.compression_core.initial_vars: "uint32_t[8] | Current State"

processing_layer.message_schedule -> processing_layer.compression_core: "uint32_t W[t] | Per Round"
constants_feeder -> processing_layer.compression_core: "uint32_t K[t] | Per Round"

processing_layer.compression_core -> output_layer.davies_meyer_addition: "Final Variables (a..h)"
output_layer.davies_meyer_addition -> output_layer.hash_digest: "H += state | 256 bits"

# Legend/Notes
note: |md
  ### SHA-256 Compression Logic
  - **Davies-Meyer Construction**: The final addition makes the function one-way.
  - **Round Logic**:
    T1 = h + Σ1(e) + Ch(e,f,g) + K[t] + W[t]
    T2 = Σ0(a) + Maj(a,b,c)
  - **Non-Invertibility**: Feedback of initial state prevents working backwards.
| {
  near: bottom-right
}