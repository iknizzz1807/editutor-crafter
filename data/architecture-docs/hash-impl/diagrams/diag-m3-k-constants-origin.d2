direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: {
  shape: text
  label: "SHA-256 Round Constants (K) Derivation"
  near: top-center
  style: {
    font-size: 24
    bold: true
  }
}

# --- DERIVATION LOGIC LAYER ---
derivation_layer: {
  label: "MATHEMATICAL DERIVATION PIPELINE"
  direction: down

  logic_flow: {
    direction: right
    
    prime_input: {
      shape: sql_table
      label: "Step 1: Input Prime (p)"
      k0: "index 0 | p = 2"
      k1: "index 1 | p = 3"
      k2: "index 2 | p = 5"
    }

    cube_root: {
      shape: sql_table
      label: "Step 2: Cube Root (p^1/3)"
      k0: "1.259921049..."
      k1: "1.442249570..."
      k2: "1.709975946..."
    }

    fractional: {
      shape: sql_table
      label: "Step 3: Fractional Part (frac)"
      k0: "0.259921049..."
      k1: "0.442249570..."
      k2: "0.709975946..."
    }

    scaling: {
      shape: sql_table
      label: "Step 4: Scale (frac * 2^32)"
      k0: "1116352408.3..."
      k1: "1899446417.8..."
      k2: "3049318607.3..."
    }

    hex_result: {
      shape: sql_table
      label: "Step 5: Truncated Hex (K[t])"
      k0: "0x428A2F98"
      k1: "0x71374491"
      k2: "0xB5C0FBCF"
    }

    prime_input -> cube_root: "pow(p, 1/3)"
    cube_root -> fractional: "x - floor(x)"
    fractional -> scaling: "x * 4294967296"
    scaling -> hex_result: "uint32_t cast"
  }
}

# --- IMPLEMENTATION TABLE LAYER ---
constants_storage: {
  label: "static const uint32_t K[64] (sha256_compress.c)"
  direction: down

  table: {
    shape: sql_table
    label: "FIPS 180-4 Section 4.2.2 Constants"
    
    header: "Idx | Value      | Idx | Value      | Idx | Value      | Idx | Value"
    r1: "00 | 0x428A2F98 | 01 | 0x71374491 | 02 | 0xB5C0FBCF | 03 | 0xE9B5DBA5"
    r2: "04 | 0x3956C25B | 05 | 0x59F111F1 | 06 | 0x923F82A4 | 07 | 0xAB1C5ED5"
    r3: "08 | 0xD807AA98 | 09 | 0x12835B01 | 10 | 0x243185BE | 11 | 0x550C7DC3"
    r4: "... | ...        | ... | ...        | ... | ...        | 63 | 0xC67178F2"
    
    label_bottom: "Total: 256 Bytes (64 * 4 bytes)"
  }

  rationale: |md
    ### Nothing-Up-My-Sleeve (NUMS)
    These values are deterministic. Because they are derived from a simple mathematical rule (cube roots of primes), it is impossible for designers to "hide" a specific constant that might contain a cryptographic backdoor or a shortcut for collision attacks.
  |
}

# --- CROSS-REFERENCE ---
derivation_layer -> constants_storage: "Populates"

# --- LEGEND/STYLE ---
style_legend: {
  near: bottom-right
  nums: {
    label: "NUMS Verified"
    style: {
      fill: "#E1F5FE"
      stroke: "#01579B"
      double-border: true
    }
  }
}

derivation_layer.logic_flow.hex_result.k0 -> constants_storage.table.r1: "K[0]"
derivation_layer.logic_flow.hex_result.k1 -> constants_storage.table.r1: "K[1]"
derivation_layer.logic_flow.hex_result.k2 -> constants_storage.table.r1: "K[2]"