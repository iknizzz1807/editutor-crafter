direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# LEGEND / WARNING
warning: {
  shape: package
  label: "⚠️ CRITICAL DIFFERENTIATION: SILENT FAILURE HAZARD"
  style: {
    fill: "#ffcfcf"
    stroke: "#ff0000"
    stroke-width: 4
    bold: true
  }
  content: "Mixing these functions results in a valid-looking but incorrect hash.\nThey share the same structure but use different constants and operations."
}

# MESSAGE SCHEDULE FUNCTIONS (LOWERCASE)
message_schedule: {
  label: "Message Schedule Expansion (schedule.c)"
  direction: down

  sigma_0_lower: {
    shape: sql_table
    label: "σ0(x) - Lowercase Sigma 0"
    
    row_op: "Operation | x ^ x ^ x"
    row_1: "ROTR(x, 7)  | 0x07"
    row_2: "ROTR(x, 18) | 0x12"
    row_3: "SHR(x, 3)   | 0x03 (Note: SHR, not ROTR)"
    
    label_bottom: "Used for: W[t] expansion"
    style.fill: "#e1f5fe"
  }

  sigma_1_lower: {
    shape: sql_table
    label: "σ1(x) - Lowercase Sigma 1"
    
    row_op: "Operation | x ^ x ^ x"
    row_1: "ROTR(x, 17) | 0x11"
    row_2: "ROTR(x, 19) | 0x13"
    row_3: "SHR(x, 10)  | 0x0A (Note: SHR, not ROTR)"
    
    label_bottom: "Used for: W[t] expansion"
    style.fill: "#e1f5fe"
  }
}

# COMPRESSION FUNCTIONS (UPPERCASE)
compression_logic: {
  label: "Compression Function (compress.c)"
  direction: down

  Sigma_0_upper: {
    shape: sql_table
    label: "Σ0(a) - Uppercase Sigma 0"
    
    row_op: "Operation | x ^ x ^ x"
    row_1: "ROTR(x, 2)  | 0x02"
    row_2: "ROTR(x, 13) | 0x0D"
    row_3: "ROTR(x, 22) | 0x16"
    
    label_bottom: "Target: Working Variable 'a'"
    style.fill: "#f3e5f5"
  }

  Sigma_1_upper: {
    shape: sql_table
    label: "Σ1(e) - Uppercase Sigma 1"
    
    row_op: "Operation | x ^ x ^ x"
    row_1: "ROTR(x, 6)  | 0x06"
    row_2: "ROTR(x, 11) | 0x0B"
    row_3: "ROTR(x, 25) | 0x19"
    
    label_bottom: "Target: Working Variable 'e'"
    style.fill: "#f3e5f5"
  }
}

# CATASTROPHIC FAILURE PATHS
message_schedule.sigma_0_lower -> compression_logic.Sigma_0_upper: "DO NOT SWAP" {
  style: {
    stroke: red
    stroke-width: 2
    stroke-dash: 5
  }
}

message_schedule.sigma_1_lower -> compression_logic.Sigma_1_upper: "DO NOT SWAP" {
  style: {
    stroke: red
    stroke-width: 2
    stroke-dash: 5
  }
}

# Implementation Details
impl_details: {
  near: bottom-center
  
  code_sig: |md
    c
    // Message Schedule (Lowercase)
    #define sigma0(x) (ROTR(x, 7) ^ ROTR(x, 18) ^ (x >> 3))
    #define sigma1(x) (ROTR(x, 17) ^ ROTR(x, 19) ^ (x >> 10))

    // Compression (Uppercase)
    #define Sigma0(x) (ROTR(x, 2) ^ ROTR(x, 13) ^ ROTR(x, 22))
    #define Sigma1(x) (ROTR(x, 6) ^ ROTR(x, 11) ^ ROTR(x, 25))
    
  |
}