direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# Implementation-Ready Global Styles
classes: {
  function_group: {
    style: {
      stroke-width: 2
      border-radius: 8
      font-size: 18
    }
  }
  callout: {
    style: {
      stroke-dash: 3
      font-size: 14
      bold: true
    }
  }
}

title: "SHA-256: Σ (Compression) vs. σ (Schedule) Implementation Detail" {
  shape: text
  near: top-center
  style: {
    font-size: 26
    bold: true
  }
}

# LAYER 1: MESSAGE SCHEDULE
schedule_layer: "MESSAGE SCHEDULE (W[t]) FUNCTIONS" {
  class: function_group
  direction: down
  style: {
    fill: "#f9fbe7"
    stroke: "#827717"
  }

  sigma0_fn: {
    shape: class
    label: "uint32_t sigma0(uint32_t x) (sha256_schedule.c)"
    
    definition: |md
      c
      // σ0(x) = ROTR7(x) ^ ROTR18(x) ^ SHR3(x)
      uint32_t sigma0(uint32_t x) {
          return (ROTR(x, 7) ^ ROTR(x, 18) ^ (x >> 3));
      }
      
    |
    
    analysis: |md
      - Ops: 2x ROTR, 1x SHR
      - Type: Non-reversible (SHR destroys 3 MSB)
      - Purpose: Diffusion in message schedule expansion
    |
  }

  sigma1_fn: {
    shape: class
    label: "uint32_t sigma1(uint32_t x) (sha256_schedule.c)"
    
    definition: |md
      c
      // σ1(x) = ROTR17(x) ^ ROTR19(x) ^ SHR10(x)
      uint32_t sigma1(uint32_t x) {
          return (ROTR(x, 17) ^ ROTR(x, 19) ^ (x >> 10));
      }
      
    |
    
    analysis: |md
      - Ops: 2x ROTR, 1x SHR
      - Type: Non-reversible (SHR destroys 10 MSB)
      - Purpose: Recurrence for W[16..63]
    |
  }
}

# LAYER 2: COMPRESSION ROUNDS
compress_layer: "COMPRESSION (Σ) FUNCTIONS" {
  class: function_group
  direction: down
  style: {
    fill: "#e1f5fe"
    stroke: "#01579b"
  }

  Sigma0_fn: {
    shape: class
    label: "uint32_t Sigma0(uint32_t x) (sha256_compress.c)"
    
    definition: |md
      c
      // Σ0(x) = ROTR2(x) ^ ROTR13(x) ^ ROTR22(x)
      uint32_t Sigma0(uint32_t x) {
          return (ROTR(x, 2) ^ ROTR(x, 13) ^ ROTR(x, 22));
      }
      
    |
    
    analysis: |md
      - Ops: 3x ROTR (Pure rotation)
      - Type: Reversible bit diffusion
      - Usage: Applied to register 'a' (Working Variable)
    |
  }

  Sigma1_fn: {
    shape: class
    label: "uint32_t Sigma1(uint32_t x) (sha256_compress.c)"
    
    definition: |md
      c
      // Σ1(x) = ROTR6(x) ^ ROTR11(x) ^ ROTR25(x)
      uint32_t Sigma1(uint32_t x) {
          return (ROTR(x, 6) ^ ROTR(x, 11) ^ ROTR(x, 25));
      }
      
    |
    
    analysis: |md
      - Ops: 3x ROTR (Pure rotation)
      - Type: Reversible bit diffusion
      - Usage: Applied to register 'e' (Working Variable)
    |
  }
}

# INTER-LAYER DATA FLOW
schedule_layer -> compress_layer: "W[t] | uint32_t | 4-byte schedule word" {
  style: {
    stroke-width: 3
    stroke: "#455a64"
    animated: true
  }
}

# IMPLEMENTATION LOGIC LEGEND
legend: {
  shape: sql_table
  near: bottom-right
  label: "Bitwise Implementation Standards"
  
  row1: "ROTR(x, n) | (x >> n) | (x << (32 - n)) | 32-bit Rotate"
  row2: "SHR(x, n)  | (x >> n)                      | Logical Shift"
  row3: "XOR (⊕)    | Bitwise ^                    | Modulo-2 addition"
  row4: "Integer    | uint32_t (stdint.h)          | Fixed 4-byte width"
  
  label_bottom: "Compliant with FIPS PUB 180-4"
}

# ARCHITECTURAL COMPARISON CALLOUT
comparison_summary: {
  shape: cloud
  near: bottom-center
  label: |md
    ### Architectural Difference
    - **σ (Lowercase)**: Uses **SHR** (Shift Right) to break reversible linearity.
    - **Σ (Uppercase)**: Uses **ROTR** (Rotate) only for maximal diffusion without bit loss.
  |
  style: {
    fill: "#fff9c4"
    stroke: "#fbc02d"
    stroke-width: 2
  }
}