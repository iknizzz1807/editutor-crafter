direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# L1/L2 DIAGRAM: T1 and T2 Computation Detailed Data Flow (sha256_compress.c)

working_state: {
  shape: sql_table
  label: "Current State (H Round t)"
  
  a: "0x00 | uint32_t | a"
  b: "0x04 | uint32_t | b"
  c: "0x08 | uint32_t | c"
  d: "0x0C | uint32_t | d"
  e: "0x10 | uint32_t | e"
  f: "0x14 | uint32_t | f"
  g: "0x18 | uint32_t | g"
  h: "0x1C | uint32_t | h"
  
  label_bottom: "Total: 32 bytes"
}

logic_functions: {
  direction: down
  label: "Non-linear & Diffusion Primitives"
  
  sigma_upper_0: {
    shape: code
    label: "Σ0(a)"
    language: "c"
    content: "rotr(a, 2) ^ rotr(a, 13) ^ rotr(a, 22)"
  }
  
  maj: {
    shape: code
    label: "Maj(a, b, c)"
    language: "c"
    content: "(a & b) ^ (a & c) ^ (b & c)"
  }
  
  sigma_upper_1: {
    shape: code
    label: "Σ1(e)"
    language: "c"
    content: "rotr(e, 6) ^ rotr(e, 11) ^ rotr(e, 25)"
  }
  
  ch: {
    shape: code
    label: "Ch(e, f, g)"
    language: "c"
    content: "(e & f) ^ (~e & g)"
  }
}

external_inputs: {
  direction: down
  k_t: "uint32_t | K[t] | Round Constant" {
    style: { fill: "#E4DBFE"; stroke: "#3C3836" }
  }
  w_t: "uint32_t | W[t] | Message Word" {
    style: { fill: "#C7F1FF"; stroke: "#3C3836" }
  }
}

summation_engine: {
  direction: down
  label: "Intermediate Calculation (Mod 2^32)"
  
  t1: {
    label: |md
      ### T1 (Intermediate)
      c
      uint32_t T1 = h + Sigma1(e) + Ch(e, f, g) + K[t] + W[t];
      
    |
    style: { stroke: "#88DCF7"; stroke-width: 4 }
  }
  
  t2: {
    label: |md
      ### T2 (Intermediate)
      c
      uint32_t T2 = Sigma0(a) + Maj(a, b, c);
      
    |
    style: { stroke: "#88DCF7"; stroke-width: 4 }
  }
}

next_state: {
  shape: sql_table
  label: "Updated State (H Round t+1)"
  
  new_a: "a' = T1 + T2"
  new_b: "b' = a"
  new_c: "c' = b"
  new_d: "d' = c"
  new_e: "e' = d + T1"
  new_f: "f' = e"
  new_g: "g' = f"
  new_h: "h' = g"
  
  label_bottom: "Davies-Meyer Step next"
}

# --- Detailed Flow Mappings ---

# T1 Feeders
working_state.h -> summation_engine.t1: "uint32_t | 4B | direct"
working_state.e -> logic_functions.sigma_upper_1: "uint32_t | 4B"
logic_functions.sigma_upper_1 -> summation_engine.t1: "Σ1(e)"

working_state.e -> logic_functions.ch
working_state.f -> logic_functions.ch
working_state.g -> logic_functions.ch
logic_functions.ch -> summation_engine.t1: "Ch(e,f,g)"

external_inputs.k_t -> summation_engine.t1: "K[t]"
external_inputs.w_t -> summation_engine.t1: "W[t]"

# T2 Feeders
working_state.a -> logic_functions.sigma_upper_0: "uint32_t | 4B"
logic_functions.sigma_upper_0 -> summation_engine.t2: "Σ0(a)"

working_state.a -> logic_functions.maj
working_state.b -> logic_functions.maj
working_state.c -> logic_functions.maj
logic_functions.maj -> summation_engine.t2: "Maj(a,b,c)"

# Assignments
summation_engine.t1 -> next_state.new_a: "uint32_t | 4B"
summation_engine.t2 -> next_state.new_a: "uint32_t | 4B"

working_state.d -> next_state.new_e: "uint32_t | 4B"
summation_engine.t1 -> next_state.new_e: "uint32_t | 4B | Crucial: T2 NOT added here"

# Simple Shifts
working_state.a -> next_state.new_b
working_state.b -> next_state.new_c
working_state.c -> next_state.new_d
working_state.e -> next_state.new_f
working_state.f -> next_state.new_g
working_state.g -> next_state.new_h

# Bug Alert Callout
bug_alert: {
  shape: rectangle
  label: |md
    ### IMPLEMENTATION HAZARD
    **DO NOT** write:
    `e = d + T1 + T2;`
    
    **CORRECT** (FIPS 180-4):
    `e = d + T1;`
    `a = T1 + T2;`
    
    T2 only influences the 'a' register.
  |
  style: { fill: "#FE7070"; stroke: "#F69E03"; double-border: true }
}

bug_alert.near: bottom-right