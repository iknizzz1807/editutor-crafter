direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# SHA-256 Working Variable Rotation (State Evolution)
# Input: "abc" test vector
# File: sha256_compress.c

title: |md
  # SHA-256 Working Variable Rotation (t=0..3)
  ### Implementation-Ready State Evolution (NIST Test Vector: 'abc')
| {near: top-center}

legend: {
  near: bottom-right
  computed: "Newly Computed (Injection)" {
    style: {
      fill: "#E1D5E7"
      stroke: "#9673A6"
    }
  }
  shifted: "Rotated (Simple Shift)" {
    style: {
      fill: "#D5E8D4"
      stroke: "#82B366"
    }
  }
}

round_0: {
  label: "Round 0 (Initial Hash Values)"
  state: {
    shape: sql_table
    label: "uint32_t a..h (0x00 - 0x1C)"
    "0x00": "a | 0x6A09E667"
    "0x04": "b | 0xBB67AE85"
    "0x08": "c | 0x3C6EF372"
    "0x0C": "d | 0xA54FF53A"
    "0x10": "e | 0x510E527F"
    "0x14": "f | 0x9B05688C"
    "0x18": "g | 0x1F83D9AB"
    "0x1C": "h | 0x5BE0CD19"
  }
}

round_1: {
  label: "Round 1 State (Post-t=0)"
  state: {
    shape: sql_table
    label: "uint32_t a..h"
    "0x00": "a | 0xBA7816BF"
    "0x04": "b | 0x6A09E667"
    "0x08": "c | 0xBB67AE85"
    "0x0C": "d | 0x3C6EF372"
    "0x10": "e | 0xB00361A3"
    "0x14": "f | 0x510E527F"
    "0x18": "g | 0x9B05688C"
    "0x1C": "h | 0x1F83D9AB"
  }
  state."0x00".style.fill: "#E1D5E7"
  state."0x10".style.fill: "#E1D5E7"
}

round_2: {
  label: "Round 2 State (Post-t=1)"
  state: {
    shape: sql_table
    label: "uint32_t a..h"
    "0x00": "a | 0x8ED958A9"
    "0x04": "b | 0xBA7816BF"
    "0x08": "c | 0x6A09E667"
    "0x0C": "d | 0xBB67AE85"
    "0x10": "e | 0xA77D014F"
    "0x14": "f | 0xB00361A3"
    "0x18": "g | 0x510E527F"
    "0x1C": "h | 0x9B05688C"
  }
  state."0x00".style.fill: "#E1D5E7"
  state."0x10".style.fill: "#E1D5E7"
}

round_3: {
  label: "Round 3 State (Post-t=2)"
  state: {
    shape: sql_table
    label: "uint32_t a..h"
    "0x00": "a | 0x116A65BA"
    "0x04": "b | 0x8ED958A9"
    "0x08": "c | 0xBA7816BF"
    "0x0C": "d | 0x6A09E667"
    "0x10": "e | 0x34139F91"
    "0x14": "f | 0xA77D014F"
    "0x18": "g | 0xB00361A3"
    "0x1C": "h | 0x510E527F"
  }
  state."0x00".style.fill: "#E1D5E7"
  state."0x10".style.fill: "#E1D5E7"
}

round_4_start: {
  label: "Round 4 (t=3 Result)"
  state: {
    shape: sql_table
    label: "uint32_t a..h"
    "0x00": "a | 0x36746170"
    "0x04": "b | 0x116A65BA"
    "0x08": "c | 0x8ED958A9"
    "0x0C": "d | 0xBA7816BF"
    "0x10": "e | 0x86F9A9E7"
    "0x14": "f | 0x34139F91"
    "0x18": "g | 0xA77D014F"
    "0x1C": "h | 0xB00361A3"
  }
  state."0x00".style.fill: "#E1D5E7"
  state."0x10".style.fill: "#E1D5E7"
}

# Transition Logic Round 0 -> Round 1
round_0.state."0x00" -> round_1.state."0x04": "b = a"
round_0.state."0x04" -> round_1.state."0x08": "c = b"
round_0.state."0x08" -> round_1.state."0x0C": "d = c"
round_0.state."0x0C" -> round_1.state."0x10": "e = d + T1" {
  style.stroke: purple
}
round_0.state."0x10" -> round_1.state."0x14": "f = e"
round_0.state."0x14" -> round_1.state."0x18": "g = f"
round_0.state."0x18" -> round_1.state."0x1C": "h = g"
round_0.state -> round_1.state."0x00": "a = T1 + T2" {
  style.stroke: purple
}

# Transition Logic Round 1 -> Round 2
round_1.state."0x00" -> round_2.state."0x04"
round_1.state."0x04" -> round_2.state."0x08"
round_1.state."0x08" -> round_2.state."0x0C"
round_1.state."0x0C" -> round_2.state."0x10"
round_1.state."0x10" -> round_2.state."0x14"
round_1.state."0x14" -> round_2.state."0x18"
round_1.state."0x18" -> round_2.state."0x1C"
round_1.state -> round_2.state."0x00"

# Transition Logic Round 2 -> Round 3
round_2.state."0x00" -> round_3.state."0x04"
round_2.state."0x04" -> round_3.state."0x08"
round_2.state."0x08" -> round_3.state."0x0C"
round_2.state."0x0C" -> round_3.state."0x10"
round_2.state."0x10" -> round_3.state."0x14"
round_2.state."0x14" -> round_3.state."0x18"
round_2.state."0x18" -> round_3.state."0x1C"
round_2.state -> round_3.state."0x00"

# Transition Logic Round 3 -> Round 4
round_3.state."0x00" -> round_4_start.state."0x04"
round_3.state."0x04" -> round_4_start.state."0x08"
round_3.state."0x08" -> round_4_start.state."0x0C"
round_3.state."0x0C" -> round_4_start.state."0x10"
round_3.state."0x10" -> round_4_start.state."0x14"
round_3.state."0x14" -> round_4_start.state."0x18"
round_3.state."0x18" -> round_4_start.state."0x1C"
round_3.state -> round_4_start.state."0x00"

round_0.state."0x00".style.fill: "#D5E8D4"
round_0.state."0x04".style.fill: "#D5E8D4"
round_0.state."0x08".style.fill: "#D5E8D4"
round_0.state."0x0C".style.fill: "#D5E8D4"
round_0.state."0x10".style.fill: "#D5E8D4"
round_0.state."0x14".style.fill: "#D5E8D4"
round_0.state."0x18".style.fill: "#D5E8D4"
round_0.state."0x1C".style.fill: "#D5E8D4"

annotations: {
  near: top-left
  label: |md
    ### Step-by-Step Transition (Round t)
    1. $T_1 = h + \Sigma_1(e) + Ch(e, f, g) + K_t + W_t$
    2. $T_2 = \Sigma_0(a) + Maj(a, b, c)$
    3. $h_{t+1} = g_t$
    4. $g_{t+1} = f_t$
    5. $f_{t+1} = e_t$
    6. $e_{t+1} = d_t + T_1$
    7. $d_{t+1} = c_t$
    8. $c_{t+1} = b_t$
    9. $b_{t+1} = a_t$
    10. $a_{t+1} = T_1 + T_2$
  |
  shape: text
}