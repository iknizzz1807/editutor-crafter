direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ---------------------------------------------------------------------------------
# CLASSES & STYLES
# ---------------------------------------------------------------------------------
classes: {
  context_table: {
    shape: sql_table
    style: {
      stroke-width: 2
    }
  }
  process_step: {
    style: {
      fill: "#f8f9fa"
      stroke: "#343a40"
      border-radius: 8
    }
  }
}

# ---------------------------------------------------------------------------------
# DATA WALK: STREAMING HASH OF 'abc'
# ---------------------------------------------------------------------------------

state_0_init: {
  class: process_step
  label: "STEP 0: sha256_init(ctx)"
  
  ctx: {
    class: context_table
    label: "struct SHA256_CTX (sha256.h)"
    
    row_h: "0x00 | uint32_t[8] | H | {0x6A09E667, 0xBB67AE85, ...}"
    row_buf: "0x20 | uint8_t[64] | buf | {0x00, 0x00, ..., 0x00}"
    row_blen: "0x60 | size_t | buf_len | 0"
    row_tlen: "0x68 | uint64_t | total_len | 0"
    
    label_bottom: "Total: 112 bytes"
  }
}

state_1_update_a: {
  class: process_step
  label: "STEP 1: update(ctx, 'a', 1)"
  
  ctx: {
    class: context_table
    label: "struct SHA256_CTX (sha256.h)"
    
    row_h: "0x00 | uint32_t[8] | H | (Initial State Unchanged)"
    row_buf: "0x20 | uint8_t[64] | buf | {0x61, 0x00, ..., 0x00}"
    row_blen: "0x60 | size_t | buf_len | 1"
    row_tlen: "0x68 | uint64_t | total_len | 1"
    
    row_buf.style: { fill: "#C7F1FF" }
  }
}

state_2_update_bc: {
  class: process_step
  label: "STEP 2: update(ctx, 'bc', 2)"
  
  ctx: {
    class: context_table
    label: "struct SHA256_CTX (sha256.h)"
    
    row_h: "0x00 | uint32_t[8] | H | (Initial State Unchanged)"
    row_buf: "0x20 | uint8_t[64] | buf | {0x61, 0x62, 0x63, 0x00, ...}"
    row_blen: "0x60 | size_t | buf_len | 3"
    row_tlen: "0x68 | uint64_t | total_len | 3"
    
    row_buf.style: { fill: "#C7F1FF" }
  }
}

state_3_finalize: {
  class: process_step
  label: "STEP 3: sha256_finalize(ctx, out)"
  
  padding_logic: {
    shape: rectangle
    label: "Padding & Compression (Internal)"
    
    step1: "Append 0x80 @ buf[3]"
    step2: "Zero fill buf[4..55]"
    step3: "Write Length (24 bits) @ buf[56..63]"
    step4: "W[64] = schedule(buf)"
    step5: "compress(H, W)"
    
    step1 -> step2 -> step3 -> step4 -> step5
  }

  ctx_final: {
    class: context_table
    label: "Final Output (Big-Endian)"
    
    h0: "0xBA7816BF"
    h1: "0x8F01CFEA"
    h2: "0x414140DE"
    h3: "0x5DAE2223"
    h4: "0xB00361A3"
    h5: "0x96177A9C"
    h6: "0xB410FF61"
    h7: "0xF20015AD"
  }
  
  padding_logic -> ctx_final: "Update H[0..7]"
}

# ---------------------------------------------------------------------------------
# DATA FLOW CONNECTIONS
# ---------------------------------------------------------------------------------

state_0_init -> state_1_update_a: "uint8_t[1] | 'a' (0x61)" {
  style: { stroke: "#007bff"; animated: true }
}

state_1_update_a -> state_2_update_bc: "uint8_t[2] | 'bc' (0x62 0x63)" {
  style: { stroke: "#007bff"; animated: true }
}

state_2_update_bc -> state_3_finalize: "Finalize Trigger" {
  style: { stroke: "#28a745"; stroke-dash: 5 }
}

digest_out: "ba7816bf8f01cfea414140de5dae2223b00361a396177a9cb410ff61f20015ad" {
  shape: code
}

state_3_finalize.ctx_final -> digest_out: "sha256_hex()"

# ---------------------------------------------------------------------------------
# LEGEND / ANNOTATIONS
# ---------------------------------------------------------------------------------

legend: {
  near: bottom-center
  
  note: |md
    **Verification:**
    The streaming process produces 
    identical `H` state to the 
    one-shot `sha256("abc")` call.
  |
}