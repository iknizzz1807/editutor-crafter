direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# L1/L2 Component Diagram: Structure Layout
sha256_context: {
  direction: down
  label: "SHA256_CTX (sha256.h)"

  # C Structure Definition
  struct_definition: {
    shape: class
    label: "struct SHA256_CTX"
    definition: |md
      c
      typedef struct {
          uint32_t H[8];           // Current hash state
          uint8_t  buf[64];        // 512-bit message buffer
          uint32_t buf_len;        // Bytes in buffer (0-63)
          uint32_t padding;        // Alignment padding
          uint64_t msg_len_bits;   // Total message bits
      } SHA256_CTX;
      
    |
  }

  # Physical Memory Layout
  memory_layout: {
    shape: sql_table
    label: "Memory Map (112 Bytes Total)"
    
    row_state: "0x00 | uint32_t[8] | H (Intermediate Hash State)"
    row_buffer: "0x20 | uint8_t[64] | buf (Partial Block Data)"
    row_buflen: "0x60 | uint32_t    | buf_len (Occupancy: 0-63)"
    row_pad: "0x64 | uint32_t    | [padding] (Alignment hole)"
    row_bitcount: "0x68 | uint64_t    | msg_len_bits (Total Bit Length)"
    
    row_state.style.fill: "#D0E1F9"
    row_buffer.style.fill: "#D0E1F9"
    row_buflen.style.fill: "#FFF2CC"
    row_bitcount.style.fill: "#E1D5E7"
    
    label_bottom: "Total: 112 bytes (Padded for uint64_t alignment)"
  }

  # Logical Field Roles
  field_roles: {
    direction: right
    
    state_role: {
      shape: text
      label: "H: Stores fractional parts of prime square roots. Updates after every 512-bit block."
    }
    
    buffer_role: {
      shape: text
      label: "buf: Staging area for chunked input. Clears when buf_len reaches 64."
    }
    
    len_role: {
      shape: text
      label: "msg_len_bits: Crucial for padding. Must support > 4GB files, hence uint64_t."
    }
  }

  # Connections
  struct_definition -> memory_layout: "Implementation Mapping"
  memory_layout.row_state -> field_roles.state_role
  memory_layout.row_buffer -> field_roles.buffer_role
  memory_layout.row_bitcount -> field_roles.len_role
}

# Annotations for Engineers
nist_note: {
  shape: rectangle
  label: "NIST FIPS 180-4 Requirement:\nThe length field must represent the\noriginal message length in bits.\nMax value: 2^64 - 1."
  style: {
    fill: "#FFF2CC"
    stroke-dash: 3
  }
  near: bottom-right
}