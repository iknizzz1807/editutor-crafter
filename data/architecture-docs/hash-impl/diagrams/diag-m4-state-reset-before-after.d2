direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# SATELLITE CONTEXT: Milestone 4 - State Management
# FILE: sha256.c / sha256.h

before: {
  label: "BUGGY IMPLEMENTATION (Missing Reset)"
  direction: down

  code_snippet: |md
    c
    // BUG: Missing sha256_init()
    // H[0..7] contains values from prev call
    sha256_update(&ctx, "abc", 3);
    sha256_finalize(&ctx, digest); 
    
  |

  stale_context: {
    shape: sql_table
    label: "struct SHA256_CTX (Memory View)"
    
    row0: "0x00 | uint32_t[8] | H[0] = 0xBA7816BF"
    row1: "0x20 | uint8_t[64] | buf = { ... }"
    row2: "0x60 | size_t      | buf_len = 0"
    row3: "0x68 | uint64_t    | total_len = 3"
    
    style: {
      stroke: red
      stroke-width: 2
    }
  }

  execution_flow: {
    shape: sequence_diagram
    round_0: Round 0 Start
    round_0 -> state: "a = H[0] (0xBA7816BF)" {
      style.stroke: red
    }
    state -> failure: "Result Diverges Immediately"
  }
  
  stale_context -> execution_flow: "Stale IV used as starting state"
}

after: {
  label: "FIXED IMPLEMENTATION (Proper Init)"
  direction: down

  code_snippet: |md
    c
    // FIX: Explicit reset
    sha256_init(&ctx); 
    sha256_update(&ctx, "abc", 3);
    sha256_finalize(&ctx, digest);
    
  |

  reset_context: {
    shape: sql_table
    label: "struct SHA256_CTX (Memory View)"
    
    row0: "0x00 | uint32_t[8] | H[0] = 0x6A09E667"
    row1: "0x20 | uint8_t[64] | buf = { 0x00... }"
    row2: "0x60 | size_t      | buf_len = 0"
    row3: "0x68 | uint64_t    | total_len = 0"
    
    style: {
      stroke: green
      stroke-width: 2
    }
  }

  execution_flow: {
    shape: sequence_diagram
    round_0: Round 0 Start
    round_0 -> state: "a = H[0] (0x6A09E667)" {
      style.stroke: green
    }
    state -> success: "Result Matches NIST Vector"
  }

  reset_context -> execution_flow: "Canonical IV used"
}

# Annotations
before -> after: "FIX: Add sha256_init() to restore nothing-up-my-sleeve constants" {
  style: {
    stroke-dash: 5
    animated: true
  }
}

legend: {
  near: bottom-center
  
  iv_note: "Standard Initial Hash Value (H[0]): 0x6A09E667" {
    shape: text
    style.font-color: blue
  }
  stale_note: "Stale H[0] from previous SHA256('abc'): 0xBA7816BF" {
    shape: text
    style.font-color: red
  }
}