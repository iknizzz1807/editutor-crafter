direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# L0 SATELLITE MAPPING
test_validation_system: {
  label: "SHA-256 Test Vector Validation Matrix (NIST FIPS 180-4)"
  direction: down

  validation_matrix: {
    shape: sql_table
    label: "struct KnownAnswerTest (validation.c)"

    "Vector ID | Test Case": "Input (Hex) | Blocks | Debug Checkpoint (H[0..1]) | Final Hash (Digest)"
    
    "vector_1": "Empty String | 0x | 1 Block | H[0]=0xE3B0C442 H[1]=0x98FC1C14 | e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
    "vector_2": "Short 'abc' | 0x616263 | 1 Block | H[0]=0xBA7816BF H[1]=0x8F01CFEA | ba7816bf8f01cfea414140de5dae2223b00361a396177a9cb410ff61f20015ad"
    "vector_3": "56-byte Bound | 0x61... (56B) | 2 Blocks | H[0]=0x85E655D6 H[1]=0x20455B60 | 248d6a61d20638b8e5c026930c3e6039a33ce45964ff2167f6ecedd419db06c1"
    
    label_bottom: "Total: 3 NIST KAT Vectors | All states are Big-Endian | 32-bit Words"
  }

  implementation_details: {
    direction: right
    
    context_state: {
      shape: class
      label: "SHA256_CTX (sha256.h)"
      fields: |`md
        c
        uint32_t H[8];          // 32 bytes | Running hash state
        uint8_t  buf[64];       // 64 bytes | Partial block buffer
        uint32_t buf_len;       // 04 bytes | [0..63] range
        uint64_t msg_len_bits;  // 08 bytes | Cumulative bit count
        
      `|
      label_bottom: "Total Size: 108 bytes"
    }

    formatting_logic: {
      label: "Digest Output Logic (sha256.c)"
      code: |`md
        c
        // Extract 4 bytes per word (Big-Endian)
        for (int i = 0; i < 8; i++) {
            digest[i*4+0] = (uint8_t)(H[i] >> 24);
            digest[i*4+1] = (uint8_t)(H[i] >> 16);
            digest[i*4+2] = (uint8_t)(H[i] >> 8);
            digest[i*4+3] = (uint8_t)(H[i]);
        }
        
      `|
    }

    context_state -> formatting_logic: "sha256_finalize()"
  }
}

# DATA WALK: VERIFYING VECTOR 3 (BOUNDARY CASE)
data_walk: {
  direction: right
  label: "Data Flow: 56-byte Boundary Case Execution"

  input_56b: "Input | 56 Bytes | 448 Bits"
  
  block_1: {
    shape: rectangle
    label: "Block 0 (Padded)"
    content: |md
      - Message: 0..55 (56 bytes)
      - Separator: [56] = 0x80
      - Padding: [57..63] = 0x00
      - Size: 64 Bytes
    |
  }

  block_2: {
    shape: rectangle
    label: "Block 1 (Final)"
    content: |md
      - Padding: 0..55 (zeros)
      - Length: [56..63] = 0x00...01C0
      - Size: 64 Bytes
    |
  }

  compress_1: "sha256_compress()"
  compress_2: "sha256_compress()"

  input_56b -> block_1: "sha256_update()"
  block_1 -> compress_1: "buf_len = 57 (triggered finalize)"
  compress_1 -> block_2: "Intermediate H loaded"
  block_2 -> compress_2: "Final state transition"
  compress_2 -> test_validation_system.validation_matrix.vector_3: "Result Match"
}

# ANNOTATIONS
test_validation_system.validation_matrix.vector_1 -> data_walk: "Padding: len <= 55" {
  style.stroke-dash: 5
}
test_validation_system.validation_matrix.vector_3 -> data_walk: "Padding: len >= 56" {
  style.stroke: blue
}