direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# GLOBAL STYLES
***.style.font: mono
# Milestones
hash-impl-m1.style.stroke: "#44C7B1"
hash-impl-m2.style.stroke: "#88DCF7"
hash-impl-m3.style.stroke: "#B5AFF6"
hash-impl-m4.style.stroke: "#DEE1EB"

# COMPONENT DEFINITIONS
input_stream: {
  shape: cylinder
  label: "Raw Input Data\n(Stream of Bytes)"
}

hash-impl-m1: {
  label: "Milestone 1: Preprocessing & Padding (pad.c)"
  direction: down

  padding_logic: {
    shape: class
    label: "sha256_pad"
    definition: |md
      c
      1. Append 0x80
      2. k zero bytes
      3. 64-bit Big-Endian Len
      
    |
  }

  padded_block: {
    shape: sql_table
    label: "struct SHA256_Block"
    row1: "0x00 | uint8_t[64] | bytes"
    label_bottom: "Total: 64 bytes (512 bits)"
  }

  padding_logic -> padded_block: "Aligned Buffer"
}

hash-impl-m2: {
  label: "Milestone 2: Message Schedule (schedule.c)"
  direction: down

  word_parsing: {
    label: "load_u32_be()"
    tooltip: "Convert 4 bytes to 1 Big-Endian uint32_t"
  }

  schedule_expansion: {
    label: "Expansion Recurrence"
    definition: |md
      c
      W[t] = σ1(W[t-2]) + W[t-7] + 
             σ0(W[t-15]) + W[t-16]
      
    |
  }

  message_schedule: {
    shape: sql_table
    label: "uint32_t W[64]"
    row0: "W[0..15]  | Raw Words"
    row1: "W[16..63] | Expanded via σ"
    label_bottom: "256 bytes total workspace"
  }

  word_parsing -> schedule_expansion -> message_schedule
}

hash-impl-m3: {
  label: "Milestone 3: Compression Function (compress.c)"
  direction: down

  working_vars: {
    shape: sql_table
    label: "Working Variables (a-h)"
    a_d: "a, b, c, d | Σ0, Maj"
    e_h: "e, f, g, h | Σ1, Ch"
  }

  round_constants: {
    shape: sql_table
    label: "static const uint32_t K[64]"
    k0: "K[0]: 0x428A2F98 (∛2)"
    k63: "K[63]: 0xC67178F2 (∛311)"
  }

  compression_loop: {
    label: "64-Round Loop"
    shape: rectangle
    style.double-border: true
    content: "T1 = h + Σ1(e) + Ch + K[t] + W[t]\nT2 = Σ0(a) + Maj"
  }

  state_update: {
    label: "H[i] = H[i-1] + WorkingVars"
    tooltip: "Merkle-Damgård Additive Chaining"
  }

  working_vars -> compression_loop
  round_constants -> compression_loop
  compression_loop -> state_update
}

hash-impl-m4: {
  label: "Milestone 4: API & Finalization (sha256.c)"
  direction: down

  context_struct: {
    shape: sql_table
    label: "struct SHA256_CTX"
    h_state: "uint32_t H[8] | Hash State"
    buffer: "uint8_t buf[64] | Partial Block"
    counts: "uint64_t msg_len | Bit Count"
  }

  hex_encoder: {
    label: "sha256_hex()"
    tooltip: "Nibble-to-ASCII conversion"
  }

  final_digest: {
    shape: rectangle
    label: "256-bit Digest\n(64-char Hex String)"
    style.fill: "#ACE1AF"
  }

  context_struct -> hex_encoder -> final_digest
}

# DATA FLOW CONNECTIONS
input_stream -> hash-impl-m1.padding_logic: "Raw Bytes | size_t"
hash-impl-m1.padded_block -> hash-impl-m2.word_parsing: "512-bit Block | void*"
hash-impl-m2.message_schedule -> hash-impl-m3.compression_loop: "W[t] | 4 bytes/round"
hash-impl-m4.context_struct -> hash-impl-m3.working_vars: "Load H[0..7]"
hash-impl-m3.state_update -> hash-impl-m4.context_struct: "Store updated H"

# ANNOTATIONS
hash-impl-m1 -> hash-impl-m4: "Streaming State Management" {
  style.stroke-dash: 5
}

# LEGEND/INFO
legend: {
  near: bottom-right
  m1: Milestone 1: Padding {style.fill: "#44C7B1"}
  m2: Milestone 2: Schedule {style.fill: "#88DCF7"}
  m3: Milestone 3: Compression {style.fill: "#B5AFF6"}
  m4: Milestone 4: Finalization {style.fill: "#DEE1EB"}
}