layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

# Module Architecture: Milestone 2 (Message Schedule)
m2_schedule: "Module: sha256_schedule" {
  tooltip: "Expands 512-bit block into 64-word schedule"
  style: {
    stroke: "#333333"
    stroke-width: 2
    fill: "#f8f9fa"
  }

  # Layer 3: Public API
  api_layer: "Public Interface" {
    msg_sched: "sha256_message_schedule" {
      shape: class
      # Method signature format: method(params): return
      "sha256_message_schedule(const SHA256_Block *block, uint32_t W[64])": void
    }
  }

  # Layer 2: Internal Logic
  logic_layer: "Internal Orchestration" {
    init: "sha256_schedule_init" {
      shape: class
      "sha256_schedule_init(const SHA256_Block *block, uint32_t W[64])": static void
    }
    expand: "sha256_schedule_expand" {
      shape: class
      "sha256_schedule_expand(uint32_t W[64])": static void
    }
  }

  # Layer 1: Bit-Mixing Primitives
  primitive_layer: "Bit-Mixing Primitives" {
    rotr: "rotr32" {
      shape: class
      "rotr32(uint32_t x, uint32_t n)": static inline uint32_t
    }
    load_be: "load_u32_be" {
      shape: class
      "load_u32_be(const uint8_t *p)": static inline uint32_t
    }
    s0: "sigma0" {
      shape: class
      "sigma0(uint32_t x)": static uint32_t
    }
    s1: "sigma1" {
      shape: class
      "sigma1(uint32_t x)": static uint32_t
    }
  }

  # Architectural Ownership (Solid Arrows)
  api_layer.style.stroke-width: 2
  logic_layer.style.stroke-width: 2
  primitive_layer.style.stroke-width: 2

  # Dependencies / Calls (Dashed Arrows)
  api_layer.msg_sched -> logic_layer.init: "1. Parse Block" {style.stroke-dash: 3}
  api_layer.msg_sched -> logic_layer.expand: "2. Recurrence" {style.stroke-dash: 3}

  logic_layer.init -> primitive_layer.load_be: "BE_To_Native" {style.stroke-dash: 3}
  
  logic_layer.expand -> primitive_layer.s0: "W[t-15]" {style.stroke-dash: 3}
  logic_layer.expand -> primitive_layer.s1: "W[t-2]" {style.stroke-dash: 3}
  logic_layer.expand -> primitive_layer.rotr: "direct mixing" {style.stroke-dash: 3}

  primitive_layer.s0 -> primitive_layer.rotr: "mix" {style.stroke-dash: 3}
  primitive_layer.s1 -> primitive_layer.rotr: "mix" {style.stroke-dash: 3}
}

# Memory Annotations
storage_ann: |md
  ### Output Storage (W Array)
  - **Type**: `uint32_t[64]`
  - **sizeof**: 256 bytes (4 cache lines)
  - **Scope**: Internal Workspace
| {
  near: top-right
}

input_ann: |md
  ### Input Structure (block)
  - **Type**: `SHA256_Block*`
  - **sizeof**: 64 bytes (one cache line)
| {
  near: bottom-right
}

# Style overrides (Intel-spec alignment)
m2_schedule.api_layer.msg_sched.style.fill: "#E1BEE7" # Purple (Header/API)
m2_schedule.primitive_layer.s0.style.fill: "#B3E5FC" # Blue (Data/Logic)
m2_schedule.primitive_layer.s1.style.fill: "#B3E5FC"
m2_schedule.primitive_layer.load_be.style.fill: "#B3E5FC"
m2_schedule.primitive_layer.rotr.style.fill: "#FFCC80" # Orange (Pointers/Utilities)