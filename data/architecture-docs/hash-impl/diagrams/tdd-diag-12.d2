direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

sha256_ch: "SHA-256 Choice Function: Ch(e, f, g)" {
  style: {
    stroke: "#6a1b9a"
    stroke-width: 4
  }

  truth_table: "Bit-level Truth Table" {
    grid-columns: 4
    grid-gap: 0
    
    style: {
      fill: "#f3e5f5"
    }

    # Headers
    h1: "**e**" { style: { fill: "#ce93d8"; bold: true } }
    h2: "**f**" { style: { fill: "#ce93d8"; bold: true } }
    h3: "**g**" { style: { fill: "#ce93d8"; bold: true } }
    h4: "**Out**" { style: { fill: "#ce93d8"; bold: true } }

    # e=0 rows (Selects g)
    r1c1: "0"; r1c2: "0"; r1c3: "0"; r1out: "**0**" { style: { font-color: red } }
    r2c1: "0"; r2c2: "0"; r2c3: "1"; r2out: "**1**" { style: { font-color: red } }
    r3c1: "0"; r3c2: "1"; r3c3: "0"; r3out: "**0**" { style: { font-color: red } }
    r4c1: "0"; r4c2: "1"; r4c3: "1"; r4out: "**1**" { style: { font-color: red } }

    # e=1 rows (Selects f)
    r5c1: "1"; r5c2: "0"; r5c3: "0"; r5out: "**0**" { style: { font-color: red } }
    r6c1: "1"; r6c2: "0"; r6c3: "1"; r6out: "**0**" { style: { font-color: red } }
    r7c1: "1"; r7c2: "1"; r7c3: "0"; r7out: "**1**" { style: { font-color: red } }
    r8c1: "1"; r8c2: "1"; r8c3: "1"; r8out: "**1**" { style: { font-color: red } }
    
    legend: |md
      **Logic:**
      IF e == 1 THEN f
      ELSE g
    | {
      shape: text
    }
  }

  mux: "32-bit Parallel Multiplexer" {
    style.fill: "#e3f2fd"
    
    registers: {
      direction: down
      e_reg: "e (Control)" {
        grid-columns: 32; grid-gap: 2
        style.fill: white
        b0: " "; b1: " "; b2: " "; b3: " "; b4: " "; b5: " "; b6: " "; b7: " "; b8: " "; b9: " "; b10: " "; b11: " "; b12: " "; b13: " "; b14: " "; b15: " "
        b16: " "
        b17: "**1**" { style: { fill: "#ffcdd2"; bold: true } }
        b18: " "; b19: " "; b20: " "; b21: " "; b22: " "; b23: " "; b24: " "; b25: " "; b26: " "; b27: " "; b28: " "; b29: " "; b30: " "; b31: " "
      }
      f_reg: "f (Input A)" {
        grid-columns: 32; grid-gap: 2
        style.fill: white
        b0: " "; b1: " "; b2: " "; b3: " "; b4: " "; b5: " "; b6: " "; b7: " "; b8: " "; b9: " "; b10: " "; b11: " "; b12: " "; b13: " "; b14: " "; b15: " "
        b16: " "
        b17: "**f₁₇**" { style: { fill: "#bbdefb"; bold: true } }
        b18: " "; b19: " "; b20: " "; b21: " "; b22: " "; b23: " "; b24: " "; b25: " "; b26: " "; b27: " "; b28: " "; b29: " "; b30: " "; b31: " "
      }
      g_reg: "g (Input B)" {
        grid-columns: 32; grid-gap: 2
        style.fill: white
        b0: " "; b1: " "; b2: " "; b3: " "; b4: " "; b5: " "; b6: " "; b7: " "; b8: " "; b9: " "; b10: " "; b11: " "; b12: " "; b13: " "; b14: " "; b15: " "
        b16: " "
        b17: "g₁₇"
        b18: " "; b19: " "; b20: " "; b21: " "; b22: " "; b23: " "; b24: " "; b25: " "; b26: " "; b27: " "; b28: " "; b29: " "; b30: " "; b31: " "
      }
      out_reg: "Output (Ch)" {
        grid-columns: 32; grid-gap: 2
        style.fill: "#c8e6c9"
        b0: " "; b1: " "; b2: " "; b3: " "; b4: " "; b5: " "; b6: " "; b7: " "; b8: " "; b9: " "; b10: " "; b11: " "; b12: " "; b13: " "; b14: " "; b15: " "
        b16: " "
        b17: "**f₁₇**" { style: { fill: "#bbdefb"; bold: true; font-color: red } }
        b18: " "; b19: " "; b20: " "; b21: " "; b22: " "; b23: " "; b24: " "; b25: " "; b26: " "; b27: " "; b28: " "; b29: " "; b30: " "; b31: " "
      }
    }

    zoom: "Bit 17 Logic Detail" {
      style.stroke-dash: 3
      
      gate: "MUX" {
        shape: parallelogram
        style.fill: "#fff9c4"
      }
      
      e_ctrl: "e₁₇ = 1"
      f_in: "f₁₇"
      g_in: "g₁₇"
      out_val: "**f₁₇**" { style: { bold: true; font-color: red } }

      e_ctrl -> gate
      f_in -> gate
      g_in -> gate
      gate -> out_val
    }
    
    registers.e_reg.b17 -- zoom.e_ctrl: "zoom" { style: { stroke-dash: 5; stroke: gray } }
  }

  formulas: "Implementation Efficiency" {
    standard: |md
      ### FIPS 180-4 Standard
      `Ch(e,f,g) = (e & f) ^ (~e & g)`
      *   1x AND (e&f)
      *   1x NOT (~e)
      *   1x AND (~e&g)
      *   1x XOR (combine)
      **Total: 4 Ops**
    | {
      shape: rectangle
      style: { fill: white; border-radius: 5 }
    }

    optimized: |md
      ### Modern Optimized
      `Ch(e,f,g) = g ^ (e & (f ^ g))`
      *   1x XOR (f^g)
      *   1x AND (e&...)
      *   1x XOR (g^...)
      **Total: 3 Ops**
    | {
      shape: rectangle
      style: { fill: "#e8f5e9"; border-radius: 5; double-border: true }
    }
  }

  truth_table -> mux: "applies to each bit"
  mux -> formulas: "mapping to C code"
}