direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- SHA-256 COMPRESSION ROUND t ---
# Specification: FIPS 180-4 Section 6.2.2
# sizeof = 32 bytes (8 x 32-bit registers)

INPUT_REGS: "WORKING VARIABLES (Round t)" {
  grid-columns: 8
  style.stroke-width: 2
  
  a: "a" { style.fill: "#e7f3ff"; style.stroke: "#0366d6"; tooltip: "32-bit word" }
  b: "b" { style.fill: "#e7f3ff"; style.stroke: "#0366d6" }
  c: "c" { style.fill: "#e7f3ff"; style.stroke: "#0366d6" }
  d: "d" { style.fill: "#e7f3ff"; style.stroke: "#0366d6" }
  e: "e" { style.fill: "#e7f3ff"; style.stroke: "#0366d6" }
  f: "f" { style.fill: "#e7f3ff"; style.stroke: "#0366d6" }
  g: "g" { style.fill: "#e7f3ff"; style.stroke: "#0366d6" }
  h: "h" { style.fill: "#e7f3ff"; style.stroke: "#0366d6" }
}

CONSTANTS: "ROUND INPUTS" {
  kt: "K[t]" { 
    shape: cylinder
    style.fill: "#fff5e6"
    style.stroke: "#f66a0a"
    tooltip: "Round Constant (Cube root of prime)"
  }
  wt: "W[t]" { 
    shape: cylinder
    style.fill: "#fff5e6"
    style.stroke: "#f66a0a"
    tooltip: "Message Schedule Word"
  }
}

LOGIC_GATES: "TRANSFORMATION FUNCTIONS" {
  style.stroke-dash: 3
  
  sigma0: "Σ0" {
    tooltip: "ROTR(a,2) ^ ROTR(a,13) ^ ROTR(a,22)"
    style.fill: "#f3e8ff"
    style.stroke: "#6e42c1"
  }
  maj: "Maj" {
    tooltip: "(a & b) ^ (a & c) ^ (b & c)"
    style.fill: "#f3e8ff"
    style.stroke: "#6e42c1"
  }
  sigma1: "Σ1" {
    tooltip: "ROTR(e,6) ^ ROTR(e,11) ^ ROTR(e,25)"
    style.fill: "#f3e8ff"
    style.stroke: "#6e42c1"
  }
  ch: "Ch" {
    tooltip: "(e & f) ^ (~e & g)"
    style.fill: "#f3e8ff"
    style.stroke: "#6e42c1"
  }
}

SUM_T1: "Σ(+)" { shape: circle; style.fill: "#d1fadf" }
SUM_T2: "Σ(+)" { shape: circle; style.fill: "#d1fadf" }
SUM_A: "Σ(+)" { shape: circle; style.fill: "#d1fadf" }
SUM_E: "Σ(+)" { shape: circle; style.fill: "#d1fadf" }

# --- Data Flow ---

INPUT_REGS.a -> LOGIC_GATES.sigma0
INPUT_REGS.a -> LOGIC_GATES.maj
INPUT_REGS.b -> LOGIC_GATES.maj
INPUT_REGS.c -> LOGIC_GATES.maj

INPUT_REGS.e -> LOGIC_GATES.sigma1
INPUT_REGS.e -> LOGIC_GATES.ch
INPUT_REGS.f -> LOGIC_GATES.ch
INPUT_REGS.g -> LOGIC_GATES.ch

LOGIC_GATES.sigma0 -> SUM_T2
LOGIC_GATES.maj -> SUM_T2: "T2"

INPUT_REGS.h -> SUM_T1
LOGIC_GATES.sigma1 -> SUM_T1
LOGIC_GATES.ch -> SUM_T1
CONSTANTS.kt -> SUM_T1
CONSTANTS.wt -> SUM_T1: "T1"

SUM_T1 -> SUM_A
SUM_T2 -> SUM_A

INPUT_REGS.d -> SUM_E
SUM_T1 -> SUM_E

# --- Output Assignments (The Shift) ---

OUTPUT_REGS: "WORKING VARIABLES (Round t+1)" {
  grid-columns: 8
  style.fill: "#f8f9fa"
  style.stroke-width: 2

  a_n: "a'" { style.fill: "#e7f3ff"; style.bold: true; style.stroke-width: 3 }
  b_n: "b'" { style.fill: "#e7f3ff" }
  c_n: "c'" { style.fill: "#e7f3ff" }
  d_n: "d'" { style.fill: "#e7f3ff" }
  e_n: "e'" { style.fill: "#e7f3ff"; style.bold: true; style.stroke-width: 3 }
  f_n: "f'" { style.fill: "#e7f3ff" }
  g_n: "g'" { style.fill: "#e7f3ff" }
  h_n: "h'" { style.fill: "#e7f3ff" }
}

SUM_A -> OUTPUT_REGS.a_n: "T1 + T2" { style.stroke: "#0366d6" }
INPUT_REGS.a -> OUTPUT_REGS.b_n
INPUT_REGS.b -> OUTPUT_REGS.c_n
INPUT_REGS.c -> OUTPUT_REGS.d_n
SUM_E -> OUTPUT_REGS.e_n: "d + T1" { style.stroke: "#0366d6" }
INPUT_REGS.e -> OUTPUT_REGS.f_n
INPUT_REGS.f -> OUTPUT_REGS.g_n
INPUT_REGS.g -> OUTPUT_REGS.h_n

# --- Annotations ---
annotation: |md
  ### SHA-256 COMPRESSION CORE
  **State Update Logic:**
  - $T_1 = h + \Sigma_1(e) + Ch(e,f,g) + K_t + W_t$
  - $T_2 = \Sigma_0(a) + Maj(a,b,c)$
  - $a_{t+1} = T_1 + T_2$
  - $e_{t+1} = d + T_1$
  
  **Registers:** 8 x 32-bit (unsigned)
  **Arithmetic:** Addition mod $2^{32}$
  **Size:** 256 bits (32 bytes)
| {near: bottom-center}