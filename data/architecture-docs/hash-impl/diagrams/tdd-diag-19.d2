direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

title: |md
  ### K Constants Derivation
  *Nothing-up-my-sleeve numbers based on NIST FIPS 180-4 Section 4.2.2*
| {
  near: top-center
  shape: text
}

derivation_formula: {
  shape: rectangle
  style: {
    fill: "#f8f9fa"
    stroke-dash: 3
  }
  label: |md
    **Mathematical Definition**
    $K_t = \lfloor 2^{32} \cdot (\sqrt[3]{p_t} \pmod 1) \rfloor$
    
    **Python Verification**
    python
    def get_k(p):
        return int((p**(1/3) % 1) * 2**32)
    
    *"Verifiable by any calculator — no backdoor possible"*
  |
}

process: {
  grid-columns: 3
  grid-gap: 50

  k0: {
    label: "Constant K[0]"
    prime: "Prime p = 2" {
      style.fill: "#e7f3ff"
    }
    cbrt: "∛2 = 1.259921049..."
    frac: "Fractional = 0.259921049..."
    scale: "× 2^32 = 1116352408.49..."
    hex: "**0x428A2F98**" {
      style.fill: "#d4edda"
      style.font-color: "#155724"
    }

    prime -> cbrt -> frac -> scale -> hex
  }

  k1: {
    label: "Constant K[1]"
    prime: "Prime p = 3" {
      style.fill: "#e7f3ff"
    }
    cbrt: "∛3 = 1.442249570..."
    frac: "Fractional = 0.442249570..."
    scale: "× 2^32 = 1899451281.42..."
    hex: "**0x71374491**" {
      style.fill: "#d4edda"
      style.font-color: "#155724"
    }

    prime -> cbrt -> frac -> scale -> hex
  }

  k63: {
    label: "Constant K[63]"
    prime: "64th Prime p = 311" {
      style.fill: "#e7f3ff"
    }
    cbrt: "∛311 = 6.7753406..."
    frac: "Fractional = 0.7753406..."
    scale: "× 2^32 = 3330386162.91..."
    hex: "**0xC67178F2**" {
      style.fill: "#d4edda"
      style.font-color: "#155724"
    }

    prime -> cbrt -> frac -> scale -> hex
  }
}

derivation_formula -> process.k0.prime: "Apply to first 64 primes" {
  style.stroke-dash: 5
}

legend: {
  near: bottom-right
  step1: "1. Select Prime" { shape: text; style.font-color: "#007bff" }
  step2: "2. Calculate Cube Root" { shape: text }
  step3: "3. Extract Modulo 1.0" { shape: text }
  step4: "4. Scale to 32-bit Space" { shape: text }
  step5: "5. Truncate to Integer" { shape: text; style.font-color: "#28a745" }
}