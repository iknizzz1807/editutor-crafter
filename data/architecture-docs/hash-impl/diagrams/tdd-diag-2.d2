layout-engine: elk
vars: {
  d2-config: {
    theme-id: 0
    pad: 20
  }
}

# 1. Message Source
msg_source: "Raw Input Message" {
  shape: cylinder
  style.fill: "#dae8fc" # Blue (Data)
}

# 2. sha256_pad Implementation Logic
sha256_pad: "sha256_pad(out, msg, msg_len)" {
  style.stroke-width: 2

  # Internal Logic Steps
  step1: "1. memcpy(out, msg, msg_len)" {
    style.stroke-dash: 3
  }
  step2: "2. out[msg_len] = 0x80" {
    style.stroke-dash: 3
  }
  step3: "3. memset(out + msg_len + 1, 0, Z)" {
    style.stroke-dash: 3
  }
  step4: "4. write_uint64_be(out + total - 8, L)" {
    style.stroke-dash: 3
  }

  # The Physical Buffer Result - Intel Manual Byte Alignment Quality
  padded_buffer: "Padded Memory Layout" {
    grid-columns: 1
    grid-gap: 0
    
    # [Offset] | [Field] | [Size]
    buf_msg: "0x00 | Message Data | msg_len bytes" {
      style.fill: "#dae8fc" # Blue (Data)
    }
    buf_sentinel: "msg_len | 0x80 Sentinel | 1 byte" {
      style.fill: "#e1d5e7" # Purple (Header/Sentinel)
    }
    buf_padding: "... | 0x00 Padding (Z) | total - msg_len - 9 bytes" {
      style.fill: "#f5f5f5" # Gray (Padding)
      style.stroke-dash: 5
    }
    buf_length: "total-8 | Bit Length (L) | 8 bytes" {
      style.fill: "#ffe6cc" # Orange (Pointers/Length)
      style.bold: true
    }
  }
}

# Moved to Root level to fix 'near' constant and special object restrictions
total_size_box: "Total: N * 64 Bytes" {
  near: bottom-right
  shape: text
  style.italic: true
}

# State Calculations - Fixed by using constant 'top-right' for ELK compatibility
calc: |md
  ### Preprocessing Formulas
  - **L (Bits)**: `msg_len * 8`
  - **Total Size**: `((msg_len + 9 + 63) / 64) * 64`
  - **Zero Fill (Z)**: Smallest `k` s.t. `(L + 1 + k) â‰¡ 448 (mod 512)`
| {
  near: top-right
}

# 3. Block Accessor Logic
accessor: "sha256_get_block(padded, idx)" {
  shape: parallelogram
  style.fill: "#d5e8d4" # Green (Free/Reference)
}

# Data Flow Connections
msg_source -> sha256_pad.step1: "const uint8_t*"
sha256_pad.step1 -> sha256_pad.padded_buffer.buf_msg: "Copy bytes [0..msg_len-1]"
sha256_pad.step2 -> sha256_pad.padded_buffer.buf_sentinel: "Write 0x80 at msg_len"
sha256_pad.step3 -> sha256_pad.padded_buffer.buf_padding: "Fill Z bytes"
sha256_pad.step4 -> sha256_pad.padded_buffer.buf_length: "Write BE-uint64"

sha256_pad.padded_buffer -> accessor: "uint8_t *padded"
accessor -> block_ptr: "return padded + (idx * 64)"

block_ptr: "Target 512-bit Block" {
  shape: package
  style.stroke: orange
  style.stroke-width: 4
}

# Legend/Footer - Ensuring root level for constant near
footer: |md
  **Memory Invariant**: Base Address % 64 == 0 (Cache Aligned)
  **Growth**: Sequential memory addresses (0x00 -> total)
| {
  near: bottom-center
}