direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# Participants representing the core streaming entities
DataPtr: "Data Pointer\n(Input Stream)" {
  shape: person
  style.stroke: orange
}

CtxBuf: "Internal Buffer\n(64 Bytes)" {
  style.fill: "#B3E5FC"
  style.stroke: "#01579B"
}

HState: "Hash State (H)\n(256-bit)" {
  style.fill: "#E1BEE7"
  style.stroke: "#4A148C"
}

# Define the sequence logic
sha256_stream: {
  shape: sequence_diagram

  # Ensure participants are correctly ordered in the sequence layout
  DataPtr; CtxBuf; HState

  # Milestone 4 Lifecycle
  
  Initialization: {
    HState."H[0..7] = H_INIT"
    CtxBuf."buf_len = 0"
    DataPtr."msg_len_bits = 0"
  }

  Update_Chunk_1: "sha256_update(100 bytes)" {
    DataPtr."msg_len_bits += 800"
    
    Phase_1_Skip: {
      DataPtr -> CtxBuf: "Check buf_len == 0"
      CtxBuf."Phase 1: Skipped"
    }

    Phase_2_Bulk: {
      DataPtr -> HState: "sha256_compress(bytes 0..63)" {
        style.stroke: blue
        style.stroke-width: 4
      }
      HState."H state updated; data pointer += 64"
    }

    Phase_3_Remainder: {
      DataPtr -> CtxBuf: "memcpy(bytes 64..99)" {
        style.stroke-dash: 3
      }
      CtxBuf."buf_len = 36"
    }
  }

  Update_Chunk_2: "sha256_update(another 100 bytes)" {
    DataPtr."msg_len_bits += 800 (Total: 1600)"

    Phase_1_Fill: {
      DataPtr -> CtxBuf: "fill: copy 28 bytes (100..127)"
      CtxBuf."buf_len = 64"
      CtxBuf -> HState: "sha256_compress(buf: bytes 64..127)" {
        style.stroke: blue
      }
      CtxBuf."buf_len = 0"
    }

    Phase_2_Bulk: {
      DataPtr -> HState: "sha256_compress(bytes 128..191)" {
        style.stroke: blue
        style.stroke-width: 4
      }
    }

    Phase_3_Remainder: {
      DataPtr -> CtxBuf: "memcpy(bytes 192..199)"
      CtxBuf."buf_len = 8"
    }
  }

  Finalization: "sha256_finalize()" {
    Padding_Logic: {
      CtxBuf."buf[8] = 0x80"
      CtxBuf."buf_len = 9 (<= 56)"
      CtxBuf."memset(buf[9..55], 0x00)"
      CtxBuf."write_be64(buf[56..63], 1600)"
    }

    Final_Compression: {
      CtxBuf -> HState: "sha256_compress(final padding block)" {
        style.stroke: blue
        style.stroke-width: 4
      }
    }

    Output: {
      HState -> DataPtr: "Return Digest[32] (Big-Endian)" {
        style.stroke: orange
        target-arrowhead.shape: diamond
      }
    }
  }
}

# Legend/Annotation - Fixed 'near' for ELK engine
Annotation: |md
  ### SHA-256 Streaming Trace
  - **Msg Size**: 200 Bytes (1600 bits)
  - **Chunk Size**: 100 Bytes
  - **Block A**: Bytes 0..63 (Direct Compress)
  - **Block B**: Bytes 64..127 (Buffer Fill + Compress)
  - **Block C**: Bytes 128..191 (Direct Compress)
  - **Block D**: Bytes 192..199 + Padding (Finalize Compress)
| {
  near: bottom-center
}