layout-engine: elk
theme-id: 4
direction: down

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  ### SHA-256 FINAL OUTPUT ENCODING
  **H[0..7] to Hex Digest â€” Nibble Extraction and Lookup**
| {near: top-center}

# --- Internal State ---
state: {
  label: "Internal 256-bit State (H)"
  # Header Color: Purple
  h0: "H[0]: 0xBA7816BF" {
    style: {
      fill: "#B5AFF6"
      stroke-width: 2
      bold: true
    }
  }
  h1: "H[1]"
  h2: "H[2]"
  h3: "H[3]"
  h4: "H[4]"
  h5: "H[5]"
  h6: "H[6]"
  h7: "H[7]"
  # Inactive State: Gray Padding
  h1; h2; h3; h4; h5; h6; h7: { style.fill: "#DEE1EB" }
}

# --- Processing Byte 0 ---
processing: {
  label: "Logic for Byte 0 (0xBA)"
  
  # Data Color: Blue
  byte_reg: "Byte[0]: 1011 1010 (0xBA)" {
    shape: rectangle
    style.fill: "#C7F1FF"
  }

  extraction: {
    grid-columns: 2
    
    # Pointers/Extraction: Orange
    high: "High Nibble\n(byte >> 4) & 0x0F" {
      style.stroke: "#F4A261"
    }
    low: "Low Nibble\nbyte & 0x0F" {
      style.stroke: "#F4A261"
    }
    
    # Changes: Red + Bold
    high_val: "Value: 11 (0xB)" {
      style.font: mono
      style.stroke: red
      style.font-color: red
      style.bold: true
    }
    low_val: "Value: 10 (0xA)" {
      style.font: mono
      style.stroke: red
      style.font-color: red
      style.bold: true
    }
    
    high -> high_val
    low -> low_val
  }
  
  byte_reg -> extraction.high
  byte_reg -> extraction.low
}

# --- Mapping Table ---
table: {
  label: "hex_chars[] lookup table"
  grid-columns: 8
  
  0: "0"; 1: "1"; 2: "2"; 3: "3"; 4: "4"; 5: "5"; 6: "6"; 7: "7"
  8: "8"; 9: "9"
  # Hit: Green
  10: "a" { style.fill: "#ACE1AF"; style.bold: true }
  11: "b" { style.fill: "#ACE1AF"; style.bold: true }
  12: "c"; 13: "d"; 14: "e"; 15: "f"
  
  *: { style.font: mono }
}

# --- Destination Buffer ---
output: {
  label: "char hex[65] (C-String Output)"
  
  hex_array: {
    shape: sql_table
    style.fill: "#C7F1FF"
    
    # Changes: Red + Bold
    idx0: "hex[0]: 'b'" { style.stroke: red; style.font-color: red; style.bold: true }
    idx1: "hex[1]: 'a'" { style.stroke: red; style.font-color: red; style.bold: true }
    idx2: "hex[2]: '7'"
    idx3: "hex[3]: '8'"
    idx4: "hex[4]: '1'"
    idx5: "hex[5]: '6'"
    idx6: "hex[6]: 'b'"
    idx7: "hex[7]: 'f'"
    # Padding/Null: Gray
    trunc: "... (idx 8..63) ..." { style.fill: "#DEE1EB" }
    null_ptr: "hex[64]: '\\0'" {
      style: {
        fill: "#DEE1EB"
        font-color: red
        bold: true
      }
    }
  }
}

# --- Data Flow Connections (Orange Pointers) ---
state.h0 -> processing.byte_reg: "Select Byte 0" { style.stroke: "#F4A261" }

processing.extraction.high_val -> table.11: "Index 11" {
  style.stroke: "#F4A261"
}
processing.extraction.low_val -> table.10: "Index 10" {
  style.stroke: "#F4A261"
}

table.11 -> output.hex_array.idx0: "Store 'b'" { style.stroke: "#F4A261" }
table.10 -> output.hex_array.idx1: "Store 'a'" { style.stroke: "#F4A261" }

# --- Annotations ---
# FIX: 'near' is now a constant value for compatibility with ELK engine
notes: |md
  ### Implementation Constraints
  1. **Big-Endian State**: H[0] is processed MSB (Byte 0) to LSB (Byte 3).
  2. **Lowercase**: FIPS 180-4 standard uses lowercase hex `abcdef`.
  3. **Null Termination**: `hex[64]` must be `0x00` for C-string compatibility.
| {
  near: bottom-center
  style.stroke-dash: 3
}