layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
    layout-engine: elk
  }
}

sha256_pipeline: {
  shape: sequence_diagram
  
  caller: "Application Caller\n(USER_PROC)" {
    shape: person
  }
  api_init: "sha256_init\n(M4_API)"
  api_update: "sha256_update\n(M4_API)"
  api_final: "sha256_finalize\n(M4_API)"
  engine_comp: "sha256_compress\n(M3_ENGINE)"
  engine_sched: "sha256_message_schedule\n(M2_SCHED)"

  # 1. Initialization Phase
  caller -> api_init: "sha256_init(ctx: *SHA256_CTX) -> void"
  api_init -> api_init: "ctx->H[0..7] = H_INIT\nctx->buf_len = 0\nctx->msg_len_bits = 0"
  api_init -> caller: "void"

  # 2. Update Phase
  caller -> api_update: "sha256_update(ctx, data, len) -> void"
  api_update -> api_update: "ctx->msg_len_bits += (len << 3)"
  
  api_update."**Processing Logic**\nRepeat while input >= 64B"

  api_update -> engine_comp: "sha256_compress(ctx->H, block, W[64])" {
    source-arrowhead.label: "▼ Lock H"
    style.stroke: "#2962ff"
  }
  
  engine_comp -> engine_sched: "sha256_message_schedule(block, W)"
  engine_sched -> engine_sched: "W[0..15] = load_u32_be(block)"
  engine_sched -> engine_sched: "W[16..63] = Expansion (σ1, σ0)"
  engine_sched -> engine_comp: "W[0..63] ready"
  
  engine_comp -> engine_comp: "Initialize a..h = ctx->H[0..7]"
  engine_comp -> engine_comp: "Loop 64 rounds:\nCompression Function"
  engine_comp -> engine_comp: "Feed-forward:\nctx->H[i] += working_var[i]"
  
  engine_comp -> api_update: "void" {
    target-arrowhead.label: "▲ Release H"
    style.stroke: "#2962ff"
  }
  
  api_update -> api_update: "Buffer remaining < 64 bytes"
  api_update -> caller: "void"

  # 3. Finalization Phase
  caller -> api_final: "sha256_finalize(ctx, digest[32]) -> void"
  api_final -> api_final: "Append 0x80 to buf"
  api_final -> api_final: "Conditional Pad (If buf_len > 56)"
  api_final -> api_final: "Write msg_len_bits (BE) to buf[56..63]"
  
  api_final -> engine_comp: "sha256_compress(ctx->H, last_block, W)"
  engine_comp -> engine_sched: "sha256_message_schedule(...)"
  engine_sched -> engine_comp: "W ready"
  engine_comp -> engine_comp: "Final Round"
  engine_comp -> api_final: "H[0..7] Finalized"
  
  api_final -> api_final: "digest[0..31] = encode_be(H[0..7])"
  
  api_final -> api_final: "secure_memzero(ctx)" {
    style.stroke: red
    style.font-color: red
  }
  api_final -> caller: "binary_digest[32]"
}

annotations: |md
  ### SHA-256 Pipeline Metadata
  - **Layout Engine**: `ELK` (Deterministic Routing)
  - **sha256_compress**: 100% Constant-time (No branching on H or W)
  - **W Workspace**: 256 bytes, stack-allocated
  - **Buffer**: 64-byte alignment mandatory for M3 module
| {
  near: bottom-center
}