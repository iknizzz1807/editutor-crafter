direction: up
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- STYLING CLASSES ---
classes: {
  milestone: {
    style: {
      stroke-width: 2
      border-radius: 8
    }
  }
  function_block: {
    shape: rectangle
    style: {
      fill: "#f8f9fa"
      stroke: "#212529"
    }
  }
  data_structure: {
    shape: sql_table
    style: {
      fill: "#e7f3ff"
      stroke: "#0366d6"
    }
  }
}

# --- NIST KAT HARNESS ---
nist_harness: "NIST KAT Test Harness" {
  style.fill: "#fff3cd"
  style.stroke: "#856404"
  vectors: |md
    ### Validation Targets
    - **Empty Set**: "" (0 bits)
    - **Single Block**: "abc" (24 bits)
    - **Boundary**: 56-char (448 bits)
  |
}

# --- LAYER 4: FINAL HASH & API ---
M4: "Milestone 4: Final Hash & API" {
  class: milestone
  style.stroke: "#6f42c1"

  SHA256_CTX: {
    shape: class
    label: "struct SHA256_CTX"
    h: "uint32_t[8] (32B) | offset=0"
    buf: "uint8_t[64] (64B) | offset=32"
    buf_len: "uint32_t (4B) | offset=96"
    msg_len: "uint64_t (8B) | offset=104"
    size: "sizeof=112 bytes"
    style.fill: "#e7f3ff"
  }

  API: {
    shape: class
    label: "Public Streaming API"
    sha256_init: "+ sha256_init(ctx: *SHA256_CTX): void"
    sha256_update: "+ sha256_update(ctx: *SHA256_CTX, data: *uint8_t, len: size_t): void"
    sha256_finalize: "+ sha256_finalize(ctx: *SHA256_CTX, out: *uint8_t): void"
    sha256_hex: "+ sha256_hex(digest: *uint8_t, str: *char): void"
    sha256: "+ sha256(data: *uint8_t, len: size_t, out: *uint8_t): void"
    style.fill: "#f8f9fa"
  }
}

# --- LAYER 3: COMPRESSION ---
M3: "Milestone 3: Compression Engine" {
  class: milestone
  style.stroke: "#0366d6"

  compression: {
    shape: class
    label: "sha256_compress"
    sha256_compress: "+ sha256_compress(H: uint32_t[8], block: *SHA256_Block, W: uint32_t[64]): void"
    logic: "Core Grinding Logic"
    style.fill: "#f8f9fa"
  }

  primitives: {
    shape: class
    label: "Bitwise Nonlinear Ops"
    ch: "ch(x, y, z): (x & y) ^ (~x & z)"
    maj: "maj(x, y, z): (x & y) ^ (x & z) ^ (y & z)"
    Sigma0: "Sigma0(x): ROTR(x,2) ^ ROTR(x,13) ^ ROTR(x,22)"
    Sigma1: "Sigma1(x): ROTR(x,6) ^ ROTR(x,11) ^ ROTR(x,25)"
    style.fill: "#f8f9fa"
  }

  constants: {
    shape: class
    label: "Fixed Constants"
    K: "K[64]: ∛(primes) frac"
    H_INIT: "H_INIT[8]: √(primes) frac"
    style.fill: "#f8f9fa"
  }
}

# --- LAYER 2: MESSAGE SCHEDULE ---
M2: "Milestone 2: Message Schedule" {
  class: milestone
  style.stroke: "#28a745"

  schedule: {
    shape: class
    label: "sha256_message_schedule"
    sha256_message_schedule: "+ sha256_message_schedule(block: *SHA256_Block, W: uint32_t[64]): void"
    recurrence: "W[t] = σ1(W[t-2]) + W[t-7] + σ0(W[t-15]) + W[t-16]"
    style.fill: "#f8f9fa"
  }

  mixing: {
    shape: class
    label: "Diffusion Helpers"
    sigma0: "sigma0(x): ROTR(x,7) ^ ROTR(x,18) ^ (x >> 3)"
    sigma1: "sigma1(x): ROTR(x,17) ^ ROTR(x,19) ^ (x >> 10)"
    rotr32: "rotr32(x, n): (x >> n) | (x << (32-n))"
    load: "load_u32_be(p): Big-Endian Word Load"
    style.fill: "#f8f9fa"
  }
}

# --- LAYER 1: PREPROCESSING ---
M1: "Milestone 1: Preprocessing" {
  class: milestone
  style.stroke: "#6a737d"

  padding: {
    shape: class
    label: "Padding Logic"
    sha256_pad: "+ sha256_pad(msg: *uint8_t, len: size_t): *SHA256_Block"
    write_u64: "write_u64_be(dst, val): Bit Length Encoder"
    style.fill: "#f8f9fa"
  }

  SHA256_Block: {
    shape: sql_table
    label: "struct SHA256_Block"
    "00-63": "uint8_t[64] chunk_data"
    "---": "---"
    "Total": "sizeof=64 bytes (1 cache line)"
    style.fill: "#e7f3ff"
  }
}

# --- DEPENDENCY GRAPH ---

# M4 Uses M3
M4.API -> M3.compression: "Calls sha256_compress\nper 512-bit block" {
  style.stroke-dash: 0
}

# M3 Uses M2
M3.compression -> M2.schedule: "Expands 16 words to 64 words" {
  style.stroke-dash: 0
}

# M2/M3 Uses M1
M2.schedule -> M1.SHA256_Block: "Reinterprets raw bytes\n(4-byte offsets)" {
  style.stroke-dash: 5
}
M3.compression -> M1.SHA256_Block: "Reads 512 bits\n(Big-Endian)" {
  style.stroke-dash: 5
}

# M4 API Orchestration
M4.API -> M4.SHA256_CTX: "Manages state lifecycle"

# Test Harness
nist_harness -> M4.API: "Validates vectors\n(Mode: TDD Verification)" {
  style.stroke: "#d39e00"
  target-arrowhead: triangle
}

# Method-specific call annotations (pointing to class shapes)
M4.API -> M3.compression: "Fast-path (Bypass Buffer):\nsha256_update -> sha256_compress" {
  style.font-size: 10
  style.stroke: "#F66A0A"
}

M1.padding -> M1.SHA256_Block: "sha256_pad() Factory" {
  style.stroke: "#28A745"
}