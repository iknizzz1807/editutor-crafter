direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: "Big-Endian vs Little-Endian Length Field Encoding" {
  shape: text
  near: top-center
  style.font-size: 24
  style.bold: true
}

Input: "Input Value: 24 (0x18)\n(bit-length of 'abc')" {
  shape: cylinder
  style.fill: "#DEE1EB"
}

BE_Container: "Big-Endian (SHA-256 Correct)" {
  style.stroke: "#44C7B1"
  style.stroke-width: 4
  style.fill: "#F0FFF0"

  Grid: {
    grid-columns: 8
    grid-gap: 0
    
    O56: "00" { style.fill: gray }
    O57: "00" { style.fill: gray }
    O58: "00" { style.fill: gray }
    O59: "00" { style.fill: gray }
    O60: "00" { style.fill: gray }
    O61: "00" { style.fill: gray }
    O62: "00" { style.fill: gray }
    O63: "18" { 
      style.fill: orange
      style.bold: true
    }
  }

  Labels: {
    grid-columns: 8
    grid-gap: 0
    style.stroke-width: 0
    l1: "56 (MSB)"
    l2: "57"
    l3: "58"
    l4: "59"
    l5: "60"
    l6: "61"
    l7: "62"
    l8: "63 (LSB)"
  }

  Expression: |c
    // Explicit right-shift (Portable)
    dst[0] = (uint8_t)(val >> 56); // 0x00
    // ...
    dst[7] = (uint8_t)(val >>  0); // 0x18
  |
}

LE_Container: "Little-Endian (x86 Native - WRONG)" {
  style.stroke: "#FE7070"
  style.stroke-width: 4
  style.stroke-dash: 5
  style.fill: "#FFF0F0"

  Grid: {
    grid-columns: 8
    grid-gap: 0
    
    O56: "18" { 
      style.fill: orange
      style.bold: true
    }
    O57: "00" { style.fill: gray }
    O58: "00" { style.fill: gray }
    O59: "00" { style.fill: gray }
    O60: "00" { style.fill: gray }
    O61: "00" { style.fill: gray }
    O62: "00" { style.fill: gray }
    O63: "00" { style.fill: gray }
  }

  Labels: {
    grid-columns: 8
    grid-gap: 0
    style.stroke-width: 0
    l1: "56 (LSB)"
    l2: "57"
    l3: "58"
    l4: "59"
    l5: "60"
    l6: "61"
    l7: "62"
    l8: "63 (MSB)"
  }

  Expression: |c
    // Native Memory Copy
    uint64_t len = 24;
    memcpy(dst, &len, 8);
    // Result depends on CPU architecture
  |
}

Input -> BE_Container.Grid.O63: "LSB maps to 63" {
  style.stroke: "#44C7B1"
  style.animated: true
}

Input -> LE_Container.Grid.O56: "LSB maps to 56" {
  style.stroke: "#FE7070"
  style.stroke-dash: 3
}

Annotation: |md
  **Architectural Rule**:
  SHA-256 mandates **Big-Endian** for the length field. 
  The Least Significant Byte (LSB) must be stored at the 
  highest memory address (Offset 63).
| {
  near: bottom-center
}