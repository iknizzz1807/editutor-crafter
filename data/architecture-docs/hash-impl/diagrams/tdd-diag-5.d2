direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- INPUTS ---
inputs: {
  shape: package
  label: "Input Parameters"
  
  ptr: "const uint8_t *input" {
    shape: parallelogram
    style.fill: "#f59e0b"
  }
  len: "size_t input_len" {
    shape: parallelogram
    style.fill: "#3b82f6"
  }
}

# --- LOGIC ENGINE ---
logic: {
  label: "sha256_pad Implementation Logic"
  
  calc_blocks: "Calculate num_blocks" {
    tooltip: "(len + 1 + 8 + 63) / 64"
  }
  
  allocate: "calloc(num_blocks, 64)" {
    style.fill: "#10b981"
    style.stroke-width: 2
  }
  
  write_separator: "buf[input_len] = 0x80" {
    style.font-color: red
    style.bold: true
  }
  
  calc_bits: "bit_len = (uint64_t)len * 8"
  
  be_writer: "write_u64_be(target, bit_len)" {
    tooltip: "Explicit Big-Endian Byte Shifts"
    style.fill: "#f59e0b"
  }
}

# --- MEMORY LAYOUT ---
memory_buffer: {
  label: "Padded Memory Layout (Total Size: N * 64B)"
  
  block_n: {
    grid-columns: 4
    grid-gap: 0
    
    # Message Section
    msg: "Message Data" {
      style.fill: "#3b82f6"
      style.font-color: white
      width: 200
    }
    
    # Separator
    sep: "0x80" {
      style.fill: "#6a09e6"
      style.font-color: white
      width: 40
    }
    
    # Padding
    pad: "Zero Padding (k bits)" {
      style.fill: "#9ca3af"
      style.stroke-dash: 2
      width: 150
    }
    
    # Length Field
    len_field: "64-bit Length (BE)" {
      style.fill: "#f59e0b"
      style.bold: true
      width: 120
    }
  }
  
  # Offsets
  offsets: {
    shape: package
    style.stroke-width: 0
    style.fill: transparent
    
    o0: "offset 0" {shape: text}
    o1: "offset input_len" {shape: text}
    o2: "offset total_len - 8" {shape: text}
    o3: "offset total_len" {shape: text}
  }
}

# --- DATA FLOW CONNECTIONS ---
inputs.ptr -> logic.allocate: "Passed as input"
inputs.len -> logic.calc_blocks: "Used for size calc"

logic.calc_blocks -> logic.allocate: "Total bytes"
logic.allocate -> memory_buffer.block_n: "Allocated buffer (zeroed)"

inputs.ptr -> memory_buffer.block_n.msg: "memcpy(buf, input, len)" {
  style.stroke: "#3b82f6"
  style.animated: true
}

inputs.len -> logic.write_separator: "Index into buffer"
logic.write_separator -> memory_buffer.block_n.sep: "Store 10000000b"

inputs.len -> logic.calc_bits: "x 8"
logic.calc_bits -> logic.be_writer: "uint64_t"
logic.be_writer -> memory_buffer.block_n.len_field: "8-byte BE store" {
  style.stroke: "#f59e0b"
  style.stroke-width: 2
}

# --- ANNOTATIONS ---
memory_buffer.block_n.pad -> logic.allocate: "Implicitly zeroed by calloc" {
  style.stroke-dash: 5
  style.stroke: "#10b981"
}

output: "SHA256_Block *padded_blocks" {
  shape: diamond
  style.fill: "#f59e0b"
  style.bold: true
}

memory_buffer -> output: "Pointer Cast (L-Value)"

# Metadata
legend: {
  near: bottom-right
  
  h: "Header/Separator" { style.fill: "#6a09e6" }
  d: "Data" { style.fill: "#3b82f6" }
  f: "Free/Allocated" { style.fill: "#10b981" }
  p: "Padding/Zeros" { style.fill: "#9ca3af" }
  ptr: "Pointers/BE Length" { style.fill: "#f59e0b" }
}

# Cache line indicators - FIXED: Changed near to constant value for ELK compliance
cl_marker: "" {
  near: top-right
  shape: text
  label: "--- 64B Boundary (Cache Line) ---"
  style.font-color: "#9ca3af"
  style.italic: true
}