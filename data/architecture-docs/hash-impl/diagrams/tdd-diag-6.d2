direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

SHA256_Block: {
  shape: class
  style: {
    stroke: "#764157"
    fill: "#764157" # Header=Purple
    font-color: "#ffffff"
  }
  # Fields: name, type, size
  bytes: "uint8_t[64], 64 bytes"
  "sizeof": "64 bytes (one cache line)"
}

Padding_Logic: {
  label: "sha256_padding.c"
  
  # Logic/Internal components: Blue
  write_u64_be: "static write_u64_be(uint8_t *dst, uint64_t value) -> void" {
    style.fill: "#DAE8FC" 
  }

  sha256_pad: "sha256_pad(const uint8_t *input, size_t len, size_t *out_n) -> SHA256_Block*" {
    style.fill: "#DAE8FC"
  }

  dump_block: "dump_block(const SHA256_Block *block, size_t index) -> void" {
    style.fill: "#DAE8FC"
  }
}

libc: "C Standard Library" {
  style.stroke-dash: 3
  calloc: "calloc(size_t num, size_t size) -> void*" {
    style.fill: "#DAE8FC"
  }
}

# Dependency Relationships
# Solid arrow = owns (heap return)
Padding_Logic.sha256_pad -> SHA256_Block: "returns owned heap array" {
  style: {
    stroke: "#F08000" # Orange Pointer/Ownership
    stroke-width: 2
  }
}

# Dashed arrow = references
Padding_Logic.sha256_pad -> Padding_Logic.write_u64_be: "big-endian encoding" {
  style.stroke-dash: 5
}

Padding_Logic.sha256_pad -> libc.calloc: "Zero-initialized allocation" {
  style.stroke-dash: 5
}

Padding_Logic.dump_block -> SHA256_Block: "read-only reference" {
  style.stroke-dash: 5
}

# Technical Specs
Documentation: |md
  ### SHA-256 Milestone 1: Padding Logic
  - **Memory Contract**: `sha256_pad` returns heap-allocated blocks. The **caller must `free()`** the pointer.
  - **Error Handling**: Returns `NULL` if `calloc` fails or `out_n` is NULL.
  - **Endianness**: `write_u64_be` implements explicit byte-shifting to ensure Big-Endian bit-length storage regardless of host CPU endianness.
  - **Alignment**: Final result is guaranteed to be $N \times 512$ bits.
  - **Invariants**: 
    - `total_len % 64 == 0`
    - `buffer[input_len] == 0x80`
| {
  # FIXED: Elk engine requires constant values for near
  near: bottom-right
}