direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- HEADER ---
title: |md
  # Algorithm Steps: `write_uint64_be`
  *Target: Write 64-bit Length field (L=24) to buffer in Big-Endian order*
| {
  near: top-center
  shape: text
}

# --- STEP 1: INITIAL STATE ---
step1: "1. Input Parameters" {
  input_v: "v (uint64_t)" {
    shape: sql_table
    val: "0x0000000000000018"
    bits: "64-bit"
  }
  buffer_init: "buf[8] (Memory)" {
    grid-columns: 8
    b0: "??"; b1: "??"; b2: "??"; b3: "??"
    b4: "??"; b5: "??"; b6: "??"; b7: "??"
  }
}

# --- STEP 2: EXTRACT MSB (buf[0]) ---
step2: "2. Extract Most Significant Byte" {
  logic: "buf[0] = (uint8_t)(v >> 56)" {
    shape: text
    style.italic: true
  }
  input_v: "v (uint64_t)" {
    shape: sql_table
    byte0: "0x00" {style.stroke: red; style.bold: true}
    rest: "0000000000000018"
  }
  buffer_state: "buf[8]" {
    grid-columns: 8
    b0: "0x00" {style: {font-color: red; bold: true}}
    b1: "??"; b2: "??"; b3: "??"
    b4: "??"; b5: "??"; b6: "??"; b7: "??"
  }
  input_v.byte0 -> buffer_state.b0: "Shift >> 56" {style.stroke: red}
}

# --- STEP 3: INTERMEDIATE PROCESSING ---
step3: "3-7. Iterative Shift & Mask" {
  shape: text
  label: "... repeat for shifts 48, 40, 32, 24, 16, 8 ..."
  style.font-size: 14
}

# --- STEP 4: EXTRACT LSB (buf[7]) ---
step4: "8. Extract Least Significant Byte" {
  logic: "buf[7] = (uint8_t)(v >> 0)" {
    shape: text
    style.italic: true
  }
  input_v: "v (uint64_t)" {
    shape: sql_table
    prefix: "0x00000000000000"
    lsb: "18" {style.stroke: red; style.bold: true}
  }
  buffer_state: "buf[8]" {
    grid-columns: 8
    b0: "0x00"; b1: "00"; b2: "00"; b3: "00"
    b4: "00"; b5: "00"; b6: "00"
    b7: "0x18" {style: {font-color: red; bold: true}}
  }
  input_v.lsb -> buffer_state.b7: "Shift >> 0" {style.stroke: red}
}

# --- COMPARISON: ENDIANNESS RESULTS ---
comparison: "Resulting Memory Layouts" {
  big_endian: "Correct (Big-Endian / SHA-256)" {
    style.fill: "#E1F5FE"
    layout: {
      grid-columns: 8
      b0: "00"; b1: "00"; b2: "00"; b3: "00"
      b4: "00"; b5: "00"; b6: "00"; b7: "18"
    }
    anno: "MSB at lowest address" {shape: text}
  }

  little_endian: "Incorrect (Little-Endian / x86 Cast)" {
    style.fill: "#FFEBEE"
    layout: {
      grid-columns: 8
      b0: "18"; b1: "00"; b2: "00"; b3: "00"
      b4: "00"; b5: "00"; b6: "00"; b7: "00"
    }
    anno: "LSB at lowest address" {shape: text}
    style.stroke: red
  }
}

step1 -> step2 -> step3 -> step4 -> comparison: "Sequence of Operations"