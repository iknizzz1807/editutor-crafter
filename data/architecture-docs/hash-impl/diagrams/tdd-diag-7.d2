direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# Module Definition
schedule_module: "Module: Message Schedule (M2)" {
  style: {
    stroke: "#333333"
    stroke-width: 2
    fill: "#f8f9fa"
  }

  # Public Interface
  public_api: "Public Interface" {
    sha256_schedule: {
      shape: class
      style.fill: "#e1d5e7" # Purple Header
      "sha256_schedule(const uint8_t* block, uint32_t W[64])": void
    }
  }

  # Internal Static Functions
  internal_helpers: "Static Helpers (Internal)" {
    sha256_parse_block: {
      shape: class
      style.fill: "#dae8fc" # Blue Data
      "sha256_parse_block(const uint8_t* block, uint32_t* W)": static void
    }

    read_uint32_be: {
      shape: class
      style.fill: "#dae8fc"
      "read_uint32_be(const uint8_t* buf, size_t i)": static uint32_t
    }

    sigma0: {
      shape: class
      style.fill: "#dae8fc"
      "sigma0(uint32_t x)": "ROTR7 ^ ROTR18 ^ SHR3"
    }

    sigma1: {
      shape: class
      style.fill: "#dae8fc"
      "sigma1(uint32_t x)": "ROTR17 ^ ROTR19 ^ SHR10"
    }

    rotr: {
      shape: class
      style.fill: "#dae8fc"
      "rotr(uint32_t x, uint32_t n)": static uint32_t
    }
  }

  # Call Dependencies
  public_api.sha256_schedule -> internal_helpers.sha256_parse_block: "Initializes W[0..15]" {
    style.stroke: "#ff8c00" # Orange Pointers/Flow
  }

  public_api.sha256_schedule -> internal_helpers.sigma0: "Recurrence (t=16..63)" {
    style.stroke: "#ff8c00"
  }

  public_api.sha256_schedule -> internal_helpers.sigma1: "Recurrence (t=16..63)" {
    style.stroke: "#ff8c00"
  }

  internal_helpers.sha256_parse_block -> internal_helpers.read_uint32_be: "Loop 16x" {
    style.stroke-dash: 3
  }

  internal_helpers.sigma0 -> internal_helpers.rotr: "Double Call"
  internal_helpers.sigma1 -> internal_helpers.rotr: "Double Call"
}

# Documentation / Annotations
# FIX: 'near' set to constant for ELK compatibility
annotation: |md
  ### Module Statistics
  - **Memory:** `sizeof(uint32_t[64]) = 256 bytes`
  - **Complexity:** 48 iterations (W[16..63])
  - **Primitives:** ROTR (Rotate), SHR (Shift), XOR
| {
  near: top-right
}

# Data Flow Context
input_block: "Input Block (M1)" {
  shape: cylinder
  style.fill: "#d5e8d4" # Green Free/New Data
}

input_block -> schedule_module.public_api.sha256_schedule: "512-bit Padded Buffer"

schedule_module.public_api.sha256_schedule -> compression: "64-word W[t]" {
  target-arrowhead: triangle
}

compression: "Compression Function (M3)" {
  style.stroke-dash: 5
}