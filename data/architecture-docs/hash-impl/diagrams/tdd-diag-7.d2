direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  ### SHA-256 Message Schedule Primitives
  **ROTR (Right Rotate) vs. SHR (Right Shift)**
  *Input: 0x000000B7 (binary: ...10110111), n=4*
| {
  near: top-center
  shape: text
}

# ─────────────────────────────────────────────────────────────────────────────
# 1. ROTR OPERATION (INVERTIBLE)
# ─────────────────────────────────────────────────────────────────────────────
rotr_container: {
  label: "ROTR(x, 4): Invertible Diffusion"
  style.stroke: "#6A1B9A" # Purple Header
  
  initial: {
    label: "INPUT: 0x000000B7"
    reg: {
      grid-columns: 3
      grid-gap: 0
      
      unused: "0x000000" {
        width: 300
        style.fill: "#BDBDBD" # Gray Padding
      }
      high_nibble: "1011" {
        style.fill: "#1976D2" # Blue Data
        style.font-color: white
      }
      low_nibble: "0111" {
        style.fill: "#FFB300" # Orange Pointer/Moved
        style.font-color: black
        style.bold: true
      }
    }
  }

  process: {
    shape: text
    label: "Step: (x >> 4) | (x << 28)"
  }

  final: {
    label: "RESULT: 0x7000000B"
    reg: {
      grid-columns: 3
      grid-gap: 0
      
      wrapped: "**0111**" {
        style.fill: "#FFB300" # Orange Moved
        style.font-color: black
        style.bold: true
      }
      unused: "0x000000" {
        width: 300
        style.fill: "#BDBDBD" # Gray Padding
      }
      shifted: "1011" {
        style.fill: "#1976D2" # Blue Data
        style.font-color: white
      }
    }
  }

  initial.reg.low_nibble -> final.reg.wrapped: "Wrap to MSB" {
    style: {
      stroke: "#FFB300"
      stroke-width: 2
      animated: true
    }
  }
  
  initial.reg.high_nibble -> final.reg.shifted: "Shift Right" {
    style: {
      stroke: "#1976D2"
      stroke-dash: 3
    }
  }

  annotation: |md
    **Bit Conservation**
    All bits are preserved. No information is lost. 
    Operation is bi-directional.
  | {
    shape: text
  }
}

# ─────────────────────────────────────────────────────────────────────────────
# 2. SHR OPERATION (IRREVERSIBLE)
# ─────────────────────────────────────────────────────────────────────────────
shr_container: {
  label: "SHR(x, 4): Irreversible Extraction"
  style.stroke: "#6A1B9A" # Purple Header
  
  initial: {
    label: "INPUT: 0x000000B7"
    reg: {
      grid-columns: 3
      grid-gap: 0
      
      unused: "0x000000" {
        width: 300
        style.fill: "#BDBDBD"
      }
      high_nibble: "1011" {
        style.fill: "#1976D2"
        style.font-color: white
      }
      low_nibble: "0111" {
        style.fill: "#EF5350" # Red Error/Discarded
        style.stroke: red
        style.font-color: white
      }
    }
  }

  process: {
    shape: text
    label: "Step: x >> 4"
  }

  final: {
    label: "RESULT: 0x0000000B"
    reg: {
      grid-columns: 3
      grid-gap: 0
      
      zero_fill: "0000" {
        style.fill: "#EEEEEE" # Gray Padding
        style.font-color: black
        style.italic: true
      }
      unused: "0x000000" {
        width: 300
        style.fill: "#BDBDBD"
      }
      shifted: "1011" {
        style.fill: "#1976D2"
        style.font-color: white
      }
    }
  }

  initial.reg.low_nibble -> trash: "Discarded" {
    style.stroke: "#EF5350"
  }
  trash: "X" {
    shape: circle
    style.fill: "#EF5350"
    style.stroke: red
  }

  initial.reg.high_nibble -> final.reg.shifted: "Shift Right" {
    style: {
      stroke: "#1976D2"
      stroke-dash: 3
    }
  }

  annotation: |md
    **Bit Destruction**
    4 LSB bits are destroyed. 
    Information loss = 4 bits. 
    Operation is one-way.
  | {
    shape: text
  }
}

# Comparison Line
rotr_container -- shr_container: "Implementation Distinction" {
  style.stroke-dash: 5
}

legend: {
  near: bottom-right
  data: "Data Bits" { style.fill: "#1976D2" }
  moved: "Wrapped Bits" { style.fill: "#FFB300" }
  lost: "Discarded Bits" { style.fill: "#EF5350" }
  padding: "Padding/Zero" { style.fill: "#BDBDBD" }
}