direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# 1. MEMORY LAYOUT: 512-bit Block (Source)
# Removed 'shape: grid' - grids are enabled via grid-columns/rows on any container
Block: {
  label: "INPUT BLOCK (512-bit / 64-byte)"
  grid-columns: 4
  style: {
    fill: "#E1BEE7" # Purple Header
    stroke: "#7B1FA2"
    stroke-width: 2
  }

  b00: "00h: W[0]" { style.fill: "#BBDEFB" } # Blue Data
  b04: "04h: W[1]" { style.fill: "#BBDEFB" }
  b08: "08h: W[2]" { style.fill: "#BBDEFB" }
  b12: "0Ch: W[3]" { style.fill: "#BBDEFB" }
  
  # Gray Padding for middle section
  mid_block: "..." { 
    grid-columns: 4
    style: {
      fill: "#F5F5F5"
      stroke-dash: 3
    }
  }
  
  b60: "3Ch: W[15]" { style.fill: "#BBDEFB" }
}

# 2. TRANSFORMATION: Parsing
Parser: "sha256_parse_block" {
  shape: parallelogram
  style.fill: "#C8E6C9" # Green Process
  tooltip: "Big-Endian Byte to 32-bit Word Conversion"
}

# 3. MEMORY LAYOUT: Message Schedule W[64]
Schedule: {
  label: "MESSAGE SCHEDULE W[64] (uint32_t)"
  style.fill: "#E1BEE7" # Purple Header
  
  Initial: {
    label: "Extracted Words (t = 0..15)"
    grid-columns: 4
    style.fill: "#E3F2FD" # Light Blue Data
    
    w0: "W[0]"
    w1: "W[1]"
    w14: "W[14]"
    w15: "W[15]"
  }

  Expanded: {
    label: "Generated Words (t = 16..63)"
    style.fill: "#FFF3E0" # Light Orange Data
    
    W_t: "W[t]" {
      style: {
        stroke: red
        stroke-width: 3
        bold: true
      }
    }
  }
}

# 4. RECURRENCE LOGIC
ExpansionLogic: {
  label: "Recurrence Relation: W[t] = σ1(W[t-2]) + W[t-7] + σ0(W[t-15]) + W[t-16]"
  style.stroke-dash: 5

  sigma0: "σ0(x)" {
    shape: circle
    tooltip: "ROTR7(x) ^ ROTR18(x) ^ SHR3(x)"
  }
  
  sigma1: "σ1(x)" {
    shape: circle
    tooltip: "ROTR17(x) ^ ROTR19(x) ^ SHR10(x)"
  }

  Adder: {
    shape: diamond
    label: "Σ mod 2^32"
  }
}

# 5. DATA FLOW CONNECTIONS
Block -> Parser: "uint8_t[64]" {
  style.stroke: "#7B1FA2"
}

Parser -> Schedule.Initial: "Big-Endian Read" {
  style.stroke: "#FF9800" # Orange Pointers
}

# Taps for W[t]
Schedule.Initial.w0 -> ExpansionLogic.Adder: "W[t-16]" { style.stroke: "#FF9800" }
Schedule.Initial.w1 -> ExpansionLogic.sigma0: "W[t-15]" { style.stroke: "#FF9800" }
Schedule.Initial.w1 -> ExpansionLogic.Adder: "W[t-7]" { style.stroke: "#FF9800" }
Schedule.Initial.w14 -> ExpansionLogic.sigma1: "W[t-2]" { style.stroke: "#FF9800" }

ExpansionLogic.sigma0 -> ExpansionLogic.Adder: "uint32_t"
ExpansionLogic.sigma1 -> ExpansionLogic.Adder: "uint32_t"

ExpansionLogic.Adder -> Schedule.Expanded.W_t: "Store W[t]" {
  style.stroke: red
  style.stroke-width: 2
}

# Annotations
Block.b00 -> Parser: "Offset 0x00: 4 bytes"
Schedule.Expanded.W_t -> ExpansionLogic: "Loop Invariant: t ∈ [16, 63]"

# Total Size Annotation - Moved to root level to fix 'near' error
W_Total_Size: "sizeof = 256 bytes (4 cache lines)" {
  shape: text
  near: bottom-right
  style: {
    font-size: 14
    bold: true
  }
}