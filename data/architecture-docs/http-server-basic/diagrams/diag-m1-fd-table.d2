vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- Classes & Professional Styling ---
classes: {
  kernel_struct: {
    shape: sql_table
    style: {
      fill: "#E4DBFE"
      stroke: "#5D2B82"
      stroke-width: 2
    }
  }
  process_struct: {
    shape: sql_table
    style: {
      fill: "#C7F1FF"
      stroke: "#0077B6"
      stroke-width: 2
    }
  }
  warning: {
    style: {
      fill: "#FFE5E5"
      stroke: "#C0392B"
      stroke-dash: 3
    }
  }
}

# --- 2D Grid Layout Strategy ---
direction: right

user_space: {
  label: "USER SPACE (Process Context)"
  direction: down

  process: {
    class: process_struct
    label: "struct task_struct (linux/sched.h)"
    
    row1: "0x00 | pid_t          | pid = 1234"
    row2: "0x04 | struct mm_struct* | mm (Address Space)"
    row3: "0x10 | struct files_struct* | files (Open FDs)"
    row4: "0x18 | struct fs_struct*    | fs (CWD/Root)"
    label_bottom: "Total: ~10KB (Memory Resident)"
  }

  server_code: {
    shape: code
    label: "server.c (Accept Loop)"
    content: |md
    c
    // Milestone 1: FD Allocation
    int client_fd = accept(server_fd, NULL, NULL);
    
    // CRITICAL: If close() is omitted, 
    // files_struct->fd_array[client_fd] remains 
    // pinned in kernel memory.
    // close(client_fd); 
    
    |
  }
}

kernel_space: {
  label: "KERNEL SPACE (VFS & Socket Layers)"
  direction: down

  fd_table: {
    class: kernel_struct
    label: "struct files_struct (linux/fdtable.h)"
    
    fd0: "0x00 | FD 0 | stdin  (pts/0)"
    fd1: "0x08 | FD 1 | stdout (pts/0)"
    fd2: "0x10 | FD 2 | stderr (pts/0)"
    fd3: "0x18 | FD 3 | server_fd (LISTEN)"
    fd4: "0x20 | FD 4 | client_fd_1 (ESTABLISHED)"
    fd5: "0x28 | FD 5 | client_fd_2 (ESTABLISHED)"
    leak_zone: "0x30 | ...  | [UNCLOSED HANDLES]" {
      class: warning
    }
    limit: "0x2000 | FD 1024 | RLIMIT_NOFILE (EMFILE)" {
      style.fill: "#FFCCCC"
    }
    
    label_bottom: "Array size: 8 bytes per pointer (x64)"
  }

  file_table: {
    class: kernel_struct
    label: "struct file (linux/fs.h)"
    
    entry_listen: "Ref: 1 | Offset: 0 | mode: O_RDWR | f_op: socket_file_ops"
    entry_c1:     "Ref: 1 | Offset: 0 | mode: O_RDWR | f_op: socket_file_ops"
    entry_c2:     "Ref: 1 | Offset: 0 | mode: O_RDWR | f_op: socket_file_ops"
    
    label_bottom: "Global System Open File Table (Object Reference)"
  }

  socket_layer: {
    direction: right
    label: "Socket Memory (net/socket.c)"
    
    listen_socket: {
      class: kernel_struct
      label: "struct socket (net/socket.h)"
      state: "State: SS_UNCONNECTED"
      proto: "Proto: TCP (LISTEN)"
      port:  "Port: 8080"
      backlog: "Queue: [3/128]"
    }

    client_socket_1: {
      class: kernel_struct
      label: "struct socket (net/socket.h)"
      state: "State: SS_CONNECTED"
      peer:  "Peer: 192.168.1.5:54321"
      buf:   "RecvBuf: 8KB (Buffered)"
    }
  }
}

# --- Data Flow & Implementation Pointers ---

# task_struct -> files_struct
user_space.process.row3 -> kernel_space.fd_table: "files_struct* | 8B | current->files"

# FD Entries (Pointers) -> Open File Table
kernel_space.fd_table.fd3 -> kernel_space.file_table.entry_listen: "struct file* | [inode: 456]"
kernel_space.fd_table.fd4 -> kernel_space.file_table.entry_c1: "struct file* | [inode: 789]"
kernel_space.fd_table.fd5 -> kernel_space.file_table.entry_c2: "struct file* | [inode: 901]"

# Open File Table -> Protocol Sockets
kernel_space.file_table.entry_listen -> kernel_space.socket_layer.listen_socket: "private_data | ops: tcp_ops"
kernel_space.file_table.entry_c1 -> kernel_space.socket_layer.client_socket_1: "private_data | ops: tcp_ops"

# Allocation path
user_space.server_code -> kernel_space.fd_table: "sys_accept() | Result: FD 4" {
  style: {
    stroke: green
    stroke-width: 3
    animated: true
  }
}

# --- Corrected Error: ELK compatible positioning ---
leak_note: {
  shape: text
  label: "RESOURCE LEAK ANALYSIS:\n1. FD Slot Occupied (fd_table)\n2. File struct RefCount > 0\n3. Kernel Socket Memory Pinned\nResult: EMFILE (Process) or Kernel OOM"
  near: top-right
  style.font-color: red
  style.bold: true
}

leak_note -> kernel_space.fd_table.leak_zone: "Leak Trigger" {
  style.stroke: red
  style.stroke-dash: 2
}

# --- Legend ---
legend: {
  near: bottom-right
  direction: right
  u: "User Context" { 
    class: process_struct 
    width: 120
  }
  k: "Kernel Context" { 
    class: kernel_struct
    width: 120
  }
}