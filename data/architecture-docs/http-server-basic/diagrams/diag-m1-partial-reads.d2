direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- MENTAL MODEL (THE FALLACY) ---
mental_model: {
  label: "DEVELOPER MENTAL MODEL (Incorrect)"
  style: {
    stroke-dash: 5
    fill: "#f8f9fa"
  }
  
  client: "Web Browser" {
    shape: person
  }
  
  socket: "TCP Socket (FD 5)" {
    shape: circle
  }
  
  app_logic: "Application Code" {
    shape: class
    label: "server.c"
    definition: |md
      c
      char buf[8192];
      // Expecting one read to rule them all
      read(fd, buf, sizeof(buf)); 
      
    |
  }
  
  client -> socket: "GET / HTTP/1.1\r\n..."
  socket -> app_logic: "Full 38 bytes | Request Object" {
    style: {
      stroke: red
      stroke-width: 4
    }
  }
}

# --- REALITY: THE BYTE STREAM ---
reality: {
  label: "TCP REALITY: THE ASYNCHRONOUS BYTE STREAM"
  direction: down

  # Timeline of arriving packets
  network_packets: {
    direction: right
    p1: "Packet 1\n(9 bytes)" {style.fill: "#C7F1FF"}
    p2: "Packet 2\n(15 bytes)" {style.fill: "#C7F1FF"}
    p3: "Packet 3\n(14 bytes)" {style.fill: "#C7F1FF"}
  }

  # The Read Loop Sequence
  iteration_1: {
    direction: right
    label: "T1: Initial read()"
    
    call: {
      shape: code
      label: "read(fd, buf + 0, 8191)"
    }
    
    buffer_state: {
      shape: sql_table
      label: "Accumulation Buffer (0x00)"
      row1: "0x00 | 'G' | 'E' | 'T' | ' ' | '/' | ' ' | 'H' | 'T' | [EMPTY...]"
      label_bottom: "total_read: 9 bytes | strstr(buf, \"\\r\\n\\r\\n\") == NULL"
    }
    
    call -> buffer_state: "n = 9"
  }

  iteration_2: {
    direction: right
    label: "T2: Second read()"
    
    call: {
      shape: code
      label: "read(fd, buf + 9, 8182)"
    }
    
    buffer_state: {
      shape: sql_table
      label: "Accumulation Buffer (0x09)"
      row1: "0x00 | 'G' | 'E' | 'T' | ' ' | '/' | ' ' | 'H' | 'T' | 'P' | '/' | '1' | '.' | '1' | '\\r' | '\\n' | 'H' | 'o' | 's' | 't' | ':' | ' ' | 'l' | 'o' | [EMPTY...]"
      label_bottom: "total_read: 24 bytes | strstr(buf, \"\\r\\n\\r\\n\") == NULL"
    }
    
    call -> buffer_state: "n = 15"
  }

  iteration_3: {
    direction: right
    label: "T3: Final read() (Header Complete)"
    
    call: {
      shape: code
      label: "read(fd, buf + 24, 8167)"
    }
    
    buffer_state: {
      shape: sql_table
      label: "Accumulation Buffer (0x24)"
      row1: "... | 'c' | 'a' | 'l' | 'h' | 'o' | 's' | 't' | '\\r' | '\\n' | '\\r' | '\\n'"
      label_bottom: "total_read: 38 bytes | strstr(buf, \"\\r\\n\\r\\n\") == 0x22"
    }
    
    call -> buffer_state: "n = 14"
    
    success_notif: "PARSER TRIGGERED" {
      style: {
        fill: green
        font-color: white
        bold: true
      }
    }
    
    buffer_state -> success_notif: "Delimiter Found"
  }

  network_packets.p1 -> iteration_1.call
  network_packets.p2 -> iteration_2.call
  network_packets.p3 -> iteration_3.call
  
  iteration_1 -> iteration_2 -> iteration_3: "Loop Next"
}

# Implementation Signature
implementation_notes: {
  near: bottom-right
  shape: code
  label: |md
    c
    // Robust header reading pattern
    while (total < size && !header_finished) {
        n = read(fd, buf + total, size - total);
        if (n <= 0) break;
        total += n;
        if (strstr(buf, "\r\n\r\n")) header_finished = 1;
    }
    
  |
}

reality.iteration_3.success_notif -> implementation_notes: "Implements" {
  style.stroke-dash: 3
}