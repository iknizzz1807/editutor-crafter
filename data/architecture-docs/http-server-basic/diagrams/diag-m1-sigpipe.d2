direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- BEFORE: DEFAULT BEHAVIOR (VULNERABLE) ---
vulnerable_scenario: {
  label: "BEFORE: Default Signal Handling (Process Termination)"
  direction: down
  
  client: "Client (curl/browser)" {
    shape: person
    style.stroke: "#e74c3c"
  }

  kernel: "Linux Kernel (TCP Stack)" {
    shape: cylinder
    style.fill: "#f2f2f2"
  }

  server_process: "Server Process (PID: 1234)" {
    shape: class
    label: "http_server (server.c)"
    
    state: "STATE: RUNNING"
    active_fds: "Active FDs: [3, 4, 5, 6]"
    
    code: |md
      c
      // No signal handling defined
      ssize_t n = write(client_fd, buf, len);
      
    |
  }

  # Sequence
  client -> kernel: "1. TCP FIN/RST (Tab Closed)"
  server_process -> kernel: "2. write(fd, buf, len)"
  kernel -> server_process: "3. SIGPIPE (Signal 13)" {
    style: {
      stroke: red
      stroke-width: 4
      animated: true
    }
  }
  
  server_death: "PROCESS TERMINATED" {
    shape: diamond
    style.fill: "#e74c3c"
    style.font-color: white
  }
  
  server_process -> server_death: "Uncaught Signal"
  server_death -> "*": "CRITICAL: All connections dropped" {
    style.stroke: red
    style.stroke-dash: 3
  }
}

# --- GAP / TRANSITION ---
transition: " " {
  shape: package
  style.opacity: 0
  width: 100
}

# --- AFTER: IMPLEMENTATION-READY PROTECTION ---
protected_scenario: {
  label: "AFTER: Signal Masking (Robust Connection Handling)"
  direction: down
  
  client: "Client (curl/browser)" {
    shape: person
    style.stroke: "#2ecc71"
  }

  kernel: "Linux Kernel (TCP Stack)" {
    shape: cylinder
    style.fill: "#f2f2f2"
  }

  server_process: "Server Process (PID: 5678)" {
    shape: class
    label: "http_server (server.c)"
    
    state: "STATE: RUNNING"
    active_fds: "Active FDs: [3, 4, 5, 6]"
    
    init_code: |md
      c
      // Fix applied at startup
      signal(SIGPIPE, SIG_IGN);
      
    |
    
    io_code: |md
      c
      ssize_t n = write(fd, buf, len);
      if (n < 0) {
          if (errno == EPIPE) {
              // Client disconnected
              close(fd); 
              return;
          }
      }
      
    |
  }

  # Sequence
  client -> kernel: "1. TCP FIN/RST"
  server_process -> kernel: "2. write(fd, buf, len)"
  kernel -> server_process: "3. Return -1 | errno=EPIPE" {
    style: {
      stroke: "#2ecc71"
      stroke-width: 2
    }
  }
  
  connection_cleanup: "CLEANUP: close(client_fd)" {
    shape: rectangle
    style.fill: "#d4efdf"
  }
  
  server_process -> connection_cleanup: "Error Handled"
  
  survivor: "PROCESS REMAINS ALIVE" {
    shape: diamond
    style.fill: "#2ecc71"
    style.font-color: white
  }
  
  connection_cleanup -> survivor
  survivor -> "Other Clients": "Connections [4, 5, 6] Unaffected" {
    style.stroke: green
  }
}

# Layout constraints
vulnerable_scenario -> transition -> protected_scenario: "Implementation: signal(SIGPIPE, SIG_IGN)" {
  style.stroke-width: 2
  style.stroke-dash: 5
}