direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ---------------------------------------------------------------------------------
# DATA STRUCTURES & DEFINITIONS
# ---------------------------------------------------------------------------------
request_struct: {
  shape: sql_table
  label: "struct http_request_t (parser.h)"
  
  row1: "0x00 | int      | method (GET=0, HEAD=1, POST=2)"
  row2: "0x04 | char[8192]| path (URI)"
  row3: "0x2004| int      | http_minor (0=1.0, 1=1.1)"
  row4: "0x2008| header_t | headers[32]"
  row5: "0x... | int      | content_length (-1 if absent)"
  label_bottom: "Total: ~270KB (Fixed Arrays)"
}

parser_api: {
  shape: code
  label: "Parser Signature (parser.c)"
  language: c
  value: |md
    c
    int parse_http_request(
        const char *buf, 
        size_t buf_len, 
        int header_end, 
        http_request_t *req
    );
    
  |
}

# ---------------------------------------------------------------------------------
# DECISION TREE FLOW
# ---------------------------------------------------------------------------------
input_stream: "Raw Socket Buffer\nchar[]" {
  shape: cylinder
  style.fill: "#DEE1EB"
}

validation_layer: {
  direction: down
  label: "VALIDATION LAYER (parser.c)"
  style.stroke-dash: 3

  line_split: "Split Buffer by CRLF" {
    shape: rectangle
  }

  check_malformed: "Is Request Line\nPresent/Valid?" {
    shape: diamond
  }

  check_uri: "URI Length\n<= 8192 Bytes?" {
    shape: diamond
  }

  check_method: "Method In\n{GET, HEAD, POST}?" {
    shape: diamond
  }

  check_host: "HTTP/1.1 AND\nHost Header Present?" {
    shape: diamond
  }

  check_head: "Method == HEAD?" {
    shape: diamond
  }
}

# ---------------------------------------------------------------------------------
# TERMINAL STATES (HTTP RESPONSES)
# ---------------------------------------------------------------------------------
responses: {
  label: "TERMINAL STATES"
  
  r400: "400 Bad Request" {
    shape: code
    style.fill: "#FE7070"
    value: |md
      http
      HTTP/1.1 400 Bad Request\r\n
      Content-Type: text/html\r\n
      Content-Length: 45\r\n
      Connection: close\r\n
      \r\n
      <html><body>400 Bad Request</body></html>
      
    |
  }

  r414: "414 URI Too Long" {
    shape: code
    style.fill: "#FE7070"
    value: |md
      http
      HTTP/1.1 414 URI Too Long\r\n
      Content-Type: text/html\r\n
      Content-Length: 45\r\n
      Connection: close\r\n
      \r\n
      <html><body>414 URI Too Long</body></html>
      
    |
  }

  r501: "501 Not Implemented" {
    shape: code
    style.fill: "#FE7070"
    value: |md
      http
      HTTP/1.1 501 Not Implemented\r\n
      Content-Type: text/html\r\n
      Content-Length: 52\r\n
      Connection: close\r\n
      \r\n
      <html><body>501 Not Implemented</body></html>
      
    |
  }

  r200_head: "200 OK (HEAD)" {
    shape: code
    style.fill: "#A7CC9E"
    value: |md
      http
      HTTP/1.1 200 OK\r\n
      Content-Type: text/html\r\n
      Content-Length: 1024\r\n
      Connection: keep-alive\r\n
      \r\n
      (NO BODY SENT)
      
    |
  }

  r200_get: "200 OK (GET)" {
    shape: code
    style.fill: "#A7CC9E"
    value: |md
      http
      HTTP/1.1 200 OK\r\n
      Content-Type: text/html\r\n
      Content-Length: 1024\r\n
      Connection: keep-alive\r\n
      \r\n
      [1024 bytes of HTML data...]
      
    |
  }
}

# ---------------------------------------------------------------------------------
# CONNECTIONS (LOGIC PATHS)
# ---------------------------------------------------------------------------------
input_stream -> validation_layer.line_split

validation_layer.line_split -> validation_layer.check_malformed

validation_layer.check_malformed -> responses.r400: "No"
validation_layer.check_malformed -> validation_layer.check_uri: "Yes"

validation_layer.check_uri -> responses.r414: "> 8192 bytes"
validation_layer.check_uri -> validation_layer.check_method: "OK"

validation_layer.check_method -> responses.r501: "Unknown"
validation_layer.check_method -> validation_layer.check_host: "Known"

validation_layer.check_host -> responses.r400: "Missing Host"
validation_layer.check_host -> validation_layer.check_head: "Valid"

validation_layer.check_head -> responses.r200_head: "Yes"
validation_layer.check_head -> responses.r200_get: "No (GET/POST)"

# Data Flow Annotations
parser_api -> validation_layer: "Logic Implementation"
request_struct -> validation_layer: "State Container"

# Styling logic path
(validation_layer.check_head -> responses.r200_get)[0].style.stroke: blue
(validation_layer.check_head -> responses.r200_get)[0].label: "Full Payload"

(validation_layer.check_malformed -> responses.r400)[0].style.stroke: red
(validation_layer.check_uri -> responses.r414)[0].style.stroke: red
(validation_layer.check_method -> responses.r501)[0].style.stroke: red
(validation_layer.check_host -> responses.r400)[0].style.stroke: red