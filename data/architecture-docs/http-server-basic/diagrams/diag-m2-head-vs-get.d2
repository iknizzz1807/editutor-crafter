direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# Implementation Reference: RFC 7231 Section 4.3.2
title: "Comparison: HTTP GET vs HEAD Response Construction" {
  shape: text
  near: top-center
  style: {
    font-size: 18
    bold: true
  }
}

legend: {
  near: bottom-center
  get_color: "GET: Headers + Body" {
    style: {
      fill: "#B6DDF6"
    }
  }
  head_color: "HEAD: Headers ONLY (Metadata Match)" {
    style: {
      fill: "#E4DBFE"
    }
  }
}

GET_TRANSACTION: {
  label: "GET Request Cycle (server.c)"
  direction: down
  
  client: "HTTP Client\n(Browser/Curl)" {
    shape: person
  }

  request: {
    shape: sql_table
    label: "Raw Request String"
    line1: "GET /index.html HTTP/1.1"
    line2: "Host: localhost:8080"
    line3: "\\r\\n"
  }

  response: {
    shape: sql_table
    label: "Full Response Message"
    style: { fill: "#B6DDF6" }
    
    status: "HTTP/1.1 200 OK"
    header1: "Content-Type: text/html"
    header2: "Content-Length: 1024"
    header3: "Date: Sat, 28 Feb 2026..."
    sep: "\\r\\n"
    body: "<html>... [1024 Bytes of Data] ..." {
      style: { bold: true; stroke-width: 2 }
    }
  }

  client -> request: "write(fd, buf, 42)"
  request -> response: "logic: serve_static_file()"
  response -> client: "1056 Bytes | Full payload"
}

HEAD_TRANSACTION: {
  label: "HEAD Request Cycle (server.c)"
  direction: down
  
  client: "HTTP Client\n(Cache Validator)" {
    shape: person
  }

  request: {
    shape: sql_table
    label: "Raw Request String"
    line1: "HEAD /index.html HTTP/1.1"
    line2: "Host: localhost:8080"
    line3: "\\r\\n"
  }

  response: {
    shape: sql_table
    label: "Header-Only Response"
    style: { fill: "#E4DBFE" }
    
    status: "HTTP/1.1 200 OK"
    header1: "Content-Type: text/html"
    header2: "Content-Length: 1024" {
      tooltip: "MUST match GET body size"
      style: { stroke: red; stroke-width: 3 }
    }
    header3: "Date: Sat, 28 Feb 2026..."
    sep: "\\r\\n"
    body_placeholder: "[BODY OMITTED BY SPEC]" {
      style: { stroke-dash: 5; opacity: 0.5 }
    }
  }

  client -> request: "write(fd, buf, 43)"
  request -> response: "logic: serve_static_file()"
  response -> client: "32 Bytes | Headers ONLY"
}

IMPLEMENTATION_DETAIL: {
  label: "C Logic (file_server.c)"
  near: bottom-right
  
  code: |md
    c
    // Logic inside serve_static_file()
    header_len = snprintf(header_buf, sizeof(header_buf),
        "HTTP/1.1 200 OK\r\n"
        "Content-Length: %ld\r\n\r\n", 
        st.st_size); // st_size is same for both
    
    write_all(client_fd, header_buf, header_len);

    if (req->method != METHOD_HEAD) {
        // Only transmit bits if NOT HEAD
        stream_file_to_socket(client_fd, file_fd);
    }
    
  |
}

# Annotated Connections
GET_TRANSACTION.response.header2 -> HEAD_TRANSACTION.response.header2: "Identical Bytes | 1024" {
  style: {
    stroke: purple
    stroke-dash: 3
    animated: true
  }
}

GET_TRANSACTION.response.body -> HEAD_TRANSACTION.response.body_placeholder: "SUPPRESSED" {
  source-arrowhead: cross
  style: {
    stroke: red
  }
}