direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

classes: {
  method: { style: { fill: "#C7F1FF"; stroke: "#007bff"; bold: true } }
  sp: { style: { fill: "#DEE1EB"; stroke: "#6c757d"; font-color: "#6c757d" } }
  path: { style: { fill: "#ebf3e6"; stroke: "#28a745"; bold: true } }
  version: { style: { fill: "#fff3cd"; stroke: "#ffc107"; bold: true } }
  crlf: { style: { fill: "#f8d7da"; stroke: "#dc3545"; font-color: "#dc3545"; bold: true } }
  header_key: { style: { fill: "#E4DBFE"; stroke: "#6f42c1" } }
  header_val: { style: { fill: "#fbfdfd"; stroke: "#17a2b8" } }
  payload: { style: { fill: "#ffffff"; stroke: "#343a40"; stroke-dash: 3 } }
}

http_request_anatomy: {
  shape: sql_table
  label: "HTTP/1.1 Request Message Anatomy (Memory Buffer)"

  # Header Section
  row_0: "Offset | Type | Content Descriptor"
  
  # Request Line
  row_1: "0x00 | char[3] | METHOD: 'GET'" {class: method}
  row_2: "0x03 | char[1] | SP (0x20)" {class: sp}
  row_3: "0x04 | char[11]| PATH: '/index.html'" {class: path}
  row_4: "0x0F | char[1] | SP (0x20)" {class: sp}
  row_5: "0x10 | char[8] | VERSION: 'HTTP/1.1'" {class: version}
  row_6: "0x18 | char[2] | CRLF (0x0D 0x0A)" {class: crlf}

  # Headers
  row_7: "0x1A | char[5] | Header Name: 'Host:'" {class: header_key}
  row_8: "0x1F | char[1] | OWS (Optional WhiteSpace)" {class: sp}
  row_9: "0x20 | char[9] | Header Value: 'localhost'" {class: header_val}
  row_10: "0x29| char[2] | CRLF" {class: crlf}
  
  row_11: "0x2B| char[12]| Header Name: 'User-Agent:'" {class: header_key}
  row_12: "0x37| char[4] | Header Value: 'curl'" {class: header_val}
  row_13: "0x3B| char[2] | CRLF" {class: crlf}

  # Empty line (Header Terminator)
  row_14: "0x3D| char[2] | TERMINATING CRLF (Blank Line)" {class: crlf}

  # Body
  row_15: "0x3F| byte[]  | MESSAGE BODY (Payload)" {class: payload}

  label_bottom: "Total Header Size: 63 bytes | Total Request: 63 + N bytes"
}

legend: {
  near: bottom-right
  direction: down
  
  m: "Method Token" {class: method}
  p: "Request Target (URI)" {class: path}
  v: "Protocol Version" {class: version}
  s: "Space Separator (SP)" {class: sp}
  c: "Line Terminator (CRLF)" {class: crlf}
}

explanation: |md
  ### RFC 7230 Compliance
  - **Request Line**: Must contain exactly 2 spaces.
  - **Normalization**: Headers are case-insensitive; server should normalize to lowercase.
  - **Validation**: Headers end at the first occurrence of `\r\n\r\n`.
  - **Binary Safety**: The body is a raw byte stream; its length is defined by `Content-Length`.
| {near: top-right}

http_request_anatomy.row_14 -> explanation: "Header termination boundary" {style: {stroke-dash: 5}}