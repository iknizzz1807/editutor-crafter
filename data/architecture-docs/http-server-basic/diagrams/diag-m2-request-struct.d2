direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 1
  }
}

http_request_t_module: {
  label: "http_request_t (http.h)"
  direction: down

  struct_definition: |md
    c
    typedef struct {
        char name[256];
        char value[8192];
    } http_header_t;

    typedef struct {
        int          method;
        char         path[8192];
        int          http_minor;
        int          header_count;
        int          content_length;
        int          keep_alive;
        const char  *body;
        http_header_t headers[32];
    } http_request_t;
    
  |

  memory_layout: {
    shape: sql_table
    label: "Memory Layout: struct http_request_t"
    
    row_0: "0x0000 | int          | method (enum: GET=0, HEAD=1, POST=2, UNK=3)"
    row_1: "0x0004 | char[8192]    | path (Normalized URI)"
    row_2: "0x2004 | int          | http_minor (0=HTTP/1.0, 1=HTTP/1.1)"
    row_3: "0x2008 | int          | header_count (Total parsed headers)"
    row_4: "0x200C | int          | content_length (-1 if absent)"
    row_5: "0x2010 | int          | keep_alive (1=True, 0=False)"
    row_6: "0x2014 | void*        | [Padding] (Alignment to 8-byte boundary)"
    row_7: "0x2018 | const char*  | body (Zero-copy pointer to raw_buf)"
    row_8: "0x2020 | http_header_t[32] | headers array (~270 KB)"

    label_bottom: "Total Size: 278,560 bytes (~272 KB)"
  }

  header_detail: {
    shape: sql_table
    label: "Element Detail: http_header_t"
    
    h_0: "0x000 | char[256]  | name (Normalized to lowercase)"
    h_1: "0x100 | char[8192] | value (OWS stripped)"
    
    label_bottom: "Size per header: 8,448 bytes"
  }

  security_notes: {
    shape: rectangle
    label: "Adversarial Defense: \n1. path[8192] enforces RFC limits. \nExceeding this results in 414 URI Too Long. \n2. header_count capped at 32 to prevent \nMemory Exhaustion attacks."
    style: {
      fill: "#fff3cd"
      stroke-dash: 3
    }
  }

  memory_layout.row_8 -> header_detail: "Array of 32 structs"
  memory_layout.row_1 -> security_notes: "Validation Point"
}

data_flow_context: {
  label: "Pointer Reference Context"
  direction: right

  raw_buffer: {
    shape: code
    label: "char req_buf[8192] (Milestone 1)"
    style.fill: "#e2e3e5"
  }

  parsed_struct: {
    label: "http_request_t Instance"
    style.stroke: "#0d6efd"
  }

  parsed_struct -> raw_buffer: "body points to req_buf + header_end" {
    style.stroke: "#0d6efd"
    style.animated: true
  }
}

http_request_t_module.memory_layout.row_7 -> data_flow_context.parsed_struct: "Offset 0x2018 | const char*"