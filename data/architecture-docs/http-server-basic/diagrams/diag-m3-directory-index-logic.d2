direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- CLASSES ---
classes: {
  decision: {
    shape: diamond
    style: {
      fill: "#fff2cc"
      stroke: "#d6b656"
    }
  }
  process: {
    shape: rectangle
    style: {
      fill: "#dae8fc"
      stroke: "#6c8ebf"
      border-radius: 4
    }
  }
  error_node: {
    shape: rectangle
    style: {
      fill: "#f8cecc"
      stroke: "#b85450"
      double-border: true
    }
  }
  success_node: {
    shape: rectangle
    style: {
      fill: "#d5e8d4"
      stroke: "#82b366"
    }
  }
  annotation: {
    shape: rectangle
    style: {
      fill: "#f5f5f5"
      stroke: "#666666"
      stroke-dash: 3
    }
  }
}

# --- LAYERS (L0 Architecture) ---

path_resolution: {
  label: "PATH RESOLUTION (file_server.c)"
  direction: down

  input_path: {
    shape: parallelogram
    label: "URL Path | char* | '/docs'"
  }

  resolve: {
    class: process
    label: "resolve_safe_path() (path.c)"
    methods: |md
      c
      char* url_decode(const char*);
      char* realpath(const char*, char*);
      bool  prefix_check(const char* root, const char* resolved);
      
    |
  }

  input_path -> resolve: "char* | variable | '/docs'"
}

directory_logic: {
  label: "DIRECTORY LOGIC (dir_handler.c)"
  direction: down

  is_dir: {
    class: decision
    label: "S_ISDIR(st.st_mode)?"
  }

  check_slash: {
    class: decision
    label: "Path ends in '/'?"
  }

  redirect_301: {
    class: error_node
    label: "301 Moved Permanently"
    tooltip: "Redirect to path + '/'"
  }

  check_index: {
    class: decision
    label: "stat('index.html') == 0?"
  }

  is_dir -> check_slash: "Yes | inode_type: DT_DIR"
  check_slash -> redirect_301: "No | Location: /docs/"
  check_slash -> check_index: "Yes"
}

response_layer: {
  label: "RESPONSE LAYER"
  direction: down

  serve_index: {
    class: success_node
    label: "200 OK | Serve index.html"
    row1: "Content-Type: text/html"
    row2: "Content-Length: [size]"
  }

  forbidden_403: {
    class: error_node
    label: "403 Forbidden"
    tooltip: "Directory listing disabled"
  }

  serve_file: {
    class: success_node
    label: "200 OK | Serve File"
    row1: "fstat(fd, &st)"
    row2: "sendfile(out, in, ...)"
  }
}

# --- ANNOTATIONS ---

security_warning: {
  class: annotation
  label: "SECURITY POLICY (security.h)"
  description: |md
    **Rule: Block Directory Listings**
    Prevents information disclosure:
    1. Structure mapping.
    2. Sensitive files (.env, .git).
    3. Fallback to 403 on index failure.
  |
}

# --- GLOBAL FLOW ---

path_resolution.resolve -> directory_logic.is_dir: "struct stat | 144 bytes | {st_mode: 0040000}"

directory_logic.is_dir -> response_layer.serve_file: "No | S_ISREG"
directory_logic.check_index -> response_layer.serve_index: "Yes | int | 0"
directory_logic.check_index -> response_layer.forbidden_403: "No | int | -1 (ENOENT)"

response_layer.forbidden_403 -> security_warning: "Security Constraint"

# Metadata / Legend
metadata: {
  shape: rectangle
  near: top-right
  label: "handle_directory_path()\nFile: file_server.c\nStandard: POSIX + RFC 7231"
  style: {
    stroke-dash: 3
    fill: transparent
    font-size: 10
  }
}