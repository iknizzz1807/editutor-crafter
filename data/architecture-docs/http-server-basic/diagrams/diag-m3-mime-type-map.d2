direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 3
  }
}

# LAYER 0: SATELLITE ORIENTATION
mime_system: {
  label: "MIME Resolution Subsystem (mime.c)"
  direction: down

  # LAYER 1: DATA STRUCTURE DEFINITION
  definitions: {
    label: "Memory Layout & Type Definitions"
    direction: right

    mime_entry_struct: {
      shape: sql_table
      label: "struct mime_entry_t (mime.h)"
      
      row1: "0x00 | const char* | extension  (e.g., '.html')"
      row2: "0x08 | const char* | mime_type  (e.g., 'text/html')"
      label_bottom: "Total: 16 bytes (x64 Architecture)"
    }

    constants: {
      shape: code
      label: "Static Table Declaration (mime.c)"
      language: c
      content: |md
        c
        static const mime_entry_t MIME_TABLE[] = {
            {".html", "text/html; charset=utf-8"},
            {".css",  "text/css"},
            {".js",   "application/javascript"},
            // ...
        };
        static const int MIME_TABLE_LEN = 15;
        
      |
    }
  }

  # LAYER 2: THE LOOKUP TABLE (Implementation-Ready Data)
  lookup_table: {
    shape: sql_table
    label: "Static Lookup Table: MIME_TABLE"
    
    header: "Extension | MIME Type String | Primary Browser Category"
    
    h1: ".html | text/html; charset=utf-8 | Text (Render)"
    h2: ".htm  | text/html; charset=utf-8 | Text (Render)"
    c1: ".css  | text/css                  | Style (Render)"
    j1: ".js   | application/javascript     | Script (Execute)"
    j2: ".json | application/json           | Data (Parse)"
    p1: ".png  | image/png                  | Image (Render)"
    p2: ".jpg  | image/jpeg                 | Image (Render)"
    p3: ".jpeg | image/jpeg                 | Image (Render)"
    g1: ".gif  | image/gif                  | Image (Render)"
    s1: ".svg  | image/svg+xml              | Vector (Render)"
    t1: ".txt  | text/plain; charset=utf-8  | Text (Render)"
    p4: ".pdf  | application/pdf            | Document (Plugin)"
    i1: ".ico  | image/x-icon               | Icon (Render)"
    w1: ".webp | image/webp                 | Image (Render)"
    x1: ".xml  | application/xml            | Markup (Parse)"
    
    label_bottom: "Linear Scan: O(N) | Cache Friendly (Contiguous Memory)"
  }

  # LAYER 3: RESOLUTION LOGIC
  lookup_logic: {
    label: "Resolution Pipeline: mime_type_for_path(const char* path)"
    direction: right

    input_path: {
      shape: rectangle
      label: "char* path"
      tooltip: "e.g., '/var/www/styles/main.min.css'"
    }
    
    extraction: {
      label: "1. Extraction"
      step: "strrchr(path, '.')"
      detail: "Finds LAST dot to handle '.min.css'"
    }

    normalization: {
      label: "2. Normalization"
      step: "tolower()"
      detail: "Ensures '.CSS' matches '.css'"
    }

    search: {
      label: "3. Linear Scan"
      step: "strcmp(ext, table[i].ext)"
      detail: "Compare against MIME_TABLE entries"
    }

    fallback: {
      label: "4. Fallback Logic"
      shape: rectangle
      style.fill: "#fff2cc"
      label: "Return 'application/octet-stream'"
    }

    input_path -> extraction -> normalization -> search
    search -> fallback: "No match found"
  }

  # LAYER 4: BROWSER BEHAVIOR (IMPACT)
  browser_behavior: {
    label: "Browser Processing Modes (Content-Type Header)"
    direction: right

    text_mode: {
      label: "Render/Execute"
      style.fill: "#d4edda"
      header: "Status 200 + text/*"
      action: "Interpret as Code/Markup"
    }

    binary_mode: {
      label: "Media Display"
      style.fill: "#cce5ff"
      header: "Status 200 + image/*"
      action: "Decode via Codec"
    }

    download_mode: {
      label: "Binary/Download"
      style.fill: "#f8d7da"
      header: "Status 200 + octet-stream"
      action: "Trigger Save-As Dialog"
    }
  }

  # Internal connections
  definitions -> lookup_table: "Defines structure"
  lookup_table -> lookup_logic: "Iterated by"
  lookup_logic -> browser_behavior: "Provides Content-Type"
}

# Annotations & Rules
mime_system.lookup_logic.search -> mime_system.lookup_table: "i++ until i == MIME_TABLE_LEN" {
  style.stroke-dash: 5
}

notes: {
  near: bottom-right
  shape: text
  label: |md
    ### Architectural Constraints:
    - **No MIME Sniffing**: We rely solely on extension mapping for security.
    - **Charset**: HTML/Text must specify `charset=utf-8` in the MIME string to prevent rendering artifacts.
    - **Security**: Returning `application/octet-stream` for unknown files prevents browsers from accidentally executing malicious scripts masked as other types.
    - **Performance**: Contiguous memory in `MIME_TABLE` ensures high cache hit rate during linear scan.
  |
}