direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- Classes & Styles ---
classes: {
  vulnerable: {
    style: {
      fill: "#ffcccc"
      stroke: "#cc0000"
      font-color: "#cc0000"
      bold: true
    }
  }
  secure: {
    style: {
      fill: "#ccffcc"
      stroke: "#006600"
      font-color: "#006600"
      bold: true
    }
  }
  logic_gate: {
    shape: diamond
    style: {
      fill: "#e6f3ff"
    }
  }
  code_block: {
    style: {
      font: mono
      fill: "#f5f5f5"
    }
  }
}

# --- Title and Legend ---
title: "Directory Traversal Attack Vectors & Defense Pipeline" {
  shape: text
  near: top-center
  style: {
    font-size: 24
    bold: true
  }
}

legend: {
  near: bottom-right
  v: "VULNERABLE (PASS)" { class: vulnerable }
  s: "SECURE (BLOCKED)" { class: secure }
}

# --- Pipeline Flow ---
pipeline: {
  label: "Path Resolution Pipeline (file_server.c)"
  direction: down

  input: "Raw URI Path | char* | \"/%2e%2e%2fetc/passwd\"" {
    shape: parallelogram
  }

  step1: "url_decode()" {
    class: code_block
    label: |md
      c
      // Step 1: Decode %-encoding
      int url_decode(const char *src, char *out, size_t out_size);
      
    |
  }

  step2: "snprintf(raw_fs_path)" {
    class: code_block
    label: |md
      c
      // Step 2: Combine root + decoded
      snprintf(raw, sizeof(raw), "%s%s", root, decoded);
      
    |
  }

  step3: "realpath(3)" {
    class: code_block
    label: |md
      c
      // Step 3: Canonicalize (Follow symlinks, resolve ..)
      char *realpath(const char *path, char *resolved_path);
      
    |
  }

  step4: "strncmp(security_check)" {
    class: code_block
    label: |md
      c
      // Step 4: Verify root prefix
      strncmp(resolved, doc_root, root_len);
      
    |
  }

  input -> step1: "char[]"
  step1 -> step2: "Decoded: \"/../../etc/passwd\""
  step2 -> step3: "Raw: \"/var/www/../../etc/passwd\""
  step3 -> step4: "Canonical: \"/etc/passwd\""
}

# --- Attack Vector Matrix ---
matrix: {
  shape: sql_table
  label: "Attack Vectors vs. Security Logic"
  
  header: "Attack Type | Input Payload | Naive strncmp Check | realpath() + Prefix Check"
  
  row1: "1. Classic Traversal | ../../../etc/passwd | [VULNERABLE] Prefix matches /var/www | [BLOCKED] Resolves to /etc/passwd"
  row2: "2. URL Encoded | %2e%2e%2fetc/passwd | [VULNERABLE] Prefix matches /var/www | [BLOCKED] Decodes -> Resolves to /etc/passwd"
  row3: "3. Double Encoded | %252e%252e%252fetc/passwd | [VULNERABLE] No '..' visible in string | [BLOCKED] Requires recursive decode or fails realpath"
  row4: "4. Symlink | /www/uploads/link | [VULNERABLE] Safe-looking path | [BLOCKED] realpath follows link to /etc/passwd"
  row5: "5. Null Byte Injection | /safe%00/../etc/passwd | [VULNERABLE] Ends in .html extension | [BLOCKED] url_decode rejects %00"

  row1.style: { fill: "#fff4f4" }
  row2.style: { fill: "#fff4f4" }
  row3.style: { fill: "#fff4f4" }
  row4.style: { fill: "#fff4f4" }
  row5.style: { fill: "#fff4f4" }
}

# --- Logic Visualizer ---
security_logic: {
  direction: right
  label: "Security Decision Logic"

  incoming: "Resolved Path"
  root: "Document Root"

  check: "startsWith(Resolved, Root)?" {
    class: logic_gate
  }

  char_check: "Resolved[root_len] == '/' OR '\\0'?" {
    class: logic_gate
    tooltip: "Prevents matching /var/www-secret when root is /var/www"
  }

  incoming -> check
  root -> check
  
  check -> char_check: "Yes"
  check -> fail: "No" { style: { stroke: red; font-color: red } }
  
  char_check -> success: "Yes" { class: secure }
  char_check -> fail: "No" { class: vulnerable }

  success: "STATUS 200: OK" { class: secure }
  fail: "STATUS 403: FORBIDDEN" { class: vulnerable }
}

pipeline.step4 -> security_logic: "resolved_path"
matrix -> pipeline: "Simulated Attacks" { style: { stroke-dash: 5 } }