direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# L0 Satellite Reference: HTTP Core (server.c)
http_keepalive_analysis: {
  label: "HTTP/1.1 Keep-Alive — Connection Reuse Timeline (Milestone 4)"
  
  # 2D Grid Layout Strategy
  grid-columns: 2
  grid-gap: 50

  # COLUMN 1: High-Fidelity Sequence Diagram
  timeline_pane: {
    timeline: {
      shape: sequence_diagram
      
      browser: "Client Browser (curl/Chrome)" {
        shape: person
      }
      server: "Worker Thread (server.c)" {
        style.fill: "#E4DBFE"
      }

      # TCP Handshake Phase
      group: "TCP 3-Way Handshake (Socket: SYN_SENT -> ESTABLISHED)" {
        browser -> server: "SYN | seq=0 | [MSS=1460, WS=256]"
        server -> browser: "SYN-ACK | seq=0, ack=1"
        browser -> server: "ACK | seq=1, ack=1"
      }

      # Request 1
      browser.r1 -> server.r1: |md
        http
        GET /index.html HTTP/1.1
        Host: localhost:8080
        Connection: keep-alive
        
      |
      server.r1 -> browser.r1: |md
        http
        HTTP/1.1 200 OK
        Content-Length: 512
        Connection: keep-alive

        [Body: index.html]
        
      |

      # Note on Persistence
      server.idle: "Server enters SO_RCVTIMEO wait (30s idle)" {
        style.stroke-dash: 3
        style.fill: "#FFF9C9"
      }

      # Request 2
      browser.r2 -> server.r2: |md
        http
        GET /style.css HTTP/1.1
        Host: localhost:8080
        
      |
      server.r2 -> browser.r2: |md
        http
        HTTP/1.1 200 OK
        Content-Length: 1024
        Connection: keep-alive

        [Body: style.css]
        
      |

      # Request 3 - Final
      browser.r3 -> server.r3: |md
        http
        GET /app.js HTTP/1.1
        Host: localhost:8080
        Connection: close
        
      |
      server.r3 -> browser.r3: |md
        http
        HTTP/1.1 200 OK
        Content-Length: 2048
        Connection: close

        [Body: app.js]
        
      |

      # Termination Phase
      group: "TCP Connection Termination (FIN Wait)" {
        server -> browser: "FIN | server_fd close()"
        browser -> server: "ACK"
        browser -> server: "FIN"
        server -> browser: "ACK"
      }
    }
  }

  # COLUMN 2: Implementation Details & Statistics
  technical_pane: {
    direction: down
    
    # Connection Control Structure
    conn_struct: {
      shape: sql_table
      label: "struct http_conn_t (server.h)"
      
      row1: "0x00 | int      | client_fd"
      row2: "0x04 | uint32_t | request_count"
      row3: "0x08 | bool     | keep_alive"
      row4: "0x0C | time_t   | last_activity"
      row5: "0x10 | char[64] | remote_addr"
      label_bottom: "Total: 80 bytes"
    }

    # Implementation Logic
    logic_check: {
      shape: class
      label: "Implementation Logic (server.c)"
      
      loop_body: |md
        c
        // Milestone 4: Keep-Alive Loop Implementation
        struct timeval tv = { .tv_sec = 30, .tv_usec = 0 };
        setsockopt(client_fd, SOL_SOCKET, SO_RCVTIMEO, &tv, sizeof(tv));

        while (conn->keep_alive) {
            ssize_t n = read_request(conn->client_fd, &buffer);
            if (n <= 0) break; // Timeout (EAGAIN) or Close

            http_response_t res = handle_request(&buffer);
            send_response(conn->client_fd, &res);

            if (header_match(buffer, "Connection", "close")) {
                conn->keep_alive = false;
            }
        }
        close(conn->client_fd);
        
      |
    }

    # Metrics
    statistics: {
      shape: sql_table
      label: "Performance Metrics (100ms RTT Link)"
      
      h10: "HTTP/1.0 | 3 Handshakes | Latency: 600ms"
      h11: "HTTP/1.1 | 1 Handshake  | Latency: 400ms"
      sav: "Efficiency | Δ Latency  | -200ms (33% Reduction)"
      label_bottom: "Syscall overhead: 3x socket(), 3x connect() -> 1x"
    }
  }

  # Semantic Linkages
  timeline_pane.timeline -> technical_pane.statistics: "Observed Trace" {
    style.stroke-dash: 5
    style.stroke: gray
  }
}