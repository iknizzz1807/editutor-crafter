direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# TITLE: Concurrency Control Strategies
title: "Concurrency Management: Thread Exhaustion vs. Bounded Resource Pools" {
  shape: text
  near: top-center
  style: {
    font-size: 24
    bold: true
  }
}

# -----------------------------------------------------------------------------
# UNBOUNDED MODEL (THE VULNERABILITY)
# -----------------------------------------------------------------------------
unbounded_model: "THREAD-PER-CONNECTION (UNSAFE)" {
  style: {
    fill: "#fff0f0"
    stroke: "#ff0000"
    stroke-width: 2
  }
  
  accept_logic: {
    label: "accept_loop (server.c)"
    direction: down
    logic: |c
      while (1) {
          int fd = accept(s_fd, NULL, NULL);
          if (fd > 0) {
              pthread_t t;
              pthread_create(&t, NULL, connection_handler, (void*)&fd);
              pthread_detach(t);
          }
      }
    |
  }

  resource_spike: {
    shape: sql_table
    label: "OS Kernel Resources (10k Clients)"
    
    row1: "Threads | 10,000 active instances"
    row2: "Stack Memory | 10,000 * 8MB = 80GB VIRT"
    row3: "Kernel Tasks | 10,000 * sizeof(task_struct) (~640MB)"
    row4: "Context Switch | Overload / Trashing"
    
    style: {
      fill: "#ffcccc"
    }
  }

  outcome_failure: "SYSTEM COLLAPSE" {
    shape: hexagon
    style: {
      fill: red
      font-color: white
      bold: true
    }
    tooltip: "EAGAIN on pthread_create or OOM Killer triggers"
  }

  accept_logic -> resource_spike: "uint32_t | 4B | spawn_thread(fd)"
  resource_spike -> outcome_failure: "SIGKILL | Resource Exhaustion"
}

# -----------------------------------------------------------------------------
# BOUNDED MODEL (THE SOLUTION)
# -----------------------------------------------------------------------------
bounded_pool_model: "BOUNDED THREAD POOL (PRODUCTION)" {
  style: {
    fill: "#f0fff0"
    stroke: "#00aa00"
    stroke-width: 2
  }

  struct_def: {
    shape: sql_table
    label: "struct thread_pool_t (thread_pool.h)"
    
    row1: "0x00 | work_item_t*   | queue (Circular Array)"
    row2: "0x08 | uint32_t       | queue_capacity (256)"
    row3: "0x0C | uint32_t       | current_size"
    row4: "0x10 | pthread_t*     | threads (Fixed 16)"
    row5: "0x18 | pthread_mutex_t| lock"
    row6: "0x40 | pthread_cond_t | not_empty_signal"
    label_bottom: "Total: 128 bytes (Metadata Head)"
  }

  work_queue: {
    label: "Synchronized Work Queue (queue.c)"
    shape: cylinder
    style: {
      fill: "#e0ffe0"
      stroke-dash: 0
    }
    content: "Pending FDs: [12, 15, 18, ...]"
  }

  worker_pool: {
    direction: right
    label: "Worker Threads (Fixed: 16)"
    
    t1: "Thread 01" { shape: person; style.fill: "#ccffcc" }
    t2: "Thread 02" { shape: person; style.fill: "#ccffcc" }
    tN: "... Thread 16" { shape: person; style.fill: "#ccffcc" }
  }

  resource_stability: {
    shape: sql_table
    label: "Stable OS Metrics (10k Clients)"
    row1: "Threads | 16 (Static Pool)"
    row2: "Stack Memory | 16 * 8MB = 128MB VIRT"
    row3: "Queue Memory | 256 * 4B = 1KB Buffer"
    row4: "Context Switch | Low / Deterministic"
    
    style: {
      fill: "#ccffcc"
    }
  }

  outcome_success: "GRACEFUL DEGRADATION" {
    shape: hexagon
    style: {
      fill: green
      font-color: white
      bold: true
    }
    tooltip: "Overload returns 503; system remains responsive"
  }

  struct_def -> work_queue: "pool_push(fd)"
  work_queue -> worker_pool: "pthread_cond_wait"
  worker_pool -> resource_stability: "Deterministic Pressure"
  resource_stability -> outcome_success: "Responsive Baseline"
}

# -----------------------------------------------------------------------------
# SHARED EXTERNAL INPUT
# -----------------------------------------------------------------------------
clients: "10,000 Concurrent TCP Clients" {
  shape: cloud
  icon: https://icons.terrastruct.com/essentials%2F005-programmer.svg
}

clients -> unbounded_model.accept_logic: "TCP SYN | Handshake Complete"
clients -> bounded_pool_model.struct_def: "TCP SYN | Handshake Complete"

# Annotations
(clients -> unbounded_model.accept_logic)[0].label: "1 conn = 1 fork/thread"
(clients -> bounded_pool_model.struct_def)[0].label: "1 conn = 1 enqueue"

legend: {
  near: bottom-right
  
  r1: "Red = Path to Crash" {
    shape: text
    style.font-color: red
  }
  g1: "Green = Production Hardened" {
    shape: text
    style.font-color: green
  }
}