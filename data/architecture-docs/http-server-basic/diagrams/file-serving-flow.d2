title: File Serving Security Flow

classes: {
  request: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  security: {
    style.fill: "#16213e"
    style.stroke: "#e17055"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  error: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
  }
  success: {
    style.fill: "#00b894"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
  }
}

start: Start {
  shape: circle
  class: request
}

receive_request: "Receive URL Request" {
  class: request
}

parse_path: "Parse URL Path" {
  class: request
}

validate_boundaries: "Check Document Root Boundaries" {
  shape: diamond
  class: security
}

path_traversal_check: "Directory Traversal Check" {
  shape: diamond
  class: security
}

file_exists: "File Exists?" {
  shape: diamond
  class: decision
}

permission_check: "Permission Validation" {
  shape: diamond
  class: security
}

detect_mime: "Detect MIME Type" {
  class: request
}

serve_file: "Serve File with Headers" {
  class: success
}

error_403: "403 Forbidden" {
  class: error
}

error_404: "404 Not Found" {
  class: error
}

start -> receive_request
receive_request -> parse_path
parse_path -> validate_boundaries

validate_boundaries -> path_traversal_check: "Within bounds"
validate_boundaries -> error_403: "Outside root"

path_traversal_check -> file_exists: "No traversal"
path_traversal_check -> error_403: "../ detected"

file_exists -> permission_check: "File found"
file_exists -> error_404: "Not found"

permission_check -> detect_mime: "Access allowed"
permission_check -> error_403: "Access denied"

detect_mime -> serve_file

security_guard: "Security Guard Layer" {
  shape: rectangle
  style.fill: "#16213e"
  style.stroke: "#e17055"
  style.stroke-dash: 3
  
  guard_boundaries: "Boundary Check"
  guard_traversal: "Traversal Check"
  guard_permissions: "Permission Check"
}