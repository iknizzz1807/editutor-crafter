direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# State Definitions
START: "" {
  shape: circle
  style.fill: black
  width: 20
  height: 20
}

CLOSED: {
  label: |md
    **CLOSED**
    ***
    **Invariant:** No resources allocated.
    **Kernel:** FD Table slot empty.
  |
}

UNBOUND: {
  label: |md
    **UNBOUND**
    ***
    **Invariant:** FD allocated, no address.
    **Kernel:** `struct socket` created.
  |
}

BOUND: {
  label: |md
    **BOUND**
    ***
    **Invariant:** Local port reserved.
    **Kernel:** `sockaddr_in` linked.
  |
}

LISTENING: {
  label: |md
    **LISTENING**
    ***
    **Invariant:** Passive socket mode.
    **Kernel:** SYN/Accept queues init.
  |
}

CONNECTED: {
  label: |md
    **CONNECTED**
    ***
    **Invariant:** Established TCP pair.
    **Kernel:** New child FD created.
  |
}

READING: {
  label: |md
    **READING**
    ***
    **Invariant:** Accumulating byte pipe.
    **Kernel:** Data in `recv_buf`.
  |
}

RESPONDING: {
  label: |md
    **RESPONDING**
    ***
    **Invariant:** Draining send pipe.
    **Kernel:** Data in `send_buf`.
  |
}

ERROR_STATE: "FATAL_ERROR" {
  style.fill: red
  style.font-color: white
}

# Valid Transitions
START -> CLOSED

CLOSED -> UNBOUND: "socket()" {
  tooltip: "AF_INET, SOCK_STREAM"
  label: "Action: alloc(fd)"
}

UNBOUND -> BOUND: "bind()" {
  tooltip: "htons(port)"
  label: "Action: assign_addr"
}

BOUND -> LISTENING: "listen()" {
  tooltip: "backlog=SOMAXCONN"
  label: "Action: set_passive"
}

LISTENING -> CONNECTED: "accept()" {
  tooltip: "blocks until SYN/ACK"
  label: "Action: fork_fd"
}

CONNECTED -> READING: "read()" {
  tooltip: "search \r\n\r\n"
  label: "Action: fill_buf"
}

READING -> RESPONDING: "write()" {
  tooltip: "RFC 7230 format"
  label: "Action: drain_buf"
}

RESPONDING -> CLOSED: "close()" {
  tooltip: "FIN/ACK handshake"
  label: "Action: free(fd)"
}

# Error Transitions (Aborts)
UNBOUND -> ERROR_STATE: "EADDRINUSE" {
  style.stroke: red
}
LISTENING -> ERROR_STATE: "EMFILE" {
  style.stroke: red
  label: "Log: No FDs"
}
READING -> CLOSED: "ECONNRESET" {
  style.stroke: orange
  label: "Clean exit"
}
RESPONDING -> CLOSED: "EPIPE / SIGPIPE" {
  style.stroke: red
  label: "Abrupt disconnect"
}

# Illegal Transitions
UNBOUND -> LISTENING: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

LISTENING -> RESPONDING: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

CONNECTED -> CLOSED: "ILLEGAL: LEAK" {
  style: {
    stroke: red
    stroke-dash: 5
  }
  label: "Must drain first?"
}

# Annotations
legend: {
  shape: rectangle
  near: top-right
  style.fill: "#fffceb"
  label: |md
    ### Syscall State Machine
    - **Solid:** Valid Syscall
    - **Red Dashed:** API Violation
    - **Red Solid:** Kernel Error
  |
}