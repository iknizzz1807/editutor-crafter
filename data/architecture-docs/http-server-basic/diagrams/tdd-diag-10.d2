direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

Normalization_Algorithm: {
  label: "Algorithm: Case-Insensitive Header Normalization"

  Step_1: {
    label: "Step 1: Ingestion & Memcpy"
    style.stroke: "#6C5CE7"
    Raw_Buffer: "Content-Type: text/html\n" {
      style.fill: "#74B9FF"
      tooltip: "Input Stream (Raw bytes)"
    }
    h_name_dest: {
      shape: sql_table
      style.fill: "#6C5CE7"
      row_0: "[ ] [ ] [ ] [ ] [ ] [ ] [ ] [ ] [ ] [ ] [ ] [ ]"
      label: "Heap Destination (12 bytes)"
    }
    Raw_Buffer -> h_name_dest: "memcpy(name_len=12)" {
      style.stroke-dash: 3
      style.stroke: orange
    }
  }

  Step_2: {
    label: "Step 2: Normalization Loop (str_to_lower)"
    style.stroke: "#6C5CE7"
    Iteration_State: {
      shape: sql_table
      style.fill: "#6C5CE7"
      i_0: "Index 0: 'C' (0x43) -> 'c' (0x63)"
      i_1: "Index 1: 'o' (0x6F) -> 'o' (0x6F)"
      i_8: "Index 8: 'T' (0x54) -> 't' (0x74)"
      
      i_0.style: {
        font-color: red
        bold: true
      }
      i_8.style: {
        font-color: red
        bold: true
      }
    }
    
    logic: "|c| |= 0x20 (Bitwise OR 32)"
  }

  Step_3: {
    label: "Step 3: Normalized Result"
    style.stroke: "#6C5CE7"
    Normalized_Buffer: {
      shape: sql_table
      style.fill: "#6C5CE7"
      content: "'c' 'o' 'n' 't' 'e' 'n' 't' '-' 't' 'y' 'p' 'e'"
      label: "sizeof = 12 bytes"
    }
    Normalized_Buffer.content: {
      style.font-color: red
      style.bold: true
      style.stroke: red
      style.stroke-width: 3
    }
  }

  Comparison_Paths: {
    label: "Comparison Logic (request_get_header)"
    style.stroke: "#6C5CE7"
    
    Success_Path: {
      label: "PROPER LOOKUP"
      call: "strcmp(\"content-type\", \"content-type\")"
      result: "MATCH (0)" {
        style.fill: "#ACE1AF"
        style.bold: true
      }
    }

    Bug_Path: {
      label: "BUGGY LOOKUP (Case Sensitive)"
      call: "strcmp(\"Content-Type\", \"content-type\")"
      result: "FAIL (!= 0)" {
        style.fill: "#FE7070"
        style.bold: true
      }
    }
  }

  Step_1 -> Step_2 -> Step_3
  Step_3 -> Comparison_Paths.Success_Path: "Search key: 'content-type'"
}

ASCII_Reference: |'md
### ASCII Transformation Logic
| Char | Hex | Bin | Char | Hex | Bin |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **'C'** | 0x43 | 0100 0011 | **'c'** | 0x63 | 0110 0011 |
| **'T'** | 0x54 | 0101 0100 | **'t'** | 0x74 | 0111 0100 |
| **Offset**| **+32**| **0x20** | | | |

*Normalization: `char |= 0x20` flips bit 5 to lowercase.*
'|

ASCII_Reference.near: top-right

# Global Styling
Normalization_Algorithm.** : {
  style: {
    font: mono
  }
}