layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
    sketch: false
  }
}

shape: sequence_diagram

# Participants (shared global scope for sequence lifelines)
Client: "HTTP Client\n(Remote Socket)"
Parser: "http_request_t*\n(Parser State)"
Server: "serve_static_file()\n(Execution Logic)"
VFS: "Linux Kernel\n(VFS/Inode Cache)"

# -----------------------------------------------------------------------------
# HEAD Request Scenario
# -----------------------------------------------------------------------------
"SCENARIO: HTTP HEAD (RFC 7231 §4.3.2)": {
  Client -> Parser: "GET /index.html HTTP/1.1" {
    style.stroke: blue
  }
  Parser -> Parser: "parse_request_line()\nmethod = METHOD_HEAD"
  
  Parser -> Server: "serve_static_file(req_t*, client_fd)"
  
  # Resource Resolution (Common Path)
  Server -> VFS: "stat(resolved_path, struct stat* st)"
  VFS -> Server: "return 0 (st_size = 1024, st_mtime = ...)"
  
  Server -> Server: "mime_type_for_path() -> 'text/html'"
  
  # Header Construction (Common Path)
  Server -> VFS: "open(resolved_path, O_RDONLY) -> file_fd=4"
  Server -> Client: "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: 1024\r\n..." {
    style.stroke: blue
  }
  
  # ---------------------------------------------------------
  # Divergent Path
  # ---------------------------------------------------------
  Server -> Server: "▼ CHECK: if (req->method == METHOD_HEAD)" {
    style.bold: true
  }
  
  Server -> VFS: "close(file_fd=4) -> 0"
  Server -> Server: "▲ EXIT: skip_body_transfer()" {
    style.font-color: red
  }
  
  Server -> Parser: "return (void)"
  
  # Standard Sequence Note (Removes "near: ancestor" error)
  Client."Total Rx: ~256B (Headers)\nPayload Rx: 0B"
}

# -----------------------------------------------------------------------------
# GET Request Scenario
# -----------------------------------------------------------------------------
"SCENARIO: HTTP GET (Standard Flow)": {
  Client -> Parser: "GET /index.html HTTP/1.1" {
    style.stroke: blue
  }
  Parser -> Parser: "parse_request_line()\nmethod = METHOD_GET"
  
  Parser -> Server: "serve_static_file(req_t*, client_fd)"
  
  # Resource Resolution (Common Path)
  Server -> VFS: "stat(path, &st)"
  VFS -> Server: "Timing: ~15µs (Page Cache Hit)" {
    style.stroke-dash: 3
    style.font-color: "#44C7B1"
  }
  
  # Header Construction (Common Path)
  Server -> VFS: "open(...) -> file_fd=5"
  Server -> Client: "HTTP/1.1 200 OK\r\nContent-Length: 1024\r\n..." {
    style.stroke: blue
  }
  
  # ---------------------------------------------------------
  # Divergent Path
  # ---------------------------------------------------------
  Server -> Server: "▼ CHECK: if (req->method != METHOD_HEAD)"
  
  loop: "File Stream Loop (64KB Chunks)" {
    Server -> VFS: "read(file_fd=5, io_buf, 65536)"
    VFS -> Server: "ssize_t: 1024"
    Server -> Client: "write_all(client_fd, io_buf, 1024)" {
      style.stroke: blue
      style.animated: true
    }
  }
  
  Server -> VFS: "close(file_fd=5) -> 0"
  Server -> Parser: "return (void)"
  
  # Standard Sequence Note (Removes "near: ancestor" error)
  Client."Total Rx: ~1280B\nPayload Rx: 1024B"
}