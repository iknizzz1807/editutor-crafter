direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
  root: "/var/www/html"
}

# --- STYLES ---
classes: {
  step_box: {
    style: {
      stroke-width: 2
      border-radius: 8
    }
  }
  header: {
    style: {
      fill: "#6a0dad"
      font-color: white
      bold: true
    }
  }
  path_data: {
    shape: rectangle
    style: {
      fill: "#e3f2fd"
      font: mono
    }
  }
  error: {
    style: {
      fill: "#ffebee"
      stroke: "#d32f2f"
      font-color: "#d32f2f"
      bold: true
    }
  }
  success: {
    style: {
      fill: "#e8f5e9"
      stroke: "#2e7d32"
      font-color: "#2e7d32"
      bold: true
    }
  }
  changed: {
    style: {
      font-color: red
      bold: true
    }
  }
}

title: |md
  # Path Resolution & Security Pipeline
  **Goal:** Map URL to Filesystem while preventing Directory Traversal
| {near: top-center}

# --- PIPELINE CONTAINERS ---

Malicious_Input: "TRAVERSAL ATTEMPT" {
  class: step_box
  
  S1: "1. url_decode()" {
    Input: "/%2e%2e%2fetc%2fpasswd"
    Output: |md
      **` /../etc/passwd `**
    |
    Output.class: [path_data; changed]
  }
  
  S2: "2. Path Concatenation" {
    Base: ${root}
    Result: |md
      **` /var/www/html/../etc/passwd `**
    |
    Result.class: [path_data; changed]
  }
  
  S3: "3. realpath() [Syscall]" {
    Internal: "Kernel VFS Resolution"
    Canonical: |md
      **` /etc/passwd `**
    |
    Canonical.class: [path_data; changed]
  }
  
  S4: "4. Prefix Boundary Check" {
    Check: "Starts with /var/www/html?"
    Verdict: "FAIL" {
      class: error
    }
    Return: "HTTP 403 Forbidden" {
      style.font-color: red
    }
  }

  S1 -> S2 -> S3 -> S4
}

Safe_Input: "LEGITIMATE REQUEST" {
  class: step_box
  
  S1: "1. url_decode()" {
    Input: "/%2findex.html"
    Output: |md
      **` /index.html `**
    |
    Output.class: path_data
  }
  
  S2: "2. Path Concatenation" {
    Base: ${root}
    Result: |md
      **` /var/www/html/index.html `**
    |
    Result.class: path_data
  }
  
  S3: "3. realpath() [Syscall]" {
    Internal: "Kernel VFS Resolution"
    Canonical: |md
      **` /var/www/html/index.html `**
    |
    Canonical.class: path_data
  }
  
  S4: "4. Prefix Boundary Check" {
    Check: "Starts with /var/www/html?"
    Verdict: "PASS" {
      class: success
    }
    Return: "0 (SUCCESS)" {
      style.font-color: green
    }
  }

  S1 -> S2 -> S3 -> S4
}

# --- ANNOTATIONS ---
Annotation: |md
  ### The canonicalization invariant
  `realpath()` must be called **before** the prefix check. 
  It resolves:
  1. `..` and `.` components
  2. Redundant slashes `//`
  3. **Symbolic links** to external dirs
| {
  near: top-right
  style.stroke-dash: 3
}

Malicious_Input.S4.Verdict -> Annotation: "Prevents Bypass" {style.stroke-dash: 5}