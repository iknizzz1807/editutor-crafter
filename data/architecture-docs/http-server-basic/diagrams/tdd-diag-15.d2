layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# States with Invariants
START: "â—" {
  shape: circle
}

URL_DECODED: "URL DECODED" {
  tooltip: "Invariant: Raw %XX sequences converted to bytes; no null bytes (%00)."
}

PATH_JOINED: "PATH JOINED" {
  tooltip: "Invariant: Full filesystem string constructed in scratch buffer."
}

CANONICALIZED: "CANONICALIZED" {
  tooltip: "Invariant: Absolute path; all symlinks, '..', and '.' components resolved."
}

PREFIX_CHECKED: "PREFIX CHECKED" {
  tooltip: "Invariant: First N bytes of resolved path exactly match document_root."
}

SAFE: "SAFE (Return 0)" {
  style: {
    fill: "#ACE1AF"
    stroke: "#167c3c"
    bold: true
  }
}

# Error Terminal States
ERROR_400: "400 BAD REQUEST" {
  style: {
    fill: "#FFC5C5"
    stroke: red
  }
}

ERROR_403: "403 FORBIDDEN" {
  style: {
    fill: "#FFC5C5"
    stroke: red
  }
}

ERROR_404: "404 NOT FOUND" {
  style: {
    fill: "#FFC5C5"
    stroke: red
  }
}

# Transitions: trigger + [guard] + action
START -> URL_DECODED: "url_decode()\n[no %00, valid hex]\nwrite to 'decoded'"

START -> ERROR_400: "url_decode()\n[malformed hex or %00]\nreject"

URL_DECODED -> PATH_JOINED: "snprintf()\n[n < MAX_PATH]\nroot + decoded"

URL_DECODED -> ERROR_400: "snprintf()\n[n >= MAX_PATH]\ntruncation guard"

PATH_JOINED -> CANONICALIZED: "realpath()\n[ptr != NULL]\nupdate 'resolved_out'"

PATH_JOINED -> ERROR_404: "realpath()\n[errno == ENOENT]\nmissing file"

PATH_JOINED -> ERROR_403: "realpath()\n[errno == EACCES]\npermission denied"

CANONICALIZED -> PREFIX_CHECKED: "strncmp()\n[match == 0]\nroot prefix verified"

CANONICALIZED -> ERROR_403: "strncmp()\n[match != 0]\ntraversal detected"

PREFIX_CHECKED -> SAFE: "boundary check\n[char is '/' or '\\0']\nreturn success"

PREFIX_CHECKED -> ERROR_403: "boundary check\n[char is alphanum]\npartial root bypass"

# Illegal Transition Annotation
PATH_JOINED -> SAFE: "ILLEGAL:\nBypass Canonicalization" {
  style: {
    stroke: red
    stroke-dash: 5
  }
  source-arrowhead: cross
}

# Annotations
legend: |md
  ### Path Resolution Guards
  - **url_decode**: Rejects `%00` to prevent C-string truncation attacks.
  - **realpath**: Essential to resolve symlinks that point outside the root.
  - **strncmp**: Verifies the resolved path still begins with the root.
  - **boundary**: Prevents `/var/www-secret` matching root `/var/www`.
| {
  near: bottom-right
}