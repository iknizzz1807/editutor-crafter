layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ALGORITHM: Directory Request Handling Logic
# Module: http-server-basic-m3
# Purpose: Resource Resolution & Directory Traversal Prevention

direction: down

legend: {
  shape: rectangle
  near: top-left
  label: |md
    ### Legend
    - **Blue**: Success Path
    - **Red**: Error/Forbidden Path
    - **Bold Red**: State Mutation
  |
  style: {
    stroke-dash: 3
    fill: "#f5f5f5"
  }
}

# Step 1: Initial Path Resolution
Step_1: {
  shape: sql_table
  label: "Step 1: Initial Stat"
  stat_call: "stat(resolved_path, &st)"
  result: "st_mode populated"
}

Step_1 -> Step_2: "Check File Type"

# Step 2: Directory Branching
Step_2: {
  shape: diamond
  label: "S_ISDIR(st.st_mode)?"
}

Step_2 -> Step_3_Regular: "NO (Is Regular File)" {
  style: {
    stroke: blue
    stroke-width: 2
  }
}

Step_2 -> Step_3_Dir: "YES (Is Directory)" {
  style: {
    stroke: orange
    stroke-width: 2
  }
}

# Branch A: Regular File
Step_3_Regular: {
  shape: sql_table
  label: "Step 3A: Direct Serve"
  check: "S_ISREG(st.st_mode)?"
  action: "serve_static_file()"
  style.fill: "#e1f5fe"
}

# Branch B: Directory Resolution
Step_3_Dir: {
  shape: sql_table
  label: "Step 3B: Index Mapping"
  buffer_check: "if (len + 11 >= 4096) goto 403"
  append: "strcat(resolved_path, '/index.html')"
  state: "resolved_path += '/index.html'" {
    style: {
      font-color: "#d32f2f"
      bold: true
    }
  }
}

Step_3_Dir -> Step_4_Stat: "Re-Stat Index File"

Step_4_Stat: {
  shape: sql_table
  label: "Step 4: Verify Index"
  stat_call: "stat(resolved_path, &st)"
  check_1: "errno == ENOENT? -> 403"
  check_2: "S_ISREG(st.st_mode)?"
}

Step_4_Stat -> Step_5_Success: "Found & Regular" {
  style.stroke: blue
}
Step_4_Stat -> Step_5_Error: "Missing or Not Regular" {
  style.stroke: red
}

# Final Terminals
Step_5_Success: {
  label: "200 OK: Serve Index"
  style.fill: "#c8e6c9"
  shape: package
}

Step_5_Error: {
  label: "403 Forbidden: No Listing"
  style: {
    fill: "#ffcdd2"
    stroke: red
  }
  shape: package
}

# Buffer Transition Visualization
Transition: {
  # FIX: ELK requires constant positions for 'near'
  near: center-right
  Before: {
    shape: sql_table
    label: "Buffer Before"
    path: "/var/www/images/\0"
    ptr: "len = 16"
  }
  
  After: {
    shape: sql_table
    label: "Buffer After"
    path: "/var/www/images/index.html\0" {
      style: {
        font-color: "#d32f2f"
        bold: true
      }
    }
    ptr: "len = 26"
  }
  
  Before.path -> After.path: "strncat" {
    style.stroke-dash: 3
  }
}

# Annotation for Engineers
Note: |md
  ### Implementation Note
  `realpath()` must be called **BEFORE** this logic to ensure `resolved_path`
  is canonicalized. This logic only handles the `index.html` mapping 
  internally. If `index.html` is a symlink pointing outside the root, 
  the next `open()` call or a recursive security check will catch it.
| {
  shape: rectangle
  # FIX: ELK requires constant positions for 'near'
  near: bottom-right
}