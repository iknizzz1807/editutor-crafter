direction: right
layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

# --- Module: MIME Type Resolution Pipeline ---

path_input: "/var/www/html/images/photo.min.jpg" {
  shape: cylinder
  style: {
    fill: "#dae8fc" # Data: Blue
    stroke: "#6c8ebf"
    stroke-width: 2
  }
}

pipeline: {
  # Step 1: Pointer Search
  step1: "1. strrchr(path, '.')" {
    shape: rectangle
    style: {
      fill: "#e1d5e7" # Header: Purple
      stroke: "#9673a6"
    }
  }

  # Step 2: Normalization
  step2: "2. str_to_lower(ext)" {
    shape: rectangle
    style: {
      fill: "#e1d5e7"
    }
  }

  # Step 3: Linear Table Scan
  scan_logic: "3. Linear Scan Loop" {
    style: {
      stroke-dash: 3
    }
    comparison: "strcmp(normalized, MIME_TABLE[i].ext)" {
      shape: diamond
    }
  }
}

# --- Data Structure: MIME_TABLE ---
# Contiguous memory layout in static data segment
MIME_TABLE: {
  shape: sql_table
  style: {
    fill: "#e1d5e7" # Header: Purple
    stroke: "#9673a6"
  }
  header: "Index | Extension | MIME Type (Value)"
  0: "0 | .html | text/html; charset=utf-8" {style.fill: "#ffffff"}
  1: "1 | .css  | text/css" {style.fill: "#ffffff"}
  2: "2 | .js   | application/javascript" {style.fill: "#ffffff"}
  dot: "... | ... | ..." {style.fill: "#ffffff"}
  6: "6 | .jpg  | image/jpeg" {
    style: {
      fill: "#d5e8d4" # Match: Green
      bold: true
    }
  }
  14: "14 | .webp | image/webp" {style.fill: "#ffffff"}
}

# --- Exit Points ---
result_ok: "image/jpeg" {
  shape: cloud
  style: {
    fill: "#d5e8d4" # Green
    stroke: "#82b366"
    bold: true
  }
}

fallback: "application/octet-stream" {
  shape: cloud
  style: {
    fill: "#f5f5f5" # Gray: Generic Padding
    stroke: "#666666"
  }
}

# --- Data Flow Connections ---
path_input -> pipeline.step1: "const char *path"
pipeline.step1 -> pipeline.step2: "'.jpg'" {
  style.stroke: "#ff8c00" # Pointer: Orange
}
pipeline.step2 -> pipeline.scan_logic.comparison: "normalized: '.jpg'"

pipeline.scan_logic.comparison <-> MIME_TABLE: "O(N) search" {
  style.stroke: "#dae8fc"
}

pipeline.scan_logic.comparison -> result_ok: "Match found"
pipeline.scan_logic.comparison -> fallback: "i == 15 (No match)"

# --- Documentation Annotations ---
annotation: |md
  ### The strrchr() Advantage
  Why **strrchr** instead of **strchr**?
  
  Consider `main.min.css`:
  - `strchr` returns `.min.css` (Unknown)
  - `strrchr` returns `.css` (Match: text/css)
  
  *Implementation handles nested dots and complex extensions.*
| {
  near: top-right
  style: {
    font-size: 11
  }
}

# Global Styles
pipeline.**.style.font: mono
MIME_TABLE.**.style.font: mono