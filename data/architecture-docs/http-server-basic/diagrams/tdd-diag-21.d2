direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# --- STYLES ---
classes: {
  header: {
    style: {
      fill: "#6a1b9a"
      font-color: white
      bold: true
    }
  }
  data_field: {
    style: {
      fill: "#1976d2"
      font-color: white
    }
  }
  pointer_field: {
    style: {
      fill: "#ef6c00"
      font-color: white
    }
  }
  padding_field: {
    style: {
      fill: "#9e9e9e"
      font-color: black
    }
  }
  cache_boundary: {
    style: {
      stroke-dash: 5
      stroke: "#f44336"
      font-color: "#f44336"
      bold: true
    }
  }
}

# --- DIAGRAM ---
thread_pool_t: "thread_pool_t | sizeof: 208 bytes" {
  shape: sql_table
  style: {
    stroke-width: 2
    fill: "#6a1b9a" # Header color: Purple
  }

  "0x00": "void** queue" { class: pointer_field; constraint: "8 bytes" }
  "0x08": "int queue_capacity" { class: data_field; constraint: "4 bytes" }
  "0x0C": "int queue_head" { class: data_field; constraint: "4 bytes" }
  "0x10": "int queue_tail" { class: data_field; constraint: "4 bytes" }
  "0x14": "int queue_size" { class: data_field; constraint: "4 bytes" }
  "0x18": "pthread_mutex_t lock" { class: data_field; constraint: "40 bytes" }

  # Cache Line 1 (64 bytes)
  " ": "---------------- CACHE LINE BOUNDARY (64B) ----------------" { class: cache_boundary }

  "0x40": "pthread_cond_t not_empty" { class: data_field; constraint: "48 bytes" }
  "0x70": "pthread_cond_t not_full (p1)" { class: data_field; constraint: "16 bytes" }

  # Cache Line 2 (128 bytes)
  "  ": "---------------- CACHE LINE BOUNDARY (128B) ---------------" { class: cache_boundary }

  "0x80": "pthread_cond_t not_full (p2)" { class: data_field; constraint: "32 bytes" }
  "0xA0": "pthread_t* threads" { class: pointer_field; constraint: "8 bytes" }
  "0xA8": "int num_threads" { class: data_field; constraint: "4 bytes" }
  "0xAC": "int shutdown" { class: data_field; constraint: "4 bytes" }
  "0xB0": "int active_connections" { class: data_field; constraint: "4 bytes" }
  "0xB4": "alignment padding" { class: padding_field; constraint: "4 bytes" }
  "0xB8": "long total_requests" { class: data_field; constraint: "8 bytes" }

  # Cache Line 3 (192 bytes)
  "   ": "---------------- CACHE LINE BOUNDARY (192B) ---------------" { class: cache_boundary }

  "0xC0": "const char* document_root" { class: pointer_field; constraint: "8 bytes" }
  "0xC8": "int idle_timeout" { class: data_field; constraint: "4 bytes" }
  "0xCC": "alignment padding" { class: padding_field; constraint: "4 bytes" }
}

annotation: |md
  ### Analysis: Concurrency & False Sharing
  - **Shared Cache Line**: `active_connections` (0xB0) and `total_requests` (0xB8) reside in the same cache line [128-192].
  - **Performance Hit**: Frequent atomic updates to both fields by different worker threads will trigger **Cache Invalidation Traffic** (MESI Protocol).
  - **Optimization**: Pad the space between them with a full cache line or use `__attribute__((aligned(64)))`.
| {
  near: bottom-center
}