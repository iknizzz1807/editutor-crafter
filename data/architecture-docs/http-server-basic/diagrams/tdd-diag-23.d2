vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

classes: {
  mem_header: { style: { fill: "#6e41ab"; font-color: white; bold: true } }
  mem_data: { style: { fill: "#3b82f6"; font-color: white } }
  mem_free: { style: { fill: "#10b981"; font-color: white } }
  mem_padding: { style: { fill: "#94a3b8"; font-color: white } }
  ptr: { style: { stroke: "#f59e0b"; stroke-width: 3; font-color: "#f59e0b"; bold: true } }
  changed: { style: { stroke: "#ef4444"; stroke-width: 4; bold: true; font-color: "#ef4444" } }
}

direction: right

# Global Annotation
Title: "Circular Queue State Transitions (64B Cache Line)" {
  shape: text
  style.font-size: 24
  near: top-center
}

# -----------------------------------------------------------------------------
# STATE A
# -----------------------------------------------------------------------------
StateA: "1. INITIAL STATE" {
  style.stroke-dash: 5
  
  Head: "HEAD (ptr)" { class: ptr }
  Tail: "TAIL (ptr)" { class: ptr }

  Layout: {
    shape: sql_table
    style.fill: "#6e41ab"
    
    "0x00": "Slot [0]: EMPTY" {constraint: "8B"; class: mem_free}
    "0x08": "Slot [1]: EMPTY" {constraint: "8B"; class: mem_free}
    "0x10": "Slot [2]: fd=9" {constraint: "8B"; class: mem_data}
    "0x18": "Slot [3]: fd=12" {constraint: "8B"; class: mem_data}
    "0x20": "Slot [4]: fd=15" {constraint: "8B"; class: mem_data}
    "0x28": "Slot [5]: EMPTY" {constraint: "8B"; class: mem_free}
    "0x30": "Slot [6]: EMPTY" {constraint: "8B"; class: mem_free}
    "0x38": "Slot [7]: EMPTY" {constraint: "8B"; class: mem_free}
  }

  Head -> Layout."0x10"
  Tail -> Layout."0x28"
  
  Footer: "Size: 3/8" {
    shape: text
    near: bottom-center
  }
}

# -----------------------------------------------------------------------------
# STATE B
# -----------------------------------------------------------------------------
StateB: "2. ENQUEUE FD 22" {
  style.stroke-dash: 5

  Head: "HEAD" { class: ptr }
  Tail: "**TAIL (6)**" { class: [ptr; changed] }

  Layout: {
    shape: sql_table
    style.fill: "#6e41ab"
    
    "0x00": "Slot [0]: EMPTY" {constraint: "8B"; class: mem_free}
    "0x08": "Slot [1]: EMPTY" {constraint: "8B"; class: mem_free}
    "0x10": "Slot [2]: fd=9" {constraint: "8B"; class: mem_data}
    "0x18": "Slot [3]: fd=12" {constraint: "8B"; class: mem_data}
    "0x20": "Slot [4]: fd=15" {constraint: "8B"; class: mem_data}
    "0x28": "**Slot [5]: fd=22**" {constraint: "8B"; class: [mem_data; changed]}
    "0x30": "Slot [6]: EMPTY" {constraint: "8B"; class: mem_free}
    "0x38": "Slot [7]: EMPTY" {constraint: "8B"; class: mem_free}
  }

  Head -> Layout."0x10"
  Tail -> Layout."0x30"

  Footer: "Size: 4/8" {
    shape: text
    near: bottom-center
  }
}

# -----------------------------------------------------------------------------
# STATE C
# -----------------------------------------------------------------------------
StateC: "3. DEQUEUE" {
  style.stroke-dash: 5

  Head: "**HEAD (3)**" { class: [ptr; changed] }
  Tail: "TAIL" { class: ptr }

  Layout: {
    shape: sql_table
    style.fill: "#6e41ab"
    
    "0x00": "Slot [0]: EMPTY" {constraint: "8B"; class: mem_free}
    "0x08": "Slot [1]: EMPTY" {constraint: "8B"; class: mem_free}
    "0x10": "**Slot [2]: FREE**" {constraint: "8B"; class: [mem_free; changed]}
    "0x18": "Slot [3]: fd=12" {constraint: "8B"; class: mem_data}
    "0x20": "Slot [4]: fd=15" {constraint: "8B"; class: mem_data}
    "0x28": "Slot [5]: fd=22" {constraint: "8B"; class: mem_data}
    "0x30": "Slot [6]: EMPTY" {constraint: "8B"; class: mem_free}
    "0x38": "Slot [7]: EMPTY" {constraint: "8B"; class: mem_free}
  }

  Head -> Layout."0x18"
  Tail -> Layout."0x30"

  Footer: "Size: 3/8" {
    shape: text
    near: bottom-center
  }
}

# -----------------------------------------------------------------------------
# FLOW AND DOCS
# -----------------------------------------------------------------------------
StateA -> StateB: "Enqueue(22)" { style.stroke-width: 4 }
StateB -> StateC: "Dequeue()" { style.stroke-width: 4 }

LogicInvariants: "LOGIC INVARIANTS" {
  style.fill: "#fef9c3"
  content: |md
    ### Memory Specs
    - **Total:** 64B (Cache Line)
    - **Alignment:** 8-byte
    - **Colors:**
      - Purple: Header/Metadata
      - Blue: Active Data
      - Green: Available Space
      - Red: Changed this step
  |
}

(StateA -> StateB)[0].style.animated: true
(StateB -> StateC)[0].style.animated: true