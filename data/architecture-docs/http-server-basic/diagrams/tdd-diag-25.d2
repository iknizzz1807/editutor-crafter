layout-engine: elk

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

KeepAlive_Algorithm: {
  grid-columns: 5
  grid-gap: 50

  Step1: "Step 1: Initial Handshake" {
    Socket: "FD 12"
    TCP_State: "ESTABLISHED"
    Handshake: "SYN -> SYN-ACK -> ACK"
    Latency: "1ms RTT"
    
    Socket.style.font-color: blue
    TCP_State.style.font-color: blue
  }

  Step2: "Step 2: First Request" {
    Socket: "FD 12"
    Action: "**READING_HEADERS**"
    Header: "**Connection: keep-alive**"
    Response: "**200 OK**"
    Latency: "0ms (Reused)"

    Action.style.font-color: red
    Action.style.bold: true
    Header.style.font-color: red
    Header.style.bold: true
    Response.style.font-color: red
    Response.style.bold: true
  }

  Step3: "Step 3: Socket Loopback" {
    Socket: "FD 12"
    Action: "**RE-USE POOL THREAD**"
    State: "**WAITING_FOR_DATA**"
    Status: "Keep-Alive Active"
    Latency: "0ms (Reused)"

    Action.style.font-color: red
    Action.style.bold: true
    State.style.font-color: red
    State.style.bold: true
  }

  Step4: "Step 4: Conditional Request" {
    Socket: "FD 12"
    Input: "**If-Modified-Since**"
    Logic: "**st_mtime <= IMS**"
    Response: "**304 Not Modified**"
    Payload: "**0 Bytes Sent**"

    Input.style.font-color: red
    Input.style.bold: true
    Logic.style.font-color: red
    Logic.style.bold: true
    Response.style.font-color: red
    Response.style.bold: true
    Payload.style.font-color: red
    Payload.style.bold: true
  }

  Step5: "Step 5: Connection Close" {
    Socket: "**CLOSED**"
    Trigger: "**Connection: close**"
    Action: "**close(12)**"
    TCP_State: "**FIN-WAIT**"

    Socket.style.font-color: red
    Socket.style.bold: true
    Trigger.style.font-color: red
    Trigger.style.bold: true
    Action.style.font-color: red
    Action.style.bold: true
    TCP_State.style.font-color: red
    TCP_State.style.bold: true
  }

  Step1 -> Step2: "recv(GET /)"
  Step2 -> Step3: "Loop back to start"
  Step3 -> Step4: "recv(GET /logo.png)"
  Step4 -> Step5: "recv(close)"
}

Efficiency_Annotation: |md
  ### TCP Performance Analysis
  - **Standard Sequential**: 3 Requests Ã— (1ms Handshake) = **3ms Overhead**
  - **HTTP/1.1 Keep-Alive**: 1 Handshake + 3 Reuses = **1ms Overhead**
  - **Latency Savings**: **-66% RTT Reduction**
| {
  near: bottom-center
}

KeepAlive_Algorithm.Step2.style.stroke: red
KeepAlive_Algorithm.Step2.style.stroke-width: 4
KeepAlive_Algorithm.Step3.style.stroke: red
KeepAlive_Algorithm.Step3.style.stroke-width: 4
KeepAlive_Algorithm.Step4.style.stroke: red
KeepAlive_Algorithm.Step4.style.stroke-width: 4
KeepAlive_Algorithm.Step5.style.stroke: red
KeepAlive_Algorithm.Step5.style.stroke-width: 4