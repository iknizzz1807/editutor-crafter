vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# SO_RCVTIMEO Idle Timeout — The Slowloris Defense
# Diagram Type: Sequence Diagram
# Context: Concurrent Connections / Resource Protection

Slowloris_Defense: {
  shape: sequence_diagram

  Attacker: "Hostile Client (Slowloris)" {
    style.fill: "#ffcccc"
  }
  Kernel: "OS Kernel (TCP Stack & Timer)" {
    style.fill: "#e6f3ff"
  }
  Worker: "Worker Thread (HTTP Server)" {
    style.fill: "#e6ffe6"
  }

  # Phase 1: Connection Setup
  Attacker -> Kernel: "TCP_Handshake(SYN/ACK)"
  Kernel -> Worker: "accept(server_fd): client_fd=12"
  Worker -> Kernel: "setsockopt(12, SOL_SOCKET, SO_RCVTIMEO, 30s)"

  # Phase 2: Hostile Partial Request
  Attacker -> Kernel: "send(12, 'GET / ...')" {
    tooltip: "Attacker omits final CRLF delimiter to hold connection open"
    style: {
      stroke: orange
      stroke-width: 2
    }
  }

  # Phase 3: The Blocking Read
  # Using spans to represent thread state
  Worker.read_call -> Kernel.read_block: "read(12, buf, 8192)" {
    style: {
      stroke: blue
    }
  }
  
  # Manual Annotation for the block
  Kernel."Thread ▼ BLOCKS; waits for headers" {
    style: {
      stroke: blue
      stroke-dash: 2
    }
  }

  # Phase 4: Timer Execution
  Kernel."30s SO_RCVTIMEO Countdown" {
    style: {
      stroke-dash: 5
      fill: "#fff4e6"
    }
  }

  Kernel."... 30 Seconds of Idle Silence ..."

  # Phase 5: Timeout Recovery
  # Returning from the block with error state
  Kernel.read_block -> Worker.read_call: "return -1 (errno=EAGAIN)" {
    style: {
      stroke: red
      bold: true
    }
  }
  
  Worker."**TIMEOUT DETECTED**" {
    style: {
      font-color: red
      bold: true
    }
  }

  # Phase 6: Graceful Cleanup
  Worker -> Worker: "cleanup_keep_alive_context()"
  Worker -> Kernel: "close(12) returns 0" {
    style: {
      stroke: green
    }
  }
  
  Worker."▲ Release File Descriptor"

  Worker."**THREAD AVAILABLE**" {
    tooltip: "Ready to handle legitimate clients"
    style: {
      font-color: green
      bold: true
    }
  }
}

# Legend and Annotations
Legend: {
  near: bottom-center
  
  EAGAIN: |md
    ### EAGAIN / EWOULDBLOCK
    Indicates the operation would block, but the 
    kernel timer (SO_RCVTIMEO) expired first.
  |
  
  Mechanism: |md
    ### Resource Recovery
    Without this timeout, the Worker thread stays
    blocked indefinitely, leading to **Thread Exhaustion**.
  |
}