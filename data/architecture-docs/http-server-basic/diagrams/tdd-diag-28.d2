layout-engine: elk
vars: {
  d2-config: {
    theme-id: 6
  }
}

# Graceful Shutdown — 4-Phase Sequence Diagram
# Tracks the coordinated exit of a multi-threaded HTTP server
shape: sequence_diagram

OS: "Operating System / Kernel"
Signal_Thread: "Signal Handler Thread\n(sigwait)"
Accept_Loop: "Main Thread\n(Accept Loop)"
Worker_Idle: "Worker Thread 1\n(Sleeping/Idle)"
Worker_Active: "Worker Thread N\n(In-flight)"

Phase_1: "PHASE 1: SIGNAL INITIATION" {
  OS -> Signal_Thread: "SIGTERM / SIGINT" {
    style: {
      stroke: red
      animated: true
    }
  }
  Signal_Thread -> Signal_Thread: "sigwait() returns"
  
  Signal_Thread -> Signal_Thread: "pool->lock ▼"
  Signal_Thread -> Signal_Thread: "set pool->shutdown = 1" {
    style.font-color: red
    style.bold: true
  }
  Signal_Thread -> OS: "pthread_cond_broadcast(&not_empty)"
  Signal_Thread -> Signal_Thread: "pool->lock ▲"
}

Phase_2: "PHASE 2: ACCEPT TERMINATION" {
  Accept_Loop -> Accept_Loop: "Check pool->shutdown == 1"
  Accept_Loop -> OS: "close(server_fd)"
  OS."Invalidate listening socket"
  
  Accept_Loop."ECONNREFUSED for new callers"
}

Phase_3: "PHASE 3: WORKER DRAINING" {
  # Worker 1 was idle, waiting on condition variable
  OS -> Worker_Idle: "Wake from cond_wait"
  Worker_Idle -> Worker_Idle: "Check shutdown && size == 0"
  Worker_Idle -> Worker_Idle: "pthread_exit(NULL)" {
    style.stroke: red
  }

  # Worker N was busy serving a file
  Worker_Active -> Worker_Active: "serve_static_file() finishes"
  Worker_Active -> Worker_Active: "Check shutdown && size == 0"
  Worker_Active -> Worker_Active: "pthread_exit(NULL)" {
    style.stroke: red
  }
}

Phase_4: "PHASE 4: RECLAMATION" {
  Accept_Loop -> Worker_Idle: "pthread_join()"
  Accept_Loop <- Worker_Idle: "Success"
  
  Accept_Loop -> Worker_Active: "pthread_join()"
  Accept_Loop <- Worker_Active: "Success"
  
  Accept_Loop -> Accept_Loop: "free(pool->threads)\nfree(pool->queue)"
  Accept_Loop -> Accept_Loop: "destroy mutex/cond"
  
  Accept_Loop -> OS: "exit(0)" {
    style.stroke: green
    style.bold: true
  }
}

# Documentation Block within Sequence Context
# In sequence diagrams, objects without connections act as timeline notes
Implementation Details: |md
  ### Invariants During Shutdown
  1. **Non-Blocking Logic**: The `Accept_Loop` must check the `shutdown` flag *before* every `accept()` call.
  2. **Socket Invalidation**: Closing the `server_fd` ensures that even if a thread is blocked in `accept()`, it wakes with `EBADF`.
  3. **Atomic Completion**: Workers never check the shutdown flag *mid-request*. They finish the current HTTP transaction to prevent partial responses.
|

# Annotations for Engineers
Signal_Thread.style: {
  fill: "#E4DBFE"
}
Worker_Idle.style: {
  stroke-dash: 5
}
Worker_Active.style: {
  stroke-width: 2
}