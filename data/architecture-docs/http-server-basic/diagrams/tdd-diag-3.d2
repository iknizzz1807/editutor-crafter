direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

classes: {
  header_f: {
    style: {
      fill: "#E1BEE7"
      stroke: "#4A148C"
      stroke-width: 2
    }
  }
  data_f: {
    style: {
      fill: "#BBDEFB"
      stroke: "#0D47A1"
      stroke-width: 2
    }
  }
  padding_f: {
    style: {
      fill: "#EEEEEE"
      stroke: "#616161"
      stroke-width: 2
    }
  }
  cache_boundary: {
    style: {
      stroke: "#000000"
      stroke-dash: 5
    }
  }
  page_boundary: {
    style: {
      stroke: "#000000"
      stroke-width: 6
    }
  }
}

# -----------------------------------------------------------------------------
# Memory Segment: server_config_t
# -----------------------------------------------------------------------------
config: "server_config_t (sizeof = 16B)" {
  shape: sql_table
  style: {
    stroke: "#4A148C"
    stroke-width: 2
  }
  
  # Offsets left, sizes right
  0x00: "port" {constraint: "4B"; class: header_f}
  0x04: "server_fd" {constraint: "4B"; class: header_f}
  0x08: "is_running" {constraint: "4B"; class: header_f}
  0x0C: "padding" {constraint: "4B"; class: padding_f}
}

# -----------------------------------------------------------------------------
# Memory Segment: req_buf (Request Buffer)
# -----------------------------------------------------------------------------
req: "req_buf (8192B / 2 Pages)\n(Stack Allocated)" {
  
  c0: "Cache Line 0 (0-63)" {
    shape: sql_table
    0x0000: "Header Segment" {constraint: "64B"; class: data_f}
  }
  
  sep_c0: "" {
    class: cache_boundary
    width: 400
  }
  
  c1: "Cache Line 1 (64-127)" {
    shape: sql_table
    0x0040: "Header Continuation" {constraint: "64B"; class: data_f}
  }

  dots: "..." {
    shape: text
  }

  page_break_1: "PAGE BOUNDARY (4096B)" {
    class: page_boundary
    width: 450
  }

  c64: "Cache Line 64 (4096-4159)" {
    shape: sql_table
    0x1000: "Body Segment Start" {constraint: "64B"; class: data_f}
  }

  dots2: "..." {
    shape: text
  }

  page_break_2: "END OF BUFFER (8192B)" {
    class: page_boundary
    width: 450
  }

  c0 -> sep_c0 -> c1 -> dots -> page_break_1 -> c64 -> dots2 -> page_break_2: {style.stroke-width: 0}
}

# -----------------------------------------------------------------------------
# Memory Segment: resp_buf (Response Buffer)
# -----------------------------------------------------------------------------
resp: "resp_buf (4096B / 1 Page)\n(Stack Allocated)" {
  
  rc0: "Cache Line 0 (0-63)" {
    shape: sql_table
    0x0000: "Response Headers" {constraint: "64B"; class: data_f}
  }
  
  rsep: "" {
    class: cache_boundary
    width: 400
  }

  rdots: "..." {
    shape: text
  }

  rpage: "PAGE BOUNDARY (4096B)" {
    class: page_boundary
    width: 450
  }

  rc0 -> rsep -> rdots -> rpage: {style.stroke-width: 0}
}

config -> req: "Adjacent in Memory (Stack)" {
  style: {
    stroke-dash: 2
    stroke: orange
  }
}
req -> resp: "Sequential Buffer Allocation" {
  style: {
    stroke-dash: 2
    stroke: orange
  }
}

# Legend and Annotation
annotation: |md
  ## Architecture Notes
  - **Cache Alignment**: All buffers start on 64B boundaries to prevent false sharing.
  - **Page Alignment**: `req_buf` spans exactly two 4KB hardware pages.
  - **Color Code**: 
    - <span style="color:#4A148C">Purple</span>: Configuration Header
    - <span style="color:#0D47A1">Blue</span>: Raw Request/Response Data
    - <span style="color:#616161">Gray</span>: Memory Alignment Padding
| {
  near: bottom-right
}