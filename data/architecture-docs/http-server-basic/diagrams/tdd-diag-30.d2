direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

shape: sequence_diagram

Main_Thread: "Main Thread\n(CPU-0)" {
  style.stroke: "#007acc"
  style.fill: "#e1f5fe"
}

Worker_3: "Worker-3\n(CPU-1)" {
  style.stroke: "#2e7d32"
  style.fill: "#e8f5e9"
}

OS_Kernel: "OS/Kernel\n(Linux VFS/TCP)" {
  style.stroke: "#5d4037"
  style.fill: "#efebe9"
}

Hardware: "Hardware\n(MESI/DMA/MMU)" {
  style.stroke: "#e65100"
  style.fill: "#fff3e0"
}

# --- TIMELINE START ---

Main_Thread -> OS_Kernel: "accept(server_fd)" {
  style.stroke: blue
}

OS_Kernel -> Hardware: "Check TCP Accept Queue"
Hardware -> OS_Kernel: "Established Handshake (ACK received)"

OS_Kernel -> Main_Thread: "return client_fd=12" {
  style.stroke: blue
}

Main_Thread -> Hardware: "▼ Mutex Lock (LOCK CMPXCHG)\nTiming: ~40-100 cycles\nTriggers MESI Invalidation"

Hardware -> Hardware: "Invalidate Cache Line @ CPU-1" {
  style.stroke-dash: 3
}

Main_Thread -> Main_Thread: "pool->queue[tail] = 12\nsize++"

Main_Thread -> OS_Kernel: "pthread_cond_signal(not_empty)" {
  style.stroke-dash: 5
}

Main_Thread -> Hardware: "▲ Mutex Unlock"

Main_Thread -> OS_Kernel: "accept(server_fd) [BLOCKING]" {
  style.stroke: blue
}

# --- CONCURRENCY SHIFT ---

OS_Kernel -> OS_Kernel: "Transition Worker-3\nSLEEP -> RUNNABLE"

OS_Kernel -> Hardware: "Save Context (CPU-0) / Load Context (CPU-1)\nCost: ~1-5µs"

Worker_3.t1: "pthread_cond_wait returns"

Worker_3.t1 -> Hardware: "▼ Mutex Lock (Reacquire)" {
  style.stroke: orange
}

Worker_3.t1 -> Worker_3.t1: "Dequeue item=12\nsize--"

Worker_3.t1 -> Hardware: "▲ Mutex Unlock" {
  style.stroke: orange
}

Worker_3.t1 -> Worker_3.t1: "handle_connection(12)" {
  style.bold: true
}

Worker_3.t1 -> OS_Kernel: "read(12, req_buf, 8192)" {
  style.stroke: blue
}

OS_Kernel -> Hardware: "Memory Copy (Page Cache -> req_buf)\nL1/L2 Locality: ~1ns/byte"

OS_Kernel -> Worker_3.t1: "return bytes_read" {
  style.stroke: blue
}

# --- PARALLEL ACTION ---

Hardware."**HARDWARE SOUL:**\nWhile Worker-3 processes FD 12 on CPU-1, \nMain Thread is already waiting for FD 13 on CPU-0.\nZero synchronization overhead during I/O."

# --- STYLES ---

(Main_Thread -> Hardware)[0].style.font-color: orange
(Worker_3.t1 -> Hardware)[0].style.font-color: orange
(Worker_3.t1 -> Hardware)[1].style.font-color: orange

(OS_Kernel -> Hardware)[0].style.stroke-dash: 2
(Hardware -> OS_Kernel)[0].style.stroke-dash: 2