direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- CLASSES ---
classes: {
  fd_header: {
    style: {
      fill: "#673AB7"
      font-color: "#ffffff"
      bold: true
    }
  }
  leaked_node: {
    style: {
      fill: "#FE7070"
      font-color: "#ffffff"
      bold: true
    }
  }
}

# --- STEP 1: BASELINE STATE ---
step_1: "1. Baseline Initialization" {
  style.stroke-width: 4
  fd_table: {
    shape: sql_table
    label: "Kernel FD Table (PID: 1234)"
    class: fd_header
    0: "stdin" {constraint: "read-only"}
    1: "stdout" {constraint: "write-only"}
    2: "stderr" {constraint: "write-only"}
    3: "server_fd" {constraint: "listening (8080)"}
    4: "misc_fd" {constraint: "epoll/timer"}
  }
  stats: {
    shape: rectangle
    style.fill: "#E8F5E9"
    label: |md
      **Open FD Count**: 5
      **Status**: Ready
    |
  }
}

# --- STEP 2: CORRECT LIFECYCLE ---
step_2: "2. Success Path (Per-Request)" {
  style.stroke-width: 4
  fd_table: {
    shape: sql_table
    label: "Transient State"
    class: fd_header
    0: "stdin"
    1: "stdout"
    2: "stderr"
    3: "server_fd"
    4: "misc_fd"
    5: "socket" {
      constraint: "**client_fd (Active)**"
      style.fill: "#ACE1AF"
      style.bold: true
    }
  }
  logic: {
    label: |md
      1. `accept()` returns **5**
      2. Serve file `/index.html`
      3. **`close(5)`** invoked
    |
  }
  fd_table.5 -> logic: "cleanup" {style.stroke-dash: 3}
}

# --- STEP 3: LEAK SCENARIO ---
step_3: "3. Leak Path (EAGAIN/Timeout)" {
  style.stroke: red
  style.stroke-width: 4
  fd_table: {
    shape: sql_table
    label: "Leaked State (After 1000 Timeouts)"
    class: fd_header
    0: "stdin"
    1: "stdout"
    2: "stderr"
    3: "server_fd"
    4: "misc_fd"
    5: "socket" {
      constraint: "**client_fd (LEAKED)**"
      style.fill: "#FE7070"
      style.font-color: "#ffffff"
    }
    6: "socket" {
      constraint: "**client_fd (LEAKED)**"
      style.fill: "#FE7070"
      style.font-color: "#ffffff"
    }
    "..." : "..."
    1005: "socket" {
      constraint: "**client_fd (LEAKED)**"
      style.fill: "#FE7070"
      style.font-color: "#ffffff"
    }
  }
  logic: {
    label: |md
      1. `read()` returns `-1` (**EAGAIN**)
      2. Code skips `close(fd)` branch
      3. **FD remains allocated** in kernel
    |
  }
}

# --- STEP 4: FINAL VERIFICATION ---
step_4: "4. Verification & Result" {
  style.stroke-width: 4
  grid-columns: 2
  
  pass_view: "PASSED (No Leak)" {
    style.fill: "#E1F5FE"
    label: |md
      **Baseline**: 5
      **Final**: 5
      **Delta**: 0
      **Result**: **OK**
    |
  }
  
  fail_view: "FAILED (Resource Exhaustion)" {
    style.fill: "#FFEBEE"
    style.stroke: red
    label: |md
      **Baseline**: 5
      **Final**: 1024 (ulimit)
      **Next `accept()`**: **EMFILE**
      **Result**: **CRASH**
    |
  }
}

# --- TRANSITIONS ---
step_1 -> step_2: "Normal Operation"
step_2 -> step_3: "Timeout Error (Bugged)" {
  style.stroke: red
  style.stroke-width: 2
}
step_3 -> step_4.fail_view: "Exhaustion" {
  style.stroke: red
  style.animated: true
}
step_2 -> step_4.pass_view: "10,000 iterations" {
  style.stroke: green
}

# --- ANNOTATIONS ---
explanation: {
  shape: rectangle
  near: step_4
  style.stroke-dash: 3
  style.fill: "#F5F5F5"
  label: |`md
    ### Invariant Checklist
    - `final_count - baseline_count <= 2`
    - All error paths (EAGAIN, EPIPE, 404) must reach `close(fd)`
    - Monitor via: `ls /proc/<pid>/fd | wc -l`
  `|
}