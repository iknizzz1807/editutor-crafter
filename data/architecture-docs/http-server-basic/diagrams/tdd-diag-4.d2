layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
    layout-engine: elk
  }
}

title: |md
  ### Three-Level View: What Happens on accept()
  *Lifecycle of a TCP connection from NIC to User-space*
| {
  near: top-center
  shape: text
}

shape: sequence_diagram

# Participants
Application: {
  label: "Application\n(User-space)"
  style.fill: "#E1F5FE"
}
OS_Kernel: {
  label: "OS / Kernel\n(Network Stack)"
  style.fill: "#F3E5F5"
}
Hardware_NIC: {
  label: "Hardware\n(NIC / Physical)"
  style.fill: "#E8F5E9"
}

# Sequence
Application -> OS_Kernel: "accept(server_fd) -> blocks" {
  style.stroke: blue
}

OS_Kernel.t1: "Thread State: TASK_INTERRUPTIBLE" {
  style.stroke-dash: 3
}

Hardware_NIC -> OS_Kernel: "[Ethernet Frame] TCP SYN" {
  style.stroke: red
  tooltip: "Physical Arrival"
}

OS_Kernel: "Interrupt Handler (ISR)"
OS_Kernel: "DMA Transfer into RX Ring"

# Synchronization of Queues
OS_Kernel: "SYN Queue: Lock Acquire ▼" {
  style.font-size: 10
}
OS_Kernel: "TCP Handshake: SYN-ACK Sent"
OS_Kernel: "SYN Queue: Lock Release ▲" {
  style.font-size: 10
}

Hardware_NIC -> OS_Kernel: "[Ethernet Frame] TCP ACK" {
  style.stroke: green
}

OS_Kernel: "TCP Handshake Complete"

# Moving to Accept Queue
OS_Kernel: "Accept Queue: Lock Acquire ▼"
OS_Kernel: "Move from SYN -> Accept Queue"
OS_Kernel: "Accept Queue: Lock Release ▲"

# Transition back to Application
OS_Kernel -> Application: "SCHED_WAKEUP (Task Runnable)" {
  style.animated: true
}

note right of OS_Kernel: |md
  **Timing Annotation**
  - NIC -> Kernel IRQ: ~1µs
  - Context Switch: ~1-2µs
|

OS_Kernel: "Allocate File Descriptor (e.g. fd=5)"

Application <- OS_Kernel: "return client_fd (5)" {
  style.stroke: blue
  style.bold: true
}

# Footer Legend/Annotation
Annotation: |md
  **Legend:**
  - Blue: API Call / Return
  - Red: External Ingress (Untrusted)
  - Green: Handshake Completion
  - Dashed: Process State Change
| {
  near: bottom-center
  shape: text
}

# Styles
Application.style.stroke: "#01579B"
OS_Kernel.style.stroke: "#4A148C"
Hardware_NIC.style.stroke: "#1B5E20"