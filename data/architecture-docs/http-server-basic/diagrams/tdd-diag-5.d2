layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

explanation: |md
  ### SIGPIPE Scenario: Death vs. Survival
  When a TCP client disconnects unexpectedly, the first `write()` from the server usually succeeds as the kernel hasn't yet processed the remote disconnection. The remote then sends an **RST** packet. A subsequent `write()` to that socket triggers the kernel to send a `SIGPIPE` signal to the process.
| {
  near: top-center
}

before: "BEFORE FIX (Default Behavior)" {
  style: {
    stroke: red
    stroke-width: 4
  }

  step1: "1. Initial Write" {
    app: "App Process\n(Running)"
    kernel: "Kernel Stack"
    socket: "Socket FD=5"
    client: "Remote Client\n(CLOSED)"
    
    app -> kernel: "write(fd=5, ...)"
    kernel -> socket: "Sends Data"
    socket -> client: "Packet Sent"
    client -> socket: "**RST Packet**" {style.stroke: red; style.bold: true}
  }

  step2: "2. The Kill" {
    app: "App Process\n(Running)"
    kernel: "Kernel Stack"
    socket: "Socket FD=5\n(RST Received)"
    
    app -> kernel: "**write(fd=5, ...)**" {style.stroke: red; style.bold: true}
    kernel -> app: "**SIGPIPE Signal**" {style.stroke: red; style.bold: true}
    app.style.fill: "#FFCCCC"
    app.label: "**App Terminated\n(Default Signal Action)**"
  }

  step1 -> step2: "Next write() call"
}

after: "AFTER FIX (SIG_IGN applied)" {
  style: {
    stroke: green
    stroke-width: 4
  }

  step1: "1. Startup Setup" {
    app: "App Process\n(Running)"
    mask: "Signal Handler Table"
    mask.sigpipe: "**SIGPIPE: SIG_IGN**" {style.fill: "#CCFFCC"; style.bold: true}
  }

  step2: "2. Failed Write" {
    app: "App Process\n(Running)"
    kernel: "Kernel Stack"
    socket: "Socket FD=5\n(RST Received)"
    
    app -> kernel: "write(fd=5, ...)"
    kernel -> app: "**returns -1**\n**errno = EPIPE**" {style.stroke: green; style.bold: true}
  }

  step3: "3. Graceful Recovery" {
    app: "App Process\n(Running)"
    code: "Error Handler"
    code.logic: "if (n < 0) {\n  close(fd);\n  continue;\n}" {style.font: mono}
    
    app -> code: "Check Return"
    code -> app: "**Server Survives**" {style.stroke: green; style.bold: true}
  }

  step1 -> step2: "Client Disconnects"
  step2 -> step3: "Logic branch"
}

before -> after: "Fix: signal(SIGPIPE, SIG_IGN)" {
  style.stroke-dash: 5
}