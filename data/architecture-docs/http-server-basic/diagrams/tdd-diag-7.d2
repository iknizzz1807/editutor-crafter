direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

memory_map: {
  grid-columns: 3
  grid-gap: 0
  
  # Header Row
  offset_h: "Offset" { style.font-color: "#666666"; style.bold: true; style.stroke: transparent }
  field_h: "Field Definition" { style.font-color: "#666666"; style.bold: true; style.stroke: transparent }
  size_h: "Size" { style.font-color: "#666666"; style.bold: true; style.stroke: transparent }

  # --- CACHE LINE 0 ---
  o0: "0x0000" { style.stroke: transparent; style.font: mono }
  f0: "method (http_method_t)" { 
    style.fill: "#E1D5E7"
    tooltip: "Hot Field: Clustered in L1 on entry"
  }
  s0: "4B" { style.stroke: transparent; style.font: mono }

  o1: "0x0004" { style.stroke: transparent; style.font: mono }
  f1: "path[0...59]" { style.fill: "#DAE8FC" }
  s1: "60B" { style.stroke: transparent; style.font: mono }

  cl0: {
    grid-column-span: 3
    label: "-------------------------- Cache Line 0 (64B Boundary) --------------------------"
    style: { stroke-dash: 3; font-size: 10; font-color: "#888888"; stroke: transparent }
  }

  # --- DATA BLOCK (PATH) ---
  o2: "0x0040" { style.stroke: transparent; style.font: mono }
  f2: "path[60...4091]" { 
    style.fill: "#DAE8FC"
    label: "path continued... (spans 128 cache lines)"
  }
  s2: "4032B" { style.stroke: transparent; style.font: mono }

  pb1: {
    grid-column-span: 3
    label: "======================== PAGE BOUNDARY (4096B) ========================"
    style: { stroke-width: 3; font-size: 12; font-color: "#000000"; stroke: "#000000" }
  }

  o3: "0x1000" { style.stroke: transparent; style.font: mono }
  f3: "path[4092...8187]" { style.fill: "#DAE8FC" }
  s3: "4096B" { style.stroke: transparent; style.font: mono }

  pb2: {
    grid-column-span: 3
    label: "======================== PAGE BOUNDARY (8192B) ========================"
    style: { stroke-width: 3; font-size: 12; font-color: "#000000"; stroke: "#000000" }
  }

  # --- CONTROL CLUSTER (8KB OFFSET) ---
  o4: "0x2000" { style.stroke: transparent; style.font: mono }
  f4: "path[8188...8191]" { style.fill: "#DAE8FC" }
  s4: "4B" { style.stroke: transparent; style.font: mono }

  o5: "0x2004" { style.stroke: transparent; style.font: mono }
  f5: "http_minor (int)" { style.fill: "#E1D5E7" }
  s5: "4B" { style.stroke: transparent; style.font: mono }

  o6: "0x2008" { style.stroke: transparent; style.font: mono }
  f6: "header_count (int)" { 
    style.fill: "#E1D5E7"
    style.bold: true
    tooltip: "Hot Field: Modified during parse"
  }
  s6: "4B" { style.stroke: transparent; style.font: mono }

  o7: "0x200C" { style.stroke: transparent; style.font: mono }
  f7: "content_length (int)" { style.fill: "#DAE8FC" }
  s7: "4B" { style.stroke: transparent; style.font: mono }

  o8: "0x2010" { style.stroke: transparent; style.font: mono }
  f8: "keep_alive (int)" { 
    style.fill: "#E1D5E7"
    style.bold: true
    tooltip: "Hot Field: Used by connection loop"
  }
  s8: "4B" { style.stroke: transparent; style.font: mono }

  o9: "0x2014" { style.stroke: transparent; style.font: mono }
  f9: "padding (alignment)" { style.fill: "#F5F5F5" }
  s9: "4B" { style.stroke: transparent; style.font: mono }

  o10: "0x2018" { style.stroke: transparent; style.font: mono }
  f10: "body (const char*)" { 
    style.fill: "#FFE6CC"
    tooltip: "Zero-copy pointer into recv buffer"
  }
  s10: "8B" { style.stroke: transparent; style.font: mono }

  cl128: {
    grid-column-span: 3
    label: "-------------------------- Cache Line 128 Boundary --------------------------"
    style: { stroke-dash: 3; font-size: 10; font-color: "#888888"; stroke: transparent }
  }

  # --- HEADERS ARRAY ---
  o11: "0x2020" { style.stroke: transparent; style.font: mono }
  f11: "headers[32] (http_header_t[])" { 
    style.fill: "#DAE8FC"
    tooltip: "Each element: 8448B (name[256] + value[8192])"
  }
  s11: "270,336B" { style.stroke: transparent; style.font: mono }

  footer: {
    grid-column-span: 3
    label: "Total Size: 278,560 Bytes (~272 KB)"
    style: { stroke: transparent; bold: true; font-size: 14; text-transform: uppercase }
  }
}

annotations: {
  legend: |md
    ### Memory Invariants
    - **Header (Purple)**: Protocol control fields.
    - **Data (Blue)**: Payload/Buffer segments.
    - **Pointer (Orange)**: Virtual address references.
    - **Padding (Gray)**: 8-byte boundary alignment.
  |
}