direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- RAW BYTE BUFFER (INPUT) ---
raw_buffer: "Raw Request Buffer (Incoming TCP Stream)" {
  style: {
    stroke-width: 2
    fill: "#f8f9fa"
  }

  request_line: {
    grid-columns: 6
    method: "GET" {
      tooltip: "Offset: 0, Size: 3"
      style.fill: "#D1C4E9" # Purple (Header)
    }
    sp1: "0x20" {
      label: "SP"
      style.fill: "#E0E0E0" # Gray (Padding/Delimiter)
    }
    target: "/index.html" {
      tooltip: "Offset: 4, Size: N"
      style.fill: "#BBDEFB" # Blue (Data)
    }
    sp2: "0x20" {
      label: "SP"
      style.fill: "#E0E0E0"
    }
    version: "HTTP/1.1" {
      tooltip: "Offset: N+2, Size: 8"
      style.fill: "#D1C4E9"
    }
    crlf1: "\\r\\n" {
      style.fill: "#E0E0E0"
    }
  }

  headers_block: {
    grid-columns: 5
    h_name: "Host" { style.fill: "#BBDEFB" }
    h_colon: ":" { style.fill: "#E0E0E0" }
    h_ows: " " { label: "OWS"; style.fill: "#E0E0E0" }
    h_val: "localhost" { style.fill: "#BBDEFB" }
    h_crlf: "\\r\\n" { style.fill: "#E0E0E0" }
  }

  terminator: "\\r\\n (Blank Line)" {
    style.fill: "#C8E6C9" # Green (Free/End)
    style.stroke-dash: 3
  }
}

# --- STRUCTURED DATA (OUTPUT) ---
http_request_t: "struct http_request_t" {
  shape: sql_table
  style.fill: "#FFF9C4"
  
  method: "int (METHOD_GET)" { constraint: "0x00" }
  path: "char[8192] (\"/index.html\")" { constraint: "0x04" }
  http_minor: "int (1)" { constraint: "0x2004" }
  header_count: "int (1)" { constraint: "0x44008" }
  headers: "http_header_t[0].name = \"host\"" { constraint: "0x2008" }
}

# --- PARSING LOGIC / MAPPINGS ---
raw_buffer.request_line.method -> http_request_t.method: "parse_method()" {
  style: {
    stroke: "#FF9800" # Orange (Pointers/Mappings)
    stroke-width: 2
    animated: true
  }
}

raw_buffer.request_line.target -> http_request_t.path: "memcpy() after URL decode" {
  style.stroke: "#FF9800"
}

raw_buffer.request_line.version -> http_request_t.http_minor: "parse_http_version()" {
  style.stroke: "#FF9800"
}

raw_buffer.headers_block.h_name -> http_request_t.headers: "str_to_lower()" {
  style.stroke: "#FF9800"
}

# --- ANNOTATIONS ---
arithmetic: |md
  ### Offset Arithmetic
  - `path_start` = `buf + 4`
  - `path_len` = `(version_start - path_start) - 1`
  - `header_end` = `strstr(buf, "\r\n\r\n") + 4`
| {
  near: top-left
  style.font-size: 10
}

legend: {
  near: bottom-right
  h: Header { style.fill: "#D1C4E9" }
  d: Data { style.fill: "#BBDEFB" }
  p: Delimiter { style.fill: "#E0E0E0" }
  e: End { style.fill: "#C8E6C9" }
}