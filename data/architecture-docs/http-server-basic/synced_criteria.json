[
  {
    "milestone_id": "http-server-basic-m1",
    "criteria": [
      "Server accepts a configurable port number as a command-line argument (argv[1]) with a default of 8080 if no argument is provided; invalid port values (non-numeric, out of range 1–65535) print an error and exit",
      "Server creates a listening socket using socket(AF_INET, SOCK_STREAM, 0), sets SO_REUSEADDR, calls bind() with htons() for correct network byte order, and calls listen() with SOMAXCONN backlog before entering the accept loop",
      "Accept loop calls accept() in a continuous while(1) loop, handles EINTR by retrying, logs per-connection errors without crashing the server, and continues to the next connection on non-fatal errors",
      "Request reading uses a loop that accumulates bytes from successive read() calls into a single buffer until the \\r\\n\\r\\n delimiter is found via strstr(), correctly handles partial reads where each read() returns fewer bytes than the total request size",
      "read() return value of 0 (client disconnected) is detected and treated as a non-fatal per-connection error: client_fd is closed and the accept loop continues without crashing",
      "Response is a valid HTTP/1.1 200 OK message containing exactly these headers: Content-Type (text/html; charset=utf-8), Content-Length (matching exact byte count of the body), Date (RFC 7231 GMT format from system clock), and Connection: close, followed by a blank line and HTML body",
      "write() calls use a write-all loop that retries partial writes, checking the return value and treating -1 with EPIPE as a non-fatal per-connection error",
      "SIGPIPE is suppressed at server startup via signal(SIGPIPE, SIG_IGN) so that writing to a closed client socket returns EPIPE errno rather than terminating the server process",
      "client_fd is closed via close(client_fd) after the response is fully sent, including on all error paths within the connection handler (read failure, write failure, request too large)",
      "After 1000 sequential connections, the server's open file descriptor count (verified via /proc/<pid>/fd/) returns to the same baseline count as at startup, confirming zero FD leaks",
      "Request buffer enforces a maximum size (8192 bytes); if the buffer fills without finding \\r\\n\\r\\n, the connection is closed without crashing",
      "Server logs the client IP address (via inet_ntop), client port, and first line of the HTTP request for each accepted connection"
    ]
  },
  {
    "milestone_id": "http-server-basic-m2",
    "criteria": [
      "Parse request line extracting method, path, and HTTP version from the first line of the buffer; method field is one of METHOD_GET, METHOD_HEAD, METHOD_POST, or METHOD_UNKNOWN (integer enum, not string)",
      "Return 400 Bad Request for any malformed request line: missing space delimiter, empty path, unknown HTTP version format (not 'HTTP/1.X'), or no request line at all",
      "Return 501 Not Implemented for any HTTP method that is syntactically valid but not in the supported set (GET, HEAD, POST) — for example DELETE, PUT, PATCH, OPTIONS",
      "Return 414 URI Too Long when the request-target (path) portion of the request line exceeds 8192 bytes (MAX_PATH_LEN constant)",
      "Parse all header lines into a fixed-size array of name/value pairs (up to 32 headers); silently skip malformed header lines that lack a colon separator",
      "Normalize all header names to lowercase during parsing so that 'Content-Type', 'content-type', and 'CONTENT-TYPE' are all stored identically as 'content-type'",
      "Strip Optional WhiteSpace (spaces and tabs) from both ends of header values during parsing: 'Content-Type:  text/html  ' stores as 'text/html'",
      "Accept both CRLF (\\r\\n) and bare LF (\\n) as line terminators; a request with bare LF line endings must parse successfully and return the same result as one with CRLF",
      "Return 400 Bad Request for any HTTP/1.1 request (http_minor == 1) that lacks a Host header; HTTP/1.0 requests (http_minor == 0) without Host are accepted",
      "Extract Content-Length header into an integer field (content_length): -1 if header absent, the parsed integer value if present; reject values over 64MB or containing non-numeric characters by treating as absent (-1)",
      "Set keep_alive field: 1 for HTTP/1.1 requests without 'Connection: close', 0 for HTTP/1.0 requests without 'Connection: keep-alive', and honor the explicit Connection header value (case-insensitive comparison)",
      "HEAD method requests are parsed with method == METHOD_HEAD; the parser makes no distinction between GET and HEAD (body suppression is the responder's responsibility, not the parser's)",
      "request_get_header() lookup uses lowercase names and finds headers regardless of the original capitalization the client used",
      "No file descriptor leak on any error path: after 100 malformed or incomplete connections, the server's open FD count returns to baseline",
      "The parsed http_request_t is populated by a single parse_http_request() function that takes the raw buffer and header_end offset from Milestone 1's read loop and returns 0 on success or an HTTP status code on failure"
    ]
  },
  {
    "milestone_id": "http-server-basic-m3",
    "criteria": [
      "Server accepts a document root directory as a command-line argument and prints its realpath()-canonicalized absolute path at startup",
      "URL path is percent-decoded before filesystem operations, with %00 (null byte) rejected as an invalid encoding",
      "Resolved filesystem path is computed by concatenating the canonical document root with the decoded URL path, then passed through realpath() to follow all symlinks and resolve all .. and . components",
      "After realpath() canonicalization, the resolved path is verified to start with the canonical document root followed by '/' or end-of-string; paths that escape the root return 403 Forbidden",
      "Symlinks inside the document root that point to paths outside the root are rejected with 403 Forbidden, detected via realpath() resolving to a path outside the root",
      "GET /../../etc/passwd (raw) and GET /%2e%2e%2f%2e%2e%2fetc%2fpasswd (URL-encoded) both return 403 Forbidden without serving any file contents",
      "Content-Type header is set based on file extension (case-insensitive) for at least: .html→text/html; charset=utf-8, .css→text/css, .js→application/javascript, .json→application/json, .png→image/png, .jpg→image/jpeg, .gif→image/gif, .svg→image/svg+xml, .txt→text/plain; charset=utf-8, .pdf→application/pdf; unknown extensions return application/octet-stream",
      "File contents are read in binary mode and transmitted byte-for-byte; PNG and other binary files verified intact (e.g., via 'file -' command on the response body)",
      "Content-Length header in the response matches the exact byte count of the file as reported by stat()",
      "All 200 OK file responses include a Last-Modified header formatted as RFC 7231 HTTP-date (e.g., 'Sat, 28 Feb 2026 12:00:00 GMT') using the file's st_mtime in UTC",
      "If-Modified-Since header is parsed as an HTTP-date; if the file's st_mtime is less than or equal to the parsed timestamp, server returns 304 Not Modified with no response body",
      "304 Not Modified response includes Last-Modified and Date headers but zero bytes of body",
      "Requests for missing files return 404 Not Found with a non-empty HTML error body",
      "Requests for paths that resolve outside the document root return 403 Forbidden with a non-empty HTML error body",
      "Requests for a directory path where index.html exists inside that directory serve the index.html file with 200 OK",
      "Requests for a directory path where index.html does not exist return 403 Forbidden",
      "HEAD requests return the same status code and headers as the equivalent GET request (including Content-Length) but with zero bytes of body",
      "File descriptor count in /proc/<pid>/fd/ returns to baseline after 1000 sequential requests including error cases (404, 403, 304, 200), verifying no fd leaks on any code path",
      "stat() is called on the resolved path to obtain file size and modification time; S_ISREG() check rejects non-regular files (devices, pipes) with 403 Forbidden",
      "realpath() on the document root is called once at server startup, not per request"
    ]
  },
  {
    "milestone_id": "http-server-basic-m4",
    "criteria": [
      "Thread pool initializes with configurable size (default 16 worker threads) and configurable queue capacity (default 256), confirmed by server startup log output",
      "Each accepted connection is submitted to the thread pool's circular work queue and handled by a worker thread; the accept loop never directly processes requests",
      "When the thread pool queue is at capacity, new connections receive a valid HTTP/1.1 503 Service Unavailable response before the socket is closed — the connection is never silently dropped",
      "HTTP/1.1 keep-alive: a single TCP connection handles multiple sequential requests when the client sends Connection: keep-alive (or omits Connection header in HTTP/1.1); the connection closes only when Connection: close is received or an error occurs",
      "HTTP/1.1 keep-alive: a Connection: close request header causes the server to close the connection after sending exactly one response",
      "Per-connection idle timeout (default 30 seconds) implemented via SO_RCVTIMEO: a connection that sends no data for longer than the timeout is closed by the server, freeing the worker thread",
      "Graceful shutdown on SIGTERM: server stops accepting new connections, all worker threads complete their current in-flight requests, then all threads are joined and the process exits with code 0",
      "Graceful shutdown on SIGINT: identical behavior to SIGTERM — in-flight requests complete before process exit",
      "Signal handling uses pthread_sigmask() to block signals in all threads and sigwait() in a dedicated signal thread — no async signal handlers run in worker threads",
      "SIGPIPE is ignored globally (via sigaction with SIG_IGN) so that writing to a disconnected client socket returns EPIPE rather than killing the server process",
      "All shared mutable state (work queue, shutdown flag, active_connections counter, total_requests counter) is protected by a single pool mutex; no field is written from one thread and read from another without holding the mutex",
      "The thread sanitizer build (gcc -fsanitize=thread) reports zero data races when the server is exercised with 50+ concurrent connections",
      "Access log output is protected by a dedicated log mutex so that log lines from concurrent worker threads do not interleave on stdout",
      "After 10,000 sequential connections with a mix of 200, 304, 404, and 503 responses, the server's open file descriptor count (from /proc/<pid>/fd) returns to within 2 of the baseline count measured before the connections",
      "Worker threads use a while loop (not if) around pthread_cond_wait() to correctly handle spurious wakeups from the condition variable",
      "pthread_create() failures during pool initialization trigger cleanup of already-created threads before returning an error — no thread or memory is leaked on partial initialization failure",
      "The document root is canonicalized via realpath() exactly once at server startup and passed read-only to all worker threads — no per-request realpath() call on the document root",
      "Pool size and idle timeout are not hardcoded in connection-handling logic but read from the thread_pool_t configuration struct, making them runtime-tunable",
      "50 concurrent curl requests all receive identical, correct 200 OK responses — verified by comparing md5sum of all response bodies"
    ]
  },
  {
    "module_id": "http-server-basic-m1",
    "criteria": [
      "Server binds to port 8080 and handles SO_REUSEADDR correctly",
      "read_http_request handles partial reads by looping until CRLF-CRLF",
      "write_all handles partial writes without data loss",
      "Hardcoded HTTP/1.1 response includes Date and Content-Length",
      "SIGPIPE is ignored or suppressed to prevent server crash",
      "Every client FD is explicitly closed, verified by no FD growth under load"
    ]
  },
  {
    "module_id": "http-server-basic-m2",
    "criteria": [
      "Implement http_request_t with fixed-size arrays for path (8192) and headers (32).",
      "Implement parse_request_line with support for GET, HEAD, POST and rejection of others with 501.",
      "Implement header parsing with mandatory lowercase normalization of keys.",
      "Enforce mandatory Host header check for HTTP/1.1 requests (return 400 if missing).",
      "Implement OWS (Optional WhiteSpace) stripping for header values per RFC 7230.",
      "Handle both CRLF and bare LF as line terminators for robustness.",
      "Ensure zero malloc() calls during the entire parsing phase.",
      "Return 414 URI Too Long if the request path exceeds 8191 characters.",
      "Correctly identify keep-alive status based on Connection header and HTTP version (1.0 vs 1.1).",
      "Extract Content-Length as an integer using safe strtol() with error checking."
    ]
  },
  {
    "module_id": "http-server-basic-m3",
    "criteria": [
      "url_decode rejects %00 and malformed hex",
      "resolve_safe_path uses realpath() and prefix check",
      "handle_directory_path re-stats for index.html",
      "mime_type_for_path uses static MIME_TABLE",
      "If-Modified-Since returns 304 with no body",
      "64KB I/O loop manages file_fd closure in all paths",
      "Zero malloc() used during request handling",
      "MIME names normalized to lowercase for comparison"
    ]
  },
  {
    "module_id": "http-server-basic-m4",
    "criteria": [
      "Thread pool initialization creates exact number of requested pthreads",
      "Work queue uses a circular buffer to prevent O(N) shifts",
      "Mutex protects all access to queue_size, head, tail, and shutdown flag",
      "Condition variables used to prevent busy-waiting in worker threads",
      "SO_RCVTIMEO is set on client sockets to prevent Slowloris resource holding",
      "Keep-alive loop correctly identifies 'Connection: close' to terminate session",
      "Signal thread uses sigwait to handle SIGTERM/SIGINT synchronously",
      "Accept loop implements exponential backoff on EMFILE errors",
      "Graceful shutdown drains the existing work queue before worker threads exit",
      "No data races detected by ThreadSanitizer under 400+ concurrent connections"
    ]
  }
]