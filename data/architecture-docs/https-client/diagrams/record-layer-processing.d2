direction: down

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  error: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  data: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

title: TLS Record Layer Processing Flow {
  near: top-center
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
}

start: {
  shape: circle
  style.fill: "#3fb950"
  label: ""
}

incoming_bytes: Incoming TCP Bytes {
  class: data
}

tcp_reassembly: TCP Stream Reassembly {
  class: process
}

buffer_check: Sufficient bytes\nfor TLS header? {
  shape: diamond
  class: decision
}

parse_header: Parse TLS Record Header {
  class: process
}

header_valid: Valid TLS\nrecord header? {
  shape: diamond
  class: decision
}

payload_check: Complete payload\navailable? {
  shape: diamond
  class: decision
}

extract_record: Extract Complete\nTLS Record {
  class: process
}

encrypted_check: Record encrypted? {
  shape: diamond
  class: decision
}

decrypt_record: Decrypt Record Payload {
  class: process
}

decrypt_error: Decryption Failed {
  class: error
}

classify_message: Classify Message Type {
  class: process
}

handshake_msg: Handshake Message {
  class: data
}

app_data: Application Data {
  class: data
}

alert_msg: Alert Message {
  class: data
}

change_cipher: Change Cipher Spec {
  class: data
}

protocol_error: Protocol Error {
  class: error
}

wait_more_data: Wait for More Data {
  class: data
}

start -> incoming_bytes
incoming_bytes -> tcp_reassembly
tcp_reassembly -> buffer_check

buffer_check -> wait_more_data: No
buffer_check -> parse_header: Yes

parse_header -> header_valid
header_valid -> protocol_error: Invalid
header_valid -> payload_check: Valid

payload_check -> wait_more_data: No
payload_check -> extract_record: Yes

extract_record -> encrypted_check

encrypted_check -> decrypt_record: Yes
encrypted_check -> classify_message: No

decrypt_record -> decrypt_error: Failed
decrypt_record -> classify_message: Success

classify_message -> handshake_msg: Handshake (22)
classify_message -> app_data: Application Data (23)
classify_message -> alert_msg: Alert (21)
classify_message -> change_cipher: Change Cipher Spec (20)

wait_more_data -> buffer_check: More data arrives
decrypt_error -> protocol_error
protocol_error -> start: Reset connection