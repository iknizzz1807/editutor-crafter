shape: sequence_diagram

style: {
  fill: "#1a1a2e"
  stroke: "#3fb950"
  font-color: "#e6edf3"
}

user: User {
  style.bold: true
  style.fill: "#16213e"
}
cli: CLI {
  style.fill: "#16213e"
}
state_manager: State Manager {
  style.fill: "#16213e"
}
executor: Executor {
  style.fill: "#16213e"
}
provider: Provider {
  style.fill: "#16213e"
}

user -> cli: apply command
cli -> state_manager: 1. acquire lock
state_manager -> cli: lock acquired
cli -> executor: 2. execute plan
executor -> executor: 3. analyze dependencies

group {
  style.stroke: "#8b949e"
  style.fill: "#0f3460"
  style.stroke-width: 1
  
  loop Resources (concurrent) {
    executor -> provider: 4a. apply resource
    provider -> provider: 5a. API calls
    provider -> executor: 6a. result
    
    alt Failure {
      executor -> executor: 7a. retry logic
      executor -> provider: retry apply
      provider -> executor: retry result
    }
  }
}

executor -> cli: 8. execution complete
cli -> state_manager: 9. write new state
state_manager -> cli: state written
cli -> state_manager: 10. release lock
cli -> user: apply completed