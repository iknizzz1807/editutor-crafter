title: "io_uring Ring Memory Layout"
description: "Diagram illustrating the shared memory rings: Submission Queue (SQ) ring with head, tail, array, and SQEs. Completion Queue (CQ) ring with head, tail, and CQEs. Show the separation between ring metadata and the actual entry arrays."

io_uring_rings: {
  shape: rectangle
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"

  # Submission Queue Ring
  sq_ring: Submission Queue (SQ) Ring {
    style.fill: "#16213e"
    style.stroke: "#8b949e"

    sq_metadata: {
      shape: rectangle
      style.fill: "#0f3460"
      style.stroke: "#8b949e"
      style.bold: true
      label: "SQ Ring Metadata (Shared)"

      sq_head: "head (user space updates)" {
        style.bold: true
      }
      sq_tail: "tail (kernel consumes)" {
        style.bold: true
      }
      sq_ring_mask: "ring mask"
      sq_ring_entries: "ring entries"
      sq_flags: "flags"
      sq_dropped: "dropped"
    }

    sq_array: SQ Array (indices) {
      shape: sql_table
      style.fill: "#0f3460"
      style.stroke: "#8b949e"
      label: "Circular buffer of SQE indices"
      columns: 1
      index_0: "0 → SQE[0]"
      index_1: "1 → SQE[1]"
      index_2: "2 → SQE[2]"
      index_n: "N-1 → SQE[N-1]"
    }
  }

  # Submission Queue Entries
  sqes: {
    shape: rectangle
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    label: "Submission Queue Entries (SQEs)"
    style.font-color: "#e6edf3"

    sqe_array: {
      shape: sql_table
      style.fill: "#0f3460"
      style.stroke: "#8b949e"
      label: "SQE Array (Separate memory region)"
      columns: 1
      sqe_0: "SQE 0: {opcode, fd, addr, len, ...}"
      sqe_1: "SQE 1: {opcode, fd, addr, len, ...}"
      sqe_2: "SQE 2: {opcode, fd, addr, len, ...}"
      sqe_n: "SQE N-1: {opcode, fd, addr, len, ...}"
    }
  }

  # Completion Queue Ring
  cq_ring: Completion Queue (CQ) Ring {
    style.fill: "#16213e"
    style.stroke: "#8b949e"

    cq_metadata: {
      shape: rectangle
      style.fill: "#0f3460"
      style.stroke: "#8b949e"
      style.bold: true
      label: "CQ Ring Metadata (Shared)"

      cq_head: "head (kernel produces)" {
        style.bold: true
      }
      cq_tail: "tail (user space reads)" {
        style.bold: true
      }
      cq_ring_mask: "ring mask"
      cq_ring_entries: "ring entries"
      cq_overflow: "overflow"
      cq_cqes: "cqes"
    }

    cqe_array: {
      shape: sql_table
      style.fill: "#0f3460"
      style.stroke: "#8b949e"
      label: "CQE Array (Completion events)"
      columns: 1
      cqe_0: "CQE 0: {user_data, res, flags}"
      cqe_1: "CQE 1: {user_data, res, flags}"
      cqe_2: "CQE 2: {user_data, res, flags}"
      cqe_n: "CQE N-1: {user_data, res, flags}"
    }
  }

  # Relationships and annotations
  note: |md
    **Key Concepts:**
    - **Shared Memory:** Kernel and user space share ring metadata
    - **Producer/Consumer:** Lock-free via head/tail pointers
    - **Indirection:** SQ array points to actual SQE entries
    - **Separation:** Metadata and entry arrays can be in different memory regions
  | {
    shape: page
    style.fill: "#2d4263"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }

  # Arrows showing relationships
  sq_ring.sq_array -> sqes.sqe_array: "indices reference"
  sq_ring.sq_metadata.sq_head -> sq_ring.sq_array: "user updates, kernel reads"
  sq_ring.sq_metadata.sq_tail -> sq_ring.sq_array: "kernel consumes"
  cq_ring.cq_metadata.cq_head -> cq_ring.cqe_array: "kernel produces"
  cq_ring.cq_metadata.cq_tail -> cq_ring.cqe_array: "user reads"
}

# Layout direction
direction: right