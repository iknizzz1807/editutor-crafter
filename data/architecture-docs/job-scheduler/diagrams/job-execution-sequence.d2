shape: sequence_diagram
cron_timer: Cron Timer
scheduler: Scheduler
job_queue: Job Queue
worker1: Worker 1
worker2: Worker 2
coordinator: Coordinator
metrics: Metrics Store

cron_timer -> scheduler: Timer fired\n(*/5 * * * *)
scheduler -> scheduler: Generate job instance\n(job_id, priority, payload)
scheduler -> job_queue: Insert job\n(priority=HIGH, retry_count=0)
job_queue -> scheduler: Job queued successfully

worker1 -> job_queue: Poll for jobs
job_queue -> worker1: Return highest priority job
worker1 -> coordinator: Claim job\n(job_id, worker_id, heartbeat)
coordinator -> worker1: Job claimed successfully

worker1 -> worker1: Execute job logic
worker1 -> coordinator: Heartbeat\n(job_id, status=RUNNING)
coordinator -> worker1: ACK

worker1 -> worker1: Job execution failed
worker1 -> coordinator: Report failure\n(job_id, error, retry_count=1)
coordinator -> job_queue: Requeue job\n(priority=HIGH, retry_count=1, delay=30s)
coordinator -> metrics: Record failure

worker2 -> job_queue: Poll for jobs\n(after delay)
job_queue -> worker2: Return retried job
worker2 -> coordinator: Claim job\n(job_id, worker_id)
coordinator -> worker2: Job claimed

worker2 -> worker2: Execute job logic
worker2 -> coordinator: Heartbeat\n(status=RUNNING)
worker2 -> coordinator: Report success\n(job_id, result)
coordinator -> metrics: Record success
coordinator -> job_queue: Mark job complete

coordinator -> coordinator: Check max retries exceeded
coordinator -> job_queue: Move to dead letter queue
coordinator -> metrics: Record permanent failure

classes: {
  timer_style: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  
  success_style: {
    style.fill: "#00b894"
    style.stroke: "#00cec9"
    style.font-color: "#ffffff"
  }
  
  failure_style: {
    style.fill: "#fdcb6e"
    style.stroke: "#e17055"
    style.font-color: "#2d3436"
  }
}

cron_timer: {
  class: timer_style
}

coordinator: {
  class: success_style
}

metrics: {
  class: failure_style
}