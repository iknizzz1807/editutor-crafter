title: Claims Validation Decision Tree {
  style.font-size: 24
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  decision: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  process: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  error: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  success: {
    style.fill: "#00b894"
    style.stroke: "#00a085"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

start: Start Validation {
  shape: circle
  class: success
}

check_exp: Is token expired? {
  shape: diamond
  class: decision
}

check_nbf: Is token valid yet?\n(not before) {
  shape: diamond
  class: decision
}

check_iat: Valid issued time? {
  shape: diamond
  class: decision
}

check_iss: Valid issuer? {
  shape: diamond
  class: decision
}

check_aud: Valid audience? {
  shape: diamond
  class: decision
}

check_custom: Custom claims valid? {
  shape: diamond
  class: decision
}

error_expired: TokenExpiredError {
  class: error
}

error_not_ready: TokenNotValidYetError {
  class: error
}

error_bad_time: InvalidIssuedTimeError {
  class: error
}

error_bad_issuer: InvalidIssuerError {
  class: error
}

error_bad_audience: InvalidAudienceError {
  class: error
}

error_custom: CustomClaimError {
  class: error
}

validation_success: Validation Complete\nToken Valid {
  class: success
}

# Flow connections
start -> check_exp

check_exp -> error_expired: "Yes\n(expired)"
check_exp -> check_nbf: "No\n(valid)"

check_nbf -> error_not_ready: "No\n(too early)"
check_nbf -> check_iat: "Yes\n(ready)"

check_iat -> error_bad_time: "No\n(invalid)"
check_iat -> check_iss: "Yes\n(valid)"

check_iss -> error_bad_issuer: "No\n(untrusted)"
check_iss -> check_aud: "Yes\n(trusted)"

check_aud -> error_bad_audience: "No\n(wrong target)"
check_aud -> check_custom: "Yes\n(correct)"

check_custom -> error_custom: "No\n(failed rules)"
check_custom -> validation_success: "Yes\n(all valid)"

# Style the flow arrows
start -> check_exp: {
  style.stroke: "#8b949e"
}

check_exp -> error_expired: {
  style.stroke: "#d63031"
  style.bold: true
}

check_exp -> check_nbf: {
  style.stroke: "#3fb950"
}

check_nbf -> error_not_ready: {
  style.stroke: "#d63031"
  style.bold: true
}

check_nbf -> check_iat: {
  style.stroke: "#3fb950"
}

check_iat -> error_bad_time: {
  style.stroke: "#d63031"
  style.bold: true
}

check_iat -> check_iss: {
  style.stroke: "#3fb950"
}

check_iss -> error_bad_issuer: {
  style.stroke: "#d63031"
  style.bold: true
}

check_iss -> check_aud: {
  style.stroke: "#3fb950"
}

check_aud -> error_bad_audience: {
  style.stroke: "#d63031"
  style.bold: true
}

check_aud -> check_custom: {
  style.stroke: "#3fb950"
}

check_custom -> error_custom: {
  style.stroke: "#d63031"
  style.bold: true
}

check_custom -> validation_success: {
  style.stroke: "#00b894"
  style.bold: true
}