title: Signature Verification Process {
  style.font-size: 24
  style.bold: true
  style.font-color: "#e6edf3"
  near: top-center
}

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.stroke-width: 2
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.stroke-width: 2
  }
  security: {
    style.fill: "#0f3460"
    style.stroke: "#d63031"
    style.font-color: "#ffffff"
    style.bold: true
  }
  success: {
    style.fill: "#00b894"
    style.stroke: "#00a085"
    style.font-color: "#ffffff"
    style.bold: true
  }
  error: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

start: Start {
  shape: circle
  style.fill: "#3fb950"
  style.font-color: "#ffffff"
  label: ""
}

receive_token: Receive JWT Token {
  shape: rectangle
  class: process
}

parse_header: Parse Header\nExtract Algorithm {
  shape: rectangle
  class: process
}

check_alg: Algorithm = HS256? {
  shape: diamond
  class: decision
}

extract_parts: Extract Header,\nPayload, Signature {
  shape: rectangle
  class: process
}

compute_hmac: Compute HMAC-SHA256\n(Header + Payload + Secret) {
  shape: rectangle
  class: security
}

constant_time: Constant-Time\nComparison {
  shape: hexagon
  class: security
}

signatures_match: Signatures Match? {
  shape: diamond
  class: decision
}

valid_token: Token Valid\nSignature Verified {
  shape: rectangle
  class: success
}

invalid_alg: Invalid Algorithm\nReject Token {
  shape: rectangle
  class: error
}

invalid_sig: Invalid Signature\nReject Token {
  shape: rectangle
  class: error
}

end_success: Success {
  shape: circle
  style.fill: "#00b894"
  style.font-color: "#ffffff"
  label: ""
  style.double-border: true
}

end_error: Error {
  shape: circle
  style.fill: "#d63031"
  style.font-color: "#ffffff"
  label: ""
  style.double-border: true
}

security_note: |md
  **Security Notes:**
  • Constant-time comparison prevents timing attacks
  • Algorithm verification prevents algorithm confusion
  • Secret key never logged or exposed
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: bottom-right
}

# Flow connections
start -> receive_token
receive_token -> parse_header
parse_header -> check_alg
check_alg -> extract_parts: Yes
check_alg -> invalid_alg: No
extract_parts -> compute_hmac
compute_hmac -> constant_time
constant_time -> signatures_match
signatures_match -> valid_token: Yes
signatures_match -> invalid_sig: No
valid_token -> end_success
invalid_alg -> end_error
invalid_sig -> end_error

# Style the arrows
start -> receive_token: {
  style.stroke: "#8b949e"
  style.stroke-width: 2
}
receive_token -> parse_header: {
  style.stroke: "#8b949e"
  style.stroke-width: 2
}
parse_header -> check_alg: {
  style.stroke: "#8b949e"
  style.stroke-width: 2
}
check_alg -> extract_parts: {
  style.stroke: "#3fb950"
  style.stroke-width: 2
}
check_alg -> invalid_alg: {
  style.stroke: "#d63031"
  style.stroke-width: 2
}
extract_parts -> compute_hmac: {
  style.stroke: "#8b949e"
  style.stroke-width: 2
}
compute_hmac -> constant_time: {
  style.stroke: "#d63031"
  style.stroke-width: 3
}
constant_time -> signatures_match: {
  style.stroke: "#d63031"
  style.stroke-width: 3
}
signatures_match -> valid_token: {
  style.stroke: "#00b894"
  style.stroke-width: 2
}
signatures_match -> invalid_sig: {
  style.stroke: "#d63031"
  style.stroke-width: 2
}
valid_token -> end_success: {
  style.stroke: "#00b894"
  style.stroke-width: 2
}
invalid_alg -> end_error: {
  style.stroke: "#d63031"
  style.stroke-width: 2
}
invalid_sig -> end_error: {
  style.stroke: "#d63031"
  style.stroke-width: 2
}