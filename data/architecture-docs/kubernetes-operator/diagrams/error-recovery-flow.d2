title: Error Handling and Recovery Flow {
  near: top-center
  style.font-size: 24
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  error: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  success: {
    style.fill: "#00b894"
    style.stroke: "#00cec9"
    style.font-color: "#ffffff"
    style.bold: true
  }
  queue: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

start: Reconciliation Request {
  shape: circle
  class: process
}

process_event: Process Event {
  class: process
}

error_detected: Error Detected {
  shape: diamond
  class: error
}

classify_error: Classify Error Type {
  shape: diamond
  class: decision
}

transient_error: Transient Error\n(Network timeout, API rate limit) {
  class: error
}

permanent_error: Permanent Error\n(Invalid configuration, missing permissions) {
  class: error
}

check_retry_count: Check Retry Count {
  shape: diamond
  class: decision
}

exponential_backoff: Calculate Exponential Backoff\n(2^n * base_interval) {
  class: process
}

requeue_with_delay: Requeue with Delay {
  shape: queue
  class: queue
}

immediate_requeue: Requeue Immediately {
  shape: queue
  class: queue
}

max_retries_reached: Max Retries Reached {
  class: error
}

log_permanent_error: Log Permanent Error\n& Update Status {
  class: error
}

mark_failed: Mark Resource as Failed {
  class: error
}

recovery_mechanisms: Recovery Mechanisms {
  class: process
}

circuit_breaker: Circuit Breaker\n(Prevent cascade failures) {
  class: process
}

health_check: Health Check\n(Verify external dependencies) {
  class: process
}

resource_cleanup: Resource Cleanup\n(Remove orphaned resources) {
  class: process
}

status_update: Update Resource Status\n(Error conditions, retry info) {
  class: process
}

metrics_emit: Emit Metrics\n(Error rates, retry counts) {
  class: process
}

alerting: Send Alerts\n(Critical failures) {
  class: error
}

success_path: Reconciliation Success {
  shape: circle
  class: success
}

# Main flow
start -> process_event
process_event -> error_detected

# Error detection branch
error_detected -> classify_error: Error Occurs
error_detected -> success_path: No Error

# Error classification
classify_error -> transient_error: Network/Temporary
classify_error -> permanent_error: Config/Validation

# Transient error handling
transient_error -> check_retry_count
check_retry_count -> exponential_backoff: Retries < Max
check_retry_count -> max_retries_reached: Retries >= Max

exponential_backoff -> requeue_with_delay
requeue_with_delay -> process_event: Retry After Delay

# Permanent error handling
permanent_error -> log_permanent_error
log_permanent_error -> mark_failed

# Max retries handling
max_retries_reached -> mark_failed

# Recovery mechanisms
mark_failed -> recovery_mechanisms
recovery_mechanisms -> circuit_breaker
recovery_mechanisms -> health_check
recovery_mechanisms -> resource_cleanup

# Status and monitoring
circuit_breaker -> status_update
health_check -> status_update
resource_cleanup -> status_update

status_update -> metrics_emit
metrics_emit -> alerting: Critical Errors
metrics_emit -> immediate_requeue: Recoverable State

immediate_requeue -> process_event: Manual/Automated Recovery

# Success path
success_path -> metrics_emit: Success Metrics

# Connection styling
start -> process_event: {style.stroke: "#8b949e"}
process_event -> error_detected: {style.stroke: "#8b949e"}
error_detected -> classify_error: {style.stroke: "#e17055"}
error_detected -> success_path: {style.stroke: "#00b894"}
classify_error -> transient_error: {style.stroke: "#fd79a8"}
classify_error -> permanent_error: {style.stroke: "#e17055"}
transient_error -> check_retry_count: {style.stroke: "#8b949e"}
check_retry_count -> exponential_backoff: {style.stroke: "#00b894"}
check_retry_count -> max_retries_reached: {style.stroke: "#e17055"}
exponential_backoff -> requeue_with_delay: {style.stroke: "#8b949e"}
requeue_with_delay -> process_event: {style.stroke: "#74b9ff"; style.stroke-dash: 3}
permanent_error -> log_permanent_error: {style.stroke: "#e17055"}
log_permanent_error -> mark_failed: {style.stroke: "#e17055"}
max_retries_reached -> mark_failed: {style.stroke: "#e17055"}
mark_failed -> recovery_mechanisms: {style.stroke: "#8b949e"}
recovery_mechanisms -> circuit_breaker: {style.stroke: "#8b949e"}
recovery_mechanisms -> health_check: {style.stroke: "#8b949e"}
recovery_mechanisms -> resource_cleanup: {style.stroke: "#8b949e"}
circuit_breaker -> status_update: {style.stroke: "#8b949e"}
health_check -> status_update: {style.stroke: "#8b949e"}
resource_cleanup -> status_update: {style.stroke: "#8b949e"}
status_update -> metrics_emit: {style.stroke: "#8b949e"}
metrics_emit -> alerting: {style.stroke: "#e17055"}
metrics_emit -> immediate_requeue: {style.stroke: "#00b894"}
immediate_requeue -> process_event: {style.stroke: "#74b9ff"; style.stroke-dash: 3}
success_path -> metrics_emit: {style.stroke: "#00b894"}