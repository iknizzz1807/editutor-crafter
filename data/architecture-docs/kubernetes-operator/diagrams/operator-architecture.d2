classes: {
  k8s_component: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  custom_component: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  data_flow: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  control_flow: {
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

title: Operator Architecture Overview {
  near: top-center
  style.font-size: 18
  style.font-color: "#e6edf3"
  style.bold: true
}

kubernetes_api: Kubernetes API Server {
  class: k8s_component
  shape: rectangle
  
  etcd: etcd {
    shape: cylinder
    class: k8s_component
  }
  
  admission_controller: Admission Controllers {
    class: k8s_component
  }
}

custom_resources: Custom Resources {
  class: custom_component
  shape: rectangle
  
  app_crd: ApplicationCRD {
    shape: page
    class: custom_component
  }
  
  config_crd: ConfigCRD {
    shape: page
    class: custom_component
  }
}

operator: Kubernetes Operator {
  class: custom_component
  shape: rectangle
  
  controller_manager: Controller Manager {
    class: custom_component
    
    app_controller: App Controller {
      class: custom_component
    }
    
    config_controller: Config Controller {
      class: custom_component
    }
  }
  
  client_go: Client-Go {
    class: custom_component
    
    informers: Informers {
      class: custom_component
      shape: rectangle
    }
    
    work_queues: Work Queues {
      class: custom_component
      shape: queue
    }
    
    clients: API Clients {
      class: custom_component
    }
  }
  
  webhooks: Admission Webhooks {
    class: custom_component
    
    validating: Validating Webhook {
      class: custom_component
    }
    
    mutating: Mutating Webhook {
      class: custom_component
    }
  }
}

reconciliation: Reconciliation Loop {
  class: custom_component
  shape: rectangle
  
  watch_events: Watch Events {
    class: custom_component
  }
  
  compare_state: Compare State {
    class: custom_component
  }
  
  apply_changes: Apply Changes {
    class: custom_component
  }
}

# API Server connections
kubernetes_api.etcd -> kubernetes_api: store state {
  class: data_flow
}

kubernetes_api -> custom_resources: serve CRDs {
  class: control_flow
}

kubernetes_api.admission_controller -> operator.webhooks.validating: validate {
  class: control_flow
}

kubernetes_api.admission_controller -> operator.webhooks.mutating: mutate {
  class: control_flow
}

# Client-go connections
operator.client_go.clients -> kubernetes_api: API calls {
  class: data_flow
}

kubernetes_api -> operator.client_go.informers: watch events {
  class: control_flow
}

operator.client_go.informers -> operator.client_go.work_queues: enqueue {
  class: data_flow
}

operator.client_go.work_queues -> operator.controller_manager: dequeue {
  class: data_flow
}

# Controller connections
operator.controller_manager.app_controller -> reconciliation: trigger reconcile {
  class: control_flow
}

operator.controller_manager.config_controller -> reconciliation: trigger reconcile {
  class: control_flow
}

# Reconciliation flow
reconciliation.watch_events -> reconciliation.compare_state: current vs desired {
  class: data_flow
}

reconciliation.compare_state -> reconciliation.apply_changes: delta {
  class: data_flow
}

reconciliation.apply_changes -> operator.client_go.clients: update resources {
  class: control_flow
}

# Feedback loop
reconciliation -> operator.client_go.work_queues: requeue if needed {
  class: data_flow
  style.stroke-dash: 3
}