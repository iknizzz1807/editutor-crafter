direction: right

# Define styles for the split-brain prevention diagram
classes: {
  cluster_normal: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  partition_a: {
    style.fill: "#16213e"
    style.stroke: "#d63031"
    style.font-color: "#e6edf3"
  }
  partition_b: {
    style.fill: "#16213e"
    style.stroke: "#fdcb6e"
    style.font-color: "#e6edf3"
  }
  leader_node: {
    style.fill: "#00b894"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
    style.bold: true
  }
  failed_leader: {
    style.fill: "#636e72"
    style.stroke: "#2d3436"
    style.font-color: "#ddd"
  }
  prevention_mechanism: {
    style.fill: "#0f3460"
    style.stroke: "#74b9ff"
    style.font-color: "#e6edf3"
  }
}

# Normal cluster state (before split)
normal_cluster: Normal Cluster {
  class: cluster_normal
  leader: Current Leader {
    class: leader_node
  }
  node2: Node 2
  node3: Node 3
  node4: Node 4
  node5: Node 5
  
  leader -> node2: heartbeat
  leader -> node3: heartbeat
  leader -> node4: heartbeat
  leader -> node5: heartbeat
}

# Network partition occurs
partition_event: Network Partition {
  shape: diamond
  style.fill: "#d63031"
  style.font-color: "#ffffff"
  style.bold: true
}

# Partition A - minority with old leader
partition_a: Partition A (Minority) {
  class: partition_a
  old_leader: Old Leader {
    class: failed_leader
    label: "Leader\n(isolated)"
  }
  node_a2: Node 2
  
  old_leader <-> node_a2: "can communicate"
}

# Partition B - majority attempts election
partition_b: Partition B (Majority) {
  class: partition_b
  node_b3: Node 3 {
    label: "Node 3\n(candidate)"
  }
  node_b4: Node 4 {
    label: "Node 4\n(candidate)"
  }
  node_b5: Node 5
  
  node_b3 <-> node_b4: election
  node_b3 <-> node_b5: election  
  node_b4 <-> node_b5: election
}

# Prevention mechanisms
prevention: Split-Brain Prevention {
  class: prevention_mechanism
  
  quorum: Quorum Requirement {
    shape: page
    label: |md
      **Quorum Rule**
      - Need majority (3/5) votes
      - Partition A: 2 nodes (fail)
      - Partition B: 3 nodes (succeed)
    |
  }
  
  detection: Partition Detection {
    shape: page  
    label: |md
      **Detection Methods**
      - Heartbeat timeouts
      - Consensus failure
      - External arbiters
    |
  }
  
  fencing: Node Fencing {
    shape: page
    label: |md
      **Fencing Strategies**
      - Resource isolation
      - Network blocking
      - Process termination
    |
  }
  
  quorum -> detection: triggers
  detection -> fencing: activates
}

# Final result - only one leader
result: Final State {
  class: cluster_normal
  
  isolated: Isolated Nodes {
    class: partition_a
    dead_leader: Former Leader {
      class: failed_leader
      label: "Stepped Down"
    }
    isolated_node: Node 2 {
      class: failed_leader
    }
    
    dead_leader <-> isolated_node: "no leadership"
  }
  
  active: Active Partition {
    class: partition_b
    new_leader: New Leader {
      class: leader_node
    }
    active_node1: Node 4
    active_node2: Node 5
    
    new_leader -> active_node1: coordinates
    new_leader -> active_node2: coordinates
  }
  
  isolated -> active: "awaits reconnection" {
    style.stroke-dash: 5
    style.stroke: "#74b9ff"
  }
}

# Flow connections
normal_cluster -> partition_event: network fails
partition_event -> partition_a: minority
partition_event -> partition_b: majority
partition_a -> prevention: attempts leadership
partition_b -> prevention: attempts leadership
prevention -> result: prevents split-brain

# Add warning note
warning: |md
  ⚠️ **Critical**: Without prevention mechanisms,
  both partitions could elect leaders simultaneously,
  causing data corruption and system inconsistency.
| {
  shape: page
  style.fill: "#d63031"
  style.font-color: "#ffffff"
  near: bottom-center
}