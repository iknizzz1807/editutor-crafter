direction: right

title: Audit Trail Data Structure {
  near: top-center
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  container: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.stroke-width: 2
  }
  
  table: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.stroke-width: 1
  }
  
  important: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
    style.stroke-width: 3
  }
  
  connection: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

audit_system: Audit Trail System {
  class: container
  
  audit_logs: Audit Logs {
    shape: sql_table
    class: table
    id: bigint {constraint: primary_key}
    transaction_id: uuid
    action_type: varchar
    table_name: varchar
    record_id: bigint
    old_values: jsonb
    new_values: jsonb
    user_id: varchar
    timestamp: timestamp
    hash: varchar(64)
    previous_hash: varchar(64)
  }
  
  hash_chain: Hash Chain Validator {
    class: important
    
    genesis_block: Genesis Block {
      shape: cylinder
      class: table
    }
    
    integrity_check: Integrity Verification {
      shape: hexagon
      class: table
    }
    
    genesis_block -> integrity_check: validates chain {
      class: connection
    }
  }
  
  change_history: Change History Tables {
    class: container
    
    journal_entries_history: Journal Entries History {
      shape: sql_table
      class: table
      history_id: bigint {constraint: primary_key}
      entry_id: uuid
      version: int
      account_id: uuid
      amount: decimal
      operation_type: varchar
      created_at: timestamp
      audit_log_id: bigint
    }
    
    accounts_history: Accounts History {
      shape: sql_table
      class: table
      history_id: bigint {constraint: primary_key}
      account_id: uuid
      version: int
      account_name: varchar
      account_type: varchar
      balance: decimal
      modified_at: timestamp
      audit_log_id: bigint
    }
  }
}

immutable_storage: Immutable Entry Storage {
  class: important
  shape: cylinder
  near: bottom-left
}

transaction_engine: Transaction Recording Engine {
  class: container
  near: left
}

regulatory_reports: Regulatory Compliance Reports {
  class: container
  shape: page
  near: right
}

# Primary data flow connections
transaction_engine -> audit_system.audit_logs: creates audit record {
  class: connection
}

audit_system.audit_logs -> audit_system.hash_chain.genesis_block: hash linkage {
  class: connection
}

audit_system.audit_logs -> audit_system.change_history.journal_entries_history: triggers history record {
  class: connection
}

audit_system.audit_logs -> audit_system.change_history.accounts_history: triggers history record {
  class: connection
}

audit_system.hash_chain.integrity_check -> immutable_storage: validates integrity {
  class: connection
}

audit_system.change_history -> regulatory_reports: provides audit trail {
  class: connection
}

# Hash chain relationships
audit_system.hash_chain -> audit_system.audit_logs: verifies hash sequence {
  class: connection
  style.stroke-dash: 3
}

# Storage relationships  
audit_system.audit_logs -> immutable_storage: append-only writes {
  class: connection
}

audit_system.change_history -> immutable_storage: immutable history {
  class: connection
}

note: |md
  **Key Features:**
  • Cryptographic hash chains prevent tampering
  • Append-only storage ensures immutability  
  • Complete change history for all transactions
  • Regulatory compliance through audit trails
| {
  shape: page
  near: bottom-right
  class: table
}