title: Backend Health State Machine

# Define states
healthy: Healthy {
  shape: circle
  style.fill: "#28a745"
  style.stroke: "#3fb950"
  style.font-color: "#ffffff"
  style.bold: true
}

unhealthy: Unhealthy {
  shape: circle
  style.fill: "#dc3545"
  style.stroke: "#e74c3c"
  style.font-color: "#ffffff"
  style.bold: true
}

recovery: Recovery {
  shape: circle
  style.fill: "#ffc107"
  style.stroke: "#f39c12"
  style.font-color: "#000000"
  style.bold: true
}

# Initial state
init: {
  shape: circle
  style.fill: "#3fb950"
  style.stroke: "#3fb950"
  label: ""
  width: 20
  height: 20
}

# State transitions
init -> healthy: "Server starts"

healthy -> unhealthy: "N consecutive failures\n(e.g., N=3)" {
  style.stroke: "#dc3545"
  style.font-color: "#dc3545"
}

unhealthy -> recovery: "First successful check" {
  style.stroke: "#ffc107"
  style.font-color: "#ffc107"
}

recovery -> healthy: "M consecutive successes\n(e.g., M=2)" {
  style.stroke: "#28a745"
  style.font-color: "#28a745"
}

recovery -> unhealthy: "Health check fails" {
  style.stroke: "#dc3545"
  style.font-color: "#dc3545"
}

# Self-loop for healthy state
healthy -> healthy: "Successful health checks" {
  style.stroke: "#28a745"
  style.font-color: "#28a745"
}

# Self-loop for unhealthy state
unhealthy -> unhealthy: "Continued failures" {
  style.stroke: "#dc3545"
  style.font-color: "#dc3545"
}

# Notes about the states
healthy_note: |md
  **Healthy State**
  - Receives traffic
  - Regular health checks
  - Reset failure counter
| {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: top-left
}

unhealthy_note: |md
  **Unhealthy State**
  - Excluded from load balancing
  - Continued health monitoring
  - No traffic routing
| {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: bottom-left
}

recovery_note: |md
  **Recovery State**
  - Still excluded from traffic
  - Building success streak
  - Prevents flapping
| {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: top-right
}