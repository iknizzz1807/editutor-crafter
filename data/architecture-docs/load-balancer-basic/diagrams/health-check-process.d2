direction: down

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  failure: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
  success: {
    style.fill: "#00b894"
    style.stroke: "#00cec9"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

start: Start Health Check {
  shape: circle
  class: process
}

timer: Health Check Timer {
  class: process
}

send_probe: Send HTTP Probe {
  class: process
}

wait_response: Wait for Response {
  class: process
}

response_check: Response Received? {
  shape: diamond
  class: decision
}

timeout_check: Timeout Exceeded? {
  shape: diamond
  class: decision
}

evaluate: Evaluate Response {
  class: process
}

status_check: Response Valid? {
  shape: diamond
  class: decision
}

record_success: Record Success {
  class: success
}

record_failure: Record Failure {
  class: failure
}

current_state: Check Current State {
  shape: diamond
  class: decision
}

consecutive_check: Consecutive Failures? {
  shape: diamond
  class: decision
}

recovery_check: Consecutive Successes? {
  shape: diamond
  class: decision
}

mark_unhealthy: Mark Server Unhealthy {
  class: failure
}

mark_healthy: Mark Server Healthy {
  class: success
}

update_pool: Update Backend Pool {
  class: process
}

schedule_next: Schedule Next Check {
  class: process
}

start -> timer
timer -> send_probe: Timer expires
send_probe -> wait_response
wait_response -> response_check
response_check -> evaluate: Yes
response_check -> timeout_check: No
timeout_check -> record_failure: Yes
timeout_check -> wait_response: No
evaluate -> status_check
status_check -> record_success: Valid
status_check -> record_failure: Invalid
record_success -> current_state
record_failure -> current_state
current_state -> consecutive_check: Currently Healthy
current_state -> recovery_check: Currently Unhealthy
consecutive_check -> mark_unhealthy: Yes
consecutive_check -> schedule_next: No
recovery_check -> mark_healthy: Yes
recovery_check -> schedule_next: No
mark_unhealthy -> update_pool
mark_healthy -> update_pool
update_pool -> schedule_next
schedule_next -> timer: Wait interval