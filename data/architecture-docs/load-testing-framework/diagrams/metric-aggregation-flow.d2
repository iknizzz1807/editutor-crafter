# Metric Aggregation Flow

classes: {
  request_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  histogram_style: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  coordinator_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  dashboard_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#e17055"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

http_request1: HTTP Request 1 {
  shape: rectangle
  class: request_style
}

http_request2: HTTP Request 2 {
  shape: rectangle
  class: request_style
}

http_request3: HTTP Request 3 {
  shape: rectangle
  class: request_style
}

worker_node: Worker Node {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  local_histogram: Local Histogram {
    shape: cylinder
    class: histogram_style
  }
  
  stream_buffer: Stream Buffer {
    shape: queue
    class: request_style
  }
  
  local_histogram -> stream_buffer: batch metrics
}

coordinator: Metrics Coordinator {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  style.bold: true
  
  aggregator: Aggregation Engine {
    shape: diamond
    class: coordinator_style
  }
  
  metrics_store: Metrics Store {
    shape: cylinder
    class: coordinator_style
  }
  
  aggregator -> metrics_store: store aggregated
}

dashboard: Dashboard {
  shape: rectangle
  class: dashboard_style
}

http_request1 -> worker_node.local_histogram: response time, status
http_request2 -> worker_node.local_histogram: response time, status
http_request3 -> worker_node.local_histogram: response time, status

worker_node.stream_buffer -> coordinator.aggregator: streaming metrics

coordinator.metrics_store -> dashboard: real-time data

note: |md
  **Flow Summary:**
  1. HTTP requests generate metrics (latency, errors)
  2. Worker captures in local histograms
  3. Batched streaming to coordinator
  4. Real-time aggregation and storage
  5. Live dashboard updates
| {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  near: bottom-center
}