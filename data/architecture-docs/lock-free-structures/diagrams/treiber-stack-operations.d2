classes: {
  start: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
    style.bold: true
    shape: circle
  }
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    shape: rectangle
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    shape: diamond
  }
  success: {
    style.fill: "#00b894"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
    style.bold: true
    shape: rectangle
  }
  failure: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
    shape: rectangle
  }
}

title: Treiber Stack Push/Pop Flow {
  class: start
  label: ""
  style.font-size: 14
}

push_start: Push Operation {
  class: start
}

pop_start: Pop Operation {
  class: start
}

push_container: Push Flow {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  push_new_node: Create New Node {
    class: process
  }
  
  push_read_top: Read current top {
    class: process
  }
  
  push_set_next: Set node.next = top {
    class: process
  }
  
  push_cas: CAS(top, old_top, new_node) {
    class: decision
  }
  
  push_success: Push Complete {
    class: success
  }
  
  push_retry: Retry Push {
    class: failure
  }
  
  push_new_node -> push_read_top
  push_read_top -> push_set_next
  push_set_next -> push_cas
  push_cas -> push_success: CAS Success
  push_cas -> push_retry: CAS Failed
  push_retry -> push_read_top: Backoff & Retry
}

pop_container: Pop Flow {
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  pop_read_top: Read current top {
    class: process
  }
  
  pop_empty_check: top == NULL? {
    class: decision
  }
  
  pop_return_empty: Return EMPTY {
    class: success
  }
  
  pop_read_next: Read top.next {
    class: process
  }
  
  pop_aba_check: Tagged Pointer ABA Detection {
    class: process
  }
  
  pop_cas: CAS(top, old_top, next) {
    class: decision
  }
  
  pop_success: Return old_top.data {
    class: success
  }
  
  pop_retry: Retry Pop {
    class: failure
  }
  
  pop_read_top -> pop_empty_check
  pop_empty_check -> pop_return_empty: Yes
  pop_empty_check -> pop_read_next: No
  pop_read_next -> pop_aba_check
  pop_aba_check -> pop_cas
  pop_cas -> pop_success: CAS Success
  pop_cas -> pop_retry: CAS Failed
  pop_retry -> pop_read_top: Backoff & Retry
}

aba_note: "ABA Problem Mitigation: Tagged Pointers with version counter, Memory Ordering with Acquire/Release semantics, Hazard Pointers to prevent premature deallocation" {
  shape: page
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

push_start -> push_container
pop_start -> pop_container