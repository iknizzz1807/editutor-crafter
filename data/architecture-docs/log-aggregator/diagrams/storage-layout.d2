title: Storage Layout and Chunks

classes: {
  storage_component: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  chunk_style: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  wal_style: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  policy_style: {
    style.fill: "#2d3748"
    style.stroke: "#ffd700"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

storage_engine: Storage Engine {
  class: storage_component

  wal: Write-Ahead Log {
    shape: page
    class: wal_style
  }

  chunk_manager: Chunk Manager {
    class: storage_component
    
    active_chunks: Active Chunks {
      class: chunk_style
      
      chunk_1: "Chunk 1\n[2024-01-15 14:00-15:00]\nUncompressed" {
        shape: rectangle
        class: chunk_style
      }
      
      chunk_2: "Chunk 2\n[2024-01-15 15:00-16:00]\nUncompressed" {
        shape: rectangle
        class: chunk_style
      }
    }
    
    compressed_chunks: Compressed Chunks {
      class: chunk_style
      
      chunk_old1: "Chunk 45\n[2024-01-14 10:00-11:00]\nGZIP Compressed" {
        shape: rectangle
        class: chunk_style
        style.stroke-dash: 3
      }
      
      chunk_old2: "Chunk 46\n[2024-01-14 11:00-12:00]\nLZ4 Compressed" {
        shape: rectangle
        class: chunk_style
        style.stroke-dash: 3
      }
      
      chunk_old3: "Chunk 47\n[2024-01-14 12:00-13:00]\nSnappy Compressed" {
        shape: rectangle
        class: chunk_style
        style.stroke-dash: 3
      }
    }
  }

  disk_storage: Disk Storage {
    shape: cylinder
    class: storage_component
    
    partitions: Time-based Partitions {
      class: storage_component
      
      partition_today: "Today\n/data/2024/01/15" {
        shape: package
        class: chunk_style
      }
      
      partition_yesterday: "Yesterday\n/data/2024/01/14" {
        shape: package
        class: chunk_style
      }
      
      partition_week: "Last Week\n/data/2024/01/08" {
        shape: package
        class: chunk_style
        style.opacity: 0.7
      }
    }
  }

  retention_policy: Retention Policy Engine {
    class: policy_style
  }
}

compression_layer: Compression Layer {
  class: storage_component
  
  gzip_compressor: "GZIP\n(High Ratio)" {
    shape: hexagon
    class: chunk_style
  }
  
  lz4_compressor: "LZ4\n(Fast)" {
    shape: hexagon
    class: chunk_style
  }
  
  snappy_compressor: "Snappy\n(Balanced)" {
    shape: hexagon
    class: chunk_style
  }
}

ingestion_flow: Log Ingestion {
  shape: cloud
  class: storage_component
}

metadata_index: Chunk Metadata Index {
  shape: page
  class: storage_component
}

# Ingestion flow
ingestion_flow -> storage_engine.wal: 1. Write to WAL
storage_engine.wal -> storage_engine.chunk_manager.active_chunks.chunk_1: 2. Buffer in active chunk
storage_engine.chunk_manager.active_chunks.chunk_2 -> compression_layer.lz4_compressor: 3. Compress when full

# Compression paths
compression_layer.gzip_compressor -> storage_engine.chunk_manager.compressed_chunks.chunk_old1: High compression
compression_layer.lz4_compressor -> storage_engine.chunk_manager.compressed_chunks.chunk_old2: Fast compression
compression_layer.snappy_compressor -> storage_engine.chunk_manager.compressed_chunks.chunk_old3: Balanced compression

# Storage to disk
storage_engine.chunk_manager.compressed_chunks -> storage_engine.disk_storage.partitions.partition_today: Persist to disk
storage_engine.chunk_manager.compressed_chunks -> storage_engine.disk_storage.partitions.partition_yesterday: Archive chunks

# Retention policy
storage_engine.retention_policy -> storage_engine.disk_storage.partitions.partition_week: Delete old partitions
storage_engine.retention_policy -> compression_layer.gzip_compressor: Apply higher compression over time

# Metadata tracking
storage_engine.chunk_manager -> metadata_index: Update chunk metadata
metadata_index -> storage_engine.disk_storage: Index chunk locations

# Time progression note
time_flow: |md
  **Time-based Organization**
  - New logs → Active chunks (uncompressed)
  - 1-hour threshold → Compression applied
  - Daily → Partition to disk directories
  - Retention → Delete based on age/size policies
| {
  shape: page
  near: bottom-right
  class: policy_style
}