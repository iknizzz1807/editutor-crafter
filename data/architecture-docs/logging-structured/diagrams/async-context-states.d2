title: Async Context State Machine

classes: {
  state: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  final_state: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.double-border: true
    style.bold: true
  }
  start_state: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#1a1a2e"
  }
}

init: {
  shape: circle
  class: start_state
  label: ""
}

no_context: No Context {
  shape: circle
  class: state
}

context_active: Context Active {
  shape: circle
  class: state
}

task_created: Task Created\n(Context Inherited) {
  shape: circle
  class: state
}

task_executing: Task Executing\n(Context Preserved) {
  shape: circle
  class: state
}

task_completed: Task Completed {
  shape: circle
  class: state
}

context_cleaned: Context Cleaned {
  shape: circle
  class: final_state
}

init -> no_context: {
  class: transition
  label: "System Start"
}

no_context -> context_active: {
  class: transition
  label: "Request Begins\n[set_context()]"
}

context_active -> task_created: {
  class: transition
  label: "Async Task Spawn\n[inherit_context()]"
}

task_created -> task_executing: {
  class: transition
  label: "Task Scheduled\n[context_enter()]"
}

task_executing -> task_completed: {
  class: transition
  label: "Task Finished\n[preserve_logs()]"
}

task_completed -> context_cleaned: {
  class: transition
  label: "Cleanup\n[context_exit()]"
}

context_active -> context_active: {
  class: transition
  label: "Log Events\n[maintain_context()]"
}

task_executing -> task_executing: {
  class: transition
  label: "Nested Operations\n[propagate_context()]"
}

context_active -> context_cleaned: {
  class: transition
  label: "Request Complete\n[cleanup()]"
}

note: |md
  **Context State Transitions:**
  - Context creation sets thread-local state
  - Task inheritance copies parent context
  - Execution maintains isolated context
  - Cleanup ensures no context leaks
| {
  shape: page
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: top-right
}