title: Deployment Traffic Management

# Define dark theme styles
classes: {
  container: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  service: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  logic: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  monitor: {
    style.fill: "#2d3748"
    style.stroke: "#ffa500"
    style.font-color: "#e6edf3"
  }
}

# External traffic entry point
client: Client Requests {
  shape: cloud
  class: service
}

# Load balancer as entry point
load_balancer: Load Balancer {
  class: service
}

# Traffic splitting logic
traffic_splitter: Traffic Splitter {
  class: logic
  
  canary_rules: Canary Rules {
    class: logic
  }
  
  routing_logic: Routing Logic {
    class: logic
  }
  
  weight_config: Weight Configuration {
    class: logic
  }
}

# Model serving instances
production_cluster: Production Cluster (v1.2) {
  class: container
  
  prod_instance_1: Model Server v1.2 {
    class: service
  }
  
  prod_instance_2: Model Server v1.2 {
    class: service
  }
  
  prod_instance_3: Model Server v1.2 {
    class: service
  }
}

canary_cluster: Canary Cluster (v1.3) {
  class: container
  
  canary_instance_1: Model Server v1.3 {
    class: service
  }
  
  canary_instance_2: Model Server v1.3 {
    class: service
  }
}

# Monitoring components
monitoring: Monitoring System {
  class: container
  
  metrics_collector: Metrics Collector {
    class: monitor
  }
  
  log_aggregator: Log Aggregator {
    class: monitor
  }
  
  health_checker: Health Checker {
    class: monitor
  }
}

# Traffic flow
client -> load_balancer: Incoming requests

load_balancer -> traffic_splitter: Route requests

traffic_splitter.canary_rules -> traffic_splitter.routing_logic: Apply rules
traffic_splitter.weight_config -> traffic_splitter.routing_logic: 90% / 10% split

traffic_splitter -> production_cluster: 90% traffic
traffic_splitter -> canary_cluster: 10% traffic (canary)

production_cluster.prod_instance_1 -> client: Responses
production_cluster.prod_instance_2 -> client: Responses
production_cluster.prod_instance_3 -> client: Responses

canary_cluster.canary_instance_1 -> client: Responses
canary_cluster.canary_instance_2 -> client: Responses

# Monitoring connections
production_cluster -> monitoring.metrics_collector: Metrics & logs
canary_cluster -> monitoring.metrics_collector: Metrics & logs

monitoring.health_checker -> production_cluster: Health checks
monitoring.health_checker -> canary_cluster: Health checks

monitoring.log_aggregator <-> traffic_splitter: Performance data

# Feedback loop for traffic adjustment
monitoring.metrics_collector -> traffic_splitter.weight_config: Adjust weights based on metrics