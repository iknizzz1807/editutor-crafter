direction: down

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  optimization: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  termination: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

start: Start K-NN Query {
  shape: circle
  style.fill: "#3fb950"
  style.font-color: "#ffffff"
  style.bold: true
}

init_query: Initialize Query Parameters {
  class: process
}

determine_partition: Determine Starting Partition {
  class: process
}

init_candidates: Initialize Candidate Set {
  class: process
}

search_partition: Search Current Partition {
  class: process
}

update_candidates: Update K Best Candidates {
  class: process
}

calculate_bounds: Calculate Partition Bounds {
  class: optimization
}

prune_check: Can Prune\nRemaining Partitions? {
  shape: diamond
  class: decision
}

more_partitions: More Partitions\nto Search? {
  shape: diamond
  class: decision
}

expand_search: Expand to\nAdjacent Partitions {
  class: process
}

simd_distance: SIMD Distance\nCalculations {
  class: optimization
}

early_termination: Early Termination\nCondition Met? {
  shape: diamond
  class: decision
}

sort_results: Sort Final Results {
  class: process
}

return_knn: Return K-NN Set {
  shape: circle
  class: termination
}

optimization_note: |md
  **Optimizations:**
  - SIMD vectorized distance calculations
  - Spatial partition bounds checking
  - Early termination when search radius
    is smaller than partition distances
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  near: top-right
}

start -> init_query
init_query -> determine_partition: query point, k value
determine_partition -> init_candidates
init_candidates -> search_partition
search_partition -> simd_distance: process entities
simd_distance -> update_candidates: distances computed
update_candidates -> calculate_bounds
calculate_bounds -> early_termination: check termination
early_termination -> return_knn: Yes
early_termination -> prune_check: No
prune_check -> more_partitions: No pruning possible
prune_check -> return_knn: Yes - prune all remaining
more_partitions -> expand_search: Yes
more_partitions -> sort_results: No
expand_search -> search_partition: next partition
sort_results -> return_knn