title: RLS Policy Evaluation Flow

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  data: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  success: {
    style.fill: "#1a1a2e"
    style.stroke: "#00b894"
    style.font-color: "#00b894"
    style.bold: true
  }
  error: {
    style.fill: "#1a1a2e"
    style.stroke: "#d63031"
    style.font-color: "#d63031"
    style.bold: true
  }
}

start: SQL Query Received {
  class: process
}

session_check: Session Variable\nSet? {
  shape: diamond
  class: decision
}

no_session: No Session Variable {
  class: error
}

extract_tenant: Extract tenant_id\nfrom Session {
  class: process
}

operation_check: Operation\nType? {
  shape: diamond
  class: decision
}

select_policy: SELECT Policy:\ncurrent_setting('app.tenant_id')::uuid\n= tenant_id {
  class: data
}

insert_policy: INSERT Policy:\nNEW.tenant_id =\ncurrent_setting('app.tenant_id')::uuid {
  class: data
}

update_policy: UPDATE Policy:\nOLD.tenant_id =\ncurrent_setting('app.tenant_id')::uuid {
  class: data
}

delete_policy: DELETE Policy:\ntenant_id =\ncurrent_setting('app.tenant_id')::uuid {
  class: data
}

row_eval: Evaluate Policy\nAgainst Row Data {
  class: process
}

policy_match: Policy\nMatches? {
  shape: diamond
  class: decision
}

allow_operation: Allow Operation {
  class: success
}

deny_operation: Deny Operation\n(No Rows Affected) {
  class: error
}

start -> session_check
session_check -> no_session: No
session_check -> extract_tenant: Yes
no_session -> deny_operation
extract_tenant -> operation_check

operation_check -> select_policy: SELECT
operation_check -> insert_policy: INSERT
operation_check -> update_policy: UPDATE
operation_check -> delete_policy: DELETE

select_policy -> row_eval
insert_policy -> row_eval
update_policy -> row_eval
delete_policy -> row_eval

row_eval -> policy_match
policy_match -> allow_operation: Yes
policy_match -> deny_operation: No