title: Multi-Layer Isolation Architecture

classes: {
  api_layer: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  app_layer: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  db_layer: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  security: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

client: Client Application {
  class: api_layer
}

api_gateway: API Gateway Layer {
  class: api_layer
  
  tenant_resolver: Tenant Resolver {
    class: security
  }
  
  context_manager: Context Manager {
    class: security
  }
  
  auth_middleware: Auth Middleware {
    class: security
  }
}

application: Application Layer {
  class: app_layer
  
  query_interceptor: Query Interceptor {
    class: security
  }
  
  tenant_filter: Automatic Filtering {
    class: security
  }
  
  business_logic: Business Logic
}

database: Database Layer {
  class: db_layer
  
  rls_policies: Row-Level Security {
    shape: cylinder
    class: security
  }
  
  tenant_data: Tenant Data {
    shape: cylinder
  }
}

context_note: |md
  **Defense-in-Depth**
  
  1. API-level tenant context
  2. Application-level filtering  
  3. Database-level RLS policies
| {
  shape: page
  near: top-right
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

client -> api_gateway: HTTP Request
api_gateway.tenant_resolver -> api_gateway.context_manager: Tenant ID
api_gateway.context_manager -> api_gateway.auth_middleware: Tenant Context
api_gateway -> application: Request + Context

application.query_interceptor -> application.tenant_filter: Intercept Query
application.tenant_filter -> application.business_logic: Add WHERE tenant_id
application -> database: Filtered Query

database.rls_policies -> database.tenant_data: Enforce RLS
database -> application: Tenant-Scoped Data
application -> api_gateway: Response
api_gateway -> client: JSON Response

api_gateway.tenant_resolver: "Subdomain/Header/JWT\nTenant Resolution" {
  style.stroke-dash: 3
}

application.tenant_filter: "Automatic WHERE\ntenant_id = :current" {
  style.stroke-dash: 3
}

database.rls_policies: "CREATE POLICY tenant_isolation\nON table_name FOR ALL\nUSING (tenant_id = current_tenant())" {
  style.stroke-dash: 3
}