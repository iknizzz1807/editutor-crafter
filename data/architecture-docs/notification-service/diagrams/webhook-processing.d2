title: Webhook Event Processing {
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
  near: top-center
}

shape: sequence_diagram

sendgrid: SendGrid {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}

twilio: Twilio {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}

fcm: FCM {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
}

webhook_handler: Webhook Handler {
  style.fill: "#16213e"
  style.font-color: "#e6edf3"
  style.stroke: "#3fb950"
  style.bold: true
}

validator: Signature Validator {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
  style.stroke: "#8b949e"
}

parser: Event Parser {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
  style.stroke: "#8b949e"
}

status_service: Status Service {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
  style.stroke: "#8b949e"
}

analytics: Analytics Service {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
  style.stroke: "#8b949e"
}

notification_service: Notification Service {
  style.fill: "#1a1a2e"
  style.font-color: "#e6edf3"
  style.stroke: "#8b949e"
}

sendgrid -> webhook_handler: "POST /webhooks/sendgrid\n{\"event\":\"delivered\",\"email\":\"user@example.com\",\"sg_message_id\":\"xyz\"}"
webhook_handler -> validator: Validate SendGrid signature
validator -> webhook_handler: Signature valid
webhook_handler -> parser: Parse SendGrid event
parser -> webhook_handler: "Event: delivered, message_id: xyz"

twilio -> webhook_handler: "POST /webhooks/twilio\n{\"MessageStatus\":\"delivered\",\"MessageSid\":\"SM123\",\"To\":\"+1234567890\"}"
webhook_handler -> validator: Validate Twilio signature
validator -> webhook_handler: Signature valid
webhook_handler -> parser: Parse Twilio event
parser -> webhook_handler: "Event: delivered, message_sid: SM123"

fcm -> webhook_handler: "POST /webhooks/fcm\n{\"status\":\"delivered\",\"registration_id\":\"abc123\",\"message_id\":\"fcm456\"}"
webhook_handler -> validator: Validate FCM signature
validator -> webhook_handler: Signature valid
webhook_handler -> parser: Parse FCM event
parser -> webhook_handler: "Event: delivered, fcm_message_id: fcm456"

webhook_handler -> status_service: "Update delivery status\n(message_id, status: delivered)"
status_service -> webhook_handler: Status updated

webhook_handler -> analytics: "Record delivery event\n(provider, status, timestamp)"
analytics -> webhook_handler: Analytics updated

webhook_handler -> notification_service: "Check notification rules\n(event_type, user_preferences)"
notification_service -> webhook_handler: "Send user notification: Yes"

notification_service -> webhook_handler: User notified of delivery