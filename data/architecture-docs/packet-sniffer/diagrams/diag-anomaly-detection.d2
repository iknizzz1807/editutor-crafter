vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Street View: Anomaly Detection Pipeline" {
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

direction: right

packet_stream: "Incoming Packet Stream" {
  shape: cylinder
  style: {
    fill: "#E3F2FD"
    stroke: "#1976D2"
    stroke-width: 2
    multiple: true
  }
}

detection_engine: "Detection Engine" {
  style: {
    fill: "#FFF3E0"
    stroke: "#F57C00"
    stroke-width: 2
  }
  
  dispatcher: "Packet Dispatcher" {
    shape: diamond
    style: {
      fill: "#FFE0B2"
      stroke: "#E65100"
    }
  }
  
  pattern_matchers: "Pattern Matchers" {
    style: {
      fill: "#FFECB3"
      stroke: "#FF6F00"
      stroke-dash: 3
    }
    
    port_scan: "Port Scan Detector" {
      shape: rectangle
      style: {
        fill: "#FFF9C4"
        stroke: "#F57F17"
      }
      label: "Port Scan Detector\n• Track unique dst_ports per src_ip\n• Threshold: 50 ports in 60s\n• Pattern: Rapid SYN to multiple ports"
    }
    
    syn_flood: "SYN Flood Detector" {
      shape: rectangle
      style: {
        fill: "#FFCDD2"
        stroke: "#C62828"
      }
      label: "SYN Flood Detector\n• Track incomplete handshakes\n• Threshold: 1000 SYN/sec\n• Pattern: SYN without ACK"
    }
    
    malformed: "Malformed Packet Detector" {
      shape: rectangle
      style: {
        fill: "#F8BBD0"
        stroke: "#AD1457"
      }
      label: "Malformed Packet Detector\n• Invalid TCP flags (SYN+FIN)\n• Zero-length payloads\n• Checksum failures"
    }
    
    statistical: "Statistical Outlier Detector" {
      shape: rectangle
      style: {
        fill: "#E1BEE7"
        stroke: "#6A1B9A"
      }
      label: "Statistical Outlier Detector\n• Packet rate anomalies\n• Unusual protocol distributions\n• Traffic volume spikes"
    }
  }
  
  tracker_db: "Tracker Database" {
    shape: cylinder
    style: {
      fill: "#C5CAE9"
      stroke: "#3F51B5"
      multiple: true
    }
    label: "Tracker Database\n• Port scan trackers\n• SYN flood trackers\n• Connection states"
  }
}

alert_system: "Alert System" {
  style: {
    fill: "#FFEBEE"
    stroke: "#D32F2F"
    stroke-width: 2
  }
  
  alert_queue: "Alert Queue" {
    shape: queue
    style: {
      fill: "#FFCDD2"
      stroke: "#C62828"
    }
  }
  
  alert_logger: "Alert Logger" {
    shape: document
    style: {
      fill: "#EF9A9A"
      stroke: "#B71C1C"
    }
  }
}

cleanup_service: "Cleanup Service" {
  shape: step
  style: {
    fill: "#E8F5E9"
    stroke: "#388E3C"
    stroke-dash: 5
  }
  label: "Cleanup Service\n• Expire old trackers\n• Free memory\n• Runs every 10K packets"
}

packet_stream -> detection_engine.dispatcher: "Parsed Packets" {
  style: {
    stroke: "#1976D2"
    stroke-width: 3
    animated: true
  }
}

detection_engine.dispatcher -> detection_engine.pattern_matchers.port_scan: "Check" {
  style: {
    stroke: "#F57F17"
    animated: true
  }
}

detection_engine.dispatcher -> detection_engine.pattern_matchers.syn_flood: "Check" {
  style: {
    stroke: "#C62828"
    animated: true
  }
}

detection_engine.dispatcher -> detection_engine.pattern_matchers.malformed: "Check" {
  style: {
    stroke: "#AD1457"
    animated: true
  }
}

detection_engine.dispatcher -> detection_engine.pattern_matchers.statistical: "Check" {
  style: {
    stroke: "#6A1B9A"
    animated: true
  }
}

detection_engine.pattern_matchers.port_scan <-> detection_engine.tracker_db: "Update/Query" {
  style: {
    stroke: "#3F51B5"
    stroke-dash: 3
  }
}

detection_engine.pattern_matchers.syn_flood <-> detection_engine.tracker_db: "Update/Query" {
  style: {
    stroke: "#3F51B5"
    stroke-dash: 3
  }
}

detection_engine.pattern_matchers.port_scan -> alert_system.alert_queue: "Port Scan Alert" {
  style: {
    stroke: "#D32F2F"
    stroke-width: 2
    animated: true
  }
}

detection_engine.pattern_matchers.syn_flood -> alert_system.alert_queue: "SYN Flood Alert" {
  style: {
    stroke: "#D32F2F"
    stroke-width: 2
    animated: true
  }
}

detection_engine.pattern_matchers.malformed -> alert_system.alert_queue: "Malformed Packet Alert" {
  style: {
    stroke: "#D32F2F"
    stroke-width: 2
    animated: true
  }
}

detection_engine.pattern_matchers.statistical -> alert_system.alert_queue: "Statistical Anomaly Alert" {
  style: {
    stroke: "#D32F2F"
    stroke-width: 2
    animated: true
  }
}

alert_system.alert_queue -> alert_system.alert_logger: "Log" {
  style: {
    stroke: "#B71C1C"
    stroke-width: 2
  }
}

cleanup_service -> detection_engine.tracker_db: "Expire Old Entries" {
  style: {
    stroke: "#388E3C"
    stroke-dash: 5
    animated: true
  }
}

detection_engine.dispatcher -> cleanup_service: "Trigger (every 10K packets)" {
  style: {
    stroke: "#66BB6A"
    stroke-dash: 5
  }
}

legend: "Detection Patterns" {
  near: bottom-right
  shape: rectangle
  style: {
    fill: "#FAFAFA"
    stroke: "#757575"
    font-size: 14
  }
  
  pattern1: "Port Scan: 50+ unique ports in 60s" {
    shape: text
    style: {
      font-color: "#F57F17"
      font-size: 12
    }
  }
  
  pattern2: "SYN Flood: 1000+ SYN/sec without ACK" {
    shape: text
    style: {
      font-color: "#C62828"
      font-size: 12
    }
  }
  
  pattern3: "Malformed: Invalid flags or checksums" {
    shape: text
    style: {
      font-color: "#AD1457"
      font-size: 12
    }
  }
  
  pattern4: "Statistical: Traffic rate anomalies" {
    shape: text
    style: {
      font-color: "#6A1B9A"
      font-size: 12
    }
  }
}

metrics: "Performance Metrics" {
  near: bottom-left
  shape: rectangle
  style: {
    fill: "#E8F5E9"
    stroke: "#388E3C"
    font-size: 14
  }
  
  metric1: "Throughput: 100K+ pps" {
    shape: text
    style: {
      font-color: "#2E7D32"
      font-size: 12
    }
  }
  
  metric2: "Latency (p99): <100 μs" {
    shape: text
    style: {
      font-color: "#2E7D32"
      font-size: 12
    }
  }
  
  metric3: "False Positive Rate: <1%" {
    shape: text
    style: {
      font-color: "#2E7D32"
      font-size: 12
    }
  }
}