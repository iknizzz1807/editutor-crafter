vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: down

title: "Street View: Raw Packet Capture Engine" {
  shape: text
  near: top-center
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

raw_socket: "Raw Socket Creation" {
  shape: rectangle
  style: {
    fill: "#e3f2fd"
    stroke: "#1976d2"
    stroke-width: 3
  }
  
  socket_call: "socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL))" {
    shape: code
    style: {
      fill: "#fff3e0"
      font: mono
    }
  }
  
  error_check: "Error Check: fd < 0?" {
    shape: diamond
    style: {
      fill: "#fff9c4"
    }
  }
}

promiscuous_mode: "Promiscuous Mode Setup" {
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#7b1fa2"
    stroke-width: 3
  }
  
  ifreq_struct: "struct ifreq ifr" {
    shape: code
    style: {
      fill: "#fff3e0"
      font: mono
    }
  }
  
  ioctl_call: "ioctl(fd, SIOCGIFFLAGS, &ifr)" {
    shape: code
    style: {
      fill: "#fff3e0"
      font: mono
    }
  }
  
  set_promisc: "ifr.ifr_flags |= IFF_PROMISC" {
    shape: code
    style: {
      fill: "#fff3e0"
      font: mono
    }
  }
  
  apply_flags: "ioctl(fd, SIOCSIFFLAGS, &ifr)" {
    shape: code
    style: {
      fill: "#fff3e0"
      font: mono
    }
  }
}

packet_loop: "Packet Reception Loop" {
  shape: rectangle
  style: {
    fill: "#e8f5e9"
    stroke: "#388e3c"
    stroke-width: 3
    multiple: true
  }
  
  recv_call: "recvfrom(fd, buffer, 65536, 0, NULL, NULL)" {
    shape: code
    style: {
      fill: "#fff3e0"
      font: mono
    }
  }
  
  bytes_check: "bytes_received > 0?" {
    shape: diamond
    style: {
      fill: "#fff9c4"
    }
  }
  
  timestamp_gen: "gettimeofday(&tv, NULL)" {
    shape: code
    style: {
      fill: "#fff3e0"
      font: mono
    }
  }
}

buffer_handoff: "Buffer Handoff" {
  shape: rectangle
  style: {
    fill: "#fce4ec"
    stroke: "#c2185b"
    stroke-width: 3
  }
  
  copy_buffer: "memcpy(queue_buffer, buffer, bytes_received)" {
    shape: code
    style: {
      fill: "#fff3e0"
      font: mono
    }
  }
  
  enqueue: "enqueue_packet(queue, queue_buffer, bytes_received, tv)" {
    shape: code
    style: {
      fill: "#fff3e0"
      font: mono
    }
  }
}

processing_queue: "Processing Queue" {
  shape: queue
  style: {
    fill: "#fff8e1"
    stroke: "#f57c00"
    stroke-width: 3
  }
}

error_handler: "Error Handler" {
  shape: hexagon
  style: {
    fill: "#ffebee"
    stroke: "#d32f2f"
    stroke-width: 2
  }
  
  log_error: "log_error(errno)" {
    shape: code
    style: {
      fill: "#fff3e0"
      font: mono
    }
  }
}

raw_socket.socket_call -> raw_socket.error_check
raw_socket.error_check -> error_handler: "Yes (fd < 0)" {
  style: {
    stroke: red
    stroke-dash: 3
  }
}
raw_socket.error_check -> promiscuous_mode: "No (fd >= 0)" {
  style: {
    stroke: green
  }
}

promiscuous_mode.ifreq_struct -> promiscuous_mode.ioctl_call
promiscuous_mode.ioctl_call -> promiscuous_mode.set_promisc
promiscuous_mode.set_promisc -> promiscuous_mode.apply_flags
promiscuous_mode.apply_flags -> packet_loop

packet_loop.recv_call -> packet_loop.bytes_check
packet_loop.bytes_check -> error_handler: "No (bytes <= 0)" {
  style: {
    stroke: red
    stroke-dash: 3
  }
}
packet_loop.bytes_check -> packet_loop.timestamp_gen: "Yes (bytes > 0)" {
  style: {
    stroke: green
  }
}
packet_loop.timestamp_gen -> buffer_handoff

buffer_handoff.copy_buffer -> buffer_handoff.enqueue
buffer_handoff.enqueue -> processing_queue
processing_queue -> packet_loop.recv_call: "Loop continues" {
  style: {
    stroke: blue
    stroke-dash: 5
    animated: true
  }
}

legend: "Legend" {
  near: bottom-right
  shape: rectangle
  style: {
    fill: "#fafafa"
    stroke: "#9e9e9e"
    stroke-width: 2
  }
  
  success_flow: "Success Path" {
    shape: text
    style: {
      font-color: green
    }
  }
  
  error_flow: "Error Path" {
    shape: text
    style: {
      font-color: red
    }
  }
  
  loop_flow: "Loop/Repeat" {
    shape: text
    style: {
      font-color: blue
    }
  }
}

notes: |md
  ## Key Implementation Details
  
  **Raw Socket Creation:**
  - AF_PACKET: Access to link layer
  - SOCK_RAW: Raw packet access
  - ETH_P_ALL: Capture all protocols
  
  **Promiscuous Mode:**
  - Captures all packets on network segment
  - Not just packets destined for this host
  - Requires root/CAP_NET_RAW privileges
  
  **Timestamp Generation:**
  - Microsecond precision via gettimeofday()
  - Critical for accurate flow analysis
  - Captured immediately upon packet receipt
  
  **Buffer Management:**
  - Zero-copy where possible
  - Queue prevents packet loss during processing
  - Circular buffer for efficiency
| {
  near: bottom-left
  shape: rectangle
  style: {
    fill: "#f5f5f5"
    stroke: "#757575"
    stroke-width: 2
    font-size: 14
  }
}