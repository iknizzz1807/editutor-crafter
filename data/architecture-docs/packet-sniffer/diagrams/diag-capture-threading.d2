vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Microscopic View: Capture Thread Internals" {
  near: top-center
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

direction: down

# Main capture thread lifecycle
capture_thread: "Capture Thread (pthread)" {
  shape: rectangle
  style: {
    fill: "#E8F4F8"
    stroke: "#2E86AB"
    stroke-width: 3
    font-size: 20
    bold: true
  }
}

# Thread initialization
init_phase: "Initialization Phase" {
  style: {
    fill: "#FFF4E6"
    stroke: "#FB8500"
    stroke-width: 2
  }
  
  socket_create: "socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL))" {
    shape: rectangle
    style: {
      fill: "#FFE5CC"
      font: mono
      font-size: 14
    }
  }
  
  bind_interface: "bind(sockfd, &sll, sizeof(sll))" {
    shape: rectangle
    style: {
      fill: "#FFE5CC"
      font: mono
      font-size: 14
    }
  }
  
  buffer_alloc: "malloc(BUFFER_SIZE)" {
    shape: rectangle
    style: {
      fill: "#FFE5CC"
      font: mono
      font-size: 14
    }
    tooltip: "Allocates 65536 bytes for packet buffer"
  }
  
  signal_setup: "sigaction(SIGINT, &sa, NULL)" {
    shape: rectangle
    style: {
      fill: "#FFE5CC"
      font: mono
      font-size: 14
    }
  }
}

# Main capture loop
capture_loop: "Main Capture Loop" {
  style: {
    fill: "#E8F5E9"
    stroke: "#2E7D32"
    stroke-width: 2
  }
  
  while_running: "while (running)" {
    shape: diamond
    style: {
      fill: "#C8E6C9"
      font-size: 16
    }
  }
  
  recvfrom_call: "recvfrom(sockfd, buffer, BUFFER_SIZE, 0, NULL, NULL)" {
    shape: rectangle
    style: {
      fill: "#A5D6A7"
      font: mono
      font-size: 13
    }
    tooltip: "Blocking system call - waits for packet"
  }
  
  check_bytes: "bytes_received > 0?" {
    shape: diamond
    style: {
      fill: "#C8E6C9"
      font-size: 14
    }
  }
  
  parse_packet: "parse_packet(buffer, bytes_received)" {
    shape: rectangle
    style: {
      fill: "#A5D6A7"
      font: mono
      font-size: 13
    }
  }
  
  enqueue: "packet_queue_enqueue(&parsed_packet)" {
    shape: rectangle
    style: {
      fill: "#A5D6A7"
      font: mono
      font-size: 13
    }
  }
  
  update_stats: "stats.packets_captured++" {
    shape: rectangle
    style: {
      fill: "#A5D6A7"
      font: mono
      font-size: 13
    }
  }
}

# Error handling
error_handling: "Error Handling" {
  style: {
    fill: "#FFEBEE"
    stroke: "#C62828"
    stroke-width: 2
  }
  
  check_errno: "Check errno" {
    shape: diamond
    style: {
      fill: "#FFCDD2"
      font-size: 14
    }
  }
  
  eintr: "EINTR (Interrupted)" {
    shape: rectangle
    style: {
      fill: "#EF9A9A"
      font-size: 13
    }
    tooltip: "Signal received - continue loop"
  }
  
  eagain: "EAGAIN (No data)" {
    shape: rectangle
    style: {
      fill: "#EF9A9A"
      font-size: 13
    }
    tooltip: "Non-blocking mode - retry"
  }
  
  fatal: "Fatal Error" {
    shape: rectangle
    style: {
      fill: "#E57373"
      font-size: 13
    }
    tooltip: "Log error and exit thread"
  }
}

# Signal handling
signal_handler: "Signal Handler" {
  style: {
    fill: "#F3E5F5"
    stroke: "#6A1B9A"
    stroke-width: 2
  }
  
  sigint_handler: "sigint_handler(int sig)" {
    shape: rectangle
    style: {
      fill: "#E1BEE7"
      font: mono
      font-size: 13
    }
  }
  
  set_flag: "running = 0" {
    shape: rectangle
    style: {
      fill: "#E1BEE7"
      font: mono
      font-size: 13
    }
    tooltip: "Atomic flag to stop capture loop"
  }
}

# Cleanup phase
cleanup: "Cleanup Phase" {
  style: {
    fill: "#FFF9C4"
    stroke: "#F57F17"
    stroke-width: 2
  }
  
  close_socket: "close(sockfd)" {
    shape: rectangle
    style: {
      fill: "#FFF59D"
      font: mono
      font-size: 13
    }
  }
  
  free_buffer: "free(buffer)" {
    shape: rectangle
    style: {
      fill: "#FFF59D"
      font: mono
      font-size: 13
    }
  }
  
  log_stats: "log_capture_statistics()" {
    shape: rectangle
    style: {
      fill: "#FFF59D"
      font: mono
      font-size: 13
    }
  }
  
  thread_exit: "pthread_exit(NULL)" {
    shape: rectangle
    style: {
      fill: "#FFF59D"
      font: mono
      font-size: 13
    }
  }
}

# Memory layout
memory_view: "Memory Layout" {
  style: {
    fill: "#E0F2F1"
    stroke: "#00695C"
    stroke-width: 2
  }
  
  stack: "Thread Stack" {
    shape: rectangle
    style: {
      fill: "#B2DFDB"
      font-size: 14
    }
    tooltip: "Local variables, function calls"
  }
  
  heap_buffer: "Heap: Packet Buffer (64KB)" {
    shape: rectangle
    style: {
      fill: "#80CBC4"
      font-size: 14
    }
  }
  
  shared_queue: "Shared: Packet Queue" {
    shape: cylinder
    style: {
      fill: "#4DB6AC"
      font-size: 14
    }
    tooltip: "Protected by mutex"
  }
}

# System call interface
syscall_layer: "Kernel Interface" {
  style: {
    fill: "#ECEFF1"
    stroke: "#37474F"
    stroke-width: 2
  }
  
  kernel_socket: "Kernel Socket Buffer" {
    shape: cylinder
    style: {
      fill: "#CFD8DC"
      font-size: 14
    }
  }
  
  network_driver: "Network Driver (NIC)" {
    shape: rectangle
    style: {
      fill: "#B0BEC5"
      font-size: 14
    }
  }
}

# Connections - Initialization flow
capture_thread -> init_phase: "1. Initialize"
init_phase.socket_create -> init_phase.bind_interface
init_phase.bind_interface -> init_phase.buffer_alloc
init_phase.buffer_alloc -> init_phase.signal_setup
init_phase.signal_setup -> capture_loop: "2. Enter loop"

# Main loop flow
capture_loop.while_running -> capture_loop.recvfrom_call: "running == 1"
capture_loop.recvfrom_call -> capture_loop.check_bytes
capture_loop.check_bytes -> capture_loop.parse_packet: "bytes > 0"
capture_loop.parse_packet -> capture_loop.enqueue
capture_loop.enqueue -> capture_loop.update_stats
capture_loop.update_stats -> capture_loop.while_running: "Loop back"

# Error path
capture_loop.check_bytes -> error_handling.check_errno: "bytes <= 0" {
  style: {
    stroke: red
    stroke-dash: 3
  }
}
error_handling.check_errno -> error_handling.eintr: "EINTR"
error_handling.check_errno -> error_handling.eagain: "EAGAIN"
error_handling.check_errno -> error_handling.fatal: "Other"
error_handling.eintr -> capture_loop.while_running: "Continue" {
  style: {
    stroke: green
    stroke-dash: 3
  }
}
error_handling.eagain -> capture_loop.while_running: "Retry" {
  style: {
    stroke: green
    stroke-dash: 3
  }
}
error_handling.fatal -> cleanup: "Exit" {
  style: {
    stroke: red
    stroke-width: 2
  }
}

# Signal handling flow
signal_handler.sigint_handler -> signal_handler.set_flag
signal_handler.set_flag -> capture_loop.while_running: "Interrupt" {
  style: {
    stroke: purple
    stroke-dash: 5
    animated: true
  }
}

# Cleanup flow
capture_loop.while_running -> cleanup: "running == 0" {
  style: {
    stroke: orange
    stroke-width: 2
  }
}
cleanup.close_socket -> cleanup.free_buffer
cleanup.free_buffer -> cleanup.log_stats
cleanup.log_stats -> cleanup.thread_exit

# Memory interactions
capture_loop.recvfrom_call -> memory_view.heap_buffer: "Write packet data" {
  style: {
    stroke: blue
    stroke-dash: 3
  }
}
capture_loop.enqueue -> memory_view.shared_queue: "Enqueue (mutex lock)" {
  style: {
    stroke: green
    stroke-dash: 3
  }
}

# System call interactions
capture_loop.recvfrom_call -> syscall_layer.kernel_socket: "System call" {
  style: {
    stroke: "#37474F"
    stroke-width: 2
  }
}
syscall_layer.kernel_socket -> syscall_layer.network_driver: "DMA transfer"
syscall_layer.network_driver -> syscall_layer.kernel_socket: "Packet arrival" {
  style: {
    stroke: green
    animated: true
  }
}

# Legend
legend: "Legend" {
  near: bottom-right
  style: {
    fill: white
    stroke: gray
    stroke-dash: 3
  }
  
  normal_flow: "Normal Flow" {
    shape: text
    style.font-size: 12
  }
  error_flow: "Error Path" {
    shape: text
    style: {
      font-size: 12
      font-color: red
    }
  }
  signal_flow: "Signal Interrupt" {
    shape: text
    style: {
      font-size: 12
      font-color: purple
    }
  }
}

# Code snippet annotation
code_note: |md
  **Key System Calls:**
  - socket(): Creates raw packet socket
  - bind(): Binds to network interface
  - recvfrom(): Blocking read (kernel â†’ userspace)
  - close(): Releases socket descriptor
  
  **Thread Safety:**
  - Packet queue protected by pthread_mutex
  - Atomic flag for graceful shutdown
| {
  near: bottom-left
  style: {
    fill: "#FFFDE7"
    stroke: "#F57F17"
    font-size: 11
  }
}