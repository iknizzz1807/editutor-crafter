vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

title: "TCP Connection State Machine" {
  shape: text
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

CLOSED: {
  shape: circle
  style: {
    fill: "#e8eaf6"
    stroke: "#5c6bc0"
    stroke-width: 3
  }
}

SYN_SENT: {
  shape: circle
  style: {
    fill: "#fff3e0"
    stroke: "#ff9800"
    stroke-width: 3
  }
}

SYN_RECEIVED: {
  shape: circle
  style: {
    fill: "#fff3e0"
    stroke: "#ff9800"
    stroke-width: 3
  }
}

ESTABLISHED: {
  shape: circle
  style: {
    fill: "#e8f5e9"
    stroke: "#4caf50"
    stroke-width: 3
    double-border: true
  }
}

FIN_WAIT_1: {
  shape: circle
  style: {
    fill: "#fce4ec"
    stroke: "#e91e63"
    stroke-width: 3
  }
}

FIN_WAIT_2: {
  shape: circle
  style: {
    fill: "#fce4ec"
    stroke: "#e91e63"
    stroke-width: 3
  }
}

CLOSING: {
  shape: circle
  style: {
    fill: "#fce4ec"
    stroke: "#e91e63"
    stroke-width: 3
  }
}

TIME_WAIT: {
  shape: circle
  style: {
    fill: "#f3e5f5"
    stroke: "#9c27b0"
    stroke-width: 3
  }
}

CLOSE_WAIT: {
  shape: circle
  style: {
    fill: "#fce4ec"
    stroke: "#e91e63"
    stroke-width: 3
  }
}

LAST_ACK: {
  shape: circle
  style: {
    fill: "#fce4ec"
    stroke: "#e91e63"
    stroke-width: 3
  }
}

CLOSED -> SYN_SENT: "Client sends SYN" {
  style: {
    stroke: "#ff9800"
    stroke-width: 2
    animated: true
  }
}

SYN_SENT -> SYN_RECEIVED: "Server receives SYN,\nsends SYN-ACK" {
  style: {
    stroke: "#ff9800"
    stroke-width: 2
  }
}

SYN_RECEIVED -> ESTABLISHED: "Client sends ACK" {
  style: {
    stroke: "#4caf50"
    stroke-width: 2
    animated: true
  }
}

SYN_SENT -> ESTABLISHED: "Simultaneous open:\nreceive SYN-ACK,\nsend ACK" {
  style: {
    stroke: "#4caf50"
    stroke-width: 2
    stroke-dash: 3
  }
}

ESTABLISHED -> FIN_WAIT_1: "Active close:\nsend FIN" {
  style: {
    stroke: "#e91e63"
    stroke-width: 2
    animated: true
  }
}

ESTABLISHED -> CLOSE_WAIT: "Passive close:\nreceive FIN,\nsend ACK" {
  style: {
    stroke: "#e91e63"
    stroke-width: 2
  }
}

FIN_WAIT_1 -> FIN_WAIT_2: "Receive ACK" {
  style: {
    stroke: "#e91e63"
    stroke-width: 2
  }
}

FIN_WAIT_1 -> CLOSING: "Simultaneous close:\nreceive FIN,\nsend ACK" {
  style: {
    stroke: "#e91e63"
    stroke-width: 2
    stroke-dash: 3
  }
}

FIN_WAIT_2 -> TIME_WAIT: "Receive FIN,\nsend ACK" {
  style: {
    stroke: "#9c27b0"
    stroke-width: 2
  }
}

CLOSING -> TIME_WAIT: "Receive ACK" {
  style: {
    stroke: "#9c27b0"
    stroke-width: 2
  }
}

CLOSE_WAIT -> LAST_ACK: "Send FIN" {
  style: {
    stroke: "#e91e63"
    stroke-width: 2
  }
}

LAST_ACK -> CLOSED: "Receive ACK" {
  style: {
    stroke: "#5c6bc0"
    stroke-width: 2
  }
}

TIME_WAIT -> CLOSED: "2MSL timeout\n(2 × Max Segment Lifetime)" {
  style: {
    stroke: "#5c6bc0"
    stroke-width: 2
    stroke-dash: 5
  }
}

SYN_SENT -> CLOSED: "Timeout or RST" {
  style: {
    stroke: "#f44336"
    stroke-width: 2
    stroke-dash: 5
  }
}

SYN_RECEIVED -> CLOSED: "Timeout or RST" {
  style: {
    stroke: "#f44336"
    stroke-width: 2
    stroke-dash: 5
  }
}

ESTABLISHED -> CLOSED: "Receive RST" {
  style: {
    stroke: "#f44336"
    stroke-width: 2
    stroke-dash: 5
  }
}

legend: "Legend" {
  shape: rectangle
  style: {
    fill: "#fafafa"
    stroke: "#9e9e9e"
    stroke-width: 2
    border-radius: 8
  }
  
  normal_transition: "Normal transition" {
    shape: text
    style: {
      font-size: 14
    }
  }
  
  timeout_reset: "Timeout/Reset" {
    shape: text
    style: {
      font-size: 14
      font-color: "#f44336"
    }
  }
  
  simultaneous: "Simultaneous event" {
    shape: text
    style: {
      font-size: 14
      font-color: "#ff9800"
    }
  }
}

handshake_note: "3-Way Handshake:\nSYN → SYN-ACK → ACK" {
  shape: text
  style: {
    font-size: 16
    italic: true
    fill: "#e3f2fd"
    stroke: "#2196f3"
    stroke-width: 2
    border-radius: 8
  }
}

teardown_note: "4-Way Teardown:\nFIN → ACK → FIN → ACK" {
  shape: text
  style: {
    font-size: 16
    italic: true
    fill: "#fce4ec"
    stroke: "#e91e63"
    stroke-width: 2
    border-radius: 8
  }
}