vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: down

title: "DNS Protocol Parser - Microscopic View" {
  shape: text
  near: top-center
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

dns_packet: "DNS Packet (UDP payload)" {
  shape: rectangle
  style: {
    fill: "#e3f2fd"
    stroke: "#1976d2"
    stroke-width: 3
  }
}

header: "DNS Header (12 bytes)" {
  shape: rectangle
  style: {
    fill: "#fff3e0"
    stroke: "#f57c00"
    stroke-width: 2
  }
  
  transaction_id: "Transaction ID (16 bits)" {
    shape: rectangle
    style.fill: "#ffe0b2"
  }
  
  flags: "Flags (16 bits)" {
    shape: rectangle
    style.fill: "#ffcc80"
    
    qr: "QR: Query(0)/Response(1)" {shape: rectangle}
    opcode: "Opcode: Standard(0)" {shape: rectangle}
    aa: "AA: Authoritative" {shape: rectangle}
    tc: "TC: Truncated" {shape: rectangle}
    rd: "RD: Recursion Desired" {shape: rectangle}
    ra: "RA: Recursion Available" {shape: rectangle}
    rcode: "RCODE: Response Code" {shape: rectangle}
  }
  
  counts: "Counts (4 x 16 bits)" {
    shape: rectangle
    style.fill: "#ffe0b2"
    
    qdcount: "QDCOUNT: Questions" {shape: rectangle}
    ancount: "ANCOUNT: Answers" {shape: rectangle}
    nscount: "NSCOUNT: Authority RRs" {shape: rectangle}
    arcount: "ARCOUNT: Additional RRs" {shape: rectangle}
  }
}

question_section: "Question Section" {
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#7b1fa2"
    stroke-width: 2
  }
  
  qname: "QNAME (variable)" {
    shape: rectangle
    style.fill: "#e1bee7"
    
    label_format: "Label Format" {
      shape: rectangle
      style.fill: "#ce93d8"
      
      length_byte: "Length byte (1-63)" {shape: rectangle}
      label_data: "Label data" {shape: rectangle}
      terminator: "0x00 terminator" {shape: rectangle}
    }
    
    compression: "Name Compression" {
      shape: rectangle
      style.fill: "#ba68c8"
      
      pointer_format: "Pointer: 0xC0 + offset" {shape: rectangle}
      offset_calc: "Offset from DNS start" {shape: rectangle}
    }
  }
  
  qtype: "QTYPE (16 bits)" {
    shape: rectangle
    style.fill: "#e1bee7"
    
    type_a: "A (1): IPv4" {shape: rectangle}
    type_aaaa: "AAAA (28): IPv6" {shape: rectangle}
    type_cname: "CNAME (5): Alias" {shape: rectangle}
    type_mx: "MX (15): Mail" {shape: rectangle}
  }
  
  qclass: "QCLASS (16 bits)" {
    shape: rectangle
    style.fill: "#e1bee7"
    
    class_in: "IN (1): Internet" {shape: rectangle}
  }
}

answer_section: "Answer Section (RRs)" {
  shape: rectangle
  style: {
    fill: "#e8f5e9"
    stroke: "#388e3c"
    stroke-width: 2
  }
  
  rr_name: "NAME (variable)" {
    shape: rectangle
    style.fill: "#c8e6c9"
    
    name_ref: "Often compressed pointer" {shape: rectangle}
  }
  
  rr_type: "TYPE (16 bits)" {
    shape: rectangle
    style.fill: "#c8e6c9"
  }
  
  rr_class: "CLASS (16 bits)" {
    shape: rectangle
    style.fill: "#c8e6c9"
  }
  
  rr_ttl: "TTL (32 bits)" {
    shape: rectangle
    style.fill: "#c8e6c9"
    
    ttl_seconds: "Cache lifetime (seconds)" {shape: rectangle}
  }
  
  rr_rdlength: "RDLENGTH (16 bits)" {
    shape: rectangle
    style.fill: "#c8e6c9"
  }
  
  rr_rdata: "RDATA (variable)" {
    shape: rectangle
    style.fill: "#a5d6a7"
    
    a_record: "A Record: 4 bytes IPv4" {shape: rectangle}
    aaaa_record: "AAAA Record: 16 bytes IPv6" {shape: rectangle}
    cname_record: "CNAME: Domain name" {shape: rectangle}
  }
}

parser_logic: "Parser Logic" {
  shape: rectangle
  style: {
    fill: "#fff9c4"
    stroke: "#f9a825"
    stroke-width: 2
  }
  
  parse_header: "parse_dns_header()" {
    shape: rectangle
    style.fill: "#fff59d"
    
    extract_id: "Extract transaction ID" {shape: rectangle}
    parse_flags: "Parse flag bits" {shape: rectangle}
    read_counts: "Read section counts" {shape: rectangle}
  }
  
  parse_name: "parse_dns_name()" {
    shape: rectangle
    style.fill: "#fff59d"
    
    read_label: "Read label length" {shape: rectangle}
    check_compression: "Check for pointer (0xC0)" {shape: rectangle}
    follow_pointer: "Follow pointer if compressed" {shape: rectangle}
    build_fqdn: "Build FQDN string" {shape: rectangle}
  }
  
  parse_question: "parse_dns_question()" {
    shape: rectangle
    style.fill: "#fff59d"
    
    call_parse_name: "Call parse_dns_name()" {shape: rectangle}
    read_qtype: "Read QTYPE" {shape: rectangle}
    read_qclass: "Read QCLASS" {shape: rectangle}
  }
  
  parse_rr: "parse_dns_rr()" {
    shape: rectangle
    style.fill: "#fff59d"
    
    parse_rr_name: "Parse RR name" {shape: rectangle}
    read_rr_fields: "Read TYPE/CLASS/TTL" {shape: rectangle}
    parse_rdata: "Parse RDATA by type" {shape: rectangle}
  }
  
  correlate: "correlate_query_response()" {
    shape: rectangle
    style.fill: "#fff59d"
    
    match_txid: "Match transaction ID" {shape: rectangle}
    match_qname: "Match question name" {shape: rectangle}
    link_qr: "Link query to response" {shape: rectangle}
  }
}

error_handling: "Error Handling" {
  shape: rectangle
  style: {
    fill: "#ffebee"
    stroke: "#c62828"
    stroke-width: 2
  }
  
  truncated: "Truncated packet (TC=1)" {shape: rectangle}
  malformed: "Malformed name labels" {shape: rectangle}
  loop_detect: "Compression loop detection" {shape: rectangle}
  invalid_type: "Invalid QTYPE/RCODE" {shape: rectangle}
}

dns_packet -> header: "Parse header"
dns_packet -> question_section: "Parse questions"
dns_packet -> answer_section: "Parse answers"

header -> parser_logic.parse_header
question_section -> parser_logic.parse_question
answer_section -> parser_logic.parse_rr

parser_logic.parse_question -> parser_logic.parse_name: "Uses"
parser_logic.parse_rr -> parser_logic.parse_name: "Uses"

parser_logic.parse_header -> parser_logic.correlate: "Provides TX ID"
parser_logic.parse_question -> parser_logic.correlate: "Provides QNAME"

parser_logic.parse_name -> error_handling.malformed: "Detects"
parser_logic.parse_name -> error_handling.loop_detect: "Detects"
header.flags.tc -> error_handling.truncated: "Indicates"

legend: "Legend" {
  shape: rectangle
  near: bottom-right
  style: {
    fill: "#fafafa"
    stroke: "#9e9e9e"
    stroke-width: 1
  }
  
  leg1: "Header: Orange" {
    shape: rectangle
    style.fill: "#fff3e0"
  }
  leg2: "Question: Purple" {
    shape: rectangle
    style.fill: "#f3e5f5"
  }
  leg3: "Answer: Green" {
    shape: rectangle
    style.fill: "#e8f5e9"
  }
  leg4: "Parser: Yellow" {
    shape: rectangle
    style.fill: "#fff9c4"
  }
  leg5: "Errors: Red" {
    shape: rectangle
    style.fill: "#ffebee"
  }
}

notes: |md
  **DNS Parsing Key Points:**
  - Header is fixed 12 bytes
  - Names use label format with compression
  - Compression pointers: 0xC0 + offset
  - Must track position for pointer resolution
  - Query/Response correlation via Transaction ID
  - RDATA format depends on TYPE field
| {
  shape: rectangle
  near: bottom-left
  style: {
    fill: "#f5f5f5"
    stroke: "#757575"
    font-size: 14
  }
}