vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

title: "Street View: Error Handling and Recovery" {
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

classes: {
  error_source: {
    style: {
      fill: "#FFE0E0"
      stroke: "#CC0000"
      stroke-width: 2
    }
  }
  
  handler: {
    style: {
      fill: "#FFF4E0"
      stroke: "#FF8C00"
      stroke-width: 2
    }
  }
  
  recovery: {
    style: {
      fill: "#E0FFE0"
      stroke: "#00AA00"
      stroke-width: 2
    }
  }
  
  critical: {
    style: {
      fill: "#FFD0D0"
      stroke: "#AA0000"
      stroke-width: 3
      stroke-dash: 3
    }
  }
}

malformed_packet: "Malformed Packet\nDetected" {
  class: error_source
  shape: diamond
}

parser_error: "Parser Error\nHandler" {
  class: handler
  shape: hexagon
}

error_log: "Error Logger" {
  class: handler
  shape: cylinder
}

packet_drop: "Drop Packet" {
  class: recovery
  shape: step
}

partial_parse: "Partial Parse\nRecovery" {
  class: recovery
  shape: step
}

resource_cleanup: "Resource Cleanup\nManager" {
  class: recovery
  shape: rectangle
}

graceful_degrade: "Graceful\nDegradation" {
  class: recovery
  shape: cloud
}

alert_system: "Alert System" {
  class: critical
  shape: rectangle
}

memory_leak_check: "Memory Leak\nDetection" {
  class: handler
  shape: hexagon
}

state_reset: "State Reset\nMechanism" {
  class: recovery
  shape: step
}

malformed_packet -> parser_error: "Trigger error\nhandler" {
  style: {
    stroke: "#CC0000"
    stroke-width: 2
    animated: true
  }
}

parser_error -> error_log: "Log error\ndetails" {
  style: {
    stroke: "#FF8C00"
    stroke-width: 2
  }
}

parser_error -> packet_drop: "Cannot\nrecover" {
  style: {
    stroke: "#AA0000"
    stroke-width: 2
    stroke-dash: 5
  }
}

parser_error -> partial_parse: "Attempt\nrecovery" {
  style: {
    stroke: "#00AA00"
    stroke-width: 2
  }
}

partial_parse -> resource_cleanup: "Clean up\npartial data" {
  style: {
    stroke: "#00AA00"
    stroke-width: 2
  }
}

packet_drop -> resource_cleanup: "Release\nresources" {
  style: {
    stroke: "#00AA00"
    stroke-width: 2
  }
}

resource_cleanup -> memory_leak_check: "Verify no\nleaks" {
  style: {
    stroke: "#FF8C00"
    stroke-width: 2
  }
}

memory_leak_check -> state_reset: "Reset\ntracker state" {
  style: {
    stroke: "#00AA00"
    stroke-width: 2
  }
}

parser_error -> alert_system: "Critical\nerror" {
  style: {
    stroke: "#AA0000"
    stroke-width: 3
    animated: true
  }
}

alert_system -> graceful_degrade: "Reduce\nprocessing" {
  style: {
    stroke: "#FF8C00"
    stroke-width: 2
  }
}

error_scenarios: "Error Scenarios" {
  shape: rectangle
  style: {
    fill: "#F0F0F0"
    stroke: "#666666"
    stroke-width: 2
  }
  
  truncated_header: "Truncated Header\n(len < min)" {
    shape: rectangle
    style: {
      fill: "#FFE0E0"
      stroke: "#CC0000"
    }
  }
  
  invalid_checksum: "Invalid Checksum\n(corruption)" {
    shape: rectangle
    style: {
      fill: "#FFE0E0"
      stroke: "#CC0000"
    }
  }
  
  unknown_protocol: "Unknown Protocol\n(unsupported)" {
    shape: rectangle
    style: {
      fill: "#FFE0E0"
      stroke: "#CC0000"
    }
  }
  
  resource_exhaustion: "Resource Exhaustion\n(OOM)" {
    shape: rectangle
    style: {
      fill: "#FFD0D0"
      stroke: "#AA0000"
    }
  }
}

error_scenarios.truncated_header -> malformed_packet {
  style: {
    stroke: "#CC0000"
    stroke-dash: 3
  }
}

error_scenarios.invalid_checksum -> malformed_packet {
  style: {
    stroke: "#CC0000"
    stroke-dash: 3
  }
}

error_scenarios.unknown_protocol -> malformed_packet {
  style: {
    stroke: "#CC0000"
    stroke-dash: 3
  }
}

error_scenarios.resource_exhaustion -> alert_system {
  style: {
    stroke: "#AA0000"
    stroke-width: 3
    animated: true
  }
}

recovery_strategies: "Recovery Strategies" {
  shape: rectangle
  style: {
    fill: "#F0F0F0"
    stroke: "#666666"
    stroke-width: 2
  }
  
  skip_packet: "Skip Packet\n(continue)" {
    shape: step
    style: {
      fill: "#E0FFE0"
      stroke: "#00AA00"
    }
  }
  
  use_defaults: "Use Default Values\n(safe fallback)" {
    shape: step
    style: {
      fill: "#E0FFE0"
      stroke: "#00AA00"
    }
  }
  
  retry_parse: "Retry Parse\n(different offset)" {
    shape: step
    style: {
      fill: "#FFF4E0"
      stroke: "#FF8C00"
    }
  }
  
  throttle_input: "Throttle Input\n(reduce load)" {
    shape: step
    style: {
      fill: "#E0FFE0"
      stroke: "#00AA00"
    }
  }
}

partial_parse -> recovery_strategies.use_defaults {
  style: {
    stroke: "#00AA00"
    stroke-dash: 3
  }
}

partial_parse -> recovery_strategies.retry_parse {
  style: {
    stroke: "#FF8C00"
    stroke-dash: 3
  }
}

packet_drop -> recovery_strategies.skip_packet {
  style: {
    stroke: "#00AA00"
    stroke-dash: 3
  }
}

graceful_degrade -> recovery_strategies.throttle_input {
  style: {
    stroke: "#00AA00"
    stroke-dash: 3
  }
}

legend: "Legend" {
  near: bottom-right
  shape: rectangle
  style: {
    fill: "#FFFFFF"
    stroke: "#666666"
    stroke-width: 1
  }
  
  error_flow: "Error Flow" {
    shape: text
    style: {
      font-color: "#CC0000"
      font-size: 14
    }
  }
  
  recovery_flow: "Recovery Flow" {
    shape: text
    style: {
      font-color: "#00AA00"
      font-size: 14
    }
  }
  
  critical_path: "Critical Path" {
    shape: text
    style: {
      font-color: "#AA0000"
      font-size: 14
      bold: true
    }
  }
}

notes: |md
  ## Error Handling Principles
  
  1. **Fail Fast**: Detect errors immediately
  2. **Fail Safe**: Never crash the detector
  3. **Fail Gracefully**: Degrade performance, not correctness
  4. **Fail Loudly**: Log all errors for debugging
  
  ## Recovery Priorities
  
  - **P0**: Prevent memory leaks (always cleanup)
  - **P1**: Maintain detector availability (never crash)
  - **P2**: Preserve detection accuracy (skip bad packets)
  - **P3**: Optimize throughput (throttle if needed)
| {
  near: bottom-left
  shape: rectangle
  style: {
    fill: "#FFFEF0"
    stroke: "#999999"
    stroke-width: 1
    font-size: 12
  }
}