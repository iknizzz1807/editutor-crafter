vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: down

title: "Microscopic View: Filter Rule Matching Algorithm" {
  shape: text
  style: {
    font-size: 28
    bold: true
    underline: true
  }
  near: top-center
}

packet_input: "Incoming Packet" {
  shape: parallelogram
  style: {
    fill: "#E3F2FD"
    stroke: "#1976D2"
    font-size: 16
    bold: true
  }
}

extract_fields: "Extract Fields" {
  shape: rectangle
  style: {
    fill: "#FFF9C4"
    stroke: "#F57C00"
    font-size: 14
  }
  tooltip: |md
    src_ip, dst_ip
    src_port, dst_port
    protocol
  |
}

rule_loop_start: "For Each Rule\n(index i)" {
  shape: diamond
  style: {
    fill: "#F3E5F5"
    stroke: "#7B1FA2"
    font-size: 14
  }
}

check_protocol: "Protocol Match?" {
  shape: diamond
  style: {
    fill: "#E8F5E9"
    stroke: "#388E3C"
    font-size: 13
  }
  tooltip: |md
    if (rule->protocol != ANY &&
        rule->protocol != packet->protocol)
      continue;
  |
}

early_exit_protocol: "Early Exit\n(Protocol Mismatch)" {
  shape: rectangle
  style: {
    fill: "#FFEBEE"
    stroke: "#C62828"
    font-size: 12
    stroke-dash: 3
  }
}

check_src_ip: "Source IP Match?" {
  shape: diamond
  style: {
    fill: "#E8F5E9"
    stroke: "#388E3C"
    font-size: 13
  }
  tooltip: |md
    Wildcard: rule->src_ip == 0
    CIDR: (packet->src_ip & rule->src_mask)
           == rule->src_ip
  |
}

early_exit_src_ip: "Early Exit\n(Src IP Mismatch)" {
  shape: rectangle
  style: {
    fill: "#FFEBEE"
    stroke: "#C62828"
    font-size: 12
    stroke-dash: 3
  }
}

check_dst_ip: "Dest IP Match?" {
  shape: diamond
  style: {
    fill: "#E8F5E9"
    stroke: "#388E3C"
    font-size: 13
  }
  tooltip: |md
    Wildcard: rule->dst_ip == 0
    CIDR: (packet->dst_ip & rule->dst_mask)
           == rule->dst_ip
  |
}

early_exit_dst_ip: "Early Exit\n(Dst IP Mismatch)" {
  shape: rectangle
  style: {
    fill: "#FFEBEE"
    stroke: "#C62828"
    font-size: 12
    stroke-dash: 3
  }
}

check_src_port: "Source Port Match?" {
  shape: diamond
  style: {
    fill: "#E8F5E9"
    stroke: "#388E3C"
    font-size: 13
  }
  tooltip: |md
    Wildcard: rule->src_port_min == 0
    Range: (packet->src_port >= min &&
            packet->src_port <= max)
  |
}

early_exit_src_port: "Early Exit\n(Src Port Mismatch)" {
  shape: rectangle
  style: {
    fill: "#FFEBEE"
    stroke: "#C62828"
    font-size: 12
    stroke-dash: 3
  }
}

check_dst_port: "Dest Port Match?" {
  shape: diamond
  style: {
    fill: "#E8F5E9"
    stroke: "#388E3C"
    font-size: 13
  }
  tooltip: |md
    Wildcard: rule->dst_port_min == 0
    Range: (packet->dst_port >= min &&
            packet->dst_port <= max)
  |
}

early_exit_dst_port: "Early Exit\n(Dst Port Mismatch)" {
  shape: rectangle
  style: {
    fill: "#FFEBEE"
    stroke: "#C62828"
    font-size: 12
    stroke-dash: 3
  }
}

rule_matched: "Rule Matched!" {
  shape: rectangle
  style: {
    fill: "#C8E6C9"
    stroke: "#2E7D32"
    font-size: 14
    bold: true
  }
}

increment_counter: "Increment\nrule->match_count" {
  shape: rectangle
  style: {
    fill: "#FFF9C4"
    stroke: "#F57C00"
    font-size: 12
  }
}

apply_action: "Apply Action" {
  shape: rectangle
  style: {
    fill: "#BBDEFB"
    stroke: "#1565C0"
    font-size: 14
  }
  tooltip: |md
    ALLOW: forward packet
    DENY: drop packet
    LOG: record + forward
  |
}

return_result: "Return Result" {
  shape: parallelogram
  style: {
    fill: "#E1BEE7"
    stroke: "#6A1B9A"
    font-size: 14
    bold: true
  }
}

next_rule: "Next Rule\n(i++)" {
  shape: rectangle
  style: {
    fill: "#E0E0E0"
    stroke: "#616161"
    font-size: 12
  }
}

no_match: "No Rules Matched\n(Default: ALLOW)" {
  shape: rectangle
  style: {
    fill: "#FFE0B2"
    stroke: "#E65100"
    font-size: 13
    stroke-dash: 3
  }
}

performance_box: "Performance Counters" {
  shape: rectangle
  style: {
    fill: "#F3E5F5"
    stroke: "#7B1FA2"
    font-size: 13
    bold: true
  }
  
  counter_1: "rules_evaluated++" {
    shape: text
    style: {
      font-size: 11
      font: mono
    }
  }
  
  counter_2: "early_exits++" {
    shape: text
    style: {
      font-size: 11
      font: mono
    }
  }
  
  counter_3: "full_matches++" {
    shape: text
    style: {
      font-size: 11
      font: mono
    }
  }
}

optimization_note: |md
  **Optimization Strategy:**
  - Check cheapest conditions first (protocol)
  - Early exit on first mismatch
  - Wildcard (0) = skip check
  - CIDR uses bitwise AND mask
  - Port ranges: inclusive [min, max]
| {
  shape: rectangle
  style: {
    fill: "#FFF3E0"
    stroke: "#EF6C00"
    font-size: 11
    italic: true
  }
  near: bottom-right
}

packet_input -> extract_fields: "Parse headers"
extract_fields -> rule_loop_start

rule_loop_start -> check_protocol: "Start iteration"
rule_loop_start -> no_match: "i >= rule_count" {
  style: {
    stroke-dash: 5
    stroke: "#E65100"
  }
}

check_protocol -> early_exit_protocol: "NO" {
  style: {
    stroke: "#C62828"
    stroke-width: 2
  }
}
check_protocol -> check_src_ip: "YES"

check_src_ip -> early_exit_src_ip: "NO" {
  style: {
    stroke: "#C62828"
    stroke-width: 2
  }
}
check_src_ip -> check_dst_ip: "YES"

check_dst_ip -> early_exit_dst_ip: "NO" {
  style: {
    stroke: "#C62828"
    stroke-width: 2
  }
}
check_dst_ip -> check_src_port: "YES"

check_src_port -> early_exit_src_port: "NO" {
  style: {
    stroke: "#C62828"
    stroke-width: 2
  }
}
check_src_port -> check_dst_port: "YES"

check_dst_port -> early_exit_dst_port: "NO" {
  style: {
    stroke: "#C62828"
    stroke-width: 2
  }
}
check_dst_port -> rule_matched: "YES" {
  style: {
    stroke: "#2E7D32"
    stroke-width: 3
  }
}

early_exit_protocol -> next_rule
early_exit_src_ip -> next_rule
early_exit_dst_ip -> next_rule
early_exit_src_port -> next_rule
early_exit_dst_port -> next_rule

next_rule -> rule_loop_start: "Continue loop"

rule_matched -> increment_counter
increment_counter -> apply_action
apply_action -> return_result

no_match -> return_result: "Default action"

performance_box -> check_protocol: "Track metrics" {
  style: {
    stroke-dash: 3
    stroke: "#7B1FA2"
  }
}