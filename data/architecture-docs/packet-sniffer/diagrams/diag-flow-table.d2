vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Microscopic View: Flow Table Data Structure" {
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    underline: true
  }
}

flow_table: "Flow Table (Hash Table)" {
  shape: rectangle
  style: {
    fill: "#e8f4f8"
    stroke: "#0077be"
    stroke-width: 3
    font-size: 18
    bold: true
  }

  bucket_0: "Bucket 0" {
    shape: rectangle
    style: {
      fill: "#fff9e6"
      stroke: "#ff9800"
      stroke-width: 2
    }
    
    entry_0_0: "Flow Entry" {
      shape: rectangle
      style: {
        fill: "#ffffff"
        stroke: "#666666"
      }
      
      key_0_0: "Key: 192.168.1.100:45678 -> 10.0.0.50:80 TCP" {
        shape: rectangle
        style: {
          fill: "#e3f2fd"
          stroke: "#2196f3"
          font-size: 12
        }
      }
      
      state_0_0: "State: SYN_SENT" {
        shape: rectangle
        style: {
          fill: "#fff3e0"
          stroke: "#ff9800"
          font-size: 12
        }
      }
      
      counters_0_0: "Packets: 1, Bytes: 60" {
        shape: rectangle
        style: {
          fill: "#f3e5f5"
          stroke: "#9c27b0"
          font-size: 12
        }
      }
      
      timestamp_0_0: "Last Seen: 1234567890.123" {
        shape: rectangle
        style: {
          fill: "#e8f5e9"
          stroke: "#4caf50"
          font-size: 12
        }
      }
    }
    
    entry_0_1: "Flow Entry (Collision)" {
      shape: rectangle
      style: {
        fill: "#ffffff"
        stroke: "#666666"
        stroke-dash: 3
      }
      
      key_0_1: "Key: 172.16.0.5:12345 -> 10.0.0.50:443 TCP" {
        shape: rectangle
        style: {
          fill: "#e3f2fd"
          stroke: "#2196f3"
          font-size: 12
        }
      }
      
      state_0_1: "State: ESTABLISHED" {
        shape: rectangle
        style: {
          fill: "#fff3e0"
          stroke: "#ff9800"
          font-size: 12
        }
      }
    }
    
    entry_0_0 -> entry_0_1: "next" {
      style: {
        stroke: "#ff5722"
        stroke-width: 2
        stroke-dash: 3
      }
    }
  }

  bucket_1: "Bucket 1" {
    shape: rectangle
    style: {
      fill: "#fff9e6"
      stroke: "#ff9800"
      stroke-width: 2
    }
    
    entry_1_0: "Flow Entry" {
      shape: rectangle
      style: {
        fill: "#ffffff"
        stroke: "#666666"
      }
      
      key_1_0: "Key: 10.0.0.50:80 -> 192.168.1.100:45678 TCP" {
        shape: rectangle
        style: {
          fill: "#e3f2fd"
          stroke: "#2196f3"
          font-size: 12
        }
      }
      
      state_1_0: "State: SYN_RECEIVED" {
        shape: rectangle
        style: {
          fill: "#fff3e0"
          stroke: "#ff9800"
          font-size: 12
        }
      }
    }
  }

  bucket_n: "Bucket N (Empty)" {
    shape: rectangle
    style: {
      fill: "#f5f5f5"
      stroke: "#9e9e9e"
      stroke-width: 2
      stroke-dash: 5
    }
    
    null_ptr: "NULL" {
      shape: rectangle
      style: {
        fill: "#eeeeee"
        stroke: "#757575"
        font-size: 12
      }
    }
  }
}

hash_function: "Hash Function" {
  shape: rectangle
  style: {
    fill: "#fff3e0"
    stroke: "#ff9800"
    stroke-width: 3
    font-size: 16
    bold: true
  }
  
  input_tuple: "5-Tuple Input" {
    shape: rectangle
    style: {
      fill: "#e3f2fd"
      stroke: "#2196f3"
    }
    
    src_ip_input: "src_ip: 192.168.1.100" {
      shape: rectangle
      style: {
        fill: "#ffffff"
        font-size: 11
      }
    }
    
    dst_ip_input: "dst_ip: 10.0.0.50" {
      shape: rectangle
      style: {
        fill: "#ffffff"
        font-size: 11
      }
    }
    
    src_port_input: "src_port: 45678" {
      shape: rectangle
      style: {
        fill: "#ffffff"
        font-size: 11
      }
    }
    
    dst_port_input: "dst_port: 80" {
      shape: rectangle
      style: {
        fill: "#ffffff"
        font-size: 11
      }
    }
    
    protocol_input: "protocol: TCP" {
      shape: rectangle
      style: {
        fill: "#ffffff"
        font-size: 11
      }
    }
  }
  
  hash_computation: "hash = (src_ip ^ dst_ip ^ src_port ^ dst_port ^ protocol) % TABLE_SIZE" {
    shape: rectangle
    style: {
      fill: "#fff9c4"
      stroke: "#fbc02d"
      font-size: 12
      font: mono
    }
  }
  
  hash_output: "hash = 0" {
    shape: rectangle
    style: {
      fill: "#c8e6c9"
      stroke: "#4caf50"
      font-size: 12
      bold: true
    }
  }
  
  input_tuple -> hash_computation
  hash_computation -> hash_output
}

aging_manager: "Aging Manager" {
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#9c27b0"
    stroke-width: 3
    font-size: 16
    bold: true
  }
  
  timeout_config: "Timeout Configuration" {
    shape: rectangle
    style: {
      fill: "#ffffff"
      stroke: "#9c27b0"
    }
    
    tcp_timeout: "TCP: 300s" {
      shape: rectangle
      style: {
        fill: "#e1bee7"
        font-size: 11
      }
    }
    
    udp_timeout: "UDP: 60s" {
      shape: rectangle
      style: {
        fill: "#e1bee7"
        font-size: 11
      }
    }
    
    icmp_timeout: "ICMP: 30s" {
      shape: rectangle
      style: {
        fill: "#e1bee7"
        font-size: 11
      }
    }
  }
  
  cleanup_logic: "Cleanup Logic" {
    shape: rectangle
    style: {
      fill: "#ffffff"
      stroke: "#9c27b0"
    }
    
    scan_step: "1. Scan all buckets" {
      shape: rectangle
      style: {
        fill: "#f3e5f5"
        font-size: 11
      }
    }
    
    check_step: "2. Check last_seen timestamp" {
      shape: rectangle
      style: {
        fill: "#f3e5f5"
        font-size: 11
      }
    }
    
    remove_step: "3. Remove expired entries" {
      shape: rectangle
      style: {
        fill: "#f3e5f5"
        font-size: 11
      }
    }
    
    scan_step -> check_step
    check_step -> remove_step
  }
}

memory_pool: "Memory Pool" {
  shape: rectangle
  style: {
    fill: "#e8f5e9"
    stroke: "#4caf50"
    stroke-width: 3
    font-size: 16
    bold: true
  }
  
  preallocated: "Pre-allocated Entries" {
    shape: rectangle
    style: {
      fill: "#c8e6c9"
      stroke: "#4caf50"
    }
    
    entry_pool_1: "Entry 1" {
      shape: rectangle
      style: {
        fill: "#ffffff"
        font-size: 11
      }
    }
    
    entry_pool_2: "Entry 2" {
      shape: rectangle
      style: {
        fill: "#ffffff"
        font-size: 11
      }
    }
    
    entry_pool_n: "Entry N" {
      shape: rectangle
      style: {
        fill: "#ffffff"
        font-size: 11
        stroke-dash: 5
      }
    }
  }
  
  free_list: "Free List" {
    shape: rectangle
    style: {
      fill: "#fff9c4"
      stroke: "#fbc02d"
    }
    
    free_ptr: "next_free -> Entry 1" {
      shape: rectangle
      style: {
        fill: "#ffffff"
        font-size: 11
      }
    }
  }
}

hash_function -> flow_table.bucket_0: "hash = 0"
hash_function -> flow_table.bucket_1: "hash = 1"

aging_manager -> flow_table: "periodic cleanup"

memory_pool -> flow_table: "allocate entry"
flow_table -> memory_pool: "free entry"

legend: "Legend" {
  near: bottom-right
  shape: rectangle
  style: {
    fill: "#fafafa"
    stroke: "#9e9e9e"
    stroke-width: 2
  }
  
  legend_hash: "Hash Bucket" {
    shape: rectangle
    style: {
      fill: "#fff9e6"
      stroke: "#ff9800"
      font-size: 11
    }
  }
  
  legend_entry: "Flow Entry" {
    shape: rectangle
    style: {
      fill: "#ffffff"
      stroke: "#666666"
      font-size: 11
    }
  }
  
  legend_collision: "Collision Chain" {
    shape: rectangle
    style: {
      fill: "#ffffff"
      stroke: "#666666"
      stroke-dash: 3
      font-size: 11
    }
  }
}

notes: "Implementation Notes" {
  near: bottom-left
  shape: rectangle
  style: {
    fill: "#fff3e0"
    stroke: "#ff9800"
    stroke-width: 2
    font-size: 12
  }
  
  note_1: "• Hash collisions handled via chaining" {
    shape: text
    style: {
      font-size: 11
    }
  }
  
  note_2: "• Entries aged out based on protocol timeouts" {
    shape: text
    style: {
      font-size: 11
    }
  }
  
  note_3: "• Memory pool reduces malloc overhead" {
    shape: text
    style: {
      font-size: 11
    }
  }
  
  note_4: "• Thread-safe with per-bucket locks" {
    shape: text
    style: {
      font-size: 11
    }
  }
}