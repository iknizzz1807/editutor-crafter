vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Microscopic View: IP Packet Parser" {
  near: top-center
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

# IP Packet Structure (Byte-level)
ip_packet: "IP Packet (Raw Bytes)" {
  shape: rectangle
  style: {
    fill: "#E8F4F8"
    stroke: "#2C5F7C"
    stroke-width: 3
    font-size: 20
    bold: true
  }
}

# Parsing Steps Container
parsing_steps: "Parsing Pipeline" {
  style: {
    fill: "#FFF9E6"
    stroke: "#D4A017"
    stroke-width: 2
  }

  step1: "1. Version Detection" {
    shape: rectangle
    style: {
      fill: "#D4E6F1"
      stroke: "#2874A6"
      font-size: 16
    }
  }

  step2: "2. Header Length Calc" {
    shape: rectangle
    style: {
      fill: "#D5F4E6"
      stroke: "#1E8449"
      font-size: 16
    }
  }

  step3: "3. Checksum Verify" {
    shape: rectangle
    style: {
      fill: "#FCF3CF"
      stroke: "#B7950B"
      font-size: 16
    }
  }

  step4: "4. Fragmentation Check" {
    shape: rectangle
    style: {
      fill: "#FADBD8"
      stroke: "#C0392B"
      font-size: 16
    }
  }

  step5: "5. TTL Extraction" {
    shape: rectangle
    style: {
      fill: "#E8DAEF"
      stroke: "#7D3C98"
      font-size: 16
    }
  }

  step6: "6. Protocol Field" {
    shape: rectangle
    style: {
      fill: "#D6EAF8"
      stroke: "#2E86C1"
      font-size: 16
    }
  }

  step1 -> step2: "version == 4" {
    style: {
      stroke: "#27AE60"
      stroke-width: 2
    }
  }
  step2 -> step3: "ihl * 4 bytes" {
    style: {
      stroke: "#27AE60"
      stroke-width: 2
    }
  }
  step3 -> step4: "checksum OK" {
    style: {
      stroke: "#27AE60"
      stroke-width: 2
    }
  }
  step4 -> step5: "flags parsed" {
    style: {
      stroke: "#27AE60"
      stroke-width: 2
    }
  }
  step5 -> step6: "TTL > 0" {
    style: {
      stroke: "#27AE60"
      stroke-width: 2
    }
  }
}

# IP Header Fields (Bit-level Detail)
ip_header: "IP Header Fields (20 bytes minimum)" {
  style: {
    fill: "#F4ECF7"
    stroke: "#6C3483"
    stroke-width: 2
  }

  byte0_3: "Bytes 0-3" {
    grid-columns: 4
    grid-gap: 0

    version: "Version\n(4 bits)\n0x4" {
      style: {
        fill: "#AED6F1"
        stroke: "#2874A6"
        font-size: 14
      }
    }

    ihl: "IHL\n(4 bits)\n0x5" {
      style: {
        fill: "#A9DFBF"
        stroke: "#1E8449"
        font-size: 14
      }
    }

    tos: "ToS\n(8 bits)\n0x00" {
      style: {
        fill: "#F9E79F"
        stroke: "#B7950B"
        font-size: 14
      }
    }

    total_len: "Total Length\n(16 bits)\n0x0054" {
      style: {
        fill: "#F5B7B1"
        stroke: "#C0392B"
        font-size: 14
      }
    }
  }

  byte4_7: "Bytes 4-7" {
    grid-columns: 3
    grid-gap: 0

    identification: "Identification\n(16 bits)\n0x1234" {
      style: {
        fill: "#D7BDE2"
        stroke: "#7D3C98"
        font-size: 14
      }
    }

    flags: "Flags\n(3 bits)\nDF=1" {
      style: {
        fill: "#AED6F1"
        stroke: "#2E86C1"
        font-size: 14
      }
    }

    frag_offset: "Frag Offset\n(13 bits)\n0x0000" {
      style: {
        fill: "#A9DFBF"
        stroke: "#229954"
        font-size: 14
      }
    }
  }

  byte8_11: "Bytes 8-11" {
    grid-columns: 3
    grid-gap: 0

    ttl: "TTL\n(8 bits)\n0x40 (64)" {
      style: {
        fill: "#F9E79F"
        stroke: "#D68910"
        font-size: 14
      }
    }

    protocol: "Protocol\n(8 bits)\n0x06 (TCP)" {
      style: {
        fill: "#F5B7B1"
        stroke: "#CB4335"
        font-size: 14
      }
    }

    checksum: "Checksum\n(16 bits)\n0xABCD" {
      style: {
        fill: "#D7BDE2"
        stroke: "#8E44AD"
        font-size: 14
      }
    }
  }

  byte12_19: "Bytes 12-19" {
    grid-columns: 2
    grid-gap: 0

    src_ip: "Source IP\n(32 bits)\n192.168.1.100" {
      style: {
        fill: "#AED6F1"
        stroke: "#2874A6"
        font-size: 14
      }
    }

    dst_ip: "Dest IP\n(32 bits)\n10.0.0.50" {
      style: {
        fill: "#A9DFBF"
        stroke: "#1E8449"
        font-size: 14
      }
    }
  }
}

# Parsing Logic Details
parsing_logic: "Parsing Logic (C Code)" {
  style: {
    fill: "#EAECEE"
    stroke: "#566573"
    stroke-width: 2
  }

  version_check: |c
    // Step 1: Version Detection
    uint8_t version = (ip_header[0] >> 4) & 0x0F;
    if (version != 4) {
        return ERROR_INVALID_VERSION;
    }
  | {
    shape: rectangle
    style: {
      fill: "#D4E6F1"
      font-size: 12
      font: mono
    }
  }

  ihl_calc: |c
    // Step 2: Header Length
    uint8_t ihl = ip_header[0] & 0x0F;
    size_t header_len = ihl * 4;
    if (header_len < 20) {
        return ERROR_INVALID_IHL;
    }
  | {
    shape: rectangle
    style: {
      fill: "#D5F4E6"
      font-size: 12
      font: mono
    }
  }

  checksum_verify: |c
    // Step 3: Checksum Verification
    uint16_t received_checksum = 
        ntohs(*(uint16_t*)(ip_header + 10));
    uint16_t calculated = 
        calculate_ip_checksum(ip_header, header_len);
    if (received_checksum != calculated) {
        return ERROR_CHECKSUM_MISMATCH;
    }
  | {
    shape: rectangle
    style: {
      fill: "#FCF3CF"
      font-size: 12
      font: mono
    }
  }

  fragmentation: |c
    // Step 4: Fragmentation Handling
    uint16_t flags_offset = 
        ntohs(*(uint16_t*)(ip_header + 6));
    bool dont_fragment = (flags_offset & 0x4000) != 0;
    bool more_fragments = (flags_offset & 0x2000) != 0;
    uint16_t frag_offset = (flags_offset & 0x1FFF) * 8;
  | {
    shape: rectangle
    style: {
      fill: "#FADBD8"
      font-size: 12
      font: mono
    }
  }

  ttl_extract: |c
    // Step 5: TTL Extraction
    uint8_t ttl = ip_header[8];
    if (ttl == 0) {
        return ERROR_TTL_EXPIRED;
    }
  | {
    shape: rectangle
    style: {
      fill: "#E8DAEF"
      font-size: 12
      font: mono
    }
  }

  protocol_parse: |c
    // Step 6: Protocol Field
    uint8_t protocol = ip_header[9];
    switch (protocol) {
        case IPPROTO_TCP:  // 6
        case IPPROTO_UDP:  // 17
        case IPPROTO_ICMP: // 1
            break;
        default:
            return ERROR_UNSUPPORTED_PROTOCOL;
    }
  | {
    shape: rectangle
    style: {
      fill: "#D6EAF8"
      font-size: 12
      font: mono
    }
  }
}

# Output Structure
parsed_output: "Parsed IP Packet" {
  shape: class
  style: {
    fill: "#D5F5E3"
    stroke: "#1E8449"
    stroke-width: 3
    font-size: 18
    bold: true
  }

  +version: "uint8_t (4)"
  +ihl: "uint8_t (5)"
  +tos: "uint8_t (0x00)"
  +total_length: "uint16_t (84)"
  +identification: "uint16_t (0x1234)"
  +flags: "uint8_t (DF=1)"
  +fragment_offset: "uint16_t (0)"
  +ttl: "uint8_t (64)"
  +protocol: "uint8_t (TCP=6)"
  +checksum: "uint16_t (0xABCD)"
  +src_ip: "uint32_t (192.168.1.100)"
  +dst_ip: "uint32_t (10.0.0.50)"
}

# Error Handling
error_cases: "Error Cases" {
  style: {
    fill: "#FADBD8"
    stroke: "#C0392B"
    stroke-width: 2
  }

  err1: "Invalid Version\n(version != 4)" {
    shape: rectangle
    style: {
      fill: "#F1948A"
      stroke: "#922B21"
      font-size: 14
    }
  }

  err2: "Invalid IHL\n(ihl < 5)" {
    shape: rectangle
    style: {
      fill: "#F1948A"
      stroke: "#922B21"
      font-size: 14
    }
  }

  err3: "Checksum Mismatch" {
    shape: rectangle
    style: {
      fill: "#F1948A"
      stroke: "#922B21"
      font-size: 14
    }
  }

  err4: "TTL Expired\n(ttl == 0)" {
    shape: rectangle
    style: {
      fill: "#F1948A"
      stroke: "#922B21"
      font-size: 14
    }
  }

  err5: "Unsupported Protocol" {
    shape: rectangle
    style: {
      fill: "#F1948A"
      stroke: "#922B21"
      font-size: 14
    }
  }
}

# Connections
ip_packet -> parsing_steps: "parse_ip_packet()" {
  style: {
    stroke: "#2C5F7C"
    stroke-width: 3
    animated: true
  }
}

parsing_steps -> ip_header: "read fields" {
  style: {
    stroke: "#6C3483"
    stroke-width: 2
  }
}

ip_header -> parsing_logic: "apply logic" {
  style: {
    stroke: "#566573"
    stroke-width: 2
  }
}

parsing_logic -> parsed_output: "success" {
  style: {
    stroke: "#1E8449"
    stroke-width: 3
    animated: true
  }
}

parsing_logic -> error_cases: "validation fails" {
  style: {
    stroke: "#C0392B"
    stroke-width: 2
    stroke-dash: 3
  }
}

# Legend
legend: "Legend" {
  near: bottom-right
  style: {
    fill: "#F8F9F9"
    stroke: "#ABB2B9"
    font-size: 12
  }

  success_path: "Success Path" {
    style: {
      fill: "#D5F5E3"
      stroke: "#27AE60"
    }
  }

  error_path: "Error Path" {
    style: {
      fill: "#FADBD8"
      stroke: "#C0392B"
    }
  }

  data_flow: "Data Flow" {
    style: {
      fill: "#E8F4F8"
      stroke: "#2C5F7C"
    }
  }
}

# Performance Note
perf_note: |md
  **Performance**: ~50 CPU cycles per packet
  **Memory**: Zero-copy parsing (direct buffer access)
  **Validation**: All RFC 791 checks enforced
| {
  near: bottom-left
  shape: rectangle
  style: {
    fill: "#FEF9E7"
    stroke: "#D4AC0D"
    font-size: 12
  }
}