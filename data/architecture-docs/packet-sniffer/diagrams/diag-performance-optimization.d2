vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Performance Optimization Strategies" {
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

optimization_layers: "Optimization Layers" {
  style: {
    fill: "#e8f4f8"
    stroke: "#0077b6"
    stroke-width: 3
  }

  zero_copy: "Zero-Copy Packet Handling" {
    shape: rectangle
    style: {
      fill: "#caf0f8"
      stroke: "#0096c7"
      bold: true
    }
    
    ring_buffer: "Ring Buffer (mmap)" {
      shape: cylinder
      style.fill: "#ade8f4"
    }
    
    direct_access: "Direct Memory Access" {
      shape: rectangle
      style.fill: "#90e0ef"
    }
    
    ring_buffer -> direct_access: "No memcpy"
  }

  simd_ops: "SIMD Operations" {
    shape: rectangle
    style: {
      fill: "#d0f4de"
      stroke: "#52b788"
      bold: true
    }
    
    checksum_calc: "Checksum Calculation" {
      shape: rectangle
      style.fill: "#a7c957"
    }
    
    parallel_proc: "Parallel Processing (AVX2)" {
      shape: rectangle
      style.fill: "#95d5b2"
    }
    
    checksum_calc -> parallel_proc: "4x speedup"
  }

  cache_friendly: "Cache-Friendly Structures" {
    shape: rectangle
    style: {
      fill: "#ffd6a5"
      stroke: "#fb8500"
      bold: true
    }
    
    data_locality: "Data Locality" {
      shape: rectangle
      style.fill: "#ffb703"
    }
    
    prefetch: "Prefetch Hints" {
      shape: rectangle
      style.fill: "#fd9e02"
    }
    
    data_locality -> prefetch: "Reduce cache misses"
  }

  lock_free: "Lock-Free Algorithms" {
    shape: rectangle
    style: {
      fill: "#ffc8dd"
      stroke: "#d62828"
      bold: true
    }
    
    atomic_ops: "Atomic Operations" {
      shape: rectangle
      style.fill: "#ffafcc"
    }
    
    cas_loop: "CAS Loop" {
      shape: rectangle
      style.fill: "#ff99c8"
    }
    
    atomic_ops -> cas_loop: "No mutex overhead"
  }
}

packet_flow: "Packet Processing Flow" {
  style: {
    fill: "#f8f9fa"
    stroke: "#495057"
    stroke-width: 2
  }

  raw_packet: "Raw Packet (NIC)" {
    shape: cylinder
    style: {
      fill: "#e9ecef"
      stroke: "#6c757d"
    }
  }

  zero_copy_path: "Zero-Copy Path" {
    shape: rectangle
    style: {
      fill: "#caf0f8"
      stroke: "#0096c7"
    }
  }

  simd_checksum: "SIMD Checksum" {
    shape: rectangle
    style: {
      fill: "#a7c957"
      stroke: "#52b788"
    }
  }

  cache_opt_parse: "Cache-Optimized Parse" {
    shape: rectangle
    style: {
      fill: "#ffb703"
      stroke: "#fb8500"
    }
  }

  lock_free_queue: "Lock-Free Queue" {
    shape: queue
    style: {
      fill: "#ffafcc"
      stroke: "#d62828"
    }
  }

  analysis_thread: "Analysis Thread" {
    shape: rectangle
    style: {
      fill: "#b5e48c"
      stroke: "#52b788"
    }
  }

  raw_packet -> zero_copy_path: "mmap"
  zero_copy_path -> simd_checksum: "validate"
  simd_checksum -> cache_opt_parse: "parse"
  cache_opt_parse -> lock_free_queue: "enqueue"
  lock_free_queue -> analysis_thread: "dequeue"
}

optimization_layers.zero_copy -> packet_flow.zero_copy_path: "applies to" {
  style: {
    stroke-dash: 3
    stroke: "#0077b6"
  }
}

optimization_layers.simd_ops -> packet_flow.simd_checksum: "applies to" {
  style: {
    stroke-dash: 3
    stroke: "#52b788"
  }
}

optimization_layers.cache_friendly -> packet_flow.cache_opt_parse: "applies to" {
  style: {
    stroke-dash: 3
    stroke: "#fb8500"
  }
}

optimization_layers.lock_free -> packet_flow.lock_free_queue: "applies to" {
  style: {
    stroke-dash: 3
    stroke: "#d62828"
  }
}

performance_metrics: "Performance Metrics" {
  near: bottom-center
  shape: rectangle
  style: {
    fill: "#f1faee"
    stroke: "#1d3557"
    stroke-width: 2
    bold: true
  }

  throughput: "Throughput: 100K+ pps" {
    shape: text
    style: {
      font-size: 18
      font-color: "#2a9d8f"
    }
  }

  latency: "Latency (p99): <100 Î¼s" {
    shape: text
    style: {
      font-size: 18
      font-color: "#e76f51"
    }
  }

  cpu_usage: "CPU Usage: <50%" {
    shape: text
    style: {
      font-size: 18
      font-color: "#f4a261"
    }
  }
}

code_example: "Code Example: SIMD Checksum" {
  near: bottom-left
  shape: rectangle
  style: {
    fill: "#f8f9fa"
    stroke: "#495057"
    font: mono
  }

  code_block: |'md
    c
    uint16_t checksum_simd(uint16_t* data, size_t len) {
        __m256i sum = _mm256_setzero_si256();
        for (size_t i = 0; i < len/16; i++) {
            __m256i chunk = _mm256_loadu_si256((__m256i*)&data[i*16]);
            sum = _mm256_add_epi16(sum, chunk);
        }
        // Horizontal sum and fold
        return fold_checksum(sum);
    }
    
  '|
}

legend: "Legend" {
  near: bottom-right
  shape: rectangle
  style: {
    fill: "#ffffff"
    stroke: "#adb5bd"
  }

  zero_copy_color: "Zero-Copy" {
    shape: rectangle
    style: {
      fill: "#caf0f8"
      stroke: "#0096c7"
    }
  }

  simd_color: "SIMD" {
    shape: rectangle
    style: {
      fill: "#a7c957"
      stroke: "#52b788"
    }
  }

  cache_color: "Cache-Friendly" {
    shape: rectangle
    style: {
      fill: "#ffb703"
      stroke: "#fb8500"
    }
  }

  lock_free_color: "Lock-Free" {
    shape: rectangle
    style: {
      fill: "#ffafcc"
      stroke: "#d62828"
    }
  }
}