vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Street View: Protocol Parsing Stack" {
  near: top-center
  style: {
    font-size: 32
    bold: true
    underline: true
  }
}

direction: down

raw_packet: "Raw Packet Buffer" {
  shape: cylinder
  style: {
    fill: "#E8F4F8"
    stroke: "#2C5F7C"
    stroke-width: 2
  }
}

ethernet_parser: "Ethernet Parser" {
  shape: rectangle
  style: {
    fill: "#D4E6F1"
    stroke: "#1F618D"
    stroke-width: 2
    font-size: 18
    bold: true
  }
  tooltip: "Extracts MAC addresses, EtherType"
}

ethertype_decision: "EtherType?" {
  shape: diamond
  style: {
    fill: "#FCF3CF"
    stroke: "#D68910"
    stroke-width: 2
  }
}

ipv4_parser: "IPv4 Parser" {
  shape: rectangle
  style: {
    fill: "#D5F4E6"
    stroke: "#1E8449"
    stroke-width: 2
    font-size: 18
    bold: true
  }
  tooltip: "Parses IPv4 header, validates checksum"
}

ipv6_parser: "IPv6 Parser" {
  shape: rectangle
  style: {
    fill: "#D5F4E6"
    stroke: "#1E8449"
    stroke-width: 2
    font-size: 18
    bold: true
  }
  tooltip: "Parses IPv6 header, extension headers"
}

arp_parser: "ARP Parser" {
  shape: rectangle
  style: {
    fill: "#FADBD8"
    stroke: "#943126"
    stroke-width: 2
    font-size: 18
    bold: true
  }
  tooltip: "Parses ARP requests/replies"
}

protocol_decision: "IP Protocol?" {
  shape: diamond
  style: {
    fill: "#FCF3CF"
    stroke: "#D68910"
    stroke-width: 2
  }
}

tcp_parser: "TCP Parser" {
  shape: rectangle
  style: {
    fill: "#E8DAEF"
    stroke: "#7D3C98"
    stroke-width: 2
    font-size: 18
    bold: true
  }
  tooltip: "Parses TCP header, flags, options"
}

udp_parser: "UDP Parser" {
  shape: rectangle
  style: {
    fill: "#E8DAEF"
    stroke: "#7D3C98"
    stroke-width: 2
    font-size: 18
    bold: true
  }
  tooltip: "Parses UDP header, validates length"
}

icmp_parser: "ICMP Parser" {
  shape: rectangle
  style: {
    fill: "#E8DAEF"
    stroke: "#7D3C98"
    stroke-width: 2
    font-size: 18
    bold: true
  }
  tooltip: "Parses ICMP type, code, payload"
}

other_proto: "Other Protocols" {
  shape: rectangle
  style: {
    fill: "#EAEDED"
    stroke: "#5D6D7E"
    stroke-width: 2
    stroke-dash: 3
  }
}

application_layer: "Application Layer\nParsing" {
  shape: rectangle
  style: {
    fill: "#FEF5E7"
    stroke: "#B9770E"
    stroke-width: 2
    font-size: 18
    bold: true
  }
  tooltip: "HTTP, DNS, TLS inspection (optional)"
}

parsed_packet: "ParsedPacket Structure" {
  shape: rectangle
  style: {
    fill: "#D6EAF8"
    stroke: "#21618C"
    stroke-width: 3
    font-size: 18
    bold: true
  }
  tooltip: "Final structured packet representation"
}

error_handler: "Error Handler" {
  shape: rectangle
  style: {
    fill: "#F5B7B1"
    stroke: "#C0392B"
    stroke-width: 2
    stroke-dash: 3
  }
  tooltip: "Handles malformed packets, truncation"
}

raw_packet -> ethernet_parser: "Read bytes"

ethernet_parser -> ethertype_decision: "Check EtherType"

ethertype_decision -> ipv4_parser: "0x0800 (IPv4)" {
  style: {
    stroke: "#1E8449"
    stroke-width: 2
  }
}

ethertype_decision -> ipv6_parser: "0x86DD (IPv6)" {
  style: {
    stroke: "#1E8449"
    stroke-width: 2
  }
}

ethertype_decision -> arp_parser: "0x0806 (ARP)" {
  style: {
    stroke: "#943126"
    stroke-width: 2
  }
}

ipv4_parser -> protocol_decision: "Check Protocol field"
ipv6_parser -> protocol_decision: "Check Next Header"

protocol_decision -> tcp_parser: "6 (TCP)" {
  style: {
    stroke: "#7D3C98"
    stroke-width: 2
  }
}

protocol_decision -> udp_parser: "17 (UDP)" {
  style: {
    stroke: "#7D3C98"
    stroke-width: 2
  }
}

protocol_decision -> icmp_parser: "1 (ICMP)" {
  style: {
    stroke: "#7D3C98"
    stroke-width: 2
  }
}

protocol_decision -> other_proto: "Other" {
  style: {
    stroke: "#5D6D7E"
    stroke-dash: 3
  }
}

tcp_parser -> application_layer: "Port-based\ninspection" {
  style: {
    stroke-dash: 3
  }
}

udp_parser -> application_layer: "Port-based\ninspection" {
  style: {
    stroke-dash: 3
  }
}

tcp_parser -> parsed_packet
udp_parser -> parsed_packet
icmp_parser -> parsed_packet
arp_parser -> parsed_packet
other_proto -> parsed_packet
application_layer -> parsed_packet

ethernet_parser -> error_handler: "Invalid frame" {
  style: {
    stroke: "#C0392B"
    stroke-dash: 5
  }
}

ipv4_parser -> error_handler: "Checksum fail" {
  style: {
    stroke: "#C0392B"
    stroke-dash: 5
  }
}

tcp_parser -> error_handler: "Malformed header" {
  style: {
    stroke: "#C0392B"
    stroke-dash: 5
  }
}

legend: {
  near: bottom-right
  style: {
    fill: "#FDFEFE"
    stroke: "#ABB2B9"
    stroke-width: 1
  }
  
  l1: "━━ Normal flow" {
    shape: text
    style: {
      font-size: 14
    }
  }
  
  l2: "╌╌ Optional/Error" {
    shape: text
    style: {
      font-size: 14
    }
  }
  
  l3: "◆ Decision point" {
    shape: text
    style: {
      font-size: 14
    }
  }
}

note: "Click any parser to see\nmicroscope view details" {
  near: bottom-left
  shape: text
  style: {
    font-size: 14
    italic: true
    font-color: "#5D6D7E"
  }
}