vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

title: "Street View: Packet Storage and Indexing" {
  shape: text
  style: {
    font-size: 32
    bold: true
    underline: true
  }
  near: top-center
}

raw_packet: "Raw Packet\n(from Capture)" {
  shape: cylinder
  style: {
    fill: "#e3f2fd"
    stroke: "#1976d2"
    font-size: 18
  }
}

serialization: "Packet Serialization" {
  shape: rectangle
  style: {
    fill: "#fff3e0"
    stroke: "#f57c00"
    font-size: 16
  }
  
  header_extract: "Extract Headers" {
    shape: step
    style: {
      fill: "#ffe0b2"
      stroke: "#e65100"
    }
  }
  
  payload_copy: "Copy Payload" {
    shape: step
    style: {
      fill: "#ffe0b2"
      stroke: "#e65100"
    }
  }
  
  metadata_add: "Add Metadata\n(timestamp, length)" {
    shape: step
    style: {
      fill: "#ffe0b2"
      stroke: "#e65100"
    }
  }
  
  header_extract -> payload_copy
  payload_copy -> metadata_add
}

compression: "Compression Pipeline" {
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#7b1fa2"
    font-size: 16
  }
  
  buffer_stage: "Buffer Stage\n(4KB chunks)" {
    shape: rectangle
    style: {
      fill: "#e1bee7"
      stroke: "#6a1b9a"
    }
  }
  
  compress_stage: "LZ4 Compress" {
    shape: rectangle
    style: {
      fill: "#e1bee7"
      stroke: "#6a1b9a"
    }
  }
  
  write_stage: "Write to Disk" {
    shape: rectangle
    style: {
      fill: "#e1bee7"
      stroke: "#6a1b9a"
    }
  }
  
  buffer_stage -> compress_stage: "Full buffer"
  compress_stage -> write_stage: "Compressed block"
}

index_gen: "Index Generation" {
  shape: rectangle
  style: {
    fill: "#e8f5e9"
    stroke: "#388e3c"
    font-size: 16
  }
  
  timestamp_idx: "Timestamp Index\n(B-tree)" {
    shape: rectangle
    style: {
      fill: "#c8e6c9"
      stroke: "#2e7d32"
    }
  }
  
  ip_idx: "IP Address Index\n(Hash table)" {
    shape: rectangle
    style: {
      fill: "#c8e6c9"
      stroke: "#2e7d32"
    }
  }
  
  protocol_idx: "Protocol Index\n(Bitmap)" {
    shape: rectangle
    style: {
      fill: "#c8e6c9"
      stroke: "#2e7d32"
    }
  }
  
  port_idx: "Port Index\n(Range tree)" {
    shape: rectangle
    style: {
      fill: "#c8e6c9"
      stroke: "#2e7d32"
    }
  }
}

storage: "Storage Layer" {
  shape: rectangle
  style: {
    fill: "#fce4ec"
    stroke: "#c2185b"
    font-size: 16
  }
  
  packet_file: "Packet Data File\n(.pkt)" {
    shape: cylinder
    style: {
      fill: "#f8bbd0"
      stroke: "#ad1457"
    }
  }
  
  index_file: "Index File\n(.idx)" {
    shape: cylinder
    style: {
      fill: "#f8bbd0"
      stroke: "#ad1457"
    }
  }
  
  metadata_file: "Metadata File\n(.meta)" {
    shape: cylinder
    style: {
      fill: "#f8bbd0"
      stroke: "#ad1457"
    }
  }
}

pcap_export: "PCAP Export" {
  shape: rectangle
  style: {
    fill: "#e0f2f1"
    stroke: "#00796b"
    font-size: 16
  }
  
  pcap_header: "Write PCAP Header" {
    shape: step
    style: {
      fill: "#b2dfdb"
      stroke: "#00695c"
    }
  }
  
  packet_convert: "Convert Packets\nto PCAP Format" {
    shape: step
    style: {
      fill: "#b2dfdb"
      stroke: "#00695c"
    }
  }
  
  pcap_write: "Write PCAP File" {
    shape: step
    style: {
      fill: "#b2dfdb"
      stroke: "#00695c"
    }
  }
  
  pcap_header -> packet_convert
  packet_convert -> pcap_write
}

pcap_file: "Output PCAP File\n(Wireshark compatible)" {
  shape: document
  style: {
    fill: "#fff9c4"
    stroke: "#f57f17"
    font-size: 16
  }
}

raw_packet -> serialization: "1. Serialize"
serialization -> compression: "2. Compress"
serialization -> index_gen: "3. Index"
compression -> storage.packet_file: "4. Store compressed"
index_gen.timestamp_idx -> storage.index_file
index_gen.ip_idx -> storage.index_file
index_gen.protocol_idx -> storage.index_file
index_gen.port_idx -> storage.index_file
index_gen -> storage.metadata_file: "Store metadata"

storage.packet_file -> pcap_export: "Read packets"
storage.index_file -> pcap_export: "Query index"
pcap_export -> pcap_file: "Export"

note_compression: |md
  **Compression Ratio**: 3:1 typical
  **Buffer Size**: 4KB chunks
  **Algorithm**: LZ4 (fast)
| {
  shape: text
  style: {
    font-size: 14
    italic: true
    fill: "#fffde7"
    stroke: "#f9a825"
  }
  near: top-left
}

note_index: |md
  **Index Types**:
  - Timestamp: O(log n) search
  - IP: O(1) lookup
  - Protocol: O(1) bitmap
  - Port: O(log n) range query
| {
  shape: text
  style: {
    font-size: 14
    italic: true
    fill: "#e8eaf6"
    stroke: "#3f51b5"
  }
  near: bottom-left
}

note_pcap: |md
  **PCAP Format**:
  - Global header (24 bytes)
  - Per-packet header (16 bytes)
  - Packet data (variable)
  - Compatible with tcpdump/Wireshark
| {
  shape: text
  style: {
    font-size: 14
    italic: true
    fill: "#fce4ec"
    stroke: "#e91e63"
  }
  near: bottom-right
}