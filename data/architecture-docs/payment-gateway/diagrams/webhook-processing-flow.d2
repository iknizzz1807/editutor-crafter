title: Webhook Processing Pipeline {
  style.font-size: 24
  style.bold: true
  style.font-color: "#e6edf3"
  near: top-center
}

classes: {
  webhook_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  process_style: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  error_style: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
  }
  success_style: {
    style.fill: "#00b894"
    style.stroke: "#55a3ff"
    style.font-color: "#ffffff"
  }
}

webhook_received: Webhook Received {
  class: webhook_style
}

extract_headers: Extract Headers & Payload {
  class: process_style
}

verify_signature: Verify Signature {
  shape: diamond
  class: decision_style
}

signature_invalid: Invalid Signature\nReject Request {
  class: error_style
}

check_duplicate: Check Event ID\nfor Duplicates {
  shape: diamond
  class: decision_style
}

duplicate_found: Duplicate Event\nReturn 200 OK {
  class: success_style
}

store_event_id: Store Event ID\nin Dedup Cache {
  class: process_style
}

parse_event: Parse Event Type\n& Extract Data {
  class: process_style
}

route_processor: Route to Event\nProcessor {
  shape: diamond
  class: decision_style
}

payment_processor: Payment Status\nProcessor {
  class: process_style
}

refund_processor: Refund Event\nProcessor {
  class: process_style
}

dispute_processor: Dispute Event\nProcessor {
  class: process_style
}

unknown_processor: Unknown Event\nLog & Ignore {
  class: error_style
}

state_reconcile: State Reconciliation {
  class: process_style
}

update_database: Update Payment\nDatabase {
  class: process_style
}

send_notification: Send Internal\nNotifications {
  class: process_style
}

webhook_complete: Return 200 OK\nWebhook Processed {
  class: success_style
}

webhook_received -> extract_headers
extract_headers -> verify_signature

verify_signature -> signature_invalid: Invalid
verify_signature -> check_duplicate: Valid

signature_invalid

check_duplicate -> duplicate_found: Found
check_duplicate -> store_event_id: Not Found

duplicate_found

store_event_id -> parse_event
parse_event -> route_processor

route_processor -> payment_processor: payment.*
route_processor -> refund_processor: refund.*
route_processor -> dispute_processor: dispute.*
route_processor -> unknown_processor: unknown

payment_processor -> state_reconcile
refund_processor -> state_reconcile
dispute_processor -> state_reconcile
unknown_processor -> webhook_complete

state_reconcile -> update_database
update_database -> send_notification
send_notification -> webhook_complete