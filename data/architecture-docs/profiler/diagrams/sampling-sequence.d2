shape: sequence_diagram

profiler: Profiler
target: Target Process
kernel: Kernel
signal_handler: Signal Handler
unwinder: Stack Unwinder
storage: Sample Storage

profiler -> kernel: "setup_timer(SIGPROF, interval)"
kernel -> profiler: timer_created

profiler -> target: "attach_profiler()"
target -> profiler: profiler_attached

kernel -> target: "timer_signal(SIGPROF)"
target -> signal_handler: "handle_signal()"

signal_handler -> signal_handler: "save_registers()"
signal_handler -> unwinder: "unwind_stack(registers)"
unwinder -> unwinder: "walk_stack_frames()"
unwinder -> unwinder: "resolve_addresses()"
unwinder -> signal_handler: "call_stack[]"

signal_handler -> storage: "store_sample(call_stack, timestamp)"
storage -> storage: "aggregate_samples()"
signal_handler -> target: "resume_execution()"

kernel -> target: "timer_signal(SIGPROF)"
target -> signal_handler: "handle_signal()"
signal_handler -> unwinder: "unwind_stack(registers)"
unwinder -> signal_handler: "call_stack[]"
signal_handler -> storage: "store_sample(call_stack, timestamp)"
signal_handler -> target: "resume_execution()"

profiler -> storage: "get_samples()"
storage -> profiler: "sample_data[]"
profiler -> profiler: "generate_flame_graph()"

classes: {
  profiler_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  target_style: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  system_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

profiler.class: profiler_style
target.class: target_style
kernel.class: system_style
signal_handler.class: target_style
unwinder.class: target_style
storage.class: profiler_style