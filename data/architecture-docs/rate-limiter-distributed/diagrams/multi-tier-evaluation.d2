title: Multi-Tier Rate Limit Evaluation {
  near: top-center
  shape: text
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  terminal: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  flow: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

start: Start {
  shape: circle
  style.fill: "#3fb950"
  style.font-color: "#000000"
  label: ""
}

init_request: Initialize Request Context {
  class: process
}

sort_tiers: Sort Rate Limit Tiers\nby Precedence {
  class: process
}

get_next: Get Next Tier {
  class: process
}

has_tier: More Tiers? {
  shape: diamond
  class: decision
}

eval_tier: Evaluate Current Tier {
  class: process
}

tier_allows: Tier Allows\nRequest? {
  shape: diamond
  class: decision
}

tier_blocks: Tier Blocks\nRequest? {
  shape: diamond
  class: decision
}

allow_request: ALLOW\nRequest {
  class: terminal
}

deny_request: DENY\nRequest {
  class: terminal
}

default_allow: Default Action:\nALLOW {
  class: terminal
}

start -> init_request {
  class: flow
}

init_request -> sort_tiers {
  class: flow
}

sort_tiers -> get_next {
  class: flow
}

get_next -> has_tier {
  class: flow
}

has_tier -> eval_tier: Yes {
  class: flow
}

has_tier -> default_allow: No {
  class: flow
}

eval_tier -> tier_allows {
  class: flow
}

tier_allows -> allow_request: Yes\n(Short Circuit) {
  class: flow
}

tier_allows -> tier_blocks: No/Undecided {
  class: flow
}

tier_blocks -> deny_request: Yes\n(Short Circuit) {
  class: flow
}

tier_blocks -> get_next: No/Undecided\n(Continue) {
  class: flow
}

note: |md
  **Precedence Rules:**
  1. Global limits (highest)
  2. User-specific limits
  3. IP-based limits
  4. Endpoint limits (lowest)

  **Short-Circuit Logic:**
  - ALLOW: Stop evaluation, permit request
  - DENY: Stop evaluation, reject request
  - CONTINUE: Check next tier
| {
  shape: page
  near: bottom-right
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}