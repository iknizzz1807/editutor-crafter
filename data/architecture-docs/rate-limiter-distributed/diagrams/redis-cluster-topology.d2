title: Redis Cluster and Consistent Hashing

classes: {
  redis_node: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  hash_ring: {
    style.fill: "#1a1a2e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  virtual_node: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.shape: circle
  }
  key_flow: {
    style.stroke: "#e17055"
    style.bold: true
  }
}

hash_ring: Consistent Hash Ring {
  class: hash_ring
  
  vn1: "VN1\n(Redis-1)" {
    class: virtual_node
  }
  
  vn2: "VN2\n(Redis-2)" {
    class: virtual_node
  }
  
  vn3: "VN3\n(Redis-3)" {
    class: virtual_node
  }
  
  vn4: "VN4\n(Redis-1)" {
    class: virtual_node
  }
  
  vn5: "VN5\n(Redis-2)" {
    class: virtual_node
  }
  
  vn6: "VN6\n(Redis-3)" {
    class: virtual_node
  }
  
  ring_note: |md
    **Hash Ring (0 to 2^32-1)**
    
    Each Redis node has multiple
    virtual nodes distributed
    around the ring for better
    load balancing
  | {
    shape: page
    style.fill: "#1a1a2e"
    style.font-color: "#e6edf3"
    near: center-right
  }
}

redis_cluster: Redis Cluster {
  style.fill: "#1a1a2e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  redis1: Redis Node 1\n:6379 {
    shape: cylinder
    class: redis_node
  }
  
  redis2: Redis Node 2\n:6380 {
    shape: cylinder
    class: redis_node
  }
  
  redis3: Redis Node 3\n:6381 {
    shape: cylinder
    class: redis_node
  }
}

rate_limiter: Rate Limiter Service {
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  
  hash_func: Hash Function\nSHA1(key) % 2^32 {
    shape: hexagon
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

key_distribution: Key Distribution Examples {
  style.fill: "#1a1a2e"
  style.stroke: "#8b949e"
  style.font-color: "#e6edf3"
  
  key1: "user:123\n→ hash: 500M\n→ Redis-2" {
    shape: page
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  key2: "api:/posts\n→ hash: 1.5B\n→ Redis-3" {
    shape: page
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
  
  key3: "ip:192.168.1.1\n→ hash: 3.8B\n→ Redis-1" {
    shape: page
    style.fill: "#16213e"
    style.font-color: "#e6edf3"
  }
}

rate_limiter.hash_func -> hash_ring: determine position {
  class: key_flow
}

hash_ring.vn1 -> redis_cluster.redis1: maps to {
  style.stroke: "#3fb950"
  style.stroke-dash: 3
}

hash_ring.vn4 -> redis_cluster.redis1 {
  style.stroke: "#3fb950"
  style.stroke-dash: 3
}

hash_ring.vn2 -> redis_cluster.redis2 {
  style.stroke: "#3fb950"
  style.stroke-dash: 3
}

hash_ring.vn5 -> redis_cluster.redis2 {
  style.stroke: "#3fb950"
  style.stroke-dash: 3
}

hash_ring.vn3 -> redis_cluster.redis3 {
  style.stroke: "#3fb950"
  style.stroke-dash: 3
}

hash_ring.vn6 -> redis_cluster.redis3 {
  style.stroke: "#3fb950"
  style.stroke-dash: 3
}

key_distribution.key1 -> redis_cluster.redis2: routed to {
  class: key_flow
}

key_distribution.key2 -> redis_cluster.redis3: routed to {
  class: key_flow
}

key_distribution.key3 -> redis_cluster.redis1: routed to {
  class: key_flow
}

rate_limiter -> key_distribution: processes keys

scaling_note: |md
  **Benefits of Consistent Hashing:**
  
  • **Minimal Redistribution**: Adding/removing nodes
    only affects adjacent segments
  • **Load Balancing**: Virtual nodes ensure even
    distribution across physical nodes
  • **Fault Tolerance**: Failed nodes only impact
    their hash range segments
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: bottom-center
}