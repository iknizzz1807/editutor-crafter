classes: {
  container_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  class_style: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  storage_style: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

title: Data Model and Type Relationships {
  near: top-center
  style.font-size: 20
  style.bold: true
  style.font-color: "#3fb950"
}

core_types: Core Types {
  class: container_style
  
  token_bucket_config: TokenBucketConfig {
    shape: class
    class: class_style
    - "capacity: int"
    - "refill_rate: float"
    - "initial_tokens: int"
    - "window_size_ms: int"
    + "validate(): bool"
    + "create_bucket(): TokenBucket"
  }
  
  token_bucket: TokenBucket {
    shape: class
    class: class_style
    - "tokens: float"
    - "last_refill: timestamp"
    - "config: TokenBucketConfig"
    + "try_consume(count: int): bool"
    + "refill(): void"
    + "tokens_available(): int"
    + "time_until_available(count: int): Duration"
  }
  
  client_tracker: ClientTracker {
    shape: class
    class: class_style
    - "client_id: string"
    - "bucket: TokenBucket"
    - "last_access: timestamp"
    - "request_count: int"
    + "check_limit(tokens_needed: int): RateLimitResult"
    + "update_access(): void"
    + "is_expired(): bool"
  }
}

storage_layer: Storage Layer {
  class: container_style
  
  redis_bucket_state: RedisBucketState {
    shape: class
    class: storage_style
    - "key: string"
    - "tokens: float"
    - "last_refill: int64"
    - "ttl: int"
    + "serialize(): string"
    + "deserialize(data: string): RedisBucketState"
  }
  
  redis_client_data: RedisClientData {
    shape: class
    class: storage_style
    - "hash_key: string"
    - "bucket_states: \"Map<string, RedisBucketState>\""
    - "metadata: \"Map<string, string>\""
    + "get_bucket(limit_type: string): RedisBucketState"
    + "set_bucket(limit_type: string, state: RedisBucketState): void"
    + "cleanup_expired(): int"
  }
}

result_types: Result Types {
  class: container_style
  
  rate_limit_result: RateLimitResult {
    shape: class
    class: class_style
    - "allowed: bool"
    - "tokens_remaining: int"
    - "retry_after_ms: int"
    - "limit_type: string"
    + "to_headers(): \"Map<string, string>\""
    + "is_rate_limited(): bool"
  }
}

# Relationships
token_bucket_config -> token_bucket: creates
client_tracker -> token_bucket: contains
client_tracker -> rate_limit_result: produces
token_bucket -> redis_bucket_state: persisted as {
  style.stroke-dash: 3
  style.stroke: "#8b949e"
}
redis_client_data -> redis_bucket_state: stores multiple {
  style.stroke: "#8b949e"
}

# Configuration relationship
token_bucket -> token_bucket_config: configured by {
  style.stroke: "#3fb950"
}