title: HTTP Request Processing Flow {
  near: top-center
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  success: {
    style.fill: "#0d1421"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  error: {
    style.fill: "#2d1b1b"
    style.stroke: "#f85149"
    style.font-color: "#ffa198"
  }
  middleware: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

start: Start {
  shape: circle
  class: success
  style.fill: "#3fb950"
  style.font-color: "#000000"
}

incoming: HTTP Request Received {
  class: process
}

identify: Identify Client {
  class: middleware
}

check_bucket: Token Bucket Available? {
  shape: diamond
  class: decision
}

consume_token: Consume Token {
  class: process
}

add_headers: Add Rate Limit Headers {
  class: process
}

process_request: Process Request {
  class: success
}

return_response: Return Response {
  class: success
}

rate_limited: Generate 429 Response {
  class: error
}

retry_header: Add Retry-After Header {
  class: error
}

reject_request: Reject Request {
  class: error
}

start -> incoming
incoming -> identify
identify -> check_bucket
check_bucket -> consume_token: Yes\n(Tokens Available)
check_bucket -> rate_limited: No\n(Rate Limited)
consume_token -> add_headers
add_headers -> process_request
process_request -> return_response
rate_limited -> retry_header
retry_header -> reject_request

middleware_box: Rate Limiting Middleware {
  identify
  check_bucket
  consume_token
  add_headers
  rate_limited
  retry_header
  class: middleware
  style.stroke-dash: 3
}