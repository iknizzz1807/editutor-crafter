classes: {
  container: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  component: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  storage: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  flow: {
    style.stroke: "#8b949e"
    style.font-color: "#8b949e"
  }
}

rate_limiter: Rate Limiter System {
  class: container
  
  middleware: HTTP Middleware {
    class: component
    shape: rectangle
  }
  
  tracker: Client Tracker {
    class: component
    shape: rectangle
  }
  
  bucket: Token Bucket {
    class: component
    shape: rectangle
  }
  
  redis: Redis Storage {
    class: storage
    shape: cylinder
  }
}

client: Client {
  class: component
  shape: rectangle
}

# Request flow
client -> rate_limiter.middleware: HTTP Request {
  class: flow
}

rate_limiter.middleware -> rate_limiter.tracker: Extract Client ID {
  class: flow
}

rate_limiter.tracker -> rate_limiter.bucket: Check Token Availability {
  class: flow
}

rate_limiter.bucket -> rate_limiter.redis: Read/Write Bucket State {
  class: flow
}

rate_limiter.redis -> rate_limiter.bucket: Bucket Data {
  class: flow
}

rate_limiter.bucket -> rate_limiter.tracker: Token Status {
  class: flow
}

rate_limiter.tracker -> rate_limiter.middleware: Allow/Deny Decision {
  class: flow
}

rate_limiter.middleware -> client: HTTP Response {
  class: flow
}

# Background token refill process
rate_limiter.bucket <-> rate_limiter.redis: Periodic Token Refill {
  class: flow
  style.stroke-dash: 3
}