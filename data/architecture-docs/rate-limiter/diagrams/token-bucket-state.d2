classes: {
  state: {
    shape: circle
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  initial: {
    shape: circle
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#1a1a2e"
  }
  
  action: {
    shape: rectangle
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  condition: {
    shape: diamond
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

title: Token Bucket State Machine {
  style.font-size: 20
  style.font-color: "#e6edf3"
  style.bold: true
}

init: {
  class: initial
  label: ""
}

empty: Empty Bucket {
  class: state
}

available: Tokens Available {
  class: state
}

full: Bucket Full {
  class: state
}

token_gen: Generate Token {
  class: action
}

check_space: Space Available? {
  class: condition
}

consume_token: Consume Token {
  class: action
}

check_tokens: Tokens > 0? {
  class: condition
}

overflow: Overflow {
  class: action
}

init -> empty: Initialize

empty -> token_gen: Timer tick
token_gen -> check_space
check_space -> available: Yes
check_space -> overflow: No (bucket full)

available -> consume_token: Request arrives
consume_token -> check_tokens
check_tokens -> available: Yes
check_tokens -> empty: No (last token)

available -> token_gen: Timer tick
token_gen -> full: Bucket reaches capacity

full -> consume_token: Request arrives
consume_token -> available: Token consumed
full -> overflow: Timer tick (already full)

overflow -> full: Discard excess token

empty -> consume_token: Request arrives (rejected)
consume_token -> empty: No tokens available

note: |md
  **Token Bucket States:**
  - **Empty**: No tokens available, requests rejected
  - **Available**: Has tokens, can serve requests
  - **Full**: At maximum capacity, excess tokens discarded
  
  **Key Transitions:**
  - Tokens generated at fixed rate via timer
  - Tokens consumed on valid requests
  - Overflow handling prevents unbounded growth
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: bottom-right
}