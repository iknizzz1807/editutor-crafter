title: Multi-Level Caching Architecture

classes: {
  cache_layer: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  database: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  service: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  invalidation: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

api_gateway: API Gateway {
  class: service
}

l1_cache: L1 Cache Layer {
  class: cache_layer
  user_rec_cache: User Recommendations {
    shape: cylinder
    label: "TTL: 5 min\nSize: 100K users"
  }
  
  session_cache: Session Cache {
    shape: cylinder
    label: "TTL: 30 min\nSize: 50K sessions"
  }
}

l2_cache: L2 Cache Layer {
  class: cache_layer
  similarity_cache: Similarity Matrix {
    shape: cylinder
    label: "TTL: 6 hours\nSize: 1M items"
  }
  
  user_profile_cache: User Profiles {
    shape: cylinder
    label: "TTL: 2 hours\nSize: 500K users"
  }
  
  content_features_cache: Content Features {
    shape: cylinder
    label: "TTL: 24 hours\nSize: 2M items"
  }
}

l3_cache: L3 Cache Layer {
  class: cache_layer
  model_cache: Model Cache {
    shape: cylinder
    label: "TTL: 12 hours\nEmbeddings & Weights"
  }
  
  precomputed_cache: Precomputed Results {
    shape: cylinder
    label: "TTL: 8 hours\nCandidate Sets"
  }
}

database: Primary Database {
  shape: cylinder
  class: database
}

invalidation_service: Cache Invalidation Service {
  class: invalidation
}

model_training: Model Training Pipeline {
  class: service
}

api_gateway -> l1_cache.user_rec_cache: "Check cached recommendations"
api_gateway -> l1_cache.session_cache: "User session data"

l1_cache.user_rec_cache -> l2_cache.similarity_cache: "Cache miss - fetch similarities"
l1_cache.user_rec_cache -> l2_cache.user_profile_cache: "Fetch user profile"

l2_cache.similarity_cache -> l3_cache.model_cache: "Load model embeddings"
l2_cache.user_profile_cache -> l3_cache.precomputed_cache: "Get candidate items"
l2_cache.content_features_cache -> l3_cache.model_cache: "Feature vectors"

l3_cache.model_cache -> database: "Model not cached"
l3_cache.precomputed_cache -> database: "Generate new candidates"

model_training -> invalidation_service: "New model deployed"
database -> invalidation_service: "Data updated"

invalidation_service -> l1_cache.user_rec_cache: "Invalidate user recs"
invalidation_service -> l2_cache.similarity_cache: "Invalidate similarities"
invalidation_service -> l3_cache.model_cache: "Invalidate models"

cache_policy_note: |md
  **Cache Invalidation Strategies**
  
  • **Write-through**: L1 user recommendations
  • **Write-behind**: L2 similarity matrices  
  • **TTL-based**: All layers with different timeouts
  • **Event-driven**: Model updates trigger invalidation
| {
  shape: page
  near: bottom-right
  style.fill: "#16213e"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}