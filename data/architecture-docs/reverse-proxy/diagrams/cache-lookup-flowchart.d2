title: Cache Lookup and Storage Flow {
  near: top-center
  style.font-size: 24
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  storage: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  endpoint: {
    style.fill: "#d63031"
    style.stroke: "#e17055"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

start: Incoming Request {
  shape: circle
  class: process
}

generate_key: Generate Cache Key\n(URL + Headers + Method) {
  class: process
}

cache_lookup: Cache Lookup {
  class: process
}

cache_hit: Cache Hit? {
  shape: diamond
  class: decision
}

check_ttl: Check TTL\nExpiration {
  shape: diamond
  class: decision
}

serve_cached: Serve Cached\nResponse {
  class: endpoint
}

forward_request: Forward to\nBackend Server {
  class: process
}

receive_response: Receive Backend\nResponse {
  class: process
}

check_cacheable: Check Cache-Control\nHeaders {
  shape: diamond
  class: decision
}

has_no_cache: Has no-cache\nor private? {
  shape: diamond
  class: decision
}

has_max_age: Has max-age\nor expires? {
  shape: diamond
  class: decision
}

calculate_ttl: Calculate TTL\nfrom Headers {
  class: process
}

store_cache: Store in Cache\nwith TTL {
  class: storage
}

serve_response: Serve Response\nto Client {
  class: endpoint
}

discard: Discard Response\n(Not Cacheable) {
  class: endpoint
}

start -> generate_key
generate_key -> cache_lookup
cache_lookup -> cache_hit

cache_hit -> check_ttl: Hit
cache_hit -> forward_request: Miss

check_ttl -> serve_cached: Valid
check_ttl -> forward_request: Expired

forward_request -> receive_response
receive_response -> check_cacheable

check_cacheable -> has_no_cache: Cacheable Response
check_cacheable -> discard: Not Cacheable\n(POST, PUT, etc.)

has_no_cache -> discard: Yes
has_no_cache -> has_max_age: No

has_max_age -> calculate_ttl: Yes
has_max_age -> discard: No

calculate_ttl -> store_cache
store_cache -> serve_response

serve_cached -> start: Next Request {
  style.stroke-dash: 3
  style.stroke: "#8b949e"
}

serve_response -> start: Next Request {
  style.stroke-dash: 3
  style.stroke: "#8b949e"
}

discard -> start: Next Request {
  style.stroke-dash: 3
  style.stroke: "#8b949e"
}