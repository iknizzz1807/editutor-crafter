title: "Connection State Machine"

classes: {
  state: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  initial_state: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#1a1a2e"
    style.bold: true
  }
  
  final_state: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.double-border: true
    style.bold: true
  }
  
  transition: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  error_transition: {
    style.stroke: "#d63031"
    style.font-color: "#d63031"
  }
}

init: {
  shape: circle
  label: ""
  class: initial_state
}

idle: IDLE {
  shape: circle
  class: state
}

reading_request: READING_REQUEST {
  shape: circle
  class: state
}

forwarding: FORWARDING {
  shape: circle
  class: state
}

reading_response: READING_RESPONSE {
  shape: circle
  class: state
}

writing_response: WRITING_RESPONSE {
  shape: circle
  class: state
}

closing: CLOSING {
  shape: circle
  class: final_state
}

init -> idle: "Connection established" {
  class: transition
}

idle -> reading_request: "Client data arrives" {
  class: transition
}

reading_request -> reading_request: "Partial request data" {
  class: transition
}

reading_request -> forwarding: "Complete request parsed" {
  class: transition
}

forwarding -> reading_response: "Request sent to backend" {
  class: transition
}

reading_response -> reading_response: "Partial response data" {
  class: transition
}

reading_response -> writing_response: "Complete response received" {
  class: transition
}

writing_response -> writing_response: "Partial write to client" {
  class: transition
}

writing_response -> idle: "Response sent completely" {
  class: transition
}

idle -> closing: "Connection timeout" {
  class: error_transition
}

reading_request -> closing: "Read error / timeout" {
  class: error_transition
}

forwarding -> closing: "Backend connection failed" {
  class: error_transition
}

reading_response -> closing: "Backend error / timeout" {
  class: error_transition
}

writing_response -> closing: "Client write error" {
  class: error_transition
}

idle -> closing: "Client disconnect" {
  class: transition
}

reading_request -> closing: "Client disconnect" {
  class: error_transition
}

writing_response -> closing: "Keep-alive disabled" {
  class: transition
}