title: Crash Recovery Process

classes: {
  start_state: {
    style.fill: "#3fb950"
    style.stroke: "#3fb950"
    style.font-color: "#ffffff"
    style.bold: true
  }
  
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  decision: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  storage: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  success: {
    style.fill: "#00b894"
    style.stroke: "#00cec9"
    style.font-color: "#ffffff"
    style.bold: true
  }
}

orchestrator_crash: Orchestrator Crash/Restart {
  shape: circle
  class: start_state
}

state_scan: State Scanning {
  shape: rectangle
  class: process
}

persistence_store: Saga State Store {
  shape: cylinder
  class: storage
}

saga_discovery: Saga Identification {
  shape: rectangle
  class: process
}

active_sagas_check: Active Sagas Found? {
  shape: diamond
  class: decision
}

resume_analysis: Resume Point Analysis {
  shape: rectangle
  class: process
}

step_validation: Step Status Validation {
  shape: rectangle
  class: process
}

resume_decision: Determine Resume Action {
  shape: diamond
  class: decision
}

continue_execution: Continue Forward Execution {
  shape: rectangle
  class: process
}

trigger_compensation: Execute Compensation {
  shape: rectangle
  class: process
}

retry_step: Retry Failed Step {
  shape: rectangle
  class: process
}

update_state: Update Saga State {
  shape: rectangle
  class: process
}

recovery_complete: Recovery Complete {
  shape: circle
  class: success
}

no_action: No Recovery Needed {
  shape: rectangle
  class: success
}

orchestrator_crash -> state_scan: System restarts

state_scan -> persistence_store: Read persistent state
persistence_store -> saga_discovery: Load saga records

saga_discovery -> active_sagas_check: Analyze saga status

active_sagas_check -> no_action: No active sagas
active_sagas_check -> resume_analysis: Active sagas exist

resume_analysis -> step_validation: Check last executed step

step_validation -> resume_decision: Evaluate step completion

resume_decision -> continue_execution: Step completed successfully
resume_decision -> retry_step: Step failed/timeout
resume_decision -> trigger_compensation: Saga requires rollback

continue_execution -> update_state: Execute next step
retry_step -> update_state: Re-execute failed step
trigger_compensation -> update_state: Execute compensation logic

update_state -> persistence_store: Persist new state
update_state -> recovery_complete: Recovery finished

no_action -> recovery_complete: System ready

recovery_note: |md
  **Recovery Context**
  - State scanning reconstructs in-memory saga state
  - Idempotency prevents duplicate step execution
  - Resume points determined by last persisted state
  - Compensation triggered for failed saga branches
| {
  shape: page
  class: storage
  near: top-right
}