title: Health Check Process Flow

classes: {
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  decision: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  storage: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  action: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

start: Start {
  shape: circle
  class: process
  style.fill: "#3fb950"
  label: ""
}

schedule: Schedule Health Check {
  class: process
}

get_services: Get Services from Registry {
  class: action
}

service_check: Any Services to Check? {
  shape: diamond
  class: decision
}

http_request: Send HTTP Health Check {
  class: action
}

response_check: HTTP 200 Response? {
  shape: diamond
  class: decision
}

reset_counter: Reset Failure Count {
  class: action
}

increment_counter: Increment Failure Count {
  class: action
}

threshold_check: Failure Count > Threshold? {
  shape: diamond
  class: decision
}

mark_unhealthy: Mark Service Unhealthy {
  class: action
}

update_registry: Update Registry {
  class: storage
  shape: cylinder
}

wait: Wait for Next Check Interval {
  class: process
}

registry: Service Registry {
  shape: cylinder
  class: storage
}

start -> schedule
schedule -> get_services
get_services -> service_check

service_check -> http_request: Yes
service_check -> wait: No

http_request -> response_check

response_check -> reset_counter: Yes
response_check -> increment_counter: No

reset_counter -> threshold_check
increment_counter -> threshold_check

threshold_check -> mark_unhealthy: Yes
threshold_check -> update_registry: No

mark_unhealthy -> update_registry

update_registry -> service_check: Check Next Service
wait -> schedule: Timer Expired

get_services <-> registry: Query Services
update_registry <-> registry: Update Status