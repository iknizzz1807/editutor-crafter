shape: sequence_diagram

k8s_api: Kubernetes API
consul_api: Consul API
sidecar: Sidecar Proxy
watcher: Service Watcher
cache: Service Cache
config: Config Manager
circuit_breaker: Circuit Breaker

sidecar -> watcher: Initialize watchers
watcher -> k8s_api: Watch /api/v1/endpoints
watcher -> consul_api: Watch /v1/health/service

k8s_api -> watcher: Service endpoint created
watcher -> cache: Process endpoint update
cache -> cache: Validate endpoint health
cache -> config: Update service configuration
config -> circuit_breaker: Reset circuit state

consul_api -> watcher: Health check failed
watcher -> cache: Mark endpoint unhealthy
cache -> cache: Invalidate cache entry
cache -> config: Remove unhealthy endpoint
config -> circuit_breaker: Update failure count

k8s_api -> watcher: Service endpoint deleted
watcher -> cache: Remove endpoint
cache -> cache: Clean up stale entries
cache -> config: Update active endpoints
config -> sidecar: Notify configuration change

watcher -> cache: Periodic sync check
cache -> k8s_api: Reconcile state
cache -> consul_api: Verify health status
cache -> sidecar: Emit metrics

sidecar.style.fill: "#1a1a2e"
sidecar.style.stroke: "#3fb950"
sidecar.style.font-color: "#e6edf3"
sidecar.style.bold: true

watcher.style.fill: "#16213e"
watcher.style.stroke: "#3fb950"
watcher.style.font-color: "#e6edf3"

cache.style.fill: "#16213e"
cache.style.stroke: "#3fb950"
cache.style.font-color: "#e6edf3"

k8s_api.style.fill: "#0f3460"
k8s_api.style.stroke: "#8b949e"
k8s_api.style.font-color: "#e6edf3"

consul_api.style.fill: "#0f3460"
consul_api.style.stroke: "#8b949e"
consul_api.style.font-color: "#e6edf3"

config.style.fill: "#16213e"
config.style.stroke: "#8b949e"
config.style.font-color: "#e6edf3"

circuit_breaker.style.fill: "#16213e"
circuit_breaker.style.stroke: "#8b949e"
circuit_breaker.style.font-color: "#e6edf3"