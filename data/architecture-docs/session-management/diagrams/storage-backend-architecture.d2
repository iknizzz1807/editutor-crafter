title: Storage Backend Architecture {
  near: top-center
  style.font-size: 18
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  container: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  component: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  storage: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  arrow: {
    style.stroke: "#8b949e"
  }
}

abstraction: Storage Abstraction Layer {
  class: container
  
  interface: Storage Interface {
    class: component
    shape: rectangle
    + "get(session_id: string): Session"
    + "set(session_id: string, data: Session): void"
    + "delete(session_id: string): void"
    + "exists(session_id: string): boolean"
    + "cleanup_expired(): void"
  }
  
  serializer: Serialization Manager {
    class: component
    shape: rectangle
    + "serialize(data: Session): bytes"
    + "deserialize(data: bytes): Session"
    + "compress(data: bytes): bytes"
    + "decompress(data: bytes): bytes"
  }
  
  ttl: TTL Manager {
    class: component
    shape: rectangle
    - "default_ttl: Duration"
    - "cleanup_interval: Duration"
    + "set_expiry(key: string, ttl: Duration): void"
    + "is_expired(key: string): boolean"
    + "schedule_cleanup(): void"
  }
}

pooling: Connection Pooling Layer {
  class: container
  
  redis_pool: Redis Pool Manager {
    class: component
    shape: rectangle
    - "max_connections: int"
    - "idle_timeout: Duration"
    + "get_connection(): Connection"
    + "return_connection(conn: Connection): void"
    + "health_check(): boolean"
  }
  
  db_pool: Database Pool Manager {
    class: component
    shape: rectangle
    - "max_connections: int"
    - "connection_timeout: Duration"
    + "get_connection(): Connection"
    + "return_connection(conn: Connection): void"
    + "retry_failed(): void"
  }
}

implementations: Storage Implementations {
  class: container
  
  redis_impl: Redis Storage {
    class: storage
    shape: rectangle
    - "client: RedisClient"
    - "key_prefix: string"
    + "get(key: string): bytes"
    + "set(key: string, value: bytes, ttl: Duration): void"
    + "del(key: string): void"
    + "scan_expired(): Iterator"
  }
  
  db_impl: Database Storage {
    class: storage
    shape: rectangle
    - "connection: DBConnection"
    - "table_name: string"
    + "select_session(id: string): Row"
    + "insert_session(id: string, data: bytes): void"
    + "update_session(id: string, data: bytes): void"
    + "delete_expired(): int"
  }
  
  memory_impl: Memory Storage {
    class: storage
    shape: rectangle
    - "data: Map<string, Session>"
    - "expiry: Map<string, Timestamp>"
    + "get(key: string): Session"
    + "set(key: string, value: Session): void"
    + "cleanup(): void"
  }
}

backends: Physical Storage {
  class: container
  
  redis_server: Redis Server {
    shape: cylinder
    class: storage
  }
  
  database: PostgreSQL {
    shape: cylinder
    class: storage
  }
  
  heap_memory: Application Memory {
    shape: cylinder
    class: storage
  }
}

abstraction.interface -> implementations.redis_impl: implements {
  class: arrow
}
abstraction.interface -> implementations.db_impl: implements {
  class: arrow
}
abstraction.interface -> implementations.memory_impl: implements {
  class: arrow
}

implementations.redis_impl -> abstraction.serializer: uses {
  class: arrow
}
implementations.db_impl -> abstraction.serializer: uses {
  class: arrow
}
implementations.memory_impl -> abstraction.serializer: uses {
  class: arrow
}

implementations.redis_impl -> abstraction.ttl: manages expiry {
  class: arrow
}
implementations.db_impl -> abstraction.ttl: manages expiry {
  class: arrow
}
implementations.memory_impl -> abstraction.ttl: manages expiry {
  class: arrow
}

pooling.redis_pool -> implementations.redis_impl: provides connections {
  class: arrow
}
pooling.db_pool -> implementations.db_impl: provides connections {
  class: arrow
}

implementations.redis_impl -> backends.redis_server: stores data {
  class: arrow
}
implementations.db_impl -> backends.database: stores data {
  class: arrow
}
implementations.memory_impl -> backends.heap_memory: stores data {
  class: arrow
}