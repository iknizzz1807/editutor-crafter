vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- CLASSES ---
classes: {
  api_module: {
    style: {
      fill: "#1e3a8a"
      stroke: "#3b82f6"
      stroke-width: 2
      double-border: true
      font-color: white
    }
  }
  backend_engine: {
    style: {
      fill: "#312e81"
      stroke: "#6366f1"
      stroke-dash: 3
      font-color: white
    }
  }
  hardware_target: {
    style: {
      fill: "#111827"
      stroke: "#9ca3af"
      stroke-width: 3
      font-color: white
    }
  }
  memory_segment: {
    style: {
      fill: "#064e3b"
      stroke: "#10b981"
      font-color: white
    }
  }
}

# --- SATELLITE ARCHITECTURE ---

title: |md
  # SIMD Library Satellite Architecture
  *Universal Vectorization & Intrinsics Abstraction*
| {
  near: top-center
  shape: text
}

Developer_Application: "Developer Application" {
  shape: person
  link: "#developer-integration"
}

SIMD_Library: "SIMD Abstract Library" {
  link: "#library-core"

  Frontend: "Frontend API & Dispatch" {
    class: api_module
    link: "#frontend-api"
    
    Generic_Templates: "Generic Vector<T, N>" {
      link: "#templates"
    }
    Expression_Templates: "Lazy Evaluation Engine" {
      link: "#lazy-eval"
    }
    Dispatcher: "ISA Dispatcher" {
      shape: diamond
      link: "#dispatch-logic"
    }
  }

  ISA_Backends: "ISA Specialized Backends" {
    class: backend_engine
    link: "#isa-backends"

    x86_Engine: "Intel/AMD Backend" {
      SSE: "SSE 4.2" { link: "#sse-spec" }
      AVX: "AVX2 / FMA" { link: "#avx-spec" }
      AVX512: "AVX-512" { link: "#avx512-spec" }
    }

    ARM_Engine: "ARM Backend" {
      NEON: "ASIMD / NEON" { link: "#neon-spec" }
      SVE: "Scalable Vector (SVE)" { link: "#sve-spec" }
    }

    PowerPC_Engine: "IBM VSX" { link: "#vsx-spec" }
    Wasm_Engine: "WebAssembly SIMD" { link: "#wasm-spec" }
  }

  Memory_Manager: "Memory Alignment & I/O" {
    class: api_module
    link: "#memory-management"
    
    Aligned_Allocator: "Aligned Alloc" { link: "#allocator" }
    Gather_Scatter: "Indirect I/O" { link: "#gather-scatter" }
  }
}

Hardware_Layer: "Silicon Execution Layer" {
  class: hardware_target
  link: "#silicon-layer"

  Register_Files: "Vector Register Set" {
    shape: sql_table
    XMM: "128-bit (Float4)" {constraint: "Legacy/SSE"}
    YMM: "256-bit (Float8)" {constraint: "Mainstream/AVX"}
    ZMM: "512-bit (Float16)" {constraint: "High-Perf/AVX512"}
  }
}

# --- CONNECTIONS & DATA FLOW ---

Developer_Application -> SIMD_Library.Frontend.Generic_Templates: "High-level Operations"
SIMD_Library.Frontend.Generic_Templates -> SIMD_Library.Frontend.Dispatcher: "Type Info"

SIMD_Library.Frontend.Dispatcher -> SIMD_Library.ISA_Backends.x86_Engine: "CPUID Match"
SIMD_Library.Frontend.Dispatcher -> SIMD_Library.ISA_Backends.ARM_Engine: "AT_HWCAP Match"

SIMD_Library.ISA_Backends.x86_Engine.AVX512 -> Hardware_Layer.Register_Files.ZMM: "VADDPS / VMULPS"
SIMD_Library.ISA_Backends.ARM_Engine.SVE -> Hardware_Layer.Register_Files: "Variable Width"

SIMD_Library.Memory_Manager <-> SIMD_Library.ISA_Backends: "Direct Buffer Map"
SIMD_Library.Memory_Manager -> Hardware_Layer: "DMA / Cache Prefetch"

# --- MICROSCOPE VIEW: MEMORY LAYOUT ---

Memory_Page_Visual: "Memory Layout: Aligned Data" {
  near: bottom-right
  class: memory_segment
  
  # Using Grid to represent memory columns accurately
  grid-columns: 3
  grid-gap: 0
  
  "Byte Offset": {style.underline: true}
  "Data Segment": {style.underline: true}
  "SIMD Register Fit": {style.underline: true}

  "0x00": {style.font: mono}
  "Float[0..3]": {}
  "XMM0 (128b)": {style.fill: "#065f46"}

  "0x10": {style.font: mono}
  "Float[4..7]": {}
  "XMM1 (128b)": {style.fill: "#065f46"}

  "0x20": {style.font: mono}
  "Float[8..15]": {}
  "YMM0 (256b)": {style.fill: "#047857"}

  "0x40": {style.font: mono}
  "Padding": {style.opacity: 0.5}
  "---": {}
}

# --- STATE TRANSITION: VECTORIZATION ---

Transformation: "Vectorization Logic" {
  near: bottom-left
  
  Scalar_Loop: |cpp
    // Before: Scalar (SISD)
    for(int i=0; i<8; ++i)
      c[i] = a[i] + b[i];
  | {
    link: "#scalar-reference"
  }
  
  Vector_Op: |cpp
    // After: Vector (SIMD)
    // One instruction, 8 results
    _mm256_add_ps(a_vec, b_vec);
  | {
    link: "#intrinsics-docs"
  }
  
  Scalar_Loop -> Vector_Op: "Library Transformation" {
    style.animated: true
    style.stroke: "#3b82f6"
  }
}