vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Library Architecture Overview"

classes: {
  public_layer: {
    style: {
      fill: "#E3F2FD"
      stroke: "#1E88E5"
      font-color: "#0D47A1"
      stroke-width: 2
    }
  }
  dispatch_layer: {
    style: {
      fill: "#FFF3E0"
      stroke: "#FB8C00"
      font-color: "#E65100"
      stroke-width: 2
    }
  }
  impl_layer: {
    style: {
      fill: "#F3E5F5"
      stroke: "#8E24AA"
      font-color: "#4A148C"
      stroke-width: 2
    }
  }
  optimized: {
    style: {
      fill: "#E8F5E9"
      stroke: "#43A047"
      font-color: "#1B5E20"
      stroke-width: 2
    }
  }
  fallback: {
    style: {
      fill: "#FAFAFA"
      stroke: "#9E9E9E"
      font-color: "#616161"
      stroke-dash: 3
    }
  }
}

# -------------------------------------------------------------------------
# 1. PUBLIC INTERFACE
# -------------------------------------------------------------------------
User_App: "User Application" {
  shape: person
  link: "#anchor-foundation"
}

Public_API: "simd_lib.h\n(Public API Interface)" {
  class: public_layer
  shape: package
  link: "#anchor-foundation"
}

# -------------------------------------------------------------------------
# 2. DISPATCH CORE
# -------------------------------------------------------------------------
Core_System: "Dispatch & Detection Layer" {
  style: {
    fill: transparent
    stroke-width: 0
  }
  
  Dispatcher: "Function Resolver\n(Lazy Initialization)" {
    class: dispatch_layer
    shape: diamond
    link: "#anchor-foundation"
  }

  CPU_Detection: "CPU Feature Detection\n(CPUID Instruction)" {
    class: dispatch_layer
    shape: cylinder
    link: "#anchor-foundation"
  }
}

# -------------------------------------------------------------------------
# 3. IMPLEMENTATION SUBSYSTEMS
# -------------------------------------------------------------------------
Impl_Container: "Optimized Subsystems" {
  style: {
    fill: transparent
    stroke-width: 0
  }

  # Subsystem 1: String Search
  String_Search: "String Search Module" {
    class: impl_layer
    shape: class
    link: "#anchor-foundation"
    
    AVX2_Str: "AVX2 Implementation" {
      class: optimized
      link: "#anchor-foundation"
    }
    Scalar_Str: "Scalar Fallback" {
      class: fallback
      link: "#anchor-foundation"
    }
  }

  # Subsystem 2: Memcpy
  Memcpy_Ops: "Memory Operations" {
    class: impl_layer
    shape: class
    link: "#anchor-foundation"

    SIMD_Copy: "SSE/AVX Implementation" {
      class: optimized
      link: "#anchor-foundation"
    }
    Scalar_Copy: "Scalar Fallback" {
      class: fallback
      link: "#anchor-foundation"
    }
  }

  # Subsystem 3: Checksum
  Checksum_Ops: "Checksum & Hashing" {
    class: impl_layer
    shape: class
    link: "#anchor-foundation"

    AVX512_Hash: "AVX-512 Implementation" {
      class: optimized
      link: "#anchor-foundation"
    }
    Scalar_Hash: "Scalar Fallback" {
      class: fallback
      link: "#anchor-foundation"
    }
  }
}

# -------------------------------------------------------------------------
# CONNECTIONS
# -------------------------------------------------------------------------

# Flow from User to API
User_App -> Public_API: "Calls simd_dot_product()"

# API to Dispatcher
Public_API -> Core_System.Dispatcher: "Invokes Function Pointer"

# Dispatcher Logic
Core_System.Dispatcher <-> Core_System.CPU_Detection: "Queries Hardware Support"

# Routing to Subsystems
Core_System.Dispatcher -> Impl_Container.String_Search: "Routes to Best Algo"
Core_System.Dispatcher -> Impl_Container.Memcpy_Ops
Core_System.Dispatcher -> Impl_Container.Checksum_Ops

# Internal Subsystem Relationships (Selection)
Impl_Container.String_Search.Scalar_Str -> Impl_Container.String_Search.AVX2_Str: "Selected if Supported" {
    style: {
        stroke-dash: 3
        opacity: 0.5
    }
}
Impl_Container.Memcpy_Ops.Scalar_Copy -> Impl_Container.Memcpy_Ops.SIMD_Copy: "Selected if Supported" {
    style: {
        stroke-dash: 3
        opacity: 0.5
    }
}
Impl_Container.Checksum_Ops.Scalar_Hash -> Impl_Container.Checksum_Ops.AVX512_Hash: "Selected if Supported" {
    style: {
        stroke-dash: 3
        opacity: 0.5
    }
}