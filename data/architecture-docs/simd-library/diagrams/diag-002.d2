vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  instruction: {
    shape: step
    style: {
      fill: "#2d3436"
      stroke: "#6c5ce7"
      font-color: "#a29bfe"
      stroke-width: 2
    }
  }
  register_box: {
    style: {
      fill: "#1e272e"
      stroke: "#00d8d6"
      font-color: "#efefef"
      stroke-dash: 0
    }
  }
  feature_flag: {
    shape: diamond
    style: {
      fill: "#05c46b"
      font-color: "#ffffff"
    }
  }
  logic_block: {
    style: {
      stroke: "#ffdd59"
      fill: "#485460"
    }
  }
}

title: |'md
# SIMD CPU Feature Detection Flow
Runtime ISA Discovery & Dynamic Dispatching
'| {
  near: top-center
}

# --- HIGH LEVEL FLOW ---

Detection_Pipeline: "Feature Detection Pipeline" {
  link: "#pipeline-overview"
  
  Init: "Library Load / __init__" {
    class: instruction
    link: "#initialization"
  }

  Check_CPUID: "Verify CPUID Support" {
    class: instruction
    tooltip: "Check EFLAGS bit 21 (ID bit)"
    link: "#eflags-check"
  }

  Execute_CPUID: "CPUID Leaf Query" {
    class: instruction
    link: "#cpuid-execution"
  }

  Check_OS_Save: "OSXSAVE & XGETBV" {
    class: instruction
    tooltip: "Check if OS supports YMM/ZMM state saving"
    link: "#os-support"
  }

  Bit_Masking: "Feature Bit Extraction" {
    class: instruction
    link: "#bit-extraction"
  }

  Store_Caps: "Global Capability Mask" {
    shape: cylinder
    link: "#internal-state"
  }

  Init -> Check_CPUID -> Execute_CPUID -> Check_OS_Save -> Bit_Masking -> Store_Caps
}

# --- MICROSCOPE VIEW: CPUID REGISTER LAYOUT ---

Register_State: "CPUID Register Layout (Leaf 0x07, Sub-leaf 0x0)" {
  link: "#registers"
  tooltip: "Registers after executing CPUID with EAX=7, ECX=0"
  
  grid-columns: 2
  
  Input: {
    EAX_IN: "EAX = 0x00000007" { class: register_box }
    ECX_IN: "ECX = 0x00000000" { class: register_box }
  }

  Output: {
    EAX_OUT: "EAX: Max Sub-leaf" { class: register_box }
    EBX_OUT: "EBX: Feature Flags 1" {
      shape: sql_table
      bit_5: "AVX2" { constraint: "Bit 5"; style.fill: "#05c46b" }
      bit_16: "AVX512F" { constraint: "Bit 16"; style.fill: "#05c46b" }
      bit_31: "AVX512VL" { constraint: "Bit 31"; style.fill: "#05c46b" }
    }
    ECX_OUT: "ECX: Feature Flags 2" { class: register_box }
    EDX_OUT: "EDX: Feature Flags 3" { class: register_box }
  }

  Input -> Output: "asm: 'cpuid'" {
    style: {
      stroke: "#ff3f34"
      animated: true
      stroke-width: 3
    }
  }
}

# --- OS SUPPORT CHECK (XGETBV) ---

OS_Context: "OS Context Validation" {
  link: "#os-validation"
  
  XCR0: "Control Register XCR0" {
    shape: sql_table
    bit_1: "SSE State" { constraint: "0x2" }
    bit_2: "AVX State" { constraint: "0x4" }
    bit_5_7: "AVX-512 State" { constraint: "0xE0" }
  }

  Logic: "Capability Valid?" {
    class: feature_flag
    link: "#logic-gate"
  }

  XCR0 -> Logic: "XGETBV Instruction"
}

# --- STATE TRANSITION: DISPATCHER ---

Dynamic_Dispatch: "Function Pointer Assignment" {
  link: "#dynamic-dispatch"
  
  Before: "Uninitialized State" {
    SIMD_Add: "ptr -> nullptr" { 
      class: logic_block 
      link: "#state-before"
    }
  }

  After: "Post-Detection State" {
    SIMD_Add_AVX2: "ptr -> add_avx2_impl" { 
      class: logic_block
      style.fill: "#1e3799"
      link: "#state-after"
    }
  }

  Detection_Pipeline.Store_Caps -> After: "Update VTable" {
    style.stroke: "#ffa801"
    style.animated: true
  }
}

# --- ANNOTATIONS ---

Annotate: |'md
## Detection Logic
1. **CPUID Leaf 1**: Basic SSE/AVX hardware presence.
2. **CPUID Leaf 7**: Advanced AVX2, AVX-512, SHA, and BMI extraction.
3. **XGETBV**: Critical step ensuring the OS kernel actually supports 
   context switching for wider YMM/ZMM registers.
'| {
  near: bottom-left
}

# Global Connections
Detection_Pipeline.Execute_CPUID -> Register_State: "View Registers"
Detection_Pipeline.Check_OS_Save -> OS_Context: "Validate OS Support"
Detection_Pipeline.Bit_Masking -> Dynamic_Dispatch: "Trigger Re-Bind"

# Grouping Styles
Register_State.style.stroke: "#00d8d6"
OS_Context.style.stroke: "#05c46b"
Dynamic_Dispatch.style.stroke: "#ffa801"