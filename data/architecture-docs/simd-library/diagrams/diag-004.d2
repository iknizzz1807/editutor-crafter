direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

Title: Runtime Dispatch Architecture\n(Lazy Initialization Pattern) {
  shape: text
  near: top-center
  style.font-size: 32
  style.underline: true
}

User App: {
  shape: person
  link: "#anchor-dispatch"
}

Public Interface: "simd_lib.h" {
  shape: class
  style.fill: "#f5f5f5"
  link: "#anchor-dispatch"
  +simd_dot_product()
  +simd_init()
}

Global State: {
  shape: sql_table
  link: "#anchor-dispatch"
  
  Function Pointer: "g_dot_ptr" {constraint: "static fn*"}
  Status: "Uninitialized"
}

Dispatcher: "CPU Resolver\n(Internal)" {
  shape: diamond
  style.fill: "#ffeb3b"
  link: "#anchor-dispatch"
}

Hardware: "CPU Features\n(CPUID)" {
  shape: hexagon
  style.fill: "#cfd8dc"
  link: "#anchor-dispatch"
}

Implementations: {
  style.fill: "#e3f2fd"
  style.stroke: "#2196f3"
  
  AVX512: "AVX-512 Kernel" {
    shape: package
    style.fill: "#b9f6ca"
    link: "#anchor-dispatch"
  }
  AVX2: "AVX2 Kernel" {
    shape: package
    style.fill: "#ffff8d"
    link: "#anchor-dispatch"
  }
  SSE: "SSE Kernel" {
    shape: package
    style.fill: "#ff8a80"
    link: "#anchor-dispatch"
  }
}

# Flow
User App -> Public Interface: 1. Call API
Public Interface -> Global State: 2. Check Pointer

# Conditional Edges
Global State -> Dispatcher: 3. If Null (First Run)
Dispatcher -> Hardware: 4. Check Caps
Hardware -> Dispatcher: 5. Return Flags
Dispatcher -> Global State: 6. Patch Pointer\n(Update g_dot_ptr)

Global State -> Implementations.AVX512: 7. Direct Jump\n(Subsequent Calls)
Global State -> Implementations.AVX2: " "
Global State -> Implementations.SSE: " "

Legend: |md
  **Dispatch Mechanism**
  1. **Lazy Loading**: Pointer is initially null.
  2. **Resolution**: First call triggers CPU check.
  3. **Hot-Patch**: Global pointer is updated to best kernel.
  4. **Fast Path**: Future calls bypass resolver.
| {
  near: bottom-right
  shape: text
  style.font-size: 14
}