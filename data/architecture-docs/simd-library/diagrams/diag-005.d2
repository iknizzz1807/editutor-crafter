vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  register_component: {
    shape: rectangle
    style: {
      stroke-width: 2
      border-radius: 4
      shadow: true
    }
  }
  abi_column: {
    shape: package
    style: {
      stroke-width: 2
      fill: white
    }
  }
  reg_group: {
    shape: class
    width: 200
    style: {
      stroke-width: 1
    }
  }
}

# -------------------------------------------------------------------------
# SECTION 1: Hardware Anatomy (The Microscope)
# -------------------------------------------------------------------------
Hardware_Anatomy: Register Bit Hierarchy {
  link: "#anchor-sse-core"
  style: {
    fill: "#f8f9fa"
    stroke: "#5f6368"
    stroke-dash: 3
  }
  
  # Note: Visualizing LSB on the Right, MSB on the Left
  
  ZMM_View: ZMM Register (512-bit) {
    layout: right
    
    Upper_ZMM: Bits 511..256 {
      class: register_component
      width: 200
      height: 80
      label: "AVX-512 Extension\n(High ZMM)"
      style: {
        fill: "#e8eaed"
        stroke-dash: 3
        font-size: 14
      }
    }

    Lower_ZMM: Bits 255..0 {
      style.fill: transparent
      style.stroke-width: 0
      layout: right
      
      Upper_YMM: Bits 255..128 {
        class: register_component
        width: 180
        height: 80
        label: "AVX/AVX2 Extension\n(High YMM)"
        style: {
          fill: "#d2e3fc"
          font-size: 14
        }
      }

      XMM_Base: Bits 127..0 {
        class: register_component
        width: 180
        height: 80
        label: "SSE Legacy\n(XMM)"
        style: {
          fill: "#8ab4f8"
          stroke: "#1a73e8"
          stroke-width: 4
          font-size: 14
          bold: true
        }
      }
    }
  }
  
  Explanation: |md
    *   **XMM**: Base 128-bit container. Used by SSE.
    *   **YMM**: Extends XMM to 256 bits. Used by AVX.
    *   **ZMM**: Extends YMM to 512 bits. Used by AVX-512.
  | {
    shape: text
    style.font-size: 12
  }
}

# -------------------------------------------------------------------------
# SECTION 2: ABI Constraints (The Rules)
# -------------------------------------------------------------------------

ABI_Constraints: Calling Conventions {
  link: "#anchor-sse-core"
  direction: right
  
  # --- Linux / System V ABI ---
  Linux_ABI: System V AMD64 ABI (Linux/Mac) {
    class: abi_column
    link: "#anchor-sse-core"
    
    Args: Arguments {
      class: reg_group
      label: "XMM0 - XMM7"
      style: {
        fill: "#ceead6" # Green
        stroke: "#137333"
      }
    }
    
    Ret: Returns {
      class: reg_group
      label: "XMM0 - XMM1"
      style: {
        fill: "#d2e3fc" # Blue
        stroke: "#174ea6"
      }
    }
    
    Volatile: Caller-Saved (Scratch) {
      class: reg_group
      label: "XMM0 - XMM15\n(ALL Registers)"
      style: {
        fill: "#fad2cf" # Red
        stroke: "#c5221f"
        bold: true
      }
    }
    
    Note: "The OS assumes all vector\nregisters are destroyed\nby a function call." {
        shape: text
        style.font-size: 12
    }
    
    Args -> Ret: Input/Output
    Ret -> Volatile: Lifetime
  }

  # --- Windows ABI ---
  Windows_ABI: Microsoft x64 ABI {
    class: abi_column
    link: "#anchor-sse-core"

    Args_Win: Arguments {
      class: reg_group
      label: "XMM0 - XMM3"
      style: {
        fill: "#ceead6"
        stroke: "#137333"
      }
    }

    Ret_Win: Returns {
      class: reg_group
      label: "XMM0"
      style: {
        fill: "#d2e3fc"
        stroke: "#174ea6"
      }
    }
    
    Volatile_Win: Caller-Saved (Scratch) {
      class: reg_group
      label: "XMM0 - XMM5"
      style: {
        fill: "#fad2cf"
        stroke: "#c5221f"
      }
    }

    NonVolatile_Win: Callee-Saved (Preserved) {
      class: reg_group
      label: "XMM6 - XMM15\n(Low 128-bits ONLY)"
      style: {
        fill: "#fce8b2" # Yellow/Orange
        stroke: "#fbc02d"
        stroke-width: 3
      }
    }
    
    Warning: "High bits (YMM/ZMM)\nare always VOLATILE\non Windows!" {
        shape: text
        style.font-color: "#c5221f"
        style.font-size: 12
    }

    Args_Win -> Ret_Win
    Volatile_Win -> NonVolatile_Win: Boundary
    NonVolatile_Win -> Warning
  }
}

Hardware_Anatomy -> ABI_Constraints: "Hardware capabilities vs Software rules" {
    style: {
        stroke-dash: 3
        opacity: 0.5
    }
}