vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  register: {
    style: {
      fill: "#1e1e2e"
      stroke: "#89b4fa"
      stroke-width: 2
      font-color: "#cdd6f4"
      font: mono
    }
  }
  memory_block: {
    style: {
      fill: "#313244"
      stroke: "#fab387"
      stroke-dash: 2
    }
  }
  logic_op: {
    style: {
      fill: "#45475a"
      stroke: "#a6e3a1"
      border-radius: 5
    }
  }
  byte_cell: {
    width: 30
    height: 30
    style: {
      font-size: 10
      text-transform: uppercase
    }
  }
}

# --- SATELLITE VIEW: CORE PIPELINE ---
sse_search_pipeline: "SSE 4.2 PCMPESTRI Search Pipeline" {
  prep: "Preparation Phase" {
    link: "#prep-phase"
    load_needle: "Load Needle into XMM0"
    load_haystack: "Load Haystack into XMM1"
    set_lengths: "EAX=Len1, EDX=Len2"
    load_needle -> set_lengths
    load_haystack -> set_lengths
  }

  instr: "PCMPESTRI Instruction" {
    link: "#instruction-internals"
    shape: step
    label: "PCMPESTRI xmm1, xmm2, imm8"
    style: {
      fill: "#f38ba8"
      font-color: "white"
      bold: true
    }
  }

  result: "Resolution Phase" {
    link: "#result-phase"
    check_index: "Read ECX (Index)"
    handle_flags: "Evaluate EFLAGS (ZF/CF/SF)"
    check_index -> handle_flags
  }

  prep -> instr: "SIMD Execution"
  instr -> result: "Update State"
}

# --- STREET VIEW: REGISTER MICROSCOPE ---
register_microscope: "128-bit SIMD Register Mapping" {
  xmm0_needle: "XMM0 (Needle: 'ABCD')" {
    class: register
    grid-columns: 16
    n0: "A"; n1: "B"; n2: "C"; n3: "D"
    n4: "0"; n5: "0"; n6: "0"; n7: "0"
    n8: "0"; n9: "0"; n10: "0"; n11: "0"
    n12: "0"; n13: "0"; n14: "0"; n15: "0"
    
    n0.class: byte_cell; n1.class: byte_cell; n2.class: byte_cell; n3.class: byte_cell
    n0.style.fill: "#94e2d5"; n1.style.fill: "#94e2d5"; n2.style.fill: "#94e2d5"; n3.style.fill: "#94e2d5"
  }

  comparison_logic: "Parallel Comparison Matrix" {
    shape: diamond
    style.fill: "#f9e2af"
  }

  xmm1_haystack: "XMM1 (Haystack: '..ABCD..')" {
    class: register
    grid-columns: 16
    h0: "."; h1: "."; h2: "A"; h3: "B"
    h4: "C"; h5: "D"; h6: "."; h7: "."
    h8: "."; h9: "."; h10: "."; h11: "."
    h12: "."; h13: "."; h14: "."; h15: "."
    
    h2.class: byte_cell; h3.class: byte_cell; h4.class: byte_cell; h5.class: byte_cell
    h2.style.fill: "#a6e3a1"; h3.style.fill: "#a6e3a1"; h4.style.fill: "#a6e3a1"; h5.style.fill: "#a6e3a1"
  }

  xmm0_needle -> comparison_logic: "Broadcasting"
  xmm1_haystack -> comparison_logic: "Scanning"
}

# --- DEEP DIVE: INSTRUCTION INTERNALS ---
instruction_internals: "PCMPESTRI Control Logic (Imm8)" {
  imm8_control: "Imm8 Control Byte Breakdown" {
    shape: sql_table
    bit_range: "Functionality"
    "0:1": "Source Data: 00b=unsigned byte, 01b=unsigned word"
    "2:3": "Aggregation: 11b=Equal Ordered (Substring Search)"
    "4:5": "Polarity: 00b=Positive Match, 01b=Negative (Not)"
    "6": "Index: 0=Least Significant, 1=Most Significant"
  }

  comp_unit: "Aggregation Engine" {
    class: logic_op
    mask_gen: "Match Mask Generator"
    index_calc: "ECX = BitScanForward(Mask)"
    mask_gen -> index_calc
  }

  imm8_control -> comp_unit: "Behavior Inject"
}

# --- STATE TRANSITION: BEFORE/AFTER ---
execution_state: "PCMPESTRI State Transition" {
  before: "Pre-Instruction" {
    eax: "EAX: 4" {class: register}
    edx: "EDX: 8" {class: register}
    ecx: "ECX: 0xFFFF" {class: register}
    eflags: "EFLAGS: 0x0" {class: register}
  }

  after: "Post-Instruction" {
    eax_a: "EAX: 4" {class: register}
    edx_a: "EDX: 8" {class: register}
    ecx_a: "ECX: 2" {
      class: register
      style.fill: "#a6e3a1"
      style.font-color: "black"
    }
    eflags_a: "EFLAGS" {
      class: register
      zf: "ZF=0 (No null in Haystack)"
      cf: "CF=1 (Match Found)"
      sf: "SF=0 (Needle <= Haystack)"
    }
  }

  before -> after: "PCMPESTRI Execution" {
    style.stroke-width: 4
    style.stroke: "#89dceb"
    style.animated: true
  }
}

# --- TEXTUAL ANNOTATION ---
explanation: |'md
### PCMPESTRI (Packed Compare Explicit Length Strings, Return Index)
This SIMD instruction performs advanced string processing in hardware.

1.  **Explicit Length**: Lengths of both operands are provided in `EAX` and `EDX`, allowing for strings with null bytes.
2.  **Aggregation Units**: 
    - `Equal Any`: Character set search (find any char from XMM0 in XMM1).
    - `Equal Ordered`: Substring search (find XMM0 in XMM1).
3.  **Result Propagation**:
    - The first matching index is loaded into `ECX`.
    - `CF` flag is set if a match is found.
    - `ZF` flag is set if a null character is found in XMM1.
'| {
  near: top-center
}

# --- ANCHOR DEFINITIONS ---
prep-phase: "" { style.opacity: 0 }
instruction-internals: "" { style.opacity: 0 }
result-phase: "" { style.opacity: 0 }