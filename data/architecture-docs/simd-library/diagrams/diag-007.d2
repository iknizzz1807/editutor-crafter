vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "SSE4.2 PCMPISTRI: The Micro-Architecture of Search"

Registers: {
  link: "#anchor-sse-core"
  near: top-center
  
  XMM1: {
    shape: rectangle
    label: "XMM1 (Needle)\n| 'W' | 'o' | 'r' | 'l' | 'd' | '\\0' | ... |"
    width: 300
    style: {
        fill: "#e3f2fd"
        stroke: "#1565c0"
        stroke-width: 2
    }
  }
  XMM2: {
    shape: rectangle
    label: "XMM2 (Haystack)\n| 'H' | 'e' | 'l' | 'l' | 'o' | ' ' | 'W' | 'o' | 'r' | 'l' | 'd' | ... |"
    width: 300
    style: {
        fill: "#e8f5e9"
        stroke: "#2e7d32"
        stroke-width: 2
    }
  }
}

Processor: "Execution Unit (Port 0/1)" {
  link: "#anchor-sse-core"
  style: {
    fill: "#f3e5f5"
    stroke: "#7b1fa2"
    stroke-width: 2
    shadow: true
  }

  Control_Logic: {
    shape: step
    label: "Imm8 Decoder\n(Val: 0x0C)"
    tooltip: "Mode: Equal Ordered (Substring)\nPolarity: Positive\nLength: Implicit"
    style.fill: "#e1bee7"
  }

  Aggregation: "PCmpIStrI Logic" {
    shape: package
    style.fill: "#ffffff"
    
    Grid: "Comparison Matrix" {
        shape: rectangle
        label: "16x16 Parallel Compare"
        style.stroke-dash: 3
    }
    
    IntRes1: {
        shape: queue
        label: "Intermediate Mask\n|0|0|0|0|0|0|1|0|...|"
        style.fill: "#ffccbc"
    }
    
    Grid -> IntRes1: "Aggregate Matches"
  }

  Index_Encoder: {
    shape: diamond
    label: "Priority Encoder\n(TZCNT)"
    style.fill: "#fff9c4"
  }

  Control_Logic -> Aggregation: Configures
  Aggregation.IntRes1 -> Index_Encoder: "Find First '1'"
}

Result: {
  link: "#anchor-sse-core"
  
  ECX: {
    shape: cylinder
    label: "ECX Register\nValue: 6"
    style: {
        fill: "#ffecb3"
        stroke: "#ff6f00"
    }
  }
  
  EFLAGS: {
    shape: parallelogram
    label: "EFLAGS\nCF=0, ZF=0"
    style: {
        fill: "#b2dfdb"
        stroke: "#00695c"
    }
  }
}

# Wiring
Registers.XMM1 -> Processor.Aggregation.Grid: "Operand 1"
Registers.XMM2 -> Processor.Aggregation.Grid: "Operand 2"

Processor.Index_Encoder -> Result.ECX: "Write Index"
Processor.Index_Encoder -> Result.EFLAGS: "Update Status"

Explanation: |md
  **Mechanism**:
  1. **Load**: XMM registers loaded with string data.
  2. **Config**: Imm8 `0x0C` selects "Substring Search".
  3. **Compare**: Hardware compares all positions in parallel.
  4. **Mask**: `IntRes1` generated. Bit 6 is set because "World" matches at offset 6.
  5. **Encode**: Hardware counts trailing zeros to find index `6`.
| {
  shape: text
  near: bottom-center
  style.font-size: 14
}