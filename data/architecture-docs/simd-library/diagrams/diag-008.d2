direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: SIMD String Search: The Boundary Problem {
  shape: text
  near: top-center
  style.font-size: 24
}

Start: Init Search {
  shape: oval
  link: "#anchor-string-search"
}

Loop: Main Vector Loop {
  link: "#anchor-string-search"
  style: {
    fill: "#f5f5f5"
    stroke: "#333"
  }
  
  Load: Load 16 Bytes (V_curr) {
    shape: step
    link: "#anchor-string-search"
  }

  Compare: SIMD Compare\n(Calculate Mask) {
    shape: rectangle
    link: "#anchor-string-search"
  }

  IsMatch: Full Match Found? {
    shape: diamond
    link: "#anchor-string-search"
  }

  IsBoundary: Suffix Match\n(Potential Split)? {
    shape: diamond
    tooltip: "Pattern might start at the end of this vector\nand finish in the next."
    link: "#anchor-string-search"
  }

  Next: Advance Pointer +16 {
    shape: parallelogram
    link: "#anchor-string-search"
  }
}

BoundaryCase: Boundary Handler {
  link: "#anchor-string-search"
  style.stroke-dash: 3
  
  LoadNext: Load Next 16 Bytes (V_next) {
    shape: step
    link: "#anchor-string-search"
  }

  Stitch: Stitch Registers\n(Shift & OR) {
    shape: rectangle
    link: "#anchor-string-search"
  }

  CheckCross: Verify Split Pattern {
    shape: diamond
    link: "#anchor-string-search"
  }
}

Result: Return Index {
  shape: document
  style.fill: "#ACE1AF"
  link: "#anchor-string-search"
}

# Connectivity
Start -> Loop.Load

Loop.Load -> Loop.Compare
Loop.Compare -> Loop.IsMatch

Loop.IsMatch -> Result: Yes
Loop.IsMatch -> Loop.IsBoundary: No

Loop.IsBoundary -> BoundaryCase.LoadNext: Yes
Loop.IsBoundary -> Loop.Next: No

Loop.Next -> Loop.Load: Continue

BoundaryCase.LoadNext -> BoundaryCase.Stitch
BoundaryCase.Stitch -> BoundaryCase.CheckCross

BoundaryCase.CheckCross -> Result: Confirmed
BoundaryCase.CheckCross -> Loop.Next: False Alarm