vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: down

classes: {
  process: {
    style: {
      stroke-width: 2
      fill: "#f8f9fa"
      stroke: "#495057"
    }
    link: "#anchor-string-search"
  }
  simd_block: {
    style: {
      fill: "#e3f2fd"
      stroke: "#2196f3"
      stroke-width: 2
      shadow: true
    }
    link: "#anchor-string-search"
  }
  decision: {
    shape: diamond
    style: {
      fill: "#fff3cd"
      stroke: "#ffc107"
    }
    link: "#anchor-string-search"
  }
  memory: {
    shape: parallelogram
    style: {
      fill: "#e8f5e9"
      stroke: "#4caf50"
    }
    link: "#anchor-string-search"
  }
}

# --- Header ---
Title: |md
  # Two-Way Substring Search
  ## SIMD-Accelerated Crochemore-Perrin
| {
  shape: text
  near: top-center
  link: "#anchor-string-search"
}

# --- Input Stage ---
Input_Data: {
  shape: package
  label: "Input Buffers"
  link: "#anchor-string-search"
  
  Needle: "Pattern P (m bytes)" {
    shape: queue
    link: "#anchor-string-search"
  }
  Haystack: "Text T (n bytes)" {
    shape: queue
    link: "#anchor-string-search"
  }
}

# --- Phase 1: Preprocessing ---
Preprocessing: {
  link: "#anchor-string-search"
  style.multiple: true
  label: "Phase 1: Critical Factorization"
  
  Factorization: "Split P into (u, v)" {
    class: process
    tooltip: "Determine the cut where local period is maximized"
  }
  
  SIMD_Prep: "Precompute Vectors" {
    class: simd_block
    label: "Broadcast First/Last Chars"
    tooltip: "YMM0 = [P[0]...], YMM1 = [P[m-1]...]"
  }
  
  Factorization -> SIMD_Prep
}

Input_Data -> Preprocessing

# --- Phase 2: The Search Loop ---
Search_Engine: "Phase 2: Vectorized Search" {
  link: "#anchor-string-search"
  style.fill: "#fafafa"
  style.stroke-dash: 3
  
  # Step 1: SIMD Scan
  SIMD_Scanner: "Fast Skip Loop" {
    class: simd_block
    
    Load: "vmovdqu" {
      label: "Load 32 Bytes of T"
      link: "#anchor-string-search"
    }
    Compare: "vpcmpeqb" {
      label: "Parallel Compare P[0]"
      link: "#anchor-string-search"
    }
    Mask: "vpmovmskb" {
      label: "Get Candidate Bits"
      link: "#anchor-string-search"
    }
    
    Load -> Compare -> Mask
  }

  # Step 2: Check for Candidates
  Check_Mask: "Mask != 0?" {
    class: decision
  }

  # Step 3: Two-Way Verification
  Verification: "Ordered Comparison" {
    class: process
    tooltip: "Order matters: Check Right (v) then Left (u)"
    
    Right_Scan: "Verify Suffix (v)" {
      label: "Compare T[i+|u|...] == v"
      link: "#anchor-string-search"
    }
    
    Left_Scan: "Verify Prefix (u)" {
      label: "Compare T[i...] == u"
      link: "#anchor-string-search"
    }
    
    Right_Scan -> Left_Scan: "Match"
  }
  
  # Step 4: Shift Logic
  Shift_Calculator: "Compute Shift" {
    class: memory
    label: "Advance Window"
    tooltip: "Shift = Period(u) or Period(v) depending on mismatch"
  }

  # Connections inside loop
  SIMD_Scanner -> Check_Mask
  Check_Mask -> Verification: "Found Candidate (1)"
  Check_Mask -> Shift_Calculator: "No Candidate (0)"
  
  Verification -> Shift_Calculator: "Mismatch"
  
  Shift_Calculator -> SIMD_Scanner: "Next Window"
}

Preprocessing -> Search_Engine.SIMD_Scanner

# --- Outcomes ---
Match_Found: "Return Index" {
  shape: callout
  type: success
  style.fill: "#b2f5ea"
  link: "#anchor-string-search"
}

End_Of_Text: "Return -1" {
  shape: circle
  style.fill: "#fed7d7"
  link: "#anchor-string-search"
}

Search_Engine.Verification -> Match_Found: "Full Match"
Search_Engine.Check_Mask -> End_Of_Text: "End of Buffer"