vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}
direction: right

title: "Micro-Architecture: Character Class Search" {
  shape: text
  near: top-center
  style: {
    font-size: 32
    bold: true
  }
  link: "#anchor-string-search"
}

SIMD_Pipeline: "SIMD Execution Flow" {
  link: "#anchor-string-search"
  
  # 1. Load Data
  Input_Stage: {
    Vector_Reg: "YMM Input Vector (32-bytes)" {
      shape: class
      # Visualizing subset of lanes for clarity
      "Lane 0": "'H' (0x48)"
      "Lane 1": "'e' (0x65)"
      "Lane 2": "' ' (0x20)"
      "Lane 3": "'w' (0x77)"
      "Lane 4": "'\\t' (0x09)"
      "Lane 5": "'o' (0x6F)"
      "Lane 6": "'\\n' (0x0A)"
      "Lane 7": "'!' (0x21)"
    }
  }

  # 2. Parallel Comparison
  Comparators: {
    CMP_Space: "VPCMPEQB (Space ' ')" {
      shape: step
      style.stroke: "#5B9BD5"
    }
    CMP_Tab: "VPCMPEQB (Tab '\\t')" {
      shape: step
      style.stroke: "#ED7D31"
    }
    CMP_Newline: "VPCMPEQB (Newline '\\n')" {
      shape: step
      style.stroke: "#70AD47"
    }
  }

  # 3. Intermediate Masks
  Masks: {
    Mask_Space: "Mask (Space)" {
      shape: class
      "L2": "0xFF"
      "Others": "0x00"
    }
    Mask_Tab: "Mask (Tab)" {
      shape: class
      "L4": "0xFF"
      "Others": "0x00"
    }
    Mask_NL: "Mask (Newline)" {
      shape: class
      "L6": "0xFF"
      "Others": "0x00"
    }
  }

  # 4. Reduction (OR)
  Reduction: {
    VPOR: "VPOR (Vector OR)" {
      shape: diamond
      style: {
        fill: "#FFC000"
        font-color: black
      }
      tooltip: "Combines all matches into one vector"
    }
  }

  # 5. Final Vector Mask
  Unified_Mask: "Unified Vector Mask" {
    shape: class
    "Lane 0": "0x00"
    "Lane 1": "0x00"
    "Lane 2": "0xFF"
    "Lane 3": "0x00"
    "Lane 4": "0xFF"
    "Lane 5": "0x00"
    "Lane 6": "0xFF"
    "Lane 7": "0x00"
  }

  # 6. Scalar Extraction
  Extraction: {
    VPMOVMSKB: "VPMOVMSKB" {
      shape: parallelogram
      label: "Compress to Scalar"
      tooltip: "Extracts MSB of each byte"
    }
    
    GPR: "General Purpose Register (RAX)" {
      shape: queue
      val: "01010100 (Binary)"
    }

    Algo: "Index Logic" {
      style.fill: "#f4f4f4"
      
      POPCNT: "POPCNT" {
        label: "Count: 3 Matches"
        shape: rectangle
      }
      TZCNT: "TZCNT Loop" {
        label: "Next Index: 2"
        shape: rectangle
        style.stroke-dash: 3
      }
    }
  }

  # Wiring the Logic
  Input_Stage.Vector_Reg -> Comparators.CMP_Space: "Broadcast ' '"
  Input_Stage.Vector_Reg -> Comparators.CMP_Tab: "Broadcast '\\t'"
  Input_Stage.Vector_Reg -> Comparators.CMP_Newline: "Broadcast '\\n'"

  Comparators.CMP_Space -> Masks.Mask_Space
  Comparators.CMP_Tab -> Masks.Mask_Tab
  Comparators.CMP_Newline -> Masks.Mask_NL

  Masks.Mask_Space -> Reduction.VPOR
  Masks.Mask_Tab -> Reduction.VPOR
  Masks.Mask_NL -> Reduction.VPOR

  Reduction.VPOR -> Unified_Mask: "Merge"
  Unified_Mask -> Extraction.VPMOVMSKB
  Extraction.VPMOVMSKB -> Extraction.GPR
  Extraction.GPR -> Extraction.Algo.POPCNT
  Extraction.GPR -> Extraction.Algo.TZCNT
}