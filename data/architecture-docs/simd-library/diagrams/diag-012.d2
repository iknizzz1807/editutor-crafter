direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  memory_cell: {
    shape: rectangle
    width: 140
    height: 60
    style: {
      fill: "#2b2b2b"
      stroke: "#7e57c2"
      font-color: "#ffffff"
      stroke-width: 2
    }
  }
  reg: {
    shape: package
    width: 120
    height: 50
    style: {
      fill: "#ff6f00"
      stroke: "#ffca28"
      font-color: "#000000"
      bold: true
    }
  }
  control_node: {
    shape: hexagon
    style: {
      fill: "#00695c"
      stroke: "#80cbc4"
      font-color: "white"
    }
  }
}

Source Memory: {
  link: "#anchor-memcpy-engine"
  tooltip: "Aligned Source Buffer (RAM)"
  
  # Cache Line Representation
  Cache Line N: {
    label: "Cache Line N (64 Bytes)"
    style: {
      stroke-dash: 3
      fill: "#1a1a1a"
      font-color: "#aaaaaa"
    }
    
    src_0: "Offset + 0x00\n[256-bit / 32B]" {
      class: memory_cell
    }
    src_32: "Offset + 0x20\n[256-bit / 32B]" {
      class: memory_cell
    }
  }

  Cache Line N+1: {
    label: "Cache Line N+1 (64 Bytes)"
    style: {
      stroke-dash: 3
      fill: "#1a1a1a"
      font-color: "#aaaaaa"
    }
    
    src_64: "Offset + 0x40\n[256-bit / 32B]" {
      class: memory_cell
    }
    src_96: "Offset + 0x60\n[256-bit / 32B]" {
      class: memory_cell
    }
  }

  Future: {
    style: { stroke: transparent; fill: transparent }
    lookahead: "Prefetch Target\n(Offset + k)" {
      shape: cloud
      style: {
        fill: "#424242"
        stroke: "#9e9e9e"
        font-color: "#ffffff"
      }
    }
  }
}

CPU Core: {
  link: "#anchor-memcpy-engine"
  style: {
    fill: "#37474f"
    stroke: "#cfd8dc"
    stroke-width: 2
  }
  label: "CPU Execution Unit (Unrolled x4)"

  YMM Registers: {
    style: { stroke: transparent; fill: transparent }
    grid-rows: 4
    grid-gap: 10
    
    ymm0: "YMM0 (256-bit)" { class: reg }
    ymm1: "YMM1 (256-bit)" { class: reg }
    ymm2: "YMM2 (256-bit)" { class: reg }
    ymm3: "YMM3 (256-bit)" { class: reg }
  }

  Control: {
    class: control_node
    label: "Load / Store Unit"
  }
}

Destination Memory: {
  link: "#anchor-memcpy-engine"
  tooltip: "Aligned Destination Buffer (RAM)"

  Write Buffer: {
    label: "Write Combining Buffer"
    style: {
      stroke-dash: 3
      fill: "#1a1a1a"
      font-color: "#aaaaaa"
    }
    
    dst_0: "Dest + 0x00\n[Stream Store]" {
      class: memory_cell
      style.stroke: "#00e676"
    }
    dst_32: "Dest + 0x20\n[Stream Store]" {
      class: memory_cell
      style.stroke: "#00e676"
    }
    dst_64: "Dest + 0x40\n[Stream Store]" {
      class: memory_cell
      style.stroke: "#00e676"
    }
    dst_96: "Dest + 0x60\n[Stream Store]" {
      class: memory_cell
      style.stroke: "#00e676"
    }
  }
}

# --- Data Flow (Loads) ---
Source Memory.Cache Line N.src_0 -> CPU Core.YMM Registers.ymm0: "vmovaps" {
  style: { stroke: "#7e57c2"; stroke-width: 2 }
}
Source Memory.Cache Line N.src_32 -> CPU Core.YMM Registers.ymm1: "vmovaps" {
  style: { stroke: "#7e57c2"; stroke-width: 2 }
}
Source Memory.Cache Line N+1.src_64 -> CPU Core.YMM Registers.ymm2: "vmovaps" {
  style: { stroke: "#7e57c2"; stroke-width: 2 }
}
Source Memory.Cache Line N+1.src_96 -> CPU Core.YMM Registers.ymm3: "vmovaps" {
  style: { stroke: "#7e57c2"; stroke-width: 2 }
}

# --- Internal CPU Flow ---
CPU Core.YMM Registers.ymm0 -> CPU Core.Control
CPU Core.YMM Registers.ymm1 -> CPU Core.Control
CPU Core.YMM Registers.ymm2 -> CPU Core.Control
CPU Core.YMM Registers.ymm3 -> CPU Core.Control

# --- Data Flow (Stores) ---
CPU Core.Control -> Destination Memory.Write Buffer.dst_0: "vmovntps\n(No-Temporal)" {
  style: { stroke: "#00e676"; stroke-width: 2 }
}
CPU Core.Control -> Destination Memory.Write Buffer.dst_32: "vmovntps" {
  style: { stroke: "#00e676"; stroke-width: 2 }
}
CPU Core.Control -> Destination Memory.Write Buffer.dst_64: "vmovntps" {
  style: { stroke: "#00e676"; stroke-width: 2 }
}
CPU Core.Control -> Destination Memory.Write Buffer.dst_96: "vmovntps" {
  style: { stroke: "#00e676"; stroke-width: 2 }
}

# --- Prefetch ---
CPU Core.Control -> Source Memory.Future.lookahead: "prefetcht0" {
  style: { stroke: "#ffca28"; stroke-dash: 3; animated: true }
}