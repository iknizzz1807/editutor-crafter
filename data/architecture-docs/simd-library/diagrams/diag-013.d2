vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# ---------------------------------------------------------------------------------------
# GLOBAL CLASSES & STYLES
# ---------------------------------------------------------------------------------------
classes: {
  api_header: {
    style: {
      fill: "#1e1e2e"
      stroke: "#89b4fa"
      stroke-width: 4
      font-color: "#89b4fa"
      bold: true
    }
  }
  signature_box: {
    shape: class
    style: {
      fill: "#313244"
      stroke: "#fab387"
      font-color: "#cdd6f4"
    }
  }
  memory_byte: {
    style: {
      stroke: "#94e2d5"
      fill: "#45475a"
      font-size: 10
      font: mono
    }
  }
  reg_active: {
    style: {
      fill: "linear-gradient(to bottom, #f38ba8, #eba0ac)"
      stroke: "#f38ba8"
      bold: true
      font-color: "#11111b"
    }
  }
}

# ---------------------------------------------------------------------------------------
# SATELLITE VIEW: API CATEGORIES
# ---------------------------------------------------------------------------------------
Public_API_Surface: {
  label: "SIMD Library: Public API Surface"
  class: api_header

  Lifecycle: "Init & Feature Detection" {
    link: "#lifecycle-signatures"
  }
  Memory_IO: "Load/Store & Alignment" {
    link: "#memory-signatures"
  }
  Math_Kernels: "Arithmetic & FP Ops" {
    link: "#math-signatures"
  }
  Data_Shuffle: "Permute & Swizzle" {
    link: "#shuffle-signatures"
  }

  Lifecycle -> Memory_IO: "Setup Context"
  Memory_IO -> Math_Kernels: "Populate ZMM"
  Math_Kernels -> Data_Shuffle: "Intra-register Op"
}

# ---------------------------------------------------------------------------------------
# DEEP DIVE: UML FUNCTION SIGNATURES
# ---------------------------------------------------------------------------------------
lifecycle-signatures: "Lifecycle Signatures" {
  Core_API: {
    class: signature_box
    "simd_detect_cpu_features()": "uint64_t"
    "simd_init_context(uint32_t flags)": "simd_ctx_t*"
    "simd_get_error_string(int err)": "const char*"
    "simd_free_context(simd_ctx_t* ctx)": "void"
  }
}

memory-signatures: "Memory Access Signatures" {
  Memory_API: {
    class: signature_box
    "simd_load_f32_aligned(const float* p)": "v512_f32"
    "simd_load_f32_unaligned(const float* p)": "v512_f32"
    "simd_store_f32(float* p, v512_f32 v)": "void"
    "simd_stream_f32(float* p, v512_f32 v)": "void"
  }
}

math-signatures: "Arithmetic Signatures" {
  Arithmetic_API: {
    class: signature_box
    "simd_add_ps(v512_f32 a, v512_f32 b)": "v512_f32"
    "simd_sub_ps(v512_f32 a, v512_f32 b)": "v512_f32"
    "simd_fmadd_ps(v512_f32 a, v512_f32 b, v512_f32 c)": "v512_f32"
    "simd_sqrt_ps(v512_f32 a)": "v512_f32"
  }
}

# ---------------------------------------------------------------------------------------
# MICROSCOPE VIEW: STATE TRANSITIONS (Addition)
# ---------------------------------------------------------------------------------------
Op_State_Transition: {
  label: "State Transition: simd_add_ps (Vector Addition)"
  
  Before: {
    label: "T0: Operand Pointers"
    
    Ptr_A: {
      grid-columns: 4
      a0: "1.5" {class: memory_byte}
      a1: "2.0" {class: memory_byte}
      a2: "3.5" {class: memory_byte}
      a3: "4.0" {class: memory_byte}
    }
    Ptr_B: {
      grid-columns: 4
      b0: "0.5" {class: memory_byte}
      b1: "1.0" {class: memory_byte}
      b2: "0.5" {class: memory_byte}
      b3: "2.0" {class: memory_byte}
    }
  }

  ALU_Process: {
    label: "T1: Pipeline Dispatch"
    
    ZMM0_Result: {
      grid-columns: 4
      r0: "2.0" {class: reg_active}
      r1: "3.0" {class: reg_active}
      r2: "4.0" {class: reg_active}
      r3: "6.0" {class: reg_active}
    }
  }

  After: {
    label: "T2: Writeback to RAM"
    
    Result_Buffer: {
      grid-columns: 4
      res0: "2.0" {class: memory_byte}
      res1: "3.0" {class: memory_byte}
      res2: "4.0" {class: memory_byte}
      res3: "6.0" {class: memory_byte}
    }
  }

  Before.Ptr_A -> ALU_Process.ZMM0_Result: "simd_load"
  Before.Ptr_B -> ALU_Process.ZMM0_Result: "simd_add"
  ALU_Process.ZMM0_Result -> After.Result_Buffer: "simd_store"
}

# ---------------------------------------------------------------------------------------
# REGISTER MEMORY LAYOUT (Bit Level)
# ---------------------------------------------------------------------------------------
ZMM_Internal_Map: {
  label: "SIMD Register 512-bit Data Mapping"
  
  Register_File: {
    grid-columns: 8
    grid-gap: 0
    
    "dw0": "32-bit FP [0]" {class: memory_byte}
    "dw1": "32-bit FP [1]" {class: memory_byte}
    "dw2": "32-bit FP [2]" {class: memory_byte}
    "dw3": "32-bit FP [3]" {class: memory_byte}
    "dw4": "32-bit FP [4]" {class: memory_byte}
    "dw5": "32-bit FP [5]" {class: memory_byte}
    "dw6": "32-bit FP [6]" {class: memory_byte}
    "dw7": "32-bit FP [7]" {class: memory_byte}
    "dw8": "32-bit FP [8]" {class: memory_byte}
    "dw9": "32-bit FP [9]" {class: memory_byte}
    "dw10": "32-bit FP [10]" {class: memory_byte}
    "dw11": "32-bit FP [11]" {class: memory_byte}
    "dw12": "32-bit FP [12]" {class: memory_byte}
    "dw13": "32-bit FP [13]" {class: memory_byte}
    "dw14": "32-bit FP [14]" {class: memory_byte}
    "dw15": "32-bit FP [15]" {class: memory_byte}
  }
}

# ---------------------------------------------------------------------------------------
# USAGE PATTERN BLOCK
# ---------------------------------------------------------------------------------------
Usage_Example: |'md
### Typical Public API Workflow
cpp
// 1. Feature Detection
if (!(simd_detect_cpu_features() & AVX512_F)) {
    return fallback_impl();
}

// 2. Initialization
simd_ctx_t* ctx = simd_init_context(SIMD_DEBUG_LOGS);

// 3. Process Vectorized Loop
for (size_t i = 0; i < len; i += 16) {
    // Load data into registers
    v512_f32 a = simd_load_f32_aligned(&data_A[i]);
    v512_f32 b = simd_load_f32_aligned(&data_B[i]);
    
    // Execute arithmetic on public API
    v512_f32 res = simd_add_ps(a, b);
    
    // Store back to memory
    simd_store_f32(&output[i], res);
}

'| {
  near: bottom-right
}

# ---------------------------------------------------------------------------------------
# CROSS-REF LINKS
# ---------------------------------------------------------------------------------------
ZMM_Internal_Map.Register_File -> Op_State_Transition.ALU_Process.ZMM0_Result: "Architecture Mapping" {
  style: {
    stroke-dash: 5
    opacity: 0.4
    stroke: "#bac2de"
  }
}