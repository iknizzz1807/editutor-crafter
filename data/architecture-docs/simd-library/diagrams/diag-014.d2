direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

Title: "Non-Temporal Store Path (Bypassing Cache)" {
  shape: text
  style.font-size: 24
  near: top-center
}

# --- CPU Core ---
CPU: CPU Core {
  link: "#anchor-memcpy-engine"
  shape: package
  style.fill: "#f5f5f5"
  style.stroke: "#333333"

  AVX_Regs: "AVX Registers (YMM/ZMM)" {
    shape: rectangle
    style.fill: "#FFD700"
    style.stroke: "#DAA520"
    
    Payload: "Data (512-bit)" {
      shape: square
      style.fill: "#FFFACD"
      style.stroke: "#DAA520"
    }
  }
}

# --- Cache Path (Standard) ---
Cache_System: Cache Hierarchy {
  link: "#anchor-memcpy-engine"
  style.fill: transparent
  style.stroke-width: 0

  L1: L1 Cache {
    shape: rectangle
    style.fill: "#ffcccb"
    style.stroke: "#ff0000"
  }
  L2: L2 Cache {
    shape: rectangle
    style.fill: "#ff9999"
    style.stroke: "#cc0000"
  }
  L3: L3 Last Level Cache {
    shape: rectangle
    style.fill: "#ff6666"
    style.stroke: "#990000"
  }

  L1 -> L2
  L2 -> L3
}

# --- Non-Temporal Path ---
WCB: Write Combine Buffer {
  link: "#anchor-memcpy-engine"
  shape: queue
  style.fill: "#90EE90"
  style.stroke: "#006400"

  Slot_A: "Buffer A (64B)" { style.fill: "#ffffff" }
  Slot_B: "Buffer B (64B)" { style.fill: "#ffffff" }
}

# --- Main Memory ---
DRAM: System RAM {
  link: "#anchor-memcpy-engine"
  shape: cylinder
  style.fill: "#87CEFA"
  style.stroke: "#4682b4"
  
  Page_X: "Memory Page" { style.fill: "#e0f7fa" }
}

# --- Connections ---

# Path 1: Standard Store
CPU.AVX_Regs -> Cache_System.L1: "Standard Store\n(MOV)" {
  style.stroke: "#ff0000"
  style.stroke-width: 2
  label.font-color: "#ff0000"
}

Cache_System.L3 -> DRAM: "Cache Eviction / RFO" {
  style.stroke: "#ff0000"
  style.stroke-dash: 3
  label.font-color: "#ff0000"
}

# Path 2: Streaming Store (NT)
CPU.AVX_Regs -> WCB: "Non-Temporal Store\n(_mm_stream_si64)" {
  style.stroke: "#006400"
  style.stroke-width: 4
  label.font-color: "#006400"
}

WCB -> DRAM: "Direct Burst Write\n(Bypasses Cache)" {
  style.stroke: "#006400"
  style.stroke-width: 4
  label.font-color: "#006400"
}

# --- Explanatory Notes ---
Note_Pollution: "Standard Stores:\n1. Read For Ownership (RFO)\n2. Pollute L1/L2/L3 caches\n3. Evict useful data" {
  shape: sticky_note
  style.fill: "#ffebec"
  style.stroke: "#ff0000"
  near: Cache_System
  link: "#anchor-memcpy-engine"
}

Note_Stream: "Streaming Stores:\n1. Collect in WCB\n2. Wait for full cache line (64B)\n3. Write once to RAM" {
  shape: sticky_note
  style.fill: "#e8f5e9"
  style.stroke: "#006400"
  near: WCB
  link: "#anchor-memcpy-engine"
}