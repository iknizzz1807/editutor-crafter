vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: Checksum Algorithm Selector Strategy

User: User Application {
  shape: person
  link: "#anchor-checksum-core"
}

Library: SIMD Checksum Lib {
  link: "#anchor-checksum-core"
  style: {
    fill: "#ffffff"
    stroke-width: 2
    shadow: true
  }

  # The Facade
  API: Public Interface {
    shape: class
    label: "checksum(data, type)"
    link: "#anchor-checksum-core"
    style: {
      fill: "#e3f2fd"
    }
  }

  # The Resolver Mechanism
  Resolver: {
    link: "#anchor-checksum-core"
    shape: diamond
    label: "Dispatch Logic"
    style: {
      fill: "#fff3e0"
    }
    tooltip: "Selects implementation based on Algorithm choice AND Hardware availability"
  }

  # CPU Capabilities
  CPU Flags: {
    link: "#anchor-checksum-core"
    style.fill: "#f5f5f5"
    
    SSE42: "SSE4.2 (CRC32)" { 
        shape: step
        link: "#anchor-checksum-core"
    }
    PCLMUL: "PCLMULQDQ" { 
        shape: step 
        link: "#anchor-checksum-core"
    }
    AVX512: "AVX-512 VL" { 
        shape: step 
        link: "#anchor-checksum-core"
    }
  }

  # Implementation Pool
  Impls: Implementations {
    link: "#anchor-checksum-core"
    style.fill: "#f0f8ff"
    
    Fastest: PCLMUL Fold {
      label: "Parallel Fold\n(PCLMULQDQ)"
      shape: package
      link: "#anchor-checksum-core"
      style: {
        stroke: "#28a745"
        stroke-width: 2
        fill: "#ffffff"
      }
    }

    Fast: Hardware Instr {
      label: "Single Instruction\n(_mm_crc32_u64)"
      shape: package
      link: "#anchor-checksum-core"
      style: {
        stroke: "#17a2b8"
        stroke-width: 2
        fill: "#ffffff"
      }
    }

    Baseline: Scalar Table {
      label: "Slicing-by-8\n(Software LUT)"
      shape: package
      link: "#anchor-checksum-core"
      style: {
        stroke: "#6c757d"
        stroke-dash: 3
        fill: "#ffffff"
      }
    }
  }
}

# Connections
User -> Library.API: 1. Call
Library.API -> Library.Resolver: 2. Route

# Capability checks
Library.Resolver -> Library.CPU Flags: 3. Check Support
Library.CPU Flags -> Library.Resolver: bitmask

# Routing logic
Library.Resolver -> Library.Impls.Fastest: "Large Buffer &\nPCLMUL Support"
Library.Resolver -> Library.Impls.Fast: "Small Buffer or\nOnly SSE4.2"
Library.Resolver -> Library.Impls.Baseline: "Legacy CPU"