vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: down

Input: "Input Byte Stream" {
  shape: queue
  link: "#anchor-checksum-core"
  style.fill: "#e0e0e0"
}

Init: "Initialize Accumulators" {
  shape: rectangle
  link: "#anchor-checksum-core"
  tooltip: "Acc[0..3] = Prime Constants"
  style: {
    fill: "#b39ddb"
    stroke: "#512da8"
  }
}

SIMD_Loop: "AVX2 Processing Loop" {
  link: "#anchor-checksum-core"
  label: "Vector Loop (Process 32 Bytes)"
  style: {
    stroke-dash: 3
    fill: "#f5f5f5"
    stroke: "#757575"
  }

  State: "Accumulator State (4 x u64)" {
    shape: package
    style.fill: "#c8e6c9"
    
    Acc1: "Acc 1" { shape: cylinder }
    Acc2: "Acc 2" { shape: cylinder }
    Acc3: "Acc 3" { shape: cylinder }
    Acc4: "Acc 4" { shape: cylinder }
  }

  Input_Stripe: "Input Stripe (32 Bytes)" {
    shape: package
    style.fill: "#bbdefb"
    
    Lane1: "Lane 1" { shape: square }
    Lane2: "Lane 2" { shape: square }
    Lane3: "Lane 3" { shape: square }
    Lane4: "Lane 4" { shape: square }
  }

  Vector_Ops: "Parallel Arithmetic" {
    shape: rectangle
    style: {
      double-border: true
      fill: "#ffccbc"
    }

    step1: "Add" { shape: step }
    step2: "Mul Prime" { shape: step }
    step3: "Rotate" { shape: step }
    
    step1 -> step2 -> step3
  }

  Input_Stripe -> Vector_Ops.step1: "Load"
  State -> Vector_Ops.step1: "Read"
  Vector_Ops.step3 -> State: "Update"
}

Input -> SIMD_Loop.Input_Stripe: "Fetch 32B Block"
Init -> SIMD_Loop.State: "Set Primes"

Finalize: "Finalization" {
  link: "#anchor-checksum-core"
  style.fill: "#e1bee7"

  Merge: "Merge Accumulators" {
    shape: hexagon
    tooltip: "Fold 4 accumulators into 1 64-bit value"
    style.fill: "#ce93d8"
  }

  Avalanche: "Avalanche Cascade" {
    label: "Avalanche"
    style.fill: "#f8bbd0"
    
    mix1: "XOR-Shift" { shape: circle }
    mix2: "Mul Prime" { shape: circle }
    mix3: "XOR-Shift" { shape: circle }
    
    mix1 -> mix2 -> mix3
  }

  Merge -> Avalanche.mix1: "Seed"
}

SIMD_Loop.State -> Finalize.Merge
Finalize.Avalanche.mix3 -> Result: "xxHash64 Digest" {
  shape: parallelogram
  style: {
    fill: "#ffd700"
    stroke: "#f57f17"
    bold: true
  }
  link: "#anchor-checksum-core"
}