vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: down

link: "#anchor-checksum-core"

classes: {
  register_lane: {
    shape: rectangle
    width: 60
    height: 40
    style: {
      fill: "#e1f5fe"
      stroke: "#01579b"
      stroke-width: 2
    }
  }
  register_ghost: {
    shape: rectangle
    width: 60
    height: 40
    style: {
      fill: "#f5f5f5"
      stroke: "#bdbdbd"
      stroke-dash: 3
    }
  }
  operation_text: {
    shape: text
    style: {
      font-size: 14
      bold: true
      font-color: "#ff6f00"
    }
  }
  container_clean: {
    style: {
      fill: "transparent"
      stroke: "transparent"
    }
  }
}

# --- STEP 1: INITIAL STATE ---
Step 1: Input Vector (xmm0) {
  class: container_clean
  # Representing [D, C, B, A]
  lane3: D {class: register_lane}
  lane2: C {class: register_lane}
  lane1: B {class: register_lane}
  lane0: A {class: register_lane}
  
  lane3 -> lane2 -> lane1 -> lane0: {style.stroke-width: 0; arrow: false}
}

# --- OPERATION: SHUFFLE ---
OpShuffle: "1. Shuffle High Half (D,C) to Low" {
  class: operation_text
}

# --- STEP 2: ALIGNMENT ---
Step 2: Align for Vertical Add {
  class: container_clean
  
  Original: {
    l3: D {class: register_lane}
    l2: C {class: register_lane}
    l1: B {class: register_lane}
    l0: A {class: register_lane}
    l3 -> l2 -> l1 -> l0: {style.stroke-width: 0; arrow: false}
  }
  
  Copy: {
    l3: - {class: register_ghost}
    l2: - {class: register_ghost}
    l1: D {class: register_lane; style.fill: "#fff9c4"}
    l0: C {class: register_lane; style.fill: "#fff9c4"}
    l3 -> l2 -> l1 -> l0: {style.stroke-width: 0; arrow: false}
  }
}

# --- OPERATION: ADD ---
OpAdd1: "2. Vertical Add (SIMD)" {
  class: operation_text
}

# --- STEP 3: INTERMEDIATE ---
Step 3: Partial Sums {
  class: container_clean
  l3: - {class: register_ghost}
  l2: - {class: register_ghost}
  l1: B+D {class: register_lane; style.fill: "#c8e6c9"}
  l0: A+C {class: register_lane; style.fill: "#c8e6c9"}
  l3 -> l2 -> l1 -> l0: {style.stroke-width: 0; arrow: false}
}

# --- OPERATION: SHUFFLE & ADD ---
OpFinal: "3. Shuffle High (B+D) & Final Add" {
  class: operation_text
}

# --- STEP 4: RESULT ---
Step 4: Scalar Result {
  class: container_clean
  Result: (A+C) + (B+D) {
    class: register_lane
    width: 160
    style: {
      fill: "#ffccbc"
      stroke: "#d84315"
      bold: true
    }
  }
}

# --- FLOW CONNECTIONS ---
Step 1 -> OpShuffle
OpShuffle -> Step 2
Step 2 -> OpAdd1
OpAdd1 -> Step 3
Step 3 -> OpFinal
OpFinal -> Step 4

# --- LOGIC CONNECTIONS (Visualizing Data Movement) ---
# Move D and C down
Step 1.lane3 -> Step 2.Copy.l1: Copy {style.stroke-dash: 3; style.stroke: gray}
Step 1.lane2 -> Step 2.Copy.l0: Copy {style.stroke-dash: 3; style.stroke: gray}

# Add Logic
Step 2.Original.l1 -> Step 3.l1: +
Step 2.Copy.l1 -> Step 3.l1

Step 2.Original.l0 -> Step 3.l0: +
Step 2.Copy.l0 -> Step 3.l0

# Final Fold Logic
Step 3.l1 -> Step 4.Result: Add High
Step 3.l0 -> Step 4.Result: Add Low