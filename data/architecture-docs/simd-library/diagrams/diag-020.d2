vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  process_node: {
    style: {
      border-radius: 5
      fill: "#e1e4e8"
      stroke: "#24292e"
    }
  }
  phase_warmup: {
    style: {
      fill: "#ffdce0"
      stroke: "#cb2431"
      stroke-width: 2
    }
  }
  phase_measure: {
    style: {
      fill: "#dcffe4"
      stroke: "#22863a"
      stroke-width: 2
    }
  }
  data: {
    shape: cylinder
    style: {
      fill: "#dbedff"
      stroke: "#0366d6"
    }
  }
}

title: |md
  # Benchmark Harness Architecture
  The Scientific Method for Performance Testing
| {
  near: top-center
  link: "#anchor-benchmark"
}

Config: Benchmark Config {
  shape: package
  link: "#anchor-benchmark"
  tooltip: "Input Parameters: Iterations, Warmup Count"
}

Runner: Benchmark Runner {
  link: "#anchor-benchmark"
  style: {
    fill: "#f6f8fa"
    stroke: "#24292e"
    stroke-dash: 3
  }

  Warmup: Warmup Phase {
    class: [process_node; phase_warmup]
    label: "Warmup Loop\n(1000 iter)"
    link: "#anchor-benchmark"
  }

  Measure: Measurement Phase {
    class: [process_node; phase_measure]
    label: "Steady State Loop\n(1M iter)"
    link: "#anchor-benchmark"
  }

  Stopwatch: High Res Clock {
    shape: diamond
    style.fill: "#fff5b1"
    link: "#anchor-benchmark"
  }
  
  OptimizerTrap: Black Hole {
    label: "Anti-Optimizer\n(volatile sink)"
    shape: cloud
    link: "#anchor-benchmark"
    style: {
      fill: "#24292e"
      stroke: "#f6f8fa"
      font-color: "#f6f8fa"
    }
  }
}

SUT: Target Algorithm {
  shape: step
  link: "#anchor-benchmark"
  style: {
    fill: "#f1f8ff"
    stroke: "#0366d6"
    stroke-width: 2
  }
}

RawData: Timing Data {
  class: data
  link: "#anchor-benchmark"
}

Analyzer: Statistical Analysis {
  class: process_node
  link: "#anchor-benchmark"
  label: "Analyzer\n(Filter Outliers)"
}

Report: Final Speedup Report {
  shape: rectangle
  link: "#anchor-benchmark"
  style: {
    fill: "#fff"
    stroke: "#24292e"
    shadow: true
    double-border: true
  }
}

# Logic Flow
Config -> Runner.Warmup: "Initialize"

# Warmup Steps
Runner.Warmup -> SUT: "Call Function"
SUT -> Runner.OptimizerTrap: "Return Value"
Runner.OptimizerTrap -> Runner.Warmup: "Discard"

# Transition
Runner.Warmup -> Runner.Measure: "CPU Ready"

# Measurement Steps
Runner.Measure -> Runner.Stopwatch: "Start Timer"
Runner.Measure -> SUT: "Call Function"
SUT -> Runner.OptimizerTrap: "Return Value"
Runner.Measure -> Runner.Stopwatch: "Stop Timer"

# Analysis Flow
Runner.Stopwatch -> RawData: "Push Duration"
RawData -> Analyzer: "Input Series"
Analyzer -> Report: "Generate Metrics"

Legend: {
  link: "#anchor-benchmark"
  near: bottom-right
  style: {
    fill: white
    stroke: black
    stroke-width: 1
  }
  Key1: Warmup Phase {
    class: phase_warmup
    shape: square
    width: 20
    link: "#anchor-benchmark"
  }
  Key2: Measurement Phase {
    class: phase_measure
    shape: square
    width: 20
    link: "#anchor-benchmark"
  }
}