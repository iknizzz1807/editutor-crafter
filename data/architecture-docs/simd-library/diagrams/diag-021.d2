vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

classes: {
  public_zone: {
    style: {
      fill: "#e3f2fd"
      stroke: "#1e88e5"
      stroke-width: 2
    }
  }
  private_zone: {
    style: {
      fill: "#ffebee"
      stroke: "#e53935"
      stroke-dash: 5
    }
  }
  code_file: {
    shape: rectangle
    width: 180
    style: {
      fill: white
      stroke: "#546e7a"
      shadow: true
    }
  }
}

User Space: {
  link: "#anchor-integration"
  style: {
    fill: "#f3e5f5"
    stroke: "#8e24aa"
  }
  
  Application: {
    shape: package
    label: "User Application"
    
    main_cpp: "main.cpp" {
      class: code_file
      content: |cpp
        #include "simd_lib.h"
        
        int main() {
          simd_init();
          simd_dot_product(...);
        }
      |
    }
  }
}

Boundary: {
  shape: text
  label: "ABI / Linker Boundary"
  style.font-size: 16
  style.font-color: "#78909c"
}

SIMD Library: {
  link: "#anchor-integration"
  style: {
    fill: "#eceff1"
    stroke: "#455a64"
  }

  Public Face: {
    class: public_zone
    label: "The Dashboard (Public API)"
    
    header_file: "simd_lib.h" {
      class: code_file
      tooltip: "The only file the user sees"
      content: |cpp
        extern "C" {
          SIMD_API void simd_init();
          SIMD_API float dot_product(...);
        }
      |
    }
    
    export_table: "Exported Symbols" {
      shape: class
      # List the visible entry points
      "simd_init()"
      "simd_dot_product()"
      "simd_memcpy()"
    }
  }

  Hidden Internals: {
    class: private_zone
    label: "The Engine (Hidden Implementation)"

    Dispatcher: {
      shape: diamond
      label: "CPU Dispatcher"
      style.fill: "#fff9c4"
    }

    Kernels: {
      shape: package
      style.fill: white
      
      AVX512: "AVX-512 Kernel" {
        shape: rectangle
        style.fill: "#c8e6c9"
      }
      AVX2: "AVX2 Kernel" {
        shape: rectangle
        style.fill: "#a5d6a7"
      }
      SSE: "SSE Kernel" {
        shape: rectangle
        style.fill: "#81c784"
      }
    }
  }

  Public Face.export_table -> Hidden Internals.Dispatcher: "Function Pointer"
  Hidden Internals.Dispatcher -> Hidden Internals.Kernels.AVX512: "Resolves to (Skylake)"
  Hidden Internals.Dispatcher -> Hidden Internals.Kernels.AVX2: "Resolves to (Haswell)"
  Hidden Internals.Dispatcher -> Hidden Internals.Kernels.SSE: "Resolves to (Legacy)"
}

User Space.Application.main_cpp -> SIMD Library.Public Face.header_file: "#include"
User Space.Application.main_cpp -> SIMD Library.Public Face.export_table: "Links Against"

User Space -> Boundary: "Calls"
Boundary -> SIMD Library