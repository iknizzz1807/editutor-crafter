vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: Memory Alignment Strategy {
  link: "#anchor-avx-core"
  near: top-center
  shape: text
  style.font-size: 30
}

User App: {
  link: "#anchor-avx-core"
  shape: person
  label: Developer
}

Wrapper: {
  link: "#anchor-avx-core"
  shape: package
  label: "aligned_alloc(size, 32)"
  style: {
    stroke-width: 2
    fill: "#e3f2fd"
  }
}

OS Allocator: {
  link: "#anchor-avx-core"
  shape: cloud
  label: System Heap
}

Memory Layout: {
  link: "#anchor-avx-core"
  direction: right
  label: Physical Memory Representation
  
  style: {
    fill: "#f5f5f5"
    stroke: "#333"
    stroke-dash: 3
  }

  Raw Ptr: {
    link: "#anchor-avx-core"
    shape: square
    label: "0x1003"
    style: {
      fill: "#ffcdd2"
      stroke: "#c62828"
    }
    tooltip: Original pointer returned by malloc
  }

  Padding: {
    link: "#anchor-avx-core"
    shape: rectangle
    label: "Padding\n(29 bytes)"
    width: 120
    style: {
      fill-pattern: lines
      stroke: "#9e9e9e"
    }
  }

  Aligned Ptr: {
    link: "#anchor-avx-core"
    shape: square
    label: "0x1020"
    style: {
      fill: "#c8e6c9"
      stroke: "#2e7d32"
      stroke-width: 2
    }
    tooltip: Adjusted pointer (32-byte boundary)
  }

  Data Block: {
    link: "#anchor-avx-core"
    shape: queue
    label: "AVX-512 Data\n[ ... ]"
    width: 200
    style: {
      fill: "#e1bee7"
    }
  }

  Raw Ptr -> Padding: "Base Address"
  Padding -> Aligned Ptr: "+ Offset"
  Aligned Ptr -> Data Block: "Valid Access"
}

Pointer Arithmetic: {
  link: "#anchor-avx-core"
  shape: class
  label: "Micro-Logic: Bitwise Masking"
  
  code: |c
    size_t raw = (size_t)ptr;
    size_t align = 32;
    size_t mask = align - 1;
    // Step 1: Add worst-case padding
    // Step 2: Clear lower bits
    size_t aligned = (raw + mask) & ~mask;
  | {
    shape: code
  }
}

# Relationships
User App -> Wrapper: Request Memory
Wrapper -> OS Allocator: malloc(size + 32)
OS Allocator -> Wrapper: returns Raw Ptr
Wrapper -> Memory Layout: Adjusts Pointer
Memory Layout -> Pointer Arithmetic: Implements Logic
Wrapper -> User App: returns Aligned Ptr