classes: {
  matrix_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  register_style: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  operation_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

title: SIMD Matrix Multiplication Data Flow {
  near: top-center
  style.font-size: 18
  style.bold: true
  style.font-color: "#e6edf3"
}

input_matrices: Input Matrices {
  class: matrix_style
  
  matrix_a: ||md
    **Matrix A (4x4)**
    ```
    a00 a01 a02 a03
    a10 a11 a12 a13  
    a20 a21 a22 a23
    a30 a31 a32 a33
    ```
  ||
  
  matrix_b: ||md
    **Matrix B (4x4)**
    ```
    b00 b10 b20 b30
    b01 b11 b21 b31
    b02 b12 b22 b32
    b03 b13 b23 b33
    ```
  ||
}

simd_registers: SIMD Register Loading {
  class: register_style
  
  row_regs: ||md
    **Row Registers (128-bit)**
    XMM0: [a00|a01|a02|a03]
    XMM1: [a10|a11|a12|a13]
    XMM2: [a20|a21|a22|a23]
    XMM3: [a30|a31|a32|a33]
  ||
  
  col_regs: ||md
    **Column Registers (128-bit)**
    XMM4: [b00|b10|b20|b30]
    XMM5: [b01|b11|b21|b31]
    XMM6: [b02|b12|b22|b32]
    XMM7: [b03|b13|b23|b33]
  ||
}

dot_products: Dot Product Operations {
  class: operation_style
  
  broadcast: |md
    **Broadcast & Multiply**
    _mm_mul_ps()
    4 multiplies per instruction
  |
  
  horizontal_add: |md
    **Horizontal Add**
    _mm_hadd_ps()
    Sum vector elements
  |
}

accumulation: Result Accumulation {
  class: register_style
  
  result_regs: ||md
    **Accumulator Registers**
    XMM8: [c00|c01|c02|c03]
    XMM9: [c10|c11|c12|c13]
    XMM10: [c20|c21|c22|c23]
    XMM11: [c30|c31|c32|c33]
  ||
  
  final_add: |md
    **Final Addition**
    _mm_add_ps()
    Result += partial
  |
}

output: |md
  **Output Matrix C (4x4)**

  c00 c01 c02 c03
  c10 c11 c12 c13
  c20 c21 c22 c23
  c30 c31 c32 c33

  Each element = dot product of corresponding row and column
| {
  class: matrix_style
}

data_flow_note: ||md
  ## SIMD Data Flow Pattern
  
  **1. Vectorized Loading**
  - Load matrix rows/columns into 128-bit registers
  - 4 float32 elements per register
  
  **2. Parallel Computation**  
  - Single instruction operates on 4 elements
  - 4x speedup over scalar operations
  
  **3. Efficient Accumulation**
  - Horizontal operations reduce vectors to scalars
  - Multiple dot products computed simultaneously
|| {
  near: bottom-right
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}

input_matrices.matrix_a -> simd_registers.row_regs: Load rows into XMM0-3
input_matrices.matrix_b -> simd_registers.col_regs: Load columns into XMM4-7

simd_registers.row_regs -> dot_products.broadcast: Row data
simd_registers.col_regs -> dot_products.broadcast: Column data

dot_products.broadcast -> dot_products.horizontal_add: 4 products per cycle
dot_products.horizontal_add -> accumulation.result_regs: Partial sums

accumulation.result_regs -> accumulation.final_add: Current results
dot_products.horizontal_add -> accumulation.final_add: New partials

accumulation.final_add -> output: Store final matrix C
