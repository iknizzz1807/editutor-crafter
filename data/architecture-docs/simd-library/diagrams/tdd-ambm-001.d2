direction: right
vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
    sketch: false
  }
}

classes: {
  ptr_marker: {
    shape: circle
    style: {
      fill: white
      stroke-width: 2
    }
  }
  memory_segment: {
    style: {
      stroke-width: 1
      border-radius: 4
    }
  }
}

MemoryLayout: {
  label: "AMBM: Aligned Memory Layout"
  
  PhysicalAllocation: {
    grid-columns: 5
    grid-gap: 0
    
    RawPadding: "Pre-Alignment Padding" {
      class: memory_segment
      style.fill: "#f1f3f5"
    }

    MetadataSlot: "Metadata Area\n(AlignedBlockHeader)" {
      class: memory_segment
      style.fill: "#e9ecef"
      style.double-border: true
    }

    SimdData: "SIMD Aligned Buffer\n(User Data Area)" {
      class: memory_segment
      style: {
        fill: "#d4edda"
        stroke: "#28a745"
        stroke-width: 3
      }
    }

    TailPadding: "Tail-End Padding\n(for Safety Over-reads)" {
      class: memory_segment
      style.fill: "#fff3bf"
    }

    DeadZone: "Unused/Guard" {
      class: memory_segment
      style.fill: "#f8d7da"
    }
  }

  Pointers: {
    near: top-center
    
    malloc_ptr: "raw_ptr (void*)" {
      class: ptr_marker
      style.stroke: "#adb5bd"
    }
    
    aligned_ptr: "aligned_ptr (void*)" {
      class: ptr_marker
      style.stroke: "#28a745"
    }
    
    malloc_ptr -> PhysicalAllocation.RawPadding: "Base Address"
    aligned_ptr -> PhysicalAllocation.SimdData: "2^n Boundary"
  }

  HeaderDefinition: AlignedBlockHeader {
    shape: sql_table
    original_ptr: void* {constraint: "8 bytes"}
    requested_size: size_t {constraint: "8 bytes"}
    alignment_offset: uint32_t {constraint: "4 bytes"}
    magic_canary: 0xDEADBEEF {constraint: "4 bytes"}
    
    style.fill: "#dee2e6"
  }

  HeaderDefinition -> PhysicalAllocation.MetadataSlot: "Serialized into"
}

Constraints: {
  near: bottom-center
  
  alignment_rule: |md
    ### Alignment Logic
    - **Total Size**: `size + alignment + sizeof(void*)`
    - **Boundary**: `(start_addr + alignment - 1) & ~(alignment - 1)`
    - **Safety**: Tail padding enables vector loads without page faults
  | {
    shape: text
    style.font-size: 14
  }
}

# Relationship links
MemoryLayout.Pointers.aligned_ptr -> MemoryLayout.PhysicalAllocation.MetadataSlot: "offset = -sizeof(void*)" {
  style: {
    stroke-dash: 5
    stroke: grey
  }
}