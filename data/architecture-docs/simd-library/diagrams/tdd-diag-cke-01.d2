direction: down
vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
  }
  colors: {
    reg: "#e1f5fe"
    op: "#fff9c4"
    scalar: "#c8e6c9"
    text: "#263238"
  }
}

classes: {
  register_lane: {
    style: {
      fill: ${colors.reg}
      stroke: ${colors.text}
      stroke-width: 2
      font-size: 14
      bold: true
    }
  }
  simd_op: {
    shape: parallelogram
    style: {
      fill: ${colors.op}
      stroke: "#fbc02d"
      stroke-width: 2
      font-size: 12
    }
  }
  result_node: {
    shape: circle
    style: {
      fill: ${colors.scalar}
      stroke: "#2e7d32"
      stroke-width: 3
    }
  }
}

HorizontalReduction: {
  label: "SIMD Horizontal Reduction Tree (AVX-256 / 8x FP32)"

  Input_State: {
    label: "Step 0: Initial Vector Register (%ymm0)"
    grid-columns: 8
    grid-gap: 5
    v0.class: register_lane; v0.label: "Lane 0"
    v1.class: register_lane; v1.label: "Lane 1"
    v2.class: register_lane; v2.label: "Lane 2"
    v3.class: register_lane; v3.label: "Lane 3"
    v4.class: register_lane; v4.label: "Lane 4"
    v5.class: register_lane; v5.label: "Lane 5"
    v6.class: register_lane; v6.label: "Lane 6"
    v7.class: register_lane; v7.label: "Lane 7"
  }

  Stage_1: {
    label: "Step 1: 256-bit to 128-bit Fold"
    instruction: "vextractf128 + vaddps"
    instruction.class: simd_op
    
    output: {
      grid-columns: 4
      r0.class: register_lane; r0.label: "v0 + v4"
      r1.class: register_lane; r1.label: "v1 + v5"
      r2.class: register_lane; r2.label: "v2 + v6"
      r3.class: register_lane; r3.label: "v3 + v7"
    }
  }

  Stage_2: {
    label: "Step 2: 128-bit Horizontal Add"
    instruction: "vshufps + vaddps"
    instruction.class: simd_op

    output: {
      grid-columns: 2
      s0.class: register_lane; s0.label: "sum(0,2)"
      s1.class: register_lane; s1.label: "sum(1,3)"
    }
  }

  Stage_3: {
    label: "Step 3: Final Scalar Reduction"
    instruction: "vpermilps + vaddss"
    instruction.class: simd_op

    Final_Scalar: {
      class: result_node
      label: "Î£ v[0..7]"
    }
  }

  # Connections showing the tree reduction logic
  Input_State.v0 -> Stage_1.instruction: "Low 128"
  Input_State.v4 -> Stage_1.instruction: "High 128"
  Input_State.v1 -> Stage_1.instruction
  Input_State.v5 -> Stage_1.instruction
  Input_State.v2 -> Stage_1.instruction
  Input_State.v6 -> Stage_1.instruction
  Input_State.v3 -> Stage_1.instruction
  Input_State.v7 -> Stage_1.instruction

  Stage_1.instruction -> Stage_1.output

  Stage_1.output.r0 -> Stage_2.instruction
  Stage_1.output.r2 -> Stage_2.instruction: "Shuffle"
  Stage_1.output.r1 -> Stage_2.instruction
  Stage_1.output.r3 -> Stage_2.instruction: "Shuffle"

  Stage_2.instruction -> Stage_2.output

  Stage_2.output.s0 -> Stage_3.instruction
  Stage_2.output.s1 -> Stage_3.instruction

  Stage_3.instruction -> Stage_3.Final_Scalar
}

# Technical Details Link
Hardware_HDDE: {
  shape: package
  label: "mod-hardware-dispatch"
  link: "TDD_MOD_ID: mod-hardware-dispatch"
}

UVI_Interface: {
  shape: package
  label: "mod-unified-vector-interface"
  link: "TDD_MOD_ID: mod-unified-vector-interface"
}

HorizontalReduction -> Hardware_HDDE: "ISA Feature Check"
HorizontalReduction -> UVI_Interface: "Implements Vector::HorizontalSum()"