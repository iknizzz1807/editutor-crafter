direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

Hardware_Layer: {
  label: "Hardware Detection & Dispatch (HDDE)"
  style: {
    fill: "#f8f9fa"
    stroke: "#212529"
  }

  CPUFeatureSet: {
    shape: class
    x86_extensions: uint64_t
    arm_extensions: uint64_t
    cache_line_size: uint32_t
    logical_cores: uint32_t
  }

  KernelRegistry: {
    shape: class
    current_best_kernel: SimdKernel
    isa_level: uint32_t
    rank_comparison(): void
  }

  HDDE_Engine: {
    shape: class
    +probe_hardware(): CPUFeatureSet
    +dispatch_init(): void
    -resolve_ifunc(): void
  }
}

Memory_Layer: {
  label: "Aligned Memory & Buffer Manager (AMBM)"
  style: {
    fill: "#e9ecef"
    stroke: "#495057"
  }

  AlignedBlockHeader: {
    shape: class
    original_ptr: void*
    requested_size: size_t
    alignment_offset: uint32_t
    magic_canary: uint32_t
  }

  AlignedBufferManager: {
    shape: class
    +Allocate(size: size_t, align: size_t): void*
    +Free(ptr: void*): void
    +IsAligned(ptr: void*, align: size_t): bool
  }
}

Abstraction_Layer: {
  label: "Unified Vector Interface (UVI)"
  style: {
    fill: "#dee2e6"
    stroke: "#343a40"
  }

  Vector_T_N: {
    label: "Vector<T, N>"
    shape: class
    -data: InternalType
    +LoadAligned(ptr: T*): Vector
    +StoreNT(ptr: T*): void
    +MultiplyAdd(a: Vector, b: Vector, c: Vector): Vector
    +HorizontalSum(): T
  }

  SimdTraits: {
    shape: class
    NativeType: type
    Alignment: size_t
    ISA_Tag: string
  }
}

Execution_Layer: {
  label: "Compute Kernel Engine (CKE)"
  style: {
    fill: "#ced4da"
    stroke: "#212529"
  }

  KernelContext: {
    shape: class
    src_a: const float*
    src_b: const float*
    out: float*
    length: size_t
    prefetch_distance: uint32_t
  }

  DotProductKernel: {
    shape: class
    -acc0: Vector
    -acc1: Vector
    -acc2: Vector
    -acc3: Vector
    +Initialize(): void
    +Step(a: T*, b: T*): void
    +Finalize(): T
  }

  IterationEngine: {
    shape: class
    +execute_pipeline(ctx: KernelContext): T
    -handle_tail_scalar(): void
    -apply_loop_peeling(): void
  }
}

# Pipeline Flow & Relationships
Hardware_Layer.HDDE_Engine -> Hardware_Layer.KernelRegistry: "Initializes"
Hardware_Layer.KernelRegistry -> Execution_Layer.IterationEngine: "Routes execution to"

Memory_Layer.AlignedBufferManager -> Execution_Layer.KernelContext: "Guarantees alignment for"
Memory_Layer.AlignedBufferManager.Allocate -> Memory_Layer.AlignedBlockHeader: "Creates"

Execution_Layer.IterationEngine -> Execution_Layer.DotProductKernel: "Orchestrates loops"
Execution_Layer.DotProductKernel -> Abstraction_Layer.Vector_T_N: "Invokes SIMD Ops"

Abstraction_Layer.SimdTraits -- Abstraction_Layer.Vector_T_N: "Specializes"
Abstraction_Layer.Vector_T_N -> Memory_Layer.AlignedBufferManager: "Validates PTR"

# Global Styles
***.style.font-size: 14
***.style.border-radius: 4

OS_Kernel: "OS Memory (malloc/mmap)" {
  shape: cloud
  link: "https://man7.org/linux/man-pages/man2/mmap.2.html"
}

Memory_Layer.AlignedBufferManager -> OS_Kernel: "Low-level alloc"
Hardware_Layer.HDDE_Engine -> OS_Kernel: "cpuid/auxv probing"