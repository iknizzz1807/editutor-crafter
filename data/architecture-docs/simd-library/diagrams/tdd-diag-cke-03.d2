vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

# --- Style Definitions ---
classes: {
  interface: {
    style: {
      stroke-width: 2
      fill: "#e3f2fd"
      border-radius: 5
    }
  }
  logic_component: {
    style: {
      fill: "#f5f5f5"
      stroke: "#424242"
      double-border: true
    }
  }
  hardware_layer: {
    style: {
      fill: "#fff3e0"
      stroke: "#ef6c00"
      stroke-dash: 3
    }
  }
}

# --- Module Structure ---
MaskedOperationLogic: {
  link: "mod-unified-vector-interface"
  
  ControlFlow: {
    label: "Compute Kernel Engine: Tail Processor"
    class: logic_component
    
    IterationEngine: {
        shape: class
        - current_index: size_t
        - remaining_elements: size_t
        + process_tail(ctx: KernelContext): void
    }
  }

  AbstractionLayer: {
    label: "Unified Vector Interface (UVI)"
    class: interface
    
    MaskFactory: {
      shape: class
      + CreateMask(count: size_t): uint64_t {
        tooltip: "Generates bitmask where first 'count' bits are 1"
      }
    }
    
    MaskedVector: {
      shape: class
      + LoadMasked(ptr: T*, mask: uint64_t): Vector<T, N>
      + StoreMasked(ptr: T*, mask: uint64_t): void
      + OpMasked(v2: Vector, mask: uint64_t): Vector
    }
  }

  HardwareIntrinsics: {
    label: "Hardware Execution Units"
    class: hardware_layer
    
    AVX512_K_Registers: {
      shape: square
      label: "Opmask Registers (k0-k7)"
    }
    
    SVE_Predicate: {
      shape: square
      label: "ARM SVE P-Registers"
    }
  }
}

# --- Sequence Flow: Masked Execution ---
ExecutionFlow: {
  shape: sequence_diagram
  
  TailHandler: "Tail Handler"
  MaskGen: "Mask Factory"
  VReg: "SIMD Register"
  Memory: "Aligned Buffer"

  TailHandler -> MaskGen: CalculateMask(remaining = 3)
  MaskGen -> TailHandler: bitmask (0b00000111)
  
  group Load Phase {
    TailHandler -> Memory: Prefetch(tail_addr)
    TailHandler -> VReg: _mm512_mask_load_ps(mask)
    VReg <- Memory: "Lanes [0-2] Active"
  }

  group Compute Phase {
    TailHandler -> VReg: MaskedAdd(v1, v2, mask)
    VReg -> VReg: "ALU suppressed for lanes [3-15]"
  }

  group Store Phase {
    TailHandler -> Memory: _mm512_mask_store_ps(mask)
    Memory <- VReg: "Boundary-safe write"
    note right: "Prevents SIGSEGV at buffer end"
  }
}

# --- Relationships ---
MaskedOperationLogic.ControlFlow.IterationEngine -> MaskedOperationLogic.AbstractionLayer.MaskFactory: "1. Request Predicate"
MaskedOperationLogic.AbstractionLayer.MaskFactory -> MaskedOperationLogic.AbstractionLayer.MaskedVector: "2. Bind Mask"
MaskedOperationLogic.AbstractionLayer.MaskedVector -> MaskedOperationLogic.HardwareIntrinsics: "3. Map to K-Regs"

# Global Glob for aesthetics
***.style.font: mono