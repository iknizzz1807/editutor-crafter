direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    layer0: "#ffeb3b"
    layer1: "#03a9f4"
    layer2: "#4caf50"
    cpu: "#f44336"
  }
}

# Classes for styling
classes: {
  prober_style: {
    style: {
      fill: ${colors.layer0}
      stroke-width: 2
      bold: true
    }
  }
  registry_style: {
    style: {
      fill: ${colors.layer1}
      stroke-width: 2
      bold: true
    }
  }
  dispatcher_style: {
    style: {
      fill: ${colors.layer2}
      stroke-width: 2
      bold: true
    }
  }
  hardware_style: {
    shape: cylinder
    style: {
      fill: ${colors.cpu}
      font-color: white
    }
  }
}

runtime_discovery: {
  shape: sequence_diagram
  
  application: Application
  
  hdde_dispatcher: Dispatcher {
    class: dispatcher_style
    link: "layers.mod-hardware-dispatch"
  }
  
  hdde_registry: Registry {
    class: registry_style
  }
  
  hdde_prober: Prober {
    class: prober_style
  }
  
  cpu_hardware: CPU (x86/ARM) {
    class: hardware_style
  }

  simd_kernel: SIMD Implementation {
    style.multiple: true
  }

  application -> hdde_dispatcher: execute_simd_op(src, dst, len)
  
  hot_path_init: {
    hdde_dispatcher -> hdde_dispatcher: atomic_load(global_dispatch_ptr)
    
    initialization_block: {
      hdde_dispatcher."If ptr is NULL (Lazy Init)"
      
      hdde_dispatcher -> hdde_prober: probe_hardware()
      
      instruction_set_check: {
        hdde_prober -> cpu_hardware: cpuid (x86) / mrs (ARM)
        hdde_prober <- cpu_hardware: feature_bits
      }
      
      hdde_prober -> hdde_registry: set_hardware_state(bits)
      
      registry_update: {
        hdde_registry -> hdde_registry: update CPUFeatureSet {
          tooltip: "Pack bits for AVX-512, NEON, SVE"
        }
      }
      
      hdde_dispatcher <- hdde_prober: CPUFeatureSet
      
      rank_and_bind: {
        hdde_dispatcher -> hdde_dispatcher: resolve_best_fit()
        hdde_dispatcher -> hdde_dispatcher: atomic_store(global_dispatch_ptr, kernel_addr)
      }
    }
  }

  execution_phase: {
    hdde_dispatcher -> simd_kernel: func(src, dst, len) {
      style.animated: true
      style.stroke: "#4caf50"
    }
    
    hdde_dispatcher <- simd_kernel: return void
  }

  application <- hdde_dispatcher: op_complete
}

# Metadata and Relationship mapping
hdde_logic: {
  CPUFeatureSet: {
    shape: sql_table
    x86_extensions: uint64_t
    arm_extensions: uint64_t
    cache_line_size: uint32_t
    logical_cores: uint32_t
  }
  
  KernelRegistry: {
    shape: class
    current_best_kernel: SimdKernel
    isa_level: uint32_t
  }

  hdde_registry -> CPUFeatureSet: manages
  hdde_dispatcher -> KernelRegistry: utilizes
  
  # Links to other modules
  hdde_dispatcher -> AMBM: validate alignment {
    style.stroke-dash: 5
  }
}

AMBM: Aligned Memory & Buffer Manager {
  link: "layers.mod-memory-management"
}

UVI: Unified Vector Interface {
  link: "layers.mod-unified-vector-interface"
}

hdde_dispatcher -> UVI: requests native type mappings