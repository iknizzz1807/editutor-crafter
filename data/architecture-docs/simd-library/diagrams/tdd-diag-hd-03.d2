direction: right
vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
    sketch: false
  }
}

# -----------------------------------------------------------------------------
# STRUCT DEFINITIONS
# -----------------------------------------------------------------------------
CPUFeatureSet: {
  shape: class
  +x86_extensions: uint64_t
  +arm_extensions: uint64_t
  +cache_line_size: uint32_t
  +logical_cores: uint32_t
  
  # Memory Layout Info
  style.fill: "#f1f3f5"
}

KernelRegistry: {
  shape: class
  +current_best_kernel: SimdKernel*
  +isa_level: uint32_t
  
  +RegisterKernel(level: uint, ptr: void*): void
  style.fill: "#f1f3f5"
}

# -----------------------------------------------------------------------------
# MAIN DISPATCHER MODULE
# -----------------------------------------------------------------------------
HDDE: Hardware Detection & Dispatch Engine {
  style: {
    stroke: "#228be6"
    stroke-width: 4
    fill: "#f8f9fa"
  }

  # ---------------------------------------------------------------------------
  # DISPATCHER STRATEGY STATE MACHINE
  # ---------------------------------------------------------------------------
  Strategy_State_Machine: {
    label: "Dispatcher Execution Strategy"
    
    COLD: Uninitialized {
      shape: circle
      tooltip: "global_dispatch_ptr == nullptr"
      style.fill: "#ced4da"
    }

    PROBING: ISA Feature Extraction {
      tooltip: "Executing cpuid / mrs instructions"
      style.fill: "#a5d8ff"
      
      Entry: {
        shape: text
        label: "Invoke Architecture Probers"
      }
    }

    BINDING: Runtime Pointer Resolution {
      tooltip: "Selecting best-fit kernel and atomic swapping"
      style.fill: "#ffec99"
      
      Logic: |md
        - Compare Rank
        - Atomic Store (Release)
      |
    }

    HOT_PATH: Optimized Execution {
      style.double-border: true
      style.fill: "#b2f2bb"
      
      HotLoop: |md
        - Acquire Load
        - Tail-Call Jump
      |
    }

    # Transitions
    COLD -> PROBING: First Call / Constructor
    PROBING -> BINDING: FeatureBits Validated
    BINDING -> HOT_PATH: Atomic CAS Success
    HOT_PATH -> HOT_PATH: Runtime Invariant Path
  }

  # ---------------------------------------------------------------------------
  # INTERNAL COMPONENTS
  # ---------------------------------------------------------------------------
  Layer0_Prober: {
    label: "Layer 0: ASM Prober"
    
    methods: {
      get_x86_features()
      get_arm_auxv()
    }
  }

  Layer1_Registry: {
    label: "Layer 1: Immutable Registry"
    data: CPUFeatureSet
    registry: KernelRegistry
  }

  Layer2_Dispatcher: {
    label: "Layer 2: FMV Bridge"
    ifunc_resolver: "__attribute__((ifunc))"
    hot_entry: "execute_simd_op()"
  }

  # Internal Relationships
  Layer2_Dispatcher -> Layer1_Registry: "Check Rank"
  Layer1_Registry -> Layer0_Prober: "Read bits"
}

# -----------------------------------------------------------------------------
# EXTERNAL MODULE RELATIONSHIPS
# -----------------------------------------------------------------------------
AMBM: Aligned Memory & Buffer Manager {
  link: "mod-memory-management"
  style.stroke-dash: 5
}

UVI: Unified Vector Interface {
  link: "mod-unified-vector-interface"
  style.stroke-dash: 5
}

HDDE.Layer2_Dispatcher -> AMBM: "Validate Alignment (ptr & align-1)"
HDDE.Layer2_Dispatcher -> UVI: "Route to Specialized Intrinsic"

# -----------------------------------------------------------------------------
# LEGEND / FOOTER
# -----------------------------------------------------------------------------
Legend: {
  near: bottom-right
  
  State_Transition: {
    shape: text
    label: "Control Flow"
    style.font-color: "#228be6"
  }
  Dependency: {
    shape: text
    label: "Interface Call"
    style.stroke-dash: 3
  }
}

title: |md
  # HDDE: Dispatcher Strategy State Machine
  *Deterministic ISA Selection and Zero-Overhead Routing*
| {
  near: top-center
}