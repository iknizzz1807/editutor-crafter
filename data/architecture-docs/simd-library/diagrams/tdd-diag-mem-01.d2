direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  struct: {
    shape: sql_table
    style: {
      fill: "#f8f9fa"
      stroke: "#495057"
    }
  }
  logic: {
    shape: class
    style: {
      fill: "#e7f5ff"
      stroke: "#228be6"
    }
  }
  memory_segment: {
    style: {
      stroke-width: 2
      border-radius: 4
      text-transform: uppercase
      font: mono
    }
  }
}

AMBM: Aligned Memory & Buffer Manager {
  
  AlignedBlockHeader: {
    class: struct
    original_ptr: void* {constraint: "8 bytes"}
    requested_size: size_t {constraint: "8 bytes"}
    alignment_offset: uint32_t {constraint: "4 bytes"}
    magic_canary: uint32_t {constraint: "4 bytes (0xDEADBEEF)"}
  }

  Manager: AlignedBufferManager {
    class: logic
    + Allocate(size: size_t, align: size_t): void*
    + Free(ptr: void*): void
    + IsAligned(ptr: void*, align: size_t): bool
    - compute_padding(raw: uintptr_t, align: size_t): size_t
  }

  MemoryLayout: {
    grid-columns: 5
    grid-gap: 10
    
    RawStart: "Heap Allocation (malloc)" {
      class: memory_segment
      style.fill: "#dee2e6"
    }
    
    Padding: "Padding / Offset" {
      class: memory_segment
      style.fill: "#f1f3f5"
      style.stroke-dash: 3
    }

    Metadata: "Header / Metadata" {
      class: memory_segment
      style.fill: "#ffec99"
    }

    AlignedPtr: "Aligned Boundary" {
      class: memory_segment
      style.fill: "#b2f2bb"
      style.double-border: true
    }

    Data: "SIMD Data Payload" {
      class: memory_segment
      style.fill: "#a5d8ff"
      width: 200
    }
  }

  # Internal Relationships
  Manager -> AlignedBlockHeader: "calculates offset & stores"
  Manager -> MemoryLayout.RawStart: "1. Request total_size"
  Manager -> MemoryLayout.Metadata: "2. Write header"
  Manager -> MemoryLayout.AlignedPtr: "3. Return to user"
  
  # Structural pointer relationships
  MemoryLayout.Metadata -> AlignedBlockHeader: "maps to"
  MemoryLayout.AlignedPtr -> MemoryLayout.Metadata: "offset -sizeof(void*)" {
    style.stroke-dash: 5
  }
}

# Link to External Module
OS_Kernel: System Allocator {
  link: "https://man7.org/linux/man-pages/man3/malloc.3.html"
  style.fill: transparent
}

AMBM.Manager -> OS_Kernel: "mmap / posix_memalign" {
  style.animated: true
}

# Global Labels
Legend: {
  near: bottom-right
  note: |md
    ### Constraints
    - Alignment must be $2^n$
    - Header stored at `ptr - 8`
    - Supports AVX-512 (64B)
  |
}