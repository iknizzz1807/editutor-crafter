shape: sequence_diagram

vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
  }
}

User: User Application
RAII: AlignedVector<T>\n(RAII Wrapper)
AMBM: AlignedMemoryManager\n(Module Logic)
OS: Operating System\n(Heap Allocator)
CKE: ComputeKernelEngine

User -> RAII: Construct(size, align)
RAII.t1 -> AMBM.t1: Allocate(size, align)

AMBM.t1 -> AMBM.t1: Calculate total_size\n(size + align + metadata)
AMBM.t1 -> OS.t1: malloc(total_size)
AMBM.t1 <- OS.t1: raw_ptr

note: {
  near: AMBM.t1
  label: |md
    **Pointer Arithmetic**
    `aligned_addr = (raw + align) & ~(align - 1)`
    Store `raw_ptr` at `aligned_addr - sizeof(void*)`
  |
}

RAII.t1 <- AMBM.t1: aligned_ptr
User <- RAII: Buffer Ready

User -> CKE: Process(buffer)
CKE.t1 -> CKE.t1: SIMD Hot Path\n(Vector Load/Store)
User <- CKE: Result

User -> RAII: Destructor / Out of Scope
RAII.t2 -> AMBM.t2: Free(aligned_ptr)

AMBM.t2 -> AMBM.t2: Retrieve Metadata\n(original_ptr)
AMBM.t2 -> OS.t2: free(original_ptr)
AMBM.t2 <- OS.t2

RAII.t2 <- AMBM.t2
User <- RAII: Memory Reclaimed

# Styling for technical aesthetic
RAII.style.stroke: "#3498db"
AMBM.style.stroke: "#e67e22"
OS.style.stroke: "#2ecc71"
CKE.style.stroke: "#9b59b6"

RAII.style.stroke-width: 2
AMBM.style.stroke-width: 2

(RAII.t1 -> AMBM.t1).style.bold: true
(AMBM.t1 -> OS.t1).style.stroke-dash: 3
(RAII.t2 -> AMBM.t2).style.stroke: red