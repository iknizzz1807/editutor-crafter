direction: right

vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
  }
}

classes: {
  template_class: {
    shape: class
    style: {
      stroke: "#2b579a"
      fill: "#f8f9fa"
      stroke-width: 2
    }
  }
  hardware_type: {
    shape: class
    style: {
      stroke: "#ae4132"
      fill: "#fff2f2"
      font-color: "#ae4132"
      stroke-dash: 3
    }
  }
  internal_logic: {
    style: {
      fill: "#f5f5f5"
      stroke: "#cccccc"
      border-radius: 10
    }
  }
}

VectorAbstraction: Unified Vector Interface (UVI) {
  style.fill: "#f1f4f9"
  
  Layer0_Traits: Hardware Mapping Layer {
    class: internal_logic
    
    SimdTraits: {
      shape: class
      label: "SimdTraits<T, N>"
      definition: "template <typename T, size_t N>"
      +NativeType: "typename"
      +Alignment: "static constexpr size_t"
      +ISA_Label: "static constexpr const char*"
    }

    AVX_Specialization: {
      shape: class
      label: "SimdTraits<float, 8>"
      NativeType: "__m256"
      Alignment: "32"
      ISA: "AVX2"
    }

    NEON_Specialization: {
      shape: class
      label: "SimdTraits<float, 4>"
      NativeType: "float32x4_t"
      Alignment: "16"
      ISA: "NEON"
    }

    AVX_Specialization -> SimdTraits: "<<specializes>>" {
      target-arrowhead: {
        shape: triangle
        style.filled: false
      }
    }
    NEON_Specialization -> SimdTraits: "<<specializes>>" {
      target-arrowhead: {
        shape: triangle
        style.filled: false
      }
    }
  }

  Layer2_PublicAPI: High-Level Vector API {
    class: internal_logic
    
    Vector: {
      shape: class
      label: "Vector<T, N>"
      class: template_class
      
      -data: "InternalType"
      
      +Load(ptr: const T*): "static Vector"
      +LoadAligned(ptr: const T*): "static Vector"
      +Store(ptr: T*): "void"
      +operator+(other: Vector): "Vector"
      +MultiplyAdd(a: Vector, b: Vector, c: Vector): "static Vector"
    }
  }

  NativeRegisters: Hardware Intrinsics {
    x86_reg: __m256 { class: hardware_type }
    arm_reg: float32x4_t { class: hardware_type }
  }
}

# Relationships
VectorAbstraction.Layer2_PublicAPI.Vector -> VectorAbstraction.Layer0_Traits.SimdTraits: "<<queries traits>>"
VectorAbstraction.Layer0_Traits.AVX_Specialization -> VectorAbstraction.NativeRegisters.x86_reg: "<<typedefs>>"
VectorAbstraction.Layer0_Traits.NEON_Specialization -> VectorAbstraction.NativeRegisters.arm_reg: "<<typedefs>>"

# Link to HDDE Module
VectorAbstraction.Layer0_Traits.SimdTraits -> HDDE: "Query ISA" {
  style: {
    stroke-dash: 5
  }
}

HDDE: Hardware Detection & Dispatch Engine {
  link: "mod-hardware-dispatch"
  shape: package
}

# Link to Memory Management
VectorAbstraction.Layer2_PublicAPI.Vector.LoadAligned -> AMBM: "Verify Alignment" {
  style: {
    stroke-dash: 5
  }
}

AMBM: Aligned Memory & Buffer Manager {
  link: "mod-memory-management"
  shape: package
}

# Styling for Methods and Fields
VectorAbstraction.Layer2_PublicAPI.Vector.style.font-size: 14
VectorAbstraction.Layer0_Traits.SimdTraits.style.font-size: 14