direction: right

vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
  }
}

classes: {
  interface: {
    shape: class
    style: {
      fill: "#E1F5FE"
      stroke: "#01579B"
    }
  }
  internal: {
    shape: class
    style: {
      fill: "#FFF3E0"
      stroke: "#E65100"
    }
  }
  hardware: {
    shape: rectangle
    style: {
      fill: "#ECEFF1"
      stroke: "#263238"
      double-border: true
    }
  }
}

UVI_Module: Unified Vector Interface {
  style.fill: "#F5F5F5"

  Vector: {
    class: interface
    label: "Vector<T, N>"
    
    +data: InternalType
    +Load(ptr: T*): Vector
    +Store(ptr: T*)
    +operator+(other: Vector): Vector
    +MultiplyAdd(a: V, b: V, c: V): V
  }

  Traits_Resolver: {
    class: internal
    label: "SimdTraits<T, N>"
    
    +NativeType: typedef
    +Alignment: size_t
    +ISA_String: const char*
  }

  Intrinsic_Wrappers: {
    class: internal
    
    simd_add_ps(a, b)
    simd_load_aligned(ptr)
    simd_fma_ps(a, b, c)
  }
}

Architecture_Mapping: {
  grid-columns: 2
  horizontal-gap: 100

  X86_Path: {
    label: "x86 Implementation (AVX-256)"
    AVX_Traits: {
      shape: code
      language: cpp
      value: |cpp
        template<> struct SimdTraits<float, 8> {
          using NativeType = __m256;
          static constexpr size_t Alignment = 32;
        };
      |
    }
    YMM_Regs: YMM Registers {
      class: hardware
      label: "256-bit Register File"
    }
  }

  ARM_Path: {
    label: "ARM Implementation (NEON)"
    NEON_Traits: {
      shape: code
      language: cpp
      value: |cpp
        template<> struct SimdTraits<float, 4> {
          using NativeType = float32x4_t;
          static constexpr size_t Alignment = 16;
        };
      |
    }
    V_Regs: V Registers {
      class: hardware
      label: "128-bit Register File"
    }
  }
}

# Relationships
UVI_Module.Vector -> UVI_Module.Traits_Resolver: "Resolves InternalType via"
UVI_Module.Vector -> UVI_Module.Intrinsic_Wrappers: "Delegates to"

UVI_Module.Traits_Resolver -> Architecture_Mapping.X86_Path.AVX_Traits: "Specializes"
UVI_Module.Traits_Resolver -> Architecture_Mapping.ARM_Path.NEON_Traits: "Specializes"

Architecture_Mapping.X86_Path.AVX_Traits -> Architecture_Mapping.X86_Path.YMM_Regs: "Maps to"
Architecture_Mapping.ARM_Path.NEON_Traits -> Architecture_Mapping.ARM_Path.V_Regs: "Maps to"

# External Linkage
UVI_Module.Traits_Resolver.link: "mod-hardware-dispatch"
UVI_Module.Vector.link: "mod-memory-management"

legend: {
  near: bottom-right
  class_definition: {
    shape: rectangle
    class_label: "Public API" { style.fill: "#E1F5FE" }
    internal_label: "Translation Layer" { style.fill: "#FFF3E0" }
    hardware_label: "Physical Register" { style.fill: "#ECEFF1" }
  }
}