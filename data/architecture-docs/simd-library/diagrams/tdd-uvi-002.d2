vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

classes: {
  module: {
    style: {
      stroke-width: 2
      border-radius: 8
    }
  }
  struct: {
    shape: sql_table
  }
  hot_path: {
    style: {
      stroke: "#ff4d4d"
      stroke-width: 4
      animated: true
    }
  }
  simd_reg: {
    style: {
      fill: "#e6f3ff"
      bold: true
    }
  }
}

SIMD_Pipelining_Architecture: {
  
  Memory_Subsystem: {
    class: module
    label: "Aligned Memory & Buffer Manager (AMBM)"
    
    AlignedBlockHeader: {
      class: struct
      original_ptr: void*
      requested_size: size_t
      alignment_offset: uint32_t
      magic_canary: uint32_t
    }

    Source_A: "Source Buffer A (alignas 64)" {
      shape: cylinder
      style.fill: "#f9f9f9"
    }
    Source_B: "Source Buffer B (alignas 64)" {
      shape: cylinder
      style.fill: "#f9f9f9"
    }
  }

  Compute_Kernel_Engine: {
    class: module
    label: "Compute Kernel Engine (CKE)"

    KernelContext: {
      class: struct
      src_a: "const float* __restrict"
      src_b: "const float* __restrict"
      out: "float* __restrict"
      length: size_t
      prefetch_distance: uint32_t
    }

    Execution_Loop: {
      direction: down
      
      Prefetcher: "Software Prefetching (L1/L2)" {
        tooltip: "__builtin_prefetch"
      }
      
      Unrolled_Worker: "4x Unrolled Logic" {
        acc0: Vector Accumulator 0
        acc1: Vector Accumulator 1
        acc2: Vector Accumulator 2
        acc3: Vector Accumulator 3
      }

      Tail_Handler: "Tail Handling" {
        Masked_Logic: "Masked Load/Store (AVX-512/SVE)"
        Scalar_Fallback: "Scalar Loop"
      }
    }
  }

  Unified_Vector_Interface: {
    class: module
    label: "Unified Vector Interface (UVI)"

    Vector_T_N: {
      shape: class
      InternalType: Native SIMD Register
      +LoadAligned(ptr: T*): Vector
      +FusedMultiplyAdd(a: V, b: V, c: V): Vector
      +StoreNT(ptr: T*): void
      +HorizontalSum(): T
    }
  }

  Hardware_Abstraction_Layer: {
    label: "Hardware Dispatch (HDDE)"
    
    ISA_Registry: {
      class: struct
      x86_extensions: uint64_t
      arm_extensions: uint64_t
    }
    
    Dispatch_PTR: "std::atomic<SimdKernel>" {
      shape: circle
    }
  }

  # Relationships & Hot Path
  Memory_Subsystem.Source_A -> Compute_Kernel_Engine.Execution_Loop.Prefetcher: "High Bandwidth Stream" { class: hot_path }
  Memory_Subsystem.Source_B -> Compute_Kernel_Engine.Execution_Loop.Prefetcher: "High Bandwidth Stream" { class: hot_path }

  Compute_Kernel_Engine.Execution_Loop.Prefetcher -> Unified_Vector_Interface.Vector_T_N: "LoadAligned()"
  
  Unified_Vector_Interface.Vector_T_N -> Compute_Kernel_Engine.Execution_Loop.Unrolled_Worker: "Intrinsic Collapse" {
    style.stroke-dash: 5
  }

  Hardware_Abstraction_Layer.Dispatch_PTR -> Compute_Kernel_Engine: "Dynamic Function Routing"
  
  Compute_Kernel_Engine.Execution_Loop.Unrolled_Worker -> Hardware_Layer.Registers: "Vector Pipeline Saturation" { class: hot_path }

  Hardware_Layer: {
    grid-columns: 4
    reg0: "YMM/ZMM 0" { class: simd_reg }
    reg1: "YMM/ZMM 1" { class: simd_reg }
    reg2: "YMM/ZMM 2" { class: simd_reg }
    reg3: "YMM/ZMM 3" { class: simd_reg }
  }
}

# Documentation Link
SIMD_Pipelining_Architecture.Compute_Kernel_Engine.link: "https://github.com/simd-library/cke-spec"