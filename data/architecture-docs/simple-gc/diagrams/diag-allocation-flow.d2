vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Street View: Allocation Algorithm Flow" {
  near: top-center
  shape: text
  style: {
    font-size: 28
    bold: true
    underline: true
  }
}

direction: down

start: "gc_alloc(gc, size)" {
  shape: oval
  style.fill: "#d4f1d4"
}

calc_size: "Calculate total size\n(size + sizeof(Header))" {
  shape: rectangle
  style.fill: "#fff4e6"
}

search_free: "Search free list\nfor suitable block" {
  shape: rectangle
  style.fill: "#e3f2fd"
}

found_check: "Block found?" {
  shape: diamond
  style.fill: "#fff9c4"
}

split_check: "Block large enough\nto split?" {
  shape: diamond
  style.fill: "#fff9c4"
}

split_block: "Split block:\n1. Create new header\n2. Update sizes\n3. Link remainder" {
  shape: rectangle
  style.fill: "#f3e5f5"
}

init_header: "Initialize header:\n- Set size\n- Clear mark bit\n- Set magic number" {
  shape: rectangle
  style.fill: "#e1f5fe"
}

return_ptr: "Return pointer\n(header + 1)" {
  shape: oval
  style.fill: "#c8e6c9"
}

oom: "Out of memory!\nReturn NULL" {
  shape: rectangle
  style.fill: "#ffcdd2"
}

start -> calc_size
calc_size -> search_free
search_free -> found_check

found_check -> split_check: "Yes"
found_check -> oom: "No"

split_check -> split_block: "Yes\n(size > needed + MIN_BLOCK)"
split_check -> init_header: "No"

split_block -> init_header

init_header -> return_ptr

oom -> end

return_ptr -> end

end: "End" {
  shape: oval
  style.fill: "#d4f1d4"
}

legend: |md
  ## Key Concepts
  
  **Free List Search**: O(n) linear scan
  
  **Block Splitting**: Reduces fragmentation
  
  **Header Layout**:
  
  [size:63][mark:1] [magic:32] [data...]
  
  
  **Alignment**: All blocks 8-byte aligned
| {
  near: top-right
  shape: rectangle
  style: {
    fill: "#fafafa"
    stroke: "#666"
    font-size: 14
  }
}

example: |md
  ## Example: Allocate 128 bytes
  
  1. **Request**: `gc_alloc(gc, 128)`
  2. **Total size**: 128 + 16 = 144 bytes
  3. **Search**: Find 256-byte block
  4. **Split**: 
     - Use 144 bytes
     - Return 112 bytes to free list
  5. **Return**: Pointer to data area
| {
  near: bottom-right
  shape: rectangle
  style: {
    fill: "#e8f5e9"
    stroke: "#4caf50"
    font-size: 14
  }
}