vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Microscopic: Free List Management" {
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    underline: true
  }
}

# ============================================================================
# MAIN DIAGRAM: Free List Structure with Size Bins
# ============================================================================

free_list_header: "Free List Header" {
  shape: rectangle
  style: {
    fill: "#e3f2fd"
    stroke: "#1976d2"
    stroke-width: 2
    font-size: 14
    bold: true
  }
  
  bins_label: |'md
    | Bin Index | Size Range | Head Pointer |
    |-----------|------------|--------------|
    | 0         | 16-31 B    | â†’ Block A    |
    | 1         | 32-63 B    | â†’ Block D    |
    | 2         | 64-127 B   | â†’ Block G    |
    | 3         | 128-255 B  | NULL         |
    | ...       | ...        | ...          |
  '|
}

heap_memory: "Heap Memory (Simplified View)" {
  shape: rectangle
  style: {
    fill: "#fff3e0"
    stroke: "#f57c00"
    stroke-width: 2
  }
  
  block_a: "Block A\n[16 B]\nFree" {
    shape: rectangle
    style: {
      fill: "#c8e6c9"
      stroke: "#388e3c"
      stroke-width: 2
    }
    
    metadata: |'md
      **Metadata:**
      - Size: 16 B
      - Next: Block B
      - Prev: NULL
    '|
  }
  
  block_b: "Block B\n[24 B]\nFree" {
    shape: rectangle
    style: {
      fill: "#c8e6c9"
      stroke: "#388e3c"
      stroke-width: 2
    }
    
    metadata: |'md
      **Metadata:**
      - Size: 24 B
      - Next: Block C
      - Prev: Block A
    '|
  }
  
  block_c: "Block C\n[32 B]\nAllocated" {
    shape: rectangle
    style: {
      fill: "#ffccbc"
      stroke: "#d84315"
      stroke-width: 2
    }
    
    metadata: |'md
      **Metadata:**
      - Size: 32 B
      - In Use: Yes
    '|
  }
  
  block_d: "Block D\n[48 B]\nFree" {
    shape: rectangle
    style: {
      fill: "#c8e6c9"
      stroke: "#388e3c"
      stroke-width: 2
    }
    
    metadata: |'md
      **Metadata:**
      - Size: 48 B
      - Next: Block E
      - Prev: NULL
    '|
  }
  
  block_e: "Block E\n[56 B]\nFree" {
    shape: rectangle
    style: {
      fill: "#c8e6c9"
      stroke: "#388e3c"
      stroke-width: 2
    }
    
    metadata: |'md
      **Metadata:**
      - Size: 56 B
      - Next: Block F
      - Prev: Block D
    '|
  }
  
  block_f: "Block F\n[64 B]\nAllocated" {
    shape: rectangle
    style: {
      fill: "#ffccbc"
      stroke: "#d84315"
      stroke-width: 2
    }
    
    metadata: |'md
      **Metadata:**
      - Size: 64 B
      - In Use: Yes
    '|
  }
  
  block_g: "Block G\n[96 B]\nFree" {
    shape: rectangle
    style: {
      fill: "#c8e6c9"
      stroke: "#388e3c"
      stroke-width: 2
    }
    
    metadata: |'md
      **Metadata:**
      - Size: 96 B
      - Next: NULL
      - Prev: NULL
    '|
  }
}

# Connections: Free List Bins to Blocks
free_list_header -> heap_memory.block_a: "Bin 0 (16-31 B)" {
  style: {
    stroke: "#1976d2"
    stroke-width: 2
    stroke-dash: 3
  }
}

free_list_header -> heap_memory.block_d: "Bin 1 (32-63 B)" {
  style: {
    stroke: "#1976d2"
    stroke-width: 2
    stroke-dash: 3
  }
}

free_list_header -> heap_memory.block_g: "Bin 2 (64-127 B)" {
  style: {
    stroke: "#1976d2"
    stroke-width: 2
    stroke-dash: 3
  }
}

# Connections: Linked List within Bins
heap_memory.block_a -> heap_memory.block_b: "Next" {
  style: {
    stroke: "#388e3c"
    stroke-width: 2
  }
}

heap_memory.block_b -> heap_memory.block_a: "Prev" {
  style: {
    stroke: "#388e3c"
    stroke-width: 1
    stroke-dash: 5
  }
}

heap_memory.block_d -> heap_memory.block_e: "Next" {
  style: {
    stroke: "#388e3c"
    stroke-width: 2
  }
}

heap_memory.block_e -> heap_memory.block_d: "Prev" {
  style: {
    stroke: "#388e3c"
    stroke-width: 1
    stroke-dash: 5
  }
}

# ============================================================================
# COALESCING LOGIC: Before and After
# ============================================================================

coalescing_example: "Coalescing Adjacent Free Blocks" {
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#7b1fa2"
    stroke-width: 2
  }
  
  before: "Before Coalescing" {
    shape: rectangle
    style: {
      fill: "#fff9c4"
      stroke: "#f57f17"
      stroke-width: 2
    }
    
    block_x: "Block X\n[32 B]\nFree" {
      shape: rectangle
      style: {
        fill: "#c8e6c9"
        stroke: "#388e3c"
      }
    }
    
    block_y: "Block Y\n[48 B]\nFree" {
      shape: rectangle
      style: {
        fill: "#c8e6c9"
        stroke: "#388e3c"
      }
    }
    
    block_z: "Block Z\n[64 B]\nAllocated" {
      shape: rectangle
      style: {
        fill: "#ffccbc"
        stroke: "#d84315"
      }
    }
  }
  
  after: "After Coalescing" {
    shape: rectangle
    style: {
      fill: "#c8e6c9"
      stroke: "#388e3c"
      stroke-width: 2
    }
    
    block_xy: "Block XY\n[80 B]\nFree" {
      shape: rectangle
      style: {
        fill: "#a5d6a7"
        stroke: "#2e7d32"
        stroke-width: 3
      }
      
      note: |'md
        **Coalesced:**
        - X (32 B) + Y (48 B) = 80 B
        - Moved to Bin 2 (64-127 B)
      '|
    }
    
    block_z_after: "Block Z\n[64 B]\nAllocated" {
      shape: rectangle
      style: {
        fill: "#ffccbc"
        stroke: "#d84315"
      }
    }
  }
}

coalescing_example.before.block_x -> coalescing_example.before.block_y: "Adjacent" {
  style: {
    stroke: "#f57f17"
    stroke-width: 2
  }
}

coalescing_example.before -> coalescing_example.after: "Coalesce()" {
  style: {
    stroke: "#7b1fa2"
    stroke-width: 3
    animated: true
  }
}

# ============================================================================
# ALLOCATION ALGORITHM: Best-Fit Search
# ============================================================================

allocation_algo: "Allocation Algorithm (Best-Fit)" {
  shape: rectangle
  style: {
    fill: "#e1f5fe"
    stroke: "#0277bd"
    stroke-width: 2
  }
  
  request: "Request: Allocate 40 B" {
    shape: rectangle
    style: {
      fill: "#fff59d"
      stroke: "#f57f17"
      stroke-width: 2
      bold: true
    }
  }
  
  search: "Search Bin 1 (32-63 B)" {
    shape: rectangle
    style: {
      fill: "#b3e5fc"
      stroke: "#0277bd"
    }
    
    candidates: |'md
      **Candidates:**
      - Block D: 48 B (waste: 8 B)
      - Block E: 56 B (waste: 16 B)
      
      **Best Fit:** Block D (48 B)
    '|
  }
  
  split: "Split Block D" {
    shape: rectangle
    style: {
      fill: "#c5e1a5"
      stroke: "#558b2f"
    }
    
    result: |'md
      **Result:**
      - Allocated: 40 B (returned to user)
      - Remainder: 8 B (stays in Bin 0)
    '|
  }
  
  update: "Update Free List" {
    shape: rectangle
    style: {
      fill: "#ffccbc"
      stroke: "#d84315"
    }
    
    changes: |'md
      **Changes:**
      - Remove Block D from Bin 1
      - Add 8 B remainder to Bin 0
      - Mark 40 B as allocated
    '|
  }
}

allocation_algo.request -> allocation_algo.search: "1. Find Bin" {
  style: {
    stroke: "#0277bd"
    stroke-width: 2
  }
}

allocation_algo.search -> allocation_algo.split: "2. Best Fit" {
  style: {
    stroke: "#558b2f"
    stroke-width: 2
  }
}

allocation_algo.split -> allocation_algo.update: "3. Update" {
  style: {
    stroke: "#d84315"
    stroke-width: 2
  }
}

# ============================================================================
# LEGEND
# ============================================================================

legend: "Legend" {
  near: bottom-right
  shape: rectangle
  style: {
    fill: "#fafafa"
    stroke: "#9e9e9e"
    stroke-width: 1
  }
  
  items: |'md
    **Block States:**
    - ðŸŸ¢ **Free**: Available for allocation
    - ðŸ”´ **Allocated**: In use by program
    
    **Connections:**
    - **Solid Arrow**: Next pointer
    - **Dashed Arrow**: Prev pointer
    - **Dotted Arrow**: Bin head pointer
  '|
}

# ============================================================================
# PERFORMANCE NOTES
# ============================================================================

perf_notes: "Performance Characteristics" {
  near: bottom-left
  shape: rectangle
  style: {
    fill: "#e8f5e9"
    stroke: "#388e3c"
    stroke-width: 2
  }
  
  metrics: |'md
    **Time Complexity:**
    - Allocation (best-fit): O(n) per bin
    - Deallocation: O(1)
    - Coalescing: O(1) per adjacent block
    
    **Space Overhead:**
    - Metadata: 16 B per block
    - Bin array: 64 B (16 bins Ã— 4 B)
    
    **Fragmentation:**
    - Internal: ~12.5% (avg)
    - External: Mitigated by coalescing
  '|
}