vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: down

title: "Mark Phase Algorithm - Iterative Marking Process" {
  near: top-center
  shape: text
  style: {
    font-size: 28
    bold: true
    underline: true
  }
}

start: "START\nMark Phase" {
  shape: oval
  style.fill: "#90EE90"
}

init_queue: "Initialize Mark Queue\nwith Root Objects" {
  shape: rectangle
  style.fill: "#FFE4B5"
}

queue_empty: "Is Queue\nEmpty?" {
  shape: diamond
  style.fill: "#FFD700"
}

pop_object: "Pop Object\nfrom Queue" {
  shape: rectangle
  style.fill: "#87CEEB"
}

already_marked: "Already\nMarked?" {
  shape: diamond
  style.fill: "#FFD700"
}

mark_object: "Mark Object\nin Bitmap" {
  shape: rectangle
  style.fill: "#98FB98"
}

scan_fields: "Scan Object Fields\nfor Pointers" {
  shape: rectangle
  style.fill: "#DDA0DD"
}

has_children: "Found\nChild Pointers?" {
  shape: diamond
  style.fill: "#FFD700"
}

push_children: "Push Child Objects\nto Queue" {
  shape: rectangle
  style.fill: "#87CEEB"
}

mark_complete: "Mark Phase\nComplete" {
  shape: oval
  style.fill: "#90EE90"
}

start -> init_queue

init_queue -> queue_empty

queue_empty -> pop_object: "No" {
  style.stroke: "#228B22"
  style.stroke-width: 2
}

queue_empty -> mark_complete: "Yes" {
  style.stroke: "#DC143C"
  style.stroke-width: 2
}

pop_object -> already_marked

already_marked -> queue_empty: "Yes\n(Skip)" {
  style.stroke: "#FFA500"
  style.stroke-width: 2
  style.stroke-dash: 3
}

already_marked -> mark_object: "No" {
  style.stroke: "#228B22"
  style.stroke-width: 2
}

mark_object -> scan_fields

scan_fields -> has_children

has_children -> push_children: "Yes" {
  style.stroke: "#228B22"
  style.stroke-width: 2
}

has_children -> queue_empty: "No" {
  style.stroke: "#FFA500"
  style.stroke-width: 2
}

push_children -> queue_empty: "Loop" {
  style.stroke: "#4169E1"
  style.stroke-width: 2
  style.stroke-dash: 3
}

legend: "Legend" {
  shape: rectangle
  style: {
    fill: "#F0F0F0"
    stroke: "#808080"
    stroke-width: 2
  }
  
  green_path: "Green = Continue" {
    shape: text
    style.font-color: "#228B22"
  }
  
  red_path: "Red = Exit" {
    shape: text
    style.font-color: "#DC143C"
  }
  
  orange_path: "Orange = Skip" {
    shape: text
    style.font-color: "#FFA500"
  }
  
  blue_path: "Blue = Loop Back" {
    shape: text
    style.font-color: "#4169E1"
  }
}

legend.near: bottom-right

notes: |'md
  **Key Steps:**
  1. **Initialize**: Start with root objects in queue
  2. **Pop**: Remove next object from queue
  3. **Check**: Skip if already marked
  4. **Mark**: Set bit in bitmap
  5. **Scan**: Find all child pointers
  6. **Push**: Add children to queue
  7. **Repeat**: Until queue is empty
  
  **Complexity**: O(live objects)
  **Space**: O(max queue depth)
'| {
  shape: rectangle
  style: {
    fill: "#FFFACD"
    stroke: "#DAA520"
    stroke-width: 2
  }
}

notes.near: bottom-left