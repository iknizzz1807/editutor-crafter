vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Microscopic: Mark Queue Internals" {
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    underline: true
  }
}

# Mark Queue Structure
mark_queue: "Mark Queue (Ring Buffer)" {
  shape: rectangle
  style: {
    fill: "#2E3440"
    stroke: "#88C0D0"
    stroke-width: 3
    font-color: "#ECEFF4"
  }

  header: "MarkQueue" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#5E81AC"
      font-color: "#D8DEE9"
    }
    
    capacity: "capacity: 1024" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#81A1C1"
        font-color: "#E5E9F0"
      }
    }
    
    head: "head: 0" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#81A1C1"
        font-color: "#E5E9F0"
      }
    }
    
    tail: "tail: 3" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#81A1C1"
        font-color: "#E5E9F0"
      }
    }
    
    size: "size: 3" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#81A1C1"
        font-color: "#E5E9F0"
      }
    }
  }
  
  buffer: "Object* buffer[1024]" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#5E81AC"
      font-color: "#D8DEE9"
    }
    
    slot0: "[0] → Object A" {
      shape: rectangle
      style: {
        fill: "#A3BE8C"
        stroke: "#8FBCBB"
        font-color: "#2E3440"
        bold: true
      }
    }
    
    slot1: "[1] → Object B" {
      shape: rectangle
      style: {
        fill: "#A3BE8C"
        stroke: "#8FBCBB"
        font-color: "#2E3440"
        bold: true
      }
    }
    
    slot2: "[2] → Object C" {
      shape: rectangle
      style: {
        fill: "#A3BE8C"
        stroke: "#8FBCBB"
        font-color: "#2E3440"
        bold: true
      }
    }
    
    slot3: "[3] → NULL" {
      shape: rectangle
      style: {
        fill: "#4C566A"
        stroke: "#616E88"
        font-color: "#D8DEE9"
      }
    }
    
    slot4: "[4] → NULL" {
      shape: rectangle
      style: {
        fill: "#4C566A"
        stroke: "#616E88"
        font-color: "#D8DEE9"
      }
    }
    
    ellipsis: "..." {
      shape: text
      style: {
        font-color: "#D8DEE9"
        font-size: 18
      }
    }
    
    slot1023: "[1023] → NULL" {
      shape: rectangle
      style: {
        fill: "#4C566A"
        stroke: "#616E88"
        font-color: "#D8DEE9"
      }
    }
  }
}

# Overflow Handling
overflow: "Overflow Handling" {
  shape: rectangle
  style: {
    fill: "#2E3440"
    stroke: "#D08770"
    stroke-width: 3
    font-color: "#ECEFF4"
  }
  
  condition: "if (size == capacity)" {
    shape: diamond
    style: {
      fill: "#BF616A"
      stroke: "#D08770"
      font-color: "#ECEFF4"
      bold: true
    }
  }
  
  fallback: "Fallback Strategy" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#EBCB8B"
      font-color: "#D8DEE9"
    }
    
    option1: "1. Recursive mark\n   (stack-based)" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#EBCB8B"
        font-color: "#E5E9F0"
      }
    }
    
    option2: "2. Allocate larger queue\n   (realloc)" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#EBCB8B"
        font-color: "#E5E9F0"
      }
    }
    
    option3: "3. Mark in-place\n   (no queue)" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#EBCB8B"
        font-color: "#E5E9F0"
      }
    }
  }
}

# Gray Object Tracking
gray_tracking: "Gray Object Tracking" {
  shape: rectangle
  style: {
    fill: "#2E3440"
    stroke: "#B48EAD"
    stroke-width: 3
    font-color: "#ECEFF4"
  }
  
  states: "Object States" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#B48EAD"
      font-color: "#D8DEE9"
    }
    
    white: "WHITE\n(unmarked)" {
      shape: rectangle
      style: {
        fill: "#ECEFF4"
        stroke: "#4C566A"
        font-color: "#2E3440"
      }
    }
    
    gray: "GRAY\n(in queue)" {
      shape: rectangle
      style: {
        fill: "#D8DEE9"
        stroke: "#5E81AC"
        font-color: "#2E3440"
        bold: true
      }
    }
    
    black: "BLACK\n(marked)" {
      shape: rectangle
      style: {
        fill: "#2E3440"
        stroke: "#88C0D0"
        font-color: "#ECEFF4"
      }
    }
  }
  
  transitions: "State Transitions" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#B48EAD"
      font-color: "#D8DEE9"
    }
    
    t1: "WHITE → GRAY\n(enqueue)" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#88C0D0"
        font-color: "#E5E9F0"
      }
    }
    
    t2: "GRAY → BLACK\n(dequeue + mark)" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#88C0D0"
        font-color: "#E5E9F0"
      }
    }
  }
}

# Operations
operations: "Queue Operations" {
  shape: rectangle
  style: {
    fill: "#2E3440"
    stroke: "#A3BE8C"
    stroke-width: 3
    font-color: "#ECEFF4"
  }
  
  enqueue: "enqueue(obj)" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#A3BE8C"
      font-color: "#D8DEE9"
    }
    
    code_enq: |'c
      buffer[tail] = obj;
      tail = (tail + 1) % capacity;
      size++;
    '| {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#8FBCBB"
        font-color: "#E5E9F0"
        font: mono
      }
    }
  }
  
  dequeue: "dequeue()" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#A3BE8C"
      font-color: "#D8DEE9"
    }
    
    code_deq: |'c
      Object* obj = buffer[head];
      head = (head + 1) % capacity;
      size--;
      return obj;
    '| {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#8FBCBB"
        font-color: "#E5E9F0"
        font: mono
      }
    }
  }
  
  is_empty: "is_empty()" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#A3BE8C"
      font-color: "#D8DEE9"
    }
    
    code_empty: |'c
      return size == 0;
    '| {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#8FBCBB"
        font-color: "#E5E9F0"
        font: mono
      }
    }
  }
}

# Example Workflow
workflow: "Example: Marking Object Graph" {
  shape: rectangle
  style: {
    fill: "#2E3440"
    stroke: "#88C0D0"
    stroke-width: 3
    font-color: "#ECEFF4"
  }
  
  step1: "1. Start: enqueue(Root)" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#88C0D0"
      font-color: "#D8DEE9"
    }
    
    state1: "Queue: [Root]\nRoot: GRAY" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#8FBCBB"
        font-color: "#E5E9F0"
      }
    }
  }
  
  step2: "2. Dequeue Root" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#88C0D0"
      font-color: "#D8DEE9"
    }
    
    state2: "Queue: []\nRoot: BLACK\nEnqueue children A, B" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#8FBCBB"
        font-color: "#E5E9F0"
      }
    }
  }
  
  step3: "3. Process A" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#88C0D0"
      font-color: "#D8DEE9"
    }
    
    state3: "Queue: [B]\nA: BLACK\nEnqueue child C" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#8FBCBB"
        font-color: "#E5E9F0"
      }
    }
  }
  
  step4: "4. Process B, C" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#88C0D0"
      font-color: "#D8DEE9"
    }
    
    state4: "Queue: []\nAll: BLACK\nMarking complete" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#8FBCBB"
        font-color: "#E5E9F0"
      }
    }
  }
}

# Performance Notes
perf_notes: "Performance Characteristics" {
  shape: rectangle
  style: {
    fill: "#2E3440"
    stroke: "#EBCB8B"
    stroke-width: 3
    font-color: "#ECEFF4"
  }
  
  time: "Time Complexity" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#EBCB8B"
      font-color: "#D8DEE9"
    }
    
    enq_time: "enqueue: O(1)" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#A3BE8C"
        font-color: "#E5E9F0"
      }
    }
    
    deq_time: "dequeue: O(1)" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#A3BE8C"
        font-color: "#E5E9F0"
      }
    }
  }
  
  space: "Space Complexity" {
    shape: rectangle
    style: {
      fill: "#3B4252"
      stroke: "#EBCB8B"
      font-color: "#D8DEE9"
    }
    
    worst: "Worst case: O(n)\n(all objects gray)" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#BF616A"
        font-color: "#E5E9F0"
      }
    }
    
    typical: "Typical: O(√n)\n(balanced graph)" {
      shape: rectangle
      style: {
        fill: "#434C5E"
        stroke: "#A3BE8C"
        font-color: "#E5E9F0"
      }
    }
  }
}

# Connections
mark_queue.header.tail -> mark_queue.buffer.slot3: "points to next\ninsert position" {
  style: {
    stroke: "#EBCB8B"
    stroke-width: 2
    stroke-dash: 3
  }
}

mark_queue.header.head -> mark_queue.buffer.slot0: "points to next\ndequeue position" {
  style: {
    stroke: "#A3BE8C"
    stroke-width: 2
    stroke-dash: 3
  }
}

overflow.condition -> overflow.fallback: "YES" {
  style: {
    stroke: "#BF616A"
    stroke-width: 2
  }
}

gray_tracking.states.white -> gray_tracking.states.gray: "enqueue" {
  style: {
    stroke: "#88C0D0"
    stroke-width: 2
  }
}

gray_tracking.states.gray -> gray_tracking.states.black: "dequeue\n+ mark" {
  style: {
    stroke: "#88C0D0"
    stroke-width: 2
  }
}

operations.enqueue -> mark_queue.buffer: "writes to tail" {
  style: {
    stroke: "#A3BE8C"
    stroke-width: 2
    stroke-dash: 3
  }
}

operations.dequeue -> mark_queue.buffer: "reads from head" {
  style: {
    stroke: "#A3BE8C"
    stroke-width: 2
    stroke-dash: 3
  }
}

workflow.step1 -> workflow.step2 -> workflow.step3 -> workflow.step4: {
  style: {
    stroke: "#88C0D0"
    stroke-width: 2
  }
}