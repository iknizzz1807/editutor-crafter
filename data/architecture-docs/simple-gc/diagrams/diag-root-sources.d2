vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: Root Set Architecture - Component View {
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    underline: true
  }
}

# Root Set Manager (Central Coordinator)
root_manager: Root Set Manager {
  shape: rectangle
  style: {
    fill: "#e8f4f8"
    stroke: "#0077b6"
    stroke-width: 3
    font-size: 18
    bold: true
  }
  
  api: |md
    **Public API:**
    - `collect_roots(GC*) â†’ RootSet`
    - `register_global(void*)`
    - `unregister_global(void*)`
  |
  
  state: |md
    **Internal State:**
    - Global variable registry
    - Thread-local storage map
    - Root deduplication cache
  |
}

# Stack Scanner Component
stack_scanner: Stack Scanner {
  shape: rectangle
  style: {
    fill: "#fff3cd"
    stroke: "#ff9800"
    stroke-width: 2
    font-size: 16
  }
  
  method: |md
    **scan_stack()**
    1. Get stack bounds (base, top)
    2. Walk stack frame-by-frame
    3. Identify potential pointers
    4. Validate against heap range
  |
  
  challenges: |md
    **Challenges:**
    - Conservative scanning (false positives)
    - Platform-specific stack layout
    - Inlined functions
  |
}

# Global Variable Scanner
global_scanner: Global Variable Scanner {
  shape: rectangle
  style: {
    fill: "#d4edda"
    stroke: "#28a745"
    stroke-width: 2
    font-size: 16
  }
  
  method: |md
    **scan_globals()**
    1. Iterate registered globals
    2. Read pointer values
    3. Validate heap membership
    4. Add to root set
  |
  
  registration: |md
    **Registration:**
    c
    static void* my_global;
    gc_register_global(&my_global);
    
  |
}

# Register Scanner
register_scanner: Register Scanner {
  shape: rectangle
  style: {
    fill: "#f8d7da"
    stroke: "#dc3545"
    stroke-width: 2
    font-size: 16
  }
  
  method: |md
    **scan_registers()**
    1. Save all CPU registers
    2. Scan saved register buffer
    3. Identify heap pointers
    4. Add to root set
  |
  
  arch_specific: |md
    **Architecture-Specific:**
    - x86-64: RAX, RBX, RCX, ...
    - ARM64: X0-X30
    - RISC-V: x1-x31
  |
}

# Thread-Local Storage Scanner
tls_scanner: Thread-Local Storage Scanner {
  shape: rectangle
  style: {
    fill: "#e2d9f3"
    stroke: "#6f42c1"
    stroke-width: 2
    font-size: 16
  }
  
  method: |md
    **scan_tls()**
    1. Enumerate all threads
    2. Access thread-local storage
    3. Scan TLS data structures
    4. Merge into root set
  |
  
  note: |md
    **Note:** Required for
    multi-threaded GC
  |
}

# Root Set Output
root_set: Root Set {
  shape: cylinder
  style: {
    fill: "#fff"
    stroke: "#333"
    stroke-width: 2
    font-size: 16
  }
  
  structure: |md
    **Structure:**
    c
    typedef struct {
      void** roots;
      size_t count;
      size_t capacity;
    } RootSet;
    
  |
  
  properties: |md
    **Properties:**
    - Deduplicated
    - Sorted (optional)
    - Validated pointers only
  |
}

# Heap Validator (Helper Component)
heap_validator: Heap Validator {
  shape: rectangle
  style: {
    fill: "#f0f0f0"
    stroke: "#666"
    stroke-width: 1
    stroke-dash: 3
    font-size: 14
  }
  
  function: |md
    **is_heap_pointer(void* ptr)**
    - Check if ptr âˆˆ [heap_start, heap_end)
    - Verify alignment
    - Check object header magic
  |
}

# Connections: Scanners â†’ Root Manager
stack_scanner -> root_manager: "Stack roots" {
  style.stroke: "#ff9800"
  style.stroke-width: 2
}

global_scanner -> root_manager: "Global roots" {
  style.stroke: "#28a745"
  style.stroke-width: 2
}

register_scanner -> root_manager: "Register roots" {
  style.stroke: "#dc3545"
  style.stroke-width: 2
}

tls_scanner -> root_manager: "TLS roots" {
  style.stroke: "#6f42c1"
  style.stroke-width: 2
}

# Root Manager â†’ Root Set
root_manager -> root_set: "Unified root set" {
  style.stroke: "#0077b6"
  style.stroke-width: 3
}

# Heap Validator connections
stack_scanner -> heap_validator: "Validate pointers" {
  style.stroke-dash: 3
}

global_scanner -> heap_validator: "Validate pointers" {
  style.stroke-dash: 3
}

register_scanner -> heap_validator: "Validate pointers" {
  style.stroke-dash: 3
}

tls_scanner -> heap_validator: "Validate pointers" {
  style.stroke-dash: 3
}

# Implementation Notes
impl_notes: |md
  **Implementation Strategy:**
  
  1. **Conservative Scanning:**
     - Treat any word-aligned value as potential pointer
     - Validate against heap bounds
     - Accept false positives (safe, but retains garbage)
  
  2. **Precise Scanning (Advanced):**
     - Require type information
     - Only scan known pointer fields
     - Zero false positives
  
  3. **Platform Portability:**
     - Use `setjmp()` for register capture
     - Use `pthread_getattr_np()` for stack bounds (Linux)
     - Use `GetThreadContext()` on Windows
  
  4. **Performance:**
     - Cache stack bounds per thread
     - Use SIMD for pointer validation
     - Parallelize multi-threaded scanning
| {
  shape: rectangle
  style: {
    fill: "#fffacd"
    stroke: "#ffa500"
    stroke-width: 2
    font-size: 14
  }
  near: bottom-center
}

# Example Code Reference
code_example: |md
  **Example: Collecting Roots**
  
  c
  RootSet collect_roots(GC* gc) {
      RootSet roots = {0};
      
      // 1. Scan stack
      scan_stack(gc, &roots);
      
      // 2. Scan globals
      scan_globals(gc, &roots);
      
      // 3. Scan registers
      scan_registers(gc, &roots);
      
      // 4. Scan TLS (if multi-threaded)
      if (gc->multi_threaded) {
          scan_tls(gc, &roots);
      }
      
      // 5. Deduplicate
      deduplicate_roots(&roots);
      
      return roots;
  }
  
| {
  shape: rectangle
  style: {
    fill: "#f0f8ff"
    stroke: "#4682b4"
    stroke-width: 2
    font-size: 13
  }
  near: bottom-left
}

# Legend
legend: |md
  **Legend:**
  - ðŸŸ¦ **Blue**: Central coordinator
  - ðŸŸ¨ **Yellow**: Stack scanning
  - ðŸŸ© **Green**: Global scanning
  - ðŸŸ¥ **Red**: Register scanning
  - ðŸŸª **Purple**: TLS scanning
  - âšª **White**: Output data structure
  - â¬œ **Gray**: Helper component
| {
  shape: rectangle
  style: {
    fill: "#fff"
    stroke: "#333"
    stroke-width: 1
    font-size: 12
  }
  near: top-right
}