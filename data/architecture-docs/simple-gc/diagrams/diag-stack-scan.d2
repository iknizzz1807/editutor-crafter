vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: down

title: "Stack Frame Scanning - Root Extraction" {
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    underline: true
  }
}

stack: "Stack Memory" {
  shape: rectangle
  style: {
    fill: "#e8f4f8"
    stroke: "#2c5aa0"
    stroke-width: 2
  }

  frame3: "Frame: main()" {
    shape: rectangle
    style: {
      fill: "#fff3cd"
      stroke: "#856404"
      stroke-width: 2
    }

    frame3_details: |'md
      | Offset | Content | Type |
      |--------|---------|------|
      | +24 | 0x7fff1234 | Return addr |
      | +16 | 0x7fff1200 | Frame ptr |
      | +8 | 0x00400abc | Local: obj_a |
      | +0 | 0x00400def | Local: obj_b |
    '|
  }

  frame2: "Frame: process()" {
    shape: rectangle
    style: {
      fill: "#d4edda"
      stroke: "#155724"
      stroke-width: 2
    }

    frame2_details: |'md
      | Offset | Content | Type |
      |--------|---------|------|
      | +32 | 0x7fff1180 | Return addr |
      | +24 | 0x7fff1150 | Frame ptr |
      | +16 | 0x00400123 | Local: temp |
      | +8 | 0x00400456 | Local: list |
      | +0 | 0x00400789 | Local: node |
    '|
  }

  frame1: "Frame: allocate()" {
    shape: rectangle
    style: {
      fill: "#f8d7da"
      stroke: "#721c24"
      stroke-width: 2
    }

    frame1_details: |'md
      | Offset | Content | Type |
      |--------|---------|------|
      | +16 | 0x7fff1100 | Return addr |
      | +8 | 0x7fff10e0 | Frame ptr |
      | +0 | 0x00400999 | Local: ptr |
    '|
  }
}

scanner: "Stack Scanner" {
  shape: rectangle
  style: {
    fill: "#d1ecf1"
    stroke: "#0c5460"
    stroke-width: 2
  }

  scan_logic: |'md
    **Scanning Algorithm:**
    1. Start at current SP
    2. Follow frame pointers
    3. For each word in frame:
       - Check if valid heap ptr
       - Add to root set if valid
    4. Stop at base pointer
  '|
}

roots: "Root Set" {
  shape: cylinder
  style: {
    fill: "#d4edda"
    stroke: "#155724"
    stroke-width: 2
  }

  root_list: |'md
    **Extracted Roots:**
    - 0x00400abc (obj_a)
    - 0x00400def (obj_b)
    - 0x00400456 (list)
    - 0x00400789 (node)
    - 0x00400999 (ptr)
  '|
}

registers: "CPU Registers" {
  shape: rectangle
  style: {
    fill: "#fff3cd"
    stroke: "#856404"
    stroke-width: 2
  }

  reg_state: |'md
    | Register | Value | Notes |
    |----------|-------|-------|
    | RSP | 0x7fff10e0 | Stack ptr |
    | RBP | 0x7fff1200 | Base ptr |
    | RAX | 0x00400abc | Temp root |
    | RBX | 0x00400def | Temp root |
  '|
}

heap: "Heap Objects" {
  shape: rectangle
  style: {
    fill: "#e8f4f8"
    stroke: "#2c5aa0"
    stroke-width: 2
  }

  heap_layout: |'md
    **Referenced Objects:**
    - 0x00400abc: Object A
    - 0x00400def: Object B
    - 0x00400456: List head
    - 0x00400789: List node
    - 0x00400999: New allocation
  '|
}

notes: "Implementation Notes" {
  shape: rectangle
  style: {
    fill: "#f8d7da"
    stroke: "#721c24"
    stroke-width: 2
  }

  impl_notes: |'md
    **Conservative Scanning:**
    - Treat every word as potential pointer
    - Validate against heap bounds
    - False positives are safe (keep garbage)
    - False negatives are fatal (collect live data)
    
    **Optimization:**
    - Use frame pointer chain for fast traversal
    - Skip known non-pointer regions
    - Cache heap bounds for validation
  '|
}

stack.frame3 -> scanner: "Scan frame 3"
stack.frame2 -> scanner: "Scan frame 2"
stack.frame1 -> scanner: "Scan frame 1"
registers -> scanner: "Scan registers"

scanner -> roots: "Extract roots" {
  style: {
    stroke: "#28a745"
    stroke-width: 3
  }
}

roots -> heap: "Mark reachable" {
  style: {
    stroke: "#007bff"
    stroke-width: 3
    stroke-dash: 3
  }
}

notes -> scanner: "Guides implementation" {
  style: {
    stroke: "#6c757d"
    stroke-dash: 5
  }
}