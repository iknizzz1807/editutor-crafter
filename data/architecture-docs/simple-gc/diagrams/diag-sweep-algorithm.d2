vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: down

title: "Sweep Phase Algorithm" {
  shape: text
  style: {
    font-size: 24
    bold: true
  }
}

start: "Start Sweep" {
  shape: oval
  style.fill: "#e8f5e9"
}

init: "Initialize:\n• current = heap_start\n• freed_bytes = 0" {
  shape: rectangle
  style.fill: "#fff3e0"
}

check_end: "current < heap_end?" {
  shape: diamond
  style.fill: "#e3f2fd"
}

get_header: "Read block header:\n• size\n• mark bit" {
  shape: rectangle
  style.fill: "#f3e5f5"
}

check_marked: "Is mark bit set?" {
  shape: diamond
  style.fill: "#e3f2fd"
}

clear_mark: "Clear mark bit:\nheader &= ~MARK_BIT" {
  shape: rectangle
  style.fill: "#fff9c4"
}

add_to_freelist: "Add to free list:\n• Set FREE_BIT\n• Link to free_list\n• freed_bytes += size" {
  shape: rectangle
  style.fill: "#ffccbc"
}

advance: "Advance pointer:\ncurrent += size" {
  shape: rectangle
  style.fill: "#f3e5f5"
}

update_stats: "Update statistics:\n• heap_size -= freed_bytes\n• objects_freed += count" {
  shape: rectangle
  style.fill: "#fff3e0"
}

end: "End Sweep" {
  shape: oval
  style.fill: "#e8f5e9"
}

parallel_note: "Parallel Optimization:\nSplit heap into N chunks,\nsweep each chunk in\nseparate thread" {
  shape: rectangle
  style: {
    stroke-dash: 3
    fill: "#e1f5fe"
  }
}

start -> init
init -> check_end

check_end -> get_header: "Yes"
check_end -> update_stats: "No"

get_header -> check_marked

check_marked -> clear_mark: "Yes (Live)"
check_marked -> add_to_freelist: "No (Garbage)"

clear_mark -> advance
add_to_freelist -> advance

advance -> check_end

update_stats -> end