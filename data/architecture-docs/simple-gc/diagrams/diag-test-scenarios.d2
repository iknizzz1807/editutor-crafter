vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: "Test Coverage Map - Comprehensive Test Scenarios" {
  near: top-center
  style: {
    font-size: 24
    bold: true
    underline: true
  }
}

direction: right

test_categories: "Test Categories" {
  shape: rectangle
  style: {
    fill: "#e3f2fd"
    stroke: "#1976d2"
    stroke-width: 3
  }
  
  unit_tests: "Unit Tests" {
    shape: rectangle
    style: {
      fill: "#fff3e0"
      stroke: "#f57c00"
    }
    
    bitmap: "Bitmap Operations" {
      shape: rectangle
      style.fill: "#ffe0b2"
      
      set_bit: "set_bit()" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      }
      clear_bit: "clear_bit()" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      }
      get_bit: "get_bit()" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      }
    }
    
    queue: "Queue Operations" {
      shape: rectangle
      style.fill: "#ffe0b2"
      
      enqueue: "enqueue()" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      }
      dequeue: "dequeue()" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      }
      is_empty: "is_empty()" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      }
    }
    
    allocation: "Allocation" {
      shape: rectangle
      style.fill: "#ffe0b2"
      
      alloc_basic: "Basic Allocation" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      }
      alloc_aligned: "Aligned Allocation" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      }
      alloc_oom: "Out of Memory" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      }
    }
  }
  
  integration_tests: "Integration Tests" {
    shape: rectangle
    style: {
      fill: "#e8f5e9"
      stroke: "#388e3c"
    }
    
    leak_detection: "Leak Detection" {
      shape: rectangle
      style.fill: "#c8e6c9"
      
      simple_leak: "Simple Leak Test" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
        tooltip: "Allocate objects, drop references, verify collection"
      }
      circular_leak: "Circular Reference Test" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
        tooltip: "Create cycles, verify proper collection"
      }
    }
    
    correctness: "Correctness Validation" {
      shape: rectangle
      style.fill: "#c8e6c9"
      
      shadow_graph: "Shadow Graph Comparison" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
        tooltip: "Compare GC marking with ground truth"
      }
      parallel_sweep: "Parallel Sweep Correctness" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
        tooltip: "Verify thread-safe sweep operations"
      }
    }
  }
  
  stress_tests: "Stress Tests" {
    shape: rectangle
    style: {
      fill: "#fce4ec"
      stroke: "#c2185b"
    }
    
    deep_nesting: "Deep Nesting" {
      shape: rectangle
      style.fill: "#f8bbd0"
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      tooltip: "10,000 levels deep object graph"
    }
    
    wide_graph: "Wide Graph" {
      shape: rectangle
      style.fill: "#f8bbd0"
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      tooltip: "1 root with 100,000 children"
    }
    
    thrashing: "Allocation Thrashing" {
      shape: rectangle
      style.fill: "#f8bbd0"
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      tooltip: "Rapid alloc/free cycles"
    }
  }
  
  performance_tests: "Performance Tests" {
    shape: rectangle
    style: {
      fill: "#f3e5f5"
      stroke: "#7b1fa2"
    }
    
    targets: "Performance Targets" {
      shape: rectangle
      style.fill: "#e1bee7"
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      tooltip: "< 20ms for 100MB heap"
    }
    
    benchmarks: "Benchmarks" {
      shape: rectangle
      style.fill: "#e1bee7"
      
      mark_bench: "Marking Benchmark" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      }
      sweep_bench: "Sweep Benchmark" {
        shape: rectangle
        icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      }
    }
  }
  
  memory_safety: "Memory Safety" {
    shape: rectangle
    style: {
      fill: "#fff9c4"
      stroke: "#f57f17"
    }
    
    valgrind: "Valgrind" {
      shape: rectangle
      style.fill: "#fff59d"
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      tooltip: "Run with --leak-check=full"
    }
    
    asan: "AddressSanitizer" {
      shape: rectangle
      style.fill: "#fff59d"
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
      tooltip: "Compile with -fsanitize=address"
    }
  }
}

validation_criteria: "Validation Criteria" {
  shape: rectangle
  style: {
    fill: "#e0f2f1"
    stroke: "#00796b"
    stroke-width: 3
  }
  
  correctness: "Correctness" {
    shape: rectangle
    style.fill: "#b2dfdb"
    
    no_false_positives: "No False Positives" {
      shape: rectangle
      tooltip: "Live objects never collected"
    }
    no_false_negatives: "No False Negatives" {
      shape: rectangle
      tooltip: "All garbage collected"
    }
    heap_integrity: "Heap Integrity" {
      shape: rectangle
      tooltip: "No corruption after GC"
    }
  }
  
  performance: "Performance" {
    shape: rectangle
    style.fill: "#b2dfdb"
    
    pause_time: "Pause Time < 20ms" {
      shape: rectangle
      tooltip: "For 100MB heap with 100K objects"
    }
    throughput: "Throughput > 90%" {
      shape: rectangle
      tooltip: "Application time / total time"
    }
    scalability: "Linear Scalability" {
      shape: rectangle
      tooltip: "O(live_objects) marking time"
    }
  }
  
  safety: "Safety" {
    shape: rectangle
    style.fill: "#b2dfdb"
    
    no_leaks: "No Memory Leaks" {
      shape: rectangle
      tooltip: "Valgrind reports 0 leaks"
    }
    no_races: "No Race Conditions" {
      shape: rectangle
      tooltip: "ThreadSanitizer clean"
    }
    no_ub: "No Undefined Behavior" {
      shape: rectangle
      tooltip: "UBSan clean"
    }
  }
}

test_scenarios: "Test Scenarios" {
  shape: rectangle
  style: {
    fill: "#fafafa"
    stroke: "#424242"
    stroke-width: 3
  }
  
  scenario1: "Scenario 1: Simple Allocation" {
    shape: rectangle
    style.fill: "#e0e0e0"
    
    steps1: |md
      1. Allocate 3 objects (A, B, C)
      2. Drop all references
      3. Run GC
      4. Verify heap_size == 0
    |
  }
  
  scenario2: "Scenario 2: Circular References" {
    shape: rectangle
    style.fill: "#e0e0e0"
    
    steps2: |md
      1. Create A â†’ B â†’ C â†’ A cycle
      2. Drop root reference
      3. Run GC
      4. Verify all 3 objects collected
    |
  }
  
  scenario3: "Scenario 3: Deep Nesting" {
    shape: rectangle
    style.fill: "#e0e0e0"
    
    steps3: |md
      1. Create 10,000-level deep chain
      2. Drop root reference
      3. Run GC (iterative marking)
      4. Verify no stack overflow
    |
  }
  
  scenario4: "Scenario 4: Wide Graph" {
    shape: rectangle
    style.fill: "#e0e0e0"
    
    steps4: |md
      1. Create 1 root with 100K children
      2. Drop root reference
      3. Run GC (parallel sweep)
      4. Verify all collected in < 50ms
    |
  }
  
  scenario5: "Scenario 5: Allocation Thrashing" {
    shape: rectangle
    style.fill: "#e0e0e0"
    
    steps5: |md
      1. Allocate 1000 objects
      2. Drop 500 references
      3. Allocate 500 more
      4. Repeat 100 times
      5. Verify stable performance
    |
  }
}

ci_pipeline: "CI/CD Pipeline" {
  shape: rectangle
  style: {
    fill: "#e8eaf6"
    stroke: "#3f51b5"
    stroke-width: 3
  }
  
  on_commit: "On Every Commit" {
    shape: rectangle
    style.fill: "#c5cae9"
    
    unit: "Unit Tests (0.5s)" {
      shape: rectangle
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
    }
    integration: "Integration Tests (5s)" {
      shape: rectangle
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
    }
  }
  
  nightly: "Nightly" {
    shape: rectangle
    style.fill: "#c5cae9"
    
    stress: "Stress Tests (5min)" {
      shape: rectangle
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
    }
    valgrind: "Valgrind (30min)" {
      shape: rectangle
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
    }
    tsan: "ThreadSanitizer (30min)" {
      shape: rectangle
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
    }
  }
  
  weekly: "Weekly" {
    shape: rectangle
    style.fill: "#c5cae9"
    
    soak: "Soak Test (8 hours)" {
      shape: rectangle
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
    }
    profile: "Profiling (perf/VTune)" {
      shape: rectangle
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
    }
    coverage: "Coverage Report" {
      shape: rectangle
      icon: https://icons.terrastruct.com/essentials%2F190-check.svg
    }
  }
}

legend: "Legend" {
  near: bottom-right
  shape: rectangle
  style: {
    fill: "#ffffff"
    stroke: "#9e9e9e"
    stroke-dash: 3
  }
  
  legend_content: |md
    **Test Types:**
    - ðŸŸ  Unit: Individual functions
    - ðŸŸ¢ Integration: End-to-end
    - ðŸ”´ Stress: Pathological cases
    - ðŸŸ£ Performance: Benchmarks
    - ðŸŸ¡ Safety: Valgrind/ASan
    
    **Validation:**
    - âœ“ Correctness: No false +/-
    - âœ“ Performance: < 20ms pause
    - âœ“ Safety: No leaks/races
  |
}

test_categories.unit_tests -> validation_criteria.correctness: "Validates"
test_categories.integration_tests -> validation_criteria.correctness: "Validates"
test_categories.stress_tests -> validation_criteria.performance: "Validates"
test_categories.performance_tests -> validation_criteria.performance: "Validates"
test_categories.memory_safety -> validation_criteria.safety: "Validates"

test_scenarios -> test_categories: "Exercises"
ci_pipeline -> test_categories: "Runs"