vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: down

title: GC Trigger Decision Tree {
  shape: text
  style: {
    font-size: 24
    bold: true
  }
}

start: Start {
  shape: oval
  style.fill: "#e8f5e9"
}

check_heap: "Heap utilization\n> threshold?" {
  shape: diamond
  style.fill: "#fff3e0"
}

check_rate: "Allocation rate\n> threshold?" {
  shape: diamond
  style.fill: "#fff3e0"
}

check_time: "Time since last GC\n> max interval?" {
  shape: diamond
  style.fill: "#fff3e0"
}

trigger_gc: "Trigger GC" {
  shape: rectangle
  style: {
    fill: "#ffcdd2"
    bold: true
  }
}

no_gc: "Continue allocating" {
  shape: rectangle
  style.fill: "#c8e6c9"
}

heap_metrics: "Heap Metrics" {
  shape: rectangle
  style: {
    fill: "#e1f5fe"
    stroke-dash: 3
  }
  label: |md
    **Heap Metrics**
    - Used: 75 MB / 100 MB
    - Threshold: 80%
    - Alloc rate: 5 MB/s
    - Last GC: 2.5s ago
  |
}

thresholds: "Thresholds" {
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke-dash: 3
  }
  label: |md
    **Thresholds**
    - Heap: 80%
    - Rate: 10 MB/s
    - Time: 5 seconds
  |
}

start -> check_heap

check_heap -> check_rate: "No\n(< 80%)"
check_heap -> trigger_gc: "Yes\n(≥ 80%)"

check_rate -> check_time: "No\n(< 10 MB/s)"
check_rate -> trigger_gc: "Yes\n(≥ 10 MB/s)"

check_time -> no_gc: "No\n(< 5s)"
check_time -> trigger_gc: "Yes\n(≥ 5s)"

no_gc -> start: "Next\nallocation" {
  style.stroke-dash: 3
}

trigger_gc -> start: "After\ncollection" {
  style.stroke-dash: 3
}