title: Object Header and Type System

classes: {
  header_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  object_style: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  metadata_style: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

object_header: Object Header Layout {
  class: header_style
  shape: class
  + "type_tag: uint8_t"
  + "mark_bit: uint8_t"
  + "size: size_t"
  + "padding: uint8_t"
}

type_system: Type System {
  class: metadata_style
  
  int_type: Integer Type {
    class: object_style
    shape: class
    + "TYPE_INT = 0x01"
    + "value: int32_t"
    + "references: none"
  }
  
  pair_type: Pair Type {
    class: object_style
    shape: class
    + "TYPE_PAIR = 0x02"
    + "first: Object*"
    + "second: Object*"
    + "references: 2"
  }
  
  string_type: String Type {
    class: object_style
    shape: class
    + "TYPE_STRING = 0x03"
    + "length: size_t"
    + "data: char[]"
    + "references: none"
  }
}

memory_layout: Memory Layout Example {
  class: metadata_style
  
  int_obj: Integer Object {
    class: object_style
    shape: rectangle
    header_int: "Header: [0x01|0|8|0]" {
      style.fill: "#1a1a2e"
      style.font-color: "#3fb950"
    }
    data_int: "Data: 42" {
      style.fill: "#16213e"
      style.font-color: "#e6edf3"
    }
  }
  
  pair_obj: Pair Object {
    class: object_style
    shape: rectangle
    header_pair: "Header: [0x02|0|24|0]" {
      style.fill: "#1a1a2e"
      style.font-color: "#3fb950"
    }
    first_ptr: "First: 0x1000" {
      style.fill: "#16213e"
      style.font-color: "#e6edf3"
    }
    second_ptr: "Second: 0x2000" {
      style.fill: "#16213e"
      style.font-color: "#e6edf3"
    }
  }
  
  string_obj: String Object {
    class: object_style
    shape: rectangle
    header_str: "Header: [0x03|0|21|3]" {
      style.fill: "#1a1a2e"
      style.font-color: "#3fb950"
    }
    length_str: "Length: 5" {
      style.fill: "#16213e"
      style.font-color: "#e6edf3"
    }
    data_str: "Data: hello\\0" {
      style.fill: "#16213e"
      style.font-color: "#e6edf3"
    }
  }
}

object_header -> type_system.int_type: "type_tag identifies"
object_header -> type_system.pair_type: "type_tag identifies"
object_header -> type_system.string_type: "type_tag identifies"

memory_layout.pair_obj.first_ptr -> memory_layout.int_obj: "references" {
  style.stroke: "#3fb950"
  style.stroke-dash: 3
}

memory_layout.pair_obj.second_ptr -> memory_layout.string_obj: "references" {
  style.stroke: "#3fb950"
  style.stroke-dash: 3
}

gc_notes: |md
  ## GC Traversal Notes
  - **Mark bit**: Set during mark phase
  - **Type tag**: Determines reference pattern
  - **Size**: Used for sweep phase deallocation
  - **Leaf objects**: INT and STRING (no references)
  - **Container objects**: PAIR (has references)
| {
  shape: page
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
  near: bottom-center
}