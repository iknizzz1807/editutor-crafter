title: Two-Phase Commit Sink State Machine

shape: rectangle

init: "Start" {
  shape: circle
  style.fill: "#3fb950"
}

INITIALIZING: Initializing {
  style: {
    fill: "#0f3460"
    stroke: "#3fb950"
    font-color: "#e6edf3"
    bold: true
  }
}

IDLE: IDLE {
  style: {
    fill: "#0f3460"
    stroke: "#3fb950"
    font-color: "#e6edf3"
  }
}

PRE_COMMITTING: Pre-Committing {
  style: {
    fill: "#0f3460"
    stroke: "#3fb950"
    font-color: "#e6edf3"
    bold: true
  }
}

COMMITTING: Committing {
  style: {
    fill: "#0f3460"
    stroke: "#3fb950"
    font-color: "#e6edf3"
    bold: true
  }
}

ABORTING: Aborting {
  style: {
    fill: "#0f3460"
    stroke: "#3fb950"
    font-color: "#e6edf3"
    bold: true
  }
}

FAILED: Failed {
  style: {
    fill: "#0f3460"
    stroke: "#ff7b72"
    font-color: "#e6edf3"
    bold: true
  }
}

# Initial transition
init -> INITIALIZING

# Normal initialization flow
INITIALIZING -> IDLE: initialization complete

# Checkpoint start triggers pre-commit phase
IDLE -> PRE_COMMITTING: checkpoint started

# Pre-commit successful -> commit phase
PRE_COMMITTING -> COMMITTING: checkpoint completed (prepare phase)

# Commit successful -> back to idle
COMMITTING -> IDLE: checkpoint completed (commit phase)

# Failure transitions
PRE_COMMITTING -> ABORTING: failure detected
COMMITTING -> ABORTING: failure detected
ABORTING -> FAILED: abort failed/unrecoverable
ABORTING -> IDLE: abort completed (recovered)

# Self-loop for handling concurrent checkpoints
IDLE -> IDLE: checkpoint started (while already in checkpoint) {
  style.stroke-dash: 3
}

# Error handling for initialization
INITIALIZING -> FAILED: initialization failed

# Styling for the diagram
style {
  stroke: "#8b949e"
  font-color: "#e6edf3"
}