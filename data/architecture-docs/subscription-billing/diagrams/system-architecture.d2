direction: right

title: System Component Architecture {
  near: top-center
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
}

classes: {
  component: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.stroke-width: 2
  }
  storage: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  flow: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  critical: {
    style.stroke: "#3fb950"
    style.bold: true
    style.font-color: "#e6edf3"
  }
}

plan_management: Plan Management {
  class: component
  
  plan_store: Plan Store {
    shape: cylinder
    class: storage
  }
  
  plan_api: Plan API {
    class: component
  }
  
  pricing_engine: Pricing Engine {
    class: component
  }
  
  plan_api -> plan_store: "store/retrieve plans"
  pricing_engine -> plan_store: "fetch pricing rules"
}

subscription_engine: Subscription Engine {
  class: component
  
  sub_manager: Subscription Manager {
    class: component
  }
  
  lifecycle_handler: Lifecycle Handler {
    class: component
  }
  
  sub_store: Subscription Store {
    shape: cylinder
    class: storage
  }
  
  sub_manager -> sub_store: "manage subscriptions"
  lifecycle_handler -> sub_store: "update states"
}

usage_tracker: Usage Tracker {
  class: component
  
  meter_collector: Meter Collector {
    class: component
  }
  
  usage_aggregator: Usage Aggregator {
    class: component
  }
  
  usage_store: Usage Store {
    shape: cylinder
    class: storage
  }
  
  meter_collector -> usage_store: "store raw metrics"
  usage_aggregator -> usage_store: "aggregate usage data"
}

invoice_generator: Invoice Generator {
  class: component
  
  billing_engine: Billing Engine {
    class: component
  }
  
  proration_calc: Proration Calculator {
    class: component
  }
  
  invoice_store: Invoice Store {
    shape: cylinder
    class: storage
  }
  
  billing_engine -> invoice_store: "generate invoices"
  proration_calc -> billing_engine: "calculate prorations"
}

payment_processor: Payment Processor {
  class: component
  
  payment_gateway: Payment Gateway {
    class: component
  }
  
  retry_handler: Retry Handler {
    class: component
  }
  
  payment_store: Payment Store {
    shape: cylinder
    class: storage
  }
  
  payment_gateway -> payment_store: "record transactions"
  retry_handler -> payment_gateway: "retry failed payments"
}

# Main data flows
plan_management.pricing_engine -> subscription_engine.sub_manager: "pricing data" {
  class: flow
}

subscription_engine.sub_manager -> usage_tracker.meter_collector: "subscription events" {
  class: flow
}

usage_tracker.usage_aggregator -> invoice_generator.billing_engine: "usage data" {
  class: critical
}

subscription_engine.sub_store -> invoice_generator.billing_engine: "subscription details" {
  class: critical
}

plan_management.plan_store -> invoice_generator.billing_engine: "plan pricing" {
  class: critical
}

invoice_generator.invoice_store -> payment_processor.payment_gateway: "invoice data" {
  class: critical
}

payment_processor.payment_store -> subscription_engine.lifecycle_handler: "payment status" {
  class: flow
}

# External interactions
customer: Customer {
  shape: oval
  class: component
}

external_systems: External Systems {
  shape: cloud
  class: component
}

customer -> plan_management.plan_api: "select plans"
customer -> subscription_engine.sub_manager: "manage subscription"
external_systems -> usage_tracker.meter_collector: "usage events"
payment_processor.payment_gateway -> external_systems: "process payments"