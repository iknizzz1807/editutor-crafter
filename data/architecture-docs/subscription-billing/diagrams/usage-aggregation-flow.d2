classes: {
  source: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  process: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  storage: {
    style.fill: "#0f3460"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  decision: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

title: Usage Event Processing and Aggregation {
  style.font-size: 18
  style.bold: true
  style.font-color: "#e6edf3"
}

sources: Event Sources {
  class: source
  api: API Calls
  sdk: SDK Events
  webhooks: Webhook Events
}

ingestion: Event Ingestion {
  class: source
  gateway: Event Gateway {
    class: process
  }
  queue: Event Queue {
    shape: queue
    class: storage
  }
  gateway -> queue: raw events
}

dedup: Deduplication {
  class: process
  processor: Event Processor
  cache: Dedup Cache {
    shape: cylinder
    class: storage
  }
  duplicate_check: Duplicate? {
    shape: diamond
    class: decision
  }
  
  processor -> duplicate_check: check event
  processor -> cache: store fingerprint
}

aggregation: Aggregation Engine {
  class: source
  aggregator: Usage Aggregator {
    class: process
  }
  window: Time Window {
    class: process
  }
  metrics: Metric Store {
    shape: cylinder
    class: storage
  }
  
  aggregator -> window: group by time
  window -> metrics: store aggregates
}

billing: Billing Processing {
  class: source
  calculator: Charge Calculator {
    class: process
  }
  pricing: Pricing Rules {
    shape: page
    class: storage
  }
  charges: Billable Charges {
    shape: cylinder
    class: storage
  }
  
  calculator -> pricing: apply rules
  calculator -> charges: generate charges
}

sources -> ingestion.gateway: stream events
ingestion.queue -> dedup.processor: consume events

dedup.duplicate_check -> dedup.processor: no | discard {
  style.stroke: "#e74c3c"
}
dedup.duplicate_check -> aggregation.aggregator: yes | process {
  style.stroke: "#3fb950"
}

aggregation.metrics -> billing.calculator: usage data
billing.charges -> invoice: Invoice Generation {
  class: process
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}