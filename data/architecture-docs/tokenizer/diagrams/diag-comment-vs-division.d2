direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  ### The '/' Ambiguity Resolution Tree
  **Logic: One-Character Lookahead (LA(1))**
| {
  near: top-center
  shape: text
}

# Implementation Details
scanner_impl: {
  shape: class
  label: "Scanner Implementation (scanner.py)"
  
  methods: |md
    python
    def _match(self, expected: str) -> bool:
        if self.is_at_end() or self.source[self.current] != expected:
            return False
        self.advance()
        return True

    def _skip_line_comment(self) -> None:
        while not self.is_at_end() and self.peek() != '\n':
            self.advance()
    
  |
  
  dispatch: |md
    python
    elif char == '/':
        if self._match('/'):
            self._skip_line_comment()
            return None
        elif self._match('*'):
            return self._skip_block_comment()
        else:
            return self._make_token(TokenType.OPERATOR)
    
  |
}

# Visual Decision Tree
resolution_tree: {
  direction: down
  
  start: {
    shape: circle
    label: "Read '/'\n(Current char)"
    style.fill: "#C7F1FF"
  }

  lookahead: {
    label: "peek() next char\n(Lookahead)"
    shape: diamond
    style.fill: "#E4DBFE"
  }

  start -> lookahead: "char consumed"

  outcomes: {
    direction: right
    
    line_comment: {
      label: "Single-Line Comment"
      shape: rectangle
      style.fill: "#fce7c6"
      
      logic: "Mode: IN_LINE_COMMENT"
      action: "Consume until '\\n'"
      result: "Emit: None"
    }

    block_comment: {
      label: "Multi-Line Comment"
      shape: rectangle
      style.fill: "#fce7c6"
      
      logic: "Mode: IN_MULTI_COMMENT"
      action: "Consume until '*/'"
      result: "Emit: None | ERROR"
    }

    division: {
      label: "Division Operator"
      shape: rectangle
      style.fill: "#C5E1A5"
      
      logic: "Mode: NORMAL"
      action: "Snapshot lexeme"
      result: "Emit: TokenType.OPERATOR"
    }
  }

  lookahead -> outcomes.line_comment: "match('/') == True" {
    style.stroke: blue
    label: "Match '//'"
  }
  
  lookahead -> outcomes.block_comment: "match('*') == True" {
    style.stroke: purple
    label: "Match '/*'"
  }
  
  lookahead -> outcomes.division: "else" {
    style.stroke: green
    label: "No Match"
  }
}

# Legend and Metadata
legend: {
  near: bottom-right
  
  c1: "Yellow = Mode Change / Context Switch" {
    style.fill: "#fce7c6"
    shape: text
  }
  c2: "Green = Token Emission" {
    style.fill: "#C5E1A5"
    shape: text
  }
  c3: "Blue/Purple = LA(1) Path" {
    style.font-color: blue
    shape: text
  }
}

# Connectivity to global context
scanner_impl -> resolution_tree.start: "invokes dispatch"
resolution_tree.outcomes.division -> scanner_impl: "calls _make_token()"