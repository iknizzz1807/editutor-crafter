direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ---------------------------------------------------------------------------------
# LAYER 0: INPUT SOURCE (The Character Buffer)
# ---------------------------------------------------------------------------------
source_buffer: {
  shape: sql_table
  label: "Source String (memory)"
  
  row0: "idx: 00 | /"
  row1: "idx: 01 | *"
  row2: "idx: 02 | l"
  row3: "idx: 03 | i"
  row4: "idx: 04 | n"
  row5: "idx: 05 | e"
  row6: "idx: 06 | 1"
  row7: "idx: 07 | \\n (LF)"
  row8: "idx: 08 | l"
  row9: "idx: 09 | i"
  row10: "idx: 10 | n"
  row11: "idx: 11 | e"
  row12: "idx: 12 | 2"
  row13: "idx: 13 | \\n (LF)"
  row14: "idx: 14 | l"
  row15: "idx: 15 | i"
  row16: "idx: 16 | n"
  row17: "idx: 17 | e"
  row18: "idx: 18 | 3"
  row19: "idx: 19 | *"
  row20: "idx: 20 | /"
  row21: "idx: 21 |  "
  row22: "idx: 22 | x"
}

# ---------------------------------------------------------------------------------
# LAYER 1: THE CORE INVARIANT (Position Tracking Logic)
# ---------------------------------------------------------------------------------
core_engine: {
  direction: down
  label: "Scanner Core (scanner.py)"
  
  advance_method: {
    shape: class
    label: "Scanner.advance(self) -> str"
    definition: |md
      python
      def advance(self) -> str:
          char = self.source[self.current]
          self.current += 1
          if char == '\n':
              self.line += 1
              self.column = 1
          else:
              self.column += 1
          return char
      
    |
  }

  state: {
    shape: sql_table
    label: "Internal State"
    line: "line   | int | 1"
    column: "column | int | 1"
    current: "current| int | 0"
  }
}

# ---------------------------------------------------------------------------------
# LAYER 2: MODE CONTEXTS (Implicit State Machine)
# ---------------------------------------------------------------------------------
scanner_modes: {
  direction: down
  label: "Mode Handlers"

  comment_mode: {
    shape: class
    label: "_skip_block_comment(self)"
    body: |md
      python
      while not self.is_at_end():
          char = self.advance() # INVARIANT CALL
          if char == '*' and self.peek() == '/':
              self.advance()
              return
      
    |
  }

  string_mode: {
    shape: class
    label: "_scan_string(self)"
    body: |md
      python
      while not self.is_at_end() and self.peek() != '"':
          if self.peek() == '\n':
              return ERROR # line++ still happened via advance
          self.advance()   # INVARIANT CALL
      
    |
  }
}

# ---------------------------------------------------------------------------------
# LAYER 3: EXECUTION TRACE (Step-by-Step Evolution)
# ---------------------------------------------------------------------------------
execution_trace: {
  shape: sql_table
  label: "Trace: /* line1\\nline2\\nline3 */ x"
  
  h: "Step | Char | Mode | Line | Col | Action"
  s1: "1 | '/' | NORMAL | 1 | 2 | Enter Comment Mode"
  s2: "2 | '*' | COMMENT | 1 | 3 | Seek '*/'"
  s3: "3 | '\\n' | COMMENT | 2 | 1 | NEWLINE DETECTED -> line=2"
  s4: "4 | '\\n' | COMMENT | 3 | 1 | NEWLINE DETECTED -> line=3"
  s5: "5 | '/' | COMMENT | 3 | 14 | '*/' Found -> Exit Mode"
  s6: "6 | ' ' | NORMAL | 3 | 15 | Whitespace ignored"
  s7: "7 | 'x' | NORMAL | 3 | 16 | _make_token(IDENTIFIER)"
  
  label_bottom: "Result: Token(IDENTIFIER, 'x', line=3, col=16)"
}

# ---------------------------------------------------------------------------------
# CONNECTIONS & FLOW
# ---------------------------------------------------------------------------------

source_buffer -> core_engine.advance_method: "1 char | bytes[idx]"
core_engine.advance_method -> core_engine.state: "mutate"

scanner_modes.comment_mode -> core_engine.advance_method: "Calls in Loop"
scanner_modes.string_mode -> core_engine.advance_method: "Calls in Loop"

core_engine.state -> execution_trace: "Log State"

# Annotations
core_engine.advance_method -> core_engine.state: "Updates 'line' globally\nregardless of mode" {
  style: {
    stroke: green
    stroke-width: 2
    animated: true
  }
}

execution_trace.s7 -> final_token: "Emits"
final_token: {
  shape: code
  label: "Token(IDENTIFIER, 'x', line=3, col=16)"
  style.fill: "#DEE1EB"
}

legend: {
  near: bottom-right
  note: "Invariant: Line updates are bound to 'advance()',\nmaking position tracking mode-agnostic."
}