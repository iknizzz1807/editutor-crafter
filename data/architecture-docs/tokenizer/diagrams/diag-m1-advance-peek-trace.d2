direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# LEGEND / METADATA
legend: {
  shape: package
  label: "Scanner Trace: 'x + 3' (scanner.py)"
  near: top-left
  
  info: {
    shape: sql_table
    row1: "advance() | Consumes char, moves current++"
    row2: "peek()    | Returns char at current, no move"
    row3: "is_at_end()| Returns True if current >= len"
  }
}

# TRACE STEPS (Renamed from 'steps' to avoid board composition errors)
trace_flow: {
  direction: right

  # STEP 1: INITIAL CHARACTER
  s1: {
    label: "Step 1: Scan 'x'"
    direction: down
    
    source: {
      shape: sql_table
      header: "Source String (current=0)"
      i0: "0x00 | 'x' | <--"
      i1: "0x01 | ' '"
      i2: "0x02 | '+'"
      i3: "0x03 | ' '"
      i4: "0x04 | '3'"
    }

    logic: |md
      python
      # next_token()
      char = advance() # returns 'x'
      # current becomes 1, col becomes 2
      
    |
    
    emit: "Token(IDENTIFIER, 'x', 1, 1)"
    source -> logic -> emit
  }

  # STEP 2: WHITESPACE PEEK & ADVANCE
  s2: {
    label: "Step 2: Consume ' '"
    direction: down
    
    source: {
      shape: sql_table
      header: "Source String (current=1)"
      i0: "0x00 | 'x'"
      i1: "0x01 | ' ' | <--"
      i2: "0x02 | '+'"
      i3: "0x03 | ' '"
      i4: "0x04 | '3'"
    }

    logic: |md
      python
      # _skip_whitespace()
      if peek() == ' ':
          advance()
      # current becomes 2, col becomes 3
      
    |
    
    emit: "No Token (Skipped)"
    source -> logic -> emit
  }

  # STEP 3: OPERATOR
  s3: {
    label: "Step 3: Scan '+'"
    direction: down
    
    source: {
      shape: sql_table
      header: "Source String (current=2)"
      i0: "0x00 | 'x'"
      i1: "0x01 | ' '"
      i2: "0x02 | '+' | <--"
      i3: "0x03 | ' '"
      i4: "0x04 | '3'"
    }

    logic: |md
      python
      # next_token()
      char = advance() # returns '+'
      # current becomes 3, col becomes 4
      
    |
    
    emit: "Token(PLUS, '+', 1, 3)"
    source -> logic -> emit
  }

  # STEP 4: WHITESPACE
  s4: {
    label: "Step 4: Consume ' '"
    direction: down
    
    source: {
      shape: sql_table
      header: "Source String (current=3)"
      i0: "0x00 | 'x'"
      i1: "0x01 | ' '"
      i2: "0x02 | '+'"
      i3: "0x03 | ' ' | <--"
      i4: "0x04 | '3'"
    }

    logic: |md
      python
      # _skip_whitespace()
      advance() 
      # current becomes 4, col becomes 5
      
    |
    
    emit: "No Token (Skipped)"
    source -> logic -> emit
  }

  # STEP 5: NUMBER
  s5: {
    label: "Step 5: Scan '3'"
    direction: down
    
    source: {
      shape: sql_table
      header: "Source String (current=4)"
      i0: "0x00 | 'x'"
      i1: "0x01 | ' '"
      i2: "0x02 | '+'"
      i3: "0x03 | ' '"
      i4: "0x04 | '3' | <--"
    }

    logic: |md
      python
      # next_token() -> _scan_number()
      char = advance() # returns '3'
      # current becomes 5, col becomes 6
      
    |
    
    emit: "Token(NUMBER, '3', 1, 5)"
    source -> logic -> emit
  }

  # STEP 6: EOF
  s6: {
    label: "Step 6: Termination"
    direction: down
    
    source: {
      shape: sql_table
      header: "Source String (current=5)"
      i4: "0x04 | '3'"
      i5: "0x05 | END | <--"
    }

    logic: |md
      python
      # next_token()
      if is_at_end():
          return Token(EOF, "", 1, 6)
      
    |
    
    emit: "Token(EOF, '', 1, 6)"
    source -> logic -> emit
  }
}

# FLOW CONNECTORS
trace_flow.s1 -> trace_flow.s2: "char consumed"
trace_flow.s2 -> trace_flow.s3: "WS skipped"
trace_flow.s3 -> trace_flow.s4: "char consumed"
trace_flow.s4 -> trace_flow.s5: "WS skipped"
trace_flow.s5 -> trace_flow.s6: "char consumed"

# STYLING
trace_flow.s2.emit.style.stroke-dash: 5
trace_flow.s4.emit.style.stroke-dash: 5
trace_flow.s6.emit.style.fill: "#E4DBFE" # Purple for sentinel
trace_flow.**.source.style.font: mono
trace_flow.**.emit.style.bold: true