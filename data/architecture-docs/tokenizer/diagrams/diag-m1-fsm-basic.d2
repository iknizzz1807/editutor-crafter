direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- Classes & Styling ---
classes: {
  state: {
    shape: circle
    style: {
      stroke-width: 2
      fill: "#f8f9fa"
    }
  }
  terminal: {
    shape: circle
    style: {
      stroke-width: 4
      double-border: true
      fill: "#e9ecef"
    }
  }
  action: {
    shape: rectangle
    style: {
      stroke-dash: 3
      border-radius: 5
    }
  }
  method_box: {
    shape: class
    style: {
      fill: "#ffffff"
    }
  }
}

# --- Component Definition ---
scanner_logic: {
  label: "class Scanner (scanner.py)"
  class: method_box
  
  definition: |md
    python
    def next_token(self) -> Token:
        self._skip_whitespace()
        tok_line = self.line
        tok_col = self.column
        if self.is_at_end():
            return Token(TokenType.EOF, ...)
        char = self.advance()
        # ... dispatch logic ...
    
  |
}

# --- Finite State Machine ---
fsm: {
  label: "Scanner FSM: Milestone 1 Basic States"
  
  START: {
    class: state
    label: "START\n(next_token)"
    tooltip: "Entry point for scanning one token"
  }

  SKIP_WHITESPACE: {
    class: state
    label: "SKIP\nWHITESPACE"
    tooltip: "Consumes ' ', \\t, \\r, \\n"
  }

  EMIT_SINGLE_CHAR: {
    class: terminal
    label: "EMIT\nSINGLE_CHAR"
    style.fill: "#d4edda"
  }

  EMIT_ERROR: {
    class: terminal
    label: "EMIT\nERROR"
    style.fill: "#f8d7da"
  }

  EMIT_EOF: {
    class: terminal
    label: "EMIT\nEOF"
    style.fill: "#cce5ff"
  }

  # --- Transitions ---
  
  # 1. Whitespace handling (The loop)
  START -> SKIP_WHITESPACE: "peek() in WHITESPACE"
  SKIP_WHITESPACE -> SKIP_WHITESPACE: "advance()"
  SKIP_WHITESPACE -> START: "!peek() in WHITESPACE"

  # 2. Boundary Condition
  START -> EMIT_EOF: "is_at_end() == True"

  # 3. Main Dispatch (The Munch)
  START -> EMIT_SINGLE_CHAR: "char in SINGLE_CHAR_TOKENS" {
    label: "advance() -> char"
  }

  # 4. Fallback/Error
  START -> EMIT_ERROR: "else" {
    label: "advance() -> char"
  }
}

# --- Implementation Details ---
data_structures: {
  direction: down
  
  token_table: {
    shape: sql_table
    label: "SINGLE_CHAR_TOKENS"
    
    "+" : TokenType.PLUS
    "-" : TokenType.MINUS
    "*" : TokenType.STAR
    "/" : TokenType.SLASH
    "(" : TokenType.LPAREN
    ")" : TokenType.RPAREN
    "{" : TokenType.LBRACE
    "}" : TokenType.RBRACE
    "[" : TokenType.LBRACKET
    "]" : TokenType.RBRACKET
    ";" : TokenType.SEMICOLON
    "," : TokenType.COMMA
  }

  pos_tracking: {
    shape: class
    label: "Position Update Logic"
    on_advance: |md
      python
      if char == "\n":
          line += 1
          column = 1
      else:
          column += 1
      
    |
  }
}

# --- Layout Connections ---
scanner_logic -> fsm: "implements logic"
fsm.EMIT_SINGLE_CHAR -> data_structures.token_table: "lookups type"
fsm.SKIP_WHITESPACE -> data_structures.pos_tracking: "triggers"