direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- SATELLITE CONTEXT ---
# Component: Scanner (scanner.py)
# Part of Tokenizer Pipeline: Character-Level Scanner

scanner_definition: {
  shape: class
  label: "Scanner (scanner.py)"
  
  fields: |md
    python
    source: str   # Full source text
    current: int  # [Offset: 0x00] Pointer to NEXT char
    line: int     # [Offset: 0x08] 1-indexed current line
    column: int   # [Offset: 0x10] 1-indexed NEXT column
    
  |
  
  methods: |md
    python
    def advance(self) -> str:
        char = self.source[self.current]
        self.current += 1
        if char == "\n":
            self.line += 1
            self.column = 1
        else:
            self.column += 1
        return char
    
  |
}

state_trace: {
  label: "State Evolution Trace: 'a + b\\n  c'"
  direction: right

  # Initial State
  s0: {
    shape: sql_table
    label: "T0: Initial"
    r1: "0x00 | int | current: 0"
    r2: "0x08 | int | line: 1"
    r3: "0x10 | int | column: 1"
    label_bottom: "Total: 24 bytes"
  }

  s1: {
    shape: sql_table
    label: "T1: After 'a'"
    r1: "0x00 | int | current: 1"
    r2: "0x08 | int | line: 1"
    r3: "0x10 | int | column: 2"
  }

  s2: {
    shape: sql_table
    label: "T2: After ' '"
    r1: "0x00 | int | current: 2"
    r2: "0x08 | int | line: 1"
    r3: "0x10 | int | column: 3"
  }

  s3: {
    shape: sql_table
    label: "T3: After '+'"
    r1: "0x00 | int | current: 3"
    r2: "0x08 | int | line: 1"
    r3: "0x10 | int | column: 4"
  }

  s4: {
    shape: sql_table
    label: "T4: After ' '"
    r1: "0x00 | int | current: 4"
    r2: "0x08 | int | line: 1"
    r3: "0x10 | int | column: 5"
  }

  s5: {
    shape: sql_table
    label: "T5: After 'b'"
    r1: "0x00 | int | current: 5"
    r2: "0x08 | int | line: 1"
    r3: "0x10 | int | column: 6"
  }

  s6: {
    shape: sql_table
    label: "T6: After '\\n'"
    r1: "0x00 | int | current: 6"
    r2: "0x08 | int | line: 2"
    r3: "0x10 | int | column: 1"
    style: {
      fill: "#E4DBFE"
      stroke: "#3b2e5a"
      stroke-width: 3
    }
  }

  s7: {
    shape: sql_table
    label: "T7: After ' '"
    r1: "0x00 | int | current: 7"
    r2: "0x08 | int | line: 2"
    r3: "0x10 | int | column: 2"
  }

  s8: {
    shape: sql_table
    label: "T8: After ' '"
    r1: "0x00 | int | current: 8"
    r2: "0x08 | int | line: 2"
    r3: "0x10 | int | column: 3"
  }

  s9: {
    shape: sql_table
    label: "T9: After 'c'"
    r1: "0x00 | int | current: 9"
    r2: "0x08 | int | line: 2"
    r3: "0x10 | int | column: 4"
  }

  # Connections with labels showing the consumed char
  s0 -> s1: "char | 1B | 'a'"
  s1 -> s2: "char | 1B | ' '"
  s2 -> s3: "char | 1B | '+'"
  s3 -> s4: "char | 1B | ' '"
  s4 -> s5: "char | 1B | 'b'"
  s5 -> s6: "char | 1B | '\\n' (Line++ Col=1)"
  s6 -> s7: "char | 1B | ' '"
  s7 -> s8: "char | 1B | ' '"
  s8 -> s9: "char | 1B | 'c'"
}

windows_logic: {
  near: bottom-right
  shape: rectangle
  label: |md
    ### Windows CRLF Logic (\r\n)
    `\r` treated as whitespace.
    1. `advance('\r')` -> `line: N, col: M+1`
    2. `advance('\n')` -> `line: N+1, col: 1`
    
    Total: One line increment. Reference: (scanner.py:84)
  |
  style: {
    fill: "#FFF9C9"
    stroke: "#9D341E"
    stroke-dash: 3
  }
}

token_capture_rule: {
  near: top-left
  shape: rectangle
  label: "CRITICAL: Captured (line, column) must occur BEFORE advance() to point to token start."
  style: {
    stroke: red
    stroke-width: 4
    fill: "#FFE7CB"
  }
}

# Layout & Implementation references
scanner_definition -> state_trace: "calls advance() on source stream"
state_trace.s6 -> windows_logic: "reset trigger" {
  style.stroke-dash: 3
}