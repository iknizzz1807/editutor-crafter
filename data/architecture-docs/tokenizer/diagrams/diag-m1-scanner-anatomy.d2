direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

scanner_anatomy: {
  label: "struct Scanner (scanner.py) - Character-Level State Machine"
  
  # Layer 0: Memory and Data Representation
  internal_state: {
    direction: down
    label: "DATA SEGMENT"
    
    struct_def: {
      shape: sql_table
      label: "Scanner Memory Layout (scanner.py)"
      row1: "0x00 | char*    | source  | Raw UTF-8 string buffer"
      row2: "0x08 | uint32_t | current | Cursor index for next byte"
      row3: "0x0C | uint32_t | start   | Start of current lexeme"
      row4: "0x10 | uint32_t | line    | 1-based line counter"
      row5: "0x14 | uint32_t | column  | 1-based column counter"
      label_bottom: "Total: 24 bytes (x86_64 alignment)"
    }

    source_tape: {
      shape: sql_table
      label: "Source Buffer Indexing"
      indices: "Offset | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10"
      chars:   "Data   | i | f |   | ( | x |   | > |   | 0 | ) | \\0"
    }

    # Pointer Grouping
    cursors: {
      direction: right
      label: "Virtual Pointers"
      
      start_marker: {
        shape: circle
        label: "start"
        style: {
          fill: "#E4DBFE"
          stroke: "#333"
        }
      }
      current_marker: {
        shape: circle
        label: "current"
        style: {
          fill: "#C7F1FF"
          stroke: "#333"
          bold: true
          stroke-width: 3
        }
      }
    }
    
    cursors.start_marker -> source_tape.chars: "Offset 0"
    cursors.current_marker -> source_tape.chars: "Offset 2"
  }

  # Layer 1: Operational Primitives
  ops_logic: {
    direction: down
    label: "INSTRUCTION LOGIC"

    advance_op: {
      label: "advance() -> str (scanner.py)"
      content: |md
        python
        # CONSUMING: Returns current char and moves pointer
        char = source[current]
        current += 1
        if char == "\n":
            line += 1
            column = 1
        else:
            column += 1
        return char
        
      |
    }

    peek_op: {
      label: "peek() -> str (scanner.py)"
      content: |md
        python
        # NON-CONSUMING: Lookahead without pointer mutation
        if is_at_end(): 
            return "\0"
        return source[current]
        
      |
    }
  }

  # Functional Interconnects
  internal_state.source_tape -> ops_logic.peek_op: "char | 1 byte | READ"
  internal_state.source_tape -> ops_logic.advance_op: "char | 1 byte | FETCH"
  
  # Connection representing logic dependency
  ops_logic.advance_op -> internal_state.struct_def.row2: "Update current" {
    style: {
      stroke: "#167c3c"
      stroke-dash: 5
    }
  }
}

# Root-level Legend - Using constant for 'near' as required by ELK
machine_legend: {
  shape: text
  near: bottom-right
  label: "VISUAL KEY:\nBlue (Circle) = Active Cursor Pointer\nPurple (Circle) = Lexeme Start Alignment"
  style: {
    font-size: 14
    italic: true
  }
}

# Annotated movement flow tracking
scanner_anatomy.internal_state.cursors.current_marker -> scanner_anatomy.ops_logic.advance_op: "State Transition: current++" {
  style: {
    stroke-dash: 5
    animated: true
    stroke: blue
    stroke-width: 2
  }
}

scanner_anatomy.ops_logic.peek_op -> scanner_anatomy.internal_state.cursors.current_marker: "Guard: current < len" {
  style: {
    stroke: gray
    stroke-dash: 3
  }
}