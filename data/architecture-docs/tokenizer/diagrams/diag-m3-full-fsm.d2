direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 3
  }
}

title: |md
  # Scanner Finite State Machine (FSM)
  **Specification**: Character-Level Deterministic Lexical Scanner
  **Language**: C-Style / Python / Rust
| {
  near: top-center
}

# --------------------------------------------------------------------------------
# L2: DATA STRUCTURES (Memory Layout)
# --------------------------------------------------------------------------------
implementation_details: {
  direction: down
  
  token_layout: {
    shape: sql_table
    label: "struct Token (token.h)"
    
    row1: "0x00 | uint32_t | type (enum)"
    row2: "0x04 | uint32_t | line"
    row3: "0x08 | uint32_t | column"
    row4: "0x10 | char*    | lexeme_ptr"
    row5: "0x18 | size_t   | length"
    
    label_bottom: "Total: 32 bytes (aligned)"
  }

  scanner_state: {
    shape: class
    label: "Scanner Controller (scanner.py)"
    
    fields: |md
      python
      source: str   # Input buffer
      start: int    # Start of lexeme
      current: int  # Current cursor
      line: int     # Source line tracker
      col: int      # Column tracker
      
    |
    
    methods: |md
      python
      def scan_token(self) -> Token:
      def is_at_end(self) -> bool:
      def advance(self) -> str:
      def peek(self) -> str:
      def match(self, expected: str) -> bool:
      
    |
  }
}

# --------------------------------------------------------------------------------
# L1: FINITE STATE MACHINE (Logic Flow)
# --------------------------------------------------------------------------------
fsm: {
  direction: right
  label: "DFA State Transition Map"
  
  # Entry Node
  START: {
    shape: circle
    label: "START\n(Peek Char)"
    style: {
      fill: "#FFF9C9"
      stroke-width: 3
    }
  }

  # Intermediate Processing Nodes
  IN_NUMBER: "IN_NUMBER\n(Consume Digits)"
  IN_FLOAT: "IN_FLOAT\n(Decimal Path)"
  IN_IDENTIFIER: "IN_IDENTIFIER\n(Trie/Hash Lookup)"
  IN_STRING: "IN_STRING\n(Buffer Literacy)"
  IN_ESCAPE: "IN_ESCAPE\n(Backslash Logic)"
  IN_OP_LOOKAHEAD: "OP_LOOKAHEAD\n(Multi-char ops)"
  DIV_CHECK: "DIV_OR_COMMENT\n(/)"
  IN_COMMENT_LINE: "COMMENT_LINE\n(Seek EOL)"
  IN_COMMENT_BLOCK: "COMMENT_BLOCK\n(Seek */)"

  # Terminal Nodes (Corrected syntax)
  EMIT_TOKEN: {
    shape: circle
    label: "EMIT_TOKEN\n(Success)"
    style: {
      double-border: true
      fill: "#ACE1AF"
    }
  }
  
  EMIT_ERROR: {
    shape: circle
    label: "LEX_ERROR\n(Failure)"
    style: {
      double-border: true
      fill: "#FE7070"
    }
  }
  
  EMIT_EOF: {
    shape: circle
    label: "HALT\n(EOF)"
    style: {
      double-border: true
      fill: "#B5AFF6"
    }
  }

  # Transitions: START Path
  START -> EMIT_EOF: "\\0 | EOF"
  START -> IN_NUMBER: "[0-9]"
  START -> IN_IDENTIFIER: "[a-zA-Z_]"
  START -> IN_STRING: "\""
  START -> IN_OP_LOOKAHEAD: "[=!<> ]"
  START -> DIV_CHECK: "/"
  START -> EMIT_TOKEN: "[( ) { } [ ] ; , + - *]"
  START -> START: "whitespace | ignore"
  START -> EMIT_ERROR: "else | Unrecognized"

  # Transitions: Numeric Path
  IN_NUMBER -> IN_NUMBER: "[0-9]"
  IN_NUMBER -> IN_FLOAT: ". && peek_next().isdigit()"
  IN_FLOAT -> IN_FLOAT: "[0-9]"
  IN_NUMBER -> EMIT_TOKEN: "else | [TOKEN_INT]"
  IN_FLOAT -> EMIT_TOKEN: "else | [TOKEN_FLOAT]"

  # Transitions: Lexical Identity
  IN_IDENTIFIER -> IN_IDENTIFIER: "[a-zA-Z0-9_]"
  IN_IDENTIFIER -> EMIT_TOKEN: "else | Keyword Match?"

  # Transitions: String Literal Path
  IN_STRING -> IN_STRING: "any except [\" \\ \\n]"
  IN_STRING -> IN_ESCAPE: "\\"
  IN_ESCAPE -> IN_STRING: "[n t r \" \\]"
  IN_ESCAPE -> EMIT_ERROR: "Invalid Escape Sequence"
  IN_STRING -> EMIT_TOKEN: "\""
  IN_STRING -> EMIT_ERROR: "\\n or EOF | Unterminated"

  # Transitions: Operator Lookahead (LL(1))
  IN_OP_LOOKAHEAD -> EMIT_TOKEN: "match('=') ? OP_2 : OP_1"

  # Transitions: Comments vs Division
  DIV_CHECK -> IN_COMMENT_LINE: "/"
  DIV_CHECK -> IN_COMMENT_BLOCK: "*"
  DIV_CHECK -> EMIT_TOKEN: "else | TOKEN_SLASH"
  
  IN_COMMENT_LINE -> START: "\\n or EOF"
  IN_COMMENT_BLOCK -> START: "*/"
  IN_COMMENT_BLOCK -> EMIT_ERROR: "EOF | Unterminated Comment"
}

# --------------------------------------------------------------------------------
# ANNOTATIONS & LEGEND
# --------------------------------------------------------------------------------
annotations: {
  near: bottom-right
  direction: down
  
  l1: "Algorithm: O(N) Time | O(1) Space (Excl. Tokens)" {shape: text}
  l2: "Principle: Greedy Maximal Munch" {shape: text}
  l3: "Memory: Single allocation input buffer" {shape: text}
}

# Architectural Links
implementation_details.scanner_state -> fsm: "Drives State Machine" {
  style: {
    stroke-dash: 5
    stroke: "#88DCF7"
  }
}

fsm.EMIT_TOKEN -> implementation_details.token_layout: "Instantiates" {
  style: {
    stroke-dash: 5
    stroke: "#ACE1AF"
  }
}