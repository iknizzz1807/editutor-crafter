direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# CLASS DEFINITIONS
classes: {
  table_header: {
    style: {
      fill: "#2d3436"
      font-color: white
      bold: true
      font-size: 14
    }
  }
  m1: { style: { fill: "#e1f5fe"; stroke: "#01579b" } }
  m2: { style: { fill: "#f3e5f5"; stroke: "#4a148c" } }
  m3: { style: { fill: "#fff3e0"; stroke: "#e65100" } }
  m4: { style: { fill: "#ffebee"; stroke: "#b71c1c" } }
  code_font: {
    style: {
      font: mono
      font-size: 12
    }
  }
}

edge_case_map: {
  label: "Edge Case Decision Map: Scanner Logic (scanner.py)"
  grid-columns: 3
  grid-gap: 0

  # HEADER ROW
  h_input: "Raw Input Source" { class: table_header }
  h_output: "Expected Token Stream (Type, Lexeme, Pos)" { class: table_header }
  h_logic: "Handling Logic / Milestone" { class: table_header }

  # ROW 1: Empty Input
  r1_in: |md
    `""`
    (Empty File)
  | { class: code_font }
  r1_out: |md
    `[Token(EOF, "", 1:1)]`
  | { class: code_font }
  r1_log: "M1: Scanner Foundation\nInitial state handles empty buffer." { class: m1 }

  # ROW 2: Single Character
  r2_in: |md
    `"x"`
  | { class: code_font }
  r2_out: |md
    `[Token(IDENT, "x", 1:1), Token(EOF, "", 1:2)]`
  | { class: code_font }
  r2_log: "M2: Identifiers\nAlphanumeric scan + EOF sentinel." { class: m2 }

  # ROW 3: Just Whitespace
  r3_in: |md
    `"   "`
  | { class: code_font }
  r3_out: |md
    `[Token(EOF, "", 1:4)]`
  | { class: code_font }
  r3_log: "M1: Foundation\n_skip_whitespace consumes without emission." { class: m1 }

  # ROW 4: Unterminated String
  r4_in: |md
    `"\"hello"`
  | { class: code_font }
  r4_out: |md
    `[Token(ERROR, "\"hello", 1:1), Token(EOF, "", 1:7)]`
  | { class: code_font }
  r4_log: "M3: Strings\nDetects EOF inside _scan_string loop." { class: m3 }

  # ROW 5: Consecutive Errors
  r5_in: |md
    `"@@#"`
  | { class: code_font }
  r5_out: |md
    `[Token(ERR, "@", 1:1), Token(ERR, "@", 1:2), Token(ERR, "#", 1:3), Token(EOF, "", 1:4)]`
  | { class: code_font }
  r5_log: "M4: Error Recovery\nPanic-mode recovery: advance 1 char and resume." { class: m4 }

  # ROW 6: Number then Identifier
  r6_in: |md
    `"42abc"`
  | { class: code_font }
  r6_out: |md
    `[Token(NUM, "42", 1:1), Token(IDENT, "abc", 1:3), Token(EOF, "", 1:6)]`
  | { class: code_font }
  r6_log: "M2: Maximal Munch\nDigit scan terminates at non-digit boundary." { class: m2 }

  # ROW 7: Empty String Literal
  r7_in: |md
    `"\"\""`
  | { class: code_font }
  r7_out: |md
    `[Token(STRING, "\"\"", 1:1), Token(EOF, "", 1:3)]`
  | { class: code_font }
  r7_log: "M3: Strings\nImmediate exit of _scan_string loop on \"." { class: m3 }
}

legend: {
  near: bottom-center
  direction: right
  m1_l: Milestone 1 { class: m1 }
  m2_l: Milestone 2 { class: m2 }
  m3_l: Milestone 3 { class: m3 }
  m4_l: Milestone 4 { class: m4 }
}

# Metadata Annotations - Fixed 'near' targeting to use absolute position keyword
note: |md
  ### Scanner Invariants (Verified in M4)
  1. **O(n) Time**: Every character visited exactly once via `advance()`.
  2. **Non-decreasing Columns**: Token column always increases within a line.
  3. **Sentinel Integrity**: Every stream MUST end with `TokenType.EOF`.
| {
  near: top-right
  style: {
    stroke: "#7f8c8d"
    fill: "#fdfefe"
    stroke-width: 2
  }
}