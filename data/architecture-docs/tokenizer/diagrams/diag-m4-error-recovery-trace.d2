direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- Metadata ---
title: "Trace: Scanner Error Recovery (scanner.py)" {
  shape: text
  near: top-center
  style: {
    font-size: 24
    bold: true
  }
}

# --- Implementation Components ---

# Layer 1: Internal Memory State
memory_layout: {
  direction: down
  label: "MEMORY STATE (scanner.h)"
  scanner_def: {
    shape: sql_table
    label: "struct Scanner"
    
    row1: "0x00 | const char* | source   | 'x @ y = 5'"
    row2: "0x08 | uint32_t    | current  | offset 0x02 ('@')"
    row3: "0x0C | uint32_t    | line     | 1"
    row4: "0x10 | uint32_t    | column   | 3"
    label_bottom: "Total: 20 bytes (Packed)"
  }
}

# Layer 2: Execution Trace
execution_trace: {
  direction: down
  label: "Execution Flow: next_token() Walkthrough"

  s1: {
    label: "Step 1: Match Identifier"
    state: "cur: 0 | col: 1 | char: 'x'"
    op: "advance() -> 'x' | is_alpha()"
    res: "yield Token(IDENTIFIER, 'x', 1:1)"
    style.fill: "#E1F5FE"
  }

  s2: {
    label: "Step 2: Consume WS"
    state: "cur: 1 | col: 2 | char: ' '"
    op: "_skip_whitespace() loop"
    res: "Internal state update only"
    style.fill: "#F5F5F5"
  }

  s3: {
    label: "Step 3: Error Encounter"
    state: "cur: 2 | col: 3 | char: '@'"
    op: "advance() -> '@' | DEFAULT path"
    res: "yield Token(ERROR, '@', 1:3)"
    style: {
      fill: "#FFEBEE"
      stroke: red
      stroke-width: 2
    }
  }

  s4: {
    label: "Step 4: Sync & Resume"
    state: "cur: 4 | col: 5 | char: 'y'"
    op: "next_token() restart"
    res: "yield Token(IDENTIFIER, 'y', 1:5)"
    style.fill: "#E1F5FE"
  }

  s5: {
    label: "Step 5: Operator"
    state: "cur: 6 | col: 7 | char: '='"
    op: "advance() -> '=' | peek() != '='"
    res: "yield Token(ASSIGN, '=', 1:7)"
    style.fill: "#E8F5E9"
  }

  s6: {
    label: "Step 6: Literal"
    state: "cur: 8 | col: 9 | char: '5'"
    op: "advance() -> '5' | is_digit()"
    res: "yield Token(NUMBER, '5', 1:9)"
    style.fill: "#FFF3E0"
  }

  s7: {
    label: "Step 7: EOF"
    state: "cur: 9 | EOF"
    op: "is_at_end() -> True"
    res: "yield Token(EOF, '', 1:10)"
    style.fill: "#ECEFF1"
  }

  s1 -> s2: "next_token()"
  s2 -> s3: "next_token()"
  s3 -> s4: "loop_continue()"
  s4 -> s5: "next_token()"
  s5 -> s6: "next_token()"
  s6 -> s7: "next_token()"
}

# Layer 3: Resulting Object Graph
token_output: {
  label: "Final Output: list[Token]"
  direction: right

  t1: "IDENT('x')"
  t2: "ERROR('@')" { style.stroke: red; style.font-color: red }
  t3: "IDENT('y')"
  t4: "ASSIGN('=')"
  t5: "NUMBER('5')"
  t6: "EOF"

  t1 -> t2 -> t3 -> t4 -> t5 -> t6
}

# --- Relationships & Annotations ---

memory_layout.scanner_def -> execution_trace.s1: "source_ptr"
execution_trace -> token_output: "yield stream" {
  style: {
    stroke-width: 4
    stroke: "#2196F3"
  }
}

recovery_logic: |md
  ### Implementation Insight: Recovery
  - **Character Level**: The `@` is unexpected.
  - **Invariant**: `advance()` moves the cursor regardless of match.
  - **State**: The `Scanner` object remains valid.
  - **Loop**: `scan_tokens()` continues to call `next_token()` until `EOF`.
| {
  near: bottom-center
}

# Apply global styles
execution_trace.*.shape: sql_table
token_output.*.shape: rectangle
token_output.*.style.border-radius: 4