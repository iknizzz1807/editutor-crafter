direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- CLASSES & STYLING ---
classes: {
  state_base: {
    shape: circle
    style: {
      stroke-width: 2
      font-size: 14
      bold: true
    }
  }
  accepting: {
    shape: circle
    style: {
      stroke-width: 2
      double-border: true
      fill: "#e1f5fe"
      font-size: 14
      bold: true
    }
  }
  transitional: {
    shape: circle
    style: {
      stroke-width: 2
      stroke-dash: 3
      fill: "#fff9c4"
      font-size: 14
      bold: true
    }
  }
  error_path: {
    style: {
      stroke: red
      stroke-dash: 3
      font-color: red
      bold: true
    }
  }
  logic_note: {
    shape: rectangle
    style: {
      fill: "#f7f9f9"
      border-radius: 4
      stroke: "#cfd8dc"
    }
  }
}

# --- NODES ---

START: {
  label: "START\n(idle)"
  class: state_base
}

DIGITS: {
  label: "DIGITS\n(Integer Part)"
  class: accepting
  tooltip: "Valid Integer Token Found | [0-9]+"
}

DOT_SEEN: {
  label: "DOT_SEEN\n(Lookahead)"
  class: transitional
  tooltip: "Character '.' consumed, must verify LA(1) is digit"
}

FRACTION_DIGITS: {
  label: "FRACTION_DIGITS\n(Float Part)"
  class: accepting
  tooltip: "Valid Float Token Found | [0-9]+\\.[0-9]+"
}

EMIT: {
  shape: package
  label: "EMIT TokenType.NUMBER (scanner.py)"
  style: {
    fill: "#c8e6c9"
    stroke: "#2e7d32"
    stroke-width: 2
  }
}

# --- TRANSITIONS ---

START -> DIGITS: "char | 1 byte | is_digit()" {
  tooltip: "Scanner enters numeric mode"
}

DIGITS -> DIGITS: "char | 1 byte | is_digit()" {
  style.stroke-dash: 0
}

DIGITS -> DOT_SEEN: "'.' | 1 byte | peek() == '.'"

DOT_SEEN -> FRACTION_DIGITS: "char | 1 byte | is_digit()" {
  label: "LA(2) Match"
}

FRACTION_DIGITS -> FRACTION_DIGITS: "char | 1 byte | is_digit()"

# --- TERMINATION / EMISSION ---

DIGITS -> EMIT: "other | 0 bytes | !is_digit() && !'.'" {
  style: {
    stroke-dash: 5
    stroke-width: 2
  }
}

FRACTION_DIGITS -> EMIT: "other | 0 bytes | !is_digit()" {
  style: {
    stroke-dash: 5
    stroke-width: 2
  }
}

# --- SPECIAL CASE: REJECTION / BACKTRACK ---

DOT_SEEN -> EMIT: "non-digit | 0 bytes | Backtrack" {
  class: error_path
  label: "Reject: '3.' is Invalid"
}

# --- ANNOTATIONS ---

logic_implementation: |md
  ### Implementation Logic (scanner.py)
  python
  def _scan_number(self):
      # Consume integer part
      while self.peek().isdigit():
          self.advance()

      # Lookahead (2) for fractional part
      # Requires both '.' and following digit
      if self.peek() == '.' and self.peek_next().isdigit():
          self.advance() # consume '.'
          while self.peek().isdigit():
              self.advance()

      self.add_token(TokenType.NUMBER)
  
| {
  near: bottom-center
  class: logic_note
}

legend: {
  near: bottom-right
  direction: down
  label: "FSM Legend"
  
  a: "Double Border = Accepting State" {
    class: accepting
    width: 250
  }
  b: "Dashed = Internal/Transitional" {
    class: transitional
    width: 250
  }
  c: "Red Dashed = Rejection/Backtrack" {
    class: error_path
    width: 250
  }
}

# --- FILE REFERENCES ---
file_ref: {
  shape: text
  label: "Source: scanner.py -> _scan_number()"
  near: top-right
  style: {
    font-size: 12
    italic: true
    font-color: "#546e7a"
  }
}