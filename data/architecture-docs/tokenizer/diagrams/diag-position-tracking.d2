direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# L0: STATE EVOLUTION LAYER
scanner_evolution: {
  direction: right
  label: "Scanner Position State Evolution (scanner.py)"

  initial: {
    shape: sql_table
    label: "T0: Initial State"
    row1: "0x00 | uint32_t | line    | 1"
    row2: "0x04 | uint32_t | column  | 1"
    row3: "0x08 | uint32_t | current | 0"
    label_bottom: "Buffer: [x = 5\\nif]"
  }

  char_x: {
    shape: sql_table
    label: "T1: Consume 'x'"
    row1: "0x00 | uint32_t | line    | 1"
    row2: "0x04 | uint32_t | column  | 2"
    row3: "0x08 | uint32_t | current | 1"
    label_bottom: "advance() -> 'x'"
  }

  char_space: {
    shape: sql_table
    label: "T2: Consume ' '"
    row1: "0x00 | uint32_t | line    | 1"
    row2: "0x04 | uint32_t | column  | 3"
    row3: "0x08 | uint32_t | current | 2"
    label_bottom: "advance() -> ' '"
  }

  char_newline: {
    shape: sql_table
    label: "T3: Consume '\\n'"
    row1: "0x00 | uint32_t | line    | 2"
    row2: "0x04 | uint32_t | column  | 1"
    row3: "0x08 | uint32_t | current | 6"
    label_bottom: "char == '\\n' => line++, col=1"
    style: {
      stroke: "#ca052b"
      stroke-width: 4
      fill: "#fff0f0"
    }
  }

  char_i: {
    shape: sql_table
    label: "T4: Consume 'i'"
    row1: "0x00 | uint32_t | line    | 2"
    row2: "0x04 | uint32_t | column  | 2"
    row3: "0x08 | uint32_t | current | 7"
    label_bottom: "advance() -> 'i'"
  }

  initial -> char_x: "1B | str[0] | 'x'"
  char_x -> char_space: "1B | str[1] | ' '"
  char_space -> char_newline: "1B | str[5] | '\\n'" {
    style: {
      stroke: "#ca052b"
      animated: true
    }
  }
  char_newline -> char_i: "1B | str[6] | 'i'"
}

# LOGIC AND EDGE CASES LAYER
logic_layer: {
  direction: down
  
  windows_handling: {
    shape: package
    label: "Windows Edge Case: \\r\\n (scanner.py)"
    
    logic: |md
      python
      # char == '\r'
      if char == '\r':
          # Treated as standard whitespace
          self.column += 1 
      
      # char == '\n'
      elif char == '\n':
          # Line break logic triggers
          self.line += 1
          self.column = 1
      
    |
    
    note: "Invariant: line count incremented exactly once per CRLF pair." {
      style.italic: true
      style.font-size: 11
    }
  }

  scanner_logic: {
    label: "Position Logic Implementation (advance.py)"
    
    advance_fn: |md
      python
      def advance(self) -> str:
          char = self.source[self.current]
          self.current += 1
          if char == '\n':
              self.line += 1
              self.column = 1
          elif char == '\t':
              self.column += self.tab_width
          else:
              self.column += 1
          return char
      
    |
    
    snapshot_rule: {
      shape: text
      label: "CRITICAL: Start column must be captured BEFORE advance() call"
      style: {
        font-color: "#ca052b"
        bold: true
      }
    }
  }
}

# CROSS-LAYER FLOWS
scanner_evolution.char_newline -> logic_layer.windows_handling: "Edge Case Logic" {
  style.stroke-dash: 5
}
scanner_evolution.initial -> logic_layer.scanner_logic.advance_fn: "calls" {
  style.stroke-dash: 3
}

# LEGEND / DOCUMENTATION
legend: {
  near: bottom-right
  direction: down
  label: "Visual Key"
  
  l1: "Blue Arrow: Standard Byte Advance" {
    style: {
      font-color: blue
      stroke: blue
    }
  }
  l2: "Red/Animated Arrow: LF State Reset (line++, col=1)" {
    style: {
      font-color: "#ca052b"
      stroke: "#ca052b"
    }
  }
}