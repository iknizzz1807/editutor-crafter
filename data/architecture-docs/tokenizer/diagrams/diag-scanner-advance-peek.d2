direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- CLASSES & STYLES ---
classes: {
  scanner_state: {
    shape: sql_table
    label: "struct Scanner (scanner.py)"
  }
  buffer_view: {
    shape: sql_table
    style: {
      stroke-width: 2
    }
  }
  logic_step: {
    style: {
      fill: "#f8f9fa"
      stroke-dash: 5
    }
  }
}

# --- TIMELINE CONTAINER ---

t1: Initial State {
  class: logic_step
  
  scanner: {
    class: scanner_state
    row1: "0x00 | int | start: 0"
    row2: "0x04 | int | current: 0"
    row3: "0x08 | int | line: 1"
    row4: "0x12 | int | column: 1"
    label_bottom: "Total Size: ~32 bytes"
  }

  buffer: {
    class: buffer_view
    label: "source[start:current]"
    0: "i"
    1: "f"
    2: " "
    3: "("
    4: "x"
  }
  
  scanner.row2 -> buffer.0: "points to next char"
}

t2: After advance() {
  class: logic_step
  
  method_call: |md
    python
    char = scanner.advance()
    # Returns 'i'
    # current += 1
    # column += 1
    
  |

  scanner: {
    class: scanner_state
    row1: "0x00 | int | start: 0"
    row2: "0x04 | int | current: 1"
    row3: "0x08 | int | line: 1"
    row4: "0x12 | int | column: 2"
    style: { fill: "#e1f5fe" }
  }

  buffer: {
    class: buffer_view
    label: "source[start:current]"
    0: "i"
    1: "f"
    2: " "
    3: "("
    4: "x"
    0.style: { fill: "#cfd8dc" }
  }

  scanner.row2 -> buffer.1: "cursor moved"
}

t3: After peek() {
  class: logic_step
  
  method_call: |md
    python
    next_char = scanner.peek()
    # Returns 'f'
    # No cursor movement
    
  |

  scanner: {
    class: scanner_state
    row1: "0x00 | int | start: 0"
    row2: "0x04 | int | current: 1"
    row3: "0x08 | int | line: 1"
    row4: "0x12 | int | column: 2"
  }

  buffer: {
    class: buffer_view
    label: "source[start:current]"
    0: "i"
    1: "f"
    2: " "
    3: "("
    4: "x"
    0.style: { fill: "#cfd8dc" }
    1.style: { stroke: "#fb8c00"; stroke-width: 4 }
  }

  scanner.row2 -> buffer.1: "STAYED AT 1"
}

# --- TRANSITIONS ---

t1 -> t2: "advance() | consumes 1 byte" {
  style: {
    stroke: "#2196f3"
    stroke-width: 3
  }
}

t2 -> t3: "peek() | read-only access" {
  style: {
    stroke: "#4caf50"
    stroke-width: 3
  }
}

# --- ANNOTATIONS ---

legend: {
  near: bottom-center
  
  advance_desc: "advance(): Mutates state. Essential for consuming known tokens." {
    shape: text
  }
  peek_desc: "peek(): Idempotent. Used for LA(1) decisions (e.g., '==' vs '=')" {
    shape: text
  }
}