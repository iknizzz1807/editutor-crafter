direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# -------------------------------------------------------------------------------------------
# GLOBAL CLASSES & STYLES
# -------------------------------------------------------------------------------------------
classes: {
  mode_container: {
    shape: rectangle
    style: {
      stroke-width: 2
      fill: "#f8f9fa"
      border-radius: 8
    }
  }
  state_node: {
    shape: circle
    style: {
      fill: "white"
      stroke: "#2c3e50"
    }
  }
  accepting_state: {
    shape: circle
    style: {
      fill: "#e8f5e9"
      stroke: "#2e7d32"
      double-border: true
    }
  }
  error_state: {
    shape: circle
    style: {
      fill: "#ffebee"
      stroke: "#c62828"
      stroke-width: 3
    }
  }
  logic_block: {
    shape: code
    style: {
      font: mono
      font-size: 12
    }
  }
}

# -------------------------------------------------------------------------------------------
# SCANNER CONTEXT MODES (L1 STATE EVOLUTION)
# -------------------------------------------------------------------------------------------

scanner_fsm: {
  label: "Scanner Mode-Switching DFA (scanner.py)"
  
  # -------------------------------------------------------------------------
  # NORMAL MODE: The Dispatcher
  # -------------------------------------------------------------------------
  NORMAL: {
    class: mode_container
    label: "NORMAL MODE\n(Main Dispatcher)"
    
    entry: {
      shape: sql_table
      label: "fn _scan_token()"
      row1: "0x01 | char | peek()"
      row2: "0x02 | bool | is_at_end()"
    }
    
    dispatch_logic: |md
      python
      char = advance()
      if char == '"': 
          return _scan_string()
      if char == '/' and match('/'):
          return _skip_line_comment()
      if char == '/' and match('*'):
          return _skip_block_comment()
      
    |
  }

  # -------------------------------------------------------------------------
  # STRING MODE: Delimited Context
  # -------------------------------------------------------------------------
  STRING: {
    class: mode_container
    label: "IN_STRING MODE\n(Literal Context)"
    
    states: {
      direction: right
      S_START: { class: state_node; label: "BODY" }
      S_ESCAPE: { class: state_node; label: "ESC" }
      S_END: { class: accepting_state; label: "EMIT" }
      S_ERR: { class: error_state; label: "ERR" }
      
      S_START -> S_ESCAPE: "char == '\\'"
      S_ESCAPE -> S_START: "advance()"
      S_START -> S_END: "char == '\"'"
      S_START -> S_ERR: "char == '\\n' | EOF"
    }
    
    note: "Normal dispatch table is SUSPENDED" {
      style.font-size: 10
      style.italic: true
    }
  }

  # -------------------------------------------------------------------------
  # COMMENT MODES: Silent Consumption
  # -------------------------------------------------------------------------
  COMMENTS: {
    direction: down
    
    LINE_COMMENT: {
      class: mode_container
      label: "LINE_COMMENT\n(Greedy Consumption)"
      
      fsm: {
        direction: right
        C1: { class: state_node; label: "SKIP" }
        C2: { class: accepting_state; label: "EXIT" }
        
        C1 -> C1: "char != '\\n'"
        C1 -> C2: "char == '\\n' | EOF"
      }
    }

    BLOCK_COMMENT: {
      class: mode_container
      label: "BLOCK_COMMENT\n(Multi-line Hunt)"
      
      fsm: {
        direction: right
        B1: { class: state_node; label: "READ" }
        B2: { class: state_node; label: "STAR" }
        B3: { class: accepting_state; label: "EXIT" }
        B_ERR: { class: error_state; label: "EOF" }
        
        B1 -> B2: "char == '*'"
        B2 -> B3: "char == '/'"
        B2 -> B1: "char != '/'"
        B1 -> B_ERR: "is_at_end()"
      }
    }
  }

  # -------------------------------------------------------------------------
  # MODE TRANSITIONS (MAXIMAL MUNCH & TRIGGERING)
  # -------------------------------------------------------------------------
  
  NORMAL.entry -> STRING: "char == '\"' | 1 byte | Entering Mode" {
    style: { stroke: "#3498db"; stroke-width: 2; animated: true }
  }
  
  NORMAL.entry -> COMMENTS.LINE_COMMENT: "match('//') | 2 bytes | LA(1)" {
    style: { stroke: "#9b59b6"; stroke-width: 2; animated: true }
  }
  
  NORMAL.entry -> COMMENTS.BLOCK_COMMENT: "match('/*') | 2 bytes | LA(1)" {
    style: { stroke: "#9b59b6"; stroke-width: 2; animated: true }
  }
  
  STRING.states.S_END -> NORMAL: "return Token(STRING)" {
    style: { stroke-dash: 5 }
  }
  
  COMMENTS.LINE_COMMENT.fsm.C2 -> NORMAL: "return None" {
    style: { stroke-dash: 5 }
  }
  
  COMMENTS.BLOCK_COMMENT.fsm.B3 -> NORMAL: "return None" {
    style: { stroke-dash: 5 }
  }
  
  # ERROR PATHS
  STRING.states.S_ERR -> NORMAL: "return Token(ERROR)" {
    style: { stroke: "#e74c3c"; stroke-dash: 3 }
  }
  
  COMMENTS.BLOCK_COMMENT.fsm.B_ERR -> NORMAL: "return Token(ERROR)" {
    style: { stroke: "#e74c3c"; stroke-dash: 3 }
  }
}

# -------------------------------------------------------------------------------------------
# LEGEND & POSITIONING
# -------------------------------------------------------------------------------------------
legend: {
  near: bottom-right
  
  t1: "LA(1) = 1 Character Lookahead" { shape: text }
  t2: "LA(2) = 2 Character Lookahead (Number dot)" { shape: text }
  
  blue_flow: "Mode Entry" {
    style: { stroke: "#3498db"; stroke-width: 4 }
  }
  purple_flow: "Comment Logic" {
    style: { stroke: "#9b59b6"; stroke-width: 4 }
  }
  red_flow: "Error Recovery Path" {
    style: { stroke: "#e74c3c"; stroke-width: 4; stroke-dash: 3 }
  }
}

# Annotated Metadata
scanner_fsm.NORMAL.dispatch_logic -> scanner_fsm.STRING: "Snapshot start_column" {
  style.font-size: 10
  style.stroke: gray
}