vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

direction: right

# --- LAYER 1: INPUT STREAM ---
input_stream: {
  label: "INPUT SOURCE (str)"
  direction: down
  
  buffer: {
    shape: code
    label: |md
      python
      # Example Source
      "(x + y);"
      
    |
  }
  
  cursor: {
    shape: sql_table
    label: "Scanner State (scanner.py)"
    row1: "self.current | int | Pointer to next char"
    row2: "self.start   | int | Start of current lexeme"
    label_bottom: "Tracks byte-offsets in UTF-8 string"
  }
}

# --- LAYER 2: DISPATCH LOGIC ---
scanner_logic: {
  label: "LEXICAL DISPATCHER"
  direction: down

  dispatch_map: {
    shape: sql_table
    label: "Static Mapping: _SINGLE_CHAR_TOKENS"
    
    header: "Char | TokenType | Category"
    r1: "'+' | OPERATOR    | Arithmetic"
    r2: "'-' | OPERATOR    | Arithmetic"
    r3: "'*' | OPERATOR    | Arithmetic"
    r4: "'(' | PUNCTUATION | Grouping"
    r5: "')' | PUNCTUATION | Grouping"
    r6: "'{' | PUNCTUATION | Scope"
    r7: "'}' | PUNCTUATION | Scope"
    r8: "'[' | PUNCTUATION | Index"
    r9: "']' | PUNCTUATION | Index"
    r10: "';' | PUNCTUATION | Statement"
    r11: "',' | PUNCTUATION | Separator"
    
    style: {
      stroke: "#2b5797"
      fill: "#f2f2f2"
    }
  }

  lookahead_deferred: {
    label: "DEFERRED TO MILESTONE 2 (Lookahead Required)"
    direction: right
    
    slash_node: {
      label: "'/' (Division? Comment?)"
      style: {
        fill: "#fff2cc"
        stroke: "#d6b656"
        stroke-dash: 5
      }
    }
    
    equal_node: {
      label: "'=' (Assign? Equals?)"
      style: {
        fill: "#fff2cc"
        stroke: "#d6b656"
        stroke-dash: 5
      }
    }
  }
}

# --- LAYER 3: OUTPUT CONSTRUCTION ---
output_factory: {
  label: "TOKEN FACTORY"
  direction: down

  token_struct: {
    shape: class
    label: "struct Token (scanner.py)"
    fields: |md
      python
      type:   TokenType
      lexeme: str
      line:   int
      column: int
      
    |
  }

  code_sample: {
    shape: code
    label: |md
      python
      def _scan_token(self):
          char = self.advance()
          if char in self._SINGLE_CHAR_TOKENS:
              return self._make_token(
                  self._SINGLE_CHAR_TOKENS[char]
              )
      
    |
  }
}

# --- DATA FLOW CONNECTIONS ---

input_stream.buffer -> scanner_logic.dispatch_map: "char | 1 byte | '+'"
scanner_logic.dispatch_map -> output_factory.token_struct: "TokenType | Enum | OPERATOR"
output_factory.token_struct -> output_factory.code_sample: "instance"

# Annotation for Deferred logic
scanner_logic.lookahead_deferred -> scanner_logic.dispatch_map: "Bypasses Table" {
  style: {
    stroke: "#d6b656"
    stroke-dash: 2
  }
}

# Metadata Annotations
scanner_logic.dispatch_map.r11: {
  tooltip: "Terminal tokens - require zero lookahead (LA(0))"
}