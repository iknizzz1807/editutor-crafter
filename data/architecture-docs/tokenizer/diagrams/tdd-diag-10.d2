layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

classes: {
  step_box: {
    style: {
      stroke-width: 2
      border-radius: 4
    }
  }
  highlight_red: {
    style: {
      font-color: "#d73a49"
      bold: true
    }
  }
}

crlf_comparison: {
  label: "CRLF Handling Comparison: \\r\\n Sequence"
  grid-columns: 2
  grid-gap: 50

  incorrect_path: "FAULTY: Increment on both \\r and \\n" {
    style.fill: "#fff5f5"
    
    step_1: "1. Initial Scan" {
      class: step_box
      buffer: "| + | \\r | \\n | + |"
      ptr: "  ^ current=0"
      counters: "Line: 1 | Col: 1"
    }

    step_2: "2. Consume '\\r'" {
      class: step_box
      buffer: "| + | \\r | \\n | + |"
      ptr: "      ^ current=1"
      counters: "Line: 2 | Col: 1"
      counters.class: highlight_red
      reason: "FAULT: \\r triggered line++"
    }

    step_3: "3. Consume '\\n'" {
      class: step_box
      buffer: "| + | \\r | \\n | + |"
      ptr: "          ^ current=2"
      counters: "Line: 3 | Col: 1"
      counters.class: highlight_red
      reason: "FAULT: \\n triggered line++ again"
    }

    step_1 -> step_2 -> step_3: "advance()"
  }

  correct_path: "CORRECT: Increment only on \\n" {
    style.fill: "#f0fff4"

    step_1: "1. Initial Scan" {
      class: step_box
      buffer: "| + | \\r | \\n | + |"
      ptr: "  ^ current=0"
      counters: "Line: 1 | Col: 1"
    }

    step_2: "2. Consume '\\r'" {
      class: step_box
      buffer: "| + | \\r | \\n | + |"
      ptr: "      ^ current=1"
      counters: "Line: 1 | Col: 2"
      counters.class: highlight_red
      reason: "PASS: \\r treated as whitespace"
    }

    step_3: "3. Consume '\\n'" {
      class: step_box
      buffer: "| + | \\r | \\n | + |"
      ptr: "          ^ current=2"
      counters: "Line: 2 | Col: 1"
      counters.class: highlight_red
      reason: "PASS: \\n triggers reset and increment"
    }

    step_1 -> step_2 -> step_3: "advance()"
  }
}

annotations: |md
### Intel-Manual Specification: Windows Line Endings
The `advance()` method must handle the two-byte `\r\n` sequence as a single logical line break. 
- **Incorrect:** Logic `if char == '\n' or char == '\r': line++` results in a line-count of 3 for a single CRLF.
- **Correct:** Logic `if char == '\n': line++; col=1` ensures `\r` is treated as a horizontal advance (col++) which is immediately reset by the subsequent `\n`.
| {
  near: bottom-center
}