layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
    sketch: false
  }
}

# =============================================================================
# CLASSES: TECHNICAL SPECIFICATION STANDARDS
# =============================================================================

classes: {
  state_node: {
    style: {
      fill: "#e7f2fa" # Data Blue
      stroke: "#0d47a1"
      stroke-width: 1
      border-radius: 0
    }
  }
  highlight: {
    style: {
      fill: "#ffecb3" # Highlight Yellow/Orange
      stroke: "#ff6f00"
      bold: true
    }
  }
  header: {
    style: {
      fill: "#f3e5f5" # Header Purple
      stroke: "#4a148c"
      bold: true
      font-size: 18
    }
  }
  error_state: {
    style: {
      fill: "#ffebee" # Error Red
      stroke: "#c62828"
      stroke-dash: 5
    }
  }
}

title: |md
  # Windows CRLF Handling (\r\n) â€” Scanner Algorithm Trace
  *Invariants: Line Tracking and Column Alignment*
| {near: top-center}

# =============================================================================
# CORRECT IMPLEMENTATION: CRLF AS SINGLE LOGICAL NEWLINE
# =============================================================================

Correct_Implementation: {
  class: header
  label: "SPEC-COMPLIANT CRLF HANDLING"
  
  step1: "S1: Initial State (Cursor at CR)" {
    class: state_node
    buffer: "Offset: [0] [1] [2] [3]\nData:   | a | \\r | \\n | b |"
    ptr: "          ^ (ptr=1)"
    state: |md
      - line: 1
      - column: 2
    |
  }

  step2: "S2: Post-CR Consumption" {
    class: state_node
    buffer: "Offset: [0] [1] [2] [3]\nData:   | a | \\r | \\n | b |"
    ptr: "               ^ (ptr=2)"
    state: |md
      - line: 1
      - **column: 3** (CR viewed as whitespace)
    |
  }

  step3: "S3: Post-LF Consumption" {
    class: state_node
    buffer: "Offset: [0] [1] [2] [3]\nData:   | a | \\r | \\n | b |"
    ptr: "                    ^ (ptr=3)"
    state: |md
      - **line: 2** (Newline triggered)
      - **column: 1** (Reset)
    |
  }

  step1 -> step2: "advance(): char is \\r" {style.stroke: orange}
  step2 -> step3: "advance(): char is \\n" {style.stroke: orange}
}

# =============================================================================
# BUGGY IMPLEMENTATION: DOUBLE NEWLINE DRIFT
# =============================================================================

Buggy_Implementation: {
  class: header
  label: "BUGGY IMPLEMENTATION (LINE DRIFT)"
  style.stroke: "#d90429"
  
  step1: "S1: Initial State" {
    class: state_node
    buffer: "| a | \\r | \\n | b |"
    ptr: "      ^"
    state: "line: 1, col: 2"
  }

  step2: "S2: CR handled as NL" {
    class: error_state
    buffer: "| a | \\r | \\n | b |"
    ptr: "             ^"
    state: |md
      - **line: 2** (INCORRECT)
      - **column: 1**
    |
  }

  step3: "S3: LF handled as NL" {
    class: error_state
    buffer: "| a | \\r | \\n | b |"
    ptr: "                    ^"
    state: |md
      - **line: 3** (DRIFTED)
      - **column: 1**
    |
  }

  step1 -> step2: "ERROR: CR incremented line" {style.stroke: red}
  step2 -> step3: "ERROR: LF incremented line again" {style.stroke: red}
}

# =============================================================================
# ANNOTATIONS: IMPLEMENTATION LOGIC
# =============================================================================

Scanner_Logic: |md
  ## Scanner.advance() Implementation
  python
  # Logical Byte-Stream Processing
  char = self.peek()
  if char == '\n':
      self.line += 1
      self.column = 1
  elif char == '\r':
      # RFC 2046: Treat as transient whitespace
      # or check for lookahead '\n'
      self.column += 1 
  else:
      self.column += 1
  self.ptr += 1
  
| {
  near: top-right
  style: {
    stroke: "#3a86ff"
    stroke-width: 2
    fill: "#f0f7ff"
  }
}

# =============================================================================
# LAYOUT & COMPARISON
# =============================================================================

Correct_Implementation.step2 -> Buggy_Implementation.step2: "Visual Diff" {
  style: {
    stroke: gray
    stroke-dash: 5
    opacity: 0.5
  }
}

Correct_Implementation.step3 -> Scanner_Logic: "Logical Invariant" {
  style.stroke: green
}