direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  ### Maximal Munch Decision Tree
  **Logic: `_scan_operator(char, line, col)`**
  *Principle: Always prefer longest valid token*
| {
  near: top-center
}

root: "START: advance() consumes first char" {
  style: {
    fill: "#e1d5e7"
    stroke-width: 2
    bold: true
  }
}

paths: {
  path_assign: "char == '='" {
    match: "_match('=')?" {
      shape: diamond
    }
    EQUAL: "Token(EQUAL, '==')" {
      style.fill: "#dae8fc"
    }
    ASSIGN: "Token(ASSIGN, '=')" {
      style.fill: "#dae8fc"
    }
    match -> EQUAL: "TRUE: Consumed '='" {
      style.stroke: green
      style.font-color: green
    }
    match -> ASSIGN: "FALSE: Lookahead remains" {
      style.stroke: red
      style.font-color: red
    }
  }

  path_bang: "char == '!'" {
    match: "_match('=')?" {
      shape: diamond
    }
    NOT_EQUAL: "Token(NOT_EQUAL, '!=')" {
      style.fill: "#dae8fc"
    }
    BANG: "Token(BANG, '!')" {
      style.fill: "#dae8fc"
    }
    match -> NOT_EQUAL: "TRUE: Consumed '='" {
      style.stroke: green
      style.font-color: green
    }
    match -> BANG: "FALSE: Lookahead remains" {
      style.stroke: red
      style.font-color: red
    }
  }

  path_less: "char == '<'" {
    match: "_match('=')?" {
      shape: diamond
    }
    LESS_EQ: "Token(LESS_EQ, '<=')" {
      style.fill: "#dae8fc"
    }
    LESS: "Token(LESS, '<')" {
      style.fill: "#dae8fc"
    }
    match -> LESS_EQ: "TRUE: Consumed '='" {
      style.stroke: green
      style.font-color: green
    }
    match -> LESS: "FALSE: Lookahead remains" {
      style.stroke: red
      style.font-color: red
    }
  }

  path_greater: "char == '>'" {
    match: "_match('=')?" {
      shape: diamond
    }
    GREATER_EQ: "Token(GREATER_EQ, '>=')" {
      style.fill: "#dae8fc"
    }
    GREATER: "Token(GREATER, '>')" {
      style.fill: "#dae8fc"
    }
    match -> GREATER_EQ: "TRUE: Consumed '='" {
      style.stroke: green
      style.font-color: green
    }
    match -> GREATER: "FALSE: Lookahead remains" {
      style.stroke: red
      style.font-color: red
    }
  }
}

root -> paths.path_assign.match
root -> paths.path_bang.match
root -> paths.path_less.match
root -> paths.path_greater.match

annotation: |md
  **Implementation Note:**
  `_match(expected)` performs a single `peek()`.
  If match: `advance()` + return `True`.
  Else: return `False`.
| {
  near: top-left
}

# Legend
legend: {
  near: bottom-right
  header: "Header/State Entry" {
    style.fill: "#e1d5e7"
  }
  data: "Accepting State (Token)" {
    style.fill: "#dae8fc"
  }
}