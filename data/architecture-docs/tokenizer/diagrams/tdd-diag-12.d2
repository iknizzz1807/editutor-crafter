direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ALGORITHM: MAXIMAL MUNCH ON '>=='
# Numbered steps matching TDD spec
# Changed elements highlighted in RED + BOLD

Step 1: "1. Scan First Token (Maximal Munch)" {
  Source: {
    grid-columns: 4
    c0: ">" {style.stroke: "#FF0000"; style.bold: true; style.stroke-width: 4}
    c1: "=" {style.stroke: "#FF0000"; style.bold: true; style.stroke-width: 4}
    c2: "="
    c3: "\\0"
  }
  
  State: {
    current: "0 -> **2**" {style.font-color: "#FF0000"; style.bold: true}
    tok_line: "1"
    tok_col: "1"
  }
  
  Logic: |md
    1. `advance()` consumes `>`
    2. `_match('=')` peeks `=`, matches
    3. `advance()` consumes `=`
  |
  
  Result: {
    label: "EMIT: Token(GREATER_EQ, '>=', 1, 1)"
    style.font-color: "#FF0000"
    style.bold: true
    style.fill: "#E1D5E7"
  }
}

Step 2: "2. Scan Second Token" {
  Source: {
    grid-columns: 4
    c0: ">" {style.opacity: 0.4}
    c1: "=" {style.opacity: 0.4}
    c2: "=" {style.stroke: "#FF0000"; style.bold: true; style.stroke-width: 4}
    c3: "\\0"
  }
  
  State: {
    current: "2 -> **3**" {style.font-color: "#FF0000"; style.bold: true}
    tok_line: "1"
    tok_col: "3"
  }
  
  Logic: |md
    1. `advance()` consumes `=`
    2. `_match('=')` peeks `\0`
    3. `is_at_end()` is True -> returns False
  |
  
  Result: {
    label: "EMIT: Token(ASSIGN, '=', 1, 3)"
    style.font-color: "#FF0000"
    style.bold: true
    style.fill: "#E1D5E7"
  }
}

Step 3: "3. Sentinel Detection" {
  Source: {
    grid-columns: 4
    c0: ">" {style.opacity: 0.4}
    c1: "=" {style.opacity: 0.4}
    c2: "=" {style.opacity: 0.4}
    c3: "\\0" {style.stroke: "#FF0000"; style.bold: true; style.stroke-width: 4}
  }
  
  State: {
    current: "3"
    is_at_end: "True" {style.font-color: "#FF0000"; style.bold: true}
  }
  
  Logic: |md
    1. `next_token()` checks `is_at_end()`
    2. Returns EOF token
  |
  
  Result: {
    label: "EMIT: Token(EOF, '', 1, 4)"
    style.font-color: "#FF0000"
    style.bold: true
    style.fill: "#D5E8D4"
  }
}

Step 1 -> Step 2: "current += 2"
Step 2 -> Step 3: "current += 1"

Final_Output: "Final Token Stream" {
  grid-columns: 1
  t1: "GREATER_EQ ('>=', 1:1)"
  t2: "ASSIGN ('=', 1:3)"
  t3: "EOF ('', 1:4)"
  
  t1.style.fill: "#E1D5E7"
  t2.style.fill: "#E1D5E7"
  t3.style.fill: "#D5E8D4"
}

Step 3 -> Final_Output: "Collection Complete"