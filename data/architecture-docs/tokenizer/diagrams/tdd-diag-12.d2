layout-engine: elk
theme-id: 6

_match_logic: {
  shape: package
  label: "_match(expected) Helper â€” Conditional Consume"

  # States
  START: "" {
    shape: circle
    style: {
      fill: black
      stroke-width: 0
    }
  }

  S1: "1. CHECK BOUNDS" {
    shape: rectangle
    tooltip: "Verify cursor is within source length"
  }

  S2: "2. COMPARE CHAR" {
    shape: diamond
    label: "source[current] == expected?"
  }

  S3: "3. advance()" {
    shape: rectangle
    label: "CONSUME & UPDATE\n**current++**\n**column++**"
    style: {
      stroke: "#2ecc71"
      stroke-width: 4
    }
  }

  RETURN_TRUE: "RETURN TRUE" {
    shape: oval
    style: {
      double-border: true
      stroke: "#2ecc71"
      bold: true
    }
  }

  RETURN_FALSE: "RETURN FALSE" {
    shape: oval
    style: {
      stroke: "#e74c3c"
      font-color: "#e74c3c"
    }
  }

  # Transitions
  START -> S1: "call _match()"

  S1 -> S2: "not is_at_end()" {
    style: {
      stroke: "#3498db"
      bold: true
    }
  }

  S1 -> RETURN_FALSE: "is_at_end()" {
    style: {
      stroke: "#e74c3c"
      stroke-dash: 3
    }
  }

  S2 -> S3: "MATCH" {
    style: {
      stroke: "#2ecc71"
      bold: true
    }
  }

  S2 -> RETURN_FALSE: "MISMATCH" {
    style: {
      stroke: "#e74c3c"
      stroke-dash: 3
    }
  }

  S3 -> RETURN_TRUE: "Commit change"
}

# Annotations
legend: {
  near: bottom-right
  note: |md
    ### Invariants
    - **LA(1)**: Only peeks at the current character.
    - **No Backtrack**: If True is returned, the cursor is moved permanently.
    - **Atomic**: If False is returned, `current` and `column` are exactly as they were before the call.
  |
}

_match_logic.S3.style.font-color: "#2ecc71"
(_match_logic.S2 -> _match_logic.S3)[0].label: "TRUE"
(_match_logic.S2 -> _match_logic.RETURN_FALSE)[0].label: "FALSE"