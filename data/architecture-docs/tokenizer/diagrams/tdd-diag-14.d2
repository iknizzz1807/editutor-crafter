direction: down
layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- GLOBAL STYLES ---
classes: {
  state_box: {
    style: {
      stroke-width: 2
      border-radius: 4
    }
  }
  buffer: {
    shape: sql_table
    style: {
      fill: "#f8f9fa"
      font-size: 14
    }
  }
  changed: {
    style: {
      font-color: "#d73a49"
      bold: true
    }
  }
  pointer: {
    shape: diamond
    style: {
      fill: "#f6c889"
    }
  }
}

# --- ALGORITHM TRACE ---

title: |md
  # Maximal Munch Algorithm Trace: `>==`
  **Principle:** Consume longest valid sequence.
| {near: top-center}

STEP_0: "0. Initial State" {
  class: state_box
  buffer: {
    shape: sql_table
    "Index": "Char"
    "0": ">"
    "1": "="
    "2": "="
  }
  state: {
    shape: sql_table
    "Field": "Value"
    "start": "0"
    "current": "0"
    "emitted": "[]"
  }
}

STEP_1: "1. Scan Call 1 (Match '>=')" {
  class: state_box
  buffer: {
    shape: sql_table
    "Index": "Char"
    "0": ">"
    "1": "="
    "2": "="
  }
  logic: |md
    1. `char = advance()` -> **'>'**
    2. `_match('=')` peeks index 1
    3. Match found! `advance()` called.
  |
  state: {
    shape: sql_table
    "Field": "Value"
    "start": "0"
    "current": "2" {class: changed}
    "last_token": "GREATER_EQUAL" {class: changed}
  }
}

STEP_2: "2. Scan Call 2 (Match '=')" {
  class: state_box
  buffer: {
    shape: sql_table
    "Index": "Char"
    "0": ">"
    "1": "="
    "2": "="
  }
  logic: |md
    1. `char = advance()` -> **'='**
    2. `_match('=')` checks EOF
    3. No match. Returns False.
  |
  state: {
    shape: sql_table
    "Field": "Value"
    "start": "2" {class: changed}
    "current": "3" {class: changed}
    "last_token": "ASSIGN" {class: changed}
  }
}

FINAL: "3. Final Token Stream" {
  class: state_box
  tokens: {
    shape: sql_table
    "Pos": "Type" {constraint: "Lexeme"}
    "0": "GREATER_EQUAL" {constraint: "'>='"}
    "1": "ASSIGN" {constraint: "'='"}
    "2": "EOF" {constraint: "''"}
  }
}

STEP_0 -> STEP_1: "Call _scan_token()"
STEP_1 -> STEP_2: "Call _scan_token()"
STEP_2 -> FINAL: "End of Input"

# Annotations
STEP_1.state."current" -> STEP_1.buffer."2": "Current points to next char" {style.stroke-dash: 3}
STEP_2.state."current" -> STEP_2.buffer."2": "Consumed last character" {style.stroke: red}