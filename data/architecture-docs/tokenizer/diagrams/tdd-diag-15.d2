direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  # _peek_next() â€” Two-Character Lookahead Logic
  *Used in _scan_number() to resolve decimal point ambiguity.*
| {near: top-center}

# --- SOURCE TAPE ---
source_memory: "Source Buffer (raw string)" {
  grid-columns: 8
  grid-gap: 0
  
  idx0: "3" { style.fill: "#dae8fc"; style.stroke: "#6c8ebf" }
  idx1: "." { style.fill: "#dae8fc"; style.stroke: "#6c8ebf" }
  idx2: "t" { style.fill: "#dae8fc"; style.stroke: "#6c8ebf" }
  idx3: "o" { style.fill: "#dae8fc"; style.stroke: "#6c8ebf" }
  idx4: "S" { style.fill: "#dae8fc"; style.stroke: "#6c8ebf" }
  idx5: "t" { style.fill: "#dae8fc"; style.stroke: "#6c8ebf" }
  idx6: "r" { style.fill: "#dae8fc"; style.stroke: "#6c8ebf" }
  idx7: "\\0" { style.fill: "#f5f5f5"; style.stroke: "#cccccc" }

  labels: {
    grid-columns: 8
    grid-gap: 0
    l0: "offset 0" { shape: text; style.font-size: 10 }
    l1: "offset 1" { shape: text; style.font-size: 10 }
    l2: "offset 2" { shape: text; style.font-size: 10 }
    l3: "offset 3" { shape: text; style.font-size: 10 }
    l4: "offset 4" { shape: text; style.font-size: 10 }
    l5: "offset 5" { shape: text; style.font-size: 10 }
    l6: "offset 6" { shape: text; style.font-size: 10 }
    l7: "EOF" { shape: text; style.font-size: 10 }
  }
}

# --- SCANNER STATE ---
scanner_internal: "Scanner Object" {
  shape: class
  source: "str"
  current: "int = 1"
  line: "int = 1"
  column: "int = 2"
  
  style.fill: "#fff2cc"
  style.stroke: "#d6b656"
}

# --- LOOKAHEAD WINDOWS ---
windows: {
  peek: "peek() [Window 0]" {
    shape: rectangle
    style.stroke: "#ff8c00"
    style.stroke-width: 4
    style.fill: transparent
  }
  
  peek_next: "_peek_next() [Window 1]" {
    shape: rectangle
    style.stroke: "#4caf50"
    style.stroke-width: 4
    style.stroke-dash: 3
    style.fill: transparent
  }
}

# --- LOGIC BRANCH ---
logic_flow: "Decision Engine" {
  style.fill: "#f8cecc"
  style.stroke: "#b85450"

  condition: |md
    ### Float Check
    `peek() == '.'`
    **AND**
    `_peek_next().isdigit()`
  |
  
  branch_true: "Consume '.' (FLOAT)" {
    style.stroke: green
    style.opacity: 0.4
  }
  
  branch_false: "Stop at '3' (INTEGER)" {
    style.stroke: red
    style.bold: true
  }
}

# --- CONNECTIONS (DATA FLOW) ---
scanner_internal.current -> source_memory.idx1: "Points to" { style.stroke: "#d6b656" }

windows.peek -> source_memory.idx1: "Read current" {
  source-arrowhead: circle
  style.stroke: "#ff8c00"
}

windows.peek_next -> source_memory.idx2: "Lookahead +1" {
  source-arrowhead: circle
  style.stroke: "#4caf50"
  style.stroke-dash: 3
}

windows.peek -> logic_flow.condition: "Provides '.'"
windows.peek_next -> logic_flow.condition: "Provides 't'"

logic_flow.condition -> logic_flow.branch_false: "'t' is NOT digit"

# --- FOOTNOTES ---
annotations: |md
  **Architectural Constraint:**
  - `peek()`: `source[current]`
  - `_peek_next()`: `source[current + 1]`
  - **Zero Side Effects:** Neither operation increments `current`.
  - **Memory Safety:** `_peek_next()` returns `\0` if `current + 1 >= len(source)`.
| {near: bottom-center}