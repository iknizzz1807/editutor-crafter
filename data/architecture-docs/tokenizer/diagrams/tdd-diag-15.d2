direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# Number Literal Scanning FSM
# Implements LA(1) for integers and LA(2) for floating-point lookahead

states: {
  INITIAL: "â—" {
    shape: circle
  }

  START: "FIRST_DIGIT" {
    tooltip: "First digit consumed by _scan_token dispatch"
  }

  INTEGER: "INTEGER_PART" {
    tooltip: "Consuming consecutive digits"
  }

  SAW_DOT: "DECIMAL_POINT" {
    style.fill: "#ffcfcf"
    style.stroke: red
    style.bold: true
    tooltip: "LA(2) Lookahead Transition"
  }

  FLOAT: "FRACTIONAL_PART" {
    tooltip: "Consuming digits after the decimal point"
  }

  EMIT: "EMIT_TOKEN" {
    style.double-border: true
    style.fill: "#cfffcf"
  }

  # Transitions: Trigger + [Guard] + Action
  INITIAL -> START: "char.isdigit()"
  
  START -> INTEGER: "while peek().isdigit()" {
    style.stroke-dash: 3
  }

  INTEGER -> INTEGER: "digit\n(advance)"

  INTEGER -> SAW_DOT: "'.' && LA(2).isdigit()\n(advance '.') " {
    style: {
      stroke: red
      bold: true
      stroke-width: 3
    }
  }

  INTEGER -> EMIT: "non-digit / '.' && !LA(2).isdigit()" {
    label: "Exit (Int)"
  }

  SAW_DOT -> FLOAT: "digit\n(advance)"

  FLOAT -> FLOAT: "digit\n(advance)"

  FLOAT -> EMIT: "non-digit / EOF" {
    label: "Exit (Float)"
  }
}

# Documentation Overlay (Fixed 'near' for ELK compatibility)
explanation: |md
  ### Number Scanning Logic
  1. **Integer Loop**: Greedily consume digits.
  2. **Float Guard**: If a dot is seen, check **one character further** (LA(2)).
  3. **Backtrack Logic**: If the char after the dot is not a digit (e.g., `3. `), do NOT consume the dot.
  4. **Acceptance**: Emit the accumulated lexeme as a single `NUMBER` token.
| {
  near: top-right
  style.font-size: 14
}

# Annotation for the LA(2) logic
la2_check: |md
  **LA(2) Primitive**
  `self.peek() == '.'`
  `&& self.peek_next().isdigit()`
| {
  near: bottom-right
  style.stroke: red
  style.fill: "#fff0f0"
}