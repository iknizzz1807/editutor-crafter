layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

# ALGORITHM: _scan_number() with Trailing-Dot Guard (LA(2))
# TARGET: Milestone 2 â€” Multi-Character Tokens

title: |md
  # _scan_number() Trace: Trailing-Dot Guard Detail
  *Maximal Munch ensures '3.' does not consume the dot as a float.*
| {near: top-center}

Legend: {
  near: top-right
  direction: right
  p: "Pointer/Index" { style.stroke: orange }
  c: "Change/Action" { style.font-color: red; style.bold: true }
}

# -----------------------------------------------------------------------------
# TRACE 1: VALID FLOAT '3.14'
# -----------------------------------------------------------------------------
FloatTrace: "Input: '3.14'" {
  style.fill: "#f0f7ff"
  
  Step1: "1. Initial State" {
    shape: sql_table
    Source: "3 . 1 4"
    Pointers: "s c" {style.font-color: orange}
    Logic: "advance() consumed '3'. Entering _scan_number()."
  }

  Step2: "2. Integer Loop" {
    shape: sql_table
    Source: "3 . 1 4"
    Pointers: "s   c" {style.font-color: orange}
    peek: "'.'"
    Logic: "peek() is not digit. Integer loop **terminates**."
  }

  Step3: "3. Guard Check (LA(2))" {
    shape: sql_table
    Source: "3 . 1 4"
    Pointers: "s   c" {style.font-color: orange}
    peek: "'.'"
    peek_next: "'1'"
    Logic: "**Guard Passes**: peek=='.' AND peek_next.isdigit()"
    Action: "advance() consumes '.'" {style.font-color: red; style.bold: true}
  }

  Step4: "4. Fractional Loop" {
    shape: sql_table
    Source: "3 . 1 4"
    Pointers: "s       c" {style.font-color: orange}
    Action: "Consumed '1' and '4'." {style.font-color: red; style.bold: true}
    Logic: "peek() is EOF/Space. Exit."
  }

  Step5: "5. Emit Token" {
    shape: sql_table
    Token: "TYPE: NUMBER"
    Lexeme: "'3.14'" {style.font-color: blue}
    Size: "4 chars"
  }

  Step1 -> Step2 -> Step3 -> Step4 -> Step5
}

# -----------------------------------------------------------------------------
# TRACE 2: REJECTED DOT '3.'
# -----------------------------------------------------------------------------
RejectTrace: "Input: '3.'" {
  style.fill: "#fff0f0"

  Step1: "1. Initial State" {
    shape: sql_table
    Source: "3 . EOF"
    Pointers: "s c" {style.font-color: orange}
    Logic: "advance() consumed '3'."
  }

  Step2: "2. Integer Loop" {
    shape: sql_table
    Source: "3 . EOF"
    Pointers: "s   c" {style.font-color: orange}
    peek: "'.'"
    Logic: "peek() is not digit. Loop exits."
  }

  Step3: "3. Guard Check (LA(2))" {
    shape: sql_table
    Source: "3 . EOF"
    Pointers: "s   c" {style.font-color: orange}
    peek: "'.'"
    peek_next: "'' (EOF)"
    Logic: "**Guard Fails**: next is not digit."
    Action: "DO NOT consume '.'" {style.font-color: red; style.bold: true}
  }

  Step4: "4. Emit Token" {
    shape: sql_table
    Token: "TYPE: NUMBER"
    Lexeme: "'3'" {style.font-color: blue}
    Note: "'.' is left in buffer" {style.italic: true}
  }

  Step5: "5. Next Dispatch" {
    shape: sql_table
    Source: "3 . EOF"
    Pointers: "    s/c" {style.font-color: orange}
    Logic: "Main loop sees '.' -> ERROR" {style.font-color: red}
  }

  Step1 -> Step2 -> Step3 -> Step4 -> Step5
}

# -----------------------------------------------------------------------------
# TRACE 3: INTEGER '42'
# -----------------------------------------------------------------------------
IntegerTrace: "Input: '42'" {
  style.fill: "#f0fff0"

  Step1: "1. Initial State" {
    shape: sql_table
    Source: "4 2 _"
    Pointers: "s c" {style.font-color: orange}
  }

  Step2: "2. Integer Loop" {
    shape: sql_table
    Source: "4 2 _"
    Pointers: "s     c" {style.font-color: orange}
    Action: "Consumed '2'." {style.font-color: red; style.bold: true}
    peek: "' '"
  }

  Step3: "3. Guard Check" {
    shape: sql_table
    Source: "4 2 _"
    Pointers: "s     c" {style.font-color: orange}
    peek: "' '"
    Logic: "peek is not '.'. Guard fails."
  }

  Step4: "4. Emit Token" {
    shape: sql_table
    Token: "TYPE: NUMBER"
    Lexeme: "'42'" {style.font-color: blue}
  }

  Step1 -> Step2 -> Step3 -> Step4
}