direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

title: |md
  # Extended Scanner FSM (Post-M2)
  **State Hierarchy: Implicit Call-Stack Transition Model**
  *Transitions: trigger [guard] / action*
| {
  near: top-center
  shape: text
}

# --- States & Invariants ---
START: "START DISPATCH\n(next_token)" {
  shape: circle
  tooltip: "Invariant: Cursor at start of potential lexeme"
  style: {
    stroke-width: 4
    double-border: true
  }
}

IN_OPERATOR: "IN_OPERATOR\n(_scan_operator)" {
  shape: rectangle
  tooltip: "Invariant: First char was {=, !, <, >}"
  style.border-radius: 10
}

IN_IDENTIFIER: "IN_IDENTIFIER\n(_scan_identifier)" {
  shape: rectangle
  tooltip: "Invariant: Lexeme starts with alpha/_"
  style.border-radius: 10
}

IN_NUMBER_INT: "IN_NUMBER_INT\n(_scan_number)" {
  shape: rectangle
  tooltip: "Invariant: Lexeme contains only digits"
  style.border-radius: 10
}

IN_NUMBER_FLOAT: "IN_NUMBER_FLOAT\n(_scan_number p2)" {
  shape: rectangle
  tooltip: "Invariant: Lexeme contains exactly one '.'"
  style.border-radius: 10
}

ACCEPT_TOKEN: "EMIT TOKEN\n(Accepting State)" {
  shape: circle
  style: {
    fill: "#ACE1AF"
    double-border: true
  }
}

ERROR_STATE: "EMIT ERROR\n(Panic Mode)" {
  shape: rectangle
  style: {
    fill: "#FE7070"
    stroke: red
  }
}

EOF_FINAL: "FINAL STATE\n(EOF)" {
  shape: circle
  style.fill: gray
}

# --- Transitions (Trigger [Guard] / Action) ---

●: {shape: circle; style.fill: black; width: 20; height: 20}
● -> START: "init() / reset_lexeme()"

START -> START: "whitespace / _skip_whitespace()"
START -> IN_OPERATOR: "operator_char [char ∈ {=,!,<,>}] / advance()"
START -> IN_NUMBER_INT: "digit [char.isdigit()] / advance()"
START -> IN_IDENTIFIER: "alpha [char.isalpha()] / advance()"
START -> ACCEPT_TOKEN: "single_char / add_token(type)"
START -> EOF_FINAL: "EOF [is_at_end()] / terminate()"
START -> ERROR_STATE: "unexpected / report_error()"

IN_OPERATOR -> ACCEPT_TOKEN: "char [match('=')] / add_token(2_char)"
IN_OPERATOR -> ACCEPT_TOKEN: "any [!match('=')] / add_token(1_char)"

IN_NUMBER_INT -> IN_NUMBER_INT: "digit [peek().isdigit()] / advance()"
IN_NUMBER_INT -> IN_NUMBER_FLOAT: "dot [peek()=='.' && next().isdigit()] / advance()"
IN_NUMBER_INT -> ACCEPT_TOKEN: "other / add_token(NUMBER)"

IN_NUMBER_FLOAT -> IN_NUMBER_FLOAT: "digit [peek().isdigit()] / advance()"
IN_NUMBER_FLOAT -> ACCEPT_TOKEN: "other / add_token(NUMBER)"

IN_IDENTIFIER -> IN_IDENTIFIER: "alnum [peek().isalnum()] / advance()"
IN_IDENTIFIER -> ACCEPT_TOKEN: "other / lookup_keyword_and_emit()"

ACCEPT_TOKEN -> START: "loop / clear_buffer()"
ERROR_STATE -> START: "sync / synchronize_stream()"

# --- Global Invariants & Legend ---
System_Context: |md
  ### Scanner Invariants
  - **current**: points to next char to process
  - **start**: points to first char of current lexeme
  - **maximal_munch**: greedy consumption strategy
  - **line/col**: tracked per `advance()` call
| {
  near: top-right
  shape: text
}

# --- Styling & Constraints ---
(● -> START)[0].style.stroke-width: 2
(ACCEPT_TOKEN -> START)[0].style.stroke-dash: 5
(ERROR_STATE -> START)[0].style.stroke-dash: 5

# Illegal Transitions (Visualized as Red Dashed)
IN_IDENTIFIER -> IN_NUMBER_INT: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 3
  }
}

IN_NUMBER_FLOAT -> IN_NUMBER_INT: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 3
  }
}