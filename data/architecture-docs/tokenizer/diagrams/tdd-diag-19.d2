layout-engine: elk
direction: right
vars: {
  d2-config: {
    theme-id: 6
    sketch: false
    pad: 20
  }
  colors: {
    header: "#6b21a8"
    logic: "#1d4ed8"
    decision: "#f59e0b"
    result: "#10b981"
    text: "#ffffff"
  }
}

# CONTEXT SENSITIVITY: DISPATCH LOGIC FOR '/'
# Illustrates the state-dependent interpretation of the same character.

title: |md
  ### Lexical Context Sensitivity
  **Character:** `/` (Forward Slash)
| {
  near: top-center
  shape: text
}

States: {
  grid-columns: 3
  grid-gap: 40

  START: "1. State: START" {
    style.stroke-width: 2
    header: {
      label: "Dispatched from next_token()"
      style.fill: ${colors.header}
      style.font-color: ${colors.text}
      style.bold: true
    }

    Logic: {
      char: "Current: '/'" {
        shape: parallelogram
        style.fill: ${colors.logic}
        style.font-color: ${colors.text}
      }

      peek: "Peek Next Character" {
        shape: diamond
        style.fill: ${colors.decision}
      }

      char -> peek: "advance()"

      peek -> Line: "match('/')" {
        style.stroke: ${colors.logic}
      }
      peek -> Block: "match('*')" {
        style.stroke: ${colors.logic}
      }
      peek -> Div: "else" {
        style.stroke: ${colors.logic}
      }

      Line: "START_LINE_COMMENT" {
        tooltip: "Consumes to EOL"
        style.fill: ${colors.result}
        style.font-color: ${colors.text}
      }
      Block: "START_BLOCK_COMMENT" {
        tooltip: "Enters sub-FSM"
        style.fill: ${colors.result}
        style.font-color: ${colors.text}
      }
      Div: "EMIT SLASH TOKEN" {
        shape: step
        style.fill: ${colors.logic}
        style.font-color: ${colors.text}
      }
    }
  }

  STRING: "2. State: IN_STRING" {
    style.stroke-width: 2
    header: {
      label: "Processing _scan_string()"
      style.fill: ${colors.header}
      style.font-color: ${colors.text}
      style.bold: true
    }

    Logic: {
      char: "Current: '/'" {
        shape: parallelogram
        style.fill: ${colors.logic}
        style.font-color: ${colors.text}
      }

      context: "Context Check" {
        label: "Is Escape Sequence?"
        shape: diamond
        style.fill: ${colors.decision}
      }

      append: "lexeme_chars.append('/')" {
        style.fill: ${colors.result}
        style.font-color: ${colors.text}
      }

      char -> context: "advance()"
      context -> append: "No (Literal Char)"
      
      Annotation: |md
        **Literal Content**
        '/' is treated as raw data.
        Does NOT trigger comment
        detection logic.
      | {
        shape: text
      }
      # Position within container instead of prohibited 'near' to grid descendant
      append -- Annotation: { style.stroke-width: 0 }
    }
  }

  COMMENT: "3. State: IN_BLOCK_COMMENT" {
    style.stroke-width: 2
    header: {
      label: "Processing _skip_block_comment()"
      style.fill: ${colors.header}
      style.font-color: ${colors.text}
      style.bold: true
    }

    Logic: {
      char: "Current: '/'" {
        shape: parallelogram
        style.fill: ${colors.logic}
        style.font-color: ${colors.text}
      }

      prev: "Check Previous Char" {
        shape: diamond
        style.fill: ${colors.decision}
      }

      char -> prev: "advance()"

      prev -> close: "Prev == '*'" {
        style.stroke: ${colors.logic}
        style.bold: true
      }
      prev -> ignore: "Else" {
        style.stroke-dash: 3
      }

      close: "EXIT_BLOCK_STATE" {
        label: "Terminator Found"
        style.fill: "#ef4444"
        style.font-color: ${colors.text}
      }
      ignore: "CONTINUE_SKIPPING" {
        label: "Comment Content"
        style.fill: "#9ca3af"
      }
    }
  }
}

Legend: {
  near: bottom-right
  
  D: "Decision Point" {
    shape: diamond
    style.fill: ${colors.decision}
  }
  A: "Lexical Action" {
    style.fill: ${colors.result}
  }
  T: "Terminal Emission" {
    shape: step
    style.fill: ${colors.logic}
  }
}

Annotation_Global: |md
  ### Architectural Invariant
  The **State Machine** naturally prevents nested or misidentified tokens. 
  When the scanner is in `IN_STRING`, it never checks for `//` prefixes, effectively 
  rendering `/` characters as inert data until the `"` terminator is encountered.
| {
  shape: text
  near: bottom-center
}