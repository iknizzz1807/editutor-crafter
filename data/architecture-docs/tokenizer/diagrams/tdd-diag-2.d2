layout-engine: elk
theme-id: 4

memory_layout: {
  grid-columns: 3
  grid-gap: 15
  vertical-gap: 0

  # Column 1: Byte Offsets (Intel Manual Style)
  offsets: {
    grid-rows: 6
    grid-gap: 0
    "0x00": { shape: text; height: 40 }
    "0x08": { shape: text; height: 40 }
    "0x10": { shape: text; height: 40 }
    "0x18": { shape: text; height: 40 }
    "0x20": { shape: text; height: 40 }
    "0x28": { shape: text; height: 40 }
  }

  # Column 2: Memory Cells (The Stack)
  # Header=Purple, Pointers=Orange, Data=Blue
  stack: {
    grid-rows: 6
    grid-gap: 0
    style.stroke-dash: 0
    
    # Python PyObject Header
    ob_refcnt: "ob_refcnt" {
      height: 40; width: 250
      style.fill: "#6a1b9a"; style.font-color: white
      tooltip: "8 bytes: Object reference count"
    }
    ob_type: "ob_type*" {
      height: 40; width: 250
      style.fill: "#6a1b9a"; style.font-color: white
      tooltip: "8 bytes: Pointer to class definition"
    }
    
    # Data Fields - Pointers
    type_ref: "token_type*" {
      height: 40; width: 250
      style.fill: "#ef6c00"; style.font-color: white
      tooltip: "8 bytes: Pointer to TokenType Enum"
    }
    lex_ref: "lexeme_ptr*" {
      height: 40; width: 250
      style.fill: "#ef6c00"; style.font-color: white
      tooltip: "8 bytes: Pointer to source buffer slice"
    }
    
    # Data Fields - Primitives
    line_val: "line_number" {
      height: 40; width: 250
      style.fill: "#1565c0"; style.font-color: white
      tooltip: "8 bytes: Integer line value"
    }
    col_val: "col_number" {
      height: 40; width: 250
      style.fill: "#1565c0"; style.font-color: white
      tooltip: "8 bytes: Integer column value"
    }
  }

  # Column 3: Field Sizes
  sizes: {
    grid-rows: 6
    grid-gap: 0
    "8B": { shape: text; height: 40 }
    "8B ": { shape: text; height: 40 }
    "8B  ": { shape: text; height: 40 }
    "8B   ": { shape: text; height: 40 }
    "8B    ": { shape: text; height: 40 }
    "8B     ": { shape: text; height: 40 }
  }
}

# 64B Cache Line Boundary Decoration
cache_line_boundary: "64-byte L1 Cache Line Boundary" {
  near: memory_layout
  style: {
    stroke: gray
    stroke-dash: 5
    fill: transparent
    stroke-width: 2
  }
  height: 300
  width: 450
}

# External Reference Targets
token_enum_obj: "TokenType.OPERATOR\n(Enum Instance)" {
  shape: cylinder
  style.fill: "#ef6c00"
  style.font-color: white
}

source_buffer: "Source String Buffer\n'if (x >= 42)...'" {
  shape: code
  style.fill: "#e0e0e0"
}

# Pointer Visuals
memory_layout.stack.type_ref -> token_enum_obj: "points to" {
  style.stroke: "#ef6c00"
  style.stroke-width: 2
}

memory_layout.stack.lex_ref -> source_buffer: "points to slice" {
  style.stroke: "#ef6c00"
  style.stroke-dash: 3
  style.stroke-width: 2
}

# Annotation Fixed: elk engine requires constant for 'near'
footer: |'md
### sizeof(Token) = 48 bytes
*Intel Style Layout: Field offsets (left) and sizes (right).*
**Header (Purple)** | **Pointers (Orange)** | **Data (Blue)**
'|
footer.near: bottom-center