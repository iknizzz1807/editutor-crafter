layout-engine: elk
vars: {
  d2-config: {
    theme-id: 0
  }
}

token_memory: {
  grid-columns: 3
  grid-gap: 0

  # Header Row
  offset_h: "OFFSET" {style.font-size: 10; style.stroke-width: 1; style.bold: true}
  instance_h: "TOKEN INSTANCE (CPython 64-bit)" {style.font-size: 10; style.stroke-width: 1; style.bold: true}
  size_h: "SIZE" {style.font-size: 10; style.stroke-width: 1; style.bold: true}

  # Object Header (Purple = Header)
  o00: "0x00" {style.stroke-width: 1}
  py_head: "PyObject_HEAD (Ref Count + Type Pointer)" {
    style.fill: "#6e41ab"
    style.font-color: white
    style.stroke-width: 1
  }
  s16: "16 B" {style.stroke-width: 1}

  # Fields (Orange = Pointers)
  o10: "0x10" {style.stroke-width: 1}
  type_ptr: "type: TokenType (Enum Reference)" {
    style.fill: "#f59e0b"
    style.font-color: white
    style.stroke-width: 1
  }
  s08a: "8 B" {style.stroke-width: 1}

  o18: "0x18" {style.stroke-width: 1}
  lexeme_ptr: "lexeme: str (Object Pointer)" {
    style.fill: "#f59e0b"
    style.font-color: white
    style.stroke-width: 1
  }
  s08b: "8 B" {style.stroke-width: 1}

  o20: "0x20" {style.stroke-width: 1}
  line_ptr: "line: int (Object Pointer)" {
    style.fill: "#f59e0b"
    style.font-color: white
    style.stroke-width: 1
  }
  s08c: "8 B" {style.stroke-width: 1}

  o28: "0x28" {style.stroke-width: 1}
  col_ptr: "column: int (Object Pointer)" {
    style.fill: "#f59e0b"
    style.font-color: white
    style.stroke-width: 1
  }
  s08d: "8 B" {style.stroke-width: 1}

  # Padding (Gray = Padding)
  o30: "0x30" {style.stroke-width: 1}
  padding_cell: "Alignment Padding (Internal)" {
    style.fill: "#9ca3af"
    style.stroke-dash: 3
    style.stroke-width: 1
  }
  s16_pad: "16 B" {style.stroke-width: 1}

  # Cache Line Boundary
  o40: "0x40" {style.stroke-width: 0}
  cache_border: "------------------------------------------------" {
    style.stroke-width: 0
    style.font-size: 10
  }
  cache_label: "64B CACHE LINE BOUNDARY" {style.font-size: 8; style.stroke-width: 0}
}

heap_objects: {
  label: "Heap Allocation Details (Blue = Data)"
  
  enum_obj: "TokenType Instance" {
    shape: rectangle
    style.fill: "#3b82f6"
    style.font-color: white
    label: "Enum: ~32 B"
  }

  str_obj: "Lexeme String" {
    shape: rectangle
    style.fill: "#3b82f6"
    style.font-color: white
    label: "str: 49B + len(lexeme)"
  }

  int_line: "Int Object (line)" {
    shape: rectangle
    style.fill: "#3b82f6"
    style.font-color: white
    label: "int: 28 B"
  }

  int_col: "Int Object (column)" {
    shape: rectangle
    style.fill: "#3b82f6"
    style.font-color: white
    label: "int: 28 B"
  }
}

# Reference arrows
token_memory.type_ptr -> heap_objects.enum_obj: "Dereference" {style.stroke: "#f59e0b"; style.stroke-dash: 2}
token_memory.lexeme_ptr -> heap_objects.str_obj: "Dereference" {style.stroke: "#f59e0b"; style.stroke-dash: 2}
token_memory.line_ptr -> heap_objects.int_line: "Dereference" {style.stroke: "#f59e0b"; style.stroke-dash: 2}
token_memory.col_ptr -> heap_objects.int_col: "Dereference" {style.stroke: "#f59e0b"; style.stroke-dash: 2}

annotation: |md
  ### Technical Specs
  - **sizeof=64 bytes (one cache line)**
  - **Memory Layout**: CPython 64-bit
  - **Growth Direction**: High Address (Down)
  - **Invariants**: `@dataclass(frozen=True)`
| {
  near: top-right
}