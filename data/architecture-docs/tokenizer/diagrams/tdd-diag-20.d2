direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# State Machine: _scan_string()
# Implements context-sensitive scanning for string literals with escape sequences.

START: {
  shape: circle
  label: "●"
}

SCANNING: {
  shape: rectangle
  label: "SCANNING CONTENT"
  tooltip: "Inside double quotes, searching for terminator or escape char."
  explanation: |md
    **Invariants:**
    - `lexeme_chars[0]` is `"`
    - `tok_line`/`tok_col` fixed to opening quote position
    - `is_at_end()` is false
  |
}

IN_ESCAPE: {
  shape: rectangle
  label: "IN ESCAPE SEQUENCE"
  tooltip: "Just saw '\\', next char is part of escape pair."
  explanation: |md
    **Invariants:**
    - `char_at(index - 1)` was `\`
    - Escape state must resolve in 1 byte
  |
}

DONE_SUCCESS: {
  shape: circle
  label: "DONE (SUCCESS)"
  style: {
    fill: "#e6fffa"
    stroke: "#38b2ac"
    double-border: true
  }
}

DONE_ERROR: {
  shape: rectangle
  label: "DONE (ERROR)"
  style: {
    fill: "#fff5f5"
    stroke: "#f56565"
    stroke-width: 2
  }
}

# --- Transitions from START ---
START -> SCANNING: "char == '\"' \n [Action: append('\"')]" {
  style.stroke-width: 2
}

# --- Transitions from SCANNING ---
SCANNING -> DONE_SUCCESS: "char == '\"' \n [Action: append('\"'), emit STRING]" {
  tooltip: "Valid termination"
}

SCANNING -> IN_ESCAPE: "char == '\\\\' \n [Action: append('\\\\')]"

SCANNING -> SCANNING: "char ∉ {'\"', '\\\\', '\\n', EOF} \n [Action: append(char)]" {
  style.stroke-dash: 3
}

SCANNING -> DONE_ERROR: "char == '\\n' \n [Guard: Illegal bare newline] \n [Action: emit ERROR]" {
  style: {
    stroke: "#f56565"
    stroke-dash: 5
  }
  label: "ILLEGAL: Unclosed String"
}

SCANNING -> DONE_ERROR: "is_at_end() \n [Guard: Unterminated EOF] \n [Action: emit ERROR]" {
  style: {
    stroke: "#f56565"
    stroke-dash: 5
  }
  label: "ILLEGAL: EOF"
}

# --- Transitions from IN_ESCAPE ---
IN_ESCAPE -> SCANNING: "char ∈ {n, t, r, \", \\\\} \n [Action: append(char)]" {
  label: "Valid: n, t, r, \", \\\\"
}

IN_ESCAPE -> DONE_ERROR: "is_at_end() \n [Guard: Backslash at EOF] \n [Action: emit ERROR]" {
  style: {
    stroke: "#f56565"
    stroke-dash: 5
  }
  label: "ILLEGAL: Trailing \\"
}

IN_ESCAPE -> DONE_ERROR: "char ∉ {n, t, r, \", \\\\} \n [Action: emit ERROR]" {
  style: {
    stroke: "#f56565"
    stroke-dash: 5
  }
  label: "ILLEGAL: Invalid Escape"
}

# --- Annotations ---
# Fixed 'near' to use constant value for ELK compatibility
legend: {
  shape: rectangle
  near: bottom-right
  label: |md
    ### DIAGNOSTIC SPECIFICATION
    All **ERROR** tokens emitted by this machine 
    must report the position of the **OPENING** 
    quote `(tok_line, tok_col)` to facilitate 
    IDE range highlighting.
  |
  style: {
    stroke-dash: 2
    fill: "#fff9c4"
  }
}