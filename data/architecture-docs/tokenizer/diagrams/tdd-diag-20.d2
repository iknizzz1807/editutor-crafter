direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

states: {
  NORMAL: {
    shape: circle
    label: "â— NORMAL\nInvariant: Full Dispatch Active"
  }

  IN_STRING: {
    shape: circle
    label: "IN_STRING\nInvariant: Mode Isolation\n(Quotes/Escapes Active)"
  }

  IN_LINE_COMMENT: {
    shape: circle
    label: "IN_LINE_COMMENT\nInvariant: Discard characters\nuntil EOL/EOF"
  }

  IN_BLOCK_COMMENT: {
    shape: circle
    label: "IN_BLOCK_COMMENT\nInvariant: Discard characters\nuntil '*/' or EOF"
  }

  ERROR_STATE: {
    shape: circle
    label: "ERROR_STATE\nUnterminated Construct"
    style: {
      fill: "#ffcccc"
      stroke: red
    }
  }
}

# Normal Transitions
states.NORMAL -> states.IN_STRING: "trigger: '\"' / action: snapshot position"
states.IN_STRING -> states.NORMAL: "trigger: '\"' / action: emit STRING token"
states.IN_STRING -> states.ERROR_STATE: "trigger: '\\n' | EOF / action: emit ERROR" {
  style.stroke: red
}

states.NORMAL -> states.IN_LINE_COMMENT: "trigger: '//' / action: skip chars"
states.IN_LINE_COMMENT -> states.NORMAL: "trigger: '\\n' | EOF / action: return None"

states.NORMAL -> states.IN_BLOCK_COMMENT: "trigger: '/*' / action: snapshot position"
states.IN_BLOCK_COMMENT -> states.NORMAL: "trigger: '*/' / action: return None"
states.IN_BLOCK_COMMENT -> states.ERROR_STATE: "trigger: EOF / action: emit ERROR" {
  style.stroke: red
}

# Internal/Self Transitions
states.IN_STRING -> states.IN_STRING: "trigger: '\\' + any / action: consume escaped"

# Illegal Mode Transitions
states.IN_STRING -> states.IN_LINE_COMMENT: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

states.IN_BLOCK_COMMENT -> states.IN_STRING: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

# Annotations - Fixed 'near' for ELK engine compatibility
legend: |md
  ### Scanner Mode Transitions
  - **NORMAL**: Standard character-to-token dispatch.
  - **Context-Aware Modes**: Suspend dispatch table.
  - **ERROR_STATE**: Triggered by illegal termination (newline in string or EOF in block).
| {
  near: bottom-right
}