direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ──────────────────────────────────────────────────────────────────────
# ALGORITHM: _scan_string() Escape Sequence Validation
# ──────────────────────────────────────────────────────────────────────

"1. BACKSLASH DETECTED": {
  state: {
    source: |' " h e l l o \ n '|
    current_ptr: "          ^"
    lexeme_chars: |' [ '"', 'h', 'e', 'l', 'l', 'o' ] '|
  }
  action: |md
  Scanner detects `\` via `advance()`.
  1. `lexeme_chars.append('\\')`
  2. `current` increments past backslash.
  |
}

"2. BOUNDARY CHECK": {
  state: {
    source: |' " h e l l o \ n '|
    current_ptr: "            ^"
    is_at_end: "False"
  }
  action: |md
  Check if backslash was the last character in the source.
  - If `True`: **return ERROR** (Unterminated).
  - If `False`: Proceed to consume escape character.
  |
}

"3. CONSUME ESCAPE CHAR": {
  state: {
    source: |' " h e l l o \ n '|
    current_ptr: "              ^"
    escape_char: {
      label: "**'n'**"
      style: {
        font-color: red
        stroke: red
        bold: true
      }
    }
    lexeme_chars: {
      label: |' [ '"', ..., '\\', 'n' ] '|
      style: {
        font-color: red
        stroke: red
        bold: true
      }
    }
  }
  action: |md
  Call `escape_char = advance()`.
  `current` increments past `n`.
  `lexeme_chars.append('n')`.
  |
}

"4. VALIDATE & DISPATCH": {
  state: {
    valid_set: |' [ 'n', 't', 'r', '"', '\' ] '|
    check: "'n' IN valid_set"
    result: {
      label: "TRUE: CONTINUE LOOP"
      style: { 
        fill: "#ACE1AF"
        bold: true
      }
    }
  }
  action: |md
  **Success Branch:**
  Valid escape found. Scanner remains in `IN_STRING` state.
  
  **Note:** Lexeme stores raw `\n` (two bytes).
  *Escape interpretation (ASCII 10) is deferred.*
  |
}

# ── Connections ──────────────────────────────────────────────────────

"1. BACKSLASH DETECTED" -> "2. BOUNDARY CHECK": "Next"
"2. BOUNDARY CHECK" -> "3. CONSUME ESCAPE CHAR": "Not at End"
"3. CONSUME ESCAPE CHAR" -> "4. VALIDATE & DISPATCH": "Validation"

# ── Error Branch ─────────────────────────────────────────────────────

"2. BOUNDARY CHECK" -> ERROR_EOF: "is_at_end == True" {
  style: {
    stroke: red
    stroke-dash: 3
  }
}
ERROR_EOF: "ERROR: Unterminated" {
  shape: diamond
  style: {
    fill: "#FFCCCC"
    stroke: red
  }
}

"4. VALIDATE & DISPATCH" -> ERROR_INVALID: "Result == FALSE" {
  style: {
    stroke: red
    stroke-dash: 3
  }
}
ERROR_INVALID: "ERROR: Invalid Escape" {
  shape: diamond
  style: {
    fill: "#FFCCCC"
    stroke: red
  }
}

# ── Styling ──────────────────────────────────────────────────────────

"1. BACKSLASH DETECTED".style.stroke-width: 2
"4. VALIDATE & DISPATCH".style.stroke-width: 4