direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# State Machine: _scan_string() Internal Logic
# Context: Triggered after first '"' is consumed in NORMAL mode.

"●": {
  shape: circle
  width: 20
  height: 20
  style.fill: black
}

"●" -> SCANNING: "\" / snapshot start_column"

SCANNING: {
  label: "SCANNING\nInvariant: current is inside quotes\nLast char was not unescaped \\"
  shape: rectangle
}

AFTER_BACKSLASH: {
  label: "AFTER_BACKSLASH\nInvariant: last char was \\\nNext char is escaped"
  shape: rectangle
}

TERMINATED: {
  label: "TERMINATED (Success)\nAction: advance(), emit STRING"
  shape: rectangle
  style: {
    fill: "#ACE1AF"
    double-border: true
  }
}

ERROR_NEWLINE: {
  label: "ERROR: UNEXPECTED NEWLINE\nAction: emit ERROR at start_column"
  style: {
    fill: "#FFCCCC"
    stroke: red
  }
}

ERROR_EOF: {
  label: "ERROR: UNEXPECTED EOF\nAction: emit ERROR at start_column"
  style: {
    fill: "#FFCCCC"
    stroke: red
  }
}

# Transitions from SCANNING
SCANNING -> SCANNING: "char [!= \", \\, \\n, EOF] / advance()"
SCANNING -> AFTER_BACKSLASH: "\\ / advance()"
SCANNING -> TERMINATED: "\" / advance()"
SCANNING -> ERROR_NEWLINE: "\\n / report_error()"
SCANNING -> ERROR_EOF: "EOF / report_error()"

# Transitions from AFTER_BACKSLASH (Escape Logic)
AFTER_BACKSLASH -> SCANNING: "any char [!= EOF] / advance()"
AFTER_BACKSLASH -> ERROR_EOF: "EOF / report_error()"

# Illegal Transitions (Logic Guards)
ERROR_NEWLINE -> SCANNING: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

ERROR_EOF -> SCANNING: "ILLEGAL" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

# Annotation
annotation: |md
  ### String Scanning Mode (Maximal Munch)
  - **Start Coordinate**: Snapshotted at opening `"`.
  - **Escape Jump**: `AFTER_BACKSLASH` unconditionally consumes the next character, preventing `\"` from triggering `TERMINATED`.
  - **Position Tracking**: Every `advance()` inside this machine updates the global `line` and `column` counters.
| {
  near: top-right
}