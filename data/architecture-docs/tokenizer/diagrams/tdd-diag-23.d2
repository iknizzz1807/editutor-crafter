direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# States with Invariants
●: {
  shape: circle
  style.fill: "#000000"
  width: 20
}

SCANNING_COMMENT: "SCANNING_COMMENT" {
  |md
  **Invariant:** Cursor is inside `/* ... */`. 
  No termination sequence `*/` has been identified.
  |
}

SAW_STAR: "SAW_STAR" {
  |md
  **Invariant:** The character most recently consumed was `*`. 
  Lookahead is active for `/`.
  |
}

SUCCESS: "SUCCESS (Accept)" {
  shape: rectangle
  style.double-border: true
  style.fill: "#ACE1AF"
  |md
  **Final State:** Block comment consumed.
  **Return:** `None` (continue scanning next token).
  |
}

ERROR: "ERROR (Reject)" {
  shape: rectangle
  style.fill: "#FE7070"
  style.stroke: "#CA052B"
  |md
  **Final State:** Unterminated block comment.
  **Return:** `Token(TokenType.ERROR, "/*", start_line, start_col)`.
  |
}

# Transitions: trigger + guard + action
● -> SCANNING_COMMENT: "next_token() / [char == '/' && _match('*')] / consume '/*'"

SCANNING_COMMENT -> SCANNING_COMMENT: "char / [char != '*' && char != '\\n'] / advance()"

SCANNING_COMMENT -> SCANNING_COMMENT: "char / [char == '\\n'] / line++, column=1"

SCANNING_COMMENT -> SAW_STAR: "char / [char == '*'] / advance()"

SCANNING_COMMENT -> ERROR: "is_at_end() / [reached EOF] / report at start_pos"

SAW_STAR -> SUCCESS: "char / [char == '/'] / advance()"

SAW_STAR -> SAW_STAR: "char / [char == '*'] / advance() (handles '**/')"

SAW_STAR -> SCANNING_COMMENT: "char / [char != '/' && char != '*'] / advance()"

SAW_STAR -> ERROR: "is_at_end() / [reached EOF] / report at start_pos"

# Architecture Annotation - Fix: near set to constant for ELK
note: |md
### Lexer Context
All transitions calling `advance()` automatically trigger:
1. `current += 1`
2. `column += 1` (or `line++, col=1` for `\n`)
| {
  near: bottom-center
}

SCANNING_COMMENT.style.stroke-width: 2
SAW_STAR.style.stroke-width: 2
SUCCESS.style.font-color: "#167C3C"
ERROR.style.font-color: "#ffffff"
ERROR.style.bold: true