direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ---------------------------------------------------------------------------------
# ESCAPE SEQUENCE PROCESSING: ALGORITHM STATE TRACE
# ---------------------------------------------------------------------------------

Step_1: "1. Detect Escape Prefix" {
  style.stroke: "#333333"
  
  Source_Tape: {
    grid-columns: 5
    grid-gap: 0
    
    idx_4: "4: a"
    idx_5: "5: \\" { style.fill: "#fff3cd" }
    idx_6: '6: "' { style.fill: "#d1ecf1" }
    idx_7: "7: ;"
    idx_8: "8: EOF"
  }
  
  State_Variables: {
    grid-columns: 1
    current: "current: 5" {
      style.font-color: orange
      style.bold: true
    }
    peek: "peek(): '\\'"
    mode: "Mode: IN_STRING"
  }
  
  Logic: |md
    `if self.peek() == '\\':`
    Evaluates to **True**.
  |
  
  Logic -> Source_Tape.idx_5: "Pointer Location" {
    style.stroke: orange
    source-arrowhead: circle
  }
}

Step_2: "2. Consume Backslash" {
  style.stroke: "#333333"
  
  Source_Tape: {
    grid-columns: 5
    grid-gap: 0
    
    idx_4: "4: a"
    idx_5: "5: \\"
    idx_6: '6: "' { style.fill: "#fff3cd" }
    idx_7: "7: ;"
    idx_8: "8: EOF"
  }
  
  State_Variables: {
    grid-columns: 1
    current: "current: **6**" {
      style.font-color: red
      style.bold: true
    }
    peek: "peek(): '\"'"
    mode: "Mode: IN_STRING"
  }
  
  Logic: |md
    `self.advance() # Consumes \`
    Pointer moves forward.
  |
  
  Logic -> Source_Tape.idx_6: "New Pointer" {
    style.stroke: orange
    source-arrowhead: circle
  }
}

Step_3: "3. Consume Escaped Char" {
  style.stroke: "#333333"
  
  Source_Tape: {
    grid-columns: 5
    grid-gap: 0
    
    idx_4: "4: a"
    idx_5: "5: \\"
    idx_6: '6: "' 
    idx_7: "7: ;" { style.fill: "#fff3cd" }
    idx_8: "8: EOF"
  }
  
  State_Variables: {
    grid-columns: 1
    current: "current: **7**" {
      style.font-color: red
      style.bold: true
    }
    peek: "peek(): ';'"
    mode: "Mode: IN_STRING"
  }
  
  Logic: |md
    `self.advance() # Consumes "`
    The escaped quote is now 
    **behind** the cursor.
  |
  
  Logic -> Source_Tape.idx_7: "Final Pointer" {
    style.stroke: orange
    source-arrowhead: circle
  }
}

Step_1 -> Step_2: "advance()"
Step_2 -> Step_3: "advance()"

# ---------------------------------------------------------------------------------
# SUMMARY ANNOTATION
# ---------------------------------------------------------------------------------

Annotation: |md
  ### The Escape Invariant
  In **Step 3**, `current` is advanced to **7**. 
  When the outer loop re-evaluates `while peek() != '"'`, 
  it looks at index **7** (';'), NOT the escaped quote at **6**.
  
  **Result:** The string remains open, correctly skipping the internal quote.
| {
  near: bottom-center
  style: {
    stroke: "#28a745"
    fill: "#e2f3e5"
    stroke-width: 2
  }
}