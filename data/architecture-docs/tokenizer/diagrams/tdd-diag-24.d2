direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  ### Trace: Multi-line Block Comment with Line Number Updates
  Source: `x /* first\n  second */ y`
| {
  near: top-center
  shape: text
}

"Step 1: Initial Scan" {
  source: |md
    `x /* first`
    `^`
  |
  state: {
    shape: sql_table
    current: 0
    line: 1
    column: 1
    status: "START"
  }
}

"Step 1: Initial Scan" -> "Step 2: Enter Comment"

"Step 2: Enter Comment" {
  source: |md
    `x /* first`
    `  ^`
  |
  state: {
    shape: sql_table
    current: 2
    line: 1
    column: 3
    status: "CALL _skip_block_comment"
  }
}

"Step 2: Enter Comment" -> "Step 3: Newline Processing"

"Step 3: Newline Processing" {
  source: |md
    `first\n  second`
    `     ^`
  |
  state: {
    shape: sql_table
    current: 11
    line: "**2**" {style.font-color: red; style.bold: true}
    column: "**1**" {style.font-color: red; style.bold: true}
    status: "INSIDE _skip_block_comment"
  }
}

"Step 3: Newline Processing" -> "Step 4: Exit Comment"

"Step 4: Exit Comment" {
  source: |md
    `second */ y`
    `       ^`
  |
  state: {
    shape: sql_table
    current: 22
    line: 2
    column: 11
    status: "EXIT _skip_block_comment"
  }
}

"Step 4: Exit Comment" -> "Step 5: Final Token"

"Step 5: Final Token" {
  source: |md
    `second */ y`
    `          ^`
  |
  state: {
    shape: sql_table
    current: 23
    line: "**2**" {style.bold: true}
    column: "**12**" {style.bold: true}
    status: "EMIT IDENTIFIER('y')"
  }
}

# Style annotations for Algorithm State Diagram compliance
"Step 3: Newline Processing".state.line.style.fill: "#ffcccc"
"Step 3: Newline Processing".state.column.style.fill: "#ffcccc"
"Step 5: Final Token".state.line.style.fill: "#ccffcc"
"Step 5: Final Token".state.status.style.fill: "#ccffcc"

explanation: |md
  1. **Step 1**: Scanner at origin.
  2. **Step 2**: `/` and `*` consumed. Start pos (1,3) captured for error reporting.
  3. **Step 3**: `advance()` consumes `\n`. **Line increments**, column resets.
  4. **Step 4**: `*` then `/` consumed via `_match`. Sub-state exits.
  5. **Step 5**: Recursive `next_token()` call skips whitespace and correctly scans `y` on **Line 2**.
| {
  near: bottom-center
  shape: text
}