direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

title: |md
  # Error Position: Blame the Cause, Not the Symptom
  **Constraint:** Error token position = where the trouble STARTED, not where it was DETECTED.
| {
  near: top-center
  shape: text
}

legend: {
  near: bottom-center
  cause: "Cause of Error" {
    style: {
      fill: "#4CAF50" # Green
      stroke-width: 2
    }
  }
  detection: "Detection Point (EOF)" {
    style: {
      fill: "#F44336" # Red
      stroke-width: 2
    }
  }
}

scenario_a: "Scenario A: Unterminated String" {
  source_view: {
    grid-columns: 11
    grid-gap: 0
    
    # Character Cells
    c1: "x"
    c2: " "
    c3: "="
    c4: " "
    c5: "\"" { style.fill: "#4CAF50"; style.bold: true }
    c6: "h"
    c7: "e"
    c8: "l"
    c9: "l"
    c10: "o"
    c11: "EOF" { style.fill: "#F44336"; style.bold: true }

    # Column Labels
    l1: "1" { shape: text; height: 20 }
    l2: "2" { shape: text; height: 20 }
    l3: "3" { shape: text; height: 20 }
    l4: "4" { shape: text; height: 20 }
    l5: "5" { shape: text; height: 20 }
    l6: "6" { shape: text; height: 20 }
    l7: "7" { shape: text; height: 20 }
    l8: "8" { shape: text; height: 20 }
    l9: "9" { shape: text; height: 20 }
    l10: "10" { shape: text; height: 20 }
    l11: "11" { shape: text; height: 20 }
  }

  internal_state: "Internal Scanner State" {
    shape: sql_table
    tok_line: "1"
    tok_col: "5"
    status: "REACHED EOF"
  }

  error_token: "Emitted Token Object" {
    shape: sql_table
    style.fill: "#6e40aa" # Purple Header
    
    0x00: "type: ERROR" { constraint: "4B" }
    0x04: "lexeme: '\"hello'" { constraint: "Ptr" }
    0x0C: "line: 1" { constraint: "4B" }
    0x10: "column: 5" { 
      constraint: "4B"
      style: { fill: "#4CAF50"; font-color: white; bold: true }
    }
  }

  source_view.c11 -> internal_state: "is_at_end() == True" {
    style: { stroke: "#F44336"; stroke-dash: 3; animated: true }
  }
  internal_state -> error_token: "Emit(tok_line, tok_col)" {
    style: { stroke: "#ff8c00"; stroke-width: 2 }
  }
}

scenario_b: "Scenario B: Unterminated Block Comment" {
  source_view: {
    grid-columns: 11
    grid-gap: 0
    
    # Character Cells
    c1: "a"
    c2: " "
    c3: "/" { style.fill: "#4CAF50"; style.bold: true }
    c4: "*" { style.fill: "#4CAF50"; style.bold: true }
    c5: " "
    c6: "n"
    c7: "e"
    c8: "v"
    c9: "e"
    c10: "r"
    c11: "EOF" { style.fill: "#F44336"; style.bold: true }

    # Column Labels
    l1: "1" { shape: text; height: 20 }
    l2: "2" { shape: text; height: 20 }
    l3: "3" { shape: text; height: 20 }
    l4: "4" { shape: text; height: 20 }
    l5: "5" { shape: text; height: 20 }
    l6: "6" { shape: text; height: 20 }
    l7: "7" { shape: text; height: 20 }
    l8: "8" { shape: text; height: 20 }
    l9: "9" { shape: text; height: 20 }
    l10: "10" { shape: text; height: 20 }
    l11: "11" { shape: text; height: 20 }
  }

  internal_state: "Internal Scanner State" {
    shape: sql_table
    start_line: "1"
    start_col: "3"
    status: "UNFINISHED_LOOP"
  }

  error_token: "Emitted Token Object" {
    shape: sql_table
    style.fill: "#6e40aa" # Purple Header
    
    0x00: "type: ERROR" { constraint: "4B" }
    0x04: "lexeme: '/*'" { constraint: "Ptr" }
    0x0C: "line: 1" { constraint: "4B" }
    0x10: "column: 3" { 
      constraint: "4B"
      style: { fill: "#4CAF50"; font-color: white; bold: true }
    }
  }

  source_view.c11 -> internal_state: "EOF Detected" {
    style: { stroke: "#F44336"; stroke-dash: 3; animated: true }
  }
  internal_state -> error_token: "Emit(start_line, start_col)" {
    style: { stroke: "#ff8c00"; stroke-width: 2 }
  }
}

# Layout constraints
scenario_a.source_view.c5 -> scenario_a.error_token.0x10: "Maps back to cause" {
  style: { stroke: "#4CAF50"; stroke-width: 2; opacity: 0.6 }
}

scenario_b.source_view.c3 -> scenario_b.error_token.0x10: "Maps back to cause" {
  style: { stroke: "#4CAF50"; stroke-width: 2; opacity: 0.6 }
}