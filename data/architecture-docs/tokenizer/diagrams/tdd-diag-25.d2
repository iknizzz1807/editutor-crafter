direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- ALGORITHM: _skip_block_comment() ---
# Tracing input: /* a * b */

classes: {
  step_container: {
    style: {
      stroke-width: 2
      border-radius: 8
    }
  }
  buffer_cell: {
    width: 30
    height: 30
    style: {
      font: mono
      fill: "#f0f0f0"
    }
  }
  active_ptr: {
    shape: triangle
    width: 20
    height: 20
    style: {
      fill: orange
      stroke: black
    }
  }
  highlight: {
    style: {
      stroke: red
      stroke-width: 4
      font-color: red
      bold: true
    }
  }
}

Steps: {
  grid-columns: 1

  # --- STEP 1: INITIAL ENTRY ---
  S1: "1. Entry Context" {
    class: step_container
    explain: |md
      - Cursor at `current=2` (after `/*`).
      - Invariants: `error_line` and `error_col` saved.
    |
    grid: {
      grid-rows: 2
      # Row 1: Pointers
      p0; p1; p2; p3; p4; p5; p6; p7; p8; p9; p10
      # Row 2: Data
      c0: "/"; c1: "*"; c2: " "; c3: "a"; c4: " "; c5: "*"; c6: " "; c7: "b"; c8: " "; c9: "*"; c10: "/"

      p*: { label: ""; style.opacity: 0 }
      p2: { class: active_ptr; style.opacity: 1 }
      c*: { class: buffer_cell }
    }
  }

  # --- STEP 2: LONE STAR CHECK ---
  S2: "2. The 'Lone Star' Case" {
    class: step_container
    explain: |md
      - `char = advance()` -> **'*'**
      - `peek()` -> **' '**
      - **Branch Condition**: `char == '*' && peek() == '/'` is **FALSE**.
      - **Action**: Loop continues.
    |
    grid: {
      grid-rows: 2
      # Row 1: Pointers
      p0; p1; p2; p3; p4; p5; p6; p7; p8; p9; p10
      # Row 2: Data
      c0: "/"; c1: "*"; c2: " "; c3: "a"; c4: " "; c5: "**\***"; c6: " "; c7: "b"; c8: " "; c9: "*"; c10: "/"

      p*: { label: ""; style.opacity: 0 }
      p6: { 
        class: active_ptr
        style.opacity: 1
        label: "current=6"
      }
      c*: { class: buffer_cell }
      c5.class: [buffer_cell; highlight]
    }
  }

  # --- STEP 3: TERMINAL DETECTION ---
  S3: "3. Termination Sequence" {
    class: step_container
    explain: |md
      - `char = advance()` -> **'*'**
      - `peek()` -> **'/'**
      - **Branch Condition**: `char == '*' && peek() == '/'` is **TRUE**.
      - **Action**: Exit loop, consume tail.
    |
    grid: {
      grid-rows: 2
      # Row 1: Pointers
      p0; p1; p2; p3; p4; p5; p6; p7; p8; p9; p10
      # Row 2: Data
      c0: "/"; c1: "*"; c2: " "; c3: "a"; c4: " "; c5: "*"; c6: " "; c7: "b"; c8: " "; c9: "**\***"; c10: "**/**"

      p*: { label: ""; style.opacity: 0 }
      p10: { 
        class: active_ptr
        style.opacity: 1
        label: "current=10"
      }
      c*: { class: buffer_cell }
      c9.class: [buffer_cell; highlight]
      c10.class: [buffer_cell; highlight]
    }
  }

  # --- STEP 4: CLEANUP ---
  S4: "4. Return to Normal Scan" {
    class: step_container
    explain: |md
      - `advance()` consumes the trailing `/`.
      - **Return**: `None` (Comment discarded).
      - Cursor ready for next token.
    |
    grid: {
      grid-rows: 2
      # Row 1: Pointers (12 cols)
      p0; p1; p2; p3; p4; p5; p6; p7; p8; p9; p10; p11
      # Row 2: Data
      c0: "/"; c1: "*"; c2: " "; c3: "a"; c4: " "; c5: "*"; c6: " "; c7: "b"; c8: " "; c9: "*"; c10: "/"; c11: "..."

      p*: { label: ""; style.opacity: 0 }
      p11: { 
        class: active_ptr
        style.opacity: 1
        label: "**current=11**"
        style.fill: green
      }
      c*: { class: buffer_cell }
      c11.style.stroke-dash: 3
    }
  }
}

Steps.S1 -> Steps.S2: "Iterate"
Steps.S2 -> Steps.S3: "Search"
Steps.S3 -> Steps.S4: "Finalize"