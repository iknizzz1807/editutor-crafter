direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ── ALGORITHM STATE DIAGRAM: MULTI-LINE TRACKING ──

Step_1: {
  label: "1. Start: NORMAL Mode"
  Scanner: {
    shape: sql_table
    line: "1"
    column: "1"
    current: "0"
    mode: "NORMAL"
  }
  Source: "|md <font color='red'><b>a</b></font>\\n/* line2\\nline3\\n*/b|"
}

Step_2: {
  label: "2. Consume Newline (advance)"
  Scanner: {
    shape: sql_table
    line: "|md <font color='red'><b>2</b></font>|"
    column: "|md <font color='red'><b>1</b></font>|"
    current: "|md <font color='red'><b>2</b></font>|"
    mode: "NORMAL"
  }
  Source: "|md a\\n<font color='red'><b>/</b></font>* line2\\nline3\\n*/b|"
  Notes: "|md `advance()` detects `\\n`\\nResets `col` to 1, increments `line`|"
}

Step_3: {
  label: "3. Enter _skip_block_comment"
  Scanner: {
    shape: sql_table
    line: "2"
    column: "|md <font color='red'><b>3</b></font>|"
    current: "|md <font color='red'><b>4</b></font>|"
    mode: "|md <font color='red'><b>BLOCK_COMMENT</b></font>|"
  }
  Source: "|md a\\n/* <font color='red'><b>l</b></font>ine2\\nline3\\n*/b|"
  Notes: "|md `_match('*')` consumes `*`\\nSub-scanner loop starts|"
}

Step_4: {
  label: "4. Inside Comment (line2\\n)"
  Scanner: {
    shape: sql_table
    line: "|md <font color='red'><b>3</b></font>|"
    column: "|md <font color='red'><b>1</b></font>|"
    current: "|md <font color='red'><b>11</b></font>|"
    mode: "BLOCK_COMMENT"
  }
  Source: "|md a\\n/* line2\\n<font color='red'><b>l</b></font>ine3\\n*/b|"
  Notes: "|md `advance()` called inside `while`\\nIncrements `line` to 3 automatically|"
}

Step_5: {
  label: "5. Inside Comment (line3\\n)"
  Scanner: {
    shape: sql_table
    line: "|md <font color='red'><b>4</b></font>|"
    column: "|md <font color='red'><b>1</b></font>|"
    current: "|md <font color='red'><b>18</b></font>|"
    mode: "BLOCK_COMMENT"
  }
  Source: "|md a\\n/* line2\\nline3\\n<font color='red'><b>*</b></font>/b|"
  Notes: "|md `advance()` hits second `\\n`\\n`line` becomes 4|"
}

Step_6: {
  label: "6. Exit & Scan 'b'"
  Scanner: {
    shape: sql_table
    line: "4"
    column: "|md <font color='red'><b>4</b></font>|"
    current: "|md <font color='red'><b>21</b></font>|"
    mode: "|md <font color='red'><b>NORMAL</b></font>|"
  }
  Source: "|md a\\n/* line2\\nline3\\n*/<font color='red'><b>b</b></font>|"
  Notes: "|md `*/` matched. Sub-scanner returns.\\n`_scan_token` resumes. 'b' scanned at Line 4.|"
}

Step_1 -> Step_2: "a\\n"
Step_2 -> Step_3: "/*"
Step_3 -> Step_4: "line2\\n"
Step_4 -> Step_5: "line3\\n"
Step_5 -> Step_6: "*/b"

# Styling
Step_2.Scanner.line.style.font-color: red
Step_2.Scanner.column.style.font-color: red
Step_3.Scanner.mode.style.font-color: red
Step_4.Scanner.line.style.font-color: red
Step_5.Scanner.line.style.font-color: red
Step_6.Scanner.mode.style.font-color: red