layout-engine: elk
direction: right
vars: {
  d2-config: {
    theme-id: 0
  }
}

Source: "source: str" {
  shape: parallelogram
  style.fill: "#f5f5f5"
}

Scanner: {
  shape: class
  label: "Scanner\nsizeof=64 bytes (one cache line)"
  
  "0x00: source": "str [8B]"
  "0x08: current": "int [8B]"
  "0x10: line": "int [8B]"
  "0x18: column": "int [8B]"
  "0x20: padding": "byte[32] [32B]"
  
  "scan_tokens()": "list[Token]"
  "next_token()": "Token"
  "_skip_whitespace()": "void"
  
  style: {
    fill: "#C6E2FF"
    stroke: "#333333"
    stroke-width: 2
  }
}

TokenStream: "list[Token]" {
  shape: package
  label: "Token Stream (Interface Contract)"
  
  Invariants: |md
    ### Interface Invariants
    1. **Type Consistency**: `token.type âˆˆ TokenType`
    2. **Lexeme Fidelity**: Exact raw substring from source
    3. **Line Accuracy**: 1-indexed line (at lexeme start)
    4. **Column Accuracy**: 1-indexed column (at lexeme start)
  |
  
  style: {
    fill: "#E4DBFE"
    stroke: "#4B0082"
    stroke-width: 4
  }
}

Consumers: {
  Parser: {
    shape: rectangle
    style.fill: "#C7F1FF"
  }
  IDE: "Syntax Highlighter" {
    shape: rectangle
    style.fill: "#C7F1FF"
  }
  Linter: "Error Reporter" {
    shape: rectangle
    style.fill: "#C7F1FF"
  }
}

Annotation: |md
### Interface Boundary
**Implementation details hidden**
Parser, IDE, Linter depend ONLY on this contract.
Changing Scanner internals does not break consumers if contract is preserved.
| {
  near: bottom-center
  style.font-size: 14
}

Source -> Scanner: "Character Input"
Scanner -> TokenStream: "owns"
TokenStream -> Consumers.Parser: "references" {
  style.stroke-dash: 5
}
TokenStream -> Consumers.IDE: "references" {
  style.stroke-dash: 5
}
TokenStream -> Consumers.Linter: "references" {
  style.stroke-dash: 5
}