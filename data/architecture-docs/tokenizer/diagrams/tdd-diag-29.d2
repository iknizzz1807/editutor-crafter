direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ----------------------------------------------------------------------------
# COMPILER TOKENIZER ARCHITECTURE: _scan_token Dispatch
# ----------------------------------------------------------------------------

Scanner: {
  shape: class
  label: "Scanner (Lexer Engine)\nsizeof=64 bytes (cache line)"
  
  # Fields - Blue (Data)
  source: "str (UTF-8)" {style.font-color: "#2196f3"}
  tokens: "list[Token]" {style.font-color: "#2196f3"}
  start: "int" {style.font-color: "#2196f3"}
  current: "int" {style.font-color: "#2196f3"}
  line: "int" {style.font-color: "#2196f3"}
  column: "int" {style.font-color: "#2196f3"}
  start_column: "int" {style.font-color: "#2196f3"}
  
  # Main Dispatch - Purple (Header/Logic)
  "_scan_token()": "Token | None"
  
  # Helper Methods
  "_match(expected: str)": "bool (LA1)"
  "_peek_next()": "str (LA2)"
  "_make_token(type: TokenType)": "Token"
  
  # Context-Specific Scanners
  "_scan_string()": "Token"
  "_skip_line_comment()": "void"
  "_skip_block_comment()": "Token | None"
  "_scan_number()": "Token"
  "_scan_identifier()": "Token"

  style.stroke: "#673ab7"
  style.stroke-width: 2
}

# Token Definition
Token: {
  shape: class
  label: "Token (Lexeme Representation)"
  
  type: "TokenType"
  lexeme: "str"
  line: "int"
  column: "int"
  
  style.fill: "#dae8fc"
  style.stroke: "#2196f3"
}

# Dispatch Pipeline (Priority Sequence)
Dispatch_Pipeline: {
  label: " _scan_token() Priority Queue"
  
  L1: "1. Two-Char Op Candidates (=, !, <, >)" {
    shape: rectangle
    style.fill: "#f8cecc"
    tooltip: "Uses _match() for LA(1)"
  }
  
  L2: "2. Div / Comment 3-Way (/)" {
    shape: rectangle
    style.fill: "#f8cecc"
    tooltip: "Distinguishes /, //, and /*"
  }
  
  L3: "3. String Literal Entry (\")" {
    shape: rectangle
    style.fill: "#fff2cc"
  }
  
  L4: "4. Numeric Literal (isdigit)" {
    shape: rectangle
    style.fill: "#fff2cc"
  }
  
  L5: "5. Identifier / Keyword (isalpha | _)" {
    shape: rectangle
    style.fill: "#fff2cc"
  }
  
  L6: "6. Single-Char Table (_SINGLE_CHAR_MAP)" {
    shape: rectangle
    style.fill: "#e1d5e7"
  }
  
  L7: "7. Whitespace Filter (' ', \\t, \\r, \\n)" {
    shape: rectangle
    style.fill: "#d5e8d4"
  }
  
  L8: "8. ERROR Fallthrough (Default)" {
    shape: rectangle
    style.fill: "#f8cecc"
    style.stroke: "#b85450"
  }

  L1 -> L2 -> L3 -> L4 -> L5 -> L6 -> L7 -> L8
}

# Method Relationships
Scanner."_scan_token()" -> Dispatch_Pipeline: "execute prioritized check" {
  style.stroke: "#ff9800" # Orange Pointer
}

# Ownership & Calls
Dispatch_Pipeline.L1 -> Scanner."_match(expected: str)": "LA(1) check"
Dispatch_Pipeline.L2 -> Scanner."_skip_line_comment()": "mode: LINE_COMMENT"
Dispatch_Pipeline.L2 -> Scanner."_skip_block_comment()": "mode: BLOCK_COMMENT"
Dispatch_Pipeline.L3 -> Scanner."_scan_string()": "mode: STRING"
Dispatch_Pipeline.L4 -> Scanner."_scan_number()": "mode: NUMBER"
Dispatch_Pipeline.L5 -> Scanner."_scan_identifier()": "mode: IDENTIFIER"
Dispatch_Pipeline.L6 -> Scanner."_make_token(type: TokenType)": "emit"

# Final Returns
Scanner."_make_token(type: TokenType)" -> Token: "creates" {
  style.stroke-dash: 5
  style.stroke: "#ff9800"
}
Scanner."_scan_token()" -> Token: "returns" {
  source-arrowhead: triangle
  style.stroke: "#ff9800"
}

# Annotations - Fixed ELK near constraint
Legend: |md
  ### Architectural Invariants
  1. **LA(1) Persistence**: `_match()` is the only method permitted to advance the cursor conditionally.
  2. **Position Consistency**: All modes must use `Scanner.advance()` to preserve line/column synchronization.
  3. **Greediness**: Priorities 1-5 enforce Maximal Munch before returning to standard character maps.
| {
  near: bottom-center
}