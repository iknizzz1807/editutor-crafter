direction: right
layout-engine: elk
vars: {
  d2-config: {
    theme-id: 0
    pad: 20
  }
}

title: |'md
### Scanner State Variables â€” Cursor Model
Snapshot during scanning of **"42"** in the input `"x + 42"`
'| {
  near: top-center
}

# Role: Memory Layout Diagram
# Legend: Header=Purple, Data=Blue, Free=Green, Padding=Gray, Pointers=Orange
scanner_memory: {
  shape: sql_table
  label: "Scanner Object (0x1000)"
  
  "00h": "PyObject_HEAD" {style.fill: "#6c5ce7"; constraint: "8B"}
  "08h": "source (char*)" {style.fill: "#e17055"; constraint: "8B"}
  "10h": "start (offset): 4" {style.fill: "#0984e3"; constraint: "8B"}
  "18h": "current (offset): 5" {style.fill: "#0984e3"; constraint: "8B"}
  "20h": "line: 1" {style.fill: "#0984e3"; constraint: "8B"}
  "28h": "column: 6" {style.fill: "#0984e3"; constraint: "8B"}
  "30h": "start_column: 5" {style.fill: "#0984e3"; constraint: "8B"}
  "38h": "Padding / Reserved" {style.fill: "#636e72"; constraint: "8B"}
  
  style.stroke: black
  style.stroke-width: 2
}

source_string: {
  shape: sql_table
  label: "Heap: source (char[])"
  
  "0": " 'x' " {style.fill: "#0984e3"; constraint: "1B"}
  "1": " ' ' " {style.fill: "#0984e3"; constraint: "1B"}
  "2": " '+' " {style.fill: "#0984e3"; constraint: "1B"}
  "3": " ' ' " {style.fill: "#0984e3"; constraint: "1B"}
  "4": " '4' " {style.fill: "#0984e3"; constraint: "1B"}
  "5": " '2' " {style.fill: "#0984e3"; constraint: "1B"}
  "6": " '\\0' " {style.fill: "#636e72"; constraint: "1B"}
}

# Cursors as pointers to show state (Orange as per spec)
start_cursor: "start" {
  shape: person
  style.fill: "#e17055"
  style.stroke: "#e17055"
}

current_cursor: "current" {
  shape: person
  style.fill: "#e17055"
  style.stroke: "#e17055"
}

# Explicit connections to rows
scanner_memory."08h" -> source_string."0": "0x5000" {
  style.stroke: "#e17055"
  style.stroke-width: 2
}

start_cursor -> source_string."4" {
  style.stroke: "#e17055"
  style.animated: true
}

current_cursor -> source_string."5" {
  style.stroke: "#e17055"
  style.animated: true
}

# Invariant/Logic annotations
logic_annotation: |'md
**INVARIANTS**
- `Lexeme = source[start:current]`
- `lexeme == "4"` (Snapshot state)
- `start_column` snapshotted before first `advance()`
- Cache line alignment: **64 Bytes total**
'| {
  near: bottom-center
}

# Cache line boundary indication
cache_line: {
  style: {
    stroke: "#636e72"
    stroke-dash: 5
    fill: transparent
  }
  label: "Total size: 64B (1 Cache Line)"
}

# Constraints for Intel-style font/consistency
scanner_memory.*.style.font-color: white
source_string.*.style.font-color: white
scanner_memory.*.style.font: mono
source_string.*.style.font: mono

# Connection to boundary object
scanner_memory -> cache_line: {style.stroke-dash: 5}