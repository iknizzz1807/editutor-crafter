direction: right
layout-engine: elk

vars: {
  d2-config: {
    theme-id: 4
  }
}

# FIX: Moved to root level to satisfy "constant near keys can only be set on root level shapes"
input_stream: "Input Stream State: '@+'" {
  near: top-center
  shape: text
  style: {
    font-size: 18
    bold: true
  }
}

m4_recovery: "Skip-One Error Recovery â€” Algorithm State Trace" {
  style.stroke-width: 4

  step_1: "Step 1: Unrecognized Character Dispatch" {
    source: {
      grid-columns: 2
      grid-gap: 0
      i0: "idx 0" {style.stroke: gray; style.font-size: 10}
      i1: "idx 1" {style.stroke: gray; style.font-size: 10}
      c0: "@" {style.fill: "#ffcccc"; style.stroke-width: 3}
      c1: "+" 
      
      start_ptr: "" {
        shape: person
        height: 20
        width: 10
        style.fill: orange # Pointer Color
      }
      curr_ptr: "" {
        shape: person
        height: 20
        width: 10
        style.fill: red # Changed/Error state
      }

      start_ptr -> c0: "start=0" {style.stroke: orange}
      curr_ptr -> c1: "current=1" {style.stroke: red}
    }

    state: {
      shape: sql_table
      style.fill: "#7016bd" # Header=Purple
      field: value
      line: "1" 
      column: "**2**" {style.font-color: red; style.bold: true} # Changed=Red+Bold
      start_index: "0"
      current_index: "**1**" {style.font-color: red; style.bold: true} # Changed=Red+Bold
    }

    logic: |md
      **Execution Sequence:**
      1. `start` pins to current cursor (0).
      2. `advance()` consumes '@'.
      3. No match in `_scan_token` dispatch.
      4. `else` branch triggers.
      5. Emits `ERROR` token.
    |

    result: "EMITTED" {
      t: Token {
        shape: class
        style.fill: "#7016bd"
        type: TokenType.ERROR
        lexeme: "'@'"
        line: 1
        column: 1
      }
    }
  }

  step_1 -> step_2: "scan_tokens() loop restarts" {
    style.stroke-width: 2
    style.animated: true
  }

  step_2: "Step 2: Re-synchronization and Resume" {
    source: {
      grid-columns: 2
      grid-gap: 0
      i0: "idx 0" {style.stroke: gray; style.font-size: 10}
      i1: "idx 1" {style.stroke: gray; style.font-size: 10}
      c0: "@"
      c1: "+" {style.fill: "#ccffcc"; style.stroke-width: 3}
      
      start_ptr: "" {
        shape: person
        height: 20
        width: 10
        style.fill: orange
      }
      curr_ptr: "" {
        shape: person
        height: 20
        width: 10
        style.fill: red
      }

      start_ptr -> c1: "start=1" {style.stroke: orange}
      curr_ptr -> eof: "current=2" {style.stroke: red}
      eof: "EOF" {style.stroke-dash: 3}
    }

    state: {
      shape: sql_table
      style.fill: "#7016bd" # Header=Purple
      field: value
      line: "1"
      column: "**3**" {style.font-color: red; style.bold: true}
      start_index: "**1**" {style.font-color: red; style.bold: true}
      current_index: "**2**" {style.font-color: red; style.bold: true}
    }

    logic: |md
      **Execution Sequence:**
      1. `start` snapshots `current` (now 1).
      2. `advance()` consumes '+'.
      3. `char in _SINGLE_CHAR_TOKENS` matches.
      4. Emits `OPERATOR` token.
      5. **Invariant Verified**: The '@' was skipped automatically.
    |

    result: "EMITTED" {
      t: Token {
        shape: class
        style.fill: "#7016bd"
        type: TokenType.OPERATOR
        lexeme: "'+'"
        line: 1
        column: 2
      }
    }
  }
}