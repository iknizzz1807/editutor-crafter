direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# Source Buffer Memory Layout
source_buffer: "Source String Buffer" {
  shape: sql_table
  style: {
    stroke: "#6f42c1"
    stroke-width: 2
  }
  header: "Byte Offset | Char | Col" {
    style: {
      fill: "#6f42c1"
      font-color: white
      bold: true
    }
  }
  0: "0x00 | '@' | 1" {style.fill: "#dc3545"; style.font-color: white}
  1: "0x01 | '#' | 2" {style.fill: "#dc3545"; style.font-color: white}
  2: '0x02 | "$" | 3' {style.fill: "#dc3545"; style.font-color: white}
  3: "0x03 | '%' | 4" {style.fill: "#dc3545"; style.font-color: white}
  4: "0x04 | '\\0' | 5" {style.fill: "#28a745"; style.font-color: white}
}

# Scanner Execution Context
scanner: "Scanner::scan_tokens() Loop" {
  style: {
    stroke: "#fd7e14"
    stroke-dash: 5
    stroke-width: 2
  }
  
  dispatch: "DFA Dispatch" {
    shape: diamond
    label: "advance()"
  }

  recovery: "Error Recovery (Skip-One)" {
    style: {
      fill: "#dc3545"
      font-color: white
      bold: true
    }
    label: "Emit ERROR Token"
  }

  dispatch -> recovery: "No Transition Match"
}

# Resulting Token Stream
token_stream: "Token Stream (list[Token])" {
  shape: sql_table
  style: {
    stroke: "#007bff"
    stroke-width: 2
  }
  header: "Index | Type | Lexeme | Line:Col" {
    style: {
      fill: "#6f42c1"
      font-color: white
      bold: true
    }
  }
  idx0: "0 | ERROR | '@' | 1:1" {style.fill: "#ffefef"}
  idx1: "1 | ERROR | '#' | 1:2" {style.fill: "#ffefef"}
  idx2: '2 | ERROR | "$" | 1:3' {style.fill: "#ffefef"}
  idx3: "3 | ERROR | '%' | 1:4" {style.fill: "#ffefef"}
  idx4: "4 | EOF   | ''  | 1:5" {style.fill: "#eeffef"}
}

# Data Flow Connections
source_buffer.0 -> scanner.dispatch: "read(0x00)" {style.stroke: "#007bff"}
scanner.recovery -> token_stream.idx0: "append[0]" {style.stroke: "#007bff"}

source_buffer.1 -> scanner.dispatch: "read(0x01)" {style.stroke: "#007bff"}
scanner.recovery -> token_stream.idx1: "append[1]" {style.stroke: "#007bff"}

source_buffer.2 -> scanner.dispatch: "read(0x02)" {style.stroke: "#007bff"}
scanner.recovery -> token_stream.idx2: "append[2]" {style.stroke: "#007bff"}

source_buffer.3 -> scanner.dispatch: "read(0x03)" {style.stroke: "#007bff"}
scanner.recovery -> token_stream.idx3: "append[3]" {style.stroke: "#007bff"}

source_buffer.4 -> scanner.dispatch: "read(0x04)" {style.stroke: "#28a745"}
scanner.dispatch -> token_stream.idx4: "append[4]" {style.stroke: "#28a745"}

# Technical Spec Annotation
notes: |md
  ### Multi-Error Collection Specification
  - **DFA Continuity**: The scanner does not halt or throw exceptions on lexical errors.
  - **Skip-One Strategy**: `advance()` is called exactly once per unknown character, ensuring recovery to the next byte.
  - **State Invariant**: `start` and `current` indices are synchronized at the start of each loop iteration.
  - **Result Aggregation**: `ERROR` tokens are first-class members of the token list.
| {
  near: bottom-center
}

# Metadata pointers
ptr: {
  shape: person
  label: "Scanner Cursor"
  style.fill: "#fd7e14"
}
ptr -> source_buffer.0: "start"
ptr -> source_buffer.4: "current"