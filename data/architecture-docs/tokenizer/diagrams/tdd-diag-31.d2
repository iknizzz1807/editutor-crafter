layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

# INTEGRATION TEST ANATOMY: INPUT → EXPECTED TOKEN STREAM
# System: Tokenizer Compiler Front-end
# Spec: Milestone 4 Integration Validation

anatomy: {
  title: "Integration Test Anatomy: Lexical Mapping Contract" {
    shape: rectangle
    style: {
      fill: "#6e41ab"
      font-color: white
      bold: true
    }
  }

  source_input: {
    label: "source = \"if (x >= 42) { return true; }\""
    shape: rectangle
    style: {
      stroke: "#3b82f6"
      stroke-width: 2
      font: mono
    }
  }

  character_mapping: {
    label: "Physical Character Grid (1-Indexed Columns)"
    
    grid: {
      grid-columns: 30
      grid-gap: 2
      
      # Column Ruler (Header)
      r1: "1"; r2: "2"; r3: "3"; r4: "4"; r5: "5"; r6: "6"; r7: "7"; r8: "8"; r9: "9"; r10: "10"
      r11: "11"; r12: "12"; r13: "13"; r14: "14"; r15: "15"; r16: "16"; r17: "17"; r18: "18"; r19: "19"; r20: "20"
      r21: "21"; r22: "22"; r23: "23"; r24: "24"; r25: "25"; r26: "26"; r27: "27"; r28: "28"; r29: "29"; r30: "30"

      # Characters (Data)
      c1: "i"; c2: "f"; c3: " "; c4: "("; c5: "x"; c6: " "; c7: ">"; c8: "="; c9: " "; c10: "4"
      c11: "2"; c12: ")"; c13: " "; c14: "{"; c15: " "; c16: "r"; c17: "e"; c18: "t"; c19: "u"
      c20: "r"; c21: "n"; c22: " "; c23: "t"; c24: "r"; c25: "u"; c26: "e"; c27: ";"; c28: " "
      c29: "}"; c30: "∅"

      style: {
        font: mono
        stroke-dash: 1
      }
    }
  }

  expected_tokens: {
    label: "Expected list[Token] Contract"
    
    list: {
      grid-columns: 1
      t01: "0: Token(KEYWORD, 'if', 1, 1)"
      t02: "1: Token(LPAREN, '(', 1, 4)"
      t03: "2: Token(IDENTIFIER, 'x', 1, 5)"
      t04: "3: Token(GREATER_EQ, '>=', 1, 7)"
      t05: "4: Token(NUMBER, '42', 1, 10)"
      t06: "5: Token(RPAREN, ')', 1, 12)"
      t07: "6: Token(LBRACE, '{', 1, 14)"
      t08: "7: Token(KEYWORD, 'return', 1, 16)"
      t09: "8: Token(KEYWORD, 'true', 1, 23)"
      t10: "9: Token(SEMICOLON, ';', 1, 27)"
      t11: "10: Token(RBRACE, '}', 1, 29)"
      t12: "11: Token(EOF, '', 1, 30)"
      
      style: {
        font: mono
        fill: "#f8fafc"
        stroke: "#3b82f6"
      }
    }
  }

  note: |md
    ### Verification Requirements
    1. **Column Accuracy**: Columns refer to the *start* of the lexeme.
    2. **Whitespace**: Consumed internally; contributes to column offset but emits no tokens (e.g., Index 3, 6, 9, 13, 15, 22, 28).
    3. **Sentinels**: EOF index is the length of source + 1 (30).
    
    **Intel Manual Quality**: Grid cells represent physical byte/char offsets.
  | {
    near: bottom-center
    style.font-size: 14
  }
}

# Lexeme Start Markers (Blue Highlights)
anatomy.character_mapping.grid.c1.style.fill: "#bfdbfe"
anatomy.character_mapping.grid.c4.style.fill: "#bfdbfe"
anatomy.character_mapping.grid.c5.style.fill: "#bfdbfe"
anatomy.character_mapping.grid.c7.style.fill: "#bfdbfe"
anatomy.character_mapping.grid.c10.style.fill: "#bfdbfe"
anatomy.character_mapping.grid.c12.style.fill: "#bfdbfe"
anatomy.character_mapping.grid.c14.style.fill: "#bfdbfe"
anatomy.character_mapping.grid.c16.style.fill: "#bfdbfe"
anatomy.character_mapping.grid.c23.style.fill: "#bfdbfe"
anatomy.character_mapping.grid.c27.style.fill: "#bfdbfe"
anatomy.character_mapping.grid.c29.style.fill: "#bfdbfe"
anatomy.character_mapping.grid.c30.style.fill: "#dcfce7"

# Connections showing mapping logic (Character Start -> Token Object)
anatomy.character_mapping.grid.c1 -> anatomy.expected_tokens.list.t01: {style.stroke: orange}
anatomy.character_mapping.grid.c4 -> anatomy.expected_tokens.list.t02: {style.stroke: orange}
anatomy.character_mapping.grid.c5 -> anatomy.expected_tokens.list.t03: {style.stroke: orange}
anatomy.character_mapping.grid.c7 -> anatomy.expected_tokens.list.t04: {style.stroke: orange}
anatomy.character_mapping.grid.c10 -> anatomy.expected_tokens.list.t05: {style.stroke: orange}
anatomy.character_mapping.grid.c12 -> anatomy.expected_tokens.list.t06: {style.stroke: orange}
anatomy.character_mapping.grid.c14 -> anatomy.expected_tokens.list.t07: {style.stroke: orange}
anatomy.character_mapping.grid.c16 -> anatomy.expected_tokens.list.t08: {style.stroke: orange}
anatomy.character_mapping.grid.c23 -> anatomy.expected_tokens.list.t09: {style.stroke: orange}
anatomy.character_mapping.grid.c27 -> anatomy.expected_tokens.list.t10: {style.stroke: orange}
anatomy.character_mapping.grid.c29 -> anatomy.expected_tokens.list.t11: {style.stroke: orange}
anatomy.character_mapping.grid.c30 -> anatomy.expected_tokens.list.t12: {style.stroke: orange}

# Logic Flow
anatomy.source_input -> anatomy.character_mapping: "Character Indexing"

# Style overrides for technical precision
anatomy.character_mapping.grid.r*: {
  style.fill: "#e2e8f0"
  style.bold: true
}
anatomy.character_mapping.grid.c*: {
  # Default data cell color
  style.stroke: "#94a3b8"
}