direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# --- GLOBAL STYLES (Persona: Header=Purple, Data=Blue, Error=Red, Padding/Correct=Green) ---
classes: {
  step_box: {
    style: {
      stroke: black
      stroke-width: 2
      border-radius: 4
    }
  }
  header_style: {
    style: {
      fill: "#6a0dad" # Purple
      font-color: white
      bold: true
    }
  }
  source_page: {
    shape: page
    style: {
      fill: "#f8f9fa"
      stroke: "#dee2e6"
      font: mono
    }
  }
  token_data: {
    style: {
      fill: "#007bff" # Blue
      font-color: white
    }
  }
  error_highlight: {
    style: {
      fill: "#dc3545" # Red
      font-color: white
      bold: true
    }
  }
  correct_label: {
    style: {
      fill: "#28a745" # Green
      font-color: white
    }
  }
}

# --- DIAGRAM TITLE ---
Title: "POSITION DRIFT: ACCUMULATED OFF-BY-ONE ERRORS" {
  shape: text
  style: {
    font-size: 24
    bold: true
  }
}

# --- ALGORITHM STEPS ---

Step1: "1. BASELINE (LINE 1)" {
  class: [step_box; header_style]
  direction: right
  
  Source: "x + y" { class: source_page }
  
  Positions: {
    t1: "x (idx: 0, col: 1)" { class: correct_label }
    t2: "+ (idx: 2, col: 3)" { class: correct_label }
    t3: "y (idx: 4, col: 5)" { class: correct_label }
  }
  
  Status: "NO DRIFT" {
    style: { fill: "#d4edda"; stroke: "#28a745" }
  }
}

Step2: "2. DRIFT INITIATION (LINE 2)" {
  class: [step_box; header_style]
  direction: right
  
  Source: "\\t x" { class: source_page }
  
  Expected: "x (idx: 1, col: 2)" { style.italic: true }
  
  Actual: "x (idx: 1, col: 3)" { 
    class: error_highlight 
    tooltip: "Tab incorrectly counted as 2 columns instead of 1"
  }
  
  Drift: "ERROR: +1" { class: error_highlight }
}

Step3: "3. DRIFT ACCUMULATION (LINE 3)" {
  class: [step_box; header_style]
  direction: right
  
  Source: "\\t\\t y" { class: source_page }
  
  Expected: "y (idx: 2, col: 3)" { style.italic: true }
  
  Actual: "y (idx: 2, col: 5)" { class: error_highlight }
  
  Drift: "ERROR: +2" { class: error_highlight }
}

Step4: "4. SYSTEMIC FAILURE (LINE 10)" {
  class: [step_box; header_style]
  direction: right
  
  Source: "\\t\\t\\t\\t\\t\\t\\t\\t\\t z" { class: source_page }
  
  Expected: "z (idx: 9, col: 10)" { style.italic: true }
  
  Actual: "z (idx: 9, col: 19)" { 
    class: error_highlight 
    style.stroke-width: 4
  }
  
  Drift: "ERROR: +9" { class: error_highlight }
}

# --- CONNECTIONS ---
Step1 -> Step2: "Newline Reset"
Step2 -> Step3: "Next Line"
Step3 -> Step4: "9 Lines Later..."

# --- SUMMARY ANNOTATION (Fixed ELK positioning) ---

Summary: |md
  ### TECHNICAL IMPACT: THE SILENT CORRUPTOR
  - **Non-Fatal Failure**: Unlike a crash, position drift does not trigger exceptions.
  - **Cascading Inaccuracy**: Every token following the bug inherits the offset.
  - **Detection Gap**: Unit tests often miss multi-line tab interactions.
  - **Primary Defense**: Column must be monotonic per line and match `\t` width logic.
| {
  near: bottom-center
  style: {
    stroke: "#dc3545"
    fill: "#fff5f5"
    stroke-width: 2
  }
}

# --- GRAPH REPRESENTATION ---
DriftGraph: {
  near: bottom-right
  grid-rows: 2
  grid-columns: 2
  
  L1: "Line 1: 0" { class: correct_label }
  L2: "Line 2: +1" { class: error_highlight }
  L3: "Line 3: +2" { class: error_highlight }
  L10: "Line 10: +9" { 
    class: error_highlight 
    style.stroke-width: 3
  }
  
  style.stroke-dash: 3
  label: "Linear Drift Slope"
}

DriftGraph.L1 -> DriftGraph.L2 -> DriftGraph.L3 -> DriftGraph.L10: "Slope" {
  style.stroke: red
  style.stroke-width: 2
}