layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

title: |md
  # POSITION INVARIANT SUITE
  ### Three Checkable Properties for Scanner Correctness
| {
  near: top-center
  shape: text
}

# -----------------------------------------------------------------------------
# PANEL 1: LINE BOUNDS
# -----------------------------------------------------------------------------
line_bounds: "PANEL 1: Line Invariant" {
  explanation: |md
    **Property:** `1 <= t.line <= source.count('\n') + 1`
  | {shape: text}

  passing: "PASSING: Correct Line Mapping" {
    style.stroke: green
    source: "a\\nb" {shape: code; style.fill: white}
    axis: {
      shape: sequence_diagram
      line1: "Line 1"
      line2: "Line 2"
      line1 -> line2: advance('\\n')
    }
    t1: "Token('a')" {style.fill: "#E1F5FE"; tooltip: "line: 1"}
    t2: "Token('b')" {style.fill: "#E1F5FE"; tooltip: "line: 2"}
    
    t1 -> axis.line1: "maps to"
    t2 -> axis.line2: "maps to"
  }

  failing: "FAILING: Double Counting CRLF" {
    style.stroke: red
    source: "a\\r\\nb" {shape: code; style.fill: white}
    t_err: "Token('b')" {
      style.fill: "#FFEBEE"
      style.stroke: red
      style.bold: true
      tooltip: "line: 3 (ERROR)"
    }
    note: "Caught Error: \\r incremented line before \\n" {
      shape: text
      style.font-color: red
    }
  }
}

# -----------------------------------------------------------------------------
# PANEL 2: COLUMN MINIMUM
# -----------------------------------------------------------------------------
column_minimum: "PANEL 2: Column Minimum" {
  explanation: |md
    **Property:** `t.column >= 1`
  | {shape: text}

  passing: "PASSING: 1-Indexed" {
    style.stroke: green
    grid: {
      grid-columns: 5
      grid-gap: 2
      c1: "1" {style.fill: "#C8E6C9"}
      c2: "2"
      c3: "3"
      c4: "4"
      c5: "5"
    }
    token: "Token('if')" {style.fill: "#E1F5FE"}
    token -> grid.c1: "Starts at"
  }

  failing: "FAILING: 0-Indexed Bug" {
    style.stroke: red
    grid: {
      grid-columns: 5
      grid-gap: 2
      c0: "0" {style.fill: "#FFCDD2"; style.stroke: red}
      c1: "1"
      c2: "2"
      c3: "3"
      c4: "4"
    }
    token: "Token('if')" {
      style.fill: "#FFEBEE"
      style.stroke: red
      style.bold: true
    }
    token -> grid.c0: "ILLEGAL" {style.stroke: red; style.stroke-dash: 3}
    note: "Caught Error: Direct string index used as column" {
      shape: text
      style.font-color: red
    }
  }
}

# -----------------------------------------------------------------------------
# PANEL 3: MONOTONICITY
# -----------------------------------------------------------------------------
monotonicity: "PANEL 3: Column Monotonicity" {
  explanation: |md
    **Property:** `If t1.line == t2.line then t2.col > t1.col`
  | {shape: text}

  passing: "PASSING: Strictly Increasing" {
    style.stroke: green
    t1: "if" {tooltip: "col: 1"}
    t2: "(" {tooltip: "col: 4"}
    t3: "x" {tooltip: "col: 5"}
    
    t1 -> t2 -> t3: "Col: 1 < 4 < 5" {style.stroke: green}
  }

  failing: "FAILING: Position Drift" {
    style.stroke: red
    t1: "if" {tooltip: "col: 1"}
    t2: "(" {
      tooltip: "col: 1 (STALL)"
      style.fill: "#FFEBEE"
      style.stroke: red
      style.bold: true
    }
    
    t1 -> t2: "Col: 1 == 1" {style.stroke: red; label: "DRIFT DETECTED"}
    note: "Caught Error: Column reset to 1 without consuming newline" {
      shape: text
      style.font-color: red
    }
  }
}

# Layout constraints
line_bounds -> column_minimum -> monotonicity