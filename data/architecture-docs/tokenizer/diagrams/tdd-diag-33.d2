direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

classes: {
  header: {
    style: {
      fill: "#6e4a9e"
      font-color: white
      bold: true
    }
  }
  data: {
    style: {
      fill: "#e1f5fe"
      stroke: "#b3e5fc"
    }
  }
  munch_highlight: {
    style: {
      fill: "#ffebee"
      stroke: "#f44336"
      stroke-width: 3
      bold: true
      font-color: "#d32f2f"
    }
  }
}

milestone_4: "Milestone 4: Integration Validation" {
  source_input: "Source Input String" {
    shape: text
    label: |md
      `if (x >= 42) { return true; }`
      `1234567890123456789012345678901`
    |
  }

  token_table: "Final Token Stream Table" {
    grid-columns: 4
    grid-gap: 0

    # Headers
    h1: "Index" {class: header}
    h2: "TokenType" {class: header}
    h3: "Lexeme" {class: header}
    h4: "Position (L:C)" {class: header}

    # Row 0
    r0_1: "0" {class: data}
    r0_2: "KEYWORD" {class: data}
    r0_3: "'if'" {class: data}
    r0_4: "1:1" {class: data}

    # Row 1
    r1_1: "1" {class: data}
    r1_2: "PUNCTUATION" {class: data}
    r1_3: "'('" {class: data}
    r1_4: "1:4" {class: data}

    # Row 2
    r2_1: "2" {class: data}
    r2_2: "IDENTIFIER" {class: data}
    r2_3: "'x'" {class: data}
    r2_4: "1:5" {class: data}

    # Row 3 - MAXIMAL MUNCH POINT
    r3_1: "3" {class: munch_highlight}
    r3_2: "GREATER_EQUAL" {class: munch_highlight}
    r3_3: "'>='" {class: munch_highlight}
    r3_4: "1:7" {class: munch_highlight}

    # Row 4
    r4_1: "4" {class: data}
    r4_2: "NUMBER" {class: data}
    r4_3: "'42'" {class: data}
    r4_4: "1:10" {class: data}

    # Row 5
    r5_1: "5" {class: data}
    r5_2: "PUNCTUATION" {class: data}
    r5_3: "')'" {class: data}
    r5_4: "1:12" {class: data}

    # Row 6
    r6_1: "6" {class: data}
    r6_2: "PUNCTUATION" {class: data}
    r6_3: "'{'" {class: data}
    r6_4: "1:14" {class: data}

    # Row 7
    r7_1: "7" {class: data}
    r7_2: "KEYWORD" {class: data}
    r7_3: "'return'" {class: data}
    r7_4: "1:16" {class: data}

    # Row 8
    r8_1: "8" {class: data}
    r8_2: "KEYWORD" {class: data}
    r8_3: "'true'" {class: data}
    r8_4: "1:23" {class: data}

    # Row 9
    r9_1: "9" {class: data}
    r9_2: "PUNCTUATION" {class: data}
    r9_3: "';'" {class: data}
    r9_4: "1:27" {class: data}

    # Row 10
    r10_1: "10" {class: data}
    r10_2: "PUNCTUATION" {class: data}
    r10_3: "'}'" {class: data}
    r10_4: "1:29" {class: data}

    # Row 11
    r11_1: "11" {class: data}
    r11_2: "EOF" {class: data}
    r11_3: "''" {class: data}
    r11_4: "1:31" {class: data}
  }

  Note: |md
    ### Maximal Munch Validation
    At index 7 in the source, the scanner encounters `>`. 
    Instead of emitting `GREATER_THAN` immediately, the 
    `_match('=')` lookahead consumes the next character, 
    forming the single token **GREATER_EQUAL**. 
    Whitespace (indices 3, 6, 9, 13, 15, 22, 28) results in 
    no token emission as per **Milestone 1** logic.
  | {
    # near: milestone_4.token_table  # removed: elk requires constant
  }
}