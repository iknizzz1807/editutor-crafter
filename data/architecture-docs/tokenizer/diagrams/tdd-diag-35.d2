direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

PerformanceBenchmark: {
  shape: sequence_diagram

  # Participants
  Benchmarker: "TestRunner\n(Milestone 4 Integration)" {
    shape: person
  }
  Gen: "SourceGenerator\n(Logic: 4-Pattern Cycle)" {
    shape: rectangle
  }
  S: "Scanner\n(Milestone 3 Core)" {
    style: {
      fill: "#b9d9eb"
      stroke: "#2f5a83"
    }
  }
  OS: "PythonRuntime\n(Interpreter & Clock)" {
    shape: cylinder
  }
  Stats: "PerformanceStats\n(Validation Logic)" {
    style.fill: "#e2f0d9"
  }

  # Step 1: Data Generation
  Benchmarker -> Gen: "generate_large_source(10_000)"
  
  Gen."Pattern Cycle: 1. // comment, 2. id=id+num, 3. id='str', 4. if(id>=num)"

  Gen -> Benchmarker: "source_str (~300,000 chars)" {
    style.stroke-dash: 5
  }

  # Step 2: Warm-up Pass
  Benchmarker -> S: "Scanner(source[:100]).scan_tokens()"
  S -> OS: "Attribute Lookup & Method Binding"
  
  S."Primes caches for advance(), peek(), and TokenType dispatch"
  
  S -> Benchmarker: "tokens_list (Partial)" {
    style.stroke-dash: 5
  }

  # Step 3: Timing Boundary Start
  Benchmarker -> OS: "start = time.perf_counter()"
  OS -> Benchmarker: "timestamp_t0" {
    style.stroke-dash: 5
  }

  # Step 4: Full Benchmark Scan
  Benchmarker -> S: "Scanner(source).scan_tokens()" {
    style.stroke: "#2f5a83"
    style.stroke-width: 3
  }

  S -> S: "advance() x 300,000 iterations"

  S."Performance Bottlenecks: No O(n²) string concat, Reduce attribute access, Minimize is_at_end()"

  S -> Benchmarker: "list[Token] (Length > 10,000)" {
    style.stroke-dash: 5
  }

  # Step 5: Timing Boundary End
  Benchmarker -> OS: "elapsed = time.perf_counter() - start"
  OS -> Benchmarker: "total_seconds" {
    style.stroke-dash: 5
  }

  # Step 6: Validation & Assertion
  Benchmarker -> Stats: "Calculate(elapsed, len(source))"
  Stats -> Benchmarker: "MB/s, Tokens/s, Chars/s" {
    style.stroke-dash: 5
  }

  Benchmarker -> Benchmarker: "assert elapsed < 1.0s" {
    style.stroke: "#228b22"
  }

  # Error Case Simulation
  Benchmarker -> Benchmarker: "elapsed > 1.0s" {
    style: {
      stroke: red
      stroke-dash: 3
    }
    label: "TIMEOUT FAILURE"
  }
}

# Standalone annotation block fixed for ELK compatibility
PerformanceEnvelope: |md
  ### PERFORMANCE ENVELOPE (x86_64)
  - **Expected:** 0.1s — 0.4s
  - **Requirement:** < 1.0s
  - **Throughput:** ~1.5 MB/s
| {
  near: bottom-center
  style: {
    stroke: gray
    stroke-dash: 2
    fill: "#f8f8f8"
  }
}