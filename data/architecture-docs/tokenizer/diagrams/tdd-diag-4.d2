layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

# --- SOURCE STRING MEMORY LAYOUT ---
source_memory: "Source String (6 bytes)" {
  shape: sql_table
  style: {
    stroke: "#70163C" # Purple Header
    fill: "#F1F5F9"
  }
  
  # Offsets (Left) | Value | Size (Right)
  "0x00": " 'x' " {constraint: "1B"}
  "0x01": " ' ' " {constraint: "1B"}
  "0x02": " '+' " {constraint: "1B"; style.fill: "#3B82F6"} # Data (Blue)
  "0x03": " ' ' " {constraint: "1B"}
  "0x04": " '1' " {constraint: "1B"}
  "0x05": " '\\0' " {constraint: "1B"; style.fill: "#94A3B8"} # Padding (Gray)
}

# --- SCANNER STATE ---
scanner_state: "Scanner Runtime State" {
  style.fill: "#E0F2FE"
  
  current: "current = 2" {
    tooltip: "Index of NEXT character to consume"
    style.stroke: "#F59E0B" # Pointer (Orange)
    style.stroke-width: 4
  }
  line: "line = 1"
  column: "column = 3" {
    tooltip: "Position of the character at source[2]"
  }
}

scanner_state.current -> source_memory."0x02": "Points to source[2]" {
  style: {
    stroke: "#F59E0B"
    stroke-width: 3
    animated: true
  }
}

# --- ALGORITHM COMPARISON ---
logic_flow: "Tokenizer State Invariants" {
  
  correct_logic: "CORRECT: Capture-Before-Advance" {
    style.stroke: "#10B981" # Free/Green (Success)
    style.stroke-width: 2
    
    step1: "1. Capture Start Position" {
      shape: rectangle
      label: |md
        python
        # Capture current metadata
        tok_line = self.line   # 1
        tok_col  = self.column # 3
        
      |
    }
    
    step2: "2. Consume Character" {
      shape: rectangle
      label: |md
        python
        char = self.advance()  # '+'
        # Mutates state:
        # self.current += 1    (3)
        # self.column  += 1    (4)
        
      |
    }
    
    result: "3. Emit Token" {
      style.fill: "#DCFCE7"
      label: "Token(PLUS, '+', 1, 3)"
    }
    
    step1 -> step2 -> result
  }

  bug_logic: "BUG: Advance-Before-Capture" {
    style.stroke: "#EF4444" # Error/Red
    style.stroke-width: 2
    style.stroke-dash: 5

    step1: "1. Consume Character First" {
      shape: rectangle
      label: |md
        python
        char = self.advance() # '+'
        # column is now 4
        
      |
    }
    
    step2: "2. Capture Position Late" {
      shape: rectangle
      style.fill: "#FEE2E2"
      label: |md
        python
        # Captures mutated state
        tok_col = self.column # 4
        
      |
    }
    
    result: "3. Emit WRONG Position" {
      style.fill: "#FEE2E2"
      style.font-color: "#B91C1C"
      label: "Token(PLUS, '+', 1, 4) âŒ"
    }
    
    step1 -> step2 -> result
  }
}

# --- ANNOTATIONS ---
# Fixed: "near" set to constant for ELK compatibility
annotation: |md
  ### The Scanner Invariant
  - **current**: Pointer to the *next* byte to be processed.
  - **line/column**: Reflects source position of `source[current]`.
  
  **Rule**: Coordinate "snapping" must occur **before** pointer mutation.
| {
  near: top-right
}

# Data Dependencies
correct_logic.step1 -> scanner_state: "Reads snapshot 1:3" {style.stroke-dash: 3}
bug_logic.step2 -> scanner_state: "Reads mutated 1:4" {style.stroke: "#EF4444"}