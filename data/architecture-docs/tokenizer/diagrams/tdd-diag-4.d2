layout-engine: elk
theme-id: 0

Scanner: "Scanner" {
  shape: rectangle
  style.fill: "#f8f9fa"
}

Source: "Source (str)" {
  shape: rectangle
  style.fill: "#e9ecef"
}

User: "User"

# Initial State Setup
note_init: |md
  **INITIAL STATE**
  - `source`: `"A\n"` (len=2)
  - `current`: 0
  - `line`: 1
  - `column`: 1
| {
  near: top-left
}

# Interaction 1: advance()
User -> Scanner: advance()
Scanner -> Source: read byte at index 0
Source -> Scanner: 'A'
Scanner -> Scanner: update state {
  tooltip: "current: 1, column: 2"
}
Scanner -> User: return 'A' {
  style.stroke: "#007bff"
}

note_step1: |md
  **Step 1: advance()**
  Consumes 'A'. 
  - `current` moves **0 → 1**
  - `column` moves **1 → 2**
| {
  near: top-right
}

# Interaction 2: peek() (Lookahead)
User -> Scanner: peek()
Scanner -> Source: inspect byte at index 1
Source -> Scanner: '\n'
Scanner -> User: return '\n' {
  style.stroke: "#28a745"
}

note_step2: |md
  **Step 2: peek()**
  Idempotent read. 
  - `current` remains **1**
  - Metadata remains **unchanged**
| {
  near: center-left
}

# Interaction 3: advance() with Newline
User -> Scanner: advance()
Scanner -> Source: read byte at index 1
Source -> Scanner: '\n'
Scanner -> Scanner: update state {
  tooltip: "current: 2, line: 2, column: 1"
}
Scanner -> User: return '\n' {
  style.stroke: "#007bff"
}

note_step3: |md
  **Step 3: advance() (Newline)**
  Consumes '\n'. 
  - `current` moves **1 → 2**
  - `line` increments **1 → 2**
  - `column` resets **2 → 1**
| {
  near: center-right
}

# Interaction 4: peek() at EOF
User -> Scanner: peek()
Scanner -> Scanner: check `current >= len(source)`
Scanner -> User: return '' (empty string) {
  style.stroke: "#dc3545"
}

note_step4: |md
  **Step 4: EOF Handling**
  `current` (2) is at end.
  - Returns `''` safely.
  - Avoids `IndexError`.
  - Terminates `while peek() != '\n'`.
| {
  near: bottom-right
}

# Styling for distinctions
Scanner.style.stroke-width: 2
User.style.font-size: 14

(User -> Scanner)[0].label: "1. Mutate"
(User -> Scanner)[1].label: "2. Inspect"
(User -> Scanner)[2].label: "3. Mutate (NL)"
(User -> Scanner)[3].label: "4. Boundary Check"