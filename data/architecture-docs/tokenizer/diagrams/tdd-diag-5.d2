direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

advance_logic: {
  label: "Scanner::advance() Internal Logic"

  # States
  init: â— {
    tooltip: "Entry point for character consumption"
  }
  
  read_source: "Read char\nchar = source[current]" {
    shape: rectangle
    style: {
      stroke-width: 2
    }
  }

  char_dispatch: {
    shape: diamond
    label: "char == ?"
  }

  handle_newline: {
    label: "Update Line\nline += 1\ncolumn = 1"
    style: {
      fill: "#e1dbfe"
    }
  }

  handle_tab: {
    label: "Update Tab\ncolumn += tab_width"
    style: {
      fill: "#e1dbfe"
    }
  }

  handle_default: {
    label: "Update Column\ncolumn += 1"
    style: {
      fill: "#e1dbfe"
    }
  }

  increment_current: "Finalize State\ncurrent += 1" {
    shape: rectangle
  }

  exit_node: "Return char" {
    style: {
      double-border: true
      stroke-width: 2
      bold: true
    }
  }

  # Transitions: trigger + [guard] + action
  init -> read_source: "call advance()"
  
  read_source -> char_dispatch

  char_dispatch -> handle_newline: "'\\n'" {
    style: {
      stroke: "#6772E5"
      bold: true
    }
  }

  char_dispatch -> handle_tab: "'\\t'" {
    style: {
      stroke: "#6772E5"
    }
  }

  char_dispatch -> handle_default: "else" {
    style: {
      stroke: "#6772E5"
    }
  }

  handle_newline -> increment_current
  handle_tab -> increment_current
  handle_default -> increment_current

  increment_current -> exit_node: "pop to caller"
}

# Resolved: Constant near keys (like top-right) must be applied to root-level shapes.
# Moved from inside 'advance_logic' to diagram root.
annotation: |md
  ### INVARIANT: POSITIONAL SYNCHRONIZATION
  Every single character consumed from the `source` string **MUST** pass 
  through this routine. 
  
  This ensures that `line` and `column` metadata are updated atomically with 
  the `current` byte-offset pointer.
| {
  near: top-right
  style: {
    stroke: orange
    stroke-dash: 3
  }
}