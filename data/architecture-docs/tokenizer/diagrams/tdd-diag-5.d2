direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# 1. MEMORY LAYOUT: Character Buffer
character_buffer: {
  label: "Source Buffer Memory Layout"
  shape: sql_table
  style.stroke: "#DDA0DD" # Purple: Header
  
  header: "Byte Offset | Field | Size"
  0x00: "char '+'" {constraint: "1 byte"; style.fill: "#ADD8E6"} # Blue: Data
  0x01: "char '\\n'" {constraint: "1 byte"; style.fill: "#ADD8E6"}
  0x02: "char '+'" {constraint: "1 byte"; style.fill: "#ADD8E6"}
  0x03: "char '\\0' (EOF)" {constraint: "1 byte"; style.fill: "#808080"} # Gray: Padding/End
  
  footer: "Total Size: 4 Bytes (Stack Allocated)"
}

# 2. ALGORITHM LOGIC: Branching Paths
logic: {
  label: "Algorithm: Scanner.advance() Branching"
  
  path_a: "Path A: Normal Character" {
    shape: sql_table
    style.stroke: "#DDA0DD"
    1: "1. read char = source[current]"
    2: "2. current += 1"
    3: "3. column += 1"
    4: "4. return char"
  }

  path_b: "Path B: Newline Character (\\n)" {
    shape: sql_table
    style.stroke: "#DDA0DD"
    1: "1. read char = source[current]"
    2: "2. current += 1"
    3: "3. line += 1"
    4: "4. column = 1"
    5: "5. return char"
  }
}

# 3. STATE TRANSITIONS: Numbered Steps
trace: {
  step_0: "Step 0: Initial State" {
    style.stroke: "#FFA500" # Orange: Pointer Focus
    current: "0"
    line: "1"
    column: "1"
    lookahead: "'+'"
  }

  step_1: "Step 1: After '+' (Path A)" {
    current: "1" { style: { font-color: red; bold: true } }
    line: "1"
    column: "2" { style: { font-color: red; bold: true } }
    lookahead: "'\\n'" { style: { font-color: red; bold: true } }
  }

  step_2: "Step 2: After '\\n' (Path B)" {
    current: "2" { style: { font-color: red; bold: true } }
    line: "2" { style: { font-color: red; bold: true } }
    column: "1" { style: { font-color: red; bold: true } }
    lookahead: "'+'" { style: { font-color: red; bold: true } }
  }

  step_3: "Step 3: After second '+' (Path A)" {
    current: "3" { style: { font-color: red; bold: true } }
    line: "2"
    column: "2" { style: { font-color: red; bold: true } }
    lookahead: "EOF" { style: { font-color: red; bold: true } }
  }

  step_0 -> step_1: "advance()"
  step_1 -> step_2: "advance()"
  step_2 -> step_3: "advance()"
}

# 4. METADATA & ANNOTATIONS
ann: |md
  ### Scanner Invariants
  - **current**: Index of the *next* character to be read.
  - **line/column**: Tracks position for the *next* character.
  - **Maximal Munch**: Immediate decision for `+`.
| {
  near: top-right
  style.fill: "#f8f8f8"
  style.stroke: "#DDA0DD"
}

# 5. LEGEND
legend: {
  shape: package
  near: bottom-right
  label: "State Symbols"
  header: "Purple: Metadata/Header" { style.fill: "#DDA0DD" }
  data: "Blue: Source Buffer" { style.fill: "#ADD8E6" }
  pointer: "Orange: Pointer Focus" { style.stroke: "#FFA500" }
  changed: "Red+Bold: Mutated State" { style.font-color: red }
  consumed: "Green: Free/Consumed" { style.fill: "#90EE90" }
}