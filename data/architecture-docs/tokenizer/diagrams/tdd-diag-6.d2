layout-engine: elk
theme-id: 4

classes: {
  changed: {
    style: {
      stroke: "#cc0000"
      stroke-width: 4
      font-color: "#cc0000"
      bold: true
    }
  }
  snapshot_box: {
    style: {
      fill: "#fff2cc"
      stroke: "#d6b656"
      stroke-width: 2
    }
  }
}

title: |md
# Algorithm Trace: Position Tracking Invariants
**Input String:** `(\n+`
**Goal:** Verify column reset on newline and start-position snapshotting.
| {
  near: top-center
}

step1: "Step 1: _scan_token() Initialization ('(')" {
  direction: right
  before: {
    source: "( \n +"
    pointers: "█ ^ ^"
    locals: {
      line: 1
      column: 1
      start_column: 0
      current: 0
    }
  }
  action: "Snapshot start_column = column"
  after: {
    source: "( \n +"
    pointers: "█ ^ ^"
    locals: {
      line: 1
      column: 1
      start_column: "**1**"
      current: 0
    }
    locals.start_column.class: changed
  }
}

step2: "Step 2: advance() execution ('(')" {
  direction: right
  before: {
    locals: {
      line: 1
      column: 1
      start_column: 1
      current: 0
    }
  }
  action: "Consume '('; current++; column++"
  after: {
    locals: {
      line: 1
      column: "**2**"
      start_column: 1
      current: "**1**"
    }
    locals.column.class: changed
    locals.current.class: changed
  }
}

step3: "Step 3: New Loop for Whitespace ('\\n')" {
  direction: right
  before: {
    source: "( \n +"
    pointers: "^ █ ^"
    locals: {
      line: 1
      column: 2
      start_column: 1
      current: 1
    }
  }
  action: "Snapshot start_column = column (2)"
  after: {
    locals: {
      line: 1
      column: 2
      start_column: "**2**"
      current: 1
    }
    locals.start_column.class: changed
  }
}

step4: "Step 4: advance() handles Newline ('\\n')" {
  direction: right
  before: {
    locals: {
      line: 1
      column: 2
      start_column: 2
      current: 1
    }
  }
  action: "Detect '\\n'; line++; column = 1"
  after: {
    locals: {
      line: "**2**"
      column: "**1**"
      start_column: 2
      current: "**2**"
    }
    locals.line.class: changed
    locals.column.class: changed
    locals.current.class: changed
  }
}

step5: "Step 5: Initialization for ('+')" {
  direction: right
  before: {
    source: "( \n +"
    pointers: "^ ^ █"
    locals: {
      line: 2
      column: 1
      start_column: 2
      current: 2
    }
  }
  action: "Snapshot start_column = column (1)"
  after: {
    locals: {
      line: 2
      column: 1
      start_column: "**1**"
      current: 2
    }
    locals.start_column.class: changed
  }
}

pitfall: "CRITICAL INVARIANT: Snapshot Timing" {
  correct: {
    label: "CORRECT (Snapshot BEFORE advance)"
    code: |python
      # State: col=1
      self.start_column = self.column # 1
      char = self.advance()           # col becomes 2
      # Emitted Token: col=1 (Correct)
    |
    class: snapshot_box
  }
  incorrect: {
    label: "PITFALL (Snapshot AFTER advance)"
    code: |python
      # State: col=1
      char = self.advance()           # col becomes 2
      self.start_column = self.column # 2
      # Emitted Token: col=2 (OFF-BY-ONE)
    |
    style: {
      stroke: "#cc0000"
      stroke-width: 3
      fill: "#f8cecc"
    }
  }
}

step1 -> step2
step2 -> step3
step3 -> step4
step4 -> step5

legend: {
  near: bottom-right
  class: snapshot_box
  note: "Start position must be captured while the cursor is at the first character of the lexeme."
}