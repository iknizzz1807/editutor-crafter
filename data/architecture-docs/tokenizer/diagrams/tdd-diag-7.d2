direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# START/TERMINAL NODES
INITIAL_NODE: "●" {
  shape: circle
  style: {
    fill: black
    font-color: white
    stroke-width: 0
  }
  width: 30
  height: 30
}

FINAL_NODE: "" {
  shape: circle
  style: {
    double-border: true
    fill: black
    stroke-width: 2
  }
  width: 30
  height: 30
}

# MAIN STATES
START_STATE: "START" {
  shape: rectangle
  style.stroke-width: 3
  
  description: |md
    ### STATE INVARIANTS
    - `current` offset points to next unconsumed byte.
    - `line`/`column` synchronized to `current`.
    - `start` pointer anchored to lexeme beginning.
  |
}

ERROR_RECOVERY: "ERROR STATE" {
  style: {
    fill: "#fce4ec"
    stroke: red
    stroke-width: 2
  }
  tooltip: "Emit ERROR token and synchronize to statement boundary"
}

# TRANSITIONS: trigger [guard] / action
INITIAL_NODE -> START_STATE: "Scanner(source) / init_pointers()"

# Transition 1: Whitespace loop (Self)
START_STATE -> START_STATE: "peek() [char ∈ WHITESPACE] / advance()" {
  style.stroke-dash: 3
}

# Transition 2: Token Production (Self)
START_STATE -> START_STATE: "peek() [char ∈ SINGLE_CHAR] / advance(); emit_token()" {
  style.stroke-width: 3
}

# Transition 3: Error Fallthrough
START_STATE -> ERROR_RECOVERY: "peek() [unknown] / advance(); emit_error()" {
  style: {
    stroke: red
  }
}

# Transition 4: Recovery Action
ERROR_RECOVERY -> START_STATE: "sync_complete / resume()" {
  style: {
    stroke: red
    stroke-dash: 5
  }
}

# Transition 5: Termination
START_STATE -> FINAL_NODE: "peek() [EOF] / emit_eof()"

# ILLEGAL TRANSITIONS (Safety Bounds)
START_STATE -> FINAL_NODE: "advance() [is_at_end]" {
  label: "ILLEGAL"
  style: {
    stroke: red
    stroke-dash: 5
  }
}

# ANNOTATIONS (Fixed 'near' to constant for ELK)
ANNOTATION_BLOCK: |md
  ## Milestone 1: Scanner Dispatch
  1. **Minimal Lookahead**: Single-character logic requires only `peek()`.
  2. **Atomic Dispatch**: Every START cycle completes one lexeme.
  3. **Panic Mode**: Recovery state handles malformed input without crashing.
| {
  near: top-right
}

# LEGEND (Fixed 'near' to constant for ELK)
LEGEND: {
  shape: package
  near: bottom-right
  label: "FSM Logic Legend"
  
  normal: "Valid Transition" {
    style.stroke-width: 1
  }
  heavy: "Token Production" {
    style.stroke-width: 3
  }
  recovery: "Panic Mode Path" {
    style: {
      stroke: red
      stroke-dash: 5
    }
  }
}