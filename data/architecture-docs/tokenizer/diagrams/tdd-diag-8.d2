direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# next_token() Control Flow â€” M1 Complete
# Source Input Example: "  +" (Two spaces followed by a Plus)

Step_1: {
  label: "1. CALL _skip_whitespace()"
  state: {
    shape: sql_table
    current: 0
    line: 1
    column: 1
    source: "\"  +\""
  }
  notes: |md
    Scanner enters method. 
    Cursor at index 0.
  |
}

Step_2: {
  label: "2. POST-WHITESPACE SKIP"
  state: {
    shape: sql_table
    current: "**2**" {style.font-color: red; style.bold: true}
    line: 1
    column: "**3**" {style.font-color: red; style.bold: true}
    source: "\"  +\""
  }
  notes: |md
    Whitespace consumed. 
    **Invariant**: Skip occurs **BEFORE** position capture.
  |
}

Step_3: {
  label: "3. POSITION CAPTURE"
  state: {
    shape: sql_table
    current: 2
    line: 1
    column: 3
    tok_line: "**1**" {style.font-color: red; style.bold: true}
    tok_col: "**3**" {style.font-color: red; style.bold: true}
  }
  notes: |md
    Local variables `tok_line` and `tok_col` 
    snapped from Scanner state.
  |
}

Step_4: {
  label: "4. CALL advance()"
  state: {
    shape: sql_table
    char: "**'+'**" {style.font-color: red; style.bold: true}
    current: "**3**" {style.font-color: red; style.bold: true}
    line: 1
    column: "**4**" {style.font-color: red; style.bold: true}
  }
  notes: |md
    Character '+' consumed. 
    Scanner column increments past the lexeme.
  |
}

Step_5: {
  label: "5. MATCH & RETURN"
  state: {
    shape: sql_table
    match: "char in SINGLE_CHAR_TOKENS"
    return: "**Token(PLUS, '+', 1, 3)**" {style.font-color: red; style.bold: true}
  }
  notes: |md
    Token emitted using **captured** positions (1:3),
    not the current scanner position (1:4).
  |
}

Step_1 -> Step_2: "_skip_whitespace()"
Step_2 -> Step_3: "capture locals"
Step_3 -> Step_4: "consume char"
Step_4 -> Step_5: "lookup & emit"

# Annotations
legend: {
  # ELK requires constant values for 'near'. Fixed from relative object reference.
  near: top-right
  info: |md
    ### Critical Order
    1. `_skip_whitespace()`
    2. `capture line/col`
    This ensures tokens don't point to leading spaces.
  |
  style.fill: "#fff2cc"
}