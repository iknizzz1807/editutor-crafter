direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# --- Participants ---
Scanner: "Scanner\n(Instance)" {
  shape: rectangle
  style: {
    fill: "#f8f9fa"
    stroke: "#343a40"
    stroke-width: 2
  }
}

InternalLogic: "Scanner._scan_token()\n(Logic Core)" {
  shape: rectangle
  style: {
    fill: "#e7f5ff"
    stroke: "#228be6"
  }
}

TokenStream: "list[Token]\n(Heap Accumulator)" {
  shape: rectangle
  style: {
    fill: "#f3f0ff"
    stroke: "#7950f2"
  }
}

# --- Interaction Sequence ---
# Loop Entry
Scanner -> Scanner: "scan_tokens() -> list[Token]"

# Iteration 1: Valid Token
Scanner -> InternalLogic: "1. _scan_token() -> Token(IDENTIFIER, 'x')" {
  style: {
    stroke: "#228be6"
    font-color: "#228be6"
    stroke-width: 2
  }
}
InternalLogic -> Scanner: "Return: Token object" {
  style.stroke: "#228be6"
}
Scanner -> TokenStream: "append(Token) -> void" {
  style: {
    stroke: "#228be6"
  }
}

# Iteration 2: Whitespace (Discard)
Scanner -> InternalLogic: "2. _scan_token() -> None" {
  style: {
    stroke: "#228be6"
    font-color: "#228be6"
  }
}
InternalLogic -> Scanner: "Return: None" {
  style.stroke: "#228be6"
}
Scanner -> Scanner: "Discard result (Whitespace)"

# Iteration 3: Error Token (Accumulate as value)
Scanner -> InternalLogic: "3. _scan_token() -> Token(ERROR, '@')" {
  style: {
    stroke: "#fa5252"
    font-color: "#fa5252"
    stroke-width: 2
  }
}
InternalLogic -> Scanner: "Return: Error Token object" {
  style.stroke: "#fa5252"
}
Scanner -> TokenStream: "append(ErrorToken) -> void" {
  style: {
    stroke: "#fa5252"
  }
}

# Final Termination
Scanner -> TokenStream: "4. append(Token(EOF, '')) -> void" {
  style: {
    stroke: "#228be6"
    stroke-width: 3
  }
}

Scanner -> Scanner: "return tokens (list pointer)"

# --- Documentation ---
# Fix: near changed from object reference to constant value for ELK compatibility
Annotation: |md
  ### Token Accumulation Logic
  - **Whitespace**: Returns `None`. Discarded by main loop to minimize parser noise.
  - **Error Recovery**: `ERROR` tokens are first-class values. They are appended to the stream to allow multi-error reporting in a single pass.
  - **Sentinel**: `EOF` is unconditionally appended after the loop to prevent downstream out-of-bounds access.
| {
  near: bottom-right
  style: {
    stroke: "#343a40"
    stroke-dash: 3
    fill: "#fff9db"
  }
}