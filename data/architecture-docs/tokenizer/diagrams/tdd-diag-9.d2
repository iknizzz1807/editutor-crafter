layout-engine: tala
vars: {
  d2-config: {
    theme-id: 0
  }
}

# 1. CHARACTER GRID DEFINITION
character_grid: {
  label: "Source Buffer Index Map"
  grid-columns: 3
  grid-gap: 20
  style.fill: "#E4DBFE" # Header Purple
  
  c0: "Index 0: '{'\n(1, 1)" { style.fill: "#B6DDF6" } # Data Blue
  c1: "Index 1: '\\n'\n(1, 1) -> (2, 1)" { style.fill: "#B6DDF6" }
  c2: "Index 2: '}'\n(2, 1)" { style.fill: "#B6DDF6" }
}

# 2. ALGORITHM STATE TRANSITIONS
execution_flow: {
  # --- STEP 0 ---
  step0: "0. Initial State" {
    scanner: {
      shape: sql_table
      style.fill: "#E4DBFE" # Header Purple
      current: 0
      line: 1
      column: 1
    }
    source_view: "Source: [ { | \\n | } ]"
    pointer: "▲" {
      style.font-color: "#F2994A" # Pointer Orange
      style.bold: true
      near: execution_flow.step0.source_view
    }
  }

  # --- STEP 1 ---
  step1: "1. After advance('{')" {
    scanner: {
      shape: sql_table
      style.fill: "#E4DBFE"
      current: 1
      line: 1
      column: 2
    }
    scanner.current.style: { font-color: red; bold: true }
    scanner.column.style: { font-color: red; bold: true }

    source_view: "Source: [ { | \\n | } ]"
    pointer: "    ▲" {
      style.font-color: "#F2994A"
      style.bold: true
      near: execution_flow.step1.source_view
    }
  }

  # --- STEP 2 ---
  step2: "2. After advance('\\n')" {
    scanner: {
      shape: sql_table
      style.fill: "#E4DBFE"
      current: 2
      line: 2
      column: 1
    }
    scanner.current.style: { font-color: red; bold: true }
    scanner.line.style: { font-color: red; bold: true }
    scanner.column.style: { font-color: red; bold: true }

    source_view: "Source: [ { | \\n | } ]"
    pointer: "        ▲" {
      style.font-color: "#F2994A"
      style.bold: true
      near: execution_flow.step2.source_view
    }
    annotation: "newline logic:\nline++\ncol=1" {
      style.stroke-dash: 3
    }
  }

  # --- STEP 3 ---
  step3: "3. Capture Start Position" {
    scanner: {
      shape: sql_table
      style.fill: "#E4DBFE"
      current: 2
      line: 2
      column: 1
    }
    captured: {
      label: "Captured Start"
      style.fill: "#B6DDF6" # Data Blue
      tok_line: 2
      tok_col: 1
    }
    captured.tok_line.style: { font-color: red; bold: true }
    captured.tok_col.style: { font-color: red; bold: true }

    source_view: "Source: [ { | \\n | } ]"
  }

  # --- STEP 4 ---
  step4: "4. After advance('}')" {
    scanner: {
      shape: sql_table
      style.fill: "#E4DBFE"
      current: 3
      line: 2
      column: 2
    }
    scanner.current.style: { font-color: red; bold: true }
    scanner.column.style: { font-color: red; bold: true }

    source_view: "Source: [ { | \\n | } ] EOF"
    pointer: "            ▲" {
      style.font-color: "#F2994A"
      style.bold: true
      near: execution_flow.step4.source_view
    }
  }

  # --- STEP 5 ---
  step5: "5. Final State: EOF" {
    scanner: {
      shape: sql_table
      style.fill: "#E4DBFE"
      current: 3
      line: 2
      column: 2
    }
    token_emitted: {
      label: "Token(RBRACE, '}', 2:1)"
      style.fill: "#ACE1AF" # Free/Success Green
      style.bold: true
    }
    eof_sentinel: "Token(EOF, '', 2:2)" {
      style.fill: "#DEE1EB" # Padding Gray
    }
  }

  step0 -> step1 -> step2 -> step3 -> step4 -> step5
}

# 3. STYLING & CONTEXT
execution_flow.**.style.border-radius: 8
execution_flow.**.source_view.style.font: mono
execution_flow.**.source_view.style.bold: true
character_grid.style.stroke-width: 2