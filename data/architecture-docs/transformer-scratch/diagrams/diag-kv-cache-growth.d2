vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

title: |md
  # KV Cache Growth Over Time
  **Each generation step appends new K,V vectors without recomputing history**
| {near: top-center}

legend: {
  near: bottom-center
  style.fill: transparent
  existing: Existing Cache (reused) {
    shape: rectangle
    style.fill: "#90EE90"
    style.stroke: "#228B22"
  }
  new: New Entry (computed) {
    shape: rectangle
    style.fill: "#FFD700"
    style.stroke: "#DAA520"
  }
}

step1: Step 1 {
  style.fill: "#E8F4E8"
  style.stroke: "#228B22"
  style.border-radius: 8
  
  cache_state_1: KV Cache {
    shape: rectangle
    style.fill: white
    
    k1: "K₁ [1, d_k]" {
      style.fill: "#FFD700"
      style.stroke: "#DAA520"
      style.stroke-width: 2
    }
    v1: "V₁ [1, d_k]" {
      style.fill: "#FFD700"
      style.stroke: "#DAA520"
      style.stroke-width: 2
    }
  }
  
  token1: "The" {
    shape: text
    style.font: mono
    style.font-size: 20
    style.bold: true
  }
  
  compute1: "Compute Q₁, K₁, V₁" {
    shape: rectangle
    style.fill: "#FFE4B5"
    style.stroke-dash: 3
  }
  
  note1: |md
    **Initial step:**
    - Process token "The"
    - Compute K₁, V₁ (single vector each)
    - Cache shape: `[1, d_k]`
  | {
    style.fill: transparent
    style.font-size: 14
  }
  
  token1 -> compute1: embed
  compute1 -> cache_state_1.k1
  compute1 -> cache_state_1.v1
}

step5: Step 5 {
  style.fill: "#E8F4E8"
  style.stroke: "#228B22"
  style.border-radius: 8
  
  cache_state_5: KV Cache {
    shape: rectangle
    style.fill: white
    
    k_group_5: "K₁₋₄ [4, d_k]\n(computed earlier)" {
      style.fill: "#90EE90"
      style.stroke: "#228B22"
      style.stroke-width: 2
    }
    k5: "K₅ [1, d_k]\n(new)" {
      style.fill: "#FFD700"
      style.stroke: "#DAA520"
      style.stroke-width: 2
    }
    v_group_5: "V₁₋₄ [4, d_k]\n(computed earlier)" {
      style.fill: "#90EE90"
      style.stroke: "#228B22"
      style.stroke-width: 2
    }
    v5: "V₅ [1, d_k]\n(new)" {
      style.fill: "#FFD700"
      style.stroke: "#DAA520"
      style.stroke-width: 2
    }
  }
  
  token5: "cat" {
    shape: text
    style.font: mono
    style.font-size: 20
    style.bold: true
  }
  
  compute5: "Compute Q₅, K₅, V₅ only" {
    shape: rectangle
    style.fill: "#FFE4B5"
    style.stroke-dash: 3
  }
  
  note5: |md
    **Step 5:**
    - Process token "cat"
    - K₁₋₄, V₁₋₄ **reused from cache**
    - Only compute K₅, V₅
    - Cache shape: `[5, d_k]`
  | {
    style.fill: transparent
    style.font-size: 14
  }
  
  token5 -> compute5: embed
  compute5 -> cache_state_5.k5
  compute5 -> cache_state_5.v5
}

step10: Step 10 {
  style.fill: "#E8F4E8"
  style.stroke: "#228B22"
  style.border-radius: 8
  
  cache_state_10: KV Cache {
    shape: rectangle
    style.fill: white
    
    k_group_10: "K₁₋₉ [9, d_k]\n(all prior steps)" {
      style.fill: "#90EE90"
      style.stroke: "#228B22"
      style.stroke-width: 2
    }
    k10: "K₁₀ [1, d_k]\n(new)" {
      style.fill: "#FFD700"
      style.stroke: "#DAA520"
      style.stroke-width: 2
    }
    v_group_10: "V₁₋₉ [9, d_k]\n(all prior steps)" {
      style.fill: "#90EE90"
      style.stroke: "#228B22"
      style.stroke-width: 2
    }
    v10: "V₁₀ [1, d_k]\n(new)" {
      style.fill: "#FFD700"
      style.stroke: "#DAA520"
      style.stroke-width: 2
    }
  }
  
  token10: "tree" {
    shape: text
    style.font: mono
    style.font-size: 20
    style.bold: true
  }
  
  compute10: "Compute Q₁₀, K₁₀, V₁₀ only" {
    shape: rectangle
    style.fill: "#FFE4B5"
    style.stroke-dash: 3
  }
  
  note10: |md
    **Step 10:**
    - Process token "tree"
    - K₁₋₉, V₁₋₉ **reused from cache**
    - Only compute K₁₀, V₁₀
    - Cache shape: `[10, d_k]`
  | {
    style.fill: transparent
    style.font-size: 14
  }
  
  token10 -> compute10: embed
  compute10 -> cache_state_10.k10
  compute10 -> cache_state_10.v10
}

step1 -> step5: "Generate →" {
  style.stroke: "#228B22"
  style.stroke-width: 2
  style.font-color: "#228B22"
  style.bold: true
}

step5 -> step10: "Generate →" {
  style.stroke: "#228B22"
  style.stroke-width: 2
  style.font-color: "#228B22"
  style.bold: true
}

sequence_label: |md
  ### Generated Sequence:
  `"The" → "quick" → "brown" → "fox" → "cat" → ... → "tree"`
| {
  near: top-center
  style.fill: transparent
  style.font: mono
}

complexity_comparison: {
  near: bottom-right
  style.fill: "#FFF8DC"
  style.stroke: "#DAA520"
  style.border-radius: 8
  
  without_cache: Without KV Cache {
    shape: rectangle
    style.fill: "#FFB6C1"
    style.stroke: "#DC143C"
    
    content: |md
      **At step 10:**
      Recompute K₁₋₁₀, V₁₋₁₀
      = **10× more work**
      = O(n²) total
    |
  }
  
  with_cache: With KV Cache {
    shape: rectangle
    style.fill: "#90EE90"
    style.stroke: "#228B22"
    
    content: |md
      **At step 10:**
      Compute K₁₀, V₁₀ only
      = **constant work**
      = O(n) total
    |
  }
  
  without_cache <-> with_cache: "9× fewer\nK,V computations\nat step 10" {
    style.stroke: "#4169E1"
    style.bold: true
    style.font-color: "#4169E1"
  }
}