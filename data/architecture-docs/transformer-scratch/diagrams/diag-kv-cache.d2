vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # KV Cache for Efficient Generation
  **From O(n²) to O(n) Complexity**
| {near: top-center}

direction: right

naive: Naive Generation {
  style.fill: "#FFE4E4"
  style.stroke: "#CC0000"
  
  desc: |md
    **Without KV Cache**
    - Recomputes K,V for ALL positions
    - At each generation step
    - Complexity: O(n²)
  | {shape: text}
  
  step1: {
    label: "Step 1"
    style.fill: "#FFB3B3"
    tokens: "The cat sat" {style.stroke: "#666"}
    kv: "K₁,V₁" {style.font-size: 12}
  }
  
  step2: {
    label: "Step 2"
    style.fill: "#FFB3B3"
    tokens: "The cat sat on" {style.stroke: "#666"}
    kv: "K₁,V₁ K₂,V₂" {style.font-size: 12}
    note: "Recompute ALL" {style.fill: "#FF9999"; style.font-color: "#8B0000"}
  }
  
  step3: {
    label: "Step 3"
    style.fill: "#FFB3B3"
    tokens: "The cat sat on the" {style.stroke: "#666"}
    kv: "K₁,V₁ ... K₃,V₃" {style.font-size: 12}
    note: "Recompute ALL" {style.fill: "#FF9999"; style.font-color: "#8B0000"}
  }
  
  complexity: "Total: O(n²) attention computations" {
    style.fill: "#FFCCCC"
    style.stroke: "#8B0000"
    style.bold: true
  }
}

cached: KV Cache Generation {
  style.fill: "#E4FFE4"
  style.stroke: "#006600"
  
  desc: |md
    **With KV Cache**
    - Stores previous K,V in cache
    - Only computes K,V for NEW token
    - Complexity: O(n)
  | {shape: text}
  
  cache_layout: "Memory Layout [batch, heads, seq_so_far, d_k]" {
    style.fill: "#CCFFCC"
    style.stroke: "#006600"
    
    header_batch: "batch" {style.fill: "#90EE90"; style.bold: true}
    header_heads: "heads" {style.fill: "#90EE90"; style.bold: true}
    header_seq: "seq" {style.fill: "#90EE90"; style.bold: true}
    header_dk: "d_k" {style.fill: "#90EE90"; style.bold: true}
    
    b0: "0" {style.fill: "#E0FFE0"}
    h0: "0..H" {style.fill: "#E0FFE0"}
    s0: "0..S" {style.fill: "#E0FFE0"}
    d64: "64" {style.fill: "#E0FFE0"}
  }
  
  cache_ops: Cache Operations {
    style.fill: "#CCFFCC"
    
    append: "cache.k = cat([cache.k, new_k], dim=2)" {
      style.font: mono
      style.fill: "#AAFFAA"
    }
    concat: "cache.v = cat([cache.v, new_v], dim=2)" {
      style.font: mono
      style.fill: "#AAFFAA"
    }
  }
  
  efficiency: "Total: O(n) attention computations" {
    style.fill: "#AAFFAA"
    style.stroke: "#006600"
    style.bold: true
  }
}

naive -> cached: "Optimization" {
  style.stroke: "#4169E1"
  style.stroke-width: 3
  style.stroke-dash: 5
  style.animated: true
}

comparison: Complexity Comparison {
  style.fill: "#F5F5F5"
  
  label_naive: "Naive:" {style.fill: "#FFE4E4"}
  value_naive: "O(n²) → n×(n+1)/2 ops" {style.fill: "#FFE4E4"; style.font: mono}
  
  label_cached: "Cached:" {style.fill: "#E4FFE4"}
  value_cached: "O(n) → n ops" {style.fill: "#E4FFE4"; style.font: mono}
}

sequence_example: "Sequence Length n=5 Example" {
  style.fill: "#E8E8E8"
  
  pos0: "pos 0" {style.fill: "#D3D3D3"; style.bold: true}
  pos1: "pos 1" {style.fill: "#D3D3D3"; style.bold: true}
  pos2: "pos 2" {style.fill: "#D3D3D3"; style.bold: true}
  pos3: "pos 3" {style.fill: "#D3D3D3"; style.bold: true}
  pos4: "pos 4" {style.fill: "#D3D3D3"; style.bold: true}
  pos5: "total" {style.fill: "#A9A9A9"; style.bold: true}
  
  n1: "The" {style.fill: "#ADD8E6"}
  n2: "cat" {style.fill: "#ADD8E6"}
  n3: "sat" {style.fill: "#ADD8E6"}
  n4: "on" {style.fill: "#ADD8E6"}
  n5: "the" {style.fill: "#ADD8E6"}
  n_total: "15 ops" {style.fill: "#FFCCCC"; style.bold: true}
  
  c1: "K₁,V₁" {style.fill: "#90EE90"}
  c2: "K₂,V₂" {style.fill: "#90EE90"}
  c3: "K₃,V₃" {style.fill: "#90EE90"}
  c4: "K₄,V₄" {style.fill: "#90EE90"}
  c5: "K₅,V₅" {style.fill: "#90EE90"}
  c_total: "5 ops" {style.fill: "#AAFFAA"; style.bold: true}
}

legend: {
  near: bottom-center
  style.fill: transparent
  
  red_box: "Red = O(n²) recomputation" {
    style.fill: "#FFE4E4"
    style.stroke: "#CC0000"
  }
  green_box: "Green = O(n) incremental" {
    style.fill: "#E4FFE4"
    style.stroke: "#006600"
  }
}