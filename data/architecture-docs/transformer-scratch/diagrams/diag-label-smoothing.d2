vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
  colors: {
    red: "#E63946"
    green: "#2A9D8F"
    yellow: "#E9C46A"
    blue: "#457B9D"
    gray: "#6C757D"
  }
}

title: |md
  # Label Smoothing Effect
  ## Regularization Through Soft Target Distribution
| {near: top-center}

direction: right

before_container: {
  label: "BEFORE\nHard Labels (One-Hot)"
  style: {
    fill: "#F8EDEB"
    stroke: ${colors.red}
    stroke-width: 3
    border-radius: 8
  }
  
  hard_labels: {
    label: "Target Distribution"
    shape: class
    class_0: "+ Class 0: 0.000"
    class_1: "+ Class 1: 1.000"
    class_2: "+ Class 2: 0.000"
    style.fill: "#FAD2CF"
    style.stroke: ${colors.red}
  }
  
  vector_before: {
    shape: sql_table
    label: "One-Hot Vector"
    idx_0: "0" {constraint: ""}
    idx_1: "1" {constraint: "← Target"}
    idx_2: "0" {constraint: ""}
    style.fill: "#FAD2CF"
  }
  
  prob_before: {
    label: "Model Confidence"
    shape: class
    p0: "P(y=0): 0.01"
    p1: "P(y=1): 0.98" 
    p2: "P(y=2): 0.01"
    style.fill: ${colors.red}
    style.font-color: white
    style.stroke: ${colors.red}
  }
  
  hard_labels -> vector_before: "Encoded as"
  vector_before -> prob_before: "Model learns\noverconfident"
}

arrow: {
  shape: text
  label: "→"
  style: {
    font-size: 48
    bold: true
    fill: ${colors.blue}
  }
}

after_container: {
  label: "AFTER\nSoft Labels (Smoothed)"
  style: {
    fill: "#E8F5E9"
    stroke: ${colors.green}
    stroke-width: 3
    border-radius: 8
  }
  
  soft_labels: {
    label: "Target Distribution"
    shape: class
    class_0: "+ Class 0: ε/K"
    class_1: "+ Class 1: 1-ε+ε/K"
    class_2: "+ Class 2: ε/K"
    style.fill: "#C8E6C9"
    style.stroke: ${colors.green}
  }
  
  vector_after: {
    shape: sql_table
    label: "Smoothed Vector"
    idx_0: "0.033" {constraint: "ε/K"}
    idx_1: "0.933" {constraint: "1-ε+ε/K"}
    idx_2: "0.033" {constraint: "ε/K"}
    style.fill: "#C8E6C9"
  }
  
  prob_after: {
    label: "Model Confidence"
    shape: class
    p0: "P(y=0): 0.05"
    p1: "P(y=1): 0.72"
    p2: "P(y=2): 0.23"
    style.fill: ${colors.green}
    style.font-color: white
    style.stroke: ${colors.green}
  }
  
  soft_labels -> vector_after: "Encoded as"
  vector_after -> prob_after: "Model learns\ncalibrated"
}

before_container -> arrow -> after_container: "Label Smoothing\n(ε=0.1, K=3)"

formula_box: {
  near: bottom-center
  label: |md
    **Smoothing Formula:**
    
    `y_smooth = y_hard × (1 - ε) + ε / K`
    
    Where:
    - `ε` = smoothing factor (typically 0.1)
    - `K` = number of classes
    - Target class gets `1 - ε + ε/K`
    - Non-target classes get `ε/K` each
  |
  shape: rectangle
  style: {
    fill: "#FFF9C4"
    stroke: ${colors.yellow}
    stroke-width: 2
    border-radius: 6
    font: mono
  }
}

benefits: {
  near: center-left
  label: |md
    **Why This Helps:**
    
    ✓ Prevents overconfident predictions
    ✓ Improves model calibration
    ✓ Acts as regularizer
    ✓ Better uncertainty estimates
    ✓ Reduces overfitting to noisy labels
  |
  shape: rectangle
  style: {
    fill: "#E3F2FD"
    stroke: ${colors.blue}
    stroke-width: 2
    border-radius: 6
  }
}

calibration_chart: {
  near: center-right
  direction: right
  
  overconfident: {
    label: "Overconfident\n(Hard Labels)"
    shape: rectangle
    style.fill: ${colors.red}
    style.font-color: white
    style.border-radius: 4
    width: 120
    height: 180
  }
  
  calibrated: {
    label: "Calibrated\n(Smoothed)"
    shape: rectangle
    style.fill: ${colors.green}
    style.font-color: white
    style.border-radius: 4
    width: 120
    height: 120
  }
  
  overconfident -> calibrated: "Better\nuncertainty"
}

legend: {
  near: bottom-right
  style.fill: transparent
  ε_note: "ε = 0.1 (smoothing factor)"
  K_note: "K = 3 (number of classes)"
}