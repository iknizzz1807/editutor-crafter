vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Residual Connections as Gradient Highways
  ## Why Skip Connections Prevent Gradient Vanishing in Deep Transformers
| {near: top-center}

direction: right

legend: {
  near: top-right
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a6a"
  style.border-radius: 8
  
  legend_title: "Legend" {
    style.font-color: white
    style.bold: true
  }
  
  healthy_grad: "Healthy gradient (|‚àÇL/‚àÇx| > 0.1)" {
    style.fill: "#00d26a"
    style.stroke: "#00d26a"
    shape: rectangle
    width: 120
  }
  
  weak_grad: "Weak gradient (|‚àÇL/‚àÇx| > 0.01)" {
    style.fill: "#ffd93d"
    style.stroke: "#ffd93d"
    shape: rectangle
    width: 120
  }
  
  vanishing_grad: "Vanishing gradient (|‚àÇL/‚àÇx| < 0.001)" {
    style.fill: "#6c757d"
    style.stroke: "#6c757d"
    shape: rectangle
    width: 120
  }
  
  gradient_flow: "‚Üí Gradient magnitude" {
    style.fill: transparent
    style.font-color: white
  }
}

without_residual: WITHOUT Residual Connections {
  style.fill: "#2d132c"
  style.stroke: "#c44569"
  style.border-radius: 12
  style.stroke-width: 3
  
  label_without: "Gradients VANISH by layer 3\nEach layer multiplies gradient by ~0.1" {
    shape: text
    style.font-color: "#ff6b6b"
    style.font-size: 14
  }
  
  loss_source_without: "Loss L" {
    style.fill: "#ff6b6b"
    style.stroke: "#ff6b6b"
    style.font-color: white
    shape: rectangle
    width: 80
  }
  
  layer6_without: "Layer 6\n|‚àÇL/‚àÇx| = 1.0" {
    style.fill: "#00d26a"
    style.font-color: white
    shape: rectangle
  }
  
  layer5_without: "Layer 5\n|‚àÇL/‚àÇx| = 0.1" {
    style.fill: "#ffd93d"
    style.font-color: black
    shape: rectangle
  }
  
  layer4_without: "Layer 4\n|‚àÇL/‚àÇx| = 0.01" {
    style.fill: "#ffd93d"
    style.font-color: black
    shape: rectangle
  }
  
  layer3_without: "Layer 3\n|‚àÇL/‚àÇx| = 0.001" {
    style.fill: "#6c757d"
    style.font-color: white
    shape: rectangle
  }
  
  layer2_without: "Layer 2\n|‚àÇL/‚àÇx| = 0.0001" {
    style.fill: "#6c757d"
    style.font-color: white
    shape: rectangle
  }
  
  layer1_without: "Layer 1\n|‚àÇL/‚àÇx| ‚âà 0" {
    style.fill: "#3d3d3d"
    style.font-color: "#888"
    style.stroke: "#444"
    shape: rectangle
  }
  
  input_without: "Input x‚ÇÄ" {
    style.fill: "#4a4a6a"
    style.font-color: white
    shape: rectangle
    width: 80
  }
  
  loss_source_without -> layer6_without: "‚àÇL/‚àÇL = 1.0" {
    style.stroke: "#00d26a"
    style.stroke-width: 4
  }
  
  layer6_without -> layer5_without: "√ó0.1" {
    style.stroke: "#ffd93d"
    style.stroke-width: 3
  }
  
  layer5_without -> layer4_without: "√ó0.1" {
    style.stroke: "#ffd93d"
    style.stroke-width: 2
  }
  
  layer4_without -> layer3_without: "√ó0.1" {
    style.stroke: "#6c757d"
    style.stroke-width: 1
    style.stroke-dash: 3
  }
  
  layer3_without -> layer2_without: "√ó0.1" {
    style.stroke: "#6c757d"
    style.stroke-width: 1
    style.stroke-dash: 3
  }
  
  layer2_without -> layer1_without: "√ó0.1" {
    style.stroke: "#444"
    style.stroke-width: 1
    style.stroke-dash: 5
  }
  
  layer1_without -> input_without: "‚âà0" {
    style.stroke: "#333"
    style.stroke-width: 1
    style.stroke-dash: 5
  }
  
  chain_rule: |md
    **Chain Rule:**
    
    ‚àÇL/‚àÇx‚ÇÅ = ‚àÇL/‚àÇx‚ÇÜ ¬∑ ‚àÇx‚ÇÜ/‚àÇx‚ÇÖ ¬∑ ‚àÇx‚ÇÖ/‚àÇx‚ÇÑ ¬∑ ‚àÇx‚ÇÑ/‚àÇx‚ÇÉ ¬∑ ‚àÇx‚ÇÉ/‚àÇx‚ÇÇ ¬∑ ‚àÇx‚ÇÇ/‚àÇx‚ÇÅ
           = 1.0 √ó 0.1 √ó 0.1 √ó 0.1 √ó 0.1 √ó 0.1
           = 0.00001
    
    **Result: Layer 1 learns almost nothing!**
  | {
    shape: rectangle
    style.fill: "#1a1a2e"
    style.font-color: white
    style.stroke: "#c44569"
    width: 280
  }
}

with_residual: WITH Residual Connections {
  style.fill: "#0d2818"
  style.stroke: "#00d26a"
  style.border-radius: 12
  style.stroke-width: 3
  
  label_with: "Gradients FLOW to all layers\nAddition passes gradient through unchanged" {
    shape: text
    style.font-color: "#00d26a"
    style.font-size: 14
  }
  
  loss_source_with: "Loss L" {
    style.fill: "#ff6b6b"
    style.stroke: "#ff6b6b"
    style.font-color: white
    shape: rectangle
    width: 80
  }
  
  layer6_with: "Layer 6\n|‚àÇL/‚àÇx| = 1.0" {
    style.fill: "#00d26a"
    style.font-color: white
    shape: rectangle
  }
  
  add6: "+" {
    shape: circle
    style.fill: "#00d26a"
    style.font-color: white
    style.font-size: 20
    width: 30
  }
  
  layer5_with: "Layer 5\n|‚àÇL/‚àÇx| = 1.0" {
    style.fill: "#00d26a"
    style.font-color: white
    shape: rectangle
  }
  
  add5: "+" {
    shape: circle
    style.fill: "#00d26a"
    style.font-color: white
    style.font-size: 20
    width: 30
  }
  
  layer4_with: "Layer 4\n|‚àÇL/‚àÇx| = 1.0" {
    style.fill: "#00d26a"
    style.font-color: white
    shape: rectangle
  }
  
  add4: "+" {
    shape: circle
    style.fill: "#00d26a"
    style.font-color: white
    style.font-size: 20
    width: 30
  }
  
  layer3_with: "Layer 3\n|‚àÇL/‚àÇx| = 1.0" {
    style.fill: "#00d26a"
    style.font-color: white
    shape: rectangle
  }
  
  add3: "+" {
    shape: circle
    style.fill: "#00d26a"
    style.font-color: white
    style.font-size: 20
    width: 30
  }
  
  layer2_with: "Layer 2\n|‚àÇL/‚àÇx| = 1.0" {
    style.fill: "#00d26a"
    style.font-color: white
    shape: rectangle
  }
  
  add2: "+" {
    shape: circle
    style.fill: "#00d26a"
    style.font-color: white
    style.font-size: 20
    width: 30
  }
  
  layer1_with: "Layer 1\n|‚àÇL/‚àÇx| = 1.0" {
    style.fill: "#00d26a"
    style.font-color: white
    shape: rectangle
  }
  
  add1: "+" {
    shape: circle
    style.fill: "#00d26a"
    style.font-color: white
    style.font-size: 20
    width: 30
  }
  
  input_with: "Input x‚ÇÄ\n|‚àÇL/‚àÇx‚ÇÄ| = 1.0" {
    style.fill: "#00d26a"
    style.font-color: white
    shape: rectangle
    width: 80
  }
  
  loss_source_with -> layer6_with: "‚àÇL/‚àÇL = 1.0" {
    style.stroke: "#00d26a"
    style.stroke-width: 4
  }
  
  layer6_with -> add6: {
    style.stroke: "#00d26a"
    style.stroke-width: 3
  }
  add6 -> layer5_with: {
    style.stroke: "#00d26a"
    style.stroke-width: 4
  }
  
  layer5_with -> add5: {
    style.stroke: "#00d26a"
    style.stroke-width: 3
  }
  add5 -> layer4_with: {
    style.stroke: "#00d26a"
    style.stroke-width: 4
  }
  
  layer4_with -> add4: {
    style.stroke: "#00d26a"
    style.stroke-width: 3
  }
  add4 -> layer3_with: {
    style.stroke: "#00d26a"
    style.stroke-width: 4
  }
  
  layer3_with -> add3: {
    style.stroke: "#00d26a"
    style.stroke-width: 3
  }
  add3 -> layer2_with: {
    style.stroke: "#00d26a"
    style.stroke-width: 4
  }
  
  layer2_with -> add2: {
    style.stroke: "#00d26a"
    style.stroke-width: 3
  }
  add2 -> layer1_with: {
    style.stroke: "#00d26a"
    style.stroke-width: 4
  }
  
  layer1_with -> add1: {
    style.stroke: "#00d26a"
    style.stroke-width: 3
  }
  add1 -> input_with: {
    style.stroke: "#00d26a"
    style.stroke-width: 4
  }
  
  skip6: "" {
    style.opacity: 0
    width: 10
  }
  skip5: "" {
    style.opacity: 0
    width: 10
  }
  skip4: "" {
    style.opacity: 0
    width: 10
  }
  skip3: "" {
    style.opacity: 0
    width: 10
  }
  skip2: "" {
    style.opacity: 0
    width: 10
  }
  
  residual_math: |md
    **Residual Block:**
    
    x‚Çó‚Çä‚ÇÅ = x‚Çó + F(x‚Çó)  where F is attention + FFN
    
    **Gradient Flow:**
    
    ‚àÇL/‚àÇx‚Çó = ‚àÇL/‚àÇx‚Çó‚Çä‚ÇÅ ¬∑ (1 + ‚àÇF/‚àÇx‚Çó)
           ‚âà ‚àÇL/‚àÇx‚Çó‚Çä‚ÇÅ ¬∑ 1  (the +1 is the highway!)
    
    **Result: ‚àÇL/‚àÇx‚ÇÅ ‚âà ‚àÇL/‚àÇx‚ÇÜ ‚âà 1.0 ‚Äî all layers learn!**
  | {
    shape: rectangle
    style.fill: "#0d2818"
    style.font-color: white
    style.stroke: "#00d26a"
    width: 300
  }
}

resnet_connection: |md
  ## üîó The ResNet Connection (He et al., 2015)
  
  Residual connections were first introduced for **computer vision** networks.
  The same insight applies to transformers:
  
  - **Without skip**: Deep networks are harder to train than shallow ones
  - **With skip**: Deep networks can match shallow network performance + learn residual
  
  The "highway" allows gradients to bypass vanishing-prone layers entirely.
  Each layer learns a *residual* correction to the identity function.
| {
  near: bottom-center
  style.fill: "#1e3a5f"
  style.stroke: "#4a90d9"
  style.border-radius: 8
  style.font-color: white
  width: 500
}

gradient_comparison: {
  direction: right
  
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a6a"
  style.border-radius: 8
  
  comp_title: "Gradient Magnitude by Layer" {
    style.font-color: white
    style.bold: true
  }
  
  table: ||md
    | Layer | Without Residual | With Residual |
    |-------|-------------------|---------------|
    | 6     | 1.0               | 1.0           |
    | 5     | 0.1               | 1.0           |
    | 4     | 0.01              | 1.0           |
    | 3     | 0.001             | 1.0           |
    | 2     | 0.0001            | 1.0           |
    | 1     | ~0                | 1.0           |
    | **Input** | **~0**        | **1.0**       |
  ||
}

back_to_map: "‚Üê Back to Transformer Map" {
  near: bottom-left
  link: "#transformer-satellite"
  style.fill: "#2a2a4a"
  style.stroke: "#6a6a9a"
  style.font-color: white
  style.border-radius: 4
}