vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Sinusoidal Positional Encoding
  ## PE(pos, 2i) = sin(pos/10000^(2i/d_model))
  ## PE(pos, 2i+1) = cos(pos/10000^(2i/d_model))
| {near: top-center}

direction: right

encoding_matrix: "Positional Encoding Matrix [seq_len × d_model]" {
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a6a"
  style.border-radius: 8
  
  grid-columns: 9
  grid-gap: 0
  
  header_row: {
    grid-columns: 9
    grid-gap: 0
    dim0: "dim 0\n(sin)" {
      style.fill: "#2d4a3e"
      style.font-color: "#7fdbca"
      style.stroke: "#3d6a5e"
    }
    dim1: "dim 1\n(cos)" {
      style.fill: "#2d4a3e"
      style.font-color: "#7fdbca"
      style.stroke: "#3d6a5e"
    }
    dim2: "dim 2\n(sin)" {
      style.fill: "#2d4a3e"
      style.font-color: "#7fdbca"
      style.stroke: "#3d6a5e"
    }
    dim3: "dim 3\n(cos)" {
      style.fill: "#2d4a3e"
      style.font-color: "#7fdbca"
      style.stroke: "#3d6a5e"
    }
    dim4: "dim 4\n(sin)" {
      style.fill: "#2d4a3e"
      style.font-color: "#7fdbca"
      style.stroke: "#3d6a5e"
    }
    dim5: "dim 5\n(cos)" {
      style.fill: "#2d4a3e"
      style.font-color: "#7fdbca"
      style.stroke: "#3d6a5e"
    }
    dim6: "..."
    dim7: "dim d-2\n(sin)" {
      style.fill: "#2d4a3e"
      style.font-color: "#7fdbca"
      style.stroke: "#3d6a5e"
    }
    dim8: "dim d-1\n(cos)" {
      style.fill: "#2d4a3e"
      style.font-color: "#7fdbca"
      style.stroke: "#3d6a5e"
    }
  }
  
  pos0: "pos 0" {
    style.fill: "#16213e"
    style.font-color: "#e94560"
    style.stroke: "#4a4a6a"
  }
  pos0_val0: "0.0" {
    style.fill: "#0f3460"
    style.font-color: "#e94560"
    style.stroke: "#4a4a6a"
  }
  pos0_val1: "1.0" {
    style.fill: "#0f3460"
    style.font-color: "#e94560"
    style.stroke: "#4a4a6a"
  }
  pos0_val2: "0.0" {
    style.fill: "#0f3460"
    style.font-color: "#e94560"
    style.stroke: "#4a4a6a"
  }
  pos0_val3: "1.0" {
    style.fill: "#0f3460"
    style.font-color: "#e94560"
    style.stroke: "#4a4a6a"
  }
  pos0_val4: "0.0" {
    style.fill: "#0f3460"
    style.font-color: "#e94560"
    style.stroke: "#4a4a6a"
  }
  pos0_val5: "1.0" {
    style.fill: "#0f3460"
    style.font-color: "#e94560"
    style.stroke: "#4a4a6a"
  }
  pos0_ellipsis: "..." {
    style.fill: "#16213e"
    style.font-color: "#e94560"
    style.stroke: "#4a4a6a"
  }
  pos0_valn2: "~0" {
    style.fill: "#0f3460"
    style.font-color: "#e94560"
    style.stroke: "#4a4a6a"
  }
  pos0_valn1: "~1" {
    style.fill: "#0f3460"
    style.font-color: "#e94560"
    style.stroke: "#4a4a6a"
  }
  
  pos1: "pos 1" {
    style.fill: "#16213e"
    style.font-color: "#f39c12"
    style.stroke: "#4a4a6a"
  }
  pos1_val0: "0.84" {
    style.fill: "#0f3460"
    style.font-color: "#f39c12"
    style.stroke: "#4a4a6a"
  }
  pos1_val1: "0.54" {
    style.fill: "#0f3460"
    style.font-color: "#f39c12"
    style.stroke: "#4a4a6a"
  }
  pos1_val2: "0.01" {
    style.fill: "#0f3460"
    style.font-color: "#f39c12"
    style.stroke: "#4a4a6a"
  }
  pos1_val3: "1.0" {
    style.fill: "#0f3460"
    style.font-color: "#f39c12"
    style.stroke: "#4a4a6a"
  }
  pos1_val4: "~0" {
    style.fill: "#0f3460"
    style.font-color: "#f39c12"
    style.stroke: "#4a4a6a"
  }
  pos1_val5: "~1" {
    style.fill: "#0f3460"
    style.font-color: "#f39c12"
    style.stroke: "#4a4a6a"
  }
  pos1_ellipsis: "..." {
    style.fill: "#16213e"
    style.font-color: "#f39c12"
    style.stroke: "#4a4a6a"
  }
  pos1_valn2: "~0" {
    style.fill: "#0f3460"
    style.font-color: "#f39c12"
    style.stroke: "#4a4a6a"
  }
  pos1_valn1: "~1" {
    style.fill: "#0f3460"
    style.font-color: "#f39c12"
    style.stroke: "#4a4a6a"
  }
  
  pos2: "pos 2" {
    style.fill: "#16213e"
    style.font-color: "#3498db"
    style.stroke: "#4a4a6a"
  }
  pos2_val0: "0.91" {
    style.fill: "#0f3460"
    style.font-color: "#3498db"
    style.stroke: "#4a4a6a"
  }
  pos2_val1: "-0.42" {
    style.fill: "#0f3460"
    style.font-color: "#3498db"
    style.stroke: "#4a4a6a"
  }
  pos2_val2: "0.02" {
    style.fill: "#0f3460"
    style.font-color: "#3498db"
    style.stroke: "#4a4a6a"
  }
  pos2_val3: "1.0" {
    style.fill: "#0f3460"
    style.font-color: "#3498db"
    style.stroke: "#4a4a6a"
  }
  pos2_val4: "~0" {
    style.fill: "#0f3460"
    style.font-color: "#3498db"
    style.stroke: "#4a4a6a"
  }
  pos2_val5: "~1" {
    style.fill: "#0f3460"
    style.font-color: "#3498db"
    style.stroke: "#4a4a6a"
  }
  pos2_ellipsis: "..." {
    style.fill: "#16213e"
    style.font-color: "#3498db"
    style.stroke: "#4a4a6a"
  }
  pos2_valn2: "~0" {
    style.fill: "#0f3460"
    style.font-color: "#3498db"
    style.stroke: "#4a4a6a"
  }
  pos2_valn1: "~1" {
    style.fill: "#0f3460"
    style.font-color: "#3498db"
    style.stroke: "#4a4a6a"
  }
  
  pos_ellipsis: "..." {
    style.fill: "#16213e"
    style.font-color: "#888"
    style.stroke: "#4a4a6a"
  }
  ellipsis_row: "..." {
    style.fill: "#16213e"
    style.font-color: "#888"
    style.stroke: "#4a4a6a"
  }
  ellipsis_row2: "..." {
    style.fill: "#16213e"
    style.font-color: "#888"
    style.stroke: "#4a4a6a"
  }
  ellipsis_row3: "..." {
    style.fill: "#16213e"
    style.font-color: "#888"
    style.stroke: "#4a4a6a"
  }
  ellipsis_row4: "..." {
    style.fill: "#16213e"
    style.font-color: "#888"
    style.stroke: "#4a4a6a"
  }
  ellipsis_row5: "..." {
    style.fill: "#16213e"
    style.font-color: "#888"
    style.stroke: "#4a4a6a"
  }
  ellipsis_row6: "..." {
    style.fill: "#16213e"
    style.font-color: "#888"
    style.stroke: "#4a4a6a"
  }
  ellipsis_row7: "..." {
    style.fill: "#16213e"
    style.font-color: "#888"
    style.stroke: "#4a4a6a"
  }
  ellipsis_row8: "..." {
    style.fill: "#16213e"
    style.font-color: "#888"
    style.stroke: "#4a4a6a"
  }
  ellipsis_row9: "..." {
    style.fill: "#16213e"
    style.font-color: "#888"
    style.stroke: "#4a4a6a"
  }
  
  posn: "pos n" {
    style.fill: "#16213e"
    style.font-color: "#9b59b6"
    style.stroke: "#4a4a6a"
  }
  posn_val0: "~sin(n)" {
    style.fill: "#0f3460"
    style.font-color: "#9b59b6"
    style.stroke: "#4a4a6a"
  }
  posn_val1: "~cos(n)" {
    style.fill: "#0f3460"
    style.font-color: "#9b59b6"
    style.stroke: "#4a4a6a"
  }
  posn_val2: "~sin(n)" {
    style.fill: "#0f3460"
    style.font-color: "#9b59b6"
    style.stroke: "#4a4a6a"
  }
  posn_val3: "~cos(n)" {
    style.fill: "#0f3460"
    style.font-color: "#9b59b6"
    style.stroke: "#4a4a6a"
  }
  posn_val4: "~sin(n)" {
    style.fill: "#0f3460"
    style.font-color: "#9b59b6"
    style.stroke: "#4a4a6a"
  }
  posn_val5: "~cos(n)" {
    style.fill: "#0f3460"
    style.font-color: "#9b59b6"
    style.stroke: "#4a4a6a"
  }
  posn_ellipsis: "..." {
    style.fill: "#16213e"
    style.font-color: "#9b59b6"
    style.stroke: "#4a4a6a"
  }
  posn_valn2: "~sin(n)" {
    style.fill: "#0f3460"
    style.font-color: "#9b59b6"
    style.stroke: "#4a4a6a"
  }
  posn_valn1: "~cos(n)" {
    style.fill: "#0f3460"
    style.font-color: "#9b59b6"
    style.stroke: "#4a4a6a"
  }
}

frequency_panel: "Frequency Spectrum" {
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a6a"
  style.border-radius: 8
  direction: down
  
  freq_label: |md
    **Wavelength increases →**
    **Frequency decreases →**
  | {
    style.font-color: "#7fdbca"
    style.fill: transparent
  }
  
  low_freq: "Low Frequency (dims 0-2)" {
    style.fill: "#2d4a3e"
    style.stroke: "#3d6a5e"
    style.font-color: "#7fdbca"
    
    desc: |md
      - Period: ~1 position
      - Captures local patterns
      - λ = 2π × 10000^(0/d) = 2π
    | {
      style.font-color: "#aaa"
      style.fill: transparent
    }
  }
  
  mid_freq: "Medium Frequency (dims ~d/4)" {
    style.fill: "#3d4a5e"
    style.stroke: "#4d6a7e"
    style.font-color: "#7fdbca"
    
    desc: |md
      - Period: ~100 positions
      - Captures medium-range deps
      - λ = 2π × 10000^(0.5) ≈ 200
    | {
      style.font-color: "#aaa"
      style.fill: transparent
    }
  }
  
  high_freq: "High Frequency (dims d-2, d-1)" {
    style.fill: "#4d3a4e"
    style.stroke: "#6d5a6e"
    style.font-color: "#7fdbca"
    
    desc: |md
      - Period: ~10000 positions
      - Captures global structure
      - λ = 2π × 10000 ≈ 62832
    | {
      style.font-color: "#aaa"
      style.fill: transparent
    }
  }
}

encoding_matrix -> frequency_panel: "Columns span\nfrequency spectrum" {
  style.stroke: "#7fdbca"
  style.stroke-dash: 3
}

uniqueness: "Position Uniqueness via Interference" {
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a6a"
  style.border-radius: 8
  direction: down
  near: bottom-center
  
  principle: |md
    ### Why Every Position Gets a Unique Fingerprint
    
    Each position is encoded by **d/2 frequency channels**.
    
    Think of it like a radio: each frequency is a different station.
    Position 42 is like tuning to all stations simultaneously,
    each at a specific phase of its wave.
    
    **No two positions can have identical encodings** because
    that would require all sin/cos waves to align at both points—
    mathematically impossible for incommensurate frequencies.
  | {
    style.font-color: "#ddd"
    style.fill: transparent
  }
  
  math_proof: |md
    
    If PE(p₁) = PE(p₂) for all dimensions:
    
    sin(p₁/λ₀) = sin(p₂/λ₀)  →  p₁ ≡ p₂ (mod 2πλ₀)
    sin(p₁/λ₁) = sin(p₂/λ₁)  →  p₁ ≡ p₂ (mod 2πλ₁)
    ...
    
    Since λᵢ = 10000^(2i/d) are incommensurate,
    the only solution is p₁ = p₂.
    
  | {
    style.font-color: "#e94560"
    style.fill: "#0f3460"
    style.border-radius: 4
  }
}

encoding_matrix -> uniqueness: "Each row is a\nunique vector" {
  style.stroke: "#e94560"
  style.stroke-dash: 3
}

addition_op: "⊕" {
  shape: circle
  style.fill: "#e94560"
  style.font-color: white
  style.font-size: 24
  style.stroke: "#ff6b6b"
}

token_embedding: "Token Embedding\n[batch, seq, d_model]" {
  style.fill: "#16213e"
  style.stroke: "#4a4a6a"
  style.font-color: "#3498db"
}

positional_encoding: "Positional Encoding\n[seq, d_model]" {
  style.fill: "#0f3460"
  style.stroke: "#4a4a6a"
  style.font-color: "#7fdbca"
}

token_embedding -> addition_op: "broadcast\naddition"
positional_encoding -> addition_op
addition_op -> final_embedding: "Final Embedding\n[batch, seq, d_model]" {
  style.fill: "#2d4a3e"
  style.stroke: "#3d6a5e"
  style.font-color: "#7fdbca"
  style.bold: true
}

implementation: |md
  python
  def positional_encoding(seq_len, d_model):
      # Create position indices: [0, 1, 2, ..., seq_len-1]
      pos = torch.arange(seq_len).unsqueeze(1)
      
      # Create dimension indices: [0, 1, 2, ..., d_model-1]
      dim = torch.arange(d_model)
      
      # Compute wavelengths: 10000^(2i/d_model)
      wavelength = 10000 ** (2 * dim / d_model)
      
      # Compute angles: pos / wavelength
      angles = pos / wavelength
      
      # Apply sin to even dims, cos to odd dims
      PE = torch.zeros(seq_len, d_model)
      PE[:, 0::2] = torch.sin(angles[:, 0::2])
      PE[:, 1::2] = torch.cos(angles[:, 1::2])
      
      return PE  # [seq_len, d_model]
  
| {
  near: bottom-left
  style.fill: "#0f3460"
  style.stroke: "#4a4a6a"
  style.border-radius: 4
}

properties: |md
  ## Key Properties
  
  1. **Bounded**: All values in [-1, 1] ✓
  2. **Deterministic**: No learned parameters ✓
  3. **Extrapolatable**: Works for longer sequences than training ✓
  4. **Relative encoding**: PE(pos+k) is linear function of PE(pos) ✓
  
  ### Relative Position Property
  
  PE(pos+k) can be expressed as linear transformation of PE(pos):
  
  
  sin(x + k) = sin(x)cos(k) + cos(x)sin(k)
  cos(x + k) = cos(x)cos(k) - sin(x)sin(k)
  
  
  This allows the model to learn **relative positions**
  through linear transformations—attention can discover
  "k positions away" relationships.
| {
  near: bottom-right
  style.fill: "#16213e"
  style.stroke: "#4a4a6a"
  style.border-radius: 4
}