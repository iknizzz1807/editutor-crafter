classes: {
  attention_head: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  projection: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  data_flow: {
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  reshape_op: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.stroke-dash: 3
  }
}

input: Input Sequence\n(batch, seq_len, d_model) {
  class: projection
}

linear_projections: Linear Projections {
  class: attention_head
  
  wq: "W_Q: Linear(d_model → d_model)"
  wk: "W_K: Linear(d_model → d_model)"
  wv: "W_V: Linear(d_model → d_model)"
}

reshape_split: Reshape & Split {
  class: reshape_op
  
  q_heads: "Q: (batch, seq_len, h, d_k)"
  k_heads: "K: (batch, seq_len, h, d_k)"
  v_heads: "V: (batch, seq_len, h, d_k)"
}

parallel_attention: Parallel Attention Heads {
  class: attention_head
  
  head1: Head 1\nAttention(Q₁, K₁, V₁)
  head2: Head 2\nAttention(Q₂, K₂, V₂)
  head_dots: "..."
  head_h: Head h\nAttention(Qₕ, Kₕ, Vₕ)
}

concat_reshape: Concatenate & Reshape {
  class: reshape_op
  
  concat_step: "Concat heads along feature dim"
  final_shape: "(batch, seq_len, d_model)"
}

output_projection: Output Projection {
  class: projection
  
  wo: "W_O: Linear(d_model → d_model)"
}

final_output: Multi-Head Output\n(batch, seq_len, d_model) {
  class: projection
}

input -> linear_projections: "Split input to Q, K, V" {
  class: data_flow
}

linear_projections -> reshape_split: "Reshape to multiple heads\nd_model = h × d_k" {
  class: data_flow
}

reshape_split -> parallel_attention: "Distribute to heads" {
  class: data_flow
}

parallel_attention -> concat_reshape: "Collect head outputs" {
  class: data_flow
}

concat_reshape -> output_projection: "Combined features" {
  class: data_flow
}

output_projection -> final_output: "Final projection" {
  class: data_flow
}

dimension_note: |md
  **Key Dimensions:**
  - h = number of heads (typically 8 or 16)
  - d_k = d_model / h (head dimension)
  - Each head processes d_k features
  - Parallel computation across heads
| {
  shape: page
  near: top-right
  style.fill: "#0f3460"
  style.stroke: "#3fb950"
  style.font-color: "#e6edf3"
}