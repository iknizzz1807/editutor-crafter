layout-engine: elk
theme-id: 200

title: |md
  # Causal Mask Construction
  `torch.tril` → softmax pathway
| {near: top-center}

direction: right

step1: Step 1: Lower-Triangular Matrix {
  grid-columns: 4
  grid-rows: 4
  grid-gap: 0
  
  c00: 1 {
    style.fill: "#E8F5E9"
    style.stroke: "#4CAF50"
  }
  c01: 0 {
    style.fill: "#FFCDD2"
    style.stroke: "#F44336"
  }
  c02: 0 {
    style.fill: "#FFCDD2"
    style.stroke: "#F44336"
  }
  c03: 0 {
    style.fill: "#FFCDD2"
    style.stroke: "#F44336"
  }
  c10: 1 {
    style.fill: "#E8F5E9"
    style.stroke: "#4CAF50"
  }
  c11: 1 {
    style.fill: "#E8F5E9"
    style.stroke: "#4CAF50"
  }
  c12: 0 {
    style.fill: "#FFCDD2"
    style.stroke: "#F44336"
  }
  c13: 0 {
    style.fill: "#FFCDD2"
    style.stroke: "#F44336"
  }
  c20: 1 {
    style.fill: "#E8F5E9"
    style.stroke: "#4CAF50"
  }
  c21: 1 {
    style.fill: "#E8F5E9"
    style.stroke: "#4CAF50"
  }
  c22: 1 {
    style.fill: "#E8F5E9"
    style.stroke: "#4CAF50"
  }
  c23: 0 {
    style.fill: "#FFCDD2"
    style.stroke: "#F44336"
  }
  c30: 1 {
    style.fill: "#E8F5E9"
    style.stroke: "#4CAF50"
  }
  c31: 1 {
    style.fill: "#E8F5E9"
    style.stroke: "#4CAF50"
  }
  c32: 1 {
    style.fill: "#E8F5E9"
    style.stroke: "#4CAF50"
  }
  c33: 1 {
    style.fill: "#E8F5E9"
    style.stroke: "#4CAF50"
  }
  
  label: |md
    `torch.tril(torch.ones(4, 4))`
    * **Green (1)**: Can attend
    * **Red (0)**: Cannot attend
  |
}

legend1: |md
  mask = torch.tril(
    torch.ones(seq_len, seq_len)
  )
  
  Lower triangle = 1 (attend)
  Upper triangle = 0 (mask)
| {
  shape: text
  style.font-size: 14
}

step2: Step 2: Mask Before Softmax {
  grid-columns: 4
  grid-rows: 4
  grid-gap: 0
  
  d00: "0" {
    style.fill: "#E3F2FD"
    style.stroke: "#2196F3"
  }
  d01: "-inf" {
    style.fill: "#FFEBEE"
    style.stroke: "#D32F2F"
    style.font-color: "#D32F2F"
    style.bold: true
  }
  d02: "-inf" {
    style.fill: "#FFEBEE"
    style.stroke: "#D32F2F"
    style.font-color: "#D32F2F"
    style.bold: true
  }
  d03: "-inf" {
    style.fill: "#FFEBEE"
    style.stroke: "#D32F2F"
    style.font-color: "#D32F2F"
    style.bold: true
  }
  d10: "0" {
    style.fill: "#E3F2FD"
    style.stroke: "#2196F3"
  }
  d11: "0" {
    style.fill: "#E3F2FD"
    style.stroke: "#2196F3"
  }
  d12: "-inf" {
    style.fill: "#FFEBEE"
    style.stroke: "#D32F2F"
    style.font-color: "#D32F2F"
    style.bold: true
  }
  d13: "-inf" {
    style.fill: "#FFEBEE"
    style.stroke: "#D32F2F"
    style.font-color: "#D32F2F"
    style.bold: true
  }
  d20: "0" {
    style.fill: "#E3F2FD"
    style.stroke: "#2196F3"
  }
  d21: "0" {
    style.fill: "#E3F2FD"
    style.stroke: "#2196F3"
  }
  d22: "0" {
    style.fill: "#E3F2FD"
    style.stroke: "#2196F3"
  }
  d23: "-inf" {
    style.fill: "#FFEBEE"
    style.stroke: "#D32F2F"
    style.font-color: "#D32F2F"
    style.bold: true
  }
  d30: "0" {
    style.fill: "#E3F2FD"
    style.stroke: "#2196F3"
  }
  d31: "0" {
    style.fill: "#E3F2FD"
    style.stroke: "#2196F3"
  }
  d32: "0" {
    style.fill: "#E3F2FD"
    style.stroke: "#2196F3"
  }
  d33: "0" {
    style.fill: "#E3F2FD"
    style.stroke: "#2196F3"
  }
  
  label: |md
    `scores.masked_fill(mask == 0, float('-inf'))`
    * **Blue (0)**: Original score
    * **Red (-inf)**: Masked position
  |
}

legend2: |md
  scores = scores.masked_fill(
    mask == 0, 
    float('-inf')
  )
  
  Where mask=0 → set to -inf
| {
  shape: text
  style.font-size: 14
}

step3: Step 3: After Softmax {
  grid-columns: 4
  grid-rows: 4
  grid-gap: 0
  
  e00: "1.00" {
    style.fill: "#C8E6C9"
    style.stroke: "#388E3C"
    style.bold: true
  }
  e01: "0.00" {
    style.fill: "#FFCDD2"
    style.stroke: "#C62828"
    style.font-color: "#B71C1C"
  }
  e02: "0.00" {
    style.fill: "#FFCDD2"
    style.stroke: "#C62828"
    style.font-color: "#B71C1C"
  }
  e03: "0.00" {
    style.fill: "#FFCDD2"
    style.stroke: "#C62828"
    style.font-color: "#B71C1C"
  }
  e10: "0.50" {
    style.fill: "#DCEDC8"
    style.stroke: "#689F38"
  }
  e11: "0.50" {
    style.fill: "#DCEDC8"
    style.stroke: "#689F38"
  }
  e12: "0.00" {
    style.fill: "#FFCDD2"
    style.stroke: "#C62828"
    style.font-color: "#B71C1C"
  }
  e13: "0.00" {
    style.fill: "#FFCDD2"
    style.stroke: "#C62828"
    style.font-color: "#B71C1C"
  }
  e20: "0.33" {
    style.fill: "#DCEDC8"
    style.stroke: "#689F38"
  }
  e21: "0.33" {
    style.fill: "#DCEDC8"
    style.stroke: "#689F38"
  }
  e22: "0.33" {
    style.fill: "#DCEDC8"
    style.stroke: "#689F38"
  }
  e23: "0.00" {
    style.fill: "#FFCDD2"
    style.stroke: "#C62828"
    style.font-color: "#B71C1C"
  }
  e30: "0.25" {
    style.fill: "#DCEDC8"
    style.stroke: "#689F38"
  }
  e31: "0.25" {
    style.fill: "#DCEDC8"
    style.stroke: "#689F38"
  }
  e32: "0.25" {
    style.fill: "#DCEDC8"
    style.stroke: "#689F38"
  }
  e33: "0.25" {
    style.fill: "#DCEDC8"
    style.stroke: "#689F38"
  }
  
  label: |md
    `softmax(scores, dim=-1)`
    * **Green**: Valid attention weights
    * **Red (0.00)**: Masked out
    * Each **row sums to 1.0**
  |
}

legend3: |md
  attn_weights = F.softmax(
    scores, dim=-1
  )
  
  exp(-inf) = 0 → no attention
  Rows sum to 1.0 ✓
| {
  shape: text
  style.font-size: 14
}

step1 -> step2: "mask == 0\n→ -inf" {
  style.stroke: "#673AB7"
  style.stroke-width: 3
  style.bold: true
}

step2 -> step3: "softmax\nexp(-inf)=0" {
  style.stroke: "#673AB7"
  style.stroke-width: 3
  style.bold: true
}

annotation: |md
  ## Critical: Mask BEFORE Softmax
  
  **Wrong**: `softmax(scores) * mask`
  - Result doesn't sum to 1
  - Breaks probability interpretation
  
  **Correct**: `softmax(scores.masked_fill(mask==0, -inf))`
  - `-inf` → `exp(-inf)` = 0
  - Remaining values normalize to sum=1
| {
  near: bottom-center
  shape: text
  style.fill: "#FFF3E0"
  style.stroke: "#FF9800"
  style.stroke-width: 2
  style.border-radius: 8
}

position_labels: ||md
  ### Position Semantics
  
  | Row | Can Attend To |
  |-----|---------------|
  | 0   | pos 0 only    |
  | 1   | pos 0, 1      |
  | 2   | pos 0, 1, 2   |
  | 3   | pos 0, 1, 2, 3|
  
  **Decoder rule**: Only see the past
|| {
  near: top-right
  shape: text
}