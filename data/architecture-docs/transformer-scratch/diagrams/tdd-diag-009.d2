vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

shape: sequence_diagram

test_runner: Test Runner
custom_attn: "ScaledDotProductAttention\n(custom impl)"
pytorch_ref: "F.scaled_dot_product_attention\n(PyTorch reference)"
verifier: "Assertion\n(max diff < 1e-5)"

test_runner -> test_runner: "torch.manual_seed(42)"

test_runner -> test_runner.a: "x = torch.randn(2, 5, 64)"

test_runner.a -> custom_attn: "forward(x)"
custom_attn -> custom_attn: "Q = W_Q(x)"
custom_attn -> custom_attn: "K = W_K(x)"
custom_attn -> custom_attn: "V = W_V(x)"
custom_attn -> custom_attn: "scores = QK^T / sqrt(d_k)"
custom_attn -> custom_attn: "weights = softmax(scores)"
custom_attn -> test_runner.a: "output_custom, weights"

test_runner.a -> pytorch_ref: "Q, K, V (same tensors)"
pytorch_ref -> test_runner.a: "output_ref"

test_runner.a -> verifier: "diff = |output_custom - output_ref|"
verifier -> test_runner: "âœ“ PASS: max diff = 2.3e-7"

test_runner."All tests passed" {
  style.fill: "#ACE1AF"
}