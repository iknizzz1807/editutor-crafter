vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # FFN Data Flow
  Feed-Forward Network: Position-wise Transformation
| {near: top-center}

direction: right

input: "Input\n[batch, seq, d_model]" {
  style.fill: "#E8F4FD"
  style.stroke: "#2563EB"
  style.stroke-width: 2
}

w1: "W₁ Projection\n[batch, seq, d_ff]" {
  style.fill: "#FEF3C7"
  style.stroke: "#D97706"
  style.stroke-width: 2
}

relu: "ReLU\nActivation" {
  shape: diamond
  style.fill: "#FEE2E2"
  style.stroke: "#DC2626"
  style.stroke-width: 2
}

w2: "W₂ Projection\n[batch, seq, d_model]" {
  style.fill: "#FEF3C7"
  style.stroke: "#D97706"
  style.stroke-width: 2
}

dropout: "Dropout\n(p=0.1)" {
  shape: circle
  style.fill: "#D1FAE5"
  style.stroke: "#059669"
  style.stroke-width: 2
}

output: "Output\n[batch, seq, d_model]" {
  style.fill: "#E8F4FD"
  style.stroke: "#2563EB"
  style.stroke-width: 2
}

input -> w1: "Linear(d_model, d_ff)" {
  style.stroke: "#2563EB"
  style.stroke-width: 2
}

w1 -> relu: "x₁ = W₁·x + b₁" {
  style.stroke: "#D97706"
  style.stroke-width: 2
}

relu -> w2: "max(0, x₁)" {
  style.stroke: "#DC2626"
  style.stroke-width: 2
}

w2 -> dropout: "x₂ = W₂·x₁ + b₂" {
  style.stroke: "#D97706"
  style.stroke-width: 2
}

dropout -> output: "x₂ if train\nx₂·(1-p) if eval" {
  style.stroke: "#059669"
  style.stroke-width: 2
}

annotation: |md
  **Position-wise**: Each token processed independently
  
  **Expansion ratio**: `d_ff = 4 × d_model` (typical)
  
  **Formula**: `FFN(x) = Dropout(W₂·ReLU(W₁·x + b₁) + b₂)`
| {
  near: bottom-center
  style.fill: transparent
}