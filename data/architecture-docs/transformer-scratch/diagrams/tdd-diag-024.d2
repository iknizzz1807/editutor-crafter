vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Sinusoidal Positional Encoding Formula
  PE(pos, 2i) = sin(pos / 10000^(2i/d_model))
  PE(pos, 2i+1) = cos(pos / 10000^(2i/d_model))
| {near: top-center}

direction: right

input_row: {
  style.fill: transparent

  pos: "pos (position index)" {
    shape: rectangle
    style.fill: "#E8D5E0"
    style.stroke: "#8B5A8B"
    style.bold: true
  }

  d_model: "d_model (embedding dim)" {
    shape: rectangle
    style.fill: "#E8D5E0"
    style.stroke: "#8B5A8B"
    style.bold: true
  }

  i: "i (dimension index)" {
    shape: rectangle
    style.fill: "#E8D5E0"
    style.stroke: "#8B5A8B"
    style.bold: true
  }
}

compute: "Compute Wavelength Term" {
  style.fill: "#D4E6F1"
  style.stroke: "#2874A6"

  step1: "term = 2i / d_model" {
    shape: rectangle
    style.fill: "#D6EAF8"
  }

  step2: "wavelength = 10000^term" {
    shape: rectangle
    style.fill: "#D6EAF8"
  }

  step3: "angle = pos / wavelength" {
    shape: rectangle
    style.fill: "#D6EAF8"
  }

  step1 -> step2 -> step3
}

branch: {
  style.fill: transparent

  even_branch: "Even Index (2i)" {
    style.fill: "#D5F5E3"
    style.stroke: "#1E8449"

    sin_compute: "sin(angle)" {
      shape: rectangle
      style.fill: "#ABEBC6"
      style.bold: true
    }

    pe_even: "PE(pos, 2i)" {
      shape: rectangle
      style.fill: "#82E0AA"
      style.stroke: "#1E8449"
      style.bold: true
    }

    sin_compute -> pe_even
  }

  odd_branch: "Odd Index (2i+1)" {
    style.fill: "#FCF3CF"
    style.stroke: "#B7950B"

    cos_compute: "cos(angle)" {
      shape: rectangle
      style.fill: "#F9E79F"
      style.bold: true
    }

    pe_odd: "PE(pos, 2i+1)" {
      shape: rectangle
      style.fill: "#F7DC6F"
      style.stroke: "#B7950B"
      style.bold: true
    }

    cos_compute -> pe_odd
  }
}

output: {
  style.fill: transparent

  pe_vector: "PE[pos] : [d_model]" {
    shape: rectangle
    style.fill: "#BB8FCE"
    style.stroke: "#6C3483"
    style.bold: true
    width: 200
  }
}

input_row.pos -> compute.step1
input_row.i -> compute.step1
input_row.d_model -> compute.step1

compute.step3 -> even_branch.sin_compute
compute.step3 -> odd_branch.cos_compute

even_branch.pe_even -> pe_vector
odd_branch.pe_odd -> pe_vector

formula_box: |md
  ## Formula Breakdown
  
  
  PE(pos, 2i)   = sin(pos / 10000^(2i/d_model))
  PE(pos, 2i+1) = cos(pos / 10000^(2i/d_model))
  
  
  - **pos**: token position in sequence (0, 1, 2, ...)
  - **i**: dimension index (0 to d_model/2 - 1)
  - **2i**: even dimensions use sin
  - **2i+1**: odd dimensions use cos
  - **10000**: base wavelength multiplier
  
  **Key Property**: Positions can be expressed as linear combinations
  of other positions, enabling the model to learn relative position.
| {near: bottom-center}