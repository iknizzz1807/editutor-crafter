vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

title: |md
  # Encoder Stack Data Flow
| {near: top-center}

classes: {
  embedding: {
    style: {
      fill: "#E8D5F2"
      stroke: "#9B59B6"
      stroke-width: 2
    }
  }
  encoder-layer: {
    style: {
      fill: "#D5E8F2"
      stroke: "#3498DB"
      stroke-width: 2
    }
  }
  output: {
    style: {
      fill: "#D5F2E8"
      stroke: "#27AE60"
      stroke-width: 2
    }
  }
  decoder-connection: {
    style: {
      stroke: "#E67E22"
      stroke-dash: 4
      animated: true
    }
  }
}

input: "Input Embeddings\n[batch, seq_len, d_model]" {
  class: embedding
}

layer_1: "Encoder Layer 1\n{Self-Attn, FFN, Add&Norm}" {
  class: encoder-layer
}

layer_2: "Encoder Layer 2\n{Self-Attn, FFN, Add&Norm}" {
  class: encoder-layer
}

layer_dots: "..." {
  style: {
    font-size: 24
    fill: "transparent"
    stroke: "transparent"
  }
}

layer_N: "Encoder Layer N\n{Self-Attn, FFN, Add&Norm}" {
  class: encoder-layer
}

encoder_output: "Encoder Output\n[batch, seq_len, d_model]" {
  class: output
}

decoder_stack: "Decoder Stack\n(Cross-Attention\nreceives this)" {
  style: {
    fill: "#FDEBD0"
    stroke: "#E67E22"
    stroke-width: 2
    stroke-dash: 4
  }
}

input -> layer_1: "forward pass"
layer_1 -> layer_2: "residual flow"
layer_2 -> layer_dots
layer_dots -> layer_N
layer_N -> encoder_output: "final representation"

encoder_output -> decoder_stack: "broadcast to\nevery decoder layer" {
  class: decoder-connection
  label.near: center-right
}

legend: |md
  ## Legend
  - **Purple**: Input embeddings
  - **Blue**: Encoder layers (Ã—N)
  - **Green**: Encoder output
  - **Orange dashed**: Cross-attention connection
| {near: bottom-left}