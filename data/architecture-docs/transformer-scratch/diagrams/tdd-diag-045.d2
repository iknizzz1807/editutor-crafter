vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Teacher Forcing Label Shift
  One-position shift between decoder input and target labels
| {near: top-center}

direction: right

step1: {
  label: "Step 1: Decoder Input"
  
  header_input: {
    shape: rectangle
    label: |md
      **DECODER INPUT** `[seq_len]`
      Shifted right by one position
    |
    style.fill: "#E8E4F0"
    style.stroke: "#7B68EE"
    style.font-color: "#4B0082"
  }
  
  input_row: {
    grid-columns: 5
    grid-gap: 0
    
    pos_0_in: {
      label: |md
        **Position 0**
        ─────────
        `<BOS>`
      |
      style.fill: "#DDA0DD"
      style.stroke: "#8B008B"
      style.bold: true
    }
    
    pos_1_in: {
      label: |md
        **Position 1**
        ─────────
        `t1`
      |
      style.fill: "#E6E6FA"
      style.stroke: "#8B008B"
    }
    
    pos_2_in: {
      label: |md
        **Position 2**
        ─────────
        `t2`
      |
      style.fill: "#E6E6FA"
      style.stroke: "#8B008B"
    }
    
    pos_3_in: {
      label: |md
        **Position 3**
        ─────────
        `t3`
      |
      style.fill: "#E6E6FA"
      style.stroke: "#8B008B"
    }
    
    pos_4_in: {
      label: |md
        **Position 4**
        ─────────
        `<PAD>`
      |
      style.fill: "#D3D3D3"
      style.stroke: "#8B008B"
      style.stroke-dash: 3
    }
  }
}

shift_arrow: {
  label: |md
    **SHIFT**
    ──────────────
    Position i predicts
    Position i+1
  |
  shape: diamond
  style.fill: "#FFE4B5"
  style.stroke: "#FF8C00"
  style.bold: true
}

step2: {
  label: "Step 2: Target Labels"
  
  header_target: {
    shape: rectangle
    label: |md
      **TARGET LABELS** `[seq_len]`
      Ground truth for loss computation
    |
    style.fill: "#E0F0E8"
    style.stroke: "#228B22"
    style.font-color: "#006400"
  }
  
  target_row: {
    grid-columns: 5
    grid-gap: 0
    
    pos_0_out: {
      label: |md
        **Position 0**
        ─────────
        `t1`
      |
      style.fill: "#98FB98"
      style.stroke: "#228B22"
      style.bold: true
    }
    
    pos_1_out: {
      label: |md
        **Position 1**
        ─────────
        `t2`
      |
      style.fill: "#98FB98"
      style.stroke: "#228B22"
    }
    
    pos_2_out: {
      label: |md
        **Position 2**
        ─────────
        `t3`
      |
      style.fill: "#98FB98"
      style.stroke: "#228B22"
    }
    
    pos_3_out: {
      label: |md
        **Position 3**
        ─────────
        `<EOS>`
      |
      style.fill: "#90EE90"
      style.stroke: "#228B22"
      style.bold: true
    }
    
    pos_4_out: {
      label: |md
        **Position 4**
        ─────────
        `<PAD>`
      |
      style.fill: "#D3D3D3"
      style.stroke: "#228B22"
      style.stroke-dash: 3
    }
  }
}

step1 -> shift_arrow -> step2: {
  label: "labels = decoder_input[1:]"
  style.stroke: "#FF8C00"
  style.stroke-width: 3
  style.bold: true
}

alignment_diagram: {
  label: "Alignment Visualization"
  
  grid: {
    grid-rows: 2
    grid-columns: 6
    grid-gap: 0
    
    label_decoder: {
      label: "Decoder:"
      style.fill: transparent
      style.stroke: transparent
      style.bold: true
    }
    
    d_bos: {
      label: "<BOS>"
      style.fill: "#DDA0DD"
      style.bold: true
    }
    
    d_t1: {
      label: "t1"
      style.fill: "#E6E6FA"
    }
    d_t2: {
      label: "t2"
      style.fill: "#E6E6FA"
    }
    d_t3: {
      label: "t3"
      style.fill: "#E6E6FA"
    }
    d_pad: {
      label: "<PAD>"
      style.fill: "#D3D3D3"
      style.stroke-dash: 3
    }
    
    label_target: {
      label: "Target:"
      style.fill: transparent
      style.stroke: transparent
      style.bold: true
    }
    
    t_t1: {
      label: "t1"
      style.fill: "#98FB98"
      style.bold: true
    }
    
    t_t2: {
      label: "t2"
      style.fill: "#98FB98"
    }
    t_t3: {
      label: "t3"
      style.fill: "#98FB98"
    }
    
    t_eos: {
      label: "<EOS>"
      style.fill: "#90EE90"
      style.bold: true
    }
    
    t_pad: {
      label: "<PAD>"
      style.fill: "#D3D3D3"
      style.stroke-dash: 3
    }
  }
}

arrows: {
  arrow_0: {
    shape: text
    label: "↓"
    style.font-size: 24
    style.font-color: "#FF4500"
    style.bold: true
  }
  
  arrow_1: {
    shape: text
    label: "↓"
    style.font-size: 24
    style.font-color: "#FF4500"
    style.bold: true
  }
  
  arrow_2: {
    shape: text
    label: "↓"
    style.font-size: 24
    style.font-color: "#FF4500"
    style.bold: true
  }
  
  arrow_3: {
    shape: text
    label: "↓"
    style.font-size: 24
    style.font-color: "#FF4500"
    style.bold: true
  }
}

implementation: {
  label: "Implementation Code"
  
  code: ||python
    # Teacher forcing: shift decoder input for labels
    decoder_input = torch.tensor([BOS, t1, t2, t3, PAD])  # [seq_len]
    
    # Labels are shifted by one position
    labels = decoder_input[1:]  # [t1, t2, t3, EOS, PAD]
    
    # Or equivalently, during data preparation:
    # decoder_input = [BOS] + tokens + [PAD]  # Input to decoder
    # labels = tokens + [EOS] + [PAD]         # Ground truth
  ||
  style.fill: "#2D2D2D"
  style.font-color: "#00FF00"
  style.font: mono
}

loss_note: {
  label: |md
    **Loss Computation**
    ─────────────────────
    CrossEntropyLoss computed at each position:
    - Position 0: P(t1 | `<BOS>`) vs `t1`
    - Position 1: P(t2 | `<BOS>`, t1) vs `t2`
    - Position 2: P(t3 | `<BOS>`, t1, t2) vs `t3`
    - Position 3: P(`<EOS>` | `<BOS>`, t1, t2, t3) vs `<EOS>`
    
    Padding positions masked in loss (ignore_index=PAD_ID)
  |
  style.fill: "#FFF8DC"
  style.stroke: "#DAA520"
  near: bottom-center
}

summary: {
  label: |md
    **Key Insight**
    ═══════════════════════════════════════════════════
    • Decoder input starts with `<BOS>` to seed generation
    • Target labels are the same sequence shifted left
    • Each decoder position predicts the NEXT token
    • Loss computed only on non-padding positions
  |
  style.fill: "#F0F8FF"
  style.stroke: "#4169E1"
  near: bottom-center
}