vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Learning Rate Schedule: Warmup + Inverse-Sqrt Decay
  **Formula:** $\text{LR} = d_{\text{model}}^{-0.5} \times \min(\text{step}^{-0.5}, \text{step} \times \text{warmup}^{-1.5})$
| {near: top-center}

step_0: Step 0: Initial State {
  step_0_desc: |md
    - `step = 0`
    - `warmup_steps = 4000`
    - `d_model = 512`
    - `base_factor = d_model^(-0.5) ≈ 0.044`
  |
  style.fill: "#E8E8E8"
  style.stroke: "#666666"
}

step_1: Step 1: Compute Warmup Factor {
  warmup_factor: {
    formula: "step × warmup^(-1.5)"
    calc: "0 × 4000^(-1.5) = 0"
    result: "warmup_factor = 0"
    style.fill: "#FFE4B5"
    style.stroke: "#FF8C00"
  }
  step_1_desc: |md
    During warmup phase, this factor
    increases linearly with step.
  |
}

step_2: Step 2: Compute Decay Factor {
  decay_factor: {
    formula: "step^(-0.5)"
    calc: "0^(-0.5) = ∞"
    result: "decay_factor = ∞"
    style.fill: "#E6E6FA"
    style.stroke: "#9370DB"
  }
  step_2_desc: |md
    Inverse sqrt decay starts high
    and decreases over time.
  |
}

step_3: Step 3: Take Minimum {
  min_result: {
    operation: "min(warmup_factor, decay_factor)"
    calc: "min(0, ∞) = 0"
    result: "selected = 0"
    style.fill: "#90EE90"
    style.stroke: "#228B22"
    style.bold: true
  }
  step_3_desc: |md
    Minimum selects the active constraint.
    Early: warmup dominates.
    Late: decay dominates.
  |
}

step_4: Step 4: Apply Base Scaling {
  lr_result: {
    formula: "base_factor × selected"
    calc: "0.044 × 0 = 0"
    result: "**LR = 0**"
    style.fill: "#FFB6C1"
    style.stroke: "#DC143C"
    style.bold: true
    style.font-size: 24
  }
}

step_0 -> step_1 -> step_2 -> step_3 -> step_4

warmup_phase: Warmup Phase (step < 4000) {
  warmup_example: |md
    **At step 1000:**
    - warmup_factor = 1000 × 4000^(-1.5) ≈ 0.004
    - decay_factor = 1000^(-0.5) ≈ 0.032
    - min = 0.004 (warmup wins)
    - LR = 0.044 × 0.004 ≈ **0.00018**
  |
  style.fill: "#FFF8DC"
  style.stroke: "#DAA520"
}

transition_phase: Transition Point (step = warmup) {
  transition_example: |md
    **At step 4000:**
    - warmup_factor = 4000 × 4000^(-1.5) = 4000^(-0.5) ≈ 0.016
    - decay_factor = 4000^(-0.5) ≈ 0.016
    - Both factors equal!
    - LR = 0.044 × 0.016 ≈ **0.0007** (peak)
  |
  style.fill: "#98FB98"
  style.stroke: "#006400"
}

decay_phase: Decay Phase (step > warmup) {
  decay_example: |md
    **At step 40000:**
    - warmup_factor = 40000 × 4000^(-1.5) ≈ 0.040
    - decay_factor = 40000^(-0.5) ≈ 0.005
    - min = 0.005 (decay wins)
    - LR = 0.044 × 0.005 ≈ **0.00022**
  |
  style.fill: "#E6E6FA"
  style.stroke: "#9370DB"
}

warmup_phase -> transition_phase -> decay_phase

legend: Legend {
  warmup_line: Warmup Factor {
    style.fill: "#FFE4B5"
    style.stroke: "#FF8C00"
  }
  decay_line: Decay Factor {
    style.fill: "#E6E6FA"
    style.stroke: "#9370DB"
  }
  lr_line: Learning Rate {
    style.fill: "#FFB6C1"
    style.stroke: "#DC143C"
  }
  style.fill: "#F5F5F5"
  style.stroke: "#CCCCCC"
}
legend.near: bottom-right