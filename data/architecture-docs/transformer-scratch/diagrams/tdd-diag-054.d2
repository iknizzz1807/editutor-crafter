vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

direction: right

title: |md
  # Batch Preparation Pipeline
  **Transformer Input Processing**
| {near: top-center}

classes: {
  process: {
    shape: rectangle
    style: {
      fill: "#E8F4FD"
      stroke: "#2E86AB"
      stroke-width: 2
      border-radius: 4
    }
  }
  data: {
    shape: cylinder
    style: {
      fill: "#FFF3E0"
      stroke: "#E65100"
      stroke-width: 2
    }
  }
  step_label: {
    shape: text
    style: {
      font-size: 11
      italic: true
      font-color: "#666666"
    }
  }
}

shape: sequence_diagram

Tokenizer
Padder
Masker
TensorCreator
Device

Init: {
    Tokenizer: {
        shape: text
        label: "vocab_size: 32000"
    }
}

Step1_Tokenize: {
    Tokenizer.t1 -> Padder: "token_ids: [batch, var_len]"
    Tokenizer.t1.note: |md
        **Input**: "Hello world"
        **Output**: [15496, 995]
        **Step**: subword segmentation
    |
}

Step2_Padding: {
    Padder.t2 -> Masker: "padded_ids: [batch, max_len]"
    Padder.t2.note: |md
        **Input**: [[15496, 995], [31373, 995, 383]]
        **Output**: [[15496, 995, PAD, PAD],
                     [31373, 995, 383, PAD]]
        **Step**: pad_id = 0
    |
}

Step3_Masking: {
    Masker.t3 -> TensorCreator: "attention_mask: [batch, max_len]"
    Masker.t3.note: |md
        **Padding Mask**: [[1, 1, 0, 0],
                          [1, 1, 1, 0]]
        **Causal Mask**: torch.tril()
        **Step**: combine masks
    |
}

Step4_TensorCreation: {
    TensorCreator.t4 -> Device.t5: "batch_dict"
    TensorCreator.t4.note: |md
        **input_ids**: torch.LongTensor
        **attention_mask**: torch.FloatTensor
        **labels**: torch.LongTensor
        **Step**: dtype conversion
    |
}

Step5_DeviceTransfer: {
    Device.t5.note: |md
        **to('cuda')**
        **non_blocking=True**
        **Step**: async transfer
    |
    Device.t5 -> _.Tokenizer: "ready for forward pass"
}

Timing: {
    label: "Pipeline Latency"
    Tokenizer -> Padder: "~2ms (CPU)" {
        style.stroke: green
    }
    Padder -> Masker: "~0.1ms" {
        style.stroke: green
    }
    Masker -> TensorCreator: "~0.2ms" {
        style.stroke: green
    }
    TensorCreator -> Device: "~1ms (PCIe)" {
        style.stroke: orange
    }
}

Tokenizer.style.fill: "#E8F4FD"
Padder.style.fill: "#E8F4FD"
Masker.style.fill: "#E8F4FD"
TensorCreator.style.fill: "#E8F4FD"
Device.style.fill: "#E3F2E5"