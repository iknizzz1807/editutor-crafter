vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Greedy Decoder State Machine
  Autoregressive Token Generation
| {near: top-center}

INIT: {
  shape: circle
  style.fill: "#E8F5E9"
  style.stroke: "#4CAF50"
  style.stroke-width: 3
  label: "●"
}

GENERATING: {
  style.fill: "#E3F2FD"
  style.stroke: "#2196F3"
  style.stroke-width: 2
  width: 200
}

GENERATING.annotation: |md
  **State: GENERATING**
  - `idx < max_length`
  - `last_token ≠ <EOS>`
  - Compute: P(x_t | x_{<t})
  - Select: x_t = argmax_v P(x_t | x_{<t})
|

EOS_REACHED: {
  shape: circle
  style.fill: "#C8E6C9"
  style.stroke: "#388E3C"
  style.stroke-width: 3
  style.double-border: true
}

EOS_REACHED.annotation: |md
  **State: EOS_REACHED**
  - `last_token == <EOS>`
  - Generation complete
  - Return: [x_1, ..., x_{t-1}]
|

MAX_LENGTH: {
  shape: circle
  style.fill: "#FFECB3"
  style.stroke: "#FFA000"
  style.stroke-width: 3
  style.double-border: true
}

MAX_LENGTH.annotation: |md
  **State: MAX_LENGTH**
  - `idx == max_length`
  - Budget exhausted
  - Return: [x_1, ..., x_{max}]
|

INIT -> GENERATING: {
  label: "start_decode()\nencoder_output ready"
  style.stroke: "#4CAF50"
  style.stroke-width: 2
}

GENERATING -> GENERATING: {
  label: "token ∈ V \\ {<EOS>}\nidx += 1\nconcat(sequence, token)"
  style.stroke: "#2196F3"
  style.stroke-width: 2
  style.animated: true
}

GENERATING -> EOS_REACHED: {
  label: "token == <EOS>\n[termination]"
  style.stroke: "#388E3C"
  style.stroke-width: 2
}

GENERATING -> MAX_LENGTH: {
  label: "idx == max_length\n[budget exhausted]"
  style.stroke: "#FFA000"
  style.stroke-width: 2
}

legend: {
  near: bottom-center
  style.fill: "#FAFAFA"
  style.stroke: "#E0E0E0"
  
  init_legend: {
    label: "● Initial State"
    shape: text
    style.font-color: "#4CAF50"
  }
  
  terminal_legend: {
    label: "◉ Terminal State (double border)"
    shape: text
    style.font-color: "#388E3C"
  }
  
  loop_legend: {
    label: "→ Self-loop: continued generation"
    shape: text
    style.font-color: "#2196F3"
  }
}

invariants: {
  near: top-right
  style.fill: "#FFF3E0"
  style.stroke: "#FF9800"
  
  inv_title: |md
    **State Invariants**
  |
  
  inv1: {
    label: "- INIT: `idx = 0`, `sequence = []`"
    shape: text
  }
  
  inv2: {
    label: "- GENERATING: `0 < idx < max_length`"
    shape: text
  }
  
  inv3: {
    label: "- EOS_REACHED: `sequence[-1] = <EOS>`"
    shape: text
  }
  
  inv4: {
    label: "- MAX_LENGTH: `len(sequence) = max_length`"
    shape: text
  }
}