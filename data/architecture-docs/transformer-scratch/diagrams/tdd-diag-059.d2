vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Beam Search State Machine
  `k=3` beam width example
| {near: top-center}

EXPANDING: {
  shape: circle
  style.fill: "#E8F4FD"
  style.stroke: "#2E86AB"
  style.stroke-width: 3
  
  annotation: |md
    - Generate `k Ã— vocab_size` candidates
    - Expand all k beams by one token
    - Accumulate log probabilities
  |
}

PRUNING: {
  shape: circle
  style.fill: "#FFF3E0"
  style.stroke: "#E65100"
  style.stroke-width: 3
  
  annotation: |md
    - Sort candidates by score
    - Keep top-k highest probability
    - Discard remaining candidates
  |
}

CHECKING_COMPLETE: {
  shape: diamond
  style.fill: "#E8F5E9"
  style.stroke: "#2E7D32"
  style.stroke-width: 3
  
  annotation: |md
    - Check for EOS tokens
    - Check max_length reached
    - Check score threshold
  |
}

DONE: {
  shape: circle
  style.fill: "#C8E6C9"
  style.stroke: "#1B5E20"
  style.stroke-width: 4
  style.bold: true
  
  annotation: |md
    - Return top completed sequences
    - Sort by length-normalized score
    - Output final beam results
  |
}

ERROR: {
  shape: circle
  style.fill: "#FFCDD2"
  style.stroke: "#B71C1C"
  style.stroke-width: 2
}

initial: {
  shape: circle
  style.fill: "#2E86AB"
  width: 20
  height: 20
}

initial -> EXPANDING: start {
  style.stroke: "#2E86AB"
  style.stroke-width: 2
}

EXPANDING -> PRUNING: candidates generated {
  label: |md
    guard: candidates.size > 0
    action: compute_scores()
  |
  style.stroke: "#2E86AB"
  style.stroke-width: 2
}

PRUNING -> CHECKING_COMPLETE: top-k selected {
  label: |md
    guard: beams.size == k
    action: update_beam_scores()
  |
  style.stroke: "#E65100"
  style.stroke-width: 2
}

CHECKING_COMPLETE -> EXPANDING: incomplete {
  label: "guard: !all_complete && steps < max_length"
  style.stroke: "#2E7D32"
  style.stroke-width: 2
  style.stroke-dash: 0
}

CHECKING_COMPLETE -> DONE: complete {
  label: "guard: all_complete || steps >= max_length"
  style.stroke: "#1B5E20"
  style.stroke-width: 3
  style.bold: true
}

EXPANDING -> ERROR: generation failed {
  label: "guard: candidates.size == 0"
  style.stroke: "#B71C1C"
  style.stroke-width: 2
  style.stroke-dash: 3
}

CHECKING_COMPLETE -> PRUNING: ILLEGAL {
  style.stroke: "#B71C1C"
  style.stroke-width: 2
  style.stroke-dash: 5
  style.font-color: "#B71C1C"
}

DONE -> EXPANDING: ILLEGAL {
  style.stroke: "#B71C1C"
  style.stroke-width: 2
  style.stroke-dash: 5
  style.font-color: "#B71C1C"
}

PRUNING -> EXPANDING: ILLEGAL {
  style.stroke: "#B71C1C"
  style.stroke-width: 2
  style.stroke-dash: 5
  style.font-color: "#B71C1C"
}

invariants: {
  near: bottom-center
  
  EXPANDING_inv: |md
    **EXPANDING invariant:**
    - `active_beams.size == k`
    - `candidates = []` (empty before)
    - `scores accumulating`
  |
  
  PRUNING_inv: |md
    **PRUNING invariant:**
    - `candidates.size == k * vocab_size`
    - All candidates have valid paths
    - Scores are log probabilities
  |
  
  CHECKING_inv: |md
    **CHECKING_COMPLETE invariant:**
    - `beams.size == k`
    - Each beam has `tokens` and `score`
    - `complete_beams subset of beams`
  |
  
  DONE_inv: |md
    **DONE invariant:**
    - `results.size <= k`
    - All results end with EOS
    - Results sorted by score DESC
  |
}

legend: {
  near: top-right
  
  initial_legend: {
    shape: circle
    width: 15
    height: 15
    style.fill: "#2E86AB"
  }
  initial_label: "Initial state"
  
  normal_legend: {
    shape: circle
    width: 40
    height: 40
    style.fill: "#E8F4FD"
    style.stroke: "#2E86AB"
  }
  normal_label: "Normal state"
  
  decision_legend: {
    shape: diamond
    width: 50
    height: 50
    style.fill: "#E8F5E9"
    style.stroke: "#2E7D32"
  }
  decision_label: "Decision state"
  
  terminal_legend: {
    shape: circle
    width: 40
    height: 40
    style.fill: "#C8E6C9"
    style.stroke: "#1B5E20"
    style.bold: true
  }
  terminal_label: "Terminal state"
  
  illegal_legend: {
    shape: text
    style.font-color: "#B71C1C"
    style.stroke-dash: 5
  }
  illegal_label: "ILLEGAL transition"
}