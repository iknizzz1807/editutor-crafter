vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

shape: sequence_diagram

Generator
KV_Cache: "KV Cache\n[K₀, K₁, ..., Kₙ₋₁]\n[V₀, V₁, ..., Vₙ₋₁]"
Attention: "Attention\nLayer"

Generator."Step t: Token t arrives"

Generator.step1 -> KV_Cache.t1: "1. Token t = 'the'"
KV_Cache.t1 -> Attention.t1: "2. Retrieve full cache"

Attention.t1 -> Attention.t1_compute: "3. Compute new Kₜ, Vₜ"
Attention.t1_compute -> KV_Cache.t1_append: "4. Append to cache\nKₜ → [K₀...Kₙ₋₁, Kₜ]\nVₜ → [V₀...Vₙ₋₁, Vₜ]"
KV_Cache.t1_append -> Attention.t1_attn: "5. Full cache for attention\nQₜ @ [K₀...Kₜ]ᵀ"
Attention.t1_attn -> Generator.t1_result: "6. Output logits → sample next"

KV_Cache."**KV Cache grows by 1 each step**\n- Initial: O(n²) → decode: O(n) per step\n- Memory: O(layers × heads × seq × d_head)"