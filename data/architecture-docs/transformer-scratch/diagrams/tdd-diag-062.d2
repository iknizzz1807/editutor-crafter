vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # KV Cache: From O(n²) to O(n) Generation
| {near: top-center}

direction: right

naive: "Naive Generation (No Cache)" {
  style.fill: "#FFE4E1"
  style.stroke: "#CD5C5C"
  style.stroke-width: 2
  
  step1: "Step 1: 'The'" {
    style.fill: "#FFF0F0"
    
    tokens1: "Tokens: ['The']" {
      shape: text
      style.font: mono
    }
    encode1: "Encode\nall tokens" {
      style.fill: "#FFB6B6"
    }
    output1: "Output: 'cat'" {
      shape: text
      style.font: mono
    }
    
    tokens1 -> encode1 -> output1
  }
  
  step2: "Step 2: 'The cat'" {
    style.fill: "#FFF0F0"
    
    tokens2: "Tokens: ['The','cat']" {
      shape: text
      style.font: mono
    }
    encode2: "Encode\nALL tokens\nAGAIN" {
      style.fill: "#FF6B6B"
      style.font-color: white
      style.bold: true
    }
    output2: "Output: 'sat'" {
      shape: text
      style.font: mono
    }
    
    tokens2 -> encode2 -> output2
  }
  
  step3: "Step 3: 'The cat sat'" {
    style.fill: "#FFF0F0"
    
    tokens3: "Tokens: ['The','cat','sat']" {
      shape: text
      style.font: mono
    }
    encode3: "Encode\nALL tokens\nAGAIN" {
      style.fill: "#FF6B6B"
      style.font-color: white
      style.bold: true
    }
    output3: "Output: 'on'" {
      shape: text
      style.font: mono
    }
    
    tokens3 -> encode3 -> output3
  }
  
  step1 -> step2 -> step3
}

waste: |md
  **Redundant Work:**
  - Step 2 re-encodes 'The' (already done)
  - Step 3 re-encodes 'The','cat' (already done)
  - Total: O(n²) computations
| {
  near: bottom-left
  style.fill: transparent
}

kvcache: "KV Cache Generation" {
  style.fill: "#E8F5E9"
  style.stroke: "#4CAF50"
  style.stroke-width: 2
  
  step1c: "Step 1: 'The'" {
    style.fill: "#F0FFF0"
    
    tokens1c: "Tokens: ['The']" {
      shape: text
      style.font: mono
    }
    encode1c: "Encode\nnew token" {
      style.fill: "#81C784"
    }
    cache1: "KV Cache:\nK₁, V₁" {
      style.fill: "#A5D6A7"
      shape: cylinder
    }
    output1c: "Output: 'cat'" {
      shape: text
      style.font: mono
    }
    
    tokens1c -> encode1c -> cache1 -> output1c
  }
  
  step2c: "Step 2: 'cat'" {
    style.fill: "#F0FFF0"
    
    tokens2c: "Token: ['cat']" {
      shape: text
      style.font: mono
    }
    encode2c: "Encode\nNEW only" {
      style.fill: "#4CAF50"
      style.font-color: white
      style.bold: true
    }
    cache2: "KV Cache:\nK₁, K₂\nV₁, V₂" {
      style.fill: "#A5D6A7"
      shape: cylinder
    }
    output2c: "Output: 'sat'" {
      shape: text
      style.font: mono
    }
    
    tokens2c -> encode2c -> cache2 -> output2c
    cache1 -> cache2: "append"
  }
  
  step3c: "Step 3: 'sat'" {
    style.fill: "#F0FFF0"
    
    tokens3c: "Token: ['sat']" {
      shape: text
      style.font: mono
    }
    encode3c: "Encode\nNEW only" {
      style.fill: "#4CAF50"
      style.font-color: white
      style.bold: true
    }
    cache3: "KV Cache:\nK₁, K₂, K₃\nV₁, V₂, V₃" {
      style.fill: "#A5D6A7"
      shape: cylinder
    }
    output3c: "Output: 'on'" {
      shape: text
      style.font: mono
    }
    
    tokens3c -> encode3c -> cache3 -> output3c
    cache2 -> cache3: "append"
  }
  
  step1c -> step2c -> step3c
}

benefit: |md
  **Efficiency Gain:**
  - Each token encoded ONCE
  - Cache grows incrementally
  - Total: O(n) computations
| {
  near: bottom-right
  style.fill: transparent
}

naive <-> kvcache: "Same output,\n10-100x faster" {
  style.stroke: "#2196F3"
  style.stroke-width: 3
  style.stroke-dash: 5
}

legend: {
  near: bottom-right
  style.fill: "#F5F5F5"
  
  redundant: "Redundant compute" {
    style.fill: "#FF6B6B"
    style.font-color: white
  }
  efficient: "Efficient (new only)" {
    style.fill: "#4CAF50"
    style.font-color: white
  }
  cached: "Cached KV pairs" {
    style.fill: "#A5D6A7"
    shape: cylinder
  }
}

comparison: {
  near: top-right
  style.fill: "#FFF8E1"
  
  header: "Complexity Comparison" {
    shape: text
    style.bold: true
  }
  
  naive_row: ||md
    | Method | Step n | Total |
    |--------|--------|-------|
    | Naive | O(n) | O(n²) |
    | KV Cache | O(1) | O(n) |
||
}