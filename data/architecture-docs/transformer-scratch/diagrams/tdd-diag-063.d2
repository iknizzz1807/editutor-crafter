vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Temperature Scaling Algorithm
  **Logits → Scaled → Softmax → Probabilities**
| {near: top-center}

step_0_input: "Step 0: Input Logits" {
  logits_raw: {
    shape: sql_table
    token: string {constraint: primary_key}
    logit: float
    --
    "the": 4.2
    "cat": 2.1
    "dog": 1.8
    "a": 0.5
  }
  style.fill: "#E8E4F0"
}

step_1_divide: "Step 1: Divide by Temperature τ" {
  formula: |md
    scaled[i] = logits[i] / τ
  |
  
  temp_controls: {
    grid-columns: 3
    grid-gap: 20
    
    t_low: "τ = 0.5\n(Cold/Sharp)" {
      style.fill: "#FFE4E1"
      style.stroke: "#DC143C"
    }
    t_one: "τ = 1.0\n(Unchanged)" {
      style.fill: "#E8F5E9"
      style.stroke: "#4CAF50"
    }
    t_high: "τ = 2.0\n(Hot/Flat)" {
      style.fill: "#E3F2FD"
      style.stroke: "#2196F3"
    }
  }
  
  style.fill: "#FFF8E1"
}

step_2_special: "Step 2: Handle τ = 0 (Greedy)" {
  greedy_rule: |md
    if τ == 0:
        return one_hot(argmax(logits))
  |
  
  example: {
    before: "Logits: [4.2, 2.1, 1.8, 0.5]"
    after: "Greedy: [1, 0, 0, 0]  (the)"
    style.fill: "#FFEBEE"
  }
  
  style.fill: "#FFCDD2"
}

step_3_softmax: "Step 3: Apply Softmax" {
  formula: |md
    probs[i] = exp(scaled[i]) / Σ exp(scaled[j])
  |
  
  results: {
    grid-columns: 3
    grid-gap: 20
    
    cold_result: "τ = 0.5" {
      shape: sql_table
      token: string {constraint: primary_key}
      prob: float
      --
      "the": "0.89"
      "cat": "0.07"
      "dog": "0.03"
      "a": "0.01"
    }
    
    normal_result: "τ = 1.0" {
      shape: sql_table
      token: string {constraint: primary_key}
      prob: float
      --
      "the": "0.71"
      "cat": "0.15"
      "dog": "0.12"
      "a": "0.02"
    }
    
    hot_result: "τ = 2.0" {
      shape: sql_table
      token: string {constraint: primary_key}
      prob: float
      --
      "the": "0.48"
      "cat": "0.24"
      "dog": "0.21"
      "a": "0.07"
    }
    
    cold_result.style.fill: "#FFCDD2"
    normal_result.style.fill: "#C8E6C9"
    hot_result.style.fill: "#BBDEFB"
  }
  
  style.fill: "#E8F5E9"
}

step_4_output: "Step 4: Sample from Distribution" {
  sampling: |md
    next_token = sample(probs)
    # or: next_token = argmax(probs) for greedy
  |
  style.fill: "#E1F5FE"
}

step_0_input -> step_1_divide: "raw logits"
step_1_divide -> step_2_special: "scaled = logits/τ"
step_2_special -> step_3_softmax: "if τ > 0"
step_3_softmax -> step_4_output: "probability\ndistribution"

legend: {
  near: bottom-center
  grid-columns: 3
  grid-gap: 30
  
  cold: |md
    **τ < 1: Sharper**
    - High prob → higher
    - Low prob → lower
    - More deterministic
  |
  
  normal: |md
    **τ = 1: Unchanged**
    - Original distribution
    - Standard training/generation
  |
  
  hot: |md
    **τ > 1: Flatter**
    - High prob → lower
    - Low prob → higher
    - More random/creative
  |
}

annotation: |md
  Temperature controls exploration vs exploitation:
  - τ → 0: Greedy (always pick most likely)
  - τ = 1: Original learned distribution  
  - τ → ∞: Uniform random (all tokens equally likely)
| {near: bottom-right}