vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

title: |md
  # Length Penalty Formula
  ## Beam Search Hypothesis Reranking
| {near: top-center}

direction: right

formula_section: {
  formula_box: {
    style: {
      fill: "#E8F4FD"
      stroke: "#2196F3"
      stroke-width: 2
      border-radius: 8
    }
    
    formula: |md
      ## **Length-Penalized Score**
      
      
      score(hypothesis) = raw_score / (length ^ α)
      
      
      Where:
      - `raw_score`: Sum of log probabilities
      - `length`: Token count of hypothesis
      - `α`: Length penalty coefficient (typically 0.6-1.0)
    |
  }
}

alpha_values: {
  label: "Typical α Values"
  style.fill: "#FFF3E0"
  style.stroke: "#FF9800"
  
  alpha_06: "α = 0.6\nLenient penalty\nFavors longer output" {
    style.fill: "#C8E6C9"
  }
  
  alpha_07: "α = 0.7\nModerate penalty\nBalanced length" {
    style.fill: "#FFF9C4"
  }
  
  alpha_08: "α = 0.8\nStronger penalty\nCommon default" {
    style.fill: "#FFE0B2"
  }
  
  alpha_10: "α = 1.0\nFull normalization\nLength-independent" {
    style.fill: "#FFCCBC"
  }
}

example_section: {
  label: "Hypothesis Ranking Example"
  
  hypotheses: {
    shape: sql_table
    id: int {constraint: primary_key}
    text: string
    length: int
    raw_score: float
    "α=0.6": float
    "α=1.0": float
  }
  
  before: {
    label: "Without Penalty"
    style.fill: "#FFEBEE"
    
    h1_before: "1. \"The cat sat\"\nraw: -2.1, len: 3" {
      style.fill: "#C8E6C9"
      style.bold: true
    }
    h2_before: "2. \"The cat sat on mat\"\nraw: -4.2, len: 5" {
      style.fill: "#FFF9C4"
    }
    h3_before: "3. \"The cat sat on the mat outside\"\nraw: -8.5, len: 8" {
      style.fill: "#FFCCBC"
    }
  }
  
  after: {
    label: "With α=0.6 Penalty"
    style.fill: "#E8F5E9"
    
    h1_after: "3. \"The cat sat\"\npen: -1.27, len: 3" {
      style.fill: "#FFCCBC"
    }
    h2_after: "1. \"The cat sat on mat\"\npen: -1.46, len: 5" {
      style.fill: "#C8E6C9"
      style.bold: true
    }
    h3_after: "2. \"The cat sat on the mat outside\"\npen: -2.19, len: 8" {
      style.fill: "#FFF9C4"
    }
  }
  
  before -> after: "Rerank" {
    style: {
      stroke: "#4CAF50"
      stroke-width: 3
      animated: true
    }
  }
}

effect_section: {
  label: "Effect on Beam Selection"
  
  short_bias: {
    label: "Low α (0.5-0.6)"
    style.fill: "#E3F2FD"
    
    effect1: |md
      - **Less penalty** on length
      - Longer hypotheses ranked higher
      - More complete translations
      - Risk: Verbose output
    |
  }
  
  balanced: {
    label: "Medium α (0.7-0.8)"
    style.fill: "#F3E5F5"
    
    effect2: |md
      - **Balanced** trade-off
      - Common default choice
      - Works well for most tasks
      - Recommended starting point
    |
  }
  
  long_bias: {
    label: "High α (0.9-1.0)"
    style.fill: "#FFEBEE"
    
    effect3: |md
      - **Strong penalty** on length
      - Shorter hypotheses ranked higher
      - May truncate output early
      - Risk: Incomplete translations
    |
  }
  
  short_bias -> balanced -> long_bias: "Increasing α" {
    style.stroke-dash: 3
  }
}

formula_section -> example_section
example_section -> effect_section

alpha_values -> formula_section: "Configures"

legend: {
  near: bottom-center
  style.fill: "#FAFAFA"
  
  note: |md
    **Key Insight**: Without length penalty, beam search favors shorter hypotheses because 
    fewer tokens = fewer opportunities to accumulate negative log probability. 
    The length penalty counteracts this bias.
  |
}