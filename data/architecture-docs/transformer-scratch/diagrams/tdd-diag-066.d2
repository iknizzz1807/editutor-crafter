vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

shape: sequence_diagram

benchmark: Benchmark Runner
model_nocache: "Model (No KV Cache)"
model_cache: "Model (KV Cache)"
timer: "Timer (ms)"
result: "Speedup Result"

benchmark."Start"

group_no_cache: "Without KV Cache" {
  benchmark.t1 -> timer.t1: "start()"
  benchmark.t1 -> model_nocache.t1: "generate(tokens, use_cache=False)"
  
  model_nocache.t1 -> model_nocache.t1: "Step 1: Q·K^T over ALL 1 tokens"
  model_nocache.t1 -> model_nocache.t1: "Step 2: Q·K^T over ALL 2 tokens"
  model_nocache.t1 -> model_nocache.t2: "Step 3: Q·K^T over ALL 3 tokens"
  model_nocache.t2 -> model_nocache.t2: "..."
  model_nocache.t2 -> model_nocache.t3: "Step N: Q·K^T over ALL N tokens"
  
  model_nocache.t3 -> benchmark.t1: "generated_tokens"
  benchmark.t1 -> timer.t1: "stop()"
  timer.t1 -> benchmark.t1: "time_no_cache (ms)"
}

group_with_cache: "With KV Cache" {
  benchmark.t2 -> timer.t2: "start()"
  benchmark.t2 -> model_cache.t1: "generate(tokens, use_cache=True)"
  
  model_cache.t1 -> model_cache.t1: "Step 1: Q·K^T over 1 token\n  cache K[0], V[0]"
  model_cache.t2 -> model_cache.t2: "Step 2: Q·K^T over 1 new token\n  append K[1], V[1]"
  model_cache.t2 -> model_cache.t3: "Step 3: Q·K^T over 1 new token\n  append K[2], V[2]"
  model_cache.t3 -> model_cache.t4: "..."
  model_cache.t4 -> model_cache.t5: "Step N: Q·K^T over 1 new token\n  append K[N-1], V[N-1]"
  
  model_cache.t5 -> benchmark.t2: "generated_tokens"
  benchmark.t2 -> timer.t2: "stop()"
  timer.t2 -> benchmark.t2: "time_with_cache (ms)"
}

benchmark.t3 -> result.t1: "speedup = time_no_cache / time_with_cache"
result.t1 -> result.t1: "Typical: 2-10x faster\nO(N²) → O(N) per step"

model_nocache.style.fill: "#FFE4E1"
model_nocache.style.stroke: "#CD5C5C"
model_cache.style.fill: "#E0FFE0"
model_cache.style.stroke: "#228B22"
timer.style.fill: "#FFFACD"
result.style.fill: "#E6E6FA"
result.style.stroke: "#9370DB"

model_nocache.t1 -> model_nocache.t1: {
  style.stroke: "#CD5C5C"
  style.stroke-dash: 3
}
model_nocache.t1 -> model_nocache.t2: {
  style.stroke: "#CD5C5C"
  style.stroke-dash: 3
}
model_nocache.t2 -> model_nocache.t2: {
  style.stroke: "#CD5C5C"
  style.stroke-dash: 3
}
model_nocache.t2 -> model_nocache.t3: {
  style.stroke: "#CD5C5C"
  style.stroke-dash: 3
}