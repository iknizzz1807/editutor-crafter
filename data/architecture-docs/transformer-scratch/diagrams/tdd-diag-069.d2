vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 200
  }
}

shape: sequence_diagram

"Input: 'The cat sat'"
Encoder
Decoder
KV_Cache: "KV Cache"
Output: "Generated Token"

Encoding: {
  "Input: 'The cat sat'" -> Encoder.t1: Tokenize + Embed
  Encoder.t1 -> Encoder.t1: "Self-Attention\n(all positions)"
  Encoder.t1 -> Encoder.t1: "FFN + LayerNorm"
  Encoder.t1 -> Encoder: "Encoder Output\n(memory)"
}

Decoding_Step_1: {
  Encoder -> Decoder.t1: Cross-attention K,V
  Decoder.t1 -> Decoder.t1: "Self-Attention\n(masked)"
  Decoder.t1 -> KV_Cache.t1: "Store K,V for\n' The'"
  Decoder.t1 -> Output.t1: "on'"
  Output.t1 -> "Input: 'The cat sat'": "Append to output"
}

Decoding_Step_2: {
  Encoder -> Decoder.t2: Cross-attention K,V
  Decoder.t2 -> KV_Cache.t1: "Retrieve cached\nK,V for ' The'"
  Decoder.t2 -> Decoder.t2: "Self-Attention\n(masked, uses cache)"
  Decoder.t2 -> KV_Cache.t2: "Store K,V for\n' on'"
  Decoder.t2 -> Output.t2: "the'"
  Output.t2 -> "Input: 'The cat sat'": "Append to output"
}

Decoding_Step_3: {
  Encoder -> Decoder.t3: Cross-attention K,V
  Decoder.t3 -> KV_Cache.t2: "Retrieve cached\nK,V for ' The on'"
  Decoder.t3 -> Decoder.t3: "Self-Attention\n(masked, uses cache)"
  Decoder.t3 -> KV_Cache.t3: "Store K,V for\n' the'"
  Decoder.t3 -> Output.t3: "mat'"
  Output.t3 -> "Input: 'The cat sat'": "Append to output"
}

Final: {
  Output.t3 -> Output: "'on the mat' âœ“"
}

Encoder: {
  style.fill: "#E8D5E8"
  style.stroke: "#9B59B6"
  style.font-color: "#6C3483"
}

Decoder: {
  style.fill: "#D5E8D5"
  style.stroke: "#27AE60"
  style.font-color: "#1E8449"
}

KV_Cache: {
  style.fill: "#FFF9C4"
  style.stroke: "#F39C12"
  style.font-color: "#B7950B"
}

Output: {
  style.fill: "#D6EAF8"
  style.stroke: "#3498DB"
  style.font-color: "#2471A3"
}

"Input: 'The cat sat'": {
  style.fill: "#FADBD8"
  style.stroke: "#E74C3C"
  style.font-color: "#922B21"
}