vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}
direction: down
title: |md
  # Monorepo Directory Tree — url-shortener
  Go module paths · Container name mapping
| {near: top-center}
root: "url-shortener/  (repo root)" {
  style.fill: "#f0f0f0"
  style.stroke: "#999"
  style.border-radius: 6
  style.bold: true
  compose: "docker-compose.yml" {
    style.fill: "#e8f5e9"
    style.stroke: "#388e3c"
    style.border-radius: 4
  }
  env: ".env.example" {
    style.fill: "#e8f5e9"
    style.stroke: "#388e3c"
    style.border-radius: 4
  }
  readme: "README.md" {
    style.fill: "#e8f5e9"
    style.stroke: "#388e3c"
    style.border-radius: 4
  }
  shared: "shared/" {
    style.fill: "#ede7f6"
    style.stroke: "#7b1fa2"
    style.border-radius: 5
    style.bold: true
    events_dir: "events/" {
      style.fill: "#ede7f6"
      style.stroke: "#9c27b0"
      style.border-radius: 4
      events_go: |md
        **events.go**
        `package events`
        DomainEvent interface
        URLCreatedEvent
        URLClickedEvent
        URLDeletedEvent
        MilestoneReachedEvent
        EventType constants
      |
    }
    logger_dir: "logger/" {
      style.fill: "#ede7f6"
      style.stroke: "#9c27b0"
      style.border-radius: 4
      logger_go: |md
        **logger.go**
        `package logger`
        New(serviceName, w) zerolog.Logger
        WithCorrelationID(log, id)
        RequestLogger(log) middleware
      |
    }
    auth_dir: "auth/" {
      style.fill: "#ede7f6"
      style.stroke: "#9c27b0"
      style.border-radius: 4
      auth_go: |md
        **types.go**
        `package auth`
        JWTVerifier interface
        Claims struct
        Sentinel errors
      |
    }
    middleware_dir: "middleware/" {
      style.fill: "#ede7f6"
      style.stroke: "#9c27b0"
      style.border-radius: 4
      mw_go: |md
        **jwt_middleware.go**
        `package middleware`
        RequireAuth(verifier, log)
        ClaimsFromContext(ctx)
      |
    }
    shared_mod: |md
      **go.mod**
      `module github.com/yourhandle/`
      `url-shortener/shared`
      `go 1.23`
      dep: zerolog v1.33.0
    | {
      style.fill: "#f3e5f5"
      style.stroke: "#7b1fa2"
      style.border-radius: 4
    }
  }
  services: "services/" {
    style.fill: "#e3f2fd"
    style.stroke: "#1565c0"
    style.border-radius: 5
    style.bold: true
    url_svc: "url-service/" {
      style.fill: "#bbdefb"
      style.stroke: "#1976d2"
      style.border-radius: 5
      url_mod: |md
        **go.mod**
        `module github.com/yourhandle/`
        `url-shortener/url-service`
        `go 1.23`
        replace shared → ../../shared
      | {style.fill: "#e3f2fd"; style.stroke: "#1976d2"; style.border-radius: 4}
      url_main: |md
        **main.go**
        ConnectDB · ConnectRedis
        ConnectRabbitMQ
        OutboxPoller.Start()
        Routes: GET /{code}
        POST /shorten
        GET /urls
        DELETE /urls/{code}
        GET /health
      | {style.fill: "#e3f2fd"; style.stroke: "#1976d2"; style.border-radius: 4}
      url_dockerfile: |md
        **Dockerfile**
        FROM golang:1.23-alpine AS builder
        FROM alpine:3.20
        EXPOSE 8081
      | {style.fill: "#e3f2fd"; style.stroke: "#1976d2"; style.border-radius: 4}
      url_pkgs: |md
        **packages/**
        codegen/ · repository/
        cache/ · amqp/
        outbox/ · service/
        handler/ · migrations/
      | {style.fill: "#e3f2fd"; style.stroke: "#1976d2"; style.border-radius: 4}
      url_container: |md
        **container:** `url-service`
        port: 8081 → 8081
        DB: `url_db:5432`
        Redis: `redis:6379`
        MQ: `rabbitmq:5672`
      | {
        style.fill: "#1976d2"
        style.font-color: white
        style.border-radius: 4
      }
    }
    analytics_svc: "analytics-service/" {
      style.fill: "#c8e6c9"
      style.stroke: "#388e3c"
      style.border-radius: 5
      an_mod: |md
        **go.mod**
        `module github.com/yourhandle/`
        `url-shortener/analytics-service`
        `go 1.23`
        replace shared → ../../shared
      | {style.fill: "#e8f5e9"; style.stroke: "#388e3c"; style.border-radius: 4}
      an_main: |md
        **main.go**
        ConnectDB · ConnectRabbitMQ
        ClickProcessor consumer
        Routes: GET /stats/{code}
        GET /stats/{code}/timeline
        GET /health
      | {style.fill: "#e8f5e9"; style.stroke: "#388e3c"; style.border-radius: 4}
      an_dockerfile: |md
        **Dockerfile**
        FROM golang:1.23-alpine AS builder
        FROM alpine:3.20
        EXPOSE 8082
      | {style.fill: "#e8f5e9"; style.stroke: "#388e3c"; style.border-radius: 4}
      an_pkgs: |md
        **packages/**
        repository/ · consumer/
        milestone/ · publisher/
        handler/ · migrations/
      | {style.fill: "#e8f5e9"; style.stroke: "#388e3c"; style.border-radius: 4}
      an_container: |md
        **container:** `analytics-service`
        port: 8082 → 8082
        DB: `analytics_db:5432`
        MQ: `rabbitmq:5672`
        queue: `analytics.clicks`
      | {
        style.fill: "#388e3c"
        style.font-color: white
        style.border-radius: 4
      }
    }
    user_svc: "user-service/" {
      style.fill: "#fff3e0"
      style.stroke: "#e65100"
      style.border-radius: 5
      us_mod: |md
        **go.mod**
        `module github.com/yourhandle/`
        `url-shortener/user-service`
        `go 1.23`
        replace shared → ../../shared
      | {style.fill: "#fff8e1"; style.stroke: "#e65100"; style.border-radius: 4}
      us_main: |md
        **main.go**
        ConnectDB · ConnectRabbitMQ
        Routes: POST /register
        POST /login
        GET /me (auth)
        GET /health
      | {style.fill: "#fff8e1"; style.stroke: "#e65100"; style.border-radius: 4}
      us_dockerfile: |md
        **Dockerfile**
        FROM golang:1.23-alpine AS builder
        FROM alpine:3.20
        EXPOSE 8083
      | {style.fill: "#fff8e1"; style.stroke: "#e65100"; style.border-radius: 4}
      us_pkgs: |md
        **packages/**
        repository/ · auth/
        service/ · handler/
        migrations/
      | {style.fill: "#fff8e1"; style.stroke: "#e65100"; style.border-radius: 4}
      us_container: |md
        **container:** `user-service`
        port: 8083 → 8083
        DB: `user_db:5432`
        MQ: `rabbitmq:5672`
        JWT_SECRET (issues + verifies)
      | {
        style.fill: "#e65100"
        style.font-color: white
        style.border-radius: 4
      }
    }
    notif_svc: "notification-service/" {
      style.fill: "#fce4ec"
      style.stroke: "#880e4f"
      style.border-radius: 5
      no_mod: |md
        **go.mod**
        `module github.com/yourhandle/`
        `url-shortener/notification-service`
        `go 1.23`
        replace shared → ../../shared
      | {style.fill: "#fce4ec"; style.stroke: "#880e4f"; style.border-radius: 4}
      no_main: |md
        **main.go**
        ConnectDB · ConnectRabbitMQ
        NotificationProcessor consumer
        Routes: GET /notifications (auth)
        GET /health
      | {style.fill: "#fce4ec"; style.stroke: "#880e4f"; style.border-radius: 4}
      no_dockerfile: |md
        **Dockerfile**
        FROM golang:1.23-alpine AS builder
        FROM alpine:3.20
        EXPOSE 8084
      | {style.fill: "#fce4ec"; style.stroke: "#880e4f"; style.border-radius: 4}
      no_pkgs: |md
        **packages/**
        repository/ · consumer/
        handler/ · migrations/
      | {style.fill: "#fce4ec"; style.stroke: "#880e4f"; style.border-radius: 4}
      no_container: |md
        **container:** `notification-service`
        port: 8084 → 8084
        DB: `notification_db:5432`
        MQ: `rabbitmq:5672`
        queue: `notifications.events`
      | {
        style.fill: "#880e4f"
        style.font-color: white
        style.border-radius: 4
      }
    }
  }
  gateway: "gateway/" {
    style.fill: "#e8eaf6"
    style.stroke: "#283593"
    style.border-radius: 5
    style.bold: true
    gw_mod: |md
      **go.mod**
      `module github.com/yourhandle/`
      `url-shortener/gateway`
      `go 1.23`
      replace shared → ../shared
    | {style.fill: "#e8eaf6"; style.stroke: "#283593"; style.border-radius: 4}
    gw_main: |md
      **main.go**
      ConnectRedis (rate limits)
      NewJWTVerifier
      NewCircuitBreaker
      NewReverseProxy (4 targets)
      Startup health checks
      Middleware: Correlation
        RequestLogger
        GatewayJWT
        RateLimit
        CircuitBreaker
    | {style.fill: "#e8eaf6"; style.stroke: "#283593"; style.border-radius: 4}
    gw_dockerfile: |md
      **Dockerfile**
      FROM golang:1.23-alpine AS builder
      FROM alpine:3.20
      EXPOSE 8080
    | {style.fill: "#e8eaf6"; style.stroke: "#283593"; style.border-radius: 4}
    gw_pkgs: |md
      **packages/**
      circuitbreaker/ · ratelimit/
      proxy/ · middleware/
      handler/ · router/
    | {style.fill: "#e8eaf6"; style.stroke: "#283593"; style.border-radius: 4}
    gw_container: |md
      **container:** `gateway`
      port: 8080 → 8080
      Redis: `redis:6379` (rate limits)
      JWT_SECRET (verify only)
      Routes all /api/* + /r/{code}
    | {
      style.fill: "#283593"
      style.font-color: white
      style.border-radius: 4
    }
  }
}
legend: |md
  **Legend**
  Purple = shared packages (imported by all services via replace directive)
  Blue   = url-service  (container: url-service, port 8081)
  Green  = analytics-service  (container: analytics-service, port 8082)
  Orange = user-service  (container: user-service, port 8083)
  Pink   = notification-service  (container: notification-service, port 8084)
  Indigo = gateway  (container: gateway, port 8080)
  Dark boxes = Docker container identity + network bindings
| {
  near: bottom-center
  style.fill: "#fafafa"
  style.stroke: "#bdbdbd"
  style.border-radius: 6
}
root.shared -> root.services.url_svc: "replace ../../shared" {
  style.stroke-dash: 5
  style.stroke: "#7b1fa2"
  style.font-color: "#7b1fa2"
}
root.shared -> root.services.analytics_svc: "replace ../../shared" {
  style.stroke-dash: 5
  style.stroke: "#7b1fa2"
}
root.shared -> root.services.user_svc: "replace ../../shared" {
  style.stroke-dash: 5
  style.stroke: "#7b1fa2"
}
root.shared -> root.services.notif_svc: "replace ../../shared" {
  style.stroke-dash: 5
  style.stroke: "#7b1fa2"
}
root.shared -> root.gateway: "replace ../shared" {
  style.stroke-dash: 5
  style.stroke: "#7b1fa2"
}
root.compose -> root.services.url_svc: "builds + configures" {
  style.stroke: "#388e3c"
  style.stroke-dash: 3
}
root.compose -> root.services.analytics_svc: "builds + configures" {
  style.stroke: "#388e3c"
  style.stroke-dash: 3
}
root.compose -> root.services.user_svc: "builds + configures" {
  style.stroke: "#388e3c"
  style.stroke-dash: 3
}
root.compose -> root.services.notif_svc: "builds + configures" {
  style.stroke: "#388e3c"
  style.stroke-dash: 3
}
root.compose -> root.gateway: "builds + configures" {
  style.stroke: "#388e3c"
  style.stroke-dash: 3
}