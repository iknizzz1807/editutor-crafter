vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}
direction: right
title: |md
  ## POST /register Data Flow
  `handler.NewRegisterHandler` → `UserService.Register` → `pgxUserRepository.Create`
| {near: top-center}
client: "HTTP Client" {
  shape: rectangle
  style.fill: "#e8f4f8"
  style.stroke: "#2980b9"
  style.bold: true
}
decode: "json.Decode\n(MaxBytesReader 1024B)" {
  shape: rectangle
  style.fill: "#d5e8d4"
  style.stroke: "#27ae60"
}
validate_email: "ValidateEmail\nnet/mail.ParseAddress()" {
  shape: rectangle
  style.fill: "#d5e8d4"
  style.stroke: "#27ae60"
}
validate_pass: "ValidatePassword\nlen(password) >= 8" {
  shape: rectangle
  style.fill: "#d5e8d4"
  style.stroke: "#27ae60"
}
normalize: "strings.ToLower\nstrings.TrimSpace" {
  shape: rectangle
  style.fill: "#d5e8d4"
  style.stroke: "#27ae60"
}
bcrypt: "bcrypt.GenerateFromPassword\n(cost = 12  ~100ms)" {
  shape: rectangle
  style.fill: "#dae8fc"
  style.stroke: "#2471a3"
  style.bold: true
}
uuid_gen: "uuid.New()\ngithub.com/google/uuid" {
  shape: rectangle
  style.fill: "#dae8fc"
  style.stroke: "#2471a3"
}
build_user: "Build User{}\nID, Email, PasswordHash" {
  shape: rectangle
  style.fill: "#dae8fc"
  style.stroke: "#2471a3"
}
repo_create: "pgxUserRepository.Create()\npgx.Tx  INSERT INTO users" {
  shape: rectangle
  style.fill: "#e1d5e7"
  style.stroke: "#7d3c98"
  style.bold: true
}
pg_insert: |md
  **PostgreSQL**
  `url_db.users`
  INSERT (id, email, password_hash)
| {
  shape: cylinder
  style.fill: "#f5cba7"
  style.stroke: "#e67e22"
}
resp_201: "201 Created\n{user_id, email}" {
  shape: rectangle
  style.fill: "#d5e8d4"
  style.stroke: "#1e8449"
  style.bold: true
}
err_400_body: "400 Bad Request\n{error: invalid request body}" {
  shape: rectangle
  style.fill: "#fadbd8"
  style.stroke: "#c0392b"
}
err_400_email: "400 Bad Request\n{error: email format is invalid}" {
  shape: rectangle
  style.fill: "#fadbd8"
  style.stroke: "#c0392b"
}
err_400_pass: "400 Bad Request\n{error: password must be at least 8 characters}" {
  shape: rectangle
  style.fill: "#fadbd8"
  style.stroke: "#c0392b"
}
err_409: "409 Conflict\n{error: email already registered}" {
  shape: rectangle
  style.fill: "#fadbd8"
  style.stroke: "#c0392b"
}
err_500: "500 Internal Server Error\n{error: internal server error}\n+ log.Error(err)" {
  shape: rectangle
  style.fill: "#fadbd8"
  style.stroke: "#922b21"
  style.bold: true
}
client -> decode: "HTTP POST /register\nContent-Type: application/json\nbody: []byte (max 1024B)"
decode -> err_400_body: "io.EOF / json.SyntaxError\nerr != nil → 400" {
  style.stroke: "#c0392b"
  style.stroke-dash: 4
}
decode -> validate_email: "RegisterRequest{Email, Password}\n(string, string)"
validate_email -> err_400_email: "mail.ParseAddress() err != nil\nor addr.Address != trimmed → 400" {
  style.stroke: "#c0392b"
  style.stroke-dash: 4
}
validate_email -> validate_pass: "string (trimmed email)"
validate_pass -> err_400_pass: "len(password) < 8 → 400" {
  style.stroke: "#c0392b"
  style.stroke-dash: 4
}
validate_pass -> normalize: "string (raw password)"
normalize -> bcrypt: "string (normalized email)\nstring (plaintext password)"
bcrypt -> uuid_gen: '[]byte (bcrypt hash, 60 chars)\n"$2a$12$..."'
uuid_gen -> build_user: "string (UUID v4)\n'550e8400-e29b-41d4-...'"
build_user -> repo_create: |md
  `repository.User{`
  `  ID:           string (UUID v4)`
  `  Email:        string (normalized)`
  `  PasswordHash: string (60-char bcrypt)`
  `  CreatedAt:    time.Time (zero — DB sets)`
  `}`
|
repo_create -> pg_insert: 'pgx.Tx\nINSERT INTO users (id, email, password_hash)\nVALUES ($1, $2, $3)'
pg_insert -> repo_create: "sql.Result (rowsAffected=1)\nor pgconn.PgError{Code: '23505'}"
repo_create -> err_409: "pgconn.PgError.Code == '23505'\n(unique_violation on email)\nErrDuplicateEmail → 409" {
  style.stroke: "#c0392b"
  style.stroke-dash: 4
}
repo_create -> err_500: "other pgconn.PgError\nor pool error → 500" {
  style.stroke: "#922b21"
  style.stroke-dash: 4
}
repo_create -> resp_201: 'nil error\nrepository.User{ID, Email}\n→ 201 {user_id, email}'
note_bcrypt: |'md
  **bcrypt invariants**
  - cost=12 → ~100ms CPU
  - output always 60 ASCII chars
  - $2a$12$ prefix verifiable
  - plaintext NEVER stored or logged
  - MaxBytesReader(1024B) prevents
    DoS via oversized bcrypt input
'| {
  near: bottom-center
  style.fill: "#fdfefe"
  style.stroke: "#aab7b8"
}