vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}
direction: right
title: |md
  ## POST /login Data Flow + Email Enumeration Prevention
  *Branch A (user not found) runs identical bcrypt cost to prevent timing-based email enumeration*
| {near: top-center}

client: "Client" {
  shape: rectangle
  style.fill: "#E8F4F8"
  style.stroke: "#2196F3"
  style.font-size: 13
}

req: |md
  **POST /login**
  json
  {
    "email": "x@ex.com",
    "password": "secret"
  }
| {
  near: top-left
  style.font-size: 12
}

handler: "LoginHandler\nhandler/login.go" {
  shape: rectangle
  style.fill: "#EDE7F6"
  style.stroke: "#7B1FA2"
  style.font-size: 13
}

svc: "UserService\nservice/user_service.go" {
  shape: rectangle
  style.fill: "#EDE7F6"
  style.stroke: "#7B1FA2"
  style.font-size: 13
}

repo: "pgxUserRepository\nrepository/user_repository.go" {
  shape: rectangle
  style.fill: "#E3F2FD"
  style.stroke: "#1565C0"
  style.font-size: 13
}

db: "users table\nuser_db (PostgreSQL)" {
  shape: cylinder
  style.fill: "#E8EAF6"
  style.stroke: "#283593"
  style.font-size: 13
}

client -> handler: "POST /login\n{email, password}" {
  style.stroke: "#2196F3"
  style.font-size: 12
}

handler -> svc: "Login(ctx, email, password)" {
  style.stroke: "#7B1FA2"
  style.font-size: 12
}

svc -> repo: "FindByEmail(ctx, email)" {
  style.stroke: "#1565C0"
  style.font-size: 12
}

repo -> db: 'SELECT id, email,\npassword_hash\nFROM users\nWHERE email = $1' {
  style.stroke: "#1565C0"
  style.stroke-dash: 3
  style.font-size: 11
}

branch_gate: "Row Returned?" {
  shape: diamond
  style.fill: "#FFF9C4"
  style.stroke: "#F57F17"
  style.font-size: 13
  style.bold: true
}

db -> branch_gate: "query result" {
  style.stroke: "#1565C0"
  style.stroke-dash: 3
  style.font-size: 11
}

branch_a: "Branch A — User NOT Found" {
  style.fill: "#FFF3E0"
  style.stroke: "#E65100"
  style.stroke-width: 2
  style.font-size: 12
  style.bold: true
  decoy: "bcrypt.CompareHashAndPassword\n(dummyHash, password)" {
    shape: rectangle
    style.fill: "#FF6F00"
    style.font-color: "#FFFFFF"
    style.stroke: "#BF360C"
    style.stroke-width: 3
    style.font-size: 13
    style.bold: true
  }
  annotation: |md
    **⚠ EMAIL ENUMERATION MITIGATION**
    `dummyHash` = pre-computed bcrypt cost=12 string
    *Runs identical ~100ms CPU work regardless of*
    *whether the email exists in the database.*
    *Without this, unknown emails return in ~0ms,*
    *leaking which addresses are registered.*
  | {
    style.font-size: 11
    style.fill: "#FFE0B2"
    style.stroke: "#E65100"
  }
  decoy -> annotation: "" {
    style.stroke: "#E65100"
    style.stroke-dash: 4
    style.font-size: 10
  }
  err_a: "return ErrAuthFailed\n(\"invalid credentials\")" {
    shape: rectangle
    style.fill: "#FFCDD2"
    style.stroke: "#B71C1C"
    style.font-size: 12
  }
  decoy -> err_a: "always mismatch\n(decoy never matches)" {
    style.stroke: "#B71C1C"
    style.font-size: 11
  }
}

branch_b: "Branch B — User Found" {
  style.fill: "#E8F5E9"
  style.stroke: "#1B5E20"
  style.stroke-width: 2
  style.font-size: 12
  style.bold: true
  real_compare: "bcrypt.CompareHashAndPassword\n(storedHash, password)" {
    shape: rectangle
    style.fill: "#2E7D32"
    style.font-color: "#FFFFFF"
    style.stroke: "#1B5E20"
    style.stroke-width: 2
    style.font-size: 13
    style.bold: true
  }
  compare_gate: "Match?" {
    shape: diamond
    style.fill: "#F9FBE7"
    style.stroke: "#827717"
    style.font-size: 13
    style.bold: true
  }
  err_b: "return ErrAuthFailed\n(\"invalid credentials\")" {
    shape: rectangle
    style.fill: "#FFCDD2"
    style.stroke: "#B71C1C"
    style.font-size: 12
  }
  sign: "JWTSigner.Sign(Claims{\n  Sub:   user.ID,\n  Email: user.Email,\n  Exp:   now+24h,\n  Iss:   \"url-shortener\"\n})" {
    shape: rectangle
    style.fill: "#1565C0"
    style.font-color: "#FFFFFF"
    style.stroke: "#0D47A1"
    style.font-size: 12
  }
  real_compare -> compare_gate: "bcrypt result\n(~100ms CPU)" {
    style.stroke: "#2E7D32"
    style.font-size: 11
  }
  compare_gate -> err_b: "NO — mismatch" {
    style.stroke: "#B71C1C"
    style.font-size: 11
  }
  compare_gate -> sign: "YES — password valid" {
    style.stroke: "#1565C0"
    style.font-size: 11
  }
}

branch_gate -> branch_a: "NO — ErrUserNotFound" {
  style.stroke: "#E65100"
  style.stroke-width: 2
  style.font-size: 12
  style.bold: true
}

branch_gate -> branch_b: "YES — User{} returned" {
  style.stroke: "#1B5E20"
  style.stroke-width: 2
  style.font-size: 12
  style.bold: true
}

resp_401_a: "HTTP 401\n{\"error\":\"invalid credentials\"}" {
  shape: rectangle
  style.fill: "#FFCDD2"
  style.stroke: "#B71C1C"
  style.font-size: 12
  style.bold: true
}

resp_401_b: "HTTP 401\n{\"error\":\"invalid credentials\"}" {
  shape: rectangle
  style.fill: "#FFCDD2"
  style.stroke: "#B71C1C"
  style.font-size: 12
  style.bold: true
}

resp_200: "HTTP 200\n{\"token\": \"eyJ...\",\n \"expires_at\": \"2026-03-03T...Z\"}" {
  shape: rectangle
  style.fill: "#C8E6C9"
  style.stroke: "#1B5E20"
  style.font-size: 12
  style.bold: true
}

branch_a.err_a -> resp_401_a: "handler writes 401" {
  style.stroke: "#B71C1C"
  style.font-size: 11
}

branch_b.err_b -> resp_401_b: "handler writes 401" {
  style.stroke: "#B71C1C"
  style.font-size: 11
}

branch_b.sign -> resp_200: "HMAC-SHA256 signed\n token string" {
  style.stroke: "#1565C0"
  style.font-size: 11
}

timing_note: |'md
  **Timing Guarantee**
  | Path | bcrypt work | Response time |
  |------|------------|--------------|
  | Branch A (unknown email) | `dummyHash` ≈ 100ms | ~100ms |
  | Branch B + wrong password | `storedHash` ≈ 100ms | ~100ms |
  | Branch B + correct password | `storedHash` ≈ 100ms | ~100ms |
  All three paths consume identical CPU time.
  An attacker cannot distinguish registered vs. unregistered emails by timing.
'| {
  near: bottom-center
  style.font-size: 11
  style.fill: "#FFF8E1"
  style.stroke: "#F9A825"
}

resp_401_a -> client: "identical body\n& status" {
  style.stroke: "#B71C1C"
  style.stroke-dash: 3
  style.font-size: 11
}

resp_401_b -> client: "identical body\n& status" {
  style.stroke: "#B71C1C"
  style.stroke-dash: 3
  style.font-size: 11
}

resp_200 -> client: "200 OK + JWT" {
  style.stroke: "#1B5E20"
  style.font-size: 11
}