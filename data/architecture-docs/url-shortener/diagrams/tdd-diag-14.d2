direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |md
  # URL Service Module Architecture — M3
  `sizeof` annotations · solid=owns · dashed=references · hollow-triangle=implements
| {near: top-center}

# ─── Domain Entities (Memory Layout Style) ───────────────────────────────────
domain: "Domain Entities (Memory Layout)" {
  style.fill: "#1e1b4b"
  style.stroke: "#6d28d9"
  style.font-color: white
  
  URL: {
    shape: sql_table
    style.fill: "#6d28d9" # Header: Purple
    
    00: "ID [16B] (UUID v4)" {constraint: PK; style.fill: "#3b82f6"} # Data: Blue
    16: "ShortCode [7B] (ASCII)" {constraint: UNQ; style.fill: "#3b82f6"}
    23: "Padding [1B]" {style.fill: "#6b7280"} # Padding: Gray
    24: "OriginalURL [16B] (String Header)" {style.fill: "#3b82f6"}
    40: "UserID [16B] (String Header)" {style.fill: "#3b82f6"}
    56: "CreatedAt [8B] (int64 nsec)" {style.fill: "#3b82f6"}
    64: "ExpiresAt [8B] (*int64)" {style.fill: "#3b82f6"}
    72: "IsActive [1B] (bool)" {style.fill: "#3b82f6"}
    73: "Padding [7B]" {style.fill: "#6b7280"}
  }

  CachedURL: {
    shape: class
    style.fill: "#3b82f6" # Data: Blue
    style.stroke: "#7c3aed"
    OriginalURL: "string  `json:\"original_url\"`"
    ExpiresAt: "*time.Time  `json:\"expires_at,omitempty\"`"
    IsActive: "bool  `json:\"is_active\"`"
  }
  
  OutboxRow: {
    shape: class
    style.fill: "#3b82f6"
    style.stroke: "#7c3aed"
    ID: "string (UUID v4)" {constraint: PK}
    EventType: "string (Routing Key)"
    Payload: "[]byte (JSONB)"
    CreatedAt: "time.Time"
    PublishedAt: "*time.Time"
  }

  url_sizeof: "sizeof=80 bytes (aligned)" {
    shape: text
    style.font-color: gray
  }
}

# ─── Interfaces (Contracts) ───────────────────────────────────────────────────
interfaces: "Interfaces (Contracts)" {
  style.fill: "#14532d"
  style.stroke: "#22c55e"
  
  URLRepository: {
    shape: class
    style.fill: "#22c55e" # Free/Interface: Green
    "Create(ctx, tx, URL) error"
    "FindByCode(ctx, code) (URL, error)"
    "ListByUser(ctx, uid, cursor, lim) ([]Summary, error)"
  }
  CacheClient: {
    shape: class
    style.fill: "#22c55e"
    "Get(ctx, code) (CachedURL, error)"
    "Set(ctx, code, CachedURL, TTL)"
  }
  AMQPPublisher: {
    shape: class
    style.fill: "#22c55e"
    "Publish(ctx, key, payload) error"
  }
}

# ─── Implementations ──────────────────────────────────────────────────────────
impls: "Implementations" {
  style.fill: "#0f172a"
  
  pgxRepo: "pgxURLRepository" {
    shape: class
    style.fill: "#1e3a8a"
    pool: "*pgxpool.Pool"
  }
  redisCache: "redisCacheClient" {
    shape: class
    style.fill: "#1e3a8a"
    client: "*redis.Client"
  }
  rabbitPub: "amqpPublisher" {
    shape: class
    style.fill: "#1e3a8a"
    ch: "*amqp091.Channel"
    mu: "sync.Mutex"
  }
}

# ─── Service Layer ────────────────────────────────────────────────────────────
svc: URLService {
  shape: class
  style.fill: "#7c2d12"
  style.stroke: "#f97316"
  style.font-color: white

  urlRepo: "URLRepository"
  cache: "CacheClient"
  codegen: "CodeGenerator"
  log: "zerolog.Logger"

  "Shorten(ctx, url, userID) (URL, error)"
  "Redirect(ctx, code) (string, error)"

  svc_meta: "sizeof=64 bytes (goroutine-safe)" {
    shape: text
    style.font-color: "#fb923c"
  }
}

# ─── Outbox Worker Pool ───────────────────────────────────────────────────────
outbox_pool: "OutboxPoller" {
  style.fill: "#4a1942"
  style.stroke: "#c026d3"
  
  coordinator: "Coordinator" {
    tick: "time.Ticker(2s)"
  }
  jobChan: "Job Queue" {
    shape: queue
    style.fill: "#86198f"
  }
  workers: "Worker Pool (x3)" {
    style.multiple: true
    style.fill: "#6b21a8"
  }
  
  coordinator -> jobChan: "fetch entries"
  jobChan -> workers: "process"
}

# ─── Infrastructure ───────────────────────────────────────────────────────────
infra: "Infrastructure" {
  postgres: "PostgreSQL" {
    shape: cylinder
    style.fill: "#1e293b"
  }
  redis: "Redis" {
    shape: cylinder
    style.fill: "#1e293b"
  }
  rabbitmq: "RabbitMQ" {
    shape: cylinder
    style.fill: "#1e293b"
  }
}

# ─── Relationships (Strict Logic) ─────────────────────────────────────────────

# Implementations (Hollow Triangle = Implements)
impls.pgxRepo -> interfaces.URLRepository: {
  target-arrowhead: * { shape: triangle; style.filled: false }
  style.stroke: "#22c55e"
}
impls.redisCache -> interfaces.CacheClient: {
  target-arrowhead: * { shape: triangle; style.filled: false }
  style.stroke: "#22c55e"
}
impls.rabbitPub -> interfaces.AMQPPublisher: {
  target-arrowhead: * { shape: triangle; style.filled: false }
  style.stroke: "#22c55e"
}

# Composition (Solid = Owns)
svc -> interfaces.URLRepository: { style.stroke: "#f97316"; style.stroke-width: 2 }
svc -> interfaces.CacheClient: { style.stroke: "#f97316"; style.stroke-width: 2 }

# Worker Connections (Dashed = References)
outbox_pool.workers -> interfaces.AMQPPublisher: { style.stroke-dash: 4; label: "Publish" }

# Infrastructure (Dashed = References)
impls.pgxRepo -> infra.postgres: { style.stroke-dash: 3 }
impls.redisCache -> infra.redis: { style.stroke-dash: 3 }
impls.rabbitPub -> infra.rabbitmq: { style.stroke-dash: 3 }

# Data references (Orange = Pointers)
interfaces.URLRepository -> domain.URL: { style.stroke-dash: 5; style.stroke: "#f97316" }