vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

direction: down

title: {
  label: |'md
    ## urls + outbox Table Schema and Index Layout
    **Migration 001_create_urls.sql Â· Migration 002_create_outbox.sql**
  '|
  near: top-center
}

# â”€â”€ TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tables: "PostgreSQL Schema" {
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a8a"
    stroke-width: 2
    border-radius: 6
    font-color: white
    bold: true
    font-size: 16
  }

  urls_table: "TABLE: urls" {
    style: {
      fill: "#16213e"
      stroke: "#7b68ee"
      stroke-width: 2
      border-radius: 4
    }
    header: {
      label: |'md
        **urls** â€” url_db.public.urls
      '|
      style: {
        fill: "#6a0dad"
        stroke: "#9b59b6"
        font-color: white
        bold: true
      }
    }
    col_id: {
      label: |'md
        | Offset | Column | Type | Constraint | Default |
        |--------|--------|------|------------|---------|
        | 0 | **id** | UUID (16 B) | PRIMARY KEY Â· NOT NULL | gen_random_uuid() |
        | 16 | **short_code** | VARCHAR(10) | NOT NULL Â· UNIQUE â†’ idx | â€” |
        | 26 | **original_url** | TEXT (variable) | NOT NULL | â€” |
        | +8 | **user_id** | UUID (16 B) | NOT NULL â†’ idx | â€” |
        | +16 | **created_at** | TIMESTAMPTZ (8 B) | NOT NULL | now() |
        | +8 | **expires_at** | TIMESTAMPTZ (8 B) | NULL | NULL |
        | +8 | **is_active** | BOOLEAN (1 B) | NOT NULL | true |
      '|
    }
    note_urls: {
      label: |'md
        **Storage notes**
        - VARCHAR(10): enforces â‰¤ 10 chars for short_code
        - TEXT: variable-length; toasted if original_url > 2 kB
        - TIMESTAMPTZ: UTC int64 microseconds since epoch (8 B)
        - BOOLEAN: 1 byte; PostgreSQL aligns to 8-byte boundary
        - **Estimated row size**: ~120 B average
      '|
      style: {
        fill: "#0d1b2a"
        stroke: "#4a4a8a"
        font-color: "#a0b0c0"
        font-size: 13
      }
    }
  }

  outbox_table: "TABLE: outbox" {
    style: {
      fill: "#16213e"
      stroke: "#e67e22"
      stroke-width: 2
      border-radius: 4
    }
    header_ob: {
      label: |'md
        **outbox** â€” url_db.public.outbox
      '|
      style: {
        fill: "#8b4513"
        stroke: "#e67e22"
        font-color: white
        bold: true
      }
    }
    col_ob: {
      label: |'md
        | Offset | Column | Type | Constraint | Default |
        |--------|--------|------|------------|---------|
        | 0 | **id** | UUID (16 B) | PRIMARY KEY Â· NOT NULL | gen_random_uuid() |
        | 16 | **event_type** | TEXT (variable) | NOT NULL | â€” |
        | +8 | **payload** | JSONB (variable) | NOT NULL | â€” |
        | +8 | **created_at** | TIMESTAMPTZ (8 B) | NOT NULL | now() |
        | +8 | **published_at** | TIMESTAMPTZ (8 B) | NULL | NULL |
      '|
    }
    note_outbox: {
      label: |'md
        **Storage notes**
        - event_type: routing key string (~12 chars avg)
        - payload: JSONB typical URLClickedEvent â‰ˆ 400â€“600 B
        - published_at NULL = not yet published (partial index target)
        - **Estimated row size**: ~650 B average (JSONB dominant)
      '|
      style: {
        fill: "#0d1b2a"
        stroke: "#4a4a8a"
        font-color: "#a0b0c0"
        font-size: 13
      }
    }
  }
}

# â”€â”€ INDEXES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
indexes: "B-Tree Index Structures" {
  style: {
    fill: "#0a1628"
    stroke: "#2ecc71"
    stroke-width: 2
    border-radius: 6
    font-color: white
    bold: true
    font-size: 16
  }

  idx_short_code: "idx_urls_short_code (UNIQUE)" {
    style: {
      fill: "#0d2b1a"
      stroke: "#2ecc71"
      stroke-width: 2
      border-radius: 4
    }
    sc_header: {
      label: |'md
        **CREATE UNIQUE INDEX idx_urls_short_code ON urls(short_code)**
      '|
      style: {
        fill: "#1a5c2e"
        stroke: "#2ecc71"
        font-color: white
        bold: true
      }
    }
    sc_tree: {
      label: |'md
        B-Tree Root Page
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Key type : VARCHAR(10) â”‚ Height: ~2â€“3 â”‚ Fill: 90% â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                     â–¼
        Internal Node          Internal Node
        [0000000 â€¦ mZZZZZZ]   [n000000 â€¦ ZZZZZZZ]
            â”‚                     â”‚
        Leaf Pages (ctidâ†’heap)  Leaf Pages (ctidâ†’heap)
      '|
      style: {
        fill: "#0a1f12"
        stroke: "#27ae60"
        font-color: "#90ee90"
        font-size: 13
      }
    }
    sc_meta: {
      label: |'md
        | Property | Value |
        |----------|-------|
        | Column | short_code VARCHAR(10) |
        | Unique | âœ… YES â€” enforces at DB level |
        | NULLs | NOT NULL â€” no NULL entries |
        | Selectivity | **~100%** (every value unique) |
        | Index size | ~120 B/entry Â· N entries |
        | Lookup cost | O(log N) â‰ˆ 3 I/Os for 10M rows |
      '|
    }
    sc_queries: {
      label: |'md
        **Queries using this index**
        â‘  `FindByCode` redirect hot path
        sql
        SELECT ... FROM urls WHERE short_code = $1
        
        â‘¡ Collision detection during INSERT
        â‘¢ Cache key derivation (Redis = "url:" + short_code)
      '|
      style: {
        fill: "#0a1f12"
        stroke: "#27ae60"
        font-color: "#c8f0d0"
        font-size: 13
      }
    }
  }

  idx_user_created: "idx_urls_user_id_created (COMPOSITE)" {
    style: {
      fill: "#1a1a0d"
      stroke: "#f1c40f"
      stroke-width: 2
      border-radius: 4
    }
    uc_header: {
      label: |'md
        **CREATE INDEX idx_urls_user_id_created ON urls(user_id, created_at DESC)**
      '|
      style: {
        fill: "#5c5c00"
        stroke: "#f1c40f"
        font-color: white
        bold: true
      }
    }
    uc_tree: {
      label: |'md
        B-Tree Root Page
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Key: (user_id UUID, created_at TIMESTAMPTZ DESC)                 â”‚
        â”‚ Height: ~3â€“4 â”‚ Fill: 85% â”‚ Sort: ASC user_id, DESC time        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                   â–¼                   â–¼
        Internal            Internal            Internal
        (uid=A, t=T3)       (uid=M, t=T2)       (uid=Z, t=T1)
      '|
      style: {
        fill: "#1a1a06"
        stroke: "#c9a800"
        font-color: "#fff0a0"
        font-size: 13
      }
    }
    uc_meta: {
      label: |'md
        | Property | Value |
        |----------|-------|
        | Column 1 | user_id UUID â€” equality filter |
        | Column 2 | created_at TIMESTAMPTZ DESC |
        | Index size | ~40 B/entry Â· N entries |
        | Lookup cost | O(log N) for user partition |
      '|
    }
    uc_queries: {
      label: |'md
        **Queries using this index**
        â‘  `ListByUser` first page (no cursor)
        sql
        SELECT ... FROM urls WHERE user_id = $1 ORDER BY created_at DESC LIMIT 21
        
        â‘¡ `ListByUser` subsequent pages (keyset cursor)
        sql
        WHERE user_id = $1 AND (created_at, id) < ($2, $3)
        
      '|
      style: {
        fill: "#1a1a06"
        stroke: "#c9a800"
        font-color: "#fff5cc"
        font-size: 13
      }
    }
  }

  idx_outbox_unpublished: "idx_outbox_unpublished (PARTIAL)" {
    style: {
      fill: "#1a0d1a"
      stroke: "#e056e0"
      stroke-width: 2
      border-radius: 4
    }
    op_header: {
      label: |'md
        **CREATE INDEX idx_outbox_unpublished ON outbox(created_at ASC) WHERE published_at IS NULL**
      '|
      style: {
        fill: "#5c005c"
        stroke: "#e056e0"
        font-color: white
        bold: true
      }
    }
    op_tree: {
      label: |'md
        Partial B-Tree (published_at IS NULL)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Key: created_at TIMESTAMPTZ ASC â”‚ Predicate check logic  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                       â–¼
            Leaf Page (oldest)      Leaf Page (recent)
      '|
      style: {
        fill: "#0d060d"
        stroke: "#b040b0"
        font-color: "#f0b0f0"
        font-size: 13
      }
    }
    op_meta: {
      label: |'md
        | Property | Value |
        |----------|-------|
        | Column | created_at TIMESTAMPTZ ASC |
        | Partial predicate | WHERE published_at IS NULL |
        | Maintenance | Auto-shrinks; no manual cleanup |
      '|
    }
    op_queries: {
      label: |'md
        **Queries using this index**
        â‘  `FetchUnpublished` â€” Poller (every 2s)
        sql
        SELECT ... FROM outbox WHERE published_at IS NULL ORDER BY created_at ASC
        
        â‘¡ `MarkPublished` Side effect: row drops OUT of partial index
      '|
      style: {
        fill: "#0d060d"
        stroke: "#b040b0"
        font-color: "#f5d0f5"
        font-size: 13
      }
    }
  }
}

# â”€â”€ ANNOTATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
annotations: "Query -> Index Routing Map" {
  style: {
    fill: "#0a0a1a"
    stroke: "#6677aa"
    stroke-width: 1
    border-radius: 4
    font-color: white
    font-size: 14
  }
  routing_table: {
    label: |'md
      | Query / Operation | Index Used | Access Method | Cost Tier |
      |-------------------|-----------|---------------|-----------|
      | `GET /:code` | idx_urls_short_code | Index Scan | ğŸŸ¢ O(log N) |
      | `POST /shorten` check | idx_urls_short_code | Index Scan | ğŸŸ¢ O(log N) |
      | `GET /urls` page 1 | idx_urls_user_id_created | Index Scan | ğŸŸ¢ O(log N) |
      | `GET /urls` page N | idx_urls_user_id_created | Index Scan | ğŸŸ¢ O(log N) |
      | Outbox poll (2s) | idx_outbox_unpublished | Index Scan | ğŸŸ¢ O(pending) |
      | Mark published | outbox PK | Index Scan | ğŸŸ¢ O(log N) |
    '|
  }
}

# â”€â”€ CONNECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tables.urls_table -> indexes.idx_short_code: "short_code UNIQUE" {
  style: { stroke: "#2ecc71"; stroke-width: 2; font-color: "#2ecc71"; bold: true }
}
tables.urls_table -> indexes.idx_user_created: "user_id + created_at DESC" {
  style: { stroke: "#f1c40f"; stroke-width: 2; font-color: "#f1c40f"; bold: true }
}
tables.outbox_table -> indexes.idx_outbox_unpublished: "WHERE published_at IS NULL" {
  style: { stroke: "#e056e0"; stroke-width: 2; font-color: "#e056e0"; bold: true }
}

indexes.idx_short_code -> annotations: "Redirect Hot Path" {
  style: { stroke: "#2ecc71"; stroke-dash: 4; font-color: "#2ecc71"; font-size: 12 }
}
indexes.idx_user_created -> annotations: "Pagination" {
  style: { stroke: "#f1c40f"; stroke-dash: 4; font-color: "#f1c40f"; font-size: 12 }
}
indexes.idx_outbox_unpublished -> annotations: "Event Delivery" {
  style: { stroke: "#e056e0"; stroke-dash: 4; font-color: "#e056e0"; font-size: 12 }
}