vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}
title: |md
  ## Base62 Code Generation Algorithm
  `codegen.Generate()` — `crypto/rand` source, 7-char output
| {near: top-center}
# ── BEFORE STATE ──────────────────────────────────────────────
before: "BEFORE: Raw Entropy (crypto/rand.Read)" {
  style.fill: "#1a1a2e"
  style.stroke: "#4a4a8a"
  style.font-color: "#e0e0ff"
  style.border-radius: 6
  buf: "buf [7]byte  (stack-allocated)" {
    style.fill: "#2a2a4e"
    style.stroke: "#6666aa"
    style.font-color: "#c0c0ff"
    style.border-radius: 4
    b0: "buf[0]\n0xAF\n(175)" {
      style.fill: "#3d1a6e"
      style.stroke: "#8855cc"
      style.font-color: "#e8d0ff"
    }
    b1: "buf[1]\n0x3C\n(60)" {
      style.fill: "#3d1a6e"
      style.stroke: "#8855cc"
      style.font-color: "#e8d0ff"
    }
    b2: "buf[2]\n0xF7\n(247)" {
      style.fill: "#3d1a6e"
      style.stroke: "#8855cc"
      style.font-color: "#e8d0ff"
    }
    b3: "buf[3]\n0x02\n(2)" {
      style.fill: "#3d1a6e"
      style.stroke: "#8855cc"
      style.font-color: "#e8d0ff"
    }
    b4: "buf[4]\n0xC1\n(193)" {
      style.fill: "#3d1a6e"
      style.stroke: "#8855cc"
      style.font-color: "#e8d0ff"
    }
    b5: "buf[5]\n0x5A\n(90)" {
      style.fill: "#3d1a6e"
      style.stroke: "#8855cc"
      style.font-color: "#e8d0ff"
    }
    b6: "buf[6]\n0x88\n(136)" {
      style.fill: "#3d1a6e"
      style.stroke: "#8855cc"
      style.font-color: "#e8d0ff"
    }
  }
  code_init: "code [7]byte\n(zeroed)" {
    style.fill: "#1e3a1e"
    style.stroke: "#4a7a4a"
    style.font-color: "#a0d0a0"
    style.border-radius: 4
  }
}
# ── STEP 1: ALPHABET ──────────────────────────────────────────
step1: "① ALPHABET CONSTANT" {
  style.fill: "#0d2b0d"
  style.stroke: "#2a6e2a"
  style.font-color: "#90ee90"
  style.border-radius: 6
  alpha_def: |go
    const base62Alphabet =
      "0123456789" +           // idx  0–9
      "ABCDEFGHIJKLMNOPQRSTUVWXYZ" + // idx 10–35
      "abcdefghijklmnopqrstuvwxyz"   // idx 36–61
    // len = 62  (verified at compile time)
    const codeLength = 7
  |
  alpha_map: "Index → Character Map (sample)" {
    style.fill: "#0a2a0a"
    style.stroke: "#3a6e3a"
    style.font-color: "#80d080"
    style.border-radius: 4
    i0:  "idx 0  → '0'" { style.fill: "#112211"; style.stroke: "#336633"; style.font-color: "#80d080" }
    i9:  "idx 9  → '9'" { style.fill: "#112211"; style.stroke: "#336633"; style.font-color: "#80d080" }
    i10: "idx 10 → 'A'" { style.fill: "#112211"; style.stroke: "#336633"; style.font-color: "#80d080" }
    i35: "idx 35 → 'Z'" { style.fill: "#112211"; style.stroke: "#336633"; style.font-color: "#80d080" }
    i36: "idx 36 → 'a'" { style.fill: "#112211"; style.stroke: "#336633"; style.font-color: "#80d080" }
    i61: "idx 61 → 'z'" { style.fill: "#112211"; style.stroke: "#336633"; style.font-color: "#80d080" }
  }
}
# ── STEP 2: RAND READ ─────────────────────────────────────────
step2: "② io.ReadFull(rand.Reader, buf[:])" {
  style.fill: "#1a0d2b"
  style.stroke: "#6622aa"
  style.font-color: "#cc99ff"
  style.border-radius: 6
  os_source: "OS Entropy Source\n(kernel CSPRNG)" {
    shape: cylinder
    style.fill: "#2a1a3e"
    style.stroke: "#8844cc"
    style.font-color: "#ddbbff"
  }
  read_call: |go
    if _, err := io.ReadFull(rand.Reader, buf); err != nil {
        return "", fmt.Errorf("codegen.Generate: %w", err)
    }
    // err == nil guaranteed by OS; extremely rare failure
    // ⚠ math/rand MUST NOT be used — not a CSPRNG
  |
  guarantee: "Guarantee: 7 independent,\nunpredictable bytes\n(cryptographically secure)" {
    style.fill: "#1e0a2e"
    style.stroke: "#9933cc"
    style.font-color: "#cc88ff"
    style.border-radius: 4
  }
  os_source -> read_call: "Read(buf)" { style.stroke: "#9955dd" }
}
# ── STEP 3: MODULO MAPPING ────────────────────────────────────
step3: "③ FOR i, b := range buf  →  index = b % 62" {
  style.fill: "#2b1a00"
  style.stroke: "#aa6600"
  style.font-color: "#ffcc66"
  style.border-radius: 6
  loop_code: |go
    for i, b := range buf {
        code[i] = base62Alphabet[int(b)%62]
    }
  |
  bias_note: |md
    ⚠ **Modulo Bias — Annotated**
    - Input domain: 256 values (0x00–0xFF)
    - Output domain: 62 values (0–61)
    - 256 ÷ 62 = 4 remainder **8**
    - Indices **0–7** map from 5 raw bytes each
    - Indices **8–61** map from 4 raw bytes each
    - Bias = (5−4)/256 ≈ **0.39%** over-representation
    - **Acceptable** for URL codes (non-security use)
    - Fix: rejection sampling (discard b ≥ 248); not warranted
  |
  bias_note.style.fill: "#3a2000"
  bias_note.style.stroke: "#cc8800"
  bias_note.style.font-color: "#ffdd88"
}
# ── STEP 4: PER-BYTE TRANSFORM (sample iterations) ───────────
step4: "④ Per-Byte Index Computation (example iterations)" {
  style.fill: "#001a2b"
  style.stroke: "#006699"
  style.font-color: "#66ccff"
  style.border-radius: 6
  iter0: "i=0: buf=0xAF(175)\n175 % 62 = 29\nalphabet[29] = 'T'" {
    style.fill: "#002244"
    style.stroke: "#0077bb"
    style.font-color: "#88ddff"
    style.bold: true
  }
  iter1: "i=1: buf=0x3C(60)\n60 % 62 = 60\nalphabet[60] = 'y'" {
    style.fill: "#002244"
    style.stroke: "#0077bb"
    style.font-color: "#88ddff"
  }
  iter2: "i=2: buf=0xF7(247)\n247 % 62 = 61\nalphabet[61] = 'z'" {
    style.fill: "#002244"
    style.stroke: "#0077bb"
    style.font-color: "#88ddff"
  }
  iter3: "i=3: buf=0x02(2)\n2 % 62 = 2\nalphabet[2] = '2'" {
    style.fill: "#002244"
    style.stroke: "#0077bb"
    style.font-color: "#88ddff"
  }
  iter4: "i=4: buf=0xC1(193)\n193 % 62 = 7\nalphabet[7] = '7'" {
    style.fill: "#002244"
    style.stroke: "#0077bb"
    style.font-color: "#88ddff"
  }
  iter5: "i=5: buf=0x5A(90)\n90 % 62 = 28\nalphabet[28] = 'S'" {
    style.fill: "#002244"
    style.stroke: "#0077bb"
    style.font-color: "#88ddff"
  }
  iter6: "i=6: buf=0x88(136)\n136 % 62 = 12\nalphabet[12] = 'C'" {
    style.fill: "#002244"
    style.stroke: "#0077bb"
    style.font-color: "#88ddff"
  }
  iter0 -> iter1 -> iter2 -> iter3 -> iter4 -> iter5 -> iter6: "" {
    style.stroke: "#0055aa"
    style.font-color: "#66aaff"
    style.stroke-dash: 3
  }
}
# ── AFTER STATE ───────────────────────────────────────────────
after: "AFTER: 7-char Base62 String" {
  style.fill: "#0a1a0a"
  style.stroke: "#2a7a2a"
  style.font-color: "#90ff90"
  style.border-radius: 6
  result_string: "\"Tyz27SC\"\nlen = 7  ✓\nall chars ∈ base62Alphabet  ✓\ncrypto/rand source  ✓" {
    style.fill: "#0d2b0d"
    style.stroke: "#33aa33"
    style.font-color: "#66ff66"
    style.bold: true
    style.font-size: 18
    style.border-radius: 8
    style.shadow: true
  }
  invariants: |md
    **Post-conditions verified by TestGenerate_***
    - `len(code) == 7`  always
    - every `code[i] ∈ base62Alphabet`
    - 1,000 consecutive calls → 0 duplicates
    - `import "math/rand"` absent from source
    - `crypto/rand.Reader` is the sole entropy source
  |
  invariants.style.fill: "#071a07"
  invariants.style.stroke: "#2a662a"
  invariants.style.font-color: "#88dd88"
  result_string -> invariants: "satisfies" { style.stroke: "#44bb44" }
}
# ── COLLISION RETRY WRAPPER ────────────────────────────────────
retry: "⑤ Collision Retry (caller: URLService.Shorten)" {
  style.fill: "#2b0000"
  style.stroke: "#aa2200"
  style.font-color: "#ffaa88"
  style.border-radius: 6
  retry_code: |go
    for attempt := 1; attempt <= 5; attempt++ {
        code, _ := s.codegen.Generate()          // ← steps ①–④
        err := urlRepo.Create(ctx, tx, url{ShortCode: code, ...})
        if errors.Is(err, ErrCodeConflict) {
            log.Debug().Int("attempt", attempt).Msg("collision; retrying")
            continue                             // 62^7 = 3.52T codes; P(collision) ≈ 0
        }
        return code, nil                         // success
    }
    return "", ErrExhausted                      // 5 collisions: 503
  |
  collision_prob: "P(collision | N existing codes)\n= N / 62^7\nAt N=1M: ≈ 0.000028%\nEarth's storage saturates first" {
    style.fill: "#220000"
    style.stroke: "#882200"
    style.font-color: "#ff8866"
    style.border-radius: 4
  }
  custom_code_path: "Custom code path:\nSkip Generate()\nPass user string directly\nDB UNIQUE → ErrCodeConflict → 409" {
    style.fill: "#1a0a0a"
    style.stroke: "#662200"
    style.font-color: "#dd8866"
    style.border-radius: 4
  }
}
# ── FLOW CONNECTIONS ──────────────────────────────────────────
before -> step1: "constants\ndefined once" {
  style.stroke: "#559955"
  style.stroke-dash: 2
}
step1 -> step2: "① alphabet ready\n→ request entropy" {
  style.stroke: "#7755bb"
  style.animated: true
}
step2 -> step3: "② buf filled\n→ start mapping loop" {
  style.stroke: "#aa6600"
  style.animated: true
}
step3 -> step4: "③ loop body\n→ apply per byte" {
  style.stroke: "#0066aa"
  style.animated: true
}
step4 -> after: "④ all 7 bytes\nmapped → result" {
  style.stroke: "#33aa33"
  style.animated: true
  style.stroke-width: 3
}
after -> retry: "returned to\nURLService.Shorten\nfor DB insert" {
  style.stroke: "#aa3300"
  style.stroke-dash: 4
}
# ── BEFORE → AFTER SIDE-BY-SIDE LABEL ─────────────────────────
transform_annotation: ||md
  **Transformation Summary**
  | Position | Raw byte | Decimal | `% 62` | Index | Char |
  |----------|----------|---------|--------|-------|------|
  | `code[0]` | `0xAF` | 175 | → | 29 | **'T'** |
  | `code[1]` | `0x3C` | 60  | → | 60 | **'y'** |
  | `code[2]` | `0xF7` | 247 | → | 61 | **'z'** |
  | `code[3]` | `0x02` | 2   | → |  2 | **'2'** |
  | `code[4]` | `0xC1` | 193 | → |  7 | **'7'** |
  | `code[5]` | `0x5A` | 90  | → | 28 | **'S'** |
  | `code[6]` | `0x88` | 136 | → | 12 | **'C'** |
  **Result:** `"Tyz27SC"` (7 chars, base62-safe)
|| {near: bottom-center}