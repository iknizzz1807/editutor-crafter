vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}
direction: right
title: |md
  ## GET /:code — Read-Through Cache Data Flow
  *URLService.Redirect — outbox click recorded in same DB transaction*
| {near: top-center}
##############################################
# ENTRY
##############################################
client: "Client\nHTTP GET /:code" {
  shape: rectangle
  style.fill: "#E8F4FD"
  style.stroke: "#2980B9"
  style.bold: true
}
extract: "Extract\nshort_code\nfrom path" {
  shape: rectangle
  style.fill: "#EBF5FB"
  style.stroke: "#5DADE2"
}
client -> extract: "GET /:code"
##############################################
# REDIS PROBE
##############################################
redis_avail: "Redis\nAvailable?" {
  shape: diamond
  style.fill: "#FEF9E7"
  style.stroke: "#F39C12"
}
extract -> redis_avail
redis_get: "Redis GET\n\"url:{code}\"" {
  shape: cylinder
  style.fill: "#FDEBD0"
  style.stroke: "#E67E22"
}
redis_avail -> redis_get: "YES" {
  style.stroke: "#27AE60"
}
redis_err_log: "log.Warn()\n\"redis GET failed;\ncache miss\"" {
  shape: rectangle
  style.fill: "#FADBD8"
  style.stroke: "#E74C3C"
  style.italic: true
}
redis_avail -> redis_err_log: "NO / ERROR" {
  style.stroke: "#E74C3C"
  style.stroke-dash: 5
}
##############################################
# CACHE HIT BRANCH
##############################################
cache_hit: "Cache HIT?\nUnmarshal\n{original_url,\nexpires_at,\nis_active}" {
  shape: diamond
  style.fill: "#FEF9E7"
  style.stroke: "#F39C12"
}
redis_get -> cache_hit
hit_active: "is_active\n== true?" {
  shape: diamond
  style.fill: "#FEF9E7"
  style.stroke: "#F39C12"
}
cache_hit -> hit_active: "HIT" {
  style.stroke: "#27AE60"
}
hit_expiry: "expires_at\n== nil OR\n> now()?" {
  shape: diamond
  style.fill: "#FEF9E7"
  style.stroke: "#F39C12"
}
hit_active -> hit_expiry: "true"
hit_inactive_410: "410 Gone\n\"link no longer\nactive\"" {
  shape: rectangle
  style.fill: "#FADBD8"
  style.stroke: "#C0392B"
  style.bold: true
}
hit_active -> hit_inactive_410: "false (is_active=false)" {
  style.stroke: "#C0392B"
}
hit_expired_410: "410 Gone\n\"link has expired\"" {
  shape: rectangle
  style.fill: "#FADBD8"
  style.stroke: "#C0392B"
  style.bold: true
}
hit_expiry -> hit_expired_410: "expired" {
  style.stroke: "#C0392B"
}
##############################################
# OUTBOX TRANSACTION (cache hit path)
##############################################
outbox_tx_hit: "pool.Begin(ctx)\n[Cache Hit Click Tx]" {
  shape: rectangle
  style.fill: "#D5F5E3"
  style.stroke: "#1E8449"
  style.bold: true
}
hit_expiry -> outbox_tx_hit: "not expired\n(valid)" {
  style.stroke: "#27AE60"
}
outbox_insert_hit: "outbox INSERT\nURLClickedEvent\n{event_id, short_code,\nip_hash, user_agent,\ncorrelation_id}" {
  shape: cylinder
  style.fill: "#A9DFBF"
  style.stroke: "#1E8449"
}
outbox_tx_hit -> outbox_insert_hit: "same pgx.Tx"
commit_hit: "tx.Commit()" {
  shape: rectangle
  style.fill: "#D5F5E3"
  style.stroke: "#1E8449"
}
outbox_insert_hit -> commit_hit
commit_err_hit: "log.Warn()\ndo NOT fail\nredirect" {
  shape: rectangle
  style.fill: "#FADBD8"
  style.stroke: "#E74C3C"
  style.italic: true
}
commit_hit -> commit_err_hit: "error" {
  style.stroke: "#E74C3C"
  style.stroke-dash: 5
}
redirect_301_hit: "301 Moved\nPermanently\nLocation: original_url" {
  shape: rectangle
  style.fill: "#D5F5E3"
  style.stroke: "#1E8449"
  style.bold: true
}
commit_hit -> redirect_301_hit: "success"
commit_err_hit -> redirect_301_hit: "continue\n(click lost)" {
  style.stroke: "#E74C3C"
  style.stroke-dash: 5
}
##############################################
# CACHE MISS → PostgreSQL
##############################################
cache_miss_pg: "PostgreSQL\nSELECT\nFROM urls\nWHERE short_code=\$1" {
  shape: cylinder
  style.fill: "#D6EAF8"
  style.stroke: "#2471A3"
}
cache_hit -> cache_miss_pg: "MISS" {
  style.stroke: "#E67E22"
}
redis_err_log -> cache_miss_pg: "bypass\n(Redis error)" {
  style.stroke: "#E74C3C"
  style.stroke-dash: 5
}
pg_found: "Row\nfound?" {
  shape: diamond
  style.fill: "#FEF9E7"
  style.stroke: "#F39C12"
}
cache_miss_pg -> pg_found
pg_404: "404 Not Found\n\"not found\"" {
  shape: rectangle
  style.fill: "#FADBD8"
  style.stroke: "#C0392B"
  style.bold: true
}
pg_found -> pg_404: "NO" {
  style.stroke: "#C0392B"
}
pg_active: "is_active\n== true?" {
  shape: diamond
  style.fill: "#FEF9E7"
  style.stroke: "#F39C12"
}
pg_found -> pg_active: "YES"
pg_inactive_410: "410 Gone\n\"link no longer\nactive\"" {
  shape: rectangle
  style.fill: "#FADBD8"
  style.stroke: "#C0392B"
  style.bold: true
}
pg_active -> pg_inactive_410: "false"
pg_expiry: "expires_at\n== nil OR\n> now()?" {
  shape: diamond
  style.fill: "#FEF9E7"
  style.stroke: "#F39C12"
}
pg_active -> pg_expiry: "true"
pg_expired_410: "410 Gone\n\"link has expired\"" {
  shape: rectangle
  style.fill: "#FADBD8"
  style.stroke: "#C0392B"
  style.bold: true
}
pg_expiry -> pg_expired_410: "expired"
##############################################
# REDIS SET (TTL computation)
##############################################
redis_set: "Redis SET\n\"url:{code}\"\n{original_url,\nexpires_at,\nis_active}\nTTL = min(\n  expires_at − now(),\n  1 hour\n)" {
  shape: cylinder
  style.fill: "#FDEBD0"
  style.stroke: "#E67E22"
}
pg_expiry -> redis_set: "not expired\n(valid)" {
  style.stroke: "#27AE60"
}
redis_set_err: "log.Warn()\nswallow error\n(best-effort)" {
  shape: rectangle
  style.fill: "#FADBD8"
  style.stroke: "#E74C3C"
  style.italic: true
}
redis_set -> redis_set_err: "error" {
  style.stroke: "#E74C3C"
  style.stroke-dash: 5
}
##############################################
# OUTBOX TRANSACTION (cache miss path)
##############################################
outbox_tx_miss: "pool.Begin(ctx)\n[Cache Miss Click Tx]" {
  shape: rectangle
  style.fill: "#D5F5E3"
  style.stroke: "#1E8449"
  style.bold: true
}
redis_set -> outbox_tx_miss: "SET done\n(or silently\nskipped on error)"
redis_set_err -> outbox_tx_miss
outbox_insert_miss: "outbox INSERT\nURLClickedEvent\n{event_id, short_code,\nip_hash, user_agent,\ncorrelation_id}" {
  shape: cylinder
  style.fill: "#A9DFBF"
  style.stroke: "#1E8449"
}
outbox_tx_miss -> outbox_insert_miss: "same pgx.Tx"
commit_miss: "tx.Commit()" {
  shape: rectangle
  style.fill: "#D5F5E3"
  style.stroke: "#1E8449"
}
outbox_insert_miss -> commit_miss
commit_err_miss: "log.Warn()\ndo NOT fail\nredirect" {
  shape: rectangle
  style.fill: "#FADBD8"
  style.stroke: "#E74C3C"
  style.italic: true
}
commit_miss -> commit_err_miss: "error" {
  style.stroke: "#E74C3C"
  style.stroke-dash: 5
}
redirect_301_miss: "301 Moved\nPermanently\nLocation: original_url" {
  shape: rectangle
  style.fill: "#D5F5E3"
  style.stroke: "#1E8449"
  style.bold: true
}
commit_miss -> redirect_301_miss: "success"
commit_err_miss -> redirect_301_miss: "continue\n(click lost)" {
  style.stroke: "#E74C3C"
  style.stroke-dash: 5
}
##############################################
# ANNOTATIONS
##############################################
note_atomic: |md
  **Outbox Atomicity Note**
  The `URLClickedEvent` outbox INSERT
  executes in its own `pool.Begin()` tx,
  separate from the HTTP response path.
  A crash after `301` is sent but before
  `tx.Commit()` loses the click event.
  This is an acknowledged **at-least-once**
  tradeoff — the redirect always succeeds.
  `EventID` (UUID v4) enables consumer-side
  idempotency deduplication in analytics-service.
| {
  near: bottom-center
  style.fill: "#FDFEFE"
  style.stroke: "#BDC3C7"
}
note_ttl: |md
  **Cache TTL Formula**
  `TTL = min(expires_at − now(), 1h)`
  - `expires_at == nil` → TTL = 1h
  - `expires_at` within 1h → TTL = remaining
  - already expired → skip SET; return 410
  - Redis error on SET → swallow, proceed
| {
  near: top-right
  style.fill: "#FDFEFE"
  style.stroke: "#BDC3C7"
}