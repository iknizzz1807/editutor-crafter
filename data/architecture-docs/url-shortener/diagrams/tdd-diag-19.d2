layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

# ── HEADER ────────────────────────────────────────────────────────────────────
title: {
  shape: text
  label: |md
    # Redis Cache Key Layout — `url:{short_code}`
    Read-through cache for GET /:code redirect hot path
  |
  near: top-center
}

# ── KEY MEMORY LAYOUT ─────────────────────────────────────────────────────────
key_layout: {
  label: "KEY BINARY LAYOUT"
  style: {
    fill: "#f5f3ff"
    stroke: "#7c3aed"
    stroke-width: 2
  }

  # Offset markers
  offsets: {
    grid-columns: 1
    o0: "0x00" {shape: text; style.font-color: gray}
    o4: "0x04" {shape: text; style.font-color: gray}
    o11: "0x0B" {shape: text; style.font-color: gray}
  }

  fields: {
    prefix: "Prefix" {
      label: "url:\n(4 bytes)"
      style.fill: "#7c3aed"
      style.font-color: white
    }
    code: "Short Code" {
      label: "{short_code}\n(7 bytes)"
      style.fill: "#2563eb"
      style.font-color: white
    }
    padding: "Padding" {
      label: "Variable\n(0-6 bytes)"
      style.fill: "#94a3b8"
      style.font-color: white
    }
  }

  offsets.o0 -> fields.prefix
  offsets.o4 -> fields.code
  offsets.o11 -> fields.padding
}

# ── VALUE SPECIFICATION ───────────────────────────────────────────────────────
value_layout: {
  label: "VALUE SPECIFICATION (JSON)"
  shape: sql_table
  style: {
    fill: "#f8fafc"
    stroke: "#2563eb"
  }

  original_url: "string (UTF-8)" {
    constraint: "max 2048B"
  }
  expires_at: "RFC3339 | null" {
    constraint: "20B / 4B"
  }
  is_active: "boolean" {
    constraint: "1B (true/false)"
  }
}

# ── ALGORITHM STATE: TTL ──────────────────────────────────────────────────────
ttl_rules: {
  label: "TTL COMPUTATION LOGIC"
  style: {
    fill: "#f0fdf4"
    stroke: "#16a34a"
  }

  check: "expires_at == null?" {
    shape: diamond
    style.fill: "#16a34a"
    style.font-color: white
  }

  branch_a: "Result: 3600s" {
    style.fill: "#dcfce7"
    style.bold: true
  }

  check_past: "rem <= 0?" {
    shape: diamond
    style.fill: "#16a34a"
    style.font-color: white
  }

  branch_b: "Result: 1s" {
    style.fill: "#dcfce7"
    style.bold: true
  }

  branch_c: "Result: min(rem, 3600s)" {
    style.fill: "#dcfce7"
    style.bold: true
  }

  check -> branch_a: "Yes"
  check -> check_past: "No"
  check_past -> branch_b: "Yes (Expired)"
  check_past -> branch_c: "No (Valid)"
}

# ── SEQUENCE: INVALIDATION ────────────────────────────────────────────────────
invalidation_seq: {
  shape: sequence_diagram
  label: "Cache Invalidation Flow"
  
  API: "URL Service"
  DB: "PostgreSQL"
  Cache: "Redis"

  API -> DB: "UPDATE urls SET is_active=false"
  API -> DB: "COMMIT TRANSACTION"
  DB -> API: "Success"
  
  API -> Cache: "DEL url:{code}" {
    style.stroke: "#f97316"
    style.stroke-width: 3
  }
  Cache -> API: "OK ▲"
}

# ── HIT PATH ──────────────────────────────────────────────────────────────────
hit_path: {
  label: "HOT PATH: GET /:code"
  style.fill: "#fafaf9"
  
  h1: "1. GET key" {
    style.fill: "#e7e5e4"
  }
  h2: "2. Parse JSON" {
    style.fill: "#e7e5e4"
  }
  h3: "3. Verify active" {
    style.fill: "#fecaca"
    style.bold: true
  }
  h4: "4. 301 Redirect" {
    style.fill: "#bbf7d0"
    style.bold: true
  }

  h1 -> h2 -> h3 -> h4
}

# ── GLOBAL POINTERS ───────────────────────────────────────────────────────────
key_layout -> value_layout: "maps to" {
  style.stroke: "#f97316"
  style.stroke-width: 3
}

value_layout -> ttl_rules: "determines" {
  style.stroke-dash: 5
}

invalidation_seq -> hit_path: "invalidates" {
  style.stroke: red
  style.stroke-dash: 3
}