vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}
direction: right
title: "Docker Compose Container Topology â€” url-shortener" {
  shape: text
  near: top-center
  style: {
    font-size: 28
    bold: true
  }
}
network: "backend (bridge network)" {
  style: {
    stroke: "#4A5568"
    stroke-width: 3
    fill: "#F7FAFC"
    stroke-dash: 4
    border-radius: 12
    font-size: 14
    bold: true
  }
  # â”€â”€ Infrastructure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  infra: "Infrastructure Layer" {
    style: {
      stroke: "#718096"
      stroke-width: 2
      fill: "#EDF2F7"
      stroke-dash: 3
      border-radius: 8
    }
    url_db: "url_db\npostgres:16-alpine\nhost:5432 â†’ 5432" {
      shape: cylinder
      style: {
        fill: "#6B46C1"
        font-color: white
        stroke: "#44337A"
        stroke-width: 2
        bold: true
      }
    }
    analytics_db: "analytics_db\npostgres:16-alpine\nhost:5432 â†’ 5433" {
      shape: cylinder
      style: {
        fill: "#6B46C1"
        font-color: white
        stroke: "#44337A"
        stroke-width: 2
        bold: true
      }
    }
    user_db: "user_db\npostgres:16-alpine\nhost:5432 â†’ 5434" {
      shape: cylinder
      style: {
        fill: "#6B46C1"
        font-color: white
        stroke: "#44337A"
        stroke-width: 2
        bold: true
      }
    }
    notification_db: "notification_db\npostgres:16-alpine\nhost:5432 â†’ 5435" {
      shape: cylinder
      style: {
        fill: "#6B46C1"
        font-color: white
        stroke: "#44337A"
        stroke-width: 2
        bold: true
      }
    }
    rabbitmq: "rabbitmq\nrabbitmq:3.13-management-alpine\nAMQP:5672 | Mgmt:15672" {
      shape: queue
      style: {
        fill: "#C05621"
        font-color: white
        stroke: "#7B341E"
        stroke-width: 2
        bold: true
      }
    }
    redis: "redis\nredis:7-alpine\nhost:6379 â†’ 6379" {
      shape: cylinder
      style: {
        fill: "#2F855A"
        font-color: white
        stroke: "#1C4532"
        stroke-width: 2
        bold: true
      }
    }
  }
  # â”€â”€ Application Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  apps: "Application Services Layer" {
    style: {
      stroke: "#4299E1"
      stroke-width: 2
      fill: "#EBF8FF"
      stroke-dash: 3
      border-radius: 8
    }
    url_service: "url-service\n:8081 â†’ 8081\nShortenURL Â· Redirect Â· CRUD" {
      style: {
        fill: "#2B6CB0"
        font-color: white
        stroke: "#1A365D"
        stroke-width: 2
        bold: true
        border-radius: 6
      }
    }
    analytics_service: "analytics-service\n:8082 â†’ 8082\nClick Ingestion Â· Stats API" {
      style: {
        fill: "#2B6CB0"
        font-color: white
        stroke: "#1A365D"
        stroke-width: 2
        bold: true
        border-radius: 6
      }
    }
    user_service: "user-service\n:8083 â†’ 8083\nRegister Â· Login Â· JWT" {
      style: {
        fill: "#2B6CB0"
        font-color: white
        stroke: "#1A365D"
        stroke-width: 2
        bold: true
        border-radius: 6
      }
    }
    notification_service: "notification-service\n:8084 â†’ 8084\nEvent Consumer Â· Alerts" {
      style: {
        fill: "#2B6CB0"
        font-color: white
        stroke: "#1A365D"
        stroke-width: 2
        bold: true
        border-radius: 6
      }
    }
  }
  # â”€â”€ Gateway â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  gateway: "gateway\n:8080 â†’ 8080\nJWT Auth Â· Rate Limit Â· Circuit Breaker Â· Routing" {
    style: {
      fill: "#744210"
      font-color: white
      stroke: "#4A2800"
      stroke-width: 3
      bold: true
      border-radius: 6
      shadow: true
    }
  }
}
# â”€â”€ Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
client: "Client\n(Browser / curl / SDK)" {
  shape: person
  style: {
    fill: "#E2E8F0"
    stroke: "#4A5568"
    font-color: "#2D3748"
    stroke-width: 2
  }
}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CLIENT â†’ GATEWAY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
client -> network.gateway: "HTTPS/HTTP\n:8080" {
  style: {
    stroke: "#2D3748"
    stroke-width: 3
    bold: true
    font-color: "#2D3748"
  }
}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GATEWAY â†’ DOWNSTREAM SERVICES  (HTTP proxy)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
network.gateway -> network.apps.url_service: "HTTP proxy\n/api/shorten Â· /r/{code}\n/api/urls Â· /api/urls/{code}" {
  style: {
    stroke: "#3182CE"
    stroke-width: 2
    font-color: "#2C5282"
  }
}
network.gateway -> network.apps.analytics_service: "HTTP proxy\n/api/stats/{code}\n/api/stats/{code}/timeline" {
  style: {
    stroke: "#3182CE"
    stroke-width: 2
    font-color: "#2C5282"
  }
}
network.gateway -> network.apps.user_service: "HTTP proxy\n/api/auth/register\n/api/auth/login Â· /api/me" {
  style: {
    stroke: "#3182CE"
    stroke-width: 2
    font-color: "#2C5282"
  }
}
network.gateway -> network.apps.notification_service: "HTTP proxy\n/api/notifications" {
  style: {
    stroke: "#3182CE"
    stroke-width: 2
    font-color: "#2C5282"
  }
}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GATEWAY â†’ REDIS  (rate limit counters)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
network.gateway -> network.infra.redis: "Redis INCR/TTL\n:6379\nRate limit buckets" {
  style: {
    stroke: "#38A169"
    stroke-width: 2
    font-color: "#276749"
    stroke-dash: 3
  }
}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# url-service â†” infrastructure
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
network.apps.url_service -> network.infra.url_db: "pgx/v5 pool\nTCP:5432\nschema: url_db" {
  style: {
    stroke: "#6B46C1"
    stroke-width: 2
    font-color: "#44337A"
  }
}
network.apps.url_service -> network.infra.redis: "go-redis\nTCP:6379\nRead-through cache\nurl:{code}" {
  style: {
    stroke: "#38A169"
    stroke-width: 2
    font-color: "#276749"
    stroke-dash: 3
  }
}
network.apps.url_service -> network.infra.rabbitmq: "AMQP 0-9-1\nTCP:5672\nPublish: url.created\nurl.clicked Â· url.deleted\n(outbox poller)" {
  style: {
    stroke: "#DD6B20"
    stroke-width: 2
    font-color: "#7B341E"
  }
}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# analytics-service â†” infrastructure
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
network.apps.analytics_service -> network.infra.analytics_db: "pgx/v5 pool\nTCP:5432\nschema: analytics_db" {
  style: {
    stroke: "#6B46C1"
    stroke-width: 2
    font-color: "#44337A"
  }
}
network.apps.analytics_service -> network.infra.rabbitmq: "AMQP 0-9-1\nTCP:5672\nConsume: analytics.clicks\n(url.clicked)\nPublish: milestone.reached" {
  style: {
    stroke: "#DD6B20"
    stroke-width: 2
    font-color: "#7B341E"
  }
}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# user-service â†” infrastructure
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
network.apps.user_service -> network.infra.user_db: "pgx/v5 pool\nTCP:5432\nschema: user_db" {
  style: {
    stroke: "#6B46C1"
    stroke-width: 2
    font-color: "#44337A"
  }
}
network.apps.user_service -> network.infra.rabbitmq: "AMQP 0-9-1\nTCP:5672\nexchange declare\n(url-shortener topic)" {
  style: {
    stroke: "#DD6B20"
    stroke-width: 2
    font-color: "#7B341E"
    stroke-dash: 5
  }
}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# notification-service â†” infrastructure
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
network.apps.notification_service -> network.infra.notification_db: "pgx/v5 pool\nTCP:5432\nschema: notification_db" {
  style: {
    stroke: "#6B46C1"
    stroke-width: 2
    font-color: "#44337A"
  }
}
network.apps.notification_service -> network.infra.rabbitmq: "AMQP 0-9-1\nTCP:5672\nConsume: notifications.events\n(url.created Â· url.deleted\nmilestone.reached)" {
  style: {
    stroke: "#DD6B20"
    stroke-width: 2
    font-color: "#7B341E"
  }
}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# depends_on + healthcheck (dashed, lighter weight)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
network.infra.url_db -> network.apps.url_service: "depends_on\ncondition: service_healthy\npg_isready -U url_user" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
network.infra.redis -> network.apps.url_service: "depends_on\ncondition: service_healthy\nredis-cli ping" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
network.infra.rabbitmq -> network.apps.url_service: "depends_on\ncondition: service_healthy\nrabbitmq-diagnostics ping" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
network.infra.analytics_db -> network.apps.analytics_service: "depends_on\ncondition: service_healthy" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
network.infra.rabbitmq -> network.apps.analytics_service: "depends_on\ncondition: service_healthy" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
network.infra.user_db -> network.apps.user_service: "depends_on\ncondition: service_healthy" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
network.infra.rabbitmq -> network.apps.user_service: "depends_on\ncondition: service_healthy" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
network.infra.notification_db -> network.apps.notification_service: "depends_on\ncondition: service_healthy" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
network.infra.rabbitmq -> network.apps.notification_service: "depends_on\ncondition: service_healthy" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
network.apps.url_service -> network.gateway: "depends_on\ncondition: service_healthy\nwget /health" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
network.apps.analytics_service -> network.gateway: "depends_on\ncondition: service_healthy" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
network.apps.user_service -> network.gateway: "depends_on\ncondition: service_healthy" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
network.apps.notification_service -> network.gateway: "depends_on\ncondition: service_healthy" {
  style: {
    stroke: "#A0AEC0"
    stroke-width: 1
    stroke-dash: 6
    font-color: "#718096"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LEGEND
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
legend: |md
  **Legend**
  â”€â”€â”€ Solid arrow = runtime protocol connection
  - - Dashed arrow = depends_on / healthcheck ordering
  ğŸŸ£ Purple cylinder = PostgreSQL (private per-service)
  ğŸŸ¢ Green cylinder = Redis (shared: cache + rate limit)
  ğŸŸ  Queue shape = RabbitMQ (shared message broker)
  ğŸ”µ Rectangle = Application service
  ğŸŸ¤ Dark rectangle = API Gateway (sole public entry point)
  **Ports exposed to host:**
  url_db:5432 analytics_db:5433 user_db:5434 notification_db:5435
  rabbitmq:5672,15672  redis:6379
  url-service:8081  analytics-service:8082
  user-service:8083  notification-service:8084  gateway:8080
| {
  near: bottom-center
  style: {
    font-size: 12
    fill: "#FFFBF0"
    stroke: "#D69E2E"
    stroke-width: 1
    border-radius: 6
  }
}