vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}
direction: right
title: |md
  ## Analytics DB Schema — clicks · milestones · processed_events
| {near: top-center}
# ── clicks table ──────────────────────────────────────────────────────────────
clicks_table: "clicks" {
  shape: sql_table
  style.fill: "#C7E0F4"
  style.stroke: "#2E75B6"
  style.font-color: "#1A1A2E"
  id: "UUID" {constraint: primary_key}
  short_code: "TEXT NOT NULL"
  clicked_at: "TIMESTAMPTZ NOT NULL"
  ip_hash: "TEXT NOT NULL"
  user_agent: "TEXT NOT NULL DEFAULT ''"
  referer: "TEXT NULL"
}
# ── milestones table ───────────────────────────────────────────────────────────
milestones_table: "milestones" {
  shape: sql_table
  style.fill: "#C7E0F4"
  style.stroke: "#2E75B6"
  style.font-color: "#1A1A2E"
  id: "UUID" {constraint: primary_key}
  short_code: "TEXT NOT NULL"
  milestone: "INT NOT NULL"
  triggered_at: "TIMESTAMPTZ NOT NULL DEFAULT now()"
  "UNIQUE(short_code, milestone)": "" {constraint: unique}
}
# ── processed_events table ─────────────────────────────────────────────────────
processed_events_table: "processed_events" {
  shape: sql_table
  style.fill: "#C7E0F4"
  style.stroke: "#2E75B6"
  style.font-color: "#1A1A2E"
  event_id: "TEXT" {constraint: primary_key}
  processed_at: "TIMESTAMPTZ NOT NULL DEFAULT now()"
}
# ── indexes ───────────────────────────────────────────────────────────────────
idx_clicks_time: "idx_clicks_short_code_time" {
  shape: rectangle
  style.fill: "#FFF2CC"
  style.stroke: "#D6AE00"
  style.font-color: "#4A3800"
  style.border-radius: 6
  label: |md
    **idx_clicks_short_code_time**
    `ON clicks(short_code, clicked_at DESC)`
    Supports: COUNT(*) in time windows,
    date_trunc bucketing, CountByCode,
    CountByCodeSince
  |
}
idx_clicks_referer: "idx_clicks_referer" {
  shape: rectangle
  style.fill: "#FFF2CC"
  style.stroke: "#D6AE00"
  style.font-color: "#4A3800"
  style.border-radius: 6
  label: |md
    **idx_clicks_referer** *(partial)*
    `ON clicks(short_code, referer)`
    `WHERE referer IS NOT NULL`
    Supports: TopReferers(code, n)
    Omits NULL rows — saves space
  |
}
idx_milestones: "idx_milestones_code_milestone" {
  shape: rectangle
  style.fill: "#FFF2CC"
  style.stroke: "#D6AE00"
  style.font-color: "#4A3800"
  style.border-radius: 6
  label: |md
    **idx_milestones_code_milestone** *(unique)*
    `ON milestones(short_code, milestone)`
    Supports: HasMilestone lookup
    Enforces: one row per (code, threshold)
  |
}
idx_processed_events: "processed_events PRIMARY KEY" {
  shape: rectangle
  style.fill: "#FFF2CC"
  style.stroke: "#D6AE00"
  style.font-color: "#4A3800"
  style.border-radius: 6
  label: |md
    **event_id PRIMARY KEY**
    O(log n) dedup lookup
    `SELECT EXISTS(... WHERE event_id = $1)`
    No extra index needed
  |
}
# ── Go struct mappings ─────────────────────────────────────────────────────────
click_record: "ClickRecord (Go struct)" {
  shape: class
  style.fill: "#E8D5F5"
  style.stroke: "#7B2FBE"
  style.font-color: "#2D0060"
  ID: "string // UUID from DB"
  ShortCode: "string"
  ClickedAt: "time.Time"
  IPHash: "string // 64-char hex SHA-256"
  UserAgent: "string // empty string ok"
  Referer: "string // empty → SQL NULL via pgtype.Text"
}
milestone_record: "MilestoneRecord (Go struct)" {
  shape: class
  style.fill: "#E8D5F5"
  style.stroke: "#7B2FBE"
  style.font-color: "#2D0060"
  ID: "string"
  ShortCode: "string"
  Milestone: "int // 10 | 100 | 1000"
  TriggeredAt: "time.Time"
}
# ── field mapping arrows: Go struct → DB column ──────────────────────────────
click_record.ShortCode -> clicks_table.short_code: "maps to" {
  style.stroke: "#7B2FBE"
  style.stroke-dash: 4
  style.font-size: 11
}
click_record.ClickedAt -> clicks_table.clicked_at: "maps to" {
  style.stroke: "#7B2FBE"
  style.stroke-dash: 4
  style.font-size: 11
}
click_record.IPHash -> clicks_table.ip_hash: "SHA-256(ip+salt)\nnever raw IP" {
  style.stroke: "#C0392B"
  style.stroke-dash: 4
  style.font-size: 11
  style.bold: true
}
click_record.Referer -> clicks_table.referer: "\"\" → NULL\n(pgtype.Text)" {
  style.stroke: "#7B2FBE"
  style.stroke-dash: 4
  style.font-size: 11
}
milestone_record.ShortCode -> milestones_table.short_code: "maps to" {
  style.stroke: "#7B2FBE"
  style.stroke-dash: 4
  style.font-size: 11
}
milestone_record.Milestone -> milestones_table.milestone: "10 | 100 | 1000" {
  style.stroke: "#7B2FBE"
  style.stroke-dash: 4
  style.font-size: 11
}
# ── index → table ownership ───────────────────────────────────────────────────
idx_clicks_time -> clicks_table: "covers" {
  style.stroke: "#D6AE00"
  style.stroke-width: 2
}
idx_clicks_referer -> clicks_table: "covers\n(partial)" {
  style.stroke: "#D6AE00"
  style.stroke-width: 2
}
idx_milestones -> milestones_table: "unique\ncovers" {
  style.stroke: "#D6AE00"
  style.stroke-width: 2
}
idx_processed_events -> processed_events_table: "PK\ncovers" {
  style.stroke: "#D6AE00"
  style.stroke-width: 2
}
# ── deduplication flow annotation ────────────────────────────────────────────
dedup_note: |md
  **Deduplication flow**
  `URLClickedEvent.EventID` (UUID v4)
  ──► `Exists(tx, eventID)` → SELECT EXISTS
  ──► if true: Rollback + Ack (skip)
  ──► if false: `Insert(tx, eventID)` + click insert
  ──► COMMIT atomically
  *At-least-once delivery + idempotent consumer*
  *= exactly-once click counting*
| {
  near: bottom-center
  style.fill: "#F0FFF0"
  style.stroke: "#2E8B57"
  style.border-radius: 8
}
# ── constraint annotations ───────────────────────────────────────────────────
milestone_constraints: |md
  **Milestone thresholds**: 10 · 100 · 1000
  `INSERT ... ON CONFLICT (short_code, milestone) DO NOTHING`
  Idempotent — safe on replay or
  concurrent consumer race.
| {
  near: top-right
  style.fill: "#FFF5E6"
  style.stroke: "#E07B00"
  style.border-radius: 6
}
ip_privacy: |md
  **Privacy invariant**
  `ip_hash = SHA-256(raw_ip + salt)`
  64-char hex · never raw IP in DB
  Salt: `IP_HASH_SALT` env var
  Already hashed by url-service before
  embedding in `URLClickedEvent.IPHash`
| {
  near: top-left
  style.fill: "#FFE8E8"
  style.stroke: "#C0392B"
  style.border-radius: 6
}