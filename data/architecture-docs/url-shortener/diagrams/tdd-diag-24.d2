vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

title: |md
  ## Consumer Message Processing State Machine
  `analytics-service` / `notification-service` Â· `prefetch=1` Â· manual Ack
| {near: top-center}

# â”€â”€ States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WAITING: "WAITING\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: channel open\nAMQP prefetch=1\nhealthy.Load()=true" {
  shape: rectangle
  style.fill: "#E8F5E9"
  style.stroke: "#388E3C"
  style.stroke-width: 2
  style.border-radius: 6
}
DECODING: "DECODING\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: d.Body != nil\nAction: json.Unmarshal\n(d.Body, &evt)" {
  shape: rectangle
  style.fill: "#E3F2FD"
  style.stroke: "#1565C0"
  style.stroke-width: 2
  style.border-radius: 6
}
DEDUP_CHECK: "DEDUP_CHECK\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: evt.EventID != \"\"\nevt.ShortCode != \"\"\nAction: pool.Begin(ctx)\ndedupStore.Exists(tx,\n  evt.EventID)" {
  shape: rectangle
  style.fill: "#E3F2FD"
  style.stroke: "#1565C0"
  style.stroke-width: 2
  style.border-radius: 6
}
INSERTING: "INSERTING\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: tx open\nevent_id not seen\nAction: dedupStore.Insert(tx)\nclickStore.Insert(tx, rec)" {
  shape: rectangle
  style.fill: "#E3F2FD"
  style.stroke: "#1565C0"
  style.stroke-width: 2
  style.border-radius: 6
}
MILESTONE_CHECK: "MILESTONE_CHECK\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: click row inserted\ntx still open\nAction: COUNT(*) on tx\ncheck thresholds [10,100,1000]\nHasMilestone(tx, code, n)" {
  shape: rectangle
  style.fill: "#E3F2FD"
  style.stroke: "#1565C0"
  style.stroke-width: 2
  style.border-radius: 6
}
PUBLISHING_MILESTONE: "PUBLISHING_MILESTONE\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: milestone row inserted\ntx still open\nAction: milestoneStore.Insert(tx)\npublisher.PublishMilestone(ctx, evt)\ntx.Commit(ctx)" {
  shape: rectangle
  style.fill: "#FFF9C4"
  style.stroke: "#F9A825"
  style.stroke-width: 2
  style.border-radius: 6
}
ACKING: "ACKING\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: tx committed OR\nno tx needed (dedup/poison)\nAction: d.Ack(false)\nlog Info" {
  shape: rectangle
  style.fill: "#E8F5E9"
  style.stroke: "#388E3C"
  style.stroke-width: 2
  style.border-radius: 6
}
ERROR_POISON: "ERROR_POISON\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: msg unprocessable\n(malformed JSON OR\nmissing event_id/short_code\nOR panic recovered)\nAction: log.Error\nd.Ack(false) â† drains queue\nDO NOT nack" {
  shape: rectangle
  style.fill: "#FFEBEE"
  style.stroke: "#C62828"
  style.stroke-width: 3
  style.border-radius: 6
}
ERROR_DB: "ERROR_DB\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: tx may be open\nDB or broker transient error\n(Begin fail, Exists fail,\nInsert fail, Commit fail)\nAction: tx.Rollback(ctx)\nlog.Error\nd.Nack(false, requeue=true)" {
  shape: rectangle
  style.fill: "#FFEBEE"
  style.stroke: "#C62828"
  style.stroke-width: 2
  style.border-radius: 6
}

# â”€â”€ Initial State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initial: "" {
  shape: circle
  style.fill: "#212121"
  style.stroke: "#212121"
  width: 28
  height: 28
}
initial -> WAITING: "service started\nch.Consume() registered\nch.Qos(1,0,false) set" {
  style.stroke: "#388E3C"
  style.stroke-width: 2
}

# â”€â”€ Normal Path Transitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WAITING -> DECODING: "trigger: <d,ok> := <-msgs\nguard: ok==true\naction: record start time" {
  style.stroke: "#1565C0"
  style.stroke-width: 2
}
DECODING -> DEDUP_CHECK: "trigger: json.Unmarshal success\nguard: evt.EventID != \"\" &&\n       evt.ShortCode != \"\"\naction: pool.Begin(ctx)" {
  style.stroke: "#1565C0"
  style.stroke-width: 2
}
DEDUP_CHECK -> INSERTING: "trigger: dedupStore.Exists â†’ false\nguard: no DB error\naction: dedupStore.Insert(tx)\n        clickStore.Insert(tx, rec)" {
  style.stroke: "#1565C0"
  style.stroke-width: 2
}
INSERTING -> MILESTONE_CHECK: "trigger: both inserts succeed\nguard: tx still open\naction: COUNT(*) FROM clicks\n        WHERE short_code=\$1 on tx" {
  style.stroke: "#1565C0"
  style.stroke-width: 2
}
MILESTONE_CHECK -> PUBLISHING_MILESTONE: "trigger: totalClicks >= threshold &&\n         HasMilestone â†’ false\nguard: threshold in {10,100,1000}\naction: milestoneStore.Insert(tx)\n        PublishMilestone (warn-only on fail)\n        tx.Commit(ctx)" {
  style.stroke: "#F9A825"
  style.stroke-width: 2
}
MILESTONE_CHECK -> ACKING: "trigger: no threshold crossed OR\n         all thresholds already recorded\nguard: tx committed\naction: tx.Commit(ctx)\n        log.Info(\"click processed\")" {
  style.stroke: "#388E3C"
  style.stroke-width: 2
}
PUBLISHING_MILESTONE -> ACKING: "trigger: tx.Commit success\nguard: publish may have warned but\n       milestone row is durable\naction: log.Info(\"click processed\"\n        + milestone info)" {
  style.stroke: "#388E3C"
  style.stroke-width: 2
}
ACKING -> WAITING: "trigger: d.Ack(false) sent\nguard: broker still connected\naction: await next delivery\n        (prefetch=1 releases slot)" {
  style.stroke: "#388E3C"
  style.stroke-width: 2
}

# â”€â”€ Duplicate Event Path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DEDUP_CHECK -> ACKING: "trigger: dedupStore.Exists â†’ true\nguard: no DB error\naction: tx.Rollback(ctx)\n        log.Info(\"duplicate event skipped\")" {
  style.stroke: "#7B1FA2"
  style.stroke-width: 2
  style.stroke-dash: 4
}

# â”€â”€ Poison Message Paths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DECODING -> ERROR_POISON: "trigger: json.Unmarshal fails\nguard: d.Body unparseable\naction: log.Error(\"poison message\")\n        truncate body preview 200 chars" {
  style.stroke: "#C62828"
  style.stroke-width: 2
}
DECODING -> ERROR_POISON: "trigger: Unmarshal ok BUT\n         evt.EventID==\"\" OR\n         evt.ShortCode==\"\"\nguard: required fields missing\naction: log.Error(\"missing required fields\")" {
  style.stroke: "#C62828"
  style.stroke-width: 2
}
DECODING -> ERROR_POISON: "trigger: panic recovered\n         in defer recover()\nguard: any panic in processDelivery\naction: log.Error(\"consumer panic recovered\")\n        log panic value + body preview" {
  style.stroke: "#C62828"
  style.stroke-width: 2
  style.stroke-dash: 3
}
ERROR_POISON -> WAITING: "trigger: d.Ack(false) sent\nguard: broker connected\naction: poison msg drained\n        no requeue" {
  style.stroke: "#C62828"
  style.stroke-width: 2
}

# â”€â”€ DB Error Paths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DEDUP_CHECK -> ERROR_DB: "trigger: pool.Begin fails OR\n         dedupStore.Exists DB error\nguard: infrastructure failure\naction: tx.Rollback(ctx)\n        log.Error" {
  style.stroke: "#C62828"
  style.stroke-width: 2
}
INSERTING -> ERROR_DB: "trigger: dedupStore.Insert OR\n         clickStore.Insert DB error\nguard: non-conflict DB error\naction: tx.Rollback(ctx)\n        log.Error(\"insert failed\")" {
  style.stroke: "#C62828"
  style.stroke-width: 2
}
MILESTONE_CHECK -> ERROR_DB: "trigger: COUNT(*) error OR\n         HasMilestone DB error OR\n         milestoneStore.Insert DB error OR\n         tx.Commit fails\nguard: any DB error in check path\naction: tx.Rollback(ctx)\n        log.Error" {
  style.stroke: "#C62828"
  style.stroke-width: 2
}
PUBLISHING_MILESTONE -> ERROR_DB: "trigger: tx.Commit fails\nguard: commit failure after milestone insert\naction: tx.Rollback(ctx)\n        log.Error(\"commit failed\")\nNOTE: PublishMilestone failure alone\n      is NON-FATAL â†’ stays in ACKING path" {
  style.stroke: "#C62828"
  style.stroke-width: 2
}
ERROR_DB -> WAITING: "trigger: d.Nack(false, requeue=true)\nguard: broker connected\naction: msg returned to queue head\n        broker will redeliver" {
  style.stroke: "#C62828"
  style.stroke-width: 2
}

# â”€â”€ Channel Closed (AMQP Drop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CHANNEL_CLOSED: "CHANNEL_CLOSED\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: ok==false on msgs\nAction: healthy.Store(false)\n         log.Warn\n         <-ctx.Done()\n/health still returns 200" {
  shape: rectangle
  style.fill: "#FFF3E0"
  style.stroke: "#E65100"
  style.stroke-width: 2
  style.border-radius: 6
}
WAITING -> CHANNEL_CLOSED: "trigger: <-msgs ok==false\nguard: AMQP connection dropped\naction: mark unhealthy\n        block until ctx cancelled" {
  style.stroke: "#E65100"
  style.stroke-width: 2
}

# â”€â”€ ILLEGAL Transition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ILLEGAL_NACK_POISON: "ILLEGAL: Nack on poison msg\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nWould cause: infinite requeue\nloop consuming broker capacity.\nPoison msgs MUST be Ack'd." {
  shape: rectangle
  style.fill: "#B71C1C"
  style.font-color: white
  style.stroke: "#B71C1C"
  style.stroke-width: 3
  style.border-radius: 4
}
ERROR_POISON -> ILLEGAL_NACK_POISON: "ILLEGAL" {
  style.stroke: "#B71C1C"
  style.stroke-width: 3
  style.stroke-dash: 5
  style.font-color: "#B71C1C"
  style.bold: true
  target-arrowhead.shape: arrow
}

# â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
legend: |md
  **Transition colors**
  ðŸ”µ Blue â€” normal happy path
  ðŸŸ¢ Green â€” success / Ack
  ðŸ”´ Red â€” error / poison / ILLEGAL
  ðŸŸ£ Purple dashed â€” duplicate skip (Ack)
  ðŸŸ  Yellow â€” milestone triggered
  ðŸŸ§ Orange â€” AMQP infrastructure event
  **Key invariants**
  â€¢ prefetch=1: at most 1 in-flight msg per consumer goroutine
  â€¢ All DB work (dedup + click + milestone) in ONE transaction
  â€¢ Poison msgs â†’ Ack (never Nack) to prevent infinite requeue
  â€¢ Publish failure is warn-only; tx.Commit still proceeds
  â€¢ healthy flag read by /health; consumer pause â‰  HTTP 500
| {
  near: bottom-right
  style.fill: "#FAFAFA"
  style.stroke: "#BDBDBD"
  style.border-radius: 6
}