vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

direction: right

title: |md
  ## clicks + milestones + processed_events — Schema & Index Layout
  Analytics Service · analytics_db · PostgreSQL 16
| {near: top-center}

# ─── clicks table ────────────────────────────────────────────────────────────
clicks_table: "TABLE: clicks" {
  style: {
    fill: "#1e1e3f"
    stroke: "#7c6af7"
    stroke-width: 3
    border-radius: 6
    font-color: "#ffffff"
    bold: true
  }
  header: |md
    **clicks**
    Storage: HEAP · Row width ≈ 160–320 bytes
  | {
    style: {
      fill: "#6a0dad" # Purple: Header
      stroke: "#7c6af7"
      font-color: "#ffffff"
    }
  }
  row_data: |md
    `+0`  **id**           UUID (16 B)   · PK
    `+16` **short_code**   TEXT          · NOT NULL
    `+32` **clicked_at**   TIMESTAMPTZ   · NOT NULL (8 B)
    `+40` **ip_hash**      TEXT          · NOT NULL (64 chars)
    `+56` **user_agent**   TEXT          · NOT NULL
    `+72` **referer**      TEXT          · NULL
  | {
    style: {
      fill: "#0047ab" # Blue: Data
      stroke: "#7c6af7"
      font-color: "#ffffff"
      font: mono
    }
  }
  note: |md
    **referer NULL:** Stored as NULL when header absent.
    **clicked_at:** Sourced from URLClickedEvent.OccurredAt.
  | {
    style: {
      fill: "#0d0d2b"
      stroke: "#5a4fd6"
      font-color: "#a89fff"
    }
  }
}

# ─── clicks indexes ───────────────────────────────────────────────────────────
idx_sc_time: "INDEX: idx_clicks_short_code_time" {
  style: {
    fill: "#0f3d2e"
    stroke: "#2ecc71"
    stroke-width: 2
    border-radius: 6
  }
  hdr: |md
    **idx_clicks_short_code_time**
    B-Tree · (short_code ASC, clicked_at DESC)
  | {
    style: {
      fill: "#6a0dad" # Purple: Header
      stroke: "#2ecc71"
      font-color: "#ffffff"
      bold: true
    }
  }
  body: |md
    Leaf entry layout:
    ┌───────────────┬───────────────┬────────┐
    │ short_code    │ clicked_at    │ heapTID│
    └───────────────┴───────────────┴────────┘
  | {
    style: {
      fill: "#ff8c00" # Orange: Pointers/Indexes
      stroke: "#2ecc71"
      font-color: "#000000"
      font: mono
    }
  }
}

idx_referer: "INDEX: idx_clicks_referer (PARTIAL)" {
  style: {
    fill: "#3d2200"
    stroke: "#f39c12"
    stroke-width: 2
    border-radius: 6
  }
  hdr: |md
    **idx_clicks_referer**
    B-Tree · WHERE referer IS NOT NULL
  | {
    style: {
      fill: "#6a0dad" # Purple: Header
      stroke: "#f39c12"
      font-color: "#ffffff"
      bold: true
    }
  }
  body: |md
    Leaf entry layout:
    ┌───────────────┬───────────────┬────────┐
    │ short_code    │ referer       │ heapTID│
    └───────────────┴───────────────┴────────┘
  | {
    style: {
      fill: "#ff8c00" # Orange: Pointers/Indexes
      stroke: "#f39c12"
      font-color: "#000000"
      font: mono
    }
  }
}

# ─── milestones table ────────────────────────────────────────────────────────
milestones_table: "TABLE: milestones" {
  style: {
    fill: "#1f1a00"
    stroke: "#f1c40f"
    stroke-width: 3
    border-radius: 6
    font-color: "#ffffff"
    bold: true
  }
  header: |md
    **milestones**
    Storage: HEAP · Fixed-width ≈ 48 bytes
  | {
    style: {
      fill: "#6a0dad" # Purple: Header
      stroke: "#f1c40f"
      font-color: "#ffffff"
    }
  }
  row_ms: |md
    `+0`  **id**           UUID (16 B)   · PK
    `+16` **short_code**   TEXT          · NOT NULL
    `+32` **milestone**    INT (4 B)     · 10/100/1000
    `+36` **triggered_at** TIMESTAMPTZ   · 8 B
  | {
    style: {
      fill: "#0047ab" # Blue: Data
      stroke: "#f1c40f"
      font-color: "#ffffff"
      font: mono
    }
  }
}

idx_milestones: "INDEX: idx_milestones_short_code" {
  style: {
    fill: "#1f1a00"
    stroke: "#c9a800"
    stroke-width: 2
    border-radius: 6
  }
  hdr_ms: |md
    **idx_milestones_short_code**
    B-Tree · (short_code ASC, milestone DESC)
  | {
    style: {
      fill: "#6a0dad" # Purple: Header
      stroke: "#c9a800"
      font-color: "#ffffff"
      bold: true
    }
  }
  body_ms: |md
    Leaf entry: (short_code, milestone DESC, TID)
  | {
    style: {
      fill: "#ff8c00" # Orange: Pointers/Indexes
      stroke: "#c9a800"
      font-color: "#000000"
      font: mono
    }
  }
}

# ─── processed_events table ──────────────────────────────────────────────────
pe_table: "TABLE: processed_events" {
  style: {
    fill: "#001f3f"
    stroke: "#3498db"
    stroke-width: 3
    border-radius: 6
    font-color: "#ffffff"
    bold: true
  }
  header: |md
    **processed_events**
    Storage: HEAP · Width: 24 bytes
  | {
    style: {
      fill: "#6a0dad" # Purple: Header
      stroke: "#3498db"
      font-color: "#ffffff"
    }
  }
  row_pe: |md
    `+0`  **event_id**     UUID (16 B)   · PK
    `+16` **processed_at** TIMESTAMPTZ   · 8 B
  | {
    style: {
      fill: "#0047ab" # Blue: Data
      stroke: "#3498db"
      font-color: "#ffffff"
      font: mono
    }
  }
}

idx_pe_pk: "INDEX: processed_events_pkey" {
  style: {
    fill: "#001f3f"
    stroke: "#2980b9"
    stroke-width: 2
    border-radius: 6
  }
  hdr_pe: |md
    **processed_events_pkey**
    B-Tree · Unique · event_id (UUID)
  | {
    style: {
      fill: "#6a0dad" # Purple: Header
      stroke: "#2980b9"
      font-color: "#ffffff"
      bold: true
    }
  }
  body_pe: |md
    Leaf entry: (event_id, TID)
  | {
    style: {
      fill: "#ff8c00" # Orange: Pointers/Indexes
      stroke: "#2980b9"
      font-color: "#000000"
      font: mono
    }
  }
}

# ─── Transaction boundary annotation ─────────────────────────────────────────
tx_boundary: "ATOMIC TRANSACTION BOUNDARY" {
  style: {
    fill: "#1a0020"
    stroke: "#9b59b6"
    stroke-width: 2
    stroke-dash: 4
    border-radius: 8
  }
  tx_body: |md
    BEGIN;
      INSERT INTO processed_events (event_id) VALUES ($id);
      INSERT INTO clicks (...) VALUES (...);
    COMMIT;
  | {
    style: {
      fill: "#0d0015"
      stroke: "#8e44ad"
      font-color: "#d7a8ff"
      font: mono
    }
  }
}

# ─── Connections ──────────────────────────────────────────────────────────────
clicks_table -> idx_sc_time: "B-Tree Leaf Pointers" {
  style: {
    stroke: "#2ecc71"
    stroke-width: 2
  }
}
clicks_table -> idx_referer: "Partial Predicate" {
  style: {
    stroke: "#f39c12"
    stroke-width: 2
  }
}
milestones_table -> idx_milestones: "Threshold Lookup" {
  style: {
    stroke: "#c9a800"
    stroke-width: 2
  }
}
pe_table -> idx_pe_pk: "PK Lookup" {
  style: {
    stroke: "#2980b9"
    stroke-width: 2
    stroke-dash: 3
  }
}
tx_boundary -> pe_table: "Step 1: Dedup" {
  style: {
    stroke: "#9b59b6"
    stroke-width: 2
    animated: true
  }
}
tx_boundary -> clicks_table: "Step 2: Persist" {
  style: {
    stroke: "#9b59b6"
    stroke-width: 2
    animated: true
  }
}