vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}
title: |md
  ## Consumer Goroutine State Machine
  **analytics-service / notification-service** Â· prefetch=1 Â· single goroutine
| {near: top-center}
# â”€â”€ States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
INITIAL: "" {
  shape: circle
  width: 28
  height: 28
  style.fill: "#1a1a2e"
  style.stroke: "#1a1a2e"
}
CONNECTING: "CONNECTING\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nDials amqp://admin@rabbitmq:5672/\nExchangeDeclare url-shortener topic\nQueueDeclare + QueueBind\nQos(prefetchCount=1)\nch.Consume â†’ deliveries chan\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: no delivery channel open" {
  shape: rectangle
  style.fill: "#2d1b69"
  style.stroke: "#7c3aed"
  style.stroke-width: 2
  style.border-radius: 6
  style.font-size: 13
}
CONSUMING: "CONSUMING\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nBlocking: select {\n  case d := <-deliveries\n  case <-ctx.Done()\n}\nInvariant: exactly one\nAMQP connection open\nprefetch=1 â†’ broker holds\nnext msg until ACK/NACK" {
  shape: rectangle
  style.fill: "#1e3a5f"
  style.stroke: "#2563eb"
  style.stroke-width: 2
  style.border-radius: 6
  style.font-size: 13
}
PROCESSING: "PROCESSING\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nStep 1:  panic recover defer\nStep 2:  json.Unmarshal d.Body\nStep 3:  validate EventID + ShortCode\nStep 4:  SetMsgLogger (correlation_id)\nStep 5:  IsProcessed(eventID) pre-check\nStep 6:  pool.Begin(ctx) â†’ tx\nStep 7:  processedRepo.MarkProcessed(tx)\nStep 8:  clickRepo.Insert(tx, click)\nStep 9:  tx.Commit()\nStep 10: detectAndRecordMilestone() [post-commit]\nStep 11: d.Ack(false)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: exactly one msg in-flight\nACK only after Step 9 COMMIT succeeds\nILLEGAL: ACK before tx.Commit()" {
  shape: rectangle
  style.fill: "#1e3a2a"
  style.stroke: "#16a34a"
  style.stroke-width: 2
  style.border-radius: 6
  style.font-size: 13
}
STOPPING: "STOPPING\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconsumer.Close()\nconn.Close()\ngoroutine exits\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nInvariant: called only once\non ctx.Done()" {
  shape: rectangle
  style.fill: "#4a1c1c"
  style.stroke: "#dc2626"
  style.stroke-width: 2
  style.border-radius: 6
  style.font-size: 13
}
WAIT_RECONNECT: "WAIT_RECONNECT\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\ntime.Sleep(10s)\nLog warn: reconnecting\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nAll in-flight deliveries\nnot ACKed â†’ broker\nredelivers on reconnect" {
  shape: rectangle
  style.fill: "#3d2a00"
  style.stroke: "#d97706"
  style.stroke-width: 2
  style.border-radius: 6
  style.font-size: 13
}
SUPERVISOR_RECOVER: "SUPERVISOR_RECOVER\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nrecover() in outer goroutine\nlog.Error panic payload\ntime.Sleep(5s)\nRestart RunConsumer loop\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nDelivery NOT ACKed\nBroker redelivers msg\nafter consumer reconnects" {
  shape: rectangle
  style.fill: "#3d1a3d"
  style.stroke: "#a855f7"
  style.stroke-width: 2
  style.border-radius: 6
  style.font-size: 13
}
# â”€â”€ Outcome leaf states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DUPLICATE: "DUPLICATE\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nIsProcessed â†’ true\nd.Ack(false)\nlog.Debug: skipped\nâ†’ back to CONSUMING" {
  shape: rectangle
  style.fill: "#1a2a3a"
  style.stroke: "#64748b"
  style.border-radius: 6
  style.font-size: 13
}
POISON: "POISON_MESSAGE\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nMalformed JSON\nor missing fields\nd.Ack(false)  â† remove permanently\nlog.Error: poison\nâ†’ back to CONSUMING\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nNEVER d.Nack requeue=true\nfor malformed payload" {
  shape: rectangle
  style.fill: "#3d1a00"
  style.stroke: "#ea580c"
  style.border-radius: 6
  style.font-size: 13
}
TRANSIENT_ERROR: "TRANSIENT_ERROR\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nDB error (Begin/Insert/Commit)\nd.Nack(false, requeue=true)\nlog.Error\nâ†’ back to CONSUMING\nBroker redelivers msg" {
  shape: rectangle
  style.fill: "#3d2000"
  style.stroke: "#ca8a04"
  style.border-radius: 6
  style.font-size: 13
}
ACK_ILLEGAL: "â›” ILLEGAL\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nd.Ack before tx.Commit\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nViolates at-least-once:\nclick lost on crash\nbetween ACK and commit" {
  shape: rectangle
  style.fill: "#2d0000"
  style.stroke: "#ef4444"
  style.stroke-width: 3
  style.border-radius: 6
  style.font-size: 13
}
# â”€â”€ Transitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
INITIAL -> CONNECTING: "service start\nmain.go launches\nsupervisor goroutine" {
  style.stroke: "#7c3aed"
  style.stroke-width: 2
}
CONNECTING -> CONSUMING: "guard: amqp.Dial OK\namqp.Channel OK\nExchangeDeclare OK\nQueueDeclare OK\nQueueBind OK\nQos(1) OK\nch.Consume OK\naction: store conn+ch\nlog.Info: consumer started" {
  style.stroke: "#16a34a"
  style.stroke-width: 2
}
CONNECTING -> WAIT_RECONNECT: "trigger: any AMQP op fails\naction: ch.Close, conn.Close\nlog.Warn: connect failed" {
  style.stroke: "#d97706"
  style.stroke-width: 2
}
WAIT_RECONNECT -> CONNECTING: "trigger: time.Sleep(10s) elapsed\naction: retry ConnectRabbitMQ\nwith exponential backoff\n(500msâ†’1sâ†’2sâ†’4sâ†’4s cap)" {
  style.stroke: "#d97706"
  style.stroke-width: 2
}
CONSUMING -> PROCESSING: "trigger: d := <-deliveries, ok=true\naction: processor.Process(ctx, d)\nInvariant: prefetch=1 means\nbroker sends no next msg\nuntil current ACK/NACK" {
  style.stroke: "#16a34a"
  style.stroke-width: 2
}
CONSUMING -> STOPPING: "trigger: ctx.Done()\naction: consumer.Close()\n        conn.Close()" {
  style.stroke: "#dc2626"
  style.stroke-width: 2
}
CONSUMING -> WAIT_RECONNECT: "trigger: ok=false on deliveries chan\n(broker closed channel)\naction: conn.Close()\nlog.Warn: channel closed; reconnecting" {
  style.stroke: "#d97706"
  style.stroke-width: 2
  style.stroke-dash: 3
}
PROCESSING -> CONSUMING: "trigger: ProcessResultInserted\naction: d.Ack(false) [Step 11]\npost-commit; at-least-once safe\nlog.Info: event processed" {
  style.stroke: "#16a34a"
  style.stroke-width: 2
}
PROCESSING -> DUPLICATE: "trigger: IsProcessed(eventID)=true [Step 5]\naction: d.Ack(false)\nNo DB writes; idempotent" {
  style.stroke: "#64748b"
  style.stroke-width: 2
}
DUPLICATE -> CONSUMING: "return ProcessResultDuplicate" {
  style.stroke: "#64748b"
}
PROCESSING -> POISON: "trigger: json.Unmarshal fails [Step 2]\n      OR EventID==\"\" [Step 3]\n      OR ShortCode==\"\" [Step 3]\n      OR unknown routing key\naction: d.Ack(false) â€” remove from queue\nlog.Error: poison message body (truncated 200 chars)" {
  style.stroke: "#ea580c"
  style.stroke-width: 2
}
POISON -> CONSUMING: "return ProcessResultPoisoned" {
  style.stroke: "#ea580c"
}
PROCESSING -> TRANSIENT_ERROR: "trigger: pool.Begin fails [Step 6]\n      OR MarkProcessed fails [Step 7]\n      OR Insert fails [Step 8]\n      OR tx.Commit fails [Step 9]\naction: tx.Rollback (via defer)\n        d.Nack(false, requeue=true)" {
  style.stroke: "#ca8a04"
  style.stroke-width: 2
}
TRANSIENT_ERROR -> CONSUMING: "return ProcessResultError\nBroker redelivers; IsProcessed\npre-check prevents double-count" {
  style.stroke: "#ca8a04"
}
PROCESSING -> SUPERVISOR_RECOVER: "trigger: panic() anywhere in Process\naction: deferred recover() fires\n        log.Error: panic payload\n        return ProcessResultError\n        delivery NOT ACKed" {
  style.stroke: "#a855f7"
  style.stroke-width: 2
  style.stroke-dash: 5
}
SUPERVISOR_RECOVER -> CONNECTING: "trigger: time.Sleep(5s)\naction: outer for-loop restarts\nRunConsumer; broker redelivers\nunACKed msg on reconnect" {
  style.stroke: "#a855f7"
  style.stroke-width: 2
  style.stroke-dash: 5
}
# â”€â”€ ILLEGAL transition (red dashed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PROCESSING -> ACK_ILLEGAL: "ILLEGAL: ACK before tx.Commit\nCrash between ACK and COMMIT\ndrops the click event permanently\nViolates at-least-once delivery" {
  style.stroke: "#ef4444"
  style.stroke-width: 3
  style.stroke-dash: 5
}
# â”€â”€ Legend annotation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
legend: |md
  **Legend**
  - ðŸŸ¢ Green arrow = happy path
  - ðŸŸ¡ Orange arrow = reconnect / retry path
  - ðŸ”´ Red dashed = â›” ILLEGAL transition
  - ðŸŸ£ Purple dashed = panic recovery path
  - â¬› Gray = duplicate/dedup path
  ---
  **prefetch=1 invariant**: broker holds next msg
  until current d.Ack() or d.Nack() is called.
  Steps 1â€“9 must complete before any ACK/NACK.
  Step 11 ACK is always after Step 9 tx.Commit().
| {
  near: bottom-right
  style.fill: "#0f0f1a"
  style.stroke: "#334155"
  style.border-radius: 8
  style.font-size: 12
}