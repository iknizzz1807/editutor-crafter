vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}
direction: right
title: |md
  ## RabbitMQ Exchange / Queue / Binding Topology
  Exchange: `url-shortener` (topic, durable)
| {near: top-center}
classes: {
  producer: {
    style: {
      fill: "#4A235A"
      font-color: white
      stroke: "#7D3C98"
      stroke-width: 2
      border-radius: 6
      bold: true
    }
  }
  exchange: {
    style: {
      fill: "#1A5276"
      font-color: white
      stroke: "#2E86C1"
      stroke-width: 3
      border-radius: 4
      bold: true
      font-size: 15
      shadow: true
    }
  }
  queue: {
    style: {
      fill: "#1E8449"
      font-color: white
      stroke: "#27AE60"
      stroke-width: 2
      border-radius: 4
      bold: true
    }
  }
  consumer: {
    style: {
      fill: "#784212"
      font-color: white
      stroke: "#CA6F1E"
      stroke-width: 2
      border-radius: 6
      bold: true
    }
  }
  dlq: {
    style: {
      fill: "#641E16"
      font-color: white
      stroke: "#E74C3C"
      stroke-width: 2
      stroke-dash: 5
      border-radius: 4
      italic: true
    }
  }
  routing_key: {
    style: {
      fill: "#F0B27A"
      font-color: "#1A1A1A"
      stroke: "#E59866"
      stroke-width: 1
      border-radius: 12
      font-size: 11
      font: mono
    }
  }
}
producers: Producers {
  style: {
    fill: "#2C2C4A"
    stroke: "#7D3C98"
    stroke-dash: 3
    border-radius: 8
    font-color: "#D7BDE2"
  }
  url_svc: "url-service\n(outbox poller)" {
    class: producer
  }
  url_svc_note: |md
    **Publishes via outbox pattern**
    - url.created → on shorten
    - url.clicked → on redirect
    - url.deleted → on soft-delete
  | {
    style.fill: transparent
    style.stroke: transparent
    style.font-color: "#D7BDE2"
    style.font-size: 11
  }
}
exchange: "url-shortener\n(type: topic | durable: true)" {
  class: exchange
  meta: |md
    **Exchange Properties**
    - Auto-delete: false
    - Internal: false
    - Persistent messages only
  | {
    style.fill: transparent
    style.stroke: transparent
    style.font-color: white
    style.font-size: 10
  }
}
queues: Queues {
  style: {
    fill: "#1A2E1A"
    stroke: "#27AE60"
    stroke-dash: 3
    border-radius: 8
    font-color: "#A9DFBF"
  }
  analytics_q: "analytics.clicks\n(durable: true)" {
    class: queue
    tooltip: "Declared by analytics-service on startup"
  }
  notifications_q: "notifications.events\n(durable: true)" {
    class: queue
    tooltip: "Declared by notification-service on startup"
  }
  dlq_placeholder: "dlq.url-shortener\n(future: dead-letter)" {
    class: dlq
    tooltip: "Placeholder — not implemented in M1-M5; captures poison messages on nack requeue=false"
  }
}
consumers: Consumers {
  style: {
    fill: "#2E1A0A"
    stroke: "#CA6F1E"
    stroke-dash: 3
    border-radius: 8
    font-color: "#FAD7A0"
  }
  analytics_svc: "analytics-service\nprefetch: 1 | ack: explicit" {
    class: consumer
  }
  notification_svc: "notification-service\nprefetch: 1 | ack: explicit" {
    class: consumer
  }
}
routing_keys: "Routing Keys (topic pattern)" {
  style: {
    fill: "#2E2A1A"
    stroke: "#F0B27A"
    stroke-dash: 2
    border-radius: 8
    font-color: "#FAD7A0"
    font-size: 12
  }
  rk1: "url.clicked" {
    class: routing_key
  }
  rk2: "url.created" {
    class: routing_key
  }
  rk3: "url.deleted" {
    class: routing_key
  }
  rk4: "milestone.reached" {
    class: routing_key
  }
}
producers.url_svc -> exchange: "AMQP\nPublish()" {
  style: {
    stroke: "#7D3C98"
    stroke-width: 3
    font-color: "#D7BDE2"
    bold: true
    animated: true
  }
  target-arrowhead: {
    shape: triangle
    style.filled: true
  }
}
exchange -> routing_keys.rk1: "" {
  style.stroke: "#F0B27A"
  style.stroke-width: 1
  style.stroke-dash: 2
}
exchange -> routing_keys.rk2: "" {
  style.stroke: "#F0B27A"
  style.stroke-width: 1
  style.stroke-dash: 2
}
exchange -> routing_keys.rk3: "" {
  style.stroke: "#F0B27A"
  style.stroke-width: 1
  style.stroke-dash: 2
}
exchange -> routing_keys.rk4: "" {
  style.stroke: "#F0B27A"
  style.stroke-width: 1
  style.stroke-dash: 2
}
routing_keys.rk1 -> queues.analytics_q: "binding\nurl.clicked" {
  style: {
    stroke: "#27AE60"
    stroke-width: 2
    font-color: "#A9DFBF"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: true
  }
}
routing_keys.rk2 -> queues.notifications_q: "binding\nurl.created" {
  style: {
    stroke: "#27AE60"
    stroke-width: 2
    font-color: "#A9DFBF"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: true
  }
}
routing_keys.rk3 -> queues.notifications_q: "binding\nurl.deleted" {
  style: {
    stroke: "#27AE60"
    stroke-width: 2
    font-color: "#A9DFBF"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: true
  }
}
routing_keys.rk4 -> queues.notifications_q: "binding\nmilestone.reached" {
  style: {
    stroke: "#27AE60"
    stroke-width: 2
    font-color: "#A9DFBF"
    font-size: 11
  }
  target-arrowhead: {
    shape: triangle
    style.filled: true
  }
}
queues.analytics_q -> consumers.analytics_svc: "Basic.Consume\nauto-ack: false" {
  style: {
    stroke: "#CA6F1E"
    stroke-width: 2
    font-color: "#FAD7A0"
    font-size: 11
    animated: true
  }
  target-arrowhead: {
    shape: triangle
    style.filled: true
  }
}
queues.notifications_q -> consumers.notification_svc: "Basic.Consume\nauto-ack: false" {
  style: {
    stroke: "#CA6F1E"
    stroke-width: 2
    font-color: "#FAD7A0"
    font-size: 11
    animated: true
  }
  target-arrowhead: {
    shape: triangle
    style.filled: true
  }
}
queues.analytics_q -> queues.dlq_placeholder: "nack(requeue=false)\n[future]" {
  style: {
    stroke: "#E74C3C"
    stroke-width: 1
    stroke-dash: 5
    font-color: "#F1948A"
    font-size: 10
  }
  target-arrowhead: {
    shape: diamond
    style.filled: false
  }
}
queues.notifications_q -> queues.dlq_placeholder: "nack(requeue=false)\n[future]" {
  style: {
    stroke: "#E74C3C"
    stroke-width: 1
    stroke-dash: 5
    font-color: "#F1948A"
    font-size: 10
  }
  target-arrowhead: {
    shape: diamond
    style.filled: false
  }
}
consumers.analytics_svc -> queues.analytics_q: "ACK / NACK" {
  style: {
    stroke: "#717D7E"
    stroke-width: 1
    stroke-dash: 3
    font-color: "#AEB6BF"
    font-size: 10
  }
  target-arrowhead: {
    shape: arrow
  }
}
consumers.notification_svc -> queues.notifications_q: "ACK / NACK" {
  style: {
    stroke: "#717D7E"
    stroke-width: 1
    stroke-dash: 3
    font-color: "#AEB6BF"
    font-size: 10
  }
  target-arrowhead: {
    shape: arrow
  }
}
legend: |md
  **Legend**
  ━━ Solid animated → message flow (publish / consume)
  ╌╌ Dashed → binding definition / future feature
  ◇  Diamond arrowhead → future DLQ binding
  **Idempotency keys:** `EventID` (analytics) · `event_type:correlation_id` (notifications)
  **Declare rule:** each consumer declares its own queue + bindings on startup (idempotent)
| {
  near: bottom-center
  style: {
    fill: "#1C1C2E"
    stroke: "#555577"
    font-color: "#C0C0D0"
    font-size: 11
    border-radius: 6
  }
}