vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: |'md
  # Redis Key Namespace Layout (Dual Role)
  Intel Manual Quality Specification — Revision 1.0.4
'| {near: top-center}

# MEMORY LAYOUT REPRESENTATION
redis_keyspace: "Redis 7 Shared Keyspace (redis:6379)" {
  style: {
    fill: "#6c5ce7" # Purple Header
    stroke: "#4834d4"
    stroke-width: 4
    border-radius: 8
    font-color: white
    bold: true
  }

  # Namespace A: URL Shortener Cache
  url_ns: "0x00: Namespace A (url:*) [64B Boundary]" {
    style: {
      fill: "#0984e3" # Blue Data
      stroke: "#74b9ff"
      stroke-width: 2
      stroke-dash: 5 # Cache line dashed
      font-color: white
      bold: true
    }
    
    url_key_pattern: |'md
      ### Key Pattern (STRING)
      `url:{short_code}`
      - `0x00-0x03`: "url:"
      - `0x04-0x0A`: {base62_code}
    '| {
      style.fill: "#1e272e"
      style.stroke: "#53d8fb"
      style.font-color: white
    }

    url_value: |'md
      ### Value Layout (JSON)
      json
      {
        "original_url": string,
        "expires_at":   ISO8601,
        "is_active":    bool
      }
      
      *Size:* 256B (avg)
    '| {
      style.fill: "#1e272e"
      style.stroke: "#53d8fb"
      style.font-color: white
    }

    url_ttl: |'md
      ### TTL Logic
      `SET url:xyz EX 3600`
      - Default: 1h
      - Expired: 1s
    '| {
      style.fill: "#1e272e"
      style.stroke: "#e94560"
      style.font-color: white
    }
    
    restart_a: |'md
      **EVICTION POLICY:** Volatile-LRU
      **MISS IMPACT:** Fallback to PG (+15ms)
    '| {
      style.fill: "#1e272e"
      style.stroke: "#f5a623"
    }
  }

  # Padding / Boundary
  separator: "0x40: ──── NAMESPACE ISOLATION BOUNDARY ────" {
    style: {
      fill: "#636e72" # Gray Padding
      stroke: "#2d3436"
      stroke-width: 2
      font-color: white
      bold: true
    }
  }

  # Namespace B: Rate Limiter
  rl_ns: "0x41: Namespace B (rl:*) [64B Boundary]" {
    style: {
      fill: "#0984e3" # Blue Data
      stroke: "#a8ff78"
      stroke-width: 2
      stroke-dash: 5 # Cache line dashed
      font-color: white
      bold: true
    }

    rl_key_pattern: |'md
      ### Key Pattern (COUNTER)
      `rl:{route}:{ip}`
      - `0x00-0x02`: "rl:"
      - `0x03-0x0F`: {scoped_path}
    '| {
      style.fill: "#1e272e"
      style.stroke: "#a8ff78"
      style.font-color: white
    }

    rl_value: |'md
      ### Atomic Counter (INT)
      `INCRBY {key} 1`
      - Value: 4 bytes (uint32)
      - Atomic Lua Ops only
    '| {
      style.fill: "#1e272e"
      style.stroke: "#a8ff78"
      style.font-color: white
    }

    rl_ttl: |'md
      ### TTL Enforcement
      `EXPIRE {key} 60`
      - Fixed Window
      - No TTL reset on INCR
    '| {
      style.fill: "#1e272e"
      style.stroke: "#e94560"
      style.font-color: white
    }

    restart_b: |'md
      **EVICTION POLICY:** Noevict
      **MISS IMPACT:** Fail-open (Counter=0)
    '| {
      style.fill: "#1e272e"
      style.stroke: "#f5a623"
    }
  }
}

# ARCHITECTURE SPECIFICATIONS
collision_proof: "Security: Collision Matrix" {
  style: {
    fill: "#1e272e"
    stroke: "#53d8fb"
    stroke-width: 2
    font-color: white
  }
  proof: |'md
    | Byte | Offset | NS A (url) | NS B (rl) |
    |------|--------|------------|-----------|
    | 0    | 0x00   | 'u' (0x75) | 'r' (0x72) |
    | 1    | 0x01   | 'r' (0x72) | 'l' (0x6C) |
    | 2    | 0x02   | 'l' (0x6C) | ':' (0x3A) |
    | 3    | 0x03   | ':' (0x3A) | {route}    |
  '|
}

ttl_summary: "TTL Registry" {
  style: {
    fill: "#1e272e"
    stroke: "#a8ff78"
    stroke-width: 2
    font-color: white
  }
  table: |'md
    | Key Pattern | Max TTL | Strategy | Role |
    | :--- | :--- | :--- | :--- |
    | `url:*` | 3600s | Sliding | Cache |
    | `rl:*` | 60s | Fixed | Limiter |
  '|
}

# ACTORS & POINTERS
url_writer: "url-service" {
  shape: person
  style.fill: "#1a5276"
}

gw_writer: "api-gateway" {
  shape: person
  style.fill: "#1a5276"
}

postgres: "PostgreSQL [Source of Truth]" {
  shape: cylinder
  style.fill: "#27ae60" # Green Free/External
}

# CONNECTIONS (Orange = Pointers/Writes)
url_writer -> redis_keyspace.url_ns: "SETEX (Write)" {
  style.stroke: "#f39c12" # Orange Pointer
  style.stroke-width: 3
  style.animated: true
}

gw_writer -> redis_keyspace.rl_ns: "LUA INCR (Atomic)" {
  style.stroke: "#f39c12" # Orange Pointer
  style.stroke-width: 3
  style.animated: true
}

redis_keyspace.url_ns -> postgres: "MISS -> REPOPULATE" {
  style.stroke: "#9b59b6"
  style.stroke-dash: 4
}

collision_proof -> redis_keyspace.separator: "validates" {
  style.stroke: "#e94560"
  style.stroke-dash: 2
}

ttl_summary -> redis_keyspace: "applies" {
  style.stroke: "#2ecc71"
  style.stroke-dash: 2
}