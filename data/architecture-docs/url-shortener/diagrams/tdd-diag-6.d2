vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

title: ||md
  ## pgxpool Connection State Machine
  `ConnectDB` → `pgxpool.New()` → steady-state pool lifecycle
|| {near: top-center}

# ── States ───────────────────────────────────────────────────────────────────

UNINITIALIZED: {
  shape: rectangle
  style: {
    fill: "#2d2d2d"
    font-color: "#cccccc"
    stroke: "#555555"
    stroke-width: 2
    border-radius: 6
  }
  label: ||md
    **UNINITIALIZED**
    ---
    _invariant: no pool object exists_
    _no goroutines spawned_
    _service startup not yet reached §4.3_
  ||
}

CONNECTING: {
  shape: rectangle
  style: {
    fill: "#1a3a5c"
    font-color: "#7ec8e3"
    stroke: "#3a7ab5"
    stroke-width: 2
    border-radius: 6
  }
  label: ||md
    **CONNECTING**
    ---
    _invariant: pgxpool.New() called_
    _MinConns=2 dials in progress_
    _exponential backoff active_
    _attempt 1→500ms→1s→2s→4s cap_
  ||
}

IDLE_POOL: {
  shape: rectangle
  style: {
    fill: "#1a4a2e"
    font-color: "#7edda0"
    stroke: "#2e8b57"
    stroke-width: 2
    border-radius: 6
  }
  label: ||md
    **IDLE_POOL**
    ---
    _invariant: MinConns=2 alive_
    _MaxConns=10 ceiling not reached_
    _HealthCheckPeriod=1m running_
    _MaxConnLifetime=30m enforced_
    _MaxConnIdleTime=5m enforced_
    _pool.Ping() succeeds_
  ||
}

ACTIVE: {
  shape: rectangle
  style: {
    fill: "#3a1a5c"
    font-color: "#c4a0e8"
    stroke: "#7b4fa6"
    stroke-width: 2
    border-radius: 6
  }
  label: ||md
    **ACTIVE**
    ---
    _invariant: 1 ≤ in-flight ≤ MaxConns-1_
    _conn acquired from pool_
    _caller holds pgx.Conn or pgx.Tx_
    _pool may open new conns up to Max_
  ||
}

EXHAUSTED: {
  shape: rectangle
  style: {
    fill: "#5c3a1a"
    font-color: "#e8b47e"
    stroke: "#c07830"
    stroke-width: 2
    border-radius: 6
  }
  label: ||md
    **EXHAUSTED**
    ---
    _invariant: in-flight = MaxConns=10_
    _pool.Acquire() blocks callers_
    _next acquire queued on ctx_
    _context timeout → pgx error_
    _returns on any conn.Release()_
  ||
}

CLOSED: {
  shape: rectangle
  style: {
    fill: "#4a1a1a"
    font-color: "#e87e7e"
    stroke: "#b03030"
    stroke-width: 2
    border-radius: 6
  }
  label: ||md
    **CLOSED**
    ---
    _invariant: pool.Close() called_
    _all conns drained + closed_
    _further Acquire() returns error_
    _triggered by SIGTERM shutdown_
  ||
}

FATAL_EXIT: {
  shape: rectangle
  style: {
    fill: "#6b0000"
    font-color: "#ff6b6b"
    stroke: "#ff0000"
    stroke-width: 3
    border-radius: 4
  }
  label: ||md
    **FATAL EXIT**
    ---
    _log.Fatal().Err(err)_
    _os.Exit(1)_
    _Docker marks container unhealthy_
    _depends_on blocks downstream_
  ||
}

# ── Initial state marker ──────────────────────────────────────────────────────
initial: "" {
  shape: circle
  style.fill: "#ffffff"
  style.stroke: "#ffffff"
  width: 20
  height: 20
}

initial -> UNINITIALIZED: "" {
  style.stroke: "#ffffff"
  style.stroke-width: 2
}

# ── Normal transitions ────────────────────────────────────────────────────────

UNINITIALIZED -> CONNECTING: ||md
  pgxpool.New(ctx, dsn)
  config.MaxConns=10
  config.MinConns=2
  config.MaxConnLifetime=30m
  config.MaxConnIdleTime=5m
  config.HealthCheckPeriod=1m
|| {
  style.stroke: "#7ec8e3"
  style.stroke-width: 2
  style.font-color: "#7ec8e3"
  style.bold: true
}

CONNECTING -> IDLE_POOL: ||md
  pool.Ping(ctx) succeeds
  [within 5 attempts]
  log: "connected to DB"
  ConnectDB() returns pool
|| {
  style.stroke: "#7edda0"
  style.stroke-width: 2
  style.font-color: "#7edda0"
  style.bold: true
}

IDLE_POOL -> ACTIVE: ||md
  pool.Acquire(ctx)
  [conn available; in-flight < MaxConns]
  returns *pgxpool.Conn
|| {
  style.stroke: "#c4a0e8"
  style.stroke-width: 2
  style.font-color: "#c4a0e8"
}

ACTIVE -> IDLE_POOL: ||md
  conn.Release()
  [in-flight drops to 0]
  conn returned to pool
|| {
  style.stroke: "#7edda0"
  style.stroke-width: 2
  style.font-color: "#7edda0"
}

ACTIVE -> EXHAUSTED: ||md
  pool.Acquire(ctx)
  [in-flight reaches MaxConns=10]
  next caller blocks
|| {
  style.stroke: "#e8b47e"
  style.stroke-width: 2
  style.font-color: "#e8b47e"
}

EXHAUSTED -> ACTIVE: ||md
  conn.Release()
  [one slot freed]
  blocked Acquire() unblocks
|| {
  style.stroke: "#c4a0e8"
  style.stroke-width: 2
  style.font-color: "#c4a0e8"
}

ACTIVE -> CLOSED: ||md
  pool.Close()
  [on SIGTERM shutdown]
  drains in-flight conns
|| {
  style.stroke: "#e87e7e"
  style.stroke-width: 2
  style.font-color: "#e87e7e"
}

IDLE_POOL -> CLOSED: ||md
  pool.Close()
  [on SIGTERM shutdown]
  closes MinConns idle conns
|| {
  style.stroke: "#e87e7e"
  style.stroke-width: 2
  style.font-color: "#e87e7e"
}

EXHAUSTED -> CLOSED: ||md
  pool.Close()
  [on SIGTERM shutdown]
|| {
  style.stroke: "#e87e7e"
  style.stroke-width: 2
  style.font-color: "#e87e7e"
}

# ── FATAL edge ────────────────────────────────────────────────────────────────

CONNECTING -> FATAL_EXIT: ||md
  pool.Ping() fails
  [5 attempts exhausted]
  fmt.Errorf("connectDB: failed after 5 attempts: %w")
  log.Fatal → os.Exit(1)
|| {
  style.stroke: "#ff0000"
  style.stroke-width: 3
  style.stroke-dash: 3
  style.font-color: "#ff6b6b"
  style.bold: true
}

# ── ILLEGAL transitions (annotated) ──────────────────────────────────────────

illegal_closed_to_active: "ILLEGAL: Acquire after Close\n→ pgx returns error\nnever allowed" {
  shape: text
  style.font-color: "#ff4444"
  style.italic: true
  near: bottom-center
}

# ── Pool config annotation ────────────────────────────────────────────────────

config_note: {
  near: bottom-right
  style: {
    fill: "#1a1a2e"
    stroke: "#3a3a6e"
    font-color: "#aaaacc"
    border-radius: 8
  }
  label: ||md
    **pgxpool Config Applied in ConnectDB() [§4.3]**
    | Parameter | Value | Effect |
    |---|---|---|
    | `MaxConns` | 10 | ceiling; EXHAUSTED state |
    | `MinConns` | 2 | floor; IDLE\_POOL invariant |
    | `MaxConnLifetime` | 30m | force-recycle long conns |
    | `MaxConnIdleTime` | 5m | reclaim idle above MinConns |
    | `HealthCheckPeriod` | 1m | background ping; evicts dead conns |

    **Retry Schedule** (ConnectDB backoff):
    attempt 1 → immediate · 2 → 500ms · 3 → 1s · 4 → 2s · 5 → 4s → **FATAL**
  ||
}