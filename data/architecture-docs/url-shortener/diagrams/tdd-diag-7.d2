vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}
direction: right
title: |md
  ## Shared Domain Event Data Flow
  `shared/events` → Marshal → RabbitMQ Wire → Unmarshal → Consumers
| {near: top-center}
shared_events: "shared/events package" {
  style.fill: "#7C3AED"
  style.font-color: white
  style.border-radius: 6
  style.bold: true
  url_created: "URLCreatedEvent\n{ShortCode, OriginalURL,\nUserID, UserEmail,\nCorrelationID, ExpiresAt}" {
    style.fill: "#A78BFA"
    style.font-color: white
    style.font-size: 12
  }
  url_clicked: "URLClickedEvent\n{EventID, ShortCode,\nIPHash, UserAgent,\nCorrelationID}" {
    style.fill: "#A78BFA"
    style.font-color: white
    style.font-size: 12
  }
  url_deleted: "URLDeletedEvent\n{ShortCode, UserID,\nUserEmail, CorrelationID}" {
    style.fill: "#A78BFA"
    style.font-color: white
    style.font-size: 12
  }
  milestone: "MilestoneReachedEvent\n{ShortCode, UserID,\nUserEmail, Milestone,\nTotalClicks}" {
    style.fill: "#A78BFA"
    style.font-color: white
    style.font-size: 12
  }
}
url_service: "url-service\n(Producer)" {
  style.fill: "#1E40AF"
  style.font-color: white
  style.border-radius: 6
  style.bold: true
  import_note: |md
    `import shared/events`
    implements producer side
  | {style.fill: "#DBEAFE"; style.font-color: "#1E3A8A"; style.font-size: 11}
  go_struct: "Go struct\nDomainEvent interface\n(GetEventType(), GetOccurredAt())" {
    style.fill: "#3B82F6"
    style.font-color: white
    style.font-size: 12
  }
  marshal: "json.Marshal(event)\nerr → log.Error + skip" {
    style.fill: "#2563EB"
    style.font-color: white
    style.font-size: 12
  }
  byte_slice: "[]byte\n(JSON-encoded payload)" {
    style.fill: "#1D4ED8"
    style.font-color: white
    style.font-size: 12
  }
  outbox_insert: "outboxRepo.Insert(ctx, tx,\n  event.GetEventType(),\n  payload)" {
    style.fill: "#1E40AF"
    style.font-color: white
    style.font-size: 12
    style.border-radius: 4
  }
  amqp_pub: "amqp091.Publishing{\n  ContentType: application/json\n  DeliveryMode: Persistent\n  Body: []byte\n}" {
    style.fill: "#1E3A8A"
    style.font-color: white
    style.font-size: 12
  }
  go_struct -> marshal: "DomainEvent" {style.font-size: 11; style.bold: true; style.stroke: "#60A5FA"}
  marshal -> byte_slice: "[]byte" {style.font-size: 11; style.bold: true; style.stroke: "#60A5FA"}
  byte_slice -> outbox_insert: "[]byte (payload)" {style.font-size: 11; style.stroke: "#60A5FA"}
  outbox_insert -> amqp_pub: "outbox poller\nreads payload\nfrom DB" {style.font-size: 10; style.stroke-dash: 4; style.stroke: "#93C5FD"}
}
rabbitmq: "RabbitMQ\nExchange: url-shortener (topic)" {
  style.fill: "#B45309"
  style.font-color: white
  style.border-radius: 8
  style.bold: true
  exchange: "Topic Exchange\nurl-shortener" {
    style.fill: "#D97706"
    style.font-color: white
    style.font-size: 12
    style.border-radius: 6
  }
  wire: "AMQP Wire Format\nrouting_key: url.clicked\nrouting_key: url.created\nrouting_key: url.deleted\nrouting_key: milestone.reached" {
    style.fill: "#92400E"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 4
  }
  q_analytics: "Queue: analytics.clicks\nbinding: url.clicked" {
    style.fill: "#78350F"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 4
  }
  q_notifications: "Queue: notifications.events\nbindings: url.created\n          url.deleted\n          milestone.reached" {
    style.fill: "#78350F"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 4
  }
  exchange -> wire: "fanout by routing_key" {style.font-size: 10; style.stroke: "#FCD34D"}
  wire -> q_analytics: "url.clicked" {style.font-size: 11; style.bold: true; style.stroke: "#FCD34D"}
  wire -> q_notifications: "url.created\nurl.deleted\nmilestone.reached" {style.font-size: 11; style.bold: true; style.stroke: "#FCD34D"}
}
analytics_service: "analytics-service\n(Consumer)" {
  style.fill: "#065F46"
  style.font-color: white
  style.border-radius: 6
  style.bold: true
  import_note2: |md
    `import shared/events`
    implements consumer side
  | {style.fill: "#D1FAE5"; style.font-color: "#064E3B"; style.font-size: 11}
  delivery_a: "amqp091.Delivery\n.Body []byte\n.RoutingKey: url.clicked" {
    style.fill: "#059669"
    style.font-color: white
    style.font-size: 12
  }
  unmarshal_a: "json.Unmarshal(\n  d.Body,\n  &URLClickedEvent{})" {
    style.fill: "#047857"
    style.font-color: white
    style.font-size: 12
  }
  go_struct_a: "URLClickedEvent\n{EventID, ShortCode,\nIPHash, OccurredAt,\nCorrelationID}" {
    style.fill: "#065F46"
    style.font-color: white
    style.font-size: 12
  }
  idempotency: "processedRepo.\nIsProcessed(EventID)\n→ deduplicate" {
    style.fill: "#064E3B"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 4
  }
  click_insert: "clickRepo.Insert(\n  Click{ShortCode,\n  ClickedAt: OccurredAt,\n  IPHash, UserAgent})" {
    style.fill: "#064E3B"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 4
  }
  delivery_a -> unmarshal_a: "[]byte (Body)" {style.font-size: 11; style.bold: true; style.stroke: "#6EE7B7"}
  unmarshal_a -> go_struct_a: "URLClickedEvent" {style.font-size: 11; style.bold: true; style.stroke: "#6EE7B7"}
  go_struct_a -> idempotency: "EventID\n(dedup key)" {style.font-size: 11; style.stroke: "#6EE7B7"}
  idempotency -> click_insert: "not duplicate\n→ insert" {style.font-size: 10; style.stroke-dash: 4; style.stroke: "#A7F3D0"}
}
notification_service: "notification-service\n(Consumer)" {
  style.fill: "#831843"
  style.font-color: white
  style.border-radius: 6
  style.bold: true
  import_note3: |md
    `import shared/events`
    implements consumer side
  | {style.fill: "#FCE7F3"; style.font-color: "#831843"; style.font-size: 11}
  delivery_n: "amqp091.Delivery\n.Body []byte\n.RoutingKey: url.created\n             url.deleted\n             milestone.reached" {
    style.fill: "#BE185D"
    style.font-color: white
    style.font-size: 11
  }
  route_switch: "SWITCH d.RoutingKey\n→ parse into correct\n  event struct" {
    style.fill: "#9D174D"
    style.font-color: white
    style.font-size: 12
    style.border-radius: 4
  }
  unmarshal_n_a: "json.Unmarshal →\nURLCreatedEvent" {
    style.fill: "#831843"
    style.font-color: white
    style.font-size: 11
  }
  unmarshal_n_b: "json.Unmarshal →\nURLDeletedEvent" {
    style.fill: "#831843"
    style.font-color: white
    style.font-size: 11
  }
  unmarshal_n_c: "json.Unmarshal →\nMilestoneReachedEvent" {
    style.fill: "#831843"
    style.font-color: white
    style.font-size: 11
  }
  notif_insert: "repo.Insert(\n  Notification{\n  UserID, EventType,\n  Payload: d.Body})" {
    style.fill: "#500724"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 4
  }
  mock_send: "log.Info()\n\"would send email\nto user\"" {
    style.fill: "#500724"
    style.font-color: white
    style.font-size: 11
    style.border-radius: 4
  }
  delivery_n -> route_switch: "[]byte (Body)" {style.font-size: 11; style.bold: true; style.stroke: "#F9A8D4"}
  route_switch -> unmarshal_n_a: "url.created" {style.font-size: 10; style.stroke: "#F9A8D4"}
  route_switch -> unmarshal_n_b: "url.deleted" {style.font-size: 10; style.stroke: "#F9A8D4"}
  route_switch -> unmarshal_n_c: "milestone.reached" {style.font-size: 10; style.stroke: "#F9A8D4"}
  unmarshal_n_a -> notif_insert: "UserID\nUserEmail\nCorrelationID" {style.font-size: 10; style.stroke: "#F9A8D4"}
  unmarshal_n_b -> notif_insert: "UserID\nUserEmail\nCorrelationID" {style.font-size: 10; style.stroke: "#F9A8D4"}
  unmarshal_n_c -> notif_insert: "UserID\nUserEmail\nMilestone" {style.font-size: 10; style.stroke: "#F9A8D4"}
  notif_insert -> mock_send: "status=sent\nsent_at=now()" {style.font-size: 10; style.stroke-dash: 4; style.stroke: "#FBCFE8"}
}
shared_events.url_created -> url_service.go_struct: "import: URLCreatedEvent\nURLClickedEvent\nURLDeletedEvent" {
  style.stroke: "#A78BFA"
  style.stroke-width: 2
  style.stroke-dash: 5
  style.font-size: 10
}
shared_events.url_clicked -> analytics_service.import_note2: "import: URLClickedEvent" {
  style.stroke: "#A78BFA"
  style.stroke-width: 2
  style.stroke-dash: 5
  style.font-size: 10
}
shared_events.milestone -> notification_service.import_note3: "import: URLCreatedEvent\nURLDeletedEvent\nMilestoneReachedEvent" {
  style.stroke: "#A78BFA"
  style.stroke-width: 2
  style.stroke-dash: 5
  style.font-size: 10
}
url_service.amqp_pub -> rabbitmq.exchange: "amqp091.Publishing\n{Body: []byte\n ContentType: application/json\n DeliveryMode: Persistent}" {
  style.stroke: "#F59E0B"
  style.stroke-width: 3
  style.bold: true
  style.font-size: 11
}
rabbitmq.q_analytics -> analytics_service.delivery_a: "amqp091.Delivery\n{Body: []byte\n RoutingKey: url.clicked\n Redelivered: bool}" {
  style.stroke: "#6EE7B7"
  style.stroke-width: 3
  style.bold: true
  style.font-size: 11
}
rabbitmq.q_notifications -> notification_service.delivery_n: "amqp091.Delivery\n{Body: []byte\n RoutingKey: url.created|\n  url.deleted|\n  milestone.reached}" {
  style.stroke: "#F9A8D4"
  style.stroke-width: 3
  style.bold: true
  style.font-size: 11
}
legend: {
  near: bottom-center
  style.fill: "#F8FAFC"
  style.stroke: "#CBD5E1"
  style.border-radius: 6
  content: |md
    **Legend**
    — — → Import (shared/events package boundary)
    ——→  Data flow (Go struct / []byte / AMQP message)
    **Purple** shared/events structs  ·  **Blue** url-service (producer)
    **Amber** RabbitMQ broker          ·  **Green** analytics-service (consumer)
    **Pink** notification-service (consumer)
    At-least-once delivery: NACK + requeue on transient errors; idempotency via EventID (analytics) and event_key (notifications)
  |
}