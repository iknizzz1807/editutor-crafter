vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}
direction: right
title: "User Service Module Architecture" {
  shape: text
  near: top-center
  style: {
    font-size: 28
    bold: true
  }
}
env_block: "Environment" {
  style.fill: "#2d2d2d"
  style.stroke: "#888888"
  style.font-color: "#ffffff"
  style.border-radius: 6
  jwt_secret: "JWT_SECRET\n(≥ 32 bytes)" {
    style.fill: "#5a3e6b"
    style.font-color: "#f0e0ff"
    style.border-radius: 4
    style.font: mono
  }
}
domain: "Domain Entities  (user-service/repository)" {
  style.fill: "#1a1a2e"
  style.stroke: "#7b5ea7"
  style.border-radius: 8
  User: "User" {
    shape: class
    style.fill: "#3b2060"
    style.font-color: "#e8d5ff"
    ID: "ID           uuid.UUID"
    Email: "Email        string"
    PasswordHash: "PasswordHash string"
    CreatedAt: "CreatedAt    time.Time"
  }
}
auth_pkg: "auth/" {
  style.fill: "#0d1f2d"
  style.stroke: "#4a90d9"
  style.border-radius: 8
  Claims: "Claims" {
    shape: class
    style.fill: "#1a3a5c"
    style.font-color: "#d0eaff"
    Sub: "Sub   string  (uuid)"
    Email: "Email string"
    Iat: "Iat   time.Time"
    Exp: "Exp   time.Time"
    Iss: "Iss   string  (\"url-shortener\")"
  }
  PasswordHasher: "PasswordHasher" {
    shape: class
    style.fill: "#0f2c40"
    style.stroke: "#4a90d9"
    style.font-color: "#d0eaff"
    "Hash(plaintext string)": "(string, error)"
    "Compare(hash, plaintext string)": "error"
  }
  bcryptHasher: "bcryptHasher" {
    shape: class
    style.fill: "#0a1e2e"
    style.font-color: "#a8d4f0"
    "cost": "12 (constant)"
    "Hash(plaintext string)": "(string, error)"
    "Compare(hash, plaintext string)": "error"
  }
  JWTSigner: "JWTSigner" {
    shape: class
    style.fill: "#0f2c40"
    style.stroke: "#4a90d9"
    style.font-color: "#d0eaff"
    "Sign(claims Claims)": "(string, error)"
  }
  JWTVerifier: "JWTVerifier" {
    shape: class
    style.fill: "#0f2c40"
    style.stroke: "#4a90d9"
    style.font-color: "#d0eaff"
    "Verify(tokenString string)": "(Claims, error)"
  }
  jwtImpl: "jwtSigner / jwtVerifier" {
    shape: class
    style.fill: "#0a1e2e"
    style.font-color: "#a8d4f0"
    "secret": "[]byte (from JWT_SECRET)"
    "Sign(claims Claims)": "(string, error)  HS256"
    "Verify(tokenString string)": "(Claims, error)  HS256"
  }
}
repo_pkg: "repository/" {
  style.fill: "#1a2010"
  style.stroke: "#6abf69"
  style.border-radius: 8
  UserRepository: "UserRepository" {
    shape: class
    style.fill: "#1f3a10"
    style.stroke: "#6abf69"
    style.font-color: "#d0f0c0"
    "Create(ctx, u User)": "error"
    "FindByEmail(ctx, email)": "(User, error)"
  }
  pgxUserRepository: "pgxUserRepository" {
    shape: class
    style.fill: "#0f2008"
    style.font-color: "#a8d8a0"
    "pool": "*pgxpool.Pool"
    "Create(ctx, u User)": "error  (23505→ErrDuplicateEmail)"
    "FindByEmail(ctx, email)": "(User, error)  →ErrUserNotFound"
  }
}
service_pkg: "service/" {
  style.fill: "#2a1a08"
  style.stroke: "#d4a017"
  style.border-radius: 8
  UserService: "UserService" {
    shape: class
    style.fill: "#3d2710"
    style.font-color: "#ffe0a0"
    "repo": "UserRepository"
    "hasher": "PasswordHasher"
    "signer": "JWTSigner"
    "log": "zerolog.Logger"
    "Register(ctx, email, pass)": "(User, error)"
    "Login(ctx, email, pass)": "(token string, exp time.Time, err error)"
  }
}
handler_pkg: "handler/" {
  style.fill: "#1a0a1a"
  style.stroke: "#c06060"
  style.border-radius: 8
  RegisterHandler: "RegisterHandler" {
    shape: class
    style.fill: "#3a1010"
    style.font-color: "#ffc0c0"
    "NewRegisterHandler(svc, log)": "http.HandlerFunc"
    "POST /register": "→ 201 RegisterResponse | 400 | 409"
  }
  LoginHandler: "LoginHandler" {
    shape: class
    style.fill: "#3a1010"
    style.font-color: "#ffc0c0"
    "NewLoginHandler(svc, log)": "http.HandlerFunc"
    "POST /login": "→ 200 LoginResponse | 400 | 401"
  }
  MeHandler: "MeHandler" {
    shape: class
    style.fill: "#3a1010"
    style.font-color: "#ffc0c0"
    "NewMeHandler(log)": "http.HandlerFunc"
    "GET /me": "→ 200 MeResponse | 401  (no DB call)"
  }
}
middleware_pkg: "shared/middleware/" {
  style.fill: "#0a1a2a"
  style.stroke: "#4a8abf"
  style.border-radius: 8
  RequireAuth: "RequireAuth" {
    shape: class
    style.fill: "#102030"
    style.font-color: "#a0c8e8"
    "RequireAuth(verifier, log)": "func(http.Handler) http.Handler"
    "ClaimsFromContext(ctx)": "(Claims, bool)"
  }
}
sentinels: "Sentinel Errors" {
  shape: text
  style.fill: "#1a1a1a"
  style.font-color: "#ff9999"
  style.border-radius: 4
  near: bottom-center
  label: |md
    **ErrDuplicateEmail** · **ErrUserNotFound** · **ErrPasswordMismatch**
    **ErrAuthFailed** · **ErrTokenExpired** · **ErrTokenInvalid**
  |
}
# ── Interface implementations (hollow triangle = implements) ──────────────
auth_pkg.bcryptHasher -> auth_pkg.PasswordHasher: "implements" {
  target-arrowhead.shape: triangle
  target-arrowhead.style.filled: false
  style.stroke-dash: 4
  style.stroke: "#4a90d9"
}
auth_pkg.jwtImpl -> auth_pkg.JWTSigner: "implements" {
  target-arrowhead.shape: triangle
  target-arrowhead.style.filled: false
  style.stroke-dash: 4
  style.stroke: "#4a90d9"
}
auth_pkg.jwtImpl -> auth_pkg.JWTVerifier: "implements" {
  target-arrowhead.shape: triangle
  target-arrowhead.style.filled: false
  style.stroke-dash: 4
  style.stroke: "#4a90d9"
}
repo_pkg.pgxUserRepository -> repo_pkg.UserRepository: "implements" {
  target-arrowhead.shape: triangle
  target-arrowhead.style.filled: false
  style.stroke-dash: 4
  style.stroke: "#6abf69"
}
# ── Service owns its deps (solid arrow = owns/injects) ───────────────────
service_pkg.UserService -> repo_pkg.UserRepository: "repo" {
  style.stroke: "#6abf69"
  style.stroke-width: 2
}
service_pkg.UserService -> auth_pkg.PasswordHasher: "hasher" {
  style.stroke: "#4a90d9"
  style.stroke-width: 2
}
service_pkg.UserService -> auth_pkg.JWTSigner: "signer" {
  style.stroke: "#4a90d9"
  style.stroke-width: 2
}
# ── Handlers depend on UserService (dashed = references) ─────────────────
handler_pkg.RegisterHandler -> service_pkg.UserService: "Register()" {
  style.stroke-dash: 5
  style.stroke: "#d4a017"
}
handler_pkg.LoginHandler -> service_pkg.UserService: "Login()" {
  style.stroke-dash: 5
  style.stroke: "#d4a017"
}
# MeHandler reads from context only (no svc call)
handler_pkg.MeHandler -> middleware_pkg.RequireAuth: "ClaimsFromContext()" {
  style.stroke-dash: 5
  style.stroke: "#888888"
}
# ── Middleware depends on Verifier ────────────────────────────────────────
middleware_pkg.RequireAuth -> auth_pkg.JWTVerifier: "Verify()" {
  style.stroke-dash: 5
  style.stroke: "#4a90d9"
}
# ── JWT_SECRET injection ──────────────────────────────────────────────────
env_block.jwt_secret -> auth_pkg.jwtImpl: "[]byte(JWT_SECRET)\nat startup" {
  style.stroke: "#c06060"
  style.stroke-width: 2
  style.stroke-dash: 3
}
env_block.jwt_secret -> middleware_pkg.RequireAuth: "[]byte(JWT_SECRET)\nat startup" {
  style.stroke: "#c06060"
  style.stroke-width: 2
  style.stroke-dash: 3
}
# ── Claims produced by signer, consumed by verifier ──────────────────────
auth_pkg.JWTSigner -> auth_pkg.Claims: "produces" {
  style.stroke: "#888888"
  style.stroke-dash: 6
  target-arrowhead.shape: arrow
}
auth_pkg.JWTVerifier -> auth_pkg.Claims: "returns" {
  style.stroke: "#888888"
  style.stroke-dash: 6
  target-arrowhead.shape: arrow
}
# ── User entity flows through repo and service ────────────────────────────
repo_pkg.UserRepository -> domain.User: "stores / returns" {
  style.stroke: "#7b5ea7"
  style.stroke-dash: 6
}