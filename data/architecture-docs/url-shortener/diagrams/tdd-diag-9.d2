vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

direction: down

title: |'md
### `users` Table — PostgreSQL Row & Index Memory Layout
**Module:** url-shortener-m2 · `migrations/001_create_users.sql`
'| {
  near: top-center
}

# ── Row Layout (Heap Page Segment) ──────────────────────────────────────────
row: "PostgreSQL Heap Row (8-byte aligned)" {
  style: {
    fill: "#1a1a2e"
    stroke: "#4a4a8a"
    stroke-width: 4 # Represents page boundary thickness
    border-radius: 6
  }

  header: {
    label: |'md
**HeapTupleHeader**
Offset: **+00** | Size: **23B**
───────────────────────────
`t_xmin`, `t_xmax`, `t_cid`, `t_ctid`
Fixed system metadata for MVCC
'|
    style: {
      fill: "#6b21a8"
      stroke: "#6b21a8"
      font-color: "#f3e8ff"
    }
  }

  null_map: {
    label: |'md
**NULL Bitmap**
Offset: **+23** | Size: **1B**
───────────────────────────
Padding/Bitmap for NULL fields
'|
    style: {
      fill: "#4b5563"
      stroke: "#9ca3af"
      font-color: "#d1d5db"
    }
  }

  f_id: {
    label: |'md
**`id`** (UUID)
Offset: **+24** | Size: **16B**
───────────────────────────
`gen_random_uuid()`
128-bit Binary representation
'|
    style: {
      fill: "#2563eb"
      stroke: "#2563eb"
      font-color: "#eff6ff"
    }
  }

  cache_line_boundary: "--- 64B CACHE LINE BOUNDARY ---" {
    style: {
      stroke: "#9ca3af"
      stroke-dash: 5
      font-color: "#9ca3af"
      font-size: 10
    }
  }

  f_email: {
    label: |'md
**`email`** (TEXT)
Offset: **+40** | Size: **4B+Var**
──────────────────────────────
Varlena header (4B) + Content
`UNIQUE NOT NULL`
'|
    style: {
      fill: "#2563eb"
      stroke: "#2563eb"
      font-color: "#eff6ff"
    }
  }

  f_pw: {
    label: |'md
**`password_hash`** (TEXT)
Offset: **Dynamic** | Size: **64B**
───────────────────────────────
bcrypt (60B) + varlena (4B)
Inline storage (< 2KB)
'|
    style: {
      fill: "#2563eb"
      stroke: "#2563eb"
      font-color: "#eff6ff"
    }
  }

  f_cat: {
    label: |'md
**`created_at`** (TIMESTAMPTZ)
Offset: **Dynamic** | Size: **8B**
──────────────────────────────
64-bit int (µs since PG epoch)
'|
    style: {
      fill: "#2563eb"
      stroke: "#2563eb"
      font-color: "#eff6ff"
    }
  }

  padding: {
    label: |'md
**Alignment Padding**
Offset: **End** | Size: **~Var**
──────────────────────────────
Aligns row to 8-byte boundary
'|
    style: {
      fill: "#4b5563"
      stroke: "#9ca3af"
      font-color: "#9ca3af"
    }
  }
}

# ── Index Structures ─────────────────────────────────────────────────────────
indexes: "Index Pages (8KB Pages)" {
  style: {
    fill: "#0f2027"
    stroke: "#f97316"
    stroke-width: 2
    border-radius: 6
  }

  idx_pk: {
    label: |'md
**PRIMARY KEY** (`id`)
B-tree Leaf Entry
──────────────────────
**UUID(16B) + CTID(6B)**
Size: **22B**
'|
    style: {
      fill: "#7c2d12"
      stroke: "#f97316"
      font-color: "#ffedd5"
    }
  }

  idx_email: {
    label: |'md
**UNIQUE INDEX** (`email`)
B-tree Leaf Entry
──────────────────────
**Email(Var) + CTID(6B)**
Avg Size: **~36B**
'|
    style: {
      fill: "#1e3a5f"
      stroke: "#f97316"
      font-color: "#bfdbfe"
    }
  }
}

# ── Metadata and Constraints ────────────────────────────────────────────────
security_note: {
  label: |'md
### Why UUID over SERIAL for `id`
| Feature | `SERIAL` (int4) | `UUID v4` (random) |
| :--- | :--- | :--- |
| **Size** | 4 bytes | 16 bytes |
| **Enumerable?** | ✅ Leak count | ❌ 2¹²² space |
| **Brute Force** | Easy `GET /43` | Infeasible |
| **Write Pattern** | Append only | Random spread |

**Verdict:** 16-byte UUID provides essential obfuscation of business metrics and prevents IDOR enumeration.
'|
  near: bottom-center
  style: {
    fill: "#0f1729"
    stroke: "#22d3ee"
    font-color: "#e0f2fe"
  }
}

toast_note: {
  label: |'md
**TOAST Threshold: 2 KB**
`email` and `password_hash` stay inline if row < 2KB. 
Prevents secondary I/O lookups for login credentials.
'|
  near: center-left
  style: {
    fill: "#042f2e"
    stroke: "#10b981"
    font-color: "#a7f3d0"
  }
}

# ── Connections (Pointers) ────────────────────────────────────────────────────
row.f_id -> indexes.idx_pk: "Indexed PK" {
  style: {
    stroke: "#f97316"
    stroke-width: 2
    stroke-dash: 4
  }
}

row.f_email -> indexes.idx_email: "Unique Index" {
  style: {
    stroke: "#f97316"
    stroke-width: 2
    stroke-dash: 4
  }
}

row -> toast_note: "Inline Storage" {
  style: {
    stroke: "#10b981"
    stroke-dash: 2
  }
}