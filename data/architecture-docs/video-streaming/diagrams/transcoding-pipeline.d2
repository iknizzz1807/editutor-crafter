title: Transcoding Pipeline Flow

classes: {
  container: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  process: {
    style.fill: "#16213e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  
  storage: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  
  decision: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  
  output: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.double-border: true
  }
}

upload_complete: Video Upload Complete {
  shape: circle
  class: process
}

create_job: Create Transcoding Job {
  class: process
}

database: Database {
  shape: cylinder
  class: storage
}

analyze_source: Analyze Source Video {
  class: process
}

determine_profiles: Determine Output Profiles {
  shape: diamond
  class: decision
}

spawn_workers: Spawn FFmpeg Workers {
  class: process
}

worker_container: FFmpeg Workers {
  class: container
  
  worker_720p: 720p Worker {
    class: process
  }
  
  worker_480p: 480p Worker {
    class: process
  }
  
  worker_360p: 360p Worker {
    class: process
  }
}

monitor_progress: Monitor Progress {
  class: process
}

check_completion: All Workers Complete? {
  shape: diamond
  class: decision
}

generate_segments: Generate HLS Segments {
  class: process
}

create_manifests: Create HLS Manifests {
  class: process
}

output_storage: HLS Output {
  shape: cylinder
  class: output
}

failure_handler: Handle Failures {
  class: process
  style.fill: "#d63031"
  style.stroke: "#e17055"
  style.font-color: "#ffffff"
}

upload_complete -> create_job
create_job -> database: Update job status
create_job -> analyze_source
analyze_source -> determine_profiles: Source specs
determine_profiles -> spawn_workers: Multiple profiles needed
spawn_workers -> worker_container.worker_720p
spawn_workers -> worker_container.worker_480p
spawn_workers -> worker_container.worker_360p
worker_container.worker_720p -> database: Update progress
worker_container.worker_480p -> database: Update progress
worker_container.worker_360p -> database: Update progress
database -> monitor_progress: Poll status
monitor_progress -> check_completion
check_completion -> generate_segments: Yes
check_completion -> monitor_progress: No
generate_segments -> create_manifests
create_manifests -> output_storage
output_storage -> database: Mark complete

worker_container.worker_720p -> failure_handler: On error
worker_container.worker_480p -> failure_handler: On error
worker_container.worker_360p -> failure_handler: On error
failure_handler -> database: Log failure
failure_handler -> spawn_workers: Retry