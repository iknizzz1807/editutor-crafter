direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

address_system: {
  label: "Memory Management Unit: Address Decomposition (mmu.c)"

  vaddr_layout: {
    shape: sql_table
    label: "32-bit Virtual Address (vaddr.h)"
    vpn: "Bits [31:12] | 20 bits | VPN (Virtual Page Number)"
    offset: "Bits [11:0]  | 12 bits | Page Offset"
    total: "Total: 32 bits | Page Size: 4096 bytes (2^12)"
  }

  extraction_logic: {
    label: "Extraction Logic (mmu.c)"
    
    vpn_calc: {
      label: "uint32_t get_vpn(uint32_t vaddr)"
      code: |'c
        // Shift right to isolate VPN bits
        return (vaddr >> 12) & 0xFFFFF;
      '|
      width: 350
    }

    offset_calc: {
      label: "uint32_t get_offset(uint32_t vaddr)"
      code: |'c
        // Mask lower 12 bits for offset
        return vaddr & 0xFFF;
      '|
      width: 350
    }
  }

  vaddr_layout.vpn -> extraction_logic.vpn_calc: "R-Shift | 12 bits | 0x001A3" {
    style: {
      stroke: "#2196F3"
      stroke-width: 2
      animated: true
    }
  }

  vaddr_layout.offset -> extraction_logic.offset_calc: "AND Mask | 0xFFF | 0xF7C" {
    style: {
      stroke: "#2196F3"
      stroke-width: 2
      animated: true
    }
  }
}

note_logic: {
  shape: callout
  label: "The 12-Bit Offset Rule"
  content: |'md
    **Page Alignment**
    Since pages are 4KB (2^12), the lower 
    12 bits uniquely identify every byte 
    within the page. These bits remain 
    identical in both Virtual and 
    Physical addresses.
  '|
}
note_logic.near: top-left

trace_example: {
  shape: sql_table
  label: "Trace: 0x001A3F7C"
  input: "Virtual Address | 0x001A3F7C"
  binary: "Binary (Part) | 0000...110100011 | 111101111100"
  vpn_res: "VPN Output | 0x001A3"
  off_res: "Offset Output | 0xF7C"
  style: {
    fill: "#E3F2FD"
    stroke: "#1976D2"
  }
}
trace_example.near: bottom-right