direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# LEGEND & COLOR SEMANTICS
legend: {
  shape: package
  label: "PTE Bit Semantics"
  hw_managed: "Hardware Set/Updated" {
    style: {
      fill: "#ff7e7e"
      stroke: red
      bold: true
    }
  }
  sw_managed: "Software/OS Defined" {
    style: {
      fill: "#7eaeff"
      stroke: blue
      bold: true
    }
  }
  reserved: "Reserved/Ignored" {
    style: {
      fill: "#d3d3d3"
      stroke: gray
    }
  }
}
legend.near: top-right

# SIMULATED PTE (FROM MILESTONE 1)
sim_pte: {
  shape: sql_table
  label: "struct pte_t (32-bit Simulated)"
  
  header: "Bit(s) | Field | Responsibility | Description"
  f0: "31:12 | PFN | OS | Physical Frame Number (20 bits)"
  f1: "11:08 | RSVD | - | Reserved / Future Use"
  f2: "07 | R | HW | Referenced bit (Set on any access)"
  f3: "06 | D | HW | Dirty bit (Set on write access only)"
  f4: "05 | R_PERM | OS | Read Permission (1=Allowed)"
  f5: "04 | W_PERM | OS | Write Permission (1=Allowed)"
  f6: "03:01 | RSVD | - | Reserved"
  f7: "00 | V | OS | Valid Bit (1=Present in RAM)"
  
  footer: "Total Size: 4 Bytes (32 bits)"

  # Apply Color Semantics to Rows
  f2.style: { fill: "#ff7e7e"; stroke: red }
  f3.style: { fill: "#ff7e7e"; stroke: red }
  f4.style: { fill: "#7eaeff"; stroke: blue }
  f5.style: { fill: "#7eaeff"; stroke: blue }
  f7.style: { fill: "#7eaeff"; stroke: blue }
  f1.style: { fill: "#d3d3d3"; stroke: gray }
  f6.style: { fill: "#d3d3d3"; stroke: gray }
}

# REAL X86_64 PTE FOR COMPARISON
x86_64_pte: {
  shape: sql_table
  label: "x86-64 PTE (64-bit Hardware Native)"
  
  header: "Bit(s) | Field | Name | Description"
  f0: "63:52 | Various | Protection | NX bit, etc."
  f1: "51:12 | Address | Physical Page | 40-bit Physical Address"
  f2: "11:09 | Avail | OS Use | Ignored by HW"
  f3: "07 | PS | Page Size | 0 for 4KB pages"
  f4: "06 | D | Dirty | Set by CPU on write"
  f5: "05 | A | Accessed | Set by CPU on any access"
  f6: "02 | U/S | User/Supervisor | 1=User access allowed"
  f7: "01 | R/W | Read/Write | 1=Writable"
  f8: "00 | P | Present | 1=In physical memory"

  footer: "Total Size: 8 Bytes (64 bits)"
  
  f4.style: { fill: "#ff7e7e"; stroke: red }
  f5.style: { fill: "#ff7e7e"; stroke: red }
  f7.style: { fill: "#7eaeff"; stroke: blue }
  f8.style: { fill: "#7eaeff"; stroke: blue }
}

# IMPLEMENTATION CODE BLOCK
implementation: {
  label: "C Definition (vmsim.h)"
  code: |'c
    typedef struct {
        uint32_t pfn        : 20; // [31:12]
        uint32_t _reserved2 :  4; // [11:8]
        uint32_t referenced :  1; // [7]
        uint32_t dirty      :  1; // [6]
        uint32_t perm_read  :  1; // [5]
        uint32_t perm_write :  1; // [4]
        uint32_t _reserved1 :  3; // [3:1]
        uint32_t valid      :  1; // [0]
    } pte_t;
  '|
  width: 350
}

# CONNECTORS
sim_pte -> x86_64_pte: "Architectural Mapping | Isomorphic | 32b -> 64b" {
  style.stroke-dash: 5
}

implementation -> sim_pte: "Defines Layout | 4 Bytes | sizeof(pte_t)"