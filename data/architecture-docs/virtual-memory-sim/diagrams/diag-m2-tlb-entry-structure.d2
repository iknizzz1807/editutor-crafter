direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- TLB ENTRY STRUCTURE (MEMORY LAYOUT) ---
tlb_entry: {
  shape: sql_table
  label: "struct tlb_entry_t (tlb.h)"
  
  f0: "bits [00:19] | uint32_t | vpn      // Tag: Virtual Page Number"
  f1: "bits [20:27] | uint16_t | asid     // Tag: Process Context Identifier"
  f2: "bits [28:47] | uint32_t | pfn      // Data: Physical Frame Number"
  f3: "bits [48:51] | uint8_t  | flags    // [V|D|R|W] Status Bits"
  f4: "bits [52:59] | uint8_t  | lru_age  // LRU Counter / Timestamp"
  
  sz: "Total: 60 bits (Packed) | 8-12 bytes padded"
}

# --- FLAG DECOMPOSITION ---
flags_breakdown: {
  shape: sql_table
  label: "Status Flags (bits 48-51)"
  
  v: "bit 48 | Valid      | 1=Entry is active"
  d: "bit 49 | Dirty      | 1=Page modified in TLB"
  r: "bit 50 | Referenced | 1=Accessed since load"
  w: "bit 51 | Writable   | 1=Write permitted"
}

# --- LOOKUP COMPONENT ---
mmu_lookup: {
  label: "Fully-Associative Lookup Logic"
  direction: down
  
  comparator: {
    label: "Parallel Search"
    code: |'c
      for (int i = 0; i < TLB_SIZE; i++) {
        if (tlb[i].valid && 
            tlb[i].asid == active_asid && 
            tlb[i].vpn == target_vpn) {
          return TLB_HIT;
        }
      }
    '|
  }
  
  input: "Search Key: (ASID, VPN)" {
    shape: parallelogram
  }
}

# --- EVICTION & COHERENCE ---
page_table: {
  shape: sql_table
  label: "Page Table Entry (RAM)"
  
  f0: "0x00 | PFN        | [31:12]"
  f1: "0x04 | Dirty Bit  | [bit 6]"
  f2: "0x04 | Ref Bit    | [bit 7]"
  
  note: "Target for Write-back"
}

# --- CONNECTIONS & FLOW ---
tlb_entry.f3 -> flags_breakdown: "Detailed view"

mmu_lookup.input -> mmu_lookup.comparator: "VPN + ASID | 28 bits"

tlb_entry -> mmu_lookup.comparator: "Tag Match" {
  style.stroke-dash: 3
}

tlb_entry -> page_table: "Write-back Policy" {
  label: "Dirty/Ref Bits | 2 bits | pte |= (tlb.D | tlb.R)"
  style: {
    stroke: "#ca052b"
    stroke-width: 2
    animated: true
  }
}

# --- METADATA CONTAINER ---
annotation: {
  near: bottom-center
  style: {
    fill: "#f8f9fa"
    stroke: "#dee2e6"
  }
  label: "Coherence Invariant: Dirty/Ref bits in TLB are authoritative. \nMust be synced to RAM before entry invalidation/reuse."
}