direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- Global Styles ---
classes: {
  hit: {
    style: {
      fill: "#d1e7dd"
      stroke: "#0f5132"
    }
  }
  miss: {
    style: {
      fill: "#f8d7da"
      stroke: "#842029"
    }
  }
  tlb_state: {
    shape: sql_table
    style: {
      font: mono
    }
  }
}

title: TLB Trace Analysis: Temporal & Spatial Locality (3-Slot Capacity) {
  near: top-center
  shape: rectangle
  style: {
    font-size: 24
    bold: true
    fill: "#f1f1f1"
  }
}

# --- Access Sequence ---

step1: {
  label: "1. R 0x00001000"
  class: miss
  detail: "VPN: 0x1 | Offset: 0x000"
  tlb: {
    class: tlb_state
    label: "TLB After Step 1"
    r0: "Idx | VPN | PFN | LRU"
    r1: "0   | 0x1 | 0x0 | 0 (New)"
    r2: "1   |  -  |  -  | -"
    r3: "2   |  -  |  -  | -"
  }
}

step2: {
  label: "2. R 0x00001004"
  class: hit
  detail: "VPN: 0x1 | Offset: 0x004"
  note: "Spatial Locality: Same Page"
  tlb: {
    class: tlb_state
    label: "TLB After Step 2"
    r0: "Idx | VPN | PFN | LRU"
    r1: "0   | 0x1 | 0x0 | 0 (Hit)"
    r2: "1   |  -  |  -  | -"
    r3: "2   |  -  |  -  | -"
  }
}

step3: {
  label: "3. W 0x00002000"
  class: miss
  detail: "VPN: 0x2 | Offset: 0x000"
  tlb: {
    class: tlb_state
    label: "TLB After Step 3"
    r0: "Idx | VPN | PFN | LRU"
    r1: "0   | 0x1 | 0x0 | 1"
    r2: "1   | 0x2 | 0x1 | 0 (New)"
    r3: "2   |  -  |  -  | -"
  }
}

step4: {
  label: "4. R 0x00001008"
  class: hit
  detail: "VPN: 0x1 | Offset: 0x008"
  note: "Temporal Locality: Page 0x1"
  tlb: {
    class: tlb_state
    label: "TLB After Step 4"
    r0: "Idx | VPN | PFN | LRU"
    r1: "0   | 0x1 | 0x0 | 0 (Hit)"
    r2: "1   | 0x2 | 0x1 | 1"
    r3: "2   |  -  |  -  | -"
  }
}

step5: {
  label: "5. R 0x00003000"
  class: miss
  detail: "VPN: 0x3 | Offset: 0x000"
  tlb: {
    class: tlb_state
    label: "TLB After Step 5"
    r0: "Idx | VPN | PFN | LRU"
    r1: "0   | 0x1 | 0x0 | 1"
    r2: "1   | 0x2 | 0x1 | 2"
    r3: "2   | 0x3 | 0x2 | 0 (New)"
  }
}

step6: {
  label: "6. R 0x00001000"
  class: hit
  detail: "VPN: 0x1 | Offset: 0x000"
  tlb: {
    class: tlb_state
    label: "TLB After Step 6"
    r0: "Idx | VPN | PFN | LRU"
    r1: "0   | 0x1 | 0x0 | 0 (Hit)"
    r2: "1   | 0x2 | 0x1 | 3 (Oldest)"
    r3: "2   | 0x3 | 0x2 | 1"
  }
}

step7: {
  label: "7. R 0x00004000"
  class: miss
  detail: "VPN: 0x4 | Offset: 0x000"
  evict: "EVICTION: VPN 0x2 (LRU)"
  tlb: {
    class: tlb_state
    label: "TLB After Step 7"
    r0: "Idx | VPN | PFN | LRU"
    r1: "0   | 0x1 | 0x0 | 1"
    r2: "1   | 0x4 | 0x3 | 0 (Replaced)"
    r3: "2   | 0x3 | 0x2 | 2"
  }
}

step8: {
  label: "8. W 0x00002000"
  class: miss
  detail: "VPN: 0x2 | Offset: 0x000"
  note: "Cold/Capacity Miss"
  tlb: {
    class: tlb_state
    label: "TLB After Step 8"
    r0: "Idx | VPN | PFN | LRU"
    r1: "0   | 0x1 | 0x0 | 2 (Oldest)"
    r2: "1   | 0x4 | 0x3 | 1"
    r3: "2   | 0x2 | 0x1 | 0 (Replaced 0x3)"
  }
}

# --- Connections ---

step1 -> step2: "mem_access_t | 8 bytes | R 0x1004"
step2 -> step3: "mem_access_t | 8 bytes | W 0x2000"
step3 -> step4: "mem_access_t | 8 bytes | R 0x1008"
step4 -> step5: "mem_access_t | 8 bytes | R 0x3000"
step5 -> step6: "mem_access_t | 8 bytes | R 0x1000"
step6 -> step7: "mem_access_t | 8 bytes | R 0x4000"
step7 -> step8: "mem_access_t | 8 bytes | W 0x2000"

# --- Annotations ---

legend: {
  shape: rectangle
  near: bottom-right
  hit_indicator: "Hit: Background Green" {
    class: hit
  }
  miss_indicator: "Miss: Background Red" {
    class: miss
  }
  logic: |md
    **LRU Policy**: 
    - 0 = Most Recently Used
    - Highest number = Victim for eviction
  |
}