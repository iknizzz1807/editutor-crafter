direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

classes: {
  fast_path: {
    style: {
      stroke: "#2ecc71"
      stroke-width: 4
    }
  }
  slow_path: {
    style: {
      stroke: "#e74c3c"
      stroke-dash: 4
      stroke-width: 2
    }
  }
  control_logic: {
    style: {
      fill: "#f3f4f6"
      stroke: "#6b7280"
    }
  }
}

# --- CPU EXECUTION STAGE ---
cpu: {
  shape: class
  label: "CPU Core (vmsim.c)"
  fields: |'c
    uint32_t pc;          // Program Counter
    uint16_t active_asid; // Address Space ID (CR3)
  '|
  methods: |'c
    void mem_op(uint32_t vaddr, bool is_write);
  '|
}

# --- ADDRESS DECOMPOSITION ---
splitter: {
  shape: sql_table
  label: "Address Decoder (mmu.c)"
  vpn: "0x00 | bits [31:12] | Virtual Page Number (VPN)"
  off: "0x04 | bits [11:0]  | Page Offset"
  sz: "Format: 20-bit VPN | 12-bit Offset"
}

# --- TLB (CACHE LAYER) ---
tlb_subsystem: {
  label: "TLB Subsystem (mmu.c:tlb)"
  direction: down
  
  tlb_cache: {
    shape: sql_table
    label: "TLB Entries (Fully Associative)"
    e0: "TAG: VPN=0x00401 | ASID=1 | PFN=0x00007 | V,R,W"
    e1: "TAG: VPN=0x00402 | ASID=1 | PFN=0x00008 | V,R"
    e_dots: "..."
    e63: "TAG: VPN=0x00FFF | ASID=1 | PFN=0x00010 | V"
  }

  lookup_logic: {
    shape: step
    label: "Parallel CAM Search"
    code: |'c
      for (int i=0; i<64; i++) {
        if (tlb[i].vpn == vpn && 
            tlb[i].asid == asid && 
            tlb[i].valid) return tlb[i].pfn;
      }
    '|
  }
}

# --- PAGE TABLE WALKER (MMU HW STATE MACHINE) ---
page_walker: {
  shape: step
  label: "Page Table Walker (Slow Path)"
  style.fill: "#fff3f3"
  code: |'c
    pde = pgdir[vaddr >> 22];
    if (!(pde & PDE_P)) raise_fault();
    pt = (pte_t*)(pde & ~0xFFF);
    pte = pt[(vaddr >> 12) & 0x3FF];
    if (!(pte & PTE_V)) raise_fault();
    return pte >> 12;
  '|
}

# --- MEMORY HIERARCHY ---
ram: {
  label: "Physical Memory (DRAM)"
  
  page_table: {
    shape: sql_table
    label: "Hierarchical Page Table (CR3)"
    pde: "0x00 | 4 bytes | Page Directory Entry"
    pte: "0x04 | 4 bytes | Page Table Entry"
    latency: "Walk Latency: ~200ns"
  }
}

# --- OUTPUT CONSTRUCTION ---
pa_gen: {
  shape: step
  label: "Address Constructor"
  code: |'c
    paddr = (pfn << 12) | offset;
  '|
}

final_mem: Physical RAM {
  shape: cylinder
  style.fill: "#e8f4ff"
}

# --- PIPELINE FLOWS ---

cpu -> splitter: "uint32_t | 4 bytes | 0x00401050"

splitter.vpn -> tlb_subsystem.lookup_logic: "vpn_t | 20 bits | 0x00401"
tlb_subsystem.lookup_logic -> tlb_subsystem.tlb_cache: "Compare | 20 bits | 0x00401"

# HIT PATH (Green/Fast)
tlb_subsystem.lookup_logic -> pa_gen: "pfn_t | 20 bits | 0x00007" {
  class: fast_path
  label: "TLB HIT (~1 Cycle)"
}

# MISS PATH (Red/Slow)
tlb_subsystem.lookup_logic -> page_walker: "vpn_t | 20 bits | 0x00401" {
  class: slow_path
  label: "TLB MISS (~200ns)"
}

page_walker -> ram.page_table: "Mem Read | 4 bytes | PDE/PTE Fetch"
ram.page_table -> page_walker: "pte_t | 4 bytes | 0x00007001"

page_walker -> pa_gen: "pfn_t | 20 bits | 0x00007" {
  class: slow_path
}

# TLB UPDATE
page_walker -> tlb_subsystem.tlb_cache: "Write | 8 bytes | tlb_insert()" {
  style.stroke-dash: 2
  label: "Fill TLB Entry"
}

splitter.off -> pa_gen: "uint12_t | 12 bits | 0x050"

pa_gen -> final_mem: "paddr_t | 4 bytes | 0x00007050"

# --- ANNOTATIONS ---
note: {
  shape: callout
  label: "Critical Path: TLB Hit bypasses the Page Table Walker entirely."
}
note.near: top-right

legend: {
  shape: sql_table
  label: "Performance Metrics"
  l1: "TLB Hit  | ~0.5ns       | 99% hit rate"
  l2: "TLB Miss | ~100ns       | Memory Latency"
  l3: "Page Flt | ~10,000,000ns | Disk Swap"
}
legend.near: bottom-right