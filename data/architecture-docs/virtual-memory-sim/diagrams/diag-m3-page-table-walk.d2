direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# 1. Address Context
address_context: {
  label: "Input: Virtual Address 0x00C07123"
  decomposition: |'c
    PDI (bits 31:22) = 0x003 (3)
    PTI (bits 21:12) = 0x007 (7)
    Offset (bits 11:0) = 0x123
  '|
  width: 300
}

# 2. CPU Registers
cpu: {
  shape: class
  label: "CPU Memory Management Unit"
  cr3: "CR3 Register: 0x00005000"
  logic: |'c
    void* pg_dir = (void*)CR3;
    PDE* pde = &pg_dir[PDI];
  '|
}

# 3. Level 1: Page Directory
page_directory: {
  shape: sql_table
  label: "Page Directory (at Phys: 0x5000)"
  row0: "0x5000 | PDE 0 | Present=0"
  row1: "0x5004 | PDE 1 | Present=0"
  row2: "0x5008 | PDE 2 | Present=0"
  row3: "0x500C | PDE 3 | Base: 0x8000, V=1"
  row_skip: "... | ... | ..."
  total: "Size: 4096 bytes (1024 entries)"
}

# 4. Level 2: Page Table
page_table: {
  shape: sql_table
  label: "Page Table (at Phys: 0x8000)"
  row0: "0x8000 | PTE 0 | Valid=0"
  row_skip1: "... | ... | ..."
  row7: "0x801C | PTE 7 | PFN: 0x0001A, V=1"
  row_skip2: "... | ... | ..."
  total: "Size: 4096 bytes (1024 entries)"
}

# 5. Physical RAM
physical_memory: {
  shape: sql_table
  label: "Physical Memory (PFN: 0x1A)"
  target: "0x1A000 + 0x123 | 0x1A123 | [ User Data ]"
  note: "Physical Frame Address: 0x1A000"
}

# Data Walk Paths
address_context -> cpu: "Control | 32-bit | 0x00C07123"

cpu -> page_directory.row3: "1. Memory Read | 100ns | Offset: PDI * 4" {
  style: {
    stroke: "#2979ff"
    stroke-width: 2
  }
}

page_directory.row3 -> page_table: "2. Follow Pointer | Base Address | 0x8000" {
  style: {
    stroke: "#2979ff"
  }
}

page_table.row7: "3. Memory Read | 100ns | Offset: PTI * 4" {
  near: top-center
}

page_table.row7 -> physical_memory.target: "4. Map to PFN | 20 bits | 0x1A" {
  style: {
    stroke: "#2979ff"
    stroke-width: 2
  }
}

# Analysis Summary
summary: {
  shape: callout
  label: "Walk Analysis"
  cost: "Total Translation Latency: 200ns"
  reads: "Memory Fetches: 2 (PDE + PTE)"
  overhead: "Mapping Overhead: 8KB for 1 page"
}
summary.near: bottom-right