direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

pde_comparison: {
  label: "Page Directory Entry (PDE) — Points to Metadata"
  
  pde_layout: {
    shape: sql_table
    label: "typedef uint32_t pde_t (32-bit)"
    f1: "[31:12] | uint32_t | pt_phys_addr // Phys address of next Page Table"
    f2: "[11:1]  | uint32_t | reserved    // System bits / ignored"
    f3: "[0]     | uint32_t | present     // 1 = Page Table exists"
    sz: "Total: 4 Bytes (points to 4KB Page Table)"
  }

  pde_logic: {
    label: "PDE Structural Role"
    code: |'c
      typedef uint32_t pde_t;
      #define PDE_PRESENT (1u << 0)
      #define PDE_ADDR_MASK 0xFFFFF000u
      
      // Points to a table, NOT data
      page_table_t* pt = (page_table_t*)pde_get_phys(pde);
    '|
  }
}

pte_comparison: {
  label: "Page Table Entry (PTE) — Points to User Data"
  
  pte_layout: {
    shape: sql_table
    label: "typedef uint32_t pte_t (32-bit)"
    f1: "[31:12] | uint32_t | pfn         // Phys address of Data Frame"
    f2: "[11:8]  | uint32_t | reserved    // System bits"
    f3: "[7]     | uint32_t | referenced  // Set by HW on access"
    f4: "[6]     | uint32_t | dirty       // Set by HW on write"
    f5: "[5]     | uint32_t | read_perm   // Permission bit"
    f6: "[4]     | uint32_t | write_perm  // Permission bit"
    f7: "[3:1]   | uint32_t | reserved    // Future use"
    f8: "[0]     | uint32_t | valid       // 1 = Data in RAM"
    sz: "Total: 4 Bytes (points to 4KB Physical Frame)"
  }

  pte_logic: {
    label: "PTE Structural Role"
    code: |'c
      typedef uint32_t pte_t;
      #define PTE_DIRTY (1u << 6)
      #define PTE_VALID (1u << 0)
      
      // Points to actual program data
      void* phys_ptr = (void*)pte_get_phys(pte);
    '|
  }
}

target_table: {
  label: "Page Table Frame"
  shape: package
  style.stroke-dash: 3
  rows: {
    shape: sql_table
    r1: "PTE[0]"
    r2: "PTE[1]"
    r3: "..."
    r4: "PTE[1023]"
  }
}

target_data: {
  label: "Physical Data Frame"
  shape: cylinder
  style.fill: "#E1F5FE"
  content: "User Heap/Stack/Code"
}

pde_comparison.pde_layout.f1 -> target_table: "PDE_ADDR | 20 bits | 0x8A123" {
  style.stroke: purple
}

pte_comparison.pte_layout.f1 -> target_data: "PFN | 20 bits | 0x00042" {
  style.stroke: blue
}

note: {
  label: "CRITICAL DIFFERENCE"
  text: |'md
    **Page Directory Entry (PDE)**:
    - Points to another management structure.
    - No Dirty Bit (directories are not "written to" by apps).
    
    **Page Table Entry (PTE)**:
    - Points to actual software data.
    - Contains full R/W/X permissions and Dirty/Referenced status.
  '|
}

note.near: top-center