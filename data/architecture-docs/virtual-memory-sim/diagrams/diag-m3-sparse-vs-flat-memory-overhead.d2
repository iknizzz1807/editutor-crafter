direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 3
  }
}

# --- PROCESS DEFINITION ---
process_context: {
  label: "Process Context (ASID: 0x01)"
  address_space: |md
    ### Sparse Memory Usage:
    - **Code**: 0x00001000 (VPN 0x01)
    - **Heap**: 0x40000000 (VPN 0x40000)
    - **Stack**: 0xFFFFF000 (VPN 0xFFFFF)
  |
}

# --- COMPARISON LAYERS ---
comparison: {
  direction: right

  # --- BEFORE: FLAT TABLE ---
  milestone_1: {
    label: "BEFORE: Flat Page Table (Milestone 1)"
    direction: down
    
    flat_table: {
      shape: sql_table
      label: "struct page_table (vmsim.c)"
      h0: "Offset | Size | Entry | Metadata"
      f0: "0x000000 | 4B | PTE 0 | Valid=0"
      f1: "0x000004 | 4B | PTE 1 | Valid=1 (PFN: 0x0A)"
      f_gap: "0x000008 | ... | PTE 2-262143 | Unused / Valid=0"
      f2: "0x100000 | 4B | PTE 262144 | Valid=1 (PFN: 0x1B)"
      f_gap2: "0x100004 | ... | PTE 262145-1048574 | Unused / Valid=0"
      f3: "0x3FFFFC | 4B | PTE 1048575 | Valid=1 (PFN: 0x3F)"
      total: "Total Memory Consumed: 4,194,304 bytes (4.0 MB)"
      
      style: {
        stroke: "#ca052b"
        stroke-width: 2
      }
    }
  }

  # --- AFTER: TWO-LEVEL TABLE ---
  milestone_3: {
    label: "AFTER: Two-Level Page Table (Milestone 3)"
    direction: right

    root: {
      pg_dir: {
        shape: sql_table
        label: "Page Directory (CR3 Root)"
        h0: "PDI | Size | PDE | Target"
        pdi0: "0x000 | 4B | PDE 0 | Present=1 (-> PT1)"
        pdi_null: "0x004 | 3.9KB | PDE 1-255 | NULL (Unmapped)"
        pdi256: "0x400 | 4B | PDE 256 | Present=1 (-> PT2)"
        pdi_null2: "0x404 | 2.9KB | PDE 257-1022 | NULL (Unmapped)"
        pdi1023: "0xFFC | 4B | PDE 1023 | Present=1 (-> PT3)"
        total: "Memory: 4,096 bytes"
        
        style: {
          stroke: "#167c3c"
          stroke-width: 2
        }
      }
    }

    leaves: {
      pt_code: {
        shape: sql_table
        label: "Page Table 1 (Code Region)"
        e0: "PTI 1 | PTE | Valid=1 (PFN: 0x0A)"
        other: "PTI 0, 2-1023 | PTE | Valid=0"
        total: "Memory: 4,096 bytes"
      }
      pt_heap: {
        shape: sql_table
        label: "Page Table 2 (Heap Region)"
        e0: "PTI 0 | PTE | Valid=1 (PFN: 0x1B)"
        other: "PTI 1-1023 | PTE | Valid=0"
        total: "Memory: 4,096 bytes"
      }
      pt_stack: {
        shape: sql_table
        label: "Page Table 3 (Stack Region)"
        e0: "PTI 1023 | PTE | Valid=1 (PFN: 0x3F)"
        other: "PTI 0-1022 | PTE | Valid=0"
        total: "Memory: 4,096 bytes"
      }
      
      direction: down
    }

    # Internal Connections
    root.pg_dir.pdi0 -> leaves.pt_code: "pde_t | 4B | phys_addr: 0x88000"
    root.pg_dir.pdi256 -> leaves.pt_heap: "pde_t | 4B | phys_addr: 0x89000"
    root.pg_dir.pdi1023 -> leaves.pt_stack: "pde_t | 4B | phys_addr: 0x8A000"
    
    summary: {
      shape: callout
      label: "Two-Level Total: 16,384 bytes (16 KB)"
      style.stroke: "#167c3c"
    }
  }
}

# --- GLOBAL ANNOTATIONS ---
process_context -> comparison.milestone_1: "Linear View"
process_context -> comparison.milestone_3: "Sparse View (Pruned)"

annotation: {
  near: bottom-center
  label: "Efficiency Ratio: 256:1 Overhead Reduction"
  style: {
    font-size: 20
    bold: true
    fill: "#C7F1FF"
  }
}