direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- Virtual Address Decomposition ---
vaddr: {
  shape: sql_table
  label: "32-bit Virtual Address Decomposition (vmsim_m3.c)"
  header: "Bits [31:30] | Bits [29:21] | Bits [20:12] | Bits [11:0]"
  row1: "L1 Index (2b) | L2 Index (9b) | L3 Index (9b) | Page Offset (12b)"
  row2: "4 Entries | 512 Entries | 512 Entries | 4096 Bytes"
}

# --- Register ---
cr3: {
  shape: sql_table
  label: "CPU Control Register"
  reg: "CR3 | Physical Base of L1 Table | 0x1000"
}

# --- Level 1: Root Table ---
l1_root: {
  shape: sql_table
  label: "L1 Root Table (16 Bytes)"
  e0: "0x00 | pde_t | L2 Table Ptr (Valid=1)"
  e1: "0x04 | pde_t | NULL (Present=0) -- Skips 1GB"
  e2: "0x08 | pde_t | NULL (Present=0) -- Skips 1GB"
  e3: "0x0C | pde_t | NULL (Present=0) -- Skips 1GB"
}

# --- Level 2: Mid-Level Directory ---
l2_mid: {
  shape: sql_table
  label: "L2 Mid-Level Directory (2048 Bytes)"
  e0: "0x000 | pde_t | L3 Table Ptr (Valid=1)"
  e1: "0x004 | pde_t | NULL (Present=0) -- Skips 2MB"
  dots: "... | ... | 510 hidden NULL entries"
  e511: "0x7FC | pde_t | NULL (Present=0)"
}

# --- Level 3: Leaf Page Table ---
l3_leaf: {
  shape: sql_table
  label: "L3 Leaf Page Table (2048 Bytes)"
  e0: "0x000 | pte_t | Physical Frame (Valid=1)"
  e1: "0x004 | pte_t | Physical Frame (Valid=1)"
  dots: "... | ... | 510 entries"
  e511: "0x7FC | pte_t | NULL (Valid=0)"
}

# --- Physical Frame ---
ram: {
  label: "Physical RAM"
  frame42: "Frame 42 (0x2A000)" {
    shape: cylinder
    style.fill: "#ACE1AF"
  }
}

# --- Logic / Tradeoff Annotation ---
tradeoff: {
  label: "Architectural Tradeoff"
  direction: down
  pros: "Memory Efficiency: 1 L1 (16B) + 1 L2 (2KB) + 1 L3 (2KB) = 4048 bytes for a 3-page process."
  cons: "Latency: 3 memory accesses per TLB miss (L1->L2, L2->L3, L3->PTE)."
  note: "Sparse space handling: NULL at L1 level prunes 25% of the 4GB space (1GB)."
  style.fill: "#FFF9C9"
}

# --- Connections (The Walk) ---
vaddr -> cr3: "Parse indices"
cr3 -> l1_root: "1st Access | Phys Addr | 0x1000"

l1_root.e0 -> l2_mid: "2nd Access | PDE | pde_make(0x2000)" {
  style.stroke: blue
}

l2_mid.e0 -> l3_leaf: "3rd Access | PDE | pde_make(0x3000)" {
  style.stroke: blue
}

l3_leaf.e0 -> ram.frame42: "PTE | PFN=42 | Offset 0x6A8" {
  style.stroke: green
}

# --- Walk Algorithm Step ---
walk_code: {
  label: "three_level_walk (vmsim_m3.c)"
  code: |'c
    pde_t *l2 = (pde_t*)pt3->root[i1];
    if (!pde_is_present(*l2)) return OOM;
    pde_t *l3 = (pde_t*)l2[i2];
    if (!pde_is_present(*l3)) return OOM;
    pte_t pte = ((pte_t*)l3)[i3];
    return pte_get_pfn(pte);
  '|
  width: 400
}

walk_code.near: bottom-right
tradeoff.near: top-right