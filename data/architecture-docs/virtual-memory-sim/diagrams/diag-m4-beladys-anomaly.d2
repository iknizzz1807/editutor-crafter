direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title_block: {
  shape: callout
  label: "Bélády's Anomaly: FIFO Performance Degradation\nRef String: 1, 2, 3, 4, 1, 2, 5, 1, 2, 3, 4, 5"
}

algo: {
  shape: class
  label: "FIFO Eviction Logic (vmsim.c)"
  fields: |'c
    phys_mem_t *pm;
    uint32_t victim_idx;
  '|
  methods: |'c
    static uint32_t fifo_select_victim(const phys_mem_t *pm);
  '|
}

fifo_logic: {
  shape: step
  label: "Selection Implementation (fifo.c)"
  width: 350
  code: |'c
    min_t = pm->desc[0].load_t;
    for (uint32_t i = 1; i < pm->num_frames; i++) {
        if (pm->desc[i].load_t < min_t) {
            min_t = pm->desc[i].load_t;
            victim = i;
        }
    }
    return victim;
  '|
}

simulation_view: {
  direction: right
  label: "Memory Comparison Simulation"

  fifo_3_frame: {
    shape: sql_table
    label: "FIFO (3 Physical Frames)"
    t01: "01 | VPN 1 | [ 1, -, - ] | FAULT"
    t02: "02 | VPN 2 | [ 1, 2, - ] | FAULT"
    t03: "03 | VPN 3 | [ 1, 2, 3 ] | FAULT"
    t04: "04 | VPN 4 | [ 4, 2, 3 ] | FAULT (1 out)"
    t05: "05 | VPN 1 | [ 4, 1, 3 ] | FAULT (2 out)"
    t06: "06 | VPN 2 | [ 4, 1, 2 ] | FAULT (3 out)"
    t07: "07 | VPN 5 | [ 5, 1, 2 ] | FAULT (4 out)"
    t08: "08 | VPN 1 | [ 5, 1, 2 ] | HIT"
    t09: "09 | VPN 2 | [ 5, 1, 2 ] | HIT"
    t10: "10 | VPN 3 | [ 5, 3, 2 ] | FAULT (1 out)"
    t11: "11 | VPN 4 | [ 5, 3, 4 ] | FAULT (2 out)"
    t12: "12 | VPN 5 | [ 5, 3, 4 ] | HIT"
    stats: "TOTAL FAULTS: 9"
    sz: "Capacity: 12 KB (3 frames)"
  }

  fifo_4_frame: {
    shape: sql_table
    label: "FIFO (4 Physical Frames)"
    t01: "01 | VPN 1 | [ 1, -, -, - ] | FAULT"
    t02: "02 | VPN 2 | [ 1, 2, -, - ] | FAULT"
    t03: "03 | VPN 3 | [ 1, 2, 3, - ] | FAULT"
    t04: "04 | VPN 4 | [ 1, 2, 3, 4 ] | FAULT"
    t05: "05 | VPN 1 | [ 1, 2, 3, 4 ] | HIT"
    t06: "06 | VPN 2 | [ 1, 2, 3, 4 ] | HIT"
    t07: "07 | VPN 5 | [ 5, 2, 3, 4 ] | FAULT (1 out)"
    t08: "08 | VPN 1 | [ 5, 1, 3, 4 ] | FAULT (2 out)"
    t09: "09 | VPN 2 | [ 5, 1, 2, 4 ] | FAULT (3 out)"
    t10: "10 | VPN 3 | [ 5, 1, 2, 3 ] | FAULT (4 out)"
    t11: "11 | VPN 4 | [ 4, 1, 2, 3 ] | FAULT (5 out)"
    t12: "12 | VPN 5 | [ 4, 5, 2, 3 ] | FAULT (1 out)"
    stats: "TOTAL FAULTS: 10"
    sz: "Capacity: 16 KB (4 frames)"
  }
}

lru_comparison: {
  shape: sql_table
  label: "LRU (Stack Algorithm) Immunity"
  hdr: "Frames | Faults (FIFO) | Faults (LRU)"
  f3: "  3    |      9       |      10      "
  f4: "  4    |     10       |       8      "
  total: "Result: LRU fault rate is monotonic"
}

root_cause: {
  shape: callout
  label: "The Anomaly Root Cause"
  description: |'md
    FIFO is not a **Stack Algorithm**.
    Adding a frame (K+1) can displace the oldest entry 
    just enough to miss a future access that would 
    have been a hit in the K-frame scenario.
  '|
}

algo -> fifo_logic: "selection logic"
simulation_view.fifo_3_frame -> simulation_view.fifo_4_frame: "phys_mem_t.num_frames++ | 4 KB | 4 frames"
simulation_view.fifo_4_frame -> lru_comparison: "Verification | size_t | 10 vs 8 faults"

simulation_view.fifo_3_frame.stats.style.fill: "#E3F2FD"
simulation_view.fifo_4_frame.stats.style.fill: "#FFEBEE"
simulation_view.fifo_4_frame.t12.style.stroke: "#D81B60"
simulation_view.fifo_4_frame.t12.style.stroke-width: 4

root_cause.near: bottom-right