direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

# --- STACK MAP ---
# Global logical clock: t=452
# Physical Memory: 16 Frames (currently full)

physical_memory: {
  label: "Physical Memory (phys_mem.c)"
  direction: down

  frame_pool: {
    grid-columns: 2
    
    f0: {
      shape: sql_table
      label: "Frame 0"
      row1: "VPN: 0x001A3 | PFN: 0"
      row2: "REF: 1 | DIRTY: 0"
      row3: "Age: t=410"
    }
    f1: {
      shape: sql_table
      label: "Frame 1"
      row1: "VPN: 0x004B0 | PFN: 1"
      row2: "REF: 1 | DIRTY: 1"
      row3: "Age: t=425"
      style.stroke: green
      style.stroke-width: 4
    }
    f2: {
      shape: sql_table
      label: "Frame 2 (VICTIM)"
      row1: "VPN: 0x008CC | PFN: 2"
      row2: "REF: 0 | DIRTY: 0"
      row3: "Age: t=380"
      style.stroke: red
      style.stroke-width: 4
    }
    f3: {
      shape: sql_table
      label: "Frame 3"
      row1: "VPN: 0x002FF | PFN: 3"
      row2: "REF: 1 | DIRTY: 0"
      row3: "Age: t=440"
    }
  }

  hand: "Clock Hand" {
    shape: circle
    style.fill: "#E4DBFE"
  }
}

# --- ALGORITHM LOGIC ---

replacement_logic: {
  label: "Clock Algorithm Sweep (vmscan.c)"
  direction: down

  step1: {
    label: "S1: Inspect Current Frame"
    code: |'c
      fd = &pm->desc[clock_hand];
      if (fd->ref_bit == true) {
          goto second_chance;
      } else {
          goto evict;
      }
    '|
  }

  step2_reset: {
    label: "S2: Second Chance"
    code: |'c
      fd->ref_bit = false;
      *pte &= ~PTE_REFERENCED;
      clock_hand = (clock_hand + 1) % n;
    '|
    style.fill: "#C7F1FF"
  }

  step2_evict: {
    label: "S2: Eviction Path"
    code: |'c
      if (fd->dirty) swap_page_out(fd->vpn);
      tlb_flush_page(fd->vpn);
      *pte &= ~PTE_VALID;
      return victim_frame;
    '|
    style.fill: "#FFC7C7"
  }
}

# --- STATE EVOLUTION ---

cpu_fault: "PAGE FAULT" {
  shape: diamond
  style.fill: red
  style.font-color: white
}

cpu_fault -> physical_memory.hand: "Trigger | 4 bytes | VPN 0x009AA"

physical_memory.hand -> physical_memory.frame_pool.f1: "Point to Hand"
physical_memory.frame_pool.f1 -> replacement_logic.step1: "ref_bit=1 | 1 bit | 1"
replacement_logic.step1 -> replacement_logic.step2_reset: "Ref=1 | Guard | ref_bit -> 0"

replacement_logic.step2_reset -> physical_memory.hand: "Advance | 4 bytes | Hand -> Frame 2"

physical_memory.hand -> physical_memory.frame_pool.f2: "Point to Hand"
physical_memory.frame_pool.f2 -> replacement_logic.step1: "ref_bit=0 | 1 bit | 0"
replacement_logic.step1 -> replacement_logic.step2_evict: "Ref=0 | Guard | RECLAIM"

replacement_logic.step2_evict -> swap_device: "Dirty=1 | 4096 bytes | Page Data" {
  style.stroke-dash: 5
}

# --- NOTES ---

legend: {
  near: bottom-right
  
  l1: "Blue Arrow: Metadata/Control" {
    style.font-color: blue
    shape: text
  }
  l2: "Red Path: Eviction/Data Loss" {
    style.font-color: red
    shape: text
  }
  l3: "Green Frame: Active/Safe" {
    style.font-color: green
    shape: text
  }
}

swap_device: {
  shape: cylinder
  label: "Swap Space (/dev/sda2)"
}