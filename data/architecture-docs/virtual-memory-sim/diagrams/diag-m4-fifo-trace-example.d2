direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# ---------------------------------------------------------------------------------
# CLASSES & STYLING
# ---------------------------------------------------------------------------------
classes: {
  fault_node: {
    style: {
      fill: "#fff0f0"
      stroke: "#d32f2f"
      stroke-width: 2
    }
  }
  hit_node: {
    style: {
      fill: "#f0fff0"
      stroke: "#388e3c"
      stroke-width: 2
    }
  }
  memory_table: {
    shape: sql_table
    style: {
      fill: "#ffffff"
      stroke: "#333333"
    }
  }
}

# ---------------------------------------------------------------------------------
# HEADER & LEGEND
# ---------------------------------------------------------------------------------
title: {
  shape: rectangle
  label: |'md
    # FIFO Page Replacement Trace
    **Policy**: First-In-First-Out (M4: vmsim.c)
    **Configuration**: 3 Physical Frames | 4KB Page Size
  '|
}
title.near: top-center

legend: {
  shape: package
  label: "Legend"
  fault: "Page Fault" { 
    style.fill: "#fff0f0"
    style.stroke: red 
  }
  hit: "TLB/Mem Hit" { 
    style.fill: "#f0fff0"
    style.stroke: green 
  }
  wb: "Swap Write-Back" { 
    style.stroke-dash: 3
    style.stroke: orange 
  }
}
legend.near: top-right

# ---------------------------------------------------------------------------------
# TRACE SEQUENCE
# ---------------------------------------------------------------------------------

t1: "T1: Access VPN 7 (Read)" {
  class: fault_node
  mem: {
    shape: sql_table
    label: "Physical Frames (phys_mem_t)"
    f0: "0x00 | VPN 7 | Load T=1 | Clean | [OLD]"
    f1: "0x10 | empty | - | - | -"
    f2: "0x20 | empty | - | - | -"
    sz: "Total: 48 bytes"
  }
  note: "Outcome: MISS | Evict: None"
}

t2: "T2: Access VPN 0 (Write)" {
  class: fault_node
  mem: {
    shape: sql_table
    label: "Physical Frames"
    f0: "0x00 | VPN 7 | Load T=1 | Clean | [OLD]"
    f1: "0x10 | VPN 0 | Load T=2 | DIRTY | -"
    f2: "0x20 | empty | - | - | -"
    sz: "Total: 48 bytes"
  }
  note: "Outcome: MISS | Dirty bit set"
}

t3: "T3: Access VPN 1 (Read)" {
  class: fault_node
  mem: {
    shape: sql_table
    label: "Physical Frames"
    f0: "0x00 | VPN 7 | Load T=1 | Clean | [OLD]"
    f1: "0x10 | VPN 0 | Load T=2 | DIRTY | -"
    f2: "0x20 | VPN 1 | Load T=3 | Clean | -"
    sz: "Total: 48 bytes"
  }
  note: "Outcome: MISS | Memory Full"
}

t4: "T4: Access VPN 2 (Read)" {
  class: fault_node
  mem: {
    shape: sql_table
    label: "Physical Frames"
    f0: "0x00 | VPN 2 | Load T=4 | Clean | -"
    f1: "0x10 | VPN 0 | Load T=2 | DIRTY | [OLD]"
    f2: "0x20 | VPN 1 | Load T=3 | Clean | -"
    sz: "Total: 48 bytes"
  }
  action: "EVICT VPN 7 (Oldest: T=1)"
}

t5: "T5: Access VPN 0 (Read)" {
  class: hit_node
  mem: {
    shape: sql_table
    label: "Physical Frames"
    f0: "0x00 | VPN 2 | Load T=4 | Clean | -"
    f1: "0x10 | VPN 0 | Load T=2 | DIRTY | [OLD]"
    f2: "0x20 | VPN 1 | Load T=3 | Clean | -"
    sz: "Total: 48 bytes"
  }
  note: "Outcome: HIT | VPN 0 still in Frame 1"
}

t6: "T6: Access VPN 3 (Read)" {
  class: fault_node
  mem: {
    shape: sql_table
    label: "Physical Frames"
    f0: "0x00 | VPN 2 | Load T=4 | Clean | -"
    f1: "0x10 | VPN 3 | Load T=6 | Clean | -"
    f2: "0x20 | VPN 1 | Load T=3 | Clean | [OLD]"
    sz: "Total: 48 bytes"
  }
  action: {
    label: "Evict/Write-back Logic"
    code: |'md
      **EVICT VPN 0** (Oldest: T=2)
      **DIRTY WRITE-BACK**: VPN 0 content saved to Swap
    '|
  }
}

t7: "T7: Access VPN 0 (Read)" {
  class: fault_node
  mem: {
    shape: sql_table
    label: "Physical Frames"
    f0: "0x00 | VPN 2 | Load T=4 | Clean | [OLD]"
    f1: "0x10 | VPN 3 | Load T=6 | Clean | -"
    f2: "0x20 | VPN 0 | Load T=7 | Clean | -"
    sz: "Total: 48 bytes"
  }
  action: {
    label: "Evict/Page-In Logic"
    code: |'md
      **EVICT VPN 1** (Oldest: T=3)
      **PAGE IN**: VPN 0 loaded from Swap
    '|
  }
}

# ---------------------------------------------------------------------------------
# CONNECTIONS
# ---------------------------------------------------------------------------------

t1 -> t2: "mem_access_t | 8 bytes | {W, 0x00000000}"
t2 -> t3: "mem_access_t | 8 bytes | {R, 0x00001000}"
t3 -> t4: "mem_access_t | 8 bytes | {R, 0x00002000}"
t4 -> t5: "mem_access_t | 8 bytes | {R, 0x00000004}"
t5 -> t6: "mem_access_t | 8 bytes | {R, 0x00003000}" {
  style.stroke: orange
  style.stroke-dash: 3
}
t6 -> t7: "mem_access_t | 8 bytes | {R, 0x00000000}"

# ---------------------------------------------------------------------------------
# FINAL TALLY
# ---------------------------------------------------------------------------------

summary: {
  shape: document
  label: "Simulation Statistics (Final)"
  stats: |'md
    - **Total Accesses**: 7
    - **Page Faults**: 6 (85.7%)
    - **Hits**: 1 (14.3%)
    - **Dirty Write-backs**: 1 (VPN 0 at T6)
    - **Page Ins**: 1 (VPN 0 at T7)
  '|
}
summary.near: bottom-center