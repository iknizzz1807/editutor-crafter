direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: {
  shape: rectangle
  label: "LRU Page Replacement — Step-by-Step Trace (vmsim.c)"
  style: {
    font-size: 24
    bold: true
    fill: "#f8f9fa"
  }
}
title.near: top-center

legend: {
  label: "Legend: State Indicators"
  hit: "HIT (Update Stack only)" {
    style: {
      fill: "#d4edda"
      stroke: "#28a745"
    }
  }
  miss: "MISS (Evict LRU + Load)" {
    style: {
      fill: "#f8d7da"
      stroke: "#dc3545"
    }
  }
}
legend.near: bottom-right

# ────────────────────────────────────────────────────────────────────────────
# Core LRU Logic Block
# ────────────────────────────────────────────────────────────────────────────
lru_logic: {
  label: "LRU Logic (vm_engine.c)"
  code: |'c
    void on_access(uint32_t vpn) {
        if (tlb_hit(vpn)) {
            stack_move_to_front(vpn); // Update MRU
        } else {
            if (mem_full()) {
                uint32_t victim = stack_pop_back(); // LRU
                evict_page(victim);
            }
            load_page(vpn);
            stack_push_front(vpn); // Insert as MRU
        }
    }
  '|
  width: 400
}

# ────────────────────────────────────────────────────────────────────────────
# Trace Steps: Page Table/Frame Array State
# ────────────────────────────────────────────────────────────────────────────

step1: {
  shape: sql_table
  label: "T1: Access VPN 7"
  f0: "0x00 | uint32_t | Frame 0: 7 // MISS"
  f1: "0x04 | uint32_t | Frame 1: -"
  f2: "0x08 | uint32_t | Frame 2: -"
  stack: "Stack | [7] (MRU)"
  style: { fill: "#f8d7da" }
}

step2: {
  shape: sql_table
  label: "T2: Access VPN 0"
  f0: "0x00 | uint32_t | Frame 0: 7"
  f1: "0x04 | uint32_t | Frame 1: 0 // MISS"
  f2: "0x08 | uint32_t | Frame 2: -"
  stack: "Stack | [0, 7]"
  style: { fill: "#f8d7da" }
}

step3: {
  shape: sql_table
  label: "T3: Access VPN 1"
  f0: "0x00 | uint32_t | Frame 0: 7"
  f1: "0x04 | uint32_t | Frame 1: 0"
  f2: "0x08 | uint32_t | Frame 2: 1 // MISS"
  stack: "Stack | [1, 0, 7]"
  style: { fill: "#f8d7da" }
}

step4: {
  shape: sql_table
  label: "T4: Access VPN 2"
  f0: "0x00 | uint32_t | Frame 0: 2 // Evict 7"
  f1: "0x04 | uint32_t | Frame 1: 0"
  f2: "0x08 | uint32_t | Frame 2: 1"
  stack: "Stack | [2, 1, 0]"
  style: { fill: "#f8d7da" }
}

step5: {
  shape: sql_table
  label: "T5: Access VPN 0"
  f0: "0x00 | uint32_t | Frame 0: 2"
  f1: "0x04 | uint32_t | Frame 1: 0 // HIT"
  f2: "0x08 | uint32_t | Frame 2: 1"
  stack: "Stack | [0, 2, 1]"
  style: { fill: "#d4edda" }
}

step6: {
  shape: sql_table
  label: "T6: Access VPN 3"
  f0: "0x00 | uint32_t | Frame 0: 2"
  f1: "0x04 | uint32_t | Frame 1: 0"
  f2: "0x08 | uint32_t | Frame 2: 3 // Evict 1"
  stack: "Stack | [3, 0, 2]"
  style: { fill: "#f8d7da" }
}

step7: {
  shape: sql_table
  label: "T7: Access VPN 0"
  f0: "0x00 | uint32_t | Frame 0: 2"
  f1: "0x04 | uint32_t | Frame 1: 0 // HIT"
  f2: "0x08 | uint32_t | Frame 2: 3"
  stack: "Stack | [0, 3, 2]"
  style: { fill: "#d4edda" }
}

step8: {
  shape: sql_table
  label: "T8: Access VPN 4"
  f0: "0x00 | uint32_t | Frame 0: 4 // Evict 2"
  f1: "0x04 | uint32_t | Frame 1: 0"
  f2: "0x08 | uint32_t | Frame 2: 3"
  stack: "Stack | [4, 0, 3]"
  style: { fill: "#f8d7da" }
}

# ────────────────────────────────────────────────────────────────────────────
# Transitions and Annotations
# ────────────────────────────────────────────────────────────────────────────

step1 -> step2: "VPN 0 | 4KB | Page Fault"
step2 -> step3: "VPN 1 | 4KB | Page Fault"
step3 -> step4: "VPN 2 | 4KB | Replace VPN 7"
step4 -> step5: "VPN 0 | 0B | Hit (Promote MRU)" {
  style: { stroke: "#28a745"; stroke-width: 3 }
}
step5 -> step6: "VPN 3 | 4KB | Replace VPN 1"
step6 -> step7: "VPN 0 | 0B | Hit (Promote MRU)" {
  style: { stroke: "#28a745"; stroke-width: 3 }
}
step7 -> step8: "VPN 4 | 4KB | Replace VPN 2"

# ────────────────────────────────────────────────────────────────────────────
# Global Attributes & Analysis
# ────────────────────────────────────────────────────────────────────────────

analysis: {
  label: "LRU Efficiency Analysis"
  content: |md
    ### Result: 6 Page Faults
    LRU effectively leverages **Temporal Locality**.
    - **Key Observation (T5)**: VPN 0 is accessed again. 
    - **Mechanism**: The stack logic brings VPN 0 to the top (MRU).
    - **Contrast**: A FIFO algorithm would have evicted VPN 0 soon because it was the 'oldest' entry from T2, leading to an extra fault at T7.
  |
}
analysis.near: bottom-center

*.style.font: mono
(step* -> step*)[*].style.animated: true