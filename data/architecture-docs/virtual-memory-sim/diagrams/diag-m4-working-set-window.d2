direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- DATA STRUCTURES ---
ws_tracker_struct: {
  shape: sql_table
  label: "struct working_set_tracker_t (m4_replacement.c)"
  f0: "0x00 | uint32_t[5] | history   // Ring buffer of last 5 VPNs"
  f1: "0x14 | uint32_t    | head      // Current write index"
  f2: "0x18 | uint32_t    | filled    // Current window utilization"
  f3: "0x1C | uint32_t    | wss_limit // Physical frame threshold (e.g., 3)"
  sz: "Total Size: 32 bytes"
}

# --- ALGORITHM LOGIC ---
logic: {
  label: "WSS Calculation (Sliding Window)"
  code: |'c
    uint32_t get_wss(working_set_tracker_t *ws) {
      uint32_t distinct = 0;
      for (int i = 0; i < ws->filled; i++) {
        bool seen = false;
        for (int j = 0; j < i; j++)
          if (ws->history[i] == ws->history[j]) seen = true;
        if (!seen) distinct++;
      }
      return distinct;
    }
  '|
  width: 400
}

# --- SIMULATION TIMELINE ---
timeline: {
  label: "Access Trace Timeline (T=0 to T=7)"
  direction: right
  
  t0: "T=0 | VPN: 7" {style.fill: "#E1F5FE"}
  t1: "T=1 | VPN: 0" {style.fill: "#E1F5FE"}
  t2: "T=2 | VPN: 1" {style.fill: "#E1F5FE"}
  t3: "T=3 | VPN: 2" {style.fill: "#E1F5FE"}
  t4: "T=4 | VPN: 0" {style.fill: "#E1F5FE"}
  t5: "T=5 | VPN: 3" {style.fill: "#E1F5FE"}
  t6: "T=6 | VPN: 0" {style.fill: "#E1F5FE"}
  t7: "T=7 | VPN: 4" {style.fill: "#FFCDD2"; style.stroke: red}

  t0 -> t1 -> t2 -> t3 -> t4 -> t5 -> t6 -> t7: "next access"
}

# --- WINDOW STATE AT T=7 ---
window_at_t7: {
  label: "Window State at T=7 (Delta=5)"
  direction: down
  
  buffer: {
    grid-columns: 5
    v3: "VPN: 2" {style.stroke-dash: 3}
    v4: "VPN: 0"
    v5: "VPN: 3"
    v6: "VPN: 0"
    v7: "VPN: 4" {style.bold: true}
  }
  
  stats: {
    shape: sql_table
    label: "Metrics"
    d1: "Distinct Set | {0, 2, 3, 4}"
    d2: "Current WSS  | 4"
    d3: "Frame Limit  | 3"
  }
}

# --- THRASHING ANALYSIS ---
analysis: {
  label: "Thrashing Threshold Analysis"
  direction: down
  
  condition: {
    label: "IF WSS(t) > Physical Frames"
    shape: diamond
    style.fill: "#FFEBEE"
  }
  
  effect: {
    label: "CRITICAL: THRASHING"
    shape: callout
    style.fill: red
    style.font-color: white
    code: "Result: 100% Page Fault Rate"
  }
  
  condition -> effect: "True (4 > 3)" {
    style.stroke: red
    style.stroke-width: 4
  }
}

# --- CONNECTIONS ---
timeline.t7 -> window_at_t7: "Update Window | 4 bytes | VPN 4"
window_at_t7 -> logic: "Input Data"
logic -> analysis.condition: "WSS Result | uint32_t | 4"

# --- LEGEND ---
legend: {
  near: bottom-right
  blue: "Historical Access" {style.fill: "#E1F5FE"}
  red_box: "Thrashing Trigger" {style.fill: "#FFCDD2"}
  green_line: "Safe: WSS <= Frames" {style.stroke: green}
  red_line: "Danger: WSS > Frames" {style.stroke: red}
}