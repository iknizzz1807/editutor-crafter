layout-engine: elk
theme-id: 0

# PTE_T MEMORY LAYOUT DEFINITION
# Exact byte offsets left margin, field sizes right margin.
# Colors: Header=Purple, Data=Blue, Free=Green, Padding=Gray, Pointers/Flags=Orange.

pte_bit_map: {
  label: "pte_t Bit-Level Field Map | sizeof=4 bytes (32-bit)"
  style.fill: "#8e44ad" # Purple Header
  style.font-color: white

  bits: {
    grid-columns: 8
    grid-gap: 0

    pfn: "PFN [31:12]" {
      width: 300; height: 60
      style.fill: "#3498db" # Blue Data
      style.font-color: white
      tooltip: "Physical Frame Number (20 bits)"
    }
    rsvd1: "RSVD [11:8]" {
      width: 80; height: 60
      style.fill: "#95a5a6" # Gray Padding
      style.stroke-dash: 2
    }
    flag_a: "A" {
      width: 40; height: 60
      style.fill: "#e67e22" # Orange Flags
      style.font-color: white
      tooltip: "Accessed (Bit 7)"
    }
    flag_d: "D" {
      width: 40; height: 60
      style.fill: "#e67e22"
      style.font-color: white
      tooltip: "Dirty (Bit 6)"
    }
    flag_r: "R" {
      width: 40; height: 60
      style.fill: "#e67e22"
      style.font-color: white
      tooltip: "Read (Bit 5)"
    }
    flag_w: "W" {
      width: 40; height: 60
      style.fill: "#e67e22"
      style.font-color: white
      tooltip: "Write (Bit 4)"
    }
    rsvd2: "RSVD [3:1]" {
      width: 60; height: 60
      style.fill: "#95a5a6"
    }
    flag_v: "V" {
      width: 40; height: 60
      style.fill: "#e67e22"
      style.font-color: white
      tooltip: "Valid (Bit 0)"
    }
  }
}

memory_offset_view: {
  label: "Byte-Aligned View"
  
  pte_struct: {
    grid-columns: 3
    grid-gap: 0

    # Offsets | Field | Sizes
    o0: "0x00" { style.stroke-width: 0; width: 50 }
    f0: "PFN (High Bits)" { style.fill: "#3498db"; width: 250 }
    s0: "2 bytes" { style.stroke-width: 0; width: 80 }

    o1: "0x02" { style.stroke-width: 0 }
    f1: "PFN (Low) + Flags" { style.fill: "#e67e22"; width: 250 }
    s1: "2 bytes" { style.stroke-width: 0 }
  }
}

# Cache Line Alignment (64B) - Bold page boundaries, dashed cache lines
cache_line_boundary: {
  label: "L1 Cache Line Mapping (64 Bytes)"
  style: {
    stroke: black
    stroke-width: 4 # Bold boundary
    stroke-dash: 5 # Cache line dashed
  }

  line_grid: {
    grid-columns: 8
    grid-gap: 2
    
    # 16 PTEs total in a 64B cache line (4B each)
    p0: "PTE0" { style.fill: "#3498db" }
    p1: "PTE1" { style.fill: "#3498db" }
    p2: "PTE2" { style.fill: "#3498db" }
    p3: "PTE3" { style.fill: "#3498db" }
    p4: "PTE4" { style.fill: "#3498db" }
    p5: "PTE5" { style.fill: "#3498db" }
    p6: "PTE6" { style.fill: "#3498db" }
    p7: "PTE7" { style.fill: "#3498db" }
    p8: "PTE8" { style.fill: "#3498db" }
    p9: "PTE9" { style.fill: "#3498db" }
    p10: "PTE10" { style.fill: "#3498db" }
    p11: "PTE11" { style.fill: "#3498db" }
    p12: "PTE12" { style.fill: "#3498db" }
    p13: "PTE13" { style.fill: "#3498db" }
    p14: "PTE14" { style.fill: "#3498db" }
    p15: "PTE15" { style.fill: "#3498db" }
  }
}

# Software implementation reference
implementation: {
  label: "Bitmask Implementations"
  shape: code
  language: c
  code: |c
    #define PTE_PFN_MASK   0xFFFFF000  // Bits [31:12]
    #define PTE_FLAGS_MASK 0x00000FFF  // Bits [11:0]
    #define PTE_VALID      (1 << 0)
    #define PTE_WRITE      (1 << 4)
    #define PTE_READ       (1 << 5)
  |
}

# Flow relations
pte_bit_map -> implementation: "Logic Mapping"
cache_line_boundary -> pte_bit_map: "Element Structure"

# Growth annotation
growth: "Memory Growth: 0x00 -> 0x3F" {
  shape: text
  style.italic: true
}