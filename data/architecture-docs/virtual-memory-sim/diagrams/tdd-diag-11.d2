direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

title: |md
  ### TLB Lookup State Machine: Tag Matching Pipeline
  **Context:** `tlb_lookup(vpn, asid, is_write)`
  **Invariant:** Single-cycle sequential search of fully-associative array
| {
  near: top-center
}

# --- States ---
START: "" {
  shape: circle
  style.fill: black
  label: "â—"
}

CHECK_VALID: "STATE: CHECK_VALID" {
  tooltip: "Invariant: entry = tlb->entries[i]"
  style.fill: "#E4DBFE"
}

CHECK_ASID: "STATE: CHECK_ASID" {
  tooltip: "Invariant: (flags & 0x01) == 1"
  style.fill: "#E4DBFE"
}

CHECK_VPN: "STATE: CHECK_VPN" {
  tooltip: "Invariant: e.asid == active_asid"
  style.fill: "#E4DBFE"
}

HIT_EVAL: "STATE: HIT_EVALUATE" {
  tooltip: "Invariant: e.vpn == target_vpn"
  style.fill: "#B5AFF6"
}

NEXT_ENTRY: "STATE: INCREMENT_LOOP" {
  tooltip: "i = i + 1"
}

SUCCESS_HIT: "XLATE_TLB_HIT" {
  shape: circle
  style: {
    fill: "#ACE1AF"
    double-border: true
  }
}

TLB_MISS: "XLATE_TLB_MISS" {
  shape: circle
  style: {
    fill: "#DEE1EB"
    double-border: true
  }
}

PROT_FAULT: "PROT_FAULT_TLB" {
  style: {
    fill: "#FE7070"
    stroke: red
    stroke-width: 2
  }
}

# --- Transitions ---

START -> CHECK_VALID: "loop_init: i = 0"

CHECK_VALID -> NEXT_ENTRY: "GUARD: !(flags & 0x01)\nACTION: Skip empty slot" {
  style.stroke-dash: 3
}

CHECK_VALID -> CHECK_ASID: "GUARD: flags & 0x01\nACTION: Proceed to ASID tag"

CHECK_ASID -> NEXT_ENTRY: "GUARD: e.asid != active_asid\nACTION: Wrong process context" {
  style.stroke-dash: 3
}

CHECK_ASID -> CHECK_VPN: "GUARD: e.asid == active_asid\nACTION: Proceed to VPN tag"

CHECK_VPN -> NEXT_ENTRY: "GUARD: e.vpn != target_vpn\nACTION: Tag mismatch" {
  style.stroke-dash: 3
}

CHECK_VPN -> HIT_EVAL: "GUARD: e.vpn == target_vpn\nACTION: Match detected"

HIT_EVAL -> PROT_FAULT: "TRIGGER: is_write\nGUARD: !(flags & 0x08)\nACTION: Raise #PF" {
  style.stroke: red
}

HIT_EVAL -> SUCCESS_HIT: "TRIGGER: any_access\nGUARD: perms_ok\nACTION: e.flags |= (R | D?)" {
  style.stroke: green
}

NEXT_ENTRY -> CHECK_VALID: "GUARD: i < TLB_SIZE"

NEXT_ENTRY -> TLB_MISS: "GUARD: i == TLB_SIZE\nACTION: Trigger Page Table Walk"

# --- Annotations ---
legend: {
  near: bottom-right
  valid_bit: "|'0x01: TLB_VALID'|"
  write_bit: "|'0x08: TLB_WRITABLE'|"
  
  valid_bit.style.font: mono
  write_bit.style.font: mono
}

ILLEGAL_TRANSITION: "ILLEGAL: Cache bypass without TLB_MISS" {
  style: {
    stroke: red
    stroke-dash: 5
    font-color: red
  }
}
START -> SUCCESS_HIT: ILLEGAL_TRANSITION {
  style.stroke: red
  style.stroke-dash: 5
}