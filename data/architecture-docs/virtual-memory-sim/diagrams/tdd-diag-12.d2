direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

classes: {
  step_container: {
    style: {
      stroke-width: 1
      border-radius: 4
    }
  }
  tlb_table: {
    grid-columns: 3
    grid-gap: 0
    style: {
      fill: "#f8f9fa"
      stroke: "#dee2e6"
    }
  }
  header_cell: {
    height: 30
    style: {
      fill: "#e9ecef"
      bold: true
      font-size: 14
      stroke: "#adb5bd"
    }
  }
  data_cell: {
    height: 25
    style: {
      font-size: 13
      font: mono
      stroke: "#dee2e6"
    }
  }
  changed: {
    style: {
      font-color: "#d90429"
      bold: true
      fill: "#fff0f3"
    }
  }
  evicted: {
    style: {
      fill: "#ffccd5"
      stroke: "#d90429"
      stroke-dash: 3
    }
  }
  note_style: {
    style: {
      fill: "#fff3b0"
      stroke: "#f4d35e"
      border-radius: 2
    }
  }
}

# -----------------------------------------------------------------------------
# STEP 1: Cold Start Access
# -----------------------------------------------------------------------------
Step1: "1. Access VPN 0x10 (MISS)" {
  class: step_container
  
  tlb: {
    class: tlb_table
    h1: "Slot" { class: header_cell }
    h2: "VPN Tag" { class: header_cell }
    h3: "Age (LRU)" { class: header_cell }
    
    s0: "0" { class: data_cell }
    v0: "0x10" { class: [data_cell; changed] }
    a0: "0" { class: [data_cell; changed] }
    
    s1: "1" { class: data_cell }
    v1: "---" { class: data_cell }
    a1: "---" { class: data_cell }
    
    s2: "2" { class: data_cell }
    v2: "---" { class: data_cell }
    a2: "---" { class: data_cell }
    
    s3: "3" { class: data_cell }
    v3: "---" { class: data_cell }
    a3: "---" { class: data_cell }
  }
  
  note: |md
    **State:** Cold Fill.
    - VPN 0x10 inserted at Slot 0.
    - Age set to **0** (MRU).
  | {
    shape: rectangle
    class: note_style
  }
}

# -----------------------------------------------------------------------------
# STEP 4: TLB Full State
# -----------------------------------------------------------------------------
Step4: "4. Access VPN 0x40 (MISS - Full)" {
  class: step_container
  
  tlb: {
    class: tlb_table
    h1: "Slot"; h2: "VPN Tag"; h3: "Age (LRU)"
    h1.class: header_cell; h2.class: header_cell; h3.class: header_cell

    s0: "0" { class: data_cell }
    v0: "0x10" { class: data_cell }
    a0: "3" { class: [data_cell; changed] }
    
    s1: "1" { class: data_cell }
    v1: "0x20" { class: data_cell }
    a1: "2" { class: [data_cell; changed] }
    
    s2: "2" { class: data_cell }
    v2: "0x30" { class: data_cell }
    a2: "1" { class: [data_cell; changed] }
    
    s3: "3" { class: data_cell }
    v3: "0x40" { class: [data_cell; changed] }
    a3: "0" { class: [data_cell; changed] }
  }
  
  note: |md
    **State:** All slots occupied.
    - All existing entries aged (incremented).
    - VPN 0x40 inserted at Slot 3.
  | {
    shape: rectangle
    class: note_style
  }
}

# -----------------------------------------------------------------------------
# STEP 5: TLB HIT (Recency Reset)
# -----------------------------------------------------------------------------
Step5: "5. Access VPN 0x10 (HIT)" {
  class: step_container
  
  tlb: {
    class: tlb_table
    h1: "Slot"; h2: "VPN Tag"; h3: "Age (LRU)"
    h1.class: header_cell; h2.class: header_cell; h3.class: header_cell
    
    s0: "0" { class: data_cell }
    v0: "0x10" { class: data_cell }
    a0: "0" { class: [data_cell; changed] }
    
    s1: "1" { class: data_cell }
    v1: "0x20" { class: data_cell }
    a1: "3" { class: [data_cell; changed] }
    
    s2: "2" { class: data_cell }
    v2: "0x30" { class: data_cell }
    a2: "2" { class: [data_cell; changed] }
    
    s3: "3" { class: data_cell }
    v3: "0x40" { class: data_cell }
    a3: "1" { class: [data_cell; changed] }
  }
  
  note: |md
    **State:** Cache Hit on VPN 0x10.
    - **Age 0** Reset: Slot 0 (MRU).
    - **Aging:** Slots 1, 2, 3 incremented.
    - **Victim Candidate:** Slot 1 (Age 3).
  | {
    shape: rectangle
    class: note_style
  }
}

# -----------------------------------------------------------------------------
# STEP 6: EVICTION (LRU Logic)
# -----------------------------------------------------------------------------
Step6: "6. Access VPN 0x50 (MISS - Eviction)" {
  class: step_container
  
  tlb: {
    class: tlb_table
    h1: "Slot"; h2: "VPN Tag"; h3: "Age (LRU)"
    h1.class: header_cell; h2.class: header_cell; h3.class: header_cell
    
    s0: "0" { class: data_cell }
    v0: "0x10" { class: data_cell }
    a0: "1" { class: [data_cell; changed] }
    
    s1: "1" { class: [data_cell; evicted] }
    v1: "0x50" { class: [data_cell; changed] }
    a1: "0" { class: [data_cell; changed] }
    
    s2: "2" { class: data_cell }
    v2: "0x30" { class: data_cell }
    a2: "3" { class: [data_cell; changed] }
    
    s3: "3" { class: data_cell }
    v3: "0x40" { class: data_cell }
    a3: "2" { class: [data_cell; changed] }
  }
  
  note: |md
    **State:** Capacity reached.
    - **Victim:** Slot 1 (Previously Age 3, VPN 0x20).
    - **Action:** Evict 0x20, write-back if dirty.
    - **Insert:** New VPN 0x50 into Slot 1, Age 0.
  | {
    shape: rectangle
    class: note_style
  }
}

Step1 -> Step4: "Aging / Fill"
Step4 -> Step5: "Temporal Locality"
Step5 -> Step6: "Evict Max(Age)"

legend: |md
  ### LRU Counter Policy (Intel Design Specs)
  1. **On Every Access:** Increment all valid `age` counters.
  2. **On Hit:** Reset `age` of hit entry to 0.
  3. **On Eviction:** Select entry where `age == max(all_entries)`.
  4. **Counter Cap:** 255 (8-bit implementation).
| {
  style: {
    fill: "#fdf0d5"
    stroke: "#669bbc"
  }
}