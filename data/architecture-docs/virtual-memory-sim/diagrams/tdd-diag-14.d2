layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
    sketch: false
  }
}

tlb_eviction_flow: {
  shape: sequence_diagram

  # Participants
  mmu: "MMU Translator\n(Caller)" {
    shape: person
    style.fill: "#B5AFF6"
  }
  tlb_ins: "tlb_insert()\n(Replacement Logic)" {
    style.fill: "#C7F1FF"
  }
  tlb_wb: "tlb_writeback_entry()\n(Coherence Manager)" {
    style.fill: "#C7F1FF"
  }
  pt: "page_table_t\n(Main Memory)" {
    style.fill: "#DEE1EB"
  }

  # Sequence Execution
  mmu -> tlb_ins: "tlb_insert(vpn, pfn, asid, writable)" {
    style.stroke: blue
  }

  tlb_ins -> tlb_ins: "find_victim_lru() -> slot K"

  tlb_ins -> tlb_wb: "tlb_writeback_entry(entries[K], pt)" {
    style.stroke: blue
  }

  tlb_wb -> pt: "▼ lock_pte(old_vpn)" {
    style.stroke: "#88DCF7"
  }

  tlb_wb -> pt: "IF entries[K].flags & TLB_DIRTY:\npt.entries[old_vpn] |= PTE_DIRTY" {
    style.stroke: "#ed800c"
  }

  tlb_wb -> pt: "IF entries[K].flags & TLB_REFERENCED:\npt.entries[old_vpn] |= PTE_REFERENCED" {
    style.stroke: "#ed800c"
  }

  tlb_wb -> pt: "▲ unlock_pte(old_vpn)" {
    style.stroke: "#88DCF7"
  }

  # Sequence Note attached to the memory actor
  pt: "### Critical Coherence Note\n**PTE_VALID is NOT cleared** here.\nThe page remains resident in physical RAM (PFN is still valid).\nOnly the TLB's cached *copy* of the translation is being\nreplaced. Metadata is synced to prevent loss of\ndirty/referenced state."

  tlb_wb -> tlb_ins: "return" {
    style.stroke-dash: 3
    style.stroke: blue
  }

  tlb_ins -> tlb_ins: "Overwrite entries[K]\n{vpn, pfn, asid, flags}"

  tlb_ins -> mmu: "void" {
    style.stroke-dash: 3
    style.stroke: blue
  }

  # Timing constraint for TLB walk
  tlb_ins -> tlb_ins: "O(TLB_SIZE) scan" {
    style.stroke-dash: 5
  }
}