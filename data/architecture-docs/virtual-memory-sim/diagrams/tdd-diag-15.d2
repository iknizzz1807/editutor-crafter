vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
    pad: 20
  }
}

tlb_invalidation_flow: {
  shape: sequence_diagram

  RP: "replace_page()\n(M4 Orchestrator)" {
    style: {
      stroke: "#6a0dad"
      stroke-width: 2
    }
  }
  SS: "swap_space_t\n(Backing Store)" {
    style: {
      fill: "#eef2ff"
    }
  }
  TLB: "tlb_t\n(MMU Cache)" {
    style: {
      fill: "#fff7ed"
      stroke: "#f97316"
    }
  }
  PT: "page_table_t\n(Architectural)" {
    style: {
      fill: "#f0fdf4"
    }
  }
  MEM: "phys_mem_t\n(Frame Pool)" {
    style: {
      fill: "#fafafa"
    }
  }

  RP -> RP: "1. Identify victim frame & VPN"
  
  RP -> SS: "2. swap_page_out(frame_data) [if dirty]" {
    style: {
      stroke: "#3b82f6"
      animated: true
    }
  }
  
  RP -> TLB: "3. tlb_flush_page(vpn)" {
    style: {
      stroke: "#ef4444"
      stroke-width: 4
    }
  }
  
  TLB -> PT: "3a. Sync Dirty/Ref bits (Writeback)" {
    style: {
      stroke: "#f97316"
      stroke-dash: 3
    }
  }
  
  TLB -> TLB: "3b. Invalidate ALL entries matching VPN [Global ASID Scan]"
  
  RP -> PT: "4. PTE.entries[vpn] &= ~PTE_VALID" {
    style: {
      stroke: "#ef4444"
      stroke-width: 4
    }
  }
  
  RP -> MEM: "5. frame.in_use = false" {
    style: {
      stroke: "#ef4444"
      stroke-width: 4
    }
  }

  RP.ordering_note: |md
    ### CRITICAL COHERENCE INVARIANT
    **Steps 3 → 4 → 5** must occur in this exact order.
    
    1. **Flush TLB (3):** Prevents hardware from using cached translation.
    2. **Clear PTE (4):** Prevents future walks from finding the mapping.
    3. **Free Frame (5):** Only safe once no stale pointers (TLB or PTE) exist.
    
    *Failure to flush before freeing frame allows a stale TLB entry to point to a reassigned frame, leading to silent memory corruption.*
  | {
    style: {
      stroke: "#ef4444"
      fill: "#fee2e2"
      font-size: 14
    }
  }
}

# Annotation for Timing/Locks
(tlb_invalidation_flow.RP -> tlb_invalidation_flow.TLB)[0].label: "▼ ACQUIRE TLB_LOCK"
(tlb_invalidation_flow.RP -> tlb_invalidation_flow.PT)[0].label: "▲ RELEASE TLB_LOCK"

style: {
  stroke-width: 2
}