direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# --- CLASSES ---

process_t: {
  shape: class
  label: "process_t\n(Struct Header)"
  asid: "uint16_t"
  pgdir: "page_directory_t*"
  pgtables: "page_table_t*[1024]"
  pt_bytes_allocated: "size_t"
  
  style: {
    stroke: "#6a1b9a"
    fill: "#f3e5f5" # Purple Header
    stroke-width: 4
  }
}

page_directory_t: {
  shape: class
  label: "page_directory_t\nsizeof=4096 bytes (one page)"
  entries: "pde_t[1024]"
  
  style: {
    stroke: "#1565c0"
    fill: "#e3f2fd" # Blue Data
  }
}

page_table_t: {
  shape: class
  label: "page_table_t\nsizeof=4096 bytes (one page)"
  entries: "pte_t[1024]"
  
  style: {
    stroke: "#1565c0"
    fill: "#e3f2fd" # Blue Data
  }
}

pde_t: {
  shape: rectangle
  label: "pde_t (uint32_t)\n[31:12] PT Base | [0] P"
  tooltip: "Page Directory Entry"
  style: {
    stroke: "#ef6c00"
    fill: "#fff3e0" # Orange Pointer
  }
}

pte_t: {
  shape: rectangle
  label: "pte_t (uint32_t)\n[31:12] PFN | [11:0] Flags"
  tooltip: "Page Table Entry"
  style: {
    stroke: "#2e7d32"
    fill: "#e8f5e9" # Green Mapping
  }
}

# --- RELATIONSHIPS ---

# process_t owns the root directory (always allocated)
process_t -> page_directory_t: "owns (1)" {
  style: {
    stroke-width: 2
  }
}

# process_t owns the second level tables (allocated on demand)
process_t -> page_table_t: "owns (0..1024)" {
  style: {
    stroke-width: 2
  }
}

# Logical link: Entries in directory point to page tables
page_directory_t -> pde_t: "contains"
pde_t -> page_table_t: "references (PT_ADDR)" {
  style: {
    stroke-dash: 3
    stroke: "#fb8c00" # Orange Pointer
  }
}

# Logical link: Entries in table point to frames
page_table_t -> pte_t: "contains"

# --- ANNOTATIONS ---

# FIXED: 'near' now uses a constant value for the ELK layout engine
annotation_memory: |md
  ### Hierarchical Sparsity Benefit
  - **Always Allocated:** `page_directory_t` (4096B)
  - **Demand Allocated:** `page_table_t` (4096B each)
  - **Typical Sparse Process:** 4KB (Dir) + 3*4KB (Tables) = 16KB
  - **Flat Table Comparison:** Constant 4MB (32768% overhead reduction)
| {
  near: top-center
  style: {
    stroke: "#9e9e9e"
    fill: "#f5f5f5"
    font-size: 12
  }
}

legend: {
  shape: package
  near: bottom-right
  
  s: "Solid Arrow = Ownership"
  d: "Dashed Arrow = Logical Reference"
  p: "Purple = Header Struct"
  b: "Blue = Data/Directory Struct"
  o: "Orange = Pointer/Reference"
  g: "Green = Data Mapping/Leaf"
}