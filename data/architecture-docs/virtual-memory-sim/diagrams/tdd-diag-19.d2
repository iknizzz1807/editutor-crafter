direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# --- CLASSES ---
classes: {
  memory_struct: {
    shape: sql_table
    style: {
      stroke: "#333333"
      stroke-width: 2
    }
  }
  header: {
    style: {
      fill: "#6a0dad"
      font-color: white
      bold: true
    }
  }
  data_field: {
    style: {
      fill: "#007bff"
      font-color: white
    }
  }
  pointer_arrow: {
    style: {
      stroke: "#fd7e14"
      stroke-width: 3
      animated: true
    }
  }
  allocation_arrow: {
    style: {
      stroke: "#28a745"
      stroke-width: 3
      stroke-dash: 5
    }
  }
}

# --- VIRTUAL ADDRESS DECOMPOSITION ---
vaddr: "Virtual Address: 0x004056A8" {
  shape: sql_table
  style.fill: "#f8f9fa"
  
  header: "21          12" { label: "31          22"; constraint: "11           0" }
  fields: "PTI: 0x005" { label: "PDI: 0x001"; constraint: "Offset: 0x6A8" }
  binary: "0000000101" { label: "0000000001"; constraint: "011010101000" }
}

# --- CPU REGISTERS ---
cpu: "CPU MMU" {
  cr3: "CR3 Register" {
    shape: rectangle
    label: "CR3: 0x00001000 (Phys)"
    style.fill: "#fd7e14"
    style.font-color: white
  }
}

# --- STEP 1: PAGE DIRECTORY ---
pg_dir: "Page Directory (at CR3)" {
  class: memory_struct
  
  header: "Page Directory Entry (PDE)" { label: "Offset"; constraint: "Size" }
  header.class: header
  
  pde0: "PDE[0]: (Present=0)" { label: "0x000"; constraint: "4B" }
  pde1: "**PDE[1]: 0x00002000 | P=1**" { label: "0x004"; constraint: "4B" }
  pde1.style.fill: "#ffc107" # Highlighting target
  pde2: "PDE[2]: (Present=0)" { label: "0x008"; constraint: "4B" }
  dots: "..." { label: "..."; constraint: "..." }
  cache_line: "Cache Line Boundary (64B)" { label: "---"; constraint: "---" }
  cache_line.style.stroke-dash: 5
}

# --- ON-DEMAND ALLOCATION LOGIC 1 ---
alloc_logic_l2: "ON-DEMAND CHECK 1" {
  shape: cloud
  label: "If PDE.P == 0:\n1. Allocate Page Table\n2. Set PDE.P = 1\n3. Set PDE.PT_ADDR"
  style.fill: "#e2f0d9"
}

# --- STEP 2: SECOND-LEVEL PAGE TABLE ---
pg_table: "Page Table (at PDE[1].Addr)" {
  class: memory_struct
  
  header: "Page Table Entry (PTE)" { label: "Offset"; constraint: "Size" }
  header.class: header
  
  pte0: "PTE[0]: (Valid=0)" { label: "0x000"; constraint: "4B" }
  dots1: "..." { label: "..."; constraint: "..." }
  pte5: "**PTE[5]: 0x00000042 | V=1 | R/W**" { label: "0x014"; constraint: "4B" }
  pte5.style.fill: "#ffc107"
  pte6: "PTE[6]: (Valid=0)" { label: "0x018"; constraint: "4B" }
  dots2: "..." { label: "..."; constraint: "..." }
}

# --- ON-DEMAND ALLOCATION LOGIC 2 ---
alloc_logic_frame: "ON-DEMAND CHECK 2" {
  shape: cloud
  label: "If PTE.V == 0:\n1. Find Free Frame\n2. Set PTE.PFN = Frame_ID\n3. Set PTE.V = 1"
  style.fill: "#e2f0d9"
}

# --- STEP 3: PHYSICAL RAM ---
phys_ram: "Physical RAM" {
  class: memory_struct
  
  header: "Frame Data" { label: "Phys Addr"; constraint: "Size" }
  header.class: header
  
  frame_gap: "..." { label: "..."; constraint: "..." }
  target_frame: "PFN 42 Base Address" { label: "0x0002A000"; constraint: "4KB" }
  target_frame.class: data_field
  
  target_data: "**FINAL ADDR: (PFN << 12) | Offset**" { label: "0x0002A6A8"; constraint: "Byte" }
  target_data.style.fill: "#28a745"
  target_data.style.font-color: white
  target_data.style.bold: true
}

# --- CONNECTIONS (DATA FLOW) ---

# 1. CR3 points to start of Directory
cpu.cr3 -> pg_dir.pde1: "1. Index by PDI (1)" { class: pointer_arrow }

# 2. PDE check/alloc
pg_dir.pde1 -> alloc_logic_l2: "2. Check P bit" { style.stroke-dash: 3 }
alloc_logic_l2 -> pg_table: "Alloc Table if P=0" { class: allocation_arrow }

# 3. PDE points to Page Table
pg_dir.pde1 -> pg_table.pte5: "3. Index by PTI (5)" { class: pointer_arrow }

# 4. PTE check/alloc
pg_table.pte5 -> alloc_logic_frame: "4. Check V bit" { style.stroke-dash: 3 }
alloc_logic_frame -> phys_ram.target_frame: "Alloc Frame if V=0" { class: allocation_arrow }

# 5. PTE points to Frame + Offset
pg_table.pte5 -> phys_ram.target_data: "5. Append Offset (0x6A8)" { class: pointer_arrow }

# Annotations
legend: "Legend" {
  near: bottom-right
  p: "Purple = Struct Header" { style.fill: "#6a0dad"; style.font-color: white }
  b: "Blue = Frame Data" { style.fill: "#007bff"; style.font-color: white }
  o: "Orange = Phys Pointers" { style.stroke: "#fd7e14"; style.stroke-width: 2 }
  g: "Green = Final Resolved Address" { style.fill: "#28a745"; style.font-color: white }
}

vaddr -> cpu.cr3: "MMU Context" { style.stroke-dash: 5 }