direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

simulator_t: {
  shape: class
  label: "simulator_t\nsizeof â‰ˆ 4.25 MiB"
  page_table: "*page_table_t, size: 8 B"
  frames: "physical_frame_t[64], size: 256.6 KiB"
  total_accesses: "uint64_t, size: 8 B"
  page_faults: "uint64_t, size: 8 B"
  protection_faults: "uint64_t, size: 8 B"
  num_frames: "uint32_t, size: 4 B"
  
  translate(vaddr: uint32_t, is_write: bool): "xlate_t"
  handle_page_fault(vpn: uint32_t, is_write: bool): "uint32_t"
}

page_table_t: {
  shape: class
  label: "page_table_t\nsizeof = 4,194,304 B"
  entries: "pte_t[1048576], size: 4 MiB"
}

physical_frame_t: {
  shape: class
  label: "physical_frame_t\nsizeof = 4104 B"
  data: "uint8_t[4096], size: 4096 B"
  in_use: "bool, size: 1 B"
  owner_vpn: "uint32_t, size: 4 B"
  padding: "uint8_t[3], size: 3 B"
}

pte_t: {
  shape: class
  label: "pte_t (Page Table Entry)\nsizeof = 4 B"
  pfn: "bits [31:12], 20 bits"
  reserved: "bits [11:8], 4 bits"
  flags: "bits [7:0], 8 bits"
}

mem_access_t: {
  shape: class
  label: "mem_access_t\nsizeof = 8 B"
  type: "access_type_t, size: 4 B"
  vaddr: "uint32_t, size: 4 B"
}

access_type_t: {
  shape: class
  label: "access_type_t (Enum)"
  ACCESS_READ: "0"
  ACCESS_WRITE: "1"
}

xlate_t: {
  shape: class
  label: "xlate_t\nsizeof = 12 B"
  result: "xlate_result_t, size: 4 B"
  paddr: "uint32_t, size: 4 B"
  pfn: "uint32_t, size: 4 B"
}

xlate_result_t: {
  shape: class
  label: "xlate_result_t (Enum)"
  XLATE_SUCCESS: "0"
  XLATE_PAGE_FAULT: "1"
  XLATE_PROT_FAULT: "2"
  XLATE_OOM: "3"
}

# Relationships
# Solid arrow = owns
simulator_t -> page_table_t: "owns"
simulator_t -> physical_frame_t: "owns array [64]"
page_table_t -> pte_t: "contains"

# Dashed arrow = references
mem_access_t -> access_type_t: "references" {
  style.stroke-dash: 3
}
xlate_t -> xlate_result_t: "references" {
  style.stroke-dash: 3
}

# Annotations - Fix: 'near' set to constant for ELK compatibility
notes: {
  near: top-right
  shape: text
  label: |md
    ### Implementation Notes
    - **Page Table**: Flat array indexed by VPN.
    - **Frames**: Fixed pool simulation.
    - **PTE**: Bit-packed metadata.
    - **ELK Layout**: Relative 'near' positioning disabled.
  |
}