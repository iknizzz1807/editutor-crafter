vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

iso: {
  shape: sequence_diagram
  label: "Address Space Isolation: CR3 Context Switch (M3)"

  os: "OS Scheduler" {
    style.stroke: "#5C2D91"
  }
  sim: "ml_simulator\n(MMU Context)" {
    style.fill: "#E4DBFE"
  }
  tlb: "TLB\n(ASID-Tagged)" {
    style.fill: "#C7F1FF"
  }
  p1: "P1_PageTable\n(Root: 0x8000)" {
    style.stroke-dash: 3
  }
  p2: "P2_PageTable\n(Root: 0x9000)" {
    style.stroke-dash: 3
  }

  # --- Initial State ---
  os."**Initial State**\n- active_process: P1\n- cr3: 0x8000\n- asid: 1"

  # --- Context Switch ---
  os -> sim: ml_context_switch(P2, force_flush=false) {
    style.stroke: blue
    style.bold: true
  }
  
  sim -> sim: sim.active_process = P2
  sim -> sim: sim.cr3 = 0x9000
  sim -> tlb: tlb.active_asid = 2
  
  tlb."ASID tagging preserves P1 entries while hiding them"

  sim <- tlb: ack

  # --- Isolated Translation ---
  os -> sim: translate(vaddr=0x00401050, R) {
    style.stroke: blue
  }

  sim -> tlb: lookup(vpn=0x401, asid=2)
  tlb -> sim: XLATE_TLB_MISS {
    style.stroke: orange
  }
  
  tlb."VPN 0x401 exists for ASID 1, but is ignored for ASID 2"

  # --- Page Table Walk via CR3 ---
  sim -> p2: walk(root=0x9000, pdi=1, pti=1) {
    style.stroke: "#5C2D91"
  }
  p2 -> sim: returns PTE (PFN=0x7B)

  sim -> tlb: tlb_insert(vpn=0x401, asid=2, pfn=0x7B)
  
  sim -> os: returns paddr=0x0007B050 {
    style.stroke: green
  }

  # --- Legend / Annotation ---
  os."**Isolation Verified**\nIn P1, 0x401000 mapped to **PFN 0x1A**\nIn P2, 0x401000 maps to **PFN 0x7B**\nIsolation achieved via **CR3 pointer swap**"
}

# Style definitions
iso.os.style.stroke: "#5C2D91"
iso.sim.style.stroke: "#5C2D91"
iso.tlb.style.stroke: orange
iso.p1.style.fill: "#F4B76C"
iso.p2.style.fill: "#F4B76C"