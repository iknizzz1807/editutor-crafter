direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

classes: {
  header: {
    style: {
      fill: "#6f42c1"
      font-color: white
      bold: true
    }
  }
  flat_style: {
    style: {
      fill: "#6c757d"
      font-color: white
    }
  }
  m3_style: {
    style: {
      fill: "#007bff"
      font-color: white
    }
  }
  savings_style: {
    style: {
      fill: "#28a745"
      font-color: white
      bold: true
    }
  }
  label_node: {
    shape: text
    style: {
      font-size: 14
    }
  }
}

title: |md
  # Memory Overhead: Flat (M1) vs. Multi-Level (M3)
  **Constraint:** 32-bit Address Space, 4KB Pages, 4-byte PTE/PDE
| {near: top-center}

# 1. Quantitative Comparison Table
comparison_table: {
  grid-columns: 6
  grid-gap: 0

  # Header Row
  h1: "Scenario" {class: header}
  h2: "Flat Size" {class: header}
  h3: "2-Level Size" {class: header}
  h4: "L2 Tables" {class: header}
  h5: "Bytes / Page" {class: header}
  h6: "Savings" {class: header}

  # Row A: Sparse
  a1: "(A) Sparse (5 regions)"
  a2: "4096 KB" {class: flat_style}
  a3: "24 KB" {class: m3_style}
  a4: "5"
  a5: "4915 B"
  a6: "99.4%" {class: savings_style}

  # Row B: Clustered
  b1: "(B) Clustered (1 region)"
  b2: "4096 KB" {class: flat_style}
  b3: "8 KB" {class: m3_style}
  b4: "1"
  b5: "1638 B"
  b6: "99.8%" {class: savings_style}

  # Row C: Worst Case
  c1: "(C) Pathological"
  c2: "4096 KB" {class: flat_style}
  c3: "4100 KB" {class: m3_style}
  c4: "1024"
  c5: "4004 B"
  c6: "~0.0%" {class: flat_style}
}

# 2. Structural Comparison (Scenario A vs Scenario B)
scenarios: {
  direction: right
  
  scenario_a: "(A) Sparse (5 Scattered Pages)" {
    direction: down
    
    pd: "Page Directory (CR3)" {
      shape: sql_table
      style.fill: "#6f42c1"
      pde_0: "[0] -> NULL"
      pde_1: "[1] -> PT_A" {style.fill: "#007bff"}
      pde_dots: "..."
      pde_256: "[256] -> PT_B" {style.fill: "#007bff"}
      pde_512: "[512] -> PT_C" {style.fill: "#007bff"}
      pde_768: "[768] -> PT_D" {style.fill: "#007bff"}
      pde_1023: "[1023] -> PT_E" {style.fill: "#007bff"}
    }

    tables: {
      direction: right
      pt_a: "PT_A (4KB)" {style.fill: "#007bff"}
      pt_b: "PT_B (4KB)" {style.fill: "#007bff"}
      pt_c: "PT_C (4KB)" {style.fill: "#007bff"}
      pt_d: "PT_D (4KB)" {style.fill: "#007bff"}
      pt_e: "PT_E (4KB)" {style.fill: "#007bff"}
    }
    
    pd.pde_1 -> tables.pt_a
    pd.pde_256 -> tables.pt_b
    pd.pde_512 -> tables.pt_c
    pd.pde_768 -> tables.pt_d
    pd.pde_1023 -> tables.pt_e
    
    footer: "Total: 1 Dir + 5 Tables = 24KB" {class: label_node}
  }

  scenario_b: "(B) Clustered (5 Adjacent Pages)" {
    direction: down
    
    pd: "Page Directory (CR3)" {
      shape: sql_table
      style.fill: "#6f42c1"
      pde_0: "[0] -> NULL"
      pde_1: "[1] -> PT_Shared" {style.fill: "#007bff"}
      pde_others: "[2...1023] -> NULL"
    }

    pt_shared: "PT_Shared (4KB)" {
      shape: sql_table
      style.fill: "#007bff"
      pte_0: "VPN 4096 -> Frame 0"
      pte_1: "VPN 4097 -> Frame 1"
      pte_2: "VPN 4098 -> Frame 2"
      pte_3: "VPN 4099 -> Frame 3"
      pte_4: "VPN 4100 -> Frame 4"
      pte_rest: "... [5...1023] INVALID"
    }
    
    pd.pde_1 -> pt_shared
    
    footer: "Total: 1 Dir + 1 Table = 8KB" {class: label_node}
  }
}

# 3. Memory Consumption Bar Chart (Visual Representation)
visual_bars: {
  grid-rows: 4
  grid-gap: 20
  
  flat_bar: "Flat (Milestone 1)" {
    width: 1000
    style.fill: "#6c757d"
    label: "4096 KB (100%)"
  }
  
  m3_sparse: "M3 Sparse (Scenario A)" {
    width: 6
    style.fill: "#007bff"
    label: "24 KB (0.6%)"
  }
  
  m3_clustered: "M3 Clustered (Scenario B)" {
    width: 2
    style.fill: "#007bff"
    label: "8 KB (0.2%)"
  }
  
  m3_worst: "M3 Worst Case (Scenario C)" {
    width: 1001
    style.fill: "#dc3545"
    label: "4100 KB (100.1%)"
  }
}

legend: {
  near: bottom-right
  l1: "Directory/Header" {style.fill: "#6f42c1"}
  l2: "Allocated Tables" {style.fill: "#007bff"}
  l3: "Flat Array (Waste)" {style.fill: "#6c757d"}
  l4: "Extra Pointers" {style.fill: "#dc3545"}
}

annotation: |md
  ### Key Insights
  1. **Trie Principle:** Hierarchical tables are a "Radix Trie". Unmapped virtual ranges are NULL pointers, pruning subtrees.
  2. **The 4MB Threshold:** Each Page Directory Entry (PDE) controls 4MB. Sparsity across 4MB boundaries determines L2 allocation.
  3. **Worst Case Cost:** In the pathological case (1 page per 4MB), M3 is slightly larger (100.1%) due to the 4KB Directory overhead.
  4. **Production Reality:** Real processes are sparse. Savings of >99% are standard for typical application address spaces.
| {near: bottom-left}