direction: down
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

title: |md
  ### Three-Level Page Table Structure
  **Address Split: 2 + 9 + 9 + 12 (32-bit Virtual Address)**
  *sizeof=4112 bytes for single mapping*
| {
  near: top-center
  shape: text
}

# --- 1. Address Decomposition Bit-Strip ---
# Colors: Header=Purple, Data=Blue, Free/Offset=Green
addr_split: "Virtual Address Decomposition [31:0]" {
  style.fill: "#f8f9fa"
  
  bits: {
    grid-columns: 4
    grid-gap: 0
    
    l1: "L1_IDX [31:30]\n2 Bits" {
      style.fill: "#e1d5e7" # Purple (Header)
      width: 100
    }
    l2: "L2_IDX [29:21]\n9 Bits" {
      style.fill: "#dae8fc" # Blue (Data)
      width: 250
    }
    l3: "L3_IDX [20:12]\n9 Bits" {
      style.fill: "#dae8fc" # Blue (Data)
      width: 250
    }
    off: "PAGE_OFFSET [11:0]\n12 Bits" {
      style.fill: "#d5e8d4" # Green (Offset)
      width: 350
    }
  }
}

# --- 2. Translation Walk Tree ---
walk: {
  cr3: "CR3 Control Register" {
    shape: sql_table
    style.fill: "#fff2cc"
    "OFFSET": "FIELD" {constraint: "SIZE"}
    "0x00": "L1_BASE_ADDR" {constraint: "32b"}
  }

  l1_root: "L1 Directory (Root)" {
    shape: sql_table
    style.fill: "#e1d5e7" # Purple
    style.stroke-dash: 5 # Cache line (64B boundary)
    "OFFSET": "PDE (Page Directory Entry)" {constraint: "SIZE"}
    "0x00": "PDE[0] -> PTR L2" {constraint: "4B"}
    "0x04": "PDE[1] -> PTR L2" {constraint: "4B"}
    "0x08": "PDE[2] (NULL)" {constraint: "4B"}
    "0x0C": "PDE[3] (NULL)" {constraint: "4B"}
  }

  l2_table: "L2 Table (Mid)" {
    shape: sql_table
    style.fill: "#dae8fc" # Blue
    "OFFSET": "PDE (Mid Directory Entry)" {constraint: "SIZE"}
    "0x000": "PDE[0] -> PTR L3" {constraint: "4B"}
    "...": "510 entries omitted" {constraint: "2040B"}
    "0x7FC": "PDE[511] (NULL)" {constraint: "4B"}
  }

  l3_table: "L3 Table (Leaf)" {
    shape: sql_table
    style.fill: "#dae8fc" # Blue
    "OFFSET": "PTE (Page Table Entry)" {constraint: "SIZE"}
    "0x000": "PTE[0] -> PFN" {constraint: "4B"}
    "... ": "510 entries omitted" {constraint: "2040B"}
    "0x7FC": "PTE[511] Flags: G,D,A,W,U,P" {constraint: "4B"}
  }

  phys_frame: "Physical Frame" {
    shape: cylinder
    style.fill: "#d5e8d4" # Green
    style.stroke-width: 4 # Bold (Page Boundary)
    content: "Raw Physical Memory | 4096 Bytes"
  }

  # Connections - Orange for Pointers as per instructions
  cr3."0x00" -> l1_root: "Physical Link" {
    style.stroke: orange
    source-arrowhead: * {
      shape: circle
      style.filled: true
    }
  }
  
  l1_root."0x00" -> l2_table: "L1[IDX1]" {
    style.stroke: orange
  }
  
  l2_table."0x000" -> l3_table: "L2[IDX2]" {
    style.stroke: orange
  }
  
  l3_table."0x000" -> phys_frame: "L3[IDX3] + OFFSET" {
    style.stroke: orange
  }
}

# --- 3. Memory Cost Analysis ---
analysis: |md
  ### Sparse Memory Cost Analysis
  *   **L1 Root Table:** 4 entries × 4B = **16 B**
  *   **L2 Mid Table:** 512 entries × 4B = **2 KB**
  *   **L3 Leaf Table:** 512 entries × 4B = **2 KB**
  
  **Total overhead for single 4KB page:** **4,112 Bytes**
  
  *Versus Milestone 1 (Flat):*
  $2^{20}$ entries × 4B = **4,194,304 Bytes (4 MB)**
  
  **Memory Efficiency:** **99.9% Savings** for sparse address spaces.
| {
  near: bottom-center
  style: {
    stroke: "#82b366"
    fill: "#f5f5f5"
    font-size: 14
  }
}

# Visual Annotations
addr_split.bits.l1.style.stroke: purple
addr_split.bits.l2.style.stroke: blue
addr_split.bits.l3.style.stroke: blue
addr_split.bits.off.style.stroke: darkgreen