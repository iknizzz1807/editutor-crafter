direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# -----------------------------------------------------------------------------
# Module: frame_desc_t Memory Layout
# -----------------------------------------------------------------------------

frame_desc_mem: {
  shape: sql_table
  label: "frame_desc_t (24 Bytes)"
  
  style: {
    stroke: "#333333"
    stroke-width: 2
    fill: "white"
  }

  # Header Row: Purple (#6a0dad)
  # Left: Offset, Center: Field, Right: Size
  header: "Byte Offset" {
    label: "Field Definition"
    constraint: "Size"
    style.fill: "#6a0dad"
    style.font-color: "white"
    style.bold: true
  }

  # Data Rows: Blue (#add8e6)
  r0: "0x00" {
    label: "vpn: Virtual Page Number"
    constraint: "4B"
    style.fill: "#add8e6"
  }
  r4: "0x04" {
    label: "load_time: Logical Timestamp"
    constraint: "8B"
    style.fill: "#add8e6"
  }
  r12: "0x0C" {
    label: "last_access: Logical Timestamp"
    constraint: "8B"
    style.fill: "#add8e6"
  }
  r20: "0x14" {
    label: "ref_bit: Clock Reference"
    constraint: "1B"
    style.fill: "#add8e6"
  }
  r21: "0x15" {
    label: "dirty: Write-back Flag"
    constraint: "1B"
    style.fill: "#add8e6"
  }
  
  # Allocation Row: Green (#90ee90)
  r22: "0x16" {
    label: "in_use: Allocation Status"
    constraint: "1B"
    style.fill: "#90ee90"
  }
  
  # Padding Row: Gray (#d3d3d3)
  r23: "0x17" {
    label: "padding"
    constraint: "1B"
    style.fill: "#d3d3d3"
  }
}

cache_line_analysis: {
  label: "L1 Cache Alignment (64B Line Analysis)"
  
  # Cache lines visualized as dashed containers
  line_0: {
    label: "Cache Line 0 [Bytes 0-63]"
    style: {
      stroke-dash: 5
      stroke: "#666666"
      fill: "#f8f9fa"
    }

    desc_0: "frame_desc[0] (24B)" {
      width: 180
      height: 40
      style.fill: "#add8e6"
    }
    desc_1: "frame_desc[1] (24B)" {
      width: 180
      height: 40
      style.fill: "#add8e6"
    }
    desc_2_a: "desc[2] Part A (16B)" {
      width: 180
      height: 40
      style.fill: "#ffcccb" # Red alert for straddle
    }
  }

  line_1: {
    label: "Cache Line 1 [Bytes 64-127]"
    style: {
      stroke-dash: 5
      stroke: "#666666"
      fill: "#f8f9fa"
    }

    desc_2_b: "desc[2] Part B (8B)" {
      width: 180
      height: 40
      style.fill: "#ffcccb" # Red alert for straddle
    }
    desc_3: "frame_desc[3] (24B)" {
      width: 180
      height: 40
      style.fill: "#add8e6"
    }
  }
  
  line_0.desc_2_a -> line_1.desc_2_b: "CACHE STRADDLE" {
    style.stroke: "red"
    style.stroke-width: 3
    style.animated: true
  }
}

annotations: |md
  ### Architectural Analysis
  - **Total Size:** 24 bytes per descriptor.
  - **Memory Footprint:** 1,536 bytes for 64 descriptors.
  - **Packing Efficiency:** 2.66 descriptors per 64B cache line.
  - **Straddle Penalty:** Index `i` where `(i*24)%64 > 40` results in dual-line fetches.
  - **Alignment:** page_aligned (4096B) start, packed internally.
| {
  # Fix: ELK requires constant value for 'near'
  near: bottom-center
}

# Layout Connections: Orange (#ffa500)
frame_desc_mem.r0 -> cache_line_analysis.line_0.desc_0: "Offset mapping" {
  style.stroke: "#ffa500"
  style.stroke-width: 2
}

# Page Boundary Annotation: Bold
page_boundary: "PHYSICAL PAGE BOUNDARY (4096B)" {
  shape: parallelogram
  style: {
    stroke-width: 5
    stroke: "black"
    fill: "transparent"
    bold: true
  }
}

cache_line_analysis -> page_boundary: "64 Descriptors fit in < 1/2 Page" {
  style.stroke-dash: 3
}