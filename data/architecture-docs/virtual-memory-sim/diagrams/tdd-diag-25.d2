direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# Page Replacement Full Module Architecture
# Intel-Grade Technical Specification

classes: {
  struct: {
    shape: class
    style: {
      stroke: "#222222"
      stroke-width: 2
      fill: "#BBDEFB" # Data=Blue
    }
  }
  logic: {
    shape: package
    style: {
      fill: "#E1F5FE"
      stroke: "#01579B"
    }
  }
  header_style: {
    style: {
      fill: "#673AB7" # Header=Purple
      font-color: "#ffffff"
    }
  }
  padding_field: {
    style: {
      fill: "#E0E0E0" # Padding=Gray
    }
  }
}

MemoryData: {
  label: "Physical & Swap Storage Layout | sizeof=~258KB"
  style.fill: "#F5F5F5"
  
  frame_desc_t: {
    class: struct
    label: "frame_desc_t | 32 Bytes"
    "0x00: vpn": "uint32_t [4B]"
    "0x04: asid": "uint16_t [2B]"
    "0x06: flags": "uint8_t (Dirty/Ref) [1B]"
    "0x07: padding": "uint8_t [1B]" {class: padding_field}
    "0x08: load_time": "uint64_t [8B]"
    "0x10: last_access": "uint64_t [8B]"
    "0x18: reserved": "uint64_t [8B]"
  }

  phys_mem_t: {
    class: struct
    label: "phys_mem_t | Base + (32+4096)*N"
    "0x00: desc": "frame_desc_t[NUM_FRAMES]"
    "0x...: data": "uint8_t[NUM_FRAMES][4096]"
    "stat: frames": "uint32_t"
    "stat: clock": "uint64_t"
  }

  swap_slot_t: {
    class: struct
    label: "swap_slot_t | 4101 Bytes"
    "0x00: data": "uint8_t[4096B]"
    "0x1000: vpn": "uint32_t [4B]"
    "0x1004: in_use": "uint8_t [1B]"
  }

  swap_space_t: {
    class: struct
    label: "swap_space_t"
    "slots": "swap_slot_t[MAX_SWAP_PAGES]"
    "w_backs": "uint64_t"
    "p_ins": "uint64_t"
  }

  phys_mem_t -> frame_desc_t: "contains" {style.stroke: orange} # Pointers/Ref=Orange
  swap_space_t -> swap_slot_t: "contains" {style.stroke: orange}
}

ReplacementLogic: {
  class: logic
  label: "Replacement Engine"

  replacement_policy_t: "<<enumeration>>" {
    shape: parallelogram
    FIFO
    LRU
    CLOCK
    OPTIMAL
  }

  ReplacementAPI: {
    shape: rectangle
    style.fill: "#673AB7"
    style.font-color: "#ffffff"
    
    replace_page(pm, swap, pt, tlb, policy, trace, idx, hand): "replace_result_t"
    evict_frame(pm, swap, pt, tlb, victim_idx): "replace_result_t"
    
    replace_fifo(pm, swap, pt, tlb): "replace_result_t"
    replace_lru(pm, swap, pt, tlb): "replace_result_t"
    replace_clock(pm, swap, pt, tlb, hand): "replace_result_t"
    replace_optimal(pm, swap, pt, tlb, trace, idx): "replace_result_t"
  }
}

Outputs: {
  replace_result_t: {
    class: struct
    freed_frame: "uint32_t"
    evicted_vpn: "uint32_t"
    was_dirty: "bool"
  }

  sim_stats_t: {
    class: struct
    label: "sim_stats_t"
    page_faults: "uint64_t"
    dirty_writebacks: "uint64_t"
    page_ins: "uint64_t"
    peak_working_set: "uint32_t"
  }
}

# System Relationships
ReplacementLogic.ReplacementAPI -> MemoryData.phys_mem_t: "references" {style.stroke-dash: 5; style.stroke: orange}
ReplacementLogic.ReplacementAPI -> MemoryData.swap_space_t: "updates" {style.stroke-dash: 5; style.stroke: orange}
ReplacementLogic.ReplacementAPI -> Outputs.replace_result_t: "returns"
ReplacementLogic.replacement_policy_t -> ReplacementLogic.ReplacementAPI: "configures"

"M1: page_table_t" -- ReplacementLogic.ReplacementAPI: "clears PTEs" {style.stroke-dash: 3}
"M2: tlb_t" -- ReplacementLogic.ReplacementAPI: "invalidates entries" {style.stroke-dash: 3}

# Hardware and Invariants
Legend: {
  shape: rectangle
  style: {
    stroke-dash: 3
    fill: "#FFF9C4"
  }
  label: |md
    ### Hardware Constraints
    - **Coherence**: TLB must be flushed *before* PTE is cleared.
    - **Persistence**: Dirty pages must hit Swap before frame is reused.
    - **Latency**: Clock algorithm approximates LRU with O(1) per access.
  |
}

Legend.near: bottom-right