direction: right
layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
    sketch: false
  }
}

# --------------------------------------------------------------------------------------------
# Algorithm State Diagram: Dirty vs Clean Page Eviction Cost Divergence
# --------------------------------------------------------------------------------------------

eviction_decision: {
  label: "Victim Frame [K] Selection"
  
  step_0: "0. Victim Selection" {
    shape: rectangle
    label: |md
      **INPUT STATE**
      frame_desc[K].vpn: 0x1A3
      frame_desc[K].in_use: true
      pte_t[0x1A3].valid: 1
    |
    style.fill: "#f1f8ff"
  }

  step_1: "1. Dirty Bit Check" {
    shape: diamond
    label: "frame_desc[K].dirty == true?"
  }

  step_0 -> step_1

  # ------------------------------------------------------------------
  # DIRTY PATH (Costly)
  # ------------------------------------------------------------------
  dirty_path: {
    style.stroke: "#d73a49"
    style.stroke-width: 4
    style.fill: "#fff5f5"

    step_2a: "2a. swap_page_out()" {
      label: |md
        **ACTION**
        1. find_swap_slot(0x1A3)
        2. **<font color="red">memcpy(4096B)</font>** to SwapSlot
        3. **<font color="red">write_backs: n → n+1</font>**
        4. Log: [SWAP OUT]
      |
    }

    step_3a: "3a. tlb_flush_page(0x1A3)" {
      label: |md
        **ACTION**
        Search TLB for vpn:0x1A3
        **<font color="red">tlb_entry.valid: 1 → 0</font>**
      |
    }

    step_4a: "4a. PTE Invalidation" {
      label: |md
        **ACTION**
        pte_t[0x1A3].valid: 1 → **<font color="red">0</font>**
        pte_t[0x1A3].dirty: 1 → **<font color="red">0</font>**
      |
    }

    step_5a: "5a. Frame Reclamation" {
      label: |md
        **FINAL STATE**
        frame_desc[K].vpn: **<font color="red">UINT32_MAX</font>**
        frame_desc[K].in_use: **<font color="red">false</font>**
      |
    }

    step_2a -> step_3a -> step_4a -> step_5a
  }

  # ------------------------------------------------------------------
  # CLEAN PATH (Optimized)
  # ------------------------------------------------------------------
  clean_path: {
    style.stroke: "#0366d6"
    style.stroke-width: 4
    style.fill: "#f1f8ff"

    step_2b: "2b. Bypass Swap" {
      label: |md
        **ACTION**
        Skip Disk I/O
        (Data matches storage)
      |
    }

    step_3b: "3b. tlb_flush_page(0x1A3)" {
      label: |md
        **ACTION**
        Search TLB for vpn:0x1A3
        **<font color="red">tlb_entry.valid: 1 → 0</font>**
      |
    }

    step_4b: "4b. PTE Invalidation" {
      label: |md
        **ACTION**
        pte_t[0x1A3].valid: 1 → **<font color="red">0</font>**
      |
    }

    step_5b: "5b. Frame Reclamation" {
      label: |md
        **FINAL STATE**
        frame_desc[K].vpn: **<font color="red">UINT32_MAX</font>**
        frame_desc[K].in_use: **<font color="red">false</font>**
      |
    }

    step_2b -> step_3b -> step_4b -> step_5b
  }

  step_1 -> dirty_path.step_2a: "True (Dirty)" {
    style.stroke: "#d73a49"
    style.font-color: "#d73a49"
    style.bold: true
  }
  step_1 -> clean_path.step_2b: "False (Clean)" {
    style.stroke: "#0366d6"
    style.font-color: "#0366d6"
    style.bold: true
  }
}

# Fix: elk engine requires constant values for 'near' (e.g., bottom-center)
annotation: |md
  ### Cost Divergence Analysis
  - **Dirty Path Cost:** High. Incurs `memcpy` overhead and `write_backs` counter increment. Effectively mimics high-latency Disk I/O.
  - **Clean Path Cost:** Low. Immediate frame availability after coherence steps.
| {
  near: bottom-center
}