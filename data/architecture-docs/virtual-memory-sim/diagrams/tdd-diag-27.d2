vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 6
  }
}

eviction_process: {
  shape: sequence_diagram
  
  evict_frame: "evict_frame()\nController" {
    shape: person
    style.stroke: "#8E24AA"
  }
  
  phys_mem: "phys_mem_t\n(RAM)" {
    style.fill: "#B6DDF6"
  }
  
  swap_space: "swap_space_t\n(Disk)" {
    shape: cylinder
    style.fill: "#C2E9C2"
  }
  
  tlb: "tlb_t\n(MMU Cache)" {
    style.fill: "#FFE0B2"
  }
  
  page_table: "page_table_t\n(Paging Structure)" {
    style.fill: "#E1BEE7"
  }

  evict_frame."â–¼ ACQUIRE PagingLock"
  
  evict_frame -> phys_mem: "1. Read frame_desc[victim] -> {dirty, vpn}" {
    style.stroke: "#2196F3"
  }
  phys_mem."Check .dirty bit and .vpn mapping"

  evict_frame -> swap_space: "2. IF dirty: swap_page_out(frame, vpn) -> status" {
    style.stroke: "#2196F3"
  }
  
  critical_persistence: {
    swap_space."ðŸ”´ DANGER: PERSISTENCE ORDER\nData MUST be written to swap before pointers are cleared."
  }

  evict_frame -> tlb: "3. tlb_flush_page(vpn) -> void" {
    style.stroke: "#FB8C00"
  }
  
  tlb -> page_table: "Sync Dirty/Ref bits from hardware to PTE" {
    style.stroke-dash: 3
  }
  
  coherence_gap: {
    tlb."ðŸ”´ DANGER: COHERENCE GAP\nTLB must be flushed BEFORE Page Table Entry is cleared."
  }

  evict_frame -> page_table: "4. update_pte(vpn, VALID=0) -> pte_t" {
    style.stroke: "#8E24AA"
  }
  
  leak_prevention: {
    page_table."ðŸ”´ DANGER: LEAK PREVENTION\nClearing PTE triggers Page Faults for future access."
  }

  evict_frame -> phys_mem: "5. frame_desc[victim].in_use = false" {
    style.stroke: "#2196F3"
  }
  
  resource_race: {
    phys_mem."ðŸ”´ DANGER: RESOURCE RACE\nMarking in_use=false must be the LAST step."
  }

  evict_frame."â–² RELEASE PagingLock"
}

ann: |md
  ### Operations Specification
  - **Latency Critical:** Steps 2 (I/O) and 3 (IPI/TLB Shootdown)
  - **Atomic Context:** Entire sequence must hold `PagingLock`
  - **Error Handling:** If Step 2 fails, abort and return `E_IO`
| {
  near: bottom-center
  style: {
    stroke: "#8E24AA"
    fill: "#F3E5F5"
    font-size: 14
  }
}