layout-engine: elk
vars: {
  d2-config: {
    theme-id: 4
  }
}

# ALGORITHM: VIRTUAL ADDRESS DECOMPOSITION (4KB PAGES)
address_decomposition: {
  label: "PROCESSOR PIPELINE: ADDR DECOMPOSITION (32-bit)"
  style.stroke-width: 4

  # STEP 1: INPUT
  step_1: "1. INPUT: VIRTUAL ADDRESS" {
    vaddr: "0x01A3F07C" {
      style: {
        stroke-width: 4
        stroke: "#ffa500"
      }
    }
  }

  # STEP 2: BINARY DECOMPOSITION
  step_2: "2. BINARY WORD VIEW" {
    decomposition: {
      shape: sql_table
      header: "32-bit Register Mapping"
      bits_31_12: "VPN [31:12]" {
        label: "**00000001101000111111**"
        style.font-color: red
      }
      bits_11_0: "Offset [11:0]" {
        label: "**000001111100**"
        style.font-color: blue
      }
    }
  }

  # STEP 3: VPN EXTRACTION
  step_3: "3. VPN EXTRACTION (SHIFT)" {
    logic: |go
      // Right-shift to remove 12-bit offset
      vpn = (vaddr >> 12);
    |
    state: {
      shape: sql_table
      input: "0x01A3F07C"
      op: ">> 12"
      result: "**0x01A3F**" {
        style.font-color: red
        style.bold: true
      }
    }
    explanation: |md
      **Shift Factor:** log2(4096) = 12 bits.
      Moves bits [31:12] to positions [19:0].
    |
  }

  # STEP 4: OFFSET EXTRACTION
  step_4: "4. OFFSET EXTRACTION (MASK)" {
    logic: |go
      // Bitwise AND with 0xFFF (4095)
      offset = (vaddr & 0xFFF);
    |
    state: {
      shape: sql_table
      input: "0x01A3F07C"
      op: "& 0xFFF"
      result: "**0x07C**" {
        style.font-color: blue
        style.bold: true
      }
    }
    explanation: |md
      **Mask Value:** (1 << 12) - 1 = 0xFFF.
      Zeroes out the VPN, preserving the displacement.
    |
  }

  # STEP 5: PHYSICAL ADDRESS ASSEMBLY
  step_5: "5. PHYSICAL ADDRESS CONSTRUCTION" {
    assembly: {
      shape: sql_table
      pfn_part: "PFN << 12 (0x0002A << 12)" { label: "0x0002A000" }
      offset_part: "OR Offset ( | 0x07C)" { label: "0x07C" }
      final: "PHYSICAL ADDRESS" {
        label: "**0x0002A07C**"
        style.font-color: green
        style.bold: true
      }
    }
  }

  # ALGORITHM FLOW
  step_1 -> step_2
  step_2 -> step_3
  step_2 -> step_4
  step_3 -> step_5: "VPN -> PTE Lookup -> PFN"
  step_4 -> step_5: "Direct Pass"
}

# WARNINGS (MOVED TO ROOT LEVEL TO RESOLVE NEAR KEY RESTRICTION)
pitfall: {
  label: "⚠️ PITFALL: SHIFT MAGNITUDE"
  content: |md
    **Common Error:** Shifting by 11 or 13.
    Range [11:0] is 12 discrete positions.
    Always shift by exactly `log2(PAGE_SIZE)`.
  |
  style: {
    fill: "#fff0f0"
    stroke: red
  }
  near: top-right
}

# LEGEND
legend: {
  near: bottom-right
  vpn_key: "RED = Virtual Page Number" {
    style.font-color: red
    shape: text
  }
  off_key: "BLUE = Page Offset" {
    style.font-color: blue
    shape: text
  }
  phys_key: "GREEN = Physical Address" {
    style.font-color: green
    shape: text
  }
}