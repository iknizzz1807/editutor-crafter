direction: right
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# --- OPTIMAL (BÉLÁDY'S) ALGORITHM SPECIFICATION ---

Optimal_Analysis: {
  label: "Step 1: Look-Ahead Distance Calculation (Current Access: VPN 4)"
  
  # Physical Memory State (Full)
  PhysicalMemory: {
    shape: sql_table
    style.fill: "#DEE1EB"
    
    header: "Physical Frames (Pool=3)"
    header.style.fill: "#E4DBFE" # Purple header
    f0: "VPN 1" {style.stroke: orange; style.stroke-width: 2; style.fill: "#C7F1FF"} # Blue data
    f1: "VPN 2" {style.stroke: orange; style.stroke-width: 2; style.fill: "#C7F1FF"}
    f2: "VPN 3" {style.stroke: orange; style.stroke-width: 2; style.fill: "#C7F1FF"}
  }

  # The Future Access Trace
  FutureTrace: {
    shape: sql_table
    header: "Future Trace (Look-ahead)"
    header.style.fill: "#E4DBFE" # Purple header
    t0: "idx [0]: VPN 4 (Current Fault)" {style.fill: "#E4DBFE"}
    t1: "idx [1]: VPN 1" 
    t2: "idx [2]: VPN 3"
    t3: "idx [3]: VPN X"
    t4: "idx [4]: VPN X"
    t5: "idx [5]: VPN 2"
    t6: "idx [6]: VPN 5"
  }

  # Distance Scans
  PhysicalMemory.f0 -> FutureTrace.t1: "dist=1" {style.stroke: blue; style.stroke-dash: 3}
  PhysicalMemory.f2 -> FutureTrace.t2: "dist=2" {style.stroke: blue; style.stroke-dash: 3}
  PhysicalMemory.f1 -> FutureTrace.t5: "dist=5 (MAX)" {style.stroke: red; style.stroke-width: 3}
}

# Logic Annotation - Moved to root level to fix 'near' compilation error
Analysis_Explanation: |md
  ### Victim Selection Logic
  1. Scan forward from `current_idx` (idx 0).
  2. VPN 1 found at index 1 (**d=1**).
  3. VPN 3 found at index 2 (**d=2**).
  4. VPN 2 found at index 5 (**d=5**).
  5. **Rule:** Evict VPN with `Max(distance)`.
  6. **Note:** If VPN not in future, $dist = \infty$.
| {
  near: bottom-right
}

Optimal_Replacement: {
  label: "Step 2: Victim Eviction and Frame Reassignment"
  
  PhysicalMemory_After: {
    shape: sql_table
    style.fill: "#DEE1EB"
    
    header: "Physical Frames (Post-Replacement)"
    header.style.fill: "#E4DBFE"
    f0: "VPN 1" {style.fill: "#C7F1FF"}
    f1: "VPN 4" {style.font-color: red; style.stroke: red; style.stroke-width: 4; style.bold: true; style.fill: "#C7F1FF"}
    f2: "VPN 3" {style.fill: "#C7F1FF"}
  }

  Action: "Evict VPN 2\nLoad VPN 4" {
    shape: package
    style.fill: "#ACE1AF" # Green for action/free logic
  }

  # Connections use absolute paths
  _.Optimal_Analysis.PhysicalMemory.f1 -> Action
  Action -> PhysicalMemory_After.f1
}

# Implementation Warnings
Replacement_Warning: |md
  **OFF-BY-ONE WARNING**
  Scan must start **AT** `current_idx` to correctly identify immediate re-use vs. cold faulting.
| {
  near: top-right
  style.font-color: red
  style.bold: true
}

# Global Styling
***.style.font: mono
(*** -> ***)[*]: {
  style.animated: true
}