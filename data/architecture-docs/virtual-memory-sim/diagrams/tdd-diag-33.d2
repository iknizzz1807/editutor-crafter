vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

title: "Working Set Window Tracker — Sliding Window State" {
  shape: text
  near: top-center
  style.font-size: 18
}

legend: {
  near: top-left
  "H": "Head Pointer" { shape: circle; style.fill: orange }
  "V": "New/Changed Value" { style.stroke: red; style.bold: true }
  "F": "Free/Empty" { style.fill: "#e8f5e9" }
}

# -----------------------------------------------------------------------------
# STEP 1: INITIAL FILL
# -----------------------------------------------------------------------------
step_1: "1. T=5 (Cold Start/Partial Fill)" {
  style.stroke: purple
  direction: right
  
  buffer: {
    grid-columns: 10
    grid-gap: 5
    
    s0: "7" { style.stroke: red; style.bold: true }
    s1: "0" { style.stroke: red; style.bold: true }
    s2: "1" { style.stroke: red; style.bold: true }
    s3: "2" { style.stroke: red; style.bold: true }
    s4: "0" { style.stroke: red; style.bold: true }
    s5: "-" { style.fill: "#e8f5e9" }
    s6: "-" { style.fill: "#e8f5e9" }
    s7: "-" { style.fill: "#e8f5e9" }
    s8: "-" { style.fill: "#e8f5e9" }
    s9: "-" { style.fill: "#e8f5e9" }
  }

  head: "Head (head=5)" { shape: circle; style.fill: orange }
  head -> buffer.s5: "Next Write"

  stats: |md
    **Stats**
    - Window Size (Δ): 10
    - Buffer Fill: 5/10
    - Unique Pages: {0, 1, 2, 7}
    - **WS Size: 4**
  |
}

# -----------------------------------------------------------------------------
# STEP 2: BUFFER SATURATION
# -----------------------------------------------------------------------------
step_2: "2. T=10 (Buffer Saturated)" {
  style.stroke: purple
  direction: right
  
  buffer: {
    grid-columns: 10
    grid-gap: 5
    
    s0: "7"
    s1: "0"
    s2: "1"
    s3: "2"
    s4: "0"
    s5: "3" { style.stroke: red; style.bold: true }
    s6: "0" { style.stroke: red; style.bold: true }
    s7: "4" { style.stroke: red; style.bold: true }
    s8: "2" { style.stroke: red; style.bold: true }
    s9: "3" { style.stroke: red; style.bold: true }
  }

  head: "Head (head=0)" { shape: circle; style.fill: orange }
  head -> buffer.s0: "Wrap Around"

  stats: |md
    **Stats**
    - Window Size (Δ): 10
    - Buffer Fill: 10/10 (Full)
    - Unique Pages: {0, 1, 2, 3, 4, 7}
    - **WS Size: 6**
  |
}

# -----------------------------------------------------------------------------
# STEP 3: WRAP-AROUND OVERWRITE
# -----------------------------------------------------------------------------
step_3: "3. T=15 (Sliding Window Shift)" {
  style.stroke: purple
  direction: right
  
  buffer: {
    grid-columns: 10
    grid-gap: 5
    
    s0: "4" { style.stroke: red; style.bold: true }
    s1: "2" { style.stroke: red; style.bold: true }
    s2: "3" { style.stroke: red; style.bold: true }
    s3: "0" { style.stroke: red; style.bold: true }
    s4: "3" { style.stroke: red; style.bold: true }
    s5: "3"
    s6: "0"
    s7: "4"
    s8: "2"
    s9: "3"
  }

  head: "Head (head=5)" { shape: circle; style.fill: orange }
  head -> buffer.s5: "Advancing"

  stats: |md
    **Stats**
    - Window Size (Δ): 10
    - Buffer: 50% Overwritten
    - Unique Pages: {0, 2, 3, 4}
    - **WS Size: 4**
  |
}

thrashing_logic: |md
  ### Thrashing Detection Logic
  If **WS Size > Physical Frames** consistently across multiple window samples, 
  the simulator reports **Thrashing Phase Transition**.
  
  *Invariant: Effective Memory Bandwidth drops 90%+ during thrashing.*
| {
  near: bottom-center
  style.stroke: red
  style.stroke-dash: 3
}

step_1 -> step_2 -> step_3: "Logical Time Advance" {
  style.stroke: "#2196f3"
  style.stroke-width: 2
}