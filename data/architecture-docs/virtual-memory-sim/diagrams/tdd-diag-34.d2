shape: sequence_diagram

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}

# -------------------------------------------------------------------------------------------
# PARTICIPANTS: Exact simulator types
# -------------------------------------------------------------------------------------------
MMU: "simulator_t\n(Translation Logic)" {
  shape: person
}
RAM: "phys_mem_t\n(Simulated RAM)" {
  shape: cylinder
  style.fill: "#B6DDF6"
}
SWAP: "swap_space_t\n(Simulated Disk)" {
  shape: cylinder
  style.fill: "#DEE1EB"
}
TLB: "tlb_t\n(Translation Cache)" {
  style.fill: "#F9D8A7"
}
PT: "page_table_t\n(Hierarchical Tables)" {
  style.fill: "#C6F6D5"
}

# -------------------------------------------------------------------------------------------
# PHASE 1: PAGE-OUT (EVICTION)
# -------------------------------------------------------------------------------------------
Page_Out: "PHASE 1: Page-Out (Eviction of Dirty Page)" {
  MMU -> MMU: "evict_frame(f_idx=7, vpn=0x42)"
  
  MMU -> SWAP: "swap_page_out(frame=7, vpn=0x42)"
  SWAP."Triggered because PTE.Dirty == 1"
  
  SWAP -> SWAP: "swap_alloc_slot(vpn=0x42)"
  SWAP."Found empty slot K"
  
  SWAP -> RAM: "memcpy(dst=swap.slots[K].data, src=phys_mem.data[7], size=4096)" {
    style.stroke: "#ed800c"
    style.stroke-width: 2
  }
  
  SWAP -> SWAP: "slots[K].vpn=0x42, in_use=true"
  SWAP -> SWAP: "write_backs++"
  
  MMU -> TLB: "tlb_flush_page(vpn=0x42)"
  TLB."Coherence: Flush before PTE clear"
  
  MMU -> PT: "pte_update(vpn=0x42, valid=0, pfn=0)"
  PT."Mapping removed from RAM"
  
  MMU -> RAM: "frames[7].in_use = false"
  RAM."Frame 7 is now FREE"
}

# -------------------------------------------------------------------------------------------
# PHASE 2: PAGE-IN (FAULT RECOVERY)
# -------------------------------------------------------------------------------------------
Page_In: "PHASE 2: Page-In (Reload from Swap)" {
  MMU -> MMU: "handle_page_fault(vpn=0x42)"
  MMU."New Access to 0x42 triggers fault"
  
  MMU -> RAM: "phys_find_free() -> frame 12"
  
  MMU -> SWAP: "swap_page_in(frame=12, vpn=0x42)"
  
  SWAP -> SWAP: "swap_find_slot(vpn=0x42)"
  SWAP."Returns slot K"
  
  SWAP -> RAM: "memcpy(dst=phys_mem.data[12], src=swap.slots[K].data, size=4096)" {
    style.stroke: "#44C7B1"
    style.stroke-width: 2
  }
  
  SWAP -> SWAP: "slots[K].in_use = false"
  SWAP."Slot K freed; original source is now RAM"
  
  SWAP -> SWAP: "page_ins++"
  
  MMU -> PT: "pte_update(vpn=0x42, valid=1, pfn=12)"
  PT."Mapping restored to RAM"
}

# -------------------------------------------------------------------------------------------
# TIMING AND ANNOTATIONS
# -------------------------------------------------------------------------------------------
MMU.style.font: mono
RAM.style.font: mono
SWAP.style.font: mono

# Notes on participants are defined as nested objects without connections
SWAP.ann1: |md
  **Latency Analysis**
  - TLB/PTE Update: ~1ns (Simulated)
  - Memcpy (4KB): ~100ns
  - *Real Hardware Disk I/O: 10ms+*
|