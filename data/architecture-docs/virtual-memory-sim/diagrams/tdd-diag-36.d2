direction: right
layout-engine: elk
vars: {
  d2-config: {
    theme-id: 0
    pad: 20
  }
}

# GLOBAL CLASSES FOR INTEL-SPEC STYLE
classes: {
  header_purple: {
    style: {
      fill: "#673AB7"
      font-color: white
      bold: true
    }
  }
  data_blue: {
    style: {
      fill: "#E3F2FD"
      stroke: "#2196F3"
    }
  }
  pointer_orange: {
    style: {
      fill: "#FFF3E0"
      stroke: "#FF9800"
    }
  }
  padding_gray: {
    style: {
      fill: "#EEEEEE"
      stroke: "#9E9E9E"
    }
  }
  annotation: {
    shape: rectangle
    style: {
      stroke-dash: 3
      border-radius: 5
      fill: "#FAFAFA"
      font-size: 12
    }
  }
}

"LRU Implementation Comparison": {
  
  "Timestamp Approach (M4 Simulator)": {
    phys_mem_t: {
      shape: sql_table
      class: header_purple
      "0x00: logical_clock": uint64_t {constraint: 8B; class: data_blue}
      "0x08: frames_ptr": "frame_desc_t*" {constraint: 8B; class: pointer_orange}
      "METHODS": "update_access(f_id), find_victim()" {style.italic: true}
    }

    frame_desc_t: {
      shape: sql_table
      class: header_purple
      "0x00: vpn": uint32_t {constraint: 4B; class: data_blue}
      "0x04: last_access": uint64_t {constraint: 8B; class: data_blue}
      "0x0C: flags": uint8_t {constraint: 1B; class: data_blue}
      "0x0D: in_use": bool {constraint: 1B; class: data_blue}
      "0x0E: padding": uint16_t {constraint: 2B; class: padding_gray}
    }

    phys_mem_t."0x08: frames_ptr" -> frame_desc_t: "owns [N] (Array)" {
      style.stroke-width: 2
    }

    "Logic Annotation A": |md
      ### Simulation Logic (Intel M4)
      - **Access Cost:** $O(1)$
      - **Eviction Cost:** $O(N)$ (Scan all)
      - **Cache Profile:** High (L1 Friendly)
      - **Total Size:** 32B per frame
    | {
      class: annotation
      near: "LRU Implementation Comparison"."Timestamp Approach (M4 Simulator)".phys_mem_t
    }
  }

  "Doubly-Linked List Approach (Production)": {
    lru_list_t: {
      shape: sql_table
      class: header_purple
      "0x00: head": "*lru_node_t" {constraint: 8B; class: pointer_orange}
      "0x08: tail": "*lru_node_t" {constraint: 8B; class: pointer_orange}
      "METHODS": "move_to_head(), pop_tail()" {style.italic: true}
    }

    lru_node_t: {
      shape: sql_table
      class: header_purple
      "0x00: prev": "*lru_node_t" {constraint: 8B; class: pointer_orange}
      "0x08: next": "*lru_node_t" {constraint: 8B; class: pointer_orange}
      "0x10: vpn": uint32_t {constraint: 4B; class: data_blue}
      "0x14: data_ptr": "void*" {constraint: 8B; class: pointer_orange}
      "0x1C: padding": uint32_t {constraint: 4B; class: padding_gray}
    }

    lru_list_t."0x00: head" -> lru_node_t: "references" {
      style.stroke-dash: 5
    }

    "Logic Annotation B": |md
      ### Production Logic (Kernel)
      - **Access Cost:** $O(1)$ (Pointer swap)
      - **Eviction Cost:** $O(1)$ (Tail pop)
      - **Cache Profile:** Low (Pointer chasing)
      - **Total Size:** 32B aligned
    | {
      class: annotation
      near: "LRU Implementation Comparison"."Doubly-Linked List Approach (Production)".lru_list_t
    }
  }
}

# CROSS-IMPLEMENTATION STATE TRANSITION PATHS
"LRU Implementation Comparison"."Timestamp Approach (M4 Simulator)".phys_mem_t."METHODS" -> "LRU Implementation Comparison"."Timestamp Approach (M4 Simulator)".frame_desc_t."0x04: last_access": "update timestamp" {
  style: {
    stroke: "#FF9800"
    animated: true
  }
}

"LRU Implementation Comparison"."Doubly-Linked List Approach (Production)".lru_list_t."METHODS" -> "LRU Implementation Comparison"."Doubly-Linked List Approach (Production)".lru_node_t."0x08: next": "re-link" {
  style: {
    stroke: "#FF9800"
    animated: true
  }
}

# LAYOUT STYLING
"LRU Implementation Comparison"."Timestamp Approach (M4 Simulator)".style.fill: "#F0F7FF"
"LRU Implementation Comparison"."Doubly-Linked List Approach (Production)".style.fill: "#FFF9F0"
"LRU Implementation Comparison".style.stroke-width: 0