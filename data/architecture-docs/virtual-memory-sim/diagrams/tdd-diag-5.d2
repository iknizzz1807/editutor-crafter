layout-engine: elk
vars: {
  d2-config: {
    theme-id: 6
  }
}

MMU_FLOW: "MMU Decision Tree (Virtual Memory System)" {
  shape: rectangle
  style: {
    stroke-width: 2
  }

  Start: â— {
    shape: circle
  }

  FetchPTE: "Fetch PTE from memory" {
    shape: rectangle
    tooltip: "Bus read at PTBR + (VPN * sizeof(PTE))"
  }

  Start -> FetchPTE

  Decision: "Check Valid Bit" {
    shape: diamond
  }

  FetchPTE -> Decision

  PageFault: "STATE: PAGE FAULT HANDLER" {
    style: {
      fill: "#fff2cc"
      stroke: "#d6b656"
      multiple: true
    }
    
    1: "Trap to OS: handle_page_fault()"
    2: "PhysMem: Allocate free frame"
    3: "Disk: Swap-in page contents"
    4: "Update PTE: Set valid=1, PFN=alloc"
    5: "IRET: Retry Instruction"
    
    1 -> 2 -> 3 -> 4 -> 5
  }

  CheckPerms: "Check Permissions" {
    shape: diamond
  }

  Decision -> PageFault: "valid == 0" {
    style: {
      stroke: red
      bold: true
      font-color: red
    }
  }

  Decision -> CheckPerms: "valid == 1"

  ProtFault: "STATE: PROTECTION FAULT (SIGSEGV)" {
    style: {
      fill: "#f8cecc"
      stroke: "#b85450"
      multiple: true
    }
    
    A: "Hardware: Log Violation to CR2/Fault Reg"
    B: "OS: Identify thread owner"
    C: "Signal: Raise Segmentation Fault"
    D: "Action: Terminate Process"
    
    A -> B -> C -> D
  }

  Success: "SUCCESS: ADDRESS TRANSLATION" {
    style: {
      fill: "#d5e8d4"
      stroke: "#82b366"
    }
    
    Result: "Return Physical Address (PFN << OFFSET_BITS | OFFSET)"
  }

  CheckPerms -> ProtFault: "(OpType & !PTE.perms)" {
    style: {
      stroke: red
      bold: true
      font-color: red
    }
  }

  CheckPerms -> Success: "Permissions OK" {
    style: {
      stroke: green
      bold: true
      font-color: green
    }
  }

  PageFault -> FetchPTE: "RESTART FLOW" {
    style.stroke-dash: 5
  }
}

DecisionMatrix: "PTE Decision Matrix" {
  near: top-right
  grid-columns: 3
  grid-gap: 0
  
  # Header Row
  H1: "**Valid Bit**" { style.fill: "#e1d5e7" }
  H2: "**Permissions**" { style.fill: "#e1d5e7" }
  H3: "**Outcome**" { style.fill: "#e1d5e7" }

  # Row 1
  R1C1: "0"
  R1C2: "Don't Care (X)"
  R1C3: "**PAGE FAULT**" { 
    style.font-color: "#d6b656" 
    style.bold: true
  }

  # Row 2
  R2C1: "1"
  R2C2: "Violation"
  R2C3: "**PROT FAULT**" { 
    style.font-color: "#b85450"
    style.bold: true
  }

  # Row 3
  R3C1: "1"
  R3C2: "Allowed"
  R3C3: "**SUCCESS**" { 
    style.font-color: "#82b366"
    style.bold: true
  }
}

Annotate: |md
  ### Hardware Logic Summary
  - **Page Fault**: A missing mapping. Software (OS) must intervene to populate RAM from disk/zero-fill.
  - **Protection Fault**: A security/permission violation. The mapping exists, but the specific operation (e.g., Write to Read-Only) is forbidden.
  - **MMU Atomic Sequence**: The MMU *must* check the valid bit before evaluating permission bits to avoid reading undefined bit patterns.
| {
  near: bottom-center
}