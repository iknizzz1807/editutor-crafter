layout-engine: elk
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
}

# TLB ENTRY MEMORY LAYOUT SPECIFICATION
# Total size: 12 bytes (96 bits)
# Alignment: 4-byte boundary
# Colors: Header=Purple, Data=Blue, Free=Green, Padding=Gray, Pointers=Orange

tlb_struct: {
  label: "tlb_entry_t Struct Layout (sizeof=12 Bytes)"
  
  header: {
    shape: sql_table
    style: {
      stroke: "#333333"
      stroke-width: 2
    }
    
    "0x00": "vpn: uint32_t" {
      label: "0x00 | VPN (Virtual Page Number) | 4B"
      style.fill: "#B3E5FC" 
    }
    "0x04": "pfn: uint32_t" {
      label: "0x04 | PFN (Physical Frame Number) | 4B"
      style.fill: "#B3E5FC"
    }
    "0x08": "asid: uint16_t" {
      label: "0x08 | ASID (Address Space ID)    | 2B"
      style.fill: "#B3E5FC"
    }
    "0x0A": "flags: uint8_t" {
      label: "0x0A | Control Flags            | 1B"
      style.fill: "#E1BEE7" 
    }
    "0x0B": "lru: uint8_t" {
      label: "0x0B | LRU Counter             | 1B"
      style.fill: "#E1BEE7"
    }
  }
}

flag_detail: {
  label: "Control Flags Bitmask Detail (Byte 0x0A)"
  # FIXED: near property set on root level shape
  near: bottom-center
  
  bits: {
    grid-columns: 8
    grid-gap: 0
    
    b7: "RSVD" { style.fill: "#E0E0E0" } 
    b6: "RSVD" { style.fill: "#E0E0E0" }
    b5: "RSVD" { style.fill: "#E0E0E0" }
    b4: "RSVD" { style.fill: "#E0E0E0" }
    b3: "W" { tooltip: "Writable"; style.fill: "#E1BEE7"; style.bold: true }
    b2: "R" { tooltip: "Referenced"; style.fill: "#E1BEE7"; style.bold: true }
    b1: "D" { tooltip: "Dirty"; style.fill: "#E1BEE7"; style.bold: true }
    b0: "V" { tooltip: "Valid"; style.fill: "#E1BEE7"; style.bold: true }
  }
  
  legend: |md
    - **V [bit 0]**: Valid (Present in TLB)
    - **D [bit 1]**: Dirty (Page has been modified)
    - **R [bit 2]**: Referenced (Accessed bit for LRU)
    - **W [bit 3]**: Writable (Write permissions enabled)
  |
}

cache_line: {
  label: "64-Byte L1 Data Cache Line Packing"
  style: {
    stroke-dash: 5
    stroke: "#666666"
    fill: "#F5F5F5"
  }
  
  packing: {
    grid-columns: 1
    grid-gap: 4
    
    e0: "Entry 0 [Offset 0x00]" { style.fill: "#B3E5FC" }
    e1: "Entry 1 [Offset 0x0C]" { style.fill: "#B3E5FC" }
    e2: "Entry 2 [Offset 0x18]" { style.fill: "#B3E5FC" }
    e3: "Entry 3 [Offset 0x24]" { style.fill: "#B3E5FC" }
    e4: "Entry 4 [Offset 0x30]" { style.fill: "#B3E5FC" }
    waste: "Internal Padding [4 Bytes]" { 
      style.fill: "#E0E0E0"
      style.stroke-dash: 2
    }
  }
  
  note: |md
    ### Intel Manual Quality Spec
    - **Width**: 32-bit aligned VPN/PFN.
    - **Density**: 5 entries per 64B cache line.
    - **Boundary**: 12B struct avoids crossing 64B cache line boundaries if aligned to 64B base.
    - **Total Set**: 64 entries (768 Bytes total footprint).
  |
}

# Mapping Reference
tlb_struct.header -> cache_line.packing.e0: "Sequential mapping (Stride=12B)" {
  style.stroke: "#FF9800"
  style.stroke-width: 2
  style.animated: true
}