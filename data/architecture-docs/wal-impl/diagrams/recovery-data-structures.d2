classes: {
  recovery_structure: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  log_record: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  phase: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
}

title: Recovery Data Structures {
  near: top-center
  style.font-size: 20
  style.bold: true
  style.font-color: "#e6edf3"
}

log_records: Log Records {
  shape: rectangle
  class: log_record

  redo_record: RedoLogRecord {
    shape: class
    - "lsn: LSN"
    - "txn_id: TxnId"
    - "page_id: PageId"
    - "redo_data: bytes"
    - "undo_next_lsn: LSN"
  }

  undo_record: UndoLogRecord {
    shape: class
    - "lsn: LSN"
    - "txn_id: TxnId"
    - "page_id: PageId"
    - "undo_data: bytes"
  }

  commit_record: CommitLogRecord {
    shape: class
    - "lsn: LSN"
    - "txn_id: TxnId"
  }

  abort_record: AbortLogRecord {
    shape: class
    - "lsn: LSN"
    - "txn_id: TxnId"
  }
}

transaction_table: Transaction Table {
  shape: rectangle
  class: recovery_structure

  txn_table_entry: TransactionTableEntry {
    shape: class
    - "txn_id: TxnId"
    - "status: TxnStatus"
    - "last_lsn: LSN"
    - "undo_next_lsn: LSN"
    + "is_active(): bool"
    + "needs_undo(): bool"
  }

  txn_status: TxnStatus {
    shape: class
    - "RUNNING"
    - "COMMITTED"
    - "ABORTED"
    - "ABORTING"
  }

  txn_table_entry -> txn_status: uses
}

dirty_page_table: Dirty Page Table {
  shape: rectangle
  class: recovery_structure

  dpt_entry: DirtyPageTableEntry {
    shape: class
    - "page_id: PageId"
    - "rec_lsn: LSN"
    + "is_dirty(): bool"
    + "get_recovery_lsn(): LSN"
  }

  page_status: PageStatus {
    shape: class
    - "CLEAN"
    - "DIRTY"
    - "FLUSHING"
  }

  dpt_entry -> page_status: tracks
}

recovery_phases: Recovery Phases {
  shape: rectangle
  class: phase

  analysis: Analysis Phase {
    shape: rectangle
    class: phase
    analysis_desc: |md
      **Populates recovery structures**
      - Scan log from checkpoint
      - Build transaction table
      - Build dirty page table
      - Determine redo/undo points
    | {
      shape: page
      style.font-color: "#e6edf3"
    }
  }

  redo: Redo Phase {
    shape: rectangle
    class: phase
    redo_desc: |md
      **Repeats history**
      - Start from oldest dirty page
      - Replay all redo operations
      - Restore database state
    | {
      shape: page
      style.font-color: "#e6edf3"
    }
  }

  undo: Undo Phase {
    shape: rectangle
    class: phase
    undo_desc: |md
      **Rolls back uncommitted**
      - Process active transactions
      - Apply undo operations
      - Write abort records
    | {
      shape: page
      style.font-color: "#e6edf3"
    }
  }

  analysis -> redo: populates tables for
  redo -> undo: enables rollback via
}

log_records.redo_record -> transaction_table.txn_table_entry: creates/updates {
  style.stroke: "#8b949e"
}

log_records.redo_record -> dirty_page_table.dpt_entry: creates/updates {
  style.stroke: "#8b949e"
}

log_records.commit_record -> transaction_table.txn_table_entry: updates status {
  style.stroke: "#8b949e"
}

log_records.abort_record -> transaction_table.txn_table_entry: updates status {
  style.stroke: "#8b949e"
}

recovery_phases.analysis -> transaction_table: builds {
  style.stroke: "#3fb950"
  style.stroke-width: 2
}

recovery_phases.analysis -> dirty_page_table: builds {
  style.stroke: "#3fb950"
  style.stroke-width: 2
}

recovery_phases.redo -> dirty_page_table: uses for replay {
  style.stroke: "#3fb950"
}

recovery_phases.undo -> transaction_table: uses for rollback {
  style.stroke: "#3fb950"
}