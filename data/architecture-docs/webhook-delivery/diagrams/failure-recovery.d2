title: Failure Recovery Architecture {
  style.font-size: 24
  style.bold: true
  near: top-center
}

classes: {
  container_style: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  critical_style: {
    style.fill: "#0f3460"
    style.stroke: "#d63031"
    style.font-color: "#ffffff"
    style.bold: true
  }
  process_style: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
  storage_style: {
    style.fill: "#2d3748"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
}

detection: Failure Detection {
  class: container_style
  
  health_monitor: Health Monitor {
    class: process_style
  }
  
  timeout_detector: Timeout Detector {
    class: process_style
  }
  
  response_analyzer: Response Analyzer {
    class: process_style
  }
}

circuit_breaker: Circuit Breaker System {
  class: container_style
  
  state_manager: State Manager {
    class: critical_style
    label: "State Manager\n(OPEN/CLOSED/HALF-OPEN)"
  }
  
  threshold_counter: Threshold Counter {
    class: process_style
  }
  
  recovery_timer: Recovery Timer {
    class: process_style
  }
}

dead_letter: Dead Letter Processing {
  class: container_style
  
  dlq: Dead Letter Queue {
    shape: queue
    class: storage_style
  }
  
  categorizer: Error Categorizer {
    class: process_style
  }
  
  retention_manager: Retention Manager {
    class: process_style
  }
}

manual_intervention: Manual Intervention {
  class: container_style
  
  operator_console: Operator Console {
    class: critical_style
  }
  
  replay_engine: Event Replay Engine {
    class: process_style
  }
  
  audit_viewer: Audit Trail Viewer {
    class: process_style
  }
}

event_store: Event Store {
  shape: cylinder
  class: storage_style
}

metrics_store: Metrics Store {
  shape: cylinder
  class: storage_style
}

notification: Alert System {
  class: critical_style
  shape: cloud
}

# Failure Detection Flow
detection.health_monitor -> circuit_breaker.threshold_counter: failure count
detection.timeout_detector -> circuit_breaker.threshold_counter: timeout events
detection.response_analyzer -> circuit_breaker.threshold_counter: error classification

# Circuit Breaker Flow
circuit_breaker.threshold_counter -> circuit_breaker.state_manager: threshold exceeded
circuit_breaker.state_manager -> circuit_breaker.recovery_timer: activate cooldown
circuit_breaker.recovery_timer -> circuit_breaker.state_manager: recovery attempt

# Dead Letter Flow
circuit_breaker.state_manager -> dead_letter.categorizer: permanent failures
dead_letter.categorizer -> dead_letter.dlq: store failed events
dead_letter.retention_manager -> dead_letter.dlq: cleanup expired

# Manual Intervention Flow
manual_intervention.operator_console -> manual_intervention.replay_engine: trigger replay
manual_intervention.replay_engine -> dead_letter.dlq: retrieve events
manual_intervention.audit_viewer -> event_store: query delivery history

# Storage and Monitoring
detection -> event_store: log detection events
circuit_breaker -> metrics_store: store state changes
dead_letter -> event_store: audit trail
manual_intervention -> event_store: operator actions

# Alerting
circuit_breaker.state_manager -> notification: circuit opened
dead_letter.dlq -> notification: DLQ threshold exceeded
detection.health_monitor -> notification: system degradation