title: Broadcasting Message Flow

classes: {
  client: {
    style.fill: "#1a1a2e"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
  }
  manager: {
    style.fill: "#0f3460"
    style.stroke: "#3fb950"
    style.font-color: "#e6edf3"
    style.bold: true
  }
  message: {
    style.fill: "#16213e"
    style.stroke: "#8b949e"
    style.font-color: "#e6edf3"
  }
}

# Client connections
client_a: Client A {
  class: client
  websocket_a: WebSocket Connection {
    class: client
  }
}

client_b: Client B {
  class: client
  websocket_b: WebSocket Connection {
    class: client
  }
}

client_c: Client C {
  class: client
  websocket_c: WebSocket Connection {
    class: client
  }
}

client_d: Client D {
  class: client
  websocket_d: WebSocket Connection {
    class: client
  }
}

# Connection Manager
connection_manager: Connection Manager {
  class: manager
  
  connection_registry: Connection Registry {
    class: message
  }
  
  message_router: Message Router {
    class: message
  }
  
  broadcast_handler: Broadcast Handler {
    class: message
  }
}

# Message flow
original_message: Original Message {
  class: message
  shape: page
}

# Step 1: Client sends message
client_a.websocket_a -> connection_manager.message_router: 1. Incoming message
original_message -> connection_manager.message_router: message payload

# Step 2: Router processes and prepares broadcast
connection_manager.message_router -> connection_manager.connection_registry: 2. Get active connections
connection_manager.connection_registry -> connection_manager.message_router: active connection list

# Step 3: Route to broadcast handler
connection_manager.message_router -> connection_manager.broadcast_handler: 3. Initiate broadcast

# Step 4: Broadcast to all other clients
connection_manager.broadcast_handler -> client_b.websocket_b: 4a. Broadcast message
connection_manager.broadcast_handler -> client_c.websocket_c: 4b. Broadcast message  
connection_manager.broadcast_handler -> client_d.websocket_d: 4c. Broadcast message

# Internal connections
connection_manager.connection_registry <-> connection_manager.broadcast_handler: connection state

# Flow indicators
flow_note: |md
  **Message Broadcasting Flow:**
  1. Client A sends message via WebSocket
  2. Connection Manager receives and processes
  3. Registry provides list of active connections
  4. Broadcast Handler sends to all other clients
  5. Clients B, C, D receive the message
| {
  shape: page
  class: message
  near: top-center
}