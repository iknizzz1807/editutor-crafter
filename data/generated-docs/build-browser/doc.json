{"html":"<h1 id=\"build-your-own-browser-engine-design-document\">Build Your Own Browser Engine: Design Document</h1>\n<h2 id=\"overview\">Overview</h2>\n<p>This system implements a simplified web browser engine that parses HTML and CSS, computes layout using the CSS box model, and renders web pages to a visual canvas. The key architectural challenge is building a multi-stage pipeline that transforms textual markup into positioned visual elements while handling the complex interactions between HTML structure, CSS styling, and geometric layout algorithms.</p>\n<blockquote>\n<p>This guide is meant to help you understand the big picture before diving into each milestone. Refer back to it whenever you need context on how components connect.</p>\n</blockquote>\n<h2 id=\"context-and-problem-statement\">Context and Problem Statement</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> All milestones (1-4) - This section establishes the foundational understanding needed throughout the entire project.</p>\n</blockquote>\n<p>Web browsers are among the most sophisticated software systems ever created, rivaling operating systems in their complexity and scope. Every time you load a web page, your browser performs an intricate dance of parsing, computation, and rendering that transforms static markup text into a rich, interactive visual experience. Understanding why this process is so complex—and how we can build a simplified version—requires us to appreciate both the technical challenges involved and the architectural approaches that have evolved to address them.</p>\n<p>The fundamental challenge of web rendering lies in the gap between two very different representations of the same content. On one side, we have textual markup languages (HTML and CSS) that describe content structure and visual styling in human-readable form. On the other side, we need pixel-perfect visual output displayed on screens with specific dimensions, colors, and fonts. Bridging this gap requires solving multiple interconnected problems: parsing complex, often malformed markup languages; resolving cascading style rules with intricate precedence hierarchies; computing geometric layouts that satisfy dozens of interacting constraints; and finally rendering visual elements with precise positioning, typography, and graphics.</p>\n<p>The complexity multiplies when we consider that web standards have evolved organically over decades, accumulating layers of backward compatibility, edge cases, and subtle interactions between features. A complete browser engine must handle thousands of CSS properties, dozens of HTML elements with unique behaviors, complex text rendering across multiple languages and scripts, and sophisticated graphics operations—all while maintaining performance standards that allow smooth interaction with dynamic content.</p>\n<h3 id=\"mental-model-the-document-assembly-line\">Mental Model: The Document Assembly Line</h3>\n<p>Think of a browser engine as a sophisticated <strong>document assembly line</strong>, similar to a modern printing press operation. Just as a printing press transforms a manuscript through multiple specialized stations—typesetting, layout, ink preparation, and final printing—a browser transforms HTML and CSS through distinct processing stages, each with its own specialized machinery and expertise.</p>\n<p>In our assembly line analogy, the raw HTML and CSS files arrive as <strong>unprocessed manuscripts</strong>—readable to humans but not yet ready for final output. The first station on our assembly line is the <strong>tokenization workshop</strong>, where skilled workers (our HTML and CSS parsers) break down the manuscript into individual components: headings, paragraphs, style declarations, and formatting instructions. These workers are trained to handle messy, incomplete manuscripts gracefully—they can infer missing punctuation, correct common mistakes, and organize chaotic input into clean, structured components.</p>\n<p>The tokenized components then move to the <strong>composition department</strong> (our styling system), where layout specialists match each piece of content with its formatting instructions. This is where the CSS cascade resolution happens—imagine expert typesetters consulting multiple style guides simultaneously, applying rules about font selection, spacing, and positioning while resolving conflicts between competing style requirements. The output of this stage is a fully annotated manuscript where every element knows exactly how it should look.</p>\n<p>Next comes the <strong>layout workshop</strong> (our layout engine), where spatial engineers calculate the precise positioning and dimensions of every element. This is analogous to the page layout artists in a printing house who determine where each paragraph, image, and heading will appear on the final page. They must consider complex constraints: available page dimensions, text flow around images, margin requirements, and the intricate interactions between nested elements. Unlike simple document layout, web layout must handle dynamic content where the size of one element can affect the positioning of all others.</p>\n<p>Finally, our assembly line reaches the <strong>printing press</strong> (our rendering engine), where the carefully planned layout gets translated into actual visual output. Modern printing presses don&#39;t just apply ink to paper—they manage multiple color separations, ensure precise registration, and optimize the printing sequence for efficiency. Similarly, our rendering engine doesn&#39;t just draw pixels—it manages layered graphics operations, handles text rendering with proper font selection and anti-aliasing, and optimizes drawing commands for graphics hardware.</p>\n<p>The critical insight of this assembly line model is that <strong>each station specializes in one transformation</strong> and passes its output to the next station in a standardized format. The HTML parser doesn&#39;t need to understand visual styling—it focuses entirely on creating a clean structural representation. The layout engine doesn&#39;t concern itself with parsing—it works with pre-processed style information. This separation of concerns allows each component to be optimized for its specific task while maintaining a clear data flow through the pipeline.</p>\n<p>However, unlike a physical assembly line, our browser engine must handle <strong>bidirectional dependencies</strong>. Sometimes the layout engine discovers that text doesn&#39;t fit in the allocated space and needs to request line breaking from the text processing system. Sometimes the rendering engine needs to trigger additional layout calculations for elements that depend on the actual rendered size of text. These feedback loops add significant complexity compared to a simple linear pipeline.</p>\n<h3 id=\"existing-browser-engine-approaches\">Existing Browser Engine Approaches</h3>\n<p>Modern browser engines have converged on remarkably similar high-level architectures, but they differ significantly in their implementation strategies, performance optimizations, and internal data structures. Understanding these approaches helps us make informed decisions about our own simplified engine while appreciating the engineering challenges that led to current designs.</p>\n<p><strong>Blink (Chrome/Chromium)</strong> represents the current state-of-the-art in browser engine architecture. Blink evolved from WebKit but has been extensively restructured to support Chrome&#39;s multi-process architecture and performance requirements. Its approach emphasizes <strong>incremental processing</strong> and <strong>parallel execution</strong> wherever possible. The Blink HTML parser operates incrementally, processing chunks of HTML as they arrive over the network rather than waiting for the complete document. This allows the browser to start building the DOM and even begin layout calculations while the page is still loading.</p>\n<p>Blink&#39;s styling system uses a <strong>rule-based cascade resolver</strong> that pre-computes style matching for common patterns, maintaining cache tables that map element types and classes to their most frequently applied styles. This optimization is crucial for large, dynamic web applications where style recalculation can become a performance bottleneck. The layout system in Blink has been redesigned around the concept of <strong>layout fragments</strong>—self-contained layout computations that can be cached and reused when content changes, avoiding the need to recalculate layout for the entire document tree.</p>\n<p><strong>WebKit (Safari)</strong> takes a more conservative approach, prioritizing <strong>correctness and standards compliance</strong> over aggressive optimization. WebKit&#39;s architecture maintains cleaner separation between components, with well-defined interfaces that make the codebase more maintainable but potentially less optimized for specific use cases. WebKit&#39;s HTML parser emphasizes <strong>robust error recovery</strong>, implementing the HTML5 parsing specification more literally than other engines. This leads to more predictable behavior with malformed HTML but can be slower for documents that require extensive error correction.</p>\n<p>The WebKit styling system uses a <strong>selector matching engine</strong> that favors memory efficiency over raw speed, making it well-suited for resource-constrained environments like mobile devices. WebKit&#39;s layout engine implements a <strong>traditional box model calculator</strong> that closely follows CSS specifications, with fewer optimizations but more predictable behavior across different content types. This approach makes WebKit an excellent reference implementation for understanding how web standards should behave.</p>\n<p><strong>Gecko (Firefox)</strong> represents a unique approach that emphasizes <strong>extensibility and modularity</strong>. Gecko&#39;s architecture was designed from the ground up to support Mozilla&#39;s vision of a customizable, open web platform. The Gecko HTML parser includes sophisticated <strong>namespace handling</strong> and <strong>XML compatibility</strong> features that other engines have simplified or removed. This makes Gecko excellent at handling complex, standards-compliant documents but adds overhead for simple HTML pages.</p>\n<p>Gecko&#39;s styling system pioneered several features that other engines later adopted, including <strong>CSS custom properties</strong> (CSS variables) and advanced <strong>selector performance optimizations</strong>. The Gecko layout engine uses a <strong>frame-based architecture</strong> where each element in the DOM can have multiple associated layout frames representing different aspects of its visual representation (content, background, borders). This approach provides flexibility for complex layouts but requires more memory and careful coordination between frames.</p>\n<blockquote>\n<p><strong>Decision: Architecture Pattern Selection</strong></p>\n<ul>\n<li><strong>Context</strong>: We need to choose an architectural approach that balances implementation complexity with educational value while remaining feasible for a learning project.</li>\n<li><strong>Options Considered</strong>: <ul>\n<li>Blink-style incremental processing with aggressive optimization</li>\n<li>WebKit-style conservative correctness-first approach</li>\n<li>Gecko-style modular extensible architecture</li>\n</ul>\n</li>\n<li><strong>Decision</strong>: WebKit-style conservative approach with simplified components</li>\n<li><strong>Rationale</strong>: The conservative approach provides the clearest learning path with predictable behavior and direct mapping to web standards. Aggressive optimizations obscure the fundamental algorithms we want to learn, while excessive modularity adds complexity without educational benefit for a beginner project.</li>\n<li><strong>Consequences</strong>: Our engine will be slower and use more memory than production browsers, but the code will be much easier to understand, debug, and extend. The direct mapping to standards makes it easier to verify correctness against reference implementations.</li>\n</ul>\n</blockquote>\n<p>The following table compares the key architectural decisions across major browser engines:</p>\n<table>\n<thead>\n<tr>\n<th>Aspect</th>\n<th>Blink (Chrome)</th>\n<th>WebKit (Safari)</th>\n<th>Gecko (Firefox)</th>\n<th>Our Approach</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Parsing Strategy</strong></td>\n<td>Incremental, network-aware</td>\n<td>Batch processing, robust error recovery</td>\n<td>Standards-compliant with XML support</td>\n<td>Simple batch processing</td>\n</tr>\n<tr>\n<td><strong>Style Resolution</strong></td>\n<td>Cached rule matching, performance-optimized</td>\n<td>Memory-efficient selector matching</td>\n<td>Extensible with custom properties</td>\n<td>Direct cascade implementation</td>\n</tr>\n<tr>\n<td><strong>Layout Algorithm</strong></td>\n<td>Fragment-based with caching</td>\n<td>Traditional box model, spec-compliant</td>\n<td>Frame-based multi-representation</td>\n<td>Simplified box model</td>\n</tr>\n<tr>\n<td><strong>Rendering Pipeline</strong></td>\n<td>Multi-threaded, GPU-accelerated</td>\n<td>Single-threaded, CPU-focused</td>\n<td>Modular with plugin support</td>\n<td>Single-threaded, simple graphics</td>\n</tr>\n<tr>\n<td><strong>Error Handling</strong></td>\n<td>Pragmatic recovery for performance</td>\n<td>Thorough spec compliance</td>\n<td>Standards-first with graceful degradation</td>\n<td>Basic recovery with clear failure modes</td>\n</tr>\n<tr>\n<td><strong>Memory Strategy</strong></td>\n<td>Aggressive optimization, complex lifecycle</td>\n<td>Conservative allocation, predictable cleanup</td>\n<td>Modular ownership, garbage collection</td>\n<td>Simple ownership, explicit cleanup</td>\n</tr>\n</tbody></table>\n<p>Each engine makes different trade-offs based on their target environments and priorities. Blink optimizes for the <strong>performance demands of modern web applications</strong>, accepting implementation complexity in exchange for speed. WebKit balances <strong>standards compliance with resource efficiency</strong>, making it ideal for mobile and embedded environments. Gecko prioritizes <strong>extensibility and correctness</strong>, supporting advanced web standards even when they&#39;re rarely used.</p>\n<p>For our educational browser engine, we&#39;ll adopt a <strong>simplified WebKit-inspired approach</strong> that emphasizes clarity and correctness over performance. This means implementing the CSS cascade and box model calculations directly from the specifications, using straightforward data structures that map clearly to the concepts we&#39;re learning, and handling errors in predictable ways that make debugging easier.</p>\n<p>The key insight from studying existing browser engines is that <strong>architecture decisions have cascading effects throughout the system</strong>. Choosing incremental parsing affects how the styling system receives DOM updates. Selecting a particular layout caching strategy influences how the rendering system must handle invalidation. Understanding these interconnections helps us make consistent architectural choices that work well together rather than optimizing individual components in isolation.</p>\n<blockquote>\n<p>The most important lesson from existing browser engines is that <strong>simplicity in individual components enables sophistication in their interactions</strong>. Rather than building complex, highly-optimized individual parsers or layout algorithms, we&#39;ll focus on clean interfaces and predictable data flow between components. This approach makes the overall system more understandable while still demonstrating the fundamental principles that drive all modern browser engines.</p>\n</blockquote>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>This implementation guidance provides the foundational setup and architectural patterns you&#39;ll use throughout all four milestones of the browser engine project.</p>\n<p><strong>A. Technology Recommendations:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>HTML/CSS Parsing</strong></td>\n<td>Hand-written recursive descent parser</td>\n<td>Parser generator (nom, pest, lalrpop)</td>\n</tr>\n<tr>\n<td><strong>String Handling</strong></td>\n<td>Rust <code>String</code> and <code>str</code> with basic tokenization</td>\n<td>Specialized string interning and rope data structures</td>\n</tr>\n<tr>\n<td><strong>DOM Storage</strong></td>\n<td><code>Vec&lt;Node&gt;</code> with index-based references</td>\n<td>Arena allocation with typed indices</td>\n</tr>\n<tr>\n<td><strong>Graphics Backend</strong></td>\n<td>Software rendering to pixel buffer</td>\n<td>Hardware-accelerated rendering (wgpu, OpenGL)</td>\n</tr>\n<tr>\n<td><strong>Text Rendering</strong></td>\n<td>Basic bitmap fonts, single font family</td>\n<td>Full font subsystem with fallbacks (rusttype, fontdue)</td>\n</tr>\n<tr>\n<td><strong>Error Handling</strong></td>\n<td>Simple <code>Result&lt;T, String&gt;</code> with descriptive messages</td>\n<td>Structured error types with error chains</td>\n</tr>\n</tbody></table>\n<p><strong>B. Recommended File Structure:</strong></p>\n<p>The modular architecture maps directly to the filesystem organization, making it easy to understand component boundaries and dependencies:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>browser-engine/\n├── src/\n│   ├── main.rs                    ← Entry point and CLI interface\n│   ├── lib.rs                     ← Public API exports\n│   │\n│   ├── html/                      ← HTML parsing (Milestone 1)\n│   │   ├── mod.rs                 ← Public interface\n│   │   ├── tokenizer.rs           ← HTML tokenization\n│   │   ├── parser.rs              ← DOM tree construction\n│   │   └── dom.rs                 ← DOM node types and tree operations\n│   │\n│   ├── css/                       ← CSS parsing and styling (Milestone 2)\n│   │   ├── mod.rs                 ← Public interface\n│   │   ├── tokenizer.rs           ← CSS tokenization\n│   │   ├── parser.rs              ← CSS rule parsing\n│   │   ├── selector.rs            ← Selector matching and specificity\n│   │   └── style.rs               ← Style resolution and cascade\n│   │\n│   ├── layout/                    ← Layout engine (Milestone 3)\n│   │   ├── mod.rs                 ← Public interface\n│   │   ├── box_model.rs           ← Box model calculations\n│   │   ├── block.rs               ← Block formatting context\n│   │   ├── inline.rs              ← Inline formatting context\n│   │   └── tree.rs                ← Layout tree construction\n│   │\n│   ├── render/                    ← Rendering engine (Milestone 4)\n│   │   ├── mod.rs                 ← Public interface\n│   │   ├── paint.rs               ← Paint command generation\n│   │   ├── canvas.rs              ← Graphics backend abstraction\n│   │   └── display_list.rs        ← Display list optimization\n│   │\n│   └── common/                    ← Shared utilities\n│       ├── mod.rs                 ← Public interface\n│       ├── geometry.rs            ← Rectangle, Point, Size types\n│       ├── color.rs               ← Color representation and parsing\n│       └── units.rs               ← CSS unit handling (px, %, em)\n│\n├── tests/                         ← Integration tests\n│   ├── parsing_tests.rs           ← End-to-end HTML/CSS parsing\n│   ├── layout_tests.rs            ← Layout calculation verification\n│   └── render_tests.rs            ← Visual output validation\n│\n└── examples/                      ← Example HTML files for testing\n    ├── simple.html                ← Basic HTML structure\n    ├── styled.html                ← HTML with CSS styling\n    └── complex.html               ← Complex layout examples</code></pre></div>\n\n<p><strong>C. Infrastructure Starter Code:</strong></p>\n<p>Here&#39;s the complete foundational infrastructure you can copy and use immediately, allowing you to focus on the core browser engine algorithms:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/common/geometry.rs - Complete geometric types</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> x</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(x</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> { x, y },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> { width, height },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> contains_point</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, point</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        point</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> point</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> point</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> point</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> intersects</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, other</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        !</span><span style=\"color:#E1E4E8\">(other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            ||</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            ||</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            ||</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// src/common/color.rs - Complete color handling</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> a</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> WHITE</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> BLACK</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> TRANSPARENT</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> rgb</span><span style=\"color:#E1E4E8\">(r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Color</span><span style=\"color:#E1E4E8\"> { r, g, b, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> rgba</span><span style=\"color:#E1E4E8\">(r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Color</span><span style=\"color:#E1E4E8\"> { r, g, b, a }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> from_hex</span><span style=\"color:#E1E4E8\">(hex</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> hex </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> hex</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">trim_start_matches</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'#'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> hex</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 6</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> Err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid hex color length: {}\"</span><span style=\"color:#E1E4E8\">, hex));</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> r </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">hex[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#F97583\">..</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid hex color: {}\"</span><span style=\"color:#E1E4E8\">, hex))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> g </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">hex[</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#F97583\">..</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid hex color: {}\"</span><span style=\"color:#E1E4E8\">, hex))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> b </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">hex[</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#F97583\">..</span><span style=\"color:#79B8FF\">6</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid hex color: {}\"</span><span style=\"color:#E1E4E8\">, hex))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">rgb</span><span style=\"color:#E1E4E8\">(r, g, b))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// src/common/units.rs - Complete CSS unit handling</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> Unit</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Px</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),           </span><span style=\"color:#6A737D\">// Absolute pixels</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Percent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),      </span><span style=\"color:#6A737D\">// Percentage of parent</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Em</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),          </span><span style=\"color:#6A737D\">// Relative to font size</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Auto</span><span style=\"color:#E1E4E8\">,             </span><span style=\"color:#6A737D\">// Automatic sizing</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Unit</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> to_px</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, parent_value</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, font_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Px</span><span style=\"color:#E1E4E8\">(value) </span><span style=\"color:#F97583\">=></span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\">value,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Percent</span><span style=\"color:#E1E4E8\">(percent) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> parent_value </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> percent </span><span style=\"color:#F97583\">/</span><span style=\"color:#79B8FF\"> 100.0</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Em</span><span style=\"color:#E1E4E8\">(ems) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> font_size </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> ems,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Auto</span><span style=\"color:#F97583\"> =></span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// Auto resolution happens in layout</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> parse</span><span style=\"color:#E1E4E8\">(input</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> input </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">trim</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> input </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"auto\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Auto</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">ends_with</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"px\"</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#E1E4E8\"> value </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> input[</span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\">input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">>()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid px value: {}\"</span><span style=\"color:#E1E4E8\">, input))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Px</span><span style=\"color:#E1E4E8\">(value))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        } </span><span style=\"color:#F97583\">else</span><span style=\"color:#F97583\"> if</span><span style=\"color:#E1E4E8\"> input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">ends_with</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'%'</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#E1E4E8\"> value </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> input[</span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\">input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">>()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid % value: {}\"</span><span style=\"color:#E1E4E8\">, input))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Percent</span><span style=\"color:#E1E4E8\">(value))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        } </span><span style=\"color:#F97583\">else</span><span style=\"color:#F97583\"> if</span><span style=\"color:#E1E4E8\"> input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">ends_with</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"em\"</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#E1E4E8\"> value </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> input[</span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\">input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">>()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid em value: {}\"</span><span style=\"color:#E1E4E8\">, input))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Em</span><span style=\"color:#E1E4E8\">(value))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // Default to pixels for bare numbers</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#E1E4E8\"> value </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">>()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid unit value: {}\"</span><span style=\"color:#E1E4E8\">, input))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Px</span><span style=\"color:#E1E4E8\">(value))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>D. Core Pipeline Skeleton:</strong></p>\n<p>This skeleton shows the main pipeline flow that connects all four milestones. You&#39;ll implement each <code>TODO</code> section as you progress through the milestones:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/lib.rs - Main browser engine pipeline</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">html</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">HTMLParser</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">css</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Stylesheet</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">StyleResolver</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">LayoutTree</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">LayoutEngine</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">render</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">DisplayList</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">RenderEngine</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">common</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    viewport_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(viewport_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, viewport_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            viewport_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0.0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">0.0</span><span style=\"color:#E1E4E8\">, viewport_width, viewport_height),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Complete rendering pipeline from HTML/CSS to visual output</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> render_page</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, html</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, css</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">u8</span><span style=\"color:#E1E4E8\">>, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO Milestone 1: Parse HTML into DOM tree</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> dom_tree </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> HTMLParser</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#E1E4E8\">(html)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO Milestone 2: Parse CSS and resolve styles for each DOM node</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> stylesheet </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> Stylesheet</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#E1E4E8\">(css)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> style_resolver </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> StyleResolver</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(stylesheet);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> styled_tree </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> style_resolver</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">resolve_styles</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">dom_tree)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO Milestone 3: Calculate layout - position and size every element</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> layout_engine </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> LayoutEngine</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">viewport_size);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> layout_tree </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> layout_engine</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">calculate_layout</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">styled_tree)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO Milestone 4: Generate paint commands and render to pixel buffer</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> render_engine </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> RenderEngine</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">viewport_size);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> display_list </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> render_engine</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">generate_display_list</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">layout_tree)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> pixel_buffer </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> render_engine</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">paint_to_buffer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">display_list)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Ok</span><span style=\"color:#E1E4E8\">(pixel_buffer)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// src/main.rs - CLI interface for testing</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> browser_engine</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">BrowserEngine</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">fs;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#B392F0\">Box</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#F97583\">dyn</span><span style=\"color:#E1E4E8\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">error</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">>> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> args</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">env</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">args</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">collect</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> args</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">() &#x3C; </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Usage: {} &#x3C;html_file> &#x3C;css_file>\"</span><span style=\"color:#E1E4E8\">, args[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">]);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> Ok</span><span style=\"color:#E1E4E8\">(());</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> html </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> fs</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">read_to_string</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">args[</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">])</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> css </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> fs</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">read_to_string</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">args[</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">])</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> engine </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">800.0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">600.0</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> pixel_buffer </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> engine</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">render_page</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">html, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">css)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO: Save pixel_buffer as PNG or display in window</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Rendered page to {} bytes\"</span><span style=\"color:#E1E4E8\">, pixel_buffer</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">());</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Ok</span><span style=\"color:#E1E4E8\">(())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>E. Language-Specific Hints for Rust:</strong></p>\n<ul>\n<li><strong>Error Handling</strong>: Use <code>Result&lt;T, String&gt;</code> for simplicity initially, then create custom error types as your engine grows more sophisticated.</li>\n<li><strong>String Processing</strong>: Rust&#39;s <code>&amp;str</code> and <code>String</code> are excellent for parsing. Use <code>chars().peekable()</code> for lookahead during tokenization.</li>\n<li><strong>Memory Management</strong>: Start with <code>Vec&lt;T&gt;</code> and <code>Box&lt;T&gt;</code> for tree structures. Arena allocation (<code>typed-arena</code> crate) can optimize later.</li>\n<li><strong>Collections</strong>: <code>HashMap&lt;String, Value&gt;</code> works well for CSS properties and DOM attributes. Use <code>BTreeMap</code> if you need ordered iteration.</li>\n<li><strong>Parsing Libraries</strong>: For hand-written parsers, <code>std::str::Chars</code> with <code>peek()</code> handles most cases. The <code>nom</code> crate provides combinator-style parsing if you prefer.</li>\n<li><strong>Graphics</strong>: Start with a simple <code>Vec&lt;u8&gt;</code> pixel buffer (4 bytes per pixel: RGBA). Later, consider <code>image</code> crate for file I/O and <code>raqote</code> for 2D graphics.</li>\n</ul>\n<p><strong>F. Milestone Checkpoints:</strong></p>\n<p>After each milestone, you should be able to run these verification commands:</p>\n<p><strong>Milestone 1 Checkpoint:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> html_parser_tests</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> '&#x3C;div>Hello &#x3C;span>World&#x3C;/span>&#x3C;/div>'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> cargo</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#79B8FF\"> --bin</span><span style=\"color:#9ECBFF\"> parse_html</span></span></code></pre></div>\n<p>Expected: DOM tree printed showing div containing text &quot;Hello &quot; and span containing text &quot;World&quot;.</p>\n<p><strong>Milestone 2 Checkpoint:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> css_parser_tests</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#79B8FF\"> --bin</span><span style=\"color:#9ECBFF\"> browser</span><span style=\"color:#9ECBFF\"> examples/simple.html</span><span style=\"color:#9ECBFF\"> examples/simple.css</span></span></code></pre></div>\n<p>Expected: Styled tree showing computed styles (color, font-size, etc.) for each DOM element.</p>\n<p><strong>Milestone 3 Checkpoint:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> layout_tests</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#79B8FF\"> --bin</span><span style=\"color:#9ECBFF\"> browser</span><span style=\"color:#9ECBFF\"> examples/layout.html</span><span style=\"color:#9ECBFF\"> examples/layout.css</span></span></code></pre></div>\n<p>Expected: Layout tree with computed positions and dimensions for all elements in viewport coordinates.</p>\n<p><strong>Milestone 4 Checkpoint:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> render_tests</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#79B8FF\"> --bin</span><span style=\"color:#9ECBFF\"> browser</span><span style=\"color:#9ECBFF\"> examples/complete.html</span><span style=\"color:#9ECBFF\"> examples/complete.css</span></span></code></pre></div>\n<p>Expected: PNG image file generated showing rendered webpage with correct colors, text, and positioning.</p>\n<p><strong>G. Debugging Tips:</strong></p>\n<table>\n<thead>\n<tr>\n<th><strong>Symptom</strong></th>\n<th><strong>Likely Cause</strong></th>\n<th><strong>How to Diagnose</strong></th>\n<th><strong>Fix</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Parser panics on valid HTML</td>\n<td>Tokenizer state machine bug</td>\n<td>Add debug prints to tokenizer state transitions</td>\n<td>Check state machine logic against HTML5 spec</td>\n</tr>\n<tr>\n<td>DOM tree has wrong structure</td>\n<td>Tree construction algorithm error</td>\n<td>Print DOM tree after parsing, compare to expected structure</td>\n<td>Verify parent-child relationship logic</td>\n</tr>\n<tr>\n<td>CSS rules don&#39;t match elements</td>\n<td>Selector matching bug</td>\n<td>Print all selectors and which elements they match</td>\n<td>Check selector syntax parsing and element matching</td>\n</tr>\n<tr>\n<td>Elements appear in wrong positions</td>\n<td>Box model calculation error</td>\n<td>Print computed dimensions for each element</td>\n<td>Verify margin/border/padding calculations</td>\n</tr>\n<tr>\n<td>Text doesn&#39;t render</td>\n<td>Font or text rendering issue</td>\n<td>Check if text paint commands are generated correctly</td>\n<td>Verify font loading and text measurement</td>\n</tr>\n<tr>\n<td>Performance is very slow</td>\n<td>Inefficient algorithms or data structures</td>\n<td>Profile with <code>cargo flamegraph</code></td>\n<td>Optimize hot paths, consider better data structures</td>\n</tr>\n</tbody></table>\n<p>The key to successful debugging is <strong>building verification into each milestone</strong>. Don&#39;t wait until the end to test—verify each component works correctly before moving to the next one. This modular approach makes it much easier to isolate and fix problems as they arise.</p>\n<h2 id=\"goals-and-non-goals\">Goals and Non-Goals</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> All milestones (1-4) - This section establishes the foundational scope that guides implementation decisions throughout the entire project.</p>\n</blockquote>\n<p>Building a complete web browser engine is an extraordinarily complex undertaking that involves hundreds of specifications, millions of lines of code, and decades of accumulated engineering knowledge. Modern browsers like Chrome and Firefox represent some of the most sophisticated software systems ever created, handling everything from JavaScript execution and WebGL graphics to complex security models and performance optimizations. To make this project achievable for learning purposes, we must carefully define what our browser engine will and will not attempt to implement.</p>\n<p>Think of our approach like building a scale model of a skyscraper rather than the full structure. A scale model captures the essential architectural principles, demonstrates the core engineering concepts, and provides a complete end-to-end experience, but it deliberately omits the complex mechanical systems, detailed interior design, and industrial-grade materials that would be required for a production building. Similarly, our browser engine will implement the fundamental rendering pipeline that transforms HTML and CSS into visual output, but it will exclude the advanced features that would require years of development effort.</p>\n<p>The key insight behind this scoping decision is that the core learning value comes from understanding how browsers parse textual markup, apply styling rules, compute geometric layout, and generate visual output. These fundamental concepts remain the same whether you&#39;re rendering a simple webpage with basic styling or a complex web application with animations and interactive features. By focusing on the essential rendering pipeline, we can build a complete, working browser engine that demonstrates all the major architectural patterns while keeping the implementation manageable.</p>\n<h3 id=\"core-goals\">Core Goals</h3>\n<p>Our browser engine must implement the complete rendering pipeline from raw HTML and CSS text to visual output displayed on screen. This pipeline represents the fundamental operation that every web browser performs millions of times per day, and understanding each stage provides deep insight into how modern web technologies work under the hood.</p>\n<p>The following table outlines the essential features our browser engine must implement to successfully render basic web pages:</p>\n<table>\n<thead>\n<tr>\n<th>Feature Category</th>\n<th>Specific Requirements</th>\n<th>Learning Value</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>HTML Document Parsing</td>\n<td>Parse HTML text into a structured DOM tree with proper parent-child relationships</td>\n<td>Understanding tokenization algorithms and tree construction patterns</td>\n</tr>\n<tr>\n<td>CSS Stylesheet Processing</td>\n<td>Parse CSS rules, calculate selector specificity, and apply the cascade to determine computed styles</td>\n<td>Learning rule-based systems and priority resolution algorithms</td>\n</tr>\n<tr>\n<td>Geometric Layout Calculation</td>\n<td>Implement the CSS box model to compute element positions and dimensions</td>\n<td>Understanding constraint-solving and 2D layout algorithms</td>\n</tr>\n<tr>\n<td>Visual Rendering Output</td>\n<td>Generate paint commands and draw backgrounds, borders, and text to a canvas</td>\n<td>Learning graphics programming and display pipeline concepts</td>\n</tr>\n</tbody></table>\n<p><strong>HTML Document Structure Processing</strong> forms the foundation of our rendering pipeline. Our browser engine must implement a tokenizer that can parse HTML text and identify start tags, end tags, attributes, self-closing elements, and text content. The tokenizer feeds into a tree construction algorithm that builds a hierarchical DOM tree representing the document structure. This DOM tree serves as the input for all subsequent processing stages.</p>\n<p>The tokenization process must handle the complexities of HTML syntax, including attribute parsing with both quoted and unquoted values, self-closing tags like <code>&lt;br&gt;</code> and <code>&lt;img&gt;</code>, and proper nesting validation. The tree construction algorithm uses a stack-based approach to maintain the current element context and build correct parent-child relationships even when encountering malformed markup.</p>\n<p><strong>CSS Styling and Cascade Resolution</strong> represents the second major component of our browser engine. The CSS parser must tokenize stylesheet text and extract selectors, property names, and property values. Our implementation must support the fundamental selector types: tag selectors (<code>div</code>), class selectors (<code>.header</code>), ID selectors (<code>#main</code>), and basic combinators for descendant relationships.</p>\n<p>The cascade resolution algorithm implements the CSS specificity calculation that determines which styles apply when multiple rules target the same element. Our engine computes specificity as a four-tuple (inline styles, ID count, class count, tag count) and resolves conflicts by applying the most specific rule. This process produces computed styles for every element in the DOM tree.</p>\n<p><strong>Box Model Layout Computation</strong> transforms the styled DOM tree into a layout tree containing the geometric information needed for visual rendering. Our layout engine must implement the CSS box model, computing content dimensions, padding, borders, and margins for each element. The layout algorithm handles both block formatting context (vertical stacking of block elements) and inline formatting context (horizontal flow of text and inline elements).</p>\n<p>The layout computation must resolve auto values, handle percentage-based dimensions, and implement margin collapsing between adjacent block elements. The output is a layout tree where each node contains a <code>Rectangle</code> specifying its position and dimensions in viewport coordinates.</p>\n<p><strong>Visual Paint Generation and Rendering</strong> completes the rendering pipeline by traversing the layout tree and generating an ordered sequence of paint commands. Our rendering engine must handle background color painting, border drawing with proper line widths and colors, and text rendering with correct font sizing and positioning.</p>\n<p>The paint generation algorithm ensures correct z-ordering by processing elements in document order and handling overlapping elements appropriately. The final output is either a raster image buffer or direct drawing to a graphics canvas that can be displayed in a window or saved to a file.</p>\n<blockquote>\n<p><strong>Design Principle</strong>: Our browser engine prioritizes correctness and clarity over performance optimization. Every component should implement the specification accurately, even if the result is slower than production browsers. The goal is learning the algorithms, not competing with Chrome&#39;s rendering speed.</p>\n</blockquote>\n<h3 id=\"explicit-non-goals\">Explicit Non-Goals</h3>\n<p>To keep our browser engine implementation achievable within a reasonable timeframe, we deliberately exclude numerous advanced features that would significantly increase complexity without proportional learning value. These exclusions are not limitations of our approach but rather conscious decisions to focus on the core rendering pipeline concepts.</p>\n<p>The following table documents the major browser features we explicitly choose not to implement:</p>\n<table>\n<thead>\n<tr>\n<th>Excluded Feature Category</th>\n<th>Specific Exclusions</th>\n<th>Complexity Reason</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>JavaScript Execution</td>\n<td>Script parsing, V8 integration, DOM manipulation APIs</td>\n<td>Requires a complete language runtime with garbage collection, JIT compilation, and security sandboxing</td>\n</tr>\n<tr>\n<td>Advanced CSS Properties</td>\n<td>Flexbox, CSS Grid, transforms, animations, media queries</td>\n<td>Each represents a complete layout system requiring thousands of lines of specification-compliant code</td>\n</tr>\n<tr>\n<td>Network and Resource Loading</td>\n<td>HTTP requests, image loading, font loading, caching</td>\n<td>Requires asynchronous I/O, protocol implementations, and resource management systems</td>\n</tr>\n<tr>\n<td>User Interaction and Events</td>\n<td>Mouse handling, keyboard input, form processing, scrolling</td>\n<td>Requires event system architecture and stateful interaction management</td>\n</tr>\n<tr>\n<td>Browser Chrome and UI</td>\n<td>Address bar, bookmarks, tabs, developer tools, preferences</td>\n<td>Represents a complete application framework separate from the rendering engine</td>\n</tr>\n</tbody></table>\n<p><strong>JavaScript Engine Integration</strong> represents perhaps the largest excluded feature category. Modern browsers include complete JavaScript runtimes with virtual machines, just-in-time compilers, garbage collectors, and extensive APIs for DOM manipulation. Integrating JavaScript execution would require implementing or embedding a language runtime, creating bindings between JavaScript objects and DOM elements, and handling the complex security model that prevents malicious scripts from accessing sensitive system resources.</p>\n<p>The JavaScript exclusion also eliminates the need for dynamic DOM modification, event handling, and asynchronous script loading. While these features are essential for modern web applications, they operate on top of the fundamental rendering pipeline we&#39;re building. A solid understanding of HTML parsing, CSS styling, and layout computation provides the foundation needed to later add JavaScript integration.</p>\n<p><strong>Advanced CSS Layout Systems</strong> like Flexbox and CSS Grid represent complete layout algorithms that rival our entire project in complexity. Flexbox alone involves multiple layout passes, complex constraint solving for flexible dimensions, and intricate algorithms for distributing space among flex items. CSS Grid adds two-dimensional layout capabilities with explicit grid tracks, implicit grid creation, and sophisticated alignment properties.</p>\n<p>Similarly, CSS transforms and animations require matrix mathematics, interpolation algorithms, and integration with the browser&#39;s compositor for smooth visual effects. Media queries introduce responsive design capabilities but require a conditional styling system that evaluates viewport dimensions and device capabilities.</p>\n<blockquote>\n<p><strong>Decision: Focus on Block and Inline Layout Only</strong></p>\n<ul>\n<li><strong>Context</strong>: CSS defines numerous layout modes including block, inline, flexbox, grid, table, and positioning schemes</li>\n<li><strong>Options Considered</strong>: <ol>\n<li>Implement all major layout modes for complete CSS compatibility</li>\n<li>Focus only on block and inline layout as foundational systems</li>\n<li>Implement flexbox as the most commonly used modern layout system</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Implement only block and inline formatting contexts</li>\n<li><strong>Rationale</strong>: Block and inline layout represent the fundamental CSS layout concepts that underpin all other systems. Understanding how block elements stack vertically and how inline elements flow horizontally provides the foundation for comprehending more advanced layout modes. These two systems also cover the majority of basic web page layouts.</li>\n<li><strong>Consequences</strong>: Our browser can render most simple web pages but cannot handle modern responsive designs or complex application layouts. However, the layout engine architecture we build can be extended to support additional formatting contexts.</li>\n</ul>\n</blockquote>\n<p><strong>Network Resource Loading</strong> encompasses HTTP protocol implementation, DNS resolution, TLS/SSL encryption, caching strategies, and asynchronous resource management. Modern browsers maintain connection pools, implement HTTP/2 multiplexing, handle cookies and authentication, and provide sophisticated caching layers that store resources across browsing sessions.</p>\n<p>Image and font loading add additional complexity with format-specific decoders (JPEG, PNG, SVG for images; TrueType, OpenType, WOFF for fonts), color space management, and memory management for large media files. Our browser engine sidesteps these challenges by accepting HTML and CSS as strings and using system fonts for text rendering.</p>\n<p><strong>User Interaction and Event Systems</strong> require stateful management of input devices, hit testing algorithms to determine which elements receive events, and complex event propagation models that bubble events up the DOM tree. Form processing adds validation, submission handling, and input element state management.</p>\n<p>Scrolling functionality requires viewport management, overflow handling, and smooth animation systems that update layout and rendering at 60 frames per second. These interaction features, while essential for usable browsers, operate on top of the static rendering pipeline we&#39;re implementing.</p>\n<p><strong>Browser Application Framework</strong> features like tabbed browsing, bookmarks, history management, and preferences represent a complete desktop or mobile application built around the rendering engine core. Developer tools require debugging APIs, performance profilers, and interactive inspection capabilities that expose the internal state of our rendering pipeline.</p>\n<p>Security features like same-origin policy enforcement, content security policy evaluation, and sandboxed iframe execution require deep integration between the JavaScript engine, network layer, and rendering system. These cross-cutting concerns significantly complicate every component of the browser architecture.</p>\n<blockquote>\n<p><strong>Key Insight</strong>: The features we exclude are not simpler versions of what we&#39;re building—they&#39;re entirely different problem domains. JavaScript execution is a language implementation challenge. Network loading is a distributed systems challenge. User interaction is a human-computer interface challenge. By focusing solely on the rendering pipeline, we can master one problem domain thoroughly rather than implementing multiple systems superficially.</p>\n</blockquote>\n<p>The boundaries we&#39;ve established create a clean separation between our browser engine and the surrounding application environment. Our engine accepts HTML and CSS strings as input and produces visual output as a raster image or display commands. This interface design means that our rendering engine could theoretically be embedded in different applications or extended with the excluded features in future iterations.</p>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>The scope definition directly influences our technical architecture decisions and development approach. Understanding what we&#39;re building and what we&#39;re excluding helps determine the appropriate abstractions and interfaces for each component.</p>\n<p><strong>A. Technology Recommendations Table:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Graphics Backend</td>\n<td>Software rasterization to image buffer</td>\n<td>Hardware-accelerated canvas (HTML5 Canvas, Skia, Cairo)</td>\n</tr>\n<tr>\n<td>Text Rendering</td>\n<td>System font with basic metrics</td>\n<td>Full font shaping library (HarfBuzz, DirectWrite)</td>\n</tr>\n<tr>\n<td>Testing Framework</td>\n<td>Unit tests with string comparisons</td>\n<td>Visual regression testing with reference images</td>\n</tr>\n<tr>\n<td>Build System</td>\n<td>Single-file compilation</td>\n<td>Multi-crate/module project with dependency management</td>\n</tr>\n</tbody></table>\n<p><strong>B. Recommended File/Module Structure:</strong></p>\n<p>The scope boundaries map directly to our module organization. Each core goal becomes a primary module, while excluded features don&#39;t appear in our codebase structure:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>browser-engine/\n  src/\n    main.rs                    ← CLI entry point and BrowserEngine coordination\n    types.rs                   ← Core types: Point, Size, Rectangle, Color, Unit\n    html/\n      mod.rs                   ← HTMLParser public interface\n      tokenizer.rs             ← HTML tokenization (Milestone 1)\n      tree_builder.rs          ← DOM tree construction (Milestone 1)\n    css/\n      mod.rs                   ← CSS parser public interface  \n      tokenizer.rs             ← CSS tokenization (Milestone 2)\n      parser.rs                ← Rule and selector parsing (Milestone 2)\n      cascade.rs               ← Specificity and cascade resolution (Milestone 2)\n    layout/\n      mod.rs                   ← LayoutEngine public interface\n      box_model.rs             ← Box model calculations (Milestone 3)\n      block.rs                 ← Block formatting context (Milestone 3)\n      inline.rs                ← Inline formatting context (Milestone 3)\n    render/\n      mod.rs                   ← RenderEngine public interface\n      paint.rs                 ← Paint command generation (Milestone 4)\n      canvas.rs                ← Graphics backend abstraction (Milestone 4)\n  tests/\n    integration/\n      milestone_1_tests.rs     ← HTML parsing validation\n      milestone_2_tests.rs     ← CSS parsing and cascade validation  \n      milestone_3_tests.rs     ← Layout computation validation\n      milestone_4_tests.rs     ← End-to-end rendering validation\n    fixtures/\n      simple.html              ← Test HTML documents\n      styles.css               ← Test CSS stylesheets\n      expected_outputs/        ← Reference images for visual testing</code></pre></div>\n\n<p><strong>C. Infrastructure Starter Code:</strong></p>\n<p>The following core types support our scoped feature set and can be used throughout the implementation:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">//! Core geometric and color types for the browser engine</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">fmt;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Represents a 2D point in viewport coordinates</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> x</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(x</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Point</span><span style=\"color:#E1E4E8\"> { x, y }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> origin</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Point</span><span style=\"color:#E1E4E8\"> { x</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Represents 2D dimensions </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Size</span><span style=\"color:#E1E4E8\"> { width, height }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> zero</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Size</span><span style=\"color:#E1E4E8\"> { width</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Represents a rectangular area with position and dimensions</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(x</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(x, y),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(width, height),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> contains_point</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, point</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        point</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> point</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> point</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> point</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> intersects</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, other</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        !</span><span style=\"color:#E1E4E8\">(other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            ||</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            ||</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            ||</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Represents an RGBA color value</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> a</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> rgb</span><span style=\"color:#E1E4E8\">(r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Color</span><span style=\"color:#E1E4E8\"> { r, g, b, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> rgba</span><span style=\"color:#E1E4E8\">(r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Color</span><span style=\"color:#E1E4E8\"> { r, g, b, a }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> from_hex</span><span style=\"color:#E1E4E8\">(hex</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> hex </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> hex</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">trim_start_matches</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'#'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> hex</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 6</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> Err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid hex color length: {}\"</span><span style=\"color:#E1E4E8\">, hex));</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> r </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">hex[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#F97583\">..</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid hex color: {}\"</span><span style=\"color:#E1E4E8\">, hex))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> g </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">hex[</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#F97583\">..</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid hex color: {}\"</span><span style=\"color:#E1E4E8\">, hex))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> b </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">hex[</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#F97583\">..</span><span style=\"color:#79B8FF\">6</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid hex color: {}\"</span><span style=\"color:#E1E4E8\">, hex))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">rgb</span><span style=\"color:#E1E4E8\">(r, g, b))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Common color constants</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> WHITE</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> BLACK</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> TRANSPARENT</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// CSS unit types for dimensions and positioning</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> Unit</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Px</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Percent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Em</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Auto</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Unit</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> parse</span><span style=\"color:#E1E4E8\">(input</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> input </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">trim</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> input </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"auto\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Auto</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">ends_with</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"px\"</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#E1E4E8\"> value_str </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">input[</span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\">input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\"> 2</span><span style=\"color:#E1E4E8\">];</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#E1E4E8\"> value </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> value_str</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">>()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid px value: {}\"</span><span style=\"color:#E1E4E8\">, input))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Px</span><span style=\"color:#E1E4E8\">(value));</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">ends_with</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'%'</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#E1E4E8\"> value_str </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">input[</span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\">input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\">];</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#E1E4E8\"> value </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> value_str</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">>()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid percent value: {}\"</span><span style=\"color:#E1E4E8\">, input))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Percent</span><span style=\"color:#E1E4E8\">(value));</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">ends_with</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"em\"</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#E1E4E8\"> value_str </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">input[</span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\">input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\"> 2</span><span style=\"color:#E1E4E8\">];</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#E1E4E8\"> value </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> value_str</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">>()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid em value: {}\"</span><span style=\"color:#E1E4E8\">, input))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Em</span><span style=\"color:#E1E4E8\">(value));</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Unknown unit: {}\"</span><span style=\"color:#E1E4E8\">, input))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> to_px</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, parent_value</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, font_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Px</span><span style=\"color:#E1E4E8\">(value) </span><span style=\"color:#F97583\">=></span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\">value,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Percent</span><span style=\"color:#E1E4E8\">(percent) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> parent_value </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> (percent </span><span style=\"color:#F97583\">/</span><span style=\"color:#79B8FF\"> 100.0</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Em</span><span style=\"color:#E1E4E8\">(em_value) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> font_size </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> em_value,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Auto</span><span style=\"color:#F97583\"> =></span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// Auto resolution happens in layout algorithms</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>D. Core Engine Structure:</strong></p>\n<p>The main <code>BrowserEngine</code> coordinates between all components and provides the public interface:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">//! Main browser engine coordinating the rendering pipeline</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">types</span><span style=\"color:#F97583\">::*</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">html</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">HTMLParser</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">css</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">StyleResolver</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">LayoutEngine</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">render</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">RenderEngine</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> viewport_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(viewport_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, viewport_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            viewport_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0.0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">0.0</span><span style=\"color:#E1E4E8\">, viewport_width, viewport_height),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO: Implement the complete rendering pipeline</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // This method should coordinate all four milestones:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 1. Parse HTML string into DOM tree using HTMLParser</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 2. Parse CSS string and resolve styles using StyleResolver  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 3. Compute layout using LayoutEngine with viewport_size</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 4. Generate paint commands and render using RenderEngine</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns either a rendered image buffer or an error message</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> render_page</span><span style=\"color:#E1E4E8\">(html</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, css</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">u8</span><span style=\"color:#E1E4E8\">>, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement complete rendering pipeline\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>E. Language-Specific Implementation Hints:</strong></p>\n<ul>\n<li><p><strong>Error Handling</strong>: Use <code>Result&lt;T, String&gt;</code> consistently for all parsing and rendering operations. Collect multiple errors where possible rather than failing on the first error.</p>\n</li>\n<li><p><strong>Memory Management</strong>: Rust&#39;s ownership system naturally handles memory management for our tree structures. Use <code>Rc&lt;RefCell&lt;T&gt;&gt;</code> only if you need shared mutable references in the DOM tree.</p>\n</li>\n<li><p><strong>String Processing</strong>: Use <code>&amp;str</code> slices for parsing to avoid unnecessary allocations. The <code>nom</code> parser combinator crate can simplify tokenization if you prefer a functional approach to manual character iteration.</p>\n</li>\n<li><p><strong>Graphics Output</strong>: For simple implementations, render to a <code>Vec&lt;u8&gt;</code> representing RGB pixel data. The <code>image</code> crate can save this buffer to PNG files for testing.</p>\n</li>\n</ul>\n<p><strong>F. Milestone Checkpoints:</strong></p>\n<p>After implementing each milestone, verify the following behaviors:</p>\n<table>\n<thead>\n<tr>\n<th>Milestone</th>\n<th>Test Command</th>\n<th>Expected Behavior</th>\n<th>Success Indicators</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1: HTML Parser</td>\n<td><code>cargo test html_parsing</code></td>\n<td>Parse <code>&lt;div&gt;&lt;p&gt;Hello&lt;/p&gt;&lt;/div&gt;</code> into correct DOM tree</td>\n<td>Tree has div parent with p child containing text node</td>\n</tr>\n<tr>\n<td>2: CSS Parser</td>\n<td><code>cargo test css_cascade</code></td>\n<td>Apply <code>div { color: red; } p { color: blue; }</code> to above DOM</td>\n<td>P element gets blue color, div gets red color</td>\n</tr>\n<tr>\n<td>3: Layout</td>\n<td><code>cargo test box_model</code></td>\n<td>Compute positions for block elements with margin/padding</td>\n<td>Each element has correct Rectangle with computed dimensions</td>\n</tr>\n<tr>\n<td>4: Rendering</td>\n<td><code>cargo test end_to_end</code></td>\n<td>Render simple HTML/CSS to image buffer</td>\n<td>Non-empty pixel buffer with expected colors at computed positions</td>\n</tr>\n</tbody></table>\n<p><strong>G. Common Scope Creep Warnings:</strong></p>\n<p>⚠️ <strong>Scope Creep: Adding &quot;Just One More&quot; CSS Property</strong>\nAdding properties like <code>position: absolute</code> or <code>display: flex</code> seems simple but each fundamentally changes layout algorithms. Stick to basic properties: <code>margin</code>, <code>padding</code>, <code>border</code>, <code>width</code>, <code>height</code>, <code>color</code>, <code>background-color</code>, <code>font-size</code>.</p>\n<p>⚠️ <strong>Scope Creep: &quot;Real&quot; HTML Compatibility</strong><br>Resist the urge to handle <code>&lt;script&gt;</code> tags, <code>&lt;style&gt;</code> tags, or complex HTML5 elements. Focus on <code>&lt;div&gt;</code>, <code>&lt;p&gt;</code>, <code>&lt;span&gt;</code>, <code>&lt;h1&gt;</code>-<code>&lt;h6&gt;</code>, and basic text content.</p>\n<p>⚠️ <strong>Scope Creep: Performance Optimization</strong>\nAvoid premature optimization like layout caching, dirty bit tracking, or GPU acceleration. Prioritize correctness and code clarity. A working but slow browser engine is infinitely more valuable for learning than a fast but broken one.</p>\n<p>The scope boundaries we&#39;ve established provide clear guidance for every implementation decision throughout the project. When facing complex specification details or edge cases, always choose the simpler approach that maintains our focus on the core rendering pipeline concepts.</p>\n<h2 id=\"high-level-architecture\">High-Level Architecture</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> All milestones (1-4) - This section establishes the architectural foundation that guides the implementation of HTML parsing, CSS parsing, layout computation, and rendering.</p>\n</blockquote>\n<p>Building a browser engine is like constructing a sophisticated assembly line for document production. Imagine a printing press that takes raw manuscript text and transforms it through multiple specialized stations: first, typesetters organize the text into structured pages; then, designers apply styling rules to determine fonts and colors; next, layout artists position every element on the page; and finally, printers render the finished product to paper. Our browser engine follows this same assembly line approach, with each stage performing a specific transformation on the document data until we achieve the final visual output.</p>\n<p><img src=\"/api/project/build-browser/architecture-doc/asset?path=diagrams%2Fcomponent-architecture.svg\" alt=\"System Component Diagram\"></p>\n<p>The browser rendering pipeline represents one of the most complex data transformation systems in modern software engineering. Unlike typical applications that process discrete requests, a browser engine must parse two different languages simultaneously (HTML and CSS), resolve their interactions through sophisticated rule systems, perform complex geometric calculations, and generate precise visual output—all while maintaining performance and handling malformed input gracefully. This complexity arises because web standards evolved organically over decades, accumulating layers of backward compatibility and edge cases that production browsers must handle flawlessly.</p>\n<h3 id=\"the-rendering-pipeline\">The Rendering Pipeline</h3>\n<p>The <strong>rendering pipeline</strong> forms the backbone of our browser engine, transforming textual markup into visual pixels through four distinct stages. Each stage consumes the output of the previous stage and produces a more refined representation of the document, moving progressively from abstract syntax to concrete visual commands. This sequential processing model ensures clear separation of concerns while enabling optimizations at each transformation boundary.</p>\n<p>Think of this pipeline as a document assembly line where each workstation has a specific responsibility. The HTML parsing station converts raw text into a structured document tree. The CSS processing station decorates this tree with styling information. The layout station calculates precise measurements and positions. Finally, the rendering station produces the visual commands needed to paint the document. Just as a real assembly line can optimize individual stations without disrupting the entire process, our pipeline allows each component to evolve independently while maintaining clear interfaces.</p>\n<table>\n<thead>\n<tr>\n<th>Pipeline Stage</th>\n<th>Input Format</th>\n<th>Output Format</th>\n<th>Primary Responsibility</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>HTML Parsing</td>\n<td>Raw HTML text string</td>\n<td>DOM tree structure</td>\n<td>Convert markup into hierarchical document representation</td>\n</tr>\n<tr>\n<td>CSS Processing</td>\n<td>CSS stylesheet text + DOM tree</td>\n<td>Styled DOM tree</td>\n<td>Apply styling rules and compute final element styles</td>\n</tr>\n<tr>\n<td>Layout Computation</td>\n<td>Styled DOM tree + viewport size</td>\n<td>Layout tree with geometry</td>\n<td>Calculate element positions and dimensions</td>\n</tr>\n<tr>\n<td>Rendering</td>\n<td>Layout tree + graphics context</td>\n<td>Display list of paint commands</td>\n<td>Generate visual commands for drawing</td>\n</tr>\n</tbody></table>\n<p>The pipeline operates as a <strong>pull-based system</strong> where each stage requests data from the previous stage as needed. This design choice enables lazy evaluation and provides natural points for caching intermediate results. For example, if only CSS changes while HTML remains constant, we can reuse the DOM tree and start processing from the style resolution stage. Similarly, viewport size changes require only layout and rendering stages to execute.</p>\n<blockquote>\n<p><strong>Key Design Insight</strong>: The pipeline stages are deliberately <strong>stateless transformations</strong>. Each stage takes input data, performs computations, and produces output without maintaining persistent state between invocations. This functional approach simplifies testing, debugging, and enables powerful optimization opportunities like result caching and parallel processing.</p>\n</blockquote>\n<p>The data flow through the pipeline follows strict type safety boundaries. Each stage defines precise input and output contracts, preventing invalid data from propagating through the system. The <code>DOMNode</code> structures produced by HTML parsing contain only structural information. The style resolver augments this with <code>ComputedStyle</code> data. The layout engine adds geometric <code>LayoutBox</code> information. Finally, the renderer produces <code>PaintCommand</code> sequences that graphics backends can execute directly.</p>\n<p>Error handling occurs at stage boundaries through explicit <code>Result</code> types that capture parsing failures, style resolution errors, layout constraints violations, and rendering failures. This allows downstream stages to implement appropriate fallback behaviors rather than crashing on malformed input. For instance, invalid CSS properties are ignored rather than causing parse failures, while malformed HTML triggers error recovery algorithms that attempt to construct meaningful DOM trees.</p>\n<h3 id=\"component-responsibilities\">Component Responsibilities</h3>\n<p>The browser engine architecture divides responsibilities among four major components, each with clearly defined ownership boundaries and interface contracts. This modular design enables independent development and testing while ensuring proper separation of concerns across the complex rendering process.</p>\n<h4 id=\"html-parser-component\">HTML Parser Component</h4>\n<p>The <code>HTMLParser</code> serves as the entry point for document processing, responsible for converting raw HTML text into structured <code>DOMNode</code> trees that represent the document&#39;s hierarchical organization. This component implements a <strong>tokenization-then-parsing</strong> architecture that first breaks HTML text into meaningful tokens (start tags, end tags, attributes, text content), then constructs the DOM tree using a stack-based algorithm that mirrors HTML&#39;s nested structure.</p>\n<table>\n<thead>\n<tr>\n<th>Method Name</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>parse_html</code></td>\n<td><code>input: &amp;str</code></td>\n<td><code>Result&lt;DOMNode, ParseError&gt;</code></td>\n<td>Main entry point that converts HTML string to DOM tree</td>\n</tr>\n<tr>\n<td><code>tokenize</code></td>\n<td><code>input: &amp;str</code></td>\n<td><code>Result&lt;Vec&lt;Token&gt;, TokenError&gt;</code></td>\n<td>Breaks HTML into structured tokens for parsing</td>\n</tr>\n<tr>\n<td><code>build_tree</code></td>\n<td><code>tokens: Vec&lt;Token&gt;</code></td>\n<td><code>Result&lt;DOMNode, TreeError&gt;</code></td>\n<td>Constructs DOM hierarchy from token sequence</td>\n</tr>\n<tr>\n<td><code>recover_from_error</code></td>\n<td><code>error: ParseError, context: &amp;str</code></td>\n<td><code>DOMNode</code></td>\n<td>Implements error recovery for malformed markup</td>\n</tr>\n</tbody></table>\n<p>The parser maintains <strong>no persistent state</strong> between invocations, making it safe for concurrent use and simplifying testing. However, during a single parse operation, it maintains a <strong>tag stack</strong> that tracks open elements to ensure proper nesting relationships. This stack-based approach naturally handles deeply nested HTML structures while providing clear error recovery points when malformed markup is encountered.</p>\n<blockquote>\n<p><strong>Critical Design Decision</strong>: The parser implements <strong>forgiving error recovery</strong> rather than strict validation. When encountering malformed HTML like unclosed tags or improper nesting, it attempts to construct the most reasonable DOM tree rather than failing. This mirrors production browser behavior where web pages often contain markup errors that must be handled gracefully.</p>\n</blockquote>\n<h4 id=\"style-resolver-component\">Style Resolver Component</h4>\n<p>The <code>StyleResolver</code> component bridges the gap between document structure and visual presentation by applying CSS rules to DOM elements and computing the final styles that will control layout and rendering. This component implements the complex <strong>CSS cascade algorithm</strong> that determines which style rules apply to each element based on specificity, source order, and inheritance relationships.</p>\n<table>\n<thead>\n<tr>\n<th>Method Name</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>resolve_styles</code></td>\n<td><code>dom: &amp;DOMNode, css: &amp;Stylesheet</code></td>\n<td><code>Result&lt;StyledNode, StyleError&gt;</code></td>\n<td>Computes final styles for all DOM elements</td>\n</tr>\n<tr>\n<td><code>match_selectors</code></td>\n<td><code>element: &amp;Element, rules: &amp;[CSSRule]</code></td>\n<td><code>Vec&lt;&amp;CSSRule&gt;</code></td>\n<td>Finds all CSS rules that apply to given element</td>\n</tr>\n<tr>\n<td><code>calculate_specificity</code></td>\n<td><code>selector: &amp;Selector</code></td>\n<td><code>Specificity</code></td>\n<td>Computes CSS specificity for cascade ordering</td>\n</tr>\n<tr>\n<td><code>compute_inherited_values</code></td>\n<td><code>parent: &amp;StyledNode, element: &amp;Element</code></td>\n<td><code>PropertyMap</code></td>\n<td>Resolves inherited property values from parent</td>\n</tr>\n</tbody></table>\n<p>The resolver maintains a <code>Stylesheet</code> structure that organizes CSS rules for efficient matching against DOM elements. During style resolution, it performs a <strong>tree traversal</strong> of the DOM where each element collects applicable CSS rules, sorts them by specificity and source order, then computes final property values considering inheritance from parent elements. This process produces a <code>StyledNode</code> tree that mirrors the DOM structure but includes computed style information for every element.</p>\n<p>The component handles several complex CSS concepts including <strong>specificity calculation</strong> using the standard (inline, IDs, classes, tags) weighting system, <strong>property inheritance</strong> where child elements receive certain styles from parents, and <strong>cascade resolution</strong> where multiple conflicting rules must be prioritized correctly. The resolver also manages <strong>default user-agent styles</strong> that provide baseline styling for HTML elements before author stylesheets are applied.</p>\n<h4 id=\"layout-engine-component\">Layout Engine Component</h4>\n<p>The <code>LayoutEngine</code> component transforms styled DOM trees into geometric layouts by implementing CSS box model calculations and formatting context algorithms. This component handles the most mathematically complex aspect of browser rendering: determining the exact size and position of every element based on CSS layout rules, content dimensions, and viewport constraints.</p>\n<table>\n<thead>\n<tr>\n<th>Method Name</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>compute_layout</code></td>\n<td><code>styled_tree: &amp;StyledNode, viewport: Rectangle</code></td>\n<td><code>Result&lt;LayoutTree, LayoutError&gt;</code></td>\n<td>Calculates positions and sizes for all elements</td>\n</tr>\n<tr>\n<td><code>layout_block_element</code></td>\n<td><code>node: &amp;StyledNode, containing_block: Rectangle</code></td>\n<td><code>LayoutBox</code></td>\n<td>Implements block formatting context layout</td>\n</tr>\n<tr>\n<td><code>layout_inline_element</code></td>\n<td><code>node: &amp;StyledNode, line_width: f32</code></td>\n<td><code>Vec&lt;LayoutBox&gt;</code></td>\n<td>Handles inline element flow and line breaking</td>\n</tr>\n<tr>\n<td><code>resolve_dimensions</code></td>\n<td><code>node: &amp;StyledNode, parent_size: Size</code></td>\n<td><code>Size</code></td>\n<td>Computes element width and height from CSS properties</td>\n</tr>\n</tbody></table>\n<p>The engine implements two primary <strong>formatting contexts</strong>: block formatting where elements stack vertically, and inline formatting where elements flow horizontally with line wrapping. Block layout involves computing content width from the containing block, resolving auto margins, calculating height from content, and positioning child elements with proper margin collapsing. Inline layout requires more complex algorithms for baseline alignment, line breaking, and handling mixed text and element content.</p>\n<p><strong>Box model calculations</strong> form the mathematical foundation of layout, where each element&#39;s total size includes content area plus padding, border, and margin dimensions. The engine must resolve percentage units relative to parent dimensions, handle auto values through constraint solving, and manage the complex interactions between width, height, margins, and positioning properties.</p>\n<blockquote>\n<p><strong>Layout Complexity Insight</strong>: Layout computation represents a <strong>constraint satisfaction problem</strong> where element dimensions depend on parent sizes, child content, and CSS properties simultaneously. The engine resolves these circular dependencies through multiple layout passes and careful ordering of dimension calculations.</p>\n</blockquote>\n<h4 id=\"render-engine-component\">Render Engine Component</h4>\n<p>The <code>RenderEngine</code> component converts computed layouts into visual output by generating sequences of paint commands that graphics backends can execute to produce the final rendered image. This component traverses the layout tree in proper paint order, emitting drawing commands for backgrounds, borders, text, and other visual elements while handling clipping, z-ordering, and graphics optimization.</p>\n<table>\n<thead>\n<tr>\n<th>Method Name</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>render_layout</code></td>\n<td><code>layout_tree: &amp;LayoutTree</code></td>\n<td><code>Result&lt;DisplayList, RenderError&gt;</code></td>\n<td>Generates paint commands from layout tree</td>\n</tr>\n<tr>\n<td><code>paint_element</code></td>\n<td><code>layout_box: &amp;LayoutBox</code></td>\n<td><code>Vec&lt;PaintCommand&gt;</code></td>\n<td>Creates paint commands for single element</td>\n</tr>\n<tr>\n<td><code>optimize_display_list</code></td>\n<td><code>commands: Vec&lt;PaintCommand&gt;</code></td>\n<td><code>Vec&lt;PaintCommand&gt;</code></td>\n<td>Applies rendering optimizations like clipping</td>\n</tr>\n<tr>\n<td><code>execute_commands</code></td>\n<td><code>display_list: &amp;DisplayList, target: &amp;mut Canvas</code></td>\n<td><code>Result&lt;(), GraphicsError&gt;</code></td>\n<td>Draws commands to graphics surface</td>\n</tr>\n</tbody></table>\n<p>The renderer implements a <strong>painter&#39;s algorithm</strong> approach where elements are drawn in back-to-front order to achieve correct visual layering. Background colors and images are painted first, followed by borders, and finally text content. The engine handles <strong>clipping</strong> by tracking the visible region during tree traversal and omitting paint commands for elements outside the viewport.</p>\n<p>Paint command generation follows the CSS specification for <strong>stacking contexts</strong> and <strong>paint ordering</strong>. Elements with positioning, opacity, or transform properties create new stacking contexts that affect paint order calculations. The renderer must correctly sort these contexts while maintaining performance for documents with complex layering relationships.</p>\n<h3 id=\"recommended-file-structure\">Recommended File Structure</h3>\n<p>The browser engine codebase follows a modular organization that separates the four major pipeline components into distinct modules while providing shared utilities and type definitions. This structure enables independent development of each component while maintaining clear dependency relationships and facilitating comprehensive testing.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>src/\n├── lib.rs                          # Public API and main BrowserEngine struct\n├── types/                          # Shared data structures and enums\n│   ├── mod.rs                      # Re-exports for all shared types\n│   ├── geometry.rs                 # Point, Size, Rectangle, Color\n│   ├── units.rs                    # CSS Unit enum and conversion methods\n│   └── errors.rs                   # Error types for each component\n├── html/                           # HTML parsing and DOM construction\n│   ├── mod.rs                      # HTMLParser public interface\n│   ├── tokenizer.rs                # HTML tokenization logic\n│   ├── parser.rs                   # DOM tree construction\n│   ├── dom.rs                      # DOMNode and Element types\n│   └── entities.rs                 # HTML entity decoding\n├── css/                            # CSS parsing and style resolution\n│   ├── mod.rs                      # StyleResolver public interface\n│   ├── parser.rs                   # CSS rule and selector parsing\n│   ├── selector.rs                 # Selector matching and specificity\n│   ├── cascade.rs                  # CSS cascade algorithm\n│   ├── stylesheet.rs               # Stylesheet storage and organization\n│   └── properties.rs               # CSS property definitions and values\n├── layout/                         # Layout computation and box model\n│   ├── mod.rs                      # LayoutEngine public interface\n│   ├── box_model.rs                # CSS box model calculations\n│   ├── block.rs                    # Block formatting context\n│   ├── inline.rs                   # Inline formatting context\n│   ├── dimensions.rs               # Width/height resolution algorithms\n│   └── tree.rs                     # LayoutTree and LayoutBox types\n├── render/                         # Rendering and paint generation\n│   ├── mod.rs                      # RenderEngine public interface\n│   ├── paint.rs                    # Paint command generation\n│   ├── display_list.rs             # DisplayList optimization\n│   ├── canvas.rs                   # Graphics backend abstraction\n│   └── commands.rs                 # PaintCommand type definitions\n└── tests/                          # Integration tests\n    ├── html_parsing_tests.rs       # HTML parser test cases\n    ├── css_resolution_tests.rs     # Style resolution test cases\n    ├── layout_tests.rs             # Layout computation test cases\n    ├── render_tests.rs             # Rendering output test cases\n    └── integration_tests.rs        # End-to-end pipeline tests</code></pre></div>\n\n<p>This modular structure provides several architectural benefits. Each major component (<code>html</code>, <code>css</code>, <code>layout</code>, <code>render</code>) can be developed and tested independently, with clear interface boundaries defined in the <code>mod.rs</code> files. The shared <code>types</code> module prevents circular dependencies while ensuring consistent data structures across components. Integration tests validate the complete pipeline while unit tests within each module verify component-specific behavior.</p>\n<blockquote>\n<p><strong>Architecture Decision: Module Boundaries</strong></p>\n<ul>\n<li><strong>Context</strong>: Browser engines involve complex interdependent components that could be organized as a monolithic module or separate specialized modules</li>\n<li><strong>Options Considered</strong>: <ol>\n<li>Single large module with all functionality</li>\n<li>Separate modules per pipeline stage</li>\n<li>Layered architecture with parsing/styling/layout/rendering layers</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Separate modules per pipeline stage with shared types module</li>\n<li><strong>Rationale</strong>: This structure matches the natural pipeline flow, enables independent testing, facilitates parallel development, and provides clear upgrade paths for individual components</li>\n<li><strong>Consequences</strong>: Enables modular development and testing, requires careful interface design, may introduce some code duplication for shared utilities</li>\n</ul>\n</blockquote>\n<p>The dependency flow follows the pipeline order: <code>html</code> module has no internal dependencies, <code>css</code> module depends on DOM types from <code>html</code>, <code>layout</code> depends on styled nodes from <code>css</code>, and <code>render</code> depends on layout trees from <code>layout</code>. This <strong>acyclic dependency structure</strong> prevents circular imports and ensures clean architectural boundaries.</p>\n<p>Each module exposes a <strong>minimal public API</strong> through its <code>mod.rs</code> file while keeping implementation details private. For example, the HTML module exposes <code>parse_html()</code> and <code>DOMNode</code> types but hides tokenization details. This encapsulation enables internal refactoring without affecting other components and simplifies the cognitive load for developers working on specific pipeline stages.</p>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>The browser engine implementation requires careful selection of foundational technologies and a well-organized codebase structure that can evolve as complexity increases. The following guidance provides specific technology recommendations and complete starter code to bootstrap development.</p>\n<h4 id=\"technology-recommendations\">Technology Recommendations</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Graphics Backend</td>\n<td>Software rendering to RGB buffer</td>\n<td>GPU-accelerated canvas (wgpu/OpenGL)</td>\n</tr>\n<tr>\n<td>Font Rendering</td>\n<td>Bitmap fonts with fixed metrics</td>\n<td>TrueType/OpenType with complex shaping</td>\n</tr>\n<tr>\n<td>Text Layout</td>\n<td>Simple left-to-right flow</td>\n<td>Full Unicode bidirectional text</td>\n</tr>\n<tr>\n<td>Image Support</td>\n<td>Basic RGB/RGBA formats</td>\n<td>Comprehensive format support (PNG, JPEG, SVG)</td>\n</tr>\n<tr>\n<td>CSS Units</td>\n<td>Pixels and percentages only</td>\n<td>Full CSS unit support (em, rem, vh, vw)</td>\n</tr>\n<tr>\n<td>Development Tools</td>\n<td>Print debugging with DOM dumps</td>\n<td>Visual layout debugging with tree inspector</td>\n</tr>\n</tbody></table>\n<p>For initial implementation, prioritize the simple options to establish working functionality across the entire pipeline. The architecture supports upgrading individual components to advanced options without requiring complete rewrites.</p>\n<h4 id=\"complete-starter-code\">Complete Starter Code</h4>\n<p>The following starter code provides a complete foundation for the browser engine with proper error handling, type definitions, and component interfaces. This code is production-ready for the non-core components, allowing focus on the pipeline algorithms.</p>\n<p><strong>src/lib.rs</strong> - Main engine interface:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">types</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Point</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Size</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">html</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">HTMLParser</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">css</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">StyleResolver</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">LayoutEngine</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">render</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">RenderEngine</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> viewport_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    html_parser</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HTMLParser</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    style_resolver</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> StyleResolver</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    layout_engine</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> LayoutEngine</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    render_engine</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> RenderEngine</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(viewport_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, viewport_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> viewport_size </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> { x</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> { width</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> viewport_width, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> viewport_height },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            viewport_size,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            html_parser</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HTMLParser</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            style_resolver</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> StyleResolver</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            layout_engine</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> LayoutEngine</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(viewport_size),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            render_engine</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> RenderEngine</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(viewport_size),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> render_page</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, html</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, css</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">u8</span><span style=\"color:#E1E4E8\">>, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Implement complete rendering pipeline</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 1. Parse HTML into DOM tree</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 2. Parse CSS into stylesheet</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 3. Resolve styles for all DOM elements</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 4. Compute layout for styled elements</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 5. Generate display list from layout</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 6. Execute paint commands to produce RGB buffer</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement rendering pipeline\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>src/types/geometry.rs</strong> - Core geometric types:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> x</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> contains_point</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, point</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Check if point lies within rectangle bounds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: point.x >= origin.x &#x26;&#x26; point.x &#x3C;= origin.x + size.width</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement point containment check\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> intersects</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, other</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Check if two rectangles overlap</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use separating axis theorem - rectangles don't intersect if</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // there's a gap on any axis (horizontal or vertical)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement rectangle intersection test\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> a</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> rgb</span><span style=\"color:#E1E4E8\">(r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> { r, g, b, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> from_hex</span><span style=\"color:#E1E4E8\">(hex</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Parse hex color strings like \"#ff0000\" or \"red\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 1. Strip leading '#' if present</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 2. Handle 3-digit (#rgb) and 6-digit (#rrggbb) formats  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 3. Parse hex digits into r, g, b components</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 4. Handle named colors as bonus feature</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement hex color parsing\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> WHITE</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> BLACK</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> TRANSPARENT</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> };</span></span></code></pre></div>\n\n<p><strong>src/types/units.rs</strong> - CSS unit handling:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> Unit</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Px</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),      </span><span style=\"color:#6A737D\">// Absolute pixels</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Percent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">), </span><span style=\"color:#6A737D\">// Percentage of parent dimension</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Em</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),      </span><span style=\"color:#6A737D\">// Multiple of current font size</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Auto</span><span style=\"color:#E1E4E8\">,         </span><span style=\"color:#6A737D\">// Automatic sizing</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Unit</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> parse</span><span style=\"color:#E1E4E8\">(input</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Parse CSS unit strings like \"10px\", \"50%\", \"2em\", \"auto\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 1. Trim whitespace from input</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 2. Handle \"auto\" keyword case</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 3. Split numeric value from unit suffix</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 4. Parse numeric component as f32</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 5. Match unit suffix to appropriate enum variant</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement CSS unit parsing\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> to_px</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, parent_value</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, font_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Convert any unit to absolute pixels</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 1. Px(value) -> return value directly</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 2. Percent(value) -> return parent_value * (value / 100.0)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 3. Em(value) -> return font_size * value</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // 4. Auto -> return 0.0 (caller handles auto resolution)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement unit to pixel conversion\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"core-logic-skeletons\">Core Logic Skeletons</h4>\n<p>The following skeletons provide the exact function signatures and detailed TODO comments that map to the algorithm steps described in the design sections. These represent the core learning objectives that developers should implement themselves.</p>\n<p><strong>src/html/parser.rs</strong> - DOM tree construction:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">html</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">dom</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Element</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">TextNode</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> HTMLParser</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> HTMLParser</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> parse_html</span><span style=\"color:#E1E4E8\">(input</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Tokenize the input HTML into structured tokens</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Initialize element stack for tracking open tags  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Process each token to build DOM tree:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        //   - StartTag: create element, push to stack, add as child</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        //   - EndTag: pop from stack if tag names match</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        //   - TextContent: create text node, add as child of current element</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        //   - SelfClosing: create element, add as child, don't push to stack</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Handle error recovery for malformed HTML</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Return root DOM node of constructed tree</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement HTML parsing with DOM tree construction\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>src/css/cascade.rs</strong> - Style resolution:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">css</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">stylesheet</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Stylesheet</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">html</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">dom</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> StyleResolver</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> stylesheet</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Stylesheet</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> StyleResolver</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> resolve_styles</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, dom</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">StyledNode</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Traverse DOM tree in document order</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: For each element, collect matching CSS rules</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Sort rules by specificity (IDs > classes > tags)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Apply cascade to resolve property conflicts</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Compute inherited values from parent element</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Build styled tree mirroring DOM structure</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement CSS cascade and style resolution\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"development-workflow-and-milestones\">Development Workflow and Milestones</h4>\n<p>Follow this incremental development approach to build the browser engine systematically:</p>\n<p><strong>Milestone 1 Checkpoint</strong>: After implementing HTML parsing, verify with:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> html_parsing_tests</span></span></code></pre></div>\n<p>Expected behavior: Parse simple HTML documents into correct DOM tree structure, handle malformed markup gracefully, support common HTML elements and attributes.</p>\n<p><strong>Milestone 2 Checkpoint</strong>: After CSS parsing and style resolution:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> css_resolution_tests</span></span></code></pre></div>\n<p>Expected behavior: Parse CSS rules correctly, match selectors to elements, compute specificity, resolve style inheritance, handle cascade conflicts.</p>\n<p><strong>Milestone 3 Checkpoint</strong>: After layout computation:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> layout_tests</span></span></code></pre></div>\n<p>Expected behavior: Calculate element positions and dimensions, implement box model correctly, handle block and inline formatting, resolve auto values.</p>\n<p><strong>Milestone 4 Checkpoint</strong>: After rendering implementation:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> render_tests</span><span style=\"color:#E1E4E8\"> &#x26;&#x26; </span><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#79B8FF\"> --example</span><span style=\"color:#9ECBFF\"> simple_page</span></span></code></pre></div>\n<p>Expected behavior: Generate correct paint commands, produce visual output, handle graphics operations, support basic styling (colors, borders, text).</p>\n<p>⚠️ <strong>Common Development Pitfall</strong>: Attempting to implement all four pipeline stages simultaneously leads to debugging nightmares where it&#39;s impossible to isolate which component contains bugs. Instead, complete each milestone fully with comprehensive tests before proceeding to the next stage.</p>\n<h2 id=\"data-model-and-core-types\">Data Model and Core Types</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> All milestones (1-4) - This section defines the fundamental data structures that flow through every stage of the rendering pipeline, from DOM tree construction through final paint command generation.</p>\n</blockquote>\n<p>The data model forms the backbone of our browser engine, defining how information is structured and flows through the rendering pipeline. Think of these data structures as <strong>standardized shipping containers</strong> in our document assembly line - each container has a specific format and purpose, allowing different stages of the pipeline to efficiently process and transform the data without needing to understand the internal details of other stages.</p>\n<p>Just as a modern manufacturing assembly line uses standardized parts and interfaces between stations, our browser engine uses well-defined data types that serve as contracts between the HTML parser, CSS parser, layout engine, and rendering engine. Each stage knows exactly what format of data it receives and what format it must produce, enabling clean separation of concerns and modular design.</p>\n<p><img src=\"/api/project/build-browser/architecture-doc/asset?path=diagrams%2Fdata-model-relationships.svg\" alt=\"Data Model Class Diagram\"></p>\n<h3 id=\"mental-model-the-document-assembly-line-containers\">Mental Model: The Document Assembly Line Containers</h3>\n<p>To understand how these data structures work together, imagine a document assembly line where information flows through standardized containers:</p>\n<p><strong>Raw Materials Station</strong>: HTML and CSS text strings enter the assembly line as unprocessed raw materials - just sequences of characters with no inherent structure.</p>\n<p><strong>Parsing Stations</strong>: The HTML parser transforms raw HTML text into <code>DOMNode</code> containers that preserve the hierarchical document structure. Simultaneously, the CSS parser creates <code>CSSRule</code> containers that capture styling information with proper specificity calculations.</p>\n<p><strong>Style Resolution Station</strong>: The style resolver combines DOM containers with CSS rule containers to produce <code>StyledNode</code> containers - DOM nodes enriched with their computed style properties after cascade resolution.</p>\n<p><strong>Layout Station</strong>: The layout engine transforms styled node containers into <code>LayoutBox</code> containers that add geometric information - exact positions, dimensions, and box model calculations.</p>\n<p><strong>Paint Station</strong>: Finally, the rendering engine processes layout boxes to generate <code>PaintCommand</code> containers - specific drawing instructions that can be executed by graphics hardware.</p>\n<p>Each container type has a specific format and purpose, and the assembly line workers (our components) know exactly how to read incoming containers and produce outgoing containers for the next station.</p>\n<h3 id=\"dom-tree-types\">DOM Tree Types</h3>\n<p>The DOM tree represents the hierarchical structure of an HTML document after parsing. These types capture both the semantic structure (what elements exist and how they&#39;re nested) and the content (text, attributes, element types) needed for later processing stages.</p>\n<blockquote>\n<p><strong>Decision: Node-based Tree Structure with Type Discrimination</strong></p>\n<ul>\n<li><strong>Context</strong>: HTML documents contain different types of content (elements, text, comments) that need different handling but must coexist in the same tree structure</li>\n<li><strong>Options Considered</strong>: Single unified node type with optional fields, enum-based discrimination, trait objects</li>\n<li><strong>Decision</strong>: Enum-based node types with shared tree navigation methods</li>\n<li><strong>Rationale</strong>: Type safety prevents attempting element operations on text nodes, pattern matching makes processing logic clear, shared navigation methods avoid code duplication</li>\n<li><strong>Consequences</strong>: Memory overhead from enum tags, but eliminates runtime type checking errors and makes tree traversal algorithms more robust</li>\n</ul>\n</blockquote>\n<h4 id=\"core-dom-node-structure\">Core DOM Node Structure</h4>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>node_type</code></td>\n<td><code>DOMNodeType</code></td>\n<td>Discriminates between element, text, comment, and document nodes</td>\n</tr>\n<tr>\n<td><code>parent</code></td>\n<td><code>Option&lt;DOMNodeHandle&gt;</code></td>\n<td>Reference to parent node, None for root document node</td>\n</tr>\n<tr>\n<td><code>children</code></td>\n<td><code>Vec&lt;DOMNodeHandle&gt;</code></td>\n<td>Ordered list of child nodes preserving document structure</td>\n</tr>\n<tr>\n<td><code>node_data</code></td>\n<td><code>DOMNodeData</code></td>\n<td>Type-specific data based on node_type value</td>\n</tr>\n</tbody></table>\n<h4 id=\"dom-node-type-variants\">DOM Node Type Variants</h4>\n<table>\n<thead>\n<tr>\n<th>Variant Name</th>\n<th>Associated Data</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Element</code></td>\n<td><code>ElementData</code></td>\n<td>HTML elements with tag names, attributes, and semantic meaning</td>\n</tr>\n<tr>\n<td><code>Text</code></td>\n<td><code>String</code></td>\n<td>Text content between elements or as element content</td>\n</tr>\n<tr>\n<td><code>Comment</code></td>\n<td><code>String</code></td>\n<td>HTML comments preserved for debugging or processing instructions</td>\n</tr>\n<tr>\n<td><code>Document</code></td>\n<td><code>DocumentData</code></td>\n<td>Root node containing document metadata and doctype information</td>\n</tr>\n</tbody></table>\n<h4 id=\"element-data-structure\">Element Data Structure</h4>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>tag_name</code></td>\n<td><code>String</code></td>\n<td>Element tag name in lowercase (div, span, p, etc.)</td>\n</tr>\n<tr>\n<td><code>attributes</code></td>\n<td><code>HashMap&lt;String, String&gt;</code></td>\n<td>Key-value pairs of HTML attributes</td>\n</tr>\n<tr>\n<td><code>namespace</code></td>\n<td><code>Option&lt;String&gt;</code></td>\n<td>XML namespace URI for elements (HTML, SVG, MathML)</td>\n</tr>\n<tr>\n<td><code>is_void</code></td>\n<td><code>bool</code></td>\n<td>True for self-closing elements (br, img, input) that cannot have children</td>\n</tr>\n</tbody></table>\n<h4 id=\"document-data-structure\">Document Data Structure</h4>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>doctype</code></td>\n<td><code>Option&lt;String&gt;</code></td>\n<td>DOCTYPE declaration if present in source</td>\n</tr>\n<tr>\n<td><code>title</code></td>\n<td><code>Option&lt;String&gt;</code></td>\n<td>Document title extracted from title element</td>\n</tr>\n<tr>\n<td><code>base_url</code></td>\n<td><code>Option&lt;String&gt;</code></td>\n<td>Base URL for resolving relative references</td>\n</tr>\n<tr>\n<td><code>character_encoding</code></td>\n<td><code>String</code></td>\n<td>Document character encoding (UTF-8, ISO-8859-1, etc.)</td>\n</tr>\n</tbody></table>\n<h4 id=\"dom-tree-navigation-interface\">DOM Tree Navigation Interface</h4>\n<table>\n<thead>\n<tr>\n<th>Method Name</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>get_parent</code></td>\n<td><code>&amp;self</code></td>\n<td><code>Option&lt;&amp;DOMNode&gt;</code></td>\n<td>Returns parent node reference or None for root</td>\n</tr>\n<tr>\n<td><code>get_children</code></td>\n<td><code>&amp;self</code></td>\n<td><code>&amp;Vec&lt;DOMNode&gt;</code></td>\n<td>Returns immutable reference to children list</td>\n</tr>\n<tr>\n<td><code>get_first_child</code></td>\n<td><code>&amp;self</code></td>\n<td><code>Option&lt;&amp;DOMNode&gt;</code></td>\n<td>Returns first child node or None if no children</td>\n</tr>\n<tr>\n<td><code>get_last_child</code></td>\n<td><code>&amp;self</code></td>\n<td><code>Option&lt;&amp;DOMNode&gt;</code></td>\n<td>Returns last child node or None if no children</td>\n</tr>\n<tr>\n<td><code>get_next_sibling</code></td>\n<td><code>&amp;self</code></td>\n<td><code>Option&lt;&amp;DOMNode&gt;</code></td>\n<td>Returns next sibling in parent&#39;s children list</td>\n</tr>\n<tr>\n<td><code>get_previous_sibling</code></td>\n<td><code>&amp;self</code></td>\n<td><code>Option&lt;&amp;DOMNode&gt;</code></td>\n<td>Returns previous sibling in parent&#39;s children list</td>\n</tr>\n<tr>\n<td><code>append_child</code></td>\n<td><code>&amp;mut self, child: DOMNode</code></td>\n<td><code>Result&lt;(), String&gt;</code></td>\n<td>Adds child to end of children list with validation</td>\n</tr>\n<tr>\n<td><code>insert_before</code></td>\n<td><code>&amp;mut self, new_child: DOMNode, reference: &amp;DOMNode</code></td>\n<td><code>Result&lt;(), String&gt;</code></td>\n<td>Inserts new child before reference child</td>\n</tr>\n<tr>\n<td><code>remove_child</code></td>\n<td><code>&amp;mut self, child: &amp;DOMNode</code></td>\n<td><code>Result&lt;DOMNode, String&gt;</code></td>\n<td>Removes and returns child node</td>\n</tr>\n</tbody></table>\n<h4 id=\"text-content-extraction\">Text Content Extraction</h4>\n<table>\n<thead>\n<tr>\n<th>Method Name</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>get_text_content</code></td>\n<td><code>&amp;self</code></td>\n<td><code>String</code></td>\n<td>Returns concatenated text of all descendant text nodes</td>\n</tr>\n<tr>\n<td><code>get_inner_text</code></td>\n<td><code>&amp;self</code></td>\n<td><code>String</code></td>\n<td>Returns visible text content respecting CSS display properties</td>\n</tr>\n<tr>\n<td><code>set_text_content</code></td>\n<td><code>&amp;mut self, text: String</code></td>\n<td><code>()</code></td>\n<td>Replaces all children with single text node</td>\n</tr>\n</tbody></table>\n<p>The DOM tree serves as the foundation for all subsequent processing. The hierarchical structure captures the semantic relationships between elements (which elements are nested inside others), while the attribute storage preserves the original HTML metadata needed for styling and behavior.</p>\n<p>Consider this HTML fragment and its corresponding DOM representation:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">html</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#85E89D\">div</span><span style=\"color:#B392F0\"> class</span><span style=\"color:#E1E4E8\">=</span><span style=\"color:#9ECBFF\">\"container\"</span><span style=\"color:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  &#x3C;</span><span style=\"color:#85E89D\">p</span><span style=\"color:#E1E4E8\">>Hello &#x3C;</span><span style=\"color:#85E89D\">strong</span><span style=\"color:#E1E4E8\">>world&#x3C;/</span><span style=\"color:#85E89D\">strong</span><span style=\"color:#E1E4E8\">>!&#x3C;/</span><span style=\"color:#85E89D\">p</span><span style=\"color:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">&#x3C;/</span><span style=\"color:#85E89D\">div</span><span style=\"color:#E1E4E8\">></span></span></code></pre></div>\n\n<p>This creates a DOM tree where the root <code>div</code> element has <code>class=&quot;container&quot;</code> in its attributes map, contains one child <code>p</code> element, which in turn contains three children: a text node (&quot;Hello &quot;), a <code>strong</code> element containing text node (&quot;world&quot;), and another text node (&quot;!&quot;). This structure preserves the exact nesting relationships needed for CSS selector matching and layout calculations.</p>\n<p>⚠️ <strong>Pitfall: Node Reference Management</strong>\nA common mistake is attempting to use raw pointers or references for parent/child relationships, which creates lifetime management nightmares in languages with strict ownership rules. Instead, use handles (indices into a node pool) or reference-counted smart pointers that allow shared ownership of nodes while maintaining tree structure integrity.</p>\n<p>⚠️ <strong>Pitfall: Attribute Case Sensitivity</strong> \nHTML parsing should normalize attribute names to lowercase for consistent access, but preserve the original case in attribute values. Failing to normalize means <code>Class=&quot;container&quot;</code> and <code>class=&quot;container&quot;</code> would be stored as different keys, breaking CSS selector matching.</p>\n<h3 id=\"css-and-style-types\">CSS and Style Types</h3>\n<p>The CSS and style system represents parsed CSS rules, selector matching logic, and the cascade resolution that determines final computed styles for each DOM element. These types capture both the structural information from CSS parsing (selectors, properties, values) and the computed results after specificity calculation and cascade resolution.</p>\n<blockquote>\n<p><strong>Decision: Separate Parsed and Computed Style Representations</strong></p>\n<ul>\n<li><strong>Context</strong>: CSS values can be specified in various units and formats but need consistent representation for layout calculations</li>\n<li><strong>Options Considered</strong>: Single style representation with on-demand conversion, separate parsed/computed types, lazy evaluation with caching</li>\n<li><strong>Decision</strong>: Explicit separation between <code>CSSValue</code> (parsed) and <code>ComputedValue</code> (resolved)</li>\n<li><strong>Rationale</strong>: Makes the cascade resolution explicit, prevents repeated unit conversions during layout, enables better debugging of style computation</li>\n<li><strong>Consequences</strong>: Higher memory usage storing both parsed and computed values, but eliminates bugs from inconsistent value resolution</li>\n</ul>\n</blockquote>\n<h4 id=\"css-rule-structure\">CSS Rule Structure</h4>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>selector</code></td>\n<td><code>Selector</code></td>\n<td>CSS selector that determines which elements this rule applies to</td>\n</tr>\n<tr>\n<td><code>declarations</code></td>\n<td><code>Vec&lt;Declaration&gt;</code></td>\n<td>Property-value pairs declared in this rule</td>\n</tr>\n<tr>\n<td><code>specificity</code></td>\n<td><code>Specificity</code></td>\n<td>Calculated specificity for cascade ordering</td>\n</tr>\n<tr>\n<td><code>source_order</code></td>\n<td><code>u32</code></td>\n<td>Original position in stylesheet for tie-breaking</td>\n</tr>\n<tr>\n<td><code>important</code></td>\n<td><code>bool</code></td>\n<td>True if any declaration in this rule has !important</td>\n</tr>\n</tbody></table>\n<h4 id=\"selector-types-and-structure\">Selector Types and Structure</h4>\n<table>\n<thead>\n<tr>\n<th>Selector Type</th>\n<th>Structure</th>\n<th>Specificity Contribution</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Universal</code></td>\n<td><code>*</code></td>\n<td>(0, 0, 0, 0)</td>\n</tr>\n<tr>\n<td><code>Type</code></td>\n<td><code>tag_name: String</code></td>\n<td>(0, 0, 0, 1)</td>\n</tr>\n<tr>\n<td><code>Class</code></td>\n<td><code>class_name: String</code></td>\n<td>(0, 0, 1, 0)</td>\n</tr>\n<tr>\n<td><code>ID</code></td>\n<td><code>id_value: String</code></td>\n<td>(0, 1, 0, 0)</td>\n</tr>\n<tr>\n<td><code>Attribute</code></td>\n<td><code>name: String, operator: AttributeOperator, value: Option&lt;String&gt;</code></td>\n<td>(0, 0, 1, 0)</td>\n</tr>\n<tr>\n<td><code>Descendant</code></td>\n<td><code>ancestor: Box&lt;Selector&gt;, descendant: Box&lt;Selector&gt;</code></td>\n<td>Sum of component specificities</td>\n</tr>\n<tr>\n<td><code>Child</code></td>\n<td><code>parent: Box&lt;Selector&gt;, child: Box&lt;Selector&gt;</code></td>\n<td>Sum of component specificities</td>\n</tr>\n</tbody></table>\n<h4 id=\"specificity-calculation\">Specificity Calculation</h4>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>inline</code></td>\n<td><code>u32</code></td>\n<td>Count of inline style declarations (always 0 for stylesheet rules)</td>\n</tr>\n<tr>\n<td><code>ids</code></td>\n<td><code>u32</code></td>\n<td>Count of ID selectors in the selector</td>\n</tr>\n<tr>\n<td><code>classes</code></td>\n<td><code>u32</code></td>\n<td>Count of class selectors, attribute selectors, and pseudo-classes</td>\n</tr>\n<tr>\n<td><code>elements</code></td>\n<td><code>u32</code></td>\n<td>Count of type selectors and pseudo-elements</td>\n</tr>\n</tbody></table>\n<h4 id=\"css-declaration-structure\">CSS Declaration Structure</h4>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>property</code></td>\n<td><code>String</code></td>\n<td>CSS property name (color, font-size, margin-left, etc.)</td>\n</tr>\n<tr>\n<td><code>value</code></td>\n<td><code>CSSValue</code></td>\n<td>Parsed value with units and type information</td>\n</tr>\n<tr>\n<td><code>important</code></td>\n<td><code>bool</code></td>\n<td>True if declaration has !important flag</td>\n</tr>\n</tbody></table>\n<h4 id=\"css-value-types\">CSS Value Types</h4>\n<table>\n<thead>\n<tr>\n<th>Value Type</th>\n<th>Structure</th>\n<th>Example</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Length</code></td>\n<td><code>value: f32, unit: Unit</code></td>\n<td><code>16px</code>, <code>2em</code>, <code>50%</code></td>\n</tr>\n<tr>\n<td><code>Color</code></td>\n<td><code>r: u8, g: u8, b: u8, a: u8</code></td>\n<td><code>#ff0000</code>, <code>rgb(255, 0, 0)</code></td>\n</tr>\n<tr>\n<td><code>Keyword</code></td>\n<td><code>keyword: String</code></td>\n<td><code>auto</code>, <code>inherit</code>, <code>initial</code></td>\n</tr>\n<tr>\n<td><code>String</code></td>\n<td><code>value: String</code></td>\n<td>Font family names, content strings</td>\n</tr>\n<tr>\n<td><code>Number</code></td>\n<td><code>value: f32</code></td>\n<td>Line height, opacity values</td>\n</tr>\n<tr>\n<td><code>URL</code></td>\n<td><code>url: String</code></td>\n<td>Background images, font sources</td>\n</tr>\n</tbody></table>\n<h4 id=\"stylesheet-structure\">Stylesheet Structure</h4>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>rules</code></td>\n<td><code>Vec&lt;CSSRule&gt;</code></td>\n<td>All parsed rules in source order</td>\n</tr>\n<tr>\n<td><code>origin</code></td>\n<td><code>StylesheetOrigin</code></td>\n<td>User-agent, author, or user stylesheet classification</td>\n</tr>\n<tr>\n<td><code>media_queries</code></td>\n<td><code>Vec&lt;MediaQuery&gt;</code></td>\n<td>Media conditions for conditional rule application</td>\n</tr>\n</tbody></table>\n<h4 id=\"computed-style-structure\">Computed Style Structure</h4>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>display</code></td>\n<td><code>Display</code></td>\n<td>Display type (block, inline, none, flex)</td>\n</tr>\n<tr>\n<td><code>position</code></td>\n<td><code>Position</code></td>\n<td>Positioning scheme (static, relative, absolute, fixed)</td>\n</tr>\n<tr>\n<td><code>width</code></td>\n<td><code>ComputedLength</code></td>\n<td>Resolved width in pixels or auto</td>\n</tr>\n<tr>\n<td><code>height</code></td>\n<td><code>ComputedLength</code></td>\n<td>Resolved height in pixels or auto</td>\n</tr>\n<tr>\n<td><code>margin</code></td>\n<td><code>BoxOffsets&lt;ComputedLength&gt;</code></td>\n<td>Margin values for all four sides</td>\n</tr>\n<tr>\n<td><code>border</code></td>\n<td><code>BoxOffsets&lt;BorderSide&gt;</code></td>\n<td>Border width, style, color for all sides</td>\n</tr>\n<tr>\n<td><code>padding</code></td>\n<td><code>BoxOffsets&lt;ComputedLength&gt;</code></td>\n<td>Padding values for all four sides</td>\n</tr>\n<tr>\n<td><code>color</code></td>\n<td><code>Color</code></td>\n<td>Text color in RGBA format</td>\n</tr>\n<tr>\n<td><code>background_color</code></td>\n<td><code>Color</code></td>\n<td>Background color in RGBA format</td>\n</tr>\n<tr>\n<td><code>font_family</code></td>\n<td><code>Vec&lt;String&gt;</code></td>\n<td>Font family stack in preference order</td>\n</tr>\n<tr>\n<td><code>font_size</code></td>\n<td><code>f32</code></td>\n<td>Font size resolved to pixels</td>\n</tr>\n<tr>\n<td><code>font_weight</code></td>\n<td><code>FontWeight</code></td>\n<td>Font weight (100-900 or keyword)</td>\n</tr>\n<tr>\n<td><code>line_height</code></td>\n<td><code>f32</code></td>\n<td>Line height resolved to pixels</td>\n</tr>\n</tbody></table>\n<h4 id=\"style-matching-interface\">Style Matching Interface</h4>\n<table>\n<thead>\n<tr>\n<th>Method Name</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>matches_element</code></td>\n<td><code>selector: &amp;Selector, element: &amp;DOMNode</code></td>\n<td><code>bool</code></td>\n<td>Tests if selector matches given element</td>\n</tr>\n<tr>\n<td><code>calculate_specificity</code></td>\n<td><code>selector: &amp;Selector</code></td>\n<td><code>Specificity</code></td>\n<td>Computes specificity tuple for cascade ordering</td>\n</tr>\n<tr>\n<td><code>collect_matching_rules</code></td>\n<td><code>element: &amp;DOMNode, stylesheet: &amp;Stylesheet</code></td>\n<td><code>Vec&lt;&amp;CSSRule&gt;</code></td>\n<td>Finds all rules that apply to element</td>\n</tr>\n<tr>\n<td><code>resolve_cascade</code></td>\n<td><code>element: &amp;DOMNode, matching_rules: Vec&lt;&amp;CSSRule&gt;</code></td>\n<td><code>ComputedStyle</code></td>\n<td>Applies cascade algorithm to determine final styles</td>\n</tr>\n<tr>\n<td><code>inherit_properties</code></td>\n<td><code>parent_style: &amp;ComputedStyle, child_style: &amp;mut ComputedStyle</code></td>\n<td><code>()</code></td>\n<td>Applies CSS inheritance rules</td>\n</tr>\n</tbody></table>\n<p>The CSS system implements the full cascade algorithm as specified in CSS specifications. When multiple rules apply to the same element, the cascade resolves conflicts using this priority order:</p>\n<ol>\n<li><strong>Origin and importance</strong>: User-agent normal &lt; author normal &lt; user normal &lt; user !important &lt; author !important</li>\n<li><strong>Specificity</strong>: Higher specificity values win using the (inline, ids, classes, elements) tuple</li>\n<li><strong>Source order</strong>: Later rules override earlier rules with identical specificity</li>\n</ol>\n<p>Consider this CSS example and how it resolves:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">css</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#85E89D\">p</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#79B8FF\">color</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">black</span><span style=\"color:#E1E4E8\">; }           </span><span style=\"color:#6A737D\">/* Specificity: (0,0,0,1) */</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">.highlight</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#79B8FF\">color</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">blue</span><span style=\"color:#E1E4E8\">; }   </span><span style=\"color:#6A737D\">/* Specificity: (0,0,1,0) */</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">#intro</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#79B8FF\">color</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">red</span><span style=\"color:#E1E4E8\">; }        </span><span style=\"color:#6A737D\">/* Specificity: (0,1,0,0) */</span></span></code></pre></div>\n\n<p>For an element <code>&lt;p id=&quot;intro&quot; class=&quot;highlight&quot;&gt;</code>, all three rules match, but the ID selector wins due to highest specificity, so the computed color is red.</p>\n<p>⚠️ <strong>Pitfall: Percentage Value Resolution</strong>\nA common mistake is resolving percentage values during CSS parsing instead of during layout computation. Percentages like <code>width: 50%</code> depend on the parent element&#39;s computed dimensions, which aren&#39;t available until layout. Store percentage values in their original form and resolve them during box model calculation.</p>\n<p>⚠️ <strong>Pitfall: Inheritance vs. Initial Values</strong>\nCSS properties behave differently when no explicit value is set. Some properties (like <code>color</code>, <code>font-family</code>) inherit from parent elements, while others (like <code>width</code>, <code>margin</code>) use their initial value. Failing to implement proper inheritance leads to incorrect rendering where text doesn&#39;t pick up parent colors or font settings.</p>\n<h3 id=\"layout-and-box-model-types\">Layout and Box Model Types</h3>\n<p>The layout system represents the geometric information computed from styled DOM elements - their positions, dimensions, and box model properties. These types capture the final calculated values after all CSS resolution, unit conversion, and constraint satisfaction needed for rendering.</p>\n<blockquote>\n<p><strong>Decision: Separate Layout Tree from DOM Tree</strong></p>\n<ul>\n<li><strong>Context</strong>: Layout calculations require additional geometric data not present in DOM, and some DOM elements don&#39;t generate layout boxes</li>\n<li><strong>Options Considered</strong>: Augment DOM nodes with layout data, create parallel layout tree, compute layout on-demand</li>\n<li><strong>Decision</strong>: Separate <code>LayoutBox</code> tree structure that references corresponding DOM nodes</li>\n<li><strong>Rationale</strong>: Clean separation allows DOM to remain immutable during layout, handles cases where single DOM node generates multiple boxes or no boxes, enables layout-specific optimizations</li>\n<li><strong>Consequences</strong>: Additional memory for separate tree structure, but provides flexibility for complex layout scenarios and keeps concerns properly separated</li>\n</ul>\n</blockquote>\n<h4 id=\"layout-box-structure\">Layout Box Structure</h4>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>box_type</code></td>\n<td><code>BoxType</code></td>\n<td>Discriminates between block, inline, text, and anonymous boxes</td>\n</tr>\n<tr>\n<td><code>dom_node</code></td>\n<td><code>Option&lt;DOMNodeHandle&gt;</code></td>\n<td>Reference to corresponding DOM element (None for anonymous boxes)</td>\n</tr>\n<tr>\n<td><code>content_rect</code></td>\n<td><code>Rectangle</code></td>\n<td>Content area dimensions after box model calculation</td>\n</tr>\n<tr>\n<td><code>padding_rect</code></td>\n<td><code>Rectangle</code></td>\n<td>Content + padding dimensions</td>\n</tr>\n<tr>\n<td><code>border_rect</code></td>\n<td><code>Rectangle</code></td>\n<td>Content + padding + border dimensions</td>\n</tr>\n<tr>\n<td><code>margin_rect</code></td>\n<td><code>Rectangle</code></td>\n<td>Content + padding + border + margin dimensions (total space occupied)</td>\n</tr>\n<tr>\n<td><code>children</code></td>\n<td><code>Vec&lt;LayoutBox&gt;</code></td>\n<td>Child boxes in layout tree order</td>\n</tr>\n<tr>\n<td><code>computed_style</code></td>\n<td><code>ComputedStyle</code></td>\n<td>Resolved CSS properties used for this box</td>\n</tr>\n</tbody></table>\n<h4 id=\"box-type-classifications\">Box Type Classifications</h4>\n<table>\n<thead>\n<tr>\n<th>Box Type</th>\n<th>Purpose</th>\n<th>Generated By</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>BlockContainer</code></td>\n<td>Establishes block formatting context for child elements</td>\n<td>Block-level elements (div, p, h1, etc.)</td>\n</tr>\n<tr>\n<td><code>InlineContainer</code></td>\n<td>Establishes inline formatting context for text flow</td>\n<td>Inline elements (span, em, strong, etc.)</td>\n</tr>\n<tr>\n<td><code>TextBox</code></td>\n<td>Contains text content with font and baseline information</td>\n<td>Text nodes with non-whitespace content</td>\n</tr>\n<tr>\n<td><code>AnonymousBlock</code></td>\n<td>Wraps inline content that appears in block context</td>\n<td>Mixed block/inline content scenarios</td>\n</tr>\n<tr>\n<td><code>LineBox</code></td>\n<td>Horizontal line containing inline boxes and text</td>\n<td>Generated during inline layout</td>\n</tr>\n</tbody></table>\n<h4 id=\"rectangle-and-geometric-types\">Rectangle and Geometric Types</h4>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>origin</code></td>\n<td><code>Point</code></td>\n<td>Top-left corner position relative to containing block</td>\n</tr>\n<tr>\n<td><code>size</code></td>\n<td><code>Size</code></td>\n<td>Width and height dimensions of the rectangle</td>\n</tr>\n</tbody></table>\n<h4 id=\"point-and-size-components\">Point and Size Components</h4>\n<table>\n<thead>\n<tr>\n<th>Type</th>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Point</code></td>\n<td><code>x</code></td>\n<td><code>f32</code></td>\n<td>Horizontal coordinate in pixels from left edge</td>\n</tr>\n<tr>\n<td><code>Point</code></td>\n<td><code>y</code></td>\n<td><code>f32</code></td>\n<td>Vertical coordinate in pixels from top edge</td>\n</tr>\n<tr>\n<td><code>Size</code></td>\n<td><code>width</code></td>\n<td><code>f32</code></td>\n<td>Horizontal extent in pixels</td>\n</tr>\n<tr>\n<td><code>Size</code></td>\n<td><code>height</code></td>\n<td><code>f32</code></td>\n<td>Vertical extent in pixels</td>\n</tr>\n</tbody></table>\n<h4 id=\"box-model-calculation-interface\">Box Model Calculation Interface</h4>\n<table>\n<thead>\n<tr>\n<th>Method Name</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>calculate_box_model</code></td>\n<td><code>&amp;self, available_width: f32</code></td>\n<td><code>BoxModel</code></td>\n<td>Computes margin, border, padding, content dimensions</td>\n</tr>\n<tr>\n<td><code>resolve_width</code></td>\n<td><code>&amp;self, containing_width: f32</code></td>\n<td><code>f32</code></td>\n<td>Resolves width value including auto and percentage</td>\n</tr>\n<tr>\n<td><code>resolve_height</code></td>\n<td><code>&amp;self, containing_height: f32</code></td>\n<td><code>f32</code></td>\n<td>Resolves height value including auto and percentage</td>\n</tr>\n<tr>\n<td><code>get_content_bounds</code></td>\n<td><code>&amp;self</code></td>\n<td><code>Rectangle</code></td>\n<td>Returns content area rectangle</td>\n</tr>\n<tr>\n<td><code>get_padding_bounds</code></td>\n<td><code>&amp;self</code></td>\n<td><code>Rectangle</code></td>\n<td>Returns content + padding rectangle</td>\n</tr>\n<tr>\n<td><code>get_border_bounds</code></td>\n<td><code>&amp;self</code></td>\n<td><code>Rectangle</code></td>\n<td>Returns content + padding + border rectangle</td>\n</tr>\n<tr>\n<td><code>get_margin_bounds</code></td>\n<td><code>&amp;self</code></td>\n<td><code>Rectangle</code></td>\n<td>Returns total space occupied including margins</td>\n</tr>\n</tbody></table>\n<h4 id=\"layout-constraints\">Layout Constraints</h4>\n<table>\n<thead>\n<tr>\n<th>Constraint Type</th>\n<th>Description</th>\n<th>Resolution Strategy</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>AvailableWidth</code></td>\n<td>Maximum width available from containing block</td>\n<td>Used for percentage width calculation and line wrapping</td>\n</tr>\n<tr>\n<td><code>AvailableHeight</code></td>\n<td>Maximum height available from containing block</td>\n<td>Used for percentage height and overflow handling</td>\n</tr>\n<tr>\n<td><code>MinContentWidth</code></td>\n<td>Minimum width needed to avoid overflow</td>\n<td>Determined by longest unbreakable content</td>\n</tr>\n<tr>\n<td><code>MaxContentWidth</code></td>\n<td>Width if no wrapping constraints applied</td>\n<td>Sum of all content without line breaks</td>\n</tr>\n</tbody></table>\n<h4 id=\"formatting-context-types\">Formatting Context Types</h4>\n<table>\n<thead>\n<tr>\n<th>Context Type</th>\n<th>Purpose</th>\n<th>Layout Algorithm</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>BlockFormattingContext</code></td>\n<td>Vertical stacking of block boxes</td>\n<td>Stack children vertically, handle margin collapsing</td>\n</tr>\n<tr>\n<td><code>InlineFormattingContext</code></td>\n<td>Horizontal flow with line wrapping</td>\n<td>Flow text and inline boxes horizontally, create line boxes</td>\n</tr>\n<tr>\n<td><code>FlowRoot</code></td>\n<td>Establishes new block formatting context</td>\n<td>Isolates float and margin collapsing behavior</td>\n</tr>\n</tbody></table>\n<h4 id=\"layout-tree-construction-process\">Layout Tree Construction Process</h4>\n<p>The layout tree is built through a multi-pass algorithm that transforms the styled DOM tree into positioned boxes:</p>\n<ol>\n<li><p><strong>Tree Structure Creation</strong>: Traverse the styled DOM tree and create corresponding layout boxes based on computed display values. Elements with <code>display: none</code> are skipped entirely.</p>\n</li>\n<li><p><strong>Anonymous Box Generation</strong>: Insert anonymous block boxes where needed to maintain formatting context rules. For example, if a block element directly contains both block children and text content, wrap the text in an anonymous block.</p>\n</li>\n<li><p><strong>Constraint Propagation</strong>: Pass available width and height constraints down the tree, allowing each box to determine its sizing context.</p>\n</li>\n<li><p><strong>Box Model Calculation</strong>: Resolve all margin, border, padding, and content dimensions using the CSS box model algorithm. Convert percentage values using containing block dimensions.</p>\n</li>\n<li><p><strong>Position Assignment</strong>: Calculate final positions for each box based on its positioning scheme (static, relative, absolute) and formatting context.</p>\n</li>\n</ol>\n<p>Consider this HTML with its layout tree structure:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">html</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#85E89D\">div</span><span style=\"color:#B392F0\"> style</span><span style=\"color:#E1E4E8\">=</span><span style=\"color:#9ECBFF\">\"width: 300px;\"</span><span style=\"color:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  &#x3C;</span><span style=\"color:#85E89D\">p</span><span style=\"color:#B392F0\"> style</span><span style=\"color:#E1E4E8\">=</span><span style=\"color:#9ECBFF\">\"margin: 10px;\"</span><span style=\"color:#E1E4E8\">>Text content&#x3C;/</span><span style=\"color:#85E89D\">p</span><span style=\"color:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">&#x3C;/</span><span style=\"color:#85E89D\">div</span><span style=\"color:#E1E4E8\">></span></span></code></pre></div>\n\n<p>This generates a layout tree where the root <code>div</code> creates a block container with content width of 300px. The child <code>p</code> element creates a nested block box with margin offsets, and the text content generates a text box within the paragraph&#39;s content area. The paragraph&#39;s total width including margins fits within the 300px constraint.</p>\n<p>The box model calculation for the paragraph involves:</p>\n<ul>\n<li>Content width: <code>auto</code> resolves to <code>300px - 20px = 280px</code> (available width minus horizontal margins)</li>\n<li>Padding: Default to 0 for all sides</li>\n<li>Border: Default to 0 for all sides  </li>\n<li>Margin: 10px on all sides as specified</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Margin Collapsing</strong>\nAdjacent block-level elements have their vertical margins collapsed according to complex CSS rules. The larger margin value wins, not the sum of both margins. Failing to implement margin collapsing creates excessive spacing between paragraphs and other block elements. Track adjacent margin values during layout and apply the collapsing algorithm.</p>\n<p>⚠️ <strong>Pitfall: Auto Value Resolution Order</strong>\nCSS <code>auto</code> values must be resolved in a specific order depending on the property and context. For width calculation, resolve <code>auto</code> margins after resolving <code>auto</code> width, not simultaneously. The order affects the final layout when multiple properties have <code>auto</code> values.</p>\n<p>⚠️ <strong>Pitfall: Containing Block Confusion</strong>\nEach element&#39;s containing block (used for percentage resolution) isn&#39;t always its parent element. For absolutely positioned elements, the containing block is the nearest positioned ancestor. For relatively positioned elements, it&#39;s the parent&#39;s content area. Using the wrong containing block leads to incorrect percentage calculations.</p>\n<h3 id=\"paint-command-types\">Paint Command Types</h3>\n<p>Paint commands represent the final rendering instructions generated from the layout tree. These types capture specific drawing operations that can be executed by graphics backends to produce visual output.</p>\n<h4 id=\"paint-command-structure\">Paint Command Structure</h4>\n<table>\n<thead>\n<tr>\n<th>Command Type</th>\n<th>Fields</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>DrawRectangle</code></td>\n<td><code>rect: Rectangle, color: Color</code></td>\n<td>Fills rectangle with solid color</td>\n</tr>\n<tr>\n<td><code>DrawBorder</code></td>\n<td><code>rect: Rectangle, border: BorderStyle</code></td>\n<td>Draws border around rectangle perimeter</td>\n</tr>\n<tr>\n<td><code>DrawText</code></td>\n<td><code>text: String, position: Point, font: Font, color: Color</code></td>\n<td>Renders text at specified baseline position</td>\n</tr>\n<tr>\n<td><code>SetClip</code></td>\n<td><code>rect: Rectangle</code></td>\n<td>Restricts subsequent drawing to rectangle bounds</td>\n</tr>\n<tr>\n<td><code>ClearClip</code></td>\n<td></td>\n<td>Removes current clipping restriction</td>\n</tr>\n</tbody></table>\n<h4 id=\"display-list-structure\">Display List Structure</h4>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>commands</code></td>\n<td><code>Vec&lt;PaintCommand&gt;</code></td>\n<td>Ordered list of paint commands in z-order</td>\n</tr>\n<tr>\n<td><code>viewport</code></td>\n<td><code>Rectangle</code></td>\n<td>Visible area bounds for clipping optimization</td>\n</tr>\n<tr>\n<td><code>background_color</code></td>\n<td><code>Color</code></td>\n<td>Document background color</td>\n</tr>\n</tbody></table>\n<p>The paint command system provides the interface between layout calculations and actual pixel rendering, abstracting away graphics backend details while preserving precise drawing control.</p>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<h4 id=\"technology-recommendations\">Technology Recommendations</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>DOM Storage</td>\n<td><code>Vec&lt;DOMNode&gt;</code> with index handles</td>\n<td><code>Arena&lt;DOMNode&gt;</code> with generational indices</td>\n</tr>\n<tr>\n<td>Style Matching</td>\n<td>Linear scan through all rules</td>\n<td>Bloom filter + rule hashing</td>\n</tr>\n<tr>\n<td>Layout Tree</td>\n<td>Recursive tree with owned children</td>\n<td>Flat array with parent/child indices</td>\n</tr>\n<tr>\n<td>Memory Management</td>\n<td>Reference counting (<code>Rc&lt;RefCell&lt;T&gt;&gt;</code>)</td>\n<td>Custom arena allocator</td>\n</tr>\n</tbody></table>\n<h4 id=\"recommended-file-structure\">Recommended File Structure</h4>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>src/\n  dom/\n    mod.rs              ← DOM type definitions and exports\n    node.rs             ← DOMNode, Element, Text implementations  \n    tree.rs             ← Tree navigation and manipulation\n    html_parser.rs      ← HTML parsing integration\n  \n  style/\n    mod.rs              ← Style type definitions and exports\n    selector.rs         ← Selector matching and specificity\n    cascade.rs          ← Cascade resolution algorithm\n    computed.rs         ← Computed style calculation\n    \n  layout/\n    mod.rs              ← Layout type definitions and exports\n    box_model.rs        ← BoxModel calculation algorithms\n    block.rs            ← Block formatting context\n    inline.rs           ← Inline formatting context\n    \n  paint/\n    mod.rs              ← Paint command types\n    display_list.rs     ← Display list generation\n    \n  geometry.rs           ← Point, Size, Rectangle utilities\n  color.rs              ← Color type and parsing</code></pre></div>\n\n<h4 id=\"core-geometry-types-complete-implementation\">Core Geometry Types (Complete Implementation)</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// geometry.rs - Complete foundational types</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> x</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(x</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Point</span><span style=\"color:#E1E4E8\"> { x, y }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> origin</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Point</span><span style=\"color:#E1E4E8\"> { x</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Size</span><span style=\"color:#E1E4E8\"> { width, height }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> zero</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Size</span><span style=\"color:#E1E4E8\"> { width</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(x</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(x, y),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(width, height),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> contains_point</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, point</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Check if point.x is within [origin.x, origin.x + size.width]</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Check if point.y is within [origin.y, origin.y + size.height]  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Return true only if both x and y are within bounds</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> intersects</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, other</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Calculate right edge as origin.x + size.width for both rectangles</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Calculate bottom edge as origin.y + size.height for both rectangles</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Check if rectangles overlap horizontally and vertically</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Return false if no overlap on either axis</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"color-type-implementation-complete\">Color Type Implementation (Complete)</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// color.rs - Complete color handling</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> a</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> rgb</span><span style=\"color:#E1E4E8\">(r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Color</span><span style=\"color:#E1E4E8\"> { r, g, b, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> rgba</span><span style=\"color:#E1E4E8\">(r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Color</span><span style=\"color:#E1E4E8\"> { r, g, b, a }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> from_hex</span><span style=\"color:#E1E4E8\">(hex</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> hex </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> hex</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">trim_start_matches</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'#'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> hex</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 6</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> Err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Hex color must be 6 characters\"</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">());</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> r </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">hex[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#F97583\">..</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#9ECBFF\"> \"Invalid hex digits\"</span><span style=\"color:#E1E4E8\">)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> g </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">hex[</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#F97583\">..</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#9ECBFF\"> \"Invalid hex digits\"</span><span style=\"color:#E1E4E8\">)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> b </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">hex[</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#F97583\">..</span><span style=\"color:#79B8FF\">6</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#9ECBFF\"> \"Invalid hex digits\"</span><span style=\"color:#E1E4E8\">)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">rgb</span><span style=\"color:#E1E4E8\">(r, g, b))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Standard color constants</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> WHITE</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> BLACK</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> TRANSPARENT</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> };</span></span></code></pre></div>\n\n<h4 id=\"dom-node-type-skeleton\">DOM Node Type Skeleton</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// dom/node.rs - Core DOM types for implementation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">collections</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">HashMap</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> DOMNode</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Element</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">ElementData</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Text</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Comment</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Document</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">DocumentData</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> ElementData</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> attributes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> children</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]  </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> DocumentData</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> doctype</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> title</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> children</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> DOMNode</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> get_text_content</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Match on node type</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: For Text nodes, return the string content directly</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: For Element/Document nodes, recursively collect text from all children</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: For Comment nodes, return empty string</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Concatenate all text content with proper whitespace handling</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> matches_selector</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, selector</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Parse selector string into Selector enum</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Match current element against selector type (tag, class, id)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: For class selectors, check if class exists in attributes[\"class\"]</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: For id selectors, check if id matches attributes[\"id\"]</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: For tag selectors, check if tag_name matches (case insensitive)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"css-value-and-unit-types-skeleton\">CSS Value and Unit Types Skeleton</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// style/values.rs - CSS value type system</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> Unit</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Px</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Percent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Em</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Auto</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Unit</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> parse</span><span style=\"color:#E1E4E8\">(input</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Trim whitespace from input</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Check for \"auto\" keyword and return Unit::Auto</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Use regex or manual parsing to extract number and unit suffix  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Match unit suffix: \"px\" -> Px, \"%\" -> Percent, \"em\" -> Em</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Parse number portion as f32, handle parse errors</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> to_px</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, parent_value</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, font_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Match on Unit variant</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Px(value) returns value directly  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Percent(value) returns parent_value * (value / 100.0)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Em(value) returns font_size * value</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Auto should panic or return default - requires context to resolve</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> CSSValue</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Length</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Color</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Keyword</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    String</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Number</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"layout-box-model-skeleton\">Layout Box Model Skeleton</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// layout/box_model.rs - Box model calculation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">geometry</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Size</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Point</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">style</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> LayoutBox</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> box_type</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> BoxType</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> content_rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> padding_rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> border_rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> margin_rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> children</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> computed_style</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ComputedStyle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> BoxType</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    BlockContainer</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    InlineContainer</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    TextBox</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    AnonymousBlock</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> LayoutBox</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> calculate_box_model</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, containing_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Extract margin, border, padding values from computed_style</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Resolve percentage values using containing_width parameter</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Calculate content_rect dimensions based on width/height properties</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Expand content_rect by padding to get padding_rect</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Expand padding_rect by border to get border_rect  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Expand border_rect by margin to get margin_rect</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Handle special cases like negative margins and box-sizing property</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> layout_block_children</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, available_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Initialize y_offset to start of content area</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Iterate through children in order</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: For each child, call calculate_box_model with available_width</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Position child at current y_offset</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Advance y_offset by child's total height including margins</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Handle margin collapsing between adjacent block children</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"milestone-checkpoint-data-structure-validation\">Milestone Checkpoint: Data Structure Validation</h4>\n<p>After implementing these core types, verify correct behavior with these tests:</p>\n<p><strong>DOM Tree Validation:</strong></p>\n<ul>\n<li>Create a simple DOM tree with nested elements</li>\n<li>Verify parent-child relationships are bidirectional</li>\n<li>Test text content extraction across multiple nesting levels</li>\n<li>Confirm attribute access is case-insensitive for names, preserves case for values</li>\n</ul>\n<p><strong>CSS Value Resolution:</strong></p>\n<ul>\n<li>Parse various unit types (px, %, em, auto) from strings</li>\n<li>Test unit conversion with different parent and font size contexts</li>\n<li>Verify color parsing from hex strings and named colors</li>\n<li>Check specificity calculation for complex selectors</li>\n</ul>\n<p><strong>Layout Box Model:</strong></p>\n<ul>\n<li>Create layout box with margin, border, padding values</li>\n<li>Verify the four rectangles (content, padding, border, margin) have correct dimensions</li>\n<li>Test percentage unit resolution using containing block dimensions</li>\n<li>Confirm box model calculation handles edge cases like negative margins</li>\n</ul>\n<p><strong>Integration Testing:</strong></p>\n<ul>\n<li>Build complete styled DOM tree from HTML + CSS</li>\n<li>Generate layout tree with proper box model calculations</li>\n<li>Verify layout tree structure matches DOM tree hierarchy</li>\n<li>Test that computed styles cascade correctly through inheritance</li>\n</ul>\n<h4 id=\"debugging-tips\">Debugging Tips</h4>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>How to Diagnose</th>\n<th>Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Incorrect text content extraction</td>\n<td>Missing recursive traversal of child nodes</td>\n<td>Add debug prints showing which nodes are visited during traversal</td>\n<td>Implement proper depth-first search through all child nodes</td>\n</tr>\n<tr>\n<td>CSS rules not matching elements</td>\n<td>Case sensitivity or attribute parsing issues</td>\n<td>Log selector matching attempts and attribute maps</td>\n<td>Normalize tag names and attribute names to lowercase</td>\n</tr>\n<tr>\n<td>Box dimensions don&#39;t add up</td>\n<td>Incorrect box model calculation or percentage resolution</td>\n<td>Print all four rectangle bounds and their calculations</td>\n<td>Verify each rectangle expands the previous by the correct amount</td>\n</tr>\n<tr>\n<td>Layout tree missing nodes</td>\n<td>DOM nodes with display:none not handled correctly</td>\n<td>Compare DOM tree size with layout tree size</td>\n<td>Skip DOM nodes with display:none during layout tree construction</td>\n</tr>\n<tr>\n<td>Memory usage grows unexpectedly</td>\n<td>Circular references in tree structures or missing cleanup</td>\n<td>Use memory profiler to track allocation patterns</td>\n<td>Ensure parent references use weak pointers or indices to avoid cycles</td>\n</tr>\n</tbody></table>\n<h2 id=\"html-parser-design\">HTML Parser Design</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 1 (HTML Parser) - This section implements the foundational HTML parsing system that converts raw HTML text into a structured DOM tree, providing the essential document representation for all subsequent rendering pipeline stages.</p>\n</blockquote>\n<p>The HTML parser represents the critical first stage of our browser rendering pipeline, transforming unstructured text markup into a hierarchical document representation. Think of HTML parsing as <strong>the librarian of our browser engine</strong> - just as a librarian takes a chaotic pile of loose papers and organizes them into a properly catalogued, cross-referenced system where every document has its proper place and relationship to other materials, the HTML parser takes raw text and creates a meticulously structured tree where every element knows its parent, children, and position in the document hierarchy.</p>\n<p>This transformation is far more complex than simply splitting text on angle brackets. Real-world HTML is often malformed, contains implicit structures, and requires sophisticated error recovery. The parser must handle everything from perfectly formatted markup to the messiest tag soup found in legacy websites, always producing a valid DOM tree that subsequent pipeline stages can reliably process.</p>\n<p><img src=\"/api/project/build-browser/architecture-doc/asset?path=diagrams%2Fhtml-parsing-flow.svg\" alt=\"HTML Parsing State Machine\"></p>\n<h3 id=\"html-tokenization\">HTML Tokenization</h3>\n<p>HTML tokenization serves as the lexical analysis phase that breaks raw HTML text into meaningful tokens. Think of <strong>tokenization as a careful archaeologist</strong> who examines an ancient manuscript character by character, identifying where words begin and end, distinguishing between different types of text (headings, body text, annotations), and recognizing structural elements like chapter breaks or marginalia. The tokenizer performs this same meticulous analysis on HTML, recognizing that <code>&lt;div</code> represents the beginning of a start tag, that <code>class=&quot;header&quot;</code> contains an attribute, and that <code>&lt;/div&gt;</code> represents a complete end tag.</p>\n<p>The tokenization process operates as a state machine that transitions between different parsing contexts based on the current character and parsing state. When the tokenizer encounters a <code>&lt;</code> character in normal text content, it transitions from the &quot;data state&quot; to the &quot;tag open state.&quot; If the next character is a letter, it moves to the &quot;tag name state&quot; and begins accumulating tag name characters. If it encounters a space, it transitions to &quot;before attribute name state&quot; to parse attributes. This state-driven approach ensures that the same character sequence can be interpreted differently depending on context - for example, <code>&lt;</code> in text content versus <code>&lt;</code> beginning a tag.</p>\n<blockquote>\n<p><strong>Decision: State Machine Architecture for HTML Tokenization</strong></p>\n<ul>\n<li><strong>Context</strong>: HTML tokenization requires parsing context-sensitive grammar where the same characters have different meanings in different contexts (text content vs. tag names vs. attribute values)</li>\n<li><strong>Options Considered</strong>: <ol>\n<li>Regular expression-based parsing with multiple passes</li>\n<li>Hand-written recursive descent parser</li>\n<li>State machine tokenizer following HTML5 specification</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: State machine tokenizer following HTML5 specification  </li>\n<li><strong>Rationale</strong>: State machines provide precise control over parsing context, handle malformed input gracefully, and align with how real browsers parse HTML. Regular expressions cannot handle the full complexity of HTML&#39;s context-sensitive grammar, while recursive descent would be unnecessarily complex for tokenization.</li>\n<li><strong>Consequences</strong>: Enables robust error recovery, matches browser behavior exactly, but requires careful state management and comprehensive state transition logic.</li>\n</ul>\n</blockquote>\n<p>The tokenizer must distinguish between several fundamental token types, each representing a different structural element in the HTML document. Start tags like <code>&lt;div class=&quot;content&quot;&gt;</code> indicate the beginning of an element and contain the tag name plus any attributes. End tags like <code>&lt;/div&gt;</code> signal element closure and contain only the tag name. Self-closing tags like <code>&lt;img src=&quot;photo.jpg&quot; /&gt;</code> represent complete elements that don&#39;t contain child content. Text tokens contain the actual content between tags, including whitespace that may be significant for layout. Comment tokens like <code>&lt;!-- this is a comment --&gt;</code> represent developer annotations that should be preserved in the DOM but not rendered.</p>\n<table>\n<thead>\n<tr>\n<th>Token Type</th>\n<th>Structure</th>\n<th>Example</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>StartTag</td>\n<td>tag_name: String, attributes: HashMap&lt;String, String&gt;, self_closing: bool</td>\n<td><code>&lt;div class=&quot;header&quot;&gt;</code></td>\n<td>Opening tag with optional attributes</td>\n</tr>\n<tr>\n<td>EndTag</td>\n<td>tag_name: String</td>\n<td><code>&lt;/div&gt;</code></td>\n<td>Closing tag containing only tag name</td>\n</tr>\n<tr>\n<td>Text</td>\n<td>content: String</td>\n<td><code>Hello World</code></td>\n<td>Text content between tags</td>\n</tr>\n<tr>\n<td>Comment</td>\n<td>content: String</td>\n<td><code>&lt;!-- comment --&gt;</code></td>\n<td>Developer comments preserved in DOM</td>\n</tr>\n<tr>\n<td>Doctype</td>\n<td>name: String, public_id: Option<String>, system_id: Option<String></td>\n<td><code>&lt;!DOCTYPE html&gt;</code></td>\n<td>Document type declaration</td>\n</tr>\n</tbody></table>\n<p>The tokenizer handles attribute parsing with particular care, as attributes can contain complex quoted values, unquoted values, and edge cases like empty attributes or attributes without values. When parsing <code>&lt;img src=&quot;photo.jpg&quot; alt=&#39;A &quot;nice&quot; photo&#39; hidden&gt;</code>, the tokenizer must recognize that the <code>src</code> attribute has a double-quoted value, the <code>alt</code> attribute has a single-quoted value containing escaped double quotes, and <code>hidden</code> is a boolean attribute without a value. This requires transitioning between &quot;attribute name,&quot; &quot;before attribute value,&quot; &quot;attribute value quoted,&quot; and &quot;attribute value unquoted&quot; states while properly handling quote escaping and whitespace normalization.</p>\n<blockquote>\n<p><strong>Critical insight</strong>: The HTML tokenizer must handle attributes containing JavaScript code, CSS rules, or other embedded languages without attempting to parse those languages. The tokenizer&#39;s responsibility ends at extracting the attribute value as a string - interpretation of that content happens in later pipeline stages.</p>\n</blockquote>\n<p>Character entity decoding represents another crucial tokenization responsibility. When the tokenizer encounters sequences like <code>&amp;amp;</code>, <code>&amp;lt;</code>, or <code>&amp;#65;</code>, it must decode these to their corresponding characters (<code>&amp;</code>, <code>&lt;</code>, <code>A</code>). However, entity decoding behavior varies by context - entities in attribute values have different rules than entities in text content. Named entities require a lookup table of predefined names, while numeric entities require conversion from decimal or hexadecimal numbers to Unicode code points.</p>\n<p><strong>Common Tokenization Pitfalls:</strong></p>\n<p>⚠️ <strong>Pitfall: Case Sensitivity Confusion</strong>\nMany developers incorrectly assume HTML tag names and attribute names are case-sensitive. The HTML5 specification requires that tag names and attribute names be treated case-insensitively in HTML documents (but case-sensitively in XML documents). Failing to normalize case leads to selector matching failures in later stages. Always convert tag names and attribute names to lowercase during tokenization.</p>\n<p>⚠️ <strong>Pitfall: Incomplete Entity Decoding</strong>\nImplementing only the most common entities like <code>&amp;amp;</code>, <code>&amp;lt;</code>, <code>&amp;gt;</code> while ignoring numeric entities or less common named entities breaks pages using international characters or special symbols. The HTML5 specification includes over 2,000 named entities. Use a complete entity lookup table or a well-tested entity decoding library.</p>\n<p>⚠️ <strong>Pitfall: Attribute Value Whitespace Handling</strong>\nHTML has complex rules for whitespace handling in attribute values. Leading and trailing whitespace should be trimmed, and internal whitespace should be normalized (multiple consecutive whitespace characters become a single space) for most attributes. However, some attributes like <code>style</code> preserve whitespace exactly. Understanding these nuances prevents layout and styling issues later.</p>\n<h3 id=\"dom-tree-construction\">DOM Tree Construction</h3>\n<p>DOM tree construction transforms the linear stream of tokens from the tokenizer into a hierarchical tree structure that represents the document&#39;s logical organization. Think of this process as <strong>an architect reviewing building blueprints</strong> - the tokenizer has identified all the individual components (walls, doors, windows, electrical fixtures), and now the tree builder must understand how these components fit together to create rooms, floors, and ultimately a complete building structure. The tree builder knows that a <code>&lt;div&gt;</code> token starts a new container that can hold other elements, while a <code>&lt;/div&gt;</code> token closes that container, and it maintains the nesting relationships that define the document hierarchy.</p>\n<p>The tree construction algorithm operates using an explicit stack that tracks the currently open elements, mirroring the nested structure of HTML tags. When the parser encounters a start tag token, it creates a new DOM node and pushes it onto the open element stack. This new element becomes the current insertion point for subsequent content. When parsing <code>&lt;div&gt;&lt;p&gt;Hello&lt;/p&gt;&lt;/div&gt;</code>, the algorithm first pushes the <code>div</code> element onto the stack, then pushes the <code>p</code> element. The text token &quot;Hello&quot; gets inserted as a child of the current stack top (the <code>p</code> element). When the <code>&lt;/p&gt;</code> end tag appears, the algorithm pops the <code>p</code> element from the stack, making <code>div</code> the current insertion point again.</p>\n<blockquote>\n<p><strong>Decision: Stack-Based Tree Construction Algorithm</strong></p>\n<ul>\n<li><strong>Context</strong>: Need to build hierarchical DOM tree from linear token stream while handling arbitrary nesting depth and malformed markup</li>\n<li><strong>Options Considered</strong>:<ol>\n<li>Recursive descent with explicit recursion stack</li>\n<li>Stack-based iterative algorithm with explicit open element stack  </li>\n<li>Two-pass algorithm that first validates structure then builds tree</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Stack-based iterative algorithm with explicit open element stack</li>\n<li><strong>Rationale</strong>: Stack-based approach directly models HTML&#39;s nesting semantics, provides precise control over error recovery, avoids recursion depth limits, and matches HTML5 specification algorithms. Two-pass validation would be less efficient and couldn&#39;t handle certain malformed markup patterns.</li>\n<li><strong>Consequences</strong>: Enables robust error recovery, handles arbitrarily deep nesting, but requires careful stack management and complex insertion mode logic.</li>\n</ul>\n</blockquote>\n<p>The DOM node structure must efficiently represent both element nodes containing tag information and text nodes containing content. Each node maintains bidirectional relationships with its parent and children, enabling efficient tree traversal in either direction. The node structure also preserves the original source information needed for error reporting and debugging tools.</p>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>node_type</td>\n<td>DOMNodeType</td>\n<td>Discriminates between Element, Text, Comment, Document, and Doctype nodes</td>\n</tr>\n<tr>\n<td>parent</td>\n<td>Option<DOMNodeHandle></td>\n<td>Reference to parent node, None for document root</td>\n</tr>\n<tr>\n<td>children</td>\n<td>Vec<DOMNodeHandle></td>\n<td>Ordered list of direct children</td>\n</tr>\n<tr>\n<td>node_data</td>\n<td>DOMNodeData</td>\n<td>Type-specific data (ElementData for elements, String for text)</td>\n</tr>\n<tr>\n<td>source_location</td>\n<td>Option<SourceLocation></td>\n<td>Original position in source HTML for debugging</td>\n</tr>\n</tbody></table>\n<p>Element nodes require additional metadata beyond the basic tree structure. The <code>ElementData</code> structure stores the tag name, attribute map, namespace information for XML documents, and whether the element is a void element that cannot contain children. This information drives both the tree construction algorithm and later processing stages.</p>\n<table>\n<thead>\n<tr>\n<th>Field Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>tag_name</td>\n<td>String</td>\n<td>Lowercase normalized tag name (e.g., &quot;div&quot;, &quot;img&quot;)</td>\n</tr>\n<tr>\n<td>attributes</td>\n<td>HashMap&lt;String, String&gt;</td>\n<td>Attribute name-value pairs with normalized names</td>\n</tr>\n<tr>\n<td>namespace</td>\n<td>Option<String></td>\n<td>XML namespace URI, None for HTML documents</td>\n</tr>\n<tr>\n<td>is_void</td>\n<td>bool</td>\n<td>True for void elements that cannot have children (img, br, hr)</td>\n</tr>\n</tbody></table>\n<p>The tree construction algorithm must handle void elements specially, as these represent complete elements that cannot contain children. When the parser encounters <code>&lt;img src=&quot;photo.jpg&quot;&gt;</code>, it creates an element node and immediately considers it complete - no corresponding end tag is expected or allowed. The HTML5 specification defines a specific set of void elements including <code>area</code>, <code>base</code>, <code>br</code>, <code>col</code>, <code>embed</code>, <code>hr</code>, <code>img</code>, <code>input</code>, <code>link</code>, <code>meta</code>, <code>param</code>, <code>source</code>, <code>track</code>, and <code>wbr</code>. Attempting to nest content inside void elements represents a parsing error that requires error recovery.</p>\n<p>Text node handling requires careful consideration of whitespace normalization and adjacent text node coalescing. When the parser encounters multiple consecutive text tokens (perhaps separated by comments), it should typically merge them into a single text node to simplify later processing. However, the algorithm must preserve semantically significant whitespace while normalizing insignificant whitespace according to CSS whitespace processing rules.</p>\n<p><strong>DOM Tree Construction Algorithm:</strong></p>\n<ol>\n<li>Initialize an empty open element stack with the document node as the root</li>\n<li>Set the current insertion mode based on document type and context</li>\n<li>For each token from the tokenizer:<ul>\n<li>If StartTag token: Create element node with tag name and attributes, insert into tree at current position, push onto stack (unless void element)</li>\n<li>If EndTag token: Pop elements from stack until matching start tag found, validate proper nesting</li>\n<li>If Text token: Create text node with content, insert as child of current stack top</li>\n<li>If Comment token: Create comment node, insert at current position</li>\n</ul>\n</li>\n<li>Handle insertion mode changes for special elements (table, select, frameset)</li>\n<li>Perform error recovery for malformed markup (unclosed tags, improper nesting)</li>\n<li>Return completed DOM tree with document root</li>\n</ol>\n<p>The algorithm includes sophisticated insertion mode logic that changes parsing behavior based on the current context. When parsing inside a <code>&lt;table&gt;</code> element, the parser enters &quot;in table&quot; mode where text tokens are handled differently than in normal content. Similarly, parsing inside <code>&lt;select&gt;</code> elements restricts which child elements are allowed. These modes ensure that the resulting DOM tree matches browser behavior even for complex nested structures.</p>\n<h3 id=\"error-recovery-and-edge-cases\">Error Recovery and Edge Cases</h3>\n<p>Real-world HTML rarely follows specifications perfectly, requiring robust error recovery mechanisms that produce sensible DOM trees from malformed markup. Think of error recovery as <strong>an experienced emergency room doctor</strong> who encounters patients with unusual symptoms and incomplete medical histories. The doctor uses their knowledge of human anatomy and common patterns to make the best possible diagnosis and treatment plan with incomplete information. Similarly, the HTML parser uses its understanding of intended document structure and common authoring patterns to construct the most reasonable DOM tree possible from broken markup.</p>\n<p>The most common parsing errors involve missing closing tags, where authors write <code>&lt;div&gt;&lt;p&gt;Content</code> without proper closing tags. The error recovery algorithm must determine where these implicit closures should occur. When the parser reaches the end of input with unclosed elements remaining on the stack, it automatically closes all open elements in reverse order. However, more sophisticated recovery occurs when encountering mismatched tags - if the parser sees <code>&lt;div&gt;&lt;p&gt;Content&lt;/div&gt;</code>, it must decide whether to implicitly close the <code>&lt;p&gt;</code> element before closing the <code>&lt;div&gt;</code>, or treat the <code>&lt;/div&gt;</code> as mismatched and ignore it.</p>\n<blockquote>\n<p><strong>Decision: Implicit Tag Closure with Foster Parenting</strong></p>\n<ul>\n<li><strong>Context</strong>: Need to handle malformed HTML where tags are improperly nested, unclosed, or appear in invalid contexts</li>\n<li><strong>Options Considered</strong>:<ol>\n<li>Strict parsing that rejects malformed markup</li>\n<li>Best-effort parsing with implicit tag closure</li>\n<li>Permissive parsing that accepts any tag structure</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Best-effort parsing with implicit tag closure following HTML5 foster parenting algorithm</li>\n<li><strong>Rationale</strong>: Real web content contains substantial amounts of malformed HTML that must render correctly. Strict parsing would break too many existing websites. Foster parenting provides predictable, specification-defined behavior for edge cases.</li>\n<li><strong>Consequences</strong>: Enables compatibility with legacy content but requires complex error recovery logic and careful testing of edge cases.</li>\n</ul>\n</blockquote>\n<p>Foster parenting represents the most complex error recovery mechanism, handling content that appears in contexts where it cannot be properly inserted. When parsing table-related markup, text content or block elements that appear directly inside <code>&lt;table&gt;</code> elements (where only <code>&lt;tr&gt;</code>, <code>&lt;thead&gt;</code>, <code>&lt;tbody&gt;</code> elements should appear) must be &quot;fostered&quot; out of the table to the nearest appropriate parent. This ensures that content remains accessible while maintaining table structure integrity.</p>\n<p>Consider the malformed markup: <code>&lt;table&gt;&lt;div&gt;Misplaced content&lt;/div&gt;&lt;tr&gt;&lt;td&gt;Cell&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</code>. The foster parenting algorithm recognizes that the <code>&lt;div&gt;</code> element cannot legally appear as a direct child of <code>&lt;table&gt;</code>. Instead of dropping the content or breaking the table structure, it moves the <code>&lt;div&gt;</code> to become a sibling of the <code>&lt;table&gt;</code> element, preserving both the table structure and the misplaced content.</p>\n<table>\n<thead>\n<tr>\n<th>Error Type</th>\n<th>Detection</th>\n<th>Recovery Strategy</th>\n<th>Example</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Unclosed Elements</td>\n<td>End of input with non-empty element stack</td>\n<td>Implicitly close all open elements in reverse order</td>\n<td><code>&lt;div&gt;&lt;p&gt;Text</code> → closes both <code>p</code> and <code>div</code></td>\n</tr>\n<tr>\n<td>Mismatched End Tags</td>\n<td>End tag doesn&#39;t match current stack top</td>\n<td>Pop stack until matching start tag found</td>\n<td><code>&lt;div&gt;&lt;span&gt;&lt;/div&gt;</code> → implicitly closes <code>span</code></td>\n</tr>\n<tr>\n<td>Void Element End Tags</td>\n<td>End tag for void element</td>\n<td>Ignore the end tag</td>\n<td><code>&lt;img&gt;&lt;/img&gt;</code> → ignore <code>&lt;/img&gt;</code></td>\n</tr>\n<tr>\n<td>Content in Wrong Context</td>\n<td>Text/elements in table/select context</td>\n<td>Foster parent to appropriate location</td>\n<td>Text in <code>&lt;table&gt;</code> → move outside table</td>\n</tr>\n<tr>\n<td>Invalid Nesting</td>\n<td>Block elements inside inline elements</td>\n<td>Close inline element, reopen after block</td>\n<td><code>&lt;b&gt;&lt;div&gt;text&lt;/div&gt;&lt;/b&gt;</code> → restructure nesting</td>\n</tr>\n</tbody></table>\n<p>Character encoding detection and handling represents another critical error recovery area. While modern HTML should specify encoding via <code>&lt;meta charset=&quot;utf-8&quot;&gt;</code>, legacy content may omit encoding declarations or specify incorrect encodings. The parser must implement encoding detection heuristics, scanning the first few kilobytes of the document for encoding hints while being prepared to restart parsing if it discovers the encoding declaration indicates a different encoding than initially assumed.</p>\n<p>Entity decoding errors require graceful handling when encountering malformed entity references. Invalid named entities like <code>&amp;invalidname;</code> should be treated as literal text rather than causing parse failures. Incomplete numeric entities like <code>&amp;#</code> followed by end-of-input should similarly be treated as literal text. However, the parser must be careful not to over-interpret text that looks like entities but isn&#39;t intended as such.</p>\n<p><strong>Critical Edge Cases:</strong></p>\n<p>⚠️ <strong>Pitfall: Script and Style Content Processing</strong>\nContent inside <code>&lt;script&gt;</code> and <code>&lt;style&gt;</code> elements follows different parsing rules than normal HTML content. These elements can contain what appears to be HTML markup that should be treated as literal text rather than parsed tags. For example, <code>&lt;script&gt;if (x &lt; 5) document.write(&#39;&lt;div&gt;&#39;);&lt;/script&gt;</code> contains <code>&lt;</code> and <code>&lt;div&gt;</code> that must not be interpreted as HTML tags. The parser must switch to raw text mode when entering these elements and only exit when encountering the appropriate end tag.</p>\n<p>⚠️ <strong>Pitfall: Case Sensitivity in End Tag Matching</strong>\nWhile HTML tag names are case-insensitive, the end tag matching algorithm must handle cases where start and end tags use different capitalization. <code>&lt;DIV&gt;</code> should properly match <code>&lt;/div&gt;</code>. However, the comparison must be case-insensitive while preserving the original case in error messages and debugging output.</p>\n<p>⚠️ <strong>Pitfall: Attribute Duplication Handling</strong>\nHTML elements may contain duplicate attribute declarations like <code>&lt;div class=&quot;first&quot; class=&quot;second&quot;&gt;</code>. The HTML5 specification requires that only the first occurrence of each attribute name be preserved, with subsequent duplicates ignored. Failing to implement this correctly can cause confusion in later CSS matching and JavaScript DOM manipulation.</p>\n<p>The parser must also handle document fragments correctly when parsing HTML that doesn&#39;t represent a complete document. This occurs when parsing HTML snippets for insertion into existing documents via JavaScript&#39;s <code>innerHTML</code> property. Fragment parsing requires different error recovery rules and omits certain document-level structures like the implicit <code>&lt;html&gt;</code> and <code>&lt;body&gt;</code> elements that would normally be inserted.</p>\n<p><strong>Performance Considerations:</strong></p>\n<p>String handling represents the primary performance bottleneck in HTML parsing, as the parser must examine every character in the input while creating numerous temporary strings for tag names, attribute values, and text content. Efficient implementations minimize string copying by using string references or slices that point into the original input buffer where possible. However, entity decoding and case normalization may require string modifications that force copying.</p>\n<p>Memory management requires careful attention to avoid creating excessive temporary allocations during parsing. The open element stack typically contains only a few dozen elements even for complex documents, but naive implementations might create unnecessary intermediate collections or duplicate node references. Using arena allocation or object pooling for DOM nodes can significantly improve performance for applications that parse many documents.</p>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>The HTML parser implementation requires careful attention to state management and error recovery while maintaining clean separation between tokenization and tree construction phases.</p>\n<p><strong>Technology Recommendations:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>String Processing</td>\n<td><code>String</code> and <code>&amp;str</code> with manual parsing</td>\n<td><code>nom</code> parsing combinator library</td>\n</tr>\n<tr>\n<td>Character Encoding</td>\n<td>UTF-8 only with <code>std::str::from_utf8</code></td>\n<td><code>encoding_rs</code> for full encoding support</td>\n</tr>\n<tr>\n<td>Entity Decoding</td>\n<td>Manual lookup table with <code>HashMap&lt;&amp;str, char&gt;</code></td>\n<td><code>html-escape</code> crate for complete entity support</td>\n</tr>\n<tr>\n<td>Error Handling</td>\n<td><code>Result&lt;T, String&gt;</code> with string error messages</td>\n<td><code>thiserror</code> for structured error types</td>\n</tr>\n</tbody></table>\n<p><strong>Recommended File Structure:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>src/\n  html/\n    mod.rs                 ← public interface and re-exports\n    tokenizer.rs          ← HTML tokenization state machine\n    tree_builder.rs       ← DOM tree construction algorithm\n    entities.rs           ← character entity decoding\n    error_recovery.rs     ← malformed markup handling\n    tests/\n      tokenizer_tests.rs  ← tokenization test cases\n      parser_tests.rs     ← complete parsing test cases\n      malformed_tests.rs  ← error recovery test cases\n  dom/\n    mod.rs                ← DOM node types and tree operations\n    node.rs               ← DOMNode and related types\n    element.rs            ← ElementData and attribute handling\n    document.rs           ← Document root and metadata</code></pre></div>\n\n<p><strong>Infrastructure Starter Code:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/html/entities.rs - Complete entity decoding implementation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">collections</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">HashMap</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">lazy_static</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">lazy_static!</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    static</span><span style=\"color:#F97583\"> ref</span><span style=\"color:#79B8FF\"> HTML_ENTITIES</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">'</span><span style=\"color:#B392F0\">static</span><span style=\"color:#B392F0\"> str</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">char</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> m </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"amp\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">'&#x26;'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"lt\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">'&#x3C;'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"gt\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">'>'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"quot\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">'\"'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"apos\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\'</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"nbsp\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\u{00A0}</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Add complete HTML5 entity table here</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> decode_entity</span><span style=\"color:#E1E4E8\">(entity_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">char</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    HTML_ENTITIES</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">get</span><span style=\"color:#E1E4E8\">(entity_name)</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">copied</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> decode_numeric_entity</span><span style=\"color:#E1E4E8\">(entity_text</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">char</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> entity_text</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">starts_with</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'#'</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> number_part </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">entity_text[</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\">];</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> number_part</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">starts_with</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'x'</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">||</span><span style=\"color:#E1E4E8\"> number_part</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">starts_with</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'X'</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // Hexadecimal numeric entity</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            u32</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">number_part[</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">ok</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">and_then</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">code</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">char</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_u32</span><span style=\"color:#E1E4E8\">(code))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // Decimal numeric entity</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            number_part</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">u32</span><span style=\"color:#E1E4E8\">>()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">ok</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">and_then</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">code</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">char</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_u32</span><span style=\"color:#E1E4E8\">(code))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        None</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// src/html/error_recovery.rs - Error recovery utilities</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> ParseError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    UnexpectedEndTag</span><span style=\"color:#E1E4E8\"> { expected</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">, found</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    UnclosedElement</span><span style=\"color:#E1E4E8\"> { tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    InvalidNesting</span><span style=\"color:#E1E4E8\"> { parent</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">, child</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    MalformedEntity</span><span style=\"color:#E1E4E8\"> { entity_text</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> ErrorRecovery</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> errors</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> ErrorRecovery</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> { errors</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">() }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> report_error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, error</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ParseError</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">errors</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">push</span><span style=\"color:#E1E4E8\">(error);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> is_void_element</span><span style=\"color:#E1E4E8\">(tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        matches!</span><span style=\"color:#E1E4E8\">(tag_name</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_lowercase</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">as_str</span><span style=\"color:#E1E4E8\">(), </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"area\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> \"base\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> \"br\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> \"col\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> \"embed\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> \"hr\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#E1E4E8\"> </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"img\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> \"input\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> \"link\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> \"meta\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> \"param\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#E1E4E8\"> </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"source\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> \"track\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> \"wbr\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Core Logic Skeleton Code:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/html/tokenizer.rs - HTML tokenization state machine</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">dom</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">ElementData</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">html</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">entities</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{decode_entity, decode_numeric_entity};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> HTMLToken</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    StartTag</span><span style=\"color:#E1E4E8\"> { </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        attributes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        self_closing</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    EndTag</span><span style=\"color:#E1E4E8\"> { tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Text</span><span style=\"color:#E1E4E8\"> { content</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Comment</span><span style=\"color:#E1E4E8\"> { content</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Doctype</span><span style=\"color:#E1E4E8\"> { name</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">enum</span><span style=\"color:#B392F0\"> TokenizerState</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Data</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    TagOpen</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    TagName</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    BeforeAttributeName</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    AttributeName</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    AfterAttributeName</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    BeforeAttributeValue</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    AttributeValueQuoted</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    AttributeValueUnquoted</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    AfterAttributeValue</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Add more states as needed</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> HTMLTokenizer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    input</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    position</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    state</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> TokenizerState</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    current_token</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">HTMLToken</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Add more state fields as needed</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> HTMLTokenizer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(input</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Initialize tokenizer with input string and starting state</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Set position to 0 and state to TokenizerState::Data</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Initialize current_token to None</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> next_token</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">HTMLToken</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Enter main tokenization loop while position &#x3C; input.len()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Get current character at position</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Match on current state and character to determine transitions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Update state, advance position, accumulate token data</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Return completed token when state machine emits one</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use a loop with match statements for state transitions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Some characters trigger immediate token emission</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> current_char</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">char</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Return character at current position, None if at end</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> advance</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Increment position, handle bounds checking</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> emit_token</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, token</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HTMLToken</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> HTMLToken</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Store token for return</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Reset current token state</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Return to appropriate state for next token</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// src/html/tree_builder.rs - DOM tree construction</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">dom</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">DOMNodeType</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">ElementData</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">html</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">HTMLToken</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> TreeBuilder</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    document</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> DOMNodeHandle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    open_elements</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    current_node</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> DOMNodeHandle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> TreeBuilder</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Create document root node</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Initialize empty open elements stack</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Set document as current insertion point</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> process_token</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, token</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HTMLToken</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Match on token type (StartTag, EndTag, Text, Comment)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: For StartTag: create element, insert into tree, push to stack</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: For EndTag: find matching start tag, pop stack, handle errors</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: For Text: create text node, insert as child of current element</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Handle void elements specially (don't push to stack)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use helper methods for each token type</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> insert_element</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">, attributes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Create new ElementData with normalized tag name</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Create DOMNode with Element type and ElementData</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Insert as child of current insertion point</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Update parent/child relationships</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Return handle to new element</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> insert_text</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, content</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Check if content is only whitespace and handle appropriately</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Create text node with content</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Insert as child of current element</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Coalesce with previous text node if present</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> close_element</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Search open elements stack for matching start tag</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: If not found, report error and ignore end tag</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: If found, pop all elements up to and including match</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Update current insertion point to new stack top</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Handle implicit closures for intervening elements</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> finish</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> DOMNodeHandle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Close any remaining open elements</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Perform final validation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Return document root</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// src/html/mod.rs - Public parser interface</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> use</span><span style=\"color:#B392F0\"> tokenizer</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">HTMLTokenizer</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">HTMLToken</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> use</span><span style=\"color:#B392F0\"> tree_builder</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">TreeBuilder</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Parse HTML string into DOM tree</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> parse_html</span><span style=\"color:#E1E4E8\">(input</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">>> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Create tokenizer with input string</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Create tree builder</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Loop: get next token from tokenizer, process with tree builder</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Handle any parse errors that occur</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Return completed DOM tree or collected errors</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Collect errors rather than failing on first error</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    todo!</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Milestone Checkpoint:</strong></p>\n<p>After implementing the HTML parser, verify correct behavior:</p>\n<ol>\n<li><p><strong>Basic Parsing Test</strong>: Parse <code>&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&lt;p&gt;World&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</code> and verify the DOM tree has correct parent-child relationships with html→body→(h1,p) structure.</p>\n</li>\n<li><p><strong>Attribute Handling</strong>: Parse <code>&lt;div class=&quot;header&quot; id=&quot;main&quot; hidden&gt;</code> and verify attributes are extracted correctly with proper normalization.</p>\n</li>\n<li><p><strong>Error Recovery</strong>: Parse malformed HTML like <code>&lt;div&gt;&lt;p&gt;Text&lt;/div&gt;</code> and verify the parser implicitly closes the <code>&lt;p&gt;</code> element.</p>\n</li>\n<li><p><strong>Void Elements</strong>: Parse <code>&lt;img src=&quot;test.jpg&quot;&gt;&lt;br&gt;&lt;input type=&quot;text&quot;&gt;</code> and verify these elements don&#39;t expect closing tags.</p>\n</li>\n</ol>\n<p>Expected test output:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>✓ Basic parsing creates correct tree structure\n✓ Attributes extracted and normalized properly  \n✓ Malformed HTML handled with error recovery\n✓ Void elements processed without expecting end tags\n✓ Text content preserved and properly positioned</code></pre></div>\n\n<p><strong>Debugging Tips:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>How to Diagnose</th>\n<th>Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Missing elements in DOM tree</td>\n<td>Tokenizer not emitting start/end tag tokens</td>\n<td>Add debug prints to tokenizer state machine</td>\n<td>Check state transitions and character matching</td>\n</tr>\n<tr>\n<td>Incorrect parent-child relationships</td>\n<td>Tree builder stack management issues</td>\n<td>Print open element stack after each operation</td>\n<td>Verify push/pop operations match start/end tags</td>\n</tr>\n<tr>\n<td>Attributes not parsed</td>\n<td>Attribute state machine not working</td>\n<td>Log state transitions during attribute parsing</td>\n<td>Check quote handling and value accumulation</td>\n</tr>\n<tr>\n<td>Text content missing</td>\n<td>Text tokens not processed by tree builder</td>\n<td>Verify text token creation and insertion</td>\n<td>Ensure text nodes inserted at correct tree position</td>\n</tr>\n<tr>\n<td>Parser hangs on malformed HTML</td>\n<td>Infinite loop in error recovery</td>\n<td>Add iteration limits and timeout detection</td>\n<td>Implement proper error recovery fallbacks</td>\n</tr>\n</tbody></table>\n<h2 id=\"css-parser-and-style-system\">CSS Parser and Style System</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 2 (CSS Parser) - This section implements the CSS parsing and style resolution system that transforms CSS text into structured rules and computes the final styles for each DOM element through the cascade algorithm.</p>\n</blockquote>\n<p>The CSS parser and style system form the second critical stage in our browser&#39;s rendering pipeline. Think of this component as a <strong>sophisticated rule matching engine</strong> - like a legal system that must parse complex laws (CSS rules), determine which laws apply to each citizen (DOM element), resolve conflicts when multiple laws contradict each other (specificity and cascade), and finally produce a definitive ruling (computed style) that governs each citizen&#39;s appearance.</p>\n<p>This analogy captures the essence of CSS processing: we have a complex set of rules written in a domain-specific language, and we need to systematically apply these rules to a hierarchical document structure while resolving conflicts and inheritance relationships. The CSS specification defines precise algorithms for how this matching and resolution should work, making this one of the most algorithmically interesting parts of a browser engine.</p>\n<p>The CSS parser transforms textual stylesheets into structured data that can be efficiently queried during style resolution. Unlike HTML parsing, which builds a single tree structure, CSS parsing must handle a more complex grammar with selectors, combinators, property declarations, and various value types. The parser must also be robust enough to handle invalid CSS gracefully, following the CSS specification&#39;s error recovery rules.</p>\n<p>Once parsed, the style system implements the <strong>cascade algorithm</strong> - the heart of CSS that determines which styles actually apply to each element. The cascade considers multiple factors: selector specificity, source order, importance declarations, and inheritance relationships. This creates a sophisticated priority system that allows CSS to scale from simple styling to complex, layered design systems.</p>\n<h3 id=\"css-tokenization-and-rule-parsing\">CSS Tokenization and Rule Parsing</h3>\n<p>CSS tokenization breaks down stylesheet text into meaningful tokens that can be assembled into selectors, properties, and values. Think of the CSS tokenizer as a <strong>specialized scanner</strong> reading through a technical manual - it needs to recognize different types of content like chapter headings (selectors), instruction steps (declarations), and reference materials (values) while understanding the punctuation and formatting that gives structure to the document.</p>\n<p>The tokenization process must handle CSS&#39;s diverse syntax elements: identifiers, strings, numbers with units, delimiters, functions, and special characters. Unlike HTML tokenization, which primarily deals with angle brackets and text content, CSS tokenization must recognize a much richer vocabulary of token types and understand context-sensitive parsing rules.</p>\n<blockquote>\n<p><strong>Decision: Token-Based CSS Parser Architecture</strong></p>\n<ul>\n<li><strong>Context</strong>: CSS has complex grammar with nested structures, multiple value types, and error recovery requirements</li>\n<li><strong>Options Considered</strong>: <ol>\n<li>Single-pass parser that builds rules directly from text</li>\n<li>Two-phase tokenizer + parser approach</li>\n<li>Parser combinator library</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Two-phase tokenizer + parser approach</li>\n<li><strong>Rationale</strong>: Separates lexical analysis from grammatical analysis, making each phase simpler to implement and debug. Allows for better error recovery and easier testing of individual phases.</li>\n<li><strong>Consequences</strong>: Requires maintaining token stream state but provides cleaner separation of concerns and more robust error handling</li>\n</ul>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Parser Component</th>\n<th>Responsibility</th>\n<th>Input</th>\n<th>Output</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>CSS Tokenizer</td>\n<td>Lexical analysis of CSS text</td>\n<td>Raw CSS string</td>\n<td>Stream of <code>CSSToken</code> objects</td>\n</tr>\n<tr>\n<td>Selector Parser</td>\n<td>Parses selector syntax and combinators</td>\n<td>Token stream starting with selector</td>\n<td><code>Selector</code> structure with specificity</td>\n</tr>\n<tr>\n<td>Declaration Parser</td>\n<td>Parses property-value pairs</td>\n<td>Token stream for declaration block</td>\n<td>Vec of <code>Declaration</code> objects</td>\n</tr>\n<tr>\n<td>Value Parser</td>\n<td>Parses CSS values with type checking</td>\n<td>Token stream for property value</td>\n<td>Typed <code>CSSValue</code> variant</td>\n</tr>\n<tr>\n<td>Rule Builder</td>\n<td>Assembles complete CSS rules</td>\n<td>Parsed components</td>\n<td><code>CSSRule</code> with computed specificity</td>\n</tr>\n</tbody></table>\n<p>The tokenizer implements a state machine that recognizes CSS tokens according to the CSS Syntax specification. The tokenizer must handle several challenging aspects of CSS syntax: strings can contain escaped characters, comments can appear almost anywhere, and numbers can have various unit suffixes that change their semantic meaning.</p>\n<p><strong>CSS Token Types and Recognition:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Token Type</th>\n<th>Pattern</th>\n<th>Example</th>\n<th>Parser Action</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Identifier</td>\n<td>Letter followed by letters/digits/hyphens</td>\n<td><code>margin-top</code>, <code>body</code></td>\n<td>Used for property names, element selectors</td>\n</tr>\n<tr>\n<td>String</td>\n<td>Text enclosed in quotes with escape handling</td>\n<td><code>&quot;Arial&quot;</code>, <code>&#39;12px&#39;</code></td>\n<td>Preserves content, processes escape sequences</td>\n</tr>\n<tr>\n<td>Hash</td>\n<td><code>#</code> followed by identifier characters</td>\n<td><code>#header</code>, <code>#ff0000</code></td>\n<td>Creates ID selector or color value</td>\n</tr>\n<tr>\n<td>Dimension</td>\n<td>Number followed by identifier unit</td>\n<td><code>12px</code>, <code>1.5em</code>, <code>100%</code></td>\n<td>Parses numeric value and unit separately</td>\n</tr>\n<tr>\n<td>Function</td>\n<td>Identifier followed by opening parenthesis</td>\n<td><code>rgb(</code>, <code>calc(</code></td>\n<td>Begins function value parsing</td>\n</tr>\n<tr>\n<td>Delimiter</td>\n<td>Single character punctuation</td>\n<td><code>{</code>, <code>}</code>, <code>;</code>, <code>,</code></td>\n<td>Structural parsing control</td>\n</tr>\n</tbody></table>\n<p>The selector parser handles CSS&#39;s rich selector syntax, including simple selectors, combinators, and compound selectors. Each selector type has different matching semantics and contributes differently to specificity calculations. The parser must correctly handle selector groups (comma-separated selectors) and complex selector chains with multiple combinators.</p>\n<p><strong>Selector Parsing Algorithm:</strong></p>\n<ol>\n<li><strong>Initialize parsing context</strong> with empty selector list and current combinator as descendant</li>\n<li><strong>Parse simple selector</strong> starting with type selector, universal selector, or attribute selector</li>\n<li><strong>Check for selector modifiers</strong> like class selectors (<code>.classname</code>) or ID selectors (<code>#idname</code>)</li>\n<li><strong>Accumulate modifiers</strong> until encountering combinator or end of selector</li>\n<li><strong>Process combinator</strong> if present (space for descendant, <code>&gt;</code> for child, <code>+</code> for adjacent sibling, <code>~</code> for general sibling)</li>\n<li><strong>Create selector node</strong> with parsed components and computed specificity</li>\n<li><strong>Continue parsing</strong> if more selector components remain in the chain</li>\n<li><strong>Handle selector groups</strong> by splitting on commas and parsing each selector independently</li>\n</ol>\n<blockquote>\n<p>The CSS specification defines selector parsing as a context-sensitive process where the meaning of certain characters depends on their position and surrounding tokens. For example, <code>&gt;</code> can be part of a selector combinator or part of a CSS custom property value.</p>\n</blockquote>\n<p><strong>Declaration Parsing and Property Validation:</strong></p>\n<p>Property declarations require careful parsing because CSS values have complex syntax rules that vary by property type. The parser must recognize different value types (lengths, colors, keywords, functions) and validate them against the expected syntax for each property.</p>\n<table>\n<thead>\n<tr>\n<th>Property Category</th>\n<th>Value Types</th>\n<th>Validation Rules</th>\n<th>Example</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Length Properties</td>\n<td>Dimension tokens with length units</td>\n<td>Must be positive for width/height</td>\n<td><code>width: 200px</code></td>\n</tr>\n<tr>\n<td>Color Properties</td>\n<td>Hex, RGB function, named colors</td>\n<td>Alpha values between 0-1</td>\n<td><code>color: rgb(255, 0, 0)</code></td>\n</tr>\n<tr>\n<td>Display Properties</td>\n<td>Keyword tokens from allowed set</td>\n<td>Must match CSS display specification</td>\n<td><code>display: block</code></td>\n</tr>\n<tr>\n<td>Font Properties</td>\n<td>Keywords, strings, dimension lists</td>\n<td>Font families require quotes if multi-word</td>\n<td><code>font-family: &quot;Times New Roman&quot;</code></td>\n</tr>\n<tr>\n<td>Box Model Properties</td>\n<td>Dimension, auto keyword, percentage</td>\n<td>Can use shorthand with 1-4 values</td>\n<td><code>margin: 10px 20px</code></td>\n</tr>\n</tbody></table>\n<p><strong>Error Recovery in CSS Parsing:</strong></p>\n<p>CSS parsing follows the principle of <strong>graceful degradation</strong> - invalid rules are ignored, but parsing continues for the rest of the stylesheet. This allows browsers to handle CSS written for newer specifications while maintaining backward compatibility.</p>\n<p>The parser implements several error recovery strategies:</p>\n<ol>\n<li><strong>Declaration-level recovery</strong>: If a property value is invalid, ignore just that declaration and continue parsing the next one</li>\n<li><strong>Rule-level recovery</strong>: If a selector is malformed, skip the entire rule block but continue with subsequent rules</li>\n<li><strong>Block-level recovery</strong>: If braces are unmatched, scan forward to find the next properly nested rule block</li>\n<li><strong>Tokenization recovery</strong>: If an unexpected character is encountered, treat it as a delimiter and continue tokenization</li>\n</ol>\n<h3 id=\"specificity-and-cascade-resolution\">Specificity and Cascade Resolution</h3>\n<p>CSS specificity and cascade resolution implement the core logic that determines which styles actually apply when multiple rules target the same element. Think of this process as a <strong>sophisticated arbitration system</strong> - like a court that must weigh different types of evidence, consider the authority of different witnesses, and apply precedent rules to reach a final judgment when multiple parties present conflicting claims.</p>\n<p>The cascade algorithm considers four key factors in order of precedence: origin and importance, specificity, source order, and inheritance. Each factor serves as a tie-breaker when the previous factors result in equal priority between competing rules.</p>\n<p><strong>CSS Cascade Priority Algorithm:</strong></p>\n<ol>\n<li><strong>Filter applicable rules</strong> by matching selectors against the target element and its ancestors</li>\n<li><strong>Group rules by origin</strong> (user-agent, author, user) and separate <code>!important</code> declarations</li>\n<li><strong>Apply origin precedence</strong>: user <code>!important</code> &gt; author <code>!important</code> &gt; author normal &gt; user normal &gt; user-agent</li>\n<li><strong>Calculate specificity</strong> for each applicable rule using the (inline, IDs, classes, elements) tuple</li>\n<li><strong>Sort rules by specificity</strong> with higher specificity values taking precedence</li>\n<li><strong>Apply source order</strong> as final tie-breaker, with later rules overriding earlier ones</li>\n<li><strong>Resolve inheritance</strong> for properties not explicitly set through the cascade</li>\n</ol>\n<blockquote>\n<p><strong>Decision: Four-Tuple Specificity Calculation</strong></p>\n<ul>\n<li><strong>Context</strong>: Need to implement CSS specificity algorithm that matches browser behavior exactly</li>\n<li><strong>Options Considered</strong>:<ol>\n<li>Single integer specificity score</li>\n<li>Three-component (ID, class, element) specificity</li>\n<li>Four-component (inline, ID, class, element) specificity as per CSS spec</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Four-component specificity matching CSS specification</li>\n<li><strong>Rationale</strong>: Ensures exact compliance with CSS specification and handles inline styles correctly. Prevents specificity overflow issues that can occur with integer scoring.</li>\n<li><strong>Consequences</strong>: Requires more complex comparison logic but guarantees spec-compliant behavior</li>\n</ul>\n</blockquote>\n<p><strong>Specificity Calculation Details:</strong></p>\n<p>The CSS specification defines specificity as a four-part value where each component is counted independently. This prevents lower-specificity selectors from &quot;overflowing&quot; into higher specificity categories, ensuring that a single ID selector always beats any number of class selectors.</p>\n<table>\n<thead>\n<tr>\n<th>Specificity Component</th>\n<th>Incremented By</th>\n<th>Examples</th>\n<th>Weight</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Inline Styles</td>\n<td><code>style</code> attribute on element</td>\n<td><code>&lt;div style=&quot;color: red&quot;&gt;</code></td>\n<td>Highest</td>\n</tr>\n<tr>\n<td>ID Selectors</td>\n<td><code>#identifier</code> in selector</td>\n<td><code>#header</code>, <code>div#main</code></td>\n<td>High</td>\n</tr>\n<tr>\n<td>Class/Attribute/Pseudo</td>\n<td><code>.class</code>, <code>[attr]</code>, <code>:hover</code></td>\n<td><code>.nav</code>, <code>[type=&quot;text&quot;]</code>, <code>:hover</code></td>\n<td>Medium</td>\n</tr>\n<tr>\n<td>Element/Pseudo-Element</td>\n<td>Element names, <code>::before</code></td>\n<td><code>div</code>, <code>p::first-line</code></td>\n<td>Low</td>\n</tr>\n</tbody></table>\n<p><strong>Specificity Comparison Algorithm:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>To compare two specificity values S1 and S2:\n1. If S1.inline ≠ S2.inline, return the one with higher inline count\n2. If S1.ids ≠ S2.ids, return the one with higher ID count\n3. If S1.classes ≠ S2.classes, return the one with higher class count\n4. If S1.elements ≠ S2.elements, return the one with higher element count\n5. If all components equal, compare source order (later wins)</code></pre></div>\n\n<p><strong>Cascade Resolution Implementation:</strong></p>\n<p>The cascade resolver must efficiently match CSS rules against DOM elements and apply the precedence rules. The implementation uses several optimization strategies to avoid recalculating styles unnecessarily.</p>\n<table>\n<thead>\n<tr>\n<th>Resolution Phase</th>\n<th>Algorithm</th>\n<th>Complexity</th>\n<th>Optimization Strategy</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Rule Matching</td>\n<td>Test each rule&#39;s selector against element</td>\n<td>O(rules × selector_complexity)</td>\n<td>Selector indexing by key components</td>\n</tr>\n<tr>\n<td>Specificity Sorting</td>\n<td>Sort applicable rules by precedence</td>\n<td>O(applicable_rules × log(n))</td>\n<td>Cache computed specificity values</td>\n</tr>\n<tr>\n<td>Property Resolution</td>\n<td>Apply winning rule for each property</td>\n<td>O(properties × applicable_rules)</td>\n<td>Early termination on property match</td>\n</tr>\n<tr>\n<td>Inheritance</td>\n<td>Copy inherited values from parent</td>\n<td>O(inherited_properties)</td>\n<td>Mark inheritable properties statically</td>\n</tr>\n</tbody></table>\n<p><strong>Handling CSS Important Declarations:</strong></p>\n<p>The <code>!important</code> declaration creates a parallel cascade where important declarations are considered separately from normal declarations. This effectively creates two cascade layers that must be resolved independently.</p>\n<ol>\n<li><strong>Separate important and normal declarations</strong> into different collections during rule matching</li>\n<li><strong>Apply cascade algorithm to important declarations first</strong> using the same specificity and source order rules</li>\n<li><strong>Apply cascade algorithm to normal declarations</strong> for any properties not set by important declarations</li>\n<li><strong>Merge the results</strong> with important declarations taking precedence over normal declarations regardless of specificity</li>\n</ol>\n<blockquote>\n<p>⚠️ <strong>Pitfall: Incorrect Important Declaration Handling</strong>\nA common mistake is treating <code>!important</code> as simply increasing specificity rather than creating a separate cascade layer. This leads to incorrect behavior where a high-specificity normal declaration can override a low-specificity important declaration, violating the CSS specification.</p>\n</blockquote>\n<h3 id=\"style-matching-and-computed-values\">Style Matching and Computed Values</h3>\n<p>Style matching and computed value resolution represent the final stage of the CSS processing pipeline, where abstract CSS rules are transformed into concrete values that the layout engine can use. Think of this process as a <strong>specialized translator</strong> that converts legal documents (CSS rules) written in formal legal language into practical instructions (computed styles) that workers (the layout engine) can follow to build something concrete.</p>\n<p>This translation process involves several complex steps: determining which rules apply to each element, resolving relative values into absolute values, computing inherited properties, and handling special cases like auto values and percentage calculations that depend on layout context.</p>\n<p><strong>Style Matching Algorithm:</strong></p>\n<p>The style matching algorithm determines which CSS rules apply to a given DOM element by testing each rule&#39;s selector against the element and its position in the document tree. The matching process must consider various selector types and combinators while maintaining good performance even for large documents.</p>\n<table>\n<thead>\n<tr>\n<th>Matching Phase</th>\n<th>Process</th>\n<th>Performance Considerations</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Fast Reject</td>\n<td>Check if selector could possibly match</td>\n<td>Use bloom filters for class/ID rejection</td>\n</tr>\n<tr>\n<td>Simple Selector Match</td>\n<td>Test element name, classes, IDs, attributes</td>\n<td>Cache element metadata for repeated access</td>\n</tr>\n<tr>\n<td>Combinator Resolution</td>\n<td>Walk DOM tree for descendant/child relationships</td>\n<td>Implement iterative traversal to avoid stack overflow</td>\n</tr>\n<tr>\n<td>Pseudo-Class Evaluation</td>\n<td>Check dynamic states like <code>:hover</code>, <code>:focus</code></td>\n<td>Maintain state change tracking for efficient updates</td>\n</tr>\n</tbody></table>\n<p><strong>Selector Matching Implementation Details:</strong></p>\n<p>Different selector types require different matching strategies. Simple selectors like element types and classes can be checked directly against the target element, while combinator selectors require traversing the DOM tree to find relationships between elements.</p>\n<ol>\n<li><strong>Universal Selector (<code>*</code>)</strong>: Always matches - return true immediately</li>\n<li><strong>Type Selector (<code>div</code>)</strong>: Compare selector tag name with element&#39;s tag name (case-insensitive for HTML)</li>\n<li><strong>Class Selector (<code>.classname</code>)</strong>: Check if element&#39;s class list contains the specified class</li>\n<li><strong>ID Selector (<code>#idvalue</code>)</strong>: Compare selector ID with element&#39;s ID attribute (case-sensitive)</li>\n<li><strong>Attribute Selector (<code>[attr=value]</code>)</strong>: Check element attributes with various matching operators</li>\n<li><strong>Descendant Combinator (<code> </code>)</strong>: Walk up ancestor chain looking for matching ancestor element</li>\n<li><strong>Child Combinator (<code>&gt;</code>)</strong>: Check immediate parent element for selector match</li>\n<li><strong>Adjacent Sibling (<code>+</code>)</strong>: Check immediately preceding sibling element</li>\n<li><strong>General Sibling (<code>~</code>)</strong>: Check all preceding siblings for matching element</li>\n</ol>\n<p><strong>Computed Style Resolution:</strong></p>\n<p>Once the cascade determines which CSS declarations apply to an element, the style system must resolve these declared values into computed values that the layout engine can use. This resolution process handles relative units, inheritance, and default values.</p>\n<table>\n<thead>\n<tr>\n<th>Value Resolution Type</th>\n<th>Process</th>\n<th>Example</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Absolute Length</td>\n<td>Direct conversion to pixels</td>\n<td><code>12px</code> → <code>12.0</code></td>\n</tr>\n<tr>\n<td>Relative Length</td>\n<td>Calculate based on context</td>\n<td><code>1.2em</code> → <code>19.2px</code> (if font-size is 16px)</td>\n</tr>\n<tr>\n<td>Percentage</td>\n<td>Store percentage for layout-time resolution</td>\n<td><code>50%</code> → <code>Percent(50.0)</code></td>\n</tr>\n<tr>\n<td>Keywords</td>\n<td>Map to specific values or behaviors</td>\n<td><code>auto</code> → <code>Auto</code>, <code>bold</code> → <code>FontWeight::Bold</code></td>\n</tr>\n<tr>\n<td>Inheritance</td>\n<td>Copy computed value from parent</td>\n<td><code>color: inherit</code> → parent&#39;s computed color</td>\n</tr>\n</tbody></table>\n<p><strong>Font and Text Property Resolution:</strong></p>\n<p>Font-related properties require special handling because they establish the context for <code>em</code> unit calculations and affect text layout. Font size resolution must happen early in the computed style process because other properties may depend on the computed font size.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Font Size Resolution Algorithm:\n1. If font-size is specified in absolute units (px, pt), use that value directly\n2. If font-size uses relative units (em, rem), compute based on parent or root font size\n3. If font-size is a keyword (small, medium, large), map to predetermined pixel values\n4. If font-size is a percentage, calculate as percentage of parent's computed font size\n5. Store computed font size for use in resolving other properties</code></pre></div>\n\n<p><strong>Color Value Resolution:</strong></p>\n<p>Color properties support multiple value formats that must be normalized into a consistent internal representation. The color resolution process handles named colors, hexadecimal values, RGB/RGBA functions, and HSL/HSLA functions.</p>\n<table>\n<thead>\n<tr>\n<th>Color Format</th>\n<th>Parsing Process</th>\n<th>Internal Representation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Named Colors</td>\n<td>Lookup in predefined color table</td>\n<td><code>Color { r: u8, g: u8, b: u8, a: u8 }</code></td>\n</tr>\n<tr>\n<td>Hex Colors</td>\n<td>Parse hex digits and convert to RGB</td>\n<td><code>#FF0000</code> → <code>Color { r: 255, g: 0, b: 0, a: 255 }</code></td>\n</tr>\n<tr>\n<td>RGB Function</td>\n<td>Extract numeric parameters</td>\n<td><code>rgb(255, 0, 0)</code> → <code>Color { r: 255, g: 0, b: 0, a: 255 }</code></td>\n</tr>\n<tr>\n<td>RGBA Function</td>\n<td>Extract RGB + alpha parameter</td>\n<td><code>rgba(255, 0, 0, 0.5)</code> → <code>Color { r: 255, g: 0, b: 0, a: 127 }</code></td>\n</tr>\n</tbody></table>\n<p><strong>Box Model Property Resolution:</strong></p>\n<p>Box model properties (margin, border, padding) support shorthand syntax where 1-4 values can specify all four sides of the box. The resolution process must expand shorthand properties and resolve each side independently.</p>\n<p><strong>Shorthand Expansion Rules:</strong></p>\n<ul>\n<li><strong>One value</strong>: Apply to all four sides (<code>margin: 10px</code> → top: 10px, right: 10px, bottom: 10px, left: 10px)</li>\n<li><strong>Two values</strong>: First applies to top/bottom, second to left/right (<code>margin: 10px 20px</code> → top: 10px, right: 20px, bottom: 10px, left: 20px)</li>\n<li><strong>Three values</strong>: Top, left/right, bottom (<code>margin: 10px 20px 30px</code> → top: 10px, right: 20px, bottom: 30px, left: 20px)</li>\n<li><strong>Four values</strong>: Top, right, bottom, left in clockwise order (<code>margin: 10px 20px 30px 40px</code>)</li>\n</ul>\n<p><strong>Property Inheritance Implementation:</strong></p>\n<p>CSS inheritance allows child elements to automatically receive certain property values from their parent elements. The style resolution system must implement inheritance for inheritable properties while ensuring non-inheritable properties use their default values.</p>\n<table>\n<thead>\n<tr>\n<th>Property Category</th>\n<th>Inheritance Behavior</th>\n<th>Examples</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Inheritable</td>\n<td>Child inherits parent&#39;s computed value</td>\n<td><code>color</code>, <code>font-family</code>, <code>line-height</code></td>\n</tr>\n<tr>\n<td>Non-Inheritable</td>\n<td>Child uses initial/default value</td>\n<td><code>margin</code>, <code>padding</code>, <code>border</code>, <code>width</code></td>\n</tr>\n<tr>\n<td>Explicit Inherit</td>\n<td>Any property can be forced to inherit</td>\n<td><code>margin: inherit</code> forces margin inheritance</td>\n</tr>\n<tr>\n<td>Initial</td>\n<td>Reset to specification default</td>\n<td><code>color: initial</code> resets to black</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>⚠️ <strong>Pitfall: Inheritance vs. Cascade Confusion</strong>\nBeginners often confuse inheritance (automatic copying of certain properties from parent to child) with the cascade (resolution of conflicting rules targeting the same element). Inheritance happens after the cascade resolves what properties apply to the current element. A child element can have its own CSS rules that override inherited values through the normal cascade process.</p>\n</blockquote>\n<p><strong>Style Invalidation and Change Propagation:</strong></p>\n<p>When DOM elements are modified or CSS rules are added/removed, the style system must efficiently update computed styles without recalculating everything from scratch. This requires tracking dependencies between elements and their computed styles.</p>\n<p><strong>Change Propagation Algorithm:</strong></p>\n<ol>\n<li><strong>Identify changed elements</strong> that need style recalculation due to DOM modifications or dynamic state changes</li>\n<li><strong>Mark descendants for inheritance updates</strong> when inheritable properties change on an element</li>\n<li><strong>Mark elements for selector re-matching</strong> when DOM structure changes affect combinator selectors</li>\n<li><strong>Batch style updates</strong> to avoid redundant calculations during multiple rapid changes</li>\n<li><strong>Invalidate layout</strong> for elements whose computed styles affect geometric properties</li>\n</ol>\n<p><img src=\"/api/project/build-browser/architecture-doc/asset?path=diagrams%2Fcss-cascade-sequence.svg\" alt=\"CSS Cascade Resolution Sequence\"></p>\n<p><strong>Common Pitfalls in Style Resolution:</strong></p>\n<p>⚠️ <strong>Pitfall: Incorrect Relative Unit Context</strong>\nWhen resolving <code>em</code> units, developers often use the wrong font-size context. The <code>em</code> unit should always resolve against the current element&#39;s computed font-size, not its parent&#39;s font-size. This means font-size must be computed before other properties that might use <code>em</code> units.</p>\n<p>⚠️ <strong>Pitfall: Percentage Resolution Timing</strong>\nPercentage values cannot always be resolved during style computation because they depend on layout information (like the parent element&#39;s computed dimensions). These values must be stored as percentages and resolved during layout, not during style computation.</p>\n<p>⚠️ <strong>Pitfall: Specificity Integer Overflow</strong>\nImplementing specificity as a single integer with multipliers (like <code>ids * 100 + classes * 10 + elements</code>) can lead to overflow problems where many low-specificity selectors can override high-specificity selectors. Always use separate counters for each specificity component.</p>\n<p>⚠️ <strong>Pitfall: Important Declaration Scope</strong>\nThe <code>!important</code> declaration applies only to the specific property where it appears, not to the entire rule. When parsing <code>color: red !important; background: blue;</code>, only the color declaration is important, not the background declaration.</p>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>The CSS parser and style system implementation requires balancing parsing correctness with performance considerations. This section provides concrete implementation strategies and starter code to build a robust CSS processing pipeline.</p>\n<p><strong>A. Technology Recommendations:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>CSS Tokenizer</td>\n<td>Hand-written state machine</td>\n<td>Lexer generator (nom, pest)</td>\n</tr>\n<tr>\n<td>Selector Parsing</td>\n<td>Recursive descent parser</td>\n<td>Parser combinator library</td>\n</tr>\n<tr>\n<td>Value Parsing</td>\n<td>Pattern matching on token types</td>\n<td>Typed value parser with validation</td>\n</tr>\n<tr>\n<td>Color Handling</td>\n<td>Basic RGB struct</td>\n<td>Full color space support with conversions</td>\n</tr>\n<tr>\n<td>String Handling</td>\n<td>Standard string operations</td>\n<td>Interned strings for performance</td>\n</tr>\n<tr>\n<td>Rule Storage</td>\n<td>Vec of rules with linear search</td>\n<td>Indexed rule storage with bloom filters</td>\n</tr>\n</tbody></table>\n<p><strong>B. Recommended File Structure:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>browser-engine/\n├── src/\n│   ├── css/\n│   │   ├── mod.rs              ← Public interface and re-exports\n│   │   ├── tokenizer.rs        ← CSS tokenization state machine\n│   │   ├── parser.rs           ← Rule and selector parsing\n│   │   ├── values.rs           ← CSS value types and parsing\n│   │   ├── specificity.rs      ← Specificity calculation\n│   │   ├── cascade.rs          ← Cascade algorithm implementation\n│   │   ├── computed.rs         ← Computed style resolution\n│   │   └── matching.rs         ← Selector matching algorithms\n│   ├── style/\n│   │   ├── mod.rs              ← Style system public interface\n│   │   ├── resolver.rs         ← Main StyleResolver implementation\n│   │   └── inheritance.rs      ← Property inheritance logic\n│   └── types.rs                ← Core types shared across modules</code></pre></div>\n\n<p><strong>C. Infrastructure Starter Code:</strong></p>\n<p>Here&#39;s a complete CSS tokenizer implementation that handles the lexical analysis phase:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// css/tokenizer.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">str</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Chars</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">iter</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Peekable</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> CSSToken</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Identifier</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    String</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Hash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">),           </span><span style=\"color:#6A737D\">// #identifier or #color</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Dimension</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">), </span><span style=\"color:#6A737D\">// number + unit (12px, 1.5em)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Number</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Percentage</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Function</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">),       </span><span style=\"color:#6A737D\">// identifier followed by (</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    LeftBrace</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    RightBrace</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    LeftParen</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    RightParen</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Semicolon</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Colon</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Comma</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Whitespace</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EOF</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> CSSTokenizer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    input</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Peekable</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Chars</span><span style=\"color:#E1E4E8\">&#x3C;'</span><span style=\"color:#B392F0\">static</span><span style=\"color:#E1E4E8\">>>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    position</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> CSSTokenizer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(css</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">'</span><span style=\"color:#B392F0\">static</span><span style=\"color:#B392F0\"> str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            input</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> css</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">chars</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peekable</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            position</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> next_token</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> CSSToken</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">skip_whitespace_and_comments</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peek_char</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            None</span><span style=\"color:#F97583\"> =></span><span style=\"color:#B392F0\"> CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#79B8FF\">EOF</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Some</span><span style=\"color:#E1E4E8\">(ch) </span><span style=\"color:#F97583\">=></span><span style=\"color:#F97583\"> match</span><span style=\"color:#E1E4E8\"> ch {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                '{'</span><span style=\"color:#F97583\"> =></span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">(); </span><span style=\"color:#B392F0\">CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">LeftBrace</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                '}'</span><span style=\"color:#F97583\"> =></span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">(); </span><span style=\"color:#B392F0\">CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">RightBrace</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                '('</span><span style=\"color:#F97583\"> =></span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">(); </span><span style=\"color:#B392F0\">CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">LeftParen</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                ')'</span><span style=\"color:#F97583\"> =></span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">(); </span><span style=\"color:#B392F0\">CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">RightParen</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                ';'</span><span style=\"color:#F97583\"> =></span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">(); </span><span style=\"color:#B392F0\">CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Semicolon</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                ':'</span><span style=\"color:#F97583\"> =></span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">(); </span><span style=\"color:#B392F0\">CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Colon</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                ','</span><span style=\"color:#F97583\"> =></span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">(); </span><span style=\"color:#B392F0\">CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Comma</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                '#'</span><span style=\"color:#F97583\"> =></span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_hash</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                '\"'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> '</span><span style=\"color:#79B8FF\">\\'</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#F97583\"> =></span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_string</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                '0'</span><span style=\"color:#F97583\">..=</span><span style=\"color:#9ECBFF\">'9'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> '.'</span><span style=\"color:#F97583\"> =></span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_numeric</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                '-'</span><span style=\"color:#F97583\"> if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_identifier_start</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">=></span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_identifier_or_function</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                _ </span><span style=\"color:#F97583\">if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_identifier_start</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">=></span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_identifier_or_function</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                _ </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                    // Unknown character - consume and continue</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">                    self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">                    self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">next_token</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> peek_char</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">char</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peek</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">copied</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> consume_char</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">char</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">next</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Some</span><span style=\"color:#E1E4E8\">(ch) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">                self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">position </span><span style=\"color:#F97583\">+=</span><span style=\"color:#E1E4E8\"> ch</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len_utf8</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                Some</span><span style=\"color:#E1E4E8\">(ch)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            None</span><span style=\"color:#F97583\"> =></span><span style=\"color:#B392F0\"> None</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> skip_whitespace_and_comments</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        while</span><span style=\"color:#F97583\"> let</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(ch) </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peek_char</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> ch</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_whitespace</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">                self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            } </span><span style=\"color:#F97583\">else</span><span style=\"color:#F97583\"> if</span><span style=\"color:#E1E4E8\"> ch </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> '/'</span><span style=\"color:#F97583\"> &#x26;&#x26;</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peek_ahead</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">==</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'*'</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">                self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">skip_comment</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                break</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> skip_comment</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Consume /*</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        while</span><span style=\"color:#F97583\"> let</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(ch) </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> ch </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> '*'</span><span style=\"color:#F97583\"> &#x26;&#x26;</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peek_char</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">==</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'/'</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">                self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">(); </span><span style=\"color:#6A737D\">// consume /</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                break</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> peek_ahead</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, n</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">char</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // This is a simplified implementation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // In practice, you'd want a more efficient lookahead buffer</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> chars</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">char</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">clone</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">take</span><span style=\"color:#E1E4E8\">(n </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\">)</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">collect</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        chars</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">get</span><span style=\"color:#E1E4E8\">(n)</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">copied</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> is_identifier_start</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peek_char</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Some</span><span style=\"color:#E1E4E8\">(ch) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> ch</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_alphabetic</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">||</span><span style=\"color:#E1E4E8\"> ch </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> '_'</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> ch </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> '-'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            None</span><span style=\"color:#F97583\"> =></span><span style=\"color:#79B8FF\"> false</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> consume_identifier_or_function</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> CSSToken</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> identifier </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        while</span><span style=\"color:#F97583\"> let</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(ch) </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peek_char</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> ch</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_alphanumeric</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">||</span><span style=\"color:#E1E4E8\"> ch </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> '-'</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> ch </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> '_'</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                identifier</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">push</span><span style=\"color:#E1E4E8\">(ch);</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">                self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                break</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Check if this is a function (followed by opening paren)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peek_char</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">==</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'('</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Function</span><span style=\"color:#E1E4E8\">(identifier)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Identifier</span><span style=\"color:#E1E4E8\">(identifier)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> consume_hash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> CSSToken</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">(); </span><span style=\"color:#6A737D\">// consume #</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> hash_value </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        while</span><span style=\"color:#F97583\"> let</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(ch) </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peek_char</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> ch</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_alphanumeric</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">||</span><span style=\"color:#E1E4E8\"> ch </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> '-'</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> ch </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> '_'</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                hash_value</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">push</span><span style=\"color:#E1E4E8\">(ch);</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">                self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                break</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Hash</span><span style=\"color:#E1E4E8\">(hash_value)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> consume_string</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> CSSToken</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> quote_char </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">unwrap</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> string_value </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        while</span><span style=\"color:#F97583\"> let</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(ch) </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> ch </span><span style=\"color:#F97583\">==</span><span style=\"color:#E1E4E8\"> quote_char {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                break</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            } </span><span style=\"color:#F97583\">else</span><span style=\"color:#F97583\"> if</span><span style=\"color:#E1E4E8\"> ch </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> '</span><span style=\"color:#79B8FF\">\\\\</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // Handle escape sequences</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                if</span><span style=\"color:#F97583\"> let</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(escaped) </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    string_value</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">push</span><span style=\"color:#E1E4E8\">(escaped);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                string_value</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">push</span><span style=\"color:#E1E4E8\">(ch);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">(string_value)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> consume_numeric</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> CSSToken</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> number_str </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Consume digits and decimal point</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        while</span><span style=\"color:#F97583\"> let</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(ch) </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peek_char</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> ch</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_numeric</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">||</span><span style=\"color:#E1E4E8\"> ch </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> '.'</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                number_str</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">push</span><span style=\"color:#E1E4E8\">(ch);</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">                self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                break</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> number</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#F97583\"> =</span><span style=\"color:#E1E4E8\"> number_str</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">unwrap_or</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0.0</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Check for percentage</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peek_char</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">==</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'%'</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">            self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Percentage</span><span style=\"color:#E1E4E8\">(number);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Check for unit</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_identifier_start</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> unit </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            while</span><span style=\"color:#F97583\"> let</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(ch) </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">peek_char</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                if</span><span style=\"color:#E1E4E8\"> ch</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_alphabetic</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    unit</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">push</span><span style=\"color:#E1E4E8\">(ch);</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">                    self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">consume_char</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                    break</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Dimension</span><span style=\"color:#E1E4E8\">(number, unit)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            CSSToken</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Number</span><span style=\"color:#E1E4E8\">(number)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>D. Core Logic Skeleton Code:</strong></p>\n<p>Here are the key interfaces that learners should implement:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// css/parser.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">types</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">CSSRule</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Selector</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Declaration</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Specificity</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> CSSParser</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    tokens</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">CSSToken</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    position</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> CSSParser</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Parses a complete CSS stylesheet into a collection of rules</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Returns a Result with parsed rules or parsing errors</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> parse_stylesheet</span><span style=\"color:#E1E4E8\">(css</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">CSSRule</span><span style=\"color:#E1E4E8\">>, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Create tokenizer and extract all tokens from CSS text</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Initialize parser with token stream</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Parse rules until end of token stream</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Handle parsing errors gracefully by skipping invalid rules</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Return collected valid rules</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement stylesheet parsing\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Parses a single CSS rule (selector + declaration block)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Advances parser position and returns parsed rule with computed specificity</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> parse_rule</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">CSSRule</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Parse selector using parse_selector method</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Expect opening brace for declaration block</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Parse declarations until closing brace</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Create CSSRule with selector, declarations, and specificity</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Handle malformed rules by returning error</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement rule parsing\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Parses a CSS selector with support for combinators and specificity calculation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Returns Selector enum variant with computed specificity</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> parse_selector</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Selector</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Parse simple selector (type, class, ID, universal)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Check for additional selectors (compound selectors)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Handle combinators (space, >, +, ~)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Create appropriate Selector variant</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Compute and store specificity for this selector</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement selector parsing\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Parses property declarations within a rule block</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Returns Vec of Declaration objects with parsed property-value pairs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> parse_declarations</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Declaration</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Loop until closing brace is encountered</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Parse property name (expect identifier token)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Expect colon separator</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Parse property value using parse_value method</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Check for !important declaration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Expect semicolon separator (optional for last declaration)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Handle malformed declarations by skipping to next semicolon</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement declaration parsing\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Parses CSS values with appropriate type checking</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Returns typed CSSValue variant based on property and token types</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> parse_value</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, property</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Look at current token type</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Match against expected value types for this property</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Parse dimensions with unit conversion</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Parse colors in various formats (hex, rgb, named)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Parse keywords and validate against property allowed values</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Handle function values like rgb(), calc()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Return appropriate CSSValue variant</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement value parsing\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// css/specificity.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">types</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Selector</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Specificity</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Specificity</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Calculates CSS specificity according to the specification</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Returns four-component specificity tuple (inline, ids, classes, elements)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> calculate</span><span style=\"color:#E1E4E8\">(selector</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Selector</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Specificity</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Initialize counters for each specificity component</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Traverse selector structure (handle compound selectors)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Count inline styles (will be 1 for style attribute, 0 for stylesheet rules)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Count ID selectors in the selector</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Count class selectors, attribute selectors, and pseudo-classes</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Count element selectors and pseudo-elements</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Return Specificity struct with computed counts</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement specificity calculation\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Compares two specificity values according to CSS precedence rules</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Returns Ordering indicating which specificity has higher precedence</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> compare</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, other</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Specificity</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">cmp</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Ordering</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Compare inline counts first</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Compare ID counts if inline counts are equal</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Compare class counts if ID counts are equal</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Compare element counts if class counts are equal</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Return Equal if all components are equal</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement specificity comparison\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// style/resolver.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">types</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">StyleResolver</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">CSSRule</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> StyleResolver</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Main entry point for style resolution - computes styles for entire DOM tree</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Applies cascade algorithm and inheritance to determine final computed styles</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> resolve_styles</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, root</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> ComputedStyle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Start with root element and empty inherited styles</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Resolve styles for root element using resolve_element_style</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Recursively resolve styles for all child elements</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Pass computed styles down as inherited values for children</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Handle special cases like replaced elements and display:none</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement style resolution\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Resolves computed style for a single element using the cascade algorithm</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Matches CSS rules, applies specificity, and resolves final property values</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> resolve_element_style</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, element</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">, inherited</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> ComputedStyle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Find all CSS rules that match this element</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Filter rules by media queries and other conditional rules</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Sort matching rules by cascade priority (origin, specificity, source order)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Apply winning rule for each CSS property</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Resolve relative values (em, %, inherit) to absolute values</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Apply inheritance for properties not explicitly set</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Return ComputedStyle with all properties resolved</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement element style resolution\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Tests if a CSS rule matches a given DOM element</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Implements selector matching algorithm with support for all selector types</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> matches_element</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, selector</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Selector</span><span style=\"color:#E1E4E8\">, element</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Handle different selector types (Universal, Type, Class, ID, etc.)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Implement combinator logic (descendant, child, sibling)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Check attribute selectors with various matching operators</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Evaluate pseudo-classes like :hover, :focus, :first-child</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Walk DOM tree as needed for combinator selectors</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Return true if selector matches, false otherwise</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement selector matching\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>E. Language-Specific Hints:</strong></p>\n<ul>\n<li><strong>Use <code>nom</code> crate for robust parsing</strong>: While the starter code shows manual parsing, consider using the <code>nom</code> parser combinator library for production CSS parsing</li>\n<li><strong>Intern strings for performance</strong>: CSS parsing creates many duplicate strings (property names, common values). Use string interning to reduce memory usage</li>\n<li><strong>Use <code>SmallVec</code> for selector components</strong>: Most selectors have few components, so <code>SmallVec&lt;[Component; 4]&gt;</code> avoids heap allocation for simple selectors</li>\n<li><strong>Cache computed specificity</strong>: Specificity calculation can be expensive for complex selectors. Cache the result in the Selector structure</li>\n<li><strong>Use <code>HashMap</code> for efficient rule matching</strong>: Index rules by their key selector components (tag names, classes, IDs) for faster matching</li>\n</ul>\n<p><strong>F. Milestone Checkpoint:</strong></p>\n<p>After implementing the CSS parser and style system, verify correct behavior:</p>\n<p><strong>Test Command:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> css_parsing</span><span style=\"color:#79B8FF\"> --</span><span style=\"color:#79B8FF\"> --nocapture</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> style_resolution</span><span style=\"color:#79B8FF\"> --</span><span style=\"color:#79B8FF\"> --nocapture</span></span></code></pre></div>\n\n<p><strong>Expected Behavior:</strong></p>\n<ul>\n<li>Parse basic CSS rules with type, class, and ID selectors</li>\n<li>Calculate specificity correctly: <code>#header .nav li</code> should have specificity (0, 1, 1, 1)</li>\n<li>Apply cascade correctly: more specific rules should override less specific ones</li>\n<li>Handle inheritance: text color should inherit from parent unless explicitly set</li>\n<li>Parse CSS values: <code>12px</code>, <code>#ff0000</code>, <code>rgb(255, 0, 0)</code> should parse to correct internal types</li>\n</ul>\n<p><strong>Manual Testing:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">let</span><span style=\"color:#E1E4E8\"> css </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  body { color: black; font-family: Arial; }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  .highlight { color: red; }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  #header .nav { color: blue; }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">let</span><span style=\"color:#E1E4E8\"> rules </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> CSSParser</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">parse_stylesheet</span><span style=\"color:#E1E4E8\">(css)</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">unwrap</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Should have 3 rules with correct selectors and declarations</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">assert_eq!</span><span style=\"color:#E1E4E8\">(rules</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">let</span><span style=\"color:#E1E4E8\"> resolver </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> StyleResolver</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(rules);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Test with sample DOM element</span></span></code></pre></div>\n\n<p><strong>G. Debugging Tips:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>How to Diagnose</th>\n<th>Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Selectors don&#39;t match elements</td>\n<td>Incorrect selector parsing or matching logic</td>\n<td>Print parsed selector structure and matching attempts</td>\n<td>Check selector component parsing and matching algorithm</td>\n</tr>\n<tr>\n<td>Wrong styles applied</td>\n<td>Specificity calculation error</td>\n<td>Print computed specificity for competing rules</td>\n<td>Verify specificity calculation follows CSS spec exactly</td>\n</tr>\n<tr>\n<td>Inheritance not working</td>\n<td>Missing inheritance implementation</td>\n<td>Check if inheritable properties copy from parent</td>\n<td>Implement proper inheritance for inheritable properties</td>\n</tr>\n<tr>\n<td>Colors display incorrectly</td>\n<td>Color parsing or conversion issues</td>\n<td>Print parsed color values in debug format</td>\n<td>Verify color parsing handles all formats correctly</td>\n</tr>\n<tr>\n<td>Performance issues with large stylesheets</td>\n<td>Inefficient rule matching</td>\n<td>Profile rule matching performance</td>\n<td>Add selector indexing and fast-path optimizations</td>\n</tr>\n</tbody></table>\n<h2 id=\"layout-engine-design\">Layout Engine Design</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 3 (Layout) - This section implements the core layout algorithms that transform the styled DOM tree into positioned and sized visual elements using CSS box model calculations and formatting contexts.</p>\n</blockquote>\n<p>The layout engine represents the geometric heart of our browser engine, where abstract CSS properties transform into concrete pixel coordinates and dimensions. Think of the layout engine as a <strong>master carpenter</strong> who takes architectural blueprints (the styled DOM tree) and transforms them into precise measurements and positioning for every piece of the structure. Just as a carpenter must understand how different materials stack, flow, and interact spatially, our layout engine must understand how CSS display types, the box model, and formatting contexts determine the final visual arrangement of elements.</p>\n<p>The layout engine operates on the fundamental principle that every element in a web page occupies rectangular space, even if that space is zero-sized or invisible. This geometric abstraction allows us to reduce the infinite complexity of visual design to a manageable set of mathematical calculations involving rectangles, their positions, and their relationships to one another.</p>\n<p><img src=\"/api/project/build-browser/architecture-doc/asset?path=diagrams%2Flayout-box-model.svg\" alt=\"CSS Box Model Calculation Flow\"></p>\n<p>The layout process transforms the styled DOM tree into a <strong>layout tree</strong>, where each node contains not just styling information but precise geometric data: content dimensions, padding thickness, border widths, margin spacing, and absolute positioning coordinates. This geometric data flows directly into the rendering engine, which uses it to determine exactly where to paint each visual element.</p>\n<h3 id=\"css-box-model-implementation\">CSS Box Model Implementation</h3>\n<p>The CSS box model serves as the fundamental geometric framework that governs how every element&#39;s size and spacing are calculated. Think of each element as a <strong>nested set of picture frames</strong>: the innermost frame holds the actual content (text, images, or child elements), surrounded by padding (like a photo mat), then a border (the frame itself), and finally margin (the space between this frame and adjacent frames on the wall).</p>\n<p>Understanding the box model requires recognizing that CSS properties like <code>width</code> and <code>height</code> specify the content area dimensions, not the total space an element occupies. The total space calculation must account for all four layers of the box model, and this calculation varies depending on the CSS <code>box-sizing</code> property and whether dimensions are specified explicitly or need to be computed automatically.</p>\n<blockquote>\n<p><strong>Decision: Box Model Calculation Strategy</strong></p>\n<ul>\n<li><strong>Context</strong>: CSS box model calculations must handle explicit dimensions, auto-sizing, percentage values, and the interaction between width/height and padding/border/margin</li>\n<li><strong>Options Considered</strong>: <ol>\n<li>Two-pass layout (measure content first, then apply box model)</li>\n<li>Single-pass with constraint propagation</li>\n<li>Iterative refinement with multiple passes</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Two-pass layout with measure-then-position phases</li>\n<li><strong>Rationale</strong>: Two-pass layout cleanly separates content sizing from box model application, making the algorithm easier to understand and debug while handling auto-sizing correctly</li>\n<li><strong>Consequences</strong>: Requires two tree traversals but provides clear separation of concerns and easier handling of percentage values and auto margins</li>\n</ul>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Option</th>\n<th>Pros</th>\n<th>Cons</th>\n<th>Chosen?</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Two-pass layout</td>\n<td>Clear separation, easier debugging, correct auto-sizing</td>\n<td>Requires two traversals, slightly less efficient</td>\n<td>✅ Yes</td>\n</tr>\n<tr>\n<td>Single-pass constraint</td>\n<td>More efficient, unified algorithm</td>\n<td>Complex constraint solving, harder to debug</td>\n<td>❌ No</td>\n</tr>\n<tr>\n<td>Iterative refinement</td>\n<td>Handles complex dependencies</td>\n<td>Non-deterministic performance, convergence issues</td>\n<td>❌ No</td>\n</tr>\n</tbody></table>\n<p>The box model calculation algorithm follows these essential steps:</p>\n<ol>\n<li><strong>Content dimension resolution</strong>: Determine the actual content width and height, resolving any <code>auto</code> values, percentage values, or constraints imposed by the containing block</li>\n<li><strong>Padding application</strong>: Add padding values to the content dimensions, converting any percentage padding values to absolute pixel measurements based on the containing block width</li>\n<li><strong>Border integration</strong>: Include border widths in the total element size, ensuring border styles and widths are properly resolved from the computed styles</li>\n<li><strong>Margin calculation</strong>: Compute margin values, handling special cases like auto margins, negative margins, and margin collapsing scenarios</li>\n<li><strong>Total space determination</strong>: Calculate the final bounding rectangle that encompasses margin, border, padding, and content areas</li>\n</ol>\n<p>The <code>LayoutBox</code> structure maintains separate rectangles for each layer of the box model, enabling precise control during both layout calculation and rendering phases:</p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>content_rect</code></td>\n<td><code>Rectangle</code></td>\n<td>Inner area containing actual content (text, images, child elements)</td>\n</tr>\n<tr>\n<td><code>padding_rect</code></td>\n<td><code>Rectangle</code></td>\n<td>Content area plus padding on all sides</td>\n</tr>\n<tr>\n<td><code>border_rect</code></td>\n<td><code>Rectangle</code></td>\n<td>Padding area plus border thickness on all sides</td>\n</tr>\n<tr>\n<td><code>margin_rect</code></td>\n<td><code>Rectangle</code></td>\n<td>Border area plus margin spacing on all sides (total element space)</td>\n</tr>\n<tr>\n<td><code>computed_style</code></td>\n<td><code>ComputedStyle</code></td>\n<td>Resolved CSS properties including dimensions, spacing, and positioning</td>\n</tr>\n<tr>\n<td><code>box_type</code></td>\n<td><code>BoxType</code></td>\n<td>Display type determining layout behavior (block, inline, text, etc.)</td>\n</tr>\n</tbody></table>\n<p>The box model calculation must handle several critical edge cases that frequently challenge implementations:</p>\n<p><strong>Percentage Value Resolution</strong>: Percentage widths and heights resolve against the containing block&#39;s corresponding dimension, while percentage padding and margin values always resolve against the containing block&#39;s width (even for top and bottom padding/margin). This asymmetric behavior reflects CSS specifications and affects element aspect ratios.</p>\n<p><strong>Auto Value Handling</strong>: When <code>width</code> or <code>height</code> is <code>auto</code>, the layout engine must compute the dimension based on content requirements and available space. For block elements, auto width typically expands to fill the containing block, while auto height shrinks to fit content. Inline elements compute both dimensions based on content.</p>\n<p><strong>Box Sizing Variations</strong>: The <code>box-sizing</code> property fundamentally changes how width and height are interpreted. With <code>content-box</code> (the default), width/height specify the content area. With <code>border-box</code>, they specify the border area, requiring the layout engine to subtract padding and border to determine content dimensions.</p>\n<blockquote>\n<p>The box model calculation forms the mathematical foundation for all layout operations. Getting these calculations wrong creates cascading errors throughout the layout tree, often manifesting as misaligned elements, incorrect scrolling behavior, or elements extending beyond their containers.</p>\n</blockquote>\n<h3 id=\"block-formatting-context\">Block Formatting Context</h3>\n<p>Block formatting context represents the vertical stacking behavior that governs how block-level elements arrange themselves within their container. Think of block formatting as <strong>arranging books on a bookshelf</strong>: each book (block element) stacks vertically below the previous one, with each book taking the full width of the shelf unless explicitly constrained. The shelf itself (the containing block) determines the available width, while each book&#39;s content determines its height.</p>\n<p>Block formatting context establishes several crucial layout principles: block elements stack vertically in document order, each block element starts on a new &quot;line&quot; (preventing horizontal adjacency with other blocks), and margin collapsing occurs between vertically adjacent blocks under specific conditions.</p>\n<p>The block layout algorithm operates through a systematic positioning process:</p>\n<ol>\n<li><strong>Available space calculation</strong>: Determine the containing block&#39;s content width and height, accounting for any constraints imposed by the parent element&#39;s box model and positioning</li>\n<li><strong>Child element iteration</strong>: Process each child block element in document order, calculating its position relative to previously positioned siblings</li>\n<li><strong>Width resolution</strong>: For each child, resolve the width dimension using CSS properties, available space, and auto-sizing rules specific to block elements</li>\n<li><strong>Height calculation</strong>: Compute the height based on content requirements, explicit CSS values, or auto-sizing behavior for block containers</li>\n<li><strong>Vertical positioning</strong>: Place the element below previously positioned siblings, accounting for margin values and potential margin collapsing scenarios</li>\n<li><strong>Margin collapsing evaluation</strong>: Apply CSS margin collapsing rules between adjacent block elements, which can reduce the actual spacing between elements</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>Layout Phase</th>\n<th>Input</th>\n<th>Process</th>\n<th>Output</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Space Analysis</td>\n<td>Containing block dimensions</td>\n<td>Calculate available width/height for children</td>\n<td>Content area constraints</td>\n</tr>\n<tr>\n<td>Width Resolution</td>\n<td>CSS width + available space</td>\n<td>Apply width algorithm (auto, percentage, explicit)</td>\n<td>Final content width</td>\n</tr>\n<tr>\n<td>Content Layout</td>\n<td>Child elements + content width</td>\n<td>Position child content (text, inline, nested blocks)</td>\n<td>Content height</td>\n</tr>\n<tr>\n<td>Height Resolution</td>\n<td>Content height + CSS height</td>\n<td>Apply height algorithm (auto, explicit, min/max)</td>\n<td>Final content height</td>\n</tr>\n<tr>\n<td>Position Assignment</td>\n<td>Element dimensions + sibling positions</td>\n<td>Calculate final x,y coordinates</td>\n<td>Positioned layout box</td>\n</tr>\n</tbody></table>\n<p><strong>Margin Collapsing</strong> represents one of the most complex aspects of block formatting context. When two or more adjacent margins touch (no padding, border, or content separates them), they &quot;collapse&quot; into a single margin whose size equals the larger of the collapsing margins. This behavior affects parent-child relationships (where a child&#39;s margin can collapse with its parent&#39;s margin) and sibling relationships (where adjacent siblings&#39; margins collapse).</p>\n<p>The margin collapsing algorithm requires careful analysis of element relationships:</p>\n<ol>\n<li><strong>Adjacency detection</strong>: Identify margins that are touching (no intervening padding, border, or content)</li>\n<li><strong>Collapse scope determination</strong>: Determine which margins participate in the collapsing (can involve more than two margins in complex scenarios)</li>\n<li><strong>Collapsed value calculation</strong>: Compute the final collapsed margin size, handling positive margins (use the maximum), negative margins (use the minimum), and mixed positive/negative margins (sum the maximum positive and minimum negative)</li>\n<li><strong>Position adjustment</strong>: Apply the collapsed margin value and adjust element positions accordingly</li>\n</ol>\n<blockquote>\n<p><strong>Decision: Margin Collapsing Implementation</strong></p>\n<ul>\n<li><strong>Context</strong>: CSS margin collapsing involves complex rules for when margins collapse, which margins participate, and how to calculate the final collapsed value</li>\n<li><strong>Options Considered</strong>:<ol>\n<li>Full CSS specification compliance with all edge cases</li>\n<li>Simplified collapsing (only adjacent sibling margins)</li>\n<li>No margin collapsing (treat all margins independently)</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Simplified collapsing for adjacent siblings and basic parent-child scenarios</li>\n<li><strong>Rationale</strong>: Full compliance requires handling dozens of edge cases that rarely occur in real content, while simplified collapsing covers 90% of practical scenarios with much less implementation complexity</li>\n<li><strong>Consequences</strong>: Some advanced margin collapsing scenarios won&#39;t render identically to major browsers, but core layout behavior will be correct</li>\n</ul>\n</blockquote>\n<p><strong>Width and Height Resolution</strong> in block formatting context follows CSS&#39;s detailed algorithms for determining element dimensions. Block elements have a natural tendency toward width expansion (filling available horizontal space) and height contraction (shrinking to fit content), but CSS properties can override these defaults.</p>\n<p>The width resolution algorithm prioritizes explicit values over auto-sizing:</p>\n<ol>\n<li><strong>Explicit width</strong>: If CSS specifies a concrete width value, use it directly (converting units to pixels as needed)</li>\n<li><strong>Percentage width</strong>: Calculate percentage relative to the containing block&#39;s content width</li>\n<li><strong>Auto width</strong>: For block elements, auto width typically means &quot;fill available horizontal space after accounting for margin, border, and padding&quot;</li>\n<li><strong>Constraint application</strong>: Apply min-width and max-width constraints, potentially overriding the calculated width</li>\n</ol>\n<p>Height resolution follows a different pattern since block elements typically size themselves based on content:</p>\n<ol>\n<li><strong>Content-based height</strong>: Measure the height required to contain all child elements and content</li>\n<li><strong>Explicit height override</strong>: If CSS specifies a height value, use it instead of content-based height</li>\n<li><strong>Percentage height</strong>: Resolve percentage heights against the containing block&#39;s height (only if the containing block has an explicit height)</li>\n<li><strong>Constraint application</strong>: Apply min-height and max-height, ensuring the final height meets all constraints</li>\n</ol>\n<h3 id=\"inline-formatting-context\">Inline Formatting Context</h3>\n<p>Inline formatting context governs the horizontal flow of text and inline elements within a line, analogous to <strong>arranging words on a page of text</strong>. Unlike block elements that stack vertically, inline elements flow horizontally from left to right (in left-to-right languages), wrapping to new lines when they exceed the containing block&#39;s width. Think of inline layout as a word processor that continuously places content horizontally until reaching the right margin, then continues on the next line.</p>\n<p>Inline formatting context introduces several concepts absent from block formatting: baseline alignment (ensuring text appears to sit on invisible horizontal lines), line breaking (determining where content wraps to new lines), and mixed content handling (managing the interaction between text and inline block elements within the same line).</p>\n<p>The inline layout algorithm processes content in reading order while maintaining line-by-line organization:</p>\n<ol>\n<li><strong>Line box initialization</strong>: Create a new line box to contain inline content, establishing the baseline and available width</li>\n<li><strong>Inline content processing</strong>: Add inline elements and text to the current line box, measuring each element&#39;s width and height requirements</li>\n<li><strong>Line breaking evaluation</strong>: When adding an element would exceed the available line width, determine the appropriate break point and wrap to a new line</li>\n<li><strong>Baseline alignment</strong>: Align all inline elements within the line box according to their vertical-align properties and the line&#39;s baseline</li>\n<li><strong>Line box finalization</strong>: Complete the line box by determining its final height (based on the tallest element) and vertical position within the containing block</li>\n<li><strong>Line stacking</strong>: Position completed line boxes vertically within the containing block, similar to how block elements stack</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>Inline Layout Component</th>\n<th>Responsibility</th>\n<th>Key Challenges</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Text measurement</td>\n<td>Calculate width/height of text runs</td>\n<td>Font metrics, character-specific widths, ligatures</td>\n</tr>\n<tr>\n<td>Line breaking</td>\n<td>Determine where content wraps</td>\n<td>Word boundaries, hyphenation, overflow handling</td>\n</tr>\n<tr>\n<td>Baseline alignment</td>\n<td>Vertical positioning within lines</td>\n<td>Multiple font sizes, inline-block elements, vertical-align</td>\n</tr>\n<tr>\n<td>Line box sizing</td>\n<td>Calculate line height and position</td>\n<td>Leading, line-height property, content height variation</td>\n</tr>\n<tr>\n<td>Mixed content</td>\n<td>Handle text + inline elements</td>\n<td>Different vertical alignment requirements, spacing</td>\n</tr>\n</tbody></table>\n<p><strong>Line Breaking</strong> represents one of the most algorithmically challenging aspects of inline layout. The line breaking algorithm must balance several competing requirements: avoiding broken words when possible, respecting whitespace and punctuation rules, handling elements that cannot break (like images), and managing overflow scenarios where content cannot fit within available space.</p>\n<p>The line breaking process follows these decision points:</p>\n<ol>\n<li><strong>Space availability check</strong>: For each inline element or text segment, determine if it fits within the remaining line width</li>\n<li><strong>Break opportunity identification</strong>: If the content doesn&#39;t fit, identify valid break points (typically at word boundaries, after hyphens, or at explicit break characters)</li>\n<li><strong>Break decision</strong>: Choose the optimal break point that minimizes visual disruption while respecting CSS properties like <code>word-break</code> and <code>overflow-wrap</code></li>\n<li><strong>Content splitting</strong>: Split the content at the chosen break point, placing part on the current line and part on the next line</li>\n<li><strong>New line initialization</strong>: Create a new line box for the wrapped content and continue the inline layout process</li>\n</ol>\n<p><strong>Baseline Alignment</strong> ensures that text and inline elements appear properly aligned within each line. The baseline serves as an invisible horizontal reference line that determines where text &quot;sits&quot; within the line box. Different fonts, font sizes, and inline elements can have different baseline positions, requiring careful calculation to maintain visual consistency.</p>\n<p>The baseline alignment algorithm coordinates multiple vertical positioning concerns:</p>\n<ol>\n<li><strong>Line baseline establishment</strong>: Determine the primary baseline position for the line based on the dominant font and size</li>\n<li><strong>Element baseline calculation</strong>: For each inline element, calculate its baseline position relative to its own content</li>\n<li><strong>Vertical alignment resolution</strong>: Apply CSS vertical-align properties (baseline, top, middle, bottom, text-top, text-bottom, percentage, or length values)</li>\n<li><strong>Line box height determination</strong>: Calculate the final line box height based on the highest and lowest points of all aligned elements</li>\n<li><strong>Final positioning</strong>: Position each element at its calculated vertical offset within the line box</li>\n</ol>\n<p><strong>Text Measurement</strong> requires the layout engine to interface with font rendering systems to obtain accurate metrics for text content. Unlike block elements with predictable rectangular geometry, text measurement involves font-specific metrics like character widths, ascent heights, descent depths, and inter-character spacing.</p>\n<table>\n<thead>\n<tr>\n<th>Text Metric</th>\n<th>Definition</th>\n<th>Layout Impact</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Advance width</td>\n<td>Horizontal space consumed by a character</td>\n<td>Determines how much space text occupies on a line</td>\n</tr>\n<tr>\n<td>Ascent</td>\n<td>Height above baseline (like the top of &#39;A&#39;)</td>\n<td>Affects line box height calculation</td>\n</tr>\n<tr>\n<td>Descent</td>\n<td>Depth below baseline (like the bottom of &#39;g&#39;)</td>\n<td>Affects line box height and baseline alignment</td>\n</tr>\n<tr>\n<td>Line height</td>\n<td>Total vertical space for a line of text</td>\n<td>Determines spacing between lines</td>\n</tr>\n<tr>\n<td>Font size</td>\n<td>Nominal height of the font</td>\n<td>Base measurement for relative units and scaling</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>Decision: Text Measurement Strategy</strong></p>\n<ul>\n<li><strong>Context</strong>: Accurate text layout requires font metrics, but font systems are complex and platform-specific</li>\n<li><strong>Options Considered</strong>:<ol>\n<li>Full font system integration with accurate metrics</li>\n<li>Simplified monospace font assumption</li>\n<li>Hardcoded average character dimensions</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Simplified monospace assumption with configurable character dimensions</li>\n<li><strong>Rationale</strong>: Font system integration adds significant complexity and platform dependencies, while monospace assumption provides predictable behavior for learning purposes</li>\n<li><strong>Consequences</strong>: Text rendering won&#39;t match real browsers exactly, but layout algorithms remain correct and understandable</li>\n</ul>\n</blockquote>\n<h3 id=\"common-pitfalls\">Common Pitfalls</h3>\n<p>⚠️ <strong>Pitfall: Box Model Calculation Order</strong>\nA frequent mistake involves calculating box model dimensions in the wrong order, particularly trying to determine total element size before resolving content dimensions. This leads to incorrect calculations when dealing with percentage values or auto-sizing scenarios. The correct approach always resolves content dimensions first, then applies padding, border, and margin in sequence. Each layer&#39;s calculation may depend on previously calculated layers, making order crucial for correctness.</p>\n<p>⚠️ <strong>Pitfall: Margin Collapsing Edge Cases</strong>\nImplementers often forget that margin collapsing can involve more than two margins and can occur between parent and child elements, not just siblings. Additionally, margins only collapse when they are directly adjacent (no padding, border, or content between them). A common error is applying margin collapsing in scenarios where intervening content prevents it, or failing to handle the three-way collapsing that occurs when a parent&#39;s margin, child&#39;s margin, and sibling&#39;s margin all interact.</p>\n<p>⚠️ <strong>Pitfall: Available Space Miscalculation</strong>\nWhen calculating available space for child elements, developers often forget to subtract the parent&#39;s padding and border from the total dimensions. This results in child elements that appear to overflow their containers. The available space for child content equals the parent&#39;s content area dimensions, not the total element dimensions including padding and border.</p>\n<p>⚠️ <strong>Pitfall: Inline Layout Line Box Height</strong>\nA subtle but critical mistake involves setting line box height based only on font size rather than measuring the actual height requirements of all inline content within the line. Line boxes must accommodate the tallest element in the line, whether that&#39;s large text, inline images, or inline-block elements. Using only font size for line height calculation causes content to overlap vertically when lines contain mixed content types.</p>\n<p>⚠️ <strong>Pitfall: Percentage Resolution Context</strong>\nDevelopers frequently resolve percentage values against the wrong containing block dimensions. Width percentages resolve against the containing block&#39;s width, height percentages resolve against the containing block&#39;s height (when explicit), but padding and margin percentages always resolve against the containing block&#39;s width, even for top and bottom values. This asymmetric behavior often surprises implementers and leads to incorrect spacing calculations.</p>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Box Model</td>\n<td>Fixed padding/border with content-box sizing</td>\n<td>Full box-sizing support with border-box</td>\n</tr>\n<tr>\n<td>Text Measurement</td>\n<td>Monospace font with fixed character width</td>\n<td>Platform font APIs with actual metrics</td>\n</tr>\n<tr>\n<td>Line Breaking</td>\n<td>Simple word boundary breaking</td>\n<td>Unicode line breaking algorithm</td>\n</tr>\n<tr>\n<td>Margin Collapsing</td>\n<td>Adjacent sibling collapsing only</td>\n<td>Full CSS specification compliance</td>\n</tr>\n<tr>\n<td>Baseline Alignment</td>\n<td>Single baseline per line</td>\n<td>Multiple baseline contexts</td>\n</tr>\n</tbody></table>\n<p><strong>Recommended File Structure:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>src/layout/\n  mod.rs                    ← Public layout engine interface\n  box_model.rs              ← Box model calculations and utilities\n  block_layout.rs           ← Block formatting context implementation\n  inline_layout.rs          ← Inline formatting context implementation\n  layout_tree.rs            ← Layout tree construction and traversal\n  geometry.rs               ← Rectangle, Point, Size utility types\n  text_measurement.rs       ← Text metrics and font interface</code></pre></div>\n\n<p><strong>Infrastructure Starter Code:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/layout/geometry.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">css</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> x</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(x</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Point</span><span style=\"color:#E1E4E8\"> { x, y }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> zero</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Point</span><span style=\"color:#E1E4E8\"> { x</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Size</span><span style=\"color:#E1E4E8\"> { width, height }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> zero</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Size</span><span style=\"color:#E1E4E8\"> { width</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">, size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Rectangle</span><span style=\"color:#E1E4E8\"> { origin, size }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> from_coords</span><span style=\"color:#E1E4E8\">(x</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(x, y),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(width, height),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> contains_point</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, point</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        point</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> point</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> point</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> point</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> intersects</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, other</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        !</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            ||</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            ||</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            ||</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> other</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Box model utilities</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> BoxOffsets</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> top</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> right</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> bottom</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> left</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> BoxOffsets</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> zero</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        BoxOffsets</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            top</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            right</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            bottom</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            left</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> uniform</span><span style=\"color:#E1E4E8\">(value</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        BoxOffsets</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            top</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> value,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            right</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> value,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            bottom</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> value,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            left</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> value,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> horizontal_total</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">left </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">right</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> vertical_total</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">top </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">bottom</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/layout/text_measurement.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">css</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> TextMetrics</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> advance_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> ascent</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> descent</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> line_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> FontInfo</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> family</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> weight</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u16</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> style</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> FontStyle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> FontStyle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Normal</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Italic</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Simple text measurement for monospace fonts</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> SimpleTextMeasurer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    char_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    line_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> SimpleTextMeasurer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(char_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, line_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        SimpleTextMeasurer</span><span style=\"color:#E1E4E8\"> { char_width, line_height }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> measure_text</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, text</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, style</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> TextMetrics</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> scale_factor </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> style</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">font_size </span><span style=\"color:#F97583\">/</span><span style=\"color:#79B8FF\"> 16.0</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#6A737D\">// Scale from base 16px</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        TextMetrics</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            advance_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> text</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">chars</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">count</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#F97583\"> *</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">char_width </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> scale_factor,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            ascent</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">line_height </span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\"> 0.8</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> scale_factor,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            descent</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">line_height </span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\"> 0.2</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> scale_factor,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            line_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">line_height </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> scale_factor,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> measure_char</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, ch</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> char</span><span style=\"color:#E1E4E8\">, style</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> scale_factor </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> style</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">font_size </span><span style=\"color:#F97583\">/</span><span style=\"color:#79B8FF\"> 16.0</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">char_width </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> scale_factor</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Core Logic Skeleton Code:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/layout/box_model.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">css</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">BoxSizing</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">geometry</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Size</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">BoxOffsets</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> LayoutBox</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Calculate box model dimensions for this element given available space</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// This is the core box model calculation that determines content, padding, border, and margin rectangles</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> calculate_box_model</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, containing_block_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Extract computed style values for width, height, padding, border, margin</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use self.computed_style to access CSS properties</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Resolve any percentage values in padding/border/margin against containing block</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Padding/margin percentages always resolve against containing block WIDTH</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Calculate content dimensions based on CSS width/height properties</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Handle 'auto', explicit values, and percentages differently</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Consider box-sizing property - content-box vs border-box changes the calculation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Apply padding to get padding rectangle from content rectangle</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Padding expands outward from content area</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Apply border to get border rectangle from padding rectangle</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Border expands outward from padding area</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Apply margin to get margin rectangle from border rectangle</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Margin expands outward from border area, but may collapse with siblings</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Store all four rectangles (content_rect, padding_rect, border_rect, margin_rect)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Each rectangle should be properly positioned and sized</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> resolve_dimension</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, value</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#E1E4E8\">, containing_dimension</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, auto_value</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Convert Unit values to pixels</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Handle Px(value), Percent(percentage), Em(em_value), Auto cases</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Return appropriate pixel value for each case</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> calculate_auto_width</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, containing_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Implement auto width calculation for different box types</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Block elements: fill available space minus margin/border/padding</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Inline elements: shrink to content width</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Return calculated width in pixels</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> calculate_auto_height</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, content_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Implement auto height calculation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Usually equals content height unless overridden by CSS</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Return calculated height in pixels</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/layout/block_layout.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">BoxType</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">geometry</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Point</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Size</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> LayoutBox</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Layout child elements in block formatting context</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Stacks children vertically with proper margin handling</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> layout_block_children</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, available_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Initialize layout state (current y position, previous margin)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Start y at top of content area, track margin for collapsing</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Iterate through child elements in document order</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use self.children.iter_mut() for mutable access</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: For each child, calculate its box model with available width</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Call child.calculate_box_model(Size::new(available_width, auto_height))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Check for margin collapsing with previous sibling</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Compare current child's top margin with previous child's bottom margin</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use the larger margin value, don't add them together</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Position the child at calculated y coordinate</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Set child's margin_rect.origin.y based on current_y and collapsed margins</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Update current_y position for next child</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Add this child's total height (margin_rect.size.height) to current_y</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Store previous child's bottom margin for next iteration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Track margin values for collapsing calculation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 8: After all children positioned, update parent's content height</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Parent content height should encompass all positioned children</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> calculate_margin_collapse</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, margin1</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, margin2</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Implement margin collapsing algorithm</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Positive margins: use maximum</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Negative margins: use minimum (most negative)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Mixed: add maximum positive and minimum negative</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> should_collapse_margins</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, child1</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, child2</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Determine if margins should collapse between these children</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Check for intervening padding, border, or content</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Return true if margins are adjacent and should collapse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/layout/inline_layout.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">BoxType</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">geometry</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Point</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Size</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">text_measurement</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">SimpleTextMeasurer</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">TextMetrics</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> LineBox</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> baseline_y</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> line_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> content_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> elements</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">InlineElement</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> InlineElement</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> content_rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> baseline_offset</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> element_type</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> InlineElementType</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> InlineElementType</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Text</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    InlineBox</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> LayoutBox</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Layout content in inline formatting context</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Flows content horizontally with line breaking and baseline alignment</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> layout_inline_content</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, available_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, text_measurer</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">SimpleTextMeasurer</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Initialize line layout state (current line box, x position)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Create first LineBox with baseline position and available width</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Process each inline child element or text node</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Iterate through inline content, measuring each piece</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: For each content piece, check if it fits on current line</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Compare element width against remaining line width</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: If content doesn't fit, find appropriate line break point</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Look for word boundaries, whitespace, or hyphen break opportunities</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Break content if necessary and wrap to new line</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Split content at break point, place first part on current line</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Add content to current line with baseline alignment</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Calculate baseline offset based on font metrics and vertical-align</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Update line box dimensions based on added content</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Line height grows to accommodate tallest element</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 8: When line is complete, finalize line box and create next line</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Position completed line box and initialize new line for remaining content</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 9: Stack completed line boxes vertically in containing block</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Each line positions below previous line, similar to block stacking</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> find_line_break_opportunity</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, text</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, max_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, text_measurer</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">SimpleTextMeasurer</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Find optimal break point in text that fits within max_width</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Prefer word boundaries, handle overflow cases</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Return character index where break should occur</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> calculate_baseline_alignment</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, element_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, line_baseline</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, vertical_align</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Calculate vertical offset for baseline alignment</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Handle \"baseline\", \"top\", \"middle\", \"bottom\" alignment values</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Return y offset from line top to element baseline</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> measure_inline_content</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, content</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">InlineElementType</span><span style=\"color:#E1E4E8\">, text_measurer</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">SimpleTextMeasurer</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> TextMetrics</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Measure width and height requirements for inline content</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Handle text measurement and inline element measurement differently</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Return metrics needed for line breaking and baseline alignment</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Language-Specific Hints for Rust:</strong></p>\n<ul>\n<li>Use <code>f32</code> for all layout calculations to match graphics coordinates and avoid precision issues with CSS pixel values</li>\n<li>Implement <code>Debug</code> and <code>Clone</code> traits on geometry types for easier debugging and testing</li>\n<li>Consider using <code>RefCell&lt;T&gt;</code> or similar interior mutability patterns if you need to modify layout boxes during traversal</li>\n<li>Use <code>Option&lt;T&gt;</code> for parent references to handle the root element case cleanly</li>\n<li>Leverage Rust&#39;s pattern matching for handling different <code>BoxType</code> variants in layout algorithms</li>\n<li>Consider using the <code>euclid</code> crate for more advanced geometric operations if needed</li>\n</ul>\n<p><strong>Milestone Checkpoint:</strong>\nAfter implementing the layout engine, verify these behaviors:</p>\n<ul>\n<li><strong>Box Model Test</strong>: Create an element with explicit width, padding, border, and margin. Verify that <code>content_rect</code>, <code>padding_rect</code>, <code>border_rect</code>, and <code>margin_rect</code> are correctly calculated and positioned</li>\n<li><strong>Block Layout Test</strong>: Create nested block elements and verify they stack vertically with correct y-positions and that each child&#39;s x-position aligns with the parent&#39;s content area</li>\n<li><strong>Margin Collapsing Test</strong>: Create two adjacent block elements with different margin values and verify that the space between them equals the larger margin, not the sum</li>\n<li><strong>Inline Layout Test</strong>: Create a block containing text and inline elements that exceed the container width, and verify that content wraps to multiple lines with consistent baseline alignment</li>\n<li><strong>Mixed Content Test</strong>: Combine block and inline elements in a complex layout and verify that the layout tree correctly represents the hierarchical positioning</li>\n</ul>\n<p><strong>Debugging Tips:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>How to Diagnose</th>\n<th>Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Elements overlap vertically</td>\n<td>Incorrect height calculation or y positioning</td>\n<td>Print each element&#39;s margin_rect coordinates</td>\n<td>Check box model height calculation and ensure y positions account for previous elements</td>\n</tr>\n<tr>\n<td>Elements extend beyond parent</td>\n<td>Wrong available space calculation</td>\n<td>Compare child width against parent content width</td>\n<td>Subtract parent&#39;s padding and border from available space calculation</td>\n</tr>\n<tr>\n<td>Inconsistent text alignment</td>\n<td>Baseline calculation errors</td>\n<td>Print baseline offsets for each line element</td>\n<td>Verify font metrics and baseline alignment calculations match expected behavior</td>\n</tr>\n<tr>\n<td>Margin spacing looks wrong</td>\n<td>Margin collapsing not applied correctly</td>\n<td>Print individual margins vs collapsed margins</td>\n<td>Check margin collapsing conditions and ensure algorithm handles positive/negative/mixed margins</td>\n</tr>\n<tr>\n<td>Layout tree seems incomplete</td>\n<td>Missing layout box creation</td>\n<td>Print layout tree structure with indentation</td>\n<td>Ensure layout boxes are created for all DOM elements that should participate in layout</td>\n</tr>\n</tbody></table>\n<h2 id=\"rendering-engine-design\">Rendering Engine Design</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 4 (Rendering) - This section implements the final stage of the rendering pipeline that converts the computed layout tree into visual output through paint command generation and graphics rendering.</p>\n</blockquote>\n<p>The <strong>rendering engine</strong> transforms the abstract layout tree into concrete visual output that users can see on their screens. Think of this stage as a <strong>printing press operation</strong> where we have already typeset all the text and determined where every element should be positioned (the layout stage), and now we need to actually put ink on paper in the correct order. Just as a printing press must lay down colors in a specific sequence—background colors first, then text, then any overlays—our rendering engine must generate drawing commands in the proper <strong>paint order</strong> to ensure elements appear correctly layered.</p>\n<p>The rendering engine operates on a fundamental principle: it traverses the layout tree in <strong>document order</strong> (the sequence elements appear in the HTML) but generates paint commands that will be executed in <strong>z-order</strong> (background to foreground). This separation between traversal order and paint order is crucial because an element that appears later in the HTML might need to be painted behind an element that appears earlier, depending on CSS positioning and stacking contexts.</p>\n<blockquote>\n<p><strong>Decision: Display List Architecture</strong></p>\n<ul>\n<li><strong>Context</strong>: The rendering engine needs to convert layout information into graphics operations while supporting efficient repainting and potential optimizations</li>\n<li><strong>Options Considered</strong>: Direct immediate-mode rendering, retained display lists, scene graphs</li>\n<li><strong>Decision</strong>: Generate a display list of paint commands before rendering</li>\n<li><strong>Rationale</strong>: Display lists decouple layout traversal from graphics execution, enable batching optimizations, support efficient damage tracking for repainting, and provide a clean abstraction over different graphics backends</li>\n<li><strong>Consequences</strong>: Adds memory overhead for storing commands but enables better performance through batching and provides flexibility for future optimizations like GPU acceleration</li>\n</ul>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Architecture Option</th>\n<th>Pros</th>\n<th>Cons</th>\n<th>Chosen?</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Immediate Mode Rendering</td>\n<td>Simple, low memory usage</td>\n<td>Difficult to optimize, tight coupling to graphics backend</td>\n<td>No</td>\n</tr>\n<tr>\n<td>Display List Generation</td>\n<td>Decoupled, optimizable, backend-agnostic</td>\n<td>Additional memory usage, two-phase rendering</td>\n<td><strong>Yes</strong></td>\n</tr>\n<tr>\n<td>Scene Graph</td>\n<td>Highly optimizable, supports complex effects</td>\n<td>Over-engineered for simple browser, complex API</td>\n<td>No</td>\n</tr>\n</tbody></table>\n<p>The rendering process consists of three distinct phases. First, <strong>paint command generation</strong> walks the layout tree and emits drawing operations for each visible element. Second, <strong>display list optimization</strong> processes these commands to eliminate unnecessary drawing and batch similar operations. Third, <strong>graphics execution</strong> sends the optimized commands to the underlying graphics system for actual drawing to the screen or buffer.</p>\n<h3 id=\"paint-command-generation\">Paint Command Generation</h3>\n<p>Think of paint command generation as creating a <strong>recipe for an artist</strong> who will paint the webpage. The artist doesn&#39;t know anything about HTML, CSS, or layout—they only understand basic drawing instructions like &quot;fill this rectangle with blue&quot; or &quot;draw this text at position (100, 50) using 14-pixel Arial font.&quot; Our job is to translate the rich semantic and layout information in our layout tree into these primitive drawing commands.</p>\n<p>The paint command generation process follows a <strong>depth-first traversal</strong> of the layout tree, visiting each layout box and determining what visual elements it contributes to the final rendering. For each layout box, we generate commands in a specific order that respects the CSS painting model: background painting, border painting, and foreground content painting. This ordering ensures that backgrounds appear behind text, borders appear around their content, and overlapping elements stack correctly.</p>\n<blockquote>\n<p>The key insight in paint command generation is that we must separate the <strong>what to paint</strong> (determined by CSS properties) from the <strong>how to paint</strong> (implemented by graphics primitives). This separation allows us to support different graphics backends while maintaining consistent visual output.</p>\n</blockquote>\n<p>The paint command generation algorithm processes each layout box through several painting phases:</p>\n<ol>\n<li><strong>Background Phase</strong>: Generate commands to fill the background area with colors, gradients, or images specified in the element&#39;s computed style</li>\n<li><strong>Border Phase</strong>: Create drawing commands for each border edge, handling different border styles, widths, and colors</li>\n<li><strong>Content Phase</strong>: For text content, generate text rendering commands with proper font, size, and positioning</li>\n<li><strong>Child Phase</strong>: Recursively process child layout boxes, maintaining proper stacking order</li>\n</ol>\n<p>Each phase examines the layout box&#39;s computed style properties to determine what painting operations are necessary. A layout box with <code>background-color: transparent</code> and no borders contributes no background or border commands to the display list, while a box with <code>background-color: blue</code> and a <code>2px solid red</code> border generates both fill and stroke commands.</p>\n<table>\n<thead>\n<tr>\n<th>Paint Phase</th>\n<th>Responsible For</th>\n<th>Example Commands</th>\n<th>Style Properties Used</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Background</td>\n<td>Filling element background</td>\n<td><code>DrawRectangle</code> with background color</td>\n<td><code>background-color</code>, <code>background-image</code></td>\n</tr>\n<tr>\n<td>Border</td>\n<td>Drawing element borders</td>\n<td><code>DrawBorder</code> for each edge</td>\n<td><code>border-width</code>, <code>border-color</code>, <code>border-style</code></td>\n</tr>\n<tr>\n<td>Content</td>\n<td>Text and replaced content</td>\n<td><code>DrawText</code> with positioning</td>\n<td><code>color</code>, <code>font-family</code>, <code>font-size</code></td>\n</tr>\n<tr>\n<td>Children</td>\n<td>Nested element painting</td>\n<td>Recursive paint command generation</td>\n<td>Inherited and cascaded properties</td>\n</tr>\n</tbody></table>\n<p>The <code>PaintCommand</code> enumeration defines the primitive drawing operations that our graphics backend must support:</p>\n<table>\n<thead>\n<tr>\n<th>Command Type</th>\n<th>Parameters</th>\n<th>Purpose</th>\n<th>Example Usage</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>DrawRectangle</code></td>\n<td>rectangle: Rectangle, color: Color</td>\n<td>Fill rectangular area</td>\n<td>Element backgrounds, solid borders</td>\n</tr>\n<tr>\n<td><code>DrawBorder</code></td>\n<td>rectangle: Rectangle, widths: BoxOffsets, colors: [Color; 4]</td>\n<td>Draw bordered rectangle</td>\n<td>CSS border properties</td>\n</tr>\n<tr>\n<td><code>DrawText</code></td>\n<td>text: String, position: Point, font: FontInfo, color: Color</td>\n<td>Render text content</td>\n<td>Element text nodes</td>\n</tr>\n<tr>\n<td><code>SetClip</code></td>\n<td>rectangle: Rectangle</td>\n<td>Restrict drawing area</td>\n<td>Overflow clipping, nested contexts</td>\n</tr>\n<tr>\n<td><code>ClearClip</code></td>\n<td>None</td>\n<td>Remove clipping restriction</td>\n<td>End of clipped content</td>\n</tr>\n</tbody></table>\n<p><strong>Paint command generation for text content</strong> requires special consideration because text rendering involves complex typography concepts like baseline alignment, font metrics, and character positioning. When we encounter a text layout box, we must generate <code>DrawText</code> commands that position each text run at the correct baseline position within its line box. The text&#39;s x-coordinate comes from the layout box&#39;s content rectangle, while the y-coordinate must account for the line box&#39;s baseline position and the font&#39;s ascent metrics.</p>\n<p>For <strong>block-level elements</strong>, paint command generation typically produces <code>DrawRectangle</code> commands for backgrounds followed by <code>DrawBorder</code> commands for any visible borders. The rectangle coordinates come directly from the layout box&#39;s computed rectangles—the background is painted to fill the <code>padding_rect</code> (content area plus padding), while borders are drawn around the <code>border_rect</code> (padding area plus border width).</p>\n<p><strong>Inline elements present unique challenges</strong> because they can wrap across multiple lines, creating multiple rectangular fragments. A single inline element might generate several <code>DrawRectangle</code> commands if its background needs to be painted across line breaks. Each line fragment gets its own drawing command with coordinates computed from the inline element&#39;s line box positions.</p>\n<blockquote>\n<p><strong>Decision: Paint Order Strategy</strong></p>\n<ul>\n<li><strong>Context</strong>: Elements must be painted in correct z-order to handle overlapping content, but layout tree traversal follows document order</li>\n<li><strong>Options Considered</strong>: Sort commands by z-index after generation, traverse tree in paint order, generate commands with z-index hints</li>\n<li><strong>Decision</strong>: Generate commands in document order with z-index metadata, sort before rendering</li>\n<li><strong>Rationale</strong>: Document order traversal is simpler and matches CSS cascade semantics, while post-generation sorting handles complex stacking contexts correctly</li>\n<li><strong>Consequences</strong>: Requires additional sorting step and z-index calculation, but provides correct visual layering</li>\n</ul>\n</blockquote>\n<p>The paint command generation process must handle <strong>clipping contexts</strong> where child elements should not draw outside their parent&#39;s boundaries. When we encounter a layout box with <code>overflow: hidden</code> or similar clipping behavior, we generate <code>SetClip</code> and <code>ClearClip</code> commands that establish a clipped drawing region. All paint commands generated for child elements will be automatically clipped to this region by the graphics backend.</p>\n<p><strong>Stacking context handling</strong> ensures that elements with CSS properties like <code>z-index</code>, <code>position: absolute</code>, or <code>opacity</code> are painted in the correct order relative to other elements. The paint command generator maintains a <strong>stacking context stack</strong> as it traverses the layout tree, tracking which elements create new stacking contexts and what their relative z-order should be.</p>\n<p>⚠️ <strong>Pitfall: Incorrect Paint Order</strong>\nA common mistake is generating paint commands in the same order as layout tree traversal without considering CSS stacking contexts. This results in elements appearing in the wrong z-order, with later HTML elements incorrectly painting over earlier elements that should be on top. To avoid this, always calculate z-index values during paint command generation and either sort commands afterward or maintain separate command lists for different stacking levels.</p>\n<p>⚠️ <strong>Pitfall: Missing Background Clipping</strong>\nDevelopers often forget that element backgrounds should be clipped to the element&#39;s border edges when the element has rounded corners or complex border styles. Failing to generate appropriate <code>SetClip</code> commands results in backgrounds bleeding outside the intended element boundaries. Always check for border-radius and other properties that affect background clipping.</p>\n<h3 id=\"graphics-backend-abstraction\">Graphics Backend Abstraction</h3>\n<p>Think of the graphics backend abstraction as a <strong>universal translator</strong> that converts our high-level paint commands into the specific API calls required by different graphics systems. Just as a universal translator can convey the same meaning through English, Spanish, or Mandarin, our graphics abstraction expresses the same visual intent through different rendering APIs like CPU-based pixel buffers, GPU-accelerated canvases, or even vector graphics formats.</p>\n<p>The graphics backend abstraction serves as a <strong>clean interface boundary</strong> between our browser engine&#39;s rendering logic and the underlying platform-specific graphics implementation. This separation allows us to support multiple rendering targets—from simple RGB pixel buffers for testing to hardware-accelerated graphics APIs for performance—without changing any of the paint command generation logic.</p>\n<blockquote>\n<p>The fundamental principle of graphics backend abstraction is <strong>primitive sufficiency</strong>: we identify the minimal set of drawing operations needed to render any webpage and ensure our abstraction supports exactly those operations. This prevents both feature gaps (missing capabilities) and interface bloat (unnecessary complexity).</p>\n</blockquote>\n<p>Our graphics abstraction defines a <strong>trait or interface</strong> that any graphics backend must implement:</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>draw_rectangle</code></td>\n<td>rect: Rectangle, color: Color</td>\n<td>Result&lt;(), String&gt;</td>\n<td>Fill rectangular region with solid color</td>\n</tr>\n<tr>\n<td><code>draw_border</code></td>\n<td>rect: Rectangle, widths: BoxOffsets, colors: [Color; 4]</td>\n<td>Result&lt;(), String&gt;</td>\n<td>Draw bordered rectangle with per-edge styling</td>\n</tr>\n<tr>\n<td><code>draw_text</code></td>\n<td>text: &amp;str, position: Point, font: FontInfo, color: Color</td>\n<td>Result&lt;(), String&gt;</td>\n<td>Render text at specified position</td>\n</tr>\n<tr>\n<td><code>set_clip_rect</code></td>\n<td>rect: Rectangle</td>\n<td>Result&lt;(), String&gt;</td>\n<td>Establish clipping region for subsequent draws</td>\n</tr>\n<tr>\n<td><code>clear_clip</code></td>\n<td>None</td>\n<td>Result&lt;(), String&gt;</td>\n<td>Remove current clipping region</td>\n</tr>\n<tr>\n<td><code>create_surface</code></td>\n<td>size: Size</td>\n<td>Result&lt;Surface, String&gt;</td>\n<td>Create new drawing surface</td>\n</tr>\n<tr>\n<td><code>present_surface</code></td>\n<td>surface: Surface</td>\n<td>Result&lt;Vec<u8>, String&gt;</td>\n<td>Finalize surface and return pixel data</td>\n</tr>\n</tbody></table>\n<p>Each graphics backend implementation handles the translation from these abstract operations to concrete graphics API calls. A <strong>software rasterization backend</strong> might maintain a pixel buffer and implement <code>draw_rectangle</code> by setting pixel values in a loop. A <strong>GPU-accelerated backend</strong> might convert the same call into vertex buffer uploads and shader dispatch calls.</p>\n<p><strong>Font handling</strong> within the graphics abstraction requires careful design because text rendering involves platform-specific font loading, glyph rasterization, and text measurement capabilities. Our abstraction defines font operations that any backend must support:</p>\n<table>\n<thead>\n<tr>\n<th>Font Operation</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>load_font</code></td>\n<td>family: String, size: f32, weight: u16</td>\n<td>Result&lt;FontHandle, String&gt;</td>\n<td>Load font for text rendering</td>\n</tr>\n<tr>\n<td><code>measure_text</code></td>\n<td>text: &amp;str, font: FontHandle</td>\n<td>TextMetrics</td>\n<td>Calculate text dimensions</td>\n</tr>\n<tr>\n<td><code>get_font_metrics</code></td>\n<td>font: FontHandle</td>\n<td>FontMetrics</td>\n<td>Get baseline, ascent, descent</td>\n</tr>\n</tbody></table>\n<p>Different graphics backends implement font operations using their platform&#39;s text rendering systems. A backend targeting web browsers might use the Canvas 2D text API, while a native desktop backend might use operating system font services like DirectWrite on Windows or Core Text on macOS.</p>\n<blockquote>\n<p><strong>Decision: Abstract Graphics Interface Design</strong></p>\n<ul>\n<li><strong>Context</strong>: Need to support multiple graphics backends (software rendering, GPU acceleration, different platforms) while keeping the interface manageable</li>\n<li><strong>Options Considered</strong>: Low-level pixel manipulation interface, high-level scene graph interface, medium-level drawing primitives</li>\n<li><strong>Decision</strong>: Medium-level drawing primitives that match CSS painting model</li>\n<li><strong>Rationale</strong>: Low-level interfaces require reimplementing text rendering and clipping; high-level interfaces don&#39;t map cleanly to diverse backends; medium-level primitives align with CSS semantics and are implementable on various platforms</li>\n<li><strong>Consequences</strong>: Clean separation between rendering logic and graphics implementation, but requires careful primitive selection to avoid missing functionality</li>\n</ul>\n</blockquote>\n<p><strong>Error handling in graphics operations</strong> must account for various failure modes including out-of-memory conditions, invalid parameters, and backend-specific errors like graphics context loss. Our abstraction returns <code>Result</code> types for all operations that can fail, allowing the rendering engine to implement appropriate fallback strategies.</p>\n<p><strong>Resource management</strong> in graphics backends involves tracking allocated resources like font handles, textures, and rendering contexts. The abstraction defines clear ownership semantics: the backend owns graphics resources and provides handles to the rendering engine, while the rendering engine is responsible for releasing resources when no longer needed.</p>\n<p>A <strong>simple software rasterization backend</strong> serves as our reference implementation and provides a fallback rendering path that works on any platform. This backend maintains an internal pixel buffer and implements all drawing operations through direct pixel manipulation:</p>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Implementation Strategy</th>\n<th>Performance Characteristics</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Rectangle Drawing</td>\n<td>Nested loops setting pixel values</td>\n<td>O(width × height) per rectangle</td>\n</tr>\n<tr>\n<td>Text Rendering</td>\n<td>Bitmap font glyph copying</td>\n<td>O(character_count × glyph_size)</td>\n</tr>\n<tr>\n<td>Clipping</td>\n<td>Coordinate bounds checking</td>\n<td>O(1) per pixel, applied during rasterization</td>\n</tr>\n<tr>\n<td>Alpha Blending</td>\n<td>Per-pixel color interpolation</td>\n<td>O(1) per pixel with transparency</td>\n</tr>\n</tbody></table>\n<p><strong>Hardware-accelerated backends</strong> leverage GPU capabilities for improved performance on complex pages. These backends translate our abstract drawing commands into GPU operations:</p>\n<ul>\n<li>Rectangle drawing becomes vertex buffer uploads for quad rendering</li>\n<li>Text rendering uses glyph textures and instanced drawing</li>\n<li>Clipping maps to GPU scissor tests or stencil buffer operations</li>\n<li>Complex effects like shadows or gradients use pixel shaders</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Platform-Specific Font Metrics</strong>\nDifferent graphics backends often report slightly different font metrics for the same font family and size due to platform differences in font rasterization. This can cause text to appear at slightly different positions across backends, breaking layout consistency. To avoid this, implement font metric normalization in your graphics abstraction or use a cross-platform font rendering library like FreeType.</p>\n<p>⚠️ <strong>Pitfall: Coordinate System Mismatches</strong>\nGraphics systems use different coordinate origins (top-left vs bottom-left) and scaling factors (device pixels vs logical pixels). Failing to handle these differences in your graphics abstraction results in incorrectly positioned or sized elements. Always define a canonical coordinate system for your paint commands and handle transformations within each backend implementation.</p>\n<h3 id=\"rendering-optimizations\">Rendering Optimizations</h3>\n<p>Think of rendering optimizations as <strong>smart shortcuts</strong> that allow us to produce the same visual result with less computational work. Just as a skilled house painter might skip painting wall areas that will be completely covered by furniture, our rendering optimizations identify situations where we can avoid unnecessary drawing operations without affecting the final appearance.</p>\n<p>The optimization phase processes the generated display list before sending commands to the graphics backend, applying various techniques to reduce the total rendering workload. These optimizations operate on the principle of <strong>visual equivalence</strong>: any optimization that changes the final rendered appearance is incorrect, but optimizations that produce identical visual results while doing less work are valuable performance improvements.</p>\n<p><strong>Clipping-based culling</strong> represents the most fundamental rendering optimization. This technique eliminates paint commands for elements that fall completely outside the visible viewport or current clipping region. When an element&#39;s bounding rectangle has no intersection with the current clip bounds, none of its paint commands can affect the final output, so we can safely skip them entirely.</p>\n<p>The clipping optimization algorithm maintains a <strong>clip bounds stack</strong> as it processes the display list:</p>\n<ol>\n<li>Initialize clip bounds to the full viewport rectangle</li>\n<li>For each <code>SetClip</code> command, push the intersection of current bounds and new clip region</li>\n<li>For each drawing command, test if the command&#39;s bounds intersect the current clip bounds</li>\n<li>If no intersection exists, skip the command; otherwise, include it in the optimized display list</li>\n<li>For each <code>ClearClip</code> command, pop the previous clip bounds from the stack</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>Optimization Type</th>\n<th>Detection Method</th>\n<th>Performance Benefit</th>\n<th>Implementation Complexity</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Viewport Culling</td>\n<td>Rectangle intersection test</td>\n<td>Skip entire subtrees outside viewport</td>\n<td>Low - simple bounds checking</td>\n</tr>\n<tr>\n<td>Overdraw Elimination</td>\n<td>Z-order analysis of opaque rectangles</td>\n<td>Reduce pixel fill operations</td>\n<td>Medium - requires sorting and coverage analysis</td>\n</tr>\n<tr>\n<td>Command Batching</td>\n<td>Group similar consecutive commands</td>\n<td>Reduce graphics API call overhead</td>\n<td>Low - merge compatible operations</td>\n</tr>\n<tr>\n<td>Empty Command Removal</td>\n<td>Check for zero-sized or transparent operations</td>\n<td>Eliminate no-op graphics calls</td>\n<td>Low - validate command parameters</td>\n</tr>\n</tbody></table>\n<p><strong>Overdraw elimination</strong> optimizes cases where multiple elements paint to the same screen region by identifying situations where later drawing operations completely obscure earlier ones. If we have two opaque rectangles that occupy the same screen area, we only need to draw the topmost rectangle since it will completely hide the one behind it.</p>\n<p>The overdraw elimination algorithm requires analyzing the <strong>z-order relationships</strong> between paint commands:</p>\n<ol>\n<li>Sort paint commands by their z-order position (background to foreground)</li>\n<li>For each opaque rectangle command, check if any later opaque rectangles completely cover it</li>\n<li>If a rectangle is completely covered by later rectangles, mark it for removal</li>\n<li>Generate the final optimized display list excluding covered commands</li>\n</ol>\n<blockquote>\n<p><strong>Decision: Optimization Strategy</strong></p>\n<ul>\n<li><strong>Context</strong>: Display lists can contain many redundant or invisible drawing operations that waste rendering performance</li>\n<li><strong>Options Considered</strong>: No optimization (simple), conservative clipping only, aggressive optimization with complex analysis</li>\n<li><strong>Decision</strong>: Implement conservative clipping and simple batching optimizations</li>\n<li><strong>Rationale</strong>: Clipping provides significant performance benefits with minimal complexity; aggressive optimizations have diminishing returns and risk introducing visual bugs</li>\n<li><strong>Consequences</strong>: Good performance improvement for typical web content without excessive implementation complexity</li>\n</ul>\n</blockquote>\n<p><strong>Command batching</strong> groups consecutive similar drawing operations to reduce graphics API overhead. Many graphics systems have significant per-call costs, so combining multiple rectangle draws into a single batched operation can improve performance substantially. This optimization works best when the display list contains many similar operations in sequence.</p>\n<p>Batching opportunities include:</p>\n<ul>\n<li>Multiple <code>DrawRectangle</code> commands with the same color can be combined into a single call with multiple rectangles</li>\n<li>Consecutive <code>DrawText</code> commands using the same font can be batched into a single text rendering call</li>\n<li>Similar border drawing operations can be grouped to minimize graphics state changes</li>\n</ul>\n<p><strong>Empty command elimination</strong> removes paint commands that produce no visible output. These include rectangles with zero area, text commands with empty strings, or any drawing operations using completely transparent colors. While these commands are harmless, removing them reduces the workload on the graphics backend.</p>\n<p>The empty command detection process examines each paint command&#39;s parameters:</p>\n<table>\n<thead>\n<tr>\n<th>Command Type</th>\n<th>Empty Condition</th>\n<th>Optimization Action</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>DrawRectangle</code></td>\n<td>Width or height ≤ 0, or alpha = 0</td>\n<td>Remove command entirely</td>\n</tr>\n<tr>\n<td><code>DrawText</code></td>\n<td>Empty string or font size ≤ 0</td>\n<td>Remove command entirely</td>\n</tr>\n<tr>\n<td><code>DrawBorder</code></td>\n<td>All border widths = 0</td>\n<td>Remove command entirely</td>\n</tr>\n<tr>\n<td><code>SetClip</code></td>\n<td>Clip rectangle has zero area</td>\n<td>Replace with <code>ClearClip</code></td>\n</tr>\n</tbody></table>\n<p><strong>Display list compression</strong> optimizes memory usage by representing common patterns more efficiently. For example, a series of text drawing commands that differ only in their x-coordinates might be compressed into a single command with multiple text positions. This optimization is particularly valuable for pages with large amounts of text content.</p>\n<blockquote>\n<p>The key insight for rendering optimizations is to focus on the <strong>common cases</strong> that provide the biggest performance improvements. Optimizing rare edge cases often adds complexity without meaningful benefits, while simple optimizations like viewport culling can eliminate large amounts of unnecessary work with minimal code.</p>\n</blockquote>\n<p><strong>Damage tracking</strong> prepares our rendering system for future optimizations like incremental repainting. During the optimization phase, we can mark which regions of the screen are affected by each paint command, enabling future updates to only repaint the portions of the page that have actually changed.</p>\n<p>⚠️ <strong>Pitfall: Over-Aggressive Culling</strong>\nA common mistake is culling elements based only on their content rectangles without considering effects like box shadows, outlines, or transforms that can extend beyond the element&#39;s normal bounds. This results in visual artifacts where parts of elements disappear when they should remain visible. Always use the complete visual bounds of an element, including all graphical effects, when making culling decisions.</p>\n<p>⚠️ <strong>Pitfall: Incorrect Z-Order Optimization</strong>\nWhen implementing overdraw elimination, developers sometimes incorrectly assume that later elements in the DOM always paint over earlier elements. This ignores CSS stacking contexts and z-index properties that can cause earlier elements to appear above later ones. Always use the computed z-order from layout rather than DOM order when making overdraw optimization decisions.</p>\n<p><img src=\"/api/project/build-browser/architecture-doc/asset?path=diagrams%2Frendering-paint-order.svg\" alt=\"Paint Command Generation Sequence\"></p>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>The rendering engine implementation combines paint command generation, graphics abstraction, and optimization techniques into a cohesive system that produces visual output from layout trees.</p>\n<p><strong>Technology Recommendations:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Graphics Backend</td>\n<td>Software rasterization with RGB buffer</td>\n<td>Hardware acceleration with wgpu or vulkano</td>\n</tr>\n<tr>\n<td>Font Handling</td>\n<td>Fixed-width character approximation</td>\n<td>System fonts with fontdue or rusttype</td>\n</tr>\n<tr>\n<td>Image Output</td>\n<td>Raw pixel buffer to file</td>\n<td>PNG encoding with image crate</td>\n</tr>\n<tr>\n<td>Performance Profiling</td>\n<td>Manual timing with std::time::Instant</td>\n<td>Profiling with puffin or tracy</td>\n</tr>\n</tbody></table>\n<p><strong>Recommended File Structure:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>src/\n  render/\n    mod.rs                    ← Public API and RenderEngine\n    paint/\n      mod.rs                  ← Paint command generation\n      commands.rs             ← PaintCommand definitions\n      painter.rs              ← Layout tree traversal\n    graphics/\n      mod.rs                  ← Graphics backend abstraction\n      software.rs             ← Software rasterization backend\n      types.rs                ← Graphics primitives and colors\n    optimize/\n      mod.rs                  ← Display list optimizations\n      culling.rs              ← Viewport and clip culling\n      batching.rs             ← Command batching</code></pre></div>\n\n<p><strong>Core Graphics Types (Complete Implementation):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// graphics/types.rs - Complete graphics primitives</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">collections</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">HashMap</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> a</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> rgb</span><span style=\"color:#E1E4E8\">(r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Color</span><span style=\"color:#E1E4E8\"> { r, g, b, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> rgba</span><span style=\"color:#E1E4E8\">(r</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Color</span><span style=\"color:#E1E4E8\"> { r, g, b, a }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> from_hex</span><span style=\"color:#E1E4E8\">(hex</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> hex </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> hex</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">trim_start_matches</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'#'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> hex</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 6</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> Err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid hex color length: {}\"</span><span style=\"color:#E1E4E8\">, hex));</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> r </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">hex[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#F97583\">..</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid hex color: {}\"</span><span style=\"color:#E1E4E8\">, hex))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> g </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">hex[</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#F97583\">..</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid hex color: {}\"</span><span style=\"color:#E1E4E8\">, hex))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> b </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_str_radix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">hex[</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#F97583\">..</span><span style=\"color:#79B8FF\">6</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            .</span><span style=\"color:#B392F0\">map_err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">|</span><span style=\"color:#E1E4E8\">_</span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Invalid hex color: {}\"</span><span style=\"color:#E1E4E8\">, hex))</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">rgb</span><span style=\"color:#E1E4E8\">(r, g, b))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> is_transparent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">a </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> 0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> blend_over</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, background</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">a </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            *</span><span style=\"color:#79B8FF\">self</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        } </span><span style=\"color:#F97583\">else</span><span style=\"color:#F97583\"> if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">a </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            background</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#E1E4E8\"> alpha </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">a </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#F97583\"> /</span><span style=\"color:#79B8FF\"> 255.0</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            let</span><span style=\"color:#E1E4E8\"> inv_alpha </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 1.0</span><span style=\"color:#F97583\"> -</span><span style=\"color:#E1E4E8\"> alpha;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            Color</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">rgba</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                ((</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">r </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> alpha) </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> (background</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">r </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> inv_alpha)) </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                ((</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">g </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> alpha) </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> (background</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">g </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> inv_alpha)) </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                ((</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">b </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> alpha) </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> (background</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">b </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> inv_alpha)) </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> u8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">                255</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> WHITE</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> BLACK</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 255</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> TRANSPARENT</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\"> { r</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, g</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, b</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, a</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> FontInfo</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> family</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> weight</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u16</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> style</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> FontStyle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> FontStyle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Normal</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Italic</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> TextMetrics</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> advance_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> ascent</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> descent</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> line_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Display List and Paint Commands (Complete Implementation):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// paint/commands.rs - Complete paint command definitions</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Point</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">render</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">graphics</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">FontInfo</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">style</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">BoxOffsets</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> PaintCommand</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    DrawRectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        color</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    DrawBorder</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        widths</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> BoxOffsets</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        colors</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> [</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">], </span><span style=\"color:#6A737D\">// top, right, bottom, left</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    DrawText</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        text</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        position</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        font</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> FontInfo</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        color</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    SetClip</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    ClearClip</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> DisplayList</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> commands</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">PaintCommand</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> viewport</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> background_color</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> DisplayList</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(viewport</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">, background_color</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        DisplayList</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            commands</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            viewport,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            background_color,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> add_command</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, command</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> PaintCommand</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">commands</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">push</span><span style=\"color:#E1E4E8\">(command);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> command_count</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">commands</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> clear</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">commands</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">clear</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Graphics Backend Trait (Interface Definition):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// graphics/mod.rs - Graphics backend abstraction</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Point</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Size</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">render</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">graphics</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">FontInfo</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">TextMetrics</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">style</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">BoxOffsets</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> trait</span><span style=\"color:#B392F0\"> GraphicsBackend</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    type</span><span style=\"color:#B392F0\"> Surface</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    type</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">error</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Create a new drawing surface with specified dimensions</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> create_surface</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Surface</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Fill a rectangular region with solid color</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> draw_rectangle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, surface</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Surface</span><span style=\"color:#E1E4E8\">, rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">, color</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\">) </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        -></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Draw a bordered rectangle with per-edge styling</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> draw_border</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, surface</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Surface</span><span style=\"color:#E1E4E8\">, rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                  widths</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> BoxOffsets</span><span style=\"color:#E1E4E8\">, colors</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> [</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">]) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Render text at specified position</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> draw_text</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, surface</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Surface</span><span style=\"color:#E1E4E8\">, text</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, position</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                font</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> FontInfo</span><span style=\"color:#E1E4E8\">, color</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Establish clipping region for subsequent draws</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> set_clip_rect</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, surface</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Surface</span><span style=\"color:#E1E4E8\">, rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">) </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        -></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Remove current clipping region</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> clear_clip</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, surface</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Surface</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Calculate text dimensions for layout</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> measure_text</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, text</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, font</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">FontInfo</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> TextMetrics</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Finalize surface and return pixel data</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> present_surface</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, surface</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Surface</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">u8</span><span style=\"color:#E1E4E8\">>, </span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Paint Command Generator (Core Logic Skeleton):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// paint/painter.rs - Layout tree to paint command conversion</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">BoxType</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">render</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">paint</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">PaintCommand</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">DisplayList</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">render</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">graphics</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">FontInfo</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">style</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> PaintCommandGenerator</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> PaintCommandGenerator</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Generate display list from layout tree</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> generate_display_list</span><span style=\"color:#E1E4E8\">(layout_root</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, viewport</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> DisplayList</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> display_list </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> DisplayList</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(viewport, </span><span style=\"color:#79B8FF\">WHITE</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> generator </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> PaintCommandGenerator</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Start paint command generation from root</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Set initial clipping bounds to viewport</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Generate background command for root if needed</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Recursively paint all child boxes</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Return completed display list</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        display_list</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Paint a single layout box and its children</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> paint_box</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, layout_box</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, display_list</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> DisplayList</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Check if box intersects current clipping bounds (optimization)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Paint background if background color is not transparent</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Paint borders if any border has non-zero width</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Paint content based on box type (text vs container)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Set up clipping for children if overflow is hidden</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Recursively paint child boxes</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Clear clipping if it was set for this box</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use layout_box.computed_style to get colors and other properties</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use layout_box.content_rect, padding_rect, border_rect for positioning</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Generate background paint command for layout box</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> paint_background</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, layout_box</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, display_list</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> DisplayList</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Get background color from computed style</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Check if background color is not transparent</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Create DrawRectangle command using padding_rect as bounds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Add command to display list</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Background fills the padding area (content + padding)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Generate border paint commands for layout box</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> paint_borders</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, layout_box</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, display_list</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> DisplayList</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Get border widths and colors from computed style</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Check if any border width is greater than 0</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Create DrawBorder command using border_rect as bounds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Set up border colors array [top, right, bottom, left]</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Add command to display list</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use BoxOffsets for border widths</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Generate text paint command for text content</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> paint_text</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, layout_box</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, display_list</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> DisplayList</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Extract text content from layout box (only for TextBox type)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Get font information from computed style</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Calculate baseline position from content_rect and font metrics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Create FontInfo struct with family, size, weight</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Create DrawText command with text, position, font, color</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Add command to display list</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Text baseline is content_rect.origin.y + ascent</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use computed_style.color for text color</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Software Rasterization Backend (Complete Implementation):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// graphics/software.rs - Simple pixel buffer backend</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Point</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Size</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">render</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">graphics</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">GraphicsBackend</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">FontInfo</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">TextMetrics</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">style</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">BoxOffsets</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">cmp</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{min, max};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> SoftwareRenderer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    font_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    char_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    line_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> PixelSurface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> u32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pixels</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">u8</span><span style=\"color:#E1E4E8\">>, </span><span style=\"color:#6A737D\">// RGBA format</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    clip_stack</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> SoftwareError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    InvalidDimensions</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    OutOfBounds</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">error</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#F97583\"> for</span><span style=\"color:#B392F0\"> SoftwareError</span><span style=\"color:#E1E4E8\"> {}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Display</span><span style=\"color:#F97583\"> for</span><span style=\"color:#B392F0\"> SoftwareError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> fmt</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, f</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Formatter</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Result</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            SoftwareError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">InvalidDimensions</span><span style=\"color:#F97583\"> =></span><span style=\"color:#B392F0\"> write!</span><span style=\"color:#E1E4E8\">(f, </span><span style=\"color:#9ECBFF\">\"Invalid surface dimensions\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            SoftwareError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">OutOfBounds</span><span style=\"color:#F97583\"> =></span><span style=\"color:#B392F0\"> write!</span><span style=\"color:#E1E4E8\">(f, </span><span style=\"color:#9ECBFF\">\"Drawing operation out of bounds\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> SoftwareRenderer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        SoftwareRenderer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            font_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 14.0</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            char_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 8.0</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            line_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 16.0</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> GraphicsBackend</span><span style=\"color:#F97583\"> for</span><span style=\"color:#B392F0\"> SoftwareRenderer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    type</span><span style=\"color:#B392F0\"> Surface</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> PixelSurface</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    type</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> SoftwareError</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> create_surface</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">PixelSurface</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">SoftwareError</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> Err</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">SoftwareError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">InvalidDimensions</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> width </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> u32</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> height </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> u32</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> pixel_count </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (width </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> height </span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\"> 4</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#6A737D\">// RGBA</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">PixelSurface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            width,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            height,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            pixels</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> vec!</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#79B8FF\">255</span><span style=\"color:#E1E4E8\">; pixel_count], </span><span style=\"color:#6A737D\">// Start with white background</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            clip_stack</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> draw_rectangle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, surface</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> PixelSurface</span><span style=\"color:#E1E4E8\">, rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">, color</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#E1E4E8\">) </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        -></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#B392F0\">SoftwareError</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> clip_rect </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">current_clip_bounds</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> clipped_rect </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">intersect</span><span style=\"color:#E1E4E8\">(clip_rect);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> clipped_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> clipped_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> Ok</span><span style=\"color:#E1E4E8\">(()); </span><span style=\"color:#6A737D\">// Rectangle completely clipped</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> x1 </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> clipped_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">max</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0.0</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> u32</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> y1 </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> clipped_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">max</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0.0</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> u32</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> x2 </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (clipped_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> clipped_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width)</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">min</span><span style=\"color:#E1E4E8\">(surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> u32</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> y2 </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (clipped_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> clipped_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height)</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">min</span><span style=\"color:#E1E4E8\">(surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> u32</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        for</span><span style=\"color:#E1E4E8\"> y </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> y1</span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\">y2 {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            for</span><span style=\"color:#E1E4E8\"> x </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> x1</span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\">x2 {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                let</span><span style=\"color:#E1E4E8\"> pixel_index </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> ((y </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> x) </span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\"> 4</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                if</span><span style=\"color:#E1E4E8\"> pixel_index </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> 3</span><span style=\"color:#F97583\"> &#x3C;</span><span style=\"color:#E1E4E8\"> surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pixels</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                    // Simple alpha blending</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                    let</span><span style=\"color:#E1E4E8\"> bg_color </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> Color</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">rgba</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                        surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pixels[pixel_index],</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                        surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pixels[pixel_index </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\">],</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                        surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pixels[pixel_index </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> 2</span><span style=\"color:#E1E4E8\">],</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                        surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pixels[pixel_index </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> 3</span><span style=\"color:#E1E4E8\">],</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    );</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                    let</span><span style=\"color:#E1E4E8\"> blended </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> color</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">blend_over</span><span style=\"color:#E1E4E8\">(bg_color);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pixels[pixel_index] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> blended</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">r;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pixels[pixel_index </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> blended</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">g;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pixels[pixel_index </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> 2</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> blended</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">b;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pixels[pixel_index </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> 3</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> blended</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">a;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Ok</span><span style=\"color:#E1E4E8\">(())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Additional implementation methods...</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> measure_text</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, text</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, font</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">FontInfo</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> TextMetrics</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        TextMetrics</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            advance_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> text</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#F97583\"> *</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">char_width,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            ascent</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">font_size </span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\"> 0.8</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            descent</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">font_size </span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\"> 0.2</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            line_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">line_height,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> present_surface</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, surface</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> PixelSurface</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">u8</span><span style=\"color:#E1E4E8\">>, </span><span style=\"color:#B392F0\">SoftwareError</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Ok</span><span style=\"color:#E1E4E8\">(surface</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pixels)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO: Implement remaining GraphicsBackend methods</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // draw_border, draw_text, set_clip_rect, clear_clip</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> PixelSurface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> current_clip_bounds</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">clip_stack</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">last</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">copied</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">unwrap_or</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> { x</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> { width</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Render Engine Main Interface (Core Logic Skeleton):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// render/mod.rs - Main rendering engine interface</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Size</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">render</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">paint</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">PaintCommandGenerator</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">render</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">graphics</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">GraphicsBackend</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> RenderEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> viewport_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> RenderEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(viewport_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, viewport_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        RenderEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            viewport_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> { x</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> { width</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> viewport_width, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> viewport_height },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Complete rendering pipeline from layout tree to pixels</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> render_layout_tree</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">B</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> GraphicsBackend</span><span style=\"color:#E1E4E8\">>(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, layout_tree</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                                                 backend</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> B</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">u8</span><span style=\"color:#E1E4E8\">>, </span><span style=\"color:#B392F0\">B</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Generate display list from layout tree</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Apply rendering optimizations to display list</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Create graphics surface with viewport dimensions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Execute paint commands on graphics backend</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Present final surface and return pixel data</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use PaintCommandGenerator::generate_display_list</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use optimize_display_list for performance</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Loop through display_list.commands and call backend methods</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Apply optimizations to reduce rendering work</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> optimize_display_list</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, display_list</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> DisplayList</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Remove commands that draw outside viewport bounds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Eliminate commands with transparent colors</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Batch consecutive similar commands where possible</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Remove commands with zero-sized rectangles</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use Rectangle::intersects for viewport culling</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Check Color::is_transparent() for empty commands</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Execute display list commands on graphics backend</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> execute_display_list</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">B</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> GraphicsBackend</span><span style=\"color:#E1E4E8\">>(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, display_list</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DisplayList</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                                               backend</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> B</span><span style=\"color:#E1E4E8\">, surface</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> B</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Surface</span><span style=\"color:#E1E4E8\">) </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                                               -></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#B392F0\">B</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Clear surface with background color</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Iterate through all paint commands</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Match on command type and call appropriate backend method</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Handle SetClip and ClearClip commands for clipping stack</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Call draw methods for DrawRectangle, DrawBorder, DrawText</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use match expression on PaintCommand variants</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Pass command parameters directly to backend methods</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Milestone Checkpoint:</strong>\nAfter implementing the rendering engine, you should be able to:</p>\n<ol>\n<li><strong>Generate Paint Commands</strong>: Run <code>cargo test paint_generation</code> to verify that layout boxes produce the correct sequence of drawing commands</li>\n<li><strong>Software Rendering</strong>: Create a simple test that renders a layout tree to a pixel buffer and saves it as a PPM image file</li>\n<li><strong>Viewport Culling</strong>: Test that elements outside the viewport don&#39;t generate paint commands in the optimized display list</li>\n<li><strong>Visual Verification</strong>: Render a simple HTML page with colored backgrounds and borders, then visually inspect the output image</li>\n</ol>\n<p><strong>Expected Test Output:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Running paint generation tests...\n✓ Block element generates background rectangle\n✓ Text element generates text drawing command  \n✓ Bordered element generates border commands\n✓ Clipped content generates clip commands\n✓ Viewport culling removes off-screen elements\n\nRendering complete: output saved to test_render.ppm\nDisplay list: 15 commands generated, 12 after optimization</code></pre></div>\n\n<p><strong>Debugging Tips:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>How to Diagnose</th>\n<th>Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>All elements appear black</td>\n<td>Missing color information in paint commands</td>\n<td>Print paint command colors</td>\n<td>Check computed style color resolution</td>\n</tr>\n<tr>\n<td>Text positioned incorrectly</td>\n<td>Wrong baseline calculation</td>\n<td>Compare font metrics with text position</td>\n<td>Add font ascent to y-coordinate</td>\n</tr>\n<tr>\n<td>Elements clipped unexpectedly</td>\n<td>Clipping bounds too restrictive</td>\n<td>Log clip rectangle stack</td>\n<td>Verify parent element overflow handling</td>\n</tr>\n<tr>\n<td>Performance very slow</td>\n<td>No viewport culling optimization</td>\n<td>Profile paint command count</td>\n<td>Implement rectangle intersection culling</td>\n</tr>\n</tbody></table>\n<h2 id=\"component-interactions-and-data-flow\">Component Interactions and Data Flow</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> All milestones (1-4) - This section documents the complete data flow through the rendering pipeline and the formal interfaces between HTML parsing, CSS parsing, layout computation, and rendering stages.</p>\n</blockquote>\n<p>Building a browser engine requires orchestrating four distinct processing stages that must work together seamlessly. Think of this as <strong>the orchestra conductor&#39;s score</strong> — each section (HTML parser, CSS parser, layout engine, rendering engine) has its own specialized role, but the magic happens when they play together in perfect harmony. The conductor (our <code>BrowserEngine</code>) ensures that the output from one section becomes the perfectly formatted input for the next, maintaining timing and synchronization throughout the entire performance.</p>\n<p>The rendering pipeline transforms simple text strings into complex visual output through a series of well-defined data transformations. Each stage has strict input requirements and produces specific output formats that the next stage depends upon. Understanding these interfaces is crucial for debugging issues, optimizing performance, and extending functionality. When a web page renders incorrectly, the problem often lies not within a single component, but in the data transformation between components.</p>\n<p><img src=\"/api/project/build-browser/architecture-doc/asset?path=diagrams%2Frendering-pipeline-overview.svg\" alt=\"Browser Rendering Pipeline\"></p>\n<p>The component interaction model follows a <strong>unidirectional data flow pattern</strong> where each stage completes its processing before passing results to the next stage. This design choice eliminates complex feedback loops and makes the system more predictable and debuggable. However, it also means that each stage must produce complete, self-contained output that includes all information the downstream stages will need.</p>\n<h3 id=\"end-to-end-pipeline-flow\">End-to-End Pipeline Flow</h3>\n<p>The complete rendering pipeline transforms raw HTML and CSS text through four distinct processing stages, with each stage operating on the output of the previous stage. Think of this as <strong>a document assembly line in a printing factory</strong> — raw text enters at one end, passes through specialized machines that perform specific transformations, and emerges as a finished visual document ready for display.</p>\n<p>The pipeline begins when the <code>BrowserEngine</code> receives HTML content and optional CSS stylesheets. The engine coordinates the entire process, managing viewport dimensions, error handling, and resource allocation across all stages. Each stage operates independently but relies on well-defined data contracts to ensure compatibility.</p>\n<h4 id=\"stage-1-html-text-to-dom-tree\">Stage 1: HTML Text to DOM Tree</h4>\n<p>The first transformation converts raw HTML text into a structured <code>DOMNode</code> tree that represents the document&#39;s logical hierarchy. The <code>HTMLParser</code> operates through two distinct phases: tokenization and tree construction.</p>\n<p>During tokenization, the parser&#39;s state machine processes the HTML character stream and produces a sequence of <code>HTMLToken</code> objects. Each token represents a semantic unit like a start tag, end tag, text content, or comment. The tokenizer handles complex scenarios including quoted attributes, entity decoding, and malformed markup recovery.</p>\n<table>\n<thead>\n<tr>\n<th>Input</th>\n<th>Processing</th>\n<th>Output</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Raw HTML string</td>\n<td>Character-by-character state machine tokenization</td>\n<td>Stream of <code>HTMLToken</code> objects</td>\n</tr>\n<tr>\n<td><code>HTMLToken</code> stream</td>\n<td>Stack-based tree construction with error recovery</td>\n<td><code>DOMNode</code> tree with parent-child relationships</td>\n</tr>\n</tbody></table>\n<p>The tree construction phase consumes the token stream and builds the hierarchical DOM structure. A <code>TreeBuilder</code> maintains a stack of open elements and processes each token according to HTML parsing rules. When it encounters a start tag token, it creates a new <code>DOMNode</code> with <code>ElementData</code> and pushes it onto the element stack. Text tokens become text nodes attached to the current element. End tag tokens pop elements from the stack, establishing the final parent-child relationships.</p>\n<p><strong>Error recovery</strong> plays a critical role during tree construction. When the parser encounters malformed HTML like missing closing tags or improperly nested elements, it uses standardized recovery algorithms to produce a valid tree structure. For example, if it finds a <code>&lt;/div&gt;</code> tag but the current element is a <code>&lt;span&gt;</code>, the parser automatically closes the span element before processing the div end tag.</p>\n<blockquote>\n<p><strong>Critical Design Insight</strong>: The DOM tree must be complete and internally consistent before any subsequent stage can begin processing. Partial or malformed trees will cause cascading failures in styling and layout calculations.</p>\n</blockquote>\n<h4 id=\"stage-2-dom-tree-css-rules-to-styled-tree\">Stage 2: DOM Tree + CSS Rules to Styled Tree</h4>\n<p>The second transformation applies CSS styling rules to the DOM tree, producing a styled tree where each element has computed style properties. This process involves three sub-stages: CSS parsing, selector matching, and cascade resolution.</p>\n<p>The <code>CSSParser</code> first transforms CSS text into structured <code>CSSRule</code> objects. Each rule contains a <code>Selector</code> that specifies which elements it applies to, and a list of <code>Declaration</code> objects that specify property values. The parser handles complex scenarios including selector combinators, shorthand properties, and malformed CSS recovery.</p>\n<table>\n<thead>\n<tr>\n<th>CSS Input</th>\n<th>Processing Phase</th>\n<th>Intermediate Output</th>\n<th>Final Output</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>CSS text string</td>\n<td>Tokenization and rule parsing</td>\n<td><code>Vec&lt;CSSRule&gt;</code> in <code>Stylesheet</code></td>\n<td><code>Stylesheet</code> with calculated specificity</td>\n</tr>\n<tr>\n<td><code>Stylesheet</code> + <code>DOMNode</code></td>\n<td>Selector matching and specificity calculation</td>\n<td>Matching rules per element</td>\n<td>Element with applicable rules</td>\n</tr>\n<tr>\n<td>Applicable rules</td>\n<td>Cascade algorithm and inheritance</td>\n<td>Resolved property values</td>\n<td><code>ComputedStyle</code> for each element</td>\n</tr>\n</tbody></table>\n<p>Selector matching tests each CSS rule against each DOM element using the <code>matches_element</code> function. This process considers the element&#39;s tag name, class list, ID, and position within the DOM tree. Complex selectors like descendant combinators require traversing up the DOM tree to find matching ancestors.</p>\n<p>The cascade resolution stage determines the final computed style for each element. The <code>StyleResolver</code> applies the cascade algorithm, which prioritizes rules based on specificity, source order, and importance. The <code>calculate_specificity</code> function computes the four-tuple (inline, ids, classes, elements) that determines rule precedence.</p>\n<p><strong>Inheritance</strong> adds another layer of complexity. Properties like <code>color</code> and <code>font-family</code> automatically inherit from parent elements unless explicitly overridden. The style resolver must traverse the DOM tree in document order to ensure that inherited values are available when processing child elements.</p>\n<h4 id=\"stage-3-styled-tree-to-layout-tree\">Stage 3: Styled Tree to Layout Tree</h4>\n<p>The third transformation calculates the size and position of every element, producing a <code>LayoutTree</code> where each node contains geometric information. This stage implements the CSS box model and formatting context algorithms.</p>\n<p>The <code>LayoutEngine</code> traverses the styled DOM tree and creates corresponding <code>LayoutBox</code> nodes. Each layout box contains four nested rectangles representing the margin, border, padding, and content areas. The engine must resolve auto values, handle percentage units, and implement margin collapsing.</p>\n<table>\n<thead>\n<tr>\n<th>Styled Input</th>\n<th>Layout Processing</th>\n<th>Geometric Output</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>ComputedStyle</code> with CSS values</td>\n<td>Box model calculation</td>\n<td>Four nested rectangles per element</td>\n</tr>\n<tr>\n<td>Parent dimensions and constraints</td>\n<td>Block formatting context</td>\n<td>Child positions and sizes</td>\n</tr>\n<tr>\n<td>Available width and text content</td>\n<td>Inline formatting with line breaking</td>\n<td><code>LineBox</code> objects with text positioning</td>\n</tr>\n</tbody></table>\n<p><strong>Block formatting context</strong> handles elements with <code>display: block</code>. The layout engine processes block children in document order, calculating their width based on the containing block and stacking them vertically. Margin collapsing between adjacent block elements requires careful tracking of margin values.</p>\n<p><strong>Inline formatting context</strong> handles text and inline elements. The layout engine flows content horizontally, creating <code>LineBox</code> objects when content exceeds the available width. Text measurement using <code>SimpleTextMeasurer</code> determines where line breaks should occur and calculates baseline alignment for mixed content.</p>\n<p>The <code>calculate_box_model</code> method performs the core geometric calculations. It resolves percentage units relative to the containing block, handles auto margins by centering or expanding elements, and ensures that the total box dimensions fit within available space.</p>\n<h4 id=\"stage-4-layout-tree-to-visual-output\">Stage 4: Layout Tree to Visual Output</h4>\n<p>The final transformation converts the positioned layout tree into drawing commands that produce visual output. The <code>RenderEngine</code> generates a <code>DisplayList</code> containing <code>PaintCommand</code> objects that specify exactly what to draw and where.</p>\n<p>The rendering engine traverses the layout tree in paint order, which considers z-index values and stacking contexts. For each layout box, it generates multiple paint commands: background rectangles, border segments, and text drawing operations.</p>\n<table>\n<thead>\n<tr>\n<th>Layout Input</th>\n<th>Paint Processing</th>\n<th>Visual Output</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>LayoutBox</code> with computed rectangles</td>\n<td>Background and border paint commands</td>\n<td><code>DrawRectangle</code> and <code>DrawBorder</code> commands</td>\n</tr>\n<tr>\n<td>Text content with computed fonts</td>\n<td>Text measurement and positioning</td>\n<td><code>DrawText</code> commands with precise coordinates</td>\n</tr>\n<tr>\n<td><code>DisplayList</code> commands</td>\n<td>Graphics backend execution</td>\n<td>Pixel data in canvas buffer</td>\n</tr>\n</tbody></table>\n<p><strong>Paint command generation</strong> follows a specific order to ensure correct visual layering. The engine first generates background commands, then border commands, and finally text commands. This ensures that text appears on top of backgrounds and borders.</p>\n<p><strong>Clipping</strong> adds complexity to the rendering process. Elements with <code>overflow: hidden</code> create clipping contexts that restrict where child elements can draw. The renderer generates <code>SetClip</code> and <code>ClearClip</code> commands to manage these restricted drawing regions.</p>\n<blockquote>\n<p><strong>Performance Consideration</strong>: The display list acts as an optimization boundary. Once generated, it can be cached and reused if the layout doesn&#39;t change, avoiding expensive re-computation of paint commands.</p>\n</blockquote>\n<h3 id=\"component-interface-contracts\">Component Interface Contracts</h3>\n<p>Each stage of the rendering pipeline has formal interface contracts that specify the exact data formats and constraints for inputs and outputs. These contracts ensure that components can evolve independently while maintaining compatibility.</p>\n<p>Think of these contracts as <strong>diplomatic treaties between neighboring countries</strong> — they establish clear boundaries, specify what can cross those boundaries, and define the protocols for handling disputes (error conditions). Just as countries can change their internal policies without affecting their neighbors (as long as they honor treaty obligations), our components can optimize their internal algorithms without breaking the pipeline.</p>\n<h4 id=\"htmlparser-interface-contract\">HTMLParser Interface Contract</h4>\n<p>The HTML parser provides the foundational interface that converts unstructured text into structured data. Its contract must handle the full complexity of real-world HTML while providing clean, consistent output.</p>\n<table>\n<thead>\n<tr>\n<th>Method Signature</th>\n<th>Input Constraints</th>\n<th>Output Guarantees</th>\n<th>Error Conditions</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>parse_html(input: &amp;str)</code></td>\n<td>Valid UTF-8 string, arbitrary length</td>\n<td>Well-formed DOM tree with valid parent-child relationships</td>\n<td>Returns <code>Vec&lt;ParseError&gt;</code> for recoverable issues</td>\n</tr>\n<tr>\n<td><code>HTMLParser::new()</code></td>\n<td>None</td>\n<td>Ready-to-use parser instance</td>\n<td>Cannot fail</td>\n</tr>\n<tr>\n<td><code>next_token(&amp;mut self)</code></td>\n<td>Parser in valid state</td>\n<td>Next <code>HTMLToken</code> or None at end</td>\n<td>State machine handles all malformed input</td>\n</tr>\n</tbody></table>\n<p><strong>Input Processing Guarantees</strong>: The HTML parser must handle any valid UTF-8 string, including empty strings, strings containing only whitespace, and strings with malformed HTML. It cannot assume well-formed input and must implement error recovery for common malformation patterns.</p>\n<p><strong>Output Structure Guarantees</strong>: The parser guarantees that the returned <code>DOMNode</code> tree has these properties:</p>\n<ul>\n<li>Every node except the root has exactly one parent</li>\n<li>Parent nodes correctly reference all their children in document order  </li>\n<li>Text nodes contain only text content with no child elements</li>\n<li>Element nodes have valid tag names and attribute dictionaries</li>\n<li>The tree structure respects HTML nesting rules (with error recovery where necessary)</li>\n</ul>\n<p><strong>Error Handling Contract</strong>: The parser distinguishes between fatal errors (which prevent parsing) and recoverable errors (which allow parsing to continue with corrections). Fatal errors are extremely rare and typically indicate corrupted input encoding. Recoverable errors include missing closing tags, improper nesting, and invalid attributes. The parser collects all recoverable errors and returns them alongside the corrected DOM tree.</p>\n<table>\n<thead>\n<tr>\n<th>Error Type</th>\n<th>Recovery Strategy</th>\n<th>Tree Impact</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Missing closing tag</td>\n<td>Auto-close at document end or conflicting tag</td>\n<td>Creates valid tree structure</td>\n</tr>\n<tr>\n<td>Improper nesting</td>\n<td>Close conflicting elements early</td>\n<td>Flattens to valid nesting</td>\n</tr>\n<tr>\n<td>Invalid attributes</td>\n<td>Skip invalid attributes</td>\n<td>Element created with valid attributes only</td>\n</tr>\n<tr>\n<td>Malformed entities</td>\n<td>Use replacement character</td>\n<td>Text content contains � for bad entities</td>\n</tr>\n</tbody></table>\n<h4 id=\"styleresolver-interface-contract\">StyleResolver Interface Contract</h4>\n<p>The style resolution system bridges CSS and DOM by computing the final visual properties for each element. Its contract must handle CSS complexity while providing consistent computed values.</p>\n<table>\n<thead>\n<tr>\n<th>Method Signature</th>\n<th>Input Requirements</th>\n<th>Output Guarantees</th>\n<th>Performance Constraints</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>parse_stylesheet(css: &amp;str)</code></td>\n<td>Valid UTF-8 CSS text</td>\n<td><code>Stylesheet</code> with parsed rules and computed specificity</td>\n<td>O(n) where n is CSS length</td>\n</tr>\n<tr>\n<td><code>resolve_styles(root: &amp;DOMNode)</code></td>\n<td>Complete DOM tree with valid structure</td>\n<td><code>ComputedStyle</code> for every element in tree</td>\n<td>O(n*m) where n=elements, m=rules</td>\n</tr>\n<tr>\n<td><code>matches_element(selector: &amp;Selector, element: &amp;DOMNode)</code></td>\n<td>Valid selector and element with complete ancestry</td>\n<td>Boolean match result</td>\n<td>O(d) where d is tree depth</td>\n</tr>\n</tbody></table>\n<p><strong>CSS Parsing Guarantees</strong>: The CSS parser must produce a valid <code>Stylesheet</code> even from malformed CSS input. Invalid rules are skipped, but valid rules within the same stylesheet are preserved. The parser guarantees that:</p>\n<ul>\n<li>Every <code>CSSRule</code> has a valid <code>Selector</code> and at least one <code>Declaration</code></li>\n<li><code>Specificity</code> is correctly calculated according to CSS specification  </li>\n<li>Rules maintain source order for cascade resolution</li>\n<li>Shorthand properties are expanded into individual declarations</li>\n</ul>\n<p><strong>Style Resolution Guarantees</strong>: The style resolver produces complete <code>ComputedStyle</code> objects for every element in the DOM tree. Each computed style contains:</p>\n<ul>\n<li>Resolved values for all CSS properties (no &#39;inherit&#39; or &#39;auto&#39; keywords remain)</li>\n<li>Correct inheritance from parent elements  </li>\n<li>Applied cascade order based on specificity and source order</li>\n<li>Default values for properties not explicitly set</li>\n</ul>\n<p><strong>Cascade Algorithm Contract</strong>: The resolver implements the CSS cascade algorithm precisely:</p>\n<table>\n<thead>\n<tr>\n<th>Cascade Step</th>\n<th>Processing Order</th>\n<th>Conflict Resolution</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>User agent defaults</td>\n<td>Applied first</td>\n<td>Lowest priority</td>\n</tr>\n<tr>\n<td>Author stylesheet rules</td>\n<td>Applied by specificity</td>\n<td>Higher specificity wins</td>\n</tr>\n<tr>\n<td>Same specificity rules</td>\n<td>Applied by source order</td>\n<td>Later rules win</td>\n</tr>\n<tr>\n<td>!important declarations</td>\n<td>Applied after normal</td>\n<td>Reverse specificity order</td>\n</tr>\n</tbody></table>\n<h4 id=\"layoutengine-interface-contract\">LayoutEngine Interface Contract</h4>\n<p>The layout engine transforms styled elements into geometric boxes with precise positions and dimensions. Its contract must handle the full complexity of CSS layout while maintaining pixel-perfect accuracy.</p>\n<table>\n<thead>\n<tr>\n<th>Method Signature</th>\n<th>Input Requirements</th>\n<th>Output Guarantees</th>\n<th>Coordinate System</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>new(viewport_size: Rectangle)</code></td>\n<td>Valid positive viewport dimensions</td>\n<td>Ready layout engine</td>\n<td>Top-left origin coordinate system</td>\n</tr>\n<tr>\n<td><code>calculate_box_model(&amp;mut self, containing_block_size: Size)</code></td>\n<td>Complete computed styles</td>\n<td>Four nested rectangles per element</td>\n<td>Precise floating-point coordinates</td>\n</tr>\n<tr>\n<td><code>layout_block_children(&amp;mut self, available_width: f32)</code></td>\n<td>Block container with styled children</td>\n<td>Children positioned vertically</td>\n<td>Margin collapsing applied</td>\n</tr>\n</tbody></table>\n<p><strong>Box Model Calculation Guarantees</strong>: The layout engine guarantees that every <code>LayoutBox</code> contains geometrically consistent rectangles:</p>\n<ul>\n<li>Content rectangle is innermost</li>\n<li>Padding rectangle surrounds content rectangle  </li>\n<li>Border rectangle surrounds padding rectangle</li>\n<li>Margin rectangle surrounds border rectangle</li>\n<li>All rectangles use the same coordinate system and precise positioning</li>\n</ul>\n<p><strong>Formatting Context Contracts</strong>: The layout engine implements both block and inline formatting contexts with specific behaviors:</p>\n<table>\n<thead>\n<tr>\n<th>Formatting Context</th>\n<th>Child Positioning</th>\n<th>Width Calculation</th>\n<th>Height Calculation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Block</td>\n<td>Vertical stacking with margin collapse</td>\n<td>Fill available width or explicit width</td>\n<td>Sum of content height</td>\n</tr>\n<tr>\n<td>Inline</td>\n<td>Horizontal flow with line wrapping</td>\n<td>Sum of child widths with line breaking</td>\n<td>Line height based on font metrics</td>\n</tr>\n</tbody></table>\n<p><strong>Measurement and Positioning Precision</strong>: All layout calculations use 32-bit floating-point precision to avoid rounding errors. The layout engine maintains sub-pixel accuracy throughout all calculations and only rounds to integer pixels during final rendering.</p>\n<h4 id=\"renderengine-interface-contract\">RenderEngine Interface Contract</h4>\n<p>The rendering engine generates the final visual output by converting layout trees into drawing commands. Its contract must handle all visual CSS properties while maintaining efficient rendering performance.</p>\n<table>\n<thead>\n<tr>\n<th>Method Signature</th>\n<th>Input Requirements</th>\n<th>Output Guarantees</th>\n<th>Rendering Order</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>new(viewport_size: Rectangle)</code></td>\n<td>Valid viewport dimensions</td>\n<td>Configured render engine</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><code>generate_display_list(layout_root: &amp;LayoutBox)</code></td>\n<td>Complete layout tree</td>\n<td>Ordered paint commands</td>\n<td>Background → Border → Content</td>\n</tr>\n<tr>\n<td><code>render_to_canvas(display_list: &amp;DisplayList)</code></td>\n<td>Valid display list</td>\n<td>Updated canvas buffer</td>\n<td>Commands executed in order</td>\n</tr>\n</tbody></table>\n<p><strong>Paint Command Generation Guarantees</strong>: The renderer produces a <code>DisplayList</code> with commands in correct paint order:</p>\n<ul>\n<li>Background commands appear before content commands for the same element</li>\n<li>Parent element backgrounds appear before child element backgrounds  </li>\n<li>Text commands appear after all background and border commands</li>\n<li>Clipping commands properly nest with matching <code>SetClip</code>/<code>ClearClip</code> pairs</li>\n</ul>\n<p><strong>Visual Property Support</strong>: The renderer handles all visual CSS properties supported by our simplified browser:</p>\n<table>\n<thead>\n<tr>\n<th>CSS Property</th>\n<th>Paint Command Type</th>\n<th>Special Handling</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>background-color</code></td>\n<td><code>DrawRectangle</code></td>\n<td>Transparent colors skip command generation</td>\n</tr>\n<tr>\n<td><code>border</code></td>\n<td><code>DrawBorder</code></td>\n<td>Separate commands for each border side</td>\n</tr>\n<tr>\n<td>Text content</td>\n<td><code>DrawText</code></td>\n<td>Font fallback and baseline alignment</td>\n</tr>\n<tr>\n<td><code>overflow: hidden</code></td>\n<td><code>SetClip</code>/<code>ClearClip</code></td>\n<td>Nested clipping contexts</td>\n</tr>\n</tbody></table>\n<p><strong>Canvas Output Contract</strong>: The rendering engine guarantees that the final canvas contains pixel-perfect representation of the layout tree:</p>\n<ul>\n<li>Colors match CSS color specifications exactly</li>\n<li>Text appears at computed baseline positions  </li>\n<li>Elements respect stacking order and clipping boundaries</li>\n<li>Transparent areas remain unmodified in the canvas buffer</li>\n</ul>\n<blockquote>\n<p><strong>Integration Testing Insight</strong>: The interface contracts enable comprehensive testing by allowing mock implementations of each stage. Testing can verify that a mock DOM tree produces expected layout boxes, or that specific layout boxes generate correct paint commands.</p>\n</blockquote>\n<h3 id=\"data-transformation-validation\">Data Transformation Validation</h3>\n<p>Each pipeline stage includes built-in validation to ensure that data transformations maintain correctness and catch errors early. Think of this as <strong>quality control checkpoints on the assembly line</strong> — each station verifies that the previous station&#39;s work meets specifications before adding its own processing.</p>\n<p>The validation system serves two critical purposes: debugging aid for developers implementing the browser engine, and runtime safety for handling malformed web content. Validation checks are designed to be comprehensive enough to catch implementation bugs while being efficient enough to run on every document.</p>\n<h4 id=\"dom-tree-validation\">DOM Tree Validation</h4>\n<p>After HTML parsing completes, the DOM tree undergoes structural validation to ensure it meets the requirements for style resolution:</p>\n<table>\n<thead>\n<tr>\n<th>Validation Check</th>\n<th>Correctness Requirement</th>\n<th>Failure Impact</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Parent-child consistency</td>\n<td>Every child&#39;s parent points back to containing node</td>\n<td>Style inheritance breaks</td>\n</tr>\n<tr>\n<td>Tree connectivity</td>\n<td>Every node reachable from root via parent/child links</td>\n<td>Parts of document disappear</td>\n</tr>\n<tr>\n<td>Node type validity</td>\n<td>Element nodes have tag names, text nodes have content</td>\n<td>Style matching fails</td>\n</tr>\n<tr>\n<td>Circular reference detection</td>\n<td>No cycles in parent-child relationships</td>\n<td>Infinite loops in tree traversal</td>\n</tr>\n</tbody></table>\n<h4 id=\"style-resolution-validation\">Style Resolution Validation</h4>\n<p>The styled tree validation ensures that computed styles are complete and consistent:</p>\n<table>\n<thead>\n<tr>\n<th>Validation Check</th>\n<th>Style Requirement</th>\n<th>Layout Impact</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Complete property coverage</td>\n<td>Every element has values for all layout-affecting properties</td>\n<td>Layout calculations fail</td>\n</tr>\n<tr>\n<td>Resolved value validation</td>\n<td>No &#39;inherit&#39;, &#39;auto&#39;, or other unresolved values remain</td>\n<td>Box model computation breaks</td>\n</tr>\n<tr>\n<td>Inheritance consistency</td>\n<td>Inherited properties match parent computed values</td>\n<td>Visual inconsistencies</td>\n</tr>\n<tr>\n<td>Cascade order verification</td>\n<td>Rules applied in correct specificity and source order</td>\n<td>Wrong styles applied</td>\n</tr>\n</tbody></table>\n<h4 id=\"layout-tree-validation\">Layout Tree Validation</h4>\n<p>Layout validation ensures geometric consistency and prevents rendering errors:</p>\n<table>\n<thead>\n<tr>\n<th>Validation Check</th>\n<th>Geometric Requirement</th>\n<th>Rendering Impact</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Rectangle nesting</td>\n<td>Content ⊆ Padding ⊆ Border ⊆ Margin for every box</td>\n<td>Visual overlaps and gaps</td>\n</tr>\n<tr>\n<td>Coordinate consistency</td>\n<td>All coordinates within viewport bounds</td>\n<td>Clipping and drawing errors</td>\n</tr>\n<tr>\n<td>Dimension positivity</td>\n<td>All widths and heights are non-negative</td>\n<td>Graphics API failures</td>\n</tr>\n<tr>\n<td>Parent-child containment</td>\n<td>Child boxes positioned within parent content area</td>\n<td>Layout overflow issues</td>\n</tr>\n</tbody></table>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>Building the component interaction system requires careful attention to data flow orchestration and error propagation. The implementation focuses on creating clean interfaces between pipeline stages while maintaining performance and debuggability.</p>\n<h4 id=\"technology-recommendations\">Technology Recommendations</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Implementation</th>\n<th>Production-Ready Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Pipeline Orchestration</td>\n<td>Direct function calls with error propagation</td>\n<td>Async pipeline with cancellation support</td>\n</tr>\n<tr>\n<td>Data Validation</td>\n<td>Assert macros in debug builds</td>\n<td>Comprehensive validation with detailed error messages</td>\n</tr>\n<tr>\n<td>Performance Monitoring</td>\n<td>Simple timing measurements</td>\n<td>Structured profiling with stage-by-stage metrics</td>\n</tr>\n<tr>\n<td>Error Handling</td>\n<td>Result types with error enums</td>\n<td>Hierarchical error types with context preservation</td>\n</tr>\n</tbody></table>\n<h4 id=\"recommended-file-structure\">Recommended File Structure</h4>\n<p>The component interaction system spans multiple modules but centralizes orchestration logic:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>src/\n  engine/\n    browser_engine.rs     ← main pipeline orchestration\n    pipeline.rs           ← stage interface definitions  \n    validation.rs         ← cross-stage validation logic\n  html/\n    parser.rs            ← HTML parsing implementation\n    mod.rs               ← HTML parser public interface\n  css/\n    parser.rs            ← CSS parsing implementation\n    resolver.rs          ← Style resolution implementation  \n    mod.rs               ← CSS system public interface\n  layout/\n    engine.rs            ← Layout calculation implementation\n    mod.rs               ← Layout engine public interface\n  render/\n    engine.rs            ← Rendering implementation\n    display_list.rs      ← Paint command generation\n    mod.rs               ← Render engine public interface\n  types/\n    mod.rs               ← Shared type definitions</code></pre></div>\n\n<h4 id=\"pipeline-orchestration-infrastructure\">Pipeline Orchestration Infrastructure</h4>\n<p>The <code>BrowserEngine</code> coordinates the entire rendering pipeline with comprehensive error handling:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Complete pipeline orchestration with validation and error handling</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">types</span><span style=\"color:#F97583\">::*</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">time</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Instant</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> viewport_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    html_parser</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HTMLParser</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    style_resolver</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> StyleResolver</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    layout_engine</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> LayoutEngine</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    render_engine</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> RenderEngine</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    validation_enabled</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(viewport_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, viewport_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> viewport_size </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            origin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Point</span><span style=\"color:#E1E4E8\"> { x</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\">, y</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0.0</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\"> { width</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> viewport_width, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> viewport_height },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            viewport_size,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            html_parser</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HTMLParser</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            style_resolver</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> StyleResolver</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            layout_engine</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> LayoutEngine</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(viewport_size),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            render_engine</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> RenderEngine</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(viewport_size),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            validation_enabled</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> cfg!</span><span style=\"color:#E1E4E8\">(debug_assertions),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> render_page</span><span style=\"color:#E1E4E8\">(html</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, css</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">u8</span><span style=\"color:#E1E4E8\">>, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Parse HTML into DOM tree using HTMLParser::parse_html</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Validate DOM tree structure if validation_enabled</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Parse CSS into stylesheet using CSSParser::parse_stylesheet  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Resolve styles for all DOM elements using StyleResolver</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Validate computed styles if validation_enabled</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Calculate layout using LayoutEngine with viewport constraints</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Validate layout tree geometry if validation_enabled  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 8: Generate display list using RenderEngine</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 9: Execute paint commands to produce final canvas buffer</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 10: Return canvas buffer as byte array for display</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use timing measurements to identify performance bottlenecks</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Preserve intermediate results for debugging pipeline issues</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"stage-interface-definitions\">Stage Interface Definitions</h4>\n<p>Define clean interfaces that each pipeline stage must implement:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Formal interfaces that define the contracts between pipeline stages</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">types</span><span style=\"color:#F97583\">::*</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> trait</span><span style=\"color:#B392F0\"> HTMLParsingStage</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> parse_html</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, input</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">>>;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> validate_dom_tree</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, root</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#B392F0\">ValidationError</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> trait</span><span style=\"color:#B392F0\"> StyleResolutionStage</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> parse_stylesheet</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, css</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Stylesheet</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> resolve_styles</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, root</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">, stylesheets</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#B392F0\">Stylesheet</span><span style=\"color:#E1E4E8\">]) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">StyledNode</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> validate_computed_styles</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, styled_root</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">StyledNode</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#B392F0\">ValidationError</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> trait</span><span style=\"color:#B392F0\"> LayoutCalculationStage</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> calculate_layout</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, styled_root</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">StyledNode</span><span style=\"color:#E1E4E8\">, viewport</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> validate_layout_tree</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, layout_root</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#B392F0\">ValidationError</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> trait</span><span style=\"color:#B392F0\"> RenderingStage</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> generate_display_list</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, layout_root</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DisplayList</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> render_to_canvas</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, display_list</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DisplayList</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">u8</span><span style=\"color:#E1E4E8\">>, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"cross-stage-validation-logic\">Cross-Stage Validation Logic</h4>\n<p>Implement comprehensive validation that verifies data integrity between pipeline stages:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Validation functions that verify data integrity between pipeline stages</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">types</span><span style=\"color:#F97583\">::*</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> PipelineValidator</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    strict_mode</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> PipelineValidator</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(strict_mode</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> PipelineValidator</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        PipelineValidator</span><span style=\"color:#E1E4E8\"> { strict_mode }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> validate_dom_structure</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, root</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#B392F0\">ValidationError</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Verify that every child node's parent pointer references the correct parent</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Check that the tree has no circular references by tracking visited nodes</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Validate that element nodes have non-empty tag names  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Ensure text nodes contain valid UTF-8 content</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Verify that all nodes are reachable from root via parent-child traversal</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use a HashSet to detect cycles during tree traversal</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Check that parent.children[i].parent == parent for all children</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> validate_style_resolution</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, styled_root</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">StyledNode</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#B392F0\">ValidationError</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Verify every element has a complete ComputedStyle with all properties set</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Check that no computed values contain unresolved keywords like 'inherit'</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Validate that inherited properties match their parent's computed values</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Ensure all color values are valid and within RGB ranges</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Check that length values have been resolved to pixel units</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Traverse styled tree and compare inherited properties with parent values</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> validate_layout_geometry</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, layout_root</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;(), </span><span style=\"color:#B392F0\">ValidationError</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Verify that content_rect ⊆ padding_rect ⊆ border_rect ⊆ margin_rect</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Check that all coordinates are finite floating-point numbers  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Validate that child boxes are positioned within parent content area</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Ensure all width and height values are non-negative</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Verify that positioned elements respect viewport boundaries</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use Rectangle::contains and Rectangle::intersects for geometric checks</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"error-propagation-and-context-preservation\">Error Propagation and Context Preservation</h4>\n<p>Implement rich error types that preserve context across pipeline stages:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Error types that preserve context and enable debugging across pipeline stages</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">fmt;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> PipelineError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    HTMLParsing</span><span style=\"color:#E1E4E8\"> { </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        stage</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        errors</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        input_context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    StyleResolution</span><span style=\"color:#E1E4E8\"> { </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        stage</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        element_context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        css_context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        error</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    LayoutCalculation</span><span style=\"color:#E1E4E8\"> { </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        stage</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        element_context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        available_space</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        error</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Rendering</span><span style=\"color:#E1E4E8\"> { </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        stage</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        paint_context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        error</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Validation</span><span style=\"color:#E1E4E8\"> { </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        stage</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        check_failed</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> fmt</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Display</span><span style=\"color:#F97583\"> for</span><span style=\"color:#B392F0\"> PipelineError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> fmt</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, f</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> fmt</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Formatter</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> fmt</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Result</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            PipelineError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">HTMLParsing</span><span style=\"color:#E1E4E8\"> { stage, errors, input_context } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                write!</span><span style=\"color:#E1E4E8\">(f, </span><span style=\"color:#9ECBFF\">\"HTML parsing failed in {}: {} errors near '{}'\"</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                       stage, errors</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(), input_context)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // TODO: Implement Display for other error variants with rich context</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"milestone-checkpoints\">Milestone Checkpoints</h4>\n<p>After implementing the component interaction system, verify these behaviors:</p>\n<p><strong>Pipeline Integration Test</strong>: Create a simple HTML document with CSS and verify it processes through all stages:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">html</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">&#x3C;!</span><span style=\"color:#85E89D\">DOCTYPE</span><span style=\"color:#B392F0\"> html</span><span style=\"color:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#85E89D\">html</span><span style=\"color:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#85E89D\">head</span><span style=\"color:#E1E4E8\">>&#x3C;</span><span style=\"color:#85E89D\">style</span><span style=\"color:#E1E4E8\">></span><span style=\"color:#85E89D\">body</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#79B8FF\">color</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">red</span><span style=\"color:#E1E4E8\">; }&#x3C;/</span><span style=\"color:#85E89D\">style</span><span style=\"color:#E1E4E8\">>&#x3C;/</span><span style=\"color:#85E89D\">head</span><span style=\"color:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#85E89D\">body</span><span style=\"color:#E1E4E8\">>&#x3C;</span><span style=\"color:#85E89D\">p</span><span style=\"color:#E1E4E8\">>Hello World&#x3C;/</span><span style=\"color:#85E89D\">p</span><span style=\"color:#E1E4E8\">>&#x3C;/</span><span style=\"color:#85E89D\">body</span><span style=\"color:#E1E4E8\">></span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">&#x3C;/</span><span style=\"color:#85E89D\">html</span><span style=\"color:#E1E4E8\">></span></span></code></pre></div>\n\n<p>Expected behavior:</p>\n<ul>\n<li>HTML parsing produces DOM tree with html → head/body → style/p structure</li>\n<li>CSS parsing extracts rule for body element with color: red  </li>\n<li>Style resolution applies red color to body and inherits to p element</li>\n<li>Layout calculation produces positioned boxes for all elements</li>\n<li>Rendering generates DrawText command with red color for &quot;Hello World&quot;</li>\n</ul>\n<p><strong>Error Recovery Test</strong>: Process malformed input to verify graceful degradation:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">html</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#85E89D\">div</span><span style=\"color:#E1E4E8\">>&#x3C;</span><span style=\"color:#85E89D\">p</span><span style=\"color:#E1E4E8\">>Unclosed paragraph&#x3C;</span><span style=\"color:#85E89D\">span</span><span style=\"color:#E1E4E8\">>Nested content&#x3C;/</span><span style=\"color:#85E89D\">div</span><span style=\"color:#E1E4E8\">></span></span></code></pre></div>\n\n<p>Expected behavior:</p>\n<ul>\n<li>HTML parser auto-closes p element before processing div end tag</li>\n<li>DOM tree shows correct nesting: div → p → span with &quot;Nested content&quot;  </li>\n<li>Style resolution processes all elements despite malformed source</li>\n<li>Layout and rendering complete successfully with corrected structure</li>\n</ul>\n<p><strong>Performance Validation</strong>: Measure processing time for each pipeline stage:</p>\n<ul>\n<li>HTML parsing should complete in O(n) time where n is input length</li>\n<li>CSS parsing should scale linearly with stylesheet size</li>\n<li>Style resolution should be O(elements × rules) for small documents  </li>\n<li>Layout calculation time should be proportional to element count</li>\n<li>Display list generation should complete in O(elements) time</li>\n</ul>\n<h3 id=\"debugging-component-interactions\">Debugging Component Interactions</h3>\n<p>The component interaction system requires systematic debugging approaches that can isolate issues to specific pipeline stages and data transformations.</p>\n<h4 id=\"pipeline-stage-isolation\">Pipeline Stage Isolation</h4>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Stage</th>\n<th>Diagnostic Approach</th>\n<th>Fix Strategy</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Empty or malformed DOM tree</td>\n<td>HTML parsing</td>\n<td>Log token stream and tree construction steps</td>\n<td>Fix tokenizer state machine or tree builder</td>\n</tr>\n<tr>\n<td>Missing or incorrect styles</td>\n<td>Style resolution</td>\n<td>Check rule matching and cascade order</td>\n<td>Debug selector matching or specificity calculation</td>\n</tr>\n<tr>\n<td>Elements positioned incorrectly</td>\n<td>Layout calculation</td>\n<td>Visualize box model rectangles</td>\n<td>Fix box model math or formatting context logic</td>\n</tr>\n<tr>\n<td>Visual rendering issues</td>\n<td>Paint generation</td>\n<td>Inspect display list commands</td>\n<td>Fix paint order or graphics backend calls</td>\n</tr>\n</tbody></table>\n<h4 id=\"data-flow-visualization\">Data Flow Visualization</h4>\n<p>Implement debug output that shows data transformations between stages:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Debug utilities for visualizing data flow between pipeline stages</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> render_with_debug</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, html</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, css</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DebugInfo</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Enable comprehensive logging for each pipeline stage</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Capture intermediate data structures after each transformation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Generate visual representations of DOM tree, layout boxes, paint commands</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Measure timing and memory usage for each stage</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Create diff comparison between expected and actual outputs</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use serde to serialize intermediate structures for inspection</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Generate DOT graph format for tree structure visualization</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"common-integration-issues\">Common Integration Issues</h4>\n<p>⚠️ <strong>Pitfall: Incomplete Style Resolution</strong>\nWhen elements appear unstyled, the issue often lies in selector matching logic. The style resolver might be failing to match CSS selectors to DOM elements due to incorrect tag name comparison, missing class attributes, or broken combinators.</p>\n<p><strong>Diagnosis</strong>: Log the selector matching process for each element and rule combination. Check that <code>matches_element</code> correctly handles all selector types and that specificity calculation produces expected values.</p>\n<p><strong>Fix</strong>: Implement comprehensive unit tests for selector matching with edge cases like case-insensitive tag names, multiple classes, and complex combinators.</p>\n<p>⚠️ <strong>Pitfall: Layout Coordinate System Confusion</strong>\nWhen elements appear in wrong positions, coordinate system mismatches between layout calculation and rendering often cause issues. The layout engine might compute positions relative to one origin point while the renderer expects a different coordinate system.</p>\n<p><strong>Diagnosis</strong>: Add debug output that logs the computed rectangles for each layout box and compare them with the expected paint command coordinates.</p>\n<p><strong>Fix</strong>: Establish a single coordinate system (top-left origin) used consistently across layout and rendering stages. Document coordinate system assumptions in interface contracts.</p>\n<p>⚠️ <strong>Pitfall: Paint Command Ordering Issues</strong> \nWhen elements appear layered incorrectly, paint command generation might be producing commands in the wrong order. Background elements appearing on top of foreground elements indicates incorrect z-ordering.</p>\n<p><strong>Diagnosis</strong>: Log the complete display list with element context for each paint command. Verify that background commands appear before text commands for the same element.</p>\n<p><strong>Fix</strong>: Implement systematic paint order traversal that processes elements in correct depth-first order with proper background-to-foreground layering within each element.</p>\n<h2 id=\"error-handling-and-edge-cases\">Error Handling and Edge Cases</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> All milestones (1-4) - This section establishes comprehensive error recovery strategies that are essential throughout the entire rendering pipeline, from HTML parsing through final canvas output.</p>\n</blockquote>\n<p>Web browsers must gracefully handle an enormous variety of malformed, incomplete, or invalid input. Think of error handling in a browser engine like <strong>emergency protocols in air traffic control</strong> - when something goes wrong, the system must continue functioning safely rather than crashing completely. A single malformed HTML tag or missing font file should never bring down the entire browser. The web&#39;s robustness principle &quot;be conservative in what you send, be liberal in what you accept&quot; means our browser engine must implement sophisticated error recovery at every stage of the rendering pipeline.</p>\n<p>This section covers three critical areas of error handling: parse error recovery for malformed HTML and CSS, layout edge cases involving complex box model calculations, and rendering failure modes when the graphics backend encounters problems. Each area requires different recovery strategies, from the HTML parser&#39;s foster parenting algorithm to the renderer&#39;s graceful degradation when fonts fail to load.</p>\n<p><img src=\"/api/project/build-browser/architecture-doc/asset?path=diagrams%2Ferror-handling-flow.svg\" alt=\"Error Recovery Flowchart\"></p>\n<p>The fundamental principle underlying all error handling in our browser engine is <strong>graceful degradation</strong> - when an error occurs, we preserve as much functionality as possible while providing sensible fallback behavior. This means continuing to render whatever content we can process correctly, even when parts of the input are malformed or unsupported.</p>\n<h3 id=\"parse-error-recovery\">Parse Error Recovery</h3>\n<p>HTML and CSS parsing errors are incredibly common in real-world web content. Studies show that over 90% of web pages contain some form of HTML validation error, yet browsers must render them correctly. Our error recovery system treats parsing not as a strict validation process, but as a <strong>best-effort reconstruction</strong> of the author&#39;s intent from potentially malformed markup.</p>\n<blockquote>\n<p><strong>Decision: Continuation-Based Error Recovery</strong></p>\n<ul>\n<li><strong>Context</strong>: Real web content frequently contains malformed HTML and CSS that would cause strict parsers to fail completely.</li>\n<li><strong>Options Considered</strong>: <ol>\n<li>Strict validation with parsing failure on first error</li>\n<li>Error collection with warnings but continued parsing</li>\n<li>Aggressive error recovery with automatic correction</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Implement continuation-based error recovery that attempts to fix common mistakes automatically while collecting error information.</li>\n<li><strong>Rationale</strong>: Web browsers must handle the existing web ecosystem, which contains billions of pages with validation errors. Failing to parse would make our browser unusable on real content.</li>\n<li><strong>Consequences</strong>: More complex parser implementation but dramatically improved compatibility with real web content.</li>\n</ul>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Recovery Strategy</th>\n<th>When Applied</th>\n<th>Action Taken</th>\n<th>Example</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Foster Parenting</td>\n<td>Elements appear in wrong context</td>\n<td>Move to appropriate parent</td>\n<td><code>&lt;table&gt;&lt;div&gt;</code> moves <code>div</code> outside table</td>\n</tr>\n<tr>\n<td>Implicit Tag Insertion</td>\n<td>Missing required elements</td>\n<td>Insert omitted tags</td>\n<td>Missing <code>&lt;tbody&gt;</code> in table</td>\n</tr>\n<tr>\n<td>Tag Auto-Closing</td>\n<td>Unclosed elements at end</td>\n<td>Close all open elements</td>\n<td>Missing <code>&lt;/div&gt;</code> at document end</td>\n</tr>\n<tr>\n<td>Attribute Recovery</td>\n<td>Malformed attributes</td>\n<td>Use fallback values</td>\n<td><code>width=&quot;invalid&quot;</code> becomes default width</td>\n</tr>\n<tr>\n<td>Entity Fallback</td>\n<td>Unknown character entities</td>\n<td>Display raw text</td>\n<td><code>&amp;unknownentity;</code> shows literally</td>\n</tr>\n<tr>\n<td>Encoding Recovery</td>\n<td>Invalid UTF-8 sequences</td>\n<td>Replace with replacement char</td>\n<td>Invalid bytes become �</td>\n</tr>\n</tbody></table>\n<h4 id=\"html-parse-error-recovery\">HTML Parse Error Recovery</h4>\n<p>The HTML tokenizer and tree builder implement a <strong>state machine with error transitions</strong> that allow parsing to continue even when encountering malformed markup. When the tokenizer encounters unexpected characters, it doesn&#39;t abort but instead transitions to an error recovery state that attempts to interpret the author&#39;s intent.</p>\n<p><strong>Malformed Tag Recovery Process:</strong></p>\n<ol>\n<li>The tokenizer encounters an invalid character sequence in a tag context (e.g., <code>&lt;div class=&quot;unclosed</code> at end of file)</li>\n<li>It checks if the current token can be salvaged by applying common corrections (missing quote, missing closing bracket)</li>\n<li>If the token is recoverable, it applies the fix and emits a corrected token along with a <code>ParseError::MalformedTag</code> warning</li>\n<li>If the token is unrecoverable, it treats the <code>&lt;</code> as literal text and continues parsing from the next character</li>\n<li>The tree builder receives the corrected token or literal text and continues normal processing</li>\n</ol>\n<p><strong>Foster Parenting Algorithm:</strong></p>\n<p>Foster parenting handles the common case where content appears in an inappropriate parent context. The algorithm maintains a <strong>stack of open elements</strong> and checks whether each new element is valid in its current context.</p>\n<ol>\n<li>When processing a start tag token, check if the element is allowed in the current context using HTML content model rules</li>\n<li>If the element is forbidden (e.g., block content inside inline element), search up the open element stack for an appropriate parent</li>\n<li>If an appropriate parent is found, close intervening elements and insert the new element at the correct location</li>\n<li>If no appropriate parent exists, create an anonymous block container to hold the misplaced content</li>\n<li>Update the DOM tree structure to reflect the corrected nesting while preserving document order</li>\n</ol>\n<p><strong>Common HTML Error Patterns:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Error Pattern</th>\n<th>Detection</th>\n<th>Recovery Action</th>\n<th>Example</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Unclosed Tags</td>\n<td>End of input with open elements</td>\n<td>Auto-close in reverse order</td>\n<td><code>&lt;div&gt;&lt;p&gt;text</code> becomes <code>&lt;div&gt;&lt;p&gt;text&lt;/p&gt;&lt;/div&gt;</code></td>\n</tr>\n<tr>\n<td>Mis-nested Tags</td>\n<td>End tag doesn&#39;t match current element</td>\n<td>Close to matching start tag</td>\n<td><code>&lt;b&gt;&lt;i&gt;&lt;/b&gt;&lt;/i&gt;</code> becomes <code>&lt;b&gt;&lt;i&gt;&lt;/i&gt;&lt;/b&gt;</code></td>\n</tr>\n<tr>\n<td>Invalid Nesting</td>\n<td>Block element inside inline</td>\n<td>Foster parent to valid container</td>\n<td><code>&lt;span&gt;&lt;div&gt;</code> moves <code>div</code> outside <code>span</code></td>\n</tr>\n<tr>\n<td>Missing Required Elements</td>\n<td>Table content outside <code>tbody</code></td>\n<td>Insert implicit wrapper</td>\n<td>Table rows get wrapped in <code>tbody</code></td>\n</tr>\n<tr>\n<td>Duplicate Attributes</td>\n<td>Same attribute appears twice</td>\n<td>Use first occurrence</td>\n<td><code>&lt;div id=&quot;a&quot; id=&quot;b&quot;&gt;</code> keeps <code>id=&quot;a&quot;</code></td>\n</tr>\n<tr>\n<td>Void Element Content</td>\n<td>Content inside self-closing element</td>\n<td>Treat content as sibling</td>\n<td><code>&lt;br&gt;text</code> becomes <code>&lt;br&gt;</code> followed by text</td>\n</tr>\n</tbody></table>\n<h4 id=\"css-parse-error-recovery\">CSS Parse Error Recovery</h4>\n<p>CSS parsing uses a different error recovery strategy based on <strong>error recovery tokens</strong> and <strong>declaration skipping</strong>. When the CSS parser encounters invalid syntax, it attempts to skip to the next valid parsing context rather than trying to fix the invalid content.</p>\n<p><strong>CSS Error Recovery Process:</strong></p>\n<ol>\n<li>The CSS tokenizer encounters an invalid character sequence (e.g., unmatched brackets, invalid escape sequences)</li>\n<li>It enters error recovery mode and consumes tokens until it finds a recovery point (semicolon, closing brace, or EOF)</li>\n<li>The parser discards the invalid rule or declaration and continues parsing from the recovery point</li>\n<li>For property values, invalid values are ignored and the property uses its inherited or initial value</li>\n<li>For selectors, invalid selector syntax causes the entire rule to be discarded</li>\n</ol>\n<p><strong>CSS Recovery Points:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Context</th>\n<th>Recovery Token</th>\n<th>Action</th>\n<th>Example</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Rule Level</td>\n<td><code>}</code> or EOF</td>\n<td>Discard rule, continue</td>\n<td>Invalid selector discards entire rule</td>\n</tr>\n<tr>\n<td>Declaration Level</td>\n<td><code>;</code> or <code>}</code></td>\n<td>Discard declaration</td>\n<td><code>color: #invalid;</code> ignored, next property processed</td>\n</tr>\n<tr>\n<td>Function Level</td>\n<td><code>)</code></td>\n<td>Discard function call</td>\n<td><code>rgb(invalid)</code> becomes initial value</td>\n</tr>\n<tr>\n<td>String Level</td>\n<td><code>&quot;</code> or <code>&#39;</code></td>\n<td>Close string, continue</td>\n<td>Unclosed string closed at line end</td>\n</tr>\n<tr>\n<td>Comment Level</td>\n<td><code>*/</code></td>\n<td>End comment, continue</td>\n<td>Unclosed comment closed at EOF</td>\n</tr>\n<tr>\n<td>Import Level</td>\n<td><code>;</code> or newline</td>\n<td>End import statement</td>\n<td>Malformed <code>@import</code> skipped</td>\n</tr>\n</tbody></table>\n<p><strong>Property Value Error Handling:</strong></p>\n<p>When CSS property values are invalid, our parser implements a <strong>fallback hierarchy</strong> that attempts to provide reasonable default behavior:</p>\n<ol>\n<li><strong>Syntax Validation</strong>: Check if the value matches the property&#39;s expected syntax pattern</li>\n<li><strong>Range Validation</strong>: Verify numeric values fall within valid ranges (e.g., opacity 0-1)</li>\n<li><strong>Unit Validation</strong>: Ensure units are appropriate for the property context</li>\n<li><strong>Fallback Selection</strong>: Choose appropriate fallback from inheritance, initial value, or browser default</li>\n<li><strong>Error Logging</strong>: Record the invalid value and chosen fallback for debugging</li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Invalid CSS: color: #gggggg; (invalid hex)\nRecovery: Use inherited color or initial value (black)\nError logged: &quot;Invalid color value '#gggggg' in declaration, using inherited&quot;\n\nInvalid CSS: width: -50px; (negative length not allowed)\nRecovery: Treat as 'auto' width\nError logged: &quot;Negative length '-50px' invalid for width, using auto&quot;</code></pre></div>\n\n<p>⚠️ <strong>Pitfall: Cascading Parse Errors</strong>\nA common mistake is allowing parse errors to cascade and corrupt subsequent parsing. For example, if an unclosed string in CSS contains what looks like property syntax, the parser might try to interpret the string contents as CSS rules. Always ensure error recovery completely consumes the invalid content before resuming normal parsing.</p>\n<h3 id=\"layout-edge-cases\">Layout Edge Cases</h3>\n<p>Layout calculations involve complex interactions between the CSS box model, formatting contexts, and constraint solving. Many edge cases arise from the <strong>cascading dependencies</strong> between parent and child dimensions, percentage calculations, and the intricate rules governing margin collapsing and auto value resolution.</p>\n<p>Think of layout edge cases like <strong>puzzle pieces that don&#39;t quite fit</strong> - the CSS specification defines the ideal relationships between elements, but real content often pushes these relationships to their limits. Our layout engine must handle circular dependencies, conflicting constraints, and mathematical edge cases while maintaining visual coherence.</p>\n<blockquote>\n<p><strong>Decision: Constraint Satisfaction with Fallback Ordering</strong></p>\n<ul>\n<li><strong>Context</strong>: Layout calculations often involve conflicting constraints (e.g., explicit width vs. content requirements, percentage dimensions with unknown parent size).</li>\n<li><strong>Options Considered</strong>:<ol>\n<li>Strict specification compliance, failing on impossible constraints</li>\n<li>Heuristic-based resolution with &quot;reasonable&quot; defaults</li>\n<li>Layered constraint satisfaction with priority ordering</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Implement layered constraint satisfaction where constraints are resolved in specification-defined priority order, with well-defined fallbacks for impossible situations.</li>\n<li><strong>Rationale</strong>: The CSS specification defines resolution order for most conflicts, and web compatibility requires handling edge cases consistently across browsers.</li>\n<li><strong>Consequences</strong>: More complex layout algorithm but predictable behavior matching real browser implementations.</li>\n</ul>\n</blockquote>\n<h4 id=\"percentage-and-auto-value-resolution\">Percentage and Auto Value Resolution</h4>\n<p>Percentage values in CSS create <strong>dependency cycles</strong> when parent and child dimensions depend on each other. The layout engine must break these cycles using the CSS specification&#39;s resolution order while handling degenerate cases gracefully.</p>\n<p><strong>Percentage Resolution Algorithm:</strong></p>\n<ol>\n<li><strong>Initial Pass</strong>: Identify elements with percentage dimensions and their dependency relationships</li>\n<li><strong>Cycle Detection</strong>: Use depth-first traversal to detect circular dependencies in the dimension calculation graph</li>\n<li><strong>Constraint Ordering</strong>: Sort constraints by CSS-defined priority (width before height, explicit before auto, etc.)</li>\n<li><strong>Iterative Resolution</strong>: Resolve constraints in priority order, using tentative values for unresolved dependencies</li>\n<li><strong>Convergence Check</strong>: Verify that dimension calculations converge to stable values within tolerance</li>\n<li><strong>Fallback Application</strong>: Apply fallback rules for non-converging or impossible constraint sets</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>Edge Case</th>\n<th>Scenario</th>\n<th>Resolution Strategy</th>\n<th>Example</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Circular Percentage</td>\n<td>Child width depends on parent, parent width depends on child</td>\n<td>Use intrinsic child width for parent</td>\n<td><code>&lt;div style=&quot;width:auto&quot;&gt;&lt;img style=&quot;width:50%&quot;&gt;</code></td>\n</tr>\n<tr>\n<td>Zero-Sized Container</td>\n<td>Percentage child of zero-width parent</td>\n<td>Treat percentage as zero</td>\n<td><code>width: 50%</code> of 0px parent becomes 0px</td>\n</tr>\n<tr>\n<td>Infinite Recursion</td>\n<td>Nested elements with interdependent auto sizing</td>\n<td>Limit recursion depth, use content-based sizing</td>\n<td>Deep nesting with shrink-wrap behavior</td>\n</tr>\n<tr>\n<td>Negative Percentages</td>\n<td>Percentage values that compute to negative lengths</td>\n<td>Clamp to zero (negative sizes forbidden)</td>\n<td><code>width: 50%</code> of -100px parent becomes 0px</td>\n</tr>\n<tr>\n<td>Mixed Units</td>\n<td>Calculations involving percentages and absolute units</td>\n<td>Convert to common unit system at resolution time</td>\n<td><code>width: calc(50% + 10px)</code> calculations</td>\n</tr>\n</tbody></table>\n<p><strong>Auto Value Resolution Priority:</strong></p>\n<p>The CSS specification defines a complex hierarchy for resolving <code>auto</code> values when multiple dimensions are automatic. Our implementation follows this priority ordering:</p>\n<ol>\n<li><strong>Available Space</strong>: Use available space from containing block when possible</li>\n<li><strong>Content Requirements</strong>: Fall back to content-driven sizing (shrink-to-fit)</li>\n<li><strong>Intrinsic Ratios</strong>: Apply aspect ratios for elements with natural dimensions</li>\n<li><strong>Specification Defaults</strong>: Use CSS-defined initial values as last resort</li>\n<li><strong>Browser Minimums</strong>: Apply minimum readable sizes for text content</li>\n</ol>\n<h4 id=\"margin-collapsing-edge-cases\">Margin Collapsing Edge Cases</h4>\n<p>Margin collapsing follows complex rules that interact with positioning, floating, and formatting contexts. The algorithm must handle <strong>nested collapsing</strong>, <strong>negative margins</strong>, and <strong>self-collapsing elements</strong> while maintaining correct visual spacing.</p>\n<p><strong>Complex Margin Collapse Scenarios:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Scenario</th>\n<th>Description</th>\n<th>Calculation</th>\n<th>Result</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Adjacent Positive</td>\n<td>Two positive margins touch</td>\n<td><code>max(margin1, margin2)</code></td>\n<td>Larger margin wins</td>\n</tr>\n<tr>\n<td>Adjacent Negative</td>\n<td>Two negative margins touch</td>\n<td><code>min(margin1, margin2)</code></td>\n<td>More negative margin wins</td>\n</tr>\n<tr>\n<td>Mixed Sign</td>\n<td>Positive and negative margins</td>\n<td><code>margin1 + margin2</code></td>\n<td>Arithmetic sum</td>\n</tr>\n<tr>\n<td>Nested Collapse</td>\n<td>Parent and child margins collapse through</td>\n<td>Collapse all participating margins</td>\n<td>Multiple margins become one</td>\n</tr>\n<tr>\n<td>Self-Collapse</td>\n<td>Element with no content, height, padding, or border</td>\n<td>Top and bottom margins collapse together</td>\n<td>Element takes no space</td>\n</tr>\n<tr>\n<td>Clearance</td>\n<td>Margin collapsing prevented by clearance</td>\n<td>No collapsing occurs</td>\n<td>Margins remain separate</td>\n</tr>\n</tbody></table>\n<p><strong>Margin Collapse Algorithm Implementation:</strong></p>\n<ol>\n<li><strong>Adjacency Detection</strong>: Identify which margins are adjacent according to CSS rules (no padding, border, or content between)</li>\n<li><strong>Collapse Group Formation</strong>: Group all margins that collapse together, handling nested scenarios</li>\n<li><strong>Collapse Calculation</strong>: Compute the final collapsed margin using max for positive, min for negative, sum for mixed</li>\n<li><strong>Position Adjustment</strong>: Update element positions based on the collapsed margin values</li>\n<li><strong>Clearance Handling</strong>: Prevent collapsing when clearance is present due to floating elements</li>\n</ol>\n<h4 id=\"box-model-constraint-conflicts\">Box Model Constraint Conflicts</h4>\n<p>When explicit width, padding, border, and margin values conflict with available space, the layout engine must resolve the <strong>over-constrained</strong> situation according to CSS rules.</p>\n<p><strong>Over-Constraint Resolution Order:</strong></p>\n<ol>\n<li><strong>Check Container Capacity</strong>: Determine if total required space exceeds available space</li>\n<li><strong>Apply Reduction Priority</strong>: Reduce dimensions in CSS-specified order (margin auto, then explicit margins, then width)</li>\n<li><strong>Honor Minimums</strong>: Respect minimum content requirements and CSS <code>min-width</code>/<code>min-height</code> properties</li>\n<li><strong>Overflow Handling</strong>: Allow content to overflow if reduction would make content unreadable</li>\n<li><strong>Document Flow Impact</strong>: Ensure constraint resolution doesn&#39;t break containing block relationships</li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Example Over-Constraint:\nAvailable width: 300px\nElement: width: 200px, margin-left: 100px, margin-right: 100px, padding: 20px, border: 10px\nTotal required: 200 + 100 + 100 + 40 + 20 = 460px\n\nResolution:\n1. Convert auto margins to zero: no auto margins present\n2. Reduce right margin: 460 - 300 = 160px over, reduce margin-right by 160px\n3. Final: width: 200px, margin-left: 100px, margin-right: -60px, padding: 20px, border: 10px\n4. Element extends outside container by the negative margin</code></pre></div>\n\n<p>⚠️ <strong>Pitfall: Floating Point Precision</strong>\nLayout calculations involve extensive floating-point arithmetic that can accumulate precision errors. A common mistake is using exact equality comparisons for layout values. Instead, use epsilon-based comparisons and consider values within 0.001px as equal. This prevents infinite iteration in constraint resolution loops.</p>\n<h3 id=\"rendering-failure-modes\">Rendering Failure Modes</h3>\n<p>The rendering stage sits at the intersection of our layout calculations and the underlying graphics system. Failures can occur due to <strong>graphics backend limitations</strong>, <strong>resource exhaustion</strong>, <strong>font loading problems</strong>, or <strong>coordinate system overflow</strong>. Unlike parsing and layout errors, rendering failures often require real-time decisions about visual degradation.</p>\n<p>Think of rendering failure handling like <strong>emergency broadcasting</strong> - when the ideal signal fails, we switch to backup systems that deliver reduced quality but maintain communication. A missing font shouldn&#39;t prevent text from appearing, and a graphics driver crash shouldn&#39;t make the entire page invisible.</p>\n<blockquote>\n<p><strong>Decision: Layered Rendering with Graceful Degradation</strong></p>\n<ul>\n<li><strong>Context</strong>: Graphics backends can fail due to driver issues, memory exhaustion, or unsupported operations, and rendering failures should not crash the entire browser.</li>\n<li><strong>Options Considered</strong>:<ol>\n<li>Fail-fast approach where any rendering error aborts the entire page</li>\n<li>Best-effort rendering with silent fallbacks to simplified graphics</li>\n<li>Layered fallback system with user notification of degraded rendering</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Implement layered fallback system that attempts progressively simpler rendering approaches while logging degradation events.</li>\n<li><strong>Rationale</strong>: Users expect pages to remain visible even when graphics drivers have problems, and silent degradation could hide serious system issues.</li>\n<li><strong>Consequences</strong>: More complex rendering pipeline but much better user experience during system problems.</li>\n</ul>\n</blockquote>\n<h4 id=\"graphics-backend-error-handling\">Graphics Backend Error Handling</h4>\n<p>Graphics backends can fail for numerous reasons: driver crashes, out-of-memory conditions, invalid rendering state, or unsupported operations. Our rendering engine implements a <strong>fallback cascade</strong> that attempts progressively simpler rendering techniques when advanced features fail.</p>\n<p><strong>Graphics Backend Failure Types:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Failure Type</th>\n<th>Typical Causes</th>\n<th>Detection Method</th>\n<th>Recovery Strategy</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Context Loss</td>\n<td>Driver crash, system hibernation</td>\n<td>Rendering calls return error codes</td>\n<td>Recreate graphics context, re-upload resources</td>\n</tr>\n<tr>\n<td>Memory Exhaustion</td>\n<td>Large textures, too many buffers</td>\n<td>Allocation failures</td>\n<td>Switch to immediate mode rendering</td>\n</tr>\n<tr>\n<td>Unsupported Operations</td>\n<td>Missing GPU features, old drivers</td>\n<td>Feature detection, operation errors</td>\n<td>Fall back to software rendering</td>\n</tr>\n<tr>\n<td>Coordinate Overflow</td>\n<td>Elements positioned beyond coordinate limits</td>\n<td>Clipping calculations</td>\n<td>Clamp coordinates to valid ranges</td>\n</tr>\n<tr>\n<td>State Corruption</td>\n<td>Invalid rendering state combinations</td>\n<td>Inconsistent rendering output</td>\n<td>Reset to known good state</td>\n</tr>\n<tr>\n<td>Resource Limit</td>\n<td>Too many fonts, textures, or buffers loaded</td>\n<td>Resource creation failures</td>\n<td>Implement resource LRU cache with eviction</td>\n</tr>\n</tbody></table>\n<p><strong>Rendering Fallback Cascade:</strong></p>\n<ol>\n<li><strong>Hardware-Accelerated Path</strong>: Use GPU-accelerated rendering with full feature set (gradients, transforms, anti-aliasing)</li>\n<li><strong>Software Rendering Path</strong>: Fall back to CPU-based rendering with reduced features but full correctness</li>\n<li><strong>Simple Drawing Path</strong>: Use basic rectangle and text drawing without advanced features</li>\n<li><strong>Text-Only Mode</strong>: Render only text content with default fonts and colors</li>\n<li><strong>Error Display</strong>: Show error message indicating rendering system failure</li>\n</ol>\n<h4 id=\"font-loading-and-text-rendering-failures\">Font Loading and Text Rendering Failures</h4>\n<p>Font failures are among the most common rendering issues because fonts are external resources that may be missing, corrupted, or incompatible. The text rendering system must provide <strong>progressive fallback</strong> through font family lists while maintaining readable output.</p>\n<p><strong>Font Fallback Algorithm:</strong></p>\n<ol>\n<li><strong>Primary Font Loading</strong>: Attempt to load the first font in the CSS <code>font-family</code> list</li>\n<li><strong>Format Validation</strong>: Verify the font file format is supported and the font data is not corrupted</li>\n<li><strong>Character Coverage Check</strong>: Ensure the font contains glyphs for the required characters</li>\n<li><strong>Fallback Font Selection</strong>: If primary font fails, try each subsequent font in the family list</li>\n<li><strong>System Font Fallback</strong>: Use operating system default fonts if all CSS fonts fail</li>\n<li><strong>Generic Fallback</strong>: Fall back to built-in bitmap fonts as last resort</li>\n<li><strong>Missing Glyph Handling</strong>: Display replacement characters (□) for unavailable glyphs</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>Font Failure Mode</th>\n<th>Detection</th>\n<th>Fallback Action</th>\n<th>User Impact</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>File Not Found</td>\n<td>Font loading returns 404 or file error</td>\n<td>Try next font in family</td>\n<td>Slight appearance change</td>\n</tr>\n<tr>\n<td>Corrupted Font Data</td>\n<td>Font parsing fails with invalid data</td>\n<td>Skip to system fonts</td>\n<td>Noticeable font change</td>\n</tr>\n<tr>\n<td>Missing Characters</td>\n<td>Font lacks glyphs for text content</td>\n<td>Use fallback font for missing chars</td>\n<td>Mixed fonts in text</td>\n</tr>\n<tr>\n<td>Font Size Unsupported</td>\n<td>Requested size outside font limits</td>\n<td>Clamp to supported range</td>\n<td>Text size different than specified</td>\n</tr>\n<tr>\n<td>Rendering Failure</td>\n<td>Glyph rasterization fails</td>\n<td>Use simpler text rendering</td>\n<td>Possible visual artifacts</td>\n</tr>\n<tr>\n<td>Memory Exhaustion</td>\n<td>Font cache full</td>\n<td>Evict least-recently-used fonts</td>\n<td>Temporary font reloading</td>\n</tr>\n</tbody></table>\n<p><strong>Text Metrics Calculation Failures:</strong></p>\n<p>When text measurement fails (due to font issues or graphics backend problems), the layout system needs <strong>estimated metrics</strong> to maintain document flow:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Fallback Text Metrics Calculation:\n1. Character Count: count characters in text string\n2. Average Width: use 0.6 * font_size as typical character width\n3. Line Height: use 1.2 * font_size as standard line spacing\n4. Ascent/Descent: use 0.8 * font_size ascent, 0.2 * font_size descent\n5. Word Breaking: assume breaking opportunities at whitespace\n\nExample for &quot;Hello World&quot; in 16px font:\n- Estimated width: 11 characters * 0.6 * 16px = 105.6px\n- Line height: 1.2 * 16px = 19.2px\n- Ascent: 0.8 * 16px = 12.8px from baseline</code></pre></div>\n\n<h4 id=\"memory-management-and-resource-limits\">Memory Management and Resource Limits</h4>\n<p>The rendering engine must handle <strong>memory pressure</strong> and <strong>resource exhaustion</strong> gracefully, especially when rendering large documents or complex graphics. Our system implements <strong>adaptive quality reduction</strong> and <strong>resource recycling</strong> to maintain functionality under constraints.</p>\n<p><strong>Resource Management Strategies:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Resource Type</th>\n<th>Tracking Method</th>\n<th>Limit Detection</th>\n<th>Mitigation Strategy</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Graphics Textures</td>\n<td>Allocated memory counter</td>\n<td>Total exceeds GPU memory limit</td>\n<td>LRU eviction of cached textures</td>\n</tr>\n<tr>\n<td>Font Cache</td>\n<td>Loaded font count and size</td>\n<td>Cache size exceeds limit</td>\n<td>Evict fonts not used recently</td>\n</tr>\n<tr>\n<td>Paint Command Buffers</td>\n<td>Buffer memory usage</td>\n<td>Allocation failures</td>\n<td>Switch to immediate rendering</td>\n</tr>\n<tr>\n<td>Clipping Regions</td>\n<td>Active clip stack depth</td>\n<td>Stack overflow</td>\n<td>Flatten nested clips</td>\n</tr>\n<tr>\n<td>Graphics Context Objects</td>\n<td>Handle count tracking</td>\n<td>System handle exhaustion</td>\n<td>Pool and reuse context objects</td>\n</tr>\n<tr>\n<td>Image Decode Buffers</td>\n<td>Decoded image memory</td>\n<td>Memory allocation fails</td>\n<td>Decode images on-demand only</td>\n</tr>\n</tbody></table>\n<p><strong>Adaptive Quality Reduction:</strong></p>\n<p>When resource pressure is detected, the rendering engine can reduce quality to maintain functionality:</p>\n<ol>\n<li><strong>Disable Anti-Aliasing</strong>: Turn off text and shape anti-aliasing to reduce memory usage</li>\n<li><strong>Reduce Color Depth</strong>: Switch from 32-bit to 16-bit color rendering</li>\n<li><strong>Simplify Gradients</strong>: Replace complex gradients with solid colors</li>\n<li><strong>Skip Decorative Elements</strong>: Don&#39;t render shadows, decorative borders, or background images</li>\n<li><strong>Reduce Text Quality</strong>: Use bitmap fonts instead of vector fonts for small text</li>\n<li><strong>Increase Clipping Aggressiveness</strong>: Clip elements earlier to reduce off-screen rendering</li>\n</ol>\n<p>⚠️ <strong>Pitfall: Resource Leak Cascades</strong>\nA common mistake is not properly cleaning up graphics resources when errors occur, leading to resource leaks that compound over time. Always use RAII patterns (destructors, <code>defer</code> statements, or <code>finally</code> blocks) to ensure resources are freed even when rendering operations fail. This is especially critical for GPU resources which have strict system limits.</p>\n<h4 id=\"coordinate-system-and-overflow-handling\">Coordinate System and Overflow Handling</h4>\n<p>Modern web pages can have elements positioned far outside the visible viewport, potentially exceeding the coordinate system limits of graphics backends. The rendering engine must <strong>clip and transform</strong> coordinates to prevent overflow while maintaining visual correctness for visible content.</p>\n<p><strong>Coordinate Overflow Scenarios:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Overflow Type</th>\n<th>Typical Values</th>\n<th>Graphics Limit</th>\n<th>Handling Strategy</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Large Positive Coordinates</td>\n<td>Elements positioned &gt; 1M pixels right</td>\n<td>32-bit float precision limit</td>\n<td>Clamp to maximum representable value</td>\n</tr>\n<tr>\n<td>Large Negative Coordinates</td>\n<td>Elements positioned &lt; -1M pixels left</td>\n<td>Graphics backend coordinate limits</td>\n<td>Clamp to minimum representable value</td>\n</tr>\n<tr>\n<td>Extreme Scaling</td>\n<td>CSS transforms with scale &gt; 1000x</td>\n<td>Matrix calculation overflow</td>\n<td>Clamp scale factors to reasonable range</td>\n</tr>\n<tr>\n<td>Deep Z-Ordering</td>\n<td>Elements with z-index &gt; 100,000</td>\n<td>Depth buffer precision</td>\n<td>Compress z-order to available range</td>\n</tr>\n<tr>\n<td>Viewport Translation</td>\n<td>Document scrolled to extreme positions</td>\n<td>Coordinate arithmetic overflow</td>\n<td>Use relative coordinate systems</td>\n</tr>\n</tbody></table>\n<p><strong>Coordinate Clamping Algorithm:</strong></p>\n<ol>\n<li><strong>Range Detection</strong>: Check if element coordinates exceed graphics system limits</li>\n<li><strong>Visibility Culling</strong>: Skip rendering for elements completely outside the viewport</li>\n<li><strong>Coordinate Transformation</strong>: Transform coordinates to fit within graphics backend limits</li>\n<li><strong>Precision Preservation</strong>: Maintain relative positioning accuracy for visible elements</li>\n<li><strong>Overflow Indication</strong>: Mark elements as clipped when coordinate clamping occurs</li>\n</ol>\n<p>The rendering system maintains separate <strong>logical coordinates</strong> (unlimited precision) and <strong>graphics coordinates</strong> (backend-limited) to ensure layout calculations remain accurate even when rendering coordinates are clamped.</p>\n<h3 id=\"error-recovery-integration-across-pipeline-stages\">Error Recovery Integration Across Pipeline Stages</h3>\n<p>Error handling in a browser engine requires coordination across all pipeline stages because errors in one stage can cascade to affect subsequent stages. Our system implements <strong>error boundary isolation</strong> and <strong>graceful degradation propagation</strong> to contain failures while maintaining overall functionality.</p>\n<p><strong>Cross-Stage Error Propagation:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Error Origin</th>\n<th>Immediate Effect</th>\n<th>Downstream Impact</th>\n<th>Recovery Coordination</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>HTML Parse Error</td>\n<td>Malformed DOM tree</td>\n<td>Layout calculations on incorrect structure</td>\n<td>Layout uses error-corrected DOM</td>\n</tr>\n<tr>\n<td>CSS Parse Error</td>\n<td>Missing or invalid styles</td>\n<td>Layout uses default styles</td>\n<td>Rendering gets computed defaults</td>\n</tr>\n<tr>\n<td>Layout Calculation Error</td>\n<td>Incorrect element positioning</td>\n<td>Rendering draws at wrong locations</td>\n<td>Renderer clamps to valid coordinates</td>\n</tr>\n<tr>\n<td>Font Loading Failure</td>\n<td>Text metrics unavailable</td>\n<td>Layout estimates text dimensions</td>\n<td>Renderer uses fallback fonts</td>\n</tr>\n<tr>\n<td>Graphics Backend Failure</td>\n<td>Rendering operations fail</td>\n<td>User sees incomplete visuals</td>\n<td>Switch to software rendering</td>\n</tr>\n</tbody></table>\n<p><strong>Error State Propagation Protocol:</strong></p>\n<ol>\n<li><strong>Error Detection</strong>: Each pipeline stage detects errors using stage-specific validation</li>\n<li><strong>Error Classification</strong>: Classify errors as recoverable, degraded-functionality, or fatal</li>\n<li><strong>Recovery Action</strong>: Apply appropriate recovery strategy and continue processing</li>\n<li><strong>Error Context Passing</strong>: Pass error context and applied corrections to next pipeline stage</li>\n<li><strong>Quality Metadata</strong>: Include quality/confidence indicators with processed data</li>\n<li><strong>Fallback Coordination</strong>: Coordinate fallback strategies across stages for consistent behavior</li>\n</ol>\n<p>This comprehensive error handling approach ensures that our browser engine can handle the messy reality of web content while providing useful feedback for debugging and maintaining compatibility with existing web pages.</p>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>The error handling system requires careful coordination between robust error detection, intelligent recovery strategies, and graceful degradation paths. This implementation provides the infrastructure for handling errors throughout the rendering pipeline.</p>\n<h4 id=\"technology-recommendations\">Technology Recommendations</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Error Types</td>\n<td>Enum with error variants</td>\n<td>Structured error types with context</td>\n</tr>\n<tr>\n<td>Error Recovery</td>\n<td>Simple fallback values</td>\n<td>State machine-based recovery</td>\n</tr>\n<tr>\n<td>Logging</td>\n<td>Print statements for debugging</td>\n<td>Structured logging with levels</td>\n</tr>\n<tr>\n<td>Resource Management</td>\n<td>Manual cleanup</td>\n<td>RAII with automatic cleanup</td>\n</tr>\n<tr>\n<td>Graphics Fallback</td>\n<td>Single software fallback</td>\n<td>Multi-tier fallback cascade</td>\n</tr>\n</tbody></table>\n<h4 id=\"recommended-file-structure\">Recommended File Structure</h4>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>src/\n├── main.rs\n├── lib.rs\n├── error/\n│   ├── mod.rs                    ← Error type definitions and utilities\n│   ├── parse_error.rs            ← HTML/CSS parsing error types\n│   ├── layout_error.rs           ← Layout calculation error types\n│   └── render_error.rs           ← Rendering failure types\n├── html/\n│   ├── parser.rs\n│   └── error_recovery.rs         ← HTML parse error recovery\n├── css/\n│   ├── parser.rs\n│   └── error_recovery.rs         ← CSS parse error recovery\n├── layout/\n│   ├── engine.rs\n│   └── edge_cases.rs             ← Layout edge case handling\n├── render/\n│   ├── engine.rs\n│   ├── fallback.rs               ← Rendering fallback strategies\n│   └── resource_manager.rs       ← Graphics resource management\n└── utils/\n    ├── mod.rs\n    └── recovery.rs               ← Cross-component error utilities</code></pre></div>\n\n<h4 id=\"infrastructure-starter-code\">Infrastructure Starter Code</h4>\n<p><strong>Complete Error Type System:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/error/mod.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">fmt;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Result type used throughout the browser engine</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> type</span><span style=\"color:#B392F0\"> BrowserResult</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">BrowserError</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Top-level error type encompassing all failure modes</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> BrowserError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Parse</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Layout</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">LayoutError</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Render</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">RenderError</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Resource</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">ResourceError</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> fmt</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Display</span><span style=\"color:#F97583\"> for</span><span style=\"color:#B392F0\"> BrowserError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> fmt</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, f</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> fmt</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Formatter</span><span style=\"color:#E1E4E8\">&#x3C;'</span><span style=\"color:#B392F0\">_</span><span style=\"color:#E1E4E8\">>) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> fmt</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Result</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            BrowserError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Parse</span><span style=\"color:#E1E4E8\">(e) </span><span style=\"color:#F97583\">=></span><span style=\"color:#B392F0\"> write!</span><span style=\"color:#E1E4E8\">(f, </span><span style=\"color:#9ECBFF\">\"Parse error: {}\"</span><span style=\"color:#E1E4E8\">, e),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            BrowserError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Layout</span><span style=\"color:#E1E4E8\">(e) </span><span style=\"color:#F97583\">=></span><span style=\"color:#B392F0\"> write!</span><span style=\"color:#E1E4E8\">(f, </span><span style=\"color:#9ECBFF\">\"Layout error: {}\"</span><span style=\"color:#E1E4E8\">, e),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            BrowserError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Render</span><span style=\"color:#E1E4E8\">(e) </span><span style=\"color:#F97583\">=></span><span style=\"color:#B392F0\"> write!</span><span style=\"color:#E1E4E8\">(f, </span><span style=\"color:#9ECBFF\">\"Render error: {}\"</span><span style=\"color:#E1E4E8\">, e),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            BrowserError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Resource</span><span style=\"color:#E1E4E8\">(e) </span><span style=\"color:#F97583\">=></span><span style=\"color:#B392F0\"> write!</span><span style=\"color:#E1E4E8\">(f, </span><span style=\"color:#9ECBFF\">\"Resource error: {}\"</span><span style=\"color:#E1E4E8\">, e),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">error</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#F97583\"> for</span><span style=\"color:#B392F0\"> BrowserError</span><span style=\"color:#E1E4E8\"> {}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Severity levels for error reporting and recovery decisions</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Eq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> ErrorSeverity</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Warning</span><span style=\"color:#E1E4E8\">,    </span><span style=\"color:#6A737D\">// Continue with fallback</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Error</span><span style=\"color:#E1E4E8\">,      </span><span style=\"color:#6A737D\">// Degrade functionality</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Critical</span><span style=\"color:#E1E4E8\">,   </span><span style=\"color:#6A737D\">// Abort current operation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Error context provides additional information for debugging and recovery</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> location</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> severity</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorSeverity</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> recoverable</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> suggested_fallback</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(location</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, severity</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorSeverity</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            location</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> location</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            severity,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            recoverable</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> severity </span><span style=\"color:#F97583\">!=</span><span style=\"color:#B392F0\"> ErrorSeverity</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Critical</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            suggested_fallback</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> None</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> with_fallback</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, fallback</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">suggested_fallback </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> Some</span><span style=\"color:#E1E4E8\">(fallback</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">());</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// src/error/parse_error.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#79B8FF\"> super</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">ErrorContext</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">ErrorSeverity</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Parsing-specific error types with recovery information</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> ParseError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    UnexpectedEndTag</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    UnclosedElement</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    InvalidNesting</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        child_tag</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        parent_tag</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    MalformedEntity</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        entity_text</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    InvalidCSSSyntax</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        css_text</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> ParseError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> unexpected_end_tag</span><span style=\"color:#E1E4E8\">(tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, location</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        ParseError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">UnexpectedEndTag</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> tag_name</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(location, </span><span style=\"color:#B392F0\">ErrorSeverity</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Warning</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">with_fallback</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"ignore end tag\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> unclosed_element</span><span style=\"color:#E1E4E8\">(tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, location</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        ParseError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">UnclosedElement</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            tag_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> tag_name</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(location, </span><span style=\"color:#B392F0\">ErrorSeverity</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Warning</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">with_fallback</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"auto-close element\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">ErrorContext</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            ParseError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">UnexpectedEndTag</span><span style=\"color:#E1E4E8\"> { context, </span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\"> } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> context,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            ParseError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">UnclosedElement</span><span style=\"color:#E1E4E8\"> { context, </span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\"> } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> context,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            ParseError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">InvalidNesting</span><span style=\"color:#E1E4E8\"> { context, </span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\"> } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> context,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            ParseError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">MalformedEntity</span><span style=\"color:#E1E4E8\"> { context, </span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\"> } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> context,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            ParseError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">InvalidCSSSyntax</span><span style=\"color:#E1E4E8\"> { context, </span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\"> } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> context,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Display</span><span style=\"color:#F97583\"> for</span><span style=\"color:#B392F0\"> ParseError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> fmt</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, f</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Formatter</span><span style=\"color:#E1E4E8\">&#x3C;'</span><span style=\"color:#B392F0\">_</span><span style=\"color:#E1E4E8\">>) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Result</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            ParseError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">UnexpectedEndTag</span><span style=\"color:#E1E4E8\"> { tag_name, context } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                write!</span><span style=\"color:#E1E4E8\">(f, </span><span style=\"color:#9ECBFF\">\"Unexpected end tag '{}' at {}\"</span><span style=\"color:#E1E4E8\">, tag_name, context</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">location)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            ParseError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">UnclosedElement</span><span style=\"color:#E1E4E8\"> { tag_name, context } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                write!</span><span style=\"color:#E1E4E8\">(f, </span><span style=\"color:#9ECBFF\">\"Unclosed element '{}' at {}\"</span><span style=\"color:#E1E4E8\">, tag_name, context</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">location)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            ParseError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">InvalidNesting</span><span style=\"color:#E1E4E8\"> { child_tag, parent_tag, context } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                write!</span><span style=\"color:#E1E4E8\">(f, </span><span style=\"color:#9ECBFF\">\"Invalid nesting: '{}' inside '{}' at {}\"</span><span style=\"color:#E1E4E8\">, child_tag, parent_tag, context</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">location)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            ParseError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">MalformedEntity</span><span style=\"color:#E1E4E8\"> { entity_text, context } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                write!</span><span style=\"color:#E1E4E8\">(f, </span><span style=\"color:#9ECBFF\">\"Malformed entity '{}' at {}\"</span><span style=\"color:#E1E4E8\">, entity_text, context</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">location)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            ParseError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">InvalidCSSSyntax</span><span style=\"color:#E1E4E8\"> { css_text, context } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                write!</span><span style=\"color:#E1E4E8\">(f, </span><span style=\"color:#9ECBFF\">\"Invalid CSS syntax '{}' at {}\"</span><span style=\"color:#E1E4E8\">, css_text, context</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">location)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// src/error/render_error.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#79B8FF\"> super</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">ErrorContext</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">ErrorSeverity</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Rendering-specific error types with fallback strategies</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> RenderError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    GraphicsContextLost</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    FontLoadFailed</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        font_family</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    OutOfMemory</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        requested_bytes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    CoordinateOverflow</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        coordinate</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    UnsupportedOperation</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        operation</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> RenderError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> font_load_failed</span><span style=\"color:#E1E4E8\">(font_family</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, location</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        RenderError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">FontLoadFailed</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            font_family</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> font_family</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            context</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> ErrorContext</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(location, </span><span style=\"color:#B392F0\">ErrorSeverity</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Warning</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                .</span><span style=\"color:#B392F0\">with_fallback</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"use system default font\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">ErrorContext</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            RenderError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">GraphicsContextLost</span><span style=\"color:#E1E4E8\"> { context } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> context,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            RenderError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">FontLoadFailed</span><span style=\"color:#E1E4E8\"> { context, </span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\"> } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> context,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            RenderError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">OutOfMemory</span><span style=\"color:#E1E4E8\"> { context, </span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\"> } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> context,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            RenderError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">CoordinateOverflow</span><span style=\"color:#E1E4E8\"> { context, </span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\"> } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> context,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            RenderError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">UnsupportedOperation</span><span style=\"color:#E1E4E8\"> { context, </span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\"> } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> context,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// src/utils/recovery.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">error</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">BrowserError</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">ErrorSeverity</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Utility functions for error recovery across components</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> ErrorRecovery</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> ErrorRecovery</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Determines if an error should halt processing or allow continuation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> should_continue</span><span style=\"color:#E1E4E8\">(error</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">BrowserError</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#E1E4E8\"> error {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            BrowserError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Parse</span><span style=\"color:#E1E4E8\">(e) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> e</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">context</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">severity </span><span style=\"color:#F97583\">!=</span><span style=\"color:#B392F0\"> ErrorSeverity</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Critical</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            BrowserError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Layout</span><span style=\"color:#E1E4E8\">(e) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> e</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">context</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">severity </span><span style=\"color:#F97583\">!=</span><span style=\"color:#B392F0\"> ErrorSeverity</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Critical</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            BrowserError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Render</span><span style=\"color:#E1E4E8\">(e) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> e</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">context</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">severity </span><span style=\"color:#F97583\">!=</span><span style=\"color:#B392F0\"> ErrorSeverity</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Critical</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            BrowserError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Resource</span><span style=\"color:#E1E4E8\">(e) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> e</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">context</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">severity </span><span style=\"color:#F97583\">!=</span><span style=\"color:#B392F0\"> ErrorSeverity</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Critical</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Logs error with appropriate level based on severity</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> log_error</span><span style=\"color:#E1E4E8\">(error</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">BrowserError</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#E1E4E8\"> error {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            BrowserError</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Parse</span><span style=\"color:#E1E4E8\">(e) </span><span style=\"color:#F97583\">=></span><span style=\"color:#F97583\"> match</span><span style=\"color:#E1E4E8\"> e</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">context</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">severity {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                ErrorSeverity</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Warning</span><span style=\"color:#F97583\"> =></span><span style=\"color:#B392F0\"> println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"WARN: {}\"</span><span style=\"color:#E1E4E8\">, error),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                ErrorSeverity</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#F97583\"> =></span><span style=\"color:#B392F0\"> println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"ERROR: {}\"</span><span style=\"color:#E1E4E8\">, error),</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                ErrorSeverity</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Critical</span><span style=\"color:#F97583\"> =></span><span style=\"color:#B392F0\"> println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"CRITICAL: {}\"</span><span style=\"color:#E1E4E8\">, error),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            _ </span><span style=\"color:#F97583\">=></span><span style=\"color:#B392F0\"> println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"ERROR: {}\"</span><span style=\"color:#E1E4E8\">, error),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Applies suggested fallback if available</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> apply_fallback</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">>(error</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">BrowserError</span><span style=\"color:#E1E4E8\">, default_value</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> T</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> T</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Log the error and return default</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">log_error</span><span style=\"color:#E1E4E8\">(error);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        default_value</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"core-logic-skeleton-code\">Core Logic Skeleton Code</h4>\n<p><strong>HTML Error Recovery Implementation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/html/error_recovery.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">error</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">BrowserResult</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">html</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">HTMLToken</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">collections</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">HashMap</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// HTML parse error recovery implementation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> HTMLErrorRecovery</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    open_elements</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    error_count</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> HTMLErrorRecovery</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            open_elements</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            error_count</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Handles unclosed elements at end of input</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> close_all_open_elements</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> BrowserResult</span><span style=\"color:#E1E4E8\">&#x3C;()> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Iterate through open_elements in reverse order (LIFO)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: For each open element, create implicit closing tag</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Update DOM tree to properly close the element</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Log warning for each auto-closed element</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Clear the open_elements stack</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use ParseError::unclosed_element for each auto-closed tag</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement auto-closing of unclosed elements\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Implements foster parenting for misplaced elements</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> foster_parent_element</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        &#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        child_tag</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        parent_tag</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        child_node</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> DOMNodeHandle</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> BrowserResult</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Check if child_tag is allowed inside parent_tag using HTML content model</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: If not allowed, search up open_elements stack for appropriate parent</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: If appropriate parent found, close intervening elements</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: If no appropriate parent, create anonymous block container</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Insert child_node at the corrected location</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Log ParseError::InvalidNesting with recovery action</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use VOID_ELEMENTS constant to check self-closing elements</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement foster parenting algorithm\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Recovers from malformed tag syntax</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> recover_malformed_tag</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, tag_text</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> BrowserResult</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">HTMLToken</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Check for common malformation patterns (missing quotes, unclosed attributes)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Attempt to repair the tag by adding missing characters</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: If repair successful, return corrected HTMLToken</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: If unrepairable, treat as text content</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Log appropriate ParseError with suggested fix</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Look for patterns like `&#x3C;div class=unclosed` and add closing quote</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement tag malformation recovery\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// src/css/error_recovery.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">error</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">BrowserResult</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">css</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">CSSToken</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">CSSRule</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Declaration</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// CSS parse error recovery implementation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> CSSErrorRecovery</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    error_count</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> CSSErrorRecovery</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Skips to next recovery point after parse error</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> skip_to_recovery_point</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, tokens</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#B392F0\">CSSToken</span><span style=\"color:#E1E4E8\">], position</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Identify current parsing context (rule, declaration, function, etc.)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Find appropriate recovery token for context (}, ;, ), etc.)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Consume tokens until recovery point found</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Return new position after recovery point</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Log ParseError::InvalidCSSSyntax with skipped content</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Track brace/parentheses nesting to find correct recovery point</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement CSS error recovery point detection\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Validates and recovers invalid property values</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> recover_property_value</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, property</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, value</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> BrowserResult</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Check if value matches expected syntax for property</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Validate numeric ranges (e.g., opacity 0-1)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Check unit compatibility (length units for width, etc.)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: If invalid, determine appropriate fallback value</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Log error with invalid value and chosen fallback</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use match on property name to apply property-specific validation</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement CSS property value validation and recovery\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Layout Edge Case Handling:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/layout/edge_cases.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">BoxOffsets</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">css</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Unit</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">ComputedLength</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">error</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">LayoutError</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">BrowserResult</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Handles complex layout edge cases and constraint resolution</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> LayoutEdgeCaseHandler</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> LayoutEdgeCaseHandler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Resolves circular dependencies in percentage calculations</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> resolve_percentage_cycles</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        &#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        element</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> LayoutBox</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        available_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> BrowserResult</span><span style=\"color:#E1E4E8\">&#x3C;()> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Detect if element width depends on parent width (percentage)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Check if parent width depends on element content (auto sizing)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: If circular dependency detected, use intrinsic content width</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Apply CSS-specified resolution order for breaking cycles</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Ensure calculated values converge to stable result</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use tentative values and iterative resolution for complex cases</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement percentage cycle resolution\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Implements margin collapsing with all edge cases</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> calculate_margin_collapse</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        &#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        margin1</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        margin2</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        context</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> BrowserResult</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Check if margins are adjacent (no border/padding between)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Handle positive margin case (use maximum)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Handle negative margin case (use minimum/most negative)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Handle mixed positive/negative case (arithmetic sum)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Consider clearance preventing collapse</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Log complex collapse scenarios for debugging</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Clearance from floated elements prevents margin collapsing</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement complete margin collapse algorithm\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Resolves over-constrained box model situations</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> resolve_over_constraint</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        &#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        available_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        computed_style</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">ComputedStyle</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> BrowserResult</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">BoxOffsets</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Calculate total required width including margins, borders, padding</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Check if total exceeds available width</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: If over-constrained, apply CSS reduction priority order</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Reduce auto margins first, then explicit margins</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Ensure minimum content requirements are still met</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Allow overflow if reduction would break readability</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: CSS spec defines exact order for resolving over-constraint</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement over-constraint resolution\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Rendering Fallback System:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/render/fallback.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">render</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">PaintCommand</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">DisplayList</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">FontInfo</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">TextMetrics</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">error</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">RenderError</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">BrowserResult</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Multi-tier rendering fallback system for handling graphics failures</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> RenderingFallback</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    fallback_level</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> FallbackLevel</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    software_renderer_available</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">enum</span><span style=\"color:#B392F0\"> FallbackLevel</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Hardware</span><span style=\"color:#E1E4E8\">,     </span><span style=\"color:#6A737D\">// Full GPU acceleration</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Software</span><span style=\"color:#E1E4E8\">,     </span><span style=\"color:#6A737D\">// CPU rendering with full features  </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Simple</span><span style=\"color:#E1E4E8\">,       </span><span style=\"color:#6A737D\">// Basic shapes and text only</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    TextOnly</span><span style=\"color:#E1E4E8\">,     </span><span style=\"color:#6A737D\">// Text rendering only</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    ErrorDisplay</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// Show error message</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> RenderingFallback</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            fallback_level</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> FallbackLevel</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Hardware</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            software_renderer_available</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> true</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Attempts to render display list with current fallback level</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> render_with_fallback</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, display_list</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DisplayList</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> BrowserResult</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">u8</span><span style=\"color:#E1E4E8\">>> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Try rendering with current fallback level</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: If rendering fails, move to next fallback level</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Simplify display list commands for lower fallback levels</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Log degradation when fallback level decreases</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Return rendered output or error display</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Each fallback level supports different subset of PaintCommand variants</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement fallback rendering cascade\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Handles font loading failures with progressive fallback</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> handle_font_failure</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        &#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        requested_font</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">FontInfo</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        text</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> BrowserResult</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">TextMetrics</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Try loading fonts from CSS font-family list in order</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Fall back to system default fonts if CSS fonts fail</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Use built-in fonts if system fonts unavailable</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Calculate estimated metrics if all font loading fails</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Log font fallback chain for debugging</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Maintain font cache to avoid reloading failed fonts</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement font fallback with metrics estimation\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Manages graphics resource limits and memory pressure</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> handle_resource_pressure</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> BrowserResult</span><span style=\"color:#E1E4E8\">&#x3C;()> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Check current memory usage against limits</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: If pressure detected, start resource cleanup</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Evict least-recently-used cached resources</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Reduce rendering quality to save memory</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Switch to lower fallback level if needed</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Log resource pressure events and actions taken</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use LRU cache for fonts and textures with size-based eviction</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        todo!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Implement resource pressure handling\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"milestone-checkpoints\">Milestone Checkpoints</h4>\n<p><strong>After implementing parse error recovery:</strong></p>\n<ul>\n<li>Run <code>cargo test html_error_recovery</code> - should pass tests for malformed HTML</li>\n<li>Test with intentionally broken HTML: <code>&lt;div&gt;&lt;p&gt;unclosed</code> should auto-close both tags</li>\n<li>Verify foster parenting: <code>&lt;span&gt;&lt;div&gt;content&lt;/div&gt;&lt;/span&gt;</code> should move div outside span</li>\n<li>Check error logging shows appropriate warnings with suggested fixes</li>\n</ul>\n<p><strong>After implementing layout edge cases:</strong></p>\n<ul>\n<li>Run <code>cargo test layout_edge_cases</code> - should handle percentage cycles and margin collapse</li>\n<li>Test over-constrained layout: element wider than container should overflow gracefully</li>\n<li>Verify margin collapse: adjacent margins should collapse to maximum value</li>\n<li>Check that layout doesn&#39;t infinite loop on circular percentage dependencies</li>\n</ul>\n<p><strong>After implementing rendering fallbacks:</strong></p>\n<ul>\n<li>Run <code>cargo test render_fallback</code> - should gracefully degrade when graphics fail</li>\n<li>Test font fallback: specify non-existent font, should fall back to system default</li>\n<li>Simulate graphics context loss, should switch to software rendering</li>\n<li>Verify error display appears when all rendering methods fail</li>\n</ul>\n<h4 id=\"debugging-tips\">Debugging Tips</h4>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>How to Diagnose</th>\n<th>Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Parser infinite loop</td>\n<td>Error recovery not advancing input position</td>\n<td>Add debug prints in tokenizer state machine</td>\n<td>Ensure error recovery always consumes at least one character</td>\n</tr>\n<tr>\n<td>Layout calculations never converge</td>\n<td>Circular percentage dependencies</td>\n<td>Log calculated values in percentage resolution</td>\n<td>Implement cycle detection and break with intrinsic sizes</td>\n</tr>\n<tr>\n<td>Font rendering shows boxes</td>\n<td>Font fallback chain exhausted</td>\n<td>Check font loading error logs</td>\n<td>Add built-in bitmap font as final fallback</td>\n</tr>\n<tr>\n<td>Graphics render fails silently</td>\n<td>Error not propagated properly</td>\n<td>Enable graphics backend error logging</td>\n<td>Check all graphics calls return success codes</td>\n</tr>\n<tr>\n<td>Memory usage grows without bound</td>\n<td>Resource cleanup not working</td>\n<td>Monitor font and texture cache sizes</td>\n<td>Implement LRU eviction with proper size limits</td>\n</tr>\n<tr>\n<td>Text appears at wrong positions</td>\n<td>Font metrics estimation incorrect</td>\n<td>Compare estimated vs actual text measurements</td>\n<td>Calibrate estimation constants against real fonts</td>\n</tr>\n</tbody></table>\n<h2 id=\"testing-strategy-and-milestone-validation\">Testing Strategy and Milestone Validation</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> All milestones (1-4) - This section establishes comprehensive testing approaches and validation criteria for each stage of the browser engine implementation.</p>\n</blockquote>\n<p>Building a browser engine presents unique testing challenges because the system transforms textual markup through multiple intermediate representations before producing visual output. Think of testing a browser engine like <strong>quality control in a film production pipeline</strong> — you need checkpoints at each stage (script review, filming, editing, post-production) rather than just watching the final movie. Each stage has different success criteria: the script needs coherent plot structure, the raw footage needs proper lighting and framing, the edited sequences need smooth transitions, and the final product needs correct color grading and audio sync.</p>\n<p>Similarly, our browser engine requires validation at each pipeline stage. The HTML parser must produce structurally correct DOM trees regardless of input malformations. The CSS parser must handle invalid syntax gracefully while preserving valid rules. The layout engine must compute geometrically consistent box positions even with conflicting constraints. The rendering engine must produce visually correct output even when graphics resources are constrained.</p>\n<p>The testing strategy balances <strong>unit-level validation</strong> (testing individual components in isolation) with <strong>integration-level validation</strong> (testing the complete pipeline with real-world inputs). Each milestone builds upon previous stages, so testing must verify both backward compatibility and forward progression. The key insight is that browser engines fail gracefully — they should render <em>something</em> useful even with severely malformed input, rather than crashing or producing blank output.</p>\n<h3 id=\"milestone-validation-checkpoints\">Milestone Validation Checkpoints</h3>\n<p>Each milestone requires specific validation checkpoints that verify the acceptance criteria have been met. These checkpoints serve as concrete proof that the implementation handles both normal cases and edge cases correctly.</p>\n<h4 id=\"milestone-1-html-parser-validation\">Milestone 1: HTML Parser Validation</h4>\n<p>The HTML parser validation focuses on <strong>structural correctness</strong> of the DOM tree and <strong>graceful degradation</strong> with malformed input. Think of this like <strong>validating a document parser</strong> — the output structure must accurately represent the input meaning, even when the input format is imperfect.</p>\n<table>\n<thead>\n<tr>\n<th>Test Category</th>\n<th>Validation Focus</th>\n<th>Success Criteria</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Basic Tokenization</td>\n<td>Token boundary detection</td>\n<td>Start tags, end tags, text content, and attributes are correctly identified</td>\n</tr>\n<tr>\n<td>Tree Construction</td>\n<td>Parent-child relationships</td>\n<td>DOM tree reflects HTML nesting structure with correct hierarchy</td>\n</tr>\n<tr>\n<td>Self-Closing Elements</td>\n<td>Void element handling</td>\n<td>Elements like <code>br</code>, <code>img</code>, <code>input</code> don&#39;t expect closing tags</td>\n</tr>\n<tr>\n<td>Error Recovery</td>\n<td>Malformed input handling</td>\n<td>Missing closing tags and improper nesting produce usable DOM trees</td>\n</tr>\n<tr>\n<td>Entity Decoding</td>\n<td>Character reference processing</td>\n<td>Named entities (<code>&amp;amp;</code>, <code>&amp;lt;</code>) and numeric entities are decoded</td>\n</tr>\n</tbody></table>\n<p><strong>Essential Test Cases for HTML Parser:</strong></p>\n<p>The tokenizer validation requires testing the state machine transitions with various input patterns:</p>\n<ol>\n<li><strong>Well-formed markup parsing</strong>: Standard HTML with properly nested elements, complete attribute syntax, and correct tag closing should produce an exact structural match in the DOM tree</li>\n<li><strong>Attribute parsing verification</strong>: Elements with multiple attributes, quoted and unquoted values, and empty attributes should preserve all attribute data in the <code>ElementData</code> structure</li>\n<li><strong>Text content preservation</strong>: Mixed text and element content should maintain text nodes in correct positions relative to element siblings</li>\n<li><strong>Self-closing element recognition</strong>: Void elements like <code>&lt;br&gt;</code>, <code>&lt;img src=&quot;test.png&quot;&gt;</code>, and <code>&lt;input type=&quot;text&quot;&gt;</code> should not wait for closing tags and should set the <code>is_void</code> flag correctly</li>\n<li><strong>Malformed tag recovery</strong>: Unclosed tags like <code>&lt;div&gt;&lt;p&gt;content</code> should auto-close at document end or when encountering incompatible parent elements</li>\n<li><strong>Improper nesting correction</strong>: Invalid structures like <code>&lt;p&gt;&lt;div&gt;content&lt;/div&gt;&lt;/p&gt;</code> should use foster parenting to move misplaced elements to valid locations</li>\n<li><strong>Entity decoding accuracy</strong>: Character references like <code>&amp;amp;</code>, <code>&amp;lt;</code>, <code>&amp;quot;</code>, and numeric references like <code>&amp;#65;</code> should decode to correct Unicode characters</li>\n<li><strong>Case sensitivity handling</strong>: Tag names and attribute names should normalize to lowercase while preserving attribute value casing</li>\n</ol>\n<blockquote>\n<p><strong>Critical Validation Point</strong>: The DOM tree&#39;s <code>get_children()</code> and <code>get_parent()</code> methods should maintain bidirectional consistency — every child&#39;s parent should reference the correct ancestor, and every parent&#39;s children list should contain all direct descendants.</p>\n</blockquote>\n<p><strong>HTML Parser Checkpoint Commands:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code># Test basic parsing functionality\ncargo test html_parser_basic --features test-utils\n\n# Validate malformed input recovery  \ncargo test html_error_recovery --features test-utils\n\n# Verify entity decoding\ncargo test html_entities --features test-utils</code></pre></div>\n\n<p>Expected output should show successful DOM tree construction with proper node relationships and error counts within acceptable limits (warnings for malformed input, but no critical failures that prevent tree construction).</p>\n<h4 id=\"milestone-2-css-parser-validation\">Milestone 2: CSS Parser Validation</h4>\n<p>The CSS parser validation emphasizes <strong>rule extraction accuracy</strong> and <strong>cascade precedence correctness</strong>. This is like <strong>validating a legal document parser</strong> — the system must extract precise rules from complex syntax and apply them in the correct priority order.</p>\n<table>\n<thead>\n<tr>\n<th>Test Category</th>\n<th>Validation Focus</th>\n<th>Success Criteria</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Selector Parsing</td>\n<td>Selector type recognition</td>\n<td>Tag, class, ID, and combinator selectors parse correctly</td>\n</tr>\n<tr>\n<td>Property Extraction</td>\n<td>Declaration parsing</td>\n<td>Property names, values, and units are extracted accurately</td>\n</tr>\n<tr>\n<td>Specificity Calculation</td>\n<td>Precedence computation</td>\n<td>Specificity tuple (inline, ids, classes, elements) is correct</td>\n</tr>\n<tr>\n<td>Cascade Application</td>\n<td>Rule precedence</td>\n<td>Styles apply in document order with specificity override</td>\n</tr>\n<tr>\n<td>Error Recovery</td>\n<td>Invalid CSS handling</td>\n<td>Malformed rules are skipped without breaking valid rules</td>\n</tr>\n</tbody></table>\n<p><strong>Essential Test Cases for CSS Parser:</strong></p>\n<p>The CSS parser testing requires validating both individual rule parsing and complete stylesheet processing:</p>\n<ol>\n<li><strong>Selector variety parsing</strong>: Test tag selectors (<code>div</code>), class selectors (<code>.content</code>), ID selectors (<code>#header</code>), and attribute selectors (<code>input[type=&quot;text&quot;]</code>) for correct <code>Selector</code> enum construction</li>\n<li><strong>Combinator selector handling</strong>: Descendant (<code>div p</code>), child (<code>ul &gt; li</code>), adjacent sibling (<code>h1 + p</code>), and general sibling (<code>h1 ~ p</code>) combinators should parse into correct combinator variants</li>\n<li><strong>Property-value extraction</strong>: CSS declarations like <code>color: red</code>, <code>margin: 10px 20px</code>, and <code>background: url(image.png) no-repeat center</code> should parse into appropriate <code>CSSValue</code> enum variants</li>\n<li><strong>Specificity computation validation</strong>: Complex selectors like <code>#main .content div.highlight</code> should calculate specificity as (0, 1, 2, 1) representing (inline, ids, classes, elements)</li>\n<li><strong>Cascade rule application</strong>: When multiple rules target the same element, higher specificity rules should override lower specificity ones, with document order as the tiebreaker</li>\n<li><strong>Unit parsing verification</strong>: Length values like <code>10px</code>, <code>2em</code>, <code>50%</code>, and <code>auto</code> should parse into correct <code>Unit</code> enum variants with proper numeric values</li>\n<li><strong>Color value processing</strong>: Color values in hex (<code>#FF0000</code>), RGB (<code>rgb(255, 0, 0)</code>), and keyword (<code>red</code>) formats should convert to consistent <code>Color</code> struct representation</li>\n<li><strong>Invalid rule recovery</strong>: Malformed CSS like <code>color: ;</code> or <code>unknown-property: value;</code> should be skipped without affecting subsequent valid rules</li>\n</ol>\n<blockquote>\n<p><strong>Critical Validation Point</strong>: The <code>calculate_specificity()</code> function must produce consistent results that match CSS specification algorithms, as this directly affects which styles apply to elements during cascade resolution.</p>\n</blockquote>\n<p><strong>CSS Parser Checkpoint Commands:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code># Test selector and property parsing\ncargo test css_parser_rules --features test-utils\n\n# Validate specificity calculations  \ncargo test css_specificity --features test-utils\n\n# Verify cascade resolution\ncargo test css_cascade --features test-utils</code></pre></div>\n\n<p>Expected output should demonstrate correct rule extraction, accurate specificity values, and proper cascade application where high-specificity rules override low-specificity ones.</p>\n<h4 id=\"milestone-3-layout-engine-validation\">Milestone 3: Layout Engine Validation</h4>\n<p>The layout engine validation focuses on <strong>geometric consistency</strong> and <strong>constraint satisfaction</strong>. Think of this like <strong>validating an architectural blueprint</strong> — all measurements must be mathematically consistent, space allocations must sum correctly, and physical constraints must be respected.</p>\n<table>\n<thead>\n<tr>\n<th>Test Category</th>\n<th>Validation Focus</th>\n<th>Success Criteria</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Box Model Calculation</td>\n<td>Dimension computation</td>\n<td>Content, padding, border, margin rectangles are correctly sized</td>\n</tr>\n<tr>\n<td>Block Formatting</td>\n<td>Vertical layout</td>\n<td>Child elements stack vertically with proper spacing</td>\n</tr>\n<tr>\n<td>Inline Formatting</td>\n<td>Horizontal flow</td>\n<td>Inline content flows horizontally with correct line breaks</td>\n</tr>\n<tr>\n<td>Constraint Resolution</td>\n<td>Overconstrained handling</td>\n<td>Conflicting width/margin values resolve per CSS specification</td>\n</tr>\n<tr>\n<td>Margin Collapsing</td>\n<td>Adjacent margin handling</td>\n<td>Vertical margins collapse according to CSS rules</td>\n</tr>\n</tbody></table>\n<p><strong>Essential Test Cases for Layout Engine:</strong></p>\n<p>The layout validation requires testing both individual box calculations and complete formatting context behavior:</p>\n<ol>\n<li><strong>Box model dimension verification</strong>: Elements with explicit <code>width</code>, <code>height</code>, <code>padding</code>, <code>border</code>, and <code>margin</code> values should produce <code>LayoutBox</code> structures where <code>content_rect</code>, <code>padding_rect</code>, <code>border_rect</code>, and <code>margin_rect</code> have mathematically consistent dimensions</li>\n<li><strong>Auto sizing behavior</strong>: Elements with <code>width: auto</code> should expand to fill available space minus sibling elements&#39; space requirements, while <code>height: auto</code> should shrink to content height</li>\n<li><strong>Percentage unit resolution</strong>: Child elements with percentage dimensions should compute to pixel values based on their containing block&#39;s resolved dimensions</li>\n<li><strong>Block formatting context</strong>: Block elements should stack vertically with each child&#39;s <code>content_rect.origin.y</code> positioned below the previous child&#39;s margin bottom edge</li>\n<li><strong>Inline formatting context</strong>: Text and inline elements should flow horizontally within available width, creating new <code>LineBox</code> instances when content exceeds container bounds</li>\n<li><strong>Margin collapsing verification</strong>: Adjacent block elements with vertical margins should collapse to the larger margin value, not the sum of both margins</li>\n<li><strong>Overconstrained resolution</strong>: Elements with conflicting constraints like <code>width: 200px</code> and <code>margin-left: auto</code> and <code>margin-right: auto</code> in a 150px container should resolve according to CSS specification priority rules</li>\n<li><strong>Nested formatting context</strong>: Block containers with both block and inline children should create anonymous block boxes to wrap inline content sequences</li>\n</ol>\n<blockquote>\n<p><strong>Critical Validation Point</strong>: The <code>calculate_box_model()</code> method must ensure that <code>margin_rect.size.width</code> equals <code>content_rect.size.width</code> plus padding, border, and margin horizontal totals. Any mismatch indicates a fundamental calculation error.</p>\n</blockquote>\n<p><strong>Layout Engine Checkpoint Commands:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code># Test box model calculations\ncargo test layout_box_model --features test-utils\n\n# Validate formatting contexts\ncargo test layout_formatting --features test-utils  \n\n# Verify constraint resolution\ncargo test layout_constraints --features test-utils</code></pre></div>\n\n<p>Expected output should show consistent rectangle dimensions where outer rectangles properly contain inner rectangles, and total space allocation matches available space.</p>\n<h4 id=\"milestone-4-rendering-engine-validation\">Milestone 4: Rendering Engine Validation</h4>\n<p>The rendering engine validation emphasizes <strong>visual output correctness</strong> and <strong>paint command ordering</strong>. This is like <strong>validating a print production system</strong> — the final output must visually match the design specifications, colors must be accurate, and layering must follow the correct stacking order.</p>\n<table>\n<thead>\n<tr>\n<th>Test Category</th>\n<th>Validation Focus</th>\n<th>Success Criteria</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Paint Command Generation</td>\n<td>Drawing operation sequence</td>\n<td>Background, border, and text commands generate in correct order</td>\n</tr>\n<tr>\n<td>Color Accuracy</td>\n<td>RGB value preservation</td>\n<td>Colors specified in CSS render with exact RGB values</td>\n</tr>\n<tr>\n<td>Text Positioning</td>\n<td>Baseline alignment</td>\n<td>Text renders at correct coordinates with proper font metrics</td>\n</tr>\n<tr>\n<td>Z-Order Handling</td>\n<td>Layering sequence</td>\n<td>Later elements paint over earlier elements</td>\n</tr>\n<tr>\n<td>Clipping Boundaries</td>\n<td>Viewport constraints</td>\n<td>Content outside viewport bounds is properly clipped</td>\n</tr>\n</tbody></table>\n<p><strong>Essential Test Cases for Rendering Engine:</strong></p>\n<p>The rendering validation requires both command sequence verification and visual output testing:</p>\n<ol>\n<li><strong>Display list command ordering</strong>: The <code>generate_display_list()</code> function should produce <code>PaintCommand</code> sequences where background rectangles precede border rectangles, which precede text commands for each element</li>\n<li><strong>Color value preservation</strong>: CSS colors like <code>background-color: #FF0000</code> should generate <code>DrawRectangle</code> commands with <code>Color { r: 255, g: 0, b: 0, a: 255 }</code> values</li>\n<li><strong>Text positioning accuracy</strong>: Text elements should generate <code>DrawText</code> commands with coordinates that align text baselines correctly within their containing <code>LayoutBox</code> rectangles  </li>\n<li><strong>Rectangle coordinate verification</strong>: <code>DrawRectangle</code> and <code>DrawBorder</code> commands should use coordinates from the corresponding <code>LayoutBox.border_rect</code> or <code>LayoutBox.content_rect</code> fields</li>\n<li><strong>Z-order paint sequence</strong>: Elements appearing later in document order should generate paint commands that appear later in the <code>DisplayList.commands</code> vector, ensuring proper visual layering</li>\n<li><strong>Viewport clipping application</strong>: Elements with rectangles extending beyond <code>BrowserEngine.viewport_size</code> should either generate <code>SetClip</code> commands or be omitted from the display list entirely</li>\n<li><strong>Font fallback handling</strong>: Text with unavailable fonts should generate <code>DrawText</code> commands using fallback font families rather than failing or rendering blank space</li>\n<li><strong>Graphics backend compatibility</strong>: The <code>render_to_canvas()</code> function should produce consistent visual output regardless of whether hardware acceleration is available</li>\n</ol>\n<blockquote>\n<p><strong>Critical Validation Point</strong>: The <code>DisplayList.commands</code> vector must maintain paint order consistency — background colors must precede borders, which must precede text content for each element. Violations of this ordering produce incorrect visual layering.</p>\n</blockquote>\n<p><strong>Rendering Engine Checkpoint Commands:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code># Test paint command generation\ncargo test render_display_list --features test-utils\n\n# Validate visual output  \ncargo test render_canvas --features test-utils\n\n# Verify z-order handling\ncargo test render_layering --features test-utils</code></pre></div>\n\n<p>Expected output should produce visual files or canvas data that can be compared against reference images, with text clearly readable and colors matching CSS specifications.</p>\n<h3 id=\"integration-testing-strategy\">Integration Testing Strategy</h3>\n<p>Integration testing validates the <strong>complete rendering pipeline</strong> with real-world HTML and CSS inputs. Think of this like <strong>end-to-end quality assurance for a manufacturing pipeline</strong> — individual components might work correctly in isolation, but the complete system must handle the complex interactions and edge cases that emerge when all components work together.</p>\n<p>The integration testing strategy focuses on <strong>realistic web content scenarios</strong> rather than synthetic test cases. This reveals issues like CSS rules that parse correctly but produce invalid layout constraints, or layout calculations that are geometrically sound but generate paint commands outside graphics system limits.</p>\n<h4 id=\"comprehensive-pipeline-testing\">Comprehensive Pipeline Testing</h4>\n<p>The integration tests should exercise the complete <code>render_page()</code> function with various complexity levels of real HTML/CSS content:</p>\n<table>\n<thead>\n<tr>\n<th>Test Complexity</th>\n<th>Content Characteristics</th>\n<th>Validation Focus</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Basic Documents</td>\n<td>Simple HTML with minimal CSS</td>\n<td>End-to-end pipeline functionality</td>\n</tr>\n<tr>\n<td>Styled Content</td>\n<td>Multiple CSS rules and selectors</td>\n<td>Style resolution and cascade accuracy</td>\n</tr>\n<tr>\n<td>Complex Layouts</td>\n<td>Nested elements with varied positioning</td>\n<td>Layout constraint interaction</td>\n</tr>\n<tr>\n<td>Edge Case Combinations</td>\n<td>Malformed HTML with complex CSS</td>\n<td>Error recovery across pipeline stages</td>\n</tr>\n<tr>\n<td>Performance Boundaries</td>\n<td>Large documents with many elements</td>\n<td>Resource management and scaling</td>\n</tr>\n</tbody></table>\n<p><strong>Essential Integration Test Scenarios:</strong></p>\n<p>The integration test suite should include realistic web content patterns that stress the interactions between pipeline components:</p>\n<ol>\n<li><strong>Basic webpage rendering</strong>: A simple HTML document with headings, paragraphs, and basic CSS styling should render completely without errors, producing a <code>DisplayList</code> with appropriate text and background commands</li>\n<li><strong>CSS cascade complexity</strong>: Multiple stylesheets with conflicting rules should resolve according to specificity and source order, with the final rendered output reflecting the correct winning styles</li>\n<li><strong>Nested layout interaction</strong>: Complex HTML structures with deeply nested elements should produce correct layout calculations where child element positions are computed relative to their proper containing blocks</li>\n<li><strong>Mixed content handling</strong>: Documents combining block elements, inline text, images, and form elements should create appropriate anonymous boxes and formatting contexts</li>\n<li><strong>Malformed input resilience</strong>: Documents with both HTML parsing errors and CSS syntax errors should still produce usable visual output, degrading gracefully rather than failing completely</li>\n<li><strong>Resource constraint handling</strong>: Large documents that approach memory or processing limits should either render successfully or fail gracefully with appropriate error messages</li>\n<li><strong>Font and color accuracy</strong>: Documents with various font families, sizes, and color specifications should render with visually correct text appearance and background colors</li>\n<li><strong>Viewport adaptation</strong>: Content designed for different screen sizes should adapt appropriately to the configured <code>BrowserEngine.viewport_size</code> dimensions</li>\n</ol>\n<blockquote>\n<p><strong>Key Integration Insight</strong>: Integration tests often reveal <strong>cascade failures</strong> where errors in one pipeline stage propagate to create incorrect behavior in downstream stages. For example, HTML parsing errors might create DOM structures that confuse CSS selector matching, leading to incorrect style application and ultimately wrong visual output.</p>\n</blockquote>\n<p><strong>Integration Test Implementation Strategy:</strong></p>\n<p>The integration testing harness should provide both <strong>automated verification</strong> and <strong>manual inspection capabilities</strong>:</p>\n<table>\n<thead>\n<tr>\n<th>Test Type</th>\n<th>Automation Level</th>\n<th>Verification Method</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Structure Validation</td>\n<td>Fully Automated</td>\n<td>Compare DOM tree structure against expected patterns</td>\n</tr>\n<tr>\n<td>Style Resolution</td>\n<td>Fully Automated</td>\n<td>Verify computed styles match expected CSS cascade results</td>\n</tr>\n<tr>\n<td>Layout Geometry</td>\n<td>Fully Automated</td>\n<td>Check layout box dimensions against calculated expectations</td>\n</tr>\n<tr>\n<td>Visual Output</td>\n<td>Semi-Automated</td>\n<td>Generate reference images for manual comparison</td>\n</tr>\n<tr>\n<td>Error Boundaries</td>\n<td>Fully Automated</td>\n<td>Verify graceful degradation and error message quality</td>\n</tr>\n</tbody></table>\n<p><strong>Reference Test Document Set:</strong></p>\n<p>The integration test suite should include a curated set of reference documents that comprehensively exercise the browser engine:</p>\n<ol>\n<li><strong>Basic HTML Structure Test</strong>: A simple document with common HTML elements to verify fundamental parsing and rendering</li>\n<li><strong>CSS Cascade Resolution Test</strong>: Multiple competing CSS rules targeting the same elements to verify specificity and cascade algorithms  </li>\n<li><strong>Complex Layout Test</strong>: Nested block and inline elements with various sizing constraints to test layout engine robustness</li>\n<li><strong>Error Recovery Test</strong>: Deliberately malformed HTML and CSS to verify graceful degradation behavior</li>\n<li><strong>Performance Boundary Test</strong>: Large documents to verify resource management and performance characteristics</li>\n</ol>\n<p>Each reference document should include expected outputs at each pipeline stage:</p>\n<ul>\n<li>Expected DOM tree structure (serialized as JSON for comparison)</li>\n<li>Expected computed styles for key elements (property-value pairs)</li>\n<li>Expected layout box coordinates and dimensions (rectangle specifications)</li>\n<li>Expected visual appearance (reference images or detailed descriptions)</li>\n</ul>\n<h4 id=\"cross-component-error-propagation-testing\">Cross-Component Error Propagation Testing</h4>\n<p>Integration testing must specifically validate how errors propagate between pipeline components and verify that error recovery mechanisms work correctly across component boundaries:</p>\n<table>\n<thead>\n<tr>\n<th>Error Source</th>\n<th>Propagation Path</th>\n<th>Expected Recovery Behavior</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>HTML Parse Errors</td>\n<td>DOM → Style → Layout → Render</td>\n<td>Malformed elements should receive default styles and layout</td>\n</tr>\n<tr>\n<td>CSS Parse Errors</td>\n<td>Style → Layout → Render</td>\n<td>Invalid rules should be ignored without affecting valid rules</td>\n</tr>\n<tr>\n<td>Layout Constraint Failures</td>\n<td>Layout → Render</td>\n<td>Impossible constraints should resolve to specification defaults</td>\n</tr>\n<tr>\n<td>Rendering Resource Failures</td>\n<td>Render stage only</td>\n<td>Should fallback to simpler rendering techniques</td>\n</tr>\n</tbody></table>\n<p><strong>Error Propagation Test Cases:</strong></p>\n<ol>\n<li><strong>HTML syntax errors affecting CSS matching</strong>: Malformed HTML that creates unexpected DOM structures should not prevent CSS rules from applying to correctly formed elements</li>\n<li><strong>CSS parsing errors affecting layout</strong>: Invalid CSS declarations should not interfere with layout calculations for properties that parsed successfully</li>\n<li><strong>Layout constraint conflicts affecting rendering</strong>: Elements with impossible sizing constraints should still generate valid paint commands using fallback dimensions</li>\n<li><strong>Resource exhaustion during rendering</strong>: Memory or graphics failures during rendering should be contained and not corrupt earlier pipeline stage results</li>\n</ol>\n<blockquote>\n<p><strong>Critical Integration Principle</strong>: The browser engine should implement <strong>error boundary isolation</strong> — failures in one pipeline stage should not prevent successful processing of subsequent stages. Each stage should validate its inputs and apply appropriate fallbacks when receiving corrupted data from earlier stages.</p>\n</blockquote>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<h4 id=\"technology-recommendations\">Technology Recommendations</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Test Framework</td>\n<td><code>cargo test</code> with built-in assert macros</td>\n<td><code>proptest</code> for property-based testing with generated inputs</td>\n</tr>\n<tr>\n<td>Visual Comparison</td>\n<td>Manual image inspection</td>\n<td>Automated pixel-diff comparison with reference images</td>\n</tr>\n<tr>\n<td>Performance Testing</td>\n<td>Simple timing measurements</td>\n<td><code>criterion</code> crate for statistical benchmarking</td>\n</tr>\n<tr>\n<td>Test Data Management</td>\n<td>Embedded test strings in source</td>\n<td>External HTML/CSS files with structured test directories</td>\n</tr>\n<tr>\n<td>Error Simulation</td>\n<td>Manual error injection</td>\n<td><code>fault-injection</code> crate for systematic failure testing</td>\n</tr>\n</tbody></table>\n<h4 id=\"recommended-file-structure\">Recommended File Structure</h4>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>browser-engine/\n├── src/\n│   ├── html/\n│   │   ├── parser.rs\n│   │   └── parser_tests.rs       ← Unit tests for HTML parser\n│   ├── css/  \n│   │   ├── parser.rs\n│   │   └── parser_tests.rs       ← Unit tests for CSS parser\n│   ├── layout/\n│   │   ├── engine.rs\n│   │   └── engine_tests.rs       ← Unit tests for layout engine\n│   ├── render/\n│   │   ├── engine.rs\n│   │   └── engine_tests.rs       ← Unit tests for rendering engine\n│   └── lib.rs\n├── tests/\n│   ├── integration/\n│   │   ├── basic_rendering.rs    ← End-to-end pipeline tests\n│   │   ├── error_recovery.rs     ← Cross-component error handling\n│   │   └── performance.rs        ← Resource usage and scaling tests\n│   └── test_data/\n│       ├── html/\n│       │   ├── basic.html\n│       │   ├── malformed.html\n│       │   └── complex.html\n│       ├── css/\n│       │   ├── simple.css\n│       │   ├── cascade.css  \n│       │   └── invalid.css\n│       └── expected/\n│           ├── dom_trees/        ← JSON serialized expected DOM structures\n│           ├── computed_styles/  ← Expected style resolution results\n│           ├── layout_boxes/     ← Expected layout coordinates\n│           └── visual_output/    ← Reference images for visual comparison\n└── Cargo.toml</code></pre></div>\n\n<h4 id=\"test-infrastructure-starter-code\">Test Infrastructure Starter Code</h4>\n<p><strong>Complete Test Utilities Module:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// tests/test_utils.rs - Complete testing infrastructure</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">collections</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">HashMap</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> browser_engine</span><span style=\"color:#F97583\">::*</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Test harness for validating complete rendering pipeline</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> RenderingTestHarness</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    engine</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    test_data_path</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> RenderingTestHarness</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(viewport_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, viewport_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            engine</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> BrowserEngine</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(viewport_width, viewport_height),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            test_data_path</span><span style=\"color:#F97583\">:</span><span style=\"color:#9ECBFF\"> \"tests/test_data\"</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Load test HTML file and return content</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> load_test_html</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, filename</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">, std</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">io</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">fs</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">read_to_string</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"{}/html/{}\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">test_data_path, filename))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Load test CSS file and return content  </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> load_test_css</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, filename</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">, std</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">io</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">fs</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">read_to_string</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">format!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"{}/css/{}\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">test_data_path, filename))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Validate DOM tree structure against expected JSON</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> validate_dom_structure</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, dom</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">, expected_file</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Serialize DOM to JSON and compare with expected file</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        true</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Validate computed styles against expected values</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> validate_computed_styles</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, styles</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">, expected</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Compare computed style properties with expected values</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        true</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Generate visual output and optionally compare with reference</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> validate_visual_output</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, display_list</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DisplayList</span><span style=\"color:#E1E4E8\">, reference_file</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">>) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">u8</span><span style=\"color:#E1E4E8\">>, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Render display list to canvas and optionally compare with reference image</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">vec!</span><span style=\"color:#E1E4E8\">[])</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Utility functions for creating test data</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> TestDataBuilder</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    html_content</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    css_content</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> TestDataBuilder</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            html_content</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            css_content</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> with_html</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, html</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">html_content </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> html</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> with_css</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, css</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">css_content </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> css</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> build</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        (</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">html_content, </span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">css_content)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"core-testing-skeleton-code\">Core Testing Skeleton Code</h4>\n<p><strong>HTML Parser Milestone Validation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/html/parser_tests.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#79B8FF\"> super</span><span style=\"color:#F97583\">::*</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">test_utils</span><span style=\"color:#F97583\">::*</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Validates HTML tokenization against acceptance criteria</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> test_tokenization_acceptance_criteria</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> html </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"&#x3C;div class='content'>Hello &#x3C;span>World&#x3C;/span>&#x3C;/div>\"</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> parser </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> HTMLParser</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Parse HTML into tokens and verify token types</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expected: StartTag(div), Text(Hello ), StartTag(span), Text(World), EndTag(span), EndTag(div)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Validate attribute parsing for class='content'</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expected: attributes HashMap should contain \"class\" -> \"content\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Verify text content preservation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expected: Text tokens should preserve whitespace and content exactly</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Validates DOM tree construction with proper parent-child relationships  </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> test_dom_tree_construction</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> html </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"&#x3C;div>&#x3C;p>Paragraph 1&#x3C;/p>&#x3C;p>Paragraph 2&#x3C;/p>&#x3C;/div>\"</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Parse HTML into DOM tree</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> dom_result </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> HTMLParser</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#E1E4E8\">(html);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Validate tree structure - div should have 2 paragraph children</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Use get_children() to verify child count and get_parent() to verify relationships</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Verify text content is correctly associated with paragraph elements</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Each paragraph should have exactly one text child node</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Test bidirectional consistency - every child's parent should reference correct ancestor</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Validates self-closing and void element handling</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[test] </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> test_void_element_handling</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> html </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"&#x3C;div>&#x3C;br>&#x3C;img src='test.png'>&#x3C;input type='text'>&#x3C;/div>\"</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Parse HTML with void elements that lack closing tags</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Verify void elements don't wait for closing tags</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // br, img, and input should be complete after start tag</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Validate is_void flag is set correctly in ElementData</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Ensure DOM structure treats void elements as self-contained nodes</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Validates error recovery with malformed HTML</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> test_error_recovery_acceptance</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> malformed_html </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"&#x3C;div>&#x3C;p>Unclosed paragraph&#x3C;div>Improperly nested&#x3C;/div>\"</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Parse malformed HTML and capture parse errors</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> (dom, errors) </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> HTMLParser</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">parse_with_errors</span><span style=\"color:#E1E4E8\">(malformed_html);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Verify DOM tree is still usable despite errors</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Should auto-close unclosed elements and fix improper nesting</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Validate error recovery strategies produced reasonable tree structure</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Check that foster parenting moved misplaced elements correctly</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Ensure error count is recorded but parsing continues</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>CSS Parser Milestone Validation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/css/parser_tests.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#79B8FF\"> super</span><span style=\"color:#F97583\">::*</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Validates CSS selector parsing across all selector types</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> test_selector_parsing_acceptance</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> css </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> r#\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        div { color: red; }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        .content { margin: 10px; }  </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        #header { background: blue; }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        input[type=\"text\"] { border: 1px solid gray; }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        div > p { font-size: 14px; }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"#</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Parse CSS into rules and extract selectors</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> stylesheet </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> CSSParser</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">parse_stylesheet</span><span style=\"color:#E1E4E8\">(css)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Verify tag selector parsing - div should create Type selector</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Verify class selector parsing - .content should create Class selector  </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Verify ID selector parsing - #header should create ID selector</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Verify attribute selector parsing - input[type=\"text\"] creates Attribute selector</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Verify combinator parsing - div > p creates Child combinator selector</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Validates specificity calculation against CSS specification</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> test_specificity_calculation</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> test_cases </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> vec!</span><span style=\"color:#E1E4E8\">[</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        (</span><span style=\"color:#9ECBFF\">\"div\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Specificity</span><span style=\"color:#E1E4E8\"> { inline</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, ids</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, classes</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, elements</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\"> }),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        (</span><span style=\"color:#9ECBFF\">\".content\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Specificity</span><span style=\"color:#E1E4E8\"> { inline</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, ids</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, classes</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\">, elements</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> }),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        (</span><span style=\"color:#9ECBFF\">\"#header\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Specificity</span><span style=\"color:#E1E4E8\"> { inline</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, ids</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\">, classes</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, elements</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> }),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        (</span><span style=\"color:#9ECBFF\">\"div.content\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Specificity</span><span style=\"color:#E1E4E8\"> { inline</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, ids</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, classes</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\">, elements</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\"> }),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        (</span><span style=\"color:#9ECBFF\">\"#main .content div\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Specificity</span><span style=\"color:#E1E4E8\"> { inline</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, ids</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\">, classes</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\">, elements</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\"> }),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ];</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> (selector_text, expected) </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> test_cases {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Parse selector string into Selector enum</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Calculate specificity using calculate_specificity()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Compare calculated specificity with expected values</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // All four components (inline, ids, classes, elements) must match exactly</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Validates cascade algorithm applies rules in correct order</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> test_cascade_resolution</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> css </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> r#\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        div { color: red; font-size: 16px; }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        .content { color: blue; margin: 10px; }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        #specific { color: green; }  </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"#</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> html </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> r#\"&#x3C;div id=\"specific\" class=\"content\">Test&#x3C;/div>\"#</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Parse both HTML and CSS  </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Apply cascade algorithm to resolve final styles for the div element</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Verify color resolves to green (ID selector wins over class and tag)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Verify font-size comes from tag selector (no higher-specificity override)  </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Verify margin comes from class selector (higher specificity than tag)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Layout Engine Milestone Validation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/layout/engine_tests.rs  </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#79B8FF\"> super</span><span style=\"color:#F97583\">::*</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Validates box model calculation accuracy</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> test_box_model_calculation</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> style </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> ComputedStyle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        width</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Px</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">100.0</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        height</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Unit</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Px</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">50.0</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        margin</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> BoxOffsets</span><span style=\"color:#E1E4E8\"> { top</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 10.0</span><span style=\"color:#E1E4E8\">, right</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 20.0</span><span style=\"color:#E1E4E8\">, bottom</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 10.0</span><span style=\"color:#E1E4E8\">, left</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 20.0</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        padding</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> BoxOffsets</span><span style=\"color:#E1E4E8\"> { top</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 5.0</span><span style=\"color:#E1E4E8\">, right</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 10.0</span><span style=\"color:#E1E4E8\">, bottom</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 5.0</span><span style=\"color:#E1E4E8\">, left</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 10.0</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        border</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> BoxOffsets</span><span style=\"color:#E1E4E8\"> { top</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 2.0</span><span style=\"color:#E1E4E8\">, right</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 3.0</span><span style=\"color:#E1E4E8\">, bottom</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 2.0</span><span style=\"color:#E1E4E8\">, left</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 3.0</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // ... other properties</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> layout_box </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> LayoutBox</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">BoxType</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">BlockContainer</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    layout_box</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">computed_style </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> style;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Calculate box model dimensions using calculate_box_model()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    layout_box</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">calculate_box_model</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Size</span><span style=\"color:#E1E4E8\"> { width</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 200.0</span><span style=\"color:#E1E4E8\">, height</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 300.0</span><span style=\"color:#E1E4E8\"> });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Verify content rectangle dimensions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Should be exactly 100x50 as specified in computed style</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Verify padding rectangle includes content + padding</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Width: 100 + 10 + 10 = 120, Height: 50 + 5 + 5 = 60</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Verify border rectangle includes padding + border  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Width: 120 + 3 + 3 = 126, Height: 60 + 2 + 2 = 64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Verify margin rectangle includes border + margin</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Width: 126 + 20 + 20 = 166, Height: 64 + 10 + 10 = 84</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Validate rectangle containment - outer rectangles must contain inner rectangles</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Validates block formatting context behavior</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> test_block_formatting_context</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> html </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"&#x3C;div>&#x3C;p>First paragraph&#x3C;/p>&#x3C;p>Second paragraph&#x3C;/p>&#x3C;div>Third block&#x3C;/div>&#x3C;/div>\"</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> css </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"p { height: 30px; margin: 10px; } div { height: 40px; }\"</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Parse HTML and CSS, compute styles, create layout tree</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Run layout calculation on container with available width 300px</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Verify children stack vertically</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // First paragraph y-position should be 0 (plus margin)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Second paragraph should be positioned below first (accounting for margins)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Third div should be positioned below second paragraph</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Verify margin collapsing between paragraphs</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Adjacent 10px margins should collapse to single 10px gap, not 20px</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Validate total container height encompasses all children plus margins</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Validates inline formatting context with line breaking</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> test_inline_formatting_context</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> html </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"&#x3C;p>This is a long line of text that should wrap to multiple lines when the container width is too narrow to fit all content on one line&#x3C;/p>\"</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> css </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"p { width: 100px; font-size: 12px; }\"</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> text_measurer </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> SimpleTextMeasurer</span><span style=\"color:#E1E4E8\"> { char_width</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 8.0</span><span style=\"color:#E1E4E8\">, line_height</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> 16.0</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Parse and style content, create layout tree</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Run inline layout with narrow container width</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Verify text content breaks across multiple LineBox instances</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // With 100px width and ~8px per character, should break around 12 characters per line</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Validate line box positions stack vertically within container</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Verify text positioning respects baseline alignment within each line</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Rendering Engine Milestone Validation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// src/render/engine_tests.rs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#79B8FF\"> super</span><span style=\"color:#F97583\">::*</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Validates paint command generation sequence and content</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[test]  </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> test_paint_command_generation</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Create layout tree with background, border, and text content</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> layout_tree </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> create_test_layout_tree</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Generate display list from layout tree</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> display_list </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> generate_display_list</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">layout_tree)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Verify paint commands are in correct z-order</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Background rectangles should come before borders, borders before text</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Validate DrawRectangle commands use correct coordinates</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Should match border_rect or content_rect from corresponding LayoutBox</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Verify DrawText commands position text at correct baseline coordinates</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Confirm color values match ComputedStyle specifications exactly</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/// Validates complete rendering pipeline produces visual output</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fn</span><span style=\"color:#B392F0\"> test_end_to_end_rendering</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> html </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"&#x3C;div style='background-color: red; width: 100px; height: 50px;'>Hello World&#x3C;/div>\"</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> css </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"div { color: white; font-size: 16px; }\"</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Execute complete render_page() pipeline</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> canvas_data </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> render_page</span><span style=\"color:#E1E4E8\">(html, css)</span><span style=\"color:#F97583\">?</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Verify canvas data is non-empty and has expected dimensions</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Sample pixel data to verify red background color is present</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Verify white text pixels are rendered over red background</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Validate output format is compatible with image display/saving</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"milestone-checkpoint-validation\">Milestone Checkpoint Validation</h4>\n<p><strong>Milestone 1 Checkpoint (HTML Parser):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Run HTML parser unit tests</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> html_parser</span><span style=\"color:#79B8FF\"> --features</span><span style=\"color:#9ECBFF\"> test-utils</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected output: All tokenization and tree construction tests pass</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Parse basic.html should produce valid DOM tree</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Parse malformed.html should recover gracefully with warnings</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Void elements should not wait for closing tags</span></span></code></pre></div>\n\n<p><strong>Milestone 2 Checkpoint (CSS Parser):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Run CSS parser unit tests  </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> css_parser</span><span style=\"color:#79B8FF\"> --features</span><span style=\"color:#9ECBFF\"> test-utils</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected output: All selector, specificity, and cascade tests pass</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Parse simple.css should extract all rules correctly</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Parse cascade.css should resolve conflicts by specificity</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Parse invalid.css should skip malformed rules without breaking valid ones</span></span></code></pre></div>\n\n<p><strong>Milestone 3 Checkpoint (Layout Engine):</strong>  </p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Run layout engine unit tests</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> layout_engine</span><span style=\"color:#79B8FF\"> --features</span><span style=\"color:#9ECBFF\"> test-utils</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected output: All box model and formatting context tests pass</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Layout calculations should produce mathematically consistent rectangles  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Block formatting should stack elements vertically with proper spacing</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Inline formatting should wrap text at container boundaries</span></span></code></pre></div>\n\n<p><strong>Milestone 4 Checkpoint (Rendering Engine):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Run rendering engine unit tests</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> render_engine</span><span style=\"color:#79B8FF\"> --features</span><span style=\"color:#9ECBFF\"> test-utils</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected output: All paint generation and output tests pass</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Display lists should contain commands in correct z-order  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Canvas output should be non-empty with expected pixel dimensions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Visual output should match CSS specifications for colors and positioning</span></span></code></pre></div>\n\n<p><strong>Integration Testing Checkpoint:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Run complete pipeline integration tests</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> integration</span><span style=\"color:#79B8FF\"> --features</span><span style=\"color:#9ECBFF\"> test-utils</span><span style=\"color:#E1E4E8\">  </span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected output: End-to-end rendering completes successfully</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Complex documents should render without crashing</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Error recovery should maintain usable output despite malformed input  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Performance tests should complete within reasonable time/memory bounds</span></span></code></pre></div>\n\n\n<h2 id=\"debugging-guide-and-common-issues\">Debugging Guide and Common Issues</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> All milestones (1-4) - This section provides systematic debugging approaches and diagnostic techniques that are essential throughout the entire browser engine implementation.</p>\n</blockquote>\n<p>Building a browser engine involves multiple complex systems working together in a <strong>rendering pipeline</strong>, where failures in one stage can manifest as seemingly unrelated problems downstream. Think of debugging a browser engine like diagnosing a multi-stage <strong>factory assembly line</strong> where raw materials (HTML/CSS text) are transformed through various stations (parsing, styling, layout, rendering) into finished products (visual output). When the final product is defective, the problem could have originated at any stage, and symptoms often appear far from their root causes.</p>\n<p>This debugging guide provides a systematic approach to isolating and resolving issues across all four milestones. The key insight is that browser engine bugs typically fall into three categories: <strong>parse-time errors</strong> where malformed input creates incorrect data structures, <strong>computation-time errors</strong> where algorithms produce wrong results from correct inputs, and <strong>render-time errors</strong> where correct layout data fails to produce visual output. Each category requires different diagnostic techniques and has characteristic symptom patterns.</p>\n<p>The debugging methodology follows a <strong>symptom-first approach</strong>: we identify observable behaviors (incorrect DOM structure, wrong element positions, missing visual elements), trace them back through the pipeline to find root causes, and provide specific fixes. This approach mirrors how experienced browser engineers debug complex rendering issues in production systems.</p>\n<h3 id=\"htmlcss-parsing-issues\">HTML/CSS Parsing Issues</h3>\n<p>Parse-time failures occur when the tokenization and tree construction algorithms encounter malformed input or implement the parsing specifications incorrectly. These issues manifest as incorrect DOM trees or CSS rule structures that cause downstream problems in layout and rendering. The challenge is distinguishing between malformed input that should be recovered from gracefully versus implementation bugs in the parsing logic itself.</p>\n<p><strong>Mental Model: The Document Scanner</strong>\nThink of HTML/CSS parsing like a <strong>document scanner with optical character recognition (OCR)</strong>. The scanner reads characters sequentially and must recognize patterns (tags, selectors, properties) while handling damaged or unclear input. Just as OCR systems have confidence thresholds and error correction, parsers must implement recovery strategies when the input doesn&#39;t match expected patterns. The debugging process involves examining both the &quot;raw scan data&quot; (tokens) and the &quot;interpreted text&quot; (DOM/CSS structures) to identify where recognition failed.</p>\n<h4 id=\"html-tokenization-debugging\">HTML Tokenization Debugging</h4>\n<p>HTML tokenization problems typically occur in the state machine transitions where the <code>HTMLTokenizer</code> incorrectly identifies token boundaries or types. These issues are particularly common with edge cases like nested quotes, malformed attributes, or unexpected character sequences.</p>\n<table>\n<thead>\n<tr>\n<th><strong>Symptom</strong></th>\n<th><strong>Likely Cause</strong></th>\n<th><strong>Diagnostic Technique</strong></th>\n<th><strong>Fix Strategy</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Missing text content between elements</td>\n<td>Tokenizer incorrectly categorizing text as markup</td>\n<td>Add logging to <code>next_token()</code> showing state transitions and character consumption</td>\n<td>Check state transitions in <code>TokenizerState::Data</code> - ensure non-<code>&lt;</code> characters stay in data state</td>\n</tr>\n<tr>\n<td>Attributes parsed as separate elements</td>\n<td>Incorrect handling of whitespace in <code>TokenizerState::BeforeAttributeName</code></td>\n<td>Log attribute parsing sequence showing quote handling and boundary detection</td>\n<td>Implement proper whitespace skipping and quote matching in attribute value parsing</td>\n</tr>\n<tr>\n<td>Self-closing tags treated as container elements</td>\n<td><code>VOID_ELEMENTS</code> list incomplete or <code>is_void</code> flag not checked</td>\n<td>Verify element against <code>VOID_ELEMENTS</code> constant and log <code>is_void</code> determination</td>\n<td>Ensure all HTML5 void elements are in the constant list and check during tree construction</td>\n</tr>\n<tr>\n<td>Text content includes raw HTML tags</td>\n<td>Failure to transition from data state to tag parsing</td>\n<td>Instrument state machine to show when <code>&lt;</code> character triggers state change</td>\n<td>Fix <code>TokenizerState::Data</code> to properly detect tag start and transition to <code>TokenizerState::TagOpen</code></td>\n</tr>\n<tr>\n<td>Malformed attributes cause parser crash</td>\n<td>Exception handling missing in attribute parsing</td>\n<td>Wrap attribute parsing in <code>Result</code> types and log parsing attempts</td>\n<td>Implement graceful degradation - skip malformed attributes but continue processing element</td>\n</tr>\n</tbody></table>\n<p>The most effective debugging technique for tokenization is <strong>state machine instrumentation</strong>. Add logging that shows the current state, input character, and resulting state transition for every character processed. This reveals exactly where the state machine diverges from expected behavior.</p>\n<blockquote>\n<p><strong>Key Insight</strong>: Most tokenization bugs occur at state boundaries, particularly when handling unexpected characters in specific states. The HTML specification defines these transitions precisely, so any deviation indicates an implementation bug rather than ambiguous input.</p>\n</blockquote>\n<h4 id=\"dom-tree-construction-debugging\">DOM Tree Construction Debugging</h4>\n<p>Tree construction errors occur when the <code>TreeBuilder</code> processes tokens correctly but builds an incorrect hierarchical structure. These problems often involve the <strong>open elements stack</strong> management, improper parent-child relationships, or failure to implement <strong>foster parenting</strong> for misplaced content.</p>\n<table>\n<thead>\n<tr>\n<th><strong>Symptom</strong></th>\n<th><strong>Likely Cause</strong></th>\n<th><strong>Diagnostic Technique</strong></th>\n<th><strong>Fix Strategy</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Elements appear as siblings instead of parent-child</td>\n<td><code>open_elements</code> stack not properly maintained during <code>process_token()</code></td>\n<td>Log stack contents before/after each token and verify nesting depth matches HTML structure</td>\n<td>Check <code>insert_element()</code> pushes to stack and <code>close_element()</code> properly pops matching elements</td>\n</tr>\n<tr>\n<td>Missing closing tags cause incorrect nesting</td>\n<td><code>close_element()</code> not handling implicit tag closure or mismatched tags</td>\n<td>Trace element closure sequence and verify auto-closing logic for block elements</td>\n<td>Implement <code>close_all_open_elements()</code> for implicit closure and handle mismatched end tags gracefully</td>\n</tr>\n<tr>\n<td>Text nodes attached to wrong parents</td>\n<td>Foster parenting not implemented for table-related misplaced content</td>\n<td>Check if text content appears inside table elements without proper cell containers</td>\n<td>Implement <code>foster_parent_element()</code> to move misplaced content to appropriate ancestors</td>\n</tr>\n<tr>\n<td>Duplicate elements in final tree</td>\n<td>Same DOM node reference added multiple times during tree construction</td>\n<td>Verify <code>DOMNodeHandle</code> uniqueness and parent-child reference integrity</td>\n<td>Ensure <code>append_child()</code> checks for existing parent before adding and updates references atomically</td>\n</tr>\n<tr>\n<td>Crash on deeply nested elements</td>\n<td>Stack overflow in recursive tree traversal or unbounded <code>open_elements</code> growth</td>\n<td>Monitor <code>open_elements</code> length and tree depth during parsing</td>\n<td>Add maximum nesting depth limits and iterative traversal algorithms</td>\n</tr>\n</tbody></table>\n<p>Tree construction debugging requires <strong>hierarchical visualization</strong>. Create a diagnostic function that prints the DOM tree structure with indentation showing parent-child relationships, and compare this output against the expected HTML structure.</p>\n<p>⚠️ <strong>Pitfall: Reference Ownership Confusion</strong>\nA common mistake is mixing owned references and borrowed references when building the DOM tree, leading to use-after-free errors or memory leaks. The <code>DOMNodeHandle</code> type must consistently represent either owned or borrowed references throughout tree construction. Fix this by establishing clear ownership rules: the <code>TreeBuilder</code> owns all nodes until construction completes, then transfers ownership to the final document root.</p>\n<h4 id=\"css-tokenization-and-rule-parsing\">CSS Tokenization and Rule Parsing</h4>\n<p>CSS parsing failures typically occur in the tokenization phase where complex CSS syntax like nested selectors, media queries, or shorthand properties aren&#39;t handled correctly. Unlike HTML, CSS parsing must handle more diverse token types and complex grammar rules.</p>\n<table>\n<thead>\n<tr>\n<th><strong>Symptom</strong></th>\n<th><strong>Likely Cause</strong></th>\n<th><strong>Diagnostic Technique</strong></th>\n<th><strong>Fix Strategy</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>CSS rules completely ignored</td>\n<td>Tokenizer not recognizing selector syntax or rule boundaries</td>\n<td>Log <code>CSSToken</code> sequence and verify delimiter tokens (braces, semicolons) are identified</td>\n<td>Check <code>CSSTokenizer</code> handles all delimiter types and <code>parse_rule()</code> finds rule boundaries correctly</td>\n</tr>\n<tr>\n<td>Property values parsed incorrectly</td>\n<td><code>parse_value()</code> not handling unit types or color formats</td>\n<td>Trace value parsing showing input string, detected type, and final <code>CSSValue</code></td>\n<td>Implement robust value parsing for all <code>Unit</code> variants and <code>Color</code> formats including hex</td>\n</tr>\n<tr>\n<td>Selector specificity calculated wrong</td>\n<td><code>calculate_specificity()</code> not counting selector components correctly</td>\n<td>Log specificity calculation showing individual counts for ids, classes, elements</td>\n<td>Verify <code>Specificity</code> calculation matches CSS specification: (inline, ids, classes+attributes, elements)</td>\n</tr>\n<tr>\n<td>Multiple CSS rules create conflicting styles</td>\n<td>Cascade resolution not ordering rules by specificity and source order</td>\n<td>Display rule matching sequence for specific elements showing specificity comparison</td>\n<td>Implement proper <code>compare()</code> method for <code>Specificity</code> and ensure <code>source_order</code> breaks ties</td>\n</tr>\n<tr>\n<td>CSS parsing stops at first error</td>\n<td>Error recovery not implemented - parser fails on single malformed rule</td>\n<td>Test parsing behavior with intentionally malformed CSS mixed with valid rules</td>\n<td>Implement <code>skip_to_recovery_point()</code> to find next valid rule start and continue parsing</td>\n</tr>\n</tbody></table>\n<p>CSS debugging benefits from <strong>rule tracing</strong>: for any DOM element, log all CSS rules that match, their specificity calculations, and the final computed style after cascade resolution. This reveals where unexpected style conflicts occur.</p>\n<blockquote>\n<p><strong>Architecture Decision: CSS Error Recovery Strategy</strong></p>\n<ul>\n<li><strong>Context</strong>: CSS parsing can encounter malformed syntax that doesn&#39;t match the grammar, but the CSS specification requires parsers to recover gracefully rather than failing completely</li>\n<li><strong>Options Considered</strong>: <ol>\n<li>Fail-fast: Stop parsing on first error</li>\n<li>Rule-level recovery: Skip malformed rules, continue with next rule</li>\n<li>Property-level recovery: Skip malformed properties, continue with rest of rule</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Implement rule-level recovery with property-level fallback</li>\n<li><strong>Rationale</strong>: CSS is designed to be fault-tolerant - browsers should render pages even with some invalid CSS. Rule-level recovery handles most common errors (typos, unsupported properties) while property-level recovery handles more complex syntax errors within rules.</li>\n<li><strong>Consequences</strong>: Parsing is more robust but requires careful implementation of recovery points and error context tracking</li>\n</ul>\n</blockquote>\n<h4 id=\"entity-decoding-and-character-handling\">Entity Decoding and Character Handling</h4>\n<p>Character-level parsing issues involve HTML entities, Unicode handling, and special character sequences. These problems often manifest as incorrect text content or parsing failures when encountering non-ASCII characters.</p>\n<table>\n<thead>\n<tr>\n<th><strong>Symptom</strong></th>\n<th><strong>Likely Cause</strong></th>\n<th><strong>Diagnostic Technique</strong></th>\n<th><strong>Fix Strategy</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>HTML entities appear as literal text</td>\n<td>Entity decoder not implemented or <code>HTML_ENTITIES</code> table incomplete</td>\n<td>Search for entity patterns in parsed text content and verify entity recognition</td>\n<td>Implement entity decoder using <code>HTML_ENTITIES</code> lookup table and handle numeric entities</td>\n</tr>\n<tr>\n<td>Non-ASCII characters cause parsing errors</td>\n<td>Character encoding assumptions or Unicode handling issues</td>\n<td>Log character codes and encoding detection for problematic input</td>\n<td>Ensure parser handles UTF-8 encoding and validates character sequences</td>\n</tr>\n<tr>\n<td>Quote characters in attributes break parsing</td>\n<td>Quote escaping not handled in attribute value parsing</td>\n<td>Test with mixed single/double quotes and escaped quote sequences</td>\n<td>Implement proper quote matching and escape sequence handling in attribute parsing</td>\n</tr>\n<tr>\n<td>Whitespace handling inconsistent</td>\n<td>Normalization rules not applied consistently across text content</td>\n<td>Compare whitespace preservation in different parsing contexts</td>\n<td>Apply HTML5 whitespace normalization rules: collapse consecutive whitespace, trim leading/trailing</td>\n</tr>\n</tbody></table>\n<h3 id=\"layout-calculation-problems\">Layout Calculation Problems</h3>\n<p>Layout issues occur when the <strong>box model</strong> calculations, <strong>formatting context</strong> algorithms, or <strong>constraint resolution</strong> produce incorrect element positions and sizes. These problems are particularly challenging because they often result from the complex interactions between multiple CSS properties and the inheritance hierarchy.</p>\n<p><strong>Mental Model: The Blueprint Architect</strong>\nThink of layout calculation like an <strong>architect creating construction blueprints</strong> from a building design. The architect must translate design specifications (CSS properties) into precise measurements and positions (layout coordinates) while respecting physical constraints (available space, structural requirements). When buildings don&#39;t match the original design, the problem could be measurement errors, constraint violations, or misunderstanding the design specifications. Layout debugging follows the same pattern: verify measurements, check constraints, and validate algorithmic understanding.</p>\n<h4 id=\"box-model-calculation-issues\">Box Model Calculation Issues</h4>\n<p>Box model problems involve incorrect computation of the margin, border, padding, and content rectangles that define each element&#39;s spatial extent. These calculations must handle complex interactions between explicit dimensions, <code>auto</code> values, percentage units, and <strong>available space</strong> constraints.</p>\n<table>\n<thead>\n<tr>\n<th><strong>Symptom</strong></th>\n<th><strong>Likely Cause</strong></th>\n<th><strong>Diagnostic Technique</strong></th>\n<th><strong>Fix Strategy</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Elements larger or smaller than expected</td>\n<td>Box model rectangles not accounting for all margin/border/padding</td>\n<td>Log complete box model calculation showing content, padding, border, margin rectangles</td>\n<td>Verify <code>calculate_box_model()</code> computes all four rectangles and <code>LayoutBox</code> stores them correctly</td>\n</tr>\n<tr>\n<td>Percentage widths calculated incorrectly</td>\n<td>Containing block width not passed correctly to percentage resolution</td>\n<td>Trace percentage calculation showing parent width, percentage value, and computed result</td>\n<td>Ensure containing block size passed to <code>calculate_box_model()</code> and percentage conversion handles edge cases</td>\n</tr>\n<tr>\n<td>Auto margins not centering elements</td>\n<td>Auto margin resolution algorithm not implemented or incorrect</td>\n<td>Log margin resolution showing available space, content width, and computed margin values</td>\n<td>Implement CSS auto margin centering: <code>(available_width - content_width) / 2</code> for left and right margins</td>\n</tr>\n<tr>\n<td>Elements overflow their containers</td>\n<td>Max-width/min-width constraints not enforced or over-constraint resolution wrong</td>\n<td>Check element dimensions against container size and trace constraint satisfaction</td>\n<td>Implement <code>resolve_over_constraint()</code> to handle impossible dimension combinations with CSS priority rules</td>\n</tr>\n<tr>\n<td>Margin collapsing not working</td>\n<td>Adjacent margin collapse algorithm missing or block context detection wrong</td>\n<td>Compare adjacent element margins before/after collapse and verify block formatting context</td>\n<td>Implement <code>calculate_margin_collapse()</code> for adjacent vertical margins in same block formatting context</td>\n</tr>\n</tbody></table>\n<p>Box model debugging requires <strong>dimensional visualization</strong>. Create diagnostic output that shows each element as nested rectangles representing margin (outermost), border, padding, and content (innermost) areas with their computed dimensions and positions.</p>\n<p>⚠️ <strong>Pitfall: Percentage Circular Dependencies</strong>\nA common layout bug occurs when percentage dimensions create circular dependencies: a parent&#39;s size depends on its children, but children&#39;s percentage dimensions depend on the parent&#39;s size. This manifests as incorrect sizes or infinite loops in layout calculation. The fix requires implementing a multi-pass layout algorithm that resolves explicit dimensions first, then uses those to resolve percentage dimensions in dependent elements.</p>\n<h4 id=\"block-layout-and-vertical-positioning\">Block Layout and Vertical Positioning</h4>\n<p>Block formatting context issues involve incorrect vertical positioning of child elements, improper margin collapsing behavior, or failure to handle <strong>available space</strong> constraints correctly. Block layout is the foundation of most web page layouts, so errors here affect almost all elements.</p>\n<table>\n<thead>\n<tr>\n<th><strong>Symptom</strong></th>\n<th><strong>Likely Cause</strong></th>\n<th><strong>Diagnostic Technique</strong></th>\n<th><strong>Fix Strategy</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Child elements positioned incorrectly vertically</td>\n<td><code>layout_block_children()</code> not accumulating y-positions or handling margin collapsing</td>\n<td>Log y-position calculation for each child showing previous sibling position, margins, and final position</td>\n<td>Verify block layout algorithm maintains running y-offset and applies margin collapsing between siblings</td>\n</tr>\n<tr>\n<td>Elements overlap vertically</td>\n<td>Margin collapsing calculated incorrectly or negative margins not handled</td>\n<td>Visual diff showing expected vs actual element positions and margin calculations</td>\n<td>Implement proper margin collapsing rules: adjacent positive/negative margins collapse, non-adjacent don&#39;t collapse</td>\n</tr>\n<tr>\n<td>Container height incorrect</td>\n<td>Block container not expanding to contain all child elements or intrinsic height wrong</td>\n<td>Compare container height to sum of child heights plus margins</td>\n<td>Ensure block container height includes all child content plus collapsed margins</td>\n</tr>\n<tr>\n<td>Float elements disrupt normal flow</td>\n<td>Float positioning not implemented or clearance calculations wrong</td>\n<td>Check if float elements are removed from normal document flow and positioned correctly</td>\n<td>Implement float positioning as separate phase after normal flow layout</td>\n</tr>\n<tr>\n<td>Text baseline alignment wrong</td>\n<td>Line height calculation or text metrics incorrect</td>\n<td>Log text positioning showing baseline, ascent, descent, and line height values</td>\n<td>Verify <code>TextMetrics</code> calculation and baseline alignment in <code>LineBox</code> construction</td>\n</tr>\n</tbody></table>\n<p>Block layout debugging benefits from <strong>flow visualization</strong>: create output showing the document flow with each element&#39;s position in the coordinate system and the available space passed to child elements.</p>\n<h4 id=\"inline-layout-and-text-flow\">Inline Layout and Text Flow</h4>\n<p>Inline formatting context problems involve incorrect horizontal text flow, line breaking failures, or improper baseline alignment of inline elements. Inline layout is more complex than block layout because it must handle variable-width content and dynamic line wrapping.</p>\n<table>\n<thead>\n<tr>\n<th><strong>Symptom</strong></th>\n<th><strong>Likely Cause</strong></th>\n<th><strong>Diagnostic Technique</strong></th>\n<th><strong>Fix Strategy</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Text doesn&#39;t wrap at container boundaries</td>\n<td>Line breaking algorithm not implemented or <code>find_line_break_opportunity()</code> incorrect</td>\n<td>Log line breaking decisions showing available width, text width, and break points</td>\n<td>Implement proper line breaking at word boundaries with fallback to character breaking</td>\n</tr>\n<tr>\n<td>Inline elements positioned incorrectly</td>\n<td>Baseline alignment wrong or <code>LineBox</code> construction flawed</td>\n<td>Trace inline layout showing baseline calculation, element metrics, and final positions</td>\n<td>Verify <code>LineBox</code> baseline calculation and <code>InlineElement</code> positioning relative to baseline</td>\n</tr>\n<tr>\n<td>Text overlaps or has incorrect spacing</td>\n<td>Character width measurement wrong or font metrics unavailable</td>\n<td>Log <code>TextMetrics</code> for sample text and verify character advance width calculation</td>\n<td>Implement proper text measurement using <code>SimpleTextMeasurer</code> or platform font metrics</td>\n</tr>\n<tr>\n<td>Mixed inline content alignment wrong</td>\n<td>Block elements inside inline context not handled or line height calculation wrong</td>\n<td>Check mixed content handling and verify line height encompasses all inline elements</td>\n<td>Implement proper line height calculation as max of all inline element heights plus leading</td>\n</tr>\n<tr>\n<td>Long words break layout</td>\n<td>No fallback to character-level breaking when word-level breaking fails</td>\n<td>Test with very long words that exceed container width</td>\n<td>Add character-level breaking fallback when no word boundaries available within line width</td>\n</tr>\n</tbody></table>\n<p>Inline layout debugging requires <strong>line-by-line analysis</strong>: show how text and inline elements are distributed across lines, with measurements for each element&#39;s contribution to line width and height.</p>\n<blockquote>\n<p><strong>Key Insight</strong>: Inline layout bugs often stem from incorrect font metrics or text measurement. Unlike block layout where dimensions are computed from CSS properties, inline layout depends heavily on actual text rendering measurements that vary by font, size, and platform.</p>\n</blockquote>\n<h4 id=\"constraint-resolution-and-edge-cases\">Constraint Resolution and Edge Cases</h4>\n<p>Complex layout scenarios involve multiple interacting constraints that can create impossible or ambiguous situations. The CSS specification defines resolution algorithms for these <strong>over-constraint</strong> cases, but implementation bugs are common due to the complexity of constraint prioritization.</p>\n<table>\n<thead>\n<tr>\n<th><strong>Symptom</strong></th>\n<th><strong>Likely Cause</strong></th>\n<th><strong>Diagnostic Technique</strong></th>\n<th><strong>Fix Strategy</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Elements ignore width/height constraints</td>\n<td>Min/max width constraints not implemented or constraint priorities wrong</td>\n<td>Log constraint resolution showing all width-related properties and final computed value</td>\n<td>Implement CSS constraint resolution: min-width overrides width, max-width overrides min-width</td>\n</tr>\n<tr>\n<td>Absolutely positioned elements wrong</td>\n<td>Absolute positioning not removing elements from normal flow or position calculation incorrect</td>\n<td>Trace absolute positioning showing offset values, containing block, and final coordinates</td>\n<td>Implement absolute positioning with proper containing block identification and offset calculation</td>\n</tr>\n<tr>\n<td>Flexbox or grid layout broken</td>\n<td>Complex layout modes not implemented or interaction with normal flow incorrect</td>\n<td>Compare expected vs actual layout for flex/grid containers and their children</td>\n<td>Focus on block/inline layout first - advanced layout modes are beyond basic browser scope</td>\n</tr>\n<tr>\n<td>Performance degradation with large documents</td>\n<td>Layout algorithm has poor time complexity or redundant calculations</td>\n<td>Profile layout calculation time and identify bottlenecks in layout tree traversal</td>\n<td>Optimize layout algorithm to avoid redundant calculations and use incremental layout updates</td>\n</tr>\n<tr>\n<td>Memory usage grows unboundedly</td>\n<td>Layout tree retains references to old layouts or intermediate calculations not cleaned up</td>\n<td>Monitor memory usage during layout and identify retained references</td>\n<td>Implement proper cleanup of intermediate layout state and reuse layout boxes where possible</td>\n</tr>\n</tbody></table>\n<h3 id=\"rendering-and-visual-issues\">Rendering and Visual Issues</h3>\n<p>Rendering problems occur when the <strong>display list</strong> generation or <strong>graphics backend</strong> integration fails to produce correct visual output. These issues are often the most visible to end users but can be caused by problems anywhere in the pipeline, making diagnosis challenging.</p>\n<p><strong>Mental Model: The Art Gallery Curator</strong>\nThink of rendering like a <strong>museum curator organizing an art exhibition</strong>. The curator must arrange artworks (layout boxes) in the gallery space (viewport) according to a planned layout, ensuring proper lighting (colors), appropriate positioning (coordinates), and correct viewing order (z-index). When visitors see problems with the exhibition - missing pieces, wrong positions, poor lighting - the curator must trace back through the planning process to find where the arrangement went wrong. Rendering debugging follows this same systematic approach from visual symptoms back to root causes.</p>\n<h4 id=\"paint-command-generation-issues\">Paint Command Generation Issues</h4>\n<p>Display list generation problems occur when the traversal of the <code>LayoutTree</code> fails to generate correct <code>PaintCommand</code> sequences or when the paint order doesn&#39;t match the expected visual stacking order. These issues manifest as missing visual elements, incorrect colors, or wrong z-ordering.</p>\n<table>\n<thead>\n<tr>\n<th><strong>Symptom</strong></th>\n<th><strong>Likely Cause</strong></th>\n<th><strong>Diagnostic Technique</strong></th>\n<th><strong>Fix Strategy</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Elements completely missing from rendered output</td>\n<td><code>generate_display_list()</code> not traversing entire layout tree or skipping certain box types</td>\n<td>Log display list generation showing which layout boxes generate paint commands</td>\n<td>Verify layout tree traversal visits all nodes and generates commands for visible <code>BoxType</code> variants</td>\n</tr>\n<tr>\n<td>Background colors not appearing</td>\n<td><code>DrawRectangle</code> commands not generated for background or color values incorrect</td>\n<td>Examine display list for background paint commands and verify <code>Color</code> values</td>\n<td>Generate <code>DrawRectangle</code> commands for all elements with non-transparent background colors</td>\n</tr>\n<tr>\n<td>Element borders missing or wrong</td>\n<td><code>DrawBorder</code> commands not generated or border width/color calculation wrong</td>\n<td>Check border paint command generation and verify border properties from <code>ComputedStyle</code></td>\n<td>Generate <code>DrawBorder</code> commands for all four border sides with correct width, color, and position</td>\n</tr>\n<tr>\n<td>Text content invisible</td>\n<td><code>DrawText</code> commands missing or text positioning incorrect</td>\n<td>Trace text rendering showing font selection, positioning, and color</td>\n<td>Generate <code>DrawText</code> commands for all text nodes with proper baseline positioning and font metrics</td>\n</tr>\n<tr>\n<td>Elements appear in wrong stacking order</td>\n<td>Paint command order incorrect or z-index not implemented</td>\n<td>Compare expected vs actual paint order in display list</td>\n<td>Implement proper paint order: backgrounds first, borders second, content last, respecting z-index</td>\n</tr>\n</tbody></table>\n<p>Paint command debugging requires <strong>command sequence analysis</strong>: examine the generated <code>DisplayList</code> and verify that paint commands appear in the correct order and with the expected parameters.</p>\n<p>⚠️ <strong>Pitfall: Coordinate System Confusion</strong>\nA common rendering bug involves mixing different coordinate systems - layout coordinates (relative to document), viewport coordinates (relative to visible area), and graphics coordinates (relative to canvas). This manifests as elements appearing in completely wrong positions. The fix requires establishing consistent coordinate transformation throughout the rendering pipeline and documenting which coordinate system each component expects.</p>\n<h4 id=\"graphics-backend-integration-problems\">Graphics Backend Integration Problems</h4>\n<p>Graphics backend issues involve the interface between the browser engine&#39;s paint commands and the underlying graphics system (Canvas, OpenGL, DirectX, etc.). These problems often appear as visual corruption, performance issues, or rendering failures under specific conditions.</p>\n<table>\n<thead>\n<tr>\n<th><strong>Symptom</strong></th>\n<th><strong>Likely Cause</strong></th>\n<th><strong>Diagnostic Technique</strong></th>\n<th><strong>Fix Strategy</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Rendering produces blank or corrupted output</td>\n<td>Graphics context not initialized properly or command translation incorrect</td>\n<td>Test graphics backend directly with simple commands to isolate browser vs graphics issues</td>\n<td>Implement <code>render_with_fallback()</code> with progressive degradation to software rendering</td>\n</tr>\n<tr>\n<td>Text rendering fails or shows wrong fonts</td>\n<td>Font loading failure or font fallback chain not implemented</td>\n<td>Test text rendering with different fonts and log font loading success/failure</td>\n<td>Implement <code>handle_font_failure()</code> with system font fallback and basic text measurement</td>\n</tr>\n<tr>\n<td>Colors appear wrong or corrupted</td>\n<td>Color space conversion errors or graphics backend color format mismatch</td>\n<td>Test color rendering with known values and compare expected vs actual output</td>\n<td>Ensure <code>Color</code> values are converted correctly to graphics backend format (RGB vs RGBA, color space)</td>\n</tr>\n<tr>\n<td>Performance degrades with complex layouts</td>\n<td>Graphics operations not batched or excessive draw calls</td>\n<td>Profile rendering performance and identify bottlenecks in graphics operations</td>\n<td>Implement command batching for similar operations and viewport culling for off-screen elements</td>\n</tr>\n<tr>\n<td>Memory leaks during rendering</td>\n<td>Graphics resources not cleaned up or command buffers growing unboundedly</td>\n<td>Monitor memory usage during extended rendering and identify resource leaks</td>\n<td>Implement proper resource cleanup and display list reuse for similar content</td>\n</tr>\n</tbody></table>\n<p>Graphics debugging often requires <strong>external validation</strong>: render the same content with a reference implementation or graphics debugger to verify that the problem is in the browser engine rather than the underlying graphics system.</p>\n<h4 id=\"visual-debugging-and-diagnostic-tools\">Visual Debugging and Diagnostic Tools</h4>\n<p>Visual debugging involves creating diagnostic visualizations that reveal the internal state of the rendering pipeline. These tools are essential for understanding complex rendering problems that aren&#39;t apparent from code inspection alone.</p>\n<table>\n<thead>\n<tr>\n<th><strong>Debug Visualization</strong></th>\n<th><strong>Purpose</strong></th>\n<th><strong>Implementation</strong></th>\n<th><strong>Usage</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Layout box outlines</td>\n<td>Show computed box model rectangles for each element</td>\n<td>Add debug paint commands that draw colored outlines for margin, border, padding, content</td>\n<td>Identify box model calculation errors and positioning problems</td>\n</tr>\n<tr>\n<td>Text baseline guides</td>\n<td>Show line boxes and baseline alignment for text content</td>\n<td>Draw horizontal lines at baseline positions and text metrics boundaries</td>\n<td>Debug text positioning and line height calculations</td>\n</tr>\n<tr>\n<td>Paint command sequence</td>\n<td>Show order and parameters of all paint commands in display list</td>\n<td>Log or visualize paint command sequence with element identification</td>\n<td>Debug paint order problems and missing visual elements</td>\n</tr>\n<tr>\n<td>Coordinate system grid</td>\n<td>Show document coordinate system and viewport boundaries</td>\n<td>Draw grid lines at regular intervals with coordinate labels</td>\n<td>Debug coordinate transformation and positioning calculations</td>\n</tr>\n<tr>\n<td>Style cascade visualization</td>\n<td>Show which CSS rules apply to specific elements and their precedence</td>\n<td>Create detailed style reports showing matched rules, specificity, and computed values</td>\n<td>Debug CSS cascade and specificity calculation problems</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>Architecture Decision: Rendering Fallback Strategy</strong></p>\n<ul>\n<li><strong>Context</strong>: Graphics operations can fail due to driver issues, memory pressure, or hardware limitations, but the browser should continue functioning rather than crashing</li>\n<li><strong>Options Considered</strong>:<ol>\n<li>Fail-hard: Crash or stop rendering when graphics operations fail</li>\n<li>Silent failure: Skip failed operations and continue with partial rendering</li>\n<li>Progressive fallback: Degrade to simpler rendering techniques when advanced operations fail</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Implement progressive fallback with multiple fallback levels</li>\n<li><strong>Rationale</strong>: Browser engines must be extremely robust - users expect web pages to render even on limited hardware or with driver problems. Progressive fallback allows graceful degradation while maintaining core functionality.</li>\n<li><strong>Consequences</strong>: Requires implementing multiple rendering backends and fallback detection, but provides much better user experience under adverse conditions</li>\n</ul>\n</blockquote>\n<h4 id=\"clipping-and-viewport-management\">Clipping and Viewport Management</h4>\n<p>Clipping and viewport issues involve incorrect handling of element visibility, coordinate transformations between document and viewport space, and optimization of off-screen content. These problems affect both correctness and performance.</p>\n<table>\n<thead>\n<tr>\n<th><strong>Symptom</strong></th>\n<th><strong>Likely Cause</strong></th>\n<th><strong>Diagnostic Technique</strong></th>\n<th><strong>Fix Strategy</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Elements render outside their containers</td>\n<td>Clipping not implemented or clipping boundaries incorrect</td>\n<td>Verify clipping rectangle calculation and <code>SetClip</code>/<code>ClearClip</code> command generation</td>\n<td>Implement proper clipping context management with nested clipping support</td>\n</tr>\n<tr>\n<td>Off-screen elements still rendered</td>\n<td>Viewport culling not implemented or visibility detection wrong</td>\n<td>Log which elements are considered visible and compare with actual viewport bounds</td>\n<td>Implement viewport intersection testing and skip paint command generation for invisible elements</td>\n</tr>\n<tr>\n<td>Scrolling broken or coordinates wrong</td>\n<td>Coordinate transformation between document and viewport incorrect</td>\n<td>Test coordinate conversion at various scroll positions and zoom levels</td>\n<td>Implement proper coordinate transformation accounting for viewport offset</td>\n</tr>\n<tr>\n<td>Performance poor with large documents</td>\n<td>No optimization for off-screen content or excessive overdraw</td>\n<td>Profile rendering with large documents and measure draw call efficiency</td>\n<td>Implement viewport culling and overdraw elimination to skip invisible content</td>\n</tr>\n<tr>\n<td>Nested clipping wrong</td>\n<td>Clipping context stack not maintained properly or intersection calculation incorrect</td>\n<td>Test nested elements with overflow hidden and verify clipping behavior</td>\n<td>Maintain clipping context stack and properly intersect nested clipping rectangles</td>\n</tr>\n</tbody></table>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>This debugging system requires systematic diagnostic infrastructure throughout the browser engine. The key is building observability into each pipeline stage so that problems can be traced from symptoms back to root causes.</p>\n<h4 id=\"technology-recommendations\">Technology Recommendations</h4>\n<table>\n<thead>\n<tr>\n<th><strong>Component</strong></th>\n<th><strong>Simple Option</strong></th>\n<th><strong>Advanced Option</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Logging Infrastructure</td>\n<td><code>println!</code> macros with debug levels</td>\n<td><code>env_logger</code> with structured logging</td>\n</tr>\n<tr>\n<td>DOM Tree Visualization</td>\n<td>Text-based tree printing with indentation</td>\n<td>HTML output with interactive tree explorer</td>\n</tr>\n<tr>\n<td>Layout Box Debugging</td>\n<td>Console output of box model calculations</td>\n<td>Visual overlay showing box boundaries</td>\n</tr>\n<tr>\n<td>Paint Command Analysis</td>\n<td>Text-based command listing</td>\n<td>Graphical display list viewer</td>\n</tr>\n<tr>\n<td>Performance Profiling</td>\n<td>Basic timing with <code>std::time::Instant</code></td>\n<td><code>perf</code> integration with flame graphs</td>\n</tr>\n</tbody></table>\n<h4 id=\"recommended-file-structure\">Recommended File Structure</h4>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>src/\n  debug/\n    mod.rs                    ← debug infrastructure exports\n    tree_visualizer.rs        ← DOM and layout tree printing\n    paint_debugger.rs         ← display list analysis tools\n    style_tracer.rs           ← CSS cascade debugging\n    layout_inspector.rs       ← box model visualization\n    error_reporter.rs         ← centralized error reporting\n  parser/\n    html_parser.rs           ← add parse debugging here\n    css_parser.rs            ← add tokenization logging here  \n  layout/\n    layout_engine.rs         ← add box model debugging here\n  rendering/\n    render_engine.rs         ← add paint command logging here\n  lib.rs                     ← conditional debug feature compilation</code></pre></div>\n\n<h4 id=\"error-reporting-infrastructure\">Error Reporting Infrastructure</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Centralized error reporting with context preservation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> DebugContext</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    component</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    operation</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    input_sample</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    stack_trace</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> DebugContext</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">(component</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, operation</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        DebugContext</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            component</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> component</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            operation</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> operation</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            input_sample</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            stack_trace</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> with_input</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, input</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">input_sample </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> input</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">chars</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">take</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">)</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">collect</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> add_stack_frame</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, frame</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">stack_trace</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">push</span><span style=\"color:#E1E4E8\">(frame</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">());</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> report_parse_error</span><span style=\"color:#E1E4E8\">(error</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">ParseError</span><span style=\"color:#E1E4E8\">, context</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DebugContext</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    eprintln!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"PARSE ERROR in {}/{}: {:?}\"</span><span style=\"color:#E1E4E8\">, context</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">component, context</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">operation, error);</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    eprintln!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Input sample: '{}'\"</span><span style=\"color:#E1E4E8\">, context</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">input_sample);</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    eprintln!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Call stack: {}\"</span><span style=\"color:#E1E4E8\">, context</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">stack_trace</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">join</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\" -> \"</span><span style=\"color:#E1E4E8\">));</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO: Add specific diagnostic hints based on error type</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO: Log to structured error database for pattern analysis</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"htmlcss-parse-debugging-tools\">HTML/CSS Parse Debugging Tools</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// HTML tokenization diagnostics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> TokenizerDebugger</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log_state_transitions</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log_token_generation</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    current_input_position</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> TokenizerDebugger</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> log_state_transition</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, from_state</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> TokenizerState</span><span style=\"color:#E1E4E8\">, to_state</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> TokenizerState</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                               input_char</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> char</span><span style=\"color:#E1E4E8\">, position</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">log_state_transitions {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Tokenizer @{}: '{}' ({:?} -> {:?})\"</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    position, input_char, from_state, to_state);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> log_token_generated</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, token</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">HTMLToken</span><span style=\"color:#E1E4E8\">, position</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">log_token_generation {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Token @{}: {:?}\"</span><span style=\"color:#E1E4E8\">, position, token);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO: Add method to dump tokenizer state for debugging crashes</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO: Add method to validate token sequence correctness</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO: Add method to compare tokens against reference implementation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// DOM tree structure visualization  </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> print_dom_tree</span><span style=\"color:#E1E4E8\">(node</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DOMNode</span><span style=\"color:#E1E4E8\">, indent</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    let</span><span style=\"color:#E1E4E8\"> indent_str </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"  \"</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">repeat</span><span style=\"color:#E1E4E8\">(indent);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    match</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">node</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">node_data {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        DOMNodeData</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Element</span><span style=\"color:#E1E4E8\">(element) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"{}Element: {} (attributes: {:?})\"</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    indent_str, element</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">tag_name, element</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">attributes);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        DOMNodeData</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Text</span><span style=\"color:#E1E4E8\">(text) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"{}Text: '{}'\"</span><span style=\"color:#E1E4E8\">, indent_str, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    text</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">content</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">chars</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">take</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">50</span><span style=\"color:#E1E4E8\">)</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">collect</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>());</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        DOMNodeData</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Document</span><span style=\"color:#E1E4E8\">(_) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"{}Document\"</span><span style=\"color:#E1E4E8\">, indent_str);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> child </span><span style=\"color:#F97583\">in</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">node</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">children {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Get child node from handle and recurse</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Add cycle detection to prevent infinite loops</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Add maximum depth limit for very large trees</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"layout-debugging-infrastructure\">Layout Debugging Infrastructure</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Box model visualization and validation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> LayoutDebugger</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    show_box_outlines</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log_calculations</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    validate_constraints</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> LayoutDebugger</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> log_box_calculation</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, element</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, computed_style</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                              containing_block</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">, result</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">log_calculations {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Layout {}: CB({:.1}x{:.1}) -> Content({:.1}x{:.1})\"</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    element, containing_block</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width, containing_block</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">content_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width, result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">content_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height);</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"  Margin: {:.1}/{:.1}/{:.1}/{:.1}\"</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">margin_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">-</span><span style=\"color:#E1E4E8\"> result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">border_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">border_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">border_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width </span><span style=\"color:#F97583\">-</span><span style=\"color:#E1E4E8\"> result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">margin_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">-</span><span style=\"color:#E1E4E8\"> result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">margin_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">margin_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">margin_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height </span><span style=\"color:#F97583\">-</span><span style=\"color:#E1E4E8\"> result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">border_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">y </span><span style=\"color:#F97583\">-</span><span style=\"color:#E1E4E8\"> result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">border_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">border_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x </span><span style=\"color:#F97583\">-</span><span style=\"color:#E1E4E8\"> result</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">margin_rect</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">origin</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">x);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> validate_box_model</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, layout_box</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> errors </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Validate that content_rect is inside padding_rect</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Validate that padding_rect is inside border_rect  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Validate that border_rect is inside margin_rect</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Check for negative dimensions or positions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Verify box dimensions match computed style expectations</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        errors</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Generate paint commands for debugging overlays</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> generate_debug_overlay</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, layout_box</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">PaintCommand</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> commands </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">show_box_outlines {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // TODO: Add DrawRectangle command for margin outline (red)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // TODO: Add DrawRectangle command for border outline (blue)  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // TODO: Add DrawRectangle command for padding outline (green)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // TODO: Add DrawRectangle command for content outline (yellow)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        commands</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"rendering-pipeline-diagnostics\">Rendering Pipeline Diagnostics</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Display list analysis and validation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> RenderDebugger</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log_paint_commands</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    validate_coordinates</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    measure_performance</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> RenderDebugger</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> analyze_display_list</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, display_list</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">DisplayList</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> RenderingReport</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#F97583\"> mut</span><span style=\"color:#E1E4E8\"> report </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> RenderingReport</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        for</span><span style=\"color:#E1E4E8\"> (i, command) </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> display_list</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">commands</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">iter</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">enumerate</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">log_paint_commands {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Paint[{}]: {:?}\"</span><span style=\"color:#E1E4E8\">, i, command);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">validate_coordinates {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                match</span><span style=\"color:#E1E4E8\"> command {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                    PaintCommand</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">DrawRectangle</span><span style=\"color:#E1E4E8\"> { rect, </span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\"> } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                        // TODO: Check if rectangle is within viewport bounds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                        // TODO: Validate that coordinates are not NaN or infinite</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                        // TODO: Warn about rectangles with zero or negative dimensions</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    }</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                    PaintCommand</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">DrawText</span><span style=\"color:#E1E4E8\"> { position, </span><span style=\"color:#F97583\">..</span><span style=\"color:#E1E4E8\"> } </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                        // TODO: Check if text position is within reasonable bounds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                        // TODO: Validate text baseline positioning</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    _ </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        report</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO: Method to compare display list against reference implementation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO: Method to measure rendering performance and identify bottlenecks</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO: Method to detect common paint order problems</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> RenderingReport</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    command_count</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    coordinate_warnings</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    performance_metrics</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Option</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">RenderingMetrics</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> RenderingMetrics</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    paint_command_generation_time</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">time</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    graphics_backend_time</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">time</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    total_rendering_time</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">time</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"milestone-validation-checkpoints\">Milestone Validation Checkpoints</h4>\n<p><strong>Milestone 1 Checkpoint (HTML Parser):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> html_parser_tests</span></span></code></pre></div>\n<p>Expected output: All tokenization and tree construction tests pass. Run with malformed HTML samples and verify graceful error recovery. Check DOM tree structure matches expected hierarchy.</p>\n<p><strong>Milestone 2 Checkpoint (CSS Parser):</strong>  </p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> css_parser_tests</span></span></code></pre></div>\n<p>Expected output: CSS rule parsing and specificity calculation tests pass. Test with malformed CSS and verify error recovery. Check computed styles match expected cascade resolution.</p>\n<p><strong>Milestone 3 Checkpoint (Layout):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> layout_engine_tests</span></span></code></pre></div>\n<p>Expected output: Box model and positioning tests pass. Test with percentage dimensions and margin collapsing cases. Verify layout tree coordinates are correct.</p>\n<p><strong>Milestone 4 Checkpoint (Rendering):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> render_engine_tests</span></span></code></pre></div>\n<p>Expected output: Display list generation and rendering tests pass. Visual output should match reference images. Test with different viewport sizes and element combinations.</p>\n<p>Signs of problems and debugging steps:</p>\n<ul>\n<li><strong>Parse tests failing</strong>: Enable tokenizer debugging, check state transitions</li>\n<li><strong>Layout coordinates wrong</strong>: Enable box model logging, verify containing block calculations  </li>\n<li><strong>Visual output incorrect</strong>: Examine display list, check paint command generation</li>\n<li><strong>Performance issues</strong>: Profile with timing measurements, identify bottlenecks</li>\n</ul>\n<h2 id=\"future-extensions-and-advanced-features\">Future Extensions and Advanced Features</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> All milestones (1-4) - This section provides a roadmap for extending the browser engine beyond the core implementation, building upon the foundational HTML parsing, CSS parsing, layout computation, and rendering systems established in the previous milestones.</p>\n</blockquote>\n<p>Building a functional browser engine through the four core milestones represents just the beginning of the journey into modern web rendering technology. Think of our current implementation as a sturdy foundation house - it provides the essential structure and functionality needed for basic habitation, but there&#39;s enormous potential for expansion and enhancement. The real-world web demands sophisticated features like flexible layout systems, dynamic content updates, smooth animations, and high-performance rendering that can handle complex documents with thousands of elements.</p>\n<p>This section serves as an architectural roadmap for transforming our basic browser engine into a more capable system. We&#39;ll explore two critical dimensions of advancement: feature sophistication and performance optimization. Feature sophistication involves implementing advanced CSS layout modes like Flexbox and Grid, supporting CSS transforms and animations, and potentially integrating JavaScript execution. Performance optimization focuses on making our engine fast and scalable enough to handle real-world web content through techniques like incremental rendering, layout caching, and multi-threaded processing.</p>\n<p>The extensions outlined here follow a principle of <strong>progressive enhancement</strong> - each addition builds naturally upon our existing architecture without requiring fundamental rewrites. Our modular design with clear separation between parsing, styling, layout, and rendering stages provides natural extension points for new features. The key insight is that advanced features typically involve either extending our CSS property vocabulary and layout algorithms, or optimizing our data flow and computation strategies.</p>\n<h3 id=\"advanced-css-features\">Advanced CSS Features</h3>\n<p>Think of advanced CSS features as specialized tools in a master craftsperson&#39;s workshop. While our current implementation provides the basic tools - hammer, saw, screwdriver - advanced CSS features are like precision instruments that enable much more sophisticated and flexible creations. Just as a craftsperson gradually acquires specialized tools as their skills develop, our browser engine can incrementally support advanced CSS features that dramatically expand its layout and rendering capabilities.</p>\n<p>The modern web relies heavily on advanced CSS layout modes that go far beyond the simple block and inline formatting contexts we&#39;ve implemented. <strong>Flexbox</strong> enables flexible, responsive layouts where elements can grow, shrink, and align themselves intelligently within containers. <strong>CSS Grid</strong> provides two-dimensional layout control with precise positioning and responsive behavior. <strong>CSS transforms</strong> allow elements to be rotated, scaled, and positioned in 3D space without affecting document layout. <strong>CSS animations and transitions</strong> enable smooth visual changes over time, creating engaging user experiences.</p>\n<p>These advanced features share several common architectural patterns that make them natural extensions to our existing system. They typically involve extending our CSS parser to recognize new properties and values, enhancing our style resolution system to compute new types of computed styles, implementing specialized layout algorithms that operate alongside our existing block and inline formatters, and extending our rendering engine to handle new visual effects.</p>\n<h4 id=\"flexbox-layout-implementation\">Flexbox Layout Implementation</h4>\n<p><strong>Flexbox</strong> represents one of the most transformative layout modes in modern CSS. Unlike our current block layout that simply stacks elements vertically, Flexbox provides intelligent space distribution, flexible sizing, and powerful alignment capabilities along both main and cross axes.</p>\n<blockquote>\n<p><strong>Decision: Flexbox Integration Strategy</strong></p>\n<ul>\n<li><strong>Context</strong>: Flexbox requires fundamentally different layout logic than block/inline formatting, but should integrate seamlessly with our existing layout tree</li>\n<li><strong>Options Considered</strong>: <ul>\n<li>Separate flexbox-specific layout tree</li>\n<li>Extend existing <code>LayoutBox</code> with flexbox-specific fields</li>\n<li>Create specialized flexbox layout context within existing system</li>\n</ul>\n</li>\n<li><strong>Decision</strong>: Create specialized flexbox layout context within existing system</li>\n<li><strong>Rationale</strong>: Maintains architectural consistency, reuses existing infrastructure for style resolution and rendering, allows mixed layout modes in same document</li>\n<li><strong>Consequences</strong>: Requires extending <code>BoxType</code> enum and implementing new layout algorithms, but preserves existing APIs and data flow</li>\n</ul>\n</blockquote>\n<p>The flexbox implementation extends our existing layout system with new computed style properties and specialized layout algorithms. Our <code>ComputedStyle</code> struct needs enhancement to include flexbox-specific properties:</p>\n<table>\n<thead>\n<tr>\n<th>Property</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>flex_direction</td>\n<td>FlexDirection</td>\n<td>Main axis direction (row, column, row-reverse, column-reverse)</td>\n</tr>\n<tr>\n<td>flex_wrap</td>\n<td>FlexWrap</td>\n<td>Whether flex items wrap to new lines (nowrap, wrap, wrap-reverse)</td>\n</tr>\n<tr>\n<td>justify_content</td>\n<td>JustifyContent</td>\n<td>Alignment along main axis (flex-start, center, space-between, etc.)</td>\n</tr>\n<tr>\n<td>align_items</td>\n<td>AlignItems</td>\n<td>Alignment along cross axis (stretch, center, flex-start, etc.)</td>\n</tr>\n<tr>\n<td>flex_grow</td>\n<td>f32</td>\n<td>Growth factor for available space distribution</td>\n</tr>\n<tr>\n<td>flex_shrink</td>\n<td>f32</td>\n<td>Shrink factor when space is insufficient</td>\n</tr>\n<tr>\n<td>flex_basis</td>\n<td>ComputedLength</td>\n<td>Initial size before free space distribution</td>\n</tr>\n</tbody></table>\n<p>The flexbox layout algorithm operates in distinct phases that replace our simple vertical stacking approach. First, we collect all flex items and determine the main and cross axis dimensions based on <code>flex_direction</code>. Second, we resolve flex basis values and calculate total hypothetical main size. Third, we distribute available space among flex items based on their <code>flex_grow</code> and <code>flex_shrink</code> factors. Fourth, we align items along the cross axis according to <code>align_items</code> and individual <code>align_self</code> values. Fifth, we handle line wrapping if <code>flex_wrap</code> is enabled, potentially creating multiple flex lines. Finally, we position all items and update their final rectangles in the layout tree.</p>\n<table>\n<thead>\n<tr>\n<th>Algorithm Step</th>\n<th>Input</th>\n<th>Processing</th>\n<th>Output</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Flex Item Collection</td>\n<td>Layout box with <code>display: flex</code></td>\n<td>Identify immediate children as flex items</td>\n<td>List of flex items with initial sizes</td>\n</tr>\n<tr>\n<td>Main/Cross Axis Resolution</td>\n<td><code>flex_direction</code> property</td>\n<td>Determine which dimension is main vs cross</td>\n<td>Axis orientation and available space</td>\n</tr>\n<tr>\n<td>Flex Basis Resolution</td>\n<td><code>flex_basis</code>, <code>width</code>, <code>height</code> properties</td>\n<td>Calculate initial item sizes before space distribution</td>\n<td>Hypothetical main size for each item</td>\n</tr>\n<tr>\n<td>Space Distribution</td>\n<td>Available space, <code>flex_grow</code>, <code>flex_shrink</code></td>\n<td>Distribute extra space or absorb overflow</td>\n<td>Final main size for each flex item</td>\n</tr>\n<tr>\n<td>Cross Axis Alignment</td>\n<td><code>align_items</code>, <code>align_self</code>, container height</td>\n<td>Position items perpendicular to main axis</td>\n<td>Cross axis positions and sizes</td>\n</tr>\n<tr>\n<td>Line Wrapping</td>\n<td><code>flex_wrap</code>, total item sizes</td>\n<td>Create additional flex lines if needed</td>\n<td>Multiple flex lines with item assignments</td>\n</tr>\n</tbody></table>\n<p>A concrete walkthrough illustrates the flexbox algorithm complexity. Consider a flex container with 400px width containing three items: Item A (<code>flex: 1 0 100px</code>), Item B (<code>flex: 2 0 50px</code>), and Item C (<code>flex: 0 1 200px</code>). First, we calculate total flex basis: 100 + 50 + 200 = 350px, leaving 50px of free space. Second, we sum flex-grow factors: 1 + 2 + 0 = 3. Third, we distribute free space proportionally: Item A gets 50 * (1/3) = 16.67px, Item B gets 50 * (2/3) = 33.33px, Item C gets 0px. Final sizes become: Item A = 116.67px, Item B = 83.33px, Item C = 200px. This demonstrates how flexbox intelligently distributes available space based on item preferences.</p>\n<blockquote>\n<p>The critical insight with flexbox implementation is that it requires a fundamentally different mental model from block layout. Instead of positioning items sequentially, flexbox operates more like a constraint satisfaction system where available space is distributed according to item flexibility preferences and alignment constraints.</p>\n</blockquote>\n<h4 id=\"css-grid-layout-system\">CSS Grid Layout System</h4>\n<p><strong>CSS Grid</strong> provides the most sophisticated layout capabilities in modern CSS, enabling precise two-dimensional positioning with responsive behavior. Think of CSS Grid as an architect&#39;s blueprint system - instead of stacking blocks or flowing content like our current layout modes, Grid allows explicit placement of elements in a defined grid structure with named areas, flexible track sizing, and complex alignment options.</p>\n<p>Grid layout introduces several new concepts that extend our layout system architecture. <strong>Grid tracks</strong> define the rows and columns of the grid with flexible sizing options. <strong>Grid areas</strong> provide named regions for element placement. <strong>Grid lines</strong> create the boundary structure that defines track edges. <strong>Grid gaps</strong> add consistent spacing between tracks. These concepts require significant extensions to our data model and layout algorithms.</p>\n<p>The grid implementation requires new CSS property support and layout data structures:</p>\n<table>\n<thead>\n<tr>\n<th>Grid Property</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>grid_template_columns</td>\n<td>Vec<TrackSize></td>\n<td>Column track definitions with sizing functions</td>\n</tr>\n<tr>\n<td>grid_template_rows</td>\n<td>Vec<TrackSize></td>\n<td>Row track definitions with sizing functions</td>\n</tr>\n<tr>\n<td>grid_template_areas</td>\n<td>Vec&lt;Vec<String>&gt;</td>\n<td>Named grid areas as 2D string matrix</td>\n</tr>\n<tr>\n<td>grid_column_gap</td>\n<td>ComputedLength</td>\n<td>Spacing between column tracks</td>\n</tr>\n<tr>\n<td>grid_row_gap</td>\n<td>ComputedLength</td>\n<td>Spacing between row tracks</td>\n</tr>\n<tr>\n<td>grid_column</td>\n<td>GridPosition</td>\n<td>Item placement in column dimension</td>\n</tr>\n<tr>\n<td>grid_row</td>\n<td>GridPosition</td>\n<td>Item placement in row dimension</td>\n</tr>\n<tr>\n<td>grid_area</td>\n<td>String</td>\n<td>Named area for item placement</td>\n</tr>\n</tbody></table>\n<p>The Grid layout algorithm operates through several sophisticated phases. First, we parse grid track definitions and resolve sizing functions like <code>fr</code> units, <code>minmax()</code> constraints, and <code>repeat()</code> patterns. Second, we build the explicit grid structure from template definitions and identify any implicit tracks needed for item placement. Third, we place grid items either through explicit positioning properties or automatic placement algorithms. Fourth, we resolve track sizes through a complex constraint satisfaction process that handles minimum/maximum constraints, flexible <code>fr</code> units, and content-based sizing. Fifth, we calculate final positions and sizes for all grid items based on resolved track dimensions and gap spacing.</p>\n<table>\n<thead>\n<tr>\n<th>Grid Sizing Function</th>\n<th>Syntax</th>\n<th>Behavior</th>\n<th>Use Case</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Fixed Size</td>\n<td><code>100px</code>, <code>20em</code></td>\n<td>Absolute track size</td>\n<td>Headers, sidebars with known dimensions</td>\n</tr>\n<tr>\n<td>Fractional Unit</td>\n<td><code>1fr</code>, <code>2fr</code></td>\n<td>Proportional share of available space</td>\n<td>Flexible content areas</td>\n</tr>\n<tr>\n<td>Min-Max Constraint</td>\n<td><code>minmax(100px, 1fr)</code></td>\n<td>Bounded flexible sizing</td>\n<td>Responsive columns with minimum width</td>\n</tr>\n<tr>\n<td>Content-Based</td>\n<td><code>min-content</code>, <code>max-content</code></td>\n<td>Size based on item content</td>\n<td>Tables, flexible text content</td>\n</tr>\n<tr>\n<td>Fit-Content</td>\n<td><code>fit-content(200px)</code></td>\n<td>Content size clamped to maximum</td>\n<td>Responsive containers</td>\n</tr>\n</tbody></table>\n<p>Grid&#39;s <strong>track sizing algorithm</strong> represents one of the most complex layout calculations in CSS. The algorithm processes tracks in multiple passes, first resolving fixed sizes, then minimum constraints, then distributing flexible space among <code>fr</code> units while respecting <code>minmax()</code> bounds. This requires implementing a constraint satisfaction solver that can handle circular dependencies and optimization objectives.</p>\n<h4 id=\"css-transforms-and-3d-positioning\">CSS Transforms and 3D Positioning</h4>\n<p><strong>CSS transforms</strong> enable visual manipulation of elements without affecting document layout flow. Think of transforms as a camera lens system - elements maintain their original layout positions, but we apply visual filters that can rotate, scale, translate, and even position elements in 3D space. This separation between layout position and visual position is crucial for performance and animation capabilities.</p>\n<p>Transform implementation extends our rendering pipeline with new visual effects that operate after layout calculation. Our <code>ComputedStyle</code> needs transform-specific properties:</p>\n<table>\n<thead>\n<tr>\n<th>Transform Property</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>transform</td>\n<td>Vec<TransformFunction></td>\n<td>List of transform functions to apply</td>\n</tr>\n<tr>\n<td>transform_origin</td>\n<td>Point</td>\n<td>Point around which transforms are applied</td>\n</tr>\n<tr>\n<td>perspective</td>\n<td>Option<f32></td>\n<td>3D perspective distance for child elements</td>\n</tr>\n<tr>\n<td>transform_style</td>\n<td>TransformStyle</td>\n<td>Whether children participate in 3D context</td>\n</tr>\n</tbody></table>\n<p>Transform functions represent individual transformation operations that combine through matrix multiplication:</p>\n<table>\n<thead>\n<tr>\n<th>Transform Function</th>\n<th>Parameters</th>\n<th>Matrix Effect</th>\n<th>Visual Result</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>translate(x, y)</code></td>\n<td>x: Length, y: Length</td>\n<td>Translation matrix</td>\n<td>Element repositioning</td>\n</tr>\n<tr>\n<td><code>rotate(angle)</code></td>\n<td>angle: Angle</td>\n<td>Rotation matrix</td>\n<td>Element rotation around origin</td>\n</tr>\n<tr>\n<td><code>scale(x, y)</code></td>\n<td>x: f32, y: f32</td>\n<td>Scaling matrix</td>\n<td>Element size multiplication</td>\n</tr>\n<tr>\n<td><code>skew(x, y)</code></td>\n<td>x: Angle, y: Angle</td>\n<td>Skew matrix</td>\n<td>Element distortion</td>\n</tr>\n<tr>\n<td><code>matrix(a,b,c,d,e,f)</code></td>\n<td>6 matrix values</td>\n<td>Direct matrix</td>\n<td>Custom transformation</td>\n</tr>\n</tbody></table>\n<p>The transform rendering process involves matrix composition and coordinate space conversion. Each element with transforms creates a new coordinate space for its children. We compute the cumulative transformation matrix by multiplying all transform functions in order, then apply this matrix during paint command generation to convert element-local coordinates to screen coordinates. 3D transforms require additional complexity with z-coordinate handling and perspective projection calculations.</p>\n<blockquote>\n<p>A critical design insight for transforms is that they operate purely in the rendering stage without affecting layout. This separation enables smooth animations since transform changes don&#39;t trigger expensive layout recalculations - only the final rendering phase needs updates.</p>\n</blockquote>\n<h4 id=\"css-animations-and-transitions\">CSS Animations and Transitions</h4>\n<p><strong>CSS animations and transitions</strong> bring temporal dynamics to web content, enabling smooth visual changes over time. Think of animations as a film director&#39;s storyboard - we define keyframes that specify property values at different time points, and the browser interpolates smooth transitions between these values.</p>\n<p>Animation implementation requires extending our architecture with time-based systems and interpolation logic. We need new data structures to represent animation definitions and active animation state:</p>\n<table>\n<thead>\n<tr>\n<th>Animation Component</th>\n<th>Fields</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>KeyframeRule</td>\n<td>selector: String, keyframes: Vec<Keyframe></td>\n<td>CSS <code>@keyframes</code> rule definition</td>\n</tr>\n<tr>\n<td>Keyframe</td>\n<td>percentage: f32, declarations: Vec<Declaration></td>\n<td>Property values at specific time point</td>\n</tr>\n<tr>\n<td>Animation</td>\n<td>name: String, duration: f32, timing_function: TimingFunction</td>\n<td>Animation configuration</td>\n</tr>\n<tr>\n<td>ActiveAnimation</td>\n<td>start_time: f64, current_value: CSSValue, target_element: DOMNodeHandle</td>\n<td>Running animation state</td>\n</tr>\n</tbody></table>\n<p>The animation system operates through several coordinated processes. The CSS parser must recognize <code>@keyframes</code> rules and animation properties like <code>animation-name</code>, <code>animation-duration</code>, and <code>animation-timing-function</code>. The style resolution system matches animations to elements and creates <code>ActiveAnimation</code> instances. A separate animation scheduler tracks time progression and calculates current property values through interpolation. The layout and rendering systems use these animated values as if they were static computed styles.</p>\n<p>Keyframe interpolation requires type-specific logic for different CSS value types:</p>\n<table>\n<thead>\n<tr>\n<th>Value Type</th>\n<th>Interpolation Strategy</th>\n<th>Example</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Length</td>\n<td>Linear numeric interpolation</td>\n<td><code>0px</code> to <code>100px</code> over time</td>\n</tr>\n<tr>\n<td>Color</td>\n<td>RGB component interpolation</td>\n<td><code>red</code> to <code>blue</code> through purple</td>\n</tr>\n<tr>\n<td>Transform</td>\n<td>Matrix decomposition and interpolation</td>\n<td>Smooth rotation and scaling</td>\n</tr>\n<tr>\n<td>Visibility</td>\n<td>Discrete change at 50% progress</td>\n<td><code>visible</code> to <code>hidden</code> as step function</td>\n</tr>\n</tbody></table>\n<p>⚠️ <strong>Pitfall: Animation Performance</strong>\nA common mistake is recalculating layout for every animation frame, which creates performance bottlenecks. Properties like <code>transform</code> and <code>opacity</code> can be animated purely in the rendering stage without triggering layout recalculation. However, animating properties like <code>width</code>, <code>height</code>, or <code>margin</code> requires full layout recalculation for every frame, which can cause animations to appear janky or slow. The solution is to prefer transform-based animations (<code>transform: translateX()</code> instead of animating <code>left</code> property) and implement animation layer optimization that identifies layout-affecting vs. rendering-only property changes.</p>\n<h3 id=\"performance-and-scalability\">Performance and Scalability</h3>\n<p>Think of performance optimization as transforming our browser engine from a skilled artisan&#39;s workshop to a modern manufacturing facility. While our current implementation works well for simple documents, real-world web pages contain thousands of elements, complex styling, and dynamic content updates that demand efficient processing strategies. Performance optimization involves both algorithmic improvements that reduce computational complexity and architectural changes that enable parallel processing and resource management.</p>\n<p>Modern web performance demands span several dimensions. <strong>Rendering performance</strong> ensures smooth 60fps animation and interaction response times. <strong>Memory efficiency</strong> allows handling large documents without exhausting system resources. <strong>Incremental processing</strong> enables responsive user interfaces that don&#39;t freeze during expensive operations. <strong>Cache effectiveness</strong> reduces redundant computations across layout and rendering cycles. These optimizations often involve fundamental changes to our data structures and algorithms while preserving the same external interfaces.</p>\n<p>The key insight is that performance optimization usually involves trading memory for speed, or introducing complexity to reduce computational work. We&#39;ll explore several major optimization categories: incremental rendering systems that avoid redundant work, layout caching strategies that preserve computed results, and multi-threaded architectures that parallelize independent operations.</p>\n<h4 id=\"incremental-rendering-architecture\">Incremental Rendering Architecture</h4>\n<p><strong>Incremental rendering</strong> transforms our current &quot;parse everything, layout everything, render everything&quot; approach into a sophisticated system that identifies what actually changed and processes only the minimal necessary updates. Think of this as the difference between repainting an entire house versus touching up only the walls that got scuffed - the end result is identical, but the efficiency improvement is dramatic.</p>\n<p>The incremental rendering architecture requires introducing change tracking and invalidation systems throughout our rendering pipeline. Every data structure needs version tracking to identify when updates occur. Layout calculations need dependency analysis to determine which elements require recalculation when styles change. The rendering system needs damage tracking to identify screen regions that need repainting.</p>\n<blockquote>\n<p><strong>Decision: Incremental Update Strategy</strong></p>\n<ul>\n<li><strong>Context</strong>: Real web pages involve frequent DOM and style changes that shouldn&#39;t require complete re-rendering</li>\n<li><strong>Options Considered</strong>:<ul>\n<li>Complete re-rendering on every change (current approach)</li>\n<li>Fine-grained change tracking with targeted updates</li>\n<li>Hybrid approach with batched invalidation and update cycles</li>\n</ul>\n</li>\n<li><strong>Decision</strong>: Hybrid approach with batched invalidation and update cycles</li>\n<li><strong>Rationale</strong>: Balances implementation complexity with performance gains, matches browser main loop patterns, enables animation optimization</li>\n<li><strong>Consequences</strong>: Requires version tracking in all data structures, but enables responsive updates and smooth animations</li>\n</ul>\n</blockquote>\n<p>The incremental system introduces several new data structures for change tracking:</p>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Version Tracking</th>\n<th>Invalidation Strategy</th>\n<th>Update Scope</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>DOM Tree</td>\n<td>node_version: u64, subtree_version: u64</td>\n<td>Mark node and ancestors dirty on mutation</td>\n<td>Single node to document root</td>\n</tr>\n<tr>\n<td>Style System</td>\n<td>style_version: u64, cascade_version: u64</td>\n<td>Invalidate matching elements on stylesheet change</td>\n<td>Selector-matched elements</td>\n</tr>\n<tr>\n<td>Layout Tree</td>\n<td>layout_version: u64, geometry_version: u64</td>\n<td>Invalidate dependent elements on size change</td>\n<td>Containing block and children</td>\n</tr>\n<tr>\n<td>Render Tree</td>\n<td>paint_version: u64, visual_version: u64</td>\n<td>Mark visual regions dirty on appearance change</td>\n<td>Screen damage rectangles</td>\n</tr>\n</tbody></table>\n<p>The incremental update algorithm operates in carefully orchestrated phases to maintain consistency while minimizing work. First, we collect all pending changes (DOM mutations, style updates, layout constraint changes) and batch them into a single update cycle. Second, we propagate invalidation markers through dependency chains - style changes invalidate layout, layout changes invalidate rendering. Third, we process updates in dependency order: style resolution before layout, layout before rendering. Fourth, we compute minimal damage rectangles that need screen updates. Finally, we execute only the necessary rendering operations for changed regions.</p>\n<table>\n<thead>\n<tr>\n<th>Update Phase</th>\n<th>Input Changes</th>\n<th>Processing Strategy</th>\n<th>Output State</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Change Collection</td>\n<td>DOM/style/layout mutations</td>\n<td>Batch all changes since last update</td>\n<td>Change set with dependencies</td>\n</tr>\n<tr>\n<td>Invalidation Propagation</td>\n<td>Change set</td>\n<td>Mark affected elements dirty</td>\n<td>Invalidation flags throughout tree</td>\n</tr>\n<tr>\n<td>Style Resolution</td>\n<td>Dirty style flags</td>\n<td>Recompute styles only for marked elements</td>\n<td>Updated computed styles</td>\n</tr>\n<tr>\n<td>Layout Calculation</td>\n<td>Dirty layout flags</td>\n<td>Recalculate positions only for affected subtrees</td>\n<td>Updated layout tree</td>\n</tr>\n<tr>\n<td>Damage Calculation</td>\n<td>Layout changes</td>\n<td>Compute minimal screen regions needing updates</td>\n<td>Damage rectangle list</td>\n</tr>\n<tr>\n<td>Selective Rendering</td>\n<td>Damage rectangles</td>\n<td>Repaint only affected screen regions</td>\n<td>Updated display buffer</td>\n</tr>\n</tbody></table>\n<p>A concrete example demonstrates the incremental rendering benefits. Consider a web page with a sidebar and main content area. When the user hovers over a navigation link, only the link&#39;s background color changes. Instead of re-rendering the entire page, our incremental system: (1) detects the single element style change, (2) determines that layout is unaffected since only <code>background-color</code> changed, (3) computes the damage rectangle covering only the link&#39;s screen area, (4) repaints only that small region. This reduces rendering work from potentially thousands of elements to a single element update.</p>\n<h4 id=\"layout-caching-and-optimization\">Layout Caching and Optimization</h4>\n<p><strong>Layout caching</strong> addresses the expensive nature of box model calculations by preserving computed results and reusing them when inputs haven&#39;t changed. Think of layout caching as a memoization system for geometry calculations - we remember the results of expensive computations and return cached values when we encounter the same inputs again.</p>\n<p>Effective layout caching requires understanding the dependency relationships between layout calculations. An element&#39;s final position depends on its computed styles, its parent&#39;s layout, and potentially its siblings&#39; sizes (in cases like inline layout with line breaking). We can cache layout results at multiple granularities: individual box model calculations, complete subtree layouts, and even cross-document layout patterns.</p>\n<p>The caching architecture introduces cache-aware data structures and invalidation logic:</p>\n<table>\n<thead>\n<tr>\n<th>Cache Type</th>\n<th>Cache Key</th>\n<th>Cache Value</th>\n<th>Invalidation Trigger</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Box Model Cache</td>\n<td>computed_style_hash, containing_block_size</td>\n<td>LayoutBox dimensions</td>\n<td>Style or parent size change</td>\n</tr>\n<tr>\n<td>Subtree Layout Cache</td>\n<td>subtree_style_hash, available_space</td>\n<td>Complete subtree layout</td>\n<td>Any descendant style change</td>\n</tr>\n<tr>\n<td>Text Metrics Cache</td>\n<td>font_info, text_content</td>\n<td>TextMetrics</td>\n<td>Font or text change</td>\n</tr>\n<tr>\n<td>Line Breaking Cache</td>\n<td>text, available_width, font_info</td>\n<td>Line break positions</td>\n<td>Text, width, or font change</td>\n</tr>\n</tbody></table>\n<p>Layout cache implementation requires careful consideration of cache invalidation strategies. <strong>Conservative invalidation</strong> marks cache entries invalid whenever any dependency might have changed, ensuring correctness at the cost of cache hit rates. <strong>Precise invalidation</strong> tracks exact dependencies and only invalidates when specific inputs change, maximizing cache effectiveness but increasing complexity. <strong>Hybrid invalidation</strong> uses conservative strategies for complex dependencies and precise strategies for simple cases.</p>\n<table>\n<thead>\n<tr>\n<th>Caching Strategy</th>\n<th>Hit Rate</th>\n<th>Correctness Risk</th>\n<th>Implementation Complexity</th>\n<th>Best Use Case</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>No Caching</td>\n<td>0%</td>\n<td>None</td>\n<td>Low</td>\n<td>Simple documents, prototyping</td>\n</tr>\n<tr>\n<td>Conservative</td>\n<td>60-70%</td>\n<td>None</td>\n<td>Medium</td>\n<td>General purpose, safety-first</td>\n</tr>\n<tr>\n<td>Precise</td>\n<td>85-95%</td>\n<td>Medium</td>\n<td>High</td>\n<td>Performance-critical applications</td>\n</tr>\n<tr>\n<td>Hybrid</td>\n<td>75-85%</td>\n<td>Low</td>\n<td>Medium-High</td>\n<td>Production browser engines</td>\n</tr>\n</tbody></table>\n<p>Advanced layout optimizations involve recognizing common patterns and applying specialized algorithms. <strong>Constraint caching</strong> remembers the results of complex box model constraint resolution for common size combinations. <strong>Layout tree structural sharing</strong> reuses unchanged subtrees between layout cycles. <strong>Incremental line layout</strong> updates only the lines affected by text changes rather than reflowing entire text blocks.</p>\n<blockquote>\n<p>The key insight for layout caching is that spatial locality in layout calculations mirrors temporal locality in cache access patterns. Elements that are laid out together are likely to be updated together, so cache organization should reflect document structure rather than just computational dependencies.</p>\n</blockquote>\n<h4 id=\"multi-threaded-processing-architecture\">Multi-threaded Processing Architecture</h4>\n<p><strong>Multi-threaded processing</strong> transforms our sequential rendering pipeline into a parallel system that can utilize multiple CPU cores for improved performance. Think of this as converting from a single-lane highway to a multi-lane expressway - multiple operations can proceed simultaneously as long as they don&#39;t interfere with each other.</p>\n<p>Browser engines present unique challenges for multi-threading because of the extensive dependencies between parsing, styling, layout, and rendering operations. However, certain operations can be parallelized effectively: HTML parsing can use separate threads for tokenization and tree building, style resolution can process independent subtrees concurrently, layout calculations for independent formatting contexts can run in parallel, and rendering operations can utilize GPU parallelism for paint operations.</p>\n<p>The multi-threaded architecture requires careful design to avoid data races while maximizing parallelism opportunities:</p>\n<table>\n<thead>\n<tr>\n<th>Pipeline Stage</th>\n<th>Parallelization Strategy</th>\n<th>Synchronization Requirements</th>\n<th>Performance Gain</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>HTML Parsing</td>\n<td>Producer-consumer tokenization</td>\n<td>Token stream synchronization</td>\n<td>20-30% for large documents</td>\n</tr>\n<tr>\n<td>CSS Parsing</td>\n<td>Parallel stylesheet processing</td>\n<td>Rule ordering preservation</td>\n<td>15-25% for complex stylesheets</td>\n</tr>\n<tr>\n<td>Style Resolution</td>\n<td>Subtree-parallel processing</td>\n<td>Cascade dependency ordering</td>\n<td>40-60% for deep trees</td>\n</tr>\n<tr>\n<td>Layout Calculation</td>\n<td>Independent formatting context parallelism</td>\n<td>Parent-child dependency coordination</td>\n<td>30-50% for complex layouts</td>\n</tr>\n<tr>\n<td>Rendering</td>\n<td>GPU-accelerated paint operations</td>\n<td>Command buffer synchronization</td>\n<td>100-300% for graphics-heavy content</td>\n</tr>\n</tbody></table>\n<p>The thread coordination architecture uses a combination of work-stealing queues, dependency graphs, and barrier synchronization to maintain correctness while maximizing parallelism:</p>\n<table>\n<thead>\n<tr>\n<th>Coordination Mechanism</th>\n<th>Purpose</th>\n<th>Implementation</th>\n<th>Trade-offs</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Work-Stealing Queues</td>\n<td>Load balancing across threads</td>\n<td>Lock-free deques with thread-local work</td>\n<td>High throughput, complex debugging</td>\n</tr>\n<tr>\n<td>Dependency Graphs</td>\n<td>Ensuring correct processing order</td>\n<td>DAG with completion tracking</td>\n<td>Correct ordering, scheduling overhead</td>\n</tr>\n<tr>\n<td>Barrier Synchronization</td>\n<td>Pipeline stage coordination</td>\n<td>Phase barriers with worker synchronization</td>\n<td>Simple correctness, potential thread starvation</td>\n</tr>\n<tr>\n<td>Message Passing</td>\n<td>Cross-thread communication</td>\n<td>Channel-based producer-consumer</td>\n<td>Clean isolation, potential bottlenecks</td>\n</tr>\n</tbody></table>\n<p>A concrete multi-threading example shows the complexity and benefits. Consider processing a large HTML document with extensive CSS styling. Thread 1 performs HTML tokenization, sending tokens to Thread 2 for DOM tree construction. Meanwhile, Thread 3 processes the CSS stylesheet in parallel. Once both complete, Threads 4-6 perform style resolution on independent document subtrees. After style resolution completes, Threads 7-8 calculate layout for independent formatting contexts. Finally, Thread 9 generates paint commands while the GPU processes previous frame rendering operations. This pipeline approach keeps all processing units busy and dramatically reduces total processing time.</p>\n<p>⚠️ <strong>Pitfall: Premature Multi-threading</strong>\nA common mistake is introducing multi-threading too early in the development process, before the single-threaded implementation is stable and well-understood. Multi-threading adds significant debugging complexity, can introduce subtle race conditions, and may not provide performance benefits if the workload doesn&#39;t parallelize well. The correct approach is to first optimize the single-threaded implementation, identify actual performance bottlenecks through profiling, and then introduce threading only for operations that show clear parallelization benefits. Additionally, many web documents are small enough that threading overhead exceeds the benefits - multi-threading optimizations should be conditional based on document complexity.</p>\n<h4 id=\"memory-management-and-resource-optimization\">Memory Management and Resource Optimization</h4>\n<p><strong>Memory management</strong> becomes critical as our browser engine handles larger and more complex documents. Real-world web pages can contain thousands of DOM nodes, extensive CSS rules, and large layout trees that collectively consume significant memory. Effective memory management involves both reducing memory usage through efficient data structures and managing memory lifecycle through careful allocation and deallocation strategies.</p>\n<p>The memory optimization strategy operates across several dimensions. <strong>Data structure optimization</strong> reduces the memory footprint of individual nodes and eliminates unnecessary data duplication. <strong>Memory pooling</strong> reduces allocation overhead by reusing memory blocks for similar objects. <strong>Garbage collection coordination</strong> ensures timely cleanup of unused objects without creating performance stutters. <strong>Resource limiting</strong> prevents memory exhaustion by setting bounds on cache sizes and processing complexity.</p>\n<table>\n<thead>\n<tr>\n<th>Memory Optimization</th>\n<th>Technique</th>\n<th>Memory Savings</th>\n<th>Implementation Complexity</th>\n<th>Performance Impact</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Struct Packing</td>\n<td>Optimize field ordering and sizes</td>\n<td>20-40% per object</td>\n<td>Low</td>\n<td>Minimal</td>\n</tr>\n<tr>\n<td>String Interning</td>\n<td>Share common string values</td>\n<td>30-60% for repeated content</td>\n<td>Medium</td>\n<td>Slight positive</td>\n</tr>\n<tr>\n<td>Layout Tree Sharing</td>\n<td>Reuse unchanged subtrees</td>\n<td>40-80% for static content</td>\n<td>High</td>\n<td>Positive for large documents</td>\n</tr>\n<tr>\n<td>Object Pooling</td>\n<td>Reuse memory for temporary objects</td>\n<td>Reduces allocation overhead</td>\n<td>Medium</td>\n<td>Positive for allocation-heavy workloads</td>\n</tr>\n<tr>\n<td>Lazy Evaluation</td>\n<td>Defer calculations until needed</td>\n<td>Variable, often 20-50%</td>\n<td>Medium-High</td>\n<td>Positive for sparse usage patterns</td>\n</tr>\n</tbody></table>\n<p>Advanced memory optimization techniques involve structural changes to our data model. <strong>Copy-on-write sharing</strong> allows multiple layout trees to share unchanged subtrees, dramatically reducing memory usage for documents with repeated elements. <strong>Compressed representations</strong> use bit packing and specialized encoding for common value ranges. <strong>Memory mapped resources</strong> enable efficient sharing of large resources like images and fonts across multiple documents.</p>\n<p>The resource management system needs sophisticated policies for cache eviction, memory pressure response, and resource prioritization:</p>\n<table>\n<thead>\n<tr>\n<th>Resource Type</th>\n<th>Eviction Policy</th>\n<th>Memory Pressure Response</th>\n<th>Priority Level</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Layout Caches</td>\n<td>LRU with size limits</td>\n<td>Aggressive eviction</td>\n<td>Medium</td>\n</tr>\n<tr>\n<td>Style Computation</td>\n<td>Time-based expiration</td>\n<td>Partial eviction</td>\n<td>High</td>\n</tr>\n<tr>\n<td>Font Resources</td>\n<td>Reference counting</td>\n<td>Lazy loading</td>\n<td>High</td>\n</tr>\n<tr>\n<td>Image Buffers</td>\n<td>Size-based priorities</td>\n<td>Progressive quality reduction</td>\n<td>Low-Medium</td>\n</tr>\n<tr>\n<td>Parse Trees</td>\n<td>Usage-based retention</td>\n<td>Complete eviction</td>\n<td>Medium-High</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>The fundamental insight for memory optimization is that browser engines must balance memory usage with computational performance. Aggressive memory optimization can force expensive recalculations, while unlimited memory usage leads to system instability. The optimal strategy involves profiling real-world usage patterns and implementing adaptive policies that respond to both memory pressure and performance requirements.</p>\n</blockquote>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>The advanced features outlined above represent significant extensions to our basic browser engine architecture. This implementation guidance provides concrete technical approaches and starter code to help bridge the gap between design concepts and working implementations.</p>\n<h4 id=\"technology-recommendations\">Technology Recommendations</h4>\n<table>\n<thead>\n<tr>\n<th>Feature Category</th>\n<th>Simple Approach</th>\n<th>Advanced Approach</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Flexbox Layout</td>\n<td>Extend existing layout with flex-specific algorithms</td>\n<td>Implement full CSS Flexible Box specification</td>\n</tr>\n<tr>\n<td>Grid Layout</td>\n<td>Basic grid with fixed tracks</td>\n<td>Full grid with subgrids, implicit tracks, and auto-placement</td>\n</tr>\n<tr>\n<td>CSS Transforms</td>\n<td>2D transforms with matrix math</td>\n<td>3D transforms with perspective and hardware acceleration</td>\n</tr>\n<tr>\n<td>Animations</td>\n<td>Simple property interpolation</td>\n<td>Timeline-based animation system with complex easing</td>\n</tr>\n<tr>\n<td>Incremental Rendering</td>\n<td>Dirty flag propagation</td>\n<td>Sophisticated invalidation with dependency tracking</td>\n</tr>\n<tr>\n<td>Caching</td>\n<td>Simple memoization</td>\n<td>Multi-level cache hierarchy with smart eviction</td>\n</tr>\n<tr>\n<td>Multi-threading</td>\n<td>Basic task parallelism</td>\n<td>Lock-free data structures with work-stealing</td>\n</tr>\n<tr>\n<td>Memory Management</td>\n<td>Manual optimization</td>\n<td>Automatic memory pressure response</td>\n</tr>\n</tbody></table>\n<h4 id=\"recommended-file-structure-extension\">Recommended File Structure Extension</h4>\n<p>The advanced features require extending our existing modular architecture with new specialized components:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>project-root/\n  src/\n    layout/\n      mod.rs                    ← existing layout module\n      flexbox.rs                ← flexbox layout algorithms\n      grid.rs                   ← CSS Grid implementation\n      transforms.rs             ← transform matrix calculations\n      cache.rs                  ← layout caching system\n    \n    rendering/\n      mod.rs                    ← existing rendering module\n      animation.rs              ← animation and transition system\n      incremental.rs            ← incremental update tracking\n      damage.rs                 ← screen damage calculation\n      \n    performance/\n      memory.rs                 ← memory management utilities\n      threading.rs              ← multi-threading coordination\n      profiling.rs              ← performance measurement\n      cache_manager.rs          ← unified cache management\n    \n    css/\n      mod.rs                    ← existing CSS parser\n      flexbox_properties.rs     ← flexbox CSS parsing\n      grid_properties.rs        ← grid CSS parsing  \n      animation_parser.rs       ← keyframe and animation parsing\n      transform_functions.rs    ← transform function parsing</code></pre></div>\n\n<h4 id=\"flexbox-implementation-starter-code\">Flexbox Implementation Starter Code</h4>\n<p>Here&#39;s a complete implementation foundation for adding flexbox support to our layout engine:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">BoxType</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">ComputedStyle</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">css</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Display</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">FlexDirection</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">JustifyContent</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">AlignItems</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">types</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Size</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Point</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> FlexContainer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> flex_direction</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> FlexDirection</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> justify_content</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> JustifyContent</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> align_items</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> AlignItems</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> flex_wrap</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> FlexWrap</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> FlexItem</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> flex_grow</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> flex_shrink</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> flex_basis</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> main_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> cross_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> FlexDirection</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Row</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Column</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    RowReverse</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    ColumnReverse</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">PartialEq</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> FlexWrap</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Nowrap</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Wrap</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    WrapReverse</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> LayoutBox</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Calculate flexbox layout for container with flex display</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// This is the main entry point for flexbox layout calculations</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> calculate_flexbox_layout</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, available_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Validate that this box has display: flex</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Extract flex container properties from computed_style</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Collect all immediate children as flex items</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Determine main and cross axis based on flex_direction</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Resolve flex-basis for all items using resolve_flex_basis()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Calculate total hypothetical main size</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Distribute free space using distribute_flex_space()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 8: Handle flex line wrapping if flex_wrap is enabled</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 9: Align items on cross axis using align_cross_axis()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 10: Update final positions and sizes for all flex items</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use is_main_axis_horizontal() to determine axis orientation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Store flex container state in a FlexContainer struct</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Resolve flex-basis for each flex item, considering auto values</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> resolve_flex_basis</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, item</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#B392F0\"> LayoutBox</span><span style=\"color:#E1E4E8\">, available_main_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Check if flex-basis is 'auto' - if so, use width/height</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: If flex-basis is 'content', measure content size</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Convert percentage values to absolute pixels</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Return resolved flex-basis in main axis dimension</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use the item's computed_style to access flex properties</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Content-based sizing may require text measurement</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        0.0</span><span style=\"color:#6A737D\"> // Placeholder</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Distribute available free space among flex items based on grow/shrink factors</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> distribute_flex_space</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, items</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#E1E4E8\"> [</span><span style=\"color:#B392F0\">FlexItem</span><span style=\"color:#E1E4E8\">], available_space</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Calculate total hypothetical main size of all items</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Determine if we have extra space (grow) or overflow (shrink)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: If growing, calculate total flex-grow and distribute proportionally</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: If shrinking, calculate total flex-shrink and reduce proportionally</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Ensure no item shrinks below its minimum content size</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Update main_size for each flex item with final dimensions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Handle division by zero when total grow/shrink factors are zero</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Items with flex-shrink: 0 should not shrink below basis</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Align flex items along the cross axis</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> align_cross_axis</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, items</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;mut</span><span style=\"color:#E1E4E8\"> [</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">], container_cross_size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Determine cross axis dimension based on flex_direction  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: For each item, check align-self (falls back to align-items)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Calculate cross axis position based on alignment:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        //         - flex-start: position at 0</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        //         - center: position at (container_size - item_size) / 2  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        //         - flex-end: position at container_size - item_size</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        //         - stretch: expand item to fill container cross size</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Update item's cross axis position and size</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: stretch only affects size, not position</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use set_cross_axis_position() helper method</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Helper to determine if main axis is horizontal based on flex-direction</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> is_main_axis_horizontal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        matches!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">get_flex_direction</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#B392F0\">FlexDirection</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Row</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> FlexDirection</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">RowReverse</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Helper to get main axis size from a Size struct</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> main_axis_size</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_main_axis_horizontal</span><span style=\"color:#E1E4E8\">() { size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> { size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Helper to get cross axis size from a Size struct  </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> cross_axis_size</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, size</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Size</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_main_axis_horizontal</span><span style=\"color:#E1E4E8\">() { size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">height } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> { size</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">width }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Helper functions for accessing flex properties from computed styles</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> ComputedStyle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> flex_direction</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> FlexDirection</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Extract from CSS properties, default to Row</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        FlexDirection</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Row</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> flex_grow</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Extract from CSS properties, default to 0.0</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        0.0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> flex_shrink</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Extract from CSS properties, default to 1.0</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        1.0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> flex_basis</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Extract from CSS properties, handle 'auto' and 'content'</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        0.0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[cfg(test)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">mod</span><span style=\"color:#B392F0\"> tests</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    use</span><span style=\"color:#79B8FF\"> super</span><span style=\"color:#F97583\">::*</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    #[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> test_flexbox_basic_layout</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Create test with simple flex container and items</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Verify items are positioned correctly with default properties</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    #[test] </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> test_flex_grow_distribution</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Test free space distribution with different flex-grow values</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Verify proportional space allocation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    #[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> test_flex_shrink_overflow</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Test item shrinking when total size exceeds container</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Verify shrink factors are respected</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"animation-system-infrastructure\">Animation System Infrastructure</h4>\n<p>The animation system requires time-based processing and interpolation capabilities:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">time</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Instant</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">collections</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">HashMap</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">css</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Declaration</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">dom</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> AnimationEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    active_animations</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">AnimationId</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">ActiveAnimation</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    keyframe_rules</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">KeyframeRule</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    animation_scheduler</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> AnimationScheduler</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    start_time</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Instant</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> KeyframeRule</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> name</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> keyframes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Keyframe</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> Keyframe</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> percentage</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// 0.0 to 100.0</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> declarations</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Declaration</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> ActiveAnimation</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> element</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> DOMNodeHandle</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> keyframe_rule</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> duration</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Duration</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> start_time</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Instant</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> current_values</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> timing_function</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> TimingFunction</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> type</span><span style=\"color:#B392F0\"> AnimationId</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> u64</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> TimingFunction</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Linear</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Ease</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    EaseIn</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    EaseOut</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    EaseInOut</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    CubicBezier</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">f32</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> AnimationEngine</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            active_animations</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            keyframe_rules</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            animation_scheduler</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> AnimationScheduler</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            start_time</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Instant</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Update all active animations and return elements that need style updates</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> update_animations</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Get current timestamp relative to engine start</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Iterate through all active animations</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Calculate progress (0.0 to 1.0) based on duration and elapsed time</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Apply timing function to get eased progress</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Interpolate keyframe values at current progress</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Update current_values for each animation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Remove completed animations from active list</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 8: Return list of elements that need style recalculation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use interpolate_keyframes() to calculate intermediate values</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Elements appear multiple times if they have multiple animations</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        vec!</span><span style=\"color:#E1E4E8\">[]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Start a new animation for the given element</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> start_animation</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, element</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> DOMNodeHandle</span><span style=\"color:#E1E4E8\">, animation_name</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">, duration</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Duration</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Result</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">AnimationId</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Check if keyframe rule exists for animation_name</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Generate unique animation ID</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Create ActiveAnimation instance with current timestamp</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Initialize current_values with starting keyframe values</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Add to active_animations map</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Schedule for regular updates</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Return animation ID for later reference</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use Instant::now() for start_time</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Parse initial keyframe (0%) for starting values</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        Ok</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Interpolate between keyframes at given progress (0.0 to 1.0)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> interpolate_keyframes</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, keyframes</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#B392F0\">Keyframe</span><span style=\"color:#E1E4E8\">], progress</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Find the two keyframes that bracket the current progress</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Calculate local progress between the two keyframes</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: For each property in the keyframes, interpolate the value</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Handle different CSSValue types (Length, Color, Number, etc.)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Return map of property names to interpolated values</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use find_keyframe_range() to locate bounding keyframes</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Different value types need different interpolation logic</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        HashMap</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Apply timing function to linear progress</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> apply_timing_function</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, progress</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">, timing</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">TimingFunction</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#E1E4E8\"> timing {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            TimingFunction</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Linear</span><span style=\"color:#F97583\"> =></span><span style=\"color:#E1E4E8\"> progress,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            TimingFunction</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Ease</span><span style=\"color:#F97583\"> =></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // TODO: Implement ease cubic-bezier curve (0.25, 0.1, 0.25, 1.0)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                progress</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            TimingFunction</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">EaseIn</span><span style=\"color:#F97583\"> =></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // TODO: Implement ease-in cubic-bezier curve (0.42, 0, 1.0, 1.0)  </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                progress</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            TimingFunction</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">EaseOut</span><span style=\"color:#F97583\"> =></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // TODO: Implement ease-out cubic-bezier curve (0, 0, 0.58, 1.0)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                progress</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            TimingFunction</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">EaseInOut</span><span style=\"color:#F97583\"> =></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // TODO: Implement ease-in-out cubic-bezier curve (0.42, 0, 0.58, 1.0)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                progress</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            TimingFunction</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">CubicBezier</span><span style=\"color:#E1E4E8\">(x1, y1, x2, y2) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // TODO: Implement general cubic bezier evaluation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // Hint: This requires solving the bezier curve for given x (time) to find y (progress)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                progress</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Value interpolation trait for different CSS value types</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">trait</span><span style=\"color:#B392F0\"> Interpolatable</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> interpolate</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, other</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#E1E4E8\">, progress</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Interpolatable</span><span style=\"color:#F97583\"> for</span><span style=\"color:#B392F0\"> CSSValue</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> interpolate</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, other</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#79B8FF\">Self</span><span style=\"color:#E1E4E8\">, progress</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        match</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, other) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            (</span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Length</span><span style=\"color:#E1E4E8\">(start), </span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Length</span><span style=\"color:#E1E4E8\">(end)) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // TODO: Interpolate length values, handling unit conversion</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                CSSValue</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Length</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">start)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            (</span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">(start), </span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">(end)) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // TODO: Interpolate RGB color components</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                CSSValue</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Color</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">start)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            (</span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Number</span><span style=\"color:#E1E4E8\">(start), </span><span style=\"color:#B392F0\">CSSValue</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Number</span><span style=\"color:#E1E4E8\">(end)) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // TODO: Linear interpolation for numeric values</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                CSSValue</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Number</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">start)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            _ </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // TODO: Discrete interpolation - switch at 50% progress</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                if</span><span style=\"color:#E1E4E8\"> progress </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 0.5</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">clone</span><span style=\"color:#E1E4E8\">() } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> { other</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">clone</span><span style=\"color:#E1E4E8\">() }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> AnimationScheduler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    next_frame_time</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Instant</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    frame_duration</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Duration</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> AnimationScheduler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            next_frame_time</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Instant</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            frame_duration</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Duration</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">from_millis</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">), </span><span style=\"color:#6A737D\">// ~60fps</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Check if it's time for the next animation frame</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> should_update</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> now </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> Instant</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">now</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> now </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">next_frame_time {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">            self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">next_frame_time </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> now </span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">frame_duration;</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">            true</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">            false</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"incremental-rendering-infrastructure\">Incremental Rendering Infrastructure</h4>\n<p>The incremental rendering system requires sophisticated change tracking and invalidation logic:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">collections</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">HashSet</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">HashMap</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">dom</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">layout</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#F97583\"> crate::</span><span style=\"color:#B392F0\">types</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> IncrementalRenderer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> dom_versions</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">u64</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> style_versions</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">u64</span><span style=\"color:#E1E4E8\">>, </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> layout_versions</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">u64</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> damage_tracker</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> DamageTracker</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> update_scheduler</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> UpdateScheduler</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> DamageTracker</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> damaged_regions</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> previous_paint_rects</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> enum</span><span style=\"color:#B392F0\"> InvalidationType</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Style</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Layout</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Paint</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> UpdateScheduler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> pending_dom_changes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashSet</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> pending_style_changes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashSet</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> pending_layout_changes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashSet</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">DOMNodeHandle</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> frame_pending</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> IncrementalRenderer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            dom_versions</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            style_versions</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            layout_versions</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            damage_tracker</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> DamageTracker</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            update_scheduler</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> UpdateScheduler</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Mark element as needing style recalculation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> invalidate_style</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, element</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> DOMNodeHandle</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Add element to pending_style_changes set</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Propagate invalidation to all descendant elements</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Mark ancestors for potential layout invalidation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Schedule update frame if not already pending</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Style changes can affect layout, so cascade invalidation upward</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use propagate_invalidation_to_descendants() helper</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Mark element as needing layout recalculation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> invalidate_layout</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, element</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> DOMNodeHandle</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Add element to pending_layout_changes set</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Propagate to all children (parent layout affects child positions)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Mark for paint invalidation (layout changes require repaint)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Update damage tracking with element's current paint rectangle</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Schedule update frame</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Layout changes always require paint updates</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Store previous layout bounds for damage calculation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Perform incremental update cycle</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> perform_incremental_update</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> UpdateResult</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Process pending DOM changes first</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Resolve style changes using resolve_pending_styles()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Calculate layout for invalidated elements</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Compute damage rectangles from layout changes</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Generate paint commands for damaged regions only</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 6: Clear pending change sets</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 7: Update version numbers for processed elements</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 8: Return update statistics and damage regions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Process in dependency order: DOM -> Style -> Layout -> Paint</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Skip redundant work by checking version numbers</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        UpdateResult</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">default</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Compute minimal damage rectangles for screen updates</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> compute_damage_regions</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, layout_changes</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#B392F0\">LayoutBox</span><span style=\"color:#E1E4E8\">]) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: For each changed layout box, get old and new paint rectangles</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Union old and new rectangles to get total damage area</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Merge overlapping damage rectangles for efficiency</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Clip damage rectangles to viewport bounds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Return list of minimal rectangles needing repaint</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use rectangle_union() to combine overlapping areas</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Small damage rectangles can be merged to reduce draw call overhead</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        vec!</span><span style=\"color:#E1E4E8\">[]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Check if element needs style recalculation based on version tracking</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> needs_style_update</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">, element</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> DOMNodeHandle</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Compare current DOM version with cached style version</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Check if any ancestor styles have changed (inheritance)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Check if any matching CSS rules have been modified</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Return true if any dependency has newer version</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Style depends on element's own attributes and inherited values</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: CSS rule changes affect all matching elements</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        false</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> DamageTracker</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            damaged_regions</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            previous_paint_rects</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Add a damaged rectangle to the damage list</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> add_damage</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, rect</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Rectangle</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Check if new rectangle overlaps with existing damage</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: If overlapping, merge rectangles to avoid redundant repaints</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: If not overlapping, add as separate damage region</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Limit total number of damage rectangles for performance</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Too many small rectangles can be slower than one large rectangle</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Hint: Use Rectangle::intersects() and Rectangle::union() methods</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Get all damage rectangles and clear the damage list</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> take_damage</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">mem</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">take</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">damaged_regions)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> UpdateResult</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> elements_styled</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> elements_laid_out</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> damage_rectangles</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Rectangle</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> total_damage_area</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> UpdateScheduler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            pending_dom_changes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashSet</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            pending_style_changes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashSet</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(), </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            pending_layout_changes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashSet</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            frame_pending</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> false</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Schedule an update frame if one isn't already pending</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> schedule_frame</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">frame_pending </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> true</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: In real implementation, this would schedule with the browser's</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // main loop or request an animation frame callback</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Check if any updates are pending</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> has_pending_updates</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        !</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pending_dom_changes</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_empty</span><span style=\"color:#E1E4E8\">() </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            ||</span><span style=\"color:#F97583\"> !</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pending_style_changes</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_empty</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            ||</span><span style=\"color:#F97583\"> !</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">pending_layout_changes</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">is_empty</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[cfg(test)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">mod</span><span style=\"color:#B392F0\"> tests</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    use</span><span style=\"color:#79B8FF\"> super</span><span style=\"color:#F97583\">::*</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    #[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> test_style_invalidation_propagation</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Test that style changes propagate to descendants</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Verify version tracking works correctly</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    #[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> test_damage_rectangle_merging</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Test that overlapping damage rectangles are merged</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Verify damage tracking reduces redundant repaints</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    #[test]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> test_incremental_update_cycle</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Test complete update cycle with multiple change types</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Verify changes are processed in correct dependency order</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"performance-monitoring-and-profiling\">Performance Monitoring and Profiling</h4>\n<p>Performance optimization requires measurement and profiling capabilities:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">rust</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">time</span><span style=\"color:#F97583\">::</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Instant</span><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">use</span><span style=\"color:#B392F0\"> std</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">collections</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">HashMap</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> PerformanceProfiler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> frame_times</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> component_times</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> memory_usage</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> MemoryStats</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> render_stats</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> RenderingStats</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> MemoryStats</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> dom_nodes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> layout_boxes</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> cached_styles</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> total_memory_mb</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> RenderingStats</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> paint_commands_generated</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> damage_rectangles</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> pixels_painted</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> usize</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> cache_hit_rate</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> PerformanceProfiler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> new</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-></span><span style=\"color:#79B8FF\"> Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        Self</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            frame_times</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            component_times</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> HashMap</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">new</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            memory_usage</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> MemoryStats</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">default</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            render_stats</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> RenderingStats</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">default</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Start timing a component operation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> start_timer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, component</span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">str</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> TimerHandle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        TimerHandle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            component</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> component</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">to_string</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            start_time</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Instant</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Record component timing when timer handle is dropped</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> record_time</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">, component</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">, duration</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Duration</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        *</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">component_times</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">entry</span><span style=\"color:#E1E4E8\">(component)</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">or_insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#F97583\">::</span><span style=\"color:#79B8FF\">ZERO</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">+=</span><span style=\"color:#E1E4E8\"> duration;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    /// Generate performance report</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#F97583\"> fn</span><span style=\"color:#B392F0\"> generate_report</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#79B8FF\">self</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">-></span><span style=\"color:#B392F0\"> PerformanceReport</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Calculate average frame time and FPS</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Identify performance bottlenecks from component times</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Analyze memory usage patterns</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Generate recommendations for optimization</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Format report with timing breakdowns and suggestions</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        PerformanceReport</span><span style=\"color:#F97583\">::</span><span style=\"color:#B392F0\">default</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> TimerHandle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    component</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    start_time</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Instant</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">impl</span><span style=\"color:#B392F0\"> Drop</span><span style=\"color:#F97583\"> for</span><span style=\"color:#B392F0\"> TimerHandle</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fn</span><span style=\"color:#B392F0\"> drop</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;mut</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> duration </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">start_time</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">elapsed</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO: Record timing data to global profiler</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // In real implementation, this would access a thread-local profiler instance</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        println!</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Component '{}' took {:?}\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">self</span><span style=\"color:#F97583\">.</span><span style=\"color:#E1E4E8\">component, duration);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[derive(</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">)]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">pub</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#B392F0\"> PerformanceReport</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> average_frame_time</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Duration</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> fps</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> bottleneck_component</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> String</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> memory_usage_mb</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> cache_efficiency</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> f32</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    pub</span><span style=\"color:#E1E4E8\"> recommendations</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Vec</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Macro for convenient performance measurement</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">#[macro_export]</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">macro_rules!</span><span style=\"color:#B392F0\"> profile_scope</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    (</span><span style=\"color:#F97583\">$</span><span style=\"color:#E1E4E8\">profiler</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\">expr, </span><span style=\"color:#F97583\">$</span><span style=\"color:#E1E4E8\">name</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\">expr) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        let</span><span style=\"color:#E1E4E8\"> _timer </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> $</span><span style=\"color:#E1E4E8\">profiler</span><span style=\"color:#F97583\">.</span><span style=\"color:#B392F0\">start_timer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">$</span><span style=\"color:#E1E4E8\">name);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Example usage in layout calculation:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// profile_scope!(profiler, \"flexbox_layout\");</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// calculate_flexbox_layout();</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Timer automatically records when scope exits</span></span></code></pre></div>\n\n<h4 id=\"milestone-checkpoints-for-advanced-features\">Milestone Checkpoints for Advanced Features</h4>\n<p>After implementing each advanced feature, use these checkpoints to validate functionality:</p>\n<p><strong>Flexbox Validation Checkpoint:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Test basic flexbox layout</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> flexbox_basic_layout</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Test with sample HTML/CSS:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># &#x3C;div style=\"display: flex; width: 300px;\"></span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">#   &#x3C;div style=\"flex: 1;\">Item 1&#x3C;/div>  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">#   &#x3C;div style=\"flex: 2;\">Item 2&#x3C;/div></span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">#   &#x3C;div style=\"flex: 1;\">Item 3&#x3C;/div></span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># &#x3C;/div></span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: Item 2 should be twice the width of Items 1 and 3</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Items should sum to 300px total width</span></span></code></pre></div>\n\n<p><strong>Animation System Validation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Test keyframe interpolation</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> animation_interpolation</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Test with sample animation:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># @keyframes slide { from { left: 0px; } to { left: 100px; } }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># div { animation: slide 2s ease-in-out; }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: Element should smoothly move from left: 0 to left: 100px over 2 seconds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Animation should use ease-in-out timing curve, not linear motion</span></span></code></pre></div>\n\n<p><strong>Incremental Rendering Validation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Test damage tracking</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> incremental_damage_tracking</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Performance test: Change single element style in large document</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: Update time should be proportional to changed content, not document size</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Memory usage should not grow significantly with number of updates</span></span></code></pre></div>\n\n<p><strong>Performance Optimization Validation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Run performance benchmarks</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> bench</span><span style=\"color:#9ECBFF\"> layout_performance</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cargo</span><span style=\"color:#9ECBFF\"> bench</span><span style=\"color:#9ECBFF\"> rendering_performance</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Profile with large document (1000+ elements)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: Layout time &#x3C; 16ms for 60fps rendering</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Memory usage should stabilize without continuous growth</span></span></code></pre></div>\n\n<p>⚠️ <strong>Integration Testing Pitfall</strong>\nWhen testing advanced features, avoid testing them in isolation from the rest of the rendering pipeline. Real-world performance bottlenecks often emerge from interactions between systems - for example, flexbox layout might work perfectly on its own but cause performance issues when combined with CSS animations and incremental rendering. Always test advanced features with complete end-to-end scenarios that exercise the full rendering pipeline with realistic document complexity and update patterns.</p>\n<h2 id=\"glossary-and-technical-reference\">Glossary and Technical Reference</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> All milestones (1-4) - This section provides comprehensive definitions and technical references that support understanding and implementation throughout the entire browser engine project.</p>\n</blockquote>\n<p>Building a browser engine introduces a vast vocabulary of domain-specific terms, technical concepts, and specialized data structures. This glossary serves as a comprehensive reference for all terminology used throughout the design document, providing precise definitions, context, and relationships between concepts. Understanding this terminology is crucial for successful implementation and debugging of the rendering pipeline.</p>\n<h3 id=\"mental-model-the-technical-translator\">Mental Model: The Technical Translator</h3>\n<p>Think of this glossary as a <strong>technical translator</strong> for the browser engineering domain. Just as learning a foreign language requires understanding not just individual words but also their cultural context and relationships, mastering browser engine development requires understanding both the precise technical definitions and how concepts relate to each other within the larger system. This glossary provides both the &quot;dictionary definitions&quot; and the &quot;cultural context&quot; that connects terminology to the actual implementation challenges you&#39;ll face.</p>\n<h3 id=\"core-architecture-terms\">Core Architecture Terms</h3>\n<p>The fundamental architecture of browser engines revolves around several key concepts that form the backbone of the entire system.</p>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context</th>\n<th>Related Concepts</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Rendering Pipeline</td>\n<td>Sequential stages transforming HTML/CSS to visual output through distinct processing phases</td>\n<td>Core architectural pattern organizing the entire browser engine</td>\n<td>Assembly Line, Document Scanner, Blueprint Architect</td>\n</tr>\n<tr>\n<td>Assembly Line</td>\n<td>Mental model for browser processing stages where each component performs specialized transformation</td>\n<td>Helps understand the sequential nature of HTML→DOM→Layout→Paint</td>\n<td>Rendering Pipeline, Component Responsibilities</td>\n</tr>\n<tr>\n<td>DOM Tree</td>\n<td>Hierarchical representation of HTML document structure using parent-child node relationships</td>\n<td>Central data structure connecting HTML parsing to all downstream processing</td>\n<td>DOMNode, Tree Construction, Document Structure</td>\n</tr>\n<tr>\n<td>Style Cascade</td>\n<td>CSS rule precedence resolution system determining which styles apply to each element</td>\n<td>Implements CSS specification for handling conflicting style declarations</td>\n<td>Specificity, Cascade Algorithm, Rule Matching</td>\n</tr>\n<tr>\n<td>Box Model</td>\n<td>CSS layout model with margin, border, padding, content areas defining element dimensions</td>\n<td>Fundamental layout concept governing how space is allocated to elements</td>\n<td>LayoutBox, BoxOffsets, Containing Block</td>\n</tr>\n<tr>\n<td>Layout Tree</td>\n<td>Tree structure with computed element positions and sizes after box model calculations</td>\n<td>Bridge between styled DOM and visual rendering with geometric information</td>\n<td>LayoutBox, Formatting Context, Computed Dimensions</td>\n</tr>\n<tr>\n<td>Display List</td>\n<td>Ordered sequence of paint commands for rendering elements in correct visual order</td>\n<td>Intermediate representation between layout and actual graphics operations</td>\n<td>PaintCommand, Z-Order, Rendering Pipeline</td>\n</tr>\n<tr>\n<td>Viewport</td>\n<td>Visible area dimensions for layout calculations and rendering coordinate system</td>\n<td>Defines the available space and coordinate system for all layout operations</td>\n<td>Rectangle, Coordinate System, Available Space</td>\n</tr>\n</tbody></table>\n<h3 id=\"html-parsing-and-dom-terms\">HTML Parsing and DOM Terms</h3>\n<p>HTML parsing involves complex terminology related to tokenization, tree construction, and error recovery mechanisms.</p>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context</th>\n<th>Implementation Notes</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Tokenization</td>\n<td>Breaking HTML text into meaningful tokens like start tags, end tags, and text content</td>\n<td>First stage of HTML parsing that performs lexical analysis</td>\n<td>HTMLToken, TokenizerState, State Machine</td>\n</tr>\n<tr>\n<td>State Machine</td>\n<td>Context-sensitive parsing algorithm tracking current parsing context and valid transitions</td>\n<td>Core algorithm for HTML tokenizer handling context-dependent parsing rules</td>\n<td>TokenizerState, State Transitions, Context Tracking</td>\n</tr>\n<tr>\n<td>Tree Construction</td>\n<td>Building hierarchical DOM structure from token stream using stack-based algorithm</td>\n<td>Second stage of HTML parsing that creates the document structure</td>\n<td>TreeBuilder, Open Elements Stack, DOM Assembly</td>\n</tr>\n<tr>\n<td>Void Elements</td>\n<td>Self-closing tags that cannot contain children like <code>br</code>, <code>img</code>, <code>input</code></td>\n<td>Special HTML elements requiring different parsing and tree construction logic</td>\n<td>VOID_ELEMENTS constant, Self-Closing Tags</td>\n</tr>\n<tr>\n<td>Error Recovery</td>\n<td>Graceful handling of malformed input with continuation of parsing process</td>\n<td>Essential for real-world HTML which often contains syntax errors</td>\n<td>HTMLErrorRecovery, Foster Parenting, Auto-Closing</td>\n</tr>\n<tr>\n<td>Foster Parenting</td>\n<td>Moving misplaced HTML content to appropriate parent elements during tree construction</td>\n<td>Specific error recovery mechanism for handling incorrectly nested elements</td>\n<td>TreeBuilder algorithm, DOM correction</td>\n</tr>\n<tr>\n<td>Open Elements Stack</td>\n<td>Stack tracking unclosed HTML elements during parsing for proper nesting validation</td>\n<td>Core data structure in tree builder ensuring correct parent-child relationships</td>\n<td>TreeBuilder state, Element nesting</td>\n</tr>\n<tr>\n<td>HTML Entities</td>\n<td>Named character entity lookup table for converting <code>&amp;amp;</code> to <code>&amp;</code> etc</td>\n<td>Text processing component handling special character encoding in HTML</td>\n<td>HTML_ENTITIES constant, Entity Decoding</td>\n</tr>\n</tbody></table>\n<h3 id=\"css-parsing-and-style-terms\">CSS Parsing and Style Terms</h3>\n<p>CSS processing introduces extensive terminology around selectors, properties, cascade resolution, and style computation.</p>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context</th>\n<th>Key Algorithms</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>CSS Cascade</td>\n<td>Rule precedence resolution system implementing CSS specification for style conflicts</td>\n<td>Determines final computed styles when multiple rules affect the same element</td>\n<td>Cascade Algorithm, Specificity Comparison</td>\n</tr>\n<tr>\n<td>Specificity</td>\n<td>CSS selector priority calculation as tuple (inline, ids, classes, elements)</td>\n<td>Numerical weight system determining which CSS rules take precedence</td>\n<td>Specificity calculation, Cascade Resolution</td>\n</tr>\n<tr>\n<td>Selector Matching</td>\n<td>Testing if CSS rules apply to DOM elements based on selector patterns</td>\n<td>Core algorithm connecting CSS rules to DOM elements for style application</td>\n<td>matches_element function, Selector evaluation</td>\n</tr>\n<tr>\n<td>Computed Styles</td>\n<td>Final resolved CSS property values after cascade, inheritance, and value computation</td>\n<td>Result of style resolution process containing all properties needed for layout</td>\n<td>ComputedStyle, Style Resolution Pipeline</td>\n</tr>\n<tr>\n<td>Inheritance</td>\n<td>Automatic copying of properties from parent to child elements in DOM tree</td>\n<td>CSS mechanism for style propagation through document hierarchy</td>\n<td>Property inheritance, Parent-child relationships</td>\n</tr>\n<tr>\n<td>Combinator Selectors</td>\n<td>CSS selectors with relationship operators like descendant, child, sibling</td>\n<td>Advanced selector patterns expressing relationships between elements</td>\n<td>Selector parsing, Relationship matching</td>\n</tr>\n<tr>\n<td>Shorthand Properties</td>\n<td>CSS properties that set multiple values in single declaration like <code>margin: 10px</code></td>\n<td>Convenience syntax requiring expansion to individual property values</td>\n<td>Property parsing, Value expansion</td>\n</tr>\n<tr>\n<td>Cascade Algorithm</td>\n<td>Systematic process for resolving CSS rule conflicts through origin, specificity, and source order</td>\n<td>Core CSS specification algorithm implemented in style resolution</td>\n<td>Rule sorting, Precedence calculation</td>\n</tr>\n</tbody></table>\n<h3 id=\"layout-and-box-model-terms\">Layout and Box Model Terms</h3>\n<p>Layout computation involves precise terminology around geometric calculations, formatting contexts, and dimensional algorithms.</p>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context</th>\n<th>Mathematical Relationships</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Formatting Context</td>\n<td>Layout algorithm governing element arrangement (block or inline flow)</td>\n<td>Determines how child elements are positioned within their container</td>\n<td>Block Formatting, Inline Formatting</td>\n</tr>\n<tr>\n<td>Containing Block</td>\n<td>Element establishing coordinate system and available space for child elements</td>\n<td>Reference frame for percentage calculations and positioning</td>\n<td>Coordinate System, Available Space</td>\n</tr>\n<tr>\n<td>Available Space</td>\n<td>Dimensions accessible to child elements after subtracting parent padding/border</td>\n<td>Constraint on child element sizing during layout calculation</td>\n<td>Box Model, Dimension Calculation</td>\n</tr>\n<tr>\n<td>Margin Collapsing</td>\n<td>CSS behavior combining adjacent margins into single margin value</td>\n<td>Complex algorithm affecting vertical spacing between block elements</td>\n<td>Margin calculation, Block layout</td>\n</tr>\n<tr>\n<td>Baseline Alignment</td>\n<td>Vertical positioning of inline elements relative to text baseline</td>\n<td>Typography-based positioning for inline and text elements</td>\n<td>Inline Layout, Text Metrics</td>\n</tr>\n<tr>\n<td>Line Breaking</td>\n<td>Algorithm for wrapping content to new lines at container boundaries</td>\n<td>Text flow algorithm handling word wrapping and hyphenation</td>\n<td>Inline Layout, Text Measurement</td>\n</tr>\n<tr>\n<td>Auto Margins</td>\n<td>Margin values that adjust automatically based on available space</td>\n<td>Special CSS value requiring constraint satisfaction algorithms</td>\n<td>Centering, Space Distribution</td>\n</tr>\n<tr>\n<td>Percentage Units</td>\n<td>CSS dimensions calculated relative to containing block dimensions</td>\n<td>Relative sizing requiring parent dimension knowledge</td>\n<td>Unit conversion, Relative sizing</td>\n</tr>\n<tr>\n<td>Over-Constraint Resolution</td>\n<td>Handling impossible combinations of CSS layout values</td>\n<td>Conflict resolution when CSS properties specify contradictory requirements</td>\n<td>Constraint satisfaction, Fallback rules</td>\n</tr>\n</tbody></table>\n<h3 id=\"rendering-and-graphics-terms\">Rendering and Graphics Terms</h3>\n<p>The rendering stage introduces terminology around visual output, paint operations, and graphics optimization.</p>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context</th>\n<th>Optimization Considerations</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Paint Command Generation</td>\n<td>Converting layout tree into drawing operations for graphics backend</td>\n<td>Translation from geometric layout to visual rendering instructions</td>\n<td>PaintCommand creation, Display List</td>\n</tr>\n<tr>\n<td>Graphics Backend Abstraction</td>\n<td>Interface over different graphics libraries for drawing primitives and text</td>\n<td>Portability layer supporting multiple rendering targets</td>\n<td>Hardware acceleration, Software fallback</td>\n</tr>\n<tr>\n<td>Z-Order</td>\n<td>Depth ordering for element layering and visual stacking</td>\n<td>Determines which elements appear in front of others</td>\n<td>Stacking Context, Paint order</td>\n</tr>\n<tr>\n<td>Clipping Context</td>\n<td>Restricted drawing region for child elements</td>\n<td>Graphics optimization and visual containment</td>\n<td>Viewport culling, Overdraw elimination</td>\n</tr>\n<tr>\n<td>Stacking Context</td>\n<td>CSS layering and z-index management for complex layering scenarios</td>\n<td>Advanced layout feature affecting paint order</td>\n<td>Z-index, Layer management</td>\n</tr>\n<tr>\n<td>Viewport Culling</td>\n<td>Optimization removing off-screen elements from rendering</td>\n<td>Performance optimization reducing unnecessary drawing operations</td>\n<td>Coordinate bounds checking</td>\n</tr>\n<tr>\n<td>Overdraw Elimination</td>\n<td>Optimization removing occluded drawing operations</td>\n<td>Graphics optimization reducing pixel fill operations</td>\n<td>Occlusion testing, Layer optimization</td>\n</tr>\n<tr>\n<td>Command Batching</td>\n<td>Grouping similar operations for efficiency</td>\n<td>Graphics API optimization reducing state changes</td>\n<td>Batch processing, GPU efficiency</td>\n</tr>\n<tr>\n<td>Subpixel Rendering</td>\n<td>High-precision text rendering using fractional pixel positions</td>\n<td>Typography enhancement for text clarity</td>\n<td>Font rendering, Anti-aliasing</td>\n</tr>\n</tbody></table>\n<h3 id=\"error-handling-and-recovery-terms\">Error Handling and Recovery Terms</h3>\n<p>Comprehensive error handling requires specific terminology around failure modes, recovery strategies, and diagnostic techniques.</p>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context</th>\n<th>Recovery Strategies</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Graceful Degradation</td>\n<td>Maintaining functionality with reduced quality when errors occur</td>\n<td>Overall error handling philosophy prioritizing continued operation</td>\n<td>Progressive fallback, Quality reduction</td>\n</tr>\n<tr>\n<td>Error Recovery</td>\n<td>Systematic strategies for handling failures while continuing processing</td>\n<td>Essential capability for real-world robustness with malformed input</td>\n<td>Recovery points, Continuation strategies</td>\n</tr>\n<tr>\n<td>Fallback Cascade</td>\n<td>Progressive degradation through simpler rendering techniques</td>\n<td>Layered approach to handling rendering failures</td>\n<td>Hardware→Software→Simple rendering</td>\n</tr>\n<tr>\n<td>Recovery Point</td>\n<td>Valid parsing position to resume after CSS syntax error</td>\n<td>Parsing strategy for continuing after encountering malformed input</td>\n<td>Parser state, Error boundaries</td>\n</tr>\n<tr>\n<td>Constraint Satisfaction</td>\n<td>Resolving conflicting layout requirements through systematic algorithms</td>\n<td>Layout algorithm handling impossible CSS property combinations</td>\n<td>Over-constraint resolution</td>\n</tr>\n<tr>\n<td>Resource Pressure</td>\n<td>Managing memory and graphics resource exhaustion</td>\n<td>System-level error condition requiring resource management</td>\n<td>Memory management, Resource limits</td>\n</tr>\n<tr>\n<td>Error Boundary Isolation</td>\n<td>Containing failures to prevent cross-component cascading</td>\n<td>Architectural strategy limiting error propagation between components</td>\n<td>Component isolation, Failure containment</td>\n</tr>\n<tr>\n<td>Cascade Error Propagation</td>\n<td>Coordinating error handling across pipeline stages</td>\n<td>System-level error handling ensuring consistent behavior</td>\n<td>Pipeline error handling</td>\n</tr>\n</tbody></table>\n<h3 id=\"data-structure-and-type-system-terms\">Data Structure and Type System Terms</h3>\n<p>The browser engine relies on numerous specialized data structures, each with specific purposes and relationships.</p>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Key Fields</th>\n<th>Usage Context</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>DOMNodeHandle</td>\n<td>Reference to DOM node enabling tree navigation and manipulation</td>\n<td>Opaque reference type</td>\n<td>Tree traversal, Node relationships</td>\n</tr>\n<tr>\n<td>ElementData</td>\n<td>HTML element information including tag name, attributes, and metadata</td>\n<td>tag_name, attributes, namespace, is_void</td>\n<td>Element representation, Attribute access</td>\n</tr>\n<tr>\n<td>DocumentData</td>\n<td>Document-level metadata and configuration</td>\n<td>doctype, title, base_url, character_encoding</td>\n<td>Document properties, Global settings</td>\n</tr>\n<tr>\n<td>CSSRule</td>\n<td>Complete CSS rule with selector, declarations, and metadata</td>\n<td>selector, declarations, specificity, source_order</td>\n<td>Style matching, Cascade resolution</td>\n</tr>\n<tr>\n<td>Selector</td>\n<td>CSS selector pattern for matching elements</td>\n<td>Universal, Type, Class, ID, Attribute variants</td>\n<td>Element matching, Style application</td>\n</tr>\n<tr>\n<td>Specificity</td>\n<td>CSS selector priority calculation tuple</td>\n<td>inline, ids, classes, elements</td>\n<td>Cascade algorithm, Rule precedence</td>\n</tr>\n<tr>\n<td>Declaration</td>\n<td>CSS property-value pair with importance flag</td>\n<td>property, value, important</td>\n<td>Style declaration, Property application</td>\n</tr>\n<tr>\n<td>ComputedStyle</td>\n<td>Final resolved CSS property values for layout</td>\n<td>display, position, dimensions, colors, spacing</td>\n<td>Layout input, Visual properties</td>\n</tr>\n<tr>\n<td>LayoutBox</td>\n<td>Geometric layout information with box model rectangles</td>\n<td>box_type, rectangles, children, computed_style</td>\n<td>Layout tree, Geometric calculations</td>\n</tr>\n<tr>\n<td>BoxOffsets</td>\n<td>Four-sided spacing values for margin, border, padding</td>\n<td>top, right, bottom, left</td>\n<td>Box model, Spacing calculations</td>\n</tr>\n</tbody></table>\n<h3 id=\"debugging-and-development-terms\">Debugging and Development Terms</h3>\n<p>Effective debugging requires understanding diagnostic terminology and development workflow concepts.</p>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Application</th>\n<th>Diagnostic Value</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Symptom-First Approach</td>\n<td>Debugging methodology starting from observable problems</td>\n<td>Start with visible issues, trace backwards to root causes</td>\n<td>Systematic problem solving</td>\n</tr>\n<tr>\n<td>Hierarchical Visualization</td>\n<td>Diagnostic technique showing tree structures with indentation</td>\n<td>DOM tree, CSS rule hierarchy, layout tree inspection</td>\n<td>Structure understanding</td>\n</tr>\n<tr>\n<td>Dimensional Visualization</td>\n<td>Diagnostic technique showing box model rectangles</td>\n<td>Layout debugging, box model verification</td>\n<td>Geometric validation</td>\n</tr>\n<tr>\n<td>Flow Visualization</td>\n<td>Diagnostic technique showing document layout flow</td>\n<td>Block and inline layout debugging</td>\n<td>Layout algorithm verification</td>\n</tr>\n<tr>\n<td>State Machine Instrumentation</td>\n<td>Adding logging to parser state transitions</td>\n<td>HTML/CSS parser debugging</td>\n<td>Parse process understanding</td>\n</tr>\n<tr>\n<td>Rule Tracing</td>\n<td>Debugging technique tracking CSS rule application</td>\n<td>Style resolution debugging</td>\n<td>Cascade algorithm verification</td>\n</tr>\n<tr>\n<td>Integration Testing</td>\n<td>End-to-end tests validating complete rendering pipeline</td>\n<td>Full system testing with real HTML/CSS examples</td>\n<td>System validation</td>\n</tr>\n<tr>\n<td>Milestone Validation</td>\n<td>Specific tests and expected behaviors after completing each milestone</td>\n<td>Development progress verification</td>\n<td>Implementation checkpoints</td>\n</tr>\n<tr>\n<td>Acceptance Criteria</td>\n<td>Specific requirements that must be met for milestone completion</td>\n<td>Quality gates for development milestones</td>\n<td>Success measurement</td>\n</tr>\n</tbody></table>\n<h3 id=\"advanced-features-and-extensions\">Advanced Features and Extensions</h3>\n<p>Future development involves terminology around advanced CSS features, performance optimization, and system scalability.</p>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Complexity Level</th>\n<th>Implementation Scope</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Flexbox</td>\n<td>CSS flexible box layout system with intelligent space distribution</td>\n<td>Advanced layout algorithm</td>\n<td>Milestone extension</td>\n</tr>\n<tr>\n<td>CSS Grid</td>\n<td>Two-dimensional layout system with precise positioning control</td>\n<td>Complex layout system</td>\n<td>Advanced feature</td>\n</tr>\n<tr>\n<td>CSS Transforms</td>\n<td>Visual manipulation without affecting document layout</td>\n<td>Graphics transformation</td>\n<td>Rendering extension</td>\n</tr>\n<tr>\n<td>Animation Interpolation</td>\n<td>Calculating intermediate values between keyframes</td>\n<td>Mathematical animation system</td>\n<td>Dynamic rendering</td>\n</tr>\n<tr>\n<td>Timing Functions</td>\n<td>Mathematical curves controlling animation pacing</td>\n<td>Animation mathematics</td>\n<td>Smooth transitions</td>\n</tr>\n<tr>\n<td>Incremental Rendering</td>\n<td>Optimization avoiding redundant work by processing only changes</td>\n<td>Performance optimization</td>\n<td>Scalability improvement</td>\n</tr>\n<tr>\n<td>Damage Tracking</td>\n<td>Identifying screen regions needing repaint</td>\n<td>Rendering optimization</td>\n<td>Efficient updates</td>\n</tr>\n<tr>\n<td>Layout Caching</td>\n<td>Preserving computed layout results for reuse</td>\n<td>Performance optimization</td>\n<td>Memory-speed tradeoff</td>\n</tr>\n<tr>\n<td>Multi-threaded Processing</td>\n<td>Parallel execution across multiple CPU cores</td>\n<td>Concurrency optimization</td>\n<td>System scalability</td>\n</tr>\n<tr>\n<td>Version Tracking</td>\n<td>Detecting changes through sequential numbering</td>\n<td>Change detection system</td>\n<td>Incremental updates</td>\n</tr>\n</tbody></table>\n<h3 id=\"performance-and-optimization-terms\">Performance and Optimization Terms</h3>\n<p>Browser engines require extensive performance optimization terminology covering memory management, rendering efficiency, and system resource utilization.</p>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Measurement Approach</th>\n<th>Optimization Impact</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Performance Profiling</td>\n<td>Measuring and analyzing system performance characteristics</td>\n<td>Timing measurements, resource usage monitoring</td>\n<td>Bottleneck identification</td>\n</tr>\n<tr>\n<td>Memory Pressure</td>\n<td>System resource exhaustion requiring optimization strategies</td>\n<td>Memory usage tracking, allocation monitoring</td>\n<td>Resource management</td>\n</tr>\n<tr>\n<td>Cache Efficiency</td>\n<td>Effectiveness of caching strategies in reducing computation</td>\n<td>Cache hit rates, computation savings</td>\n<td>Performance improvement</td>\n</tr>\n<tr>\n<td>Frame Rate</td>\n<td>Rendering performance measured in frames per second</td>\n<td>Time-based performance measurement</td>\n<td>User experience quality</td>\n</tr>\n<tr>\n<td>Bottleneck Component</td>\n<td>System component limiting overall performance</td>\n<td>Component-level timing analysis</td>\n<td>Optimization prioritization</td>\n</tr>\n<tr>\n<td>Progressive Enhancement</td>\n<td>Adding features while maintaining backward compatibility</td>\n<td>Feature capability detection</td>\n<td>System robustness</td>\n</tr>\n<tr>\n<td>Invalidation Propagation</td>\n<td>Cascading change notifications through dependency chains</td>\n<td>Change tracking, update coordination</td>\n<td>Efficient updates</td>\n</tr>\n<tr>\n<td>Update Scheduler</td>\n<td>System managing timing and coordination of rendering updates</td>\n<td>Frame timing, update batching</td>\n<td>Smooth rendering</td>\n</tr>\n</tbody></table>\n<h3 id=\"implementation-and-development-terms\">Implementation and Development Terms</h3>\n<p>The development process introduces terminology around code organization, testing strategies, and implementation validation.</p>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Development Phase</th>\n<th>Quality Assurance</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Test Harness</td>\n<td>Infrastructure for running and validating tests</td>\n<td>Testing framework setup</td>\n<td>Automated validation</td>\n</tr>\n<tr>\n<td>Reference Documents</td>\n<td>Curated test inputs with known expected outputs</td>\n<td>Test case development</td>\n<td>Correctness verification</td>\n</tr>\n<tr>\n<td>File Structure Organization</td>\n<td>Modular organization of codebase across parsing, styling, layout, and rendering modules</td>\n<td>Project architecture</td>\n<td>Code maintainability</td>\n</tr>\n<tr>\n<td>Component Interface Contracts</td>\n<td>Formal specifications of data passed between pipeline stages</td>\n<td>API design, system integration</td>\n<td>Interface compliance</td>\n</tr>\n<tr>\n<td>Milestone Checkpoints</td>\n<td>Specific tests and expected behaviors after each implementation stage</td>\n<td>Development progress tracking</td>\n<td>Quality gates</td>\n</tr>\n<tr>\n<td>External Validation</td>\n<td>Debugging technique using reference implementations</td>\n<td>Correctness verification against standards</td>\n<td>Implementation validation</td>\n</tr>\n<tr>\n<td>Progressive Fallback</td>\n<td>Rendering strategy with multiple quality levels</td>\n<td>Error handling, system robustness</td>\n<td>Graceful degradation</td>\n</tr>\n</tbody></table>\n<h3 id=\"constants-and-enumerations\">Constants and Enumerations</h3>\n<p>The browser engine defines numerous constants and enumerated types for consistent behavior across components.</p>\n<table>\n<thead>\n<tr>\n<th>Constant/Enum</th>\n<th>Value/Variants</th>\n<th>Purpose</th>\n<th>Usage Context</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>WHITE</td>\n<td>Color { r: 255, g: 255, b: 255, a: 255 }</td>\n<td>Standard white color</td>\n<td>Default backgrounds, text rendering</td>\n</tr>\n<tr>\n<td>BLACK</td>\n<td>Color { r: 0, g: 0, b: 0, a: 255 }</td>\n<td>Standard black color</td>\n<td>Default text, borders</td>\n</tr>\n<tr>\n<td>TRANSPARENT</td>\n<td>Color { r: 0, g: 0, b: 0, a: 0 }</td>\n<td>Fully transparent color</td>\n<td>Invisible elements, overlay effects</td>\n</tr>\n<tr>\n<td>VOID_ELEMENTS</td>\n<td>[&quot;br&quot;, &quot;hr&quot;, &quot;img&quot;, &quot;input&quot;, &quot;meta&quot;, &quot;link&quot;]</td>\n<td>Self-closing HTML elements</td>\n<td>HTML parsing, tree construction</td>\n</tr>\n<tr>\n<td>HTML_ENTITIES</td>\n<td>{&quot;&amp;&quot;: &quot;&amp;&quot;, &quot;&lt;&quot;: &quot;&lt;&quot;, &quot;&gt;&quot;: &quot;&gt;&quot;}</td>\n<td>Named character entities</td>\n<td>Text content processing</td>\n</tr>\n<tr>\n<td>TokenizerState</td>\n<td>Data, TagOpen, TagName, BeforeAttributeName</td>\n<td>HTML parsing states</td>\n<td>Tokenizer state machine</td>\n</tr>\n<tr>\n<td>BoxType</td>\n<td>BlockContainer, InlineContainer, TextBox</td>\n<td>Layout box classifications</td>\n<td>Layout tree construction</td>\n</tr>\n<tr>\n<td>Display</td>\n<td>Block, Inline, None, Flex, Grid</td>\n<td>CSS display property values</td>\n<td>Layout algorithm selection</td>\n</tr>\n<tr>\n<td>Position</td>\n<td>Static, Relative, Absolute, Fixed</td>\n<td>CSS position property values</td>\n<td>Positioning algorithm selection</td>\n</tr>\n<tr>\n<td>Unit</td>\n<td>Px(f32), Percent(f32), Em(f32), Auto</td>\n<td>CSS unit types</td>\n<td>Dimension calculation</td>\n</tr>\n</tbody></table>\n<h3 id=\"relationships-and-dependencies\">Relationships and Dependencies</h3>\n<p>Understanding how terminology relates across the system is crucial for implementation success. The browser engine&#39;s terminology forms interconnected networks of concepts that build upon each other systematically.</p>\n<blockquote>\n<p><strong>Key Insight</strong>: Browser engine terminology follows the data flow through the rendering pipeline. HTML parsing terms connect to DOM concepts, which connect to CSS terms, which connect to layout terms, which connect to rendering terms. Understanding these relationships helps navigate the complexity.</p>\n</blockquote>\n<p>The <strong>parsing domain</strong> (tokenization, state machines, tree construction) connects to the <strong>structure domain</strong> (DOM trees, elements, attributes) which connects to the <strong>styling domain</strong> (selectors, cascade, computed styles) which connects to the <strong>layout domain</strong> (box model, formatting contexts, dimensions) which finally connects to the <strong>rendering domain</strong> (paint commands, graphics backends, visual output).</p>\n<p><strong>Error handling terminology</strong> cuts across all domains, providing consistent recovery strategies and debugging approaches throughout the system. Similarly, <strong>performance terminology</strong> applies to all components but becomes increasingly important in layout and rendering where computational complexity is highest.</p>\n<p><strong>Advanced features</strong> build upon the foundational terminology, extending basic concepts into more sophisticated algorithms and optimizations. Understanding the basic terminology thoroughly is essential before approaching advanced extensions like flexbox, animations, or incremental rendering.</p>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>This glossary supports implementation by providing not just definitions but also context about how terminology translates into actual code structures and algorithms. Each term connects to specific data types, function signatures, and implementation patterns defined in the naming conventions.</p>\n<p>Understanding the precise meaning of each term helps avoid common implementation mistakes where similar concepts get confused or where terminology imprecision leads to incorrect algorithm implementation. For example, distinguishing between &quot;available space&quot; and &quot;containing block dimensions&quot; is crucial for correct box model calculations.</p>\n<p>The terminology also provides a shared vocabulary for debugging and optimization discussions. When layout calculations produce incorrect results, being able to precisely describe the issue using terms like &quot;margin collapsing,&quot; &quot;over-constraint resolution,&quot; or &quot;percentage unit calculation&quot; enables more efficient problem-solving.</p>\n","toc":[{"level":1,"text":"Build Your Own Browser Engine: Design Document","id":"build-your-own-browser-engine-design-document"},{"level":2,"text":"Overview","id":"overview"},{"level":2,"text":"Context and Problem Statement","id":"context-and-problem-statement"},{"level":3,"text":"Mental Model: The Document Assembly Line","id":"mental-model-the-document-assembly-line"},{"level":3,"text":"Existing Browser Engine Approaches","id":"existing-browser-engine-approaches"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":2,"text":"Goals and Non-Goals","id":"goals-and-non-goals"},{"level":3,"text":"Core Goals","id":"core-goals"},{"level":3,"text":"Explicit Non-Goals","id":"explicit-non-goals"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":2,"text":"High-Level Architecture","id":"high-level-architecture"},{"level":3,"text":"The Rendering Pipeline","id":"the-rendering-pipeline"},{"level":3,"text":"Component Responsibilities","id":"component-responsibilities"},{"level":4,"text":"HTML Parser Component","id":"html-parser-component"},{"level":4,"text":"Style Resolver Component","id":"style-resolver-component"},{"level":4,"text":"Layout Engine Component","id":"layout-engine-component"},{"level":4,"text":"Render Engine Component","id":"render-engine-component"},{"level":3,"text":"Recommended File Structure","id":"recommended-file-structure"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"Technology Recommendations","id":"technology-recommendations"},{"level":4,"text":"Complete Starter Code","id":"complete-starter-code"},{"level":4,"text":"Core Logic Skeletons","id":"core-logic-skeletons"},{"level":4,"text":"Development Workflow and Milestones","id":"development-workflow-and-milestones"},{"level":2,"text":"Data Model and Core Types","id":"data-model-and-core-types"},{"level":3,"text":"Mental Model: The Document Assembly Line Containers","id":"mental-model-the-document-assembly-line-containers"},{"level":3,"text":"DOM Tree Types","id":"dom-tree-types"},{"level":4,"text":"Core DOM Node Structure","id":"core-dom-node-structure"},{"level":4,"text":"DOM Node Type Variants","id":"dom-node-type-variants"},{"level":4,"text":"Element Data Structure","id":"element-data-structure"},{"level":4,"text":"Document Data Structure","id":"document-data-structure"},{"level":4,"text":"DOM Tree Navigation Interface","id":"dom-tree-navigation-interface"},{"level":4,"text":"Text Content Extraction","id":"text-content-extraction"},{"level":3,"text":"CSS and Style Types","id":"css-and-style-types"},{"level":4,"text":"CSS Rule Structure","id":"css-rule-structure"},{"level":4,"text":"Selector Types and Structure","id":"selector-types-and-structure"},{"level":4,"text":"Specificity Calculation","id":"specificity-calculation"},{"level":4,"text":"CSS Declaration Structure","id":"css-declaration-structure"},{"level":4,"text":"CSS Value Types","id":"css-value-types"},{"level":4,"text":"Stylesheet Structure","id":"stylesheet-structure"},{"level":4,"text":"Computed Style Structure","id":"computed-style-structure"},{"level":4,"text":"Style Matching Interface","id":"style-matching-interface"},{"level":3,"text":"Layout and Box Model Types","id":"layout-and-box-model-types"},{"level":4,"text":"Layout Box Structure","id":"layout-box-structure"},{"level":4,"text":"Box Type Classifications","id":"box-type-classifications"},{"level":4,"text":"Rectangle and Geometric Types","id":"rectangle-and-geometric-types"},{"level":4,"text":"Point and Size Components","id":"point-and-size-components"},{"level":4,"text":"Box Model Calculation Interface","id":"box-model-calculation-interface"},{"level":4,"text":"Layout Constraints","id":"layout-constraints"},{"level":4,"text":"Formatting Context Types","id":"formatting-context-types"},{"level":4,"text":"Layout Tree Construction Process","id":"layout-tree-construction-process"},{"level":3,"text":"Paint Command Types","id":"paint-command-types"},{"level":4,"text":"Paint Command Structure","id":"paint-command-structure"},{"level":4,"text":"Display List Structure","id":"display-list-structure"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"Technology Recommendations","id":"technology-recommendations"},{"level":4,"text":"Recommended File Structure","id":"recommended-file-structure"},{"level":4,"text":"Core Geometry Types (Complete Implementation)","id":"core-geometry-types-complete-implementation"},{"level":4,"text":"Color Type Implementation (Complete)","id":"color-type-implementation-complete"},{"level":4,"text":"DOM Node Type Skeleton","id":"dom-node-type-skeleton"},{"level":4,"text":"CSS Value and Unit Types Skeleton","id":"css-value-and-unit-types-skeleton"},{"level":4,"text":"Layout Box Model Skeleton","id":"layout-box-model-skeleton"},{"level":4,"text":"Milestone Checkpoint: Data Structure Validation","id":"milestone-checkpoint-data-structure-validation"},{"level":4,"text":"Debugging Tips","id":"debugging-tips"},{"level":2,"text":"HTML Parser Design","id":"html-parser-design"},{"level":3,"text":"HTML Tokenization","id":"html-tokenization"},{"level":3,"text":"DOM Tree Construction","id":"dom-tree-construction"},{"level":3,"text":"Error Recovery and Edge Cases","id":"error-recovery-and-edge-cases"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":2,"text":"CSS Parser and Style System","id":"css-parser-and-style-system"},{"level":3,"text":"CSS Tokenization and Rule Parsing","id":"css-tokenization-and-rule-parsing"},{"level":3,"text":"Specificity and Cascade Resolution","id":"specificity-and-cascade-resolution"},{"level":3,"text":"Style Matching and Computed Values","id":"style-matching-and-computed-values"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":2,"text":"Layout Engine Design","id":"layout-engine-design"},{"level":3,"text":"CSS Box Model Implementation","id":"css-box-model-implementation"},{"level":3,"text":"Block Formatting Context","id":"block-formatting-context"},{"level":3,"text":"Inline Formatting Context","id":"inline-formatting-context"},{"level":3,"text":"Common Pitfalls","id":"common-pitfalls"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":2,"text":"Rendering Engine Design","id":"rendering-engine-design"},{"level":3,"text":"Paint Command Generation","id":"paint-command-generation"},{"level":3,"text":"Graphics Backend Abstraction","id":"graphics-backend-abstraction"},{"level":3,"text":"Rendering Optimizations","id":"rendering-optimizations"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":2,"text":"Component Interactions and Data Flow","id":"component-interactions-and-data-flow"},{"level":3,"text":"End-to-End Pipeline Flow","id":"end-to-end-pipeline-flow"},{"level":4,"text":"Stage 1: HTML Text to DOM Tree","id":"stage-1-html-text-to-dom-tree"},{"level":4,"text":"Stage 2: DOM Tree + CSS Rules to Styled Tree","id":"stage-2-dom-tree-css-rules-to-styled-tree"},{"level":4,"text":"Stage 3: Styled Tree to Layout Tree","id":"stage-3-styled-tree-to-layout-tree"},{"level":4,"text":"Stage 4: Layout Tree to Visual Output","id":"stage-4-layout-tree-to-visual-output"},{"level":3,"text":"Component Interface Contracts","id":"component-interface-contracts"},{"level":4,"text":"HTMLParser Interface Contract","id":"htmlparser-interface-contract"},{"level":4,"text":"StyleResolver Interface Contract","id":"styleresolver-interface-contract"},{"level":4,"text":"LayoutEngine Interface Contract","id":"layoutengine-interface-contract"},{"level":4,"text":"RenderEngine Interface Contract","id":"renderengine-interface-contract"},{"level":3,"text":"Data Transformation Validation","id":"data-transformation-validation"},{"level":4,"text":"DOM Tree Validation","id":"dom-tree-validation"},{"level":4,"text":"Style Resolution Validation","id":"style-resolution-validation"},{"level":4,"text":"Layout Tree Validation","id":"layout-tree-validation"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"Technology Recommendations","id":"technology-recommendations"},{"level":4,"text":"Recommended File Structure","id":"recommended-file-structure"},{"level":4,"text":"Pipeline Orchestration Infrastructure","id":"pipeline-orchestration-infrastructure"},{"level":4,"text":"Stage Interface Definitions","id":"stage-interface-definitions"},{"level":4,"text":"Cross-Stage Validation Logic","id":"cross-stage-validation-logic"},{"level":4,"text":"Error Propagation and Context Preservation","id":"error-propagation-and-context-preservation"},{"level":4,"text":"Milestone Checkpoints","id":"milestone-checkpoints"},{"level":3,"text":"Debugging Component Interactions","id":"debugging-component-interactions"},{"level":4,"text":"Pipeline Stage Isolation","id":"pipeline-stage-isolation"},{"level":4,"text":"Data Flow Visualization","id":"data-flow-visualization"},{"level":4,"text":"Common Integration Issues","id":"common-integration-issues"},{"level":2,"text":"Error Handling and Edge Cases","id":"error-handling-and-edge-cases"},{"level":3,"text":"Parse Error Recovery","id":"parse-error-recovery"},{"level":4,"text":"HTML Parse Error Recovery","id":"html-parse-error-recovery"},{"level":4,"text":"CSS Parse Error Recovery","id":"css-parse-error-recovery"},{"level":3,"text":"Layout Edge Cases","id":"layout-edge-cases"},{"level":4,"text":"Percentage and Auto Value Resolution","id":"percentage-and-auto-value-resolution"},{"level":4,"text":"Margin Collapsing Edge Cases","id":"margin-collapsing-edge-cases"},{"level":4,"text":"Box Model Constraint Conflicts","id":"box-model-constraint-conflicts"},{"level":3,"text":"Rendering Failure Modes","id":"rendering-failure-modes"},{"level":4,"text":"Graphics Backend Error Handling","id":"graphics-backend-error-handling"},{"level":4,"text":"Font Loading and Text Rendering Failures","id":"font-loading-and-text-rendering-failures"},{"level":4,"text":"Memory Management and Resource Limits","id":"memory-management-and-resource-limits"},{"level":4,"text":"Coordinate System and Overflow Handling","id":"coordinate-system-and-overflow-handling"},{"level":3,"text":"Error Recovery Integration Across Pipeline Stages","id":"error-recovery-integration-across-pipeline-stages"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"Technology Recommendations","id":"technology-recommendations"},{"level":4,"text":"Recommended File Structure","id":"recommended-file-structure"},{"level":4,"text":"Infrastructure Starter Code","id":"infrastructure-starter-code"},{"level":4,"text":"Core Logic Skeleton Code","id":"core-logic-skeleton-code"},{"level":4,"text":"Milestone Checkpoints","id":"milestone-checkpoints"},{"level":4,"text":"Debugging Tips","id":"debugging-tips"},{"level":2,"text":"Testing Strategy and Milestone Validation","id":"testing-strategy-and-milestone-validation"},{"level":3,"text":"Milestone Validation Checkpoints","id":"milestone-validation-checkpoints"},{"level":4,"text":"Milestone 1: HTML Parser Validation","id":"milestone-1-html-parser-validation"},{"level":4,"text":"Milestone 2: CSS Parser Validation","id":"milestone-2-css-parser-validation"},{"level":4,"text":"Milestone 3: Layout Engine Validation","id":"milestone-3-layout-engine-validation"},{"level":4,"text":"Milestone 4: Rendering Engine Validation","id":"milestone-4-rendering-engine-validation"},{"level":3,"text":"Integration Testing Strategy","id":"integration-testing-strategy"},{"level":4,"text":"Comprehensive Pipeline Testing","id":"comprehensive-pipeline-testing"},{"level":4,"text":"Cross-Component Error Propagation Testing","id":"cross-component-error-propagation-testing"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"Technology Recommendations","id":"technology-recommendations"},{"level":4,"text":"Recommended File Structure","id":"recommended-file-structure"},{"level":4,"text":"Test Infrastructure Starter Code","id":"test-infrastructure-starter-code"},{"level":4,"text":"Core Testing Skeleton Code","id":"core-testing-skeleton-code"},{"level":4,"text":"Milestone Checkpoint Validation","id":"milestone-checkpoint-validation"},{"level":2,"text":"Debugging Guide and Common Issues","id":"debugging-guide-and-common-issues"},{"level":3,"text":"HTML/CSS Parsing Issues","id":"htmlcss-parsing-issues"},{"level":4,"text":"HTML Tokenization Debugging","id":"html-tokenization-debugging"},{"level":4,"text":"DOM Tree Construction Debugging","id":"dom-tree-construction-debugging"},{"level":4,"text":"CSS Tokenization and Rule Parsing","id":"css-tokenization-and-rule-parsing"},{"level":4,"text":"Entity Decoding and Character Handling","id":"entity-decoding-and-character-handling"},{"level":3,"text":"Layout Calculation Problems","id":"layout-calculation-problems"},{"level":4,"text":"Box Model Calculation Issues","id":"box-model-calculation-issues"},{"level":4,"text":"Block Layout and Vertical Positioning","id":"block-layout-and-vertical-positioning"},{"level":4,"text":"Inline Layout and Text Flow","id":"inline-layout-and-text-flow"},{"level":4,"text":"Constraint Resolution and Edge Cases","id":"constraint-resolution-and-edge-cases"},{"level":3,"text":"Rendering and Visual Issues","id":"rendering-and-visual-issues"},{"level":4,"text":"Paint Command Generation Issues","id":"paint-command-generation-issues"},{"level":4,"text":"Graphics Backend Integration Problems","id":"graphics-backend-integration-problems"},{"level":4,"text":"Visual Debugging and Diagnostic Tools","id":"visual-debugging-and-diagnostic-tools"},{"level":4,"text":"Clipping and Viewport Management","id":"clipping-and-viewport-management"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"Technology Recommendations","id":"technology-recommendations"},{"level":4,"text":"Recommended File Structure","id":"recommended-file-structure"},{"level":4,"text":"Error Reporting Infrastructure","id":"error-reporting-infrastructure"},{"level":4,"text":"HTML/CSS Parse Debugging Tools","id":"htmlcss-parse-debugging-tools"},{"level":4,"text":"Layout Debugging Infrastructure","id":"layout-debugging-infrastructure"},{"level":4,"text":"Rendering Pipeline Diagnostics","id":"rendering-pipeline-diagnostics"},{"level":4,"text":"Milestone Validation Checkpoints","id":"milestone-validation-checkpoints"},{"level":2,"text":"Future Extensions and Advanced Features","id":"future-extensions-and-advanced-features"},{"level":3,"text":"Advanced CSS Features","id":"advanced-css-features"},{"level":4,"text":"Flexbox Layout Implementation","id":"flexbox-layout-implementation"},{"level":4,"text":"CSS Grid Layout System","id":"css-grid-layout-system"},{"level":4,"text":"CSS Transforms and 3D Positioning","id":"css-transforms-and-3d-positioning"},{"level":4,"text":"CSS Animations and Transitions","id":"css-animations-and-transitions"},{"level":3,"text":"Performance and Scalability","id":"performance-and-scalability"},{"level":4,"text":"Incremental Rendering Architecture","id":"incremental-rendering-architecture"},{"level":4,"text":"Layout Caching and Optimization","id":"layout-caching-and-optimization"},{"level":4,"text":"Multi-threaded Processing Architecture","id":"multi-threaded-processing-architecture"},{"level":4,"text":"Memory Management and Resource Optimization","id":"memory-management-and-resource-optimization"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"Technology Recommendations","id":"technology-recommendations"},{"level":4,"text":"Recommended File Structure Extension","id":"recommended-file-structure-extension"},{"level":4,"text":"Flexbox Implementation Starter Code","id":"flexbox-implementation-starter-code"},{"level":4,"text":"Animation System Infrastructure","id":"animation-system-infrastructure"},{"level":4,"text":"Incremental Rendering Infrastructure","id":"incremental-rendering-infrastructure"},{"level":4,"text":"Performance Monitoring and Profiling","id":"performance-monitoring-and-profiling"},{"level":4,"text":"Milestone Checkpoints for Advanced Features","id":"milestone-checkpoints-for-advanced-features"},{"level":2,"text":"Glossary and Technical Reference","id":"glossary-and-technical-reference"},{"level":3,"text":"Mental Model: The Technical Translator","id":"mental-model-the-technical-translator"},{"level":3,"text":"Core Architecture Terms","id":"core-architecture-terms"},{"level":3,"text":"HTML Parsing and DOM Terms","id":"html-parsing-and-dom-terms"},{"level":3,"text":"CSS Parsing and Style Terms","id":"css-parsing-and-style-terms"},{"level":3,"text":"Layout and Box Model Terms","id":"layout-and-box-model-terms"},{"level":3,"text":"Rendering and Graphics Terms","id":"rendering-and-graphics-terms"},{"level":3,"text":"Error Handling and Recovery Terms","id":"error-handling-and-recovery-terms"},{"level":3,"text":"Data Structure and Type System Terms","id":"data-structure-and-type-system-terms"},{"level":3,"text":"Debugging and Development Terms","id":"debugging-and-development-terms"},{"level":3,"text":"Advanced Features and Extensions","id":"advanced-features-and-extensions"},{"level":3,"text":"Performance and Optimization Terms","id":"performance-and-optimization-terms"},{"level":3,"text":"Implementation and Development Terms","id":"implementation-and-development-terms"},{"level":3,"text":"Constants and Enumerations","id":"constants-and-enumerations"},{"level":3,"text":"Relationships and Dependencies","id":"relationships-and-dependencies"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"}],"title":"Build Your Own Browser Engine: Design Document","markdown":"# Build Your Own Browser Engine: Design Document\n\n\n## Overview\n\nThis system implements a simplified web browser engine that parses HTML and CSS, computes layout using the CSS box model, and renders web pages to a visual canvas. The key architectural challenge is building a multi-stage pipeline that transforms textual markup into positioned visual elements while handling the complex interactions between HTML structure, CSS styling, and geometric layout algorithms.\n\n\n> This guide is meant to help you understand the big picture before diving into each milestone. Refer back to it whenever you need context on how components connect.\n\n\n## Context and Problem Statement\n\n> **Milestone(s):** All milestones (1-4) - This section establishes the foundational understanding needed throughout the entire project.\n\nWeb browsers are among the most sophisticated software systems ever created, rivaling operating systems in their complexity and scope. Every time you load a web page, your browser performs an intricate dance of parsing, computation, and rendering that transforms static markup text into a rich, interactive visual experience. Understanding why this process is so complex—and how we can build a simplified version—requires us to appreciate both the technical challenges involved and the architectural approaches that have evolved to address them.\n\nThe fundamental challenge of web rendering lies in the gap between two very different representations of the same content. On one side, we have textual markup languages (HTML and CSS) that describe content structure and visual styling in human-readable form. On the other side, we need pixel-perfect visual output displayed on screens with specific dimensions, colors, and fonts. Bridging this gap requires solving multiple interconnected problems: parsing complex, often malformed markup languages; resolving cascading style rules with intricate precedence hierarchies; computing geometric layouts that satisfy dozens of interacting constraints; and finally rendering visual elements with precise positioning, typography, and graphics.\n\nThe complexity multiplies when we consider that web standards have evolved organically over decades, accumulating layers of backward compatibility, edge cases, and subtle interactions between features. A complete browser engine must handle thousands of CSS properties, dozens of HTML elements with unique behaviors, complex text rendering across multiple languages and scripts, and sophisticated graphics operations—all while maintaining performance standards that allow smooth interaction with dynamic content.\n\n### Mental Model: The Document Assembly Line\n\nThink of a browser engine as a sophisticated **document assembly line**, similar to a modern printing press operation. Just as a printing press transforms a manuscript through multiple specialized stations—typesetting, layout, ink preparation, and final printing—a browser transforms HTML and CSS through distinct processing stages, each with its own specialized machinery and expertise.\n\nIn our assembly line analogy, the raw HTML and CSS files arrive as **unprocessed manuscripts**—readable to humans but not yet ready for final output. The first station on our assembly line is the **tokenization workshop**, where skilled workers (our HTML and CSS parsers) break down the manuscript into individual components: headings, paragraphs, style declarations, and formatting instructions. These workers are trained to handle messy, incomplete manuscripts gracefully—they can infer missing punctuation, correct common mistakes, and organize chaotic input into clean, structured components.\n\nThe tokenized components then move to the **composition department** (our styling system), where layout specialists match each piece of content with its formatting instructions. This is where the CSS cascade resolution happens—imagine expert typesetters consulting multiple style guides simultaneously, applying rules about font selection, spacing, and positioning while resolving conflicts between competing style requirements. The output of this stage is a fully annotated manuscript where every element knows exactly how it should look.\n\nNext comes the **layout workshop** (our layout engine), where spatial engineers calculate the precise positioning and dimensions of every element. This is analogous to the page layout artists in a printing house who determine where each paragraph, image, and heading will appear on the final page. They must consider complex constraints: available page dimensions, text flow around images, margin requirements, and the intricate interactions between nested elements. Unlike simple document layout, web layout must handle dynamic content where the size of one element can affect the positioning of all others.\n\nFinally, our assembly line reaches the **printing press** (our rendering engine), where the carefully planned layout gets translated into actual visual output. Modern printing presses don't just apply ink to paper—they manage multiple color separations, ensure precise registration, and optimize the printing sequence for efficiency. Similarly, our rendering engine doesn't just draw pixels—it manages layered graphics operations, handles text rendering with proper font selection and anti-aliasing, and optimizes drawing commands for graphics hardware.\n\nThe critical insight of this assembly line model is that **each station specializes in one transformation** and passes its output to the next station in a standardized format. The HTML parser doesn't need to understand visual styling—it focuses entirely on creating a clean structural representation. The layout engine doesn't concern itself with parsing—it works with pre-processed style information. This separation of concerns allows each component to be optimized for its specific task while maintaining a clear data flow through the pipeline.\n\nHowever, unlike a physical assembly line, our browser engine must handle **bidirectional dependencies**. Sometimes the layout engine discovers that text doesn't fit in the allocated space and needs to request line breaking from the text processing system. Sometimes the rendering engine needs to trigger additional layout calculations for elements that depend on the actual rendered size of text. These feedback loops add significant complexity compared to a simple linear pipeline.\n\n### Existing Browser Engine Approaches\n\nModern browser engines have converged on remarkably similar high-level architectures, but they differ significantly in their implementation strategies, performance optimizations, and internal data structures. Understanding these approaches helps us make informed decisions about our own simplified engine while appreciating the engineering challenges that led to current designs.\n\n**Blink (Chrome/Chromium)** represents the current state-of-the-art in browser engine architecture. Blink evolved from WebKit but has been extensively restructured to support Chrome's multi-process architecture and performance requirements. Its approach emphasizes **incremental processing** and **parallel execution** wherever possible. The Blink HTML parser operates incrementally, processing chunks of HTML as they arrive over the network rather than waiting for the complete document. This allows the browser to start building the DOM and even begin layout calculations while the page is still loading.\n\nBlink's styling system uses a **rule-based cascade resolver** that pre-computes style matching for common patterns, maintaining cache tables that map element types and classes to their most frequently applied styles. This optimization is crucial for large, dynamic web applications where style recalculation can become a performance bottleneck. The layout system in Blink has been redesigned around the concept of **layout fragments**—self-contained layout computations that can be cached and reused when content changes, avoiding the need to recalculate layout for the entire document tree.\n\n**WebKit (Safari)** takes a more conservative approach, prioritizing **correctness and standards compliance** over aggressive optimization. WebKit's architecture maintains cleaner separation between components, with well-defined interfaces that make the codebase more maintainable but potentially less optimized for specific use cases. WebKit's HTML parser emphasizes **robust error recovery**, implementing the HTML5 parsing specification more literally than other engines. This leads to more predictable behavior with malformed HTML but can be slower for documents that require extensive error correction.\n\nThe WebKit styling system uses a **selector matching engine** that favors memory efficiency over raw speed, making it well-suited for resource-constrained environments like mobile devices. WebKit's layout engine implements a **traditional box model calculator** that closely follows CSS specifications, with fewer optimizations but more predictable behavior across different content types. This approach makes WebKit an excellent reference implementation for understanding how web standards should behave.\n\n**Gecko (Firefox)** represents a unique approach that emphasizes **extensibility and modularity**. Gecko's architecture was designed from the ground up to support Mozilla's vision of a customizable, open web platform. The Gecko HTML parser includes sophisticated **namespace handling** and **XML compatibility** features that other engines have simplified or removed. This makes Gecko excellent at handling complex, standards-compliant documents but adds overhead for simple HTML pages.\n\nGecko's styling system pioneered several features that other engines later adopted, including **CSS custom properties** (CSS variables) and advanced **selector performance optimizations**. The Gecko layout engine uses a **frame-based architecture** where each element in the DOM can have multiple associated layout frames representing different aspects of its visual representation (content, background, borders). This approach provides flexibility for complex layouts but requires more memory and careful coordination between frames.\n\n> **Decision: Architecture Pattern Selection**\n> - **Context**: We need to choose an architectural approach that balances implementation complexity with educational value while remaining feasible for a learning project.\n> - **Options Considered**: \n>   - Blink-style incremental processing with aggressive optimization\n>   - WebKit-style conservative correctness-first approach\n>   - Gecko-style modular extensible architecture\n> - **Decision**: WebKit-style conservative approach with simplified components\n> - **Rationale**: The conservative approach provides the clearest learning path with predictable behavior and direct mapping to web standards. Aggressive optimizations obscure the fundamental algorithms we want to learn, while excessive modularity adds complexity without educational benefit for a beginner project.\n> - **Consequences**: Our engine will be slower and use more memory than production browsers, but the code will be much easier to understand, debug, and extend. The direct mapping to standards makes it easier to verify correctness against reference implementations.\n\nThe following table compares the key architectural decisions across major browser engines:\n\n| Aspect | Blink (Chrome) | WebKit (Safari) | Gecko (Firefox) | Our Approach |\n|--------|----------------|-----------------|-----------------|--------------|\n| **Parsing Strategy** | Incremental, network-aware | Batch processing, robust error recovery | Standards-compliant with XML support | Simple batch processing |\n| **Style Resolution** | Cached rule matching, performance-optimized | Memory-efficient selector matching | Extensible with custom properties | Direct cascade implementation |\n| **Layout Algorithm** | Fragment-based with caching | Traditional box model, spec-compliant | Frame-based multi-representation | Simplified box model |\n| **Rendering Pipeline** | Multi-threaded, GPU-accelerated | Single-threaded, CPU-focused | Modular with plugin support | Single-threaded, simple graphics |\n| **Error Handling** | Pragmatic recovery for performance | Thorough spec compliance | Standards-first with graceful degradation | Basic recovery with clear failure modes |\n| **Memory Strategy** | Aggressive optimization, complex lifecycle | Conservative allocation, predictable cleanup | Modular ownership, garbage collection | Simple ownership, explicit cleanup |\n\nEach engine makes different trade-offs based on their target environments and priorities. Blink optimizes for the **performance demands of modern web applications**, accepting implementation complexity in exchange for speed. WebKit balances **standards compliance with resource efficiency**, making it ideal for mobile and embedded environments. Gecko prioritizes **extensibility and correctness**, supporting advanced web standards even when they're rarely used.\n\nFor our educational browser engine, we'll adopt a **simplified WebKit-inspired approach** that emphasizes clarity and correctness over performance. This means implementing the CSS cascade and box model calculations directly from the specifications, using straightforward data structures that map clearly to the concepts we're learning, and handling errors in predictable ways that make debugging easier.\n\nThe key insight from studying existing browser engines is that **architecture decisions have cascading effects throughout the system**. Choosing incremental parsing affects how the styling system receives DOM updates. Selecting a particular layout caching strategy influences how the rendering system must handle invalidation. Understanding these interconnections helps us make consistent architectural choices that work well together rather than optimizing individual components in isolation.\n\n> The most important lesson from existing browser engines is that **simplicity in individual components enables sophistication in their interactions**. Rather than building complex, highly-optimized individual parsers or layout algorithms, we'll focus on clean interfaces and predictable data flow between components. This approach makes the overall system more understandable while still demonstrating the fundamental principles that drive all modern browser engines.\n\n### Implementation Guidance\n\nThis implementation guidance provides the foundational setup and architectural patterns you'll use throughout all four milestones of the browser engine project.\n\n**A. Technology Recommendations:**\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| **HTML/CSS Parsing** | Hand-written recursive descent parser | Parser generator (nom, pest, lalrpop) |\n| **String Handling** | Rust `String` and `str` with basic tokenization | Specialized string interning and rope data structures |\n| **DOM Storage** | `Vec<Node>` with index-based references | Arena allocation with typed indices |\n| **Graphics Backend** | Software rendering to pixel buffer | Hardware-accelerated rendering (wgpu, OpenGL) |\n| **Text Rendering** | Basic bitmap fonts, single font family | Full font subsystem with fallbacks (rusttype, fontdue) |\n| **Error Handling** | Simple `Result<T, String>` with descriptive messages | Structured error types with error chains |\n\n**B. Recommended File Structure:**\n\nThe modular architecture maps directly to the filesystem organization, making it easy to understand component boundaries and dependencies:\n\n```\nbrowser-engine/\n├── src/\n│   ├── main.rs                    ← Entry point and CLI interface\n│   ├── lib.rs                     ← Public API exports\n│   │\n│   ├── html/                      ← HTML parsing (Milestone 1)\n│   │   ├── mod.rs                 ← Public interface\n│   │   ├── tokenizer.rs           ← HTML tokenization\n│   │   ├── parser.rs              ← DOM tree construction\n│   │   └── dom.rs                 ← DOM node types and tree operations\n│   │\n│   ├── css/                       ← CSS parsing and styling (Milestone 2)\n│   │   ├── mod.rs                 ← Public interface\n│   │   ├── tokenizer.rs           ← CSS tokenization\n│   │   ├── parser.rs              ← CSS rule parsing\n│   │   ├── selector.rs            ← Selector matching and specificity\n│   │   └── style.rs               ← Style resolution and cascade\n│   │\n│   ├── layout/                    ← Layout engine (Milestone 3)\n│   │   ├── mod.rs                 ← Public interface\n│   │   ├── box_model.rs           ← Box model calculations\n│   │   ├── block.rs               ← Block formatting context\n│   │   ├── inline.rs              ← Inline formatting context\n│   │   └── tree.rs                ← Layout tree construction\n│   │\n│   ├── render/                    ← Rendering engine (Milestone 4)\n│   │   ├── mod.rs                 ← Public interface\n│   │   ├── paint.rs               ← Paint command generation\n│   │   ├── canvas.rs              ← Graphics backend abstraction\n│   │   └── display_list.rs        ← Display list optimization\n│   │\n│   └── common/                    ← Shared utilities\n│       ├── mod.rs                 ← Public interface\n│       ├── geometry.rs            ← Rectangle, Point, Size types\n│       ├── color.rs               ← Color representation and parsing\n│       └── units.rs               ← CSS unit handling (px, %, em)\n│\n├── tests/                         ← Integration tests\n│   ├── parsing_tests.rs           ← End-to-end HTML/CSS parsing\n│   ├── layout_tests.rs            ← Layout calculation verification\n│   └── render_tests.rs            ← Visual output validation\n│\n└── examples/                      ← Example HTML files for testing\n    ├── simple.html                ← Basic HTML structure\n    ├── styled.html                ← HTML with CSS styling\n    └── complex.html               ← Complex layout examples\n```\n\n**C. Infrastructure Starter Code:**\n\nHere's the complete foundational infrastructure you can copy and use immediately, allowing you to focus on the core browser engine algorithms:\n\n```rust\n// src/common/geometry.rs - Complete geometric types\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Point {\n    pub x: f32,\n    pub y: f32,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Size {\n    pub width: f32,\n    pub height: f32,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Rectangle {\n    pub origin: Point,\n    pub size: Size,\n}\n\nimpl Rectangle {\n    pub fn new(x: f32, y: f32, width: f32, height: f32) -> Self {\n        Rectangle {\n            origin: Point { x, y },\n            size: Size { width, height },\n        }\n    }\n    \n    pub fn contains_point(&self, point: Point) -> bool {\n        point.x >= self.origin.x \n            && point.x <= self.origin.x + self.size.width\n            && point.y >= self.origin.y \n            && point.y <= self.origin.y + self.size.height\n    }\n    \n    pub fn intersects(&self, other: &Rectangle) -> bool {\n        !(other.origin.x > self.origin.x + self.size.width\n            || other.origin.x + other.size.width < self.origin.x\n            || other.origin.y > self.origin.y + self.size.height\n            || other.origin.y + other.size.height < self.origin.y)\n    }\n}\n\n// src/common/color.rs - Complete color handling\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Color {\n    pub r: u8,\n    pub g: u8,\n    pub b: u8,\n    pub a: u8,\n}\n\nimpl Color {\n    pub const WHITE: Color = Color { r: 255, g: 255, b: 255, a: 255 };\n    pub const BLACK: Color = Color { r: 0, g: 0, b: 0, a: 255 };\n    pub const TRANSPARENT: Color = Color { r: 0, g: 0, b: 0, a: 0 };\n    \n    pub fn rgb(r: u8, g: u8, b: u8) -> Self {\n        Color { r, g, b, a: 255 }\n    }\n    \n    pub fn rgba(r: u8, g: u8, b: u8, a: u8) -> Self {\n        Color { r, g, b, a }\n    }\n    \n    pub fn from_hex(hex: &str) -> Result<Self, String> {\n        let hex = hex.trim_start_matches('#');\n        if hex.len() != 6 {\n            return Err(format!(\"Invalid hex color length: {}\", hex));\n        }\n        \n        let r = u8::from_str_radix(&hex[0..2], 16)\n            .map_err(|_| format!(\"Invalid hex color: {}\", hex))?;\n        let g = u8::from_str_radix(&hex[2..4], 16)\n            .map_err(|_| format!(\"Invalid hex color: {}\", hex))?;\n        let b = u8::from_str_radix(&hex[4..6], 16)\n            .map_err(|_| format!(\"Invalid hex color: {}\", hex))?;\n            \n        Ok(Color::rgb(r, g, b))\n    }\n}\n\n// src/common/units.rs - Complete CSS unit handling\n#[derive(Debug, Clone, Copy, PartialEq)]\npub enum Unit {\n    Px(f32),           // Absolute pixels\n    Percent(f32),      // Percentage of parent\n    Em(f32),          // Relative to font size\n    Auto,             // Automatic sizing\n}\n\nimpl Unit {\n    pub fn to_px(&self, parent_value: f32, font_size: f32) -> f32 {\n        match self {\n            Unit::Px(value) => *value,\n            Unit::Percent(percent) => parent_value * percent / 100.0,\n            Unit::Em(ems) => font_size * ems,\n            Unit::Auto => 0.0, // Auto resolution happens in layout\n        }\n    }\n    \n    pub fn parse(input: &str) -> Result<Self, String> {\n        let input = input.trim();\n        if input == \"auto\" {\n            return Ok(Unit::Auto);\n        }\n        \n        if input.ends_with(\"px\") {\n            let value = input[..input.len()-2].parse::<f32>()\n                .map_err(|_| format!(\"Invalid px value: {}\", input))?;\n            Ok(Unit::Px(value))\n        } else if input.ends_with('%') {\n            let value = input[..input.len()-1].parse::<f32>()\n                .map_err(|_| format!(\"Invalid % value: {}\", input))?;\n            Ok(Unit::Percent(value))\n        } else if input.ends_with(\"em\") {\n            let value = input[..input.len()-2].parse::<f32>()\n                .map_err(|_| format!(\"Invalid em value: {}\", input))?;\n            Ok(Unit::Em(value))\n        } else {\n            // Default to pixels for bare numbers\n            let value = input.parse::<f32>()\n                .map_err(|_| format!(\"Invalid unit value: {}\", input))?;\n            Ok(Unit::Px(value))\n        }\n    }\n}\n```\n\n**D. Core Pipeline Skeleton:**\n\nThis skeleton shows the main pipeline flow that connects all four milestones. You'll implement each `TODO` section as you progress through the milestones:\n\n```rust\n// src/lib.rs - Main browser engine pipeline\nuse crate::html::{DOMNode, HTMLParser};\nuse crate::css::{Stylesheet, StyleResolver};\nuse crate::layout::{LayoutTree, LayoutEngine};\nuse crate::render::{DisplayList, RenderEngine};\nuse crate::common::{Rectangle, Color};\n\npub struct BrowserEngine {\n    viewport_size: Rectangle,\n}\n\nimpl BrowserEngine {\n    pub fn new(viewport_width: f32, viewport_height: f32) -> Self {\n        BrowserEngine {\n            viewport_size: Rectangle::new(0.0, 0.0, viewport_width, viewport_height),\n        }\n    }\n    \n    /// Complete rendering pipeline from HTML/CSS to visual output\n    pub fn render_page(&self, html: &str, css: &str) -> Result<Vec<u8>, String> {\n        // TODO Milestone 1: Parse HTML into DOM tree\n        let dom_tree = HTMLParser::parse(html)?;\n        \n        // TODO Milestone 2: Parse CSS and resolve styles for each DOM node\n        let stylesheet = Stylesheet::parse(css)?;\n        let style_resolver = StyleResolver::new(stylesheet);\n        let styled_tree = style_resolver.resolve_styles(&dom_tree)?;\n        \n        // TODO Milestone 3: Calculate layout - position and size every element\n        let layout_engine = LayoutEngine::new(self.viewport_size);\n        let layout_tree = layout_engine.calculate_layout(&styled_tree)?;\n        \n        // TODO Milestone 4: Generate paint commands and render to pixel buffer\n        let render_engine = RenderEngine::new(self.viewport_size);\n        let display_list = render_engine.generate_display_list(&layout_tree)?;\n        let pixel_buffer = render_engine.paint_to_buffer(&display_list)?;\n        \n        Ok(pixel_buffer)\n    }\n}\n\n// src/main.rs - CLI interface for testing\nuse browser_engine::BrowserEngine;\nuse std::fs;\n\nfn main() -> Result<(), Box<dyn std::error::Error>> {\n    let args: Vec<String> = std::env::args().collect();\n    if args.len() < 3 {\n        println!(\"Usage: {} <html_file> <css_file>\", args[0]);\n        return Ok(());\n    }\n    \n    let html = fs::read_to_string(&args[1])?;\n    let css = fs::read_to_string(&args[2])?;\n    \n    let engine = BrowserEngine::new(800.0, 600.0);\n    let pixel_buffer = engine.render_page(&html, &css)?;\n    \n    // TODO: Save pixel_buffer as PNG or display in window\n    println!(\"Rendered page to {} bytes\", pixel_buffer.len());\n    Ok(())\n}\n```\n\n**E. Language-Specific Hints for Rust:**\n\n- **Error Handling**: Use `Result<T, String>` for simplicity initially, then create custom error types as your engine grows more sophisticated.\n- **String Processing**: Rust's `&str` and `String` are excellent for parsing. Use `chars().peekable()` for lookahead during tokenization.\n- **Memory Management**: Start with `Vec<T>` and `Box<T>` for tree structures. Arena allocation (`typed-arena` crate) can optimize later.\n- **Collections**: `HashMap<String, Value>` works well for CSS properties and DOM attributes. Use `BTreeMap` if you need ordered iteration.\n- **Parsing Libraries**: For hand-written parsers, `std::str::Chars` with `peek()` handles most cases. The `nom` crate provides combinator-style parsing if you prefer.\n- **Graphics**: Start with a simple `Vec<u8>` pixel buffer (4 bytes per pixel: RGBA). Later, consider `image` crate for file I/O and `raqote` for 2D graphics.\n\n**F. Milestone Checkpoints:**\n\nAfter each milestone, you should be able to run these verification commands:\n\n**Milestone 1 Checkpoint:**\n```bash\ncargo test html_parser_tests\necho '<div>Hello <span>World</span></div>' | cargo run --bin parse_html\n```\nExpected: DOM tree printed showing div containing text \"Hello \" and span containing text \"World\".\n\n**Milestone 2 Checkpoint:**\n```bash\ncargo test css_parser_tests\ncargo run --bin browser examples/simple.html examples/simple.css\n```\nExpected: Styled tree showing computed styles (color, font-size, etc.) for each DOM element.\n\n**Milestone 3 Checkpoint:**\n```bash\ncargo test layout_tests\ncargo run --bin browser examples/layout.html examples/layout.css\n```\nExpected: Layout tree with computed positions and dimensions for all elements in viewport coordinates.\n\n**Milestone 4 Checkpoint:**\n```bash\ncargo test render_tests\ncargo run --bin browser examples/complete.html examples/complete.css\n```\nExpected: PNG image file generated showing rendered webpage with correct colors, text, and positioning.\n\n**G. Debugging Tips:**\n\n| **Symptom** | **Likely Cause** | **How to Diagnose** | **Fix** |\n|-------------|------------------|-------------------|---------|\n| Parser panics on valid HTML | Tokenizer state machine bug | Add debug prints to tokenizer state transitions | Check state machine logic against HTML5 spec |\n| DOM tree has wrong structure | Tree construction algorithm error | Print DOM tree after parsing, compare to expected structure | Verify parent-child relationship logic |\n| CSS rules don't match elements | Selector matching bug | Print all selectors and which elements they match | Check selector syntax parsing and element matching |\n| Elements appear in wrong positions | Box model calculation error | Print computed dimensions for each element | Verify margin/border/padding calculations |\n| Text doesn't render | Font or text rendering issue | Check if text paint commands are generated correctly | Verify font loading and text measurement |\n| Performance is very slow | Inefficient algorithms or data structures | Profile with `cargo flamegraph` | Optimize hot paths, consider better data structures |\n\nThe key to successful debugging is **building verification into each milestone**. Don't wait until the end to test—verify each component works correctly before moving to the next one. This modular approach makes it much easier to isolate and fix problems as they arise.\n\n\n## Goals and Non-Goals\n\n> **Milestone(s):** All milestones (1-4) - This section establishes the foundational scope that guides implementation decisions throughout the entire project.\n\nBuilding a complete web browser engine is an extraordinarily complex undertaking that involves hundreds of specifications, millions of lines of code, and decades of accumulated engineering knowledge. Modern browsers like Chrome and Firefox represent some of the most sophisticated software systems ever created, handling everything from JavaScript execution and WebGL graphics to complex security models and performance optimizations. To make this project achievable for learning purposes, we must carefully define what our browser engine will and will not attempt to implement.\n\nThink of our approach like building a scale model of a skyscraper rather than the full structure. A scale model captures the essential architectural principles, demonstrates the core engineering concepts, and provides a complete end-to-end experience, but it deliberately omits the complex mechanical systems, detailed interior design, and industrial-grade materials that would be required for a production building. Similarly, our browser engine will implement the fundamental rendering pipeline that transforms HTML and CSS into visual output, but it will exclude the advanced features that would require years of development effort.\n\nThe key insight behind this scoping decision is that the core learning value comes from understanding how browsers parse textual markup, apply styling rules, compute geometric layout, and generate visual output. These fundamental concepts remain the same whether you're rendering a simple webpage with basic styling or a complex web application with animations and interactive features. By focusing on the essential rendering pipeline, we can build a complete, working browser engine that demonstrates all the major architectural patterns while keeping the implementation manageable.\n\n### Core Goals\n\nOur browser engine must implement the complete rendering pipeline from raw HTML and CSS text to visual output displayed on screen. This pipeline represents the fundamental operation that every web browser performs millions of times per day, and understanding each stage provides deep insight into how modern web technologies work under the hood.\n\nThe following table outlines the essential features our browser engine must implement to successfully render basic web pages:\n\n| Feature Category | Specific Requirements | Learning Value |\n|------------------|----------------------|-----------------|\n| HTML Document Parsing | Parse HTML text into a structured DOM tree with proper parent-child relationships | Understanding tokenization algorithms and tree construction patterns |\n| CSS Stylesheet Processing | Parse CSS rules, calculate selector specificity, and apply the cascade to determine computed styles | Learning rule-based systems and priority resolution algorithms |\n| Geometric Layout Calculation | Implement the CSS box model to compute element positions and dimensions | Understanding constraint-solving and 2D layout algorithms |\n| Visual Rendering Output | Generate paint commands and draw backgrounds, borders, and text to a canvas | Learning graphics programming and display pipeline concepts |\n\n**HTML Document Structure Processing** forms the foundation of our rendering pipeline. Our browser engine must implement a tokenizer that can parse HTML text and identify start tags, end tags, attributes, self-closing elements, and text content. The tokenizer feeds into a tree construction algorithm that builds a hierarchical DOM tree representing the document structure. This DOM tree serves as the input for all subsequent processing stages.\n\nThe tokenization process must handle the complexities of HTML syntax, including attribute parsing with both quoted and unquoted values, self-closing tags like `<br>` and `<img>`, and proper nesting validation. The tree construction algorithm uses a stack-based approach to maintain the current element context and build correct parent-child relationships even when encountering malformed markup.\n\n**CSS Styling and Cascade Resolution** represents the second major component of our browser engine. The CSS parser must tokenize stylesheet text and extract selectors, property names, and property values. Our implementation must support the fundamental selector types: tag selectors (`div`), class selectors (`.header`), ID selectors (`#main`), and basic combinators for descendant relationships.\n\nThe cascade resolution algorithm implements the CSS specificity calculation that determines which styles apply when multiple rules target the same element. Our engine computes specificity as a four-tuple (inline styles, ID count, class count, tag count) and resolves conflicts by applying the most specific rule. This process produces computed styles for every element in the DOM tree.\n\n**Box Model Layout Computation** transforms the styled DOM tree into a layout tree containing the geometric information needed for visual rendering. Our layout engine must implement the CSS box model, computing content dimensions, padding, borders, and margins for each element. The layout algorithm handles both block formatting context (vertical stacking of block elements) and inline formatting context (horizontal flow of text and inline elements).\n\nThe layout computation must resolve auto values, handle percentage-based dimensions, and implement margin collapsing between adjacent block elements. The output is a layout tree where each node contains a `Rectangle` specifying its position and dimensions in viewport coordinates.\n\n**Visual Paint Generation and Rendering** completes the rendering pipeline by traversing the layout tree and generating an ordered sequence of paint commands. Our rendering engine must handle background color painting, border drawing with proper line widths and colors, and text rendering with correct font sizing and positioning.\n\nThe paint generation algorithm ensures correct z-ordering by processing elements in document order and handling overlapping elements appropriately. The final output is either a raster image buffer or direct drawing to a graphics canvas that can be displayed in a window or saved to a file.\n\n> **Design Principle**: Our browser engine prioritizes correctness and clarity over performance optimization. Every component should implement the specification accurately, even if the result is slower than production browsers. The goal is learning the algorithms, not competing with Chrome's rendering speed.\n\n### Explicit Non-Goals\n\nTo keep our browser engine implementation achievable within a reasonable timeframe, we deliberately exclude numerous advanced features that would significantly increase complexity without proportional learning value. These exclusions are not limitations of our approach but rather conscious decisions to focus on the core rendering pipeline concepts.\n\nThe following table documents the major browser features we explicitly choose not to implement:\n\n| Excluded Feature Category | Specific Exclusions | Complexity Reason |\n|---------------------------|-------------------|-------------------|\n| JavaScript Execution | Script parsing, V8 integration, DOM manipulation APIs | Requires a complete language runtime with garbage collection, JIT compilation, and security sandboxing |\n| Advanced CSS Properties | Flexbox, CSS Grid, transforms, animations, media queries | Each represents a complete layout system requiring thousands of lines of specification-compliant code |\n| Network and Resource Loading | HTTP requests, image loading, font loading, caching | Requires asynchronous I/O, protocol implementations, and resource management systems |\n| User Interaction and Events | Mouse handling, keyboard input, form processing, scrolling | Requires event system architecture and stateful interaction management |\n| Browser Chrome and UI | Address bar, bookmarks, tabs, developer tools, preferences | Represents a complete application framework separate from the rendering engine |\n\n**JavaScript Engine Integration** represents perhaps the largest excluded feature category. Modern browsers include complete JavaScript runtimes with virtual machines, just-in-time compilers, garbage collectors, and extensive APIs for DOM manipulation. Integrating JavaScript execution would require implementing or embedding a language runtime, creating bindings between JavaScript objects and DOM elements, and handling the complex security model that prevents malicious scripts from accessing sensitive system resources.\n\nThe JavaScript exclusion also eliminates the need for dynamic DOM modification, event handling, and asynchronous script loading. While these features are essential for modern web applications, they operate on top of the fundamental rendering pipeline we're building. A solid understanding of HTML parsing, CSS styling, and layout computation provides the foundation needed to later add JavaScript integration.\n\n**Advanced CSS Layout Systems** like Flexbox and CSS Grid represent complete layout algorithms that rival our entire project in complexity. Flexbox alone involves multiple layout passes, complex constraint solving for flexible dimensions, and intricate algorithms for distributing space among flex items. CSS Grid adds two-dimensional layout capabilities with explicit grid tracks, implicit grid creation, and sophisticated alignment properties.\n\nSimilarly, CSS transforms and animations require matrix mathematics, interpolation algorithms, and integration with the browser's compositor for smooth visual effects. Media queries introduce responsive design capabilities but require a conditional styling system that evaluates viewport dimensions and device capabilities.\n\n> **Decision: Focus on Block and Inline Layout Only**\n> - **Context**: CSS defines numerous layout modes including block, inline, flexbox, grid, table, and positioning schemes\n> - **Options Considered**: \n>   1. Implement all major layout modes for complete CSS compatibility\n>   2. Focus only on block and inline layout as foundational systems\n>   3. Implement flexbox as the most commonly used modern layout system\n> - **Decision**: Implement only block and inline formatting contexts\n> - **Rationale**: Block and inline layout represent the fundamental CSS layout concepts that underpin all other systems. Understanding how block elements stack vertically and how inline elements flow horizontally provides the foundation for comprehending more advanced layout modes. These two systems also cover the majority of basic web page layouts.\n> - **Consequences**: Our browser can render most simple web pages but cannot handle modern responsive designs or complex application layouts. However, the layout engine architecture we build can be extended to support additional formatting contexts.\n\n**Network Resource Loading** encompasses HTTP protocol implementation, DNS resolution, TLS/SSL encryption, caching strategies, and asynchronous resource management. Modern browsers maintain connection pools, implement HTTP/2 multiplexing, handle cookies and authentication, and provide sophisticated caching layers that store resources across browsing sessions.\n\nImage and font loading add additional complexity with format-specific decoders (JPEG, PNG, SVG for images; TrueType, OpenType, WOFF for fonts), color space management, and memory management for large media files. Our browser engine sidesteps these challenges by accepting HTML and CSS as strings and using system fonts for text rendering.\n\n**User Interaction and Event Systems** require stateful management of input devices, hit testing algorithms to determine which elements receive events, and complex event propagation models that bubble events up the DOM tree. Form processing adds validation, submission handling, and input element state management.\n\nScrolling functionality requires viewport management, overflow handling, and smooth animation systems that update layout and rendering at 60 frames per second. These interaction features, while essential for usable browsers, operate on top of the static rendering pipeline we're implementing.\n\n**Browser Application Framework** features like tabbed browsing, bookmarks, history management, and preferences represent a complete desktop or mobile application built around the rendering engine core. Developer tools require debugging APIs, performance profilers, and interactive inspection capabilities that expose the internal state of our rendering pipeline.\n\nSecurity features like same-origin policy enforcement, content security policy evaluation, and sandboxed iframe execution require deep integration between the JavaScript engine, network layer, and rendering system. These cross-cutting concerns significantly complicate every component of the browser architecture.\n\n> **Key Insight**: The features we exclude are not simpler versions of what we're building—they're entirely different problem domains. JavaScript execution is a language implementation challenge. Network loading is a distributed systems challenge. User interaction is a human-computer interface challenge. By focusing solely on the rendering pipeline, we can master one problem domain thoroughly rather than implementing multiple systems superficially.\n\nThe boundaries we've established create a clean separation between our browser engine and the surrounding application environment. Our engine accepts HTML and CSS strings as input and produces visual output as a raster image or display commands. This interface design means that our rendering engine could theoretically be embedded in different applications or extended with the excluded features in future iterations.\n\n### Implementation Guidance\n\nThe scope definition directly influences our technical architecture decisions and development approach. Understanding what we're building and what we're excluding helps determine the appropriate abstractions and interfaces for each component.\n\n**A. Technology Recommendations Table:**\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| Graphics Backend | Software rasterization to image buffer | Hardware-accelerated canvas (HTML5 Canvas, Skia, Cairo) |\n| Text Rendering | System font with basic metrics | Full font shaping library (HarfBuzz, DirectWrite) |\n| Testing Framework | Unit tests with string comparisons | Visual regression testing with reference images |\n| Build System | Single-file compilation | Multi-crate/module project with dependency management |\n\n**B. Recommended File/Module Structure:**\n\nThe scope boundaries map directly to our module organization. Each core goal becomes a primary module, while excluded features don't appear in our codebase structure:\n\n```\nbrowser-engine/\n  src/\n    main.rs                    ← CLI entry point and BrowserEngine coordination\n    types.rs                   ← Core types: Point, Size, Rectangle, Color, Unit\n    html/\n      mod.rs                   ← HTMLParser public interface\n      tokenizer.rs             ← HTML tokenization (Milestone 1)\n      tree_builder.rs          ← DOM tree construction (Milestone 1)\n    css/\n      mod.rs                   ← CSS parser public interface  \n      tokenizer.rs             ← CSS tokenization (Milestone 2)\n      parser.rs                ← Rule and selector parsing (Milestone 2)\n      cascade.rs               ← Specificity and cascade resolution (Milestone 2)\n    layout/\n      mod.rs                   ← LayoutEngine public interface\n      box_model.rs             ← Box model calculations (Milestone 3)\n      block.rs                 ← Block formatting context (Milestone 3)\n      inline.rs                ← Inline formatting context (Milestone 3)\n    render/\n      mod.rs                   ← RenderEngine public interface\n      paint.rs                 ← Paint command generation (Milestone 4)\n      canvas.rs                ← Graphics backend abstraction (Milestone 4)\n  tests/\n    integration/\n      milestone_1_tests.rs     ← HTML parsing validation\n      milestone_2_tests.rs     ← CSS parsing and cascade validation  \n      milestone_3_tests.rs     ← Layout computation validation\n      milestone_4_tests.rs     ← End-to-end rendering validation\n    fixtures/\n      simple.html              ← Test HTML documents\n      styles.css               ← Test CSS stylesheets\n      expected_outputs/        ← Reference images for visual testing\n```\n\n**C. Infrastructure Starter Code:**\n\nThe following core types support our scoped feature set and can be used throughout the implementation:\n\n```rust\n//! Core geometric and color types for the browser engine\nuse std::fmt;\n\n/// Represents a 2D point in viewport coordinates\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Point {\n    pub x: f32,\n    pub y: f32,\n}\n\nimpl Point {\n    pub fn new(x: f32, y: f32) -> Self {\n        Point { x, y }\n    }\n    \n    pub fn origin() -> Self {\n        Point { x: 0.0, y: 0.0 }\n    }\n}\n\n/// Represents 2D dimensions \n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Size {\n    pub width: f32,\n    pub height: f32,\n}\n\nimpl Size {\n    pub fn new(width: f32, height: f32) -> Self {\n        Size { width, height }\n    }\n    \n    pub fn zero() -> Self {\n        Size { width: 0.0, height: 0.0 }\n    }\n}\n\n/// Represents a rectangular area with position and dimensions\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Rectangle {\n    pub origin: Point,\n    pub size: Size,\n}\n\nimpl Rectangle {\n    pub fn new(x: f32, y: f32, width: f32, height: f32) -> Self {\n        Rectangle {\n            origin: Point::new(x, y),\n            size: Size::new(width, height),\n        }\n    }\n    \n    pub fn contains_point(&self, point: Point) -> bool {\n        point.x >= self.origin.x\n            && point.y >= self.origin.y\n            && point.x <= self.origin.x + self.size.width\n            && point.y <= self.origin.y + self.size.height\n    }\n    \n    pub fn intersects(&self, other: &Rectangle) -> bool {\n        !(other.origin.x > self.origin.x + self.size.width\n            || other.origin.x + other.size.width < self.origin.x\n            || other.origin.y > self.origin.y + self.size.height\n            || other.origin.y + other.size.height < self.origin.y)\n    }\n}\n\n/// Represents an RGBA color value\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Color {\n    pub r: u8,\n    pub g: u8,\n    pub b: u8,\n    pub a: u8,\n}\n\nimpl Color {\n    pub fn rgb(r: u8, g: u8, b: u8) -> Self {\n        Color { r, g, b, a: 255 }\n    }\n    \n    pub fn rgba(r: u8, g: u8, b: u8, a: u8) -> Self {\n        Color { r, g, b, a }\n    }\n    \n    pub fn from_hex(hex: &str) -> Result<Color, String> {\n        let hex = hex.trim_start_matches('#');\n        if hex.len() != 6 {\n            return Err(format!(\"Invalid hex color length: {}\", hex));\n        }\n        \n        let r = u8::from_str_radix(&hex[0..2], 16)\n            .map_err(|_| format!(\"Invalid hex color: {}\", hex))?;\n        let g = u8::from_str_radix(&hex[2..4], 16)\n            .map_err(|_| format!(\"Invalid hex color: {}\", hex))?;\n        let b = u8::from_str_radix(&hex[4..6], 16)\n            .map_err(|_| format!(\"Invalid hex color: {}\", hex))?;\n            \n        Ok(Color::rgb(r, g, b))\n    }\n}\n\n// Common color constants\npub const WHITE: Color = Color { r: 255, g: 255, b: 255, a: 255 };\npub const BLACK: Color = Color { r: 0, g: 0, b: 0, a: 255 };\npub const TRANSPARENT: Color = Color { r: 0, g: 0, b: 0, a: 0 };\n\n/// CSS unit types for dimensions and positioning\n#[derive(Debug, Clone, PartialEq)]\npub enum Unit {\n    Px(f32),\n    Percent(f32),\n    Em(f32),\n    Auto,\n}\n\nimpl Unit {\n    pub fn parse(input: &str) -> Result<Unit, String> {\n        let input = input.trim();\n        \n        if input == \"auto\" {\n            return Ok(Unit::Auto);\n        }\n        \n        if input.ends_with(\"px\") {\n            let value_str = &input[..input.len() - 2];\n            let value = value_str.parse::<f32>()\n                .map_err(|_| format!(\"Invalid px value: {}\", input))?;\n            return Ok(Unit::Px(value));\n        }\n        \n        if input.ends_with('%') {\n            let value_str = &input[..input.len() - 1];\n            let value = value_str.parse::<f32>()\n                .map_err(|_| format!(\"Invalid percent value: {}\", input))?;\n            return Ok(Unit::Percent(value));\n        }\n        \n        if input.ends_with(\"em\") {\n            let value_str = &input[..input.len() - 2];\n            let value = value_str.parse::<f32>()\n                .map_err(|_| format!(\"Invalid em value: {}\", input))?;\n            return Ok(Unit::Em(value));\n        }\n        \n        Err(format!(\"Unknown unit: {}\", input))\n    }\n    \n    pub fn to_px(&self, parent_value: f32, font_size: f32) -> f32 {\n        match self {\n            Unit::Px(value) => *value,\n            Unit::Percent(percent) => parent_value * (percent / 100.0),\n            Unit::Em(em_value) => font_size * em_value,\n            Unit::Auto => 0.0, // Auto resolution happens in layout algorithms\n        }\n    }\n}\n```\n\n**D. Core Engine Structure:**\n\nThe main `BrowserEngine` coordinates between all components and provides the public interface:\n\n```rust\n//! Main browser engine coordinating the rendering pipeline\nuse crate::types::*;\nuse crate::html::HTMLParser;\nuse crate::css::StyleResolver;\nuse crate::layout::LayoutEngine;\nuse crate::render::RenderEngine;\n\npub struct BrowserEngine {\n    pub viewport_size: Rectangle,\n}\n\nimpl BrowserEngine {\n    pub fn new(viewport_width: f32, viewport_height: f32) -> Self {\n        BrowserEngine {\n            viewport_size: Rectangle::new(0.0, 0.0, viewport_width, viewport_height),\n        }\n    }\n    \n    // TODO: Implement the complete rendering pipeline\n    // This method should coordinate all four milestones:\n    // 1. Parse HTML string into DOM tree using HTMLParser\n    // 2. Parse CSS string and resolve styles using StyleResolver  \n    // 3. Compute layout using LayoutEngine with viewport_size\n    // 4. Generate paint commands and render using RenderEngine\n    // Returns either a rendered image buffer or an error message\n    pub fn render_page(html: &str, css: &str) -> Result<Vec<u8>, String> {\n        todo!(\"Implement complete rendering pipeline\")\n    }\n}\n```\n\n**E. Language-Specific Implementation Hints:**\n\n- **Error Handling**: Use `Result<T, String>` consistently for all parsing and rendering operations. Collect multiple errors where possible rather than failing on the first error.\n\n- **Memory Management**: Rust's ownership system naturally handles memory management for our tree structures. Use `Rc<RefCell<T>>` only if you need shared mutable references in the DOM tree.\n\n- **String Processing**: Use `&str` slices for parsing to avoid unnecessary allocations. The `nom` parser combinator crate can simplify tokenization if you prefer a functional approach to manual character iteration.\n\n- **Graphics Output**: For simple implementations, render to a `Vec<u8>` representing RGB pixel data. The `image` crate can save this buffer to PNG files for testing.\n\n**F. Milestone Checkpoints:**\n\nAfter implementing each milestone, verify the following behaviors:\n\n| Milestone | Test Command | Expected Behavior | Success Indicators |\n|-----------|-------------|-------------------|-------------------|\n| 1: HTML Parser | `cargo test html_parsing` | Parse `<div><p>Hello</p></div>` into correct DOM tree | Tree has div parent with p child containing text node |\n| 2: CSS Parser | `cargo test css_cascade` | Apply `div { color: red; } p { color: blue; }` to above DOM | P element gets blue color, div gets red color |\n| 3: Layout | `cargo test box_model` | Compute positions for block elements with margin/padding | Each element has correct Rectangle with computed dimensions |\n| 4: Rendering | `cargo test end_to_end` | Render simple HTML/CSS to image buffer | Non-empty pixel buffer with expected colors at computed positions |\n\n**G. Common Scope Creep Warnings:**\n\n⚠️ **Scope Creep: Adding \"Just One More\" CSS Property**\nAdding properties like `position: absolute` or `display: flex` seems simple but each fundamentally changes layout algorithms. Stick to basic properties: `margin`, `padding`, `border`, `width`, `height`, `color`, `background-color`, `font-size`.\n\n⚠️ **Scope Creep: \"Real\" HTML Compatibility**  \nResist the urge to handle `<script>` tags, `<style>` tags, or complex HTML5 elements. Focus on `<div>`, `<p>`, `<span>`, `<h1>`-`<h6>`, and basic text content.\n\n⚠️ **Scope Creep: Performance Optimization**\nAvoid premature optimization like layout caching, dirty bit tracking, or GPU acceleration. Prioritize correctness and code clarity. A working but slow browser engine is infinitely more valuable for learning than a fast but broken one.\n\nThe scope boundaries we've established provide clear guidance for every implementation decision throughout the project. When facing complex specification details or edge cases, always choose the simpler approach that maintains our focus on the core rendering pipeline concepts.\n\n\n## High-Level Architecture\n\n> **Milestone(s):** All milestones (1-4) - This section establishes the architectural foundation that guides the implementation of HTML parsing, CSS parsing, layout computation, and rendering.\n\nBuilding a browser engine is like constructing a sophisticated assembly line for document production. Imagine a printing press that takes raw manuscript text and transforms it through multiple specialized stations: first, typesetters organize the text into structured pages; then, designers apply styling rules to determine fonts and colors; next, layout artists position every element on the page; and finally, printers render the finished product to paper. Our browser engine follows this same assembly line approach, with each stage performing a specific transformation on the document data until we achieve the final visual output.\n\n![System Component Diagram](./diagrams/component-architecture.svg)\n\nThe browser rendering pipeline represents one of the most complex data transformation systems in modern software engineering. Unlike typical applications that process discrete requests, a browser engine must parse two different languages simultaneously (HTML and CSS), resolve their interactions through sophisticated rule systems, perform complex geometric calculations, and generate precise visual output—all while maintaining performance and handling malformed input gracefully. This complexity arises because web standards evolved organically over decades, accumulating layers of backward compatibility and edge cases that production browsers must handle flawlessly.\n\n### The Rendering Pipeline\n\nThe **rendering pipeline** forms the backbone of our browser engine, transforming textual markup into visual pixels through four distinct stages. Each stage consumes the output of the previous stage and produces a more refined representation of the document, moving progressively from abstract syntax to concrete visual commands. This sequential processing model ensures clear separation of concerns while enabling optimizations at each transformation boundary.\n\nThink of this pipeline as a document assembly line where each workstation has a specific responsibility. The HTML parsing station converts raw text into a structured document tree. The CSS processing station decorates this tree with styling information. The layout station calculates precise measurements and positions. Finally, the rendering station produces the visual commands needed to paint the document. Just as a real assembly line can optimize individual stations without disrupting the entire process, our pipeline allows each component to evolve independently while maintaining clear interfaces.\n\n| Pipeline Stage | Input Format | Output Format | Primary Responsibility |\n|----------------|-------------|---------------|------------------------|\n| HTML Parsing | Raw HTML text string | DOM tree structure | Convert markup into hierarchical document representation |\n| CSS Processing | CSS stylesheet text + DOM tree | Styled DOM tree | Apply styling rules and compute final element styles |\n| Layout Computation | Styled DOM tree + viewport size | Layout tree with geometry | Calculate element positions and dimensions |\n| Rendering | Layout tree + graphics context | Display list of paint commands | Generate visual commands for drawing |\n\nThe pipeline operates as a **pull-based system** where each stage requests data from the previous stage as needed. This design choice enables lazy evaluation and provides natural points for caching intermediate results. For example, if only CSS changes while HTML remains constant, we can reuse the DOM tree and start processing from the style resolution stage. Similarly, viewport size changes require only layout and rendering stages to execute.\n\n> **Key Design Insight**: The pipeline stages are deliberately **stateless transformations**. Each stage takes input data, performs computations, and produces output without maintaining persistent state between invocations. This functional approach simplifies testing, debugging, and enables powerful optimization opportunities like result caching and parallel processing.\n\nThe data flow through the pipeline follows strict type safety boundaries. Each stage defines precise input and output contracts, preventing invalid data from propagating through the system. The `DOMNode` structures produced by HTML parsing contain only structural information. The style resolver augments this with `ComputedStyle` data. The layout engine adds geometric `LayoutBox` information. Finally, the renderer produces `PaintCommand` sequences that graphics backends can execute directly.\n\nError handling occurs at stage boundaries through explicit `Result` types that capture parsing failures, style resolution errors, layout constraints violations, and rendering failures. This allows downstream stages to implement appropriate fallback behaviors rather than crashing on malformed input. For instance, invalid CSS properties are ignored rather than causing parse failures, while malformed HTML triggers error recovery algorithms that attempt to construct meaningful DOM trees.\n\n### Component Responsibilities\n\nThe browser engine architecture divides responsibilities among four major components, each with clearly defined ownership boundaries and interface contracts. This modular design enables independent development and testing while ensuring proper separation of concerns across the complex rendering process.\n\n#### HTML Parser Component\n\nThe `HTMLParser` serves as the entry point for document processing, responsible for converting raw HTML text into structured `DOMNode` trees that represent the document's hierarchical organization. This component implements a **tokenization-then-parsing** architecture that first breaks HTML text into meaningful tokens (start tags, end tags, attributes, text content), then constructs the DOM tree using a stack-based algorithm that mirrors HTML's nested structure.\n\n| Method Name | Parameters | Returns | Description |\n|-------------|------------|---------|-------------|\n| `parse_html` | `input: &str` | `Result<DOMNode, ParseError>` | Main entry point that converts HTML string to DOM tree |\n| `tokenize` | `input: &str` | `Result<Vec<Token>, TokenError>` | Breaks HTML into structured tokens for parsing |\n| `build_tree` | `tokens: Vec<Token>` | `Result<DOMNode, TreeError>` | Constructs DOM hierarchy from token sequence |\n| `recover_from_error` | `error: ParseError, context: &str` | `DOMNode` | Implements error recovery for malformed markup |\n\nThe parser maintains **no persistent state** between invocations, making it safe for concurrent use and simplifying testing. However, during a single parse operation, it maintains a **tag stack** that tracks open elements to ensure proper nesting relationships. This stack-based approach naturally handles deeply nested HTML structures while providing clear error recovery points when malformed markup is encountered.\n\n> **Critical Design Decision**: The parser implements **forgiving error recovery** rather than strict validation. When encountering malformed HTML like unclosed tags or improper nesting, it attempts to construct the most reasonable DOM tree rather than failing. This mirrors production browser behavior where web pages often contain markup errors that must be handled gracefully.\n\n#### Style Resolver Component\n\nThe `StyleResolver` component bridges the gap between document structure and visual presentation by applying CSS rules to DOM elements and computing the final styles that will control layout and rendering. This component implements the complex **CSS cascade algorithm** that determines which style rules apply to each element based on specificity, source order, and inheritance relationships.\n\n| Method Name | Parameters | Returns | Description |\n|-------------|------------|---------|-------------|\n| `resolve_styles` | `dom: &DOMNode, css: &Stylesheet` | `Result<StyledNode, StyleError>` | Computes final styles for all DOM elements |\n| `match_selectors` | `element: &Element, rules: &[CSSRule]` | `Vec<&CSSRule>` | Finds all CSS rules that apply to given element |\n| `calculate_specificity` | `selector: &Selector` | `Specificity` | Computes CSS specificity for cascade ordering |\n| `compute_inherited_values` | `parent: &StyledNode, element: &Element` | `PropertyMap` | Resolves inherited property values from parent |\n\nThe resolver maintains a `Stylesheet` structure that organizes CSS rules for efficient matching against DOM elements. During style resolution, it performs a **tree traversal** of the DOM where each element collects applicable CSS rules, sorts them by specificity and source order, then computes final property values considering inheritance from parent elements. This process produces a `StyledNode` tree that mirrors the DOM structure but includes computed style information for every element.\n\nThe component handles several complex CSS concepts including **specificity calculation** using the standard (inline, IDs, classes, tags) weighting system, **property inheritance** where child elements receive certain styles from parents, and **cascade resolution** where multiple conflicting rules must be prioritized correctly. The resolver also manages **default user-agent styles** that provide baseline styling for HTML elements before author stylesheets are applied.\n\n#### Layout Engine Component\n\nThe `LayoutEngine` component transforms styled DOM trees into geometric layouts by implementing CSS box model calculations and formatting context algorithms. This component handles the most mathematically complex aspect of browser rendering: determining the exact size and position of every element based on CSS layout rules, content dimensions, and viewport constraints.\n\n| Method Name | Parameters | Returns | Description |\n|-------------|------------|---------|-------------|\n| `compute_layout` | `styled_tree: &StyledNode, viewport: Rectangle` | `Result<LayoutTree, LayoutError>` | Calculates positions and sizes for all elements |\n| `layout_block_element` | `node: &StyledNode, containing_block: Rectangle` | `LayoutBox` | Implements block formatting context layout |\n| `layout_inline_element` | `node: &StyledNode, line_width: f32` | `Vec<LayoutBox>` | Handles inline element flow and line breaking |\n| `resolve_dimensions` | `node: &StyledNode, parent_size: Size` | `Size` | Computes element width and height from CSS properties |\n\nThe engine implements two primary **formatting contexts**: block formatting where elements stack vertically, and inline formatting where elements flow horizontally with line wrapping. Block layout involves computing content width from the containing block, resolving auto margins, calculating height from content, and positioning child elements with proper margin collapsing. Inline layout requires more complex algorithms for baseline alignment, line breaking, and handling mixed text and element content.\n\n**Box model calculations** form the mathematical foundation of layout, where each element's total size includes content area plus padding, border, and margin dimensions. The engine must resolve percentage units relative to parent dimensions, handle auto values through constraint solving, and manage the complex interactions between width, height, margins, and positioning properties.\n\n> **Layout Complexity Insight**: Layout computation represents a **constraint satisfaction problem** where element dimensions depend on parent sizes, child content, and CSS properties simultaneously. The engine resolves these circular dependencies through multiple layout passes and careful ordering of dimension calculations.\n\n#### Render Engine Component\n\nThe `RenderEngine` component converts computed layouts into visual output by generating sequences of paint commands that graphics backends can execute to produce the final rendered image. This component traverses the layout tree in proper paint order, emitting drawing commands for backgrounds, borders, text, and other visual elements while handling clipping, z-ordering, and graphics optimization.\n\n| Method Name | Parameters | Returns | Description |\n|-------------|------------|---------|-------------|\n| `render_layout` | `layout_tree: &LayoutTree` | `Result<DisplayList, RenderError>` | Generates paint commands from layout tree |\n| `paint_element` | `layout_box: &LayoutBox` | `Vec<PaintCommand>` | Creates paint commands for single element |\n| `optimize_display_list` | `commands: Vec<PaintCommand>` | `Vec<PaintCommand>` | Applies rendering optimizations like clipping |\n| `execute_commands` | `display_list: &DisplayList, target: &mut Canvas` | `Result<(), GraphicsError>` | Draws commands to graphics surface |\n\nThe renderer implements a **painter's algorithm** approach where elements are drawn in back-to-front order to achieve correct visual layering. Background colors and images are painted first, followed by borders, and finally text content. The engine handles **clipping** by tracking the visible region during tree traversal and omitting paint commands for elements outside the viewport.\n\nPaint command generation follows the CSS specification for **stacking contexts** and **paint ordering**. Elements with positioning, opacity, or transform properties create new stacking contexts that affect paint order calculations. The renderer must correctly sort these contexts while maintaining performance for documents with complex layering relationships.\n\n### Recommended File Structure\n\nThe browser engine codebase follows a modular organization that separates the four major pipeline components into distinct modules while providing shared utilities and type definitions. This structure enables independent development of each component while maintaining clear dependency relationships and facilitating comprehensive testing.\n\n```\nsrc/\n├── lib.rs                          # Public API and main BrowserEngine struct\n├── types/                          # Shared data structures and enums\n│   ├── mod.rs                      # Re-exports for all shared types\n│   ├── geometry.rs                 # Point, Size, Rectangle, Color\n│   ├── units.rs                    # CSS Unit enum and conversion methods\n│   └── errors.rs                   # Error types for each component\n├── html/                           # HTML parsing and DOM construction\n│   ├── mod.rs                      # HTMLParser public interface\n│   ├── tokenizer.rs                # HTML tokenization logic\n│   ├── parser.rs                   # DOM tree construction\n│   ├── dom.rs                      # DOMNode and Element types\n│   └── entities.rs                 # HTML entity decoding\n├── css/                            # CSS parsing and style resolution\n│   ├── mod.rs                      # StyleResolver public interface\n│   ├── parser.rs                   # CSS rule and selector parsing\n│   ├── selector.rs                 # Selector matching and specificity\n│   ├── cascade.rs                  # CSS cascade algorithm\n│   ├── stylesheet.rs               # Stylesheet storage and organization\n│   └── properties.rs               # CSS property definitions and values\n├── layout/                         # Layout computation and box model\n│   ├── mod.rs                      # LayoutEngine public interface\n│   ├── box_model.rs                # CSS box model calculations\n│   ├── block.rs                    # Block formatting context\n│   ├── inline.rs                   # Inline formatting context\n│   ├── dimensions.rs               # Width/height resolution algorithms\n│   └── tree.rs                     # LayoutTree and LayoutBox types\n├── render/                         # Rendering and paint generation\n│   ├── mod.rs                      # RenderEngine public interface\n│   ├── paint.rs                    # Paint command generation\n│   ├── display_list.rs             # DisplayList optimization\n│   ├── canvas.rs                   # Graphics backend abstraction\n│   └── commands.rs                 # PaintCommand type definitions\n└── tests/                          # Integration tests\n    ├── html_parsing_tests.rs       # HTML parser test cases\n    ├── css_resolution_tests.rs     # Style resolution test cases\n    ├── layout_tests.rs             # Layout computation test cases\n    ├── render_tests.rs             # Rendering output test cases\n    └── integration_tests.rs        # End-to-end pipeline tests\n```\n\nThis modular structure provides several architectural benefits. Each major component (`html`, `css`, `layout`, `render`) can be developed and tested independently, with clear interface boundaries defined in the `mod.rs` files. The shared `types` module prevents circular dependencies while ensuring consistent data structures across components. Integration tests validate the complete pipeline while unit tests within each module verify component-specific behavior.\n\n> **Architecture Decision: Module Boundaries**\n> - **Context**: Browser engines involve complex interdependent components that could be organized as a monolithic module or separate specialized modules\n> - **Options Considered**: \n>   1. Single large module with all functionality\n>   2. Separate modules per pipeline stage\n>   3. Layered architecture with parsing/styling/layout/rendering layers\n> - **Decision**: Separate modules per pipeline stage with shared types module\n> - **Rationale**: This structure matches the natural pipeline flow, enables independent testing, facilitates parallel development, and provides clear upgrade paths for individual components\n> - **Consequences**: Enables modular development and testing, requires careful interface design, may introduce some code duplication for shared utilities\n\nThe dependency flow follows the pipeline order: `html` module has no internal dependencies, `css` module depends on DOM types from `html`, `layout` depends on styled nodes from `css`, and `render` depends on layout trees from `layout`. This **acyclic dependency structure** prevents circular imports and ensures clean architectural boundaries.\n\nEach module exposes a **minimal public API** through its `mod.rs` file while keeping implementation details private. For example, the HTML module exposes `parse_html()` and `DOMNode` types but hides tokenization details. This encapsulation enables internal refactoring without affecting other components and simplifies the cognitive load for developers working on specific pipeline stages.\n\n### Implementation Guidance\n\nThe browser engine implementation requires careful selection of foundational technologies and a well-organized codebase structure that can evolve as complexity increases. The following guidance provides specific technology recommendations and complete starter code to bootstrap development.\n\n#### Technology Recommendations\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| Graphics Backend | Software rendering to RGB buffer | GPU-accelerated canvas (wgpu/OpenGL) |\n| Font Rendering | Bitmap fonts with fixed metrics | TrueType/OpenType with complex shaping |\n| Text Layout | Simple left-to-right flow | Full Unicode bidirectional text |\n| Image Support | Basic RGB/RGBA formats | Comprehensive format support (PNG, JPEG, SVG) |\n| CSS Units | Pixels and percentages only | Full CSS unit support (em, rem, vh, vw) |\n| Development Tools | Print debugging with DOM dumps | Visual layout debugging with tree inspector |\n\nFor initial implementation, prioritize the simple options to establish working functionality across the entire pipeline. The architecture supports upgrading individual components to advanced options without requiring complete rewrites.\n\n#### Complete Starter Code\n\nThe following starter code provides a complete foundation for the browser engine with proper error handling, type definitions, and component interfaces. This code is production-ready for the non-core components, allowing focus on the pipeline algorithms.\n\n**src/lib.rs** - Main engine interface:\n```rust\nuse crate::types::{Rectangle, Point, Size};\nuse crate::html::HTMLParser;\nuse crate::css::StyleResolver;\nuse crate::layout::LayoutEngine;\nuse crate::render::RenderEngine;\n\npub struct BrowserEngine {\n    pub viewport_size: Rectangle,\n    html_parser: HTMLParser,\n    style_resolver: StyleResolver,\n    layout_engine: LayoutEngine,\n    render_engine: RenderEngine,\n}\n\nimpl BrowserEngine {\n    pub fn new(viewport_width: f32, viewport_height: f32) -> Self {\n        let viewport_size = Rectangle {\n            origin: Point { x: 0.0, y: 0.0 },\n            size: Size { width: viewport_width, height: viewport_height },\n        };\n        \n        Self {\n            viewport_size,\n            html_parser: HTMLParser::new(),\n            style_resolver: StyleResolver::new(),\n            layout_engine: LayoutEngine::new(viewport_size),\n            render_engine: RenderEngine::new(viewport_size),\n        }\n    }\n    \n    pub fn render_page(&mut self, html: &str, css: &str) -> Result<Vec<u8>, String> {\n        // TODO: Implement complete rendering pipeline\n        // 1. Parse HTML into DOM tree\n        // 2. Parse CSS into stylesheet\n        // 3. Resolve styles for all DOM elements\n        // 4. Compute layout for styled elements\n        // 5. Generate display list from layout\n        // 6. Execute paint commands to produce RGB buffer\n        todo!(\"Implement rendering pipeline\")\n    }\n}\n```\n\n**src/types/geometry.rs** - Core geometric types:\n```rust\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Point {\n    pub x: f32,\n    pub y: f32,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Size {\n    pub width: f32,\n    pub height: f32,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Rectangle {\n    pub origin: Point,\n    pub size: Size,\n}\n\nimpl Rectangle {\n    pub fn contains_point(&self, point: Point) -> bool {\n        // TODO: Check if point lies within rectangle bounds\n        // Hint: point.x >= origin.x && point.x <= origin.x + size.width\n        todo!(\"Implement point containment check\")\n    }\n    \n    pub fn intersects(&self, other: &Rectangle) -> bool {\n        // TODO: Check if two rectangles overlap\n        // Hint: Use separating axis theorem - rectangles don't intersect if\n        // there's a gap on any axis (horizontal or vertical)\n        todo!(\"Implement rectangle intersection test\")\n    }\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Color {\n    pub r: u8,\n    pub g: u8, \n    pub b: u8,\n    pub a: u8,\n}\n\nimpl Color {\n    pub fn rgb(r: u8, g: u8, b: u8) -> Self {\n        Self { r, g, b, a: 255 }\n    }\n    \n    pub fn from_hex(hex: &str) -> Result<Self, String> {\n        // TODO: Parse hex color strings like \"#ff0000\" or \"red\"\n        // 1. Strip leading '#' if present\n        // 2. Handle 3-digit (#rgb) and 6-digit (#rrggbb) formats  \n        // 3. Parse hex digits into r, g, b components\n        // 4. Handle named colors as bonus feature\n        todo!(\"Implement hex color parsing\")\n    }\n}\n\npub const WHITE: Color = Color { r: 255, g: 255, b: 255, a: 255 };\npub const BLACK: Color = Color { r: 0, g: 0, b: 0, a: 255 };\npub const TRANSPARENT: Color = Color { r: 0, g: 0, b: 0, a: 0 };\n```\n\n**src/types/units.rs** - CSS unit handling:\n```rust\n#[derive(Debug, Clone, Copy, PartialEq)]\npub enum Unit {\n    Px(f32),      // Absolute pixels\n    Percent(f32), // Percentage of parent dimension\n    Em(f32),      // Multiple of current font size\n    Auto,         // Automatic sizing\n}\n\nimpl Unit {\n    pub fn parse(input: &str) -> Result<Self, String> {\n        // TODO: Parse CSS unit strings like \"10px\", \"50%\", \"2em\", \"auto\"\n        // 1. Trim whitespace from input\n        // 2. Handle \"auto\" keyword case\n        // 3. Split numeric value from unit suffix\n        // 4. Parse numeric component as f32\n        // 5. Match unit suffix to appropriate enum variant\n        todo!(\"Implement CSS unit parsing\")\n    }\n    \n    pub fn to_px(&self, parent_value: f32, font_size: f32) -> f32 {\n        // TODO: Convert any unit to absolute pixels\n        // 1. Px(value) -> return value directly\n        // 2. Percent(value) -> return parent_value * (value / 100.0)\n        // 3. Em(value) -> return font_size * value\n        // 4. Auto -> return 0.0 (caller handles auto resolution)\n        todo!(\"Implement unit to pixel conversion\")\n    }\n}\n```\n\n#### Core Logic Skeletons\n\nThe following skeletons provide the exact function signatures and detailed TODO comments that map to the algorithm steps described in the design sections. These represent the core learning objectives that developers should implement themselves.\n\n**src/html/parser.rs** - DOM tree construction:\n```rust\nuse crate::html::dom::{DOMNode, Element, TextNode};\n\npub struct HTMLParser;\n\nimpl HTMLParser {\n    pub fn new() -> Self {\n        Self\n    }\n    \n    pub fn parse_html(input: &str) -> Result<DOMNode, String> {\n        // TODO 1: Tokenize the input HTML into structured tokens\n        // TODO 2: Initialize element stack for tracking open tags  \n        // TODO 3: Process each token to build DOM tree:\n        //   - StartTag: create element, push to stack, add as child\n        //   - EndTag: pop from stack if tag names match\n        //   - TextContent: create text node, add as child of current element\n        //   - SelfClosing: create element, add as child, don't push to stack\n        // TODO 4: Handle error recovery for malformed HTML\n        // TODO 5: Return root DOM node of constructed tree\n        todo!(\"Implement HTML parsing with DOM tree construction\")\n    }\n}\n```\n\n**src/css/cascade.rs** - Style resolution:\n```rust\nuse crate::css::stylesheet::Stylesheet;\nuse crate::html::dom::DOMNode;\n\npub struct StyleResolver {\n    pub stylesheet: Stylesheet,\n}\n\nimpl StyleResolver {\n    pub fn resolve_styles(&self, dom: &DOMNode) -> Result<StyledNode, String> {\n        // TODO 1: Traverse DOM tree in document order\n        // TODO 2: For each element, collect matching CSS rules\n        // TODO 3: Sort rules by specificity (IDs > classes > tags)\n        // TODO 4: Apply cascade to resolve property conflicts\n        // TODO 5: Compute inherited values from parent element\n        // TODO 6: Build styled tree mirroring DOM structure\n        todo!(\"Implement CSS cascade and style resolution\")\n    }\n}\n```\n\n#### Development Workflow and Milestones\n\nFollow this incremental development approach to build the browser engine systematically:\n\n**Milestone 1 Checkpoint**: After implementing HTML parsing, verify with:\n```bash\ncargo test html_parsing_tests\n```\nExpected behavior: Parse simple HTML documents into correct DOM tree structure, handle malformed markup gracefully, support common HTML elements and attributes.\n\n**Milestone 2 Checkpoint**: After CSS parsing and style resolution:\n```bash  \ncargo test css_resolution_tests\n```\nExpected behavior: Parse CSS rules correctly, match selectors to elements, compute specificity, resolve style inheritance, handle cascade conflicts.\n\n**Milestone 3 Checkpoint**: After layout computation:\n```bash\ncargo test layout_tests  \n```\nExpected behavior: Calculate element positions and dimensions, implement box model correctly, handle block and inline formatting, resolve auto values.\n\n**Milestone 4 Checkpoint**: After rendering implementation:\n```bash\ncargo test render_tests && cargo run --example simple_page\n```\nExpected behavior: Generate correct paint commands, produce visual output, handle graphics operations, support basic styling (colors, borders, text).\n\n⚠️ **Common Development Pitfall**: Attempting to implement all four pipeline stages simultaneously leads to debugging nightmares where it's impossible to isolate which component contains bugs. Instead, complete each milestone fully with comprehensive tests before proceeding to the next stage.\n\n\n## Data Model and Core Types\n\n> **Milestone(s):** All milestones (1-4) - This section defines the fundamental data structures that flow through every stage of the rendering pipeline, from DOM tree construction through final paint command generation.\n\nThe data model forms the backbone of our browser engine, defining how information is structured and flows through the rendering pipeline. Think of these data structures as **standardized shipping containers** in our document assembly line - each container has a specific format and purpose, allowing different stages of the pipeline to efficiently process and transform the data without needing to understand the internal details of other stages.\n\nJust as a modern manufacturing assembly line uses standardized parts and interfaces between stations, our browser engine uses well-defined data types that serve as contracts between the HTML parser, CSS parser, layout engine, and rendering engine. Each stage knows exactly what format of data it receives and what format it must produce, enabling clean separation of concerns and modular design.\n\n![Data Model Class Diagram](./diagrams/data-model-relationships.svg)\n\n### Mental Model: The Document Assembly Line Containers\n\nTo understand how these data structures work together, imagine a document assembly line where information flows through standardized containers:\n\n**Raw Materials Station**: HTML and CSS text strings enter the assembly line as unprocessed raw materials - just sequences of characters with no inherent structure.\n\n**Parsing Stations**: The HTML parser transforms raw HTML text into `DOMNode` containers that preserve the hierarchical document structure. Simultaneously, the CSS parser creates `CSSRule` containers that capture styling information with proper specificity calculations.\n\n**Style Resolution Station**: The style resolver combines DOM containers with CSS rule containers to produce `StyledNode` containers - DOM nodes enriched with their computed style properties after cascade resolution.\n\n**Layout Station**: The layout engine transforms styled node containers into `LayoutBox` containers that add geometric information - exact positions, dimensions, and box model calculations.\n\n**Paint Station**: Finally, the rendering engine processes layout boxes to generate `PaintCommand` containers - specific drawing instructions that can be executed by graphics hardware.\n\nEach container type has a specific format and purpose, and the assembly line workers (our components) know exactly how to read incoming containers and produce outgoing containers for the next station.\n\n### DOM Tree Types\n\nThe DOM tree represents the hierarchical structure of an HTML document after parsing. These types capture both the semantic structure (what elements exist and how they're nested) and the content (text, attributes, element types) needed for later processing stages.\n\n> **Decision: Node-based Tree Structure with Type Discrimination**\n> - **Context**: HTML documents contain different types of content (elements, text, comments) that need different handling but must coexist in the same tree structure\n> - **Options Considered**: Single unified node type with optional fields, enum-based discrimination, trait objects\n> - **Decision**: Enum-based node types with shared tree navigation methods\n> - **Rationale**: Type safety prevents attempting element operations on text nodes, pattern matching makes processing logic clear, shared navigation methods avoid code duplication\n> - **Consequences**: Memory overhead from enum tags, but eliminates runtime type checking errors and makes tree traversal algorithms more robust\n\n#### Core DOM Node Structure\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| `node_type` | `DOMNodeType` | Discriminates between element, text, comment, and document nodes |\n| `parent` | `Option<DOMNodeHandle>` | Reference to parent node, None for root document node |\n| `children` | `Vec<DOMNodeHandle>` | Ordered list of child nodes preserving document structure |\n| `node_data` | `DOMNodeData` | Type-specific data based on node_type value |\n\n#### DOM Node Type Variants\n\n| Variant Name | Associated Data | Purpose |\n|--------------|-----------------|---------|\n| `Element` | `ElementData` | HTML elements with tag names, attributes, and semantic meaning |\n| `Text` | `String` | Text content between elements or as element content |\n| `Comment` | `String` | HTML comments preserved for debugging or processing instructions |\n| `Document` | `DocumentData` | Root node containing document metadata and doctype information |\n\n#### Element Data Structure\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| `tag_name` | `String` | Element tag name in lowercase (div, span, p, etc.) |\n| `attributes` | `HashMap<String, String>` | Key-value pairs of HTML attributes |\n| `namespace` | `Option<String>` | XML namespace URI for elements (HTML, SVG, MathML) |\n| `is_void` | `bool` | True for self-closing elements (br, img, input) that cannot have children |\n\n#### Document Data Structure\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| `doctype` | `Option<String>` | DOCTYPE declaration if present in source |\n| `title` | `Option<String>` | Document title extracted from title element |\n| `base_url` | `Option<String>` | Base URL for resolving relative references |\n| `character_encoding` | `String` | Document character encoding (UTF-8, ISO-8859-1, etc.) |\n\n#### DOM Tree Navigation Interface\n\n| Method Name | Parameters | Returns | Description |\n|-------------|------------|---------|-------------|\n| `get_parent` | `&self` | `Option<&DOMNode>` | Returns parent node reference or None for root |\n| `get_children` | `&self` | `&Vec<DOMNode>` | Returns immutable reference to children list |\n| `get_first_child` | `&self` | `Option<&DOMNode>` | Returns first child node or None if no children |\n| `get_last_child` | `&self` | `Option<&DOMNode>` | Returns last child node or None if no children |\n| `get_next_sibling` | `&self` | `Option<&DOMNode>` | Returns next sibling in parent's children list |\n| `get_previous_sibling` | `&self` | `Option<&DOMNode>` | Returns previous sibling in parent's children list |\n| `append_child` | `&mut self, child: DOMNode` | `Result<(), String>` | Adds child to end of children list with validation |\n| `insert_before` | `&mut self, new_child: DOMNode, reference: &DOMNode` | `Result<(), String>` | Inserts new child before reference child |\n| `remove_child` | `&mut self, child: &DOMNode` | `Result<DOMNode, String>` | Removes and returns child node |\n\n#### Text Content Extraction\n\n| Method Name | Parameters | Returns | Description |\n|-------------|------------|---------|-------------|\n| `get_text_content` | `&self` | `String` | Returns concatenated text of all descendant text nodes |\n| `get_inner_text` | `&self` | `String` | Returns visible text content respecting CSS display properties |\n| `set_text_content` | `&mut self, text: String` | `()` | Replaces all children with single text node |\n\nThe DOM tree serves as the foundation for all subsequent processing. The hierarchical structure captures the semantic relationships between elements (which elements are nested inside others), while the attribute storage preserves the original HTML metadata needed for styling and behavior.\n\nConsider this HTML fragment and its corresponding DOM representation:\n\n```html\n<div class=\"container\">\n  <p>Hello <strong>world</strong>!</p>\n</div>\n```\n\nThis creates a DOM tree where the root `div` element has `class=\"container\"` in its attributes map, contains one child `p` element, which in turn contains three children: a text node (\"Hello \"), a `strong` element containing text node (\"world\"), and another text node (\"!\"). This structure preserves the exact nesting relationships needed for CSS selector matching and layout calculations.\n\n⚠️ **Pitfall: Node Reference Management**\nA common mistake is attempting to use raw pointers or references for parent/child relationships, which creates lifetime management nightmares in languages with strict ownership rules. Instead, use handles (indices into a node pool) or reference-counted smart pointers that allow shared ownership of nodes while maintaining tree structure integrity.\n\n⚠️ **Pitfall: Attribute Case Sensitivity** \nHTML parsing should normalize attribute names to lowercase for consistent access, but preserve the original case in attribute values. Failing to normalize means `Class=\"container\"` and `class=\"container\"` would be stored as different keys, breaking CSS selector matching.\n\n### CSS and Style Types\n\nThe CSS and style system represents parsed CSS rules, selector matching logic, and the cascade resolution that determines final computed styles for each DOM element. These types capture both the structural information from CSS parsing (selectors, properties, values) and the computed results after specificity calculation and cascade resolution.\n\n> **Decision: Separate Parsed and Computed Style Representations**\n> - **Context**: CSS values can be specified in various units and formats but need consistent representation for layout calculations\n> - **Options Considered**: Single style representation with on-demand conversion, separate parsed/computed types, lazy evaluation with caching\n> - **Decision**: Explicit separation between `CSSValue` (parsed) and `ComputedValue` (resolved)\n> - **Rationale**: Makes the cascade resolution explicit, prevents repeated unit conversions during layout, enables better debugging of style computation\n> - **Consequences**: Higher memory usage storing both parsed and computed values, but eliminates bugs from inconsistent value resolution\n\n#### CSS Rule Structure\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| `selector` | `Selector` | CSS selector that determines which elements this rule applies to |\n| `declarations` | `Vec<Declaration>` | Property-value pairs declared in this rule |\n| `specificity` | `Specificity` | Calculated specificity for cascade ordering |\n| `source_order` | `u32` | Original position in stylesheet for tie-breaking |\n| `important` | `bool` | True if any declaration in this rule has !important |\n\n#### Selector Types and Structure\n\n| Selector Type | Structure | Specificity Contribution |\n|---------------|-----------|-------------------------|\n| `Universal` | `*` | (0, 0, 0, 0) |\n| `Type` | `tag_name: String` | (0, 0, 0, 1) |\n| `Class` | `class_name: String` | (0, 0, 1, 0) |\n| `ID` | `id_value: String` | (0, 1, 0, 0) |\n| `Attribute` | `name: String, operator: AttributeOperator, value: Option<String>` | (0, 0, 1, 0) |\n| `Descendant` | `ancestor: Box<Selector>, descendant: Box<Selector>` | Sum of component specificities |\n| `Child` | `parent: Box<Selector>, child: Box<Selector>` | Sum of component specificities |\n\n#### Specificity Calculation\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| `inline` | `u32` | Count of inline style declarations (always 0 for stylesheet rules) |\n| `ids` | `u32` | Count of ID selectors in the selector |\n| `classes` | `u32` | Count of class selectors, attribute selectors, and pseudo-classes |\n| `elements` | `u32` | Count of type selectors and pseudo-elements |\n\n#### CSS Declaration Structure\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| `property` | `String` | CSS property name (color, font-size, margin-left, etc.) |\n| `value` | `CSSValue` | Parsed value with units and type information |\n| `important` | `bool` | True if declaration has !important flag |\n\n#### CSS Value Types\n\n| Value Type | Structure | Example |\n|------------|-----------|---------|\n| `Length` | `value: f32, unit: Unit` | `16px`, `2em`, `50%` |\n| `Color` | `r: u8, g: u8, b: u8, a: u8` | `#ff0000`, `rgb(255, 0, 0)` |\n| `Keyword` | `keyword: String` | `auto`, `inherit`, `initial` |\n| `String` | `value: String` | Font family names, content strings |\n| `Number` | `value: f32` | Line height, opacity values |\n| `URL` | `url: String` | Background images, font sources |\n\n#### Stylesheet Structure\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| `rules` | `Vec<CSSRule>` | All parsed rules in source order |\n| `origin` | `StylesheetOrigin` | User-agent, author, or user stylesheet classification |\n| `media_queries` | `Vec<MediaQuery>` | Media conditions for conditional rule application |\n\n#### Computed Style Structure\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| `display` | `Display` | Display type (block, inline, none, flex) |\n| `position` | `Position` | Positioning scheme (static, relative, absolute, fixed) |\n| `width` | `ComputedLength` | Resolved width in pixels or auto |\n| `height` | `ComputedLength` | Resolved height in pixels or auto |\n| `margin` | `BoxOffsets<ComputedLength>` | Margin values for all four sides |\n| `border` | `BoxOffsets<BorderSide>` | Border width, style, color for all sides |\n| `padding` | `BoxOffsets<ComputedLength>` | Padding values for all four sides |\n| `color` | `Color` | Text color in RGBA format |\n| `background_color` | `Color` | Background color in RGBA format |\n| `font_family` | `Vec<String>` | Font family stack in preference order |\n| `font_size` | `f32` | Font size resolved to pixels |\n| `font_weight` | `FontWeight` | Font weight (100-900 or keyword) |\n| `line_height` | `f32` | Line height resolved to pixels |\n\n#### Style Matching Interface\n\n| Method Name | Parameters | Returns | Description |\n|-------------|------------|---------|-------------|\n| `matches_element` | `selector: &Selector, element: &DOMNode` | `bool` | Tests if selector matches given element |\n| `calculate_specificity` | `selector: &Selector` | `Specificity` | Computes specificity tuple for cascade ordering |\n| `collect_matching_rules` | `element: &DOMNode, stylesheet: &Stylesheet` | `Vec<&CSSRule>` | Finds all rules that apply to element |\n| `resolve_cascade` | `element: &DOMNode, matching_rules: Vec<&CSSRule>` | `ComputedStyle` | Applies cascade algorithm to determine final styles |\n| `inherit_properties` | `parent_style: &ComputedStyle, child_style: &mut ComputedStyle` | `()` | Applies CSS inheritance rules |\n\nThe CSS system implements the full cascade algorithm as specified in CSS specifications. When multiple rules apply to the same element, the cascade resolves conflicts using this priority order:\n\n1. **Origin and importance**: User-agent normal < author normal < user normal < user !important < author !important\n2. **Specificity**: Higher specificity values win using the (inline, ids, classes, elements) tuple\n3. **Source order**: Later rules override earlier rules with identical specificity\n\nConsider this CSS example and how it resolves:\n\n```css\np { color: black; }           /* Specificity: (0,0,0,1) */\n.highlight { color: blue; }   /* Specificity: (0,0,1,0) */\n#intro { color: red; }        /* Specificity: (0,1,0,0) */\n```\n\nFor an element `<p id=\"intro\" class=\"highlight\">`, all three rules match, but the ID selector wins due to highest specificity, so the computed color is red.\n\n⚠️ **Pitfall: Percentage Value Resolution**\nA common mistake is resolving percentage values during CSS parsing instead of during layout computation. Percentages like `width: 50%` depend on the parent element's computed dimensions, which aren't available until layout. Store percentage values in their original form and resolve them during box model calculation.\n\n⚠️ **Pitfall: Inheritance vs. Initial Values**\nCSS properties behave differently when no explicit value is set. Some properties (like `color`, `font-family`) inherit from parent elements, while others (like `width`, `margin`) use their initial value. Failing to implement proper inheritance leads to incorrect rendering where text doesn't pick up parent colors or font settings.\n\n### Layout and Box Model Types\n\nThe layout system represents the geometric information computed from styled DOM elements - their positions, dimensions, and box model properties. These types capture the final calculated values after all CSS resolution, unit conversion, and constraint satisfaction needed for rendering.\n\n> **Decision: Separate Layout Tree from DOM Tree**\n> - **Context**: Layout calculations require additional geometric data not present in DOM, and some DOM elements don't generate layout boxes\n> - **Options Considered**: Augment DOM nodes with layout data, create parallel layout tree, compute layout on-demand\n> - **Decision**: Separate `LayoutBox` tree structure that references corresponding DOM nodes\n> - **Rationale**: Clean separation allows DOM to remain immutable during layout, handles cases where single DOM node generates multiple boxes or no boxes, enables layout-specific optimizations\n> - **Consequences**: Additional memory for separate tree structure, but provides flexibility for complex layout scenarios and keeps concerns properly separated\n\n#### Layout Box Structure\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| `box_type` | `BoxType` | Discriminates between block, inline, text, and anonymous boxes |\n| `dom_node` | `Option<DOMNodeHandle>` | Reference to corresponding DOM element (None for anonymous boxes) |\n| `content_rect` | `Rectangle` | Content area dimensions after box model calculation |\n| `padding_rect` | `Rectangle` | Content + padding dimensions |\n| `border_rect` | `Rectangle` | Content + padding + border dimensions |\n| `margin_rect` | `Rectangle` | Content + padding + border + margin dimensions (total space occupied) |\n| `children` | `Vec<LayoutBox>` | Child boxes in layout tree order |\n| `computed_style` | `ComputedStyle` | Resolved CSS properties used for this box |\n\n#### Box Type Classifications\n\n| Box Type | Purpose | Generated By |\n|----------|---------|--------------|\n| `BlockContainer` | Establishes block formatting context for child elements | Block-level elements (div, p, h1, etc.) |\n| `InlineContainer` | Establishes inline formatting context for text flow | Inline elements (span, em, strong, etc.) |\n| `TextBox` | Contains text content with font and baseline information | Text nodes with non-whitespace content |\n| `AnonymousBlock` | Wraps inline content that appears in block context | Mixed block/inline content scenarios |\n| `LineBox` | Horizontal line containing inline boxes and text | Generated during inline layout |\n\n#### Rectangle and Geometric Types\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| `origin` | `Point` | Top-left corner position relative to containing block |\n| `size` | `Size` | Width and height dimensions of the rectangle |\n\n#### Point and Size Components\n\n| Type | Field Name | Type | Description |\n|------|------------|------|-------------|\n| `Point` | `x` | `f32` | Horizontal coordinate in pixels from left edge |\n| `Point` | `y` | `f32` | Vertical coordinate in pixels from top edge |\n| `Size` | `width` | `f32` | Horizontal extent in pixels |\n| `Size` | `height` | `f32` | Vertical extent in pixels |\n\n#### Box Model Calculation Interface\n\n| Method Name | Parameters | Returns | Description |\n|-------------|------------|---------|-------------|\n| `calculate_box_model` | `&self, available_width: f32` | `BoxModel` | Computes margin, border, padding, content dimensions |\n| `resolve_width` | `&self, containing_width: f32` | `f32` | Resolves width value including auto and percentage |\n| `resolve_height` | `&self, containing_height: f32` | `f32` | Resolves height value including auto and percentage |\n| `get_content_bounds` | `&self` | `Rectangle` | Returns content area rectangle |\n| `get_padding_bounds` | `&self` | `Rectangle` | Returns content + padding rectangle |\n| `get_border_bounds` | `&self` | `Rectangle` | Returns content + padding + border rectangle |\n| `get_margin_bounds` | `&self` | `Rectangle` | Returns total space occupied including margins |\n\n#### Layout Constraints\n\n| Constraint Type | Description | Resolution Strategy |\n|-----------------|-------------|-------------------|\n| `AvailableWidth` | Maximum width available from containing block | Used for percentage width calculation and line wrapping |\n| `AvailableHeight` | Maximum height available from containing block | Used for percentage height and overflow handling |\n| `MinContentWidth` | Minimum width needed to avoid overflow | Determined by longest unbreakable content |\n| `MaxContentWidth` | Width if no wrapping constraints applied | Sum of all content without line breaks |\n\n#### Formatting Context Types\n\n| Context Type | Purpose | Layout Algorithm |\n|--------------|---------|------------------|\n| `BlockFormattingContext` | Vertical stacking of block boxes | Stack children vertically, handle margin collapsing |\n| `InlineFormattingContext` | Horizontal flow with line wrapping | Flow text and inline boxes horizontally, create line boxes |\n| `FlowRoot` | Establishes new block formatting context | Isolates float and margin collapsing behavior |\n\n#### Layout Tree Construction Process\n\nThe layout tree is built through a multi-pass algorithm that transforms the styled DOM tree into positioned boxes:\n\n1. **Tree Structure Creation**: Traverse the styled DOM tree and create corresponding layout boxes based on computed display values. Elements with `display: none` are skipped entirely.\n\n2. **Anonymous Box Generation**: Insert anonymous block boxes where needed to maintain formatting context rules. For example, if a block element directly contains both block children and text content, wrap the text in an anonymous block.\n\n3. **Constraint Propagation**: Pass available width and height constraints down the tree, allowing each box to determine its sizing context.\n\n4. **Box Model Calculation**: Resolve all margin, border, padding, and content dimensions using the CSS box model algorithm. Convert percentage values using containing block dimensions.\n\n5. **Position Assignment**: Calculate final positions for each box based on its positioning scheme (static, relative, absolute) and formatting context.\n\nConsider this HTML with its layout tree structure:\n\n```html\n<div style=\"width: 300px;\">\n  <p style=\"margin: 10px;\">Text content</p>\n</div>\n```\n\nThis generates a layout tree where the root `div` creates a block container with content width of 300px. The child `p` element creates a nested block box with margin offsets, and the text content generates a text box within the paragraph's content area. The paragraph's total width including margins fits within the 300px constraint.\n\nThe box model calculation for the paragraph involves:\n- Content width: `auto` resolves to `300px - 20px = 280px` (available width minus horizontal margins)\n- Padding: Default to 0 for all sides\n- Border: Default to 0 for all sides  \n- Margin: 10px on all sides as specified\n\n⚠️ **Pitfall: Margin Collapsing**\nAdjacent block-level elements have their vertical margins collapsed according to complex CSS rules. The larger margin value wins, not the sum of both margins. Failing to implement margin collapsing creates excessive spacing between paragraphs and other block elements. Track adjacent margin values during layout and apply the collapsing algorithm.\n\n⚠️ **Pitfall: Auto Value Resolution Order**\nCSS `auto` values must be resolved in a specific order depending on the property and context. For width calculation, resolve `auto` margins after resolving `auto` width, not simultaneously. The order affects the final layout when multiple properties have `auto` values.\n\n⚠️ **Pitfall: Containing Block Confusion**\nEach element's containing block (used for percentage resolution) isn't always its parent element. For absolutely positioned elements, the containing block is the nearest positioned ancestor. For relatively positioned elements, it's the parent's content area. Using the wrong containing block leads to incorrect percentage calculations.\n\n### Paint Command Types\n\nPaint commands represent the final rendering instructions generated from the layout tree. These types capture specific drawing operations that can be executed by graphics backends to produce visual output.\n\n#### Paint Command Structure\n\n| Command Type | Fields | Description |\n|--------------|--------|-------------|\n| `DrawRectangle` | `rect: Rectangle, color: Color` | Fills rectangle with solid color |\n| `DrawBorder` | `rect: Rectangle, border: BorderStyle` | Draws border around rectangle perimeter |\n| `DrawText` | `text: String, position: Point, font: Font, color: Color` | Renders text at specified baseline position |\n| `SetClip` | `rect: Rectangle` | Restricts subsequent drawing to rectangle bounds |\n| `ClearClip` | | Removes current clipping restriction |\n\n#### Display List Structure\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| `commands` | `Vec<PaintCommand>` | Ordered list of paint commands in z-order |\n| `viewport` | `Rectangle` | Visible area bounds for clipping optimization |\n| `background_color` | `Color` | Document background color |\n\nThe paint command system provides the interface between layout calculations and actual pixel rendering, abstracting away graphics backend details while preserving precise drawing control.\n\n### Implementation Guidance\n\n#### Technology Recommendations\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| DOM Storage | `Vec<DOMNode>` with index handles | `Arena<DOMNode>` with generational indices |\n| Style Matching | Linear scan through all rules | Bloom filter + rule hashing |\n| Layout Tree | Recursive tree with owned children | Flat array with parent/child indices |\n| Memory Management | Reference counting (`Rc<RefCell<T>>`) | Custom arena allocator |\n\n#### Recommended File Structure\n\n```\nsrc/\n  dom/\n    mod.rs              ← DOM type definitions and exports\n    node.rs             ← DOMNode, Element, Text implementations  \n    tree.rs             ← Tree navigation and manipulation\n    html_parser.rs      ← HTML parsing integration\n  \n  style/\n    mod.rs              ← Style type definitions and exports\n    selector.rs         ← Selector matching and specificity\n    cascade.rs          ← Cascade resolution algorithm\n    computed.rs         ← Computed style calculation\n    \n  layout/\n    mod.rs              ← Layout type definitions and exports\n    box_model.rs        ← BoxModel calculation algorithms\n    block.rs            ← Block formatting context\n    inline.rs           ← Inline formatting context\n    \n  paint/\n    mod.rs              ← Paint command types\n    display_list.rs     ← Display list generation\n    \n  geometry.rs           ← Point, Size, Rectangle utilities\n  color.rs              ← Color type and parsing\n```\n\n#### Core Geometry Types (Complete Implementation)\n\n```rust\n// geometry.rs - Complete foundational types\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Point {\n    pub x: f32,\n    pub y: f32,\n}\n\nimpl Point {\n    pub fn new(x: f32, y: f32) -> Self {\n        Point { x, y }\n    }\n    \n    pub fn origin() -> Self {\n        Point { x: 0.0, y: 0.0 }\n    }\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Size {\n    pub width: f32,\n    pub height: f32,\n}\n\nimpl Size {\n    pub fn new(width: f32, height: f32) -> Self {\n        Size { width, height }\n    }\n    \n    pub fn zero() -> Self {\n        Size { width: 0.0, height: 0.0 }\n    }\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Rectangle {\n    pub origin: Point,\n    pub size: Size,\n}\n\nimpl Rectangle {\n    pub fn new(x: f32, y: f32, width: f32, height: f32) -> Self {\n        Rectangle {\n            origin: Point::new(x, y),\n            size: Size::new(width, height),\n        }\n    }\n    \n    pub fn contains_point(&self, point: Point) -> bool {\n        // TODO: Check if point.x is within [origin.x, origin.x + size.width]\n        // TODO: Check if point.y is within [origin.y, origin.y + size.height]  \n        // TODO: Return true only if both x and y are within bounds\n        todo!()\n    }\n    \n    pub fn intersects(&self, other: &Rectangle) -> bool {\n        // TODO: Calculate right edge as origin.x + size.width for both rectangles\n        // TODO: Calculate bottom edge as origin.y + size.height for both rectangles\n        // TODO: Check if rectangles overlap horizontally and vertically\n        // TODO: Return false if no overlap on either axis\n        todo!()\n    }\n}\n```\n\n#### Color Type Implementation (Complete)\n\n```rust\n// color.rs - Complete color handling\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Color {\n    pub r: u8,\n    pub g: u8,\n    pub b: u8,\n    pub a: u8,\n}\n\nimpl Color {\n    pub fn rgb(r: u8, g: u8, b: u8) -> Self {\n        Color { r, g, b, a: 255 }\n    }\n    \n    pub fn rgba(r: u8, g: u8, b: u8, a: u8) -> Self {\n        Color { r, g, b, a }\n    }\n    \n    pub fn from_hex(hex: &str) -> Result<Color, String> {\n        let hex = hex.trim_start_matches('#');\n        if hex.len() != 6 {\n            return Err(\"Hex color must be 6 characters\".to_string());\n        }\n        \n        let r = u8::from_str_radix(&hex[0..2], 16)\n            .map_err(|_| \"Invalid hex digits\")?;\n        let g = u8::from_str_radix(&hex[2..4], 16)\n            .map_err(|_| \"Invalid hex digits\")?;\n        let b = u8::from_str_radix(&hex[4..6], 16)\n            .map_err(|_| \"Invalid hex digits\")?;\n            \n        Ok(Color::rgb(r, g, b))\n    }\n}\n\n// Standard color constants\npub const WHITE: Color = Color { r: 255, g: 255, b: 255, a: 255 };\npub const BLACK: Color = Color { r: 0, g: 0, b: 0, a: 255 };\npub const TRANSPARENT: Color = Color { r: 0, g: 0, b: 0, a: 0 };\n```\n\n#### DOM Node Type Skeleton\n\n```rust\n// dom/node.rs - Core DOM types for implementation\nuse std::collections::HashMap;\n\n#[derive(Debug, Clone)]\npub enum DOMNode {\n    Element(ElementData),\n    Text(String),\n    Comment(String),\n    Document(DocumentData),\n}\n\n#[derive(Debug, Clone)]\npub struct ElementData {\n    pub tag_name: String,\n    pub attributes: HashMap<String, String>,\n    pub children: Vec<DOMNode>,\n}\n\n#[derive(Debug, Clone)]  \npub struct DocumentData {\n    pub doctype: Option<String>,\n    pub title: Option<String>,\n    pub children: Vec<DOMNode>,\n}\n\nimpl DOMNode {\n    pub fn get_text_content(&self) -> String {\n        // TODO: Match on node type\n        // TODO: For Text nodes, return the string content directly\n        // TODO: For Element/Document nodes, recursively collect text from all children\n        // TODO: For Comment nodes, return empty string\n        // TODO: Concatenate all text content with proper whitespace handling\n        todo!()\n    }\n    \n    pub fn matches_selector(&self, selector: &str) -> bool {\n        // TODO: Parse selector string into Selector enum\n        // TODO: Match current element against selector type (tag, class, id)\n        // TODO: For class selectors, check if class exists in attributes[\"class\"]\n        // TODO: For id selectors, check if id matches attributes[\"id\"]\n        // TODO: For tag selectors, check if tag_name matches (case insensitive)\n        todo!()\n    }\n}\n```\n\n#### CSS Value and Unit Types Skeleton\n\n```rust\n// style/values.rs - CSS value type system\n#[derive(Debug, Clone, PartialEq)]\npub enum Unit {\n    Px(f32),\n    Percent(f32),\n    Em(f32),\n    Auto,\n}\n\nimpl Unit {\n    pub fn parse(input: &str) -> Result<Unit, String> {\n        // TODO: Trim whitespace from input\n        // TODO: Check for \"auto\" keyword and return Unit::Auto\n        // TODO: Use regex or manual parsing to extract number and unit suffix  \n        // TODO: Match unit suffix: \"px\" -> Px, \"%\" -> Percent, \"em\" -> Em\n        // TODO: Parse number portion as f32, handle parse errors\n        todo!()\n    }\n    \n    pub fn to_px(&self, parent_value: f32, font_size: f32) -> f32 {\n        // TODO: Match on Unit variant\n        // TODO: Px(value) returns value directly  \n        // TODO: Percent(value) returns parent_value * (value / 100.0)\n        // TODO: Em(value) returns font_size * value\n        // TODO: Auto should panic or return default - requires context to resolve\n        todo!()\n    }\n}\n\n#[derive(Debug, Clone)]\npub enum CSSValue {\n    Length(Unit),\n    Color(Color),\n    Keyword(String),\n    String(String),\n    Number(f32),\n}\n```\n\n#### Layout Box Model Skeleton\n\n```rust\n// layout/box_model.rs - Box model calculation\nuse crate::geometry::{Rectangle, Size, Point};\nuse crate::style::ComputedStyle;\n\n#[derive(Debug, Clone)]\npub struct LayoutBox {\n    pub box_type: BoxType,\n    pub content_rect: Rectangle,\n    pub padding_rect: Rectangle,\n    pub border_rect: Rectangle,\n    pub margin_rect: Rectangle,\n    pub children: Vec<LayoutBox>,\n    pub computed_style: ComputedStyle,\n}\n\n#[derive(Debug, Clone, PartialEq)]\npub enum BoxType {\n    BlockContainer,\n    InlineContainer, \n    TextBox,\n    AnonymousBlock,\n}\n\nimpl LayoutBox {\n    pub fn calculate_box_model(&mut self, containing_width: f32) {\n        // TODO: Extract margin, border, padding values from computed_style\n        // TODO: Resolve percentage values using containing_width parameter\n        // TODO: Calculate content_rect dimensions based on width/height properties\n        // TODO: Expand content_rect by padding to get padding_rect\n        // TODO: Expand padding_rect by border to get border_rect  \n        // TODO: Expand border_rect by margin to get margin_rect\n        // TODO: Handle special cases like negative margins and box-sizing property\n        todo!()\n    }\n    \n    pub fn layout_block_children(&mut self, available_width: f32) {\n        // TODO: Initialize y_offset to start of content area\n        // TODO: Iterate through children in order\n        // TODO: For each child, call calculate_box_model with available_width\n        // TODO: Position child at current y_offset\n        // TODO: Advance y_offset by child's total height including margins\n        // TODO: Handle margin collapsing between adjacent block children\n        todo!()\n    }\n}\n```\n\n#### Milestone Checkpoint: Data Structure Validation\n\nAfter implementing these core types, verify correct behavior with these tests:\n\n**DOM Tree Validation:**\n- Create a simple DOM tree with nested elements\n- Verify parent-child relationships are bidirectional\n- Test text content extraction across multiple nesting levels\n- Confirm attribute access is case-insensitive for names, preserves case for values\n\n**CSS Value Resolution:**\n- Parse various unit types (px, %, em, auto) from strings\n- Test unit conversion with different parent and font size contexts\n- Verify color parsing from hex strings and named colors\n- Check specificity calculation for complex selectors\n\n**Layout Box Model:**\n- Create layout box with margin, border, padding values\n- Verify the four rectangles (content, padding, border, margin) have correct dimensions\n- Test percentage unit resolution using containing block dimensions\n- Confirm box model calculation handles edge cases like negative margins\n\n**Integration Testing:**\n- Build complete styled DOM tree from HTML + CSS\n- Generate layout tree with proper box model calculations\n- Verify layout tree structure matches DOM tree hierarchy\n- Test that computed styles cascade correctly through inheritance\n\n#### Debugging Tips\n\n| Symptom | Likely Cause | How to Diagnose | Fix |\n|---------|--------------|-----------------|-----|\n| Incorrect text content extraction | Missing recursive traversal of child nodes | Add debug prints showing which nodes are visited during traversal | Implement proper depth-first search through all child nodes |\n| CSS rules not matching elements | Case sensitivity or attribute parsing issues | Log selector matching attempts and attribute maps | Normalize tag names and attribute names to lowercase |\n| Box dimensions don't add up | Incorrect box model calculation or percentage resolution | Print all four rectangle bounds and their calculations | Verify each rectangle expands the previous by the correct amount |\n| Layout tree missing nodes | DOM nodes with display:none not handled correctly | Compare DOM tree size with layout tree size | Skip DOM nodes with display:none during layout tree construction |\n| Memory usage grows unexpectedly | Circular references in tree structures or missing cleanup | Use memory profiler to track allocation patterns | Ensure parent references use weak pointers or indices to avoid cycles |\n\n\n## HTML Parser Design\n\n> **Milestone(s):** Milestone 1 (HTML Parser) - This section implements the foundational HTML parsing system that converts raw HTML text into a structured DOM tree, providing the essential document representation for all subsequent rendering pipeline stages.\n\nThe HTML parser represents the critical first stage of our browser rendering pipeline, transforming unstructured text markup into a hierarchical document representation. Think of HTML parsing as **the librarian of our browser engine** - just as a librarian takes a chaotic pile of loose papers and organizes them into a properly catalogued, cross-referenced system where every document has its proper place and relationship to other materials, the HTML parser takes raw text and creates a meticulously structured tree where every element knows its parent, children, and position in the document hierarchy.\n\nThis transformation is far more complex than simply splitting text on angle brackets. Real-world HTML is often malformed, contains implicit structures, and requires sophisticated error recovery. The parser must handle everything from perfectly formatted markup to the messiest tag soup found in legacy websites, always producing a valid DOM tree that subsequent pipeline stages can reliably process.\n\n![HTML Parsing State Machine](./diagrams/html-parsing-flow.svg)\n\n### HTML Tokenization\n\nHTML tokenization serves as the lexical analysis phase that breaks raw HTML text into meaningful tokens. Think of **tokenization as a careful archaeologist** who examines an ancient manuscript character by character, identifying where words begin and end, distinguishing between different types of text (headings, body text, annotations), and recognizing structural elements like chapter breaks or marginalia. The tokenizer performs this same meticulous analysis on HTML, recognizing that `<div` represents the beginning of a start tag, that `class=\"header\"` contains an attribute, and that `</div>` represents a complete end tag.\n\nThe tokenization process operates as a state machine that transitions between different parsing contexts based on the current character and parsing state. When the tokenizer encounters a `<` character in normal text content, it transitions from the \"data state\" to the \"tag open state.\" If the next character is a letter, it moves to the \"tag name state\" and begins accumulating tag name characters. If it encounters a space, it transitions to \"before attribute name state\" to parse attributes. This state-driven approach ensures that the same character sequence can be interpreted differently depending on context - for example, `<` in text content versus `<` beginning a tag.\n\n> **Decision: State Machine Architecture for HTML Tokenization**\n> - **Context**: HTML tokenization requires parsing context-sensitive grammar where the same characters have different meanings in different contexts (text content vs. tag names vs. attribute values)\n> - **Options Considered**: \n>   1. Regular expression-based parsing with multiple passes\n>   2. Hand-written recursive descent parser\n>   3. State machine tokenizer following HTML5 specification\n> - **Decision**: State machine tokenizer following HTML5 specification  \n> - **Rationale**: State machines provide precise control over parsing context, handle malformed input gracefully, and align with how real browsers parse HTML. Regular expressions cannot handle the full complexity of HTML's context-sensitive grammar, while recursive descent would be unnecessarily complex for tokenization.\n> - **Consequences**: Enables robust error recovery, matches browser behavior exactly, but requires careful state management and comprehensive state transition logic.\n\nThe tokenizer must distinguish between several fundamental token types, each representing a different structural element in the HTML document. Start tags like `<div class=\"content\">` indicate the beginning of an element and contain the tag name plus any attributes. End tags like `</div>` signal element closure and contain only the tag name. Self-closing tags like `<img src=\"photo.jpg\" />` represent complete elements that don't contain child content. Text tokens contain the actual content between tags, including whitespace that may be significant for layout. Comment tokens like `<!-- this is a comment -->` represent developer annotations that should be preserved in the DOM but not rendered.\n\n| Token Type | Structure | Example | Description |\n|------------|-----------|---------|-------------|\n| StartTag | tag_name: String, attributes: HashMap<String, String>, self_closing: bool | `<div class=\"header\">` | Opening tag with optional attributes |\n| EndTag | tag_name: String | `</div>` | Closing tag containing only tag name |\n| Text | content: String | `Hello World` | Text content between tags |\n| Comment | content: String | `<!-- comment -->` | Developer comments preserved in DOM |\n| Doctype | name: String, public_id: Option<String>, system_id: Option<String> | `<!DOCTYPE html>` | Document type declaration |\n\nThe tokenizer handles attribute parsing with particular care, as attributes can contain complex quoted values, unquoted values, and edge cases like empty attributes or attributes without values. When parsing `<img src=\"photo.jpg\" alt='A \"nice\" photo' hidden>`, the tokenizer must recognize that the `src` attribute has a double-quoted value, the `alt` attribute has a single-quoted value containing escaped double quotes, and `hidden` is a boolean attribute without a value. This requires transitioning between \"attribute name,\" \"before attribute value,\" \"attribute value quoted,\" and \"attribute value unquoted\" states while properly handling quote escaping and whitespace normalization.\n\n> **Critical insight**: The HTML tokenizer must handle attributes containing JavaScript code, CSS rules, or other embedded languages without attempting to parse those languages. The tokenizer's responsibility ends at extracting the attribute value as a string - interpretation of that content happens in later pipeline stages.\n\nCharacter entity decoding represents another crucial tokenization responsibility. When the tokenizer encounters sequences like `&amp;`, `&lt;`, or `&#65;`, it must decode these to their corresponding characters (`&`, `<`, `A`). However, entity decoding behavior varies by context - entities in attribute values have different rules than entities in text content. Named entities require a lookup table of predefined names, while numeric entities require conversion from decimal or hexadecimal numbers to Unicode code points.\n\n**Common Tokenization Pitfalls:**\n\n⚠️ **Pitfall: Case Sensitivity Confusion**\nMany developers incorrectly assume HTML tag names and attribute names are case-sensitive. The HTML5 specification requires that tag names and attribute names be treated case-insensitively in HTML documents (but case-sensitively in XML documents). Failing to normalize case leads to selector matching failures in later stages. Always convert tag names and attribute names to lowercase during tokenization.\n\n⚠️ **Pitfall: Incomplete Entity Decoding**\nImplementing only the most common entities like `&amp;`, `&lt;`, `&gt;` while ignoring numeric entities or less common named entities breaks pages using international characters or special symbols. The HTML5 specification includes over 2,000 named entities. Use a complete entity lookup table or a well-tested entity decoding library.\n\n⚠️ **Pitfall: Attribute Value Whitespace Handling**\nHTML has complex rules for whitespace handling in attribute values. Leading and trailing whitespace should be trimmed, and internal whitespace should be normalized (multiple consecutive whitespace characters become a single space) for most attributes. However, some attributes like `style` preserve whitespace exactly. Understanding these nuances prevents layout and styling issues later.\n\n### DOM Tree Construction\n\nDOM tree construction transforms the linear stream of tokens from the tokenizer into a hierarchical tree structure that represents the document's logical organization. Think of this process as **an architect reviewing building blueprints** - the tokenizer has identified all the individual components (walls, doors, windows, electrical fixtures), and now the tree builder must understand how these components fit together to create rooms, floors, and ultimately a complete building structure. The tree builder knows that a `<div>` token starts a new container that can hold other elements, while a `</div>` token closes that container, and it maintains the nesting relationships that define the document hierarchy.\n\nThe tree construction algorithm operates using an explicit stack that tracks the currently open elements, mirroring the nested structure of HTML tags. When the parser encounters a start tag token, it creates a new DOM node and pushes it onto the open element stack. This new element becomes the current insertion point for subsequent content. When parsing `<div><p>Hello</p></div>`, the algorithm first pushes the `div` element onto the stack, then pushes the `p` element. The text token \"Hello\" gets inserted as a child of the current stack top (the `p` element). When the `</p>` end tag appears, the algorithm pops the `p` element from the stack, making `div` the current insertion point again.\n\n> **Decision: Stack-Based Tree Construction Algorithm**\n> - **Context**: Need to build hierarchical DOM tree from linear token stream while handling arbitrary nesting depth and malformed markup\n> - **Options Considered**:\n>   1. Recursive descent with explicit recursion stack\n>   2. Stack-based iterative algorithm with explicit open element stack  \n>   3. Two-pass algorithm that first validates structure then builds tree\n> - **Decision**: Stack-based iterative algorithm with explicit open element stack\n> - **Rationale**: Stack-based approach directly models HTML's nesting semantics, provides precise control over error recovery, avoids recursion depth limits, and matches HTML5 specification algorithms. Two-pass validation would be less efficient and couldn't handle certain malformed markup patterns.\n> - **Consequences**: Enables robust error recovery, handles arbitrarily deep nesting, but requires careful stack management and complex insertion mode logic.\n\nThe DOM node structure must efficiently represent both element nodes containing tag information and text nodes containing content. Each node maintains bidirectional relationships with its parent and children, enabling efficient tree traversal in either direction. The node structure also preserves the original source information needed for error reporting and debugging tools.\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| node_type | DOMNodeType | Discriminates between Element, Text, Comment, Document, and Doctype nodes |\n| parent | Option<DOMNodeHandle> | Reference to parent node, None for document root |\n| children | Vec<DOMNodeHandle> | Ordered list of direct children |\n| node_data | DOMNodeData | Type-specific data (ElementData for elements, String for text) |\n| source_location | Option<SourceLocation> | Original position in source HTML for debugging |\n\nElement nodes require additional metadata beyond the basic tree structure. The `ElementData` structure stores the tag name, attribute map, namespace information for XML documents, and whether the element is a void element that cannot contain children. This information drives both the tree construction algorithm and later processing stages.\n\n| Field Name | Type | Description |\n|------------|------|-------------|\n| tag_name | String | Lowercase normalized tag name (e.g., \"div\", \"img\") |\n| attributes | HashMap<String, String> | Attribute name-value pairs with normalized names |\n| namespace | Option<String> | XML namespace URI, None for HTML documents |\n| is_void | bool | True for void elements that cannot have children (img, br, hr) |\n\nThe tree construction algorithm must handle void elements specially, as these represent complete elements that cannot contain children. When the parser encounters `<img src=\"photo.jpg\">`, it creates an element node and immediately considers it complete - no corresponding end tag is expected or allowed. The HTML5 specification defines a specific set of void elements including `area`, `base`, `br`, `col`, `embed`, `hr`, `img`, `input`, `link`, `meta`, `param`, `source`, `track`, and `wbr`. Attempting to nest content inside void elements represents a parsing error that requires error recovery.\n\nText node handling requires careful consideration of whitespace normalization and adjacent text node coalescing. When the parser encounters multiple consecutive text tokens (perhaps separated by comments), it should typically merge them into a single text node to simplify later processing. However, the algorithm must preserve semantically significant whitespace while normalizing insignificant whitespace according to CSS whitespace processing rules.\n\n**DOM Tree Construction Algorithm:**\n\n1. Initialize an empty open element stack with the document node as the root\n2. Set the current insertion mode based on document type and context\n3. For each token from the tokenizer:\n   - If StartTag token: Create element node with tag name and attributes, insert into tree at current position, push onto stack (unless void element)\n   - If EndTag token: Pop elements from stack until matching start tag found, validate proper nesting\n   - If Text token: Create text node with content, insert as child of current stack top\n   - If Comment token: Create comment node, insert at current position\n4. Handle insertion mode changes for special elements (table, select, frameset)\n5. Perform error recovery for malformed markup (unclosed tags, improper nesting)\n6. Return completed DOM tree with document root\n\nThe algorithm includes sophisticated insertion mode logic that changes parsing behavior based on the current context. When parsing inside a `<table>` element, the parser enters \"in table\" mode where text tokens are handled differently than in normal content. Similarly, parsing inside `<select>` elements restricts which child elements are allowed. These modes ensure that the resulting DOM tree matches browser behavior even for complex nested structures.\n\n### Error Recovery and Edge Cases\n\nReal-world HTML rarely follows specifications perfectly, requiring robust error recovery mechanisms that produce sensible DOM trees from malformed markup. Think of error recovery as **an experienced emergency room doctor** who encounters patients with unusual symptoms and incomplete medical histories. The doctor uses their knowledge of human anatomy and common patterns to make the best possible diagnosis and treatment plan with incomplete information. Similarly, the HTML parser uses its understanding of intended document structure and common authoring patterns to construct the most reasonable DOM tree possible from broken markup.\n\nThe most common parsing errors involve missing closing tags, where authors write `<div><p>Content` without proper closing tags. The error recovery algorithm must determine where these implicit closures should occur. When the parser reaches the end of input with unclosed elements remaining on the stack, it automatically closes all open elements in reverse order. However, more sophisticated recovery occurs when encountering mismatched tags - if the parser sees `<div><p>Content</div>`, it must decide whether to implicitly close the `<p>` element before closing the `<div>`, or treat the `</div>` as mismatched and ignore it.\n\n> **Decision: Implicit Tag Closure with Foster Parenting**\n> - **Context**: Need to handle malformed HTML where tags are improperly nested, unclosed, or appear in invalid contexts\n> - **Options Considered**:\n>   1. Strict parsing that rejects malformed markup\n>   2. Best-effort parsing with implicit tag closure\n>   3. Permissive parsing that accepts any tag structure\n> - **Decision**: Best-effort parsing with implicit tag closure following HTML5 foster parenting algorithm\n> - **Rationale**: Real web content contains substantial amounts of malformed HTML that must render correctly. Strict parsing would break too many existing websites. Foster parenting provides predictable, specification-defined behavior for edge cases.\n> - **Consequences**: Enables compatibility with legacy content but requires complex error recovery logic and careful testing of edge cases.\n\nFoster parenting represents the most complex error recovery mechanism, handling content that appears in contexts where it cannot be properly inserted. When parsing table-related markup, text content or block elements that appear directly inside `<table>` elements (where only `<tr>`, `<thead>`, `<tbody>` elements should appear) must be \"fostered\" out of the table to the nearest appropriate parent. This ensures that content remains accessible while maintaining table structure integrity.\n\nConsider the malformed markup: `<table><div>Misplaced content</div><tr><td>Cell</td></tr></table>`. The foster parenting algorithm recognizes that the `<div>` element cannot legally appear as a direct child of `<table>`. Instead of dropping the content or breaking the table structure, it moves the `<div>` to become a sibling of the `<table>` element, preserving both the table structure and the misplaced content.\n\n| Error Type | Detection | Recovery Strategy | Example |\n|------------|-----------|------------------|---------|\n| Unclosed Elements | End of input with non-empty element stack | Implicitly close all open elements in reverse order | `<div><p>Text` → closes both `p` and `div` |\n| Mismatched End Tags | End tag doesn't match current stack top | Pop stack until matching start tag found | `<div><span></div>` → implicitly closes `span` |\n| Void Element End Tags | End tag for void element | Ignore the end tag | `<img></img>` → ignore `</img>` |\n| Content in Wrong Context | Text/elements in table/select context | Foster parent to appropriate location | Text in `<table>` → move outside table |\n| Invalid Nesting | Block elements inside inline elements | Close inline element, reopen after block | `<b><div>text</div></b>` → restructure nesting |\n\nCharacter encoding detection and handling represents another critical error recovery area. While modern HTML should specify encoding via `<meta charset=\"utf-8\">`, legacy content may omit encoding declarations or specify incorrect encodings. The parser must implement encoding detection heuristics, scanning the first few kilobytes of the document for encoding hints while being prepared to restart parsing if it discovers the encoding declaration indicates a different encoding than initially assumed.\n\nEntity decoding errors require graceful handling when encountering malformed entity references. Invalid named entities like `&invalidname;` should be treated as literal text rather than causing parse failures. Incomplete numeric entities like `&#` followed by end-of-input should similarly be treated as literal text. However, the parser must be careful not to over-interpret text that looks like entities but isn't intended as such.\n\n**Critical Edge Cases:**\n\n⚠️ **Pitfall: Script and Style Content Processing**\nContent inside `<script>` and `<style>` elements follows different parsing rules than normal HTML content. These elements can contain what appears to be HTML markup that should be treated as literal text rather than parsed tags. For example, `<script>if (x < 5) document.write('<div>');</script>` contains `<` and `<div>` that must not be interpreted as HTML tags. The parser must switch to raw text mode when entering these elements and only exit when encountering the appropriate end tag.\n\n⚠️ **Pitfall: Case Sensitivity in End Tag Matching**\nWhile HTML tag names are case-insensitive, the end tag matching algorithm must handle cases where start and end tags use different capitalization. `<DIV>` should properly match `</div>`. However, the comparison must be case-insensitive while preserving the original case in error messages and debugging output.\n\n⚠️ **Pitfall: Attribute Duplication Handling**\nHTML elements may contain duplicate attribute declarations like `<div class=\"first\" class=\"second\">`. The HTML5 specification requires that only the first occurrence of each attribute name be preserved, with subsequent duplicates ignored. Failing to implement this correctly can cause confusion in later CSS matching and JavaScript DOM manipulation.\n\nThe parser must also handle document fragments correctly when parsing HTML that doesn't represent a complete document. This occurs when parsing HTML snippets for insertion into existing documents via JavaScript's `innerHTML` property. Fragment parsing requires different error recovery rules and omits certain document-level structures like the implicit `<html>` and `<body>` elements that would normally be inserted.\n\n**Performance Considerations:**\n\nString handling represents the primary performance bottleneck in HTML parsing, as the parser must examine every character in the input while creating numerous temporary strings for tag names, attribute values, and text content. Efficient implementations minimize string copying by using string references or slices that point into the original input buffer where possible. However, entity decoding and case normalization may require string modifications that force copying.\n\nMemory management requires careful attention to avoid creating excessive temporary allocations during parsing. The open element stack typically contains only a few dozen elements even for complex documents, but naive implementations might create unnecessary intermediate collections or duplicate node references. Using arena allocation or object pooling for DOM nodes can significantly improve performance for applications that parse many documents.\n\n### Implementation Guidance\n\nThe HTML parser implementation requires careful attention to state management and error recovery while maintaining clean separation between tokenization and tree construction phases.\n\n**Technology Recommendations:**\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| String Processing | `String` and `&str` with manual parsing | `nom` parsing combinator library |\n| Character Encoding | UTF-8 only with `std::str::from_utf8` | `encoding_rs` for full encoding support |\n| Entity Decoding | Manual lookup table with `HashMap<&str, char>` | `html-escape` crate for complete entity support |\n| Error Handling | `Result<T, String>` with string error messages | `thiserror` for structured error types |\n\n**Recommended File Structure:**\n\n```\nsrc/\n  html/\n    mod.rs                 ← public interface and re-exports\n    tokenizer.rs          ← HTML tokenization state machine\n    tree_builder.rs       ← DOM tree construction algorithm\n    entities.rs           ← character entity decoding\n    error_recovery.rs     ← malformed markup handling\n    tests/\n      tokenizer_tests.rs  ← tokenization test cases\n      parser_tests.rs     ← complete parsing test cases\n      malformed_tests.rs  ← error recovery test cases\n  dom/\n    mod.rs                ← DOM node types and tree operations\n    node.rs               ← DOMNode and related types\n    element.rs            ← ElementData and attribute handling\n    document.rs           ← Document root and metadata\n```\n\n**Infrastructure Starter Code:**\n\n```rust\n// src/html/entities.rs - Complete entity decoding implementation\nuse std::collections::HashMap;\n\nlazy_static::lazy_static! {\n    static ref HTML_ENTITIES: HashMap<&'static str, char> = {\n        let mut m = HashMap::new();\n        m.insert(\"amp\", '&');\n        m.insert(\"lt\", '<');\n        m.insert(\"gt\", '>');\n        m.insert(\"quot\", '\"');\n        m.insert(\"apos\", '\\'');\n        m.insert(\"nbsp\", '\\u{00A0}');\n        // Add complete HTML5 entity table here\n        m\n    };\n}\n\npub fn decode_entity(entity_name: &str) -> Option<char> {\n    HTML_ENTITIES.get(entity_name).copied()\n}\n\npub fn decode_numeric_entity(entity_text: &str) -> Option<char> {\n    if entity_text.starts_with('#') {\n        let number_part = &entity_text[1..];\n        if number_part.starts_with('x') || number_part.starts_with('X') {\n            // Hexadecimal numeric entity\n            u32::from_str_radix(&number_part[1..], 16)\n                .ok()\n                .and_then(|code| std::char::from_u32(code))\n        } else {\n            // Decimal numeric entity\n            number_part.parse::<u32>()\n                .ok()\n                .and_then(|code| std::char::from_u32(code))\n        }\n    } else {\n        None\n    }\n}\n\n// src/html/error_recovery.rs - Error recovery utilities\n#[derive(Debug, Clone)]\npub enum ParseError {\n    UnexpectedEndTag { expected: String, found: String },\n    UnclosedElement { tag_name: String },\n    InvalidNesting { parent: String, child: String },\n    MalformedEntity { entity_text: String },\n}\n\npub struct ErrorRecovery {\n    pub errors: Vec<ParseError>,\n}\n\nimpl ErrorRecovery {\n    pub fn new() -> Self {\n        Self { errors: Vec::new() }\n    }\n    \n    pub fn report_error(&mut self, error: ParseError) {\n        self.errors.push(error);\n    }\n    \n    pub fn is_void_element(tag_name: &str) -> bool {\n        matches!(tag_name.to_lowercase().as_str(), \n            \"area\" | \"base\" | \"br\" | \"col\" | \"embed\" | \"hr\" | \n            \"img\" | \"input\" | \"link\" | \"meta\" | \"param\" | \n            \"source\" | \"track\" | \"wbr\")\n    }\n}\n```\n\n**Core Logic Skeleton Code:**\n\n```rust\n// src/html/tokenizer.rs - HTML tokenization state machine\nuse crate::dom::{ElementData};\nuse crate::html::entities::{decode_entity, decode_numeric_entity};\n\n#[derive(Debug, Clone)]\npub enum HTMLToken {\n    StartTag { \n        tag_name: String, \n        attributes: HashMap<String, String>, \n        self_closing: bool \n    },\n    EndTag { tag_name: String },\n    Text { content: String },\n    Comment { content: String },\n    Doctype { name: String },\n}\n\n#[derive(Debug, Clone, Copy)]\nenum TokenizerState {\n    Data,\n    TagOpen,\n    TagName,\n    BeforeAttributeName,\n    AttributeName,\n    AfterAttributeName,\n    BeforeAttributeValue,\n    AttributeValueQuoted,\n    AttributeValueUnquoted,\n    AfterAttributeValue,\n    // Add more states as needed\n}\n\npub struct HTMLTokenizer {\n    input: String,\n    position: usize,\n    state: TokenizerState,\n    current_token: Option<HTMLToken>,\n    // Add more state fields as needed\n}\n\nimpl HTMLTokenizer {\n    pub fn new(input: String) -> Self {\n        // TODO 1: Initialize tokenizer with input string and starting state\n        // TODO 2: Set position to 0 and state to TokenizerState::Data\n        // TODO 3: Initialize current_token to None\n        todo!()\n    }\n    \n    pub fn next_token(&mut self) -> Option<HTMLToken> {\n        // TODO 1: Enter main tokenization loop while position < input.len()\n        // TODO 2: Get current character at position\n        // TODO 3: Match on current state and character to determine transitions\n        // TODO 4: Update state, advance position, accumulate token data\n        // TODO 5: Return completed token when state machine emits one\n        // Hint: Use a loop with match statements for state transitions\n        // Hint: Some characters trigger immediate token emission\n        todo!()\n    }\n    \n    fn current_char(&self) -> Option<char> {\n        // TODO: Return character at current position, None if at end\n        todo!()\n    }\n    \n    fn advance(&mut self) {\n        // TODO: Increment position, handle bounds checking\n        todo!()\n    }\n    \n    fn emit_token(&mut self, token: HTMLToken) -> HTMLToken {\n        // TODO 1: Store token for return\n        // TODO 2: Reset current token state\n        // TODO 3: Return to appropriate state for next token\n        todo!()\n    }\n}\n\n// src/html/tree_builder.rs - DOM tree construction\nuse crate::dom::{DOMNode, DOMNodeType, DOMNodeHandle, ElementData};\nuse crate::html::{HTMLToken, ParseError};\n\npub struct TreeBuilder {\n    document: DOMNodeHandle,\n    open_elements: Vec<DOMNodeHandle>,\n    current_node: DOMNodeHandle,\n}\n\nimpl TreeBuilder {\n    pub fn new() -> Self {\n        // TODO 1: Create document root node\n        // TODO 2: Initialize empty open elements stack\n        // TODO 3: Set document as current insertion point\n        todo!()\n    }\n    \n    pub fn process_token(&mut self, token: HTMLToken) -> Result<(), ParseError> {\n        // TODO 1: Match on token type (StartTag, EndTag, Text, Comment)\n        // TODO 2: For StartTag: create element, insert into tree, push to stack\n        // TODO 3: For EndTag: find matching start tag, pop stack, handle errors\n        // TODO 4: For Text: create text node, insert as child of current element\n        // TODO 5: Handle void elements specially (don't push to stack)\n        // Hint: Use helper methods for each token type\n        todo!()\n    }\n    \n    fn insert_element(&mut self, tag_name: String, attributes: HashMap<String, String>) -> Result<DOMNodeHandle, ParseError> {\n        // TODO 1: Create new ElementData with normalized tag name\n        // TODO 2: Create DOMNode with Element type and ElementData\n        // TODO 3: Insert as child of current insertion point\n        // TODO 4: Update parent/child relationships\n        // TODO 5: Return handle to new element\n        todo!()\n    }\n    \n    fn insert_text(&mut self, content: String) -> Result<(), ParseError> {\n        // TODO 1: Check if content is only whitespace and handle appropriately\n        // TODO 2: Create text node with content\n        // TODO 3: Insert as child of current element\n        // TODO 4: Coalesce with previous text node if present\n        todo!()\n    }\n    \n    fn close_element(&mut self, tag_name: &str) -> Result<(), ParseError> {\n        // TODO 1: Search open elements stack for matching start tag\n        // TODO 2: If not found, report error and ignore end tag\n        // TODO 3: If found, pop all elements up to and including match\n        // TODO 4: Update current insertion point to new stack top\n        // TODO 5: Handle implicit closures for intervening elements\n        todo!()\n    }\n    \n    pub fn finish(self) -> DOMNodeHandle {\n        // TODO 1: Close any remaining open elements\n        // TODO 2: Perform final validation\n        // TODO 3: Return document root\n        todo!()\n    }\n}\n\n// src/html/mod.rs - Public parser interface\npub use tokenizer::{HTMLTokenizer, HTMLToken};\npub use tree_builder::TreeBuilder;\n\n/// Parse HTML string into DOM tree\npub fn parse_html(input: &str) -> Result<DOMNodeHandle, Vec<ParseError>> {\n    // TODO 1: Create tokenizer with input string\n    // TODO 2: Create tree builder\n    // TODO 3: Loop: get next token from tokenizer, process with tree builder\n    // TODO 4: Handle any parse errors that occur\n    // TODO 5: Return completed DOM tree or collected errors\n    // Hint: Collect errors rather than failing on first error\n    todo!()\n}\n```\n\n**Milestone Checkpoint:**\n\nAfter implementing the HTML parser, verify correct behavior:\n\n1. **Basic Parsing Test**: Parse `<html><body><h1>Hello</h1><p>World</p></body></html>` and verify the DOM tree has correct parent-child relationships with html→body→(h1,p) structure.\n\n2. **Attribute Handling**: Parse `<div class=\"header\" id=\"main\" hidden>` and verify attributes are extracted correctly with proper normalization.\n\n3. **Error Recovery**: Parse malformed HTML like `<div><p>Text</div>` and verify the parser implicitly closes the `<p>` element.\n\n4. **Void Elements**: Parse `<img src=\"test.jpg\"><br><input type=\"text\">` and verify these elements don't expect closing tags.\n\nExpected test output:\n```\n✓ Basic parsing creates correct tree structure\n✓ Attributes extracted and normalized properly  \n✓ Malformed HTML handled with error recovery\n✓ Void elements processed without expecting end tags\n✓ Text content preserved and properly positioned\n```\n\n**Debugging Tips:**\n\n| Symptom | Likely Cause | How to Diagnose | Fix |\n|---------|--------------|-----------------|-----|\n| Missing elements in DOM tree | Tokenizer not emitting start/end tag tokens | Add debug prints to tokenizer state machine | Check state transitions and character matching |\n| Incorrect parent-child relationships | Tree builder stack management issues | Print open element stack after each operation | Verify push/pop operations match start/end tags |\n| Attributes not parsed | Attribute state machine not working | Log state transitions during attribute parsing | Check quote handling and value accumulation |\n| Text content missing | Text tokens not processed by tree builder | Verify text token creation and insertion | Ensure text nodes inserted at correct tree position |\n| Parser hangs on malformed HTML | Infinite loop in error recovery | Add iteration limits and timeout detection | Implement proper error recovery fallbacks |\n\n\n## CSS Parser and Style System\n\n> **Milestone(s):** Milestone 2 (CSS Parser) - This section implements the CSS parsing and style resolution system that transforms CSS text into structured rules and computes the final styles for each DOM element through the cascade algorithm.\n\nThe CSS parser and style system form the second critical stage in our browser's rendering pipeline. Think of this component as a **sophisticated rule matching engine** - like a legal system that must parse complex laws (CSS rules), determine which laws apply to each citizen (DOM element), resolve conflicts when multiple laws contradict each other (specificity and cascade), and finally produce a definitive ruling (computed style) that governs each citizen's appearance.\n\nThis analogy captures the essence of CSS processing: we have a complex set of rules written in a domain-specific language, and we need to systematically apply these rules to a hierarchical document structure while resolving conflicts and inheritance relationships. The CSS specification defines precise algorithms for how this matching and resolution should work, making this one of the most algorithmically interesting parts of a browser engine.\n\nThe CSS parser transforms textual stylesheets into structured data that can be efficiently queried during style resolution. Unlike HTML parsing, which builds a single tree structure, CSS parsing must handle a more complex grammar with selectors, combinators, property declarations, and various value types. The parser must also be robust enough to handle invalid CSS gracefully, following the CSS specification's error recovery rules.\n\nOnce parsed, the style system implements the **cascade algorithm** - the heart of CSS that determines which styles actually apply to each element. The cascade considers multiple factors: selector specificity, source order, importance declarations, and inheritance relationships. This creates a sophisticated priority system that allows CSS to scale from simple styling to complex, layered design systems.\n\n### CSS Tokenization and Rule Parsing\n\nCSS tokenization breaks down stylesheet text into meaningful tokens that can be assembled into selectors, properties, and values. Think of the CSS tokenizer as a **specialized scanner** reading through a technical manual - it needs to recognize different types of content like chapter headings (selectors), instruction steps (declarations), and reference materials (values) while understanding the punctuation and formatting that gives structure to the document.\n\nThe tokenization process must handle CSS's diverse syntax elements: identifiers, strings, numbers with units, delimiters, functions, and special characters. Unlike HTML tokenization, which primarily deals with angle brackets and text content, CSS tokenization must recognize a much richer vocabulary of token types and understand context-sensitive parsing rules.\n\n> **Decision: Token-Based CSS Parser Architecture**\n> - **Context**: CSS has complex grammar with nested structures, multiple value types, and error recovery requirements\n> - **Options Considered**: \n>   1. Single-pass parser that builds rules directly from text\n>   2. Two-phase tokenizer + parser approach\n>   3. Parser combinator library\n> - **Decision**: Two-phase tokenizer + parser approach\n> - **Rationale**: Separates lexical analysis from grammatical analysis, making each phase simpler to implement and debug. Allows for better error recovery and easier testing of individual phases.\n> - **Consequences**: Requires maintaining token stream state but provides cleaner separation of concerns and more robust error handling\n\n| Parser Component | Responsibility | Input | Output |\n|------------------|---------------|--------|---------|\n| CSS Tokenizer | Lexical analysis of CSS text | Raw CSS string | Stream of `CSSToken` objects |\n| Selector Parser | Parses selector syntax and combinators | Token stream starting with selector | `Selector` structure with specificity |\n| Declaration Parser | Parses property-value pairs | Token stream for declaration block | Vec of `Declaration` objects |\n| Value Parser | Parses CSS values with type checking | Token stream for property value | Typed `CSSValue` variant |\n| Rule Builder | Assembles complete CSS rules | Parsed components | `CSSRule` with computed specificity |\n\nThe tokenizer implements a state machine that recognizes CSS tokens according to the CSS Syntax specification. The tokenizer must handle several challenging aspects of CSS syntax: strings can contain escaped characters, comments can appear almost anywhere, and numbers can have various unit suffixes that change their semantic meaning.\n\n**CSS Token Types and Recognition:**\n\n| Token Type | Pattern | Example | Parser Action |\n|------------|---------|---------|---------------|\n| Identifier | Letter followed by letters/digits/hyphens | `margin-top`, `body` | Used for property names, element selectors |\n| String | Text enclosed in quotes with escape handling | `\"Arial\"`, `'12px'` | Preserves content, processes escape sequences |\n| Hash | `#` followed by identifier characters | `#header`, `#ff0000` | Creates ID selector or color value |\n| Dimension | Number followed by identifier unit | `12px`, `1.5em`, `100%` | Parses numeric value and unit separately |\n| Function | Identifier followed by opening parenthesis | `rgb(`, `calc(` | Begins function value parsing |\n| Delimiter | Single character punctuation | `{`, `}`, `;`, `,` | Structural parsing control |\n\nThe selector parser handles CSS's rich selector syntax, including simple selectors, combinators, and compound selectors. Each selector type has different matching semantics and contributes differently to specificity calculations. The parser must correctly handle selector groups (comma-separated selectors) and complex selector chains with multiple combinators.\n\n**Selector Parsing Algorithm:**\n\n1. **Initialize parsing context** with empty selector list and current combinator as descendant\n2. **Parse simple selector** starting with type selector, universal selector, or attribute selector\n3. **Check for selector modifiers** like class selectors (`.classname`) or ID selectors (`#idname`)\n4. **Accumulate modifiers** until encountering combinator or end of selector\n5. **Process combinator** if present (space for descendant, `>` for child, `+` for adjacent sibling, `~` for general sibling)\n6. **Create selector node** with parsed components and computed specificity\n7. **Continue parsing** if more selector components remain in the chain\n8. **Handle selector groups** by splitting on commas and parsing each selector independently\n\n> The CSS specification defines selector parsing as a context-sensitive process where the meaning of certain characters depends on their position and surrounding tokens. For example, `>` can be part of a selector combinator or part of a CSS custom property value.\n\n**Declaration Parsing and Property Validation:**\n\nProperty declarations require careful parsing because CSS values have complex syntax rules that vary by property type. The parser must recognize different value types (lengths, colors, keywords, functions) and validate them against the expected syntax for each property.\n\n| Property Category | Value Types | Validation Rules | Example |\n|------------------|-------------|------------------|---------|\n| Length Properties | Dimension tokens with length units | Must be positive for width/height | `width: 200px` |\n| Color Properties | Hex, RGB function, named colors | Alpha values between 0-1 | `color: rgb(255, 0, 0)` |\n| Display Properties | Keyword tokens from allowed set | Must match CSS display specification | `display: block` |\n| Font Properties | Keywords, strings, dimension lists | Font families require quotes if multi-word | `font-family: \"Times New Roman\"` |\n| Box Model Properties | Dimension, auto keyword, percentage | Can use shorthand with 1-4 values | `margin: 10px 20px` |\n\n**Error Recovery in CSS Parsing:**\n\nCSS parsing follows the principle of **graceful degradation** - invalid rules are ignored, but parsing continues for the rest of the stylesheet. This allows browsers to handle CSS written for newer specifications while maintaining backward compatibility.\n\nThe parser implements several error recovery strategies:\n\n1. **Declaration-level recovery**: If a property value is invalid, ignore just that declaration and continue parsing the next one\n2. **Rule-level recovery**: If a selector is malformed, skip the entire rule block but continue with subsequent rules\n3. **Block-level recovery**: If braces are unmatched, scan forward to find the next properly nested rule block\n4. **Tokenization recovery**: If an unexpected character is encountered, treat it as a delimiter and continue tokenization\n\n### Specificity and Cascade Resolution\n\nCSS specificity and cascade resolution implement the core logic that determines which styles actually apply when multiple rules target the same element. Think of this process as a **sophisticated arbitration system** - like a court that must weigh different types of evidence, consider the authority of different witnesses, and apply precedent rules to reach a final judgment when multiple parties present conflicting claims.\n\nThe cascade algorithm considers four key factors in order of precedence: origin and importance, specificity, source order, and inheritance. Each factor serves as a tie-breaker when the previous factors result in equal priority between competing rules.\n\n**CSS Cascade Priority Algorithm:**\n\n1. **Filter applicable rules** by matching selectors against the target element and its ancestors\n2. **Group rules by origin** (user-agent, author, user) and separate `!important` declarations\n3. **Apply origin precedence**: user `!important` > author `!important` > author normal > user normal > user-agent\n4. **Calculate specificity** for each applicable rule using the (inline, IDs, classes, elements) tuple\n5. **Sort rules by specificity** with higher specificity values taking precedence\n6. **Apply source order** as final tie-breaker, with later rules overriding earlier ones\n7. **Resolve inheritance** for properties not explicitly set through the cascade\n\n> **Decision: Four-Tuple Specificity Calculation**\n> - **Context**: Need to implement CSS specificity algorithm that matches browser behavior exactly\n> - **Options Considered**:\n>   1. Single integer specificity score\n>   2. Three-component (ID, class, element) specificity\n>   3. Four-component (inline, ID, class, element) specificity as per CSS spec\n> - **Decision**: Four-component specificity matching CSS specification\n> - **Rationale**: Ensures exact compliance with CSS specification and handles inline styles correctly. Prevents specificity overflow issues that can occur with integer scoring.\n> - **Consequences**: Requires more complex comparison logic but guarantees spec-compliant behavior\n\n**Specificity Calculation Details:**\n\nThe CSS specification defines specificity as a four-part value where each component is counted independently. This prevents lower-specificity selectors from \"overflowing\" into higher specificity categories, ensuring that a single ID selector always beats any number of class selectors.\n\n| Specificity Component | Incremented By | Examples | Weight |\n|----------------------|---------------|----------|--------|\n| Inline Styles | `style` attribute on element | `<div style=\"color: red\">` | Highest |\n| ID Selectors | `#identifier` in selector | `#header`, `div#main` | High |\n| Class/Attribute/Pseudo | `.class`, `[attr]`, `:hover` | `.nav`, `[type=\"text\"]`, `:hover` | Medium |\n| Element/Pseudo-Element | Element names, `::before` | `div`, `p::first-line` | Low |\n\n**Specificity Comparison Algorithm:**\n\n```\nTo compare two specificity values S1 and S2:\n1. If S1.inline ≠ S2.inline, return the one with higher inline count\n2. If S1.ids ≠ S2.ids, return the one with higher ID count\n3. If S1.classes ≠ S2.classes, return the one with higher class count\n4. If S1.elements ≠ S2.elements, return the one with higher element count\n5. If all components equal, compare source order (later wins)\n```\n\n**Cascade Resolution Implementation:**\n\nThe cascade resolver must efficiently match CSS rules against DOM elements and apply the precedence rules. The implementation uses several optimization strategies to avoid recalculating styles unnecessarily.\n\n| Resolution Phase | Algorithm | Complexity | Optimization Strategy |\n|-----------------|-----------|------------|---------------------|\n| Rule Matching | Test each rule's selector against element | O(rules × selector_complexity) | Selector indexing by key components |\n| Specificity Sorting | Sort applicable rules by precedence | O(applicable_rules × log(n)) | Cache computed specificity values |\n| Property Resolution | Apply winning rule for each property | O(properties × applicable_rules) | Early termination on property match |\n| Inheritance | Copy inherited values from parent | O(inherited_properties) | Mark inheritable properties statically |\n\n**Handling CSS Important Declarations:**\n\nThe `!important` declaration creates a parallel cascade where important declarations are considered separately from normal declarations. This effectively creates two cascade layers that must be resolved independently.\n\n1. **Separate important and normal declarations** into different collections during rule matching\n2. **Apply cascade algorithm to important declarations first** using the same specificity and source order rules\n3. **Apply cascade algorithm to normal declarations** for any properties not set by important declarations\n4. **Merge the results** with important declarations taking precedence over normal declarations regardless of specificity\n\n> ⚠️ **Pitfall: Incorrect Important Declaration Handling**\n> A common mistake is treating `!important` as simply increasing specificity rather than creating a separate cascade layer. This leads to incorrect behavior where a high-specificity normal declaration can override a low-specificity important declaration, violating the CSS specification.\n\n### Style Matching and Computed Values\n\nStyle matching and computed value resolution represent the final stage of the CSS processing pipeline, where abstract CSS rules are transformed into concrete values that the layout engine can use. Think of this process as a **specialized translator** that converts legal documents (CSS rules) written in formal legal language into practical instructions (computed styles) that workers (the layout engine) can follow to build something concrete.\n\nThis translation process involves several complex steps: determining which rules apply to each element, resolving relative values into absolute values, computing inherited properties, and handling special cases like auto values and percentage calculations that depend on layout context.\n\n**Style Matching Algorithm:**\n\nThe style matching algorithm determines which CSS rules apply to a given DOM element by testing each rule's selector against the element and its position in the document tree. The matching process must consider various selector types and combinators while maintaining good performance even for large documents.\n\n| Matching Phase | Process | Performance Considerations |\n|----------------|---------|---------------------------|\n| Fast Reject | Check if selector could possibly match | Use bloom filters for class/ID rejection |\n| Simple Selector Match | Test element name, classes, IDs, attributes | Cache element metadata for repeated access |\n| Combinator Resolution | Walk DOM tree for descendant/child relationships | Implement iterative traversal to avoid stack overflow |\n| Pseudo-Class Evaluation | Check dynamic states like `:hover`, `:focus` | Maintain state change tracking for efficient updates |\n\n**Selector Matching Implementation Details:**\n\nDifferent selector types require different matching strategies. Simple selectors like element types and classes can be checked directly against the target element, while combinator selectors require traversing the DOM tree to find relationships between elements.\n\n1. **Universal Selector (`*`)**: Always matches - return true immediately\n2. **Type Selector (`div`)**: Compare selector tag name with element's tag name (case-insensitive for HTML)\n3. **Class Selector (`.classname`)**: Check if element's class list contains the specified class\n4. **ID Selector (`#idvalue`)**: Compare selector ID with element's ID attribute (case-sensitive)\n5. **Attribute Selector (`[attr=value]`)**: Check element attributes with various matching operators\n6. **Descendant Combinator (` `)**: Walk up ancestor chain looking for matching ancestor element\n7. **Child Combinator (`>`)**: Check immediate parent element for selector match\n8. **Adjacent Sibling (`+`)**: Check immediately preceding sibling element\n9. **General Sibling (`~`)**: Check all preceding siblings for matching element\n\n**Computed Style Resolution:**\n\nOnce the cascade determines which CSS declarations apply to an element, the style system must resolve these declared values into computed values that the layout engine can use. This resolution process handles relative units, inheritance, and default values.\n\n| Value Resolution Type | Process | Example |\n|--------------------- |---------|---------|\n| Absolute Length | Direct conversion to pixels | `12px` → `12.0` |\n| Relative Length | Calculate based on context | `1.2em` → `19.2px` (if font-size is 16px) |\n| Percentage | Store percentage for layout-time resolution | `50%` → `Percent(50.0)` |\n| Keywords | Map to specific values or behaviors | `auto` → `Auto`, `bold` → `FontWeight::Bold` |\n| Inheritance | Copy computed value from parent | `color: inherit` → parent's computed color |\n\n**Font and Text Property Resolution:**\n\nFont-related properties require special handling because they establish the context for `em` unit calculations and affect text layout. Font size resolution must happen early in the computed style process because other properties may depend on the computed font size.\n\n```\nFont Size Resolution Algorithm:\n1. If font-size is specified in absolute units (px, pt), use that value directly\n2. If font-size uses relative units (em, rem), compute based on parent or root font size\n3. If font-size is a keyword (small, medium, large), map to predetermined pixel values\n4. If font-size is a percentage, calculate as percentage of parent's computed font size\n5. Store computed font size for use in resolving other properties\n```\n\n**Color Value Resolution:**\n\nColor properties support multiple value formats that must be normalized into a consistent internal representation. The color resolution process handles named colors, hexadecimal values, RGB/RGBA functions, and HSL/HSLA functions.\n\n| Color Format | Parsing Process | Internal Representation |\n|-------------|----------------|------------------------|\n| Named Colors | Lookup in predefined color table | `Color { r: u8, g: u8, b: u8, a: u8 }` |\n| Hex Colors | Parse hex digits and convert to RGB | `#FF0000` → `Color { r: 255, g: 0, b: 0, a: 255 }` |\n| RGB Function | Extract numeric parameters | `rgb(255, 0, 0)` → `Color { r: 255, g: 0, b: 0, a: 255 }` |\n| RGBA Function | Extract RGB + alpha parameter | `rgba(255, 0, 0, 0.5)` → `Color { r: 255, g: 0, b: 0, a: 127 }` |\n\n**Box Model Property Resolution:**\n\nBox model properties (margin, border, padding) support shorthand syntax where 1-4 values can specify all four sides of the box. The resolution process must expand shorthand properties and resolve each side independently.\n\n**Shorthand Expansion Rules:**\n- **One value**: Apply to all four sides (`margin: 10px` → top: 10px, right: 10px, bottom: 10px, left: 10px)\n- **Two values**: First applies to top/bottom, second to left/right (`margin: 10px 20px` → top: 10px, right: 20px, bottom: 10px, left: 20px)\n- **Three values**: Top, left/right, bottom (`margin: 10px 20px 30px` → top: 10px, right: 20px, bottom: 30px, left: 20px)\n- **Four values**: Top, right, bottom, left in clockwise order (`margin: 10px 20px 30px 40px`)\n\n**Property Inheritance Implementation:**\n\nCSS inheritance allows child elements to automatically receive certain property values from their parent elements. The style resolution system must implement inheritance for inheritable properties while ensuring non-inheritable properties use their default values.\n\n| Property Category | Inheritance Behavior | Examples |\n|------------------|---------------------|----------|\n| Inheritable | Child inherits parent's computed value | `color`, `font-family`, `line-height` |\n| Non-Inheritable | Child uses initial/default value | `margin`, `padding`, `border`, `width` |\n| Explicit Inherit | Any property can be forced to inherit | `margin: inherit` forces margin inheritance |\n| Initial | Reset to specification default | `color: initial` resets to black |\n\n> ⚠️ **Pitfall: Inheritance vs. Cascade Confusion**\n> Beginners often confuse inheritance (automatic copying of certain properties from parent to child) with the cascade (resolution of conflicting rules targeting the same element). Inheritance happens after the cascade resolves what properties apply to the current element. A child element can have its own CSS rules that override inherited values through the normal cascade process.\n\n**Style Invalidation and Change Propagation:**\n\nWhen DOM elements are modified or CSS rules are added/removed, the style system must efficiently update computed styles without recalculating everything from scratch. This requires tracking dependencies between elements and their computed styles.\n\n**Change Propagation Algorithm:**\n1. **Identify changed elements** that need style recalculation due to DOM modifications or dynamic state changes\n2. **Mark descendants for inheritance updates** when inheritable properties change on an element\n3. **Mark elements for selector re-matching** when DOM structure changes affect combinator selectors\n4. **Batch style updates** to avoid redundant calculations during multiple rapid changes\n5. **Invalidate layout** for elements whose computed styles affect geometric properties\n\n![CSS Cascade Resolution Sequence](./diagrams/css-cascade-sequence.svg)\n\n**Common Pitfalls in Style Resolution:**\n\n⚠️ **Pitfall: Incorrect Relative Unit Context**\nWhen resolving `em` units, developers often use the wrong font-size context. The `em` unit should always resolve against the current element's computed font-size, not its parent's font-size. This means font-size must be computed before other properties that might use `em` units.\n\n⚠️ **Pitfall: Percentage Resolution Timing**\nPercentage values cannot always be resolved during style computation because they depend on layout information (like the parent element's computed dimensions). These values must be stored as percentages and resolved during layout, not during style computation.\n\n⚠️ **Pitfall: Specificity Integer Overflow**\nImplementing specificity as a single integer with multipliers (like `ids * 100 + classes * 10 + elements`) can lead to overflow problems where many low-specificity selectors can override high-specificity selectors. Always use separate counters for each specificity component.\n\n⚠️ **Pitfall: Important Declaration Scope**\nThe `!important` declaration applies only to the specific property where it appears, not to the entire rule. When parsing `color: red !important; background: blue;`, only the color declaration is important, not the background declaration.\n\n### Implementation Guidance\n\nThe CSS parser and style system implementation requires balancing parsing correctness with performance considerations. This section provides concrete implementation strategies and starter code to build a robust CSS processing pipeline.\n\n**A. Technology Recommendations:**\n\n| Component | Simple Option | Advanced Option |\n|-----------|--------------|-----------------|\n| CSS Tokenizer | Hand-written state machine | Lexer generator (nom, pest) |\n| Selector Parsing | Recursive descent parser | Parser combinator library |\n| Value Parsing | Pattern matching on token types | Typed value parser with validation |\n| Color Handling | Basic RGB struct | Full color space support with conversions |\n| String Handling | Standard string operations | Interned strings for performance |\n| Rule Storage | Vec of rules with linear search | Indexed rule storage with bloom filters |\n\n**B. Recommended File Structure:**\n\n```\nbrowser-engine/\n├── src/\n│   ├── css/\n│   │   ├── mod.rs              ← Public interface and re-exports\n│   │   ├── tokenizer.rs        ← CSS tokenization state machine\n│   │   ├── parser.rs           ← Rule and selector parsing\n│   │   ├── values.rs           ← CSS value types and parsing\n│   │   ├── specificity.rs      ← Specificity calculation\n│   │   ├── cascade.rs          ← Cascade algorithm implementation\n│   │   ├── computed.rs         ← Computed style resolution\n│   │   └── matching.rs         ← Selector matching algorithms\n│   ├── style/\n│   │   ├── mod.rs              ← Style system public interface\n│   │   ├── resolver.rs         ← Main StyleResolver implementation\n│   │   └── inheritance.rs      ← Property inheritance logic\n│   └── types.rs                ← Core types shared across modules\n```\n\n**C. Infrastructure Starter Code:**\n\nHere's a complete CSS tokenizer implementation that handles the lexical analysis phase:\n\n```rust\n// css/tokenizer.rs\nuse std::str::Chars;\nuse std::iter::Peekable;\n\n#[derive(Debug, Clone, PartialEq)]\npub enum CSSToken {\n    Identifier(String),\n    String(String),\n    Hash(String),           // #identifier or #color\n    Dimension(f32, String), // number + unit (12px, 1.5em)\n    Number(f32),\n    Percentage(f32),\n    Function(String),       // identifier followed by (\n    LeftBrace,\n    RightBrace,\n    LeftParen,\n    RightParen,\n    Semicolon,\n    Colon,\n    Comma,\n    Whitespace,\n    EOF,\n}\n\n#[derive(Debug)]\npub struct CSSTokenizer {\n    input: Peekable<Chars<'static>>,\n    position: usize,\n}\n\nimpl CSSTokenizer {\n    pub fn new(css: &'static str) -> Self {\n        Self {\n            input: css.chars().peekable(),\n            position: 0,\n        }\n    }\n\n    pub fn next_token(&mut self) -> CSSToken {\n        self.skip_whitespace_and_comments();\n        \n        match self.peek_char() {\n            None => CSSToken::EOF,\n            Some(ch) => match ch {\n                '{' => { self.consume_char(); CSSToken::LeftBrace }\n                '}' => { self.consume_char(); CSSToken::RightBrace }\n                '(' => { self.consume_char(); CSSToken::LeftParen }\n                ')' => { self.consume_char(); CSSToken::RightParen }\n                ';' => { self.consume_char(); CSSToken::Semicolon }\n                ':' => { self.consume_char(); CSSToken::Colon }\n                ',' => { self.consume_char(); CSSToken::Comma }\n                '#' => self.consume_hash(),\n                '\"' | '\\'' => self.consume_string(),\n                '0'..='9' | '.' => self.consume_numeric(),\n                '-' if self.is_identifier_start() => self.consume_identifier_or_function(),\n                _ if self.is_identifier_start() => self.consume_identifier_or_function(),\n                _ => {\n                    // Unknown character - consume and continue\n                    self.consume_char();\n                    self.next_token()\n                }\n            }\n        }\n    }\n\n    fn peek_char(&mut self) -> Option<char> {\n        self.input.peek().copied()\n    }\n\n    fn consume_char(&mut self) -> Option<char> {\n        match self.input.next() {\n            Some(ch) => {\n                self.position += ch.len_utf8();\n                Some(ch)\n            }\n            None => None,\n        }\n    }\n\n    fn skip_whitespace_and_comments(&mut self) {\n        while let Some(ch) = self.peek_char() {\n            if ch.is_whitespace() {\n                self.consume_char();\n            } else if ch == '/' && self.peek_ahead(1) == Some('*') {\n                self.skip_comment();\n            } else {\n                break;\n            }\n        }\n    }\n\n    fn skip_comment(&mut self) {\n        // Consume /*\n        self.consume_char();\n        self.consume_char();\n        \n        while let Some(ch) = self.consume_char() {\n            if ch == '*' && self.peek_char() == Some('/') {\n                self.consume_char(); // consume /\n                break;\n            }\n        }\n    }\n\n    fn peek_ahead(&mut self, n: usize) -> Option<char> {\n        // This is a simplified implementation\n        // In practice, you'd want a more efficient lookahead buffer\n        let chars: Vec<char> = self.input.clone().take(n + 1).collect();\n        chars.get(n).copied()\n    }\n\n    fn is_identifier_start(&mut self) -> bool {\n        match self.peek_char() {\n            Some(ch) => ch.is_alphabetic() || ch == '_' || ch == '-',\n            None => false,\n        }\n    }\n\n    fn consume_identifier_or_function(&mut self) -> CSSToken {\n        let mut identifier = String::new();\n        \n        while let Some(ch) = self.peek_char() {\n            if ch.is_alphanumeric() || ch == '-' || ch == '_' {\n                identifier.push(ch);\n                self.consume_char();\n            } else {\n                break;\n            }\n        }\n\n        // Check if this is a function (followed by opening paren)\n        if self.peek_char() == Some('(') {\n            CSSToken::Function(identifier)\n        } else {\n            CSSToken::Identifier(identifier)\n        }\n    }\n\n    fn consume_hash(&mut self) -> CSSToken {\n        self.consume_char(); // consume #\n        let mut hash_value = String::new();\n        \n        while let Some(ch) = self.peek_char() {\n            if ch.is_alphanumeric() || ch == '-' || ch == '_' {\n                hash_value.push(ch);\n                self.consume_char();\n            } else {\n                break;\n            }\n        }\n        \n        CSSToken::Hash(hash_value)\n    }\n\n    fn consume_string(&mut self) -> CSSToken {\n        let quote_char = self.consume_char().unwrap();\n        let mut string_value = String::new();\n        \n        while let Some(ch) = self.consume_char() {\n            if ch == quote_char {\n                break;\n            } else if ch == '\\\\' {\n                // Handle escape sequences\n                if let Some(escaped) = self.consume_char() {\n                    string_value.push(escaped);\n                }\n            } else {\n                string_value.push(ch);\n            }\n        }\n        \n        CSSToken::String(string_value)\n    }\n\n    fn consume_numeric(&mut self) -> CSSToken {\n        let mut number_str = String::new();\n        \n        // Consume digits and decimal point\n        while let Some(ch) = self.peek_char() {\n            if ch.is_numeric() || ch == '.' {\n                number_str.push(ch);\n                self.consume_char();\n            } else {\n                break;\n            }\n        }\n        \n        let number: f32 = number_str.parse().unwrap_or(0.0);\n        \n        // Check for percentage\n        if self.peek_char() == Some('%') {\n            self.consume_char();\n            return CSSToken::Percentage(number);\n        }\n        \n        // Check for unit\n        if self.is_identifier_start() {\n            let mut unit = String::new();\n            while let Some(ch) = self.peek_char() {\n                if ch.is_alphabetic() {\n                    unit.push(ch);\n                    self.consume_char();\n                } else {\n                    break;\n                }\n            }\n            CSSToken::Dimension(number, unit)\n        } else {\n            CSSToken::Number(number)\n        }\n    }\n}\n```\n\n**D. Core Logic Skeleton Code:**\n\nHere are the key interfaces that learners should implement:\n\n```rust\n// css/parser.rs\nuse crate::types::{CSSRule, Selector, Declaration, CSSValue, Specificity};\n\npub struct CSSParser {\n    tokens: Vec<CSSToken>,\n    position: usize,\n}\n\nimpl CSSParser {\n    /// Parses a complete CSS stylesheet into a collection of rules\n    /// Returns a Result with parsed rules or parsing errors\n    pub fn parse_stylesheet(css: &str) -> Result<Vec<CSSRule>, String> {\n        // TODO 1: Create tokenizer and extract all tokens from CSS text\n        // TODO 2: Initialize parser with token stream\n        // TODO 3: Parse rules until end of token stream\n        // TODO 4: Handle parsing errors gracefully by skipping invalid rules\n        // TODO 5: Return collected valid rules\n        todo!(\"Implement stylesheet parsing\")\n    }\n\n    /// Parses a single CSS rule (selector + declaration block)\n    /// Advances parser position and returns parsed rule with computed specificity\n    fn parse_rule(&mut self) -> Result<CSSRule, String> {\n        // TODO 1: Parse selector using parse_selector method\n        // TODO 2: Expect opening brace for declaration block\n        // TODO 3: Parse declarations until closing brace\n        // TODO 4: Create CSSRule with selector, declarations, and specificity\n        // TODO 5: Handle malformed rules by returning error\n        todo!(\"Implement rule parsing\")\n    }\n\n    /// Parses a CSS selector with support for combinators and specificity calculation\n    /// Returns Selector enum variant with computed specificity\n    fn parse_selector(&mut self) -> Result<Selector, String> {\n        // TODO 1: Parse simple selector (type, class, ID, universal)\n        // TODO 2: Check for additional selectors (compound selectors)\n        // TODO 3: Handle combinators (space, >, +, ~)\n        // TODO 4: Create appropriate Selector variant\n        // TODO 5: Compute and store specificity for this selector\n        todo!(\"Implement selector parsing\")\n    }\n\n    /// Parses property declarations within a rule block\n    /// Returns Vec of Declaration objects with parsed property-value pairs\n    fn parse_declarations(&mut self) -> Vec<Declaration> {\n        // TODO 1: Loop until closing brace is encountered\n        // TODO 2: Parse property name (expect identifier token)\n        // TODO 3: Expect colon separator\n        // TODO 4: Parse property value using parse_value method\n        // TODO 5: Check for !important declaration\n        // TODO 6: Expect semicolon separator (optional for last declaration)\n        // TODO 7: Handle malformed declarations by skipping to next semicolon\n        todo!(\"Implement declaration parsing\")\n    }\n\n    /// Parses CSS values with appropriate type checking\n    /// Returns typed CSSValue variant based on property and token types\n    fn parse_value(&mut self, property: &str) -> Result<CSSValue, String> {\n        // TODO 1: Look at current token type\n        // TODO 2: Match against expected value types for this property\n        // TODO 3: Parse dimensions with unit conversion\n        // TODO 4: Parse colors in various formats (hex, rgb, named)\n        // TODO 5: Parse keywords and validate against property allowed values\n        // TODO 6: Handle function values like rgb(), calc()\n        // TODO 7: Return appropriate CSSValue variant\n        todo!(\"Implement value parsing\")\n    }\n}\n```\n\n```rust\n// css/specificity.rs\nuse crate::types::{Selector, Specificity};\n\nimpl Specificity {\n    /// Calculates CSS specificity according to the specification\n    /// Returns four-component specificity tuple (inline, ids, classes, elements)\n    pub fn calculate(selector: &Selector) -> Specificity {\n        // TODO 1: Initialize counters for each specificity component\n        // TODO 2: Traverse selector structure (handle compound selectors)\n        // TODO 3: Count inline styles (will be 1 for style attribute, 0 for stylesheet rules)\n        // TODO 4: Count ID selectors in the selector\n        // TODO 5: Count class selectors, attribute selectors, and pseudo-classes\n        // TODO 6: Count element selectors and pseudo-elements\n        // TODO 7: Return Specificity struct with computed counts\n        todo!(\"Implement specificity calculation\")\n    }\n\n    /// Compares two specificity values according to CSS precedence rules\n    /// Returns Ordering indicating which specificity has higher precedence\n    pub fn compare(&self, other: &Specificity) -> std::cmp::Ordering {\n        // TODO 1: Compare inline counts first\n        // TODO 2: Compare ID counts if inline counts are equal\n        // TODO 3: Compare class counts if ID counts are equal\n        // TODO 4: Compare element counts if class counts are equal\n        // TODO 5: Return Equal if all components are equal\n        todo!(\"Implement specificity comparison\")\n    }\n}\n```\n\n```rust\n// style/resolver.rs\nuse crate::types::{StyleResolver, DOMNode, ComputedStyle, CSSRule};\n\nimpl StyleResolver {\n    /// Main entry point for style resolution - computes styles for entire DOM tree\n    /// Applies cascade algorithm and inheritance to determine final computed styles\n    pub fn resolve_styles(&self, root: &DOMNode) -> ComputedStyle {\n        // TODO 1: Start with root element and empty inherited styles\n        // TODO 2: Resolve styles for root element using resolve_element_style\n        // TODO 3: Recursively resolve styles for all child elements\n        // TODO 4: Pass computed styles down as inherited values for children\n        // TODO 5: Handle special cases like replaced elements and display:none\n        todo!(\"Implement style resolution\")\n    }\n\n    /// Resolves computed style for a single element using the cascade algorithm\n    /// Matches CSS rules, applies specificity, and resolves final property values\n    fn resolve_element_style(&self, element: &DOMNode, inherited: &ComputedStyle) -> ComputedStyle {\n        // TODO 1: Find all CSS rules that match this element\n        // TODO 2: Filter rules by media queries and other conditional rules\n        // TODO 3: Sort matching rules by cascade priority (origin, specificity, source order)\n        // TODO 4: Apply winning rule for each CSS property\n        // TODO 5: Resolve relative values (em, %, inherit) to absolute values\n        // TODO 6: Apply inheritance for properties not explicitly set\n        // TODO 7: Return ComputedStyle with all properties resolved\n        todo!(\"Implement element style resolution\")\n    }\n\n    /// Tests if a CSS rule matches a given DOM element\n    /// Implements selector matching algorithm with support for all selector types\n    fn matches_element(&self, selector: &Selector, element: &DOMNode) -> bool {\n        // TODO 1: Handle different selector types (Universal, Type, Class, ID, etc.)\n        // TODO 2: Implement combinator logic (descendant, child, sibling)\n        // TODO 3: Check attribute selectors with various matching operators\n        // TODO 4: Evaluate pseudo-classes like :hover, :focus, :first-child\n        // TODO 5: Walk DOM tree as needed for combinator selectors\n        // TODO 6: Return true if selector matches, false otherwise\n        todo!(\"Implement selector matching\")\n    }\n}\n```\n\n**E. Language-Specific Hints:**\n\n- **Use `nom` crate for robust parsing**: While the starter code shows manual parsing, consider using the `nom` parser combinator library for production CSS parsing\n- **Intern strings for performance**: CSS parsing creates many duplicate strings (property names, common values). Use string interning to reduce memory usage\n- **Use `SmallVec` for selector components**: Most selectors have few components, so `SmallVec<[Component; 4]>` avoids heap allocation for simple selectors\n- **Cache computed specificity**: Specificity calculation can be expensive for complex selectors. Cache the result in the Selector structure\n- **Use `HashMap` for efficient rule matching**: Index rules by their key selector components (tag names, classes, IDs) for faster matching\n\n**F. Milestone Checkpoint:**\n\nAfter implementing the CSS parser and style system, verify correct behavior:\n\n**Test Command:**\n```bash\ncargo test css_parsing -- --nocapture\ncargo test style_resolution -- --nocapture\n```\n\n**Expected Behavior:**\n- Parse basic CSS rules with type, class, and ID selectors\n- Calculate specificity correctly: `#header .nav li` should have specificity (0, 1, 1, 1)\n- Apply cascade correctly: more specific rules should override less specific ones\n- Handle inheritance: text color should inherit from parent unless explicitly set\n- Parse CSS values: `12px`, `#ff0000`, `rgb(255, 0, 0)` should parse to correct internal types\n\n**Manual Testing:**\n```rust\nlet css = \"\n  body { color: black; font-family: Arial; }\n  .highlight { color: red; }\n  #header .nav { color: blue; }\n\";\n\nlet rules = CSSParser::parse_stylesheet(css).unwrap();\n// Should have 3 rules with correct selectors and declarations\nassert_eq!(rules.len(), 3);\n\nlet resolver = StyleResolver::new(rules);\n// Test with sample DOM element\n```\n\n**G. Debugging Tips:**\n\n| Symptom | Likely Cause | How to Diagnose | Fix |\n|---------|-------------|-----------------|-----|\n| Selectors don't match elements | Incorrect selector parsing or matching logic | Print parsed selector structure and matching attempts | Check selector component parsing and matching algorithm |\n| Wrong styles applied | Specificity calculation error | Print computed specificity for competing rules | Verify specificity calculation follows CSS spec exactly |\n| Inheritance not working | Missing inheritance implementation | Check if inheritable properties copy from parent | Implement proper inheritance for inheritable properties |\n| Colors display incorrectly | Color parsing or conversion issues | Print parsed color values in debug format | Verify color parsing handles all formats correctly |\n| Performance issues with large stylesheets | Inefficient rule matching | Profile rule matching performance | Add selector indexing and fast-path optimizations |\n\n\n## Layout Engine Design\n\n> **Milestone(s):** Milestone 3 (Layout) - This section implements the core layout algorithms that transform the styled DOM tree into positioned and sized visual elements using CSS box model calculations and formatting contexts.\n\nThe layout engine represents the geometric heart of our browser engine, where abstract CSS properties transform into concrete pixel coordinates and dimensions. Think of the layout engine as a **master carpenter** who takes architectural blueprints (the styled DOM tree) and transforms them into precise measurements and positioning for every piece of the structure. Just as a carpenter must understand how different materials stack, flow, and interact spatially, our layout engine must understand how CSS display types, the box model, and formatting contexts determine the final visual arrangement of elements.\n\nThe layout engine operates on the fundamental principle that every element in a web page occupies rectangular space, even if that space is zero-sized or invisible. This geometric abstraction allows us to reduce the infinite complexity of visual design to a manageable set of mathematical calculations involving rectangles, their positions, and their relationships to one another.\n\n![CSS Box Model Calculation Flow](./diagrams/layout-box-model.svg)\n\nThe layout process transforms the styled DOM tree into a **layout tree**, where each node contains not just styling information but precise geometric data: content dimensions, padding thickness, border widths, margin spacing, and absolute positioning coordinates. This geometric data flows directly into the rendering engine, which uses it to determine exactly where to paint each visual element.\n\n### CSS Box Model Implementation\n\nThe CSS box model serves as the fundamental geometric framework that governs how every element's size and spacing are calculated. Think of each element as a **nested set of picture frames**: the innermost frame holds the actual content (text, images, or child elements), surrounded by padding (like a photo mat), then a border (the frame itself), and finally margin (the space between this frame and adjacent frames on the wall).\n\nUnderstanding the box model requires recognizing that CSS properties like `width` and `height` specify the content area dimensions, not the total space an element occupies. The total space calculation must account for all four layers of the box model, and this calculation varies depending on the CSS `box-sizing` property and whether dimensions are specified explicitly or need to be computed automatically.\n\n> **Decision: Box Model Calculation Strategy**\n> - **Context**: CSS box model calculations must handle explicit dimensions, auto-sizing, percentage values, and the interaction between width/height and padding/border/margin\n> - **Options Considered**: \n>   1. Two-pass layout (measure content first, then apply box model)\n>   2. Single-pass with constraint propagation\n>   3. Iterative refinement with multiple passes\n> - **Decision**: Two-pass layout with measure-then-position phases\n> - **Rationale**: Two-pass layout cleanly separates content sizing from box model application, making the algorithm easier to understand and debug while handling auto-sizing correctly\n> - **Consequences**: Requires two tree traversals but provides clear separation of concerns and easier handling of percentage values and auto margins\n\n| Option | Pros | Cons | Chosen? |\n|--------|------|------|---------|\n| Two-pass layout | Clear separation, easier debugging, correct auto-sizing | Requires two traversals, slightly less efficient | ✅ Yes |\n| Single-pass constraint | More efficient, unified algorithm | Complex constraint solving, harder to debug | ❌ No |\n| Iterative refinement | Handles complex dependencies | Non-deterministic performance, convergence issues | ❌ No |\n\nThe box model calculation algorithm follows these essential steps:\n\n1. **Content dimension resolution**: Determine the actual content width and height, resolving any `auto` values, percentage values, or constraints imposed by the containing block\n2. **Padding application**: Add padding values to the content dimensions, converting any percentage padding values to absolute pixel measurements based on the containing block width\n3. **Border integration**: Include border widths in the total element size, ensuring border styles and widths are properly resolved from the computed styles\n4. **Margin calculation**: Compute margin values, handling special cases like auto margins, negative margins, and margin collapsing scenarios\n5. **Total space determination**: Calculate the final bounding rectangle that encompasses margin, border, padding, and content areas\n\nThe `LayoutBox` structure maintains separate rectangles for each layer of the box model, enabling precise control during both layout calculation and rendering phases:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `content_rect` | `Rectangle` | Inner area containing actual content (text, images, child elements) |\n| `padding_rect` | `Rectangle` | Content area plus padding on all sides |\n| `border_rect` | `Rectangle` | Padding area plus border thickness on all sides |\n| `margin_rect` | `Rectangle` | Border area plus margin spacing on all sides (total element space) |\n| `computed_style` | `ComputedStyle` | Resolved CSS properties including dimensions, spacing, and positioning |\n| `box_type` | `BoxType` | Display type determining layout behavior (block, inline, text, etc.) |\n\nThe box model calculation must handle several critical edge cases that frequently challenge implementations:\n\n**Percentage Value Resolution**: Percentage widths and heights resolve against the containing block's corresponding dimension, while percentage padding and margin values always resolve against the containing block's width (even for top and bottom padding/margin). This asymmetric behavior reflects CSS specifications and affects element aspect ratios.\n\n**Auto Value Handling**: When `width` or `height` is `auto`, the layout engine must compute the dimension based on content requirements and available space. For block elements, auto width typically expands to fill the containing block, while auto height shrinks to fit content. Inline elements compute both dimensions based on content.\n\n**Box Sizing Variations**: The `box-sizing` property fundamentally changes how width and height are interpreted. With `content-box` (the default), width/height specify the content area. With `border-box`, they specify the border area, requiring the layout engine to subtract padding and border to determine content dimensions.\n\n> The box model calculation forms the mathematical foundation for all layout operations. Getting these calculations wrong creates cascading errors throughout the layout tree, often manifesting as misaligned elements, incorrect scrolling behavior, or elements extending beyond their containers.\n\n### Block Formatting Context\n\nBlock formatting context represents the vertical stacking behavior that governs how block-level elements arrange themselves within their container. Think of block formatting as **arranging books on a bookshelf**: each book (block element) stacks vertically below the previous one, with each book taking the full width of the shelf unless explicitly constrained. The shelf itself (the containing block) determines the available width, while each book's content determines its height.\n\nBlock formatting context establishes several crucial layout principles: block elements stack vertically in document order, each block element starts on a new \"line\" (preventing horizontal adjacency with other blocks), and margin collapsing occurs between vertically adjacent blocks under specific conditions.\n\nThe block layout algorithm operates through a systematic positioning process:\n\n1. **Available space calculation**: Determine the containing block's content width and height, accounting for any constraints imposed by the parent element's box model and positioning\n2. **Child element iteration**: Process each child block element in document order, calculating its position relative to previously positioned siblings\n3. **Width resolution**: For each child, resolve the width dimension using CSS properties, available space, and auto-sizing rules specific to block elements\n4. **Height calculation**: Compute the height based on content requirements, explicit CSS values, or auto-sizing behavior for block containers\n5. **Vertical positioning**: Place the element below previously positioned siblings, accounting for margin values and potential margin collapsing scenarios\n6. **Margin collapsing evaluation**: Apply CSS margin collapsing rules between adjacent block elements, which can reduce the actual spacing between elements\n\n| Layout Phase | Input | Process | Output |\n|--------------|-------|---------|---------|\n| Space Analysis | Containing block dimensions | Calculate available width/height for children | Content area constraints |\n| Width Resolution | CSS width + available space | Apply width algorithm (auto, percentage, explicit) | Final content width |\n| Content Layout | Child elements + content width | Position child content (text, inline, nested blocks) | Content height |\n| Height Resolution | Content height + CSS height | Apply height algorithm (auto, explicit, min/max) | Final content height |\n| Position Assignment | Element dimensions + sibling positions | Calculate final x,y coordinates | Positioned layout box |\n\n**Margin Collapsing** represents one of the most complex aspects of block formatting context. When two or more adjacent margins touch (no padding, border, or content separates them), they \"collapse\" into a single margin whose size equals the larger of the collapsing margins. This behavior affects parent-child relationships (where a child's margin can collapse with its parent's margin) and sibling relationships (where adjacent siblings' margins collapse).\n\nThe margin collapsing algorithm requires careful analysis of element relationships:\n\n1. **Adjacency detection**: Identify margins that are touching (no intervening padding, border, or content)\n2. **Collapse scope determination**: Determine which margins participate in the collapsing (can involve more than two margins in complex scenarios)\n3. **Collapsed value calculation**: Compute the final collapsed margin size, handling positive margins (use the maximum), negative margins (use the minimum), and mixed positive/negative margins (sum the maximum positive and minimum negative)\n4. **Position adjustment**: Apply the collapsed margin value and adjust element positions accordingly\n\n> **Decision: Margin Collapsing Implementation**\n> - **Context**: CSS margin collapsing involves complex rules for when margins collapse, which margins participate, and how to calculate the final collapsed value\n> - **Options Considered**:\n>   1. Full CSS specification compliance with all edge cases\n>   2. Simplified collapsing (only adjacent sibling margins)\n>   3. No margin collapsing (treat all margins independently)\n> - **Decision**: Simplified collapsing for adjacent siblings and basic parent-child scenarios\n> - **Rationale**: Full compliance requires handling dozens of edge cases that rarely occur in real content, while simplified collapsing covers 90% of practical scenarios with much less implementation complexity\n> - **Consequences**: Some advanced margin collapsing scenarios won't render identically to major browsers, but core layout behavior will be correct\n\n**Width and Height Resolution** in block formatting context follows CSS's detailed algorithms for determining element dimensions. Block elements have a natural tendency toward width expansion (filling available horizontal space) and height contraction (shrinking to fit content), but CSS properties can override these defaults.\n\nThe width resolution algorithm prioritizes explicit values over auto-sizing:\n\n1. **Explicit width**: If CSS specifies a concrete width value, use it directly (converting units to pixels as needed)\n2. **Percentage width**: Calculate percentage relative to the containing block's content width\n3. **Auto width**: For block elements, auto width typically means \"fill available horizontal space after accounting for margin, border, and padding\"\n4. **Constraint application**: Apply min-width and max-width constraints, potentially overriding the calculated width\n\nHeight resolution follows a different pattern since block elements typically size themselves based on content:\n\n1. **Content-based height**: Measure the height required to contain all child elements and content\n2. **Explicit height override**: If CSS specifies a height value, use it instead of content-based height\n3. **Percentage height**: Resolve percentage heights against the containing block's height (only if the containing block has an explicit height)\n4. **Constraint application**: Apply min-height and max-height, ensuring the final height meets all constraints\n\n### Inline Formatting Context\n\nInline formatting context governs the horizontal flow of text and inline elements within a line, analogous to **arranging words on a page of text**. Unlike block elements that stack vertically, inline elements flow horizontally from left to right (in left-to-right languages), wrapping to new lines when they exceed the containing block's width. Think of inline layout as a word processor that continuously places content horizontally until reaching the right margin, then continues on the next line.\n\nInline formatting context introduces several concepts absent from block formatting: baseline alignment (ensuring text appears to sit on invisible horizontal lines), line breaking (determining where content wraps to new lines), and mixed content handling (managing the interaction between text and inline block elements within the same line).\n\nThe inline layout algorithm processes content in reading order while maintaining line-by-line organization:\n\n1. **Line box initialization**: Create a new line box to contain inline content, establishing the baseline and available width\n2. **Inline content processing**: Add inline elements and text to the current line box, measuring each element's width and height requirements\n3. **Line breaking evaluation**: When adding an element would exceed the available line width, determine the appropriate break point and wrap to a new line\n4. **Baseline alignment**: Align all inline elements within the line box according to their vertical-align properties and the line's baseline\n5. **Line box finalization**: Complete the line box by determining its final height (based on the tallest element) and vertical position within the containing block\n6. **Line stacking**: Position completed line boxes vertically within the containing block, similar to how block elements stack\n\n| Inline Layout Component | Responsibility | Key Challenges |\n|------------------------|---------------|----------------|\n| Text measurement | Calculate width/height of text runs | Font metrics, character-specific widths, ligatures |\n| Line breaking | Determine where content wraps | Word boundaries, hyphenation, overflow handling |\n| Baseline alignment | Vertical positioning within lines | Multiple font sizes, inline-block elements, vertical-align |\n| Line box sizing | Calculate line height and position | Leading, line-height property, content height variation |\n| Mixed content | Handle text + inline elements | Different vertical alignment requirements, spacing |\n\n**Line Breaking** represents one of the most algorithmically challenging aspects of inline layout. The line breaking algorithm must balance several competing requirements: avoiding broken words when possible, respecting whitespace and punctuation rules, handling elements that cannot break (like images), and managing overflow scenarios where content cannot fit within available space.\n\nThe line breaking process follows these decision points:\n\n1. **Space availability check**: For each inline element or text segment, determine if it fits within the remaining line width\n2. **Break opportunity identification**: If the content doesn't fit, identify valid break points (typically at word boundaries, after hyphens, or at explicit break characters)\n3. **Break decision**: Choose the optimal break point that minimizes visual disruption while respecting CSS properties like `word-break` and `overflow-wrap`\n4. **Content splitting**: Split the content at the chosen break point, placing part on the current line and part on the next line\n5. **New line initialization**: Create a new line box for the wrapped content and continue the inline layout process\n\n**Baseline Alignment** ensures that text and inline elements appear properly aligned within each line. The baseline serves as an invisible horizontal reference line that determines where text \"sits\" within the line box. Different fonts, font sizes, and inline elements can have different baseline positions, requiring careful calculation to maintain visual consistency.\n\nThe baseline alignment algorithm coordinates multiple vertical positioning concerns:\n\n1. **Line baseline establishment**: Determine the primary baseline position for the line based on the dominant font and size\n2. **Element baseline calculation**: For each inline element, calculate its baseline position relative to its own content\n3. **Vertical alignment resolution**: Apply CSS vertical-align properties (baseline, top, middle, bottom, text-top, text-bottom, percentage, or length values)\n4. **Line box height determination**: Calculate the final line box height based on the highest and lowest points of all aligned elements\n5. **Final positioning**: Position each element at its calculated vertical offset within the line box\n\n**Text Measurement** requires the layout engine to interface with font rendering systems to obtain accurate metrics for text content. Unlike block elements with predictable rectangular geometry, text measurement involves font-specific metrics like character widths, ascent heights, descent depths, and inter-character spacing.\n\n| Text Metric | Definition | Layout Impact |\n|-------------|------------|---------------|\n| Advance width | Horizontal space consumed by a character | Determines how much space text occupies on a line |\n| Ascent | Height above baseline (like the top of 'A') | Affects line box height calculation |\n| Descent | Depth below baseline (like the bottom of 'g') | Affects line box height and baseline alignment |\n| Line height | Total vertical space for a line of text | Determines spacing between lines |\n| Font size | Nominal height of the font | Base measurement for relative units and scaling |\n\n> **Decision: Text Measurement Strategy**\n> - **Context**: Accurate text layout requires font metrics, but font systems are complex and platform-specific\n> - **Options Considered**:\n>   1. Full font system integration with accurate metrics\n>   2. Simplified monospace font assumption\n>   3. Hardcoded average character dimensions\n> - **Decision**: Simplified monospace assumption with configurable character dimensions\n> - **Rationale**: Font system integration adds significant complexity and platform dependencies, while monospace assumption provides predictable behavior for learning purposes\n> - **Consequences**: Text rendering won't match real browsers exactly, but layout algorithms remain correct and understandable\n\n### Common Pitfalls\n\n⚠️ **Pitfall: Box Model Calculation Order**\nA frequent mistake involves calculating box model dimensions in the wrong order, particularly trying to determine total element size before resolving content dimensions. This leads to incorrect calculations when dealing with percentage values or auto-sizing scenarios. The correct approach always resolves content dimensions first, then applies padding, border, and margin in sequence. Each layer's calculation may depend on previously calculated layers, making order crucial for correctness.\n\n⚠️ **Pitfall: Margin Collapsing Edge Cases**\nImplementers often forget that margin collapsing can involve more than two margins and can occur between parent and child elements, not just siblings. Additionally, margins only collapse when they are directly adjacent (no padding, border, or content between them). A common error is applying margin collapsing in scenarios where intervening content prevents it, or failing to handle the three-way collapsing that occurs when a parent's margin, child's margin, and sibling's margin all interact.\n\n⚠️ **Pitfall: Available Space Miscalculation**\nWhen calculating available space for child elements, developers often forget to subtract the parent's padding and border from the total dimensions. This results in child elements that appear to overflow their containers. The available space for child content equals the parent's content area dimensions, not the total element dimensions including padding and border.\n\n⚠️ **Pitfall: Inline Layout Line Box Height**\nA subtle but critical mistake involves setting line box height based only on font size rather than measuring the actual height requirements of all inline content within the line. Line boxes must accommodate the tallest element in the line, whether that's large text, inline images, or inline-block elements. Using only font size for line height calculation causes content to overlap vertically when lines contain mixed content types.\n\n⚠️ **Pitfall: Percentage Resolution Context**\nDevelopers frequently resolve percentage values against the wrong containing block dimensions. Width percentages resolve against the containing block's width, height percentages resolve against the containing block's height (when explicit), but padding and margin percentages always resolve against the containing block's width, even for top and bottom values. This asymmetric behavior often surprises implementers and leads to incorrect spacing calculations.\n\n### Implementation Guidance\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| Box Model | Fixed padding/border with content-box sizing | Full box-sizing support with border-box |\n| Text Measurement | Monospace font with fixed character width | Platform font APIs with actual metrics |\n| Line Breaking | Simple word boundary breaking | Unicode line breaking algorithm |\n| Margin Collapsing | Adjacent sibling collapsing only | Full CSS specification compliance |\n| Baseline Alignment | Single baseline per line | Multiple baseline contexts |\n\n**Recommended File Structure:**\n```\nsrc/layout/\n  mod.rs                    ← Public layout engine interface\n  box_model.rs              ← Box model calculations and utilities\n  block_layout.rs           ← Block formatting context implementation\n  inline_layout.rs          ← Inline formatting context implementation\n  layout_tree.rs            ← Layout tree construction and traversal\n  geometry.rs               ← Rectangle, Point, Size utility types\n  text_measurement.rs       ← Text metrics and font interface\n```\n\n**Infrastructure Starter Code:**\n\n```rust\n// src/layout/geometry.rs\nuse crate::css::{Unit, ComputedStyle};\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Point {\n    pub x: f32,\n    pub y: f32,\n}\n\nimpl Point {\n    pub fn new(x: f32, y: f32) -> Self {\n        Point { x, y }\n    }\n    \n    pub fn zero() -> Self {\n        Point { x: 0.0, y: 0.0 }\n    }\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Size {\n    pub width: f32,\n    pub height: f32,\n}\n\nimpl Size {\n    pub fn new(width: f32, height: f32) -> Self {\n        Size { width, height }\n    }\n    \n    pub fn zero() -> Self {\n        Size { width: 0.0, height: 0.0 }\n    }\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Rectangle {\n    pub origin: Point,\n    pub size: Size,\n}\n\nimpl Rectangle {\n    pub fn new(origin: Point, size: Size) -> Self {\n        Rectangle { origin, size }\n    }\n    \n    pub fn from_coords(x: f32, y: f32, width: f32, height: f32) -> Self {\n        Rectangle {\n            origin: Point::new(x, y),\n            size: Size::new(width, height),\n        }\n    }\n    \n    pub fn contains_point(&self, point: Point) -> bool {\n        point.x >= self.origin.x \n            && point.x <= self.origin.x + self.size.width\n            && point.y >= self.origin.y \n            && point.y <= self.origin.y + self.size.height\n    }\n    \n    pub fn intersects(&self, other: &Rectangle) -> bool {\n        !(self.origin.x + self.size.width < other.origin.x\n            || other.origin.x + other.size.width < self.origin.x\n            || self.origin.y + self.size.height < other.origin.y\n            || other.origin.y + other.size.height < self.origin.y)\n    }\n}\n\n// Box model utilities\n#[derive(Debug, Clone, PartialEq)]\npub struct BoxOffsets {\n    pub top: f32,\n    pub right: f32,\n    pub bottom: f32,\n    pub left: f32,\n}\n\nimpl BoxOffsets {\n    pub fn zero() -> Self {\n        BoxOffsets {\n            top: 0.0,\n            right: 0.0,\n            bottom: 0.0,\n            left: 0.0,\n        }\n    }\n    \n    pub fn uniform(value: f32) -> Self {\n        BoxOffsets {\n            top: value,\n            right: value,\n            bottom: value,\n            left: value,\n        }\n    }\n    \n    pub fn horizontal_total(&self) -> f32 {\n        self.left + self.right\n    }\n    \n    pub fn vertical_total(&self) -> f32 {\n        self.top + self.bottom\n    }\n}\n```\n\n```rust\n// src/layout/text_measurement.rs\nuse crate::css::ComputedStyle;\n\npub struct TextMetrics {\n    pub advance_width: f32,\n    pub ascent: f32,\n    pub descent: f32,\n    pub line_height: f32,\n}\n\npub struct FontInfo {\n    pub family: String,\n    pub size: f32,\n    pub weight: u16,\n    pub style: FontStyle,\n}\n\n#[derive(Debug, Clone, PartialEq)]\npub enum FontStyle {\n    Normal,\n    Italic,\n}\n\n// Simple text measurement for monospace fonts\npub struct SimpleTextMeasurer {\n    char_width: f32,\n    line_height: f32,\n}\n\nimpl SimpleTextMeasurer {\n    pub fn new(char_width: f32, line_height: f32) -> Self {\n        SimpleTextMeasurer { char_width, line_height }\n    }\n    \n    pub fn measure_text(&self, text: &str, style: &ComputedStyle) -> TextMetrics {\n        let scale_factor = style.font_size / 16.0; // Scale from base 16px\n        TextMetrics {\n            advance_width: text.chars().count() as f32 * self.char_width * scale_factor,\n            ascent: self.line_height * 0.8 * scale_factor,\n            descent: self.line_height * 0.2 * scale_factor,\n            line_height: self.line_height * scale_factor,\n        }\n    }\n    \n    pub fn measure_char(&self, ch: char, style: &ComputedStyle) -> f32 {\n        let scale_factor = style.font_size / 16.0;\n        self.char_width * scale_factor\n    }\n}\n```\n\n**Core Logic Skeleton Code:**\n\n```rust\n// src/layout/box_model.rs\nuse crate::css::{ComputedStyle, Unit, BoxSizing};\nuse crate::layout::geometry::{Rectangle, Size, BoxOffsets};\n\nimpl LayoutBox {\n    /// Calculate box model dimensions for this element given available space\n    /// This is the core box model calculation that determines content, padding, border, and margin rectangles\n    pub fn calculate_box_model(&mut self, containing_block_size: Size) {\n        // TODO 1: Extract computed style values for width, height, padding, border, margin\n        // Hint: Use self.computed_style to access CSS properties\n        \n        // TODO 2: Resolve any percentage values in padding/border/margin against containing block\n        // Hint: Padding/margin percentages always resolve against containing block WIDTH\n        \n        // TODO 3: Calculate content dimensions based on CSS width/height properties\n        // Hint: Handle 'auto', explicit values, and percentages differently\n        // Hint: Consider box-sizing property - content-box vs border-box changes the calculation\n        \n        // TODO 4: Apply padding to get padding rectangle from content rectangle\n        // Hint: Padding expands outward from content area\n        \n        // TODO 5: Apply border to get border rectangle from padding rectangle\n        // Hint: Border expands outward from padding area\n        \n        // TODO 6: Apply margin to get margin rectangle from border rectangle\n        // Hint: Margin expands outward from border area, but may collapse with siblings\n        \n        // TODO 7: Store all four rectangles (content_rect, padding_rect, border_rect, margin_rect)\n        // Hint: Each rectangle should be properly positioned and sized\n    }\n    \n    fn resolve_dimension(&self, value: &Unit, containing_dimension: f32, auto_value: f32) -> f32 {\n        // TODO: Convert Unit values to pixels\n        // Handle Px(value), Percent(percentage), Em(em_value), Auto cases\n        // Return appropriate pixel value for each case\n    }\n    \n    fn calculate_auto_width(&self, containing_width: f32) -> f32 {\n        // TODO: Implement auto width calculation for different box types\n        // Block elements: fill available space minus margin/border/padding\n        // Inline elements: shrink to content width\n        // Return calculated width in pixels\n    }\n    \n    fn calculate_auto_height(&self, content_height: f32) -> f32 {\n        // TODO: Implement auto height calculation\n        // Usually equals content height unless overridden by CSS\n        // Return calculated height in pixels\n    }\n}\n```\n\n```rust\n// src/layout/block_layout.rs\nuse crate::layout::{LayoutBox, BoxType};\nuse crate::layout::geometry::{Point, Size, Rectangle};\n\nimpl LayoutBox {\n    /// Layout child elements in block formatting context\n    /// Stacks children vertically with proper margin handling\n    pub fn layout_block_children(&mut self, available_width: f32) {\n        // TODO 1: Initialize layout state (current y position, previous margin)\n        // Hint: Start y at top of content area, track margin for collapsing\n        \n        // TODO 2: Iterate through child elements in document order\n        // Hint: Use self.children.iter_mut() for mutable access\n        \n        // TODO 3: For each child, calculate its box model with available width\n        // Hint: Call child.calculate_box_model(Size::new(available_width, auto_height))\n        \n        // TODO 4: Check for margin collapsing with previous sibling\n        // Hint: Compare current child's top margin with previous child's bottom margin\n        // Hint: Use the larger margin value, don't add them together\n        \n        // TODO 5: Position the child at calculated y coordinate\n        // Hint: Set child's margin_rect.origin.y based on current_y and collapsed margins\n        \n        // TODO 6: Update current_y position for next child\n        // Hint: Add this child's total height (margin_rect.size.height) to current_y\n        \n        // TODO 7: Store previous child's bottom margin for next iteration\n        // Hint: Track margin values for collapsing calculation\n        \n        // TODO 8: After all children positioned, update parent's content height\n        // Hint: Parent content height should encompass all positioned children\n    }\n    \n    fn calculate_margin_collapse(&self, margin1: f32, margin2: f32) -> f32 {\n        // TODO: Implement margin collapsing algorithm\n        // Positive margins: use maximum\n        // Negative margins: use minimum (most negative)\n        // Mixed: add maximum positive and minimum negative\n    }\n    \n    fn should_collapse_margins(&self, child1: &LayoutBox, child2: &LayoutBox) -> bool {\n        // TODO: Determine if margins should collapse between these children\n        // Check for intervening padding, border, or content\n        // Return true if margins are adjacent and should collapse\n    }\n}\n```\n\n```rust\n// src/layout/inline_layout.rs\nuse crate::layout::{LayoutBox, BoxType};\nuse crate::layout::geometry::{Point, Size, Rectangle};\nuse crate::layout::text_measurement::{SimpleTextMeasurer, TextMetrics};\n\npub struct LineBox {\n    pub baseline_y: f32,\n    pub line_height: f32,\n    pub content_width: f32,\n    pub elements: Vec<InlineElement>,\n}\n\npub struct InlineElement {\n    pub content_rect: Rectangle,\n    pub baseline_offset: f32,\n    pub element_type: InlineElementType,\n}\n\npub enum InlineElementType {\n    Text(String),\n    InlineBox(LayoutBox),\n}\n\nimpl LayoutBox {\n    /// Layout content in inline formatting context\n    /// Flows content horizontally with line breaking and baseline alignment\n    pub fn layout_inline_content(&mut self, available_width: f32, text_measurer: &SimpleTextMeasurer) {\n        // TODO 1: Initialize line layout state (current line box, x position)\n        // Hint: Create first LineBox with baseline position and available width\n        \n        // TODO 2: Process each inline child element or text node\n        // Hint: Iterate through inline content, measuring each piece\n        \n        // TODO 3: For each content piece, check if it fits on current line\n        // Hint: Compare element width against remaining line width\n        \n        // TODO 4: If content doesn't fit, find appropriate line break point\n        // Hint: Look for word boundaries, whitespace, or hyphen break opportunities\n        \n        // TODO 5: Break content if necessary and wrap to new line\n        // Hint: Split content at break point, place first part on current line\n        \n        // TODO 6: Add content to current line with baseline alignment\n        // Hint: Calculate baseline offset based on font metrics and vertical-align\n        \n        // TODO 7: Update line box dimensions based on added content\n        // Hint: Line height grows to accommodate tallest element\n        \n        // TODO 8: When line is complete, finalize line box and create next line\n        // Hint: Position completed line box and initialize new line for remaining content\n        \n        // TODO 9: Stack completed line boxes vertically in containing block\n        // Hint: Each line positions below previous line, similar to block stacking\n    }\n    \n    fn find_line_break_opportunity(&self, text: &str, max_width: f32, text_measurer: &SimpleTextMeasurer) -> usize {\n        // TODO: Find optimal break point in text that fits within max_width\n        // Prefer word boundaries, handle overflow cases\n        // Return character index where break should occur\n    }\n    \n    fn calculate_baseline_alignment(&self, element_height: f32, line_baseline: f32, vertical_align: &str) -> f32 {\n        // TODO: Calculate vertical offset for baseline alignment\n        // Handle \"baseline\", \"top\", \"middle\", \"bottom\" alignment values\n        // Return y offset from line top to element baseline\n    }\n    \n    fn measure_inline_content(&self, content: &InlineElementType, text_measurer: &SimpleTextMeasurer) -> TextMetrics {\n        // TODO: Measure width and height requirements for inline content\n        // Handle text measurement and inline element measurement differently\n        // Return metrics needed for line breaking and baseline alignment\n    }\n}\n```\n\n**Language-Specific Hints for Rust:**\n- Use `f32` for all layout calculations to match graphics coordinates and avoid precision issues with CSS pixel values\n- Implement `Debug` and `Clone` traits on geometry types for easier debugging and testing\n- Consider using `RefCell<T>` or similar interior mutability patterns if you need to modify layout boxes during traversal\n- Use `Option<T>` for parent references to handle the root element case cleanly\n- Leverage Rust's pattern matching for handling different `BoxType` variants in layout algorithms\n- Consider using the `euclid` crate for more advanced geometric operations if needed\n\n**Milestone Checkpoint:**\nAfter implementing the layout engine, verify these behaviors:\n- **Box Model Test**: Create an element with explicit width, padding, border, and margin. Verify that `content_rect`, `padding_rect`, `border_rect`, and `margin_rect` are correctly calculated and positioned\n- **Block Layout Test**: Create nested block elements and verify they stack vertically with correct y-positions and that each child's x-position aligns with the parent's content area\n- **Margin Collapsing Test**: Create two adjacent block elements with different margin values and verify that the space between them equals the larger margin, not the sum\n- **Inline Layout Test**: Create a block containing text and inline elements that exceed the container width, and verify that content wraps to multiple lines with consistent baseline alignment\n- **Mixed Content Test**: Combine block and inline elements in a complex layout and verify that the layout tree correctly represents the hierarchical positioning\n\n**Debugging Tips:**\n\n| Symptom | Likely Cause | How to Diagnose | Fix |\n|---------|-------------|-----------------|-----|\n| Elements overlap vertically | Incorrect height calculation or y positioning | Print each element's margin_rect coordinates | Check box model height calculation and ensure y positions account for previous elements |\n| Elements extend beyond parent | Wrong available space calculation | Compare child width against parent content width | Subtract parent's padding and border from available space calculation |\n| Inconsistent text alignment | Baseline calculation errors | Print baseline offsets for each line element | Verify font metrics and baseline alignment calculations match expected behavior |\n| Margin spacing looks wrong | Margin collapsing not applied correctly | Print individual margins vs collapsed margins | Check margin collapsing conditions and ensure algorithm handles positive/negative/mixed margins |\n| Layout tree seems incomplete | Missing layout box creation | Print layout tree structure with indentation | Ensure layout boxes are created for all DOM elements that should participate in layout |\n\n\n## Rendering Engine Design\n\n> **Milestone(s):** Milestone 4 (Rendering) - This section implements the final stage of the rendering pipeline that converts the computed layout tree into visual output through paint command generation and graphics rendering.\n\nThe **rendering engine** transforms the abstract layout tree into concrete visual output that users can see on their screens. Think of this stage as a **printing press operation** where we have already typeset all the text and determined where every element should be positioned (the layout stage), and now we need to actually put ink on paper in the correct order. Just as a printing press must lay down colors in a specific sequence—background colors first, then text, then any overlays—our rendering engine must generate drawing commands in the proper **paint order** to ensure elements appear correctly layered.\n\nThe rendering engine operates on a fundamental principle: it traverses the layout tree in **document order** (the sequence elements appear in the HTML) but generates paint commands that will be executed in **z-order** (background to foreground). This separation between traversal order and paint order is crucial because an element that appears later in the HTML might need to be painted behind an element that appears earlier, depending on CSS positioning and stacking contexts.\n\n> **Decision: Display List Architecture**\n> - **Context**: The rendering engine needs to convert layout information into graphics operations while supporting efficient repainting and potential optimizations\n> - **Options Considered**: Direct immediate-mode rendering, retained display lists, scene graphs\n> - **Decision**: Generate a display list of paint commands before rendering\n> - **Rationale**: Display lists decouple layout traversal from graphics execution, enable batching optimizations, support efficient damage tracking for repainting, and provide a clean abstraction over different graphics backends\n> - **Consequences**: Adds memory overhead for storing commands but enables better performance through batching and provides flexibility for future optimizations like GPU acceleration\n\n| Architecture Option | Pros | Cons | Chosen? |\n|---------------------|------|------|---------|\n| Immediate Mode Rendering | Simple, low memory usage | Difficult to optimize, tight coupling to graphics backend | No |\n| Display List Generation | Decoupled, optimizable, backend-agnostic | Additional memory usage, two-phase rendering | **Yes** |\n| Scene Graph | Highly optimizable, supports complex effects | Over-engineered for simple browser, complex API | No |\n\nThe rendering process consists of three distinct phases. First, **paint command generation** walks the layout tree and emits drawing operations for each visible element. Second, **display list optimization** processes these commands to eliminate unnecessary drawing and batch similar operations. Third, **graphics execution** sends the optimized commands to the underlying graphics system for actual drawing to the screen or buffer.\n\n### Paint Command Generation\n\nThink of paint command generation as creating a **recipe for an artist** who will paint the webpage. The artist doesn't know anything about HTML, CSS, or layout—they only understand basic drawing instructions like \"fill this rectangle with blue\" or \"draw this text at position (100, 50) using 14-pixel Arial font.\" Our job is to translate the rich semantic and layout information in our layout tree into these primitive drawing commands.\n\nThe paint command generation process follows a **depth-first traversal** of the layout tree, visiting each layout box and determining what visual elements it contributes to the final rendering. For each layout box, we generate commands in a specific order that respects the CSS painting model: background painting, border painting, and foreground content painting. This ordering ensures that backgrounds appear behind text, borders appear around their content, and overlapping elements stack correctly.\n\n> The key insight in paint command generation is that we must separate the **what to paint** (determined by CSS properties) from the **how to paint** (implemented by graphics primitives). This separation allows us to support different graphics backends while maintaining consistent visual output.\n\nThe paint command generation algorithm processes each layout box through several painting phases:\n\n1. **Background Phase**: Generate commands to fill the background area with colors, gradients, or images specified in the element's computed style\n2. **Border Phase**: Create drawing commands for each border edge, handling different border styles, widths, and colors\n3. **Content Phase**: For text content, generate text rendering commands with proper font, size, and positioning\n4. **Child Phase**: Recursively process child layout boxes, maintaining proper stacking order\n\nEach phase examines the layout box's computed style properties to determine what painting operations are necessary. A layout box with `background-color: transparent` and no borders contributes no background or border commands to the display list, while a box with `background-color: blue` and a `2px solid red` border generates both fill and stroke commands.\n\n| Paint Phase | Responsible For | Example Commands | Style Properties Used |\n|-------------|-----------------|------------------|----------------------|\n| Background | Filling element background | `DrawRectangle` with background color | `background-color`, `background-image` |\n| Border | Drawing element borders | `DrawBorder` for each edge | `border-width`, `border-color`, `border-style` |\n| Content | Text and replaced content | `DrawText` with positioning | `color`, `font-family`, `font-size` |\n| Children | Nested element painting | Recursive paint command generation | Inherited and cascaded properties |\n\nThe `PaintCommand` enumeration defines the primitive drawing operations that our graphics backend must support:\n\n| Command Type | Parameters | Purpose | Example Usage |\n|--------------|------------|---------|---------------|\n| `DrawRectangle` | rectangle: Rectangle, color: Color | Fill rectangular area | Element backgrounds, solid borders |\n| `DrawBorder` | rectangle: Rectangle, widths: BoxOffsets, colors: [Color; 4] | Draw bordered rectangle | CSS border properties |\n| `DrawText` | text: String, position: Point, font: FontInfo, color: Color | Render text content | Element text nodes |\n| `SetClip` | rectangle: Rectangle | Restrict drawing area | Overflow clipping, nested contexts |\n| `ClearClip` | None | Remove clipping restriction | End of clipped content |\n\n**Paint command generation for text content** requires special consideration because text rendering involves complex typography concepts like baseline alignment, font metrics, and character positioning. When we encounter a text layout box, we must generate `DrawText` commands that position each text run at the correct baseline position within its line box. The text's x-coordinate comes from the layout box's content rectangle, while the y-coordinate must account for the line box's baseline position and the font's ascent metrics.\n\nFor **block-level elements**, paint command generation typically produces `DrawRectangle` commands for backgrounds followed by `DrawBorder` commands for any visible borders. The rectangle coordinates come directly from the layout box's computed rectangles—the background is painted to fill the `padding_rect` (content area plus padding), while borders are drawn around the `border_rect` (padding area plus border width).\n\n**Inline elements present unique challenges** because they can wrap across multiple lines, creating multiple rectangular fragments. A single inline element might generate several `DrawRectangle` commands if its background needs to be painted across line breaks. Each line fragment gets its own drawing command with coordinates computed from the inline element's line box positions.\n\n> **Decision: Paint Order Strategy**\n> - **Context**: Elements must be painted in correct z-order to handle overlapping content, but layout tree traversal follows document order\n> - **Options Considered**: Sort commands by z-index after generation, traverse tree in paint order, generate commands with z-index hints\n> - **Decision**: Generate commands in document order with z-index metadata, sort before rendering\n> - **Rationale**: Document order traversal is simpler and matches CSS cascade semantics, while post-generation sorting handles complex stacking contexts correctly\n> - **Consequences**: Requires additional sorting step and z-index calculation, but provides correct visual layering\n\nThe paint command generation process must handle **clipping contexts** where child elements should not draw outside their parent's boundaries. When we encounter a layout box with `overflow: hidden` or similar clipping behavior, we generate `SetClip` and `ClearClip` commands that establish a clipped drawing region. All paint commands generated for child elements will be automatically clipped to this region by the graphics backend.\n\n**Stacking context handling** ensures that elements with CSS properties like `z-index`, `position: absolute`, or `opacity` are painted in the correct order relative to other elements. The paint command generator maintains a **stacking context stack** as it traverses the layout tree, tracking which elements create new stacking contexts and what their relative z-order should be.\n\n⚠️ **Pitfall: Incorrect Paint Order**\nA common mistake is generating paint commands in the same order as layout tree traversal without considering CSS stacking contexts. This results in elements appearing in the wrong z-order, with later HTML elements incorrectly painting over earlier elements that should be on top. To avoid this, always calculate z-index values during paint command generation and either sort commands afterward or maintain separate command lists for different stacking levels.\n\n⚠️ **Pitfall: Missing Background Clipping**\nDevelopers often forget that element backgrounds should be clipped to the element's border edges when the element has rounded corners or complex border styles. Failing to generate appropriate `SetClip` commands results in backgrounds bleeding outside the intended element boundaries. Always check for border-radius and other properties that affect background clipping.\n\n### Graphics Backend Abstraction\n\nThink of the graphics backend abstraction as a **universal translator** that converts our high-level paint commands into the specific API calls required by different graphics systems. Just as a universal translator can convey the same meaning through English, Spanish, or Mandarin, our graphics abstraction expresses the same visual intent through different rendering APIs like CPU-based pixel buffers, GPU-accelerated canvases, or even vector graphics formats.\n\nThe graphics backend abstraction serves as a **clean interface boundary** between our browser engine's rendering logic and the underlying platform-specific graphics implementation. This separation allows us to support multiple rendering targets—from simple RGB pixel buffers for testing to hardware-accelerated graphics APIs for performance—without changing any of the paint command generation logic.\n\n> The fundamental principle of graphics backend abstraction is **primitive sufficiency**: we identify the minimal set of drawing operations needed to render any webpage and ensure our abstraction supports exactly those operations. This prevents both feature gaps (missing capabilities) and interface bloat (unnecessary complexity).\n\nOur graphics abstraction defines a **trait or interface** that any graphics backend must implement:\n\n| Method | Parameters | Returns | Purpose |\n|--------|------------|---------|---------|\n| `draw_rectangle` | rect: Rectangle, color: Color | Result<(), String> | Fill rectangular region with solid color |\n| `draw_border` | rect: Rectangle, widths: BoxOffsets, colors: [Color; 4] | Result<(), String> | Draw bordered rectangle with per-edge styling |\n| `draw_text` | text: &str, position: Point, font: FontInfo, color: Color | Result<(), String> | Render text at specified position |\n| `set_clip_rect` | rect: Rectangle | Result<(), String> | Establish clipping region for subsequent draws |\n| `clear_clip` | None | Result<(), String> | Remove current clipping region |\n| `create_surface` | size: Size | Result<Surface, String> | Create new drawing surface |\n| `present_surface` | surface: Surface | Result<Vec<u8>, String> | Finalize surface and return pixel data |\n\nEach graphics backend implementation handles the translation from these abstract operations to concrete graphics API calls. A **software rasterization backend** might maintain a pixel buffer and implement `draw_rectangle` by setting pixel values in a loop. A **GPU-accelerated backend** might convert the same call into vertex buffer uploads and shader dispatch calls.\n\n**Font handling** within the graphics abstraction requires careful design because text rendering involves platform-specific font loading, glyph rasterization, and text measurement capabilities. Our abstraction defines font operations that any backend must support:\n\n| Font Operation | Parameters | Returns | Purpose |\n|----------------|------------|---------|---------|\n| `load_font` | family: String, size: f32, weight: u16 | Result<FontHandle, String> | Load font for text rendering |\n| `measure_text` | text: &str, font: FontHandle | TextMetrics | Calculate text dimensions |\n| `get_font_metrics` | font: FontHandle | FontMetrics | Get baseline, ascent, descent |\n\nDifferent graphics backends implement font operations using their platform's text rendering systems. A backend targeting web browsers might use the Canvas 2D text API, while a native desktop backend might use operating system font services like DirectWrite on Windows or Core Text on macOS.\n\n> **Decision: Abstract Graphics Interface Design**\n> - **Context**: Need to support multiple graphics backends (software rendering, GPU acceleration, different platforms) while keeping the interface manageable\n> - **Options Considered**: Low-level pixel manipulation interface, high-level scene graph interface, medium-level drawing primitives\n> - **Decision**: Medium-level drawing primitives that match CSS painting model\n> - **Rationale**: Low-level interfaces require reimplementing text rendering and clipping; high-level interfaces don't map cleanly to diverse backends; medium-level primitives align with CSS semantics and are implementable on various platforms\n> - **Consequences**: Clean separation between rendering logic and graphics implementation, but requires careful primitive selection to avoid missing functionality\n\n**Error handling in graphics operations** must account for various failure modes including out-of-memory conditions, invalid parameters, and backend-specific errors like graphics context loss. Our abstraction returns `Result` types for all operations that can fail, allowing the rendering engine to implement appropriate fallback strategies.\n\n**Resource management** in graphics backends involves tracking allocated resources like font handles, textures, and rendering contexts. The abstraction defines clear ownership semantics: the backend owns graphics resources and provides handles to the rendering engine, while the rendering engine is responsible for releasing resources when no longer needed.\n\nA **simple software rasterization backend** serves as our reference implementation and provides a fallback rendering path that works on any platform. This backend maintains an internal pixel buffer and implements all drawing operations through direct pixel manipulation:\n\n| Operation | Implementation Strategy | Performance Characteristics |\n|-----------|------------------------|----------------------------|\n| Rectangle Drawing | Nested loops setting pixel values | O(width × height) per rectangle |\n| Text Rendering | Bitmap font glyph copying | O(character_count × glyph_size) |\n| Clipping | Coordinate bounds checking | O(1) per pixel, applied during rasterization |\n| Alpha Blending | Per-pixel color interpolation | O(1) per pixel with transparency |\n\n**Hardware-accelerated backends** leverage GPU capabilities for improved performance on complex pages. These backends translate our abstract drawing commands into GPU operations:\n\n- Rectangle drawing becomes vertex buffer uploads for quad rendering\n- Text rendering uses glyph textures and instanced drawing\n- Clipping maps to GPU scissor tests or stencil buffer operations\n- Complex effects like shadows or gradients use pixel shaders\n\n⚠️ **Pitfall: Platform-Specific Font Metrics**\nDifferent graphics backends often report slightly different font metrics for the same font family and size due to platform differences in font rasterization. This can cause text to appear at slightly different positions across backends, breaking layout consistency. To avoid this, implement font metric normalization in your graphics abstraction or use a cross-platform font rendering library like FreeType.\n\n⚠️ **Pitfall: Coordinate System Mismatches**\nGraphics systems use different coordinate origins (top-left vs bottom-left) and scaling factors (device pixels vs logical pixels). Failing to handle these differences in your graphics abstraction results in incorrectly positioned or sized elements. Always define a canonical coordinate system for your paint commands and handle transformations within each backend implementation.\n\n### Rendering Optimizations\n\nThink of rendering optimizations as **smart shortcuts** that allow us to produce the same visual result with less computational work. Just as a skilled house painter might skip painting wall areas that will be completely covered by furniture, our rendering optimizations identify situations where we can avoid unnecessary drawing operations without affecting the final appearance.\n\nThe optimization phase processes the generated display list before sending commands to the graphics backend, applying various techniques to reduce the total rendering workload. These optimizations operate on the principle of **visual equivalence**: any optimization that changes the final rendered appearance is incorrect, but optimizations that produce identical visual results while doing less work are valuable performance improvements.\n\n**Clipping-based culling** represents the most fundamental rendering optimization. This technique eliminates paint commands for elements that fall completely outside the visible viewport or current clipping region. When an element's bounding rectangle has no intersection with the current clip bounds, none of its paint commands can affect the final output, so we can safely skip them entirely.\n\nThe clipping optimization algorithm maintains a **clip bounds stack** as it processes the display list:\n\n1. Initialize clip bounds to the full viewport rectangle\n2. For each `SetClip` command, push the intersection of current bounds and new clip region\n3. For each drawing command, test if the command's bounds intersect the current clip bounds\n4. If no intersection exists, skip the command; otherwise, include it in the optimized display list\n5. For each `ClearClip` command, pop the previous clip bounds from the stack\n\n| Optimization Type | Detection Method | Performance Benefit | Implementation Complexity |\n|------------------|------------------|-------------------|-------------------------|\n| Viewport Culling | Rectangle intersection test | Skip entire subtrees outside viewport | Low - simple bounds checking |\n| Overdraw Elimination | Z-order analysis of opaque rectangles | Reduce pixel fill operations | Medium - requires sorting and coverage analysis |\n| Command Batching | Group similar consecutive commands | Reduce graphics API call overhead | Low - merge compatible operations |\n| Empty Command Removal | Check for zero-sized or transparent operations | Eliminate no-op graphics calls | Low - validate command parameters |\n\n**Overdraw elimination** optimizes cases where multiple elements paint to the same screen region by identifying situations where later drawing operations completely obscure earlier ones. If we have two opaque rectangles that occupy the same screen area, we only need to draw the topmost rectangle since it will completely hide the one behind it.\n\nThe overdraw elimination algorithm requires analyzing the **z-order relationships** between paint commands:\n\n1. Sort paint commands by their z-order position (background to foreground)\n2. For each opaque rectangle command, check if any later opaque rectangles completely cover it\n3. If a rectangle is completely covered by later rectangles, mark it for removal\n4. Generate the final optimized display list excluding covered commands\n\n> **Decision: Optimization Strategy**\n> - **Context**: Display lists can contain many redundant or invisible drawing operations that waste rendering performance\n> - **Options Considered**: No optimization (simple), conservative clipping only, aggressive optimization with complex analysis\n> - **Decision**: Implement conservative clipping and simple batching optimizations\n> - **Rationale**: Clipping provides significant performance benefits with minimal complexity; aggressive optimizations have diminishing returns and risk introducing visual bugs\n> - **Consequences**: Good performance improvement for typical web content without excessive implementation complexity\n\n**Command batching** groups consecutive similar drawing operations to reduce graphics API overhead. Many graphics systems have significant per-call costs, so combining multiple rectangle draws into a single batched operation can improve performance substantially. This optimization works best when the display list contains many similar operations in sequence.\n\nBatching opportunities include:\n\n- Multiple `DrawRectangle` commands with the same color can be combined into a single call with multiple rectangles\n- Consecutive `DrawText` commands using the same font can be batched into a single text rendering call\n- Similar border drawing operations can be grouped to minimize graphics state changes\n\n**Empty command elimination** removes paint commands that produce no visible output. These include rectangles with zero area, text commands with empty strings, or any drawing operations using completely transparent colors. While these commands are harmless, removing them reduces the workload on the graphics backend.\n\nThe empty command detection process examines each paint command's parameters:\n\n| Command Type | Empty Condition | Optimization Action |\n|--------------|----------------|-------------------|\n| `DrawRectangle` | Width or height ≤ 0, or alpha = 0 | Remove command entirely |\n| `DrawText` | Empty string or font size ≤ 0 | Remove command entirely |\n| `DrawBorder` | All border widths = 0 | Remove command entirely |\n| `SetClip` | Clip rectangle has zero area | Replace with `ClearClip` |\n\n**Display list compression** optimizes memory usage by representing common patterns more efficiently. For example, a series of text drawing commands that differ only in their x-coordinates might be compressed into a single command with multiple text positions. This optimization is particularly valuable for pages with large amounts of text content.\n\n> The key insight for rendering optimizations is to focus on the **common cases** that provide the biggest performance improvements. Optimizing rare edge cases often adds complexity without meaningful benefits, while simple optimizations like viewport culling can eliminate large amounts of unnecessary work with minimal code.\n\n**Damage tracking** prepares our rendering system for future optimizations like incremental repainting. During the optimization phase, we can mark which regions of the screen are affected by each paint command, enabling future updates to only repaint the portions of the page that have actually changed.\n\n⚠️ **Pitfall: Over-Aggressive Culling**\nA common mistake is culling elements based only on their content rectangles without considering effects like box shadows, outlines, or transforms that can extend beyond the element's normal bounds. This results in visual artifacts where parts of elements disappear when they should remain visible. Always use the complete visual bounds of an element, including all graphical effects, when making culling decisions.\n\n⚠️ **Pitfall: Incorrect Z-Order Optimization**\nWhen implementing overdraw elimination, developers sometimes incorrectly assume that later elements in the DOM always paint over earlier elements. This ignores CSS stacking contexts and z-index properties that can cause earlier elements to appear above later ones. Always use the computed z-order from layout rather than DOM order when making overdraw optimization decisions.\n\n![Paint Command Generation Sequence](./diagrams/rendering-paint-order.svg)\n\n### Implementation Guidance\n\nThe rendering engine implementation combines paint command generation, graphics abstraction, and optimization techniques into a cohesive system that produces visual output from layout trees.\n\n**Technology Recommendations:**\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| Graphics Backend | Software rasterization with RGB buffer | Hardware acceleration with wgpu or vulkano |\n| Font Handling | Fixed-width character approximation | System fonts with fontdue or rusttype |\n| Image Output | Raw pixel buffer to file | PNG encoding with image crate |\n| Performance Profiling | Manual timing with std::time::Instant | Profiling with puffin or tracy |\n\n**Recommended File Structure:**\n```\nsrc/\n  render/\n    mod.rs                    ← Public API and RenderEngine\n    paint/\n      mod.rs                  ← Paint command generation\n      commands.rs             ← PaintCommand definitions\n      painter.rs              ← Layout tree traversal\n    graphics/\n      mod.rs                  ← Graphics backend abstraction\n      software.rs             ← Software rasterization backend\n      types.rs                ← Graphics primitives and colors\n    optimize/\n      mod.rs                  ← Display list optimizations\n      culling.rs              ← Viewport and clip culling\n      batching.rs             ← Command batching\n```\n\n**Core Graphics Types (Complete Implementation):**\n```rust\n// graphics/types.rs - Complete graphics primitives\nuse crate::layout::Rectangle;\nuse std::collections::HashMap;\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Color {\n    pub r: u8,\n    pub g: u8,\n    pub b: u8,\n    pub a: u8,\n}\n\nimpl Color {\n    pub fn rgb(r: u8, g: u8, b: u8) -> Self {\n        Color { r, g, b, a: 255 }\n    }\n    \n    pub fn rgba(r: u8, g: u8, b: u8, a: u8) -> Self {\n        Color { r, g, b, a }\n    }\n    \n    pub fn from_hex(hex: &str) -> Result<Color, String> {\n        let hex = hex.trim_start_matches('#');\n        if hex.len() != 6 {\n            return Err(format!(\"Invalid hex color length: {}\", hex));\n        }\n        \n        let r = u8::from_str_radix(&hex[0..2], 16)\n            .map_err(|_| format!(\"Invalid hex color: {}\", hex))?;\n        let g = u8::from_str_radix(&hex[2..4], 16)\n            .map_err(|_| format!(\"Invalid hex color: {}\", hex))?;\n        let b = u8::from_str_radix(&hex[4..6], 16)\n            .map_err(|_| format!(\"Invalid hex color: {}\", hex))?;\n        \n        Ok(Color::rgb(r, g, b))\n    }\n    \n    pub fn is_transparent(&self) -> bool {\n        self.a == 0\n    }\n    \n    pub fn blend_over(&self, background: Color) -> Color {\n        if self.a == 255 {\n            *self\n        } else if self.a == 0 {\n            background\n        } else {\n            let alpha = self.a as f32 / 255.0;\n            let inv_alpha = 1.0 - alpha;\n            \n            Color::rgba(\n                ((self.r as f32 * alpha) + (background.r as f32 * inv_alpha)) as u8,\n                ((self.g as f32 * alpha) + (background.g as f32 * inv_alpha)) as u8,\n                ((self.b as f32 * alpha) + (background.b as f32 * inv_alpha)) as u8,\n                255,\n            )\n        }\n    }\n}\n\npub const WHITE: Color = Color { r: 255, g: 255, b: 255, a: 255 };\npub const BLACK: Color = Color { r: 0, g: 0, b: 0, a: 255 };\npub const TRANSPARENT: Color = Color { r: 0, g: 0, b: 0, a: 0 };\n\n#[derive(Debug, Clone)]\npub struct FontInfo {\n    pub family: String,\n    pub size: f32,\n    pub weight: u16,\n    pub style: FontStyle,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub enum FontStyle {\n    Normal,\n    Italic,\n}\n\n#[derive(Debug, Clone, Copy)]\npub struct TextMetrics {\n    pub advance_width: f32,\n    pub ascent: f32,\n    pub descent: f32,\n    pub line_height: f32,\n}\n```\n\n**Display List and Paint Commands (Complete Implementation):**\n```rust\n// paint/commands.rs - Complete paint command definitions\nuse crate::layout::{Rectangle, Point};\nuse crate::render::graphics::{Color, FontInfo};\nuse crate::style::BoxOffsets;\n\n#[derive(Debug, Clone)]\npub enum PaintCommand {\n    DrawRectangle {\n        rect: Rectangle,\n        color: Color,\n    },\n    DrawBorder {\n        rect: Rectangle,\n        widths: BoxOffsets,\n        colors: [Color; 4], // top, right, bottom, left\n    },\n    DrawText {\n        text: String,\n        position: Point,\n        font: FontInfo,\n        color: Color,\n    },\n    SetClip {\n        rect: Rectangle,\n    },\n    ClearClip,\n}\n\n#[derive(Debug, Clone)]\npub struct DisplayList {\n    pub commands: Vec<PaintCommand>,\n    pub viewport: Rectangle,\n    pub background_color: Color,\n}\n\nimpl DisplayList {\n    pub fn new(viewport: Rectangle, background_color: Color) -> Self {\n        DisplayList {\n            commands: Vec::new(),\n            viewport,\n            background_color,\n        }\n    }\n    \n    pub fn add_command(&mut self, command: PaintCommand) {\n        self.commands.push(command);\n    }\n    \n    pub fn command_count(&self) -> usize {\n        self.commands.len()\n    }\n    \n    pub fn clear(&mut self) {\n        self.commands.clear();\n    }\n}\n```\n\n**Graphics Backend Trait (Interface Definition):**\n```rust\n// graphics/mod.rs - Graphics backend abstraction\nuse crate::layout::{Rectangle, Point, Size};\nuse crate::render::graphics::{Color, FontInfo, TextMetrics};\nuse crate::style::BoxOffsets;\n\npub trait GraphicsBackend {\n    type Surface;\n    type Error: std::error::Error;\n    \n    /// Create a new drawing surface with specified dimensions\n    fn create_surface(&mut self, size: Size) -> Result<Self::Surface, Self::Error>;\n    \n    /// Fill a rectangular region with solid color\n    fn draw_rectangle(&mut self, surface: &mut Self::Surface, rect: Rectangle, color: Color) \n        -> Result<(), Self::Error>;\n    \n    /// Draw a bordered rectangle with per-edge styling\n    fn draw_border(&mut self, surface: &mut Self::Surface, rect: Rectangle, \n                  widths: BoxOffsets, colors: [Color; 4]) -> Result<(), Self::Error>;\n    \n    /// Render text at specified position\n    fn draw_text(&mut self, surface: &mut Self::Surface, text: &str, position: Point, \n                font: FontInfo, color: Color) -> Result<(), Self::Error>;\n    \n    /// Establish clipping region for subsequent draws\n    fn set_clip_rect(&mut self, surface: &mut Self::Surface, rect: Rectangle) \n        -> Result<(), Self::Error>;\n    \n    /// Remove current clipping region\n    fn clear_clip(&mut self, surface: &mut Self::Surface) -> Result<(), Self::Error>;\n    \n    /// Calculate text dimensions for layout\n    fn measure_text(&self, text: &str, font: &FontInfo) -> TextMetrics;\n    \n    /// Finalize surface and return pixel data\n    fn present_surface(&mut self, surface: Self::Surface) -> Result<Vec<u8>, Self::Error>;\n}\n```\n\n**Paint Command Generator (Core Logic Skeleton):**\n```rust\n// paint/painter.rs - Layout tree to paint command conversion\nuse crate::layout::{LayoutBox, BoxType};\nuse crate::render::paint::{PaintCommand, DisplayList};\nuse crate::render::graphics::{Color, FontInfo};\nuse crate::style::ComputedStyle;\n\npub struct PaintCommandGenerator;\n\nimpl PaintCommandGenerator {\n    /// Generate display list from layout tree\n    pub fn generate_display_list(layout_root: &LayoutBox, viewport: Rectangle) -> DisplayList {\n        let mut display_list = DisplayList::new(viewport, WHITE);\n        let mut generator = PaintCommandGenerator;\n        \n        // TODO 1: Start paint command generation from root\n        // TODO 2: Set initial clipping bounds to viewport\n        // TODO 3: Generate background command for root if needed\n        // TODO 4: Recursively paint all child boxes\n        // TODO 5: Return completed display list\n        \n        display_list\n    }\n    \n    /// Paint a single layout box and its children\n    fn paint_box(&mut self, layout_box: &LayoutBox, display_list: &mut DisplayList) {\n        // TODO 1: Check if box intersects current clipping bounds (optimization)\n        // TODO 2: Paint background if background color is not transparent\n        // TODO 3: Paint borders if any border has non-zero width\n        // TODO 4: Paint content based on box type (text vs container)\n        // TODO 5: Set up clipping for children if overflow is hidden\n        // TODO 6: Recursively paint child boxes\n        // TODO 7: Clear clipping if it was set for this box\n        // Hint: Use layout_box.computed_style to get colors and other properties\n        // Hint: Use layout_box.content_rect, padding_rect, border_rect for positioning\n    }\n    \n    /// Generate background paint command for layout box\n    fn paint_background(&mut self, layout_box: &LayoutBox, display_list: &mut DisplayList) {\n        // TODO 1: Get background color from computed style\n        // TODO 2: Check if background color is not transparent\n        // TODO 3: Create DrawRectangle command using padding_rect as bounds\n        // TODO 4: Add command to display list\n        // Hint: Background fills the padding area (content + padding)\n    }\n    \n    /// Generate border paint commands for layout box\n    fn paint_borders(&mut self, layout_box: &LayoutBox, display_list: &mut DisplayList) {\n        // TODO 1: Get border widths and colors from computed style\n        // TODO 2: Check if any border width is greater than 0\n        // TODO 3: Create DrawBorder command using border_rect as bounds\n        // TODO 4: Set up border colors array [top, right, bottom, left]\n        // TODO 5: Add command to display list\n        // Hint: Use BoxOffsets for border widths\n    }\n    \n    /// Generate text paint command for text content\n    fn paint_text(&mut self, layout_box: &LayoutBox, display_list: &mut DisplayList) {\n        // TODO 1: Extract text content from layout box (only for TextBox type)\n        // TODO 2: Get font information from computed style\n        // TODO 3: Calculate baseline position from content_rect and font metrics\n        // TODO 4: Create FontInfo struct with family, size, weight\n        // TODO 5: Create DrawText command with text, position, font, color\n        // TODO 6: Add command to display list\n        // Hint: Text baseline is content_rect.origin.y + ascent\n        // Hint: Use computed_style.color for text color\n    }\n}\n```\n\n**Software Rasterization Backend (Complete Implementation):**\n```rust\n// graphics/software.rs - Simple pixel buffer backend\nuse crate::layout::{Rectangle, Point, Size};\nuse crate::render::graphics::{GraphicsBackend, Color, FontInfo, TextMetrics};\nuse crate::style::BoxOffsets;\nuse std::cmp::{min, max};\n\npub struct SoftwareRenderer {\n    font_size: f32,\n    char_width: f32,\n    line_height: f32,\n}\n\npub struct PixelSurface {\n    width: u32,\n    height: u32,\n    pixels: Vec<u8>, // RGBA format\n    clip_stack: Vec<Rectangle>,\n}\n\n#[derive(Debug)]\npub enum SoftwareError {\n    InvalidDimensions,\n    OutOfBounds,\n}\n\nimpl std::error::Error for SoftwareError {}\nimpl std::fmt::Display for SoftwareError {\n    fn fmt(&self, f: &mut std::fmt::Formatter) -> std::fmt::Result {\n        match self {\n            SoftwareError::InvalidDimensions => write!(f, \"Invalid surface dimensions\"),\n            SoftwareError::OutOfBounds => write!(f, \"Drawing operation out of bounds\"),\n        }\n    }\n}\n\nimpl SoftwareRenderer {\n    pub fn new() -> Self {\n        SoftwareRenderer {\n            font_size: 14.0,\n            char_width: 8.0,\n            line_height: 16.0,\n        }\n    }\n}\n\nimpl GraphicsBackend for SoftwareRenderer {\n    type Surface = PixelSurface;\n    type Error = SoftwareError;\n    \n    fn create_surface(&mut self, size: Size) -> Result<PixelSurface, SoftwareError> {\n        if size.width <= 0.0 || size.height <= 0.0 {\n            return Err(SoftwareError::InvalidDimensions);\n        }\n        \n        let width = size.width as u32;\n        let height = size.height as u32;\n        let pixel_count = (width * height * 4) as usize; // RGBA\n        \n        Ok(PixelSurface {\n            width,\n            height,\n            pixels: vec![255; pixel_count], // Start with white background\n            clip_stack: Vec::new(),\n        })\n    }\n    \n    fn draw_rectangle(&mut self, surface: &mut PixelSurface, rect: Rectangle, color: Color) \n        -> Result<(), SoftwareError> {\n        \n        let clip_rect = surface.current_clip_bounds();\n        let clipped_rect = rect.intersect(clip_rect);\n        \n        if clipped_rect.size.width <= 0.0 || clipped_rect.size.height <= 0.0 {\n            return Ok(()); // Rectangle completely clipped\n        }\n        \n        let x1 = clipped_rect.origin.x.max(0.0) as u32;\n        let y1 = clipped_rect.origin.y.max(0.0) as u32;\n        let x2 = (clipped_rect.origin.x + clipped_rect.size.width).min(surface.width as f32) as u32;\n        let y2 = (clipped_rect.origin.y + clipped_rect.size.height).min(surface.height as f32) as u32;\n        \n        for y in y1..y2 {\n            for x in x1..x2 {\n                let pixel_index = ((y * surface.width + x) * 4) as usize;\n                if pixel_index + 3 < surface.pixels.len() {\n                    // Simple alpha blending\n                    let bg_color = Color::rgba(\n                        surface.pixels[pixel_index],\n                        surface.pixels[pixel_index + 1],\n                        surface.pixels[pixel_index + 2],\n                        surface.pixels[pixel_index + 3],\n                    );\n                    let blended = color.blend_over(bg_color);\n                    \n                    surface.pixels[pixel_index] = blended.r;\n                    surface.pixels[pixel_index + 1] = blended.g;\n                    surface.pixels[pixel_index + 2] = blended.b;\n                    surface.pixels[pixel_index + 3] = blended.a;\n                }\n            }\n        }\n        \n        Ok(())\n    }\n    \n    // Additional implementation methods...\n    fn measure_text(&self, text: &str, font: &FontInfo) -> TextMetrics {\n        TextMetrics {\n            advance_width: text.len() as f32 * self.char_width,\n            ascent: self.font_size * 0.8,\n            descent: self.font_size * 0.2,\n            line_height: self.line_height,\n        }\n    }\n    \n    fn present_surface(&mut self, surface: PixelSurface) -> Result<Vec<u8>, SoftwareError> {\n        Ok(surface.pixels)\n    }\n    \n    // TODO: Implement remaining GraphicsBackend methods\n    // draw_border, draw_text, set_clip_rect, clear_clip\n}\n\nimpl PixelSurface {\n    fn current_clip_bounds(&self) -> Rectangle {\n        self.clip_stack.last().copied().unwrap_or(Rectangle {\n            origin: Point { x: 0.0, y: 0.0 },\n            size: Size { width: self.width as f32, height: self.height as f32 },\n        })\n    }\n}\n```\n\n**Render Engine Main Interface (Core Logic Skeleton):**\n```rust\n// render/mod.rs - Main rendering engine interface\nuse crate::layout::{LayoutBox, Rectangle, Size};\nuse crate::render::paint::PaintCommandGenerator;\nuse crate::render::graphics::{GraphicsBackend, Color};\n\npub struct RenderEngine {\n    pub viewport_size: Rectangle,\n}\n\nimpl RenderEngine {\n    pub fn new(viewport_width: f32, viewport_height: f32) -> Self {\n        RenderEngine {\n            viewport_size: Rectangle {\n                origin: Point { x: 0.0, y: 0.0 },\n                size: Size { width: viewport_width, height: viewport_height },\n            },\n        }\n    }\n    \n    /// Complete rendering pipeline from layout tree to pixels\n    pub fn render_layout_tree<B: GraphicsBackend>(&mut self, layout_tree: &LayoutBox, \n                                                 backend: &mut B) -> Result<Vec<u8>, B::Error> {\n        // TODO 1: Generate display list from layout tree\n        // TODO 2: Apply rendering optimizations to display list\n        // TODO 3: Create graphics surface with viewport dimensions\n        // TODO 4: Execute paint commands on graphics backend\n        // TODO 5: Present final surface and return pixel data\n        // Hint: Use PaintCommandGenerator::generate_display_list\n        // Hint: Use optimize_display_list for performance\n        // Hint: Loop through display_list.commands and call backend methods\n    }\n    \n    /// Apply optimizations to reduce rendering work\n    fn optimize_display_list(&self, display_list: &mut DisplayList) {\n        // TODO 1: Remove commands that draw outside viewport bounds\n        // TODO 2: Eliminate commands with transparent colors\n        // TODO 3: Batch consecutive similar commands where possible\n        // TODO 4: Remove commands with zero-sized rectangles\n        // Hint: Use Rectangle::intersects for viewport culling\n        // Hint: Check Color::is_transparent() for empty commands\n    }\n    \n    /// Execute display list commands on graphics backend\n    fn execute_display_list<B: GraphicsBackend>(&self, display_list: &DisplayList, \n                                               backend: &mut B, surface: &mut B::Surface) \n                                               -> Result<(), B::Error> {\n        // TODO 1: Clear surface with background color\n        // TODO 2: Iterate through all paint commands\n        // TODO 3: Match on command type and call appropriate backend method\n        // TODO 4: Handle SetClip and ClearClip commands for clipping stack\n        // TODO 5: Call draw methods for DrawRectangle, DrawBorder, DrawText\n        // Hint: Use match expression on PaintCommand variants\n        // Hint: Pass command parameters directly to backend methods\n    }\n}\n```\n\n**Milestone Checkpoint:**\nAfter implementing the rendering engine, you should be able to:\n\n1. **Generate Paint Commands**: Run `cargo test paint_generation` to verify that layout boxes produce the correct sequence of drawing commands\n2. **Software Rendering**: Create a simple test that renders a layout tree to a pixel buffer and saves it as a PPM image file\n3. **Viewport Culling**: Test that elements outside the viewport don't generate paint commands in the optimized display list\n4. **Visual Verification**: Render a simple HTML page with colored backgrounds and borders, then visually inspect the output image\n\n**Expected Test Output:**\n```\nRunning paint generation tests...\n✓ Block element generates background rectangle\n✓ Text element generates text drawing command  \n✓ Bordered element generates border commands\n✓ Clipped content generates clip commands\n✓ Viewport culling removes off-screen elements\n\nRendering complete: output saved to test_render.ppm\nDisplay list: 15 commands generated, 12 after optimization\n```\n\n**Debugging Tips:**\n\n| Symptom | Likely Cause | How to Diagnose | Fix |\n|---------|--------------|------------------|-----|\n| All elements appear black | Missing color information in paint commands | Print paint command colors | Check computed style color resolution |\n| Text positioned incorrectly | Wrong baseline calculation | Compare font metrics with text position | Add font ascent to y-coordinate |\n| Elements clipped unexpectedly | Clipping bounds too restrictive | Log clip rectangle stack | Verify parent element overflow handling |\n| Performance very slow | No viewport culling optimization | Profile paint command count | Implement rectangle intersection culling |\n\n\n## Component Interactions and Data Flow\n\n> **Milestone(s):** All milestones (1-4) - This section documents the complete data flow through the rendering pipeline and the formal interfaces between HTML parsing, CSS parsing, layout computation, and rendering stages.\n\nBuilding a browser engine requires orchestrating four distinct processing stages that must work together seamlessly. Think of this as **the orchestra conductor's score** — each section (HTML parser, CSS parser, layout engine, rendering engine) has its own specialized role, but the magic happens when they play together in perfect harmony. The conductor (our `BrowserEngine`) ensures that the output from one section becomes the perfectly formatted input for the next, maintaining timing and synchronization throughout the entire performance.\n\nThe rendering pipeline transforms simple text strings into complex visual output through a series of well-defined data transformations. Each stage has strict input requirements and produces specific output formats that the next stage depends upon. Understanding these interfaces is crucial for debugging issues, optimizing performance, and extending functionality. When a web page renders incorrectly, the problem often lies not within a single component, but in the data transformation between components.\n\n![Browser Rendering Pipeline](./diagrams/rendering-pipeline-overview.svg)\n\nThe component interaction model follows a **unidirectional data flow pattern** where each stage completes its processing before passing results to the next stage. This design choice eliminates complex feedback loops and makes the system more predictable and debuggable. However, it also means that each stage must produce complete, self-contained output that includes all information the downstream stages will need.\n\n### End-to-End Pipeline Flow\n\nThe complete rendering pipeline transforms raw HTML and CSS text through four distinct processing stages, with each stage operating on the output of the previous stage. Think of this as **a document assembly line in a printing factory** — raw text enters at one end, passes through specialized machines that perform specific transformations, and emerges as a finished visual document ready for display.\n\nThe pipeline begins when the `BrowserEngine` receives HTML content and optional CSS stylesheets. The engine coordinates the entire process, managing viewport dimensions, error handling, and resource allocation across all stages. Each stage operates independently but relies on well-defined data contracts to ensure compatibility.\n\n#### Stage 1: HTML Text to DOM Tree\n\nThe first transformation converts raw HTML text into a structured `DOMNode` tree that represents the document's logical hierarchy. The `HTMLParser` operates through two distinct phases: tokenization and tree construction.\n\nDuring tokenization, the parser's state machine processes the HTML character stream and produces a sequence of `HTMLToken` objects. Each token represents a semantic unit like a start tag, end tag, text content, or comment. The tokenizer handles complex scenarios including quoted attributes, entity decoding, and malformed markup recovery.\n\n| Input | Processing | Output |\n|-------|------------|---------|\n| Raw HTML string | Character-by-character state machine tokenization | Stream of `HTMLToken` objects |\n| `HTMLToken` stream | Stack-based tree construction with error recovery | `DOMNode` tree with parent-child relationships |\n\nThe tree construction phase consumes the token stream and builds the hierarchical DOM structure. A `TreeBuilder` maintains a stack of open elements and processes each token according to HTML parsing rules. When it encounters a start tag token, it creates a new `DOMNode` with `ElementData` and pushes it onto the element stack. Text tokens become text nodes attached to the current element. End tag tokens pop elements from the stack, establishing the final parent-child relationships.\n\n**Error recovery** plays a critical role during tree construction. When the parser encounters malformed HTML like missing closing tags or improperly nested elements, it uses standardized recovery algorithms to produce a valid tree structure. For example, if it finds a `</div>` tag but the current element is a `<span>`, the parser automatically closes the span element before processing the div end tag.\n\n> **Critical Design Insight**: The DOM tree must be complete and internally consistent before any subsequent stage can begin processing. Partial or malformed trees will cause cascading failures in styling and layout calculations.\n\n#### Stage 2: DOM Tree + CSS Rules to Styled Tree\n\nThe second transformation applies CSS styling rules to the DOM tree, producing a styled tree where each element has computed style properties. This process involves three sub-stages: CSS parsing, selector matching, and cascade resolution.\n\nThe `CSSParser` first transforms CSS text into structured `CSSRule` objects. Each rule contains a `Selector` that specifies which elements it applies to, and a list of `Declaration` objects that specify property values. The parser handles complex scenarios including selector combinators, shorthand properties, and malformed CSS recovery.\n\n| CSS Input | Processing Phase | Intermediate Output | Final Output |\n|-----------|-----------------|-------------------|--------------|\n| CSS text string | Tokenization and rule parsing | `Vec<CSSRule>` in `Stylesheet` | `Stylesheet` with calculated specificity |\n| `Stylesheet` + `DOMNode` | Selector matching and specificity calculation | Matching rules per element | Element with applicable rules |\n| Applicable rules | Cascade algorithm and inheritance | Resolved property values | `ComputedStyle` for each element |\n\nSelector matching tests each CSS rule against each DOM element using the `matches_element` function. This process considers the element's tag name, class list, ID, and position within the DOM tree. Complex selectors like descendant combinators require traversing up the DOM tree to find matching ancestors.\n\nThe cascade resolution stage determines the final computed style for each element. The `StyleResolver` applies the cascade algorithm, which prioritizes rules based on specificity, source order, and importance. The `calculate_specificity` function computes the four-tuple (inline, ids, classes, elements) that determines rule precedence.\n\n**Inheritance** adds another layer of complexity. Properties like `color` and `font-family` automatically inherit from parent elements unless explicitly overridden. The style resolver must traverse the DOM tree in document order to ensure that inherited values are available when processing child elements.\n\n#### Stage 3: Styled Tree to Layout Tree\n\nThe third transformation calculates the size and position of every element, producing a `LayoutTree` where each node contains geometric information. This stage implements the CSS box model and formatting context algorithms.\n\nThe `LayoutEngine` traverses the styled DOM tree and creates corresponding `LayoutBox` nodes. Each layout box contains four nested rectangles representing the margin, border, padding, and content areas. The engine must resolve auto values, handle percentage units, and implement margin collapsing.\n\n| Styled Input | Layout Processing | Geometric Output |\n|-------------|------------------|-----------------|\n| `ComputedStyle` with CSS values | Box model calculation | Four nested rectangles per element |\n| Parent dimensions and constraints | Block formatting context | Child positions and sizes |\n| Available width and text content | Inline formatting with line breaking | `LineBox` objects with text positioning |\n\n**Block formatting context** handles elements with `display: block`. The layout engine processes block children in document order, calculating their width based on the containing block and stacking them vertically. Margin collapsing between adjacent block elements requires careful tracking of margin values.\n\n**Inline formatting context** handles text and inline elements. The layout engine flows content horizontally, creating `LineBox` objects when content exceeds the available width. Text measurement using `SimpleTextMeasurer` determines where line breaks should occur and calculates baseline alignment for mixed content.\n\nThe `calculate_box_model` method performs the core geometric calculations. It resolves percentage units relative to the containing block, handles auto margins by centering or expanding elements, and ensures that the total box dimensions fit within available space.\n\n#### Stage 4: Layout Tree to Visual Output\n\nThe final transformation converts the positioned layout tree into drawing commands that produce visual output. The `RenderEngine` generates a `DisplayList` containing `PaintCommand` objects that specify exactly what to draw and where.\n\nThe rendering engine traverses the layout tree in paint order, which considers z-index values and stacking contexts. For each layout box, it generates multiple paint commands: background rectangles, border segments, and text drawing operations.\n\n| Layout Input | Paint Processing | Visual Output |\n|-------------|-----------------|--------------|\n| `LayoutBox` with computed rectangles | Background and border paint commands | `DrawRectangle` and `DrawBorder` commands |\n| Text content with computed fonts | Text measurement and positioning | `DrawText` commands with precise coordinates |\n| `DisplayList` commands | Graphics backend execution | Pixel data in canvas buffer |\n\n**Paint command generation** follows a specific order to ensure correct visual layering. The engine first generates background commands, then border commands, and finally text commands. This ensures that text appears on top of backgrounds and borders.\n\n**Clipping** adds complexity to the rendering process. Elements with `overflow: hidden` create clipping contexts that restrict where child elements can draw. The renderer generates `SetClip` and `ClearClip` commands to manage these restricted drawing regions.\n\n> **Performance Consideration**: The display list acts as an optimization boundary. Once generated, it can be cached and reused if the layout doesn't change, avoiding expensive re-computation of paint commands.\n\n### Component Interface Contracts\n\nEach stage of the rendering pipeline has formal interface contracts that specify the exact data formats and constraints for inputs and outputs. These contracts ensure that components can evolve independently while maintaining compatibility.\n\nThink of these contracts as **diplomatic treaties between neighboring countries** — they establish clear boundaries, specify what can cross those boundaries, and define the protocols for handling disputes (error conditions). Just as countries can change their internal policies without affecting their neighbors (as long as they honor treaty obligations), our components can optimize their internal algorithms without breaking the pipeline.\n\n#### HTMLParser Interface Contract\n\nThe HTML parser provides the foundational interface that converts unstructured text into structured data. Its contract must handle the full complexity of real-world HTML while providing clean, consistent output.\n\n| Method Signature | Input Constraints | Output Guarantees | Error Conditions |\n|-----------------|-------------------|-------------------|------------------|\n| `parse_html(input: &str)` | Valid UTF-8 string, arbitrary length | Well-formed DOM tree with valid parent-child relationships | Returns `Vec<ParseError>` for recoverable issues |\n| `HTMLParser::new()` | None | Ready-to-use parser instance | Cannot fail |\n| `next_token(&mut self)` | Parser in valid state | Next `HTMLToken` or None at end | State machine handles all malformed input |\n\n**Input Processing Guarantees**: The HTML parser must handle any valid UTF-8 string, including empty strings, strings containing only whitespace, and strings with malformed HTML. It cannot assume well-formed input and must implement error recovery for common malformation patterns.\n\n**Output Structure Guarantees**: The parser guarantees that the returned `DOMNode` tree has these properties:\n- Every node except the root has exactly one parent\n- Parent nodes correctly reference all their children in document order  \n- Text nodes contain only text content with no child elements\n- Element nodes have valid tag names and attribute dictionaries\n- The tree structure respects HTML nesting rules (with error recovery where necessary)\n\n**Error Handling Contract**: The parser distinguishes between fatal errors (which prevent parsing) and recoverable errors (which allow parsing to continue with corrections). Fatal errors are extremely rare and typically indicate corrupted input encoding. Recoverable errors include missing closing tags, improper nesting, and invalid attributes. The parser collects all recoverable errors and returns them alongside the corrected DOM tree.\n\n| Error Type | Recovery Strategy | Tree Impact |\n|-----------|------------------|-------------|\n| Missing closing tag | Auto-close at document end or conflicting tag | Creates valid tree structure |\n| Improper nesting | Close conflicting elements early | Flattens to valid nesting |\n| Invalid attributes | Skip invalid attributes | Element created with valid attributes only |\n| Malformed entities | Use replacement character | Text content contains � for bad entities |\n\n#### StyleResolver Interface Contract\n\nThe style resolution system bridges CSS and DOM by computing the final visual properties for each element. Its contract must handle CSS complexity while providing consistent computed values.\n\n| Method Signature | Input Requirements | Output Guarantees | Performance Constraints |\n|-----------------|-------------------|-------------------|------------------------|\n| `parse_stylesheet(css: &str)` | Valid UTF-8 CSS text | `Stylesheet` with parsed rules and computed specificity | O(n) where n is CSS length |\n| `resolve_styles(root: &DOMNode)` | Complete DOM tree with valid structure | `ComputedStyle` for every element in tree | O(n*m) where n=elements, m=rules |\n| `matches_element(selector: &Selector, element: &DOMNode)` | Valid selector and element with complete ancestry | Boolean match result | O(d) where d is tree depth |\n\n**CSS Parsing Guarantees**: The CSS parser must produce a valid `Stylesheet` even from malformed CSS input. Invalid rules are skipped, but valid rules within the same stylesheet are preserved. The parser guarantees that:\n- Every `CSSRule` has a valid `Selector` and at least one `Declaration`\n- `Specificity` is correctly calculated according to CSS specification  \n- Rules maintain source order for cascade resolution\n- Shorthand properties are expanded into individual declarations\n\n**Style Resolution Guarantees**: The style resolver produces complete `ComputedStyle` objects for every element in the DOM tree. Each computed style contains:\n- Resolved values for all CSS properties (no 'inherit' or 'auto' keywords remain)\n- Correct inheritance from parent elements  \n- Applied cascade order based on specificity and source order\n- Default values for properties not explicitly set\n\n**Cascade Algorithm Contract**: The resolver implements the CSS cascade algorithm precisely:\n\n| Cascade Step | Processing Order | Conflict Resolution |\n|-------------|------------------|-------------------|\n| User agent defaults | Applied first | Lowest priority |\n| Author stylesheet rules | Applied by specificity | Higher specificity wins |\n| Same specificity rules | Applied by source order | Later rules win |\n| !important declarations | Applied after normal | Reverse specificity order |\n\n#### LayoutEngine Interface Contract\n\nThe layout engine transforms styled elements into geometric boxes with precise positions and dimensions. Its contract must handle the full complexity of CSS layout while maintaining pixel-perfect accuracy.\n\n| Method Signature | Input Requirements | Output Guarantees | Coordinate System |\n|-----------------|-------------------|-------------------|------------------|\n| `new(viewport_size: Rectangle)` | Valid positive viewport dimensions | Ready layout engine | Top-left origin coordinate system |\n| `calculate_box_model(&mut self, containing_block_size: Size)` | Complete computed styles | Four nested rectangles per element | Precise floating-point coordinates |\n| `layout_block_children(&mut self, available_width: f32)` | Block container with styled children | Children positioned vertically | Margin collapsing applied |\n\n**Box Model Calculation Guarantees**: The layout engine guarantees that every `LayoutBox` contains geometrically consistent rectangles:\n- Content rectangle is innermost\n- Padding rectangle surrounds content rectangle  \n- Border rectangle surrounds padding rectangle\n- Margin rectangle surrounds border rectangle\n- All rectangles use the same coordinate system and precise positioning\n\n**Formatting Context Contracts**: The layout engine implements both block and inline formatting contexts with specific behaviors:\n\n| Formatting Context | Child Positioning | Width Calculation | Height Calculation |\n|-------------------|-------------------|-------------------|-------------------|\n| Block | Vertical stacking with margin collapse | Fill available width or explicit width | Sum of content height |\n| Inline | Horizontal flow with line wrapping | Sum of child widths with line breaking | Line height based on font metrics |\n\n**Measurement and Positioning Precision**: All layout calculations use 32-bit floating-point precision to avoid rounding errors. The layout engine maintains sub-pixel accuracy throughout all calculations and only rounds to integer pixels during final rendering.\n\n#### RenderEngine Interface Contract\n\nThe rendering engine generates the final visual output by converting layout trees into drawing commands. Its contract must handle all visual CSS properties while maintaining efficient rendering performance.\n\n| Method Signature | Input Requirements | Output Guarantees | Rendering Order |\n|-----------------|-------------------|-------------------|-----------------|\n| `new(viewport_size: Rectangle)` | Valid viewport dimensions | Configured render engine | N/A |\n| `generate_display_list(layout_root: &LayoutBox)` | Complete layout tree | Ordered paint commands | Background → Border → Content |\n| `render_to_canvas(display_list: &DisplayList)` | Valid display list | Updated canvas buffer | Commands executed in order |\n\n**Paint Command Generation Guarantees**: The renderer produces a `DisplayList` with commands in correct paint order:\n- Background commands appear before content commands for the same element\n- Parent element backgrounds appear before child element backgrounds  \n- Text commands appear after all background and border commands\n- Clipping commands properly nest with matching `SetClip`/`ClearClip` pairs\n\n**Visual Property Support**: The renderer handles all visual CSS properties supported by our simplified browser:\n\n| CSS Property | Paint Command Type | Special Handling |\n|-------------|-------------------|-----------------|\n| `background-color` | `DrawRectangle` | Transparent colors skip command generation |\n| `border` | `DrawBorder` | Separate commands for each border side |\n| Text content | `DrawText` | Font fallback and baseline alignment |\n| `overflow: hidden` | `SetClip`/`ClearClip` | Nested clipping contexts |\n\n**Canvas Output Contract**: The rendering engine guarantees that the final canvas contains pixel-perfect representation of the layout tree:\n- Colors match CSS color specifications exactly\n- Text appears at computed baseline positions  \n- Elements respect stacking order and clipping boundaries\n- Transparent areas remain unmodified in the canvas buffer\n\n> **Integration Testing Insight**: The interface contracts enable comprehensive testing by allowing mock implementations of each stage. Testing can verify that a mock DOM tree produces expected layout boxes, or that specific layout boxes generate correct paint commands.\n\n### Data Transformation Validation\n\nEach pipeline stage includes built-in validation to ensure that data transformations maintain correctness and catch errors early. Think of this as **quality control checkpoints on the assembly line** — each station verifies that the previous station's work meets specifications before adding its own processing.\n\nThe validation system serves two critical purposes: debugging aid for developers implementing the browser engine, and runtime safety for handling malformed web content. Validation checks are designed to be comprehensive enough to catch implementation bugs while being efficient enough to run on every document.\n\n#### DOM Tree Validation\n\nAfter HTML parsing completes, the DOM tree undergoes structural validation to ensure it meets the requirements for style resolution:\n\n| Validation Check | Correctness Requirement | Failure Impact |\n|-----------------|-------------------------|----------------|\n| Parent-child consistency | Every child's parent points back to containing node | Style inheritance breaks |\n| Tree connectivity | Every node reachable from root via parent/child links | Parts of document disappear |\n| Node type validity | Element nodes have tag names, text nodes have content | Style matching fails |\n| Circular reference detection | No cycles in parent-child relationships | Infinite loops in tree traversal |\n\n#### Style Resolution Validation  \n\nThe styled tree validation ensures that computed styles are complete and consistent:\n\n| Validation Check | Style Requirement | Layout Impact |\n|-----------------|-------------------|---------------|\n| Complete property coverage | Every element has values for all layout-affecting properties | Layout calculations fail |\n| Resolved value validation | No 'inherit', 'auto', or other unresolved values remain | Box model computation breaks |\n| Inheritance consistency | Inherited properties match parent computed values | Visual inconsistencies |\n| Cascade order verification | Rules applied in correct specificity and source order | Wrong styles applied |\n\n#### Layout Tree Validation\n\nLayout validation ensures geometric consistency and prevents rendering errors:\n\n| Validation Check | Geometric Requirement | Rendering Impact |\n|-----------------|----------------------|------------------|\n| Rectangle nesting | Content ⊆ Padding ⊆ Border ⊆ Margin for every box | Visual overlaps and gaps |\n| Coordinate consistency | All coordinates within viewport bounds | Clipping and drawing errors |\n| Dimension positivity | All widths and heights are non-negative | Graphics API failures |\n| Parent-child containment | Child boxes positioned within parent content area | Layout overflow issues |\n\n### Implementation Guidance\n\nBuilding the component interaction system requires careful attention to data flow orchestration and error propagation. The implementation focuses on creating clean interfaces between pipeline stages while maintaining performance and debuggability.\n\n#### Technology Recommendations\n\n| Component | Simple Implementation | Production-Ready Option |\n|-----------|----------------------|------------------------|\n| Pipeline Orchestration | Direct function calls with error propagation | Async pipeline with cancellation support |\n| Data Validation | Assert macros in debug builds | Comprehensive validation with detailed error messages |\n| Performance Monitoring | Simple timing measurements | Structured profiling with stage-by-stage metrics |\n| Error Handling | Result types with error enums | Hierarchical error types with context preservation |\n\n#### Recommended File Structure\n\nThe component interaction system spans multiple modules but centralizes orchestration logic:\n\n```\nsrc/\n  engine/\n    browser_engine.rs     ← main pipeline orchestration\n    pipeline.rs           ← stage interface definitions  \n    validation.rs         ← cross-stage validation logic\n  html/\n    parser.rs            ← HTML parsing implementation\n    mod.rs               ← HTML parser public interface\n  css/\n    parser.rs            ← CSS parsing implementation\n    resolver.rs          ← Style resolution implementation  \n    mod.rs               ← CSS system public interface\n  layout/\n    engine.rs            ← Layout calculation implementation\n    mod.rs               ← Layout engine public interface\n  render/\n    engine.rs            ← Rendering implementation\n    display_list.rs      ← Paint command generation\n    mod.rs               ← Render engine public interface\n  types/\n    mod.rs               ← Shared type definitions\n```\n\n#### Pipeline Orchestration Infrastructure\n\nThe `BrowserEngine` coordinates the entire rendering pipeline with comprehensive error handling:\n\n```rust\n// Complete pipeline orchestration with validation and error handling\nuse crate::types::*;\nuse std::time::Instant;\n\npub struct BrowserEngine {\n    pub viewport_size: Rectangle,\n    html_parser: HTMLParser,\n    style_resolver: StyleResolver,\n    layout_engine: LayoutEngine,\n    render_engine: RenderEngine,\n    validation_enabled: bool,\n}\n\nimpl BrowserEngine {\n    pub fn new(viewport_width: f32, viewport_height: f32) -> BrowserEngine {\n        let viewport_size = Rectangle {\n            origin: Point { x: 0.0, y: 0.0 },\n            size: Size { width: viewport_width, height: viewport_height },\n        };\n        \n        BrowserEngine {\n            viewport_size,\n            html_parser: HTMLParser::new(),\n            style_resolver: StyleResolver::new(),\n            layout_engine: LayoutEngine::new(viewport_size),\n            render_engine: RenderEngine::new(viewport_size),\n            validation_enabled: cfg!(debug_assertions),\n        }\n    }\n\n    pub fn render_page(html: &str, css: &str) -> Result<Vec<u8>, String> {\n        // TODO 1: Parse HTML into DOM tree using HTMLParser::parse_html\n        // TODO 2: Validate DOM tree structure if validation_enabled\n        // TODO 3: Parse CSS into stylesheet using CSSParser::parse_stylesheet  \n        // TODO 4: Resolve styles for all DOM elements using StyleResolver\n        // TODO 5: Validate computed styles if validation_enabled\n        // TODO 6: Calculate layout using LayoutEngine with viewport constraints\n        // TODO 7: Validate layout tree geometry if validation_enabled  \n        // TODO 8: Generate display list using RenderEngine\n        // TODO 9: Execute paint commands to produce final canvas buffer\n        // TODO 10: Return canvas buffer as byte array for display\n        // Hint: Use timing measurements to identify performance bottlenecks\n        // Hint: Preserve intermediate results for debugging pipeline issues\n    }\n}\n```\n\n#### Stage Interface Definitions\n\nDefine clean interfaces that each pipeline stage must implement:\n\n```rust\n// Formal interfaces that define the contracts between pipeline stages\nuse crate::types::*;\n\npub trait HTMLParsingStage {\n    fn parse_html(&self, input: &str) -> Result<DOMNodeHandle, Vec<ParseError>>;\n    fn validate_dom_tree(&self, root: &DOMNode) -> Result<(), ValidationError>;\n}\n\npub trait StyleResolutionStage {\n    fn parse_stylesheet(&self, css: &str) -> Result<Stylesheet, String>;\n    fn resolve_styles(&self, root: &DOMNode, stylesheets: &[Stylesheet]) -> Result<StyledNode, String>;\n    fn validate_computed_styles(&self, styled_root: &StyledNode) -> Result<(), ValidationError>;\n}\n\npub trait LayoutCalculationStage {\n    fn calculate_layout(&mut self, styled_root: &StyledNode, viewport: Rectangle) -> Result<LayoutBox, String>;\n    fn validate_layout_tree(&self, layout_root: &LayoutBox) -> Result<(), ValidationError>;\n}\n\npub trait RenderingStage {\n    fn generate_display_list(&self, layout_root: &LayoutBox) -> Result<DisplayList, String>;\n    fn render_to_canvas(&self, display_list: &DisplayList) -> Result<Vec<u8>, String>;\n}\n```\n\n#### Cross-Stage Validation Logic\n\nImplement comprehensive validation that verifies data integrity between pipeline stages:\n\n```rust\n// Validation functions that verify data integrity between pipeline stages\nuse crate::types::*;\n\npub struct PipelineValidator {\n    strict_mode: bool,\n}\n\nimpl PipelineValidator {\n    pub fn new(strict_mode: bool) -> PipelineValidator {\n        PipelineValidator { strict_mode }\n    }\n\n    pub fn validate_dom_structure(&self, root: &DOMNode) -> Result<(), ValidationError> {\n        // TODO 1: Verify that every child node's parent pointer references the correct parent\n        // TODO 2: Check that the tree has no circular references by tracking visited nodes\n        // TODO 3: Validate that element nodes have non-empty tag names  \n        // TODO 4: Ensure text nodes contain valid UTF-8 content\n        // TODO 5: Verify that all nodes are reachable from root via parent-child traversal\n        // Hint: Use a HashSet to detect cycles during tree traversal\n        // Hint: Check that parent.children[i].parent == parent for all children\n    }\n\n    pub fn validate_style_resolution(&self, styled_root: &StyledNode) -> Result<(), ValidationError> {\n        // TODO 1: Verify every element has a complete ComputedStyle with all properties set\n        // TODO 2: Check that no computed values contain unresolved keywords like 'inherit'\n        // TODO 3: Validate that inherited properties match their parent's computed values\n        // TODO 4: Ensure all color values are valid and within RGB ranges\n        // TODO 5: Check that length values have been resolved to pixel units\n        // Hint: Traverse styled tree and compare inherited properties with parent values\n    }\n\n    pub fn validate_layout_geometry(&self, layout_root: &LayoutBox) -> Result<(), ValidationError> {\n        // TODO 1: Verify that content_rect ⊆ padding_rect ⊆ border_rect ⊆ margin_rect\n        // TODO 2: Check that all coordinates are finite floating-point numbers  \n        // TODO 3: Validate that child boxes are positioned within parent content area\n        // TODO 4: Ensure all width and height values are non-negative\n        // TODO 5: Verify that positioned elements respect viewport boundaries\n        // Hint: Use Rectangle::contains and Rectangle::intersects for geometric checks\n    }\n}\n```\n\n#### Error Propagation and Context Preservation\n\nImplement rich error types that preserve context across pipeline stages:\n\n```rust\n// Error types that preserve context and enable debugging across pipeline stages\nuse std::fmt;\n\n#[derive(Debug, Clone)]\npub enum PipelineError {\n    HTMLParsing { \n        stage: String,\n        errors: Vec<ParseError>,\n        input_context: String,\n    },\n    StyleResolution { \n        stage: String,\n        element_context: String,\n        css_context: String,\n        error: String,\n    },\n    LayoutCalculation { \n        stage: String,\n        element_context: String,\n        available_space: Rectangle,\n        error: String,\n    },\n    Rendering { \n        stage: String,\n        paint_context: String,\n        error: String,\n    },\n    Validation { \n        stage: String,\n        check_failed: String,\n        context: String,\n    },\n}\n\nimpl fmt::Display for PipelineError {\n    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n        match self {\n            PipelineError::HTMLParsing { stage, errors, input_context } => {\n                write!(f, \"HTML parsing failed in {}: {} errors near '{}'\", \n                       stage, errors.len(), input_context)\n            }\n            // TODO: Implement Display for other error variants with rich context\n        }\n    }\n}\n```\n\n#### Milestone Checkpoints\n\nAfter implementing the component interaction system, verify these behaviors:\n\n**Pipeline Integration Test**: Create a simple HTML document with CSS and verify it processes through all stages:\n```html\n<!DOCTYPE html>\n<html>\n<head><style>body { color: red; }</style></head>\n<body><p>Hello World</p></body>\n</html>\n```\n\nExpected behavior:\n- HTML parsing produces DOM tree with html → head/body → style/p structure\n- CSS parsing extracts rule for body element with color: red  \n- Style resolution applies red color to body and inherits to p element\n- Layout calculation produces positioned boxes for all elements\n- Rendering generates DrawText command with red color for \"Hello World\"\n\n**Error Recovery Test**: Process malformed input to verify graceful degradation:\n```html\n<div><p>Unclosed paragraph<span>Nested content</div>\n```\n\nExpected behavior:\n- HTML parser auto-closes p element before processing div end tag\n- DOM tree shows correct nesting: div → p → span with \"Nested content\"  \n- Style resolution processes all elements despite malformed source\n- Layout and rendering complete successfully with corrected structure\n\n**Performance Validation**: Measure processing time for each pipeline stage:\n- HTML parsing should complete in O(n) time where n is input length\n- CSS parsing should scale linearly with stylesheet size\n- Style resolution should be O(elements × rules) for small documents  \n- Layout calculation time should be proportional to element count\n- Display list generation should complete in O(elements) time\n\n### Debugging Component Interactions\n\nThe component interaction system requires systematic debugging approaches that can isolate issues to specific pipeline stages and data transformations.\n\n#### Pipeline Stage Isolation\n\n| Symptom | Likely Stage | Diagnostic Approach | Fix Strategy |\n|---------|-------------|-------------------|-------------|\n| Empty or malformed DOM tree | HTML parsing | Log token stream and tree construction steps | Fix tokenizer state machine or tree builder |\n| Missing or incorrect styles | Style resolution | Check rule matching and cascade order | Debug selector matching or specificity calculation |\n| Elements positioned incorrectly | Layout calculation | Visualize box model rectangles | Fix box model math or formatting context logic |\n| Visual rendering issues | Paint generation | Inspect display list commands | Fix paint order or graphics backend calls |\n\n#### Data Flow Visualization\n\nImplement debug output that shows data transformations between stages:\n\n```rust\n// Debug utilities for visualizing data flow between pipeline stages\nimpl BrowserEngine {\n    pub fn render_with_debug(&mut self, html: &str, css: &str) -> Result<DebugInfo, String> {\n        // TODO 1: Enable comprehensive logging for each pipeline stage\n        // TODO 2: Capture intermediate data structures after each transformation\n        // TODO 3: Generate visual representations of DOM tree, layout boxes, paint commands\n        // TODO 4: Measure timing and memory usage for each stage\n        // TODO 5: Create diff comparison between expected and actual outputs\n        // Hint: Use serde to serialize intermediate structures for inspection\n        // Hint: Generate DOT graph format for tree structure visualization\n    }\n}\n```\n\n#### Common Integration Issues\n\n⚠️ **Pitfall: Incomplete Style Resolution**\nWhen elements appear unstyled, the issue often lies in selector matching logic. The style resolver might be failing to match CSS selectors to DOM elements due to incorrect tag name comparison, missing class attributes, or broken combinators.\n\n**Diagnosis**: Log the selector matching process for each element and rule combination. Check that `matches_element` correctly handles all selector types and that specificity calculation produces expected values.\n\n**Fix**: Implement comprehensive unit tests for selector matching with edge cases like case-insensitive tag names, multiple classes, and complex combinators.\n\n⚠️ **Pitfall: Layout Coordinate System Confusion**\nWhen elements appear in wrong positions, coordinate system mismatches between layout calculation and rendering often cause issues. The layout engine might compute positions relative to one origin point while the renderer expects a different coordinate system.\n\n**Diagnosis**: Add debug output that logs the computed rectangles for each layout box and compare them with the expected paint command coordinates.\n\n**Fix**: Establish a single coordinate system (top-left origin) used consistently across layout and rendering stages. Document coordinate system assumptions in interface contracts.\n\n⚠️ **Pitfall: Paint Command Ordering Issues** \nWhen elements appear layered incorrectly, paint command generation might be producing commands in the wrong order. Background elements appearing on top of foreground elements indicates incorrect z-ordering.\n\n**Diagnosis**: Log the complete display list with element context for each paint command. Verify that background commands appear before text commands for the same element.\n\n**Fix**: Implement systematic paint order traversal that processes elements in correct depth-first order with proper background-to-foreground layering within each element.\n\n\n## Error Handling and Edge Cases\n\n> **Milestone(s):** All milestones (1-4) - This section establishes comprehensive error recovery strategies that are essential throughout the entire rendering pipeline, from HTML parsing through final canvas output.\n\nWeb browsers must gracefully handle an enormous variety of malformed, incomplete, or invalid input. Think of error handling in a browser engine like **emergency protocols in air traffic control** - when something goes wrong, the system must continue functioning safely rather than crashing completely. A single malformed HTML tag or missing font file should never bring down the entire browser. The web's robustness principle \"be conservative in what you send, be liberal in what you accept\" means our browser engine must implement sophisticated error recovery at every stage of the rendering pipeline.\n\nThis section covers three critical areas of error handling: parse error recovery for malformed HTML and CSS, layout edge cases involving complex box model calculations, and rendering failure modes when the graphics backend encounters problems. Each area requires different recovery strategies, from the HTML parser's foster parenting algorithm to the renderer's graceful degradation when fonts fail to load.\n\n![Error Recovery Flowchart](./diagrams/error-handling-flow.svg)\n\nThe fundamental principle underlying all error handling in our browser engine is **graceful degradation** - when an error occurs, we preserve as much functionality as possible while providing sensible fallback behavior. This means continuing to render whatever content we can process correctly, even when parts of the input are malformed or unsupported.\n\n### Parse Error Recovery\n\nHTML and CSS parsing errors are incredibly common in real-world web content. Studies show that over 90% of web pages contain some form of HTML validation error, yet browsers must render them correctly. Our error recovery system treats parsing not as a strict validation process, but as a **best-effort reconstruction** of the author's intent from potentially malformed markup.\n\n> **Decision: Continuation-Based Error Recovery**\n> - **Context**: Real web content frequently contains malformed HTML and CSS that would cause strict parsers to fail completely.\n> - **Options Considered**: \n>   1. Strict validation with parsing failure on first error\n>   2. Error collection with warnings but continued parsing\n>   3. Aggressive error recovery with automatic correction\n> - **Decision**: Implement continuation-based error recovery that attempts to fix common mistakes automatically while collecting error information.\n> - **Rationale**: Web browsers must handle the existing web ecosystem, which contains billions of pages with validation errors. Failing to parse would make our browser unusable on real content.\n> - **Consequences**: More complex parser implementation but dramatically improved compatibility with real web content.\n\n| Recovery Strategy | When Applied | Action Taken | Example |\n|-------------------|--------------|--------------|---------|\n| Foster Parenting | Elements appear in wrong context | Move to appropriate parent | `<table><div>` moves `div` outside table |\n| Implicit Tag Insertion | Missing required elements | Insert omitted tags | Missing `<tbody>` in table |\n| Tag Auto-Closing | Unclosed elements at end | Close all open elements | Missing `</div>` at document end |\n| Attribute Recovery | Malformed attributes | Use fallback values | `width=\"invalid\"` becomes default width |\n| Entity Fallback | Unknown character entities | Display raw text | `&unknownentity;` shows literally |\n| Encoding Recovery | Invalid UTF-8 sequences | Replace with replacement char | Invalid bytes become � |\n\n#### HTML Parse Error Recovery\n\nThe HTML tokenizer and tree builder implement a **state machine with error transitions** that allow parsing to continue even when encountering malformed markup. When the tokenizer encounters unexpected characters, it doesn't abort but instead transitions to an error recovery state that attempts to interpret the author's intent.\n\n**Malformed Tag Recovery Process:**\n\n1. The tokenizer encounters an invalid character sequence in a tag context (e.g., `<div class=\"unclosed` at end of file)\n2. It checks if the current token can be salvaged by applying common corrections (missing quote, missing closing bracket)\n3. If the token is recoverable, it applies the fix and emits a corrected token along with a `ParseError::MalformedTag` warning\n4. If the token is unrecoverable, it treats the `<` as literal text and continues parsing from the next character\n5. The tree builder receives the corrected token or literal text and continues normal processing\n\n**Foster Parenting Algorithm:**\n\nFoster parenting handles the common case where content appears in an inappropriate parent context. The algorithm maintains a **stack of open elements** and checks whether each new element is valid in its current context.\n\n1. When processing a start tag token, check if the element is allowed in the current context using HTML content model rules\n2. If the element is forbidden (e.g., block content inside inline element), search up the open element stack for an appropriate parent\n3. If an appropriate parent is found, close intervening elements and insert the new element at the correct location\n4. If no appropriate parent exists, create an anonymous block container to hold the misplaced content\n5. Update the DOM tree structure to reflect the corrected nesting while preserving document order\n\n**Common HTML Error Patterns:**\n\n| Error Pattern | Detection | Recovery Action | Example |\n|---------------|-----------|-----------------|---------|\n| Unclosed Tags | End of input with open elements | Auto-close in reverse order | `<div><p>text` becomes `<div><p>text</p></div>` |\n| Mis-nested Tags | End tag doesn't match current element | Close to matching start tag | `<b><i></b></i>` becomes `<b><i></i></b>` |\n| Invalid Nesting | Block element inside inline | Foster parent to valid container | `<span><div>` moves `div` outside `span` |\n| Missing Required Elements | Table content outside `tbody` | Insert implicit wrapper | Table rows get wrapped in `tbody` |\n| Duplicate Attributes | Same attribute appears twice | Use first occurrence | `<div id=\"a\" id=\"b\">` keeps `id=\"a\"` |\n| Void Element Content | Content inside self-closing element | Treat content as sibling | `<br>text` becomes `<br>` followed by text |\n\n#### CSS Parse Error Recovery\n\nCSS parsing uses a different error recovery strategy based on **error recovery tokens** and **declaration skipping**. When the CSS parser encounters invalid syntax, it attempts to skip to the next valid parsing context rather than trying to fix the invalid content.\n\n**CSS Error Recovery Process:**\n\n1. The CSS tokenizer encounters an invalid character sequence (e.g., unmatched brackets, invalid escape sequences)\n2. It enters error recovery mode and consumes tokens until it finds a recovery point (semicolon, closing brace, or EOF)\n3. The parser discards the invalid rule or declaration and continues parsing from the recovery point\n4. For property values, invalid values are ignored and the property uses its inherited or initial value\n5. For selectors, invalid selector syntax causes the entire rule to be discarded\n\n**CSS Recovery Points:**\n\n| Context | Recovery Token | Action | Example |\n|---------|----------------|---------|----------|\n| Rule Level | `}` or EOF | Discard rule, continue | Invalid selector discards entire rule |\n| Declaration Level | `;` or `}` | Discard declaration | `color: #invalid;` ignored, next property processed |\n| Function Level | `)` | Discard function call | `rgb(invalid)` becomes initial value |\n| String Level | `\"` or `'` | Close string, continue | Unclosed string closed at line end |\n| Comment Level | `*/` | End comment, continue | Unclosed comment closed at EOF |\n| Import Level | `;` or newline | End import statement | Malformed `@import` skipped |\n\n**Property Value Error Handling:**\n\nWhen CSS property values are invalid, our parser implements a **fallback hierarchy** that attempts to provide reasonable default behavior:\n\n1. **Syntax Validation**: Check if the value matches the property's expected syntax pattern\n2. **Range Validation**: Verify numeric values fall within valid ranges (e.g., opacity 0-1)\n3. **Unit Validation**: Ensure units are appropriate for the property context\n4. **Fallback Selection**: Choose appropriate fallback from inheritance, initial value, or browser default\n5. **Error Logging**: Record the invalid value and chosen fallback for debugging\n\n```\nInvalid CSS: color: #gggggg; (invalid hex)\nRecovery: Use inherited color or initial value (black)\nError logged: \"Invalid color value '#gggggg' in declaration, using inherited\"\n\nInvalid CSS: width: -50px; (negative length not allowed)\nRecovery: Treat as 'auto' width\nError logged: \"Negative length '-50px' invalid for width, using auto\"\n```\n\n⚠️ **Pitfall: Cascading Parse Errors**\nA common mistake is allowing parse errors to cascade and corrupt subsequent parsing. For example, if an unclosed string in CSS contains what looks like property syntax, the parser might try to interpret the string contents as CSS rules. Always ensure error recovery completely consumes the invalid content before resuming normal parsing.\n\n### Layout Edge Cases\n\nLayout calculations involve complex interactions between the CSS box model, formatting contexts, and constraint solving. Many edge cases arise from the **cascading dependencies** between parent and child dimensions, percentage calculations, and the intricate rules governing margin collapsing and auto value resolution.\n\nThink of layout edge cases like **puzzle pieces that don't quite fit** - the CSS specification defines the ideal relationships between elements, but real content often pushes these relationships to their limits. Our layout engine must handle circular dependencies, conflicting constraints, and mathematical edge cases while maintaining visual coherence.\n\n> **Decision: Constraint Satisfaction with Fallback Ordering**\n> - **Context**: Layout calculations often involve conflicting constraints (e.g., explicit width vs. content requirements, percentage dimensions with unknown parent size).\n> - **Options Considered**:\n>   1. Strict specification compliance, failing on impossible constraints\n>   2. Heuristic-based resolution with \"reasonable\" defaults\n>   3. Layered constraint satisfaction with priority ordering\n> - **Decision**: Implement layered constraint satisfaction where constraints are resolved in specification-defined priority order, with well-defined fallbacks for impossible situations.\n> - **Rationale**: The CSS specification defines resolution order for most conflicts, and web compatibility requires handling edge cases consistently across browsers.\n> - **Consequences**: More complex layout algorithm but predictable behavior matching real browser implementations.\n\n#### Percentage and Auto Value Resolution\n\nPercentage values in CSS create **dependency cycles** when parent and child dimensions depend on each other. The layout engine must break these cycles using the CSS specification's resolution order while handling degenerate cases gracefully.\n\n**Percentage Resolution Algorithm:**\n\n1. **Initial Pass**: Identify elements with percentage dimensions and their dependency relationships\n2. **Cycle Detection**: Use depth-first traversal to detect circular dependencies in the dimension calculation graph\n3. **Constraint Ordering**: Sort constraints by CSS-defined priority (width before height, explicit before auto, etc.)\n4. **Iterative Resolution**: Resolve constraints in priority order, using tentative values for unresolved dependencies\n5. **Convergence Check**: Verify that dimension calculations converge to stable values within tolerance\n6. **Fallback Application**: Apply fallback rules for non-converging or impossible constraint sets\n\n| Edge Case | Scenario | Resolution Strategy | Example |\n|-----------|----------|-------------------|---------|\n| Circular Percentage | Child width depends on parent, parent width depends on child | Use intrinsic child width for parent | `<div style=\"width:auto\"><img style=\"width:50%\">` |\n| Zero-Sized Container | Percentage child of zero-width parent | Treat percentage as zero | `width: 50%` of 0px parent becomes 0px |\n| Infinite Recursion | Nested elements with interdependent auto sizing | Limit recursion depth, use content-based sizing | Deep nesting with shrink-wrap behavior |\n| Negative Percentages | Percentage values that compute to negative lengths | Clamp to zero (negative sizes forbidden) | `width: 50%` of -100px parent becomes 0px |\n| Mixed Units | Calculations involving percentages and absolute units | Convert to common unit system at resolution time | `width: calc(50% + 10px)` calculations |\n\n**Auto Value Resolution Priority:**\n\nThe CSS specification defines a complex hierarchy for resolving `auto` values when multiple dimensions are automatic. Our implementation follows this priority ordering:\n\n1. **Available Space**: Use available space from containing block when possible\n2. **Content Requirements**: Fall back to content-driven sizing (shrink-to-fit)\n3. **Intrinsic Ratios**: Apply aspect ratios for elements with natural dimensions\n4. **Specification Defaults**: Use CSS-defined initial values as last resort\n5. **Browser Minimums**: Apply minimum readable sizes for text content\n\n#### Margin Collapsing Edge Cases\n\nMargin collapsing follows complex rules that interact with positioning, floating, and formatting contexts. The algorithm must handle **nested collapsing**, **negative margins**, and **self-collapsing elements** while maintaining correct visual spacing.\n\n**Complex Margin Collapse Scenarios:**\n\n| Scenario | Description | Calculation | Result |\n|----------|-------------|-------------|---------|\n| Adjacent Positive | Two positive margins touch | `max(margin1, margin2)` | Larger margin wins |\n| Adjacent Negative | Two negative margins touch | `min(margin1, margin2)` | More negative margin wins |\n| Mixed Sign | Positive and negative margins | `margin1 + margin2` | Arithmetic sum |\n| Nested Collapse | Parent and child margins collapse through | Collapse all participating margins | Multiple margins become one |\n| Self-Collapse | Element with no content, height, padding, or border | Top and bottom margins collapse together | Element takes no space |\n| Clearance | Margin collapsing prevented by clearance | No collapsing occurs | Margins remain separate |\n\n**Margin Collapse Algorithm Implementation:**\n\n1. **Adjacency Detection**: Identify which margins are adjacent according to CSS rules (no padding, border, or content between)\n2. **Collapse Group Formation**: Group all margins that collapse together, handling nested scenarios\n3. **Collapse Calculation**: Compute the final collapsed margin using max for positive, min for negative, sum for mixed\n4. **Position Adjustment**: Update element positions based on the collapsed margin values\n5. **Clearance Handling**: Prevent collapsing when clearance is present due to floating elements\n\n#### Box Model Constraint Conflicts\n\nWhen explicit width, padding, border, and margin values conflict with available space, the layout engine must resolve the **over-constrained** situation according to CSS rules.\n\n**Over-Constraint Resolution Order:**\n\n1. **Check Container Capacity**: Determine if total required space exceeds available space\n2. **Apply Reduction Priority**: Reduce dimensions in CSS-specified order (margin auto, then explicit margins, then width)\n3. **Honor Minimums**: Respect minimum content requirements and CSS `min-width`/`min-height` properties\n4. **Overflow Handling**: Allow content to overflow if reduction would make content unreadable\n5. **Document Flow Impact**: Ensure constraint resolution doesn't break containing block relationships\n\n```\nExample Over-Constraint:\nAvailable width: 300px\nElement: width: 200px, margin-left: 100px, margin-right: 100px, padding: 20px, border: 10px\nTotal required: 200 + 100 + 100 + 40 + 20 = 460px\n\nResolution:\n1. Convert auto margins to zero: no auto margins present\n2. Reduce right margin: 460 - 300 = 160px over, reduce margin-right by 160px\n3. Final: width: 200px, margin-left: 100px, margin-right: -60px, padding: 20px, border: 10px\n4. Element extends outside container by the negative margin\n```\n\n⚠️ **Pitfall: Floating Point Precision**\nLayout calculations involve extensive floating-point arithmetic that can accumulate precision errors. A common mistake is using exact equality comparisons for layout values. Instead, use epsilon-based comparisons and consider values within 0.001px as equal. This prevents infinite iteration in constraint resolution loops.\n\n### Rendering Failure Modes\n\nThe rendering stage sits at the intersection of our layout calculations and the underlying graphics system. Failures can occur due to **graphics backend limitations**, **resource exhaustion**, **font loading problems**, or **coordinate system overflow**. Unlike parsing and layout errors, rendering failures often require real-time decisions about visual degradation.\n\nThink of rendering failure handling like **emergency broadcasting** - when the ideal signal fails, we switch to backup systems that deliver reduced quality but maintain communication. A missing font shouldn't prevent text from appearing, and a graphics driver crash shouldn't make the entire page invisible.\n\n> **Decision: Layered Rendering with Graceful Degradation**\n> - **Context**: Graphics backends can fail due to driver issues, memory exhaustion, or unsupported operations, and rendering failures should not crash the entire browser.\n> - **Options Considered**:\n>   1. Fail-fast approach where any rendering error aborts the entire page\n>   2. Best-effort rendering with silent fallbacks to simplified graphics\n>   3. Layered fallback system with user notification of degraded rendering\n> - **Decision**: Implement layered fallback system that attempts progressively simpler rendering approaches while logging degradation events.\n> - **Rationale**: Users expect pages to remain visible even when graphics drivers have problems, and silent degradation could hide serious system issues.\n> - **Consequences**: More complex rendering pipeline but much better user experience during system problems.\n\n#### Graphics Backend Error Handling\n\nGraphics backends can fail for numerous reasons: driver crashes, out-of-memory conditions, invalid rendering state, or unsupported operations. Our rendering engine implements a **fallback cascade** that attempts progressively simpler rendering techniques when advanced features fail.\n\n**Graphics Backend Failure Types:**\n\n| Failure Type | Typical Causes | Detection Method | Recovery Strategy |\n|--------------|----------------|------------------|-------------------|\n| Context Loss | Driver crash, system hibernation | Rendering calls return error codes | Recreate graphics context, re-upload resources |\n| Memory Exhaustion | Large textures, too many buffers | Allocation failures | Switch to immediate mode rendering |\n| Unsupported Operations | Missing GPU features, old drivers | Feature detection, operation errors | Fall back to software rendering |\n| Coordinate Overflow | Elements positioned beyond coordinate limits | Clipping calculations | Clamp coordinates to valid ranges |\n| State Corruption | Invalid rendering state combinations | Inconsistent rendering output | Reset to known good state |\n| Resource Limit | Too many fonts, textures, or buffers loaded | Resource creation failures | Implement resource LRU cache with eviction |\n\n**Rendering Fallback Cascade:**\n\n1. **Hardware-Accelerated Path**: Use GPU-accelerated rendering with full feature set (gradients, transforms, anti-aliasing)\n2. **Software Rendering Path**: Fall back to CPU-based rendering with reduced features but full correctness\n3. **Simple Drawing Path**: Use basic rectangle and text drawing without advanced features\n4. **Text-Only Mode**: Render only text content with default fonts and colors\n5. **Error Display**: Show error message indicating rendering system failure\n\n#### Font Loading and Text Rendering Failures\n\nFont failures are among the most common rendering issues because fonts are external resources that may be missing, corrupted, or incompatible. The text rendering system must provide **progressive fallback** through font family lists while maintaining readable output.\n\n**Font Fallback Algorithm:**\n\n1. **Primary Font Loading**: Attempt to load the first font in the CSS `font-family` list\n2. **Format Validation**: Verify the font file format is supported and the font data is not corrupted\n3. **Character Coverage Check**: Ensure the font contains glyphs for the required characters\n4. **Fallback Font Selection**: If primary font fails, try each subsequent font in the family list\n5. **System Font Fallback**: Use operating system default fonts if all CSS fonts fail\n6. **Generic Fallback**: Fall back to built-in bitmap fonts as last resort\n7. **Missing Glyph Handling**: Display replacement characters (□) for unavailable glyphs\n\n| Font Failure Mode | Detection | Fallback Action | User Impact |\n|-------------------|-----------|-----------------|-------------|\n| File Not Found | Font loading returns 404 or file error | Try next font in family | Slight appearance change |\n| Corrupted Font Data | Font parsing fails with invalid data | Skip to system fonts | Noticeable font change |\n| Missing Characters | Font lacks glyphs for text content | Use fallback font for missing chars | Mixed fonts in text |\n| Font Size Unsupported | Requested size outside font limits | Clamp to supported range | Text size different than specified |\n| Rendering Failure | Glyph rasterization fails | Use simpler text rendering | Possible visual artifacts |\n| Memory Exhaustion | Font cache full | Evict least-recently-used fonts | Temporary font reloading |\n\n**Text Metrics Calculation Failures:**\n\nWhen text measurement fails (due to font issues or graphics backend problems), the layout system needs **estimated metrics** to maintain document flow:\n\n```\nFallback Text Metrics Calculation:\n1. Character Count: count characters in text string\n2. Average Width: use 0.6 * font_size as typical character width\n3. Line Height: use 1.2 * font_size as standard line spacing\n4. Ascent/Descent: use 0.8 * font_size ascent, 0.2 * font_size descent\n5. Word Breaking: assume breaking opportunities at whitespace\n\nExample for \"Hello World\" in 16px font:\n- Estimated width: 11 characters * 0.6 * 16px = 105.6px\n- Line height: 1.2 * 16px = 19.2px\n- Ascent: 0.8 * 16px = 12.8px from baseline\n```\n\n#### Memory Management and Resource Limits\n\nThe rendering engine must handle **memory pressure** and **resource exhaustion** gracefully, especially when rendering large documents or complex graphics. Our system implements **adaptive quality reduction** and **resource recycling** to maintain functionality under constraints.\n\n**Resource Management Strategies:**\n\n| Resource Type | Tracking Method | Limit Detection | Mitigation Strategy |\n|---------------|----------------|------------------|-------------------|\n| Graphics Textures | Allocated memory counter | Total exceeds GPU memory limit | LRU eviction of cached textures |\n| Font Cache | Loaded font count and size | Cache size exceeds limit | Evict fonts not used recently |\n| Paint Command Buffers | Buffer memory usage | Allocation failures | Switch to immediate rendering |\n| Clipping Regions | Active clip stack depth | Stack overflow | Flatten nested clips |\n| Graphics Context Objects | Handle count tracking | System handle exhaustion | Pool and reuse context objects |\n| Image Decode Buffers | Decoded image memory | Memory allocation fails | Decode images on-demand only |\n\n**Adaptive Quality Reduction:**\n\nWhen resource pressure is detected, the rendering engine can reduce quality to maintain functionality:\n\n1. **Disable Anti-Aliasing**: Turn off text and shape anti-aliasing to reduce memory usage\n2. **Reduce Color Depth**: Switch from 32-bit to 16-bit color rendering\n3. **Simplify Gradients**: Replace complex gradients with solid colors\n4. **Skip Decorative Elements**: Don't render shadows, decorative borders, or background images\n5. **Reduce Text Quality**: Use bitmap fonts instead of vector fonts for small text\n6. **Increase Clipping Aggressiveness**: Clip elements earlier to reduce off-screen rendering\n\n⚠️ **Pitfall: Resource Leak Cascades**\nA common mistake is not properly cleaning up graphics resources when errors occur, leading to resource leaks that compound over time. Always use RAII patterns (destructors, `defer` statements, or `finally` blocks) to ensure resources are freed even when rendering operations fail. This is especially critical for GPU resources which have strict system limits.\n\n#### Coordinate System and Overflow Handling\n\nModern web pages can have elements positioned far outside the visible viewport, potentially exceeding the coordinate system limits of graphics backends. The rendering engine must **clip and transform** coordinates to prevent overflow while maintaining visual correctness for visible content.\n\n**Coordinate Overflow Scenarios:**\n\n| Overflow Type | Typical Values | Graphics Limit | Handling Strategy |\n|---------------|----------------|----------------|-------------------|\n| Large Positive Coordinates | Elements positioned > 1M pixels right | 32-bit float precision limit | Clamp to maximum representable value |\n| Large Negative Coordinates | Elements positioned < -1M pixels left | Graphics backend coordinate limits | Clamp to minimum representable value |\n| Extreme Scaling | CSS transforms with scale > 1000x | Matrix calculation overflow | Clamp scale factors to reasonable range |\n| Deep Z-Ordering | Elements with z-index > 100,000 | Depth buffer precision | Compress z-order to available range |\n| Viewport Translation | Document scrolled to extreme positions | Coordinate arithmetic overflow | Use relative coordinate systems |\n\n**Coordinate Clamping Algorithm:**\n\n1. **Range Detection**: Check if element coordinates exceed graphics system limits\n2. **Visibility Culling**: Skip rendering for elements completely outside the viewport\n3. **Coordinate Transformation**: Transform coordinates to fit within graphics backend limits\n4. **Precision Preservation**: Maintain relative positioning accuracy for visible elements\n5. **Overflow Indication**: Mark elements as clipped when coordinate clamping occurs\n\nThe rendering system maintains separate **logical coordinates** (unlimited precision) and **graphics coordinates** (backend-limited) to ensure layout calculations remain accurate even when rendering coordinates are clamped.\n\n### Error Recovery Integration Across Pipeline Stages\n\nError handling in a browser engine requires coordination across all pipeline stages because errors in one stage can cascade to affect subsequent stages. Our system implements **error boundary isolation** and **graceful degradation propagation** to contain failures while maintaining overall functionality.\n\n**Cross-Stage Error Propagation:**\n\n| Error Origin | Immediate Effect | Downstream Impact | Recovery Coordination |\n|--------------|------------------|-------------------|----------------------|\n| HTML Parse Error | Malformed DOM tree | Layout calculations on incorrect structure | Layout uses error-corrected DOM |\n| CSS Parse Error | Missing or invalid styles | Layout uses default styles | Rendering gets computed defaults |\n| Layout Calculation Error | Incorrect element positioning | Rendering draws at wrong locations | Renderer clamps to valid coordinates |\n| Font Loading Failure | Text metrics unavailable | Layout estimates text dimensions | Renderer uses fallback fonts |\n| Graphics Backend Failure | Rendering operations fail | User sees incomplete visuals | Switch to software rendering |\n\n**Error State Propagation Protocol:**\n\n1. **Error Detection**: Each pipeline stage detects errors using stage-specific validation\n2. **Error Classification**: Classify errors as recoverable, degraded-functionality, or fatal\n3. **Recovery Action**: Apply appropriate recovery strategy and continue processing\n4. **Error Context Passing**: Pass error context and applied corrections to next pipeline stage\n5. **Quality Metadata**: Include quality/confidence indicators with processed data\n6. **Fallback Coordination**: Coordinate fallback strategies across stages for consistent behavior\n\nThis comprehensive error handling approach ensures that our browser engine can handle the messy reality of web content while providing useful feedback for debugging and maintaining compatibility with existing web pages.\n\n### Implementation Guidance\n\nThe error handling system requires careful coordination between robust error detection, intelligent recovery strategies, and graceful degradation paths. This implementation provides the infrastructure for handling errors throughout the rendering pipeline.\n\n#### Technology Recommendations\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| Error Types | Enum with error variants | Structured error types with context |\n| Error Recovery | Simple fallback values | State machine-based recovery |\n| Logging | Print statements for debugging | Structured logging with levels |\n| Resource Management | Manual cleanup | RAII with automatic cleanup |\n| Graphics Fallback | Single software fallback | Multi-tier fallback cascade |\n\n#### Recommended File Structure\n\n```\nsrc/\n├── main.rs\n├── lib.rs\n├── error/\n│   ├── mod.rs                    ← Error type definitions and utilities\n│   ├── parse_error.rs            ← HTML/CSS parsing error types\n│   ├── layout_error.rs           ← Layout calculation error types\n│   └── render_error.rs           ← Rendering failure types\n├── html/\n│   ├── parser.rs\n│   └── error_recovery.rs         ← HTML parse error recovery\n├── css/\n│   ├── parser.rs\n│   └── error_recovery.rs         ← CSS parse error recovery\n├── layout/\n│   ├── engine.rs\n│   └── edge_cases.rs             ← Layout edge case handling\n├── render/\n│   ├── engine.rs\n│   ├── fallback.rs               ← Rendering fallback strategies\n│   └── resource_manager.rs       ← Graphics resource management\n└── utils/\n    ├── mod.rs\n    └── recovery.rs               ← Cross-component error utilities\n```\n\n#### Infrastructure Starter Code\n\n**Complete Error Type System:**\n\n```rust\n// src/error/mod.rs\nuse std::fmt;\n\n/// Result type used throughout the browser engine\npub type BrowserResult<T> = Result<T, BrowserError>;\n\n/// Top-level error type encompassing all failure modes\n#[derive(Debug, Clone)]\npub enum BrowserError {\n    Parse(ParseError),\n    Layout(LayoutError),\n    Render(RenderError),\n    Resource(ResourceError),\n}\n\nimpl fmt::Display for BrowserError {\n    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n        match self {\n            BrowserError::Parse(e) => write!(f, \"Parse error: {}\", e),\n            BrowserError::Layout(e) => write!(f, \"Layout error: {}\", e),\n            BrowserError::Render(e) => write!(f, \"Render error: {}\", e),\n            BrowserError::Resource(e) => write!(f, \"Resource error: {}\", e),\n        }\n    }\n}\n\nimpl std::error::Error for BrowserError {}\n\n/// Severity levels for error reporting and recovery decisions\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum ErrorSeverity {\n    Warning,    // Continue with fallback\n    Error,      // Degrade functionality\n    Critical,   // Abort current operation\n}\n\n/// Error context provides additional information for debugging and recovery\n#[derive(Debug, Clone)]\npub struct ErrorContext {\n    pub location: String,\n    pub severity: ErrorSeverity,\n    pub recoverable: bool,\n    pub suggested_fallback: Option<String>,\n}\n\nimpl ErrorContext {\n    pub fn new(location: &str, severity: ErrorSeverity) -> Self {\n        Self {\n            location: location.to_string(),\n            severity,\n            recoverable: severity != ErrorSeverity::Critical,\n            suggested_fallback: None,\n        }\n    }\n    \n    pub fn with_fallback(mut self, fallback: &str) -> Self {\n        self.suggested_fallback = Some(fallback.to_string());\n        self\n    }\n}\n\n// src/error/parse_error.rs\nuse super::{ErrorContext, ErrorSeverity};\n\n/// Parsing-specific error types with recovery information\n#[derive(Debug, Clone)]\npub enum ParseError {\n    UnexpectedEndTag {\n        tag_name: String,\n        context: ErrorContext,\n    },\n    UnclosedElement {\n        tag_name: String,\n        context: ErrorContext,\n    },\n    InvalidNesting {\n        child_tag: String,\n        parent_tag: String,\n        context: ErrorContext,\n    },\n    MalformedEntity {\n        entity_text: String,\n        context: ErrorContext,\n    },\n    InvalidCSSSyntax {\n        css_text: String,\n        context: ErrorContext,\n    },\n}\n\nimpl ParseError {\n    pub fn unexpected_end_tag(tag_name: &str, location: &str) -> Self {\n        ParseError::UnexpectedEndTag {\n            tag_name: tag_name.to_string(),\n            context: ErrorContext::new(location, ErrorSeverity::Warning)\n                .with_fallback(\"ignore end tag\"),\n        }\n    }\n    \n    pub fn unclosed_element(tag_name: &str, location: &str) -> Self {\n        ParseError::UnclosedElement {\n            tag_name: tag_name.to_string(),\n            context: ErrorContext::new(location, ErrorSeverity::Warning)\n                .with_fallback(\"auto-close element\"),\n        }\n    }\n    \n    pub fn context(&self) -> &ErrorContext {\n        match self {\n            ParseError::UnexpectedEndTag { context, .. } => context,\n            ParseError::UnclosedElement { context, .. } => context,\n            ParseError::InvalidNesting { context, .. } => context,\n            ParseError::MalformedEntity { context, .. } => context,\n            ParseError::InvalidCSSSyntax { context, .. } => context,\n        }\n    }\n}\n\nimpl std::fmt::Display for ParseError {\n    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n        match self {\n            ParseError::UnexpectedEndTag { tag_name, context } => {\n                write!(f, \"Unexpected end tag '{}' at {}\", tag_name, context.location)\n            }\n            ParseError::UnclosedElement { tag_name, context } => {\n                write!(f, \"Unclosed element '{}' at {}\", tag_name, context.location)\n            }\n            ParseError::InvalidNesting { child_tag, parent_tag, context } => {\n                write!(f, \"Invalid nesting: '{}' inside '{}' at {}\", child_tag, parent_tag, context.location)\n            }\n            ParseError::MalformedEntity { entity_text, context } => {\n                write!(f, \"Malformed entity '{}' at {}\", entity_text, context.location)\n            }\n            ParseError::InvalidCSSSyntax { css_text, context } => {\n                write!(f, \"Invalid CSS syntax '{}' at {}\", css_text, context.location)\n            }\n        }\n    }\n}\n\n// src/error/render_error.rs\nuse super::{ErrorContext, ErrorSeverity};\n\n/// Rendering-specific error types with fallback strategies\n#[derive(Debug, Clone)]\npub enum RenderError {\n    GraphicsContextLost {\n        context: ErrorContext,\n    },\n    FontLoadFailed {\n        font_family: String,\n        context: ErrorContext,\n    },\n    OutOfMemory {\n        requested_bytes: usize,\n        context: ErrorContext,\n    },\n    CoordinateOverflow {\n        coordinate: f32,\n        context: ErrorContext,\n    },\n    UnsupportedOperation {\n        operation: String,\n        context: ErrorContext,\n    },\n}\n\nimpl RenderError {\n    pub fn font_load_failed(font_family: &str, location: &str) -> Self {\n        RenderError::FontLoadFailed {\n            font_family: font_family.to_string(),\n            context: ErrorContext::new(location, ErrorSeverity::Warning)\n                .with_fallback(\"use system default font\"),\n        }\n    }\n    \n    pub fn context(&self) -> &ErrorContext {\n        match self {\n            RenderError::GraphicsContextLost { context } => context,\n            RenderError::FontLoadFailed { context, .. } => context,\n            RenderError::OutOfMemory { context, .. } => context,\n            RenderError::CoordinateOverflow { context, .. } => context,\n            RenderError::UnsupportedOperation { context, .. } => context,\n        }\n    }\n}\n\n// src/utils/recovery.rs\nuse crate::error::{BrowserError, ErrorSeverity};\n\n/// Utility functions for error recovery across components\npub struct ErrorRecovery;\n\nimpl ErrorRecovery {\n    /// Determines if an error should halt processing or allow continuation\n    pub fn should_continue(error: &BrowserError) -> bool {\n        match error {\n            BrowserError::Parse(e) => e.context().severity != ErrorSeverity::Critical,\n            BrowserError::Layout(e) => e.context().severity != ErrorSeverity::Critical,\n            BrowserError::Render(e) => e.context().severity != ErrorSeverity::Critical,\n            BrowserError::Resource(e) => e.context().severity != ErrorSeverity::Critical,\n        }\n    }\n    \n    /// Logs error with appropriate level based on severity\n    pub fn log_error(error: &BrowserError) {\n        match error {\n            BrowserError::Parse(e) => match e.context().severity {\n                ErrorSeverity::Warning => println!(\"WARN: {}\", error),\n                ErrorSeverity::Error => println!(\"ERROR: {}\", error),\n                ErrorSeverity::Critical => println!(\"CRITICAL: {}\", error),\n            },\n            _ => println!(\"ERROR: {}\", error),\n        }\n    }\n    \n    /// Applies suggested fallback if available\n    pub fn apply_fallback<T>(error: &BrowserError, default_value: T) -> T {\n        // Log the error and return default\n        Self::log_error(error);\n        default_value\n    }\n}\n```\n\n#### Core Logic Skeleton Code\n\n**HTML Error Recovery Implementation:**\n\n```rust\n// src/html/error_recovery.rs\nuse crate::error::{ParseError, BrowserResult};\nuse crate::html::{HTMLToken, DOMNode, DOMNodeHandle};\nuse std::collections::HashMap;\n\n/// HTML parse error recovery implementation\npub struct HTMLErrorRecovery {\n    open_elements: Vec<DOMNodeHandle>,\n    error_count: usize,\n}\n\nimpl HTMLErrorRecovery {\n    pub fn new() -> Self {\n        Self {\n            open_elements: Vec::new(),\n            error_count: 0,\n        }\n    }\n    \n    /// Handles unclosed elements at end of input\n    pub fn close_all_open_elements(&mut self) -> BrowserResult<()> {\n        // TODO 1: Iterate through open_elements in reverse order (LIFO)\n        // TODO 2: For each open element, create implicit closing tag\n        // TODO 3: Update DOM tree to properly close the element\n        // TODO 4: Log warning for each auto-closed element\n        // TODO 5: Clear the open_elements stack\n        // Hint: Use ParseError::unclosed_element for each auto-closed tag\n        todo!(\"Implement auto-closing of unclosed elements\")\n    }\n    \n    /// Implements foster parenting for misplaced elements\n    pub fn foster_parent_element(\n        &mut self, \n        child_tag: &str, \n        parent_tag: &str,\n        child_node: DOMNodeHandle\n    ) -> BrowserResult<DOMNodeHandle> {\n        // TODO 1: Check if child_tag is allowed inside parent_tag using HTML content model\n        // TODO 2: If not allowed, search up open_elements stack for appropriate parent\n        // TODO 3: If appropriate parent found, close intervening elements\n        // TODO 4: If no appropriate parent, create anonymous block container\n        // TODO 5: Insert child_node at the corrected location\n        // TODO 6: Log ParseError::InvalidNesting with recovery action\n        // Hint: Use VOID_ELEMENTS constant to check self-closing elements\n        todo!(\"Implement foster parenting algorithm\")\n    }\n    \n    /// Recovers from malformed tag syntax\n    pub fn recover_malformed_tag(&self, tag_text: &str) -> BrowserResult<HTMLToken> {\n        // TODO 1: Check for common malformation patterns (missing quotes, unclosed attributes)\n        // TODO 2: Attempt to repair the tag by adding missing characters\n        // TODO 3: If repair successful, return corrected HTMLToken\n        // TODO 4: If unrepairable, treat as text content\n        // TODO 5: Log appropriate ParseError with suggested fix\n        // Hint: Look for patterns like `<div class=unclosed` and add closing quote\n        todo!(\"Implement tag malformation recovery\")\n    }\n}\n\n// src/css/error_recovery.rs\nuse crate::error::{ParseError, BrowserResult};\nuse crate::css::{CSSToken, CSSRule, Declaration, CSSValue};\n\n/// CSS parse error recovery implementation\npub struct CSSErrorRecovery {\n    error_count: usize,\n}\n\nimpl CSSErrorRecovery {\n    /// Skips to next recovery point after parse error\n    pub fn skip_to_recovery_point(&mut self, tokens: &[CSSToken], position: usize) -> usize {\n        // TODO 1: Identify current parsing context (rule, declaration, function, etc.)\n        // TODO 2: Find appropriate recovery token for context (}, ;, ), etc.)\n        // TODO 3: Consume tokens until recovery point found\n        // TODO 4: Return new position after recovery point\n        // TODO 5: Log ParseError::InvalidCSSSyntax with skipped content\n        // Hint: Track brace/parentheses nesting to find correct recovery point\n        todo!(\"Implement CSS error recovery point detection\")\n    }\n    \n    /// Validates and recovers invalid property values\n    pub fn recover_property_value(&self, property: &str, value: &str) -> BrowserResult<CSSValue> {\n        // TODO 1: Check if value matches expected syntax for property\n        // TODO 2: Validate numeric ranges (e.g., opacity 0-1)\n        // TODO 3: Check unit compatibility (length units for width, etc.)\n        // TODO 4: If invalid, determine appropriate fallback value\n        // TODO 5: Log error with invalid value and chosen fallback\n        // Hint: Use match on property name to apply property-specific validation\n        todo!(\"Implement CSS property value validation and recovery\")\n    }\n}\n```\n\n**Layout Edge Case Handling:**\n\n```rust\n// src/layout/edge_cases.rs\nuse crate::layout::{LayoutBox, ComputedStyle, BoxOffsets};\nuse crate::css::{Unit, ComputedLength};\nuse crate::error::{LayoutError, BrowserResult};\n\n/// Handles complex layout edge cases and constraint resolution\npub struct LayoutEdgeCaseHandler;\n\nimpl LayoutEdgeCaseHandler {\n    /// Resolves circular dependencies in percentage calculations\n    pub fn resolve_percentage_cycles(\n        &self, \n        element: &mut LayoutBox, \n        available_width: f32\n    ) -> BrowserResult<()> {\n        // TODO 1: Detect if element width depends on parent width (percentage)\n        // TODO 2: Check if parent width depends on element content (auto sizing)\n        // TODO 3: If circular dependency detected, use intrinsic content width\n        // TODO 4: Apply CSS-specified resolution order for breaking cycles\n        // TODO 5: Ensure calculated values converge to stable result\n        // Hint: Use tentative values and iterative resolution for complex cases\n        todo!(\"Implement percentage cycle resolution\")\n    }\n    \n    /// Implements margin collapsing with all edge cases\n    pub fn calculate_margin_collapse(\n        &self,\n        margin1: f32,\n        margin2: f32,\n        context: &str\n    ) -> BrowserResult<f32> {\n        // TODO 1: Check if margins are adjacent (no border/padding between)\n        // TODO 2: Handle positive margin case (use maximum)\n        // TODO 3: Handle negative margin case (use minimum/most negative)\n        // TODO 4: Handle mixed positive/negative case (arithmetic sum)\n        // TODO 5: Consider clearance preventing collapse\n        // TODO 6: Log complex collapse scenarios for debugging\n        // Hint: Clearance from floated elements prevents margin collapsing\n        todo!(\"Implement complete margin collapse algorithm\")\n    }\n    \n    /// Resolves over-constrained box model situations\n    pub fn resolve_over_constraint(\n        &self,\n        available_width: f32,\n        computed_style: &ComputedStyle\n    ) -> BrowserResult<BoxOffsets> {\n        // TODO 1: Calculate total required width including margins, borders, padding\n        // TODO 2: Check if total exceeds available width\n        // TODO 3: If over-constrained, apply CSS reduction priority order\n        // TODO 4: Reduce auto margins first, then explicit margins\n        // TODO 5: Ensure minimum content requirements are still met\n        // TODO 6: Allow overflow if reduction would break readability\n        // Hint: CSS spec defines exact order for resolving over-constraint\n        todo!(\"Implement over-constraint resolution\")\n    }\n}\n```\n\n**Rendering Fallback System:**\n\n```rust\n// src/render/fallback.rs\nuse crate::render::{PaintCommand, DisplayList, Color, FontInfo, TextMetrics};\nuse crate::error::{RenderError, BrowserResult};\n\n/// Multi-tier rendering fallback system for handling graphics failures\npub struct RenderingFallback {\n    fallback_level: FallbackLevel,\n    software_renderer_available: bool,\n}\n\n#[derive(Debug, Clone, Copy)]\nenum FallbackLevel {\n    Hardware,     // Full GPU acceleration\n    Software,     // CPU rendering with full features  \n    Simple,       // Basic shapes and text only\n    TextOnly,     // Text rendering only\n    ErrorDisplay, // Show error message\n}\n\nimpl RenderingFallback {\n    pub fn new() -> Self {\n        Self {\n            fallback_level: FallbackLevel::Hardware,\n            software_renderer_available: true,\n        }\n    }\n    \n    /// Attempts to render display list with current fallback level\n    pub fn render_with_fallback(&mut self, display_list: &DisplayList) -> BrowserResult<Vec<u8>> {\n        // TODO 1: Try rendering with current fallback level\n        // TODO 2: If rendering fails, move to next fallback level\n        // TODO 3: Simplify display list commands for lower fallback levels\n        // TODO 4: Log degradation when fallback level decreases\n        // TODO 5: Return rendered output or error display\n        // Hint: Each fallback level supports different subset of PaintCommand variants\n        todo!(\"Implement fallback rendering cascade\")\n    }\n    \n    /// Handles font loading failures with progressive fallback\n    pub fn handle_font_failure(\n        &self, \n        requested_font: &FontInfo, \n        text: &str\n    ) -> BrowserResult<TextMetrics> {\n        // TODO 1: Try loading fonts from CSS font-family list in order\n        // TODO 2: Fall back to system default fonts if CSS fonts fail\n        // TODO 3: Use built-in fonts if system fonts unavailable\n        // TODO 4: Calculate estimated metrics if all font loading fails\n        // TODO 5: Log font fallback chain for debugging\n        // Hint: Maintain font cache to avoid reloading failed fonts\n        todo!(\"Implement font fallback with metrics estimation\")\n    }\n    \n    /// Manages graphics resource limits and memory pressure\n    pub fn handle_resource_pressure(&mut self) -> BrowserResult<()> {\n        // TODO 1: Check current memory usage against limits\n        // TODO 2: If pressure detected, start resource cleanup\n        // TODO 3: Evict least-recently-used cached resources\n        // TODO 4: Reduce rendering quality to save memory\n        // TODO 5: Switch to lower fallback level if needed\n        // TODO 6: Log resource pressure events and actions taken\n        // Hint: Use LRU cache for fonts and textures with size-based eviction\n        todo!(\"Implement resource pressure handling\")\n    }\n}\n```\n\n#### Milestone Checkpoints\n\n**After implementing parse error recovery:**\n- Run `cargo test html_error_recovery` - should pass tests for malformed HTML\n- Test with intentionally broken HTML: `<div><p>unclosed` should auto-close both tags\n- Verify foster parenting: `<span><div>content</div></span>` should move div outside span\n- Check error logging shows appropriate warnings with suggested fixes\n\n**After implementing layout edge cases:**\n- Run `cargo test layout_edge_cases` - should handle percentage cycles and margin collapse\n- Test over-constrained layout: element wider than container should overflow gracefully\n- Verify margin collapse: adjacent margins should collapse to maximum value\n- Check that layout doesn't infinite loop on circular percentage dependencies\n\n**After implementing rendering fallbacks:**\n- Run `cargo test render_fallback` - should gracefully degrade when graphics fail\n- Test font fallback: specify non-existent font, should fall back to system default\n- Simulate graphics context loss, should switch to software rendering\n- Verify error display appears when all rendering methods fail\n\n#### Debugging Tips\n\n| Symptom | Likely Cause | How to Diagnose | Fix |\n|---------|--------------|-----------------|-----|\n| Parser infinite loop | Error recovery not advancing input position | Add debug prints in tokenizer state machine | Ensure error recovery always consumes at least one character |\n| Layout calculations never converge | Circular percentage dependencies | Log calculated values in percentage resolution | Implement cycle detection and break with intrinsic sizes |\n| Font rendering shows boxes | Font fallback chain exhausted | Check font loading error logs | Add built-in bitmap font as final fallback |\n| Graphics render fails silently | Error not propagated properly | Enable graphics backend error logging | Check all graphics calls return success codes |\n| Memory usage grows without bound | Resource cleanup not working | Monitor font and texture cache sizes | Implement LRU eviction with proper size limits |\n| Text appears at wrong positions | Font metrics estimation incorrect | Compare estimated vs actual text measurements | Calibrate estimation constants against real fonts |\n\n\n## Testing Strategy and Milestone Validation\n\n> **Milestone(s):** All milestones (1-4) - This section establishes comprehensive testing approaches and validation criteria for each stage of the browser engine implementation.\n\nBuilding a browser engine presents unique testing challenges because the system transforms textual markup through multiple intermediate representations before producing visual output. Think of testing a browser engine like **quality control in a film production pipeline** — you need checkpoints at each stage (script review, filming, editing, post-production) rather than just watching the final movie. Each stage has different success criteria: the script needs coherent plot structure, the raw footage needs proper lighting and framing, the edited sequences need smooth transitions, and the final product needs correct color grading and audio sync.\n\nSimilarly, our browser engine requires validation at each pipeline stage. The HTML parser must produce structurally correct DOM trees regardless of input malformations. The CSS parser must handle invalid syntax gracefully while preserving valid rules. The layout engine must compute geometrically consistent box positions even with conflicting constraints. The rendering engine must produce visually correct output even when graphics resources are constrained.\n\nThe testing strategy balances **unit-level validation** (testing individual components in isolation) with **integration-level validation** (testing the complete pipeline with real-world inputs). Each milestone builds upon previous stages, so testing must verify both backward compatibility and forward progression. The key insight is that browser engines fail gracefully — they should render *something* useful even with severely malformed input, rather than crashing or producing blank output.\n\n### Milestone Validation Checkpoints\n\nEach milestone requires specific validation checkpoints that verify the acceptance criteria have been met. These checkpoints serve as concrete proof that the implementation handles both normal cases and edge cases correctly.\n\n#### Milestone 1: HTML Parser Validation\n\nThe HTML parser validation focuses on **structural correctness** of the DOM tree and **graceful degradation** with malformed input. Think of this like **validating a document parser** — the output structure must accurately represent the input meaning, even when the input format is imperfect.\n\n| Test Category | Validation Focus | Success Criteria |\n|---------------|------------------|------------------|\n| Basic Tokenization | Token boundary detection | Start tags, end tags, text content, and attributes are correctly identified |\n| Tree Construction | Parent-child relationships | DOM tree reflects HTML nesting structure with correct hierarchy |\n| Self-Closing Elements | Void element handling | Elements like `br`, `img`, `input` don't expect closing tags |\n| Error Recovery | Malformed input handling | Missing closing tags and improper nesting produce usable DOM trees |\n| Entity Decoding | Character reference processing | Named entities (`&amp;`, `&lt;`) and numeric entities are decoded |\n\n**Essential Test Cases for HTML Parser:**\n\nThe tokenizer validation requires testing the state machine transitions with various input patterns:\n\n1. **Well-formed markup parsing**: Standard HTML with properly nested elements, complete attribute syntax, and correct tag closing should produce an exact structural match in the DOM tree\n2. **Attribute parsing verification**: Elements with multiple attributes, quoted and unquoted values, and empty attributes should preserve all attribute data in the `ElementData` structure\n3. **Text content preservation**: Mixed text and element content should maintain text nodes in correct positions relative to element siblings\n4. **Self-closing element recognition**: Void elements like `<br>`, `<img src=\"test.png\">`, and `<input type=\"text\">` should not wait for closing tags and should set the `is_void` flag correctly\n5. **Malformed tag recovery**: Unclosed tags like `<div><p>content` should auto-close at document end or when encountering incompatible parent elements\n6. **Improper nesting correction**: Invalid structures like `<p><div>content</div></p>` should use foster parenting to move misplaced elements to valid locations\n7. **Entity decoding accuracy**: Character references like `&amp;`, `&lt;`, `&quot;`, and numeric references like `&#65;` should decode to correct Unicode characters\n8. **Case sensitivity handling**: Tag names and attribute names should normalize to lowercase while preserving attribute value casing\n\n> **Critical Validation Point**: The DOM tree's `get_children()` and `get_parent()` methods should maintain bidirectional consistency — every child's parent should reference the correct ancestor, and every parent's children list should contain all direct descendants.\n\n**HTML Parser Checkpoint Commands:**\n\n```\n# Test basic parsing functionality\ncargo test html_parser_basic --features test-utils\n\n# Validate malformed input recovery  \ncargo test html_error_recovery --features test-utils\n\n# Verify entity decoding\ncargo test html_entities --features test-utils\n```\n\nExpected output should show successful DOM tree construction with proper node relationships and error counts within acceptable limits (warnings for malformed input, but no critical failures that prevent tree construction).\n\n#### Milestone 2: CSS Parser Validation\n\nThe CSS parser validation emphasizes **rule extraction accuracy** and **cascade precedence correctness**. This is like **validating a legal document parser** — the system must extract precise rules from complex syntax and apply them in the correct priority order.\n\n| Test Category | Validation Focus | Success Criteria |\n|---------------|------------------|------------------|\n| Selector Parsing | Selector type recognition | Tag, class, ID, and combinator selectors parse correctly |\n| Property Extraction | Declaration parsing | Property names, values, and units are extracted accurately |\n| Specificity Calculation | Precedence computation | Specificity tuple (inline, ids, classes, elements) is correct |\n| Cascade Application | Rule precedence | Styles apply in document order with specificity override |\n| Error Recovery | Invalid CSS handling | Malformed rules are skipped without breaking valid rules |\n\n**Essential Test Cases for CSS Parser:**\n\nThe CSS parser testing requires validating both individual rule parsing and complete stylesheet processing:\n\n1. **Selector variety parsing**: Test tag selectors (`div`), class selectors (`.content`), ID selectors (`#header`), and attribute selectors (`input[type=\"text\"]`) for correct `Selector` enum construction\n2. **Combinator selector handling**: Descendant (`div p`), child (`ul > li`), adjacent sibling (`h1 + p`), and general sibling (`h1 ~ p`) combinators should parse into correct combinator variants\n3. **Property-value extraction**: CSS declarations like `color: red`, `margin: 10px 20px`, and `background: url(image.png) no-repeat center` should parse into appropriate `CSSValue` enum variants\n4. **Specificity computation validation**: Complex selectors like `#main .content div.highlight` should calculate specificity as (0, 1, 2, 1) representing (inline, ids, classes, elements)\n5. **Cascade rule application**: When multiple rules target the same element, higher specificity rules should override lower specificity ones, with document order as the tiebreaker\n6. **Unit parsing verification**: Length values like `10px`, `2em`, `50%`, and `auto` should parse into correct `Unit` enum variants with proper numeric values\n7. **Color value processing**: Color values in hex (`#FF0000`), RGB (`rgb(255, 0, 0)`), and keyword (`red`) formats should convert to consistent `Color` struct representation\n8. **Invalid rule recovery**: Malformed CSS like `color: ;` or `unknown-property: value;` should be skipped without affecting subsequent valid rules\n\n> **Critical Validation Point**: The `calculate_specificity()` function must produce consistent results that match CSS specification algorithms, as this directly affects which styles apply to elements during cascade resolution.\n\n**CSS Parser Checkpoint Commands:**\n\n```\n# Test selector and property parsing\ncargo test css_parser_rules --features test-utils\n\n# Validate specificity calculations  \ncargo test css_specificity --features test-utils\n\n# Verify cascade resolution\ncargo test css_cascade --features test-utils\n```\n\nExpected output should demonstrate correct rule extraction, accurate specificity values, and proper cascade application where high-specificity rules override low-specificity ones.\n\n#### Milestone 3: Layout Engine Validation\n\nThe layout engine validation focuses on **geometric consistency** and **constraint satisfaction**. Think of this like **validating an architectural blueprint** — all measurements must be mathematically consistent, space allocations must sum correctly, and physical constraints must be respected.\n\n| Test Category | Validation Focus | Success Criteria |\n|---------------|------------------|------------------|\n| Box Model Calculation | Dimension computation | Content, padding, border, margin rectangles are correctly sized |\n| Block Formatting | Vertical layout | Child elements stack vertically with proper spacing |\n| Inline Formatting | Horizontal flow | Inline content flows horizontally with correct line breaks |\n| Constraint Resolution | Overconstrained handling | Conflicting width/margin values resolve per CSS specification |\n| Margin Collapsing | Adjacent margin handling | Vertical margins collapse according to CSS rules |\n\n**Essential Test Cases for Layout Engine:**\n\nThe layout validation requires testing both individual box calculations and complete formatting context behavior:\n\n1. **Box model dimension verification**: Elements with explicit `width`, `height`, `padding`, `border`, and `margin` values should produce `LayoutBox` structures where `content_rect`, `padding_rect`, `border_rect`, and `margin_rect` have mathematically consistent dimensions\n2. **Auto sizing behavior**: Elements with `width: auto` should expand to fill available space minus sibling elements' space requirements, while `height: auto` should shrink to content height\n3. **Percentage unit resolution**: Child elements with percentage dimensions should compute to pixel values based on their containing block's resolved dimensions\n4. **Block formatting context**: Block elements should stack vertically with each child's `content_rect.origin.y` positioned below the previous child's margin bottom edge\n5. **Inline formatting context**: Text and inline elements should flow horizontally within available width, creating new `LineBox` instances when content exceeds container bounds\n6. **Margin collapsing verification**: Adjacent block elements with vertical margins should collapse to the larger margin value, not the sum of both margins\n7. **Overconstrained resolution**: Elements with conflicting constraints like `width: 200px` and `margin-left: auto` and `margin-right: auto` in a 150px container should resolve according to CSS specification priority rules\n8. **Nested formatting context**: Block containers with both block and inline children should create anonymous block boxes to wrap inline content sequences\n\n> **Critical Validation Point**: The `calculate_box_model()` method must ensure that `margin_rect.size.width` equals `content_rect.size.width` plus padding, border, and margin horizontal totals. Any mismatch indicates a fundamental calculation error.\n\n**Layout Engine Checkpoint Commands:**\n\n```\n# Test box model calculations\ncargo test layout_box_model --features test-utils\n\n# Validate formatting contexts\ncargo test layout_formatting --features test-utils  \n\n# Verify constraint resolution\ncargo test layout_constraints --features test-utils\n```\n\nExpected output should show consistent rectangle dimensions where outer rectangles properly contain inner rectangles, and total space allocation matches available space.\n\n#### Milestone 4: Rendering Engine Validation\n\nThe rendering engine validation emphasizes **visual output correctness** and **paint command ordering**. This is like **validating a print production system** — the final output must visually match the design specifications, colors must be accurate, and layering must follow the correct stacking order.\n\n| Test Category | Validation Focus | Success Criteria |\n|---------------|------------------|------------------|\n| Paint Command Generation | Drawing operation sequence | Background, border, and text commands generate in correct order |\n| Color Accuracy | RGB value preservation | Colors specified in CSS render with exact RGB values |\n| Text Positioning | Baseline alignment | Text renders at correct coordinates with proper font metrics |\n| Z-Order Handling | Layering sequence | Later elements paint over earlier elements |\n| Clipping Boundaries | Viewport constraints | Content outside viewport bounds is properly clipped |\n\n**Essential Test Cases for Rendering Engine:**\n\nThe rendering validation requires both command sequence verification and visual output testing:\n\n1. **Display list command ordering**: The `generate_display_list()` function should produce `PaintCommand` sequences where background rectangles precede border rectangles, which precede text commands for each element\n2. **Color value preservation**: CSS colors like `background-color: #FF0000` should generate `DrawRectangle` commands with `Color { r: 255, g: 0, b: 0, a: 255 }` values\n3. **Text positioning accuracy**: Text elements should generate `DrawText` commands with coordinates that align text baselines correctly within their containing `LayoutBox` rectangles  \n4. **Rectangle coordinate verification**: `DrawRectangle` and `DrawBorder` commands should use coordinates from the corresponding `LayoutBox.border_rect` or `LayoutBox.content_rect` fields\n5. **Z-order paint sequence**: Elements appearing later in document order should generate paint commands that appear later in the `DisplayList.commands` vector, ensuring proper visual layering\n6. **Viewport clipping application**: Elements with rectangles extending beyond `BrowserEngine.viewport_size` should either generate `SetClip` commands or be omitted from the display list entirely\n7. **Font fallback handling**: Text with unavailable fonts should generate `DrawText` commands using fallback font families rather than failing or rendering blank space\n8. **Graphics backend compatibility**: The `render_to_canvas()` function should produce consistent visual output regardless of whether hardware acceleration is available\n\n> **Critical Validation Point**: The `DisplayList.commands` vector must maintain paint order consistency — background colors must precede borders, which must precede text content for each element. Violations of this ordering produce incorrect visual layering.\n\n**Rendering Engine Checkpoint Commands:**\n\n```\n# Test paint command generation\ncargo test render_display_list --features test-utils\n\n# Validate visual output  \ncargo test render_canvas --features test-utils\n\n# Verify z-order handling\ncargo test render_layering --features test-utils\n```\n\nExpected output should produce visual files or canvas data that can be compared against reference images, with text clearly readable and colors matching CSS specifications.\n\n### Integration Testing Strategy\n\nIntegration testing validates the **complete rendering pipeline** with real-world HTML and CSS inputs. Think of this like **end-to-end quality assurance for a manufacturing pipeline** — individual components might work correctly in isolation, but the complete system must handle the complex interactions and edge cases that emerge when all components work together.\n\nThe integration testing strategy focuses on **realistic web content scenarios** rather than synthetic test cases. This reveals issues like CSS rules that parse correctly but produce invalid layout constraints, or layout calculations that are geometrically sound but generate paint commands outside graphics system limits.\n\n#### Comprehensive Pipeline Testing\n\nThe integration tests should exercise the complete `render_page()` function with various complexity levels of real HTML/CSS content:\n\n| Test Complexity | Content Characteristics | Validation Focus |\n|----------------|-------------------------|------------------|\n| Basic Documents | Simple HTML with minimal CSS | End-to-end pipeline functionality |\n| Styled Content | Multiple CSS rules and selectors | Style resolution and cascade accuracy |\n| Complex Layouts | Nested elements with varied positioning | Layout constraint interaction |\n| Edge Case Combinations | Malformed HTML with complex CSS | Error recovery across pipeline stages |\n| Performance Boundaries | Large documents with many elements | Resource management and scaling |\n\n**Essential Integration Test Scenarios:**\n\nThe integration test suite should include realistic web content patterns that stress the interactions between pipeline components:\n\n1. **Basic webpage rendering**: A simple HTML document with headings, paragraphs, and basic CSS styling should render completely without errors, producing a `DisplayList` with appropriate text and background commands\n2. **CSS cascade complexity**: Multiple stylesheets with conflicting rules should resolve according to specificity and source order, with the final rendered output reflecting the correct winning styles\n3. **Nested layout interaction**: Complex HTML structures with deeply nested elements should produce correct layout calculations where child element positions are computed relative to their proper containing blocks\n4. **Mixed content handling**: Documents combining block elements, inline text, images, and form elements should create appropriate anonymous boxes and formatting contexts\n5. **Malformed input resilience**: Documents with both HTML parsing errors and CSS syntax errors should still produce usable visual output, degrading gracefully rather than failing completely\n6. **Resource constraint handling**: Large documents that approach memory or processing limits should either render successfully or fail gracefully with appropriate error messages\n7. **Font and color accuracy**: Documents with various font families, sizes, and color specifications should render with visually correct text appearance and background colors\n8. **Viewport adaptation**: Content designed for different screen sizes should adapt appropriately to the configured `BrowserEngine.viewport_size` dimensions\n\n> **Key Integration Insight**: Integration tests often reveal **cascade failures** where errors in one pipeline stage propagate to create incorrect behavior in downstream stages. For example, HTML parsing errors might create DOM structures that confuse CSS selector matching, leading to incorrect style application and ultimately wrong visual output.\n\n**Integration Test Implementation Strategy:**\n\nThe integration testing harness should provide both **automated verification** and **manual inspection capabilities**:\n\n| Test Type | Automation Level | Verification Method |\n|-----------|------------------|-------------------|\n| Structure Validation | Fully Automated | Compare DOM tree structure against expected patterns |\n| Style Resolution | Fully Automated | Verify computed styles match expected CSS cascade results |\n| Layout Geometry | Fully Automated | Check layout box dimensions against calculated expectations |  \n| Visual Output | Semi-Automated | Generate reference images for manual comparison |\n| Error Boundaries | Fully Automated | Verify graceful degradation and error message quality |\n\n**Reference Test Document Set:**\n\nThe integration test suite should include a curated set of reference documents that comprehensively exercise the browser engine:\n\n1. **Basic HTML Structure Test**: A simple document with common HTML elements to verify fundamental parsing and rendering\n2. **CSS Cascade Resolution Test**: Multiple competing CSS rules targeting the same elements to verify specificity and cascade algorithms  \n3. **Complex Layout Test**: Nested block and inline elements with various sizing constraints to test layout engine robustness\n4. **Error Recovery Test**: Deliberately malformed HTML and CSS to verify graceful degradation behavior\n5. **Performance Boundary Test**: Large documents to verify resource management and performance characteristics\n\nEach reference document should include expected outputs at each pipeline stage:\n- Expected DOM tree structure (serialized as JSON for comparison)\n- Expected computed styles for key elements (property-value pairs)\n- Expected layout box coordinates and dimensions (rectangle specifications)\n- Expected visual appearance (reference images or detailed descriptions)\n\n#### Cross-Component Error Propagation Testing\n\nIntegration testing must specifically validate how errors propagate between pipeline components and verify that error recovery mechanisms work correctly across component boundaries:\n\n| Error Source | Propagation Path | Expected Recovery Behavior |\n|--------------|------------------|---------------------------|\n| HTML Parse Errors | DOM → Style → Layout → Render | Malformed elements should receive default styles and layout |\n| CSS Parse Errors | Style → Layout → Render | Invalid rules should be ignored without affecting valid rules |\n| Layout Constraint Failures | Layout → Render | Impossible constraints should resolve to specification defaults |\n| Rendering Resource Failures | Render stage only | Should fallback to simpler rendering techniques |\n\n**Error Propagation Test Cases:**\n\n1. **HTML syntax errors affecting CSS matching**: Malformed HTML that creates unexpected DOM structures should not prevent CSS rules from applying to correctly formed elements\n2. **CSS parsing errors affecting layout**: Invalid CSS declarations should not interfere with layout calculations for properties that parsed successfully\n3. **Layout constraint conflicts affecting rendering**: Elements with impossible sizing constraints should still generate valid paint commands using fallback dimensions\n4. **Resource exhaustion during rendering**: Memory or graphics failures during rendering should be contained and not corrupt earlier pipeline stage results\n\n> **Critical Integration Principle**: The browser engine should implement **error boundary isolation** — failures in one pipeline stage should not prevent successful processing of subsequent stages. Each stage should validate its inputs and apply appropriate fallbacks when receiving corrupted data from earlier stages.\n\n### Implementation Guidance\n\n#### Technology Recommendations\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| Test Framework | `cargo test` with built-in assert macros | `proptest` for property-based testing with generated inputs |\n| Visual Comparison | Manual image inspection | Automated pixel-diff comparison with reference images |\n| Performance Testing | Simple timing measurements | `criterion` crate for statistical benchmarking |\n| Test Data Management | Embedded test strings in source | External HTML/CSS files with structured test directories |\n| Error Simulation | Manual error injection | `fault-injection` crate for systematic failure testing |\n\n#### Recommended File Structure\n\n```\nbrowser-engine/\n├── src/\n│   ├── html/\n│   │   ├── parser.rs\n│   │   └── parser_tests.rs       ← Unit tests for HTML parser\n│   ├── css/  \n│   │   ├── parser.rs\n│   │   └── parser_tests.rs       ← Unit tests for CSS parser\n│   ├── layout/\n│   │   ├── engine.rs\n│   │   └── engine_tests.rs       ← Unit tests for layout engine\n│   ├── render/\n│   │   ├── engine.rs\n│   │   └── engine_tests.rs       ← Unit tests for rendering engine\n│   └── lib.rs\n├── tests/\n│   ├── integration/\n│   │   ├── basic_rendering.rs    ← End-to-end pipeline tests\n│   │   ├── error_recovery.rs     ← Cross-component error handling\n│   │   └── performance.rs        ← Resource usage and scaling tests\n│   └── test_data/\n│       ├── html/\n│       │   ├── basic.html\n│       │   ├── malformed.html\n│       │   └── complex.html\n│       ├── css/\n│       │   ├── simple.css\n│       │   ├── cascade.css  \n│       │   └── invalid.css\n│       └── expected/\n│           ├── dom_trees/        ← JSON serialized expected DOM structures\n│           ├── computed_styles/  ← Expected style resolution results\n│           ├── layout_boxes/     ← Expected layout coordinates\n│           └── visual_output/    ← Reference images for visual comparison\n└── Cargo.toml\n```\n\n#### Test Infrastructure Starter Code\n\n**Complete Test Utilities Module:**\n\n```rust\n// tests/test_utils.rs - Complete testing infrastructure\nuse std::collections::HashMap;\nuse browser_engine::*;\n\n/// Test harness for validating complete rendering pipeline\npub struct RenderingTestHarness {\n    engine: BrowserEngine,\n    test_data_path: String,\n}\n\nimpl RenderingTestHarness {\n    pub fn new(viewport_width: f32, viewport_height: f32) -> Self {\n        Self {\n            engine: BrowserEngine::new(viewport_width, viewport_height),\n            test_data_path: \"tests/test_data\".to_string(),\n        }\n    }\n\n    /// Load test HTML file and return content\n    pub fn load_test_html(&self, filename: &str) -> Result<String, std::io::Error> {\n        std::fs::read_to_string(format!(\"{}/html/{}\", self.test_data_path, filename))\n    }\n\n    /// Load test CSS file and return content  \n    pub fn load_test_css(&self, filename: &str) -> Result<String, std::io::Error> {\n        std::fs::read_to_string(format!(\"{}/css/{}\", self.test_data_path, filename))\n    }\n\n    /// Validate DOM tree structure against expected JSON\n    pub fn validate_dom_structure(&self, dom: &DOMNode, expected_file: &str) -> bool {\n        // TODO: Serialize DOM to JSON and compare with expected file\n        true\n    }\n\n    /// Validate computed styles against expected values\n    pub fn validate_computed_styles(&self, styles: &ComputedStyle, expected: &HashMap<String, String>) -> bool {\n        // TODO: Compare computed style properties with expected values\n        true\n    }\n\n    /// Generate visual output and optionally compare with reference\n    pub fn validate_visual_output(&self, display_list: &DisplayList, reference_file: Option<&str>) -> Result<Vec<u8>, String> {\n        // TODO: Render display list to canvas and optionally compare with reference image\n        Ok(vec![])\n    }\n}\n\n/// Utility functions for creating test data\npub struct TestDataBuilder {\n    html_content: String,\n    css_content: String,\n}\n\nimpl TestDataBuilder {\n    pub fn new() -> Self {\n        Self {\n            html_content: String::new(),\n            css_content: String::new(),\n        }\n    }\n\n    pub fn with_html(mut self, html: &str) -> Self {\n        self.html_content = html.to_string();\n        self\n    }\n\n    pub fn with_css(mut self, css: &str) -> Self {\n        self.css_content = css.to_string();\n        self\n    }\n\n    pub fn build(self) -> (String, String) {\n        (self.html_content, self.css_content)\n    }\n}\n```\n\n#### Core Testing Skeleton Code\n\n**HTML Parser Milestone Validation:**\n\n```rust\n// src/html/parser_tests.rs\nuse super::*;\nuse crate::test_utils::*;\n\n/// Validates HTML tokenization against acceptance criteria\n#[test]\nfn test_tokenization_acceptance_criteria() {\n    let html = \"<div class='content'>Hello <span>World</span></div>\";\n    let mut parser = HTMLParser::new();\n    \n    // TODO 1: Parse HTML into tokens and verify token types\n    // Expected: StartTag(div), Text(Hello ), StartTag(span), Text(World), EndTag(span), EndTag(div)\n    \n    // TODO 2: Validate attribute parsing for class='content'\n    // Expected: attributes HashMap should contain \"class\" -> \"content\"\n    \n    // TODO 3: Verify text content preservation\n    // Expected: Text tokens should preserve whitespace and content exactly\n}\n\n/// Validates DOM tree construction with proper parent-child relationships  \n#[test]\nfn test_dom_tree_construction() {\n    let html = \"<div><p>Paragraph 1</p><p>Paragraph 2</p></div>\";\n    \n    // TODO 1: Parse HTML into DOM tree\n    let dom_result = HTMLParser::parse(html);\n    \n    // TODO 2: Validate tree structure - div should have 2 paragraph children\n    // Use get_children() to verify child count and get_parent() to verify relationships\n    \n    // TODO 3: Verify text content is correctly associated with paragraph elements\n    // Each paragraph should have exactly one text child node\n    \n    // TODO 4: Test bidirectional consistency - every child's parent should reference correct ancestor\n}\n\n/// Validates self-closing and void element handling\n#[test] \nfn test_void_element_handling() {\n    let html = \"<div><br><img src='test.png'><input type='text'></div>\";\n    \n    // TODO 1: Parse HTML with void elements that lack closing tags\n    \n    // TODO 2: Verify void elements don't wait for closing tags\n    // br, img, and input should be complete after start tag\n    \n    // TODO 3: Validate is_void flag is set correctly in ElementData\n    \n    // TODO 4: Ensure DOM structure treats void elements as self-contained nodes\n}\n\n/// Validates error recovery with malformed HTML\n#[test]\nfn test_error_recovery_acceptance() {\n    let malformed_html = \"<div><p>Unclosed paragraph<div>Improperly nested</div>\";\n    \n    // TODO 1: Parse malformed HTML and capture parse errors\n    let (dom, errors) = HTMLParser::parse_with_errors(malformed_html);\n    \n    // TODO 2: Verify DOM tree is still usable despite errors\n    // Should auto-close unclosed elements and fix improper nesting\n    \n    // TODO 3: Validate error recovery strategies produced reasonable tree structure\n    // Check that foster parenting moved misplaced elements correctly\n    \n    // TODO 4: Ensure error count is recorded but parsing continues\n}\n```\n\n**CSS Parser Milestone Validation:**\n\n```rust  \n// src/css/parser_tests.rs\nuse super::*;\n\n/// Validates CSS selector parsing across all selector types\n#[test]\nfn test_selector_parsing_acceptance() {\n    let css = r#\"\n        div { color: red; }\n        .content { margin: 10px; }  \n        #header { background: blue; }\n        input[type=\"text\"] { border: 1px solid gray; }\n        div > p { font-size: 14px; }\n    \"#;\n    \n    // TODO 1: Parse CSS into rules and extract selectors\n    let stylesheet = CSSParser::parse_stylesheet(css)?;\n    \n    // TODO 2: Verify tag selector parsing - div should create Type selector\n    \n    // TODO 3: Verify class selector parsing - .content should create Class selector  \n    \n    // TODO 4: Verify ID selector parsing - #header should create ID selector\n    \n    // TODO 5: Verify attribute selector parsing - input[type=\"text\"] creates Attribute selector\n    \n    // TODO 6: Verify combinator parsing - div > p creates Child combinator selector\n}\n\n/// Validates specificity calculation against CSS specification\n#[test]\nfn test_specificity_calculation() {\n    let test_cases = vec![\n        (\"div\", Specificity { inline: 0, ids: 0, classes: 0, elements: 1 }),\n        (\".content\", Specificity { inline: 0, ids: 0, classes: 1, elements: 0 }),\n        (\"#header\", Specificity { inline: 0, ids: 1, classes: 0, elements: 0 }),\n        (\"div.content\", Specificity { inline: 0, ids: 0, classes: 1, elements: 1 }),\n        (\"#main .content div\", Specificity { inline: 0, ids: 1, classes: 1, elements: 1 }),\n    ];\n    \n    for (selector_text, expected) in test_cases {\n        // TODO 1: Parse selector string into Selector enum\n        \n        // TODO 2: Calculate specificity using calculate_specificity()\n        \n        // TODO 3: Compare calculated specificity with expected values\n        // All four components (inline, ids, classes, elements) must match exactly\n    }\n}\n\n/// Validates cascade algorithm applies rules in correct order\n#[test]\nfn test_cascade_resolution() {\n    let css = r#\"\n        div { color: red; font-size: 16px; }\n        .content { color: blue; margin: 10px; }\n        #specific { color: green; }  \n    \"#;\n    let html = r#\"<div id=\"specific\" class=\"content\">Test</div>\"#;\n    \n    // TODO 1: Parse both HTML and CSS  \n    \n    // TODO 2: Apply cascade algorithm to resolve final styles for the div element\n    \n    // TODO 3: Verify color resolves to green (ID selector wins over class and tag)\n    \n    // TODO 4: Verify font-size comes from tag selector (no higher-specificity override)  \n    \n    // TODO 5: Verify margin comes from class selector (higher specificity than tag)\n}\n```\n\n**Layout Engine Milestone Validation:**\n\n```rust\n// src/layout/engine_tests.rs  \nuse super::*;\n\n/// Validates box model calculation accuracy\n#[test]\nfn test_box_model_calculation() {\n    let style = ComputedStyle {\n        width: Unit::Px(100.0),\n        height: Unit::Px(50.0),\n        margin: BoxOffsets { top: 10.0, right: 20.0, bottom: 10.0, left: 20.0 },\n        padding: BoxOffsets { top: 5.0, right: 10.0, bottom: 5.0, left: 10.0 },\n        border: BoxOffsets { top: 2.0, right: 3.0, bottom: 2.0, left: 3.0 },\n        // ... other properties\n    };\n    \n    let mut layout_box = LayoutBox::new(BoxType::BlockContainer);\n    layout_box.computed_style = style;\n    \n    // TODO 1: Calculate box model dimensions using calculate_box_model()\n    layout_box.calculate_box_model(Size { width: 200.0, height: 300.0 });\n    \n    // TODO 2: Verify content rectangle dimensions\n    // Should be exactly 100x50 as specified in computed style\n    \n    // TODO 3: Verify padding rectangle includes content + padding\n    // Width: 100 + 10 + 10 = 120, Height: 50 + 5 + 5 = 60\n    \n    // TODO 4: Verify border rectangle includes padding + border  \n    // Width: 120 + 3 + 3 = 126, Height: 60 + 2 + 2 = 64\n    \n    // TODO 5: Verify margin rectangle includes border + margin\n    // Width: 126 + 20 + 20 = 166, Height: 64 + 10 + 10 = 84\n    \n    // TODO 6: Validate rectangle containment - outer rectangles must contain inner rectangles\n}\n\n/// Validates block formatting context behavior\n#[test]\nfn test_block_formatting_context() {\n    let html = \"<div><p>First paragraph</p><p>Second paragraph</p><div>Third block</div></div>\";\n    let css = \"p { height: 30px; margin: 10px; } div { height: 40px; }\";\n    \n    // TODO 1: Parse HTML and CSS, compute styles, create layout tree\n    \n    // TODO 2: Run layout calculation on container with available width 300px\n    \n    // TODO 3: Verify children stack vertically\n    // First paragraph y-position should be 0 (plus margin)\n    // Second paragraph should be positioned below first (accounting for margins)\n    // Third div should be positioned below second paragraph\n    \n    // TODO 4: Verify margin collapsing between paragraphs\n    // Adjacent 10px margins should collapse to single 10px gap, not 20px\n    \n    // TODO 5: Validate total container height encompasses all children plus margins\n}\n\n/// Validates inline formatting context with line breaking\n#[test]\nfn test_inline_formatting_context() {\n    let html = \"<p>This is a long line of text that should wrap to multiple lines when the container width is too narrow to fit all content on one line</p>\";\n    let css = \"p { width: 100px; font-size: 12px; }\";\n    \n    let text_measurer = SimpleTextMeasurer { char_width: 8.0, line_height: 16.0 };\n    \n    // TODO 1: Parse and style content, create layout tree\n    \n    // TODO 2: Run inline layout with narrow container width\n    \n    // TODO 3: Verify text content breaks across multiple LineBox instances\n    // With 100px width and ~8px per character, should break around 12 characters per line\n    \n    // TODO 4: Validate line box positions stack vertically within container\n    \n    // TODO 5: Verify text positioning respects baseline alignment within each line\n}\n```\n\n**Rendering Engine Milestone Validation:**\n\n```rust\n// src/render/engine_tests.rs\nuse super::*;\n\n/// Validates paint command generation sequence and content\n#[test]  \nfn test_paint_command_generation() {\n    // Create layout tree with background, border, and text content\n    let layout_tree = create_test_layout_tree();\n    \n    // TODO 1: Generate display list from layout tree\n    let display_list = generate_display_list(&layout_tree)?;\n    \n    // TODO 2: Verify paint commands are in correct z-order\n    // Background rectangles should come before borders, borders before text\n    \n    // TODO 3: Validate DrawRectangle commands use correct coordinates\n    // Should match border_rect or content_rect from corresponding LayoutBox\n    \n    // TODO 4: Verify DrawText commands position text at correct baseline coordinates\n    \n    // TODO 5: Confirm color values match ComputedStyle specifications exactly\n}\n\n/// Validates complete rendering pipeline produces visual output\n#[test]\nfn test_end_to_end_rendering() {\n    let html = \"<div style='background-color: red; width: 100px; height: 50px;'>Hello World</div>\";\n    let css = \"div { color: white; font-size: 16px; }\";\n    \n    // TODO 1: Execute complete render_page() pipeline\n    let canvas_data = render_page(html, css)?;\n    \n    // TODO 2: Verify canvas data is non-empty and has expected dimensions\n    \n    // TODO 3: Sample pixel data to verify red background color is present\n    \n    // TODO 4: Verify white text pixels are rendered over red background\n    \n    // TODO 5: Validate output format is compatible with image display/saving\n}\n```\n\n#### Milestone Checkpoint Validation\n\n**Milestone 1 Checkpoint (HTML Parser):**\n```bash  \n# Run HTML parser unit tests\ncargo test html_parser --features test-utils\n\n# Expected output: All tokenization and tree construction tests pass\n# Parse basic.html should produce valid DOM tree\n# Parse malformed.html should recover gracefully with warnings\n# Void elements should not wait for closing tags\n```\n\n**Milestone 2 Checkpoint (CSS Parser):**\n```bash\n# Run CSS parser unit tests  \ncargo test css_parser --features test-utils\n\n# Expected output: All selector, specificity, and cascade tests pass\n# Parse simple.css should extract all rules correctly\n# Parse cascade.css should resolve conflicts by specificity\n# Parse invalid.css should skip malformed rules without breaking valid ones\n```\n\n**Milestone 3 Checkpoint (Layout Engine):**  \n```bash\n# Run layout engine unit tests\ncargo test layout_engine --features test-utils\n\n# Expected output: All box model and formatting context tests pass\n# Layout calculations should produce mathematically consistent rectangles  \n# Block formatting should stack elements vertically with proper spacing\n# Inline formatting should wrap text at container boundaries\n```\n\n**Milestone 4 Checkpoint (Rendering Engine):**\n```bash  \n# Run rendering engine unit tests\ncargo test render_engine --features test-utils\n\n# Expected output: All paint generation and output tests pass\n# Display lists should contain commands in correct z-order  \n# Canvas output should be non-empty with expected pixel dimensions\n# Visual output should match CSS specifications for colors and positioning\n```\n\n**Integration Testing Checkpoint:**\n```bash\n# Run complete pipeline integration tests\ncargo test integration --features test-utils  \n\n# Expected output: End-to-end rendering completes successfully\n# Complex documents should render without crashing\n# Error recovery should maintain usable output despite malformed input  \n# Performance tests should complete within reasonable time/memory bounds\n\n```\n\n\n## Debugging Guide and Common Issues\n\n> **Milestone(s):** All milestones (1-4) - This section provides systematic debugging approaches and diagnostic techniques that are essential throughout the entire browser engine implementation.\n\nBuilding a browser engine involves multiple complex systems working together in a **rendering pipeline**, where failures in one stage can manifest as seemingly unrelated problems downstream. Think of debugging a browser engine like diagnosing a multi-stage **factory assembly line** where raw materials (HTML/CSS text) are transformed through various stations (parsing, styling, layout, rendering) into finished products (visual output). When the final product is defective, the problem could have originated at any stage, and symptoms often appear far from their root causes.\n\nThis debugging guide provides a systematic approach to isolating and resolving issues across all four milestones. The key insight is that browser engine bugs typically fall into three categories: **parse-time errors** where malformed input creates incorrect data structures, **computation-time errors** where algorithms produce wrong results from correct inputs, and **render-time errors** where correct layout data fails to produce visual output. Each category requires different diagnostic techniques and has characteristic symptom patterns.\n\nThe debugging methodology follows a **symptom-first approach**: we identify observable behaviors (incorrect DOM structure, wrong element positions, missing visual elements), trace them back through the pipeline to find root causes, and provide specific fixes. This approach mirrors how experienced browser engineers debug complex rendering issues in production systems.\n\n### HTML/CSS Parsing Issues\n\nParse-time failures occur when the tokenization and tree construction algorithms encounter malformed input or implement the parsing specifications incorrectly. These issues manifest as incorrect DOM trees or CSS rule structures that cause downstream problems in layout and rendering. The challenge is distinguishing between malformed input that should be recovered from gracefully versus implementation bugs in the parsing logic itself.\n\n**Mental Model: The Document Scanner**\nThink of HTML/CSS parsing like a **document scanner with optical character recognition (OCR)**. The scanner reads characters sequentially and must recognize patterns (tags, selectors, properties) while handling damaged or unclear input. Just as OCR systems have confidence thresholds and error correction, parsers must implement recovery strategies when the input doesn't match expected patterns. The debugging process involves examining both the \"raw scan data\" (tokens) and the \"interpreted text\" (DOM/CSS structures) to identify where recognition failed.\n\n#### HTML Tokenization Debugging\n\nHTML tokenization problems typically occur in the state machine transitions where the `HTMLTokenizer` incorrectly identifies token boundaries or types. These issues are particularly common with edge cases like nested quotes, malformed attributes, or unexpected character sequences.\n\n| **Symptom** | **Likely Cause** | **Diagnostic Technique** | **Fix Strategy** |\n|-------------|------------------|--------------------------|------------------|\n| Missing text content between elements | Tokenizer incorrectly categorizing text as markup | Add logging to `next_token()` showing state transitions and character consumption | Check state transitions in `TokenizerState::Data` - ensure non-`<` characters stay in data state |\n| Attributes parsed as separate elements | Incorrect handling of whitespace in `TokenizerState::BeforeAttributeName` | Log attribute parsing sequence showing quote handling and boundary detection | Implement proper whitespace skipping and quote matching in attribute value parsing |\n| Self-closing tags treated as container elements | `VOID_ELEMENTS` list incomplete or `is_void` flag not checked | Verify element against `VOID_ELEMENTS` constant and log `is_void` determination | Ensure all HTML5 void elements are in the constant list and check during tree construction |\n| Text content includes raw HTML tags | Failure to transition from data state to tag parsing | Instrument state machine to show when `<` character triggers state change | Fix `TokenizerState::Data` to properly detect tag start and transition to `TokenizerState::TagOpen` |\n| Malformed attributes cause parser crash | Exception handling missing in attribute parsing | Wrap attribute parsing in `Result` types and log parsing attempts | Implement graceful degradation - skip malformed attributes but continue processing element |\n\nThe most effective debugging technique for tokenization is **state machine instrumentation**. Add logging that shows the current state, input character, and resulting state transition for every character processed. This reveals exactly where the state machine diverges from expected behavior.\n\n> **Key Insight**: Most tokenization bugs occur at state boundaries, particularly when handling unexpected characters in specific states. The HTML specification defines these transitions precisely, so any deviation indicates an implementation bug rather than ambiguous input.\n\n#### DOM Tree Construction Debugging\n\nTree construction errors occur when the `TreeBuilder` processes tokens correctly but builds an incorrect hierarchical structure. These problems often involve the **open elements stack** management, improper parent-child relationships, or failure to implement **foster parenting** for misplaced content.\n\n| **Symptom** | **Likely Cause** | **Diagnostic Technique** | **Fix Strategy** |\n|-------------|------------------|--------------------------|------------------|\n| Elements appear as siblings instead of parent-child | `open_elements` stack not properly maintained during `process_token()` | Log stack contents before/after each token and verify nesting depth matches HTML structure | Check `insert_element()` pushes to stack and `close_element()` properly pops matching elements |\n| Missing closing tags cause incorrect nesting | `close_element()` not handling implicit tag closure or mismatched tags | Trace element closure sequence and verify auto-closing logic for block elements | Implement `close_all_open_elements()` for implicit closure and handle mismatched end tags gracefully |\n| Text nodes attached to wrong parents | Foster parenting not implemented for table-related misplaced content | Check if text content appears inside table elements without proper cell containers | Implement `foster_parent_element()` to move misplaced content to appropriate ancestors |\n| Duplicate elements in final tree | Same DOM node reference added multiple times during tree construction | Verify `DOMNodeHandle` uniqueness and parent-child reference integrity | Ensure `append_child()` checks for existing parent before adding and updates references atomically |\n| Crash on deeply nested elements | Stack overflow in recursive tree traversal or unbounded `open_elements` growth | Monitor `open_elements` length and tree depth during parsing | Add maximum nesting depth limits and iterative traversal algorithms |\n\nTree construction debugging requires **hierarchical visualization**. Create a diagnostic function that prints the DOM tree structure with indentation showing parent-child relationships, and compare this output against the expected HTML structure.\n\n⚠️ **Pitfall: Reference Ownership Confusion**\nA common mistake is mixing owned references and borrowed references when building the DOM tree, leading to use-after-free errors or memory leaks. The `DOMNodeHandle` type must consistently represent either owned or borrowed references throughout tree construction. Fix this by establishing clear ownership rules: the `TreeBuilder` owns all nodes until construction completes, then transfers ownership to the final document root.\n\n#### CSS Tokenization and Rule Parsing\n\nCSS parsing failures typically occur in the tokenization phase where complex CSS syntax like nested selectors, media queries, or shorthand properties aren't handled correctly. Unlike HTML, CSS parsing must handle more diverse token types and complex grammar rules.\n\n| **Symptom** | **Likely Cause** | **Diagnostic Technique** | **Fix Strategy** |\n|-------------|------------------|--------------------------|------------------|\n| CSS rules completely ignored | Tokenizer not recognizing selector syntax or rule boundaries | Log `CSSToken` sequence and verify delimiter tokens (braces, semicolons) are identified | Check `CSSTokenizer` handles all delimiter types and `parse_rule()` finds rule boundaries correctly |\n| Property values parsed incorrectly | `parse_value()` not handling unit types or color formats | Trace value parsing showing input string, detected type, and final `CSSValue` | Implement robust value parsing for all `Unit` variants and `Color` formats including hex |\n| Selector specificity calculated wrong | `calculate_specificity()` not counting selector components correctly | Log specificity calculation showing individual counts for ids, classes, elements | Verify `Specificity` calculation matches CSS specification: (inline, ids, classes+attributes, elements) |\n| Multiple CSS rules create conflicting styles | Cascade resolution not ordering rules by specificity and source order | Display rule matching sequence for specific elements showing specificity comparison | Implement proper `compare()` method for `Specificity` and ensure `source_order` breaks ties |\n| CSS parsing stops at first error | Error recovery not implemented - parser fails on single malformed rule | Test parsing behavior with intentionally malformed CSS mixed with valid rules | Implement `skip_to_recovery_point()` to find next valid rule start and continue parsing |\n\nCSS debugging benefits from **rule tracing**: for any DOM element, log all CSS rules that match, their specificity calculations, and the final computed style after cascade resolution. This reveals where unexpected style conflicts occur.\n\n> **Architecture Decision: CSS Error Recovery Strategy**\n> - **Context**: CSS parsing can encounter malformed syntax that doesn't match the grammar, but the CSS specification requires parsers to recover gracefully rather than failing completely\n> - **Options Considered**: \n>   1. Fail-fast: Stop parsing on first error\n>   2. Rule-level recovery: Skip malformed rules, continue with next rule\n>   3. Property-level recovery: Skip malformed properties, continue with rest of rule\n> - **Decision**: Implement rule-level recovery with property-level fallback\n> - **Rationale**: CSS is designed to be fault-tolerant - browsers should render pages even with some invalid CSS. Rule-level recovery handles most common errors (typos, unsupported properties) while property-level recovery handles more complex syntax errors within rules.\n> - **Consequences**: Parsing is more robust but requires careful implementation of recovery points and error context tracking\n\n#### Entity Decoding and Character Handling\n\nCharacter-level parsing issues involve HTML entities, Unicode handling, and special character sequences. These problems often manifest as incorrect text content or parsing failures when encountering non-ASCII characters.\n\n| **Symptom** | **Likely Cause** | **Diagnostic Technique** | **Fix Strategy** |\n|-------------|------------------|--------------------------|------------------|\n| HTML entities appear as literal text | Entity decoder not implemented or `HTML_ENTITIES` table incomplete | Search for entity patterns in parsed text content and verify entity recognition | Implement entity decoder using `HTML_ENTITIES` lookup table and handle numeric entities |\n| Non-ASCII characters cause parsing errors | Character encoding assumptions or Unicode handling issues | Log character codes and encoding detection for problematic input | Ensure parser handles UTF-8 encoding and validates character sequences |\n| Quote characters in attributes break parsing | Quote escaping not handled in attribute value parsing | Test with mixed single/double quotes and escaped quote sequences | Implement proper quote matching and escape sequence handling in attribute parsing |\n| Whitespace handling inconsistent | Normalization rules not applied consistently across text content | Compare whitespace preservation in different parsing contexts | Apply HTML5 whitespace normalization rules: collapse consecutive whitespace, trim leading/trailing |\n\n### Layout Calculation Problems\n\nLayout issues occur when the **box model** calculations, **formatting context** algorithms, or **constraint resolution** produce incorrect element positions and sizes. These problems are particularly challenging because they often result from the complex interactions between multiple CSS properties and the inheritance hierarchy.\n\n**Mental Model: The Blueprint Architect**\nThink of layout calculation like an **architect creating construction blueprints** from a building design. The architect must translate design specifications (CSS properties) into precise measurements and positions (layout coordinates) while respecting physical constraints (available space, structural requirements). When buildings don't match the original design, the problem could be measurement errors, constraint violations, or misunderstanding the design specifications. Layout debugging follows the same pattern: verify measurements, check constraints, and validate algorithmic understanding.\n\n#### Box Model Calculation Issues\n\nBox model problems involve incorrect computation of the margin, border, padding, and content rectangles that define each element's spatial extent. These calculations must handle complex interactions between explicit dimensions, `auto` values, percentage units, and **available space** constraints.\n\n| **Symptom** | **Likely Cause** | **Diagnostic Technique** | **Fix Strategy** |\n|-------------|------------------|--------------------------|------------------|\n| Elements larger or smaller than expected | Box model rectangles not accounting for all margin/border/padding | Log complete box model calculation showing content, padding, border, margin rectangles | Verify `calculate_box_model()` computes all four rectangles and `LayoutBox` stores them correctly |\n| Percentage widths calculated incorrectly | Containing block width not passed correctly to percentage resolution | Trace percentage calculation showing parent width, percentage value, and computed result | Ensure containing block size passed to `calculate_box_model()` and percentage conversion handles edge cases |\n| Auto margins not centering elements | Auto margin resolution algorithm not implemented or incorrect | Log margin resolution showing available space, content width, and computed margin values | Implement CSS auto margin centering: `(available_width - content_width) / 2` for left and right margins |\n| Elements overflow their containers | Max-width/min-width constraints not enforced or over-constraint resolution wrong | Check element dimensions against container size and trace constraint satisfaction | Implement `resolve_over_constraint()` to handle impossible dimension combinations with CSS priority rules |\n| Margin collapsing not working | Adjacent margin collapse algorithm missing or block context detection wrong | Compare adjacent element margins before/after collapse and verify block formatting context | Implement `calculate_margin_collapse()` for adjacent vertical margins in same block formatting context |\n\nBox model debugging requires **dimensional visualization**. Create diagnostic output that shows each element as nested rectangles representing margin (outermost), border, padding, and content (innermost) areas with their computed dimensions and positions.\n\n⚠️ **Pitfall: Percentage Circular Dependencies**\nA common layout bug occurs when percentage dimensions create circular dependencies: a parent's size depends on its children, but children's percentage dimensions depend on the parent's size. This manifests as incorrect sizes or infinite loops in layout calculation. The fix requires implementing a multi-pass layout algorithm that resolves explicit dimensions first, then uses those to resolve percentage dimensions in dependent elements.\n\n#### Block Layout and Vertical Positioning\n\nBlock formatting context issues involve incorrect vertical positioning of child elements, improper margin collapsing behavior, or failure to handle **available space** constraints correctly. Block layout is the foundation of most web page layouts, so errors here affect almost all elements.\n\n| **Symptom** | **Likely Cause** | **Diagnostic Technique** | **Fix Strategy** |\n|-------------|------------------|--------------------------|------------------|\n| Child elements positioned incorrectly vertically | `layout_block_children()` not accumulating y-positions or handling margin collapsing | Log y-position calculation for each child showing previous sibling position, margins, and final position | Verify block layout algorithm maintains running y-offset and applies margin collapsing between siblings |\n| Elements overlap vertically | Margin collapsing calculated incorrectly or negative margins not handled | Visual diff showing expected vs actual element positions and margin calculations | Implement proper margin collapsing rules: adjacent positive/negative margins collapse, non-adjacent don't collapse |\n| Container height incorrect | Block container not expanding to contain all child elements or intrinsic height wrong | Compare container height to sum of child heights plus margins | Ensure block container height includes all child content plus collapsed margins |\n| Float elements disrupt normal flow | Float positioning not implemented or clearance calculations wrong | Check if float elements are removed from normal document flow and positioned correctly | Implement float positioning as separate phase after normal flow layout |\n| Text baseline alignment wrong | Line height calculation or text metrics incorrect | Log text positioning showing baseline, ascent, descent, and line height values | Verify `TextMetrics` calculation and baseline alignment in `LineBox` construction |\n\nBlock layout debugging benefits from **flow visualization**: create output showing the document flow with each element's position in the coordinate system and the available space passed to child elements.\n\n#### Inline Layout and Text Flow\n\nInline formatting context problems involve incorrect horizontal text flow, line breaking failures, or improper baseline alignment of inline elements. Inline layout is more complex than block layout because it must handle variable-width content and dynamic line wrapping.\n\n| **Symptom** | **Likely Cause** | **Diagnostic Technique** | **Fix Strategy** |\n|-------------|------------------|--------------------------|------------------|\n| Text doesn't wrap at container boundaries | Line breaking algorithm not implemented or `find_line_break_opportunity()` incorrect | Log line breaking decisions showing available width, text width, and break points | Implement proper line breaking at word boundaries with fallback to character breaking |\n| Inline elements positioned incorrectly | Baseline alignment wrong or `LineBox` construction flawed | Trace inline layout showing baseline calculation, element metrics, and final positions | Verify `LineBox` baseline calculation and `InlineElement` positioning relative to baseline |\n| Text overlaps or has incorrect spacing | Character width measurement wrong or font metrics unavailable | Log `TextMetrics` for sample text and verify character advance width calculation | Implement proper text measurement using `SimpleTextMeasurer` or platform font metrics |\n| Mixed inline content alignment wrong | Block elements inside inline context not handled or line height calculation wrong | Check mixed content handling and verify line height encompasses all inline elements | Implement proper line height calculation as max of all inline element heights plus leading |\n| Long words break layout | No fallback to character-level breaking when word-level breaking fails | Test with very long words that exceed container width | Add character-level breaking fallback when no word boundaries available within line width |\n\nInline layout debugging requires **line-by-line analysis**: show how text and inline elements are distributed across lines, with measurements for each element's contribution to line width and height.\n\n> **Key Insight**: Inline layout bugs often stem from incorrect font metrics or text measurement. Unlike block layout where dimensions are computed from CSS properties, inline layout depends heavily on actual text rendering measurements that vary by font, size, and platform.\n\n#### Constraint Resolution and Edge Cases\n\nComplex layout scenarios involve multiple interacting constraints that can create impossible or ambiguous situations. The CSS specification defines resolution algorithms for these **over-constraint** cases, but implementation bugs are common due to the complexity of constraint prioritization.\n\n| **Symptom** | **Likely Cause** | **Diagnostic Technique** | **Fix Strategy** |\n|-------------|------------------|--------------------------|------------------|\n| Elements ignore width/height constraints | Min/max width constraints not implemented or constraint priorities wrong | Log constraint resolution showing all width-related properties and final computed value | Implement CSS constraint resolution: min-width overrides width, max-width overrides min-width |\n| Absolutely positioned elements wrong | Absolute positioning not removing elements from normal flow or position calculation incorrect | Trace absolute positioning showing offset values, containing block, and final coordinates | Implement absolute positioning with proper containing block identification and offset calculation |\n| Flexbox or grid layout broken | Complex layout modes not implemented or interaction with normal flow incorrect | Compare expected vs actual layout for flex/grid containers and their children | Focus on block/inline layout first - advanced layout modes are beyond basic browser scope |\n| Performance degradation with large documents | Layout algorithm has poor time complexity or redundant calculations | Profile layout calculation time and identify bottlenecks in layout tree traversal | Optimize layout algorithm to avoid redundant calculations and use incremental layout updates |\n| Memory usage grows unboundedly | Layout tree retains references to old layouts or intermediate calculations not cleaned up | Monitor memory usage during layout and identify retained references | Implement proper cleanup of intermediate layout state and reuse layout boxes where possible |\n\n### Rendering and Visual Issues\n\nRendering problems occur when the **display list** generation or **graphics backend** integration fails to produce correct visual output. These issues are often the most visible to end users but can be caused by problems anywhere in the pipeline, making diagnosis challenging.\n\n**Mental Model: The Art Gallery Curator**\nThink of rendering like a **museum curator organizing an art exhibition**. The curator must arrange artworks (layout boxes) in the gallery space (viewport) according to a planned layout, ensuring proper lighting (colors), appropriate positioning (coordinates), and correct viewing order (z-index). When visitors see problems with the exhibition - missing pieces, wrong positions, poor lighting - the curator must trace back through the planning process to find where the arrangement went wrong. Rendering debugging follows this same systematic approach from visual symptoms back to root causes.\n\n#### Paint Command Generation Issues\n\nDisplay list generation problems occur when the traversal of the `LayoutTree` fails to generate correct `PaintCommand` sequences or when the paint order doesn't match the expected visual stacking order. These issues manifest as missing visual elements, incorrect colors, or wrong z-ordering.\n\n| **Symptom** | **Likely Cause** | **Diagnostic Technique** | **Fix Strategy** |\n|-------------|------------------|--------------------------|------------------|\n| Elements completely missing from rendered output | `generate_display_list()` not traversing entire layout tree or skipping certain box types | Log display list generation showing which layout boxes generate paint commands | Verify layout tree traversal visits all nodes and generates commands for visible `BoxType` variants |\n| Background colors not appearing | `DrawRectangle` commands not generated for background or color values incorrect | Examine display list for background paint commands and verify `Color` values | Generate `DrawRectangle` commands for all elements with non-transparent background colors |\n| Element borders missing or wrong | `DrawBorder` commands not generated or border width/color calculation wrong | Check border paint command generation and verify border properties from `ComputedStyle` | Generate `DrawBorder` commands for all four border sides with correct width, color, and position |\n| Text content invisible | `DrawText` commands missing or text positioning incorrect | Trace text rendering showing font selection, positioning, and color | Generate `DrawText` commands for all text nodes with proper baseline positioning and font metrics |\n| Elements appear in wrong stacking order | Paint command order incorrect or z-index not implemented | Compare expected vs actual paint order in display list | Implement proper paint order: backgrounds first, borders second, content last, respecting z-index |\n\nPaint command debugging requires **command sequence analysis**: examine the generated `DisplayList` and verify that paint commands appear in the correct order and with the expected parameters.\n\n⚠️ **Pitfall: Coordinate System Confusion**\nA common rendering bug involves mixing different coordinate systems - layout coordinates (relative to document), viewport coordinates (relative to visible area), and graphics coordinates (relative to canvas). This manifests as elements appearing in completely wrong positions. The fix requires establishing consistent coordinate transformation throughout the rendering pipeline and documenting which coordinate system each component expects.\n\n#### Graphics Backend Integration Problems\n\nGraphics backend issues involve the interface between the browser engine's paint commands and the underlying graphics system (Canvas, OpenGL, DirectX, etc.). These problems often appear as visual corruption, performance issues, or rendering failures under specific conditions.\n\n| **Symptom** | **Likely Cause** | **Diagnostic Technique** | **Fix Strategy** |\n|-------------|------------------|--------------------------|------------------|\n| Rendering produces blank or corrupted output | Graphics context not initialized properly or command translation incorrect | Test graphics backend directly with simple commands to isolate browser vs graphics issues | Implement `render_with_fallback()` with progressive degradation to software rendering |\n| Text rendering fails or shows wrong fonts | Font loading failure or font fallback chain not implemented | Test text rendering with different fonts and log font loading success/failure | Implement `handle_font_failure()` with system font fallback and basic text measurement |\n| Colors appear wrong or corrupted | Color space conversion errors or graphics backend color format mismatch | Test color rendering with known values and compare expected vs actual output | Ensure `Color` values are converted correctly to graphics backend format (RGB vs RGBA, color space) |\n| Performance degrades with complex layouts | Graphics operations not batched or excessive draw calls | Profile rendering performance and identify bottlenecks in graphics operations | Implement command batching for similar operations and viewport culling for off-screen elements |\n| Memory leaks during rendering | Graphics resources not cleaned up or command buffers growing unboundedly | Monitor memory usage during extended rendering and identify resource leaks | Implement proper resource cleanup and display list reuse for similar content |\n\nGraphics debugging often requires **external validation**: render the same content with a reference implementation or graphics debugger to verify that the problem is in the browser engine rather than the underlying graphics system.\n\n#### Visual Debugging and Diagnostic Tools\n\nVisual debugging involves creating diagnostic visualizations that reveal the internal state of the rendering pipeline. These tools are essential for understanding complex rendering problems that aren't apparent from code inspection alone.\n\n| **Debug Visualization** | **Purpose** | **Implementation** | **Usage** |\n|------------------------|-------------|-------------------|-----------|\n| Layout box outlines | Show computed box model rectangles for each element | Add debug paint commands that draw colored outlines for margin, border, padding, content | Identify box model calculation errors and positioning problems |\n| Text baseline guides | Show line boxes and baseline alignment for text content | Draw horizontal lines at baseline positions and text metrics boundaries | Debug text positioning and line height calculations |\n| Paint command sequence | Show order and parameters of all paint commands in display list | Log or visualize paint command sequence with element identification | Debug paint order problems and missing visual elements |\n| Coordinate system grid | Show document coordinate system and viewport boundaries | Draw grid lines at regular intervals with coordinate labels | Debug coordinate transformation and positioning calculations |\n| Style cascade visualization | Show which CSS rules apply to specific elements and their precedence | Create detailed style reports showing matched rules, specificity, and computed values | Debug CSS cascade and specificity calculation problems |\n\n> **Architecture Decision: Rendering Fallback Strategy**\n> - **Context**: Graphics operations can fail due to driver issues, memory pressure, or hardware limitations, but the browser should continue functioning rather than crashing\n> - **Options Considered**:\n>   1. Fail-hard: Crash or stop rendering when graphics operations fail\n>   2. Silent failure: Skip failed operations and continue with partial rendering\n>   3. Progressive fallback: Degrade to simpler rendering techniques when advanced operations fail\n> - **Decision**: Implement progressive fallback with multiple fallback levels\n> - **Rationale**: Browser engines must be extremely robust - users expect web pages to render even on limited hardware or with driver problems. Progressive fallback allows graceful degradation while maintaining core functionality.\n> - **Consequences**: Requires implementing multiple rendering backends and fallback detection, but provides much better user experience under adverse conditions\n\n#### Clipping and Viewport Management\n\nClipping and viewport issues involve incorrect handling of element visibility, coordinate transformations between document and viewport space, and optimization of off-screen content. These problems affect both correctness and performance.\n\n| **Symptom** | **Likely Cause** | **Diagnostic Technique** | **Fix Strategy** |\n|-------------|------------------|--------------------------|------------------|\n| Elements render outside their containers | Clipping not implemented or clipping boundaries incorrect | Verify clipping rectangle calculation and `SetClip`/`ClearClip` command generation | Implement proper clipping context management with nested clipping support |\n| Off-screen elements still rendered | Viewport culling not implemented or visibility detection wrong | Log which elements are considered visible and compare with actual viewport bounds | Implement viewport intersection testing and skip paint command generation for invisible elements |\n| Scrolling broken or coordinates wrong | Coordinate transformation between document and viewport incorrect | Test coordinate conversion at various scroll positions and zoom levels | Implement proper coordinate transformation accounting for viewport offset |\n| Performance poor with large documents | No optimization for off-screen content or excessive overdraw | Profile rendering with large documents and measure draw call efficiency | Implement viewport culling and overdraw elimination to skip invisible content |\n| Nested clipping wrong | Clipping context stack not maintained properly or intersection calculation incorrect | Test nested elements with overflow hidden and verify clipping behavior | Maintain clipping context stack and properly intersect nested clipping rectangles |\n\n### Implementation Guidance\n\nThis debugging system requires systematic diagnostic infrastructure throughout the browser engine. The key is building observability into each pipeline stage so that problems can be traced from symptoms back to root causes.\n\n#### Technology Recommendations\n\n| **Component** | **Simple Option** | **Advanced Option** |\n|---------------|-------------------|-------------------|\n| Logging Infrastructure | `println!` macros with debug levels | `env_logger` with structured logging |\n| DOM Tree Visualization | Text-based tree printing with indentation | HTML output with interactive tree explorer |\n| Layout Box Debugging | Console output of box model calculations | Visual overlay showing box boundaries |\n| Paint Command Analysis | Text-based command listing | Graphical display list viewer |\n| Performance Profiling | Basic timing with `std::time::Instant` | `perf` integration with flame graphs |\n\n#### Recommended File Structure\n\n```\nsrc/\n  debug/\n    mod.rs                    ← debug infrastructure exports\n    tree_visualizer.rs        ← DOM and layout tree printing\n    paint_debugger.rs         ← display list analysis tools\n    style_tracer.rs           ← CSS cascade debugging\n    layout_inspector.rs       ← box model visualization\n    error_reporter.rs         ← centralized error reporting\n  parser/\n    html_parser.rs           ← add parse debugging here\n    css_parser.rs            ← add tokenization logging here  \n  layout/\n    layout_engine.rs         ← add box model debugging here\n  rendering/\n    render_engine.rs         ← add paint command logging here\n  lib.rs                     ← conditional debug feature compilation\n```\n\n#### Error Reporting Infrastructure\n\n```rust\n// Centralized error reporting with context preservation\npub struct DebugContext {\n    component: String,\n    operation: String,\n    input_sample: String,\n    stack_trace: Vec<String>,\n}\n\nimpl DebugContext {\n    pub fn new(component: &str, operation: &str) -> Self {\n        DebugContext {\n            component: component.to_string(),\n            operation: operation.to_string(),\n            input_sample: String::new(),\n            stack_trace: Vec::new(),\n        }\n    }\n    \n    pub fn with_input(&mut self, input: &str) -> &mut Self {\n        self.input_sample = input.chars().take(100).collect();\n        self\n    }\n    \n    pub fn add_stack_frame(&mut self, frame: &str) -> &mut Self {\n        self.stack_trace.push(frame.to_string());\n        self\n    }\n}\n\npub fn report_parse_error(error: &ParseError, context: &DebugContext) {\n    eprintln!(\"PARSE ERROR in {}/{}: {:?}\", context.component, context.operation, error);\n    eprintln!(\"Input sample: '{}'\", context.input_sample);\n    eprintln!(\"Call stack: {}\", context.stack_trace.join(\" -> \"));\n    \n    // TODO: Add specific diagnostic hints based on error type\n    // TODO: Log to structured error database for pattern analysis\n}\n```\n\n#### HTML/CSS Parse Debugging Tools\n\n```rust\n// HTML tokenization diagnostics\npub struct TokenizerDebugger {\n    log_state_transitions: bool,\n    log_token_generation: bool,\n    current_input_position: usize,\n}\n\nimpl TokenizerDebugger {\n    pub fn log_state_transition(&self, from_state: TokenizerState, to_state: TokenizerState, \n                               input_char: char, position: usize) {\n        if self.log_state_transitions {\n            println!(\"Tokenizer @{}: '{}' ({:?} -> {:?})\", \n                    position, input_char, from_state, to_state);\n        }\n    }\n    \n    pub fn log_token_generated(&self, token: &HTMLToken, position: usize) {\n        if self.log_token_generation {\n            println!(\"Token @{}: {:?}\", position, token);\n        }\n    }\n    \n    // TODO: Add method to dump tokenizer state for debugging crashes\n    // TODO: Add method to validate token sequence correctness\n    // TODO: Add method to compare tokens against reference implementation\n}\n\n// DOM tree structure visualization  \npub fn print_dom_tree(node: &DOMNode, indent: usize) {\n    let indent_str = \"  \".repeat(indent);\n    match &node.node_data {\n        DOMNodeData::Element(element) => {\n            println!(\"{}Element: {} (attributes: {:?})\", \n                    indent_str, element.tag_name, element.attributes);\n        }\n        DOMNodeData::Text(text) => {\n            println!(\"{}Text: '{}'\", indent_str, \n                    text.content.chars().take(50).collect::<String>());\n        }\n        DOMNodeData::Document(_) => {\n            println!(\"{}Document\", indent_str);\n        }\n    }\n    \n    for child in &node.children {\n        // TODO: Get child node from handle and recurse\n        // TODO: Add cycle detection to prevent infinite loops\n        // TODO: Add maximum depth limit for very large trees\n    }\n}\n```\n\n#### Layout Debugging Infrastructure\n\n```rust\n// Box model visualization and validation\npub struct LayoutDebugger {\n    show_box_outlines: bool,\n    log_calculations: bool,\n    validate_constraints: bool,\n}\n\nimpl LayoutDebugger {\n    pub fn log_box_calculation(&self, element: &str, computed_style: &ComputedStyle, \n                              containing_block: Size, result: &LayoutBox) {\n        if self.log_calculations {\n            println!(\"Layout {}: CB({:.1}x{:.1}) -> Content({:.1}x{:.1})\", \n                    element, containing_block.width, containing_block.height,\n                    result.content_rect.size.width, result.content_rect.size.height);\n            println!(\"  Margin: {:.1}/{:.1}/{:.1}/{:.1}\", \n                    result.margin_rect.origin.y - result.border_rect.origin.y,\n                    result.border_rect.origin.x + result.border_rect.size.width - result.margin_rect.origin.x - result.margin_rect.size.width,\n                    result.margin_rect.origin.y + result.margin_rect.size.height - result.border_rect.origin.y - result.border_rect.size.height,\n                    result.border_rect.origin.x - result.margin_rect.origin.x);\n        }\n    }\n    \n    pub fn validate_box_model(&self, layout_box: &LayoutBox) -> Vec<String> {\n        let mut errors = Vec::new();\n        \n        // TODO: Validate that content_rect is inside padding_rect\n        // TODO: Validate that padding_rect is inside border_rect  \n        // TODO: Validate that border_rect is inside margin_rect\n        // TODO: Check for negative dimensions or positions\n        // TODO: Verify box dimensions match computed style expectations\n        \n        errors\n    }\n    \n    // Generate paint commands for debugging overlays\n    pub fn generate_debug_overlay(&self, layout_box: &LayoutBox) -> Vec<PaintCommand> {\n        let mut commands = Vec::new();\n        \n        if self.show_box_outlines {\n            // TODO: Add DrawRectangle command for margin outline (red)\n            // TODO: Add DrawRectangle command for border outline (blue)  \n            // TODO: Add DrawRectangle command for padding outline (green)\n            // TODO: Add DrawRectangle command for content outline (yellow)\n        }\n        \n        commands\n    }\n}\n```\n\n#### Rendering Pipeline Diagnostics\n\n```rust\n// Display list analysis and validation\npub struct RenderDebugger {\n    log_paint_commands: bool,\n    validate_coordinates: bool,\n    measure_performance: bool,\n}\n\nimpl RenderDebugger {\n    pub fn analyze_display_list(&self, display_list: &DisplayList) -> RenderingReport {\n        let mut report = RenderingReport::new();\n        \n        for (i, command) in display_list.commands.iter().enumerate() {\n            if self.log_paint_commands {\n                println!(\"Paint[{}]: {:?}\", i, command);\n            }\n            \n            if self.validate_coordinates {\n                match command {\n                    PaintCommand::DrawRectangle { rect, .. } => {\n                        // TODO: Check if rectangle is within viewport bounds\n                        // TODO: Validate that coordinates are not NaN or infinite\n                        // TODO: Warn about rectangles with zero or negative dimensions\n                    }\n                    PaintCommand::DrawText { position, .. } => {\n                        // TODO: Check if text position is within reasonable bounds\n                        // TODO: Validate text baseline positioning\n                    }\n                    _ => {}\n                }\n            }\n        }\n        \n        report\n    }\n    \n    // TODO: Method to compare display list against reference implementation\n    // TODO: Method to measure rendering performance and identify bottlenecks\n    // TODO: Method to detect common paint order problems\n}\n\npub struct RenderingReport {\n    command_count: usize,\n    coordinate_warnings: Vec<String>,\n    performance_metrics: Option<RenderingMetrics>,\n}\n\npub struct RenderingMetrics {\n    paint_command_generation_time: std::time::Duration,\n    graphics_backend_time: std::time::Duration,\n    total_rendering_time: std::time::Duration,\n}\n```\n\n#### Milestone Validation Checkpoints\n\n**Milestone 1 Checkpoint (HTML Parser):**\n```bash\ncargo test html_parser_tests\n```\nExpected output: All tokenization and tree construction tests pass. Run with malformed HTML samples and verify graceful error recovery. Check DOM tree structure matches expected hierarchy.\n\n**Milestone 2 Checkpoint (CSS Parser):**  \n```bash\ncargo test css_parser_tests\n```\nExpected output: CSS rule parsing and specificity calculation tests pass. Test with malformed CSS and verify error recovery. Check computed styles match expected cascade resolution.\n\n**Milestone 3 Checkpoint (Layout):**\n```bash\ncargo test layout_engine_tests  \n```\nExpected output: Box model and positioning tests pass. Test with percentage dimensions and margin collapsing cases. Verify layout tree coordinates are correct.\n\n**Milestone 4 Checkpoint (Rendering):**\n```bash\ncargo test render_engine_tests\n```\nExpected output: Display list generation and rendering tests pass. Visual output should match reference images. Test with different viewport sizes and element combinations.\n\nSigns of problems and debugging steps:\n- **Parse tests failing**: Enable tokenizer debugging, check state transitions\n- **Layout coordinates wrong**: Enable box model logging, verify containing block calculations  \n- **Visual output incorrect**: Examine display list, check paint command generation\n- **Performance issues**: Profile with timing measurements, identify bottlenecks\n\n\n## Future Extensions and Advanced Features\n\n> **Milestone(s):** All milestones (1-4) - This section provides a roadmap for extending the browser engine beyond the core implementation, building upon the foundational HTML parsing, CSS parsing, layout computation, and rendering systems established in the previous milestones.\n\nBuilding a functional browser engine through the four core milestones represents just the beginning of the journey into modern web rendering technology. Think of our current implementation as a sturdy foundation house - it provides the essential structure and functionality needed for basic habitation, but there's enormous potential for expansion and enhancement. The real-world web demands sophisticated features like flexible layout systems, dynamic content updates, smooth animations, and high-performance rendering that can handle complex documents with thousands of elements.\n\nThis section serves as an architectural roadmap for transforming our basic browser engine into a more capable system. We'll explore two critical dimensions of advancement: feature sophistication and performance optimization. Feature sophistication involves implementing advanced CSS layout modes like Flexbox and Grid, supporting CSS transforms and animations, and potentially integrating JavaScript execution. Performance optimization focuses on making our engine fast and scalable enough to handle real-world web content through techniques like incremental rendering, layout caching, and multi-threaded processing.\n\nThe extensions outlined here follow a principle of **progressive enhancement** - each addition builds naturally upon our existing architecture without requiring fundamental rewrites. Our modular design with clear separation between parsing, styling, layout, and rendering stages provides natural extension points for new features. The key insight is that advanced features typically involve either extending our CSS property vocabulary and layout algorithms, or optimizing our data flow and computation strategies.\n\n### Advanced CSS Features\n\nThink of advanced CSS features as specialized tools in a master craftsperson's workshop. While our current implementation provides the basic tools - hammer, saw, screwdriver - advanced CSS features are like precision instruments that enable much more sophisticated and flexible creations. Just as a craftsperson gradually acquires specialized tools as their skills develop, our browser engine can incrementally support advanced CSS features that dramatically expand its layout and rendering capabilities.\n\nThe modern web relies heavily on advanced CSS layout modes that go far beyond the simple block and inline formatting contexts we've implemented. **Flexbox** enables flexible, responsive layouts where elements can grow, shrink, and align themselves intelligently within containers. **CSS Grid** provides two-dimensional layout control with precise positioning and responsive behavior. **CSS transforms** allow elements to be rotated, scaled, and positioned in 3D space without affecting document layout. **CSS animations and transitions** enable smooth visual changes over time, creating engaging user experiences.\n\nThese advanced features share several common architectural patterns that make them natural extensions to our existing system. They typically involve extending our CSS parser to recognize new properties and values, enhancing our style resolution system to compute new types of computed styles, implementing specialized layout algorithms that operate alongside our existing block and inline formatters, and extending our rendering engine to handle new visual effects.\n\n#### Flexbox Layout Implementation\n\n**Flexbox** represents one of the most transformative layout modes in modern CSS. Unlike our current block layout that simply stacks elements vertically, Flexbox provides intelligent space distribution, flexible sizing, and powerful alignment capabilities along both main and cross axes.\n\n> **Decision: Flexbox Integration Strategy**\n> - **Context**: Flexbox requires fundamentally different layout logic than block/inline formatting, but should integrate seamlessly with our existing layout tree\n> - **Options Considered**: \n>   - Separate flexbox-specific layout tree\n>   - Extend existing `LayoutBox` with flexbox-specific fields\n>   - Create specialized flexbox layout context within existing system\n> - **Decision**: Create specialized flexbox layout context within existing system\n> - **Rationale**: Maintains architectural consistency, reuses existing infrastructure for style resolution and rendering, allows mixed layout modes in same document\n> - **Consequences**: Requires extending `BoxType` enum and implementing new layout algorithms, but preserves existing APIs and data flow\n\nThe flexbox implementation extends our existing layout system with new computed style properties and specialized layout algorithms. Our `ComputedStyle` struct needs enhancement to include flexbox-specific properties:\n\n| Property | Type | Description |\n|----------|------|-------------|\n| flex_direction | FlexDirection | Main axis direction (row, column, row-reverse, column-reverse) |\n| flex_wrap | FlexWrap | Whether flex items wrap to new lines (nowrap, wrap, wrap-reverse) |\n| justify_content | JustifyContent | Alignment along main axis (flex-start, center, space-between, etc.) |\n| align_items | AlignItems | Alignment along cross axis (stretch, center, flex-start, etc.) |\n| flex_grow | f32 | Growth factor for available space distribution |\n| flex_shrink | f32 | Shrink factor when space is insufficient |\n| flex_basis | ComputedLength | Initial size before free space distribution |\n\nThe flexbox layout algorithm operates in distinct phases that replace our simple vertical stacking approach. First, we collect all flex items and determine the main and cross axis dimensions based on `flex_direction`. Second, we resolve flex basis values and calculate total hypothetical main size. Third, we distribute available space among flex items based on their `flex_grow` and `flex_shrink` factors. Fourth, we align items along the cross axis according to `align_items` and individual `align_self` values. Fifth, we handle line wrapping if `flex_wrap` is enabled, potentially creating multiple flex lines. Finally, we position all items and update their final rectangles in the layout tree.\n\n| Algorithm Step | Input | Processing | Output |\n|----------------|-------|------------|--------|\n| Flex Item Collection | Layout box with `display: flex` | Identify immediate children as flex items | List of flex items with initial sizes |\n| Main/Cross Axis Resolution | `flex_direction` property | Determine which dimension is main vs cross | Axis orientation and available space |\n| Flex Basis Resolution | `flex_basis`, `width`, `height` properties | Calculate initial item sizes before space distribution | Hypothetical main size for each item |\n| Space Distribution | Available space, `flex_grow`, `flex_shrink` | Distribute extra space or absorb overflow | Final main size for each flex item |\n| Cross Axis Alignment | `align_items`, `align_self`, container height | Position items perpendicular to main axis | Cross axis positions and sizes |\n| Line Wrapping | `flex_wrap`, total item sizes | Create additional flex lines if needed | Multiple flex lines with item assignments |\n\nA concrete walkthrough illustrates the flexbox algorithm complexity. Consider a flex container with 400px width containing three items: Item A (`flex: 1 0 100px`), Item B (`flex: 2 0 50px`), and Item C (`flex: 0 1 200px`). First, we calculate total flex basis: 100 + 50 + 200 = 350px, leaving 50px of free space. Second, we sum flex-grow factors: 1 + 2 + 0 = 3. Third, we distribute free space proportionally: Item A gets 50 * (1/3) = 16.67px, Item B gets 50 * (2/3) = 33.33px, Item C gets 0px. Final sizes become: Item A = 116.67px, Item B = 83.33px, Item C = 200px. This demonstrates how flexbox intelligently distributes available space based on item preferences.\n\n> The critical insight with flexbox implementation is that it requires a fundamentally different mental model from block layout. Instead of positioning items sequentially, flexbox operates more like a constraint satisfaction system where available space is distributed according to item flexibility preferences and alignment constraints.\n\n#### CSS Grid Layout System\n\n**CSS Grid** provides the most sophisticated layout capabilities in modern CSS, enabling precise two-dimensional positioning with responsive behavior. Think of CSS Grid as an architect's blueprint system - instead of stacking blocks or flowing content like our current layout modes, Grid allows explicit placement of elements in a defined grid structure with named areas, flexible track sizing, and complex alignment options.\n\nGrid layout introduces several new concepts that extend our layout system architecture. **Grid tracks** define the rows and columns of the grid with flexible sizing options. **Grid areas** provide named regions for element placement. **Grid lines** create the boundary structure that defines track edges. **Grid gaps** add consistent spacing between tracks. These concepts require significant extensions to our data model and layout algorithms.\n\nThe grid implementation requires new CSS property support and layout data structures:\n\n| Grid Property | Type | Description |\n|---------------|------|-------------|\n| grid_template_columns | Vec<TrackSize> | Column track definitions with sizing functions |\n| grid_template_rows | Vec<TrackSize> | Row track definitions with sizing functions |\n| grid_template_areas | Vec<Vec<String>> | Named grid areas as 2D string matrix |\n| grid_column_gap | ComputedLength | Spacing between column tracks |\n| grid_row_gap | ComputedLength | Spacing between row tracks |\n| grid_column | GridPosition | Item placement in column dimension |\n| grid_row | GridPosition | Item placement in row dimension |\n| grid_area | String | Named area for item placement |\n\nThe Grid layout algorithm operates through several sophisticated phases. First, we parse grid track definitions and resolve sizing functions like `fr` units, `minmax()` constraints, and `repeat()` patterns. Second, we build the explicit grid structure from template definitions and identify any implicit tracks needed for item placement. Third, we place grid items either through explicit positioning properties or automatic placement algorithms. Fourth, we resolve track sizes through a complex constraint satisfaction process that handles minimum/maximum constraints, flexible `fr` units, and content-based sizing. Fifth, we calculate final positions and sizes for all grid items based on resolved track dimensions and gap spacing.\n\n| Grid Sizing Function | Syntax | Behavior | Use Case |\n|---------------------|---------|----------|----------|\n| Fixed Size | `100px`, `20em` | Absolute track size | Headers, sidebars with known dimensions |\n| Fractional Unit | `1fr`, `2fr` | Proportional share of available space | Flexible content areas |\n| Min-Max Constraint | `minmax(100px, 1fr)` | Bounded flexible sizing | Responsive columns with minimum width |\n| Content-Based | `min-content`, `max-content` | Size based on item content | Tables, flexible text content |\n| Fit-Content | `fit-content(200px)` | Content size clamped to maximum | Responsive containers |\n\nGrid's **track sizing algorithm** represents one of the most complex layout calculations in CSS. The algorithm processes tracks in multiple passes, first resolving fixed sizes, then minimum constraints, then distributing flexible space among `fr` units while respecting `minmax()` bounds. This requires implementing a constraint satisfaction solver that can handle circular dependencies and optimization objectives.\n\n#### CSS Transforms and 3D Positioning\n\n**CSS transforms** enable visual manipulation of elements without affecting document layout flow. Think of transforms as a camera lens system - elements maintain their original layout positions, but we apply visual filters that can rotate, scale, translate, and even position elements in 3D space. This separation between layout position and visual position is crucial for performance and animation capabilities.\n\nTransform implementation extends our rendering pipeline with new visual effects that operate after layout calculation. Our `ComputedStyle` needs transform-specific properties:\n\n| Transform Property | Type | Description |\n|-------------------|------|-------------|\n| transform | Vec<TransformFunction> | List of transform functions to apply |\n| transform_origin | Point | Point around which transforms are applied |\n| perspective | Option<f32> | 3D perspective distance for child elements |\n| transform_style | TransformStyle | Whether children participate in 3D context |\n\nTransform functions represent individual transformation operations that combine through matrix multiplication:\n\n| Transform Function | Parameters | Matrix Effect | Visual Result |\n|-------------------|------------|---------------|---------------|\n| `translate(x, y)` | x: Length, y: Length | Translation matrix | Element repositioning |\n| `rotate(angle)` | angle: Angle | Rotation matrix | Element rotation around origin |\n| `scale(x, y)` | x: f32, y: f32 | Scaling matrix | Element size multiplication |\n| `skew(x, y)` | x: Angle, y: Angle | Skew matrix | Element distortion |\n| `matrix(a,b,c,d,e,f)` | 6 matrix values | Direct matrix | Custom transformation |\n\nThe transform rendering process involves matrix composition and coordinate space conversion. Each element with transforms creates a new coordinate space for its children. We compute the cumulative transformation matrix by multiplying all transform functions in order, then apply this matrix during paint command generation to convert element-local coordinates to screen coordinates. 3D transforms require additional complexity with z-coordinate handling and perspective projection calculations.\n\n> A critical design insight for transforms is that they operate purely in the rendering stage without affecting layout. This separation enables smooth animations since transform changes don't trigger expensive layout recalculations - only the final rendering phase needs updates.\n\n#### CSS Animations and Transitions\n\n**CSS animations and transitions** bring temporal dynamics to web content, enabling smooth visual changes over time. Think of animations as a film director's storyboard - we define keyframes that specify property values at different time points, and the browser interpolates smooth transitions between these values.\n\nAnimation implementation requires extending our architecture with time-based systems and interpolation logic. We need new data structures to represent animation definitions and active animation state:\n\n| Animation Component | Fields | Purpose |\n|-------------------|--------|---------|\n| KeyframeRule | selector: String, keyframes: Vec<Keyframe> | CSS `@keyframes` rule definition |\n| Keyframe | percentage: f32, declarations: Vec<Declaration> | Property values at specific time point |\n| Animation | name: String, duration: f32, timing_function: TimingFunction | Animation configuration |\n| ActiveAnimation | start_time: f64, current_value: CSSValue, target_element: DOMNodeHandle | Running animation state |\n\nThe animation system operates through several coordinated processes. The CSS parser must recognize `@keyframes` rules and animation properties like `animation-name`, `animation-duration`, and `animation-timing-function`. The style resolution system matches animations to elements and creates `ActiveAnimation` instances. A separate animation scheduler tracks time progression and calculates current property values through interpolation. The layout and rendering systems use these animated values as if they were static computed styles.\n\nKeyframe interpolation requires type-specific logic for different CSS value types:\n\n| Value Type | Interpolation Strategy | Example |\n|------------|----------------------|---------|\n| Length | Linear numeric interpolation | `0px` to `100px` over time |\n| Color | RGB component interpolation | `red` to `blue` through purple |\n| Transform | Matrix decomposition and interpolation | Smooth rotation and scaling |\n| Visibility | Discrete change at 50% progress | `visible` to `hidden` as step function |\n\n⚠️ **Pitfall: Animation Performance**\nA common mistake is recalculating layout for every animation frame, which creates performance bottlenecks. Properties like `transform` and `opacity` can be animated purely in the rendering stage without triggering layout recalculation. However, animating properties like `width`, `height`, or `margin` requires full layout recalculation for every frame, which can cause animations to appear janky or slow. The solution is to prefer transform-based animations (`transform: translateX()` instead of animating `left` property) and implement animation layer optimization that identifies layout-affecting vs. rendering-only property changes.\n\n### Performance and Scalability\n\nThink of performance optimization as transforming our browser engine from a skilled artisan's workshop to a modern manufacturing facility. While our current implementation works well for simple documents, real-world web pages contain thousands of elements, complex styling, and dynamic content updates that demand efficient processing strategies. Performance optimization involves both algorithmic improvements that reduce computational complexity and architectural changes that enable parallel processing and resource management.\n\nModern web performance demands span several dimensions. **Rendering performance** ensures smooth 60fps animation and interaction response times. **Memory efficiency** allows handling large documents without exhausting system resources. **Incremental processing** enables responsive user interfaces that don't freeze during expensive operations. **Cache effectiveness** reduces redundant computations across layout and rendering cycles. These optimizations often involve fundamental changes to our data structures and algorithms while preserving the same external interfaces.\n\nThe key insight is that performance optimization usually involves trading memory for speed, or introducing complexity to reduce computational work. We'll explore several major optimization categories: incremental rendering systems that avoid redundant work, layout caching strategies that preserve computed results, and multi-threaded architectures that parallelize independent operations.\n\n#### Incremental Rendering Architecture\n\n**Incremental rendering** transforms our current \"parse everything, layout everything, render everything\" approach into a sophisticated system that identifies what actually changed and processes only the minimal necessary updates. Think of this as the difference between repainting an entire house versus touching up only the walls that got scuffed - the end result is identical, but the efficiency improvement is dramatic.\n\nThe incremental rendering architecture requires introducing change tracking and invalidation systems throughout our rendering pipeline. Every data structure needs version tracking to identify when updates occur. Layout calculations need dependency analysis to determine which elements require recalculation when styles change. The rendering system needs damage tracking to identify screen regions that need repainting.\n\n> **Decision: Incremental Update Strategy**\n> - **Context**: Real web pages involve frequent DOM and style changes that shouldn't require complete re-rendering\n> - **Options Considered**:\n>   - Complete re-rendering on every change (current approach)\n>   - Fine-grained change tracking with targeted updates\n>   - Hybrid approach with batched invalidation and update cycles\n> - **Decision**: Hybrid approach with batched invalidation and update cycles\n> - **Rationale**: Balances implementation complexity with performance gains, matches browser main loop patterns, enables animation optimization\n> - **Consequences**: Requires version tracking in all data structures, but enables responsive updates and smooth animations\n\nThe incremental system introduces several new data structures for change tracking:\n\n| Component | Version Tracking | Invalidation Strategy | Update Scope |\n|-----------|------------------|----------------------|-------------|\n| DOM Tree | node_version: u64, subtree_version: u64 | Mark node and ancestors dirty on mutation | Single node to document root |\n| Style System | style_version: u64, cascade_version: u64 | Invalidate matching elements on stylesheet change | Selector-matched elements |\n| Layout Tree | layout_version: u64, geometry_version: u64 | Invalidate dependent elements on size change | Containing block and children |\n| Render Tree | paint_version: u64, visual_version: u64 | Mark visual regions dirty on appearance change | Screen damage rectangles |\n\nThe incremental update algorithm operates in carefully orchestrated phases to maintain consistency while minimizing work. First, we collect all pending changes (DOM mutations, style updates, layout constraint changes) and batch them into a single update cycle. Second, we propagate invalidation markers through dependency chains - style changes invalidate layout, layout changes invalidate rendering. Third, we process updates in dependency order: style resolution before layout, layout before rendering. Fourth, we compute minimal damage rectangles that need screen updates. Finally, we execute only the necessary rendering operations for changed regions.\n\n| Update Phase | Input Changes | Processing Strategy | Output State |\n|--------------|---------------|-------------------|-------------|\n| Change Collection | DOM/style/layout mutations | Batch all changes since last update | Change set with dependencies |\n| Invalidation Propagation | Change set | Mark affected elements dirty | Invalidation flags throughout tree |\n| Style Resolution | Dirty style flags | Recompute styles only for marked elements | Updated computed styles |\n| Layout Calculation | Dirty layout flags | Recalculate positions only for affected subtrees | Updated layout tree |\n| Damage Calculation | Layout changes | Compute minimal screen regions needing updates | Damage rectangle list |\n| Selective Rendering | Damage rectangles | Repaint only affected screen regions | Updated display buffer |\n\nA concrete example demonstrates the incremental rendering benefits. Consider a web page with a sidebar and main content area. When the user hovers over a navigation link, only the link's background color changes. Instead of re-rendering the entire page, our incremental system: (1) detects the single element style change, (2) determines that layout is unaffected since only `background-color` changed, (3) computes the damage rectangle covering only the link's screen area, (4) repaints only that small region. This reduces rendering work from potentially thousands of elements to a single element update.\n\n#### Layout Caching and Optimization\n\n**Layout caching** addresses the expensive nature of box model calculations by preserving computed results and reusing them when inputs haven't changed. Think of layout caching as a memoization system for geometry calculations - we remember the results of expensive computations and return cached values when we encounter the same inputs again.\n\nEffective layout caching requires understanding the dependency relationships between layout calculations. An element's final position depends on its computed styles, its parent's layout, and potentially its siblings' sizes (in cases like inline layout with line breaking). We can cache layout results at multiple granularities: individual box model calculations, complete subtree layouts, and even cross-document layout patterns.\n\nThe caching architecture introduces cache-aware data structures and invalidation logic:\n\n| Cache Type | Cache Key | Cache Value | Invalidation Trigger |\n|------------|-----------|-------------|---------------------|\n| Box Model Cache | computed_style_hash, containing_block_size | LayoutBox dimensions | Style or parent size change |\n| Subtree Layout Cache | subtree_style_hash, available_space | Complete subtree layout | Any descendant style change |\n| Text Metrics Cache | font_info, text_content | TextMetrics | Font or text change |\n| Line Breaking Cache | text, available_width, font_info | Line break positions | Text, width, or font change |\n\nLayout cache implementation requires careful consideration of cache invalidation strategies. **Conservative invalidation** marks cache entries invalid whenever any dependency might have changed, ensuring correctness at the cost of cache hit rates. **Precise invalidation** tracks exact dependencies and only invalidates when specific inputs change, maximizing cache effectiveness but increasing complexity. **Hybrid invalidation** uses conservative strategies for complex dependencies and precise strategies for simple cases.\n\n| Caching Strategy | Hit Rate | Correctness Risk | Implementation Complexity | Best Use Case |\n|------------------|----------|------------------|--------------------------|-------------|\n| No Caching | 0% | None | Low | Simple documents, prototyping |\n| Conservative | 60-70% | None | Medium | General purpose, safety-first |\n| Precise | 85-95% | Medium | High | Performance-critical applications |\n| Hybrid | 75-85% | Low | Medium-High | Production browser engines |\n\nAdvanced layout optimizations involve recognizing common patterns and applying specialized algorithms. **Constraint caching** remembers the results of complex box model constraint resolution for common size combinations. **Layout tree structural sharing** reuses unchanged subtrees between layout cycles. **Incremental line layout** updates only the lines affected by text changes rather than reflowing entire text blocks.\n\n> The key insight for layout caching is that spatial locality in layout calculations mirrors temporal locality in cache access patterns. Elements that are laid out together are likely to be updated together, so cache organization should reflect document structure rather than just computational dependencies.\n\n#### Multi-threaded Processing Architecture\n\n**Multi-threaded processing** transforms our sequential rendering pipeline into a parallel system that can utilize multiple CPU cores for improved performance. Think of this as converting from a single-lane highway to a multi-lane expressway - multiple operations can proceed simultaneously as long as they don't interfere with each other.\n\nBrowser engines present unique challenges for multi-threading because of the extensive dependencies between parsing, styling, layout, and rendering operations. However, certain operations can be parallelized effectively: HTML parsing can use separate threads for tokenization and tree building, style resolution can process independent subtrees concurrently, layout calculations for independent formatting contexts can run in parallel, and rendering operations can utilize GPU parallelism for paint operations.\n\nThe multi-threaded architecture requires careful design to avoid data races while maximizing parallelism opportunities:\n\n| Pipeline Stage | Parallelization Strategy | Synchronization Requirements | Performance Gain |\n|----------------|-------------------------|----------------------------|------------------|\n| HTML Parsing | Producer-consumer tokenization | Token stream synchronization | 20-30% for large documents |\n| CSS Parsing | Parallel stylesheet processing | Rule ordering preservation | 15-25% for complex stylesheets |\n| Style Resolution | Subtree-parallel processing | Cascade dependency ordering | 40-60% for deep trees |\n| Layout Calculation | Independent formatting context parallelism | Parent-child dependency coordination | 30-50% for complex layouts |\n| Rendering | GPU-accelerated paint operations | Command buffer synchronization | 100-300% for graphics-heavy content |\n\nThe thread coordination architecture uses a combination of work-stealing queues, dependency graphs, and barrier synchronization to maintain correctness while maximizing parallelism:\n\n| Coordination Mechanism | Purpose | Implementation | Trade-offs |\n|------------------------|---------|----------------|------------|\n| Work-Stealing Queues | Load balancing across threads | Lock-free deques with thread-local work | High throughput, complex debugging |\n| Dependency Graphs | Ensuring correct processing order | DAG with completion tracking | Correct ordering, scheduling overhead |\n| Barrier Synchronization | Pipeline stage coordination | Phase barriers with worker synchronization | Simple correctness, potential thread starvation |\n| Message Passing | Cross-thread communication | Channel-based producer-consumer | Clean isolation, potential bottlenecks |\n\nA concrete multi-threading example shows the complexity and benefits. Consider processing a large HTML document with extensive CSS styling. Thread 1 performs HTML tokenization, sending tokens to Thread 2 for DOM tree construction. Meanwhile, Thread 3 processes the CSS stylesheet in parallel. Once both complete, Threads 4-6 perform style resolution on independent document subtrees. After style resolution completes, Threads 7-8 calculate layout for independent formatting contexts. Finally, Thread 9 generates paint commands while the GPU processes previous frame rendering operations. This pipeline approach keeps all processing units busy and dramatically reduces total processing time.\n\n⚠️ **Pitfall: Premature Multi-threading**\nA common mistake is introducing multi-threading too early in the development process, before the single-threaded implementation is stable and well-understood. Multi-threading adds significant debugging complexity, can introduce subtle race conditions, and may not provide performance benefits if the workload doesn't parallelize well. The correct approach is to first optimize the single-threaded implementation, identify actual performance bottlenecks through profiling, and then introduce threading only for operations that show clear parallelization benefits. Additionally, many web documents are small enough that threading overhead exceeds the benefits - multi-threading optimizations should be conditional based on document complexity.\n\n#### Memory Management and Resource Optimization\n\n**Memory management** becomes critical as our browser engine handles larger and more complex documents. Real-world web pages can contain thousands of DOM nodes, extensive CSS rules, and large layout trees that collectively consume significant memory. Effective memory management involves both reducing memory usage through efficient data structures and managing memory lifecycle through careful allocation and deallocation strategies.\n\nThe memory optimization strategy operates across several dimensions. **Data structure optimization** reduces the memory footprint of individual nodes and eliminates unnecessary data duplication. **Memory pooling** reduces allocation overhead by reusing memory blocks for similar objects. **Garbage collection coordination** ensures timely cleanup of unused objects without creating performance stutters. **Resource limiting** prevents memory exhaustion by setting bounds on cache sizes and processing complexity.\n\n| Memory Optimization | Technique | Memory Savings | Implementation Complexity | Performance Impact |\n|-------------------|-----------|----------------|--------------------------|-------------------|\n| Struct Packing | Optimize field ordering and sizes | 20-40% per object | Low | Minimal |\n| String Interning | Share common string values | 30-60% for repeated content | Medium | Slight positive |\n| Layout Tree Sharing | Reuse unchanged subtrees | 40-80% for static content | High | Positive for large documents |\n| Object Pooling | Reuse memory for temporary objects | Reduces allocation overhead | Medium | Positive for allocation-heavy workloads |\n| Lazy Evaluation | Defer calculations until needed | Variable, often 20-50% | Medium-High | Positive for sparse usage patterns |\n\nAdvanced memory optimization techniques involve structural changes to our data model. **Copy-on-write sharing** allows multiple layout trees to share unchanged subtrees, dramatically reducing memory usage for documents with repeated elements. **Compressed representations** use bit packing and specialized encoding for common value ranges. **Memory mapped resources** enable efficient sharing of large resources like images and fonts across multiple documents.\n\nThe resource management system needs sophisticated policies for cache eviction, memory pressure response, and resource prioritization:\n\n| Resource Type | Eviction Policy | Memory Pressure Response | Priority Level |\n|---------------|----------------|-------------------------|----------------|\n| Layout Caches | LRU with size limits | Aggressive eviction | Medium |\n| Style Computation | Time-based expiration | Partial eviction | High |\n| Font Resources | Reference counting | Lazy loading | High |\n| Image Buffers | Size-based priorities | Progressive quality reduction | Low-Medium |\n| Parse Trees | Usage-based retention | Complete eviction | Medium-High |\n\n> The fundamental insight for memory optimization is that browser engines must balance memory usage with computational performance. Aggressive memory optimization can force expensive recalculations, while unlimited memory usage leads to system instability. The optimal strategy involves profiling real-world usage patterns and implementing adaptive policies that respond to both memory pressure and performance requirements.\n\n### Implementation Guidance\n\nThe advanced features outlined above represent significant extensions to our basic browser engine architecture. This implementation guidance provides concrete technical approaches and starter code to help bridge the gap between design concepts and working implementations.\n\n#### Technology Recommendations\n\n| Feature Category | Simple Approach | Advanced Approach |\n|-----------------|-----------------|-------------------|\n| Flexbox Layout | Extend existing layout with flex-specific algorithms | Implement full CSS Flexible Box specification |\n| Grid Layout | Basic grid with fixed tracks | Full grid with subgrids, implicit tracks, and auto-placement |\n| CSS Transforms | 2D transforms with matrix math | 3D transforms with perspective and hardware acceleration |\n| Animations | Simple property interpolation | Timeline-based animation system with complex easing |\n| Incremental Rendering | Dirty flag propagation | Sophisticated invalidation with dependency tracking |\n| Caching | Simple memoization | Multi-level cache hierarchy with smart eviction |\n| Multi-threading | Basic task parallelism | Lock-free data structures with work-stealing |\n| Memory Management | Manual optimization | Automatic memory pressure response |\n\n#### Recommended File Structure Extension\n\nThe advanced features require extending our existing modular architecture with new specialized components:\n\n```\nproject-root/\n  src/\n    layout/\n      mod.rs                    ← existing layout module\n      flexbox.rs                ← flexbox layout algorithms\n      grid.rs                   ← CSS Grid implementation\n      transforms.rs             ← transform matrix calculations\n      cache.rs                  ← layout caching system\n    \n    rendering/\n      mod.rs                    ← existing rendering module\n      animation.rs              ← animation and transition system\n      incremental.rs            ← incremental update tracking\n      damage.rs                 ← screen damage calculation\n      \n    performance/\n      memory.rs                 ← memory management utilities\n      threading.rs              ← multi-threading coordination\n      profiling.rs              ← performance measurement\n      cache_manager.rs          ← unified cache management\n    \n    css/\n      mod.rs                    ← existing CSS parser\n      flexbox_properties.rs     ← flexbox CSS parsing\n      grid_properties.rs        ← grid CSS parsing  \n      animation_parser.rs       ← keyframe and animation parsing\n      transform_functions.rs    ← transform function parsing\n```\n\n#### Flexbox Implementation Starter Code\n\nHere's a complete implementation foundation for adding flexbox support to our layout engine:\n\n```rust\nuse crate::layout::{LayoutBox, BoxType, ComputedStyle};\nuse crate::css::{Display, FlexDirection, JustifyContent, AlignItems};\nuse crate::types::{Rectangle, Size, Point};\n\n#[derive(Debug, Clone)]\npub struct FlexContainer {\n    pub flex_direction: FlexDirection,\n    pub justify_content: JustifyContent,\n    pub align_items: AlignItems,\n    pub flex_wrap: FlexWrap,\n}\n\n#[derive(Debug, Clone)]\npub struct FlexItem {\n    pub flex_grow: f32,\n    pub flex_shrink: f32,\n    pub flex_basis: f32,\n    pub main_size: f32,\n    pub cross_size: f32,\n}\n\n#[derive(Debug, Clone, PartialEq)]\npub enum FlexDirection {\n    Row,\n    Column,\n    RowReverse,\n    ColumnReverse,\n}\n\n#[derive(Debug, Clone, PartialEq)]\npub enum FlexWrap {\n    Nowrap,\n    Wrap,\n    WrapReverse,\n}\n\nimpl LayoutBox {\n    /// Calculate flexbox layout for container with flex display\n    /// This is the main entry point for flexbox layout calculations\n    pub fn calculate_flexbox_layout(&mut self, available_size: Size) {\n        // TODO 1: Validate that this box has display: flex\n        // TODO 2: Extract flex container properties from computed_style\n        // TODO 3: Collect all immediate children as flex items\n        // TODO 4: Determine main and cross axis based on flex_direction\n        // TODO 5: Resolve flex-basis for all items using resolve_flex_basis()\n        // TODO 6: Calculate total hypothetical main size\n        // TODO 7: Distribute free space using distribute_flex_space()\n        // TODO 8: Handle flex line wrapping if flex_wrap is enabled\n        // TODO 9: Align items on cross axis using align_cross_axis()\n        // TODO 10: Update final positions and sizes for all flex items\n        // Hint: Use is_main_axis_horizontal() to determine axis orientation\n        // Hint: Store flex container state in a FlexContainer struct\n    }\n    \n    /// Resolve flex-basis for each flex item, considering auto values\n    fn resolve_flex_basis(&self, item: &mut LayoutBox, available_main_size: f32) -> f32 {\n        // TODO 1: Check if flex-basis is 'auto' - if so, use width/height\n        // TODO 2: If flex-basis is 'content', measure content size\n        // TODO 3: Convert percentage values to absolute pixels\n        // TODO 4: Return resolved flex-basis in main axis dimension\n        // Hint: Use the item's computed_style to access flex properties\n        // Hint: Content-based sizing may require text measurement\n        0.0 // Placeholder\n    }\n    \n    /// Distribute available free space among flex items based on grow/shrink factors\n    fn distribute_flex_space(&mut self, items: &mut [FlexItem], available_space: f32) {\n        // TODO 1: Calculate total hypothetical main size of all items\n        // TODO 2: Determine if we have extra space (grow) or overflow (shrink)\n        // TODO 3: If growing, calculate total flex-grow and distribute proportionally\n        // TODO 4: If shrinking, calculate total flex-shrink and reduce proportionally\n        // TODO 5: Ensure no item shrinks below its minimum content size\n        // TODO 6: Update main_size for each flex item with final dimensions\n        // Hint: Handle division by zero when total grow/shrink factors are zero\n        // Hint: Items with flex-shrink: 0 should not shrink below basis\n    }\n    \n    /// Align flex items along the cross axis\n    fn align_cross_axis(&mut self, items: &mut [LayoutBox], container_cross_size: f32) {\n        // TODO 1: Determine cross axis dimension based on flex_direction  \n        // TODO 2: For each item, check align-self (falls back to align-items)\n        // TODO 3: Calculate cross axis position based on alignment:\n        //         - flex-start: position at 0\n        //         - center: position at (container_size - item_size) / 2  \n        //         - flex-end: position at container_size - item_size\n        //         - stretch: expand item to fill container cross size\n        // TODO 4: Update item's cross axis position and size\n        // Hint: stretch only affects size, not position\n        // Hint: Use set_cross_axis_position() helper method\n    }\n    \n    /// Helper to determine if main axis is horizontal based on flex-direction\n    fn is_main_axis_horizontal(&self) -> bool {\n        matches!(self.get_flex_direction(), FlexDirection::Row | FlexDirection::RowReverse)\n    }\n    \n    /// Helper to get main axis size from a Size struct\n    fn main_axis_size(&self, size: Size) -> f32 {\n        if self.is_main_axis_horizontal() { size.width } else { size.height }\n    }\n    \n    /// Helper to get cross axis size from a Size struct  \n    fn cross_axis_size(&self, size: Size) -> f32 {\n        if self.is_main_axis_horizontal() { size.height } else { size.width }\n    }\n}\n\n// Helper functions for accessing flex properties from computed styles\nimpl ComputedStyle {\n    pub fn flex_direction(&self) -> FlexDirection {\n        // TODO: Extract from CSS properties, default to Row\n        FlexDirection::Row\n    }\n    \n    pub fn flex_grow(&self) -> f32 {\n        // TODO: Extract from CSS properties, default to 0.0\n        0.0\n    }\n    \n    pub fn flex_shrink(&self) -> f32 {\n        // TODO: Extract from CSS properties, default to 1.0\n        1.0\n    }\n    \n    pub fn flex_basis(&self) -> f32 {\n        // TODO: Extract from CSS properties, handle 'auto' and 'content'\n        0.0\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_flexbox_basic_layout() {\n        // TODO: Create test with simple flex container and items\n        // TODO: Verify items are positioned correctly with default properties\n    }\n    \n    #[test] \n    fn test_flex_grow_distribution() {\n        // TODO: Test free space distribution with different flex-grow values\n        // TODO: Verify proportional space allocation\n    }\n    \n    #[test]\n    fn test_flex_shrink_overflow() {\n        // TODO: Test item shrinking when total size exceeds container\n        // TODO: Verify shrink factors are respected\n    }\n}\n```\n\n#### Animation System Infrastructure\n\nThe animation system requires time-based processing and interpolation capabilities:\n\n```rust\nuse std::time::{Duration, Instant};\nuse std::collections::HashMap;\nuse crate::css::{CSSValue, Declaration};\nuse crate::dom::DOMNodeHandle;\n\npub struct AnimationEngine {\n    active_animations: HashMap<AnimationId, ActiveAnimation>,\n    keyframe_rules: HashMap<String, KeyframeRule>,\n    animation_scheduler: AnimationScheduler,\n    start_time: Instant,\n}\n\n#[derive(Debug, Clone)]\npub struct KeyframeRule {\n    pub name: String,\n    pub keyframes: Vec<Keyframe>,\n}\n\n#[derive(Debug, Clone)]\npub struct Keyframe {\n    pub percentage: f32, // 0.0 to 100.0\n    pub declarations: Vec<Declaration>,\n}\n\n#[derive(Debug)]\npub struct ActiveAnimation {\n    pub element: DOMNodeHandle,\n    pub keyframe_rule: String,\n    pub duration: Duration,\n    pub start_time: Instant,\n    pub current_values: HashMap<String, CSSValue>,\n    pub timing_function: TimingFunction,\n}\n\npub type AnimationId = u64;\n\n#[derive(Debug, Clone)]\npub enum TimingFunction {\n    Linear,\n    Ease,\n    EaseIn,\n    EaseOut,\n    EaseInOut,\n    CubicBezier(f32, f32, f32, f32),\n}\n\nimpl AnimationEngine {\n    pub fn new() -> Self {\n        Self {\n            active_animations: HashMap::new(),\n            keyframe_rules: HashMap::new(),\n            animation_scheduler: AnimationScheduler::new(),\n            start_time: Instant::now(),\n        }\n    }\n    \n    /// Update all active animations and return elements that need style updates\n    pub fn update_animations(&mut self) -> Vec<DOMNodeHandle> {\n        // TODO 1: Get current timestamp relative to engine start\n        // TODO 2: Iterate through all active animations\n        // TODO 3: Calculate progress (0.0 to 1.0) based on duration and elapsed time\n        // TODO 4: Apply timing function to get eased progress\n        // TODO 5: Interpolate keyframe values at current progress\n        // TODO 6: Update current_values for each animation\n        // TODO 7: Remove completed animations from active list\n        // TODO 8: Return list of elements that need style recalculation\n        // Hint: Use interpolate_keyframes() to calculate intermediate values\n        // Hint: Elements appear multiple times if they have multiple animations\n        vec![]\n    }\n    \n    /// Start a new animation for the given element\n    pub fn start_animation(&mut self, element: DOMNodeHandle, animation_name: &str, duration: Duration) -> Result<AnimationId, String> {\n        // TODO 1: Check if keyframe rule exists for animation_name\n        // TODO 2: Generate unique animation ID\n        // TODO 3: Create ActiveAnimation instance with current timestamp\n        // TODO 4: Initialize current_values with starting keyframe values\n        // TODO 5: Add to active_animations map\n        // TODO 6: Schedule for regular updates\n        // TODO 7: Return animation ID for later reference\n        // Hint: Use Instant::now() for start_time\n        // Hint: Parse initial keyframe (0%) for starting values\n        Ok(0)\n    }\n    \n    /// Interpolate between keyframes at given progress (0.0 to 1.0)\n    fn interpolate_keyframes(&self, keyframes: &[Keyframe], progress: f32) -> HashMap<String, CSSValue> {\n        // TODO 1: Find the two keyframes that bracket the current progress\n        // TODO 2: Calculate local progress between the two keyframes\n        // TODO 3: For each property in the keyframes, interpolate the value\n        // TODO 4: Handle different CSSValue types (Length, Color, Number, etc.)\n        // TODO 5: Return map of property names to interpolated values\n        // Hint: Use find_keyframe_range() to locate bounding keyframes\n        // Hint: Different value types need different interpolation logic\n        HashMap::new()\n    }\n    \n    /// Apply timing function to linear progress\n    fn apply_timing_function(&self, progress: f32, timing: &TimingFunction) -> f32 {\n        match timing {\n            TimingFunction::Linear => progress,\n            TimingFunction::Ease => {\n                // TODO: Implement ease cubic-bezier curve (0.25, 0.1, 0.25, 1.0)\n                progress\n            },\n            TimingFunction::EaseIn => {\n                // TODO: Implement ease-in cubic-bezier curve (0.42, 0, 1.0, 1.0)  \n                progress\n            },\n            TimingFunction::EaseOut => {\n                // TODO: Implement ease-out cubic-bezier curve (0, 0, 0.58, 1.0)\n                progress\n            },\n            TimingFunction::EaseInOut => {\n                // TODO: Implement ease-in-out cubic-bezier curve (0.42, 0, 0.58, 1.0)\n                progress\n            },\n            TimingFunction::CubicBezier(x1, y1, x2, y2) => {\n                // TODO: Implement general cubic bezier evaluation\n                // Hint: This requires solving the bezier curve for given x (time) to find y (progress)\n                progress\n            }\n        }\n    }\n}\n\n// Value interpolation trait for different CSS value types\ntrait Interpolatable {\n    fn interpolate(&self, other: &Self, progress: f32) -> Self;\n}\n\nimpl Interpolatable for CSSValue {\n    fn interpolate(&self, other: &Self, progress: f32) -> Self {\n        match (self, other) {\n            (CSSValue::Length(start), CSSValue::Length(end)) => {\n                // TODO: Interpolate length values, handling unit conversion\n                CSSValue::Length(*start)\n            },\n            (CSSValue::Color(start), CSSValue::Color(end)) => {\n                // TODO: Interpolate RGB color components\n                CSSValue::Color(*start)\n            },\n            (CSSValue::Number(start), CSSValue::Number(end)) => {\n                // TODO: Linear interpolation for numeric values\n                CSSValue::Number(*start)\n            },\n            _ => {\n                // TODO: Discrete interpolation - switch at 50% progress\n                if progress < 0.5 { self.clone() } else { other.clone() }\n            }\n        }\n    }\n}\n\npub struct AnimationScheduler {\n    next_frame_time: Instant,\n    frame_duration: Duration,\n}\n\nimpl AnimationScheduler {\n    pub fn new() -> Self {\n        Self {\n            next_frame_time: Instant::now(),\n            frame_duration: Duration::from_millis(16), // ~60fps\n        }\n    }\n    \n    /// Check if it's time for the next animation frame\n    pub fn should_update(&mut self) -> bool {\n        let now = Instant::now();\n        if now >= self.next_frame_time {\n            self.next_frame_time = now + self.frame_duration;\n            true\n        } else {\n            false\n        }\n    }\n}\n```\n\n#### Incremental Rendering Infrastructure\n\nThe incremental rendering system requires sophisticated change tracking and invalidation logic:\n\n```rust\nuse std::collections::{HashSet, HashMap};\nuse crate::dom::DOMNodeHandle;\nuse crate::layout::LayoutBox;\nuse crate::types::Rectangle;\n\npub struct IncrementalRenderer {\n    pub dom_versions: HashMap<DOMNodeHandle, u64>,\n    pub style_versions: HashMap<DOMNodeHandle, u64>, \n    pub layout_versions: HashMap<DOMNodeHandle, u64>,\n    pub damage_tracker: DamageTracker,\n    pub update_scheduler: UpdateScheduler,\n}\n\npub struct DamageTracker {\n    pub damaged_regions: Vec<Rectangle>,\n    pub previous_paint_rects: HashMap<DOMNodeHandle, Rectangle>,\n}\n\n#[derive(Debug)]\npub enum InvalidationType {\n    Style,\n    Layout,\n    Paint,\n}\n\npub struct UpdateScheduler {\n    pub pending_dom_changes: HashSet<DOMNodeHandle>,\n    pub pending_style_changes: HashSet<DOMNodeHandle>,\n    pub pending_layout_changes: HashSet<DOMNodeHandle>,\n    pub frame_pending: bool,\n}\n\nimpl IncrementalRenderer {\n    pub fn new() -> Self {\n        Self {\n            dom_versions: HashMap::new(),\n            style_versions: HashMap::new(),\n            layout_versions: HashMap::new(),\n            damage_tracker: DamageTracker::new(),\n            update_scheduler: UpdateScheduler::new(),\n        }\n    }\n    \n    /// Mark element as needing style recalculation\n    pub fn invalidate_style(&mut self, element: DOMNodeHandle) {\n        // TODO 1: Add element to pending_style_changes set\n        // TODO 2: Propagate invalidation to all descendant elements\n        // TODO 3: Mark ancestors for potential layout invalidation\n        // TODO 4: Schedule update frame if not already pending\n        // Hint: Style changes can affect layout, so cascade invalidation upward\n        // Hint: Use propagate_invalidation_to_descendants() helper\n    }\n    \n    /// Mark element as needing layout recalculation\n    pub fn invalidate_layout(&mut self, element: DOMNodeHandle) {\n        // TODO 1: Add element to pending_layout_changes set\n        // TODO 2: Propagate to all children (parent layout affects child positions)\n        // TODO 3: Mark for paint invalidation (layout changes require repaint)\n        // TODO 4: Update damage tracking with element's current paint rectangle\n        // TODO 5: Schedule update frame\n        // Hint: Layout changes always require paint updates\n        // Hint: Store previous layout bounds for damage calculation\n    }\n    \n    /// Perform incremental update cycle\n    pub fn perform_incremental_update(&mut self) -> UpdateResult {\n        // TODO 1: Process pending DOM changes first\n        // TODO 2: Resolve style changes using resolve_pending_styles()\n        // TODO 3: Calculate layout for invalidated elements\n        // TODO 4: Compute damage rectangles from layout changes\n        // TODO 5: Generate paint commands for damaged regions only\n        // TODO 6: Clear pending change sets\n        // TODO 7: Update version numbers for processed elements\n        // TODO 8: Return update statistics and damage regions\n        // Hint: Process in dependency order: DOM -> Style -> Layout -> Paint\n        // Hint: Skip redundant work by checking version numbers\n        UpdateResult::default()\n    }\n    \n    /// Compute minimal damage rectangles for screen updates\n    fn compute_damage_regions(&mut self, layout_changes: &[LayoutBox]) -> Vec<Rectangle> {\n        // TODO 1: For each changed layout box, get old and new paint rectangles\n        // TODO 2: Union old and new rectangles to get total damage area\n        // TODO 3: Merge overlapping damage rectangles for efficiency\n        // TODO 4: Clip damage rectangles to viewport bounds\n        // TODO 5: Return list of minimal rectangles needing repaint\n        // Hint: Use rectangle_union() to combine overlapping areas\n        // Hint: Small damage rectangles can be merged to reduce draw call overhead\n        vec![]\n    }\n    \n    /// Check if element needs style recalculation based on version tracking\n    fn needs_style_update(&self, element: DOMNodeHandle) -> bool {\n        // TODO 1: Compare current DOM version with cached style version\n        // TODO 2: Check if any ancestor styles have changed (inheritance)\n        // TODO 3: Check if any matching CSS rules have been modified\n        // TODO 4: Return true if any dependency has newer version\n        // Hint: Style depends on element's own attributes and inherited values\n        // Hint: CSS rule changes affect all matching elements\n        false\n    }\n}\n\nimpl DamageTracker {\n    pub fn new() -> Self {\n        Self {\n            damaged_regions: Vec::new(),\n            previous_paint_rects: HashMap::new(),\n        }\n    }\n    \n    /// Add a damaged rectangle to the damage list\n    pub fn add_damage(&mut self, rect: Rectangle) {\n        // TODO 1: Check if new rectangle overlaps with existing damage\n        // TODO 2: If overlapping, merge rectangles to avoid redundant repaints\n        // TODO 3: If not overlapping, add as separate damage region\n        // TODO 4: Limit total number of damage rectangles for performance\n        // Hint: Too many small rectangles can be slower than one large rectangle\n        // Hint: Use Rectangle::intersects() and Rectangle::union() methods\n    }\n    \n    /// Get all damage rectangles and clear the damage list\n    pub fn take_damage(&mut self) -> Vec<Rectangle> {\n        std::mem::take(&mut self.damaged_regions)\n    }\n}\n\n#[derive(Default)]\npub struct UpdateResult {\n    pub elements_styled: usize,\n    pub elements_laid_out: usize,\n    pub damage_rectangles: Vec<Rectangle>,\n    pub total_damage_area: f32,\n}\n\nimpl UpdateScheduler {\n    pub fn new() -> Self {\n        Self {\n            pending_dom_changes: HashSet::new(),\n            pending_style_changes: HashSet::new(), \n            pending_layout_changes: HashSet::new(),\n            frame_pending: false,\n        }\n    }\n    \n    /// Schedule an update frame if one isn't already pending\n    pub fn schedule_frame(&mut self) {\n        self.frame_pending = true;\n        // TODO: In real implementation, this would schedule with the browser's\n        // main loop or request an animation frame callback\n    }\n    \n    /// Check if any updates are pending\n    pub fn has_pending_updates(&self) -> bool {\n        !self.pending_dom_changes.is_empty() \n            || !self.pending_style_changes.is_empty()\n            || !self.pending_layout_changes.is_empty()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_style_invalidation_propagation() {\n        // TODO: Test that style changes propagate to descendants\n        // TODO: Verify version tracking works correctly\n    }\n    \n    #[test]\n    fn test_damage_rectangle_merging() {\n        // TODO: Test that overlapping damage rectangles are merged\n        // TODO: Verify damage tracking reduces redundant repaints\n    }\n    \n    #[test]\n    fn test_incremental_update_cycle() {\n        // TODO: Test complete update cycle with multiple change types\n        // TODO: Verify changes are processed in correct dependency order\n    }\n}\n```\n\n#### Performance Monitoring and Profiling\n\nPerformance optimization requires measurement and profiling capabilities:\n\n```rust\nuse std::time::{Duration, Instant};\nuse std::collections::HashMap;\n\npub struct PerformanceProfiler {\n    pub frame_times: Vec<Duration>,\n    pub component_times: HashMap<String, Duration>,\n    pub memory_usage: MemoryStats,\n    pub render_stats: RenderingStats,\n}\n\npub struct MemoryStats {\n    pub dom_nodes: usize,\n    pub layout_boxes: usize,\n    pub cached_styles: usize,\n    pub total_memory_mb: f32,\n}\n\npub struct RenderingStats {\n    pub paint_commands_generated: usize,\n    pub damage_rectangles: usize,\n    pub pixels_painted: usize,\n    pub cache_hit_rate: f32,\n}\n\nimpl PerformanceProfiler {\n    pub fn new() -> Self {\n        Self {\n            frame_times: Vec::new(),\n            component_times: HashMap::new(),\n            memory_usage: MemoryStats::default(),\n            render_stats: RenderingStats::default(),\n        }\n    }\n    \n    /// Start timing a component operation\n    pub fn start_timer(&mut self, component: &str) -> TimerHandle {\n        TimerHandle {\n            component: component.to_string(),\n            start_time: Instant::now(),\n        }\n    }\n    \n    /// Record component timing when timer handle is dropped\n    pub fn record_time(&mut self, component: String, duration: Duration) {\n        *self.component_times.entry(component).or_insert(Duration::ZERO) += duration;\n    }\n    \n    /// Generate performance report\n    pub fn generate_report(&self) -> PerformanceReport {\n        // TODO 1: Calculate average frame time and FPS\n        // TODO 2: Identify performance bottlenecks from component times\n        // TODO 3: Analyze memory usage patterns\n        // TODO 4: Generate recommendations for optimization\n        // TODO 5: Format report with timing breakdowns and suggestions\n        PerformanceReport::default()\n    }\n}\n\npub struct TimerHandle {\n    component: String,\n    start_time: Instant,\n}\n\nimpl Drop for TimerHandle {\n    fn drop(&mut self) {\n        let duration = self.start_time.elapsed();\n        // TODO: Record timing data to global profiler\n        // In real implementation, this would access a thread-local profiler instance\n        println!(\"Component '{}' took {:?}\", self.component, duration);\n    }\n}\n\n#[derive(Default)]\npub struct PerformanceReport {\n    pub average_frame_time: Duration,\n    pub fps: f32,\n    pub bottleneck_component: String,\n    pub memory_usage_mb: f32,\n    pub cache_efficiency: f32,\n    pub recommendations: Vec<String>,\n}\n\n// Macro for convenient performance measurement\n#[macro_export]\nmacro_rules! profile_scope {\n    ($profiler:expr, $name:expr) => {\n        let _timer = $profiler.start_timer($name);\n    };\n}\n\n// Example usage in layout calculation:\n// profile_scope!(profiler, \"flexbox_layout\");\n// calculate_flexbox_layout();\n// Timer automatically records when scope exits\n```\n\n#### Milestone Checkpoints for Advanced Features\n\nAfter implementing each advanced feature, use these checkpoints to validate functionality:\n\n**Flexbox Validation Checkpoint:**\n```bash\n# Test basic flexbox layout\ncargo test flexbox_basic_layout\n\n# Test with sample HTML/CSS:\n# <div style=\"display: flex; width: 300px;\">\n#   <div style=\"flex: 1;\">Item 1</div>  \n#   <div style=\"flex: 2;\">Item 2</div>\n#   <div style=\"flex: 1;\">Item 3</div>\n# </div>\n\n# Expected: Item 2 should be twice the width of Items 1 and 3\n# Items should sum to 300px total width\n```\n\n**Animation System Validation:**\n```bash\n# Test keyframe interpolation\ncargo test animation_interpolation\n\n# Test with sample animation:\n# @keyframes slide { from { left: 0px; } to { left: 100px; } }\n# div { animation: slide 2s ease-in-out; }\n\n# Expected: Element should smoothly move from left: 0 to left: 100px over 2 seconds\n# Animation should use ease-in-out timing curve, not linear motion\n```\n\n**Incremental Rendering Validation:**\n```bash\n# Test damage tracking\ncargo test incremental_damage_tracking\n\n# Performance test: Change single element style in large document\n# Expected: Update time should be proportional to changed content, not document size\n# Memory usage should not grow significantly with number of updates\n```\n\n**Performance Optimization Validation:**\n```bash\n# Run performance benchmarks\ncargo bench layout_performance\ncargo bench rendering_performance\n\n# Profile with large document (1000+ elements)\n# Expected: Layout time < 16ms for 60fps rendering\n# Memory usage should stabilize without continuous growth\n```\n\n⚠️ **Integration Testing Pitfall**\nWhen testing advanced features, avoid testing them in isolation from the rest of the rendering pipeline. Real-world performance bottlenecks often emerge from interactions between systems - for example, flexbox layout might work perfectly on its own but cause performance issues when combined with CSS animations and incremental rendering. Always test advanced features with complete end-to-end scenarios that exercise the full rendering pipeline with realistic document complexity and update patterns.\n\n\n## Glossary and Technical Reference\n\n> **Milestone(s):** All milestones (1-4) - This section provides comprehensive definitions and technical references that support understanding and implementation throughout the entire browser engine project.\n\nBuilding a browser engine introduces a vast vocabulary of domain-specific terms, technical concepts, and specialized data structures. This glossary serves as a comprehensive reference for all terminology used throughout the design document, providing precise definitions, context, and relationships between concepts. Understanding this terminology is crucial for successful implementation and debugging of the rendering pipeline.\n\n### Mental Model: The Technical Translator\n\nThink of this glossary as a **technical translator** for the browser engineering domain. Just as learning a foreign language requires understanding not just individual words but also their cultural context and relationships, mastering browser engine development requires understanding both the precise technical definitions and how concepts relate to each other within the larger system. This glossary provides both the \"dictionary definitions\" and the \"cultural context\" that connects terminology to the actual implementation challenges you'll face.\n\n### Core Architecture Terms\n\nThe fundamental architecture of browser engines revolves around several key concepts that form the backbone of the entire system.\n\n| Term | Definition | Context | Related Concepts |\n|------|------------|---------|------------------|\n| Rendering Pipeline | Sequential stages transforming HTML/CSS to visual output through distinct processing phases | Core architectural pattern organizing the entire browser engine | Assembly Line, Document Scanner, Blueprint Architect |\n| Assembly Line | Mental model for browser processing stages where each component performs specialized transformation | Helps understand the sequential nature of HTML→DOM→Layout→Paint | Rendering Pipeline, Component Responsibilities |\n| DOM Tree | Hierarchical representation of HTML document structure using parent-child node relationships | Central data structure connecting HTML parsing to all downstream processing | DOMNode, Tree Construction, Document Structure |\n| Style Cascade | CSS rule precedence resolution system determining which styles apply to each element | Implements CSS specification for handling conflicting style declarations | Specificity, Cascade Algorithm, Rule Matching |\n| Box Model | CSS layout model with margin, border, padding, content areas defining element dimensions | Fundamental layout concept governing how space is allocated to elements | LayoutBox, BoxOffsets, Containing Block |\n| Layout Tree | Tree structure with computed element positions and sizes after box model calculations | Bridge between styled DOM and visual rendering with geometric information | LayoutBox, Formatting Context, Computed Dimensions |\n| Display List | Ordered sequence of paint commands for rendering elements in correct visual order | Intermediate representation between layout and actual graphics operations | PaintCommand, Z-Order, Rendering Pipeline |\n| Viewport | Visible area dimensions for layout calculations and rendering coordinate system | Defines the available space and coordinate system for all layout operations | Rectangle, Coordinate System, Available Space |\n\n### HTML Parsing and DOM Terms\n\nHTML parsing involves complex terminology related to tokenization, tree construction, and error recovery mechanisms.\n\n| Term | Definition | Context | Implementation Notes |\n|------|------------|---------|---------------------|\n| Tokenization | Breaking HTML text into meaningful tokens like start tags, end tags, and text content | First stage of HTML parsing that performs lexical analysis | HTMLToken, TokenizerState, State Machine |\n| State Machine | Context-sensitive parsing algorithm tracking current parsing context and valid transitions | Core algorithm for HTML tokenizer handling context-dependent parsing rules | TokenizerState, State Transitions, Context Tracking |\n| Tree Construction | Building hierarchical DOM structure from token stream using stack-based algorithm | Second stage of HTML parsing that creates the document structure | TreeBuilder, Open Elements Stack, DOM Assembly |\n| Void Elements | Self-closing tags that cannot contain children like `br`, `img`, `input` | Special HTML elements requiring different parsing and tree construction logic | VOID_ELEMENTS constant, Self-Closing Tags |\n| Error Recovery | Graceful handling of malformed input with continuation of parsing process | Essential for real-world HTML which often contains syntax errors | HTMLErrorRecovery, Foster Parenting, Auto-Closing |\n| Foster Parenting | Moving misplaced HTML content to appropriate parent elements during tree construction | Specific error recovery mechanism for handling incorrectly nested elements | TreeBuilder algorithm, DOM correction |\n| Open Elements Stack | Stack tracking unclosed HTML elements during parsing for proper nesting validation | Core data structure in tree builder ensuring correct parent-child relationships | TreeBuilder state, Element nesting |\n| HTML Entities | Named character entity lookup table for converting `&amp;` to `&` etc | Text processing component handling special character encoding in HTML | HTML_ENTITIES constant, Entity Decoding |\n\n### CSS Parsing and Style Terms\n\nCSS processing introduces extensive terminology around selectors, properties, cascade resolution, and style computation.\n\n| Term | Definition | Context | Key Algorithms |\n|------|------------|---------|----------------|\n| CSS Cascade | Rule precedence resolution system implementing CSS specification for style conflicts | Determines final computed styles when multiple rules affect the same element | Cascade Algorithm, Specificity Comparison |\n| Specificity | CSS selector priority calculation as tuple (inline, ids, classes, elements) | Numerical weight system determining which CSS rules take precedence | Specificity calculation, Cascade Resolution |\n| Selector Matching | Testing if CSS rules apply to DOM elements based on selector patterns | Core algorithm connecting CSS rules to DOM elements for style application | matches_element function, Selector evaluation |\n| Computed Styles | Final resolved CSS property values after cascade, inheritance, and value computation | Result of style resolution process containing all properties needed for layout | ComputedStyle, Style Resolution Pipeline |\n| Inheritance | Automatic copying of properties from parent to child elements in DOM tree | CSS mechanism for style propagation through document hierarchy | Property inheritance, Parent-child relationships |\n| Combinator Selectors | CSS selectors with relationship operators like descendant, child, sibling | Advanced selector patterns expressing relationships between elements | Selector parsing, Relationship matching |\n| Shorthand Properties | CSS properties that set multiple values in single declaration like `margin: 10px` | Convenience syntax requiring expansion to individual property values | Property parsing, Value expansion |\n| Cascade Algorithm | Systematic process for resolving CSS rule conflicts through origin, specificity, and source order | Core CSS specification algorithm implemented in style resolution | Rule sorting, Precedence calculation |\n\n### Layout and Box Model Terms\n\nLayout computation involves precise terminology around geometric calculations, formatting contexts, and dimensional algorithms.\n\n| Term | Definition | Context | Mathematical Relationships |\n|------|------------|---------|---------------------------|\n| Formatting Context | Layout algorithm governing element arrangement (block or inline flow) | Determines how child elements are positioned within their container | Block Formatting, Inline Formatting |\n| Containing Block | Element establishing coordinate system and available space for child elements | Reference frame for percentage calculations and positioning | Coordinate System, Available Space |\n| Available Space | Dimensions accessible to child elements after subtracting parent padding/border | Constraint on child element sizing during layout calculation | Box Model, Dimension Calculation |\n| Margin Collapsing | CSS behavior combining adjacent margins into single margin value | Complex algorithm affecting vertical spacing between block elements | Margin calculation, Block layout |\n| Baseline Alignment | Vertical positioning of inline elements relative to text baseline | Typography-based positioning for inline and text elements | Inline Layout, Text Metrics |\n| Line Breaking | Algorithm for wrapping content to new lines at container boundaries | Text flow algorithm handling word wrapping and hyphenation | Inline Layout, Text Measurement |\n| Auto Margins | Margin values that adjust automatically based on available space | Special CSS value requiring constraint satisfaction algorithms | Centering, Space Distribution |\n| Percentage Units | CSS dimensions calculated relative to containing block dimensions | Relative sizing requiring parent dimension knowledge | Unit conversion, Relative sizing |\n| Over-Constraint Resolution | Handling impossible combinations of CSS layout values | Conflict resolution when CSS properties specify contradictory requirements | Constraint satisfaction, Fallback rules |\n\n### Rendering and Graphics Terms\n\nThe rendering stage introduces terminology around visual output, paint operations, and graphics optimization.\n\n| Term | Definition | Context | Optimization Considerations |\n|------|------------|---------|----------------------------|\n| Paint Command Generation | Converting layout tree into drawing operations for graphics backend | Translation from geometric layout to visual rendering instructions | PaintCommand creation, Display List |\n| Graphics Backend Abstraction | Interface over different graphics libraries for drawing primitives and text | Portability layer supporting multiple rendering targets | Hardware acceleration, Software fallback |\n| Z-Order | Depth ordering for element layering and visual stacking | Determines which elements appear in front of others | Stacking Context, Paint order |\n| Clipping Context | Restricted drawing region for child elements | Graphics optimization and visual containment | Viewport culling, Overdraw elimination |\n| Stacking Context | CSS layering and z-index management for complex layering scenarios | Advanced layout feature affecting paint order | Z-index, Layer management |\n| Viewport Culling | Optimization removing off-screen elements from rendering | Performance optimization reducing unnecessary drawing operations | Coordinate bounds checking |\n| Overdraw Elimination | Optimization removing occluded drawing operations | Graphics optimization reducing pixel fill operations | Occlusion testing, Layer optimization |\n| Command Batching | Grouping similar operations for efficiency | Graphics API optimization reducing state changes | Batch processing, GPU efficiency |\n| Subpixel Rendering | High-precision text rendering using fractional pixel positions | Typography enhancement for text clarity | Font rendering, Anti-aliasing |\n\n### Error Handling and Recovery Terms\n\nComprehensive error handling requires specific terminology around failure modes, recovery strategies, and diagnostic techniques.\n\n| Term | Definition | Context | Recovery Strategies |\n|------|------------|---------|-------------------|\n| Graceful Degradation | Maintaining functionality with reduced quality when errors occur | Overall error handling philosophy prioritizing continued operation | Progressive fallback, Quality reduction |\n| Error Recovery | Systematic strategies for handling failures while continuing processing | Essential capability for real-world robustness with malformed input | Recovery points, Continuation strategies |\n| Fallback Cascade | Progressive degradation through simpler rendering techniques | Layered approach to handling rendering failures | Hardware→Software→Simple rendering |\n| Recovery Point | Valid parsing position to resume after CSS syntax error | Parsing strategy for continuing after encountering malformed input | Parser state, Error boundaries |\n| Constraint Satisfaction | Resolving conflicting layout requirements through systematic algorithms | Layout algorithm handling impossible CSS property combinations | Over-constraint resolution |\n| Resource Pressure | Managing memory and graphics resource exhaustion | System-level error condition requiring resource management | Memory management, Resource limits |\n| Error Boundary Isolation | Containing failures to prevent cross-component cascading | Architectural strategy limiting error propagation between components | Component isolation, Failure containment |\n| Cascade Error Propagation | Coordinating error handling across pipeline stages | System-level error handling ensuring consistent behavior | Pipeline error handling |\n\n### Data Structure and Type System Terms\n\nThe browser engine relies on numerous specialized data structures, each with specific purposes and relationships.\n\n| Term | Definition | Key Fields | Usage Context |\n|------|------------|------------|---------------|\n| DOMNodeHandle | Reference to DOM node enabling tree navigation and manipulation | Opaque reference type | Tree traversal, Node relationships |\n| ElementData | HTML element information including tag name, attributes, and metadata | tag_name, attributes, namespace, is_void | Element representation, Attribute access |\n| DocumentData | Document-level metadata and configuration | doctype, title, base_url, character_encoding | Document properties, Global settings |\n| CSSRule | Complete CSS rule with selector, declarations, and metadata | selector, declarations, specificity, source_order | Style matching, Cascade resolution |\n| Selector | CSS selector pattern for matching elements | Universal, Type, Class, ID, Attribute variants | Element matching, Style application |\n| Specificity | CSS selector priority calculation tuple | inline, ids, classes, elements | Cascade algorithm, Rule precedence |\n| Declaration | CSS property-value pair with importance flag | property, value, important | Style declaration, Property application |\n| ComputedStyle | Final resolved CSS property values for layout | display, position, dimensions, colors, spacing | Layout input, Visual properties |\n| LayoutBox | Geometric layout information with box model rectangles | box_type, rectangles, children, computed_style | Layout tree, Geometric calculations |\n| BoxOffsets | Four-sided spacing values for margin, border, padding | top, right, bottom, left | Box model, Spacing calculations |\n\n### Debugging and Development Terms\n\nEffective debugging requires understanding diagnostic terminology and development workflow concepts.\n\n| Term | Definition | Application | Diagnostic Value |\n|------|------------|-------------|------------------|\n| Symptom-First Approach | Debugging methodology starting from observable problems | Start with visible issues, trace backwards to root causes | Systematic problem solving |\n| Hierarchical Visualization | Diagnostic technique showing tree structures with indentation | DOM tree, CSS rule hierarchy, layout tree inspection | Structure understanding |\n| Dimensional Visualization | Diagnostic technique showing box model rectangles | Layout debugging, box model verification | Geometric validation |\n| Flow Visualization | Diagnostic technique showing document layout flow | Block and inline layout debugging | Layout algorithm verification |\n| State Machine Instrumentation | Adding logging to parser state transitions | HTML/CSS parser debugging | Parse process understanding |\n| Rule Tracing | Debugging technique tracking CSS rule application | Style resolution debugging | Cascade algorithm verification |\n| Integration Testing | End-to-end tests validating complete rendering pipeline | Full system testing with real HTML/CSS examples | System validation |\n| Milestone Validation | Specific tests and expected behaviors after completing each milestone | Development progress verification | Implementation checkpoints |\n| Acceptance Criteria | Specific requirements that must be met for milestone completion | Quality gates for development milestones | Success measurement |\n\n### Advanced Features and Extensions\n\nFuture development involves terminology around advanced CSS features, performance optimization, and system scalability.\n\n| Term | Definition | Complexity Level | Implementation Scope |\n|------|------------|------------------|---------------------|\n| Flexbox | CSS flexible box layout system with intelligent space distribution | Advanced layout algorithm | Milestone extension |\n| CSS Grid | Two-dimensional layout system with precise positioning control | Complex layout system | Advanced feature |\n| CSS Transforms | Visual manipulation without affecting document layout | Graphics transformation | Rendering extension |\n| Animation Interpolation | Calculating intermediate values between keyframes | Mathematical animation system | Dynamic rendering |\n| Timing Functions | Mathematical curves controlling animation pacing | Animation mathematics | Smooth transitions |\n| Incremental Rendering | Optimization avoiding redundant work by processing only changes | Performance optimization | Scalability improvement |\n| Damage Tracking | Identifying screen regions needing repaint | Rendering optimization | Efficient updates |\n| Layout Caching | Preserving computed layout results for reuse | Performance optimization | Memory-speed tradeoff |\n| Multi-threaded Processing | Parallel execution across multiple CPU cores | Concurrency optimization | System scalability |\n| Version Tracking | Detecting changes through sequential numbering | Change detection system | Incremental updates |\n\n### Performance and Optimization Terms\n\nBrowser engines require extensive performance optimization terminology covering memory management, rendering efficiency, and system resource utilization.\n\n| Term | Definition | Measurement Approach | Optimization Impact |\n|------|------------|---------------------|-------------------|\n| Performance Profiling | Measuring and analyzing system performance characteristics | Timing measurements, resource usage monitoring | Bottleneck identification |\n| Memory Pressure | System resource exhaustion requiring optimization strategies | Memory usage tracking, allocation monitoring | Resource management |\n| Cache Efficiency | Effectiveness of caching strategies in reducing computation | Cache hit rates, computation savings | Performance improvement |\n| Frame Rate | Rendering performance measured in frames per second | Time-based performance measurement | User experience quality |\n| Bottleneck Component | System component limiting overall performance | Component-level timing analysis | Optimization prioritization |\n| Progressive Enhancement | Adding features while maintaining backward compatibility | Feature capability detection | System robustness |\n| Invalidation Propagation | Cascading change notifications through dependency chains | Change tracking, update coordination | Efficient updates |\n| Update Scheduler | System managing timing and coordination of rendering updates | Frame timing, update batching | Smooth rendering |\n\n### Implementation and Development Terms\n\nThe development process introduces terminology around code organization, testing strategies, and implementation validation.\n\n| Term | Definition | Development Phase | Quality Assurance |\n|------|------------|-------------------|-------------------|\n| Test Harness | Infrastructure for running and validating tests | Testing framework setup | Automated validation |\n| Reference Documents | Curated test inputs with known expected outputs | Test case development | Correctness verification |\n| File Structure Organization | Modular organization of codebase across parsing, styling, layout, and rendering modules | Project architecture | Code maintainability |\n| Component Interface Contracts | Formal specifications of data passed between pipeline stages | API design, system integration | Interface compliance |\n| Milestone Checkpoints | Specific tests and expected behaviors after each implementation stage | Development progress tracking | Quality gates |\n| External Validation | Debugging technique using reference implementations | Correctness verification against standards | Implementation validation |\n| Progressive Fallback | Rendering strategy with multiple quality levels | Error handling, system robustness | Graceful degradation |\n\n### Constants and Enumerations\n\nThe browser engine defines numerous constants and enumerated types for consistent behavior across components.\n\n| Constant/Enum | Value/Variants | Purpose | Usage Context |\n|---------------|----------------|---------|---------------|\n| WHITE | Color { r: 255, g: 255, b: 255, a: 255 } | Standard white color | Default backgrounds, text rendering |\n| BLACK | Color { r: 0, g: 0, b: 0, a: 255 } | Standard black color | Default text, borders |\n| TRANSPARENT | Color { r: 0, g: 0, b: 0, a: 0 } | Fully transparent color | Invisible elements, overlay effects |\n| VOID_ELEMENTS | [\"br\", \"hr\", \"img\", \"input\", \"meta\", \"link\"] | Self-closing HTML elements | HTML parsing, tree construction |\n| HTML_ENTITIES | {\"&amp;\": \"&\", \"&lt;\": \"<\", \"&gt;\": \">\"} | Named character entities | Text content processing |\n| TokenizerState | Data, TagOpen, TagName, BeforeAttributeName | HTML parsing states | Tokenizer state machine |\n| BoxType | BlockContainer, InlineContainer, TextBox | Layout box classifications | Layout tree construction |\n| Display | Block, Inline, None, Flex, Grid | CSS display property values | Layout algorithm selection |\n| Position | Static, Relative, Absolute, Fixed | CSS position property values | Positioning algorithm selection |\n| Unit | Px(f32), Percent(f32), Em(f32), Auto | CSS unit types | Dimension calculation |\n\n### Relationships and Dependencies\n\nUnderstanding how terminology relates across the system is crucial for implementation success. The browser engine's terminology forms interconnected networks of concepts that build upon each other systematically.\n\n> **Key Insight**: Browser engine terminology follows the data flow through the rendering pipeline. HTML parsing terms connect to DOM concepts, which connect to CSS terms, which connect to layout terms, which connect to rendering terms. Understanding these relationships helps navigate the complexity.\n\nThe **parsing domain** (tokenization, state machines, tree construction) connects to the **structure domain** (DOM trees, elements, attributes) which connects to the **styling domain** (selectors, cascade, computed styles) which connects to the **layout domain** (box model, formatting contexts, dimensions) which finally connects to the **rendering domain** (paint commands, graphics backends, visual output).\n\n**Error handling terminology** cuts across all domains, providing consistent recovery strategies and debugging approaches throughout the system. Similarly, **performance terminology** applies to all components but becomes increasingly important in layout and rendering where computational complexity is highest.\n\n**Advanced features** build upon the foundational terminology, extending basic concepts into more sophisticated algorithms and optimizations. Understanding the basic terminology thoroughly is essential before approaching advanced extensions like flexbox, animations, or incremental rendering.\n\n### Implementation Guidance\n\nThis glossary supports implementation by providing not just definitions but also context about how terminology translates into actual code structures and algorithms. Each term connects to specific data types, function signatures, and implementation patterns defined in the naming conventions.\n\nUnderstanding the precise meaning of each term helps avoid common implementation mistakes where similar concepts get confused or where terminology imprecision leads to incorrect algorithm implementation. For example, distinguishing between \"available space\" and \"containing block dimensions\" is crucial for correct box model calculations.\n\nThe terminology also provides a shared vocabulary for debugging and optimization discussions. When layout calculations produce incorrect results, being able to precisely describe the issue using terms like \"margin collapsing,\" \"over-constraint resolution,\" or \"percentage unit calculation\" enables more efficient problem-solving.\n"}