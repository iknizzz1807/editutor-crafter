{"html":"<h1 id=\"serverless-function-runtime-design-document\">Serverless Function Runtime: Design Document</h1>\n<h2 id=\"overview\">Overview</h2>\n<p>This system provides a platform for running ephemeral, event-driven functions without managing servers. The key architectural challenge it solves is balancing strong isolation and fast startup times (cold start optimization) while efficiently scaling from zero to handle unpredictable workloads.</p>\n<blockquote>\n<p>This guide is meant to help you understand the big picture before diving into each milestone. Refer back to it whenever you need context on how components connect.</p>\n</blockquote>\n<h2 id=\"context-and-problem-statement\">Context and Problem Statement</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> This foundational section establishes the core problem space that all subsequent milestones address: balancing isolation, speed, and efficiency in serverless function execution.</p>\n</blockquote>\n<p>Serverless computing represents a paradigm shift in how applications are built and deployed. Instead of provisioning and managing long-lived servers, developers write discrete functions that automatically scale and execute in response to events. The platform handles all infrastructure concerns—provisioning, scaling, patching, and monitoring—allowing developers to focus solely on business logic. This model offers compelling advantages: <strong>cost efficiency</strong> (pay only for execution time), <strong>elastic scaling</strong> (automatic response to load), and <strong>reduced operational overhead</strong> (no server management).</p>\n<p>However, beneath this simplified abstraction lies a complex technical challenge. Functions must execute with strong <strong>isolation</strong> (preventing one tenant&#39;s code from affecting another) while maintaining <strong>fast startup times</strong> (responding to requests within milliseconds) and <strong>resource efficiency</strong> (minimizing overhead for idle functions). These requirements often conflict, creating the central tension in serverless runtime design.</p>\n<h3 id=\"mental-model-the-instant-coffee-machine-vs-the-barista\">Mental Model: The Instant Coffee Machine vs. The Barista</h3>\n<p>To understand the fundamental trade-offs in serverless computing, consider two approaches to serving coffee:</p>\n<p><strong>The Instant Coffee Machine (Fast but Limited)</strong></p>\n<ul>\n<li><strong>Operation</strong>: Press a button → get coffee instantly</li>\n<li><strong>Preparation</strong>: Coffee is pre-ground, pre-measured, and pre-packaged in single-serving capsules</li>\n<li><strong>Customization</strong>: Limited to pre-defined options (espresso, lungo, americano)</li>\n<li><strong>Isolation</strong>: Each capsule is completely self-contained; no cross-contamination between servings</li>\n<li><strong>Cleanup</strong>: Capsule is discarded; machine is ready for next user immediately</li>\n<li><strong>Analogous to</strong>: Pre-initialized, templated execution environments with limited runtime customization</li>\n</ul>\n<p><strong>The Barista (Customizable but Slower)</strong></p>\n<ul>\n<li><strong>Operation</strong>: Place order → barista grinds beans, tamps, steams milk, pours art</li>\n<li><strong>Preparation</strong>: Everything done fresh per order with high-quality ingredients</li>\n<li><strong>Customization</strong>: Infinite variations (bean origin, grind size, milk temperature, syrup)</li>\n<li><strong>Isolation</strong>: Shared equipment cleaned between uses (risk of cross-contamination)</li>\n<li><strong>Cleanup</strong>: Thorough cleaning of portafilter, steam wand, and work area required</li>\n<li><strong>Analogous to</strong>: Full container or VM per function with complete environment customization</li>\n</ul>\n<p>The instant coffee machine represents the ideal of serverless: <strong>predictable, fast, and isolated execution</strong>. Each function invocation gets its own &quot;capsule&quot;—a pre-packaged execution environment that starts instantly. However, this comes at the cost of flexibility: you&#39;re limited to the runtimes and dependencies that fit in the capsule format.</p>\n<p>The barista model offers maximum flexibility: you can bring any coffee beans (dependencies), any milk (runtime version), and request any preparation method (custom initialization). But each order takes time to prepare, and thorough cleaning is needed between customers to prevent flavor mixing (security isolation).</p>\n<p>The challenge in building a serverless runtime is creating a system that feels like an <strong>instant coffee machine</strong> to the user (fast, simple, predictable) while internally supporting the <strong>flexibility of a barista</strong> (arbitrary code, dependencies, runtimes). We need the speed of pre-packaged execution with the isolation guarantees of fresh preparation for each customer.</p>\n<h3 id=\"the-core-technical-challenge-isolation-vs-speed\">The Core Technical Challenge: Isolation vs. Speed</h3>\n<p>The fundamental tension in serverless runtime design manifests as a three-way optimization problem between <strong>isolation strength</strong>, <strong>startup latency</strong>, and <strong>resource efficiency</strong>.</p>\n<p><strong>Isolation Requirements</strong>\nServerless platforms typically host code from multiple untrusted tenants on shared hardware. Strong isolation is non-negotiable to prevent:</p>\n<ul>\n<li><strong>Resource interference</strong>: One function consuming all CPU/memory/IO, starving others</li>\n<li><strong>Security breaches</strong>: A function accessing another tenant&#39;s data or code</li>\n<li><strong>Noisy neighbors</strong>: Performance degradation due to shared resources</li>\n<li><strong>Privilege escalation</strong>: Gaining host-level access through kernel vulnerabilities</li>\n</ul>\n<p><strong>Startup Latency Constraints</strong>\nThe &quot;serverless promise&quot; includes sub-second response times, even for the first invocation (cold start). Real-world applications have strict latency budgets:</p>\n<ul>\n<li><strong>User-facing APIs</strong>: Typically require &lt; 200ms total response time</li>\n<li><strong>Event processing</strong>: Often batch processing with &lt; 1s latency requirements</li>\n<li><strong>Cold start penalty</strong>: The additional time to initialize a function from scratch</li>\n</ul>\n<p><strong>Resource Efficiency Demands</strong>\nSince customers pay only for execution time, the platform must minimize overhead:</p>\n<ul>\n<li><strong>Memory footprint</strong>: Idle environments consume memory even when not executing</li>\n<li><strong>CPU overhead</strong>: Environment creation/teardown consumes CPU cycles</li>\n<li><strong>Storage costs</strong>: Function packages and runtime images require storage</li>\n<li><strong>Network bandwidth</strong>: Downloading dependencies on each cold start</li>\n</ul>\n<p>This creates a challenging optimization landscape:</p>\n<table>\n<thead>\n<tr>\n<th>Goal</th>\n<th>Improves</th>\n<th>Conflicts With</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Stronger isolation</td>\n<td>Security, reliability</td>\n<td>Startup speed (more setup), Resource efficiency (more overhead)</td>\n</tr>\n<tr>\n<td>Faster startup</td>\n<td>User experience, throughput</td>\n<td>Isolation (less validation), Efficiency (pre-warming costs)</td>\n</tr>\n<tr>\n<td>Higher efficiency</td>\n<td>Cost reduction, density</td>\n<td>Isolation (sharing resources), Startup speed (less pre-warming)</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>Key Insight</strong>: The &quot;cold start problem&quot; is not just about speed—it&#39;s the visible symptom of this deeper trade-off. When we optimize for isolation (fresh environment per invocation) and efficiency (no pre-warmed instances), we necessarily sacrifice startup speed. Conversely, when we optimize for speed (pre-warmed pools), we sacrifice efficiency (idle resource consumption) and potentially isolation (shared/reused environments).</p>\n</blockquote>\n<p><strong>Formalizing the Problem</strong>\nGiven:</p>\n<ul>\n<li>A set of functions <code>F = {f₁, f₂, ..., fₙ}</code> with arbitrary code and dependencies</li>\n<li>A stream of invocation requests <code>R = {r₁(t₁), r₂(t₂), ...}</code> at unpredictable times</li>\n<li>Hardware resources <code>H = {CPU, memory, storage, network}</code> shared across tenants</li>\n<li>Security requirements <code>S = {isolation, quotas, audit}</code> for multi-tenancy</li>\n</ul>\n<p>Design a runtime system that:</p>\n<ol>\n<li><strong>Minimizes P99 latency</strong>: <code>P99(response_time(rᵢ)) ≤ L_max</code> (e.g., 200ms)</li>\n<li><strong>Enforces strong isolation</strong>: <code>∀fᵢ, fⱼ ∈ F, i ≠ j: isolation(fᵢ, fⱼ) ≥ I_min</code></li>\n<li><strong>Maximizes resource utilization</strong>: <code>utilization(H) → 1</code> while <code>cost → min</code></li>\n<li><strong>Scales elastically</strong>: <code>instances(fᵢ) ∝ load(fᵢ)</code> with minimal hysteresis</li>\n</ol>\n<p>This is the core problem our serverless runtime must solve, and each milestone represents a piece of the solution.</p>\n<h3 id=\"survey-of-existing-approaches\">Survey of Existing Approaches</h3>\n<p>The industry has explored multiple isolation technologies for serverless workloads, each with different trade-offs on the isolation-speed-efficiency spectrum. Understanding these approaches informs our architecture decisions.</p>\n<p><strong>1. Linux Container Namespaces &amp; cgroups (Docker-like)</strong></p>\n<table>\n<thead>\n<tr>\n<th>Aspect</th>\n<th>Characteristics</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Isolation Mechanism</strong></td>\n<td>Kernel namespaces (pid, net, mount, user, ipc, uts) + cgroups for resource limits</td>\n</tr>\n<tr>\n<td><strong>Startup Time</strong></td>\n<td>100-500ms for fresh container, ~50ms for pre-initialized</td>\n</tr>\n<tr>\n<td><strong>Isolation Strength</strong></td>\n<td>Moderate (shared kernel, potential for kernel exploits)</td>\n</tr>\n<tr>\n<td><strong>Memory Overhead</strong></td>\n<td>Low (~10MB per container for runtime)</td>\n</tr>\n<tr>\n<td><strong>Implementation Complexity</strong></td>\n<td>Medium (leveraging existing container runtimes)</td>\n</tr>\n<tr>\n<td><strong>Multi-tenant Security</strong></td>\n<td>Requires additional hardening (seccomp, AppArmor, SELinux)</td>\n</tr>\n</tbody></table>\n<p><strong>Pros</strong>:</p>\n<ul>\n<li>Mature ecosystem (Docker, containerd, CRI-O)</li>\n<li>Fast startup with image layering and copy-on-write</li>\n<li>Low overhead compared to full virtualization</li>\n<li>Excellent tooling for packaging and distribution</li>\n</ul>\n<p><strong>Cons</strong>:</p>\n<ul>\n<li>Shared kernel creates larger attack surface</li>\n<li>Requires careful configuration for production multi-tenancy</li>\n<li>Namespace escape vulnerabilities periodically discovered</li>\n<li>Less familiar to non-Linux developers</li>\n</ul>\n<p><strong>Use Cases</strong>: AWS Lambda (2018-2020), Google Cloud Run, OpenFaaS, most on-prem serverless platforms.</p>\n<p><strong>2. MicroVMs (Firecracker)</strong></p>\n<table>\n<thead>\n<tr>\n<th>Aspect</th>\n<th>Characteristics</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Isolation Mechanism</strong></td>\n<td>Hardware virtualization (KVM) with minimal, specialized hypervisor</td>\n</tr>\n<tr>\n<td><strong>Startup Time</strong></td>\n<td>125-150ms for fresh microVM, &lt;10ms from snapshot</td>\n</tr>\n<tr>\n<td><strong>Isolation Strength</strong></td>\n<td>Very high (hardware-enforced isolation)</td>\n</tr>\n<tr>\n<td><strong>Memory Overhead</strong></td>\n<td>Moderate (~5MB per microVM + guest memory)</td>\n</tr>\n<tr>\n<td><strong>Implementation Complexity</strong></td>\n<td>High (managing VMM lifecycle, device models)</td>\n</tr>\n<tr>\n<td><strong>Multi-tenant Security</strong></td>\n<td>Excellent (hardware isolation, minimal attack surface)</td>\n</tr>\n</tbody></table>\n<p><strong>Pros</strong>:</p>\n<ul>\n<li>Near-bare-metal performance with hardware isolation</li>\n<li>Extremely fast snapshot/restore (&lt;10ms)</li>\n<li>Minimal attack surface (Firecracker &lt;50K lines vs QEMU 1.5M)</li>\n<li>Designed specifically for serverless workloads</li>\n</ul>\n<p><strong>Cons</strong>:</p>\n<ul>\n<li>Still heavier than containers</li>\n<li>More complex to integrate with container ecosystem</li>\n<li>Limited device support (intentionally)</li>\n<li>Requires virtualization extensions (Intel VT-x/AMD-V)</li>\n</ul>\n<p><strong>Use Cases</strong>: AWS Lambda (current), AWS Fargate, Cloudflare Workers (isolates).</p>\n<p><strong>3. Process-based Sandboxes (gVisor, nsjail)</strong></p>\n<table>\n<thead>\n<tr>\n<th>Aspect</th>\n<th>Characteristics</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Isolation Mechanism</strong></td>\n<td>Userspace kernel implementation + namespace isolation</td>\n</tr>\n<tr>\n<td><strong>Startup Time</strong></td>\n<td>20-100ms (lightweight process creation)</td>\n</tr>\n<tr>\n<td><strong>Isolation Strength</strong></td>\n<td>High (syscall filtering, userspace kernel)</td>\n</tr>\n<tr>\n<td><strong>Memory Overhead</strong></td>\n<td>Low to moderate (shared runsc runtime)</td>\n</tr>\n<tr>\n<td><strong>Implementation Complexity</strong></td>\n<td>High (custom kernel implementation)</td>\n</tr>\n<tr>\n<td><strong>Multi-tenant Security</strong></td>\n<td>Very good (syscall interception, no shared kernel)</td>\n</tr>\n</tbody></table>\n<p><strong>Pros</strong>:</p>\n<ul>\n<li>No virtualization required</li>\n<li>Fast startup (lightweight processes)</li>\n<li>Strong isolation without VM overhead</li>\n<li>Compatible with container images</li>\n</ul>\n<p><strong>Cons</strong>:</p>\n<ul>\n<li>Performance overhead for syscall-heavy workloads</li>\n<li>Compatibility issues with some syscalls</li>\n<li>Complex implementation and debugging</li>\n<li>Less battle-tested than containers/VMs</li>\n</ul>\n<p><strong>Use Cases</strong>: Google Cloud Run (gVisor), sandboxed CI/CD environments.</p>\n<p><strong>4. Language-Specific Runtimes (WebAssembly)</strong></p>\n<table>\n<thead>\n<tr>\n<th>Aspect</th>\n<th>Characteristics</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Isolation Mechanism</strong></td>\n<td>Capability-based security within runtime</td>\n</tr>\n<tr>\n<td><strong>Startup Time</strong></td>\n<td>&lt;1ms (pre-compiled bytecode)</td>\n</tr>\n<tr>\n<td><strong>Isolation Strength</strong></td>\n<td>Language-dependent (memory-safe languages higher)</td>\n</tr>\n<tr>\n<td><strong>Memory Overhead</strong></td>\n<td>Very low (shared runtime, per-instance memory)</td>\n</tr>\n<tr>\n<td><strong>Implementation Complexity</strong></td>\n<td>High (per-language runtime modifications)</td>\n</tr>\n<tr>\n<td><strong>Multi-tenant Security</strong></td>\n<td>Good within runtime, depends on host isolation</td>\n</tr>\n</tbody></table>\n<p><strong>Pros</strong>:</p>\n<ul>\n<li>Extremely fast startup (pre-compiled)</li>\n<li>Portable across platforms</li>\n<li>Fine-grained resource control</li>\n<li>Growing ecosystem</li>\n</ul>\n<p><strong>Cons</strong>:</p>\n<ul>\n<li>Limited language support</li>\n<li>System call interface still evolving</li>\n<li>Less mature tooling</li>\n<li>Runtime-specific vulnerabilities possible</li>\n</ul>\n<p><strong>Use Cases</strong>: Fastly Compute@Edge, Fermyon Spin, experimental platforms.</p>\n<p><strong>Comparison Table</strong></p>\n<table>\n<thead>\n<tr>\n<th>Technology</th>\n<th>Startup Time</th>\n<th>Isolation</th>\n<th>Overhead</th>\n<th>Maturity</th>\n<th>Our Use Case</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Containers</strong></td>\n<td>100-500ms</td>\n<td>Moderate</td>\n<td>Low</td>\n<td>Very High</td>\n<td>Baseline for comparison, good starting point</td>\n</tr>\n<tr>\n<td><strong>MicroVMs</strong></td>\n<td>10-150ms</td>\n<td>Very High</td>\n<td>Moderate</td>\n<td>High</td>\n<td>Production multi-tenant with strong security</td>\n</tr>\n<tr>\n<td><strong>Process Sandboxes</strong></td>\n<td>20-100ms</td>\n<td>High</td>\n<td>Low-Moderate</td>\n<td>Medium</td>\n<td>When virtualization unavailable, good security</td>\n</tr>\n<tr>\n<td><strong>WebAssembly</strong></td>\n<td>&lt;1ms</td>\n<td>Language-dependent</td>\n<td>Very Low</td>\n<td>Emerging</td>\n<td>Specialized use cases, fastest cold starts</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>Decision: Container-Based Isolation for Initial Implementation</strong></p>\n<ul>\n<li><strong>Context</strong>: We need a practical starting point that balances implementation complexity, performance, and isolation while leveraging existing ecosystems.</li>\n<li><strong>Options Considered</strong>: <ol>\n<li>Linux containers (namespaces + cgroups)</li>\n<li>Firecracker microVMs</li>\n<li>gVisor process sandboxes</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Start with container-based isolation using runc/containerd.</li>\n<li><strong>Rationale</strong>: <ul>\n<li>Containers provide sufficient isolation for many use cases with proper hardening</li>\n<li>Vast ecosystem for packaging, distribution, and management</li>\n<li>Easier debugging and development experience</li>\n<li>Can be augmented with additional security (seccomp, AppArmor)</li>\n<li>Natural migration path to microVMs later via containerd&#39;s shim API</li>\n</ul>\n</li>\n<li><strong>Consequences</strong>:<ul>\n<li>We&#39;ll need to implement additional security hardening for production</li>\n<li>Cold starts will be slower than microVM snapshot/restore</li>\n<li>We can later swap container runtime for Firecracker with minimal API changes</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<p><strong>Industry Trend: Blending Approaches</strong>\nModern serverless platforms often combine multiple isolation technologies:</p>\n<ul>\n<li><strong>AWS Lambda</strong>: Uses Firecracker microVMs but maintains container compatibility via OCI images</li>\n<li><strong>Google Cloud Run</strong>: Offers both gVisor and container-based isolation options</li>\n<li><strong>Azure Container Instances</strong>: Uses Hyper-V isolation for multi-tenant, containers for single-tenant</li>\n<li><strong>OpenFaaS</strong>: Primarily container-based but supports Kata Containers (lightweight VMs)</li>\n</ul>\n<p>The trend is toward <strong>defense-in-depth</strong>: using stronger isolation for less-trusted workloads while optimizing for speed where appropriate. Our architecture should support this evolution.</p>\n<p><strong>Common Pitfalls in Isolation Technology Selection</strong></p>\n<p>⚡ <strong>Pitfall: Over-engineering isolation for all use cases</strong></p>\n<ul>\n<li><strong>Description</strong>: Implementing the strongest possible isolation (e.g., full VMs) for all functions, even internal trusted functions.</li>\n<li><strong>Why it&#39;s wrong</strong>: Creates unnecessary overhead, slower startups, and higher costs without corresponding security benefit.</li>\n<li><strong>How to avoid</strong>: Implement tiered isolation levels based on function trust level or tenant requirements.</li>\n</ul>\n<p>⚡ <strong>Pitfall: Underestimating kernel attack surface</strong></p>\n<ul>\n<li><strong>Description</strong>: Assuming container isolation is &quot;secure enough&quot; without additional hardening.</li>\n<li><strong>Why it&#39;s wrong</strong>: New container escape vulnerabilities are regularly discovered (e.g., CVE-2019-5736 runc escape).</li>\n<li><strong>How to avoid</strong>: Always enable seccomp, AppArmor/SELinux, and capability dropping. Consider gVisor or microVMs for untrusted code.</li>\n</ul>\n<p>⚡ <strong>Pitfall: Ignoring initialization time variability</strong></p>\n<ul>\n<li><strong>Description</strong>: Assuming all functions have similar startup characteristics regardless of runtime.</li>\n<li><strong>Why it&#39;s wrong</strong>: JVM functions take ~1s+ to start, Python ~100ms, Go binary ~10ms.</li>\n<li><strong>How to avoid</strong>: Measure actual startup times per runtime and adjust warm pool strategies accordingly.</li>\n</ul>\n<p>⚡ <strong>Pitfall: Tight coupling to specific isolation technology</strong></p>\n<ul>\n<li><strong>Description</strong>: Building the entire system around Docker API calls or Firecracker-specific features.</li>\n<li><strong>Why it&#39;s wrong</strong>: Makes migration to new technologies difficult as the ecosystem evolves.</li>\n<li><strong>How to avoid</strong>: Define abstraction interfaces (ContainerManager, SandboxManager) that can have multiple implementations.</li>\n</ul>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>While this section focuses on problem definition rather than implementation, we&#39;ll establish the foundational project structure and provide tools to explore the isolation technologies discussed.</p>\n<p><strong>A. Technology Recommendations Table</strong></p>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option (Learning)</th>\n<th>Production Option (Advanced)</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Isolation</strong></td>\n<td>Docker Engine API</td>\n<td>containerd + runc</td>\n</tr>\n<tr>\n<td><strong>Orchestration</strong></td>\n<td>Custom Go controller</td>\n<td>Kubernetes Custom Resources</td>\n</tr>\n<tr>\n<td><strong>Storage</strong></td>\n<td>Local filesystem</td>\n<td>S3-compatible object storage</td>\n</tr>\n<tr>\n<td><strong>Networking</strong></td>\n<td>Docker bridge network</td>\n<td>CNI plugins (bridge, macvlan)</td>\n</tr>\n<tr>\n<td><strong>Monitoring</strong></td>\n<td>Prometheus metrics</td>\n<td>OpenTelemetry + distributed tracing</td>\n</tr>\n</tbody></table>\n<p><strong>B. Recommended File/Module Structure</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>serverless-runtime/\n├── cmd/\n│   ├── controller/          # Main orchestrator\n│   │   └── main.go\n│   ├── gateway/             # HTTP gateway\n│   │   └── main.go\n│   └── worker/              # Worker node daemon\n│       └── main.go\n├── internal/\n│   ├── api/                 # Public API definitions\n│   │   ├── types.go         # Request/response types\n│   │   └── server.go        # HTTP handlers\n│   ├── container/           # Container abstraction layer\n│   │   ├── manager.go       # ContainerManager interface\n│   │   ├── docker.go        # Docker implementation\n│   │   └── firecracker.go   # Firecracker implementation (future)\n│   ├── registry/            # Function package storage\n│   │   ├── storage.go       # Storage interface\n│   │   ├── s3.go            # S3 implementation\n│   │   └── local.go         # Local filesystem implementation\n│   ├── scheduler/           # Request routing &amp; scaling\n│   │   ├── gateway.go       # HTTP gateway logic\n│   │   ├── scaler.go        # Auto-scaling logic\n│   │   └── queue.go         # Request queue\n│   └── runtime/             # Language-specific runtime support\n│       ├── builder.go       # Function package builder\n│       ├── go.go            # Go runtime\n│       ├── python.go        # Python runtime\n│       └── nodejs.go        # Node.js runtime\n├── pkg/\n│   ├── function/            # Function definition types\n│   │   └── types.go\n│   ├── invocation/          # Invocation tracking\n│   │   └── types.go\n│   └── metrics/             # Metrics collection\n│       └── collector.go\n├── scripts/\n│   ├── benchmark/           # Performance testing\n│   └── setup/               # Environment setup\n├── go.mod\n└── README.md</code></pre></div>\n\n<p><strong>C. Infrastructure Starter Code: Container Exploration Tool</strong></p>\n<p>To understand the practical differences between isolation technologies, here&#39;s a tool that measures startup times:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// cmd/explore/main.go - Container isolation exploration tool</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> main</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">log</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">github.com/docker/docker/api/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">github.com/docker/docker/api/types/container</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">github.com/docker/docker/client</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> IsolationBenchmark</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tTechnology </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tImage      </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tCommand    []</span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tbenchmarks </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#B392F0\">IsolationBenchmark</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tTechnology: </span><span style=\"color:#9ECBFF\">\"Container (Alpine)\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tImage:      </span><span style=\"color:#9ECBFF\">\"alpine:latest\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tCommand:    []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"echo\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"Hello from container\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tTechnology: </span><span style=\"color:#9ECBFF\">\"Container (Python)\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tImage:      </span><span style=\"color:#9ECBFF\">\"python:3.9-slim\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tCommand:    []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"python\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"-c\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"print('Python ready')\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t},</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t\t// Add more benchmarks for different technologies</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tcli, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> client.</span><span style=\"color:#B392F0\">NewClientWithOpts</span><span style=\"color:#E1E4E8\">(client.FromEnv, client.</span><span style=\"color:#B392F0\">WithAPIVersionNegotiation</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tlog.</span><span style=\"color:#B392F0\">Fatal</span><span style=\"color:#E1E4E8\">(err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tfmt.</span><span style=\"color:#B392F0\">Println</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Isolation Technology Benchmark\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tfmt.</span><span style=\"color:#B392F0\">Println</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"==============================\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tfor</span><span style=\"color:#E1E4E8\"> _, bench </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> benchmarks {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tfmt.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">Benchmarking: </span><span style=\"color:#79B8FF\">%s\\n</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, bench.Technology)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t\t// Pull image (simulates dependency download)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tstart </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tfmt.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"  Pulling image </span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">... \"</span><span style=\"color:#E1E4E8\">, bench.Image)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\treader, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cli.</span><span style=\"color:#B392F0\">ImagePull</span><span style=\"color:#E1E4E8\">(ctx, bench.Image, </span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ImagePullOptions</span><span style=\"color:#E1E4E8\">{})</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tlog.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Failed to pull image: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\t\tcontinue</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t\t// Drain the reader</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tbuf </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">1024</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\tfor</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t_, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> reader.</span><span style=\"color:#B392F0\">Read</span><span style=\"color:#E1E4E8\">(buf)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\t\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\t\t\tbreak</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\treader.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tpullTime </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(start)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tfmt.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">%v\\n</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, pullTime)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t\t// Create container (environment setup)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tstart </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tfmt.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"  Creating container... \"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tresp, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cli.</span><span style=\"color:#B392F0\">ContainerCreate</span><span style=\"color:#E1E4E8\">(ctx, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">container</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tImage: bench.Image,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tCmd:   bench.Command,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t}, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tlog.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Failed to create container: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\t\tcontinue</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tcreateTime </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(start)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tfmt.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">%v\\n</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, createTime)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t\t// Start container (runtime initialization)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tstart </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tfmt.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"  Starting container... \"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\terr </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> cli.</span><span style=\"color:#B392F0\">ContainerStart</span><span style=\"color:#E1E4E8\">(ctx, resp.ID, </span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ContainerStartOptions</span><span style=\"color:#E1E4E8\">{})</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tlog.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Failed to start container: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\t\tcontinue</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tstartTime </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(start)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tfmt.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">%v\\n</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, startTime)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t\t// Wait for completion (execution time)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tstatusCh, errCh </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cli.</span><span style=\"color:#B392F0\">ContainerWait</span><span style=\"color:#E1E4E8\">(ctx, resp.ID, container.WaitConditionNotRunning)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\tselect</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\tcase</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">errCh:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\t\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t\tlog.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Error waiting for container: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\tcase</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">statusCh:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t\t\t// Container finished</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t\t// Clean up</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t_ </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> cli.</span><span style=\"color:#B392F0\">ContainerRemove</span><span style=\"color:#E1E4E8\">(ctx, resp.ID, </span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ContainerRemoveOptions</span><span style=\"color:#E1E4E8\">{})</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tfmt.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"  Total cold start: </span><span style=\"color:#79B8FF\">%v\\n</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, pullTime</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">createTime</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">startTime)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>D. Core Logic Skeleton: Isolation Interface</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/container/manager.go - Abstract isolation interface</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> container</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">io</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ContainerManager defines the interface for managing isolated execution environments.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// This abstraction allows swapping Docker for Firecracker or other technologies.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ContainerManager</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// CreateContainer creates a new isolated environment from an image</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Validate image exists locally, pull if missing with retry logic</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Generate unique container ID for tracking</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Apply resource limits (CPU, memory) from config</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Set up namespaces and cgroups for isolation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 5: Mount function code volume at /function</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 6: Configure network namespace (bridge, host, or none)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 7: Set up seccomp and AppArmor profiles for security</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">\tCreateContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#B392F0\"> CreateContainerRequest</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Container</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// StartContainer begins execution of the container</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Validate container is in created state</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Start the container process with proper stdio pipes</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Wait for container to reach running state (health check)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Start timeout timer for startup</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 5: Log container startup events for debugging</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">\tStartContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// ExecuteInContainer runs a command inside a running container</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Validate container is running</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Create exec instance with command and environment</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Attach to stdin/stdout/stderr streams</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Start execution and monitor for completion</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 5: Handle timeouts and cancellations</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 6: Capture exit code and output</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">\tExecuteInContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">cmd</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">\t\tinput</span><span style=\"color:#B392F0\"> io</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Reader</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">output</span><span style=\"color:#B392F0\"> io</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Writer</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// StopContainer gracefully stops a running container</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Send SIGTERM to container process</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Wait for graceful shutdown (configurable timeout)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: If timeout exceeded, send SIGKILL</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Ensure all resources are cleaned up</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">\tStopContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">timeout</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// RemoveContainer cleans up container resources</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Ensure container is stopped</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Remove container filesystem</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Clean up network namespace</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Remove cgroup</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 5: Delete container metadata</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">\tRemoveContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// GetContainerStats returns resource usage statistics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Read cgroup metrics for CPU, memory, I/O</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Calculate utilization percentages</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Include network statistics if available</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Return structured metrics for monitoring</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">\tGetContainerStats</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">ContainerStats</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// ListContainers returns all managed containers</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Query container runtime for all containers</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Filter by labels (e.g., function-id)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Include status and resource information</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Support pagination for large numbers</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">\tListContainers</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">filter</span><span style=\"color:#B392F0\"> ListFilter</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">Container</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Container represents an isolated execution environment</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Container</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tID        </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tImage     </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tStatus    </span><span style=\"color:#B392F0\">ContainerStatus</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tCreatedAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tLabels    </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO: Add resource limits, network info, mount points</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ContainerStatus</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tStatusCreated</span><span style=\"color:#B392F0\">    ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"created\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tStatusRunning</span><span style=\"color:#B392F0\">    ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"running\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tStatusPaused</span><span style=\"color:#B392F0\">     ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"paused\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tStatusRestarting</span><span style=\"color:#B392F0\"> ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"restarting\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tStatusExited</span><span style=\"color:#B392F0\">     ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"exited\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tStatusDead</span><span style=\"color:#B392F0\">       ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"dead\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> CreateContainerRequest</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tImage        </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tCmd          []</span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tEnv          []</span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tLabels       </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tCPUQuota     </span><span style=\"color:#F97583\">int64</span><span style=\"color:#6A737D\">    // in microseconds</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tMemoryLimit  </span><span style=\"color:#F97583\">int64</span><span style=\"color:#6A737D\">    // in bytes</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tNetworkMode  </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tBinds        []</span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // volume mounts</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO: Add security options, working directory, user</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// internal/container/docker.go - Docker implementation skeleton</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> DockerManager</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tclient </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">docker</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewDockerManager</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DockerManager</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Initialize Docker client with proper options</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Verify Docker daemon is reachable</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Set up context with timeout</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Configure client for API version negotiation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">dm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DockerManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">CreateContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#B392F0\"> CreateContainerRequest</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Container</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO: Implement using Docker SDK</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>E. Language-Specific Hints for Go</strong></p>\n<ol>\n<li><p><strong>Docker SDK</strong>: Use <code>github.com/docker/docker/client</code> for the official Go client. Remember to negotiate API version: <code>client.WithAPIVersionNegotiation()</code>.</p>\n</li>\n<li><p><strong>Context Usage</strong>: Always pass <code>context.Context</code> to container operations for cancellation and timeouts. Use <code>context.WithTimeout</code> for operations that should have deadlines.</p>\n</li>\n<li><p><strong>Resource Limits</strong>: When setting cgroup limits via Docker:</p>\n</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">   // CPU: 100000 means 100% of one CPU core, 50000 means 50%</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   HostConfig: </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">container</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HostConfig</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">       Resources: </span><span style=\"color:#B392F0\">container</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Resources</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">           CPUQuota:  </span><span style=\"color:#79B8FF\">50000</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#6A737D\">// 0.5 CPU</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">           Memory:    </span><span style=\"color:#79B8FF\">128</span><span style=\"color:#F97583\"> *</span><span style=\"color:#79B8FF\"> 1024</span><span style=\"color:#F97583\"> *</span><span style=\"color:#79B8FF\"> 1024</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#6A737D\">// 128MB</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">       },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   }</span></span></code></pre></div>\n\n<ol start=\"4\">\n<li><p><strong>Error Handling</strong>: Container operations can fail in many ways. Check for:</p>\n<ul>\n<li><code>errdefs.IsNotFound(err)</code> for missing images/containers</li>\n<li><code>errdefs.IsConflict(err)</code> for concurrent modifications</li>\n<li><code>errdefs.IsNotModified(err)</code> for idempotent operations</li>\n</ul>\n</li>\n<li><p><strong>Cleanup</strong>: Always implement defer or finally blocks to clean up containers, especially in error paths to prevent resource leaks.</p>\n</li>\n</ol>\n<p><strong>F. Milestone Checkpoint: Understanding Isolation Technologies</strong></p>\n<p>After studying this section, you should be able to:</p>\n<ol>\n<li><strong>Run the exploration tool</strong> to measure container startup times:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#79B8FF\">   cd</span><span style=\"color:#9ECBFF\"> serverless-runtime</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   go</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#9ECBFF\"> cmd/explore/main.go</span></span></code></pre></div>\n<p>   Expected output shows timing for different container types.</p>\n<ol start=\"2\">\n<li><p><strong>Understand the trade-offs</strong> by answering:</p>\n<ul>\n<li>Why would you choose containers over VMs for internal functions?</li>\n<li>What additional security measures would you add to containers for production?</li>\n<li>How does startup time change with image size?</li>\n</ul>\n</li>\n<li><p><strong>Experiment with security profiles</strong>:</p>\n</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">   # Run a container with seccomp profile</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   docker</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#79B8FF\"> --security-opt</span><span style=\"color:#9ECBFF\"> seccomp=default.json</span><span style=\"color:#9ECBFF\"> alpine</span><span style=\"color:#9ECBFF\"> echo</span><span style=\"color:#9ECBFF\"> \"hello\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">   # Run without any capabilities</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   docker</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#79B8FF\"> --cap-drop=ALL</span><span style=\"color:#9ECBFF\"> alpine</span><span style=\"color:#9ECBFF\"> echo</span><span style=\"color:#9ECBFF\"> \"hello\"</span></span></code></pre></div>\n\n<p><strong>G. Debugging Tips: Container Startup Issues</strong></p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>How to Diagnose</th>\n<th>Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Container fails to start with &quot;exec format error&quot;</strong></td>\n<td>Wrong architecture or corrupted image</td>\n<td><code>docker image inspect &lt;image&gt;</code> check architecture</td>\n<td>Pull correct image, verify download integrity</td>\n</tr>\n<tr>\n<td><strong>Container starts but immediately exits</strong></td>\n<td>Missing command or entrypoint</td>\n<td><code>docker logs &lt;container&gt;</code> for error messages</td>\n<td>Specify CMD in Dockerfile or override at runtime</td>\n</tr>\n<tr>\n<td><strong>Permission denied errors in container</strong></td>\n<td>User/group mismatch or SELinux/AppArmor</td>\n<td><code>docker run --security-opt apparmor=unconfined</code> test</td>\n<td>Fix file permissions or adjust security profile</td>\n</tr>\n<tr>\n<td><strong>High memory usage reported</strong></td>\n<td>Memory limit not applied</td>\n<td><code>docker stats</code> shows actual usage</td>\n<td>Verify memory limit in container config, check for memory leaks</td>\n</tr>\n<tr>\n<td><strong>Slow container startup</strong></td>\n<td>Large image layers or slow storage</td>\n<td><code>time docker run --rm alpine true</code> measure</td>\n<td>Use smaller base images, enable layer caching</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"goals-and-non-goals\">Goals and Non-Goals</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> This foundational section establishes the guiding principles and constraints that shape all subsequent design decisions across Milestones 1-5. It defines the measurable success criteria for the entire runtime system and explicitly scopes the project to a manageable, focused initial implementation.</p>\n</blockquote>\n<p>This section crystallizes the <strong>what</strong> and <strong>what not</strong> of our serverless runtime. Given the vast landscape of possible features in cloud computing, explicit boundaries are essential to maintain project focus, allocate engineering effort effectively, and set clear expectations. The goals are derived from the core value proposition of serverless computing: effortless scaling, cost efficiency, and developer productivity. The non-goals represent deliberate omissions—features that, while potentially valuable, would derail us from our primary mission or are better handled by adjacent systems.</p>\n<h3 id=\"guiding-principles\">Guiding Principles</h3>\n<p>Before enumerating specific goals, we establish three overarching principles that inform every architectural choice:</p>\n<ol>\n<li><strong>Isolation is Non-Negotiable:</strong> In a multi-tenant environment, one function must not be able to observe, interfere with, or exhaust resources allocated to another. Security and fairness are foundational.</li>\n<li><strong>Cold Start Latency is the Primary Performance Metric:</strong> The time from invocation request to function code beginning execution defines user-perceived performance. Optimizing this is our central technical challenge.</li>\n<li><strong>Scale-to-Zero is a Core Efficiency Requirement:</strong> The runtime must truly be serverless, consuming no compute resources when there is no demand, while balancing this with the cold start penalty.</li>\n</ol>\n<h3 id=\"goals\">Goals</h3>\n<p>The following table defines the specific, measurable outcomes that constitute a successful implementation of our serverless function runtime. Each goal is tied to a key user benefit and has concrete, testable acceptance criteria.</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Goal</th>\n<th align=\"left\">Success Criteria</th>\n<th align=\"left\">Rationale &amp; User Benefit</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"><strong>G1: Strong Multi-Tenant Isolation</strong></td>\n<td align=\"left\">1. A function cannot access another function&#39;s memory, files, or network traffic. <br> 2. A function cannot cause a denial-of-service via resource exhaustion (CPU, memory, disk, PIDs) to the host or other functions. <br> 3. Functions run with no inherent privileges; they cannot escalate to host root or modify host kernel parameters.</td>\n<td align=\"left\">Provides security and predictability. Users can run untrusted or sensitive code without fear of cross-contamination or hostile actors. This is the bedrock of a public or multi-team platform.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>G2: Sub-Second Cold Start Latency (P95)</strong></td>\n<td align=\"left\">The 95th percentile latency for a cold start invocation (including environment provisioning, code loading, and runtime initialization) is under 1 second for supported runtimes (Go, Python, Node.js).</td>\n<td align=\"left\">Delivers a responsive user experience. Functions feel &quot;instant&quot; even after periods of inactivity, making serverless viable for user-facing, synchronous APIs.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>G3: Efficient Scale-to-Zero</strong></td>\n<td align=\"left\">1. The system releases all compute resources (CPU, memory) for a function after a configurable idle period (e.g., 5-15 minutes). <br> 2. The cost of maintaining zero active instances is negligible (only metadata storage).</td>\n<td align=\"left\">Enables true pay-per-use pricing. Users incur no cost when their code isn&#39;t running, which is the primary economic appeal of serverless.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>G4: Rapid, Metric-Driven Autoscaling</strong></td>\n<td align=\"left\">1. The system can scale from zero to <em>N</em> concurrent instances to match incoming request load within seconds. <br> 2. Scaling decisions are based on observable metrics (requests-per-second, concurrent executions) with configurable thresholds. <br> 3. Scaling oscillations (thrashing) are minimized through cooldown periods and hysteresis.</td>\n<td align=\"left\">Handles unpredictable or bursty workloads automatically. Users do not need to provision or manage capacity; the platform seamlessly absorbs traffic spikes.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>G5: Polyglot Runtime Support</strong></td>\n<td align=\"left\">The platform supports at least three popular language runtimes: Go (compiled binary), Python (interpreted), and Node.js (interpreted). Each is provided with a standard library environment and a mechanism for user-supplied dependencies.</td>\n<td align=\"left\">Meets developers where they are. Teams can use their preferred language without being locked into a proprietary ecosystem, increasing adoption.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>G6: Simple, Declarative Function Packaging</strong></td>\n<td align=\"left\">Developers can deploy a function by providing source code and a simple declaration file (e.g., <code>func.yaml</code>) specifying the handler, runtime, and dependencies. The system handles the rest: building, bundling, and storage.</td>\n<td align=\"left\">Reduces operational complexity and cognitive load. The developer experience is focused on business logic, not infrastructure plumbing.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>G7: Comprehensive Observability</strong></td>\n<td align=\"left\">The system emits structured logs, metrics (invocations, durations, errors, cold starts), and traces for every function invocation. This data is accessible via an API or integrated dashboard.</td>\n<td align=\"left\">Enables debugging, performance tuning, and cost analysis. Users gain visibility into their application&#39;s behavior without manual instrumentation.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>G8: Predictable, Enforceable Resource Limits</strong></td>\n<td align=\"left\">Every function invocation is executed within strictly enforced limits for execution time (timeout), memory, and CPU allocation. Limits are defined at deployment and cannot be exceeded.</td>\n<td align=\"left\">Prevents buggy or malicious code from consuming unbounded resources. Provides cost and performance predictability for platform operators and users.</td>\n</tr>\n</tbody></table>\n<h3 id=\"non-goals\">Non-Goals</h3>\n<p>Equally important are the features we explicitly <strong>will not</strong> build in the initial version. These non-goals prevent scope creep and allow us to ship a robust, focused V1. Each is listed with a reason for exclusion, which is often that the feature is out of scope, overly complex, or better provided by a complementary system.</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Non-Goal</th>\n<th align=\"left\">Reason for Exclusion</th>\n<th align=\"left\">Potential Future Consideration</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"><strong>NG1: Stateful Function Instances</strong></td>\n<td align=\"left\">The runtime assumes functions are stateless. We will not provide durable, mutable local disk or memory that persists across invocations.</td>\n<td align=\"left\">State belongs in managed databases, caches, or object storage. Adding instance-persistent state dramatically complicates scaling, recovery, and data durability.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>NG2: Long-Running Functions (Hours/Days)</strong></td>\n<td align=\"left\">The system is optimized for short, ephemeral execution (seconds to minutes). We will not support functions that run for hours or days.</td>\n<td align=\"left\">Use a traditional container service or virtual machine for long-running processes. Our scheduling, billing, and fault recovery models are built for brevity.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>NG3: Custom Hardware or GPU Access</strong></td>\n<td align=\"left\">Functions cannot request or access specialized hardware like GPUs, TPUs, or high-performance network interfaces.</td>\n<td align=\"left\">The isolation and scheduling complexity for heterogeneous hardware is immense. This is a specialized niche outside our core focus on general-purpose compute.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>NG4: Complex Event Source Integration</strong></td>\n<td align=\"left\">We will not build first-class, built-in integrations with dozens of event sources (e.g., Kafka, RabbitMQ, DynamoDB streams). Our primary trigger is HTTP.</td>\n<td align=\"left\">The function runtime is an execution layer. Event sources should be configured externally (e.g., via a message queue that calls our HTTP endpoint). This keeps the runtime simple and composable.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>NG5: Advanced Networking (VPC Peering, Private Endpoints)</strong></td>\n<td align=\"left\">Functions initially run in a shared, platform-managed network with outbound internet access. We will not support complex networking topologies like VPC peering or placement in a user&#39;s private subnet.</td>\n<td align=\"left\">Networking is a complex domain that conflicts with our goal of simplicity and multi-tenancy. This can be added later if enterprise demand is high, but it significantly increases operational burden.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>NG6: Function Composition or Workflow Orchestration</strong></td>\n<td align=\"left\">We will not provide a built-in DSL or engine for chaining functions together into workflows (e.g., parallel execution, fan-out/fan-in).</td>\n<td align=\"left\">Workflow orchestration is a separate concern. Our runtime executes a single unit of work. Orchestration can be implemented at the application layer or by a dedicated service (like AWS Step Functions) that invokes our functions.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>NG7: Real-Time Live Code Updates</strong></td>\n<td align=\"left\">A deployed function version is immutable. We will not support hot-swapping code or configuration into a running function instance.</td>\n<td align=\"left\">Immutability simplifies versioning, rollbacks, and consistency. Updates require a new deployment, which creates a new immutable version. This is a core principle for reliability.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>NG8: Full Operating System Compatibility</strong></td>\n<td align=\"left\">The execution environment is a constrained, purpose-built runtime, not a full general-purpose OS. We will not guarantee compatibility with all system calls, kernel modules, or filesystem operations.</td>\n<td align=\"left\">We use security profiles (<code>seccomp</code>, <code>AppArmor</code>) to limit the attack surface. This inherently restricts some OS features. Our environment is tailored for application code, not system administration.</td>\n</tr>\n</tbody></table>\n<h3 id=\"architecture-decision-record-foundational-isolation-technology\">Architecture Decision Record: Foundational Isolation Technology</h3>\n<blockquote>\n<p><strong>Decision: Use Linux Container Namespaces and cgroups as the Primary Isolation Mechanism (V1)</strong></p>\n<ul>\n<li><strong>Context</strong>: We require strong isolation between untrusted function codes in a multi-tenant Linux environment. The choice of isolation technology fundamentally impacts security, performance (cold start), and implementation complexity.</li>\n<li><strong>Options Considered</strong>:<ol>\n<li><strong>Linux Containers (namespaces, cgroups, seccomp)</strong>: The industry-standard approach used by Docker, providing process, filesystem, and network isolation at the kernel level.</li>\n<li><strong>MicroVMs (Firecracker)</strong>: Lightweight virtual machines that offer stronger hardware-enforced isolation, pioneered by AWS Lambda.</li>\n<li><strong>gVisor (User-space Kernel)</strong>: A sandbox that intercepts application syscalls and implements them in a user-space kernel, providing a different security boundary.</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: For V1, we will implement isolation using <strong>Linux containers</strong> (via a low-level library like <code>containerd</code> or direct <code>runc</code> calls), augmented with <code>seccomp</code> and <code>AppArmor</code> profiles.</li>\n<li><strong>Rationale</strong>:<ul>\n<li><strong>Maturity &amp; Ecosystem</strong>: Containers have a vast ecosystem of tools, images, and knowledge. Debugging and operational tooling are readily available.</li>\n<li><strong>Cold Start Performance</strong>: Container startup, especially with optimized base images and shared layers, can be extremely fast (tens of milliseconds), which is critical for our cold start goals.</li>\n<li><strong>Implementation Simplicity</strong>: Managing containers is a well-understood problem. We can leverage existing battle-tested libraries, reducing our initial implementation risk.</li>\n<li><strong>Sufficient Isolation for V1</strong>: With careful hardening (dropping capabilities, applying strict <code>seccomp</code> filters, using read-only root filesystems), containers provide a robust level of isolation suitable for many multi-tenant scenarios.</li>\n</ul>\n</li>\n<li><strong>Consequences</strong>:<ul>\n<li><strong>Positive</strong>: Faster path to a working V1, easier debugging, better community support.</li>\n<li><strong>Negative</strong>: The isolation boundary is the Linux kernel, which has a large attack surface compared to a MicroVM. A kernel vulnerability could potentially be exploited to break out of the container.</li>\n<li><strong>Migration Path</strong>: The design will abstract the isolation layer behind a <code>ContainerManager</code> interface, making a future migration to Firecracker or gVisor possible without changing the core runtime logic.</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<p>The following table compares the isolation options in more detail, highlighting why containers were chosen for our initial implementation:</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Option</th>\n<th align=\"left\">Pros</th>\n<th align=\"left\">Cons</th>\n<th align=\"left\">Applicability to Our Goals</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"><strong>Linux Containers</strong></td>\n<td align=\"left\">- Extremely fast startup (ms). <br> - Mature, stable tooling (<code>runc</code>, <code>containerd</code>). <br> - Fine-grained resource control via <code>cgroups</code>. <br> - Rich security hardening via <code>seccomp</code>, <code>AppArmor</code>, capabilities.</td>\n<td align=\"left\">- Isolation depends on a shared kernel. Kernel vulnerabilities can lead to container escape. <br> - Requires host kernel configuration (namespaces, <code>cgroups</code>).</td>\n<td align=\"left\"><strong>CHOSEN</strong>. Best aligns with our <strong>cold start latency (G2)</strong> and <strong>implementation simplicity</strong> goals for V1. Provides sufficient isolation for many use cases.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>MicroVMs (Firecracker)</strong></td>\n<td align=\"left\">- Strong, hardware-enforced isolation (each function gets its own kernel). <br> - Minimal attack surface (specially built kernel). <br> - Excellent security story for hostile multi-tenancy.</td>\n<td align=\"left\">- Higher cold start latency (~100-400ms) due to VM boot, though snapshotting helps. <br> - More complex to implement and manage (requires KVM, device emulation). <br> - Higher memory overhead per instance.</td>\n<td align=\"left\">A strong candidate for a future V2 focused on maximum security, especially for public cloud offerings. The cold start trade-off is notable.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>gVisor</strong></td>\n<td align=\"left\">- No need for hardware virtualization. <br> - Syscall filtering provides a strong security boundary different from containers. <br> - Good compatibility with many applications.</td>\n<td align=\"left\">- Higher performance overhead for syscall-heavy workloads. <br> - Some compatibility gaps with certain syscalls or applications. <br> - Cold start similar to containers.</td>\n<td align=\"left\">An interesting middle ground. However, the performance characteristics and maturity were deemed less certain than pure containers for our V1.</td>\n</tr>\n</tbody></table>\n<h3 id=\"common-pitfalls-in-scope-definition\">Common Pitfalls in Scope Definition</h3>\n<p>⚠️ <strong>Pitfall: Under-Scoping (The &quot;Just One More Feature&quot; Trap)</strong></p>\n<ul>\n<li><strong>Description</strong>: Continuously adding &quot;small&quot; features from the Non-Goals list because they seem easy or are requested by early users.</li>\n<li><strong>Why it&#39;s Wrong</strong>: It leads to a bloated, complex V1 that never ships. It diverts effort from perfecting the core goals (like cold start optimization) and creates a confusing product identity.</li>\n<li><strong>How to Avoid</strong>: Be militant about the Non-Goals list. New features must be explicitly justified against the core goals. Create a &quot;Future Extensions&quot; backlog for ideas that don&#39;t fit V1.</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Over-Scoping (The &quot;All-or-Nothing&quot; Isolation Fallacy)</strong></p>\n<ul>\n<li><strong>Description</strong>: Believing that because containers don&#39;t offer perfect, theoretical isolation, they are unacceptable, and therefore we must start with the most secure option (MicroVMs), regardless of complexity.</li>\n<li><strong>Why it&#39;s Wrong</strong>: It ignores pragmatic trade-offs. The risk profile of many multi-tenant environments (e.g., internal company platforms, trusted communities) is well-managed by hardened containers. Starting with MicroVMs could delay the project by months and make cold start optimization much harder.</li>\n<li><strong>How to Avoid</strong>: Conduct a realistic threat model for your target users. Choose the simplest isolation technology that mitigates the actual identified threats. Plan for iterative improvement.</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Vague Success Criteria</strong></p>\n<ul>\n<li><strong>Description</strong>: Defining goals with ambiguous terms like &quot;fast,&quot; &quot;scalable,&quot; or &quot;reliable&quot; without quantifiable metrics.</li>\n<li><strong>Why it&#39;s Wrong</strong>: It makes it impossible to objectively determine if the project is successful. It leads to debates and moving goalposts.</li>\n<li><strong>How to Avoid</strong>: Every goal must have a <strong>measurable</strong> success criterion, as shown in the Goals table. &quot;Sub-second cold start (P95)&quot; is measurable. &quot;Fast cold start&quot; is not.</li>\n</ul>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p>While this section is primarily conceptual, establishing clear goals and non-goals has direct implications for our code structure and testing strategy from the very beginning.</p>\n<h4 id=\"a-technology-recommendations-table\">A. Technology Recommendations Table</h4>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Component</th>\n<th align=\"left\">Simple Option (V1)</th>\n<th align=\"left\">Advanced Option (Future)</th>\n<th align=\"left\">Rationale for V1 Choice</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"><strong>Isolation Layer</strong></td>\n<td align=\"left\"><code>containerd</code> Go client (or direct <code>runc</code>)</td>\n<td align=\"left\">Firecracker Go SDK (<code>firecracker-go-sdk</code>)</td>\n<td align=\"left\"><code>containerd</code> is the industry-standard container runtime, providing a stable API and handling low-level details. It&#39;s the path of least resistance.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>Resource Limits</strong></td>\n<td align=\"left\">Linux <code>cgroups</code> v2 (via <code>containerd</code> or <code>github.com/containerd/cgroups</code>)</td>\n<td align=\"left\">Custom cgroup manager + quota enforcement</td>\n<td align=\"left\">Letting <code>containerd</code> manage cgroups simplifies setup and ensures compatibility.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>Security Hardening</strong></td>\n<td align=\"left\">Default <code>seccomp</code> profile (Docker&#39;s) + dropped capabilities + read-only rootfs</td>\n<td align=\"left\">Custom AppArmor profiles, SELinux policies</td>\n<td align=\"left\">Starting with well-known, conservative defaults is safe. Custom policies can be added later based on need.</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>Metrics &amp; Observability</strong></td>\n<td align=\"left\">Prometheus client library (<code>github.com/prometheus/client_golang</code>) + structured logging (<code>logrus</code>/<code>zap</code>)</td>\n<td align=\"left\">OpenTelemetry SDK for distributed tracing</td>\n<td align=\"left\">Prometheus is the de facto standard for metrics. Structured logs are essential for debugging.</td>\n</tr>\n</tbody></table>\n<h4 id=\"b-recommended-filemodule-structure\">B. Recommended File/Module Structure</h4>\n<p>The goals and non-goals inform a clean separation of concerns from the project&#39;s inception. Here is the recommended high-level directory structure:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>serverless-runtime/\n├── cmd/\n│   ├── controller/          # Main orchestrator (scaling, instance management)\n│   │   └── main.go\n│   ├── gateway/             # HTTP gateway (request routing)\n│   │   └── main.go\n│   └── cli/                 # Command-line tool for deploying functions\n│       └── main.go\n├── internal/                # Private application code\n│   ├── api/                 # Internal APIs and data types\n│   │   ├── types.go         # Core types: FunctionDefinition, InvocationRequest, etc.\n│   │   └── storage.go       # Storage backend interface\n│   ├── builder/             # **Milestone 1**: Function packaging &amp; dependency bundling\n│   │   ├── go_bundler.go\n│   │   ├── python_bundler.go\n│   │   └── node_bundler.go\n│   ├── container/           # **Milestone 2 &amp; 3**: Isolation &amp; cold start optimization\n│   │   ├── manager.go       # ContainerManager interface\n│   │   ├── cgroup_utils.go  # Helper for cgroups\n│   │   ├── warm_pool.go     # WarmPoolManager\n│   │   └── criu_helper.go   # Snapshot/restore logic (if implemented)\n│   ├── gateway/             # **Milestone 4**: Request routing\n│   │   ├── router.go        HTTP routing logic\n│   │   ├── queue.go         # Request queue implementation\n│   │   └── loadbalancer.go  # Instance selection logic\n│   ├── scaler/              # **Milestone 5**: Auto-scaling\n│   │   ├── metrics.go       # Collects RPS, concurrency\n│   │   └── decision.go      # Scaling algorithm\n│   └── store/               # Storage implementations\n│       ├── s3_store.go      # S3 backend for function artifacts\n│       └── local_store.go   # Local disk backend for development\n├── pkg/                     # Public, reusable libraries (if any)\n│   └── function_spec/       # Public definition of func.yaml format\n├── go.mod\n└── README.md</code></pre></div>\n\n<h4 id=\"c-core-logic-skeleton-goal-validation-metric\">C. Core Logic Skeleton: Goal Validation Metric</h4>\n<p>To embody the principle of measurable goals, we can create a simple metric collection point from day one. This code doesn&#39;t implement the logic but sets up the scaffolding for tracking our key success metric: cold start latency.</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/api/metrics.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> api</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">github.com/prometheus/client_golang/prometheus</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">github.com/prometheus/client_golang/prometheus/promauto</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Metrics is a centralized struct holding all Prometheus metrics for the runtime.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// This ensures we track the data needed to validate our Goals (G2, G4, G7, G8).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Metrics</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// ColdStartLatency tracks the duration from when a request is received</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// for a function with no warm instance to when the function code begins execution.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// This is our KEY metric for Goal G2.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tColdStartLatency </span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Histogram</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// InvocationDuration tracks total function execution time.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tInvocationDuration </span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Histogram</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// ActiveInvocations is a gauge of currently running functions.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tActiveInvocations </span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Gauge</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// InvocationErrors counts failures by type (timeout, OOM, crash).</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tInvocationErrors </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterVec</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// FunctionInvocations counts total invocations per function.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tFunctionInvocations </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterVec</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewMetrics creates and registers all metrics. Call this once at startup.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewMetrics</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Metrics</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Metrics</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tColdStartLatency: promauto.</span><span style=\"color:#B392F0\">NewHistogram</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HistogramOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tName:    </span><span style=\"color:#9ECBFF\">\"function_cold_start_latency_seconds\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tHelp:    </span><span style=\"color:#9ECBFF\">\"Time from cold invocation request to code execution start.\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tBuckets: prometheus.DefBuckets, </span><span style=\"color:#6A737D\">// Default buckets are good for sub-second latencies</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t}),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tInvocationDuration: promauto.</span><span style=\"color:#B392F0\">NewHistogram</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HistogramOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tName:    </span><span style=\"color:#9ECBFF\">\"function_invocation_duration_seconds\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tHelp:    </span><span style=\"color:#9ECBFF\">\"Total duration of function execution.\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tBuckets: prometheus.DefBuckets,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t}),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tActiveInvocations: promauto.</span><span style=\"color:#B392F0\">NewGauge</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">GaugeOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tName: </span><span style=\"color:#9ECBFF\">\"function_active_invocations\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tHelp: </span><span style=\"color:#9ECBFF\">\"Current number of concurrently executing function invocations.\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t}),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tInvocationErrors: promauto.</span><span style=\"color:#B392F0\">NewCounterVec</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tName: </span><span style=\"color:#9ECBFF\">\"function_invocation_errors_total\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tHelp: </span><span style=\"color:#9ECBFF\">\"Total number of failed function invocations by error type.\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t}, []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error_type\"</span><span style=\"color:#E1E4E8\">}), </span><span style=\"color:#6A737D\">// error_type: \"timeout\", \"oom\", \"crash\", \"system\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tFunctionInvocations: promauto.</span><span style=\"color:#B392F0\">NewCounterVec</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tName: </span><span style=\"color:#9ECBFF\">\"function_invocations_total\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tHelp: </span><span style=\"color:#9ECBFF\">\"Total number of function invocations.\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t}, []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">}),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RecordColdStart should be called when a cold start is completed.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// `startTime` should be the time the request was first routed (before acquiring an instance).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Metrics</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RecordColdStart</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">startTime</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tduration </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(startTime).</span><span style=\"color:#B392F0\">Seconds</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tm.ColdStartLatency.</span><span style=\"color:#B392F0\">Observe</span><span style=\"color:#E1E4E8\">(duration)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RecordInvocation should be called when a function invocation finishes.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Metrics</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RecordInvocation</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">functionName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">startTime</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tduration </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(startTime).</span><span style=\"color:#B392F0\">Seconds</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tm.InvocationDuration.</span><span style=\"color:#B392F0\">Observe</span><span style=\"color:#E1E4E8\">(duration)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tm.FunctionInvocations.</span><span style=\"color:#B392F0\">WithLabelValues</span><span style=\"color:#E1E4E8\">(functionName).</span><span style=\"color:#B392F0\">Inc</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tm.ActiveInvocations.</span><span style=\"color:#B392F0\">Dec</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#6A737D\">// Assuming we .Inc() when starting an invocation</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t\t// TODO: Classify the error type (timeout, OOM, etc.)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\terrorType </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> classifyError</span><span style=\"color:#E1E4E8\">(err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tm.InvocationErrors.</span><span style=\"color:#B392F0\">WithLabelValues</span><span style=\"color:#E1E4E8\">(functionName, errorType).</span><span style=\"color:#B392F0\">Inc</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// classifyError is a helper to categorize errors for metrics.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// This is a simplistic example; real implementation would be more robust.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> classifyError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO: Implement error type classification based on your runtime's error types.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Example: check for context.DeadlineExceeded, or OOM messages from the container.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#9ECBFF\"> \"unknown\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"d-language-specific-hints-go\">D. Language-Specific Hints (Go)</h4>\n<ul>\n<li><strong>Prometheus Integration</strong>: Use the official <code>prometheus/client_golang</code> library. The <code>promauto</code> package is convenient for automatically registering metrics.</li>\n<li><strong>Time Measurement</strong>: Use <code>time.Now()</code> or <code>time.Since()</code> for latency measurements. For high precision, consider <code>time.Now().UnixNano()</code>.</li>\n<li><strong>Concurrency with Gauges</strong>: Be careful to call <code>metrics.ActiveInvocations.Inc()</code> and <code>.Dec()</code> in a thread-safe manner, ideally within a synchronized request handler.</li>\n</ul>\n<h4 id=\"e-milestone-checkpoint-goal-validation\">E. Milestone Checkpoint: Goal Validation</h4>\n<p>After implementing the initial scaffolding (even before full routing), you should be able to validate that your metrics infrastructure is working.</p>\n<ol>\n<li><strong>Command</strong>: Start your controller or gateway with the metrics code integrated. The Prometheus client will expose a <code>/metrics</code> HTTP endpoint by default on the same port as your application (if you use <code>promhttp.Handler()</code>).</li>\n<li><strong>Expected Output</strong>: Run <code>curl http://localhost:&lt;port&gt;/metrics</code>. You should see the raw Prometheus metrics, including the histograms and counters defined above (their values will be zero initially).</li>\n<li><strong>Sign of Success</strong>: The metric names appear correctly in the output. If you see <code>function_cold_start_latency_seconds</code> listed, your instrumentation is correctly registered.</li>\n<li><strong>Troubleshooting</strong>: If metrics are missing, ensure you&#39;ve called <code>NewMetrics()</code> and that the metrics variables are not garbage collected (they should be in a long-lived struct). Also verify the Prometheus handler is registered with your HTTP server: <code>http.Handle(&quot;/metrics&quot;, promhttp.Handler())</code>.</li>\n</ol>\n<hr>\n<h2 id=\"high-level-architecture\">High-Level Architecture</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> This foundational section establishes the architectural blueprint that all subsequent milestones (1-5) will implement. It defines the major system components, their responsibilities, and how they interact to solve the core challenge of balancing isolation, speed, and efficient scaling.</p>\n</blockquote>\n<h3 id=\"component-overview-and-responsibilities\">Component Overview and Responsibilities</h3>\n<p><strong>Mental Model: The Instant Kitchen Factory</strong></p>\n<p>Imagine you&#39;re running a gourmet meal delivery service that needs to prepare thousands of unique dishes on demand. Each dish (function) requires specific ingredients (code + dependencies) and cooking equipment (runtime). You face three key challenges:</p>\n<ol>\n<li><strong>Speed</strong>: Customers want their meals in seconds, not hours</li>\n<li><strong>Isolation</strong>: You can&#39;t let the garlic from one dish contaminate the dessert</li>\n<li><strong>Efficiency</strong>: You can&#39;t keep every possible kitchen setup running 24/7 when demand fluctuates</li>\n</ol>\n<p>Your solution is an &quot;Instant Kitchen Factory&quot; with these specialized departments:</p>\n<ul>\n<li><strong>The Order Desk (Gateway)</strong>: Where customers place orders, get queued if all kitchens are busy, and receive their finished meals</li>\n<li><strong>The Control Room (Controller)</strong>: The brain that tracks which kitchens are available, creates new ones when needed, and shuts down idle ones</li>\n<li><strong>The Kitchen Stations (Worker Pool)</strong>: Individual, isolated kitchens where meals are actually prepared, each with its own equipment and ingredients</li>\n<li><strong>The Warehouse (Storage)</strong>: Where recipe books (function code), pre-measured ingredient kits (dependencies), and cooking equipment (runtime images) are stored</li>\n</ul>\n<p>This factory can instantly deploy a fully-equipped kitchen for any recipe, clean it up when done, and keep a few popular kitchens &quot;warm&quot; and ready to go. Now let&#39;s translate this mental model to our technical architecture.</p>\n<p><img src=\"/api/project/serverless-runtime/architecture-doc/asset?path=diagrams%2Fsys-component-diagram.svg\" alt=\"System Component Overview\"></p>\n<p>The system comprises four core components that work together to provide serverless function execution. Each component is designed for specific responsibilities while maintaining clear boundaries and well-defined interfaces.</p>\n<h4 id=\"http-gateway-the-public-entry-point\">HTTP Gateway: The Public Entry Point</h4>\n<p>The Gateway serves as the single entry point for all function invocations, handling request routing, load balancing, and traffic management. Think of it as the restaurant host who greets customers, checks reservations (function names), and seats them at available tables (function instances).</p>\n<table>\n<thead>\n<tr>\n<th>Responsibility</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Request Reception</td>\n<td>Accepts HTTP requests on a public endpoint (e.g., <code>POST /invoke/{functionName}</code>) with function input as request body</td>\n</tr>\n<tr>\n<td>Request Validation</td>\n<td>Validates incoming requests against function specifications (timeout limits, payload size) before forwarding</td>\n</tr>\n<tr>\n<td>Function Resolution</td>\n<td>Maps URL paths or headers to specific function names and versions (e.g., <code>/api/users/create</code> → <code>createUser:v1.2</code>)</td>\n</tr>\n<tr>\n<td>Load Balancing</td>\n<td>Distributes requests across available function instances using configurable strategies (round-robin, least connections)</td>\n</tr>\n<tr>\n<td>Request Queuing</td>\n<td>Maintains per-function queues when all instances are busy, applying backpressure and fairness policies</td>\n</tr>\n<tr>\n<td>Synchronous/Async Mode</td>\n<td>Supports immediate response (synchronous) and fire-and-forget (asynchronous) invocation patterns</td>\n</tr>\n<tr>\n<td>Response Aggregation</td>\n<td>Collects function output (or error) and returns appropriate HTTP status codes and headers to the caller</td>\n</tr>\n<tr>\n<td>Request Timeout Enforcement</td>\n<td>Terminates requests that exceed configured timeouts, returning appropriate error responses</td>\n</tr>\n</tbody></table>\n<p>The Gateway maintains minimal state—primarily request queues and circuit breakers—and delegates instance management to the Controller. It communicates with the Controller via gRPC or HTTP for instance assignment.</p>\n<h4 id=\"controller-the-orchestration-brain\">Controller: The Orchestration Brain</h4>\n<p>The Controller is the central coordination point that manages function lifecycle, scaling decisions, and system state. Imagine it as the air traffic control tower that monitors all aircraft (function instances), decides when to launch new ones, and directs them to landing spots (request assignments).</p>\n<table>\n<thead>\n<tr>\n<th>Responsibility</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Function Deployment</td>\n<td>Processes function uploads, coordinates packaging with Storage, and registers new function versions</td>\n</tr>\n<tr>\n<td>Instance Lifecycle Management</td>\n<td>Creates, monitors, and destroys function instances (<code>FunctionInstance</code> objects) throughout their lifecycle</td>\n</tr>\n<tr>\n<td>Warm Pool Management</td>\n<td>Maintains pre-initialized instances ready for immediate execution, applying eviction and refresh policies</td>\n</tr>\n<tr>\n<td>Auto-Scaling Decisions</td>\n<td>Analyzes metrics (requests/second, concurrent executions) to scale instances up or down per function</td>\n</tr>\n<tr>\n<td>Health Monitoring</td>\n<td>Periodically checks instance health via heartbeat mechanisms and replaces unhealthy instances</td>\n</tr>\n<tr>\n<td>System Metrics Collection</td>\n<td>Aggregates performance data (cold starts, execution times, errors) for observability and scaling decisions</td>\n</tr>\n<tr>\n<td>Configuration Management</td>\n<td>Stores and applies function-specific configurations (timeouts, memory limits, environment variables)</td>\n</tr>\n<tr>\n<td>Instance Assignment</td>\n<td>Provides available instances to the Gateway upon request, considering load distribution and locality</td>\n</tr>\n</tbody></table>\n<p>The Controller maintains the authoritative view of system state, including all function definitions, active instances, and scaling policies. It uses the <code>ContainerManager</code> interface to manage execution environments and interacts with Storage for artifact retrieval.</p>\n<h4 id=\"worker-pool-the-execution-fabric\">Worker Pool: The Execution Fabric</h4>\n<p>The Worker Pool represents the actual compute resources where functions execute—a collection of isolated environments (containers or microVMs) running on physical or virtual hosts. Think of each worker as a self-contained kitchen with its own stove, sink, and pantry, completely isolated from other kitchens.</p>\n<table>\n<thead>\n<tr>\n<th>Responsibility</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Isolation Enforcement</td>\n<td>Provides secure multi-tenant isolation using containers, namespaces, cgroups, and security profiles</td>\n</tr>\n<tr>\n<td>Resource Management</td>\n<td>Enforces CPU, memory, disk, and network limits for each function instance</td>\n</tr>\n<tr>\n<td>Function Execution</td>\n<td>Loads function code into the isolated environment and executes the handler with provided input</td>\n</tr>\n<tr>\n<td>Runtime Lifecycle</td>\n<td>Manages runtime-specific initialization (Python interpreter, JVM, Go binary) before function execution</td>\n</tr>\n<tr>\n<td>Local Caching</td>\n<td>Caches frequently used function artifacts and runtime layers to reduce startup latency</td>\n</tr>\n<tr>\n<td>Metrics Reporting</td>\n<td>Reports per-instance resource usage (CPU%, memory MB) and execution metrics to Controller</td>\n</tr>\n<tr>\n<td>Cleanup</td>\n<td>Ensures complete cleanup of execution environments after function completion or timeout</td>\n</tr>\n</tbody></table>\n<p>The Worker Pool isn&#39;t a centralized service but a distributed capability—each host runs a worker agent that communicates with the Controller. Multiple workers can run on a single host for density, but each function instance runs in its own isolated environment.</p>\n<h4 id=\"storage-the-durable-backbone\">Storage: The Durable Backbone</h4>\n<p>Storage provides durable, scalable persistence for function artifacts, system state, and operational data. Imagine it as the warehouse + filing cabinet that stores everything from recipe books (code) to order records (invocation logs).</p>\n<table>\n<thead>\n<tr>\n<th>Responsibility</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Function Artifact Storage</td>\n<td>Stores packaged function code with dependencies, supporting versioning and immutability</td>\n</tr>\n<tr>\n<td>Runtime Image Repository</td>\n<td>Stores base runtime images (Python, Node.js, Go) and common dependency layers</td>\n</tr>\n<tr>\n<td>System State Persistence</td>\n<td>Optionally persists function definitions, scaling policies, and instance assignments (for fault tolerance)</td>\n</tr>\n<tr>\n<td>Log Aggregation</td>\n<td>Collects and stores function execution logs for debugging and audit purposes</td>\n</tr>\n<tr>\n<td>Metrics Archival</td>\n<td>Stores historical metrics for trend analysis and capacity planning</td>\n</tr>\n<tr>\n<td>Snapshot Storage</td>\n<td>Stores container snapshots for fast restoration (if using CRIU checkpoint/restore)</td>\n</tr>\n</tbody></table>\n<p>Storage is designed as a pluggable backend, supporting cloud object storage (AWS S3, Google Cloud Storage), container registries (Docker Hub, AWS ECR), and local filesystems for development.</p>\n<p><strong>Component Interaction Patterns:</strong></p>\n<p>The components follow a clear hierarchy and communication pattern:</p>\n<ol>\n<li><strong>North-South Traffic (User Requests)</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   User → HTTP Gateway → Controller → Worker Pool → Function Execution</code></pre></div>\n\n<ol start=\"2\">\n<li><strong>East-West Traffic (Control Plane)</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   Controller ↔ Storage (for artifacts)\n   Controller ↔ Worker Pool (for lifecycle management)\n   Gateway ↔ Controller (for instance assignment)</code></pre></div>\n\n<ol start=\"3\">\n<li><strong>Data Flow</strong>:<ul>\n<li>Control signals flow from Controller to Workers</li>\n<li>Metrics flow from Workers to Controller</li>\n<li>Artifacts flow from Storage to Workers</li>\n<li>Requests flow from Gateway to Workers (via Controller assignment)</li>\n</ul>\n</li>\n</ol>\n<blockquote>\n<p><strong>Design Insight:</strong> We deliberately separate the data plane (Gateway → Worker) from the control plane (Controller ↔ Worker). This allows the Gateway to communicate directly with Workers for low-latency request/response while the Controller manages orchestration without being in the hot path.</p>\n</blockquote>\n<h3 id=\"recommended-file-and-module-structure\">Recommended File and Module Structure</h3>\n<p>A well-organized codebase is critical for maintaining a complex system like this. Following Go conventions and separation of concerns, we recommend this project structure:</p>\n<p><strong>Mental Model: The Office Building</strong></p>\n<p>Think of the project structure as a well-organized office building:</p>\n<ul>\n<li><strong><code>/cmd</code></strong>: The reception desks and main entrances (executable programs)</li>\n<li><strong><code>/internal</code></strong>: The specialized departments with restricted access (private implementation)</li>\n<li><strong><code>/pkg</code></strong>: The public-facing services anyone can visit (reusable libraries)</li>\n<li><strong><code>/api</code></strong>: The building blueprints and interface specifications (contracts)</li>\n<li><strong><code>/deployments</code></strong>: The building maintenance plans and utility hookups (infrastructure)</li>\n</ul>\n<p>Here&#39;s the complete structure:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>serverless-runtime/\n├── cmd/                          # Application entry points\n│   ├── gateway/                  # HTTP Gateway service\n│   │   ├── main.go               # Gateway entry point with CLI flags\n│   │   └── config/               # Gateway-specific configuration\n│   ├── controller/               # Controller service  \n│   │   ├── main.go               # Controller entry point\n│   │   └── config/               # Controller configuration\n│   └── worker/                   # Worker agent (optional separate binary)\n│       └── main.go               # Worker entry point\n├── internal/                     # Private application code\n│   ├── gateway/                  # Gateway implementation\n│   │   ├── gateway.go            # Main Gateway struct and initialization\n│   │   ├── router.go             # HTTP routing and middleware\n│   │   ├── handler/              # HTTP request handlers\n│   │   │   ├── invoke.go         # Function invocation handler\n│   │   │   ├── async.go          # Async invocation handler\n│   │   │   └── health.go         # Health check endpoint\n│   │   ├── queue/                # Request queuing subsystem\n│   │   │   ├── manager.go        # Queue manager interface\n│   │   │   ├── memory_queue.go   # In-memory queue implementation\n│   │   │   └── priority_queue.go # Priority-based queuing\n│   │   ├── balancer/             # Load balancing logic\n│   │   │   ├── balancer.go       # LoadBalancer interface\n│   │   │   ├── round_robin.go    # Round-robin implementation\n│   │   │   └── least_conn.go     # Least-connections implementation\n│   │   └── client/               # Client to talk to Controller\n│   │       └── controller_client.go # gRPC/HTTP client for Controller\n│   ├── controller/               # Controller implementation\n│   │   ├── controller.go         # Main Controller struct and coordination\n│   │   ├── manager/              # Core management subsystems\n│   │   │   ├── function/         # Function lifecycle management\n│   │   │   │   ├── manager.go    # FunctionManager interface\n│   │   │   │   ├── registry.go   # In-memory function registry\n│   │   │   │   └── deployer.go   # Function deployment logic\n│   │   │   ├── instance/         # Instance lifecycle management\n│   │   │   │   ├── manager.go    # InstanceManager interface\n│   │   │   │   ├── lifecycle.go  # State transitions and lifecycle\n│   │   │   │   └── health.go     # Health checking logic\n│   │   │   └── warmpool/         # Warm pool management\n│   │   │       ├── manager.go    # WarmPoolManager interface\n│   │   │       ├── pool.go       # Pool implementation\n│   │   │       └── eviction.go   # Eviction policies (LRU, LFU)\n│   │   ├── scaler/               # Auto-scaling logic\n│   │   │   ├── scaler.go         # Scaler interface\n│   │   │   ├── reactive.go       # Reactive scaling implementation\n│   │   │   ├── metrics/          # Metrics collection for scaling\n│   │   │   │   ├── collector.go  # Metrics collector interface\n│   │   │   │   └── prometheus.go # Prometheus implementation\n│   │   │   └── decision/         # Scaling decision logic\n│   │   │       ├── engine.go     # Decision engine\n│   │   │       └── policies.go   # Scaling policies\n│   │   ├── api/                  # Controller API (gRPC/HTTP)\n│   │   │   ├── server.go         # API server implementation\n│   │   │   ├── service.go        # gRPC service definition\n│   │   │   └── handlers/         # HTTP handlers (if dual protocol)\n│   │   └── storage/              # Controller's storage client\n│   │       └── client.go         # Client to Storage service\n│   ├── worker/                   # Worker implementation\n│   │   ├── runtime/              # Runtime environment management\n│   │   │   ├── manager.go        # RuntimeManager interface\n│   │   │   ├── container/        # Container-based runtime\n│   │   │   │   ├── manager.go    # Container runtime manager\n│   │   │   │   └── executor.go   # Container execution logic\n│   │   │   └── microvm/          # MicroVM-based runtime (optional)\n│   │   │       ├── manager.go    # Firecracker manager\n│   │   │       └── executor.go   # MicroVM execution logic\n│   │   ├── invoker/              # Function invocation\n│   │   │   ├── invoker.go        # Invoker interface\n│   │   │   ├── http_invoker.go   # HTTP-triggered invocation\n│   │   │   └── event_invoker.go  # Event-triggered invocation\n│   │   ├── isolation/            # Isolation setup\n│   │   │   ├── cgroups.go        # cgroups setup and management\n│   │   │   ├── namespaces.go     # Linux namespace setup\n│   │   │   └── security.go       # seccomp/AppArmor profiles\n│   │   └── snapshot/             # Snapshot/restore functionality\n│   │       ├── criu.go           # CRIU integration\n│   │       └── snapshotter.go    # Snapshot manager\n│   ├── packaging/                # Function packaging subsystem\n│   │   ├── bundler/              # Language-specific bundlers\n│   │   │   ├── bundler.go        # Bundler interface\n│   │   │   ├── go_bundler.go     # Go bundler implementation\n│   │   │   ├── python_bundler.go # Python bundler\n│   │   │   └── node_bundler.go   # Node.js bundler\n│   │   ├── registry/             # Function registry and storage\n│   │   │   ├── storage.go        # Storage interface for artifacts\n│   │   │   ├── s3_storage.go     # S3-backed storage\n│   │   │   └── local_storage.go  # Local filesystem storage\n│   │   └── builder/              # Build system integration\n│   │       └── builder.go        # Build orchestration\n│   ├── models/                   # Shared data structures\n│   │   ├── function.go           # FunctionDefinition and related types\n│   │   ├── instance.go           # FunctionInstance and states\n│   │   ├── invocation.go         # InvocationRequest and response types\n│   │   ├── container.go          # Container and ContainerStatus\n│   │   └── metrics.go            # Metrics data structures\n│   └── util/                     # Shared utilities\n│       ├── logging/              # Structured logging\n│       ├── config/               # Configuration parsing\n│       ├── retry/                # Retry utilities\n│       └── telemetry/            # Tracing and telemetry\n├── pkg/                          # Public reusable packages\n│   ├── container/                # Container management abstraction\n│   │   ├── manager.go            # ContainerManager interface\n│   │   ├── types.go              # Container, CreateContainerRequest, etc.\n│   │   └── docker/               # Docker implementation\n│   │       ├── docker_manager.go # DockerManager implementation\n│   │       └── client.go         # Docker client wrapper\n│   └── metrics/                  # Metrics collection utilities\n│       ├── metrics.go            # Metrics struct and factory\n│       └── prometheus.go         # Prometheus implementation\n├── api/                          # API definitions and contracts\n│   ├── v1/                       # Version 1 API\n│   │   ├── gateway/              # Gateway API definitions\n│   │   │   ├── gateway.proto     # gRPC service definition\n│   │   │   └── openapi.yaml     # OpenAPI/Swagger spec\n│   │   ├── controller/           # Controller API definitions\n│   │   │   └── controller.proto # Controller gRPC service\n│   │   └── models/               # Shared message types\n│   │       └── models.proto      # Common protobuf messages\n│   └── buf.yaml                  # buf.build configuration\n├── deployments/                  # Deployment configurations\n│   ├── docker/                   # Docker-related files\n│   │   ├── Dockerfile.gateway    # Gateway Dockerfile\n│   │   ├── Dockerfile.controller # Controller Dockerfile\n│   │   └── docker-compose.yml    # Local development setup\n│   └── kubernetes/               # Kubernetes manifests\n│       ├── namespace.yaml        # K8s namespace\n│       ├── gateway/              # Gateway deployment\n│       ├── controller/           # Controller deployment\n│       └── worker/               # Worker DaemonSet\n├── scripts/                      # Build and development scripts\n│   ├── build.sh                  # Build script\n│   ├── test.sh                   # Test script\n│   └── deploy/                   # Deployment scripts\n├── configs/                      # Configuration files\n│   ├── gateway.yaml.example      # Gateway config example\n│   ├── controller.yaml.example   # Controller config example\n│   └── worker.yaml.example       # Worker config example\n├── tests/                        # Integration and e2e tests\n│   ├── integration/              # Integration tests\n│   └── e2e/                      # End-to-end tests\n├── docs/                         # Documentation\n│   ├── architecture/             # Architecture diagrams and docs\n│   └── api/                      # API documentation\n├── go.mod                        # Go module definition\n├── go.sum                        # Go dependencies checksum\n├── Makefile                      # Common tasks automation\n└── README.md                     # Project overview</code></pre></div>\n\n<p><strong>Key Organizational Principles:</strong></p>\n<ol>\n<li><p><strong>Clear Separation of Concerns</strong>: Each component lives in its own directory with well-defined interfaces between them.</p>\n</li>\n<li><p><strong>Dependency Direction</strong>: </p>\n<ul>\n<li>Higher-level components (<code>gateway</code>, <code>controller</code>) depend on abstractions in <code>pkg/</code></li>\n<li>Lower-level implementations (<code>docker</code>, <code>s3_storage</code>) implement those abstractions</li>\n<li>Dependencies flow inward: <code>cmd/</code> → <code>internal/</code> → <code>pkg/</code></li>\n</ul>\n</li>\n<li><p><strong>Test Organization</strong>: Unit tests live alongside the code they test (e.g., <code>gateway_test.go</code> next to <code>gateway.go</code>), while integration and end-to-end tests are separate.</p>\n</li>\n<li><p><strong>Configuration Management</strong>: Each service has its own configuration structure, with examples provided and environment-specific overrides.</p>\n</li>\n<li><p><strong>API-First Design</strong>: Protobuf/OpenAPI definitions are the source of truth for external APIs, enabling code generation for multiple languages.</p>\n</li>\n</ol>\n<blockquote>\n<p><strong>Design Insight:</strong> This structure supports incremental development across milestones. You can implement the <code>packaging/</code> directory for Milestone 1, <code>worker/runtime/</code> for Milestone 2, <code>worker/snapshot/</code> for Milestone 3, <code>gateway/queue/</code> for Milestone 4, and <code>controller/scaler/</code> for Milestone 5—each in isolation while maintaining clear interfaces.</p>\n</blockquote>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<h4 id=\"a-technology-recommendations-table\">A. Technology Recommendations Table</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option (for learning/getting started)</th>\n<th>Advanced Option (production-ready)</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Gateway Transport</strong></td>\n<td>HTTP/1.1 with Go&#39;s <code>net/http</code></td>\n<td>HTTP/2 with gRPC-gateway for dual REST/gRPC</td>\n</tr>\n<tr>\n<td><strong>Controller-Worker Communication</strong></td>\n<td>HTTP REST with JSON</td>\n<td>gRPC streaming for real-time control</td>\n</tr>\n<tr>\n<td><strong>Storage Backend</strong></td>\n<td>Local filesystem with directory structure</td>\n<td>S3-compatible object storage with versioning</td>\n</tr>\n<tr>\n<td><strong>Container Runtime</strong></td>\n<td>Docker Engine via Docker SDK</td>\n<td>containerd with CRI plugin for lower overhead</td>\n</tr>\n<tr>\n<td><strong>Metrics</strong></td>\n<td>Prometheus client library with in-memory aggregation</td>\n<td>OpenTelemetry with Jaeger/Datadog export</td>\n</tr>\n<tr>\n<td><strong>Service Discovery</strong></td>\n<td>Static configuration in YAML</td>\n<td>Consul or etcd for dynamic registration</td>\n</tr>\n<tr>\n<td><strong>Queue Implementation</strong></td>\n<td>In-memory Go channels with buffering</td>\n<td>Redis Streams or Apache Kafka for persistence</td>\n</tr>\n</tbody></table>\n<h4 id=\"b-core-infrastructure-starter-code\">B. Core Infrastructure Starter Code</h4>\n<p>Since the high-level architecture establishes the foundation, here&#39;s complete starter code for the shared models and interfaces that all components will use:</p>\n<p><strong>File: <code>internal/models/function.go</code></strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> models</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// FunctionDefinition represents a deployable function with its configuration</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> FunctionDefinition</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Unique identifier for the function (e.g., \"user-auth\")</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Name </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"name\" yaml:\"name\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Runtime environment (e.g., \"go1.19\", \"python3.9\", \"nodejs18\")</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Runtime </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"runtime\" yaml:\"runtime\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Handler entry point (e.g., \"main.Handler\", \"index.handler\")</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Handler </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"handler\" yaml:\"handler\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Path to the function code in storage</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CodePath </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"codePath\" yaml:\"codePath\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Maximum execution time in seconds</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Timeout </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\"> `json:\"timeout\" yaml:\"timeout\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Memory limit in megabytes</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MemoryMB </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\"> `json:\"memoryMB\" yaml:\"memoryMB\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // CPU quota as percentage of a single core (100 = full core)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CPUQuota </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\"> `json:\"cpuQuota\" yaml:\"cpuQuota\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Environment variables to inject</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EnvVars </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"envVars\" yaml:\"envVars\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Language-specific dependencies</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Dependencies []</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"dependencies\" yaml:\"dependencies\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Metadata</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Version    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"version\" yaml:\"version\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt  </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"createdAt\" yaml:\"createdAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UpdatedAt  </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"updatedAt\" yaml:\"updatedAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// FunctionInstance represents a running instance of a function</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> FunctionInstance</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Unique instance identifier</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"id\" yaml:\"id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Function this instance belongs to</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    FunctionName    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"functionName\" yaml:\"functionName\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    FunctionVersion </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"functionVersion\" yaml:\"functionVersion\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Current state (see constants below)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    State </span><span style=\"color:#B392F0\">FunctionInstanceState</span><span style=\"color:#9ECBFF\"> `json:\"state\" yaml:\"state\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Underlying container/microVM identifier</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ContainerID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"containerId\" yaml:\"containerId\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Host where this instance is running</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Host </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"host\" yaml:\"host\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Port for HTTP communication (if applicable)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Port </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\"> `json:\"port\" yaml:\"port\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Resource usage tracking</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MemoryUsageMB </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\"> `json:\"memoryUsageMB\" yaml:\"memoryUsageMB\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CPUUsage      </span><span style=\"color:#F97583\">float64</span><span style=\"color:#9ECBFF\"> `json:\"cpuUsage\" yaml:\"cpuUsage\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Lifecycle timestamps</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"createdAt\" yaml:\"createdAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    LastUsedAt  </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"lastUsedAt\" yaml:\"lastUsedAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TerminatedAt </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"terminatedAt,omitempty\" yaml:\"terminatedAt,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Statistics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    InvocationCount </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\"> `json:\"invocationCount\" yaml:\"invocationCount\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TotalDurationMS </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\"> `json:\"totalDurationMS\" yaml:\"totalDurationMS\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// FunctionInstanceState represents the lifecycle state of a function instance</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> FunctionInstanceState</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // InstanceStateProvisioning - Container is being created/started</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    InstanceStateProvisioning</span><span style=\"color:#B392F0\"> FunctionInstanceState</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"PROVISIONING\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // InstanceStateWarm - Container is running and ready for requests</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    InstanceStateWarm</span><span style=\"color:#B392F0\"> FunctionInstanceState</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"WARM\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // InstanceStateActive - Container is currently executing a request</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    InstanceStateActive</span><span style=\"color:#B392F0\"> FunctionInstanceState</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"ACTIVE\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // InstanceStateDraining - Container is finishing current requests, no new requests</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    InstanceStateDraining</span><span style=\"color:#B392F0\"> FunctionInstanceState</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"DRAINING\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // InstanceStateTerminated - Container has been stopped and cleaned up</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    InstanceStateTerminated</span><span style=\"color:#B392F0\"> FunctionInstanceState</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"TERMINATED\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // InstanceStateError - Container is in an error state and needs recovery</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    InstanceStateError</span><span style=\"color:#B392F0\"> FunctionInstanceState</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"ERROR\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Validate checks if the FunctionDefinition has required fields</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">fd </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Validate</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Check that Name is non-empty and follows naming conventions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Validate Runtime is supported (go, python, nodejs, etc.)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Validate Handler format based on runtime</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Ensure Timeout is between 1 and maximum allowed (e.g., 900 seconds)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Ensure MemoryMB is within allowed range (e.g., 128MB to 3008MB)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Validate CPUQuota is positive and within limits</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// IsActive returns true if the instance can accept new requests</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">fi </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FunctionInstance</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">IsActive</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> fi.State </span><span style=\"color:#F97583\">==</span><span style=\"color:#E1E4E8\"> InstanceStateWarm </span><span style=\"color:#F97583\">||</span><span style=\"color:#E1E4E8\"> fi.State </span><span style=\"color:#F97583\">==</span><span style=\"color:#E1E4E8\"> InstanceStateActive</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Age returns how long the instance has been running</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">fi </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FunctionInstance</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Age</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(fi.CreatedAt)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// IdleDuration returns how long the instance has been idle</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">fi </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FunctionInstance</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">IdleDuration</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(fi.LastUsedAt)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>File: <code>internal/models/invocation.go</code></strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> models</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// InvocationRequest represents a request to execute a function</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> InvocationRequest</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Unique identifier for this invocation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"id\" yaml:\"id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Function to invoke</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    FunctionName    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"functionName\" yaml:\"functionName\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    FunctionVersion </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"functionVersion\" yaml:\"functionVersion\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Input payload (JSON, binary, etc.)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Payload []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#9ECBFF\"> `json:\"payload\" yaml:\"payload\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Synchronous (wait for response) vs asynchronous (fire and forget)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Synchronous </span><span style=\"color:#F97583\">bool</span><span style=\"color:#9ECBFF\"> `json:\"synchronous\" yaml:\"synchronous\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // When this request must be completed by</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Deadline </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"deadline\" yaml:\"deadline\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Metadata</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RequestID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"requestId\" yaml:\"requestId\"`</span><span style=\"color:#6A737D\"> // External request ID</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Source    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"source\" yaml:\"source\"`</span><span style=\"color:#6A737D\">       // Source of invocation (HTTP, event, etc.)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"createdAt\" yaml:\"createdAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Routing hints (optional)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    PreferredInstanceID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"preferredInstanceId,omitempty\" yaml:\"preferredInstanceId,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Callback URL for async invocations</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CallbackURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"callbackUrl,omitempty\" yaml:\"callbackUrl,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// InvocationResponse represents the result of a function execution</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> InvocationResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Corresponding request ID</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RequestID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"requestId\" yaml:\"requestId\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Function output</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Payload []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#9ECBFF\"> `json:\"payload\" yaml:\"payload\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Execution metadata</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DurationMS   </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">     `json:\"durationMS\" yaml:\"durationMS\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MemoryUsedMB </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">       `json:\"memoryUsedMB\" yaml:\"memoryUsedMB\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    BilledDurationMS </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\"> `json:\"billedDurationMS\" yaml:\"billedDurationMS\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Error information (if any)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Error     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"error,omitempty\" yaml:\"error,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrorType </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"errorType,omitempty\" yaml:\"errorType,omitempty\"`</span><span style=\"color:#6A737D\"> // Runtime, Timeout, etc.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Instance that executed this</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    InstanceID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"instanceId\" yaml:\"instanceId\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Timestamps</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    StartedAt  </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"startedAt\" yaml:\"startedAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    FinishedAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"finishedAt\" yaml:\"finishedAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// InvocationStatus represents the status of an asynchronous invocation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> InvocationStatus</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RequestID   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">               `json:\"requestId\" yaml:\"requestId\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status      </span><span style=\"color:#B392F0\">InvocationStatusType</span><span style=\"color:#9ECBFF\"> `json:\"status\" yaml:\"status\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Result      </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">InvocationResponse</span><span style=\"color:#9ECBFF\">  `json:\"result,omitempty\" yaml:\"result,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    LastUpdated </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\">            `json:\"lastUpdated\" yaml:\"lastUpdated\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> InvocationStatusType</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    InvocationStatusPending</span><span style=\"color:#B392F0\">   InvocationStatusType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"PENDING\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    InvocationStatusRunning</span><span style=\"color:#B392F0\">   InvocationStatusType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"RUNNING\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    InvocationStatusCompleted</span><span style=\"color:#B392F0\"> InvocationStatusType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"COMPLETED\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    InvocationStatusFailed</span><span style=\"color:#B392F0\">    InvocationStatusType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"FAILED\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    InvocationStatusTimeout</span><span style=\"color:#B392F0\">   InvocationStatusType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"TIMEOUT\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// IsExpired returns true if the request has passed its deadline</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">ir </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">IsExpired</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">After</span><span style=\"color:#E1E4E8\">(ir.Deadline)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TimeRemaining returns how much time is left before the deadline</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">ir </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">TimeRemaining</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> ir.Deadline.</span><span style=\"color:#B392F0\">Sub</span><span style=\"color:#E1E4E8\">(time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>File: <code>pkg/container/manager.go</code></strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> container</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">io</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ContainerManager defines the interface for managing isolated execution environments</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ContainerManager</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // CreateContainer creates a new container with the specified configuration</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    CreateContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#B392F0\"> CreateContainerRequest</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Container</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // StartContainer begins execution of the container</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    StartContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ExecuteInContainer runs a command inside a running container</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    ExecuteInContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">cmd</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">input</span><span style=\"color:#B392F0\"> io</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Reader</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">output</span><span style=\"color:#B392F0\"> io</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Writer</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // StopContainer gracefully stops a running container</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    StopContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">timeout</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // RemoveContainer cleans up container resources</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    RemoveContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // GetContainerStats returns resource usage statistics</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    GetContainerStats</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">ContainerStats</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ListContainers returns all managed containers</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    ListContainers</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">filter</span><span style=\"color:#B392F0\"> ListFilter</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">Container</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // HealthCheck verifies the container manager is operational</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    HealthCheck</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CreateContainerRequest contains all parameters needed to create a container</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> CreateContainerRequest</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Container image name and tag</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Image </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"image\" yaml:\"image\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Command to run (overrides image's CMD)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Cmd []</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"cmd\" yaml:\"cmd\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Environment variables</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Env []</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"env\" yaml:\"env\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Labels for metadata</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Labels </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"labels\" yaml:\"labels\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // CPU quota (percentage of a single core, 100 = full core)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CPUQuota </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\"> `json:\"cpuQuota\" yaml:\"cpuQuota\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Memory limit in bytes</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MemoryLimit </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\"> `json:\"memoryLimit\" yaml:\"memoryLimit\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Network mode (bridge, host, none)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    NetworkMode </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"networkMode\" yaml:\"networkMode\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Volume bindings (host:container:mode)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Binds []</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"binds\" yaml:\"binds\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Working directory inside container</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    WorkingDir </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"workingDir\" yaml:\"workingDir\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // User to run as (uid:gid)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    User </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"user\" yaml:\"user\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Security options (seccomp, AppArmor)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    SecurityOpts []</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"securityOpts\" yaml:\"securityOpts\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Exposed ports</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExposedPorts </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">struct</span><span style=\"color:#E1E4E8\">{} </span><span style=\"color:#9ECBFF\">`json:\"exposedPorts\" yaml:\"exposedPorts\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Port bindings</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    PortBindings </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">][]</span><span style=\"color:#B392F0\">PortBinding</span><span style=\"color:#9ECBFF\"> `json:\"portBindings\" yaml:\"portBindings\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Container represents a container instance</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Container</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Unique identifier</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"id\" yaml:\"id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Container image</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Image </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"image\" yaml:\"image\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Current status</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status </span><span style=\"color:#B392F0\">ContainerStatus</span><span style=\"color:#9ECBFF\"> `json:\"status\" yaml:\"status\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Creation timestamp</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"createdAt\" yaml:\"createdAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Labels for metadata</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Labels </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"labels\" yaml:\"labels\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Additional metadata</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Names []</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"names\" yaml:\"names\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Ports []</span><span style=\"color:#B392F0\">Port</span><span style=\"color:#9ECBFF\">   `json:\"ports\" yaml:\"ports\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ContainerStatus represents the lifecycle state of a container</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ContainerStatus</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    StatusCreated</span><span style=\"color:#B392F0\">    ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"created\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    StatusRunning</span><span style=\"color:#B392F0\">    ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"running\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    StatusPaused</span><span style=\"color:#B392F0\">     ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"paused\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    StatusRestarting</span><span style=\"color:#B392F0\"> ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"restarting\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    StatusExited</span><span style=\"color:#B392F0\">     ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"exited\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    StatusDead</span><span style=\"color:#B392F0\">       ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"dead\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ContainerStats contains resource usage statistics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ContainerStats</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CPUPercent    </span><span style=\"color:#F97583\">float64</span><span style=\"color:#9ECBFF\">   `json:\"cpuPercent\" yaml:\"cpuPercent\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MemoryUsage   </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">     `json:\"memoryUsage\" yaml:\"memoryUsage\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MemoryLimit   </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">     `json:\"memoryLimit\" yaml:\"memoryLimit\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MemoryPercent </span><span style=\"color:#F97583\">float64</span><span style=\"color:#9ECBFF\">   `json:\"memoryPercent\" yaml:\"memoryPercent\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    NetworkRx     </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">     `json:\"networkRx\" yaml:\"networkRx\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    NetworkTx     </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">     `json:\"networkTx\" yaml:\"networkTx\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    BlockRead     </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">     `json:\"blockRead\" yaml:\"blockRead\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    BlockWrite    </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">     `json:\"blockWrite\" yaml:\"blockWrite\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    PIDs          </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">       `json:\"pids\" yaml:\"pids\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ReadAt        </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"readAt\" yaml:\"readAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ListFilter allows filtering containers by criteria</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ListFilter</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Labels </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"labels\" yaml:\"labels\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status []</span><span style=\"color:#B392F0\">ContainerStatus</span><span style=\"color:#9ECBFF\"> `json:\"status\" yaml:\"status\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Port represents a network port mapping</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Port</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IP          </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"ip\" yaml:\"ip\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    PrivatePort </span><span style=\"color:#F97583\">uint16</span><span style=\"color:#9ECBFF\"> `json:\"privatePort\" yaml:\"privatePort\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    PublicPort  </span><span style=\"color:#F97583\">uint16</span><span style=\"color:#9ECBFF\"> `json:\"publicPort\" yaml:\"publicPort\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Type        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"type\" yaml:\"type\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// PortBinding represents a port binding configuration</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> PortBinding</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    HostIP   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"hostIp\" yaml:\"hostIp\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    HostPort </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"hostPort\" yaml:\"hostPort\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>File: <code>pkg/metrics/metrics.go</code></strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> metrics</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/prometheus/client_golang/prometheus</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Metrics encapsulates all Prometheus metrics for the runtime</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Metrics</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Cold start latency histogram (seconds)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ColdStartLatency </span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Histogram</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Function invocation duration histogram (seconds)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    InvocationDuration </span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Histogram</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Currently active invocations gauge</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ActiveInvocations </span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Gauge</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Invocation errors counter (by error type)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    InvocationErrors </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterVec</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Function invocations counter (by function name)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    FunctionInvocations </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterVec</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Container operations counter</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ContainerOperations </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterVec</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Resource usage gauges</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MemoryUsageMB     </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">GaugeVec</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CPUUsagePercent   </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">GaugeVec</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ContainerCount    </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">GaugeVec</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewMetrics creates and registers all Prometheus metrics for the runtime</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewMetrics</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Metrics</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Metrics</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ColdStartLatency: prometheus.</span><span style=\"color:#B392F0\">NewHistogram</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HistogramOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name:    </span><span style=\"color:#9ECBFF\">\"function_cold_start_latency_seconds\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help:    </span><span style=\"color:#9ECBFF\">\"Time taken for cold start initialization\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Buckets: prometheus.</span><span style=\"color:#B392F0\">ExponentialBuckets</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0.1</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">), </span><span style=\"color:#6A737D\">// 100ms to ~51.2s</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        InvocationDuration: prometheus.</span><span style=\"color:#B392F0\">NewHistogram</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HistogramOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name:    </span><span style=\"color:#9ECBFF\">\"function_invocation_duration_seconds\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help:    </span><span style=\"color:#9ECBFF\">\"Time taken for function execution\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Buckets: prometheus.</span><span style=\"color:#B392F0\">ExponentialBuckets</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0.01</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">12</span><span style=\"color:#E1E4E8\">), </span><span style=\"color:#6A737D\">// 10ms to ~20.48s</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ActiveInvocations: prometheus.</span><span style=\"color:#B392F0\">NewGauge</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">GaugeOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name: </span><span style=\"color:#9ECBFF\">\"active_invocations_total\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help: </span><span style=\"color:#9ECBFF\">\"Number of currently executing function invocations\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        InvocationErrors: prometheus.</span><span style=\"color:#B392F0\">NewCounterVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name: </span><span style=\"color:#9ECBFF\">\"invocation_errors_total\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help: </span><span style=\"color:#9ECBFF\">\"Total number of invocation errors by type\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error_type\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        FunctionInvocations: prometheus.</span><span style=\"color:#B392F0\">NewCounterVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name: </span><span style=\"color:#9ECBFF\">\"function_invocations_total\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help: </span><span style=\"color:#9ECBFF\">\"Total number of function invocations\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"runtime\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"status\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ContainerOperations: prometheus.</span><span style=\"color:#B392F0\">NewCounterVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name: </span><span style=\"color:#9ECBFF\">\"container_operations_total\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help: </span><span style=\"color:#9ECBFF\">\"Total number of container operations\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"operation\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"status\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        MemoryUsageMB: prometheus.</span><span style=\"color:#B392F0\">NewGaugeVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">GaugeOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name: </span><span style=\"color:#9ECBFF\">\"container_memory_usage_mb\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help: </span><span style=\"color:#9ECBFF\">\"Memory usage of containers in MB\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"instance_id\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        CPUUsagePercent: prometheus.</span><span style=\"color:#B392F0\">NewGaugeVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">GaugeOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name: </span><span style=\"color:#9ECBFF\">\"container_cpu_usage_percent\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help: </span><span style=\"color:#9ECBFF\">\"CPU usage of containers as percentage\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"instance_id\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ContainerCount: prometheus.</span><span style=\"color:#B392F0\">NewGaugeVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">GaugeOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name: </span><span style=\"color:#9ECBFF\">\"container_count_total\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help: </span><span style=\"color:#9ECBFF\">\"Number of containers by state\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"state\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Register all metrics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    prometheus.</span><span style=\"color:#B392F0\">MustRegister</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m.ColdStartLatency,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m.InvocationDuration,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m.ActiveInvocations,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m.InvocationErrors,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m.FunctionInvocations,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m.ContainerOperations,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m.MemoryUsageMB,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m.CPUUsagePercent,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m.ContainerCount,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> m</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RecordColdStart records the duration of a cold start invocation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Metrics</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RecordColdStart</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">startTime</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    duration </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(startTime).</span><span style=\"color:#B392F0\">Seconds</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.ColdStartLatency.</span><span style=\"color:#B392F0\">Observe</span><span style=\"color:#E1E4E8\">(duration)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RecordInvocation records the completion of a function invocation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Metrics</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RecordInvocation</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">functionName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">startTime</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    duration </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(startTime).</span><span style=\"color:#B392F0\">Seconds</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.InvocationDuration.</span><span style=\"color:#B392F0\">Observe</span><span style=\"color:#E1E4E8\">(duration)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Update counters based on success/error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    status </span><span style=\"color:#F97583\">:=</span><span style=\"color:#9ECBFF\"> \"success\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        status </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"error\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m.InvocationErrors.</span><span style=\"color:#B392F0\">WithLabelValues</span><span style=\"color:#E1E4E8\">(functionName, </span><span style=\"color:#9ECBFF\">\"execution_error\"</span><span style=\"color:#E1E4E8\">).</span><span style=\"color:#B392F0\">Inc</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.FunctionInvocations.</span><span style=\"color:#B392F0\">WithLabelValues</span><span style=\"color:#E1E4E8\">(functionName, </span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">, status).</span><span style=\"color:#B392F0\">Inc</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"c-entry-point-skeleton-code\">C. Entry Point Skeleton Code</h4>\n<p><strong>File: <code>cmd/controller/main.go</code></strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> main</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">log</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os/signal</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">syscall</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourorg/serverless-runtime/internal/controller</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourorg/serverless-runtime/pkg/metrics</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/prometheus/client_golang/prometheus/promhttp</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Load configuration from file and environment variables</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Initialize structured logger with appropriate level</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Create metrics instance</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    metrics </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> metrics.</span><span style=\"color:#B392F0\">NewMetrics</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Initialize controller</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Create ContainerManager implementation (DockerManager)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Create Storage client</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Create FunctionManager, InstanceManager, WarmPoolManager</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Create Scaler with appropriate strategy</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 7: Initialize Controller with all dependencies</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ctrl, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> controller.</span><span style=\"color:#B392F0\">NewController</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">controller</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 8: Populate configuration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Failed to create controller: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Start controller</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ctx, cancel </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithCancel</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#B392F0\"> cancel</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Start metrics server</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    go</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/metrics\"</span><span style=\"color:#E1E4E8\">, promhttp.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/health\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // TODO 9: Implement health check that verifies all subsystems</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(http.StatusOK)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Println</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Starting metrics server on :9090\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">ListenAndServe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\":9090\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            log.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Metrics server error: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Start gRPC/HTTP API server</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 10: Start API server for Gateway communication</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Start scaling decision loop</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 11: Start periodic scaling evaluation in goroutine</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Start warm pool maintenance</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 12: Start periodic warm pool cleanup and refresh</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Println</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Controller started successfully\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Wait for shutdown signal</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    sigChan </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">chan</span><span style=\"color:#B392F0\"> os</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Signal</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    signal.</span><span style=\"color:#B392F0\">Notify</span><span style=\"color:#E1E4E8\">(sigChan, syscall.SIGINT, syscall.SIGTERM)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    &#x3C;-</span><span style=\"color:#E1E4E8\">sigChan</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Println</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Shutdown signal received\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Graceful shutdown</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    shutdownCtx, shutdownCancel </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithTimeout</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#B392F0\"> shutdownCancel</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 13: Implement graceful shutdown - stop accepting new requests,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //          drain existing requests, clean up resources</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> ctrl.</span><span style=\"color:#B392F0\">Shutdown</span><span style=\"color:#E1E4E8\">(shutdownCtx); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Error during shutdown: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Println</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Controller shutdown complete\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"d-language-specific-hints-for-go\">D. Language-Specific Hints for Go</h4>\n<ol>\n<li><p><strong>Concurrency</strong>: Use <code>sync.WaitGroup</code> for coordinating goroutine completion and <code>errgroup</code> for error propagation in concurrent operations.</p>\n</li>\n<li><p><strong>Context Propagation</strong>: Always pass <code>context.Context</code> through function calls to enable cancellation and timeouts across the entire call chain.</p>\n</li>\n<li><p><strong>Error Handling</strong>: Use <code>fmt.Errorf</code> with <code>%w</code> for wrapping errors and implement custom error types for specific error categories (e.g., <code>ErrFunctionNotFound</code>, <code>ErrInstanceBusy</code>).</p>\n</li>\n<li><p><strong>Configuration</strong>: Consider using <code>viper</code> for configuration management with support for multiple formats (YAML, JSON, env vars) and <code>validator</code> for struct validation.</p>\n</li>\n<li><p><strong>HTTP Client Pooling</strong>: Reuse HTTP clients with appropriate timeouts:</p>\n</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">   httpClient </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">       Timeout: </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">       Transport: </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Transport</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">           MaxIdleConns:        </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">           MaxIdleConnsPerHost: </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">           IdleConnTimeout:     </span><span style=\"color:#79B8FF\">90</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">       },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   }</span></span></code></pre></div>\n\n<ol start=\"6\">\n<li><p><strong>Graceful Shutdown Pattern</strong>: Implement graceful shutdown using contexts and wait for in-flight operations to complete before exiting.</p>\n</li>\n<li><p><strong>Structured Logging</strong>: Use <code>slog</code> (Go 1.21+) or <code>logrus</code>/<code>zap</code> for structured logging with fields for correlation IDs and request tracing.</p>\n</li>\n<li><p><strong>Metrics Collection</strong>: Use the Prometheus client library and expose metrics on a separate port (typically <code>:9090</code>) for scraping by monitoring systems.</p>\n</li>\n<li><p><strong>Interface-Based Design</strong>: Define clear interfaces between components to enable testing and alternative implementations (e.g., different <code>ContainerManager</code> implementations).</p>\n</li>\n<li><p><strong>Dependency Injection</strong>: Use constructor-based dependency injection to make components testable and configurable.</p>\n</li>\n</ol>\n<h4 id=\"e-milestone-checkpoint-for-architecture-foundation\">E. Milestone Checkpoint for Architecture Foundation</h4>\n<p>After setting up the basic structure:</p>\n<ol>\n<li><strong>Verify Project Structure</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   $ tree -L 3 serverless-runtime/\n   # Should show the directory structure as outlined above</code></pre></div>\n\n<ol start=\"2\">\n<li><strong>Build the Project</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   $ cd serverless-runtime\n   $ go mod init github.com/yourorg/serverless-runtime\n   $ go mod tidy\n   $ go build ./cmd/controller\n   $ go build ./cmd/gateway</code></pre></div>\n\n<ol start=\"3\">\n<li><strong>Run Basic Tests</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   $ go test ./internal/models/... -v\n   # Should pass model validation tests</code></pre></div>\n\n<ol start=\"4\">\n<li><strong>Check Dependencies</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   $ go list -m all | grep -E &quot;(prometheus|docker|grpc)&quot;\n   # Should show required dependencies</code></pre></div>\n\n<ol start=\"5\">\n<li><p><strong>Expected Signs of Correct Setup</strong>:</p>\n<ul>\n<li>All Go files compile without errors</li>\n<li>Models package can be imported by other packages</li>\n<li>Prometheus metrics can be registered without panic</li>\n<li>Basic <code>FunctionDefinition</code> validation logic works</li>\n</ul>\n</li>\n<li><p><strong>Common Early Issues</strong>:</p>\n<ul>\n<li><strong>Symptom</strong>: &quot;Cannot find package&quot; errors<ul>\n<li><strong>Fix</strong>: Ensure <code>go.mod</code> is in the root directory and run <code>go mod tidy</code></li>\n</ul>\n</li>\n<li><strong>Symptom</strong>: Circular import dependencies<ul>\n<li><strong>Fix</strong>: Re-evaluate package structure - higher-level packages should not import lower-level implementation packages</li>\n</ul>\n</li>\n<li><strong>Symptom</strong>: Interface implementation errors<ul>\n<li><strong>Fix</strong>: Ensure all interface methods are implemented with exact signatures</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<p>This architectural foundation sets the stage for implementing each milestone systematically. The clear separation of concerns allows you to work on packaging (Milestone 1), execution (Milestone 2), optimization (Milestone 3), routing (Milestone 4), and scaling (Milestone 5) in parallel or sequence with well-defined interfaces between components.</p>\n<h2 id=\"data-model\">Data Model</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> This section establishes the fundamental data structures that all subsequent milestones (1-5) will use to represent functions, their execution environments, and invocation requests. It provides the &quot;vocabulary&quot; for the entire system.</p>\n</blockquote>\n<p>A serverless runtime&#39;s data model serves as the system&#39;s shared language—it defines what a function <em>is</em>, how an invocation <em>is represented</em>, and what state an execution environment <em>can be in</em>. Without a precise data model, components would pass ambiguous messages, leading to race conditions, resource leaks, and incorrect behavior. Think of this as the <strong>blueprint and vocabulary</strong> that every component (gateway, controller, worker pool) must agree upon to collaborate effectively.</p>\n<p>This section defines the core entities and their relationships. First, we&#39;ll establish the key data structures through detailed tables, then formalize the lifecycle states that function instances transition through during their existence.</p>\n<h3 id=\"core-types-and-structures\">Core Types and Structures</h3>\n<p>The system revolves around three primary entities: <strong>Function Definitions</strong> (the code and configuration), <strong>Function Instances</strong> (running environments executing that code), and <strong>Invocation Requests</strong> (individual calls to execute the function). Their relationships can be visualized as:</p>\n<p><img src=\"/api/project/serverless-runtime/architecture-doc/asset?path=diagrams%2Fdata-model-diagram.svg\" alt=\"Core Data Relationships\"></p>\n<p>A single <code>FunctionDefinition</code> can have many <code>FunctionInstance</code>s running simultaneously (for scaling). Each <code>FunctionInstance</code> processes one <code>InvocationRequest</code> at a time (though it may process multiple sequentially). An <code>InvocationRequest</code> targets a specific <code>FunctionDefinition</code> but may be routed to any available <code>FunctionInstance</code> for that function.</p>\n<h4 id=\"functiondefinition-the-blueprint\">FunctionDefinition: The Blueprint</h4>\n<p>Think of a <code>FunctionDefinition</code> as a <strong>recipe card</strong> for your function. It contains all the instructions needed to create an execution environment: what code to run, which runtime to use, how much memory to allocate, and what environment variables to set. This is an immutable specification—once created, it represents a specific version of your function code and configuration.</p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Name</code></td>\n<td><code>string</code></td>\n<td>Unique identifier for the function (e.g., &quot;image-processor&quot;). Used in API paths and logging.</td>\n</tr>\n<tr>\n<td><code>Runtime</code></td>\n<td><code>string</code></td>\n<td>Execution environment language and version (e.g., &quot;python3.9&quot;, &quot;go1.19&quot;, &quot;nodejs18&quot;). Determines which base container image to use.</td>\n</tr>\n<tr>\n<td><code>Handler</code></td>\n<td><code>string</code></td>\n<td>Entry point within the code package. Format varies by runtime: Python uses &quot;module.function&quot;, Go uses compiled binary name, Node.js uses &quot;module.export&quot;.</td>\n</tr>\n<tr>\n<td><code>CodePath</code></td>\n<td><code>string</code></td>\n<td>Storage location URI for the packaged function artifact (e.g., &quot;s3://bucket/functions/image-processor-v1.zip&quot;). References the actual code bytes.</td>\n</tr>\n<tr>\n<td><code>Timeout</code></td>\n<td><code>int</code></td>\n<td>Maximum execution duration in seconds before the function is forcibly terminated. Critical for preventing runaway executions.</td>\n</tr>\n<tr>\n<td><code>MemoryMB</code></td>\n<td><code>int</code></td>\n<td>Memory allocation in megabytes. This determines both the container&#39;s memory limit and billing granularity in production systems.</td>\n</tr>\n<tr>\n<td><code>CPUQuota</code></td>\n<td><code>int64</code></td>\n<td>CPU allocation as a percentage of a single core (100 = 1 core, 200 = 2 cores). Used to set cgroup CPU quotas for fair sharing.</td>\n</tr>\n<tr>\n<td><code>EnvVars</code></td>\n<td><code>map[string]string</code></td>\n<td>Key-value pairs injected as environment variables into the execution environment. Used for configuration like API keys or feature flags.</td>\n</tr>\n<tr>\n<td><code>Dependencies</code></td>\n<td><code>[]string</code></td>\n<td>List of dependency package names/versions (language-specific). For Python: <code>[&quot;requests==2.28.0&quot;, &quot;pillow&gt;=9.0&quot;]</code>. For Go: empty (dependencies compiled in).</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>Key Insight:</strong> The <code>FunctionDefinition</code> is <strong>immutable</strong> once stored. When you update a function, you create a new <code>FunctionDefinition</code> with a new version identifier, leaving previous versions intact for rollback and audit purposes.</p>\n</blockquote>\n<h4 id=\"functioninstance-the-running-process\">FunctionInstance: The Running Process</h4>\n<p>A <code>FunctionInstance</code> represents an <strong>actual, running execution environment</strong>—a container or microVM that has been instantiated from a <code>FunctionDefinition</code>. Think of it as a <strong>kitchen that has been set up according to a recipe card</strong>. It has its own resources, lifecycle, and current state.</p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>ID</code></td>\n<td><code>string</code></td>\n<td>Unique identifier for this specific instance (UUID). Used for routing, logging, and management.</td>\n</tr>\n<tr>\n<td><code>FunctionName</code></td>\n<td><code>string</code></td>\n<td>References the <code>FunctionDefinition.Name</code> this instance was created from.</td>\n</tr>\n<tr>\n<td><code>FunctionVersion</code></td>\n<td><code>string</code></td>\n<td>References the specific version of the function (e.g., &quot;v1.2.3&quot;). Together with <code>FunctionName</code>, fully identifies the blueprint.</td>\n</tr>\n<tr>\n<td><code>State</code></td>\n<td><code>FunctionInstanceState</code></td>\n<td>Current lifecycle state (see next subsection). Determines whether the instance can accept new requests.</td>\n</tr>\n<tr>\n<td><code>ContainerID</code></td>\n<td><code>string</code></td>\n<td>Reference to the underlying container or microVM (e.g., Docker container ID, Firecracker VM ID).</td>\n</tr>\n<tr>\n<td><code>Host</code></td>\n<td><code>string</code></td>\n<td>IP address or hostname where the instance is running. Used by the gateway to route HTTP requests.</td>\n</tr>\n<tr>\n<td><code>Port</code></td>\n<td><code>int</code></td>\n<td>TCP port where the instance&#39;s HTTP server is listening. Combined with <code>Host</code> forms the endpoint.</td>\n</tr>\n<tr>\n<td><code>MemoryUsageMB</code></td>\n<td><code>int</code></td>\n<td>Current memory usage in megabytes. Updated periodically from container stats for monitoring and scaling decisions.</td>\n</tr>\n<tr>\n<td><code>CPUUsage</code></td>\n<td><code>float64</code></td>\n<td>Current CPU usage as percentage of allocated quota. Also from container stats.</td>\n</tr>\n<tr>\n<td><code>CreatedAt</code></td>\n<td><code>time.Time</code></td>\n<td>When the instance was first created. Used to calculate age for cleanup of stale instances.</td>\n</tr>\n<tr>\n<td><code>LastUsedAt</code></td>\n<td><code>time.Time</code></td>\n<td>When the instance last processed a request. Critical for determining idle time and scale-down decisions.</td>\n</tr>\n<tr>\n<td><code>TerminatedAt</code></td>\n<td><code>*time.Time</code></td>\n<td>When the instance was terminated (nil if still running). Used for cleanup and accounting.</td>\n</tr>\n<tr>\n<td><code>InvocationCount</code></td>\n<td><code>int</code></td>\n<td>Number of requests this instance has processed. Helps identify &quot;hot&quot; instances for sticky routing or debugging.</td>\n</tr>\n<tr>\n<td><code>TotalDurationMS</code></td>\n<td><code>int64</code></td>\n<td>Cumulative milliseconds spent executing requests. Used for performance analysis and cost estimation.</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>Design Rationale:</strong> Separating the blueprint (<code>FunctionDefinition</code>) from the running instance (<code>FunctionInstance</code>) allows multiple instances of the same function to run concurrently (for scaling) while sharing the same immutable specification. The instance tracks runtime-specific details like resource usage and lifecycle state.</p>\n</blockquote>\n<h4 id=\"invocationrequest-the-work-item\">InvocationRequest: The Work Item</h4>\n<p>An <code>InvocationRequest</code> represents a <strong>single call to execute a function</strong>. Think of it as a <strong>customer order ticket</strong> that arrives at the restaurant—it specifies what function to run, provides input data, and includes metadata about how to handle the request (deadlines, callbacks, etc.).</p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>ID</code></td>\n<td><code>string</code></td>\n<td>Unique identifier for this invocation (UUID). Used for idempotency, tracing, and result lookup.</td>\n</tr>\n<tr>\n<td><code>FunctionName</code></td>\n<td><code>string</code></td>\n<td>Name of the function to invoke. The gateway uses this to route to the appropriate function pool.</td>\n</tr>\n<tr>\n<td><code>FunctionVersion</code></td>\n<td><code>string</code></td>\n<td>Optional version constraint (e.g., &quot;latest&quot;, &quot;v1.2&quot;). If empty, defaults to the latest active version.</td>\n</tr>\n<tr>\n<td><code>Payload</code></td>\n<td><code>[]byte</code></td>\n<td>Raw request body (e.g., JSON, binary data) passed to the function as input.</td>\n</tr>\n<tr>\n<td><code>Synchronous</code></td>\n<td><code>bool</code></td>\n<td>Whether the caller waits for a response (true) or the request is queued for async execution (false).</td>\n</tr>\n<tr>\n<td><code>Deadline</code></td>\n<td><code>time.Time</code></td>\n<td>Absolute time by which the function must complete. Used for timeout enforcement and queue priority.</td>\n</tr>\n<tr>\n<td><code>RequestID</code></td>\n<td><code>string</code></td>\n<td>Client-provided identifier for correlation (often passed through in headers). Distinct from system <code>ID</code>.</td>\n</tr>\n<tr>\n<td><code>Source</code></td>\n<td><code>string</code></td>\n<td>Event source that triggered the invocation (e.g., &quot;api-gateway&quot;, &quot;s3:bucket-created&quot;, &quot;cron:nightly&quot;).</td>\n</tr>\n<tr>\n<td><code>CreatedAt</code></td>\n<td><code>time.Time</code></td>\n<td>When the request arrived at the system. Used for queue latency metrics.</td>\n</tr>\n<tr>\n<td><code>PreferredInstanceID</code></td>\n<td><code>string</code></td>\n<td>Optional hint for sticky routing—if provided, the gateway tries to route to this specific instance.</td>\n</tr>\n<tr>\n<td><code>CallbackURL</code></td>\n<td><code>string</code></td>\n<td>For async invocations, URL to POST the result to when complete. Empty for synchronous requests.</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>Key Insight:</strong> The <code>InvocationRequest</code> captures both the <strong>data</strong> (<code>Payload</code>) and <strong>metadata</strong> (<code>Deadline</code>, <code>CallbackURL</code>) about an execution. This separation allows the system to handle scheduling, routing, and lifecycle management independently of the actual function logic.</p>\n</blockquote>\n<h4 id=\"supporting-data-structures\">Supporting Data Structures</h4>\n<p>Several supporting types enable detailed management and observability:</p>\n<p><strong>Container and ContainerManager Types</strong>\nThese types abstract over the underlying container runtime (Docker, containerd, Firecracker):</p>\n<table>\n<thead>\n<tr>\n<th>Type/Field</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Container</code></td>\n<td>Represents a managed container/microVM with its ID, image, status, labels, and network ports.</td>\n</tr>\n<tr>\n<td><code>CreateContainerRequest</code></td>\n<td>Configuration for creating a new isolated environment—image, command, environment variables, resource limits, security options, and port bindings.</td>\n</tr>\n<tr>\n<td><code>ContainerStats</code></td>\n<td>Resource usage metrics sampled from a running container: CPU %, memory usage/limit, network I/O, block I/O, and process count.</td>\n</tr>\n<tr>\n<td><code>ContainerManager</code></td>\n<td>Interface defining operations for managing isolated environments: create, start, stop, remove, execute commands, and collect stats.</td>\n</tr>\n<tr>\n<td><code>ListFilter</code></td>\n<td>Criteria for listing containers (by labels, status). Used to find function instances by function name/version.</td>\n</tr>\n</tbody></table>\n<p><strong>Invocation Tracking Types</strong>\nThese types track the progress and outcome of function executions:</p>\n<table>\n<thead>\n<tr>\n<th>Type/Field</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>InvocationResponse</code></td>\n<td>Result returned from a function execution: output payload, duration, memory used, any error, and which instance processed it.</td>\n</tr>\n<tr>\n<td><code>InvocationStatus</code></td>\n<td>Tracks the state of an asynchronous invocation: pending, running, completed, failed, or timed out, with pointer to the result when available.</td>\n</tr>\n</tbody></table>\n<p><strong>Metrics Type</strong>\nThe <code>Metrics</code> struct aggregates all Prometheus metrics for observability: cold start latency histograms, invocation duration histograms, active invocation gauges, error counters categorized by function and error type, container operation counters, and resource usage gauges per instance.</p>\n<h3 id=\"lifecycle-state-definitions\">Lifecycle State Definitions</h3>\n<p>A <code>FunctionInstance</code> transitions through a well-defined set of states during its lifetime. Understanding these states is critical for proper request routing, scaling decisions, and resource cleanup. The state transitions can be visualized as:</p>\n<p><img src=\"/api/project/serverless-runtime/architecture-doc/asset?path=diagrams%2Finstance-state-machine.svg\" alt=\"Function Instance Lifecycle\"></p>\n<h4 id=\"functioninstancestate-constants\">FunctionInstanceState Constants</h4>\n<p>Each state represents a specific phase in the instance&#39;s existence:</p>\n<table>\n<thead>\n<tr>\n<th>Constant</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>InstanceStateProvisioning</code></td>\n<td>The container is being created and started. The runtime environment is being prepared but is not yet ready to accept requests. This is the initial state after <code>CreateContainer</code>.</td>\n</tr>\n<tr>\n<td><code>InstanceStateWarm</code></td>\n<td>The container is running, the function runtime (e.g., Python interpreter, JVM) is initialized, dependencies are loaded, and the instance is <strong>ready to immediately accept requests</strong>. This is the state for instances in the warm pool.</td>\n</tr>\n<tr>\n<td><code>InstanceStateActive</code></td>\n<td>The instance is currently executing a request. No new requests should be routed to it until it completes. This state ensures per-instance concurrency limits are enforced.</td>\n</tr>\n<tr>\n<td><code>InstanceStateDraining</code></td>\n<td>The instance is finishing its current request(s) but will not accept new ones. Used during scale-down or before termination to gracefully handle in-flight requests.</td>\n</tr>\n<tr>\n<td><code>InstanceStateTerminated</code></td>\n<td>The container has been stopped and all resources cleaned up. This is a terminal state—the instance record may be kept for auditing but is no longer active.</td>\n</tr>\n<tr>\n<td><code>InstanceStateError</code></td>\n<td>The container has crashed, failed health checks, or entered an unrecoverable state. The system should replace it with a new instance and log the error for debugging.</td>\n</tr>\n</tbody></table>\n<h4 id=\"state-transition-logic\">State Transition Logic</h4>\n<p>The following table defines the events that trigger state changes and the actions the system must take during each transition:</p>\n<table>\n<thead>\n<tr>\n<th>Current State</th>\n<th>Event</th>\n<th>Next State</th>\n<th>Action Taken</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Provisioning</code></td>\n<td>Container started successfully, runtime initialized</td>\n<td><code>Warm</code></td>\n<td>Add instance to warm pool; make it available for routing</td>\n</tr>\n<tr>\n<td><code>Provisioning</code></td>\n<td>Container startup failed (timeout, OOM, image pull error)</td>\n<td><code>Error</code></td>\n<td>Log error; notify controller to possibly retry creation</td>\n</tr>\n<tr>\n<td><code>Warm</code></td>\n<td>Request assigned to instance</td>\n<td><code>Active</code></td>\n<td>Mark instance as busy; start execution timeout timer</td>\n</tr>\n<tr>\n<td><code>Active</code></td>\n<td>Request completed (success or error)</td>\n<td><code>Warm</code></td>\n<td>Update <code>LastUsedAt</code>; return to warm pool if healthy</td>\n</tr>\n<tr>\n<td><code>Active</code></td>\n<td>Request timed out or instance crashed</td>\n<td><code>Error</code></td>\n<td>Force stop container; log failure; remove from pools</td>\n</tr>\n<tr>\n<td><code>Warm</code></td>\n<td>Scale-down signal received (instance selected for termination)</td>\n<td><code>Draining</code></td>\n<td>Remove from warm pool; allow current request to finish but don&#39;t assign new ones</td>\n</tr>\n<tr>\n<td><code>Warm</code></td>\n<td>Health check failed</td>\n<td><code>Error</code></td>\n<td>Mark unhealthy; schedule replacement instance</td>\n</tr>\n<tr>\n<td><code>Draining</code></td>\n<td>Current request completed (if any)</td>\n<td><code>Terminated</code></td>\n<td>Call <code>StopContainer</code> and <code>RemoveContainer</code>; clean up resources</td>\n</tr>\n<tr>\n<td><code>Draining</code></td>\n<td>Draining timeout exceeded (requests taking too long)</td>\n<td><code>Error</code></td>\n<td>Force terminate container; log warning about stuck requests</td>\n</tr>\n<tr>\n<td>Any state except <code>Terminated</code></td>\n<td>System shutdown or forced termination</td>\n<td><code>Terminated</code></td>\n<td>Immediately stop container; skip graceful draining</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>Critical Design Principle:</strong> State transitions must be <strong>atomic and thread-safe</strong>. Multiple components (gateway assigning requests, health checker, scaler) may concurrently attempt to modify an instance&#39;s state. Use a state machine with proper locking or compare-and-swap operations to prevent race conditions.</p>\n</blockquote>\n<h4 id=\"container-status-mapping\">Container Status Mapping</h4>\n<p>The <code>FunctionInstanceState</code> is a higher-level abstraction than the underlying <code>ContainerStatus</code>. While they correlate, they serve different purposes:</p>\n<ul>\n<li><code>ContainerStatus</code> (e.g., <code>StatusRunning</code>, <code>StatusExited</code>) reflects the raw container runtime state</li>\n<li><code>FunctionInstanceState</code> reflects the business logic state of the instance within our serverless system</li>\n</ul>\n<p>The typical mapping is:</p>\n<ul>\n<li><code>ContainerStatus</code> = <code>StatusCreated</code> → <code>FunctionInstanceState</code> = <code>Provisioning</code></li>\n<li><code>ContainerStatus</code> = <code>StatusRunning</code> → <code>FunctionInstanceState</code> = <code>Warm</code> or <code>Active</code></li>\n<li><code>ContainerStatus</code> = <code>StatusExited</code> → <code>FunctionInstanceState</code> = <code>Terminated</code> or <code>Error</code></li>\n</ul>\n<blockquote>\n<p><strong>Key Insight:</strong> The <code>FunctionInstanceState</code> adds semantic meaning beyond the container&#39;s raw status. An instance in <code>Warm</code> state has a <code>StatusRunning</code> container, but not all <code>StatusRunning</code> containers are necessarily in <code>Warm</code> state—they could be in <code>Active</code> or <code>Draining</code>. This additional layer of abstraction allows the system to implement higher-level behaviors like warm pooling and graceful shutdown.</p>\n</blockquote>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<blockquote>\n<p><strong>Technology Note:</strong> The data model is primarily implemented through Go structs with JSON tags for serialization. We&#39;ll use the <code>time.Time</code> type for timestamps (which serializes to RFC3339 format in JSON) and pointers for optional fields (like <code>TerminatedAt</code>).</p>\n</blockquote>\n<h4 id=\"recommended-file-structure\">Recommended File Structure</h4>\n<p>Organize the data model types logically by domain:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>project-root/\n├── internal/\n│   ├── types/\n│   │   ├── function.go          # FunctionDefinition, FunctionInstance, FunctionInstanceState\n│   │   ├── invocation.go        # InvocationRequest, InvocationResponse, InvocationStatus\n│   │   ├── container.go         # Container, CreateContainerRequest, ContainerStats, ListFilter\n│   │   ├── metrics.go           # Metrics struct and constructor\n│   │   └── constants.go         # All constants (InstanceState*, ContainerStatus*, etc.)\n│   ├── container/\n│   │   └── manager.go           # ContainerManager interface and implementations\n│   └── api/\n│       └── models.go            # Request/Response structs for HTTP API (if different)\n└── pkg/\n    └── timeutil/                # Optional: time utilities for deadline calculations</code></pre></div>\n\n<h4 id=\"core-data-structure-implementation\">Core Data Structure Implementation</h4>\n<p>Here&#39;s starter code for the key data structures with proper JSON serialization:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/types/function.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> types</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// FunctionDefinition represents the immutable blueprint for a function</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> FunctionDefinition</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tName         </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">            `json:\"name\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tRuntime      </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">            `json:\"runtime\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tHandler      </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">            `json:\"handler\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tCodePath     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">            `json:\"codePath\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tTimeout      </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">               `json:\"timeout\"`</span><span style=\"color:#6A737D\">      // seconds</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tMemoryMB     </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">               `json:\"memoryMB\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tCPUQuota     </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">             `json:\"cpuQuota\"`</span><span style=\"color:#6A737D\">     // percentage of a core (100 = 1 core)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tEnvVars      </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"envVars\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tDependencies []</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">          `json:\"dependencies\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Validate checks if the FunctionDefinition has required fields</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">fd </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Validate</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Check that Name is non-empty and matches allowed pattern (e.g., no spaces)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Verify Runtime is supported (e.g., \"python3.9\", \"go1.19\", \"nodejs18\")</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Ensure Handler is non-empty</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Validate Timeout is between 1 and maximum allowed (e.g., 900 seconds)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 5: Validate MemoryMB is between minimum (e.g., 128) and maximum allowed</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 6: Verify CPUQuota is positive and within limits</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 7: Check CodePath is a valid URI format</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// FunctionInstanceState represents the lifecycle state of a FunctionInstance</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> FunctionInstanceState</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tInstanceStateProvisioning</span><span style=\"color:#B392F0\"> FunctionInstanceState</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"PROVISIONING\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tInstanceStateWarm</span><span style=\"color:#B392F0\">         FunctionInstanceState</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"WARM\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tInstanceStateActive</span><span style=\"color:#B392F0\">       FunctionInstanceState</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"ACTIVE\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tInstanceStateDraining</span><span style=\"color:#B392F0\">     FunctionInstanceState</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"DRAINING\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tInstanceStateTerminated</span><span style=\"color:#B392F0\">   FunctionInstanceState</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"TERMINATED\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tInstanceStateError</span><span style=\"color:#B392F0\">        FunctionInstanceState</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"ERROR\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// FunctionInstance represents a running instance of a function</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> FunctionInstance</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tID               </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">               `json:\"id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tFunctionName     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">               `json:\"functionName\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tFunctionVersion  </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">               `json:\"functionVersion\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tState            </span><span style=\"color:#B392F0\">FunctionInstanceState</span><span style=\"color:#9ECBFF\"> `json:\"state\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tContainerID      </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">               `json:\"containerId\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tHost             </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">               `json:\"host\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tPort             </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">                  `json:\"port\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tMemoryUsageMB    </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">                  `json:\"memoryUsageMB\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tCPUUsage         </span><span style=\"color:#F97583\">float64</span><span style=\"color:#9ECBFF\">              `json:\"cpuUsage\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tCreatedAt        </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\">            `json:\"createdAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tLastUsedAt       </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\">            `json:\"lastUsedAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tTerminatedAt     </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\">           `json:\"terminatedAt,omitempty\"`</span><span style=\"color:#6A737D\"> // Pointer for optional field</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tInvocationCount  </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">                  `json:\"invocationCount\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tTotalDurationMS  </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">                `json:\"totalDurationMs\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// IsActive returns true if the instance can accept new requests</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">fi </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FunctionInstance</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">IsActive</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Return true only if State is InstanceStateWarm</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Consider also checking that ContainerID is not empty</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Consider adding a health check timestamp to avoid routing to stale instances</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> false</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Age returns how long the instance has been running</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">fi </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FunctionInstance</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Age</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: If TerminatedAt is set, return TerminatedAt.Sub(CreatedAt)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Otherwise, return time.Since(CreatedAt)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> 0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// IdleDuration returns how long the instance has been idle</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">fi </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FunctionInstance</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">IdleDuration</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Return time.Since(LastUsedAt)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Handle edge case where LastUsedAt is zero time (never used)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> 0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/types/invocation.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> types</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// InvocationRequest represents a single function execution request</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> InvocationRequest</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tID                  </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tFunctionName        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"functionName\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tFunctionVersion     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"functionVersion,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tPayload             []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#9ECBFF\">    `json:\"payload\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tSynchronous         </span><span style=\"color:#F97583\">bool</span><span style=\"color:#9ECBFF\">      `json:\"synchronous\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tDeadline            </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"deadline\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tRequestID           </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"requestId,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tSource              </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"source,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tCreatedAt           </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"createdAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tPreferredInstanceID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"preferredInstanceId,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tCallbackURL         </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"callbackUrl,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// IsExpired returns true if the request has passed its deadline</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">ir </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">IsExpired</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Return true if time.Now().After(Deadline)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Consider adding a small grace period (e.g., 100ms) for clock skew</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> false</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TimeRemaining returns how much time is left before the deadline</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">ir </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">TimeRemaining</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Return Deadline.Sub(time.Now())</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Clamp to minimum of 0 (no negative durations)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> 0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// InvocationStatusType represents the state of an asynchronous invocation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> InvocationStatusType</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tInvocationStatusPending</span><span style=\"color:#B392F0\">   InvocationStatusType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"PENDING\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tInvocationStatusRunning</span><span style=\"color:#B392F0\">   InvocationStatusType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"RUNNING\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tInvocationStatusCompleted</span><span style=\"color:#B392F0\"> InvocationStatusType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"COMPLETED\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tInvocationStatusFailed</span><span style=\"color:#B392F0\">    InvocationStatusType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"FAILED\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tInvocationStatusTimeout</span><span style=\"color:#B392F0\">   InvocationStatusType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"TIMEOUT\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// InvocationStatus tracks the progress of an asynchronous invocation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> InvocationStatus</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tRequestID    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">                `json:\"requestId\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tStatus       </span><span style=\"color:#B392F0\">InvocationStatusType</span><span style=\"color:#9ECBFF\">  `json:\"status\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tResult       </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">InvocationResponse</span><span style=\"color:#9ECBFF\">   `json:\"result,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tLastUpdated  </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\">             `json:\"lastUpdated\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// InvocationResponse contains the result of a function execution</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> InvocationResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tRequestID      </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"requestId\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tPayload        []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#9ECBFF\">    `json:\"payload,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tDurationMS     </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">     `json:\"durationMs\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tMemoryUsedMB   </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">       `json:\"memoryUsedMb\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tBilledDurationMS </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">   `json:\"billedDurationMs\"`</span><span style=\"color:#6A737D\"> // Rounded up to nearest billing increment</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tError          </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"error,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tErrorType      </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"errorType,omitempty\"`</span><span style=\"color:#6A737D\"> // e.g., \"UserError\", \"RuntimeError\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tInstanceID     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"instanceId\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tStartedAt      </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"startedAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tFinishedAt     </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"finishedAt\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/types/constants.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> types</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ContainerStatus represents the state of a container in the container runtime</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ContainerStatus</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tStatusCreated</span><span style=\"color:#B392F0\">    ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"created\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tStatusRunning</span><span style=\"color:#B392F0\">    ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"running\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tStatusPaused</span><span style=\"color:#B392F0\">     ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"paused\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tStatusRestarting</span><span style=\"color:#B392F0\"> ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"restarting\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tStatusExited</span><span style=\"color:#B392F0\">     ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"exited\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">\tStatusDead</span><span style=\"color:#B392F0\">       ContainerStatus</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"dead\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<h4 id=\"data-model-validation-helper\">Data Model Validation Helper</h4>\n<p>Add a simple validation utility to ensure data integrity:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/types/validation.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> types</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">errors</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">net/url</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">regexp</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tErrInvalidFunctionName </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"function name must contain only alphanumeric characters and hyphens\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tErrInvalidRuntime      </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"unsupported runtime\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tErrInvalidTimeout      </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"timeout must be between 1 and 900 seconds\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tErrInvalidMemory       </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"memory must be between 128 and 10240 MB\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ValidateFunctionDefinition performs comprehensive validation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> ValidateFunctionDefinition</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">fd</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Name validation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tnameRegex </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> regexp.</span><span style=\"color:#B392F0\">MustCompile</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`^[a-zA-Z0-9\\-]+$`</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">nameRegex.</span><span style=\"color:#B392F0\">MatchString</span><span style=\"color:#E1E4E8\">(fd.Name) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> ErrInvalidFunctionName</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Runtime validation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tsupportedRuntimes </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\t\"python3.9\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\t\"go1.19\"</span><span style=\"color:#E1E4E8\">:    </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\t\"nodejs18\"</span><span style=\"color:#E1E4E8\">:  </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">supportedRuntimes[fd.Runtime] {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> ErrInvalidRuntime</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Timeout validation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> fd.Timeout </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> fd.Timeout </span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> 900</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> ErrInvalidTimeout</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Memory validation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> fd.MemoryMB </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 128</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> fd.MemoryMB </span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> 10240</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> ErrInvalidMemory</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// CodePath validation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> url.</span><span style=\"color:#B392F0\">Parse</span><span style=\"color:#E1E4E8\">(fd.CodePath); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"invalid CodePath URL\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Handler must be non-empty</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> fd.Handler </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"handler cannot be empty\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"language-specific-tips-for-go-implementation\">Language-Specific Tips for Go Implementation</h4>\n<ol>\n<li><strong>Use <code>time.Time</code> for timestamps</strong>: It serializes well to JSON (RFC3339) and has rich methods for time calculations.</li>\n<li><strong>Use pointer fields for optional values</strong>: Fields like <code>TerminatedAt *time.Time</code> will be omitted from JSON when nil.</li>\n<li><strong>Validate early</strong>: Implement <code>Validate()</code> methods and call them before persisting or using data structures.</li>\n<li><strong>Make state transitions atomic</strong>: Use <code>sync.Mutex</code> or <code>sync.RWMutex</code> in the struct that manages <code>FunctionInstance</code> states to prevent race conditions.</li>\n<li><strong>Consider using UUIDs for IDs</strong>: Use <code>github.com/google/uuid</code> to generate unique identifiers that are globally unique and not guessable.</li>\n</ol>\n<h4 id=\"milestone-checkpoint-data-model-validation\">Milestone Checkpoint: Data Model Validation</h4>\n<p>After implementing the data structures, verify they work correctly:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Run unit tests for the types package</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./internal/types/...</span><span style=\"color:#79B8FF\"> -v</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected output should show tests passing for:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># - FunctionDefinition validation (valid and invalid cases)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># - FunctionInstance state methods (IsActive, Age, IdleDuration)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># - InvocationRequest deadline methods (IsExpired, TimeRemaining)</span></span></code></pre></div>\n\n<p>Create a simple test to verify serialization:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/types/function_test.go (example test)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestFunctionDefinition_JSONRoundTrip</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tfd </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tName:     </span><span style=\"color:#9ECBFF\">\"test-function\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tRuntime:  </span><span style=\"color:#9ECBFF\">\"python3.9\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tHandler:  </span><span style=\"color:#9ECBFF\">\"handler.main\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tCodePath: </span><span style=\"color:#9ECBFF\">\"s3://bucket/test-v1.zip\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tTimeout:  </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tMemoryMB: </span><span style=\"color:#79B8FF\">256</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tCPUQuota: </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tEnvVars:  </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"KEY\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"VALUE\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Marshal to JSON</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tjsonData, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(fd)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tassert.</span><span style=\"color:#B392F0\">NoError</span><span style=\"color:#E1E4E8\">(t, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Unmarshal back</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tvar</span><span style=\"color:#E1E4E8\"> fd2 </span><span style=\"color:#B392F0\">FunctionDefinition</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\terr </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(jsonData, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">fd2)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tassert.</span><span style=\"color:#B392F0\">NoError</span><span style=\"color:#E1E4E8\">(t, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Should be equal</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tassert.</span><span style=\"color:#B392F0\">Equal</span><span style=\"color:#E1E4E8\">(t, fd.Name, fd2.Name)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tassert.</span><span style=\"color:#B392F0\">Equal</span><span style=\"color:#E1E4E8\">(t, fd.Runtime, fd2.Runtime)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n\n<h2 id=\"component-design-function-packaging\">Component Design: Function Packaging</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 1</p>\n</blockquote>\n<h3 id=\"mental-model-the-shipping-dock-and-warehouse\">Mental Model: The Shipping Dock and Warehouse</h3>\n<p>Imagine you&#39;re managing a massive shipping facility where customers send you boxes of parts and instructions to assemble specialized machines. Each customer&#39;s box contains the blueprints (source code), a list of required components (dependencies), and assembly instructions (build configuration). Your job is to:</p>\n<ol>\n<li><strong>Receive shipments</strong> at the dock (upload API)</li>\n<li><strong>Inspect and validate</strong> the contents (package validation)</li>\n<li><strong>Assemble complete machines</strong> by gathering all required parts (dependency resolution)</li>\n<li><strong>Test the assembly</strong> to ensure it works (build validation)</li>\n<li><strong>Store finished machines</strong> in labeled warehouse bins with unique serial numbers (content-addressable storage)</li>\n<li><strong>Track revisions</strong> so you can always retrieve the exact same machine later (immutable versioning)</li>\n</ol>\n<p>Just as a warehouse worker doesn&#39;t need to know how to operate every machine, the runtime doesn&#39;t need to understand the function&#39;s internal logic—it just needs to retrieve the pre-assembled package and plug it into an execution environment. This separation of concerns allows the packaging subsystem to focus on reliable, reproducible builds while the execution subsystem focuses on fast, secure runtime.</p>\n<p>The critical insight is that <strong>packaging happens once per deployment, but execution happens thousands or millions of times</strong>. Therefore, we invest more computational resources during packaging (thorough dependency resolution, optimization, validation) to make execution as lightweight and predictable as possible.</p>\n<h3 id=\"interface-and-workflow\">Interface and Workflow</h3>\n<p>The packaging subsystem exposes two primary interfaces: an external HTTP API for users to upload functions, and internal interfaces for language-specific bundlers to process those functions.</p>\n<h4 id=\"external-api-function-upload-and-management\">External API: Function Upload and Management</h4>\n<p>Users interact with the packaging system through a RESTful HTTP API that supports:</p>\n<table>\n<thead>\n<tr>\n<th>Endpoint</th>\n<th>Method</th>\n<th>Request Body</th>\n<th>Response</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>/v1/functions</code></td>\n<td><code>POST</code></td>\n<td>Multipart form with code archive, <code>function.yaml</code></td>\n<td><code>201 Created</code> with <code>{&quot;function_id&quot;: &quot;...&quot;, &quot;version&quot;: &quot;...&quot;}</code></td>\n<td>Upload new function version</td>\n</tr>\n<tr>\n<td><code>/v1/functions/{name}/versions</code></td>\n<td><code>GET</code></td>\n<td>None</td>\n<td><code>200 OK</code> with list of versions</td>\n<td>List all versions of a function</td>\n</tr>\n<tr>\n<td><code>/v1/functions/{name}/versions/{version}</code></td>\n<td><code>GET</code></td>\n<td>None</td>\n<td><code>200 OK</code> with function metadata</td>\n<td>Get specific version details</td>\n</tr>\n<tr>\n<td><code>/v1/functions/{name}/versions/{version}</code></td>\n<td><code>DELETE</code></td>\n<td>None</td>\n<td><code>204 No Content</code></td>\n<td>Delete specific version (if not in use)</td>\n</tr>\n</tbody></table>\n<p>The <code>function.yaml</code> configuration file follows this schema:</p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Required</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>name</code></td>\n<td>string</td>\n<td>Yes</td>\n<td>Unique function name (slug format: <code>[a-z0-9-]+</code>)</td>\n</tr>\n<tr>\n<td><code>runtime</code></td>\n<td>string</td>\n<td>Yes</td>\n<td>One of: <code>go1.x</code>, <code>python3.9</code>, <code>nodejs18.x</code>, <code>java11</code></td>\n</tr>\n<tr>\n<td><code>handler</code></td>\n<td>string</td>\n<td>Yes</td>\n<td>Entry point format varies by runtime:<br>- Go: <code>package.FunctionName</code><br>- Python: <code>module.function</code><br>- Node.js: <code>module.exportName</code><br>- Java: <code>com.example.Handler::handleRequest</code></td>\n</tr>\n<tr>\n<td><code>timeout</code></td>\n<td>integer</td>\n<td>No</td>\n<td>Maximum execution time in seconds (default: 30)</td>\n</tr>\n<tr>\n<td><code>memory</code></td>\n<td>integer</td>\n<td>No</td>\n<td>Memory allocation in MB (default: 128)</td>\n</tr>\n<tr>\n<td><code>environment</code></td>\n<td>map[string]string</td>\n<td>No</td>\n<td>Environment variables injected at runtime</td>\n</tr>\n<tr>\n<td><code>dependencies</code></td>\n<td>array of strings</td>\n<td>No</td>\n<td>Language-specific dependency specifiers</td>\n</tr>\n</tbody></table>\n<h4 id=\"internal-workflow-from-upload-to-stored-artifact\">Internal Workflow: From Upload to Stored Artifact</h4>\n<p>When a function upload request arrives, the system executes this 10-step workflow:</p>\n<ol>\n<li><strong>Request Validation</strong>: Verify the multipart form contains both <code>function.yaml</code> and at least one code file (ZIP, TAR, or single file).</li>\n<li><strong>Configuration Parsing</strong>: Parse <code>function.yaml</code> into a <code>FunctionDefinition</code> struct, validating all required fields and runtime compatibility.</li>\n<li><strong>Temporary Storage</strong>: Extract uploaded files to a temporary working directory with a unique session ID.</li>\n<li><strong>Language Detection</strong>: Based on the <code>runtime</code> field, route to the appropriate language bundler.</li>\n<li><strong>Dependency Resolution</strong>: The language bundler analyzes the code to identify all required dependencies:<ul>\n<li>For interpreted languages (Python, Node.js): Parse dependency manifests (<code>requirements.txt</code>, <code>package.json</code>) and resolve transitive dependencies, handling version conflicts.</li>\n<li>For compiled languages (Go, Java): Compile the code, capturing all imported packages and libraries.</li>\n</ul>\n</li>\n<li><strong>Build Process</strong>: Create a complete, self-contained artifact:<ul>\n<li><strong>Python</strong>: Create a virtual environment with all dependencies, then package into a ZIP with the function code.</li>\n<li><strong>Node.js</strong>: Run <code>npm install --production</code> and bundle into a single directory.</li>\n<li><strong>Go</strong>: Compile to a standalone binary for the target architecture.</li>\n<li><strong>Java</strong>: Compile to a JAR with all dependencies shaded/fat-jarred.</li>\n</ul>\n</li>\n<li><strong>Artifact Optimization</strong>: Apply optimizations to reduce package size:<ul>\n<li>Remove development dependencies, documentation, test files.</li>\n<li>Compress resources (minify JavaScript, strip debug symbols from binaries).</li>\n<li>Deduplicate common dependencies across functions (layer sharing).</li>\n</ul>\n</li>\n<li><strong>Integrity Check</strong>: Compute SHA-256 hash of the final artifact for content addressing.</li>\n<li><strong>Storage</strong>: Store the artifact in the content-addressable storage backend using the hash as the key.</li>\n<li><strong>Metadata Registration</strong>: Record the function version metadata in the registry, linking the function name and version to the storage hash.</li>\n</ol>\n<h4 id=\"internal-interfaces-for-language-bundlers\">Internal Interfaces for Language Bundlers</h4>\n<p>The packaging subsystem defines this interface for language-specific implementations:</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>ResolveDependencies</code></td>\n<td><code>ctx context.Context, workDir string, deps []string</code></td>\n<td><code>([]string, error)</code></td>\n<td>Analyze code and return complete dependency list</td>\n</tr>\n<tr>\n<td><code>BuildArtifact</code></td>\n<td><code>ctx context.Context, workDir string, def FunctionDefinition</code></td>\n<td><code>(string, error)</code></td>\n<td>Build self-contained artifact, return path</td>\n</tr>\n<tr>\n<td><code>ValidateHandler</code></td>\n<td><code>ctx context.Context, workDir string, def FunctionDefinition</code></td>\n<td><code>error</code></td>\n<td>Verify handler exists and is callable</td>\n</tr>\n<tr>\n<td><code>GetBaseImage</code></td>\n<td><code>runtime string</code></td>\n<td><code>string</code></td>\n<td>Return container image name for this runtime</td>\n</tr>\n</tbody></table>\n<p>Each language runtime (Go, Python, Node.js, Java) provides its own implementation of this interface. The packaging coordinator calls these methods in sequence, handling errors and cleanup between steps.</p>\n<h3 id=\"adr-artifact-storage-strategy\">ADR: Artifact Storage Strategy</h3>\n<blockquote>\n<p><strong>Decision: Use Content-Addressable Storage with Registry Index</strong></p>\n<p><strong>Context</strong>: We need to store function artifacts durably and retrieve them efficiently. Artifacts range from small (Go binaries ~5MB) to large (Java applications with dependencies ~100MB+). We must support:</p>\n<ul>\n<li>Immutable versioning (once stored, never modified)</li>\n<li>Efficient deduplication (identical dependencies across functions)</li>\n<li>Fast retrieval by both content hash and function name/version</li>\n<li>Scalability to thousands of functions with multiple versions each</li>\n</ul>\n<p><strong>Options Considered</strong>:</p>\n<ol>\n<li><strong>Object Storage with Hierarchical Keys</strong> (e.g., S3 with <code>{function}/{version}/artifact.zip</code>)</li>\n<li><strong>Content-Addressable Storage</strong> (e.g., store by SHA-256 hash, maintain separate index)</li>\n<li><strong>Container Registry</strong> (e.g., Docker registry, store as OCI images)</li>\n</ol>\n<p><strong>Decision</strong>: Use content-addressable storage (option 2) with a separate registry database indexing function names and versions to content hashes.</p>\n<p><strong>Rationale</strong>:</p>\n<ul>\n<li><strong>Deduplication</strong>: Identical artifacts (common dependencies, same code) automatically deduplicate because they have the same hash. This saves significant storage for common runtimes and libraries.</li>\n<li><strong>Immutability</strong>: Content addressing guarantees immutability—the hash is the content&#39;s fingerprint. Any tampering changes the hash, making detection trivial.</li>\n<li><strong>Cache Efficiency</strong>: CDNs and caching layers can use the hash as a perfect cache key. Two functions with identical dependencies can share cached layers.</li>\n<li><strong>Simplified Garbage Collection</strong>: We can implement reference counting on hashes—delete artifacts only when no function version references them.</li>\n<li><strong>Flexibility</strong>: We can store artifacts in any backing store (S3, filesystem, IPFS) since the abstraction depends only on hash-based retrieval.</li>\n</ul>\n<p><strong>Consequences</strong>:</p>\n<ul>\n<li><strong>Added Complexity</strong>: Need a separate registry database to map <code>(function, version) → hash</code>. Two-phase writes (store artifact, then update registry).</li>\n<li><strong>Slower Lookup</strong>: To get an artifact by function name, we must first query the registry for the hash, then fetch by hash (two operations).</li>\n<li><strong>No Native Versioning</strong>: The storage layer doesn&#39;t understand semantic versioning—that&#39;s managed by the registry.</li>\n</ul>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Option</th>\n<th>Pros</th>\n<th>Cons</th>\n<th>Why Not Chosen</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Object Storage with Hierarchical Keys</td>\n<td>Simple, direct mapping, S3 versioning available</td>\n<td>No automatic deduplication, harder cache optimization, mutable without proper discipline</td>\n<td>Lacks automatic deduplication which is critical for common dependencies like AWS SDK</td>\n</tr>\n<tr>\n<td><strong>Content-Addressable Storage</strong></td>\n<td><strong>Automatic deduplication, immutable by design, cache-friendly, storage-agnostic</strong></td>\n<td><strong>Requires separate index, two-step retrieval</strong></td>\n<td><strong>Chosen for deduplication and immutability benefits</strong></td>\n</tr>\n<tr>\n<td>Container Registry (OCI)</td>\n<td>Standard format, tooling ecosystem, layer sharing</td>\n<td>Heavyweight for simple functions, complex to implement, overkill for non-container execution</td>\n<td>Too complex for our needs; we&#39;re not running containers directly but might use them as base images</td>\n</tr>\n</tbody></table>\n<h3 id=\"common-pitfalls-in-function-packaging\">Common Pitfalls in Function Packaging</h3>\n<p>⚠️ <strong>Pitfall: Dependency Hell and Version Conflicts</strong></p>\n<p><strong>Description</strong>: When function A requires <code>library-v1.2</code> and function B requires <code>library-v2.0</code>, but they share a common base environment, one function will break. Transitive dependencies compound this—<code>library-v1.2</code> might require <code>dep-alpha-v3.0</code> while <code>library-v2.0</code> requires <code>dep-alpha-v4.0</code>, which are incompatible.</p>\n<p><strong>Why It&#39;s Wrong</strong>: This causes non-deterministic behavior. A function that works during packaging might fail at runtime if a different function&#39;s deployment changes the shared environment. It violates the principle of isolation between functions.</p>\n<p><strong>How to Fix</strong>: </p>\n<ul>\n<li>Use <strong>per-function virtual environments</strong> (Python), <code>node_modules</code> isolation (Node.js), or shaded JARs (Java).</li>\n<li>For compiled languages (Go), statically link dependencies into the binary.</li>\n<li>Never share mutable dependency directories between functions.</li>\n<li>Implement <strong>dependency conflict detection</strong> during packaging—fail the build if incompatible transitive dependencies are detected.</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Bloated Packages from Development Artifacts</strong></p>\n<p><strong>Description</strong>: Including <code>node_modules</code> with dev dependencies, Python virtual environments with <code>.pyc</code> files, Java JARs with source code and documentation, or Go binaries with debug symbols. A simple 50-line function can become a 300MB package.</p>\n<p><strong>Why It&#39;s Wrong</strong>: Large packages increase cold start time (more data to transfer), consume more storage, and waste memory. They also expose potentially sensitive information (source code, comments, debug symbols).</p>\n<p><strong>How to Fix</strong>:</p>\n<ul>\n<li>Implement <strong>production-only packaging</strong>: Exclude dev dependencies, documentation, tests, examples.</li>\n<li>Apply <strong>aggressive compression</strong>: Use ZIP with maximum compression, strip debug symbols from binaries.</li>\n<li><strong>Deduplicate common layers</strong>: Store common runtime dependencies (like AWS SDK) as shared layers that can be mounted read-only.</li>\n<li>Set <strong>maximum package size limits</strong> (e.g., 250MB) and reject oversized packages.</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Improper or Missing Versioning</strong></p>\n<p><strong>Description</strong>: Using mutable tags like <code>latest</code>, auto-incrementing version numbers without consistency, or allowing package modification after upload.</p>\n<p><strong>Why It&#39;s Wrong</strong>: Breaks reproducibility and rollback capabilities. If a function starts failing, you cannot reliably revert to the previous working version. Also prevents deterministic deployments across environments (dev, staging, prod).</p>\n<p><strong>How to Fix</strong>:</p>\n<ul>\n<li>Use <strong>immutable, content-based versioning</strong>: The artifact hash (SHA-256) becomes part of the version identifier.</li>\n<li>Support <strong>semantic versioning</strong> as user-friendly aliases: <code>myfunction:v1.2.3</code> points to hash <code>abc123...</code>.</li>\n<li>Implement <strong>version immutability guarantee</strong>: Once stored, an artifact cannot be modified or deleted while referenced.</li>\n<li>Maintain <strong>version lineage</strong>: Track which version succeeded which, enabling rollback graphs.</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Incomplete Validation Leading to Runtime Failures</strong></p>\n<p><strong>Description</strong>: Only validating the package structure but not testing if the function actually works. The handler might not exist, dependencies might be missing at runtime, or the function signature might be wrong.</p>\n<p><strong>Why It&#39;s Wrong</strong>: Defers discovery of problems until invocation time, which is worse for users (harder to debug) and the system (wastes resources provisioning environments for broken functions).</p>\n<p><strong>How to Fix</strong>:</p>\n<ul>\n<li><strong>Validate handler existence</strong>: For interpreted languages, parse the code to ensure the handler module/function exists.</li>\n<li><strong>Test compilation</strong>: For compiled languages, actually compile the code during packaging.</li>\n<li><strong>Optional smoke test</strong>: Provide a flag to run a test invocation during packaging with a sample payload.</li>\n<li><strong>Runtime compatibility check</strong>: Verify the function works with the specific runtime version (Python 3.9 vs 3.10 differences).</li>\n</ul>\n<h3 id=\"implementation-guidance-for-packaging\">Implementation Guidance for Packaging</h3>\n<h4 id=\"technology-recommendations\">Technology Recommendations</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Upload API</td>\n<td>HTTP multipart form with <code>net/http</code></td>\n<td>gRPC with chunked streaming for large packages</td>\n</tr>\n<tr>\n<td>Dependency Resolution</td>\n<td>Language-native tools (<code>go mod</code>, <code>npm</code>, <code>pip</code>)</td>\n<td>Custom resolver with vulnerability scanning</td>\n</tr>\n<tr>\n<td>Artifact Storage</td>\n<td>Local filesystem with hash-based directories</td>\n<td>S3/MinIO with content addressing</td>\n</tr>\n<tr>\n<td>Registry Database</td>\n<td>SQLite (embedded)</td>\n<td>PostgreSQL with connection pooling</td>\n</tr>\n<tr>\n<td>Build Environment</td>\n<td>Local OS with language runtimes installed</td>\n<td>Docker containers for hermetic builds</td>\n</tr>\n</tbody></table>\n<h4 id=\"recommended-filemodule-structure\">Recommended File/Module Structure</h4>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>serverless-runtime/\n├── cmd/\n│   ├── packaging-server/          # Standalone packaging service\n│   │   └── main.go\n│   └── gateway/                   # Main gateway (includes packaging routes)\n│       └── main.go\n├── internal/\n│   ├── packaging/\n│   │   ├── api/                   # HTTP/API handlers\n│   │   │   ├── upload.go\n│   │   │   ├── versions.go\n│   │   │   └── middleware.go\n│   │   ├── bundler/               # Language-specific bundlers\n│   │   │   ├── interface.go\n│   │   │   ├── go_bundler.go\n│   │   │   ├── python_bundler.go\n│   │   │   ├── nodejs_bundler.go\n│   │   │   └── java_bundler.go\n│   │   ├── registry/              # Function version registry\n│   │   │   ├── registry.go\n│   │   │   ├── sqlite_store.go\n│   │   │   └── postgres_store.go\n│   │   ├── storage/               # Artifact storage backends\n│   │   │   ├── interface.go\n│   │   │   ├── filesystem_store.go\n│   │   │   └── s3_store.go\n│   │   ├── types/                 # Packaging-specific types\n│   │   │   ├── function_def.go\n│   │   │   └── artifact.go\n│   │   └── coordinator.go         # Orchestrates the packaging workflow\n│   └── function/                  # Shared function types (from Data Model)\n│       └── types.go\n└── pkg/\n    └── compression/               # Reusable compression utilities\n        ├── zip.go\n        └── tar.go</code></pre></div>\n\n<h4 id=\"infrastructure-starter-code-upload-api-handler\">Infrastructure Starter Code: Upload API Handler</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/packaging/api/upload.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> api</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">crypto/sha256</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">encoding/hex</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">io</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">mime/multipart</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">path/filepath</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/your-org/serverless-runtime/internal/packaging</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/your-org/serverless-runtime/internal/packaging/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// UploadHandler handles multipart form uploads for function packages</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> UploadHandler</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    coordinator </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">packaging</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Coordinator</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    maxUploadMB </span><span style=\"color:#F97583\">int64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    tempDir     </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewUploadHandler creates a new upload handler with configuration</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewUploadHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">coordinator</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">packaging</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Coordinator</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">maxUploadMB</span><span style=\"color:#F97583\"> int64</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">UploadHandler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">UploadHandler</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        coordinator: coordinator,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        maxUploadMB: maxUploadMB,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        tempDir:     os.</span><span style=\"color:#B392F0\">TempDir</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ServeHTTP implements http.Handler</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">UploadHandler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 1. Limit request size</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    r.Body </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">MaxBytesReader</span><span style=\"color:#E1E4E8\">(w, r.Body, h.maxUploadMB</span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\">1024</span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\">1024</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 2. Parse multipart form</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> r.</span><span style=\"color:#B392F0\">ParseMultipartForm</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\"> &#x3C;&#x3C;</span><span style=\"color:#79B8FF\"> 20</span><span style=\"color:#E1E4E8\">); </span><span style=\"color:#6A737D\">// 10MB in memory, rest on disk</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#9ECBFF\">\"Failed to parse multipart form: \"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">err.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(), http.StatusBadRequest)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 3. Extract function.yaml</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    funcFile, funcHeader, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> r.</span><span style=\"color:#B392F0\">FormFile</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"function.yaml\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#9ECBFF\">\"Missing required file: function.yaml\"</span><span style=\"color:#E1E4E8\">, http.StatusBadRequest)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> funcFile.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 4. Extract code archive</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    codeFile, codeHeader, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> r.</span><span style=\"color:#B392F0\">FormFile</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"code\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#9ECBFF\">\"Missing required file: code\"</span><span style=\"color:#E1E4E8\">, http.StatusBadRequest)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> codeFile.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 5. Create temporary workspace</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    workspace, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">createWorkspace</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#9ECBFF\">\"Failed to create workspace: \"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">err.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(), http.StatusInternalServerError)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">RemoveAll</span><span style=\"color:#E1E4E8\">(workspace) </span><span style=\"color:#6A737D\">// Cleanup</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 6. Save uploaded files to workspace</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    funcDefPath, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">saveUploadedFile</span><span style=\"color:#E1E4E8\">(funcFile, funcHeader, workspace, </span><span style=\"color:#9ECBFF\">\"function.yaml\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#9ECBFF\">\"Failed to save function definition: \"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">err.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(), http.StatusInternalServerError)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    codePath, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">saveUploadedFile</span><span style=\"color:#E1E4E8\">(codeFile, codeHeader, workspace, </span><span style=\"color:#9ECBFF\">\"code\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#9ECBFF\">\"Failed to save code: \"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">err.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(), http.StatusInternalServerError)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 7. Parse and validate function definition</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    funcDef, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">parseFunctionDefinition</span><span style=\"color:#E1E4E8\">(funcDefPath)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#9ECBFF\">\"Invalid function definition: \"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">err.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(), http.StatusBadRequest)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 8. Extract code archive if it's a ZIP/TAR</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">extractArchive</span><span style=\"color:#E1E4E8\">(codePath, workspace); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#9ECBFF\">\"Failed to extract code archive: \"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">err.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(), http.StatusBadRequest)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 9. Process through coordinator</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ctx, cancel </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithTimeout</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#79B8FF\">5</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Minute)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#B392F0\"> cancel</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    result, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.coordinator.</span><span style=\"color:#B392F0\">ProcessUpload</span><span style=\"color:#E1E4E8\">(ctx, funcDef, workspace)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#9ECBFF\">\"Packaging failed: \"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">err.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(), http.StatusInternalServerError)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 10. Return success response</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(http.StatusCreated)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    fmt.</span><span style=\"color:#B392F0\">Fprintf</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#9ECBFF\">`{\"function_id\": \"</span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">\", \"version\": \"</span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">\", \"artifact_hash\": \"</span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">\"}`</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        result.FunctionName, result.Version, result.ArtifactHash)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Helper method to create unique workspace directory</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">UploadHandler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">createWorkspace</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    dir </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> filepath.</span><span style=\"color:#B392F0\">Join</span><span style=\"color:#E1E4E8\">(h.tempDir, fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"func-pkg-</span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">UnixNano</span><span style=\"color:#E1E4E8\">()))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">MkdirAll</span><span style=\"color:#E1E4E8\">(dir, </span><span style=\"color:#79B8FF\">0755</span><span style=\"color:#E1E4E8\">); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"mkdir failed: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> dir, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Helper method to save uploaded file</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">UploadHandler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">saveUploadedFile</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">file</span><span style=\"color:#B392F0\"> multipart</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">File</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">header</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">multipart</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FileHeader</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">workspace</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">destName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    destPath </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> filepath.</span><span style=\"color:#B392F0\">Join</span><span style=\"color:#E1E4E8\">(workspace, destName)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    dest, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">Create</span><span style=\"color:#E1E4E8\">(destPath)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"create file failed: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> dest.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> io.</span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">(dest, file); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"copy failed: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> destPath, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Helper method to compute file hash</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> computeFileHash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">path</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    f, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">Open</span><span style=\"color:#E1E4E8\">(path)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\">, err</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> f.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    hasher </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> sha256.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> io.</span><span style=\"color:#B392F0\">Copy</span><span style=\"color:#E1E4E8\">(hasher, f); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\">, err</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> hex.</span><span style=\"color:#B392F0\">EncodeToString</span><span style=\"color:#E1E4E8\">(hasher.</span><span style=\"color:#B392F0\">Sum</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)), </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"core-logic-skeleton-packaging-coordinator\">Core Logic Skeleton: Packaging Coordinator</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/packaging/coordinator.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> packaging</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">path/filepath</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/your-org/serverless-runtime/internal/packaging/bundler</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/your-org/serverless-runtime/internal/packaging/registry</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/your-org/serverless-runtime/internal/packaging/storage</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/your-org/serverless-runtime/internal/packaging/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Coordinator orchestrates the packaging workflow</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Coordinator</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    registry    </span><span style=\"color:#B392F0\">registry</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Registry</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    storage     </span><span style=\"color:#B392F0\">storage</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ArtifactStorage</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    bundlers    </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#B392F0\">bundler</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Bundler</span><span style=\"color:#6A737D\"> // keyed by runtime</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    workspaceDir </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ProcessUploadResult contains results of a successful packaging operation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ProcessUploadResult</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    FunctionName  </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Version       </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ArtifactHash  </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ArtifactSize  </span><span style=\"color:#F97583\">int64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Dependencies  []</span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ProcessUpload executes the complete packaging workflow</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">c </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Coordinator</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ProcessUpload</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">def</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">sourceDir</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">ProcessUploadResult</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Validate the FunctionDefinition (check required fields, runtime support)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Use def.Validate() method</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Select appropriate bundler based on def.Runtime</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Look up in c.bundlers map, return error if runtime not supported</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Validate the handler exists in source code</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Call bundler.ValidateHandler(ctx, sourceDir, def)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Resolve dependencies</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Call bundler.ResolveDependencies(ctx, sourceDir, def.Dependencies)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Store the complete dependency list for metadata</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Create temporary build directory</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Use os.MkdirTemp with c.workspaceDir as parent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Build artifact</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Call bundler.BuildArtifact(ctx, sourceDir, def)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // The bundler returns path to the built artifact file</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 7: Compute artifact hash (SHA-256)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Read the artifact file and compute hash using sha256.Sum256</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Convert to hex string for storage key</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 8: Check if artifact already exists in storage (deduplication)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Call c.storage.Exists(ctx, hash)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // If exists, skip to step 10</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 9: Store artifact in content-addressable storage</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Call c.storage.Store(ctx, hash, artifactPath)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Get artifact size for metadata</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 10: Register function version in registry</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Create registry.FunctionVersion record with:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // - FunctionName: def.Name</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // - Version: generateVersion(def, hash) </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // - ArtifactHash: hash</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // - Metadata: size, dependencies, creation time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 11: Clean up temporary build directory</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: os.RemoveAll on build directory</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 12: Return ProcessUploadResult with all metadata</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not implemented\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GetBundler returns the bundler for a runtime</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">c </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Coordinator</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetBundler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">runtime</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">bundler</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Bundler</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b, ok </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> c.bundlers[runtime]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">ok {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"unsupported runtime: </span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, runtime)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> b, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// generateVersion creates a version identifier from function definition and hash</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> generateVersion</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">def</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">hash</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Use short hash (first 12 chars) for readability</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    shortHash </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> hash[:</span><span style=\"color:#79B8FF\">12</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">-</span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, def.Name, shortHash)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"core-logic-skeleton-go-language-bundler\">Core Logic Skeleton: Go Language Bundler</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/packaging/bundler/go_bundler.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> bundler</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os/exec</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">path/filepath</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">strings</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/your-org/serverless-runtime/internal/packaging/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GoBundler implements Bundler interface for Go functions</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> GoBundler</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    goPath      </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // Path to go binary</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    buildTarget </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // Target OS/architecture, e.g., \"linux/amd64\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewGoBundler creates a new Go bundler</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewGoBundler</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">GoBundler</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    goPath, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> exec.</span><span style=\"color:#B392F0\">LookPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"go\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"go not found in PATH: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">GoBundler</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        goPath:      goPath,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        buildTarget: </span><span style=\"color:#9ECBFF\">\"linux/amd64\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// Standard serverless target</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ResolveDependencies resolves Go dependencies using go mod</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">b </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">GoBundler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ResolveDependencies</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">workDir</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">deps</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Check if go.mod exists in workDir</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Use os.Stat on filepath.Join(workDir, \"go.mod\")</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // If not exists, create a minimal go.mod with module name</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Run 'go mod tidy' to ensure go.mod and go.sync are consistent</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Use exec.CommandContext with b.goPath, \"mod\", \"tidy\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Set Dir to workDir, capture output</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: If deps provided, add them to go.mod</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: For each dep in deps, run 'go get &#x3C;dep>'</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Run 'go list -m all' to get complete dependency list</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Parse output to get all module paths and versions</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Return list of dependencies in format \"module@version\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{}, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not implemented\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// BuildArtifact builds a standalone Go binary</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">b </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">GoBundler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">BuildArtifact</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">workDir</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">def</span><span style=\"color:#B392F0\"> types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Parse handler to extract package and function name</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Go handlers format: \"package.FunctionName\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Split on last \".\" - everything before is import path, after is function</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Create temporary output directory for the binary</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: os.MkdirTemp</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Build command: go build -o &#x3C;output> &#x3C;build flags></span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Required flags:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // - -ldflags=\"-s -w\" // Strip debug symbols</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // - -trimpath        // Remove file system paths</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // - GOOS=linux, GOARCH=amd64 environment variables</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Execute build command</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Use exec.CommandContext, set Dir to workDir</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Capture stdout/stderr for error reporting</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Verify binary was created and is executable</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: os.Stat on output path, check file mode</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Return path to built binary</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not implemented\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ValidateHandler verifies the handler exists in Go code</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">b </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">GoBundler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ValidateHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">workDir</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">def</span><span style=\"color:#B392F0\"> types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Parse handler string format: \"package.FunctionName\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: strings.Split for last \".\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Check if package directory exists in workDir</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // For relative packages (starting with \"./\"), check relative to workDir</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // For absolute packages, they should be in GOPATH/module cache</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Use 'go list' to verify function exists in package</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Command: go list -f '{{.Name}} {{.Doc}}' &#x3C;package></span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Parse output to find function</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Check function signature matches expected handler format</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Serverless Go handlers should be: func Handler(ctx context.Context, payload []byte) ([]byte, error)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // We can't fully validate without compilation, but we can check via go/ast parsing</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Simple approach: grep for function definition in source files</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not implemented\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GetBaseImage returns container image for Go runtime</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">b </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">GoBundler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetBaseImage</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">runtime</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Use lightweight Alpine-based image for Go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#9ECBFF\"> \"golang:alpine\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"language-specific-hints-for-go-implementation\">Language-Specific Hints for Go Implementation</h4>\n<ul>\n<li><strong>Dependency Management</strong>: Use <code>go mod</code> commands programmatically via <code>exec.Command</code>. Set <code>GOPROXY=direct</code> to avoid proxy caching during builds.</li>\n<li><strong>Cross-Compilation</strong>: Set <code>GOOS=linux</code> and <code>GOARCH=amd64</code> environment variables when building for the serverless environment.</li>\n<li><strong>Binary Optimization</strong>: Use <code>-ldflags=&quot;-s -w&quot;</code> to strip debug symbols and reduce binary size by 20-30%.</li>\n<li><strong>Handler Validation</strong>: For thorough validation, use the <code>go/ast</code> package to parse source files and verify function signatures match <code>func(context.Context, []byte) ([]byte, error)</code>.</li>\n<li><strong>Temporary Files</strong>: Use <code>os.MkdirTemp</code> with cleanup deferred. For large builds, ensure adequate disk space in the temporary directory.</li>\n</ul>\n<h4 id=\"milestone-checkpoint-verifying-function-packaging\">Milestone Checkpoint: Verifying Function Packaging</h4>\n<p>After implementing the packaging subsystem, verify it works:</p>\n<ol>\n<li><strong>Start the packaging server</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">   go</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#9ECBFF\"> cmd/packaging-server/main.go</span><span style=\"color:#79B8FF\"> --port</span><span style=\"color:#79B8FF\"> 8080</span><span style=\"color:#79B8FF\"> --storage-dir</span><span style=\"color:#9ECBFF\"> /tmp/func-storage</span></span></code></pre></div>\n\n<ol start=\"2\">\n<li><strong>Create a test function</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">   mkdir</span><span style=\"color:#9ECBFF\"> test-function</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   cat</span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> test-function/function.yaml</span><span style=\"color:#F97583\"> &#x3C;&#x3C;</span><span style=\"color:#9ECBFF\"> 'EOF'</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   name: hello-world</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   runtime: go1.x</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   handler: main.Handler</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   timeout: 30</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   memory: 128</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   EOF</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   cat > test-function/main.go &#x3C;&#x3C; 'EOF'</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   package main</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   import (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">       \"context\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">       \"fmt\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   )</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   func Handler(ctx context.Context, input []byte) ([]byte, error) {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">       return []byte(fmt.Sprintf(\"Hello, %s!\", string(input))), nil</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   }</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   EOF</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   cat > test-function/go.mod &#x3C;&#x3C; 'EOF'</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   module example.com/hello</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   go 1.21</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">   EOF</span></span></code></pre></div>\n\n<ol start=\"3\">\n<li><strong>Package the function</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">   curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/v1/functions</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -F</span><span style=\"color:#9ECBFF\"> \"function.yaml=@test-function/function.yaml\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -F</span><span style=\"color:#9ECBFF\"> \"code=@test-function/main.go\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -F</span><span style=\"color:#9ECBFF\"> \"code=@test-function/go.mod\"</span></span></code></pre></div>\n<p>   <strong>Expected Response</strong>:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">json</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">   {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     \"function_id\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"hello-world\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     \"version\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"hello-world-a1b2c3d4e5f6\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     \"artifact_hash\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"a1b2c3d4e5f67890...\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     \"artifact_size\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">2850367</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   }</span></span></code></pre></div>\n\n<ol start=\"4\">\n<li><strong>Verify artifact storage</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">   # Check artifact exists in storage</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   ls</span><span style=\"color:#79B8FF\"> -la</span><span style=\"color:#9ECBFF\"> /tmp/func-storage/artifacts/a1/b2/c3/</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">   # List function versions</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   curl</span><span style=\"color:#9ECBFF\"> http://localhost:8080/v1/functions/hello-world/versions</span></span></code></pre></div>\n\n<ol start=\"5\">\n<li><p><strong>Signs of Correct Implementation</strong>:</p>\n<ul>\n<li>Artifact file exists at hash-based path</li>\n<li>Binary is Linux executable (<code>file</code> shows &quot;ELF 64-bit LSB executable&quot;)</li>\n<li>Binary is stripped (no debug symbols, reduced size)</li>\n<li>Registry shows the function version with correct metadata</li>\n<li>Re-uploading identical code returns same hash (deduplication works)</li>\n</ul>\n</li>\n<li><p><strong>Common Issues and Fixes</strong>:</p>\n<ul>\n<li><strong>&quot;Handler not found&quot;</strong>: Check handler parsing logic; ensure package path matches directory structure.</li>\n<li><strong>&quot;Build failed&quot;</strong>: Check Go installation and environment variables for cross-compilation.</li>\n<li><strong>&quot;Artifact too large&quot;</strong>: Verify <code>-ldflags=&quot;-s -w&quot;</code> is being used; strip debug symbols.</li>\n<li><strong>&quot;Dependency resolution failed&quot;</strong>: Ensure <code>go.mod</code> exists or is created automatically for simple functions.</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2 id=\"component-design-execution-environment\">Component Design: Execution Environment</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 2</p>\n</blockquote>\n<h3 id=\"mental-model-the-pop-up-shop\">Mental Model: The Pop-Up Shop</h3>\n<p>Imagine you&#39;re opening a series of temporary, identical retail shops in a busy market district. Each shop must be fully self-contained with all necessary inventory, equipment, and staff. When a customer arrives, you need to instantly open a shop, serve them in complete privacy, then close it down without leaving any trace. This is exactly what our execution environment does for serverless functions.</p>\n<p>Think of our system as a <strong>pop-up shop management company</strong>:</p>\n<ul>\n<li><strong>Shop Blueprint</strong> = The base container image with language runtime and system dependencies</li>\n<li><strong>Shop Inventory</strong> = The function code and its specific dependencies</li>\n<li><strong>Shop Staff</strong> = The handler process that actually serves requests</li>\n<li><strong>Shop Security</strong> = Resource limits (budget), time limits (operating hours), and isolation walls (private spaces)</li>\n<li><strong>Shop Manager</strong> = Our ContainerManager interface that handles setup, operations, and teardown</li>\n</ul>\n<p>When a request arrives (a customer), we either reuse an already-open shop (warm instance) or rapidly set up a new one from the blueprint (cold start). Each shop operates independently—customers in one shop can&#39;t see or interfere with customers in another, even if they&#39;re right next door. After serving its customer, the shop stays open for a short time in case more customers arrive, then closes completely, returning all resources to the market.</p>\n<p>This mental model helps us understand the <strong>ephemeral</strong>, <strong>isolated</strong>, and <strong>resource-bound</strong> nature of serverless execution environments. We&#39;re not running permanent servers but creating temporary, fully-contained execution spaces that appear and disappear on demand.</p>\n<h3 id=\"container-manager-interface\">Container Manager Interface</h3>\n<p>The <code>ContainerManager</code> interface abstracts the underlying isolation technology (containers, microVMs, etc.) and provides a uniform API for managing function execution environments. This interface sits at the heart of our execution plane, responsible for creating, managing, and destroying isolated environments with precise resource controls.</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>CreateContainer</code></td>\n<td><code>ctx context.Context</code>, <code>req CreateContainerRequest</code></td>\n<td><code>(*Container, error)</code></td>\n<td>Creates a new isolated environment with the specified configuration but doesn&#39;t start it</td>\n</tr>\n<tr>\n<td><code>StartContainer</code></td>\n<td><code>ctx context.Context</code>, <code>containerID string</code></td>\n<td><code>error</code></td>\n<td>Begins execution of a previously created container</td>\n</tr>\n<tr>\n<td><code>ExecuteInContainer</code></td>\n<td><code>ctx context.Context</code>, <code>containerID string</code>, <code>cmd []string</code>, <code>input io.Reader</code>, <code>output io.Writer</code></td>\n<td><code>(int, error)</code></td>\n<td>Runs a command inside a running container, capturing stdin/stdout and returning exit code</td>\n</tr>\n<tr>\n<td><code>StopContainer</code></td>\n<td><code>ctx context.Context</code>, <code>containerID string</code>, <code>timeout time.Duration</code></td>\n<td><code>error</code></td>\n<td>Gracefully stops a running container with SIGTERM then SIGKILL</td>\n</tr>\n<tr>\n<td><code>RemoveContainer</code></td>\n<td><code>ctx context.Context</code>, <code>containerID string</code></td>\n<td><code>error</code></td>\n<td>Completely cleans up all container resources (network, storage, process)</td>\n</tr>\n<tr>\n<td><code>GetContainerStats</code></td>\n<td><code>ctx context.Context</code>, <code>containerID string</code></td>\n<td><code>(*ContainerStats, error)</code></td>\n<td>Returns current resource usage statistics for monitoring and scaling</td>\n</tr>\n<tr>\n<td><code>ListContainers</code></td>\n<td><code>ctx context.Context</code>, <code>filter ListFilter</code></td>\n<td><code>([]Container, error)</code></td>\n<td>Returns all managed containers matching filter criteria</td>\n</tr>\n<tr>\n<td><code>HealthCheck</code></td>\n<td><code>ctx context.Context</code></td>\n<td><code>error</code></td>\n<td>Verifies the underlying container runtime is operational</td>\n</tr>\n</tbody></table>\n<p>The <code>CreateContainerRequest</code> structure defines the complete specification for an isolated environment:</p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Image</code></td>\n<td><code>string</code></td>\n<td>Base container image (e.g., &quot;golang:1.21-alpine&quot;)</td>\n</tr>\n<tr>\n<td><code>Cmd</code></td>\n<td><code>[]string</code></td>\n<td>Command to execute when container starts</td>\n</tr>\n<tr>\n<td><code>Env</code></td>\n<td><code>[]string</code></td>\n<td>Environment variables in &quot;KEY=VALUE&quot; format</td>\n</tr>\n<tr>\n<td><code>Labels</code></td>\n<td><code>map[string]string</code></td>\n<td>Metadata labels for tracking and filtering</td>\n</tr>\n<tr>\n<td><code>CPUQuota</code></td>\n<td><code>int64</code></td>\n<td>CPU allocation in microseconds per second (e.g., 500000 = 0.5 CPU)</td>\n</tr>\n<tr>\n<td><code>MemoryLimit</code></td>\n<td><code>int64</code></td>\n<td>Maximum memory in bytes</td>\n</tr>\n<tr>\n<td><code>NetworkMode</code></td>\n<td><code>string</code></td>\n<td>Network isolation mode (&quot;none&quot;, &quot;bridge&quot;, &quot;host&quot;)</td>\n</tr>\n<tr>\n<td><code>Binds</code></td>\n<td><code>[]string</code></td>\n<td>Volume mounts in &quot;host:container:options&quot; format</td>\n</tr>\n<tr>\n<td><code>WorkingDir</code></td>\n<td><code>string</code></td>\n<td>Working directory inside container</td>\n</tr>\n<tr>\n<td><code>User</code></td>\n<td><code>string</code></td>\n<td>User:group to run as (e.g., &quot;1000:1000&quot;)</td>\n</tr>\n<tr>\n<td><code>SecurityOpts</code></td>\n<td><code>[]string</code></td>\n<td>Security options (seccomp, AppArmor, capabilities)</td>\n</tr>\n<tr>\n<td><code>ExposedPorts</code></td>\n<td><code>map[string]struct{}</code></td>\n<td>Ports to expose internally</td>\n</tr>\n<tr>\n<td><code>PortBindings</code></td>\n<td><code>map[string][]PortBinding</code></td>\n<td>Port mappings to host</td>\n</tr>\n</tbody></table>\n<p>When a function needs to execute, the system follows this workflow:</p>\n<ol>\n<li><strong>Environment Creation</strong>: The <code>ContainerManager</code> receives a <code>CreateContainerRequest</code> with the function&#39;s base image, resource limits, and configuration.</li>\n<li><strong>Resource Allocation</strong>: The underlying runtime (e.g., Docker) creates a container with the specified cgroups, namespaces, and security profiles.</li>\n<li><strong>Code Injection</strong>: The function artifact (from Milestone 1) is mounted into the container&#39;s filesystem.</li>\n<li><strong>Process Start</strong>: The container starts, initializing the language runtime and loading dependencies.</li>\n<li><strong>Execution</strong>: The handler process begins listening for invocations via HTTP or stdin.</li>\n<li><strong>Monitoring</strong>: Resource usage is continuously tracked via <code>GetContainerStats</code>.</li>\n<li><strong>Cleanup</strong>: After the function completes or times out, the container is stopped and removed.</li>\n</ol>\n<h3 id=\"adr-container-vs-microvm-isolation\">ADR: Container vs. MicroVM Isolation</h3>\n<blockquote>\n<p><strong>Decision: Use Linux Containers with Enhanced Security Hardening</strong></p>\n<p><strong>Context</strong>: We need strong <strong>isolation</strong> between untrusted user functions while maintaining <strong>fast startup times</strong> for cold starts. The isolation boundary must prevent functions from accessing host resources, other functions&#39; memory/files, and must enforce strict resource limits (CPU, memory, network). We evaluated two primary approaches: traditional Linux containers (namespaces + cgroups) and lightweight virtual machines (microVMs).</p>\n<p><strong>Options Considered</strong>:</p>\n<ol>\n<li><strong>Linux Containers with Enhanced Hardening</strong>: Use Docker/containerd with namespace isolation, cgroups for resources, plus seccomp, AppArmor, and capability dropping</li>\n<li><strong>Firecracker MicroVMs</strong>: Use lightweight KVM-based virtual machines with minimal device emulation and optimized boot time</li>\n<li><strong>gVisor/Sandboxed Containers</strong>: Use a userspace kernel that intercepts system calls for stronger isolation than containers but weaker than VMs</li>\n</ol>\n<p><strong>Decision</strong>: We chose <strong>Option 1: Linux Containers with Enhanced Hardening</strong> as our primary isolation mechanism.</p>\n<p><strong>Rationale</strong>:</p>\n<ol>\n<li><strong>Cold Start Performance</strong>: Containers start in 100-500ms vs. microVMs at 100-300ms with snapshotting. Without snapshotting, microVMs take 1-3 seconds. Our goal of sub-100ms cold starts (Milestone 3) is more achievable with container checkpoint/restore (CRIU).</li>\n<li><strong>Resource Efficiency</strong>: Containers share the host kernel, allowing for higher density (more functions per host) and lower memory overhead (~5MB per container vs. ~5MB + VM memory overhead).</li>\n<li><strong>Maturity and Tooling</strong>: The container ecosystem (Docker, containerd, Kubernetes) provides battle-tested tooling for lifecycle management, networking, and storage.</li>\n<li><strong>Sufficient Isolation for Most Workloads</strong>: With proper security hardening (no root, read-only rootfs, dropped capabilities, seccomp, AppArmor), containers provide adequate isolation for multi-tenant serverless functions where users don&#39;t control the underlying infrastructure.</li>\n<li><strong>Simpler Implementation</strong>: Container APIs are standardized (OCI) and Go libraries (Docker SDK) are mature, reducing implementation complexity.</li>\n</ol>\n<p><strong>Consequences</strong>:</p>\n<ul>\n<li><strong>Positive</strong>: Faster cold starts, higher density, simpler implementation, extensive tooling</li>\n<li><strong>Negative</strong>: Requires careful security configuration to prevent kernel-level escapes</li>\n<li><strong>Mitigation</strong>: We implement defense-in-depth with multiple security layers and will support microVMs as an optional, more secure backend for high-risk workloads</li>\n</ul>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Isolation Technology</th>\n<th>Startup Time (cold)</th>\n<th>Isolation Strength</th>\n<th>Memory Overhead</th>\n<th>Implementation Complexity</th>\n<th>Best For</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Linux Containers (hardened)</strong></td>\n<td>100-500ms</td>\n<td>Moderate (kernel sharing)</td>\n<td>~5-50MB</td>\n<td>Medium</td>\n<td>General-purpose serverless, fast cold starts</td>\n</tr>\n<tr>\n<td><strong>Firecracker MicroVMs</strong></td>\n<td>100-300ms (with snapshot) 1-3s (fresh)</td>\n<td>Strong (hardware virtualization)</td>\n<td>~5MB + VM memory</td>\n<td>High</td>\n<td>Security-critical multi-tenant, financial/healthcare workloads</td>\n</tr>\n<tr>\n<td><strong>gVisor/Sandboxed</strong></td>\n<td>200-800ms</td>\n<td>Strong (userspace kernel)</td>\n<td>~20-100MB</td>\n<td>Medium-High</td>\n<td>Additional security without full virtualization</td>\n</tr>\n</tbody></table>\n<p>We&#39;ll design the <code>ContainerManager</code> interface to be pluggable, allowing us to implement a <code>FirecrackerManager</code> in the future while maintaining the same API. The initial implementation will use Docker via the <code>DockerManager</code> struct.</p>\n<h3 id=\"common-pitfalls-in-execution-environment\">Common Pitfalls in Execution Environment</h3>\n<p>⚠️ <strong>Pitfall: Misconfigured Resource Limits Causing Premature Termination</strong></p>\n<p><strong>Description</strong>: Setting memory limits too close to the function&#39;s actual usage, or not accounting for runtime overhead (JVM heap, Python interpreter, etc.), causes functions to be killed by the OOM (Out-Of-Memory) killer before completing their work.</p>\n<p><strong>Why It&#39;s Wrong</strong>: Functions fail unpredictably with cryptic &quot;signal: killed&quot; errors instead of clean memory exhaustion errors. This makes debugging difficult and reduces platform reliability.</p>\n<p><strong>How to Fix</strong>:</p>\n<ol>\n<li>Always add a memory buffer (e.g., 20-30%) above the function&#39;s declared memory limit for runtime overhead</li>\n<li>Use memory-swap limits to disable swapping (set <code>MemorySwap</code> = <code>MemoryLimit</code>) to ensure predictable performance</li>\n<li>Monitor actual usage with <code>GetContainerStats</code> and adjust default limits based on runtime</li>\n<li>Provide clear error messages when containers are OOM-killed</li>\n</ol>\n<p>⚠️ <strong>Pitfall: Zombie Containers Accumulating and Exhausting Host Resources</strong></p>\n<p><strong>Description</strong>: When containers aren&#39;t properly cleaned up after function execution (due to crashes, timeouts, or programming errors), they accumulate as &quot;zombie&quot; processes consuming memory, file descriptors, and other system resources.</p>\n<p><strong>Why It&#39;s Wrong</strong>: Resource leaks eventually cause host exhaustion, leading to &quot;no space left on device&quot; or &quot;too many open files&quot; errors that affect all functions on the host.</p>\n<p><strong>How to Fix</strong>:</p>\n<ol>\n<li>Implement a garbage collection routine in the <code>ContainerManager</code> that periodically lists all containers and removes those not in the active inventory</li>\n<li>Use container labels to track ownership and expected lifetime</li>\n<li>Always call <code>RemoveContainer</code> in a <code>defer</code> statement or finally block after container use</li>\n<li>Set container auto-remove flags where supported by the runtime</li>\n</ol>\n<p>⚠️ <strong>Pitfall: Inadequate Sandboxing Allowing Privilege Escalation</strong></p>\n<p><strong>Description</strong>: Running containers as root, with excessive Linux capabilities, or without seccomp/AppArmor profiles allows malicious functions to escape isolation and access the host or other functions.</p>\n<p><strong>Why It&#39;s Wrong</strong>: Complete security breach violating multi-tenancy. Functions can read secrets, modify other functions&#39; code, or attack the host system.</p>\n<p><strong>How to Fix</strong>:</p>\n<ol>\n<li>Always run containers as non-root users (specify <code>User: &quot;1000:1000&quot;</code> in <code>CreateContainerRequest</code>)</li>\n<li>Drop all capabilities and add back only specifically required ones: <code>SecurityOpts: [&quot;no-new-privileges&quot;, &quot;cap-drop=ALL&quot;]</code></li>\n<li>Apply restrictive seccomp profiles that block dangerous syscalls (clone, ptrace, kernel module operations)</li>\n<li>Use read-only root filesystem where possible, with only <code>/tmp</code> writable</li>\n<li>Disable inter-container communication at the network level</li>\n</ol>\n<p>⚠️ <strong>Pitfall: Shared Mutable State Between Invocations Causing Data Leaks</strong></p>\n<p><strong>Description</strong>: Reusing the same container for multiple invocations without resetting the filesystem or memory state allows one invocation to see another&#39;s data.</p>\n<p><strong>Why It&#39;s Wrong</strong>: Violates the serverless principle that functions should be stateless. User A&#39;s data could be visible to User B if they happen to use the same container.</p>\n<p><strong>How to Fix</strong>:</p>\n<ol>\n<li>Treat containers as single-use for security-critical workloads, creating a new container per invocation</li>\n<li>For performance (warm starts), only reuse containers for the same function version and reset writable areas between invocations</li>\n<li>Use overlay filesystems with a fresh upper layer for each invocation</li>\n<li>Clear environment variables, process memory is harder—consider it contaminated and don&#39;t reuse for different users</li>\n</ol>\n<h3 id=\"implementation-guidance-for-execution-environment\">Implementation Guidance for Execution Environment</h3>\n<h4 id=\"technology-recommendations\">Technology Recommendations</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Container Runtime</td>\n<td>Docker Engine (docker.io)</td>\n<td>containerd with CRI plugin</td>\n</tr>\n<tr>\n<td>Container SDK</td>\n<td>Docker Go SDK (github.com/docker/docker/client)</td>\n<td>Direct containerd Go client (github.com/containerd/containerd)</td>\n</tr>\n<tr>\n<td>Resource Limits</td>\n<td>cgroups v2 via container runtime</td>\n<td>Manual cgroup setup via <code>github.com/containerd/cgroups</code></td>\n</tr>\n<tr>\n<td>Security Profiles</td>\n<td>Default Docker seccomp + custom AppArmor</td>\n<td>Custom seccomp JSON profiles + SELinux</td>\n</tr>\n</tbody></table>\n<h4 id=\"recommended-filemodule-structure\">Recommended File/Module Structure</h4>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>project-root/\n├── cmd/\n│   └── server/\n│       └── main.go                 # Entry point\n├── internal/\n│   ├── containermanager/           # Container isolation subsystem\n│   │   ├── manager.go              # ContainerManager interface\n│   │   ├── docker_manager.go       # DockerManager implementation\n│   │   ├── firecracker_manager.go  # Future: Firecracker implementation\n│   │   ├── cgroup_helper.go        # Low-level cgroup utilities\n│   │   ├── security/               # Security profiles\n│   │   │   ├── seccomp.go          # Seccomp profile generator\n│   │   │   └── apparmor.go         # AppArmor profile templates\n│   │   └── tests/\n│   │       └── manager_test.go     # Integration tests\n│   ├── execution/                  # Execution coordination\n│   │   ├── executor.go             # Orchestrates container lifecycle per function\n│   │   └── runtime/                # Language-specific runtime configurations\n│   │       ├── golang.go           # Go runtime setup\n│   │       ├── python.go           # Python runtime setup\n│   │       └── nodejs.go           # Node.js runtime setup\n│   └── metrics/                    # Metrics collection\n│       └── container_metrics.go    # Container-specific metrics\n└── pkg/\n    └── types/                      # Shared types (already defined)\n        └── container.go            # Container, CreateContainerRequest types</code></pre></div>\n\n<h4 id=\"infrastructure-starter-code\">Infrastructure Starter Code</h4>\n<p><strong>cgroup_helper.go</strong> - Low-level cgroup utilities for manual resource limiting:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> containermanager</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">path/filepath</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">strconv</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">github.com/containerd/cgroups/v3</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">github.com/containerd/cgroups/v3/cgroup1</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tcgroupv2 </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#B392F0\">github.com/containerd/cgroups/v3/cgroup2</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CGroupHelper provides utilities for managing cgroups manually</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Used when container runtime doesn't provide sufficient control</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> CGroupHelper</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tcgroupPath </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tisV2       </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewCGroupHelper creates a cgroup at the specified path</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewCGroupHelper</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">path</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CGroupHelper</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Detect cgroup version</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tisV2 </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cgroups.</span><span style=\"color:#B392F0\">Mode</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">==</span><span style=\"color:#E1E4E8\"> cgroups.Unified</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">CGroupHelper</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tcgroupPath: path,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tisV2:       isV2,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// SetMemoryLimit configures memory limit and swap (if supported)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CGroupHelper</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">SetMemoryLimit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">limitBytes</span><span style=\"color:#F97583\"> int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">swapBytes</span><span style=\"color:#F97583\"> int64</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> h.isV2 {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">setMemoryLimitV2</span><span style=\"color:#E1E4E8\">(limitBytes)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">setMemoryLimitV1</span><span style=\"color:#E1E4E8\">(limitBytes, swapBytes)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// setMemoryLimitV1 sets memory limit for cgroup v1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CGroupHelper</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">setMemoryLimitV1</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">limitBytes</span><span style=\"color:#F97583\"> int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">swapBytes</span><span style=\"color:#F97583\"> int64</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tmemoryPath </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> filepath.</span><span style=\"color:#B392F0\">Join</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/sys/fs/cgroup/memory\"</span><span style=\"color:#E1E4E8\">, h.cgroupPath)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Create cgroup directory if it doesn't exist</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">MkdirAll</span><span style=\"color:#E1E4E8\">(memoryPath, </span><span style=\"color:#79B8FF\">0755</span><span style=\"color:#E1E4E8\">); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"failed to create cgroup dir: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Set memory limit</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tlimitFile </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> filepath.</span><span style=\"color:#B392F0\">Join</span><span style=\"color:#E1E4E8\">(memoryPath, </span><span style=\"color:#9ECBFF\">\"memory.limit_in_bytes\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">WriteFile</span><span style=\"color:#E1E4E8\">(limitFile, []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(strconv.</span><span style=\"color:#B392F0\">FormatInt</span><span style=\"color:#E1E4E8\">(limitBytes, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">)), </span><span style=\"color:#79B8FF\">0644</span><span style=\"color:#E1E4E8\">); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"failed to set memory limit: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Set memory+swap limit (must be >= memory limit)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> swapBytes </span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tmemswFile </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> filepath.</span><span style=\"color:#B392F0\">Join</span><span style=\"color:#E1E4E8\">(memoryPath, </span><span style=\"color:#9ECBFF\">\"memory.memsw.limit_in_bytes\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">WriteFile</span><span style=\"color:#E1E4E8\">(memswFile, []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(strconv.</span><span style=\"color:#B392F0\">FormatInt</span><span style=\"color:#E1E4E8\">(swapBytes, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">)), </span><span style=\"color:#79B8FF\">0644</span><span style=\"color:#E1E4E8\">); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t\t\t// Some systems don't have swap accounting enabled</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\t\tif</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">os.</span><span style=\"color:#B392F0\">IsNotExist</span><span style=\"color:#E1E4E8\">(err) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\t\t\treturn</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"failed to set swap limit: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// setMemoryLimitV2 sets memory limit for cgroup v2</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CGroupHelper</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">setMemoryLimitV2</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">limitBytes</span><span style=\"color:#F97583\"> int64</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// For cgroup v2, we use the containerd library</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tres </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> cgroupv2</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Resources</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tMemory: </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">cgroupv2</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Memory</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\tMax: cgroupv2.</span><span style=\"color:#B392F0\">NewPointer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">uint64</span><span style=\"color:#E1E4E8\">(limitBytes)),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tcg, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cgroupv2.</span><span style=\"color:#B392F0\">NewManager</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/sys/fs/cgroup\"</span><span style=\"color:#E1E4E8\">, h.cgroupPath, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">res)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"failed to create cgroup v2: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tdefer</span><span style=\"color:#E1E4E8\"> cg.</span><span style=\"color:#B392F0\">Delete</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// AddProcess adds a process to the cgroup</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CGroupHelper</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">AddProcess</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pid</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> h.isV2 {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">addProcessV2</span><span style=\"color:#E1E4E8\">(pid)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">addProcessV1</span><span style=\"color:#E1E4E8\">(pid)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// addProcessV1 adds process to cgroup v1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CGroupHelper</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">addProcessV1</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pid</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tprocsFile </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> filepath.</span><span style=\"color:#B392F0\">Join</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/sys/fs/cgroup/memory\"</span><span style=\"color:#E1E4E8\">, h.cgroupPath, </span><span style=\"color:#9ECBFF\">\"cgroup.procs\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">WriteFile</span><span style=\"color:#E1E4E8\">(procsFile, []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(strconv.</span><span style=\"color:#B392F0\">Itoa</span><span style=\"color:#E1E4E8\">(pid)), </span><span style=\"color:#79B8FF\">0644</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// addProcessV2 adds process to cgroup v2</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CGroupHelper</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">addProcessV2</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pid</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Implementation with containerd library</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tres </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> cgroupv2</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Resources</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tcg, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cgroupv2.</span><span style=\"color:#B392F0\">NewManager</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/sys/fs/cgroup\"</span><span style=\"color:#E1E4E8\">, h.cgroupPath, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">res)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> err</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tdefer</span><span style=\"color:#E1E4E8\"> cg.</span><span style=\"color:#B392F0\">Delete</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#E1E4E8\"> cg.</span><span style=\"color:#B392F0\">AddProc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">uint64</span><span style=\"color:#E1E4E8\">(pid))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Cleanup removes the cgroup</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CGroupHelper</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Cleanup</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> h.isV2 {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">cleanupV2</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">cleanupV1</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// cleanupV1 removes cgroup v1 directory</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CGroupHelper</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">cleanupV1</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tmemoryPath </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> filepath.</span><span style=\"color:#B392F0\">Join</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/sys/fs/cgroup/memory\"</span><span style=\"color:#E1E4E8\">, h.cgroupPath)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// Move any remaining processes to parent cgroup</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tprocsFile </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> filepath.</span><span style=\"color:#B392F0\">Join</span><span style=\"color:#E1E4E8\">(memoryPath, </span><span style=\"color:#9ECBFF\">\"cgroup.procs\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> procs, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">ReadFile</span><span style=\"color:#E1E4E8\">(procsFile); err </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#F97583\"> &#x26;&#x26;</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(procs) </span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tparentProcs </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> filepath.</span><span style=\"color:#B392F0\">Join</span><span style=\"color:#E1E4E8\">(filepath.</span><span style=\"color:#B392F0\">Dir</span><span style=\"color:#E1E4E8\">(memoryPath), </span><span style=\"color:#9ECBFF\">\"cgroup.procs\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tos.</span><span style=\"color:#B392F0\">WriteFile</span><span style=\"color:#E1E4E8\">(parentProcs, procs, </span><span style=\"color:#79B8FF\">0644</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">RemoveAll</span><span style=\"color:#E1E4E8\">(memoryPath)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// cleanupV2 removes cgroup v2</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CGroupHelper</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">cleanupV2</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tcg, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cgroupv2.</span><span style=\"color:#B392F0\">Load</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/sys/fs/cgroup\"</span><span style=\"color:#E1E4E8\">, h.cgroupPath)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t\t// Already cleaned up</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#E1E4E8\"> cg.</span><span style=\"color:#B392F0\">Delete</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>security/seccomp.go</strong> - Default seccomp profile for serverless functions:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> security</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">encoding/json</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// SeccompProfile defines a restrictive seccomp filter for serverless functions</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> SeccompProfile</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tDefaultAction </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">          `json:\"defaultAction\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tArchitectures []</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">        `json:\"architectures\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tSyscalls      []</span><span style=\"color:#B392F0\">SeccompSyscall</span><span style=\"color:#9ECBFF\"> `json:\"syscalls\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// SeccompSyscall defines a single syscall rule</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> SeccompSyscall</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tName   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">   `json:\"name\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tAction </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">   `json:\"action\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tArgs   []</span><span style=\"color:#B392F0\">SeccompArg</span><span style=\"color:#9ECBFF\"> `json:\"args,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// SeccompArg defines an argument filter for syscalls</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> SeccompArg</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tIndex    </span><span style=\"color:#F97583\">uint</span><span style=\"color:#9ECBFF\">     `json:\"index\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tValue    </span><span style=\"color:#F97583\">uint64</span><span style=\"color:#9ECBFF\">   `json:\"value\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tValueTwo </span><span style=\"color:#F97583\">uint64</span><span style=\"color:#9ECBFF\">   `json:\"valueTwo,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tOp       </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">   `json:\"op\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// DefaultSeccompProfile returns a restrictive seccomp profile for serverless functions</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> DefaultSeccompProfile</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tprofile </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> SeccompProfile</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tDefaultAction: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ERRNO\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tArchitectures: []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"SCMP_ARCH_X86_64\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"SCMP_ARCH_X86\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"SCMP_ARCH_X32\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tSyscalls: []</span><span style=\"color:#B392F0\">SeccompSyscall</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t\t\t// Basic required syscalls</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"accept\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"accept4\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"access\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"alarm\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"bind\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"brk\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"capget\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"capset\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"chdir\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"chmod\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"chown\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"chown32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"clock_getres\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"clock_gettime\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"clock_nanosleep\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"clone\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">, Args: []</span><span style=\"color:#B392F0\">SeccompArg</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t\t{Index: </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">, Value: </span><span style=\"color:#79B8FF\">2114060288</span><span style=\"color:#E1E4E8\">, Op: </span><span style=\"color:#9ECBFF\">\"SCMP_CMP_MASKED_EQ\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t}},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"close\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"connect\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"copy_file_range\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"creat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"dup\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"dup2\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"dup3\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"epoll_create\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"epoll_create1\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"epoll_ctl\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"epoll_pwait\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"epoll_wait\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"eventfd\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"eventfd2\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"execve\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"execveat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"exit\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"exit_group\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"faccessat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fadvise64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fallocate\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fchdir\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fchmod\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fchmodat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fchown\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fchown32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fchownat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fcntl\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fcntl64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fdatasync\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fgetxattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"flistxattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"flock\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fork\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fremovexattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fsetxattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fstat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fstat64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fstatat64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fstatfs\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fstatfs64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"fsync\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"ftruncate\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"ftruncate64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"futex\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getcwd\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getdents\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getdents64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getegid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getegid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"geteuid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"geteuid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getgid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getgid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getgroups\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getgroups32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getitimer\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getpeername\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getpgid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getpgrp\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getpid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getppid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getpriority\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getrandom\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getresgid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getresgid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getresuid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getresuid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getrlimit\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"get_robust_list\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getrusage\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getsid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getsockname\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getsockopt\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"gettid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"gettimeofday\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getuid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getuid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"getxattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"inotify_add_watch\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"inotify_init\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"inotify_init1\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"inotify_rm_watch\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"io_cancel\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"ioctl\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"io_destroy\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"io_getevents\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"ioprio_get\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"ioprio_set\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"io_setup\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"io_submit\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"ipc\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"kill\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"lchown\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"lchown32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"lgetxattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"link\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"linkat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"listen\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"listxattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"llistxattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"_llseek\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"lremovexattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"lseek\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"lsetxattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"lstat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"lstat64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"madvise\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"memfd_create\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mincore\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mkdir\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mkdirat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mknod\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mknodat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mlock\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mlock2\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mlockall\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mmap\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mmap2\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mprotect\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mq_getsetattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mq_notify\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mq_open\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mq_timedreceive\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mq_timedsend\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mq_unlink\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"mremap\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"msgctl\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"msgget\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"msgrcv\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"msgsnd\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"msync\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"munlock\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"munlockall\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"munmap\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"nanosleep\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"newfstatat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"_newselect\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"open\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"openat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"pause\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"pipe\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"pipe2\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"poll\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"ppoll\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"prctl\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"pread64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"preadv\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"preadv2\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"prlimit64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"pselect6\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"pwrite64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"pwritev\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"pwritev2\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"read\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"readahead\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"readlink\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"readlinkat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"readv\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"recv\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"recvfrom\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"recvmmsg\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"recvmsg\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"remap_file_pages\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"removexattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"rename\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"renameat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"renameat2\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"rmdir\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"rt_sigaction\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"rt_sigpending\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"rt_sigprocmask\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"rt_sigqueueinfo\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"rt_sigreturn\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"rt_sigsuspend\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"rt_sigtimedwait\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"rt_tgsigqueueinfo\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sched_getaffinity\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sched_getparam\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sched_getscheduler\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sched_get_priority_max\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sched_get_priority_min\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sched_rr_get_interval\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sched_setaffinity\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sched_setparam\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sched_setscheduler\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sched_yield\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"seccomp\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"select\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"semctl\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"semget\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"semop\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"semtimedop\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"send\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sendfile\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sendfile64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sendmmsg\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sendmsg\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sendto\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setfsgid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setfsgid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setfsuid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setfsuid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setgid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setgid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setgroups\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setgroups32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setitimer\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setpgid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setpriority\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setregid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setregid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setresgid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setresgid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setresuid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setresuid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setreuid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setreuid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setrlimit\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setsid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setsockopt\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"set_tid_address\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setuid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setuid32\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"setxattr\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"shmat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"shmctl\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"shmdt\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"shmget\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"shutdown\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sigaltstack\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"signalfd\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"signalfd4\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sigreturn\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"socket\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"socketcall\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"socketpair\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"splice\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"stat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"stat64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"statfs\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"statfs64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"symlink\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"symlinkat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sync\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sync_file_range\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"sysinfo\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"tee\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"tgkill\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"time\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"timer_create\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"timer_delete\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"timer_getoverrun\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"timer_gettime\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"timer_settime\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"timerfd_create\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"timerfd_gettime\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"timerfd_settime\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"times\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"tkill\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"truncate\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"truncate64\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"ugetrlimit\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"umask\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"uname\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"unlink\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"unlinkat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"utime\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"utimensat\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"utimes\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"vfork\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"vmsplice\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"wait4\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"waitid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"waitpid\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"write\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t\t{Name: </span><span style=\"color:#9ECBFF\">\"writev\"</span><span style=\"color:#E1E4E8\">, Action: </span><span style=\"color:#9ECBFF\">\"SCMP_ACT_ALLOW\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\t},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tjsonData, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">MarshalIndent</span><span style=\"color:#E1E4E8\">(profile, </span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"  \"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\tif</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\t\treturn</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"failed to marshal seccomp profile: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">(jsonData), </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"core-logic-skeleton-code\">Core Logic Skeleton Code</h4>\n<p><strong>docker_manager.go</strong> - Docker implementation of ContainerManager:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> containermanager</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">io</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">github.com/docker/docker/api/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">github.com/docker/docker/api/types/container</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">github.com/docker/docker/api/types/filters</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">github.com/docker/docker/api/types/network</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">github.com/docker/docker/client</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">yourproject/pkg/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// DockerManager implements ContainerManager using Docker Engine</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> DockerManager</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tclient </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">docker</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewDockerManager creates a new DockerManager</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewDockerManager</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DockerManager</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Create Docker client using client.NewClientWithOpts()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Configure client with appropriate API version and timeout</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Verify connection with Ping() and return error if Docker is unavailable</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Return initialized DockerManager with client</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CreateContainer creates a new Docker container with the specified configuration</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">dm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DockerManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">CreateContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#B392F0\"> types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CreateContainerRequest</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Container</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Convert MemoryLimit from bytes to megabytes for Docker (divide by 1024*1024)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Prepare container configuration with:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - Image: req.Image</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - Cmd: req.Cmd</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - Env: req.Env</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - WorkingDir: req.WorkingDir</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - User: req.User</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - Labels: req.Labels</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - ExposedPorts: req.ExposedPorts</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Prepare host configuration with:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - Memory: req.MemoryLimit</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - MemorySwap: req.MemoryLimit (to disable swap)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - NanoCPUs: req.CPUQuota * 100 (convert to nanoseconds)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - Binds: req.Binds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - PortBindings: req.PortBindings</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - SecurityOpt: append(req.SecurityOpts, \"no-new-privileges\", \"seccomp=...\")</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - ReadonlyRootfs: true (except for /tmp)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Call dm.client.ContainerCreate() with configs</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 5: On success, create and return types.Container with:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - ID from response</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - Status: StatusCreated</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - Labels: req.Labels</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - CreatedAt: time.Now()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 6: Handle errors (image pull, invalid config, etc.)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// StartContainer starts a previously created container</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">dm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DockerManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">StartContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Call dm.client.ContainerStart() with containerID</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Handle specific errors (container already running, not found)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Wait briefly to ensure container is actually running</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Return nil on success, error on failure</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ExecuteInContainer runs a command inside a running container</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">dm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DockerManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ExecuteInContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">cmd</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">input</span><span style=\"color:#B392F0\"> io</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Reader</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">output</span><span style=\"color:#B392F0\"> io</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Writer</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Create exec configuration with Cmd, User, Privileged: false</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Call dm.client.ContainerExecCreate() to create exec instance</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Call dm.client.ContainerExecStart() with hijacked response</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Stream input to exec's stdin if provided</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 5: Stream exec's stdout/stderr to output</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 6: Wait for exec to complete with ContainerExecInspect</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 7: Return exit code and any error</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// StopContainer gracefully stops a running container</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">dm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DockerManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">StopContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">timeout</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Convert timeout to seconds (Docker uses seconds)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Call dm.client.ContainerStop() with containerID and timeout</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: If force is needed after timeout, call ContainerKill()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Return error only if both stop and kill fail</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RemoveContainer cleans up container resources</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">dm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DockerManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RemoveContainer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Set remove options: RemoveVolumes: true, Force: true, RemoveLinks: false</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Call dm.client.ContainerRemove() with options</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Log warning but don't fail if container doesn't exist (already removed)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Return actual error only for unexpected failures</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GetContainerStats returns current resource usage statistics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">dm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DockerManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetContainerStats</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ContainerStats</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Call dm.client.ContainerStats() with containerID and stream: false</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Decode the stats response (types.StatsJSON)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Calculate CPU percentage: (cpuDelta / systemDelta) * 100</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Extract memory usage, limit, and percentage</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 5: Extract network I/O statistics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 6: Extract block I/O statistics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 7: Return types.ContainerStats with all calculated values</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ListContainers returns all managed containers matching filter criteria</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">dm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DockerManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ListContainers</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">filter</span><span style=\"color:#B392F0\"> types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ListFilter</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Container</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Build Docker filters from filter.Labels</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Call dm.client.ContainerList() with All: true and filters</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Convert each Docker container to types.Container</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Apply status filtering if filter.Status is specified</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 5: Return slice of matching containers</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// HealthCheck verifies Docker daemon is operational</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">dm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DockerManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">HealthCheck</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Call dm.client.Ping() with context</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Verify API version compatibility</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Check disk space if possible</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Return nil if healthy, error otherwise</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>executor.go</strong> - Orchestrates container lifecycle for function execution:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> execution</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">yourproject/internal/containermanager</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\t\"</span><span style=\"color:#B392F0\">yourproject/pkg/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Executor manages the complete lifecycle of function execution</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Executor</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tcontainerManager </span><span style=\"color:#B392F0\">containermanager</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ContainerManager</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tmetrics          </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Metrics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tconfig           </span><span style=\"color:#B392F0\">ExecutorConfig</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ExecutorConfig holds configuration for the executor</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ExecutorConfig</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tDefaultTimeout    </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tMaxMemoryMB       </span><span style=\"color:#F97583\">int64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tMaxCPUQuota       </span><span style=\"color:#F97583\">int64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tTempDir           </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\tBaseImages        </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // runtime -> image</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewExecutor creates a new function executor</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewExecutor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">cm</span><span style=\"color:#B392F0\"> containermanager</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ContainerManager</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">metrics</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Metrics</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">config</span><span style=\"color:#B392F0\"> ExecutorConfig</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Executor</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Validate config has required fields</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Set defaults for missing values</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Return initialized Executor</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Executor</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tcontainerManager: cm,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tmetrics:          metrics,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t\tconfig:           config,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ExecuteFunction runs a function in an isolated container</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Executor</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ExecuteFunction</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">def</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationResponse</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: Validate function definition has required fields</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: Check if request has already expired (req.IsExpired())</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: Create container request from function definition:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - Image: e.config.BaseImages[def.Runtime]</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - Cmd: language-specific command (e.g., [\"/function\", \"handler\"])</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - Env: combine def.EnvVars with system variables</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - MemoryLimit: def.MemoryMB * 1024 * 1024</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - CPUQuota: def.CPUQuota</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - Labels: map with function name, version, request ID</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t//         - SecurityOpts: restrictive defaults</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Call e.containerManager.CreateContainer()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 5: Start container and record start time</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 6: Mount function artifact into container (/function directory)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 7: Execute the handler with request payload as input</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 8: Capture output and record end time</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 9: Calculate duration, memory usage from stats</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 10: Build InvocationResponse with results</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 11: Always clean up container in defer</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 12: Return response and any execution error</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CleanupIdleContainers removes containers that have been idle beyond threshold</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Executor</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">CleanupIdleContainers</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">idleThreshold</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 1: List all containers with function labels</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 2: For each container, check last used time from labels</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 3: If idle longer than threshold, stop and remove</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 4: Log cleanup actions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">\t// TODO 5: Return error only if cleanup fails catastrophically</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">\treturn</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"language-specific-hints\">Language-Specific Hints</h4>\n<ol>\n<li><p><strong>Docker Go SDK</strong>: Use <code>github.com/docker/docker/client</code> version <code>v20.10.17+incompatible</code> or later. Remember to close responses: <code>defer response.Body.Close()</code>.</p>\n</li>\n<li><p><strong>Resource Limits</strong>: When setting CPU limits, Docker uses nanoseconds of CPU time per second. Convert percentage to nanoseconds: <code>CPUQuota = percentage * 10000</code> (e.g., 50% = 500000).</p>\n</li>\n<li><p><strong>Error Handling</strong>: Docker API calls can fail with <code>ErrNotFound</code>, <code>ErrNotRunning</code>, etc. Use <code>client.IsErrNotFound(err)</code> to check error types.</p>\n</li>\n<li><p><strong>Context Propagation</strong>: Always pass the context through to Docker API calls to support cancellation and timeouts.</p>\n</li>\n<li><p><strong>Security</strong>: Generate seccomp profile JSON and pass as string: <code>SecurityOpt: []string{&quot;seccomp=&quot; + profileJSON}</code>.</p>\n</li>\n<li><p><strong>Metrics Integration</strong>: Use the <code>types.Metrics</code> struct to record container operations: <code>e.metrics.ContainerOperations.WithLabelValues(&quot;create&quot;).Inc()</code>.</p>\n</li>\n</ol>\n<h4 id=\"milestone-checkpoint\">Milestone Checkpoint</h4>\n<p>After implementing the execution environment, verify it works:</p>\n<ol>\n<li><strong>Test Container Creation</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">   # Start the server</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   go</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#9ECBFF\"> cmd/server/main.go</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">   # In another terminal, test with curl</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/v1/functions</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: multipart/form-data\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -F</span><span style=\"color:#9ECBFF\"> \"code=@hello.go\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -F</span><span style=\"color:#9ECBFF\"> \"runtime=go\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -F</span><span style=\"color:#9ECBFF\"> \"handler=Handler\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -F</span><span style=\"color:#9ECBFF\"> \"name=test-func\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">   # Expected: Function created response with version ID</span></span></code></pre></div>\n\n<ol start=\"2\">\n<li><strong>Test Function Execution</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">   # Invoke the function</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/v1/functions/test-func/invoke</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -d</span><span style=\"color:#9ECBFF\"> '{\"name\": \"World\"}'</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">   # Expected: Response from function, check Docker containers are created</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   docker</span><span style=\"color:#9ECBFF\"> ps</span><span style=\"color:#79B8FF\"> --filter</span><span style=\"color:#9ECBFF\"> \"label=function=test-func\"</span></span></code></pre></div>\n\n<ol start=\"3\">\n<li><strong>Verify Resource Limits</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">   # Check container stats while function is running</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   CONTAINER_ID</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> ps</span><span style=\"color:#79B8FF\"> -q</span><span style=\"color:#79B8FF\"> --filter</span><span style=\"color:#9ECBFF\"> \"label=function=test-func\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   docker</span><span style=\"color:#9ECBFF\"> stats</span><span style=\"color:#E1E4E8\"> $CONTAINER_ID</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">   # Should show memory limit enforced</span></span></code></pre></div>\n\n<ol start=\"4\">\n<li><strong>Test Cleanup</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">   # Wait for function timeout + cleanup period</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   sleep</span><span style=\"color:#79B8FF\"> 120</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">   # Verify containers are removed</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   docker</span><span style=\"color:#9ECBFF\"> ps</span><span style=\"color:#79B8FF\"> -a</span><span style=\"color:#79B8FF\"> --filter</span><span style=\"color:#9ECBFF\"> \"label=function=test-func\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">   # Expected: No containers (or only exited ones)</span></span></code></pre></div>\n\n<p><strong>Signs of Problems</strong>:</p>\n<ul>\n<li><strong>&quot;Cannot connect to Docker daemon&quot;</strong>: Docker isn&#39;t running or user lacks permissions</li>\n<li><strong>&quot;No such image&quot;</strong>: Base images not pulled; run <code>docker pull</code> for runtime images</li>\n<li><strong>&quot;Permission denied&quot;</strong>: Security options too restrictive; check seccomp profile</li>\n<li><strong>Containers not cleaned up</strong>: Garbage collection not running; check cleanup timer</li>\n</ul>\n<hr>\n<h2 id=\"component-design-cold-start-optimization\">Component Design: Cold Start Optimization</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 3</p>\n</blockquote>\n<h3 id=\"mental-model-the-taxi-stand\">Mental Model: The Taxi Stand</h3>\n<p>Imagine you&#39;re managing a large taxi service in a busy city. There are two ways passengers get rides:</p>\n<ol>\n<li><p><strong>The Taxi Stand Approach:</strong> You maintain a fleet of taxis parked at strategic locations around the city. Each taxi is clean, fueled, and the engine is running. When a passenger arrives, they can immediately get into a waiting taxi and drive away. The taxi driver is already behind the wheel, knows the city layout, and is ready to go. The passenger&#39;s journey starts within seconds.</p>\n</li>\n<li><p><strong>The Custom-Built Approach:</strong> When a passenger arrives, you call a factory to manufacture a new taxi from scratch. Workers assemble the chassis, install the engine, paint the exterior, install seats, and hire/train a driver. Only then can the passenger begin their journey. This process takes minutes, not seconds.</p>\n</li>\n</ol>\n<p><strong>Cold starts in serverless functions are exactly this problem.</strong> The &quot;custom-built approach&quot; represents a true <strong>cold start</strong>: when a function hasn&#39;t been invoked recently, the system must:</p>\n<ul>\n<li>Provision a new execution environment (assemble the taxi)</li>\n<li>Install the runtime and dependencies (install the engine and seats)</li>\n<li>Load the function code (train the driver on the specific route)</li>\n<li>Execute the handler (begin the journey)</li>\n</ul>\n<p>The <strong>taxi stand approach</strong> represents <strong>warm start optimization</strong>: we maintain a pool of pre-initialized, ready-to-go execution environments (warm containers). When a request arrives, we simply assign it to an available warm environment, eliminating most of the startup overhead.</p>\n<p>The key insight is that we&#39;re trading <strong>resource efficiency</strong> (keeping idle instances ready consumes memory and CPU) for <strong>performance</strong> (sub-100ms response times). Our design must intelligently balance this trade-off by determining how many taxis to keep idling, where to park them, and when to send them back to the factory for recycling.</p>\n<h3 id=\"warm-pool-manager-interface\">Warm Pool Manager Interface</h3>\n<p>The <strong>Warm Pool Manager</strong> is the component responsible for maintaining a pool of pre-initialized <code>FunctionInstance</code> objects and allocating them to incoming requests. It serves as the intermediary between the <strong>Request Router</strong> (which needs execution environments) and the <strong>Container Manager</strong> (which creates and destroys them). Think of it as the dispatcher at the taxi stand who tracks which taxis are available, which are currently on trips, and decides when to call for more taxis from the factory.</p>\n<p>The manager operates on two key principles:</p>\n<ol>\n<li><strong>Instance Reuse:</strong> Once a function finishes executing, its container environment is returned to the warm pool (after cleanup) rather than destroyed, ready for the next invocation of the same function.</li>\n<li><strong>Pre-warming:</strong> Based on traffic patterns, the system can proactively create and initialize instances before they&#39;re needed, anticipating demand spikes.</li>\n</ol>\n<p>Here are the core data structures and interfaces:</p>\n<table>\n<thead>\n<tr>\n<th>Type/Interface</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>WarmPoolManager</code></td>\n<td>Main interface for managing warm instances</td>\n</tr>\n<tr>\n<td><code>PoolConfig</code></td>\n<td>Configuration for pool behavior and limits</td>\n</tr>\n<tr>\n<td><code>AcquireRequest</code></td>\n<td>Request to obtain a warm instance</td>\n</tr>\n<tr>\n<td><code>PoolMetrics</code></td>\n<td>Metrics tracking pool efficiency and performance</td>\n</tr>\n</tbody></table>\n<p><strong>Pool Configuration:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>MaxWarmInstances</code></td>\n<td><code>int</code></td>\n<td>Maximum number of warm instances to keep per function (prevents memory bloat)</td>\n</tr>\n<tr>\n<td><code>MinWarmInstances</code></td>\n<td><code>int</code></td>\n<td>Minimum number of warm instances to maintain per function (for latency-sensitive workloads)</td>\n</tr>\n<tr>\n<td><code>InstanceTTL</code></td>\n<td><code>time.Duration</code></td>\n<td>Maximum lifetime of a warm instance before it&#39;s recycled (prevents stale environments)</td>\n</tr>\n<tr>\n<td><code>IdleTimeout</code></td>\n<td><code>time.Duration</code></td>\n<td>How long an instance can sit idle in the warm pool before being terminated (scale-to-zero within pool)</td>\n</tr>\n<tr>\n<td><code>PreWarmThreshold</code></td>\n<td><code>float64</code></td>\n<td>Request rate threshold that triggers pre-warming (requests per second)</td>\n</tr>\n<tr>\n<td><code>CleanupInterval</code></td>\n<td><code>time.Duration</code></td>\n<td>How often to run cleanup of expired/stale instances</td>\n</tr>\n</tbody></table>\n<p><strong>Warm Pool Manager Interface:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>AcquireWarmInstance</code></td>\n<td><code>ctx context.Context</code>, <code>functionName string</code>, <code>version string</code></td>\n<td><code>(*FunctionInstance, error)</code></td>\n<td>Gets a warm instance for the specified function. Creates one if needed and pool limits allow.</td>\n</tr>\n<tr>\n<td><code>ReleaseInstance</code></td>\n<td><code>ctx context.Context</code>, <code>instance *FunctionInstance</code>, <code>healthy bool</code></td>\n<td><code>error</code></td>\n<td>Returns an instance to the pool after execution. If <code>healthy</code> is false, the instance is destroyed instead.</td>\n</tr>\n<tr>\n<td><code>PreWarm</code></td>\n<td><code>ctx context.Context</code>, <code>functionName string</code>, <code>version string</code>, <code>count int</code></td>\n<td><code>error</code></td>\n<td>Proactively creates <code>count</code> warm instances for the function.</td>\n</tr>\n<tr>\n<td><code>DrainPool</code></td>\n<td><code>ctx context.Context</code>, <code>functionName string</code>, <code>version string</code></td>\n<td><code>error</code></td>\n<td>Terminates all warm instances for a function (used during updates or scale-to-zero).</td>\n</tr>\n<tr>\n<td><code>GetPoolStats</code></td>\n<td><code>ctx context.Context</code>, <code>functionName string</code>, <code>version string</code></td>\n<td><code>(*PoolStats, error)</code></td>\n<td>Returns current pool statistics (available instances, total instances, etc.).</td>\n</tr>\n<tr>\n<td><code>CleanupExpired</code></td>\n<td><code>ctx context.Context</code></td>\n<td><code>error</code></td>\n<td>Removes instances that have exceeded their TTL or idle timeout.</td>\n</tr>\n</tbody></table>\n<p><strong>Instance States with Pool Transitions:</strong>\nThe <code>FunctionInstanceState</code> machine from our data model expands with pool-specific transitions:</p>\n<table>\n<thead>\n<tr>\n<th>Current State</th>\n<th>Event</th>\n<th>Next State</th>\n<th>Action Taken</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>InstanceStateWarm</code></td>\n<td><code>AcquireWarmInstance</code> called</td>\n<td><code>InstanceStateActive</code></td>\n<td>Instance removed from available pool, assigned to request</td>\n</tr>\n<tr>\n<td><code>InstanceStateActive</code></td>\n<td>Execution completes</td>\n<td><code>InstanceStateWarm</code></td>\n<td>Instance cleaned up (filesystem reset), returned to warm pool</td>\n</tr>\n<tr>\n<td><code>InstanceStateWarm</code></td>\n<td><code>IdleTimeout</code> expires</td>\n<td><code>InstanceStateDraining</code></td>\n<td>Begin graceful termination (finish any in-progress operations)</td>\n</tr>\n<tr>\n<td><code>InstanceStateWarm</code></td>\n<td><code>InstanceTTL</code> expires</td>\n<td><code>InstanceStateDraining</code></td>\n<td>Begin graceful termination (instance is stale)</td>\n</tr>\n<tr>\n<td><code>InstanceStateWarm</code></td>\n<td>Function version updated</td>\n<td><code>InstanceStateDraining</code></td>\n<td>Old version instances are drained during updates</td>\n</tr>\n<tr>\n<td>Any state</td>\n<td>Container health check fails</td>\n<td><code>InstanceStateError</code></td>\n<td>Instance marked unhealthy, removed from pool, replacement created</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>Design Insight:</strong> The warm pool isn&#39;t just about keeping containers running—it&#39;s about keeping <em>initialized</em> containers. True cold start optimization requires that the runtime environment (language interpreter, loaded libraries, framework initialization) is already prepared. Our warm instances are &quot;pre-heated&quot; execution environments with the function code loaded and the handler initialized, ready to process the first instruction immediately.</p>\n</blockquote>\n<h3 id=\"adr-pooling-strategy-eager-vs-lazy\">ADR: Pooling Strategy - Eager vs. Lazy</h3>\n<blockquote>\n<p><strong>Decision: Lazy Warm Pool with Predictive Top-Ups</strong></p>\n<ul>\n<li><strong>Context:</strong> We need to minimize cold starts while avoiding excessive resource consumption. Keeping thousands of instances warm &quot;just in case&quot; would waste memory and CPU, especially for infrequently invoked functions. However, waiting for a cold start on every invocation defeats the purpose of optimization.</li>\n<li><strong>Options Considered:</strong><ol>\n<li><strong>Eager Pooling (Fixed-Size):</strong> Maintain a fixed number of warm instances per function at all times, regardless of traffic.</li>\n<li><strong>Lazy Pooling (On-Demand):</strong> Create warm instances only when a request arrives and no warm instance is available.</li>\n<li><strong>Hybrid Predictive:</strong> Use lazy pooling as baseline, but proactively create instances when traffic patterns suggest increased demand.</li>\n</ol>\n</li>\n<li><strong>Decision:</strong> We choose <strong>Hybrid Predictive</strong> with lazy creation as the default behavior.</li>\n<li><strong>Rationale:</strong> <ul>\n<li><strong>Eager pooling</strong> wastes resources for low-traffic functions (keeping instances warm for hours between invocations).</li>\n<li><strong>Pure lazy pooling</strong> still incurs cold start latency for the first request after idle periods.</li>\n<li><strong>Hybrid predictive</strong> gives us the best of both: minimal resource usage during quiet periods, but reduced latency when traffic patterns change. By monitoring request rates and using simple heuristics (like &quot;if requests-per-second increases by X% over Y seconds, pre-warm Z instances&quot;), we can anticipate demand without complex ML models.</li>\n</ul>\n</li>\n<li><strong>Consequences:</strong><ul>\n<li><strong>Positive:</strong> Good balance of resource efficiency and performance, adaptable to changing workloads.</li>\n<li><strong>Negative:</strong> Requires implementing traffic pattern analysis and prediction logic, adds complexity.</li>\n<li><strong>Trade-off:</strong> Some cold starts still occur for truly unpredictable traffic spikes, but this is acceptable for most workloads.</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<p><strong>Options Comparison:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Option</th>\n<th>Pros</th>\n<th>Cons</th>\n<th>Why Not Chosen</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Eager Pooling</strong></td>\n<td>- Guaranteed zero cold starts for first N concurrent requests<br>- Simple implementation (static pool)</td>\n<td>- Wastes resources for infrequent functions<br>- Doesn&#39;t adapt to traffic patterns<br>- Higher memory footprint increases hosting costs</td>\n<td>Too resource-inefficient for a multi-tenant system where most functions are invoked infrequently</td>\n</tr>\n<tr>\n<td><strong>Lazy Pooling</strong></td>\n<td>- Optimal resource usage (zero idle instances)<br>- Simple to implement</td>\n<td>- Every scale-up event incurs cold start latency<br>- Poor user experience during traffic spikes<br>- Could cause request queuing during sudden load</td>\n<td>Unacceptable latency during traffic growth; violates performance goals</td>\n</tr>\n<tr>\n<td><strong>Hybrid Predictive</strong></td>\n<td>- Balances resources and performance<br>- Adapts to workload patterns<br>- Can be tuned based on function importance/cost</td>\n<td>- More complex implementation<br>- Requires metrics collection and analysis<br>- Prediction can be wrong (false positives waste resources)</td>\n<td><strong>CHOSEN:</strong> Provides the best trade-off for our target workloads; complexity is manageable</td>\n</tr>\n</tbody></table>\n<h3 id=\"common-pitfalls-in-cold-start-optimization\">Common Pitfalls in Cold Start Optimization</h3>\n<p>⚠️ <strong>Pitfall: Memory Bloat from Unlimited Warm Pools</strong></p>\n<p><strong>The Mistake:</strong> Keeping an unlimited number of warm instances per function, or setting <code>MaxWarmInstances</code> too high. Each warm instance consumes memory (the container&#39;s resident memory plus any loaded libraries). If you keep 100 instances warm for a function that uses 256MB each, that&#39;s 25GB of RAM occupied—even if the function only gets invoked once per hour.</p>\n<p><strong>Why It&#39;s Wrong:</strong> This wastes expensive memory resources and reduces overall system density. In a multi-tenant environment, one greedy function could starve others of resources. It also increases costs for the platform operator.</p>\n<p><strong>How to Fix:</strong> Implement strict per-function limits (<code>MaxWarmInstances</code>) based on function tier/plan. Use metrics to monitor pool memory consumption. Implement <strong>instance eviction</strong> policies: when at capacity, evict the least-recently-used warm instance to make room for new ones.</p>\n<p>⚠️ <strong>Pitfall: Stale Environment State Between Invocations</strong></p>\n<p><strong>The Mistake:</strong> Returning a container to the warm pool without properly resetting its state. For example, if a function writes files to <code>/tmp</code> or modifies environment variables, those changes persist to the next invocation, potentially leaking data between users or causing unexpected behavior.</p>\n<p><strong>Why It&#39;s Wrong:</strong> Violates the principle of isolation between invocations. User A&#39;s data could be visible to User B, creating security vulnerabilities. Stateful behavior makes debugging difficult and breaks the &quot;stateless&quot; assumption of serverless functions.</p>\n<p><strong>How to Fix:</strong> Implement a <strong>cleanup hook</strong> before returning an instance to the warm pool:</p>\n<ol>\n<li>Delete all files in the container&#39;s writable filesystem (especially <code>/tmp</code>)</li>\n<li>Reset environment variables to their original values</li>\n<li>Clear any in-memory caches (language runtime specific)</li>\n<li>Restart the container&#39;s entrypoint process (if possible) to ensure fresh runtime state\nConsider using copy-on-write filesystem layers to efficiently create fresh filesystem state for each invocation.</li>\n</ol>\n<p>⚠️ <strong>Pitfall: Over-Complicated Snapshot/Restore Mechanisms</strong></p>\n<p><strong>The Mistake:</strong> Attempting to implement full container checkpoint/restore (CRIU) or VM snapshotting without understanding the complexity and edge cases. These technologies promise near-instant restores but come with significant limitations: large snapshot files, compatibility issues with certain syscalls, and high implementation complexity.</p>\n<p><strong>Why It&#39;s Wrong:</strong> The development time and maintenance burden often outweigh the benefits. Snapshot files can be large (hundreds of MB), requiring significant storage I/O that might negate latency gains. CRIU has limitations with multi-threaded applications, certain kernel versions, and network connections.</p>\n<p><strong>How to Fix:</strong> Start with <strong>simple warm pooling</strong> (keeping containers running), which provides 80% of the benefit with 20% of the complexity. Only consider snapshot/restore for specific use cases after measuring actual cold start bottlenecks. If implemented, use it selectively for large runtimes (like JVM) where initialization is truly expensive, not for lightweight runtimes like Go.</p>\n<p>⚠️ <strong>Pitfall: Ignoring Language-Specific Initialization Costs</strong></p>\n<p><strong>The Mistake:</strong> Treating all runtime environments equally. A pre-initialized Node.js container might start in 50ms, while a JVM container with Spring Boot could take 10 seconds to initialize classes and dependencies.</p>\n<p><strong>Why It&#39;s Wrong:</strong> Different runtimes have vastly different cold start characteristics. A one-size-fits-all pooling strategy will either over-provision (wasting resources on fast runtimes) or under-provision (causing unacceptable latency for slow runtimes).</p>\n<p><strong>How to Fix:</strong> Implement <strong>runtime-aware pooling</strong>:</p>\n<ul>\n<li>Set different <code>MinWarmInstances</code> based on runtime (higher for JVM, lower for Go)</li>\n<li>Use runtime-specific optimizations: for JVM, consider keeping instances in &quot;warm&quot; state with classpath pre-loaded but no application context initialized</li>\n<li>Implement <strong>gradual warmup</strong>: initialize heavy frameworks in the background while serving simple requests</li>\n<li>Track cold start duration per runtime in metrics and adjust pooling parameters accordingly</li>\n</ul>\n<h3 id=\"implementation-guidance-for-cold-start\">Implementation Guidance for Cold Start</h3>\n<p><strong>Technology Recommendations:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Pool Storage</strong></td>\n<td>In-memory map with mutex synchronization</td>\n<td>Redis with distributed locking for multi-node deployments</td>\n</tr>\n<tr>\n<td><strong>Instance Cleanup</strong></td>\n<td>Basic filesystem wipe (<code>os.RemoveAll</code>)</td>\n<td>Overlay filesystem with fresh writable layer per invocation</td>\n</tr>\n<tr>\n<td><strong>Metrics Collection</strong></td>\n<td>Prometheus counters and gauges</td>\n<td>OpenTelemetry with distributed tracing for end-to-end latency analysis</td>\n</tr>\n<tr>\n<td><strong>Predictive Warming</strong></td>\n<td>Simple rate-of-change threshold</td>\n<td>Machine learning model trained on historical invocation patterns</td>\n</tr>\n</tbody></table>\n<p><strong>Recommended File/Module Structure:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>project-root/\n  cmd/\n    server/main.go                    # Entry point\n  internal/\n    warmpool/                         # Warm pool component\n      manager.go                      # WarmPoolManager implementation\n      config.go                       # PoolConfig and related types\n      metrics.go                      # Pool-specific metrics\n      cleanup.go                      # Instance cleanup utilities\n      poolstore/                      # Storage backend for pool state\n        memory_store.go               # In-memory implementation\n        redis_store.go                # Redis implementation (optional)\n    container/                        # Container management (from Milestone 2)\n      manager.go                      # ContainerManager interface\n      docker_manager.go               # Docker implementation\n    executor/                         # Function execution (uses warm pool)\n      executor.go                     # Executor that acquires/releases instances\n    gateway/                          # HTTP gateway (from Milestone 4)\n      router.go                       # Request routing\n    scaling/                          # Auto-scaling (Milestone 5)\n      scaler.go                       # Uses pool metrics for decisions</code></pre></div>\n\n<p><strong>Infrastructure Starter Code - Warm Pool Manager Base Implementation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/warmpool/manager.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> warmpool</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/prometheus/client_golang/prometheus</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">project/internal/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">project/internal/container</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Pool metrics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    warmPoolSize </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> prometheus.</span><span style=\"color:#B392F0\">NewGaugeVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">GaugeOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            Name: </span><span style=\"color:#9ECBFF\">\"warm_pool_size\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            Help: </span><span style=\"color:#9ECBFF\">\"Number of instances in warm pool per function\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"runtime\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    coldStarts </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> prometheus.</span><span style=\"color:#B392F0\">NewCounterVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            Name: </span><span style=\"color:#9ECBFF\">\"cold_starts_total\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            Help: </span><span style=\"color:#9ECBFF\">\"Total number of cold starts\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"runtime\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    poolHits </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> prometheus.</span><span style=\"color:#B392F0\">NewCounterVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            Name: </span><span style=\"color:#9ECBFF\">\"warm_pool_hits_total\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            Help: </span><span style=\"color:#9ECBFF\">\"Number of times warm instance was available\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"runtime\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    poolMisses </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> prometheus.</span><span style=\"color:#B392F0\">NewCounterVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            Name: </span><span style=\"color:#9ECBFF\">\"warm_pool_misses_total\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            Help: </span><span style=\"color:#9ECBFF\">\"Number of times warm instance was not available\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"runtime\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> init</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    prometheus.</span><span style=\"color:#B392F0\">MustRegister</span><span style=\"color:#E1E4E8\">(warmPoolSize, coldStarts, poolHits, poolMisses)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// PoolConfig holds configuration for warm pool behavior</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> PoolConfig</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MaxWarmInstances   </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">           // Maximum warm instances per function</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MinWarmInstances   </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">           // Minimum warm instances to maintain</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    InstanceTTL        </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // Max lifetime of a warm instance</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IdleTimeout        </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // Time before idle instance is terminated</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CleanupInterval    </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // How often to run cleanup</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    PreWarmThreshold   </span><span style=\"color:#F97583\">float64</span><span style=\"color:#6A737D\">       // RPS threshold for pre-warming</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// WarmPoolManager manages a pool of warm function instances</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> WarmPoolManager</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    containerManager </span><span style=\"color:#B392F0\">container</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ContainerManager</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    config           </span><span style=\"color:#B392F0\">PoolConfig</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store            </span><span style=\"color:#B392F0\">PoolStore</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    metrics          </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Metrics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cleanupTicker    </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Ticker</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu               </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">RWMutex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Function definitions cache for creating new instances</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    functionDefs </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionDefinition</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewWarmPoolManager creates a new warm pool manager</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewWarmPoolManager</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">cm</span><span style=\"color:#B392F0\"> container</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ContainerManager</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">config</span><span style=\"color:#B392F0\"> PoolConfig</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">metrics</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Metrics</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">WarmPoolManager</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    wpm </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">WarmPoolManager</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        containerManager: cm,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        config:           config,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        store:            </span><span style=\"color:#B392F0\">NewMemoryStore</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        metrics:          metrics,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        functionDefs:     </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        cleanupTicker:    time.</span><span style=\"color:#B392F0\">NewTicker</span><span style=\"color:#E1E4E8\">(config.CleanupInterval),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Start background cleanup goroutine</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    go</span><span style=\"color:#E1E4E8\"> wpm.</span><span style=\"color:#B392F0\">cleanupLoop</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> wpm</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// AcquireWarmInstance gets a warm instance for a function</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">wpm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">WarmPoolManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">AcquireWarmInstance</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">functionName</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">version</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionInstance</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Generate a composite key from functionName and version</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Check if a warm instance is available in the store</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: If available: remove from pool, update metrics (poolHits), update instance state to ACTIVE, return it</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: If not available: update metrics (poolMisses, coldStarts)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Check if we're below MaxWarmInstances limit for this function</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: If under limit: create a new instance (cold start), set state to ACTIVE, return it</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 7: If at limit: wait for an instance to become available (with timeout) or return error</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not implemented\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ReleaseInstance returns an instance to the pool after execution</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">wpm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">WarmPoolManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ReleaseInstance</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">instance</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionInstance</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">healthy</span><span style=\"color:#F97583\"> bool</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: If instance is not healthy: destroy it completely, return nil</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Clean up the instance: reset filesystem, clear environment state</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Check if instance has exceeded InstanceTTL</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: If exceeded TTL: destroy it, return nil</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Update instance state to WARM, set LastUsedAt to now</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Add instance back to the pool store</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 7: Update warmPoolSize metrics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not implemented\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// PreWarm proactively creates warm instances</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">wpm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">WarmPoolManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">PreWarm</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">functionName</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">version</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">count</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Get current warm instance count for this function</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Calculate how many new instances to create (respecting MaxWarmInstances)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: For each instance to create: launch async creation goroutine</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Each goroutine: create container, initialize it, add to warm pool</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Return early (don't wait for all instances to be ready)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not implemented\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// cleanupLoop runs periodic cleanup of expired instances</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">wpm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">WarmPoolManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">cleanupLoop</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> wpm.cleanupTicker.C {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        wpm.</span><span style=\"color:#B392F0\">cleanupExpired</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">wpm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">WarmPoolManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">cleanupExpired</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Iterate through all instances in the store</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: For each instance: check if IdleTimeout has expired</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: If expired: remove from pool, destroy container</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Update warmPoolSize metrics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Core Logic Skeleton Code - Instance Cleanup Hook:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/warmpool/cleanup.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> warmpool</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">path/filepath</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">project/internal/container</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">project/internal/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CleanupInstance resets an instance to a clean state before returning to pool</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> CleanupInstance</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">cm</span><span style=\"color:#B392F0\"> container</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ContainerManager</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">instance</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionInstance</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Clean filesystem - execute command in container to delete all files in /tmp</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Use cm.ExecuteInContainer with command: [\"sh\", \"-c\", \"rm -rf /tmp/*\"]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Reset environment variables - restart the container's entrypoint process</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: For Docker: stop and start the container (or send signal to restart process)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Clear runtime-specific caches</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Detect runtime from instance and apply runtime-specific cleanup</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // - Node.js: Clear require.cache? (difficult in separate process)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // - Python: Might need to restart Python process entirely</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // - JVM: Consider keeping JVM warm but reset application context</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Verify container health (run a simple echo command)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: If any cleanup step fails, mark instance as unhealthy</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Runtime-specific cleanup strategies</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RuntimeCleaner</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Clean</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> GetCleanerForRuntime</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">runtime</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RuntimeCleaner</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    switch</span><span style=\"color:#E1E4E8\"> runtime {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#9ECBFF\"> \"go\"</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">GoCleaner</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#9ECBFF\"> \"python\"</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">PythonCleaner</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#9ECBFF\"> \"node\"</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">NodeJSCleaner</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#9ECBFF\"> \"java\"</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">JavaCleaner</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    default</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">GenericCleaner</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Integration with Executor - Modified ExecuteFunction Method:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/executor/executor.go - Modified from Milestone 2</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Executor</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ExecuteFunction</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">def</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationResponse</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Acquire warm instance from pool (instead of creating new container)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    instance, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> e.warmPool.</span><span style=\"color:#B392F0\">AcquireWarmInstance</span><span style=\"color:#E1E4E8\">(ctx, def.Name, req.FunctionVersion)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"failed to acquire instance: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: If instance is nil (pool empty and at max capacity), wait or return error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Execute function in the acquired container</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ... existing execution logic from Milestone 2 ...</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: After execution completes, release instance back to pool</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Pass true if execution succeeded, false if container should be destroyed</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        healthy </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> (err </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        releaseErr </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> e.warmPool.</span><span style=\"color:#B392F0\">ReleaseInstance</span><span style=\"color:#E1E4E8\">(ctx, instance, healthy)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> releaseErr </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // Log error but don't fail the invocation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            e.metrics.ContainerOperations.</span><span style=\"color:#B392F0\">WithLabelValues</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"release_failed\"</span><span style=\"color:#E1E4E8\">).</span><span style=\"color:#B392F0\">Inc</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ... rest of execution ...</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Language-Specific Hints for Go:</strong></p>\n<ol>\n<li><p><strong>Concurrency Management:</strong> Use <code>sync.RWMutex</code> for pool store access—multiple goroutines can read concurrently, but only one can write. For the pool store map: <code>map[string][]*FunctionInstance</code>.</p>\n</li>\n<li><p><strong>Background Goroutines:</strong> Use <code>context.Context</code> to gracefully stop the cleanup goroutine on shutdown:</p>\n</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">   go</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">       for</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">           select</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">           case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">ctx.</span><span style=\"color:#B392F0\">Done</span><span style=\"color:#E1E4E8\">():</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">               return</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">           case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">wpm.cleanupTicker.C:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">               wpm.</span><span style=\"color:#B392F0\">cleanupExpired</span><span style=\"color:#E1E4E8\">(ctx)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">           }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">       }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   }()</span></span></code></pre></div>\n\n<ol start=\"3\">\n<li><strong>Metrics Collection:</strong> Use Prometheus histogram for cold start duration:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">   coldStartDuration </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> prometheus.</span><span style=\"color:#B392F0\">NewHistogramVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">       prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HistogramOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">           Name: </span><span style=\"color:#9ECBFF\">\"cold_start_duration_ms\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">           Help: </span><span style=\"color:#9ECBFF\">\"Duration of cold starts in milliseconds\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">           Buckets: []</span><span style=\"color:#F97583\">float64</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">50</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">200</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">500</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">1000</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">5000</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">       },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">       []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"runtime\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   )</span></span></code></pre></div>\n\n<ol start=\"4\">\n<li><strong>Instance Identification:</strong> Create a unique key for each function version:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">   func</span><span style=\"color:#B392F0\"> poolKey</span><span style=\"color:#E1E4E8\">(functionName, version </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">       return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, functionName, version)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   }</span></span></code></pre></div>\n\n<p><strong>Milestone Checkpoint Verification:</strong></p>\n<p>After implementing the warm pool, verify the following behaviors:</p>\n<ol>\n<li><strong>Cold Start Reduction:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   # Send two requests sequentially with a small delay\n   curl -X POST http://localhost:8080/functions/myfunc\n   # First request should show &quot;cold_start: true&quot; in logs or metrics\n   \n   curl -X POST http://localhost:8080/functions/myfunc  \n   # Second request should show &quot;cold_start: false&quot; (warm start)</code></pre></div>\n\n<ol start=\"2\">\n<li><strong>Pool Metrics Exposure:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   curl http://localhost:9090/metrics | grep warm_pool\n   # Should see:\n   # warm_pool_size{function=&quot;myfunc&quot;,runtime=&quot;go&quot;} 1\n   # warm_pool_hits_total{function=&quot;myfunc&quot;,runtime=&quot;go&quot;} 1</code></pre></div>\n\n<ol start=\"3\">\n<li><strong>Instance Cleanup Verification:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   # Check container count before and after idle timeout\n   docker ps | grep myfunc\n   # Wait for IdleTimeout duration (e.g., 5 minutes)\n   # Check again - idle instances should be removed</code></pre></div>\n\n<ol start=\"4\">\n<li><strong>Concurrent Request Handling:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   # Send 10 concurrent requests\n   for i in {1..10}; do\n     curl -X POST http://localhost:8080/functions/myfunc &amp;\n   done\n   # Should see multiple warm instances created (up to MaxWarmInstances)\n   # Check warm_pool_size metric</code></pre></div>\n\n<p><strong>Common Debugging Tips:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>How to Diagnose</th>\n<th>Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>All requests show cold starts</strong></td>\n<td>Warm pool not being populated</td>\n<td>Check if <code>ReleaseInstance</code> is being called after execution</td>\n<td>Ensure executor calls <code>ReleaseInstance</code> in <code>defer</code></td>\n</tr>\n<tr>\n<td><strong>Memory usage grows indefinitely</strong></td>\n<td>Instances not being cleaned up</td>\n<td>Check <code>cleanupExpired</code> logs; verify <code>IdleTimeout</code> is &gt; 0</td>\n<td>Ensure cleanup goroutine is running; check for deadlocks</td>\n</tr>\n<tr>\n<td><strong>Instance reuse causes state leakage</strong></td>\n<td>Cleanup not working properly</td>\n<td>Add debug logs in <code>CleanupInstance</code>; check <code>/tmp</code> contents in container</td>\n<td>Ensure cleanup commands execute successfully in container</td>\n</tr>\n<tr>\n<td><strong>High latency on first request after idle</strong></td>\n<td><code>MinWarmInstances</code> set to 0</td>\n<td>Check pool size metrics during idle period</td>\n<td>Increase <code>MinWarmInstances</code> or implement predictive warming</td>\n</tr>\n<tr>\n<td><strong>&quot;Too many warm instances&quot; errors</strong></td>\n<td><code>MaxWarmInstances</code> too low for concurrent load</td>\n<td>Monitor concurrent request rate vs pool size</td>\n<td>Increase <code>MaxWarmInstances</code> or implement request queuing</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"component-design-request-routing\">Component Design: Request Routing</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 4</p>\n</blockquote>\n<p>The request routing component serves as the system&#39;s <strong>front door</strong>—it receives incoming function invocation requests, determines which function instance should handle each request, manages request flow when all instances are busy, and ensures reliable delivery even during scaling events and failures. This component bridges external HTTP traffic with the internal execution infrastructure, making critical decisions about load distribution, timeout handling, and concurrency management.</p>\n<h3 id=\"mental-model-the-restaurant-host-and-waitlist\">Mental Model: The Restaurant Host and Waitlist</h3>\n<p>Imagine a popular restaurant with multiple identical dining rooms (function instances). When customers (requests) arrive, they&#39;re greeted by a host (gateway) who must decide:</p>\n<ol>\n<li><p><strong>Which dining room to seat them in</strong>: The host looks at currently available rooms (warm instances) that match the requested cuisine type (function). If multiple rooms are available, the host uses a strategy (load balancing) to distribute customers evenly.</p>\n</li>\n<li><p><strong>What to do when all rooms are full</strong>: The host maintains a waitlist (request queue) where new arrivals wait for the next available room. The waitlist has limited capacity to prevent overcrowding in the entrance area (memory exhaustion).</p>\n</li>\n<li><p><strong>When to turn customers away</strong>: If the waitlist is full, or if customers have been waiting too long (timeout), the host politely informs them they cannot be served today (returns an error).</p>\n</li>\n<li><p><strong>How to handle special requests</strong>: Some customers request a specific room they&#39;ve used before (sticky routing for stateful functions), while others don&#39;t care. Some customers want to wait for their meal (synchronous invocation), while others leave their phone number and want to be called when it&#39;s ready (asynchronous invocation).</p>\n</li>\n</ol>\n<p>This mental model captures the core responsibilities of request routing: <strong>matching</strong>, <strong>queueing</strong>, <strong>timeout management</strong>, and <strong>load distribution</strong> while maintaining system stability under varying load.</p>\n<h3 id=\"gateway-api-and-internal-routing\">Gateway API and Internal Routing</h3>\n<p>The gateway exposes a simple HTTP API that accepts function invocation requests and routes them to appropriate function instances. Internally, it implements a sophisticated routing engine that considers instance availability, load, and health status.</p>\n<h4 id=\"public-http-gateway-api\">Public HTTP Gateway API</h4>\n<p>The gateway accepts HTTP POST requests at <code>/invoke/{functionName}</code> with the following characteristics:</p>\n<table>\n<thead>\n<tr>\n<th>Request Component</th>\n<th>Specification</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>URL Path</strong></td>\n<td><code>/invoke/{functionName}[:{versionTag}]</code></td>\n<td>Identifies the target function and optional version (default: latest)</td>\n</tr>\n<tr>\n<td><strong>HTTP Method</strong></td>\n<td>POST</td>\n<td>All invocation types use POST to include payload</td>\n</tr>\n<tr>\n<td><strong>Headers</strong></td>\n<td><code>X-Function-Timeout</code>: Override default timeout (milliseconds)<br><code>X-Synchronous</code>: &quot;true&quot;/&quot;false&quot; (default: true)<br><code>X-Callback-URL</code>: For async invocations<br><code>X-Request-ID</code>: Client-provided correlation ID</td>\n<td>Control invocation behavior and metadata</td>\n</tr>\n<tr>\n<td><strong>Body</strong></td>\n<td>Arbitrary bytes (content-type preserved)</td>\n<td>Function input payload</td>\n</tr>\n<tr>\n<td><strong>Query Params</strong></td>\n<td><code>async=true</code>, <code>timeout=5000</code>, <code>version=v1.2</code></td>\n<td>Alternative to headers for simpler clients</td>\n</tr>\n</tbody></table>\n<p>The gateway returns:</p>\n<ul>\n<li><strong>200 OK</strong> with function output in body for synchronous invocations</li>\n<li><strong>202 Accepted</strong> with <code>X-Request-ID</code> for asynchronous invocations</li>\n<li><strong>429 Too Many Requests</strong> when request queue is full</li>\n<li><strong>503 Service Unavailable</strong> when function is scaling or unhealthy</li>\n<li><strong>504 Gateway Timeout</strong> when function execution exceeds timeout</li>\n</ul>\n<h4 id=\"internal-routing-mechanism\">Internal Routing Mechanism</h4>\n<p>When a request arrives, the gateway follows this routing pipeline:</p>\n<ol>\n<li><strong>Request Validation</strong>: Parse and validate the function name, version, timeout, and payload size.</li>\n<li><strong>Function Resolution</strong>: Resolve the function name to a specific <code>FunctionDefinition</code> and check if it&#39;s active.</li>\n<li><strong>Instance Selection</strong>: Use the load balancing strategy to select an appropriate <code>FunctionInstance</code>.</li>\n<li><strong>Queue Management</strong>: If no instances are available, attempt to queue the request (if synchronous and queue not full).</li>\n<li><strong>Request Forwarding</strong>: Forward the request to the selected instance via HTTP or gRPC.</li>\n<li><strong>Response Handling</strong>: Collect the response, apply any transformations, and return to client.</li>\n<li><strong>Error Recovery</strong>: Handle instance failures with retries (when appropriate) and circuit breaking.</li>\n</ol>\n<p>The internal routing table maintains a mapping from function name to available instances:</p>\n<table>\n<thead>\n<tr>\n<th>Routing Table Entry Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>FunctionName</code></td>\n<td><code>string</code></td>\n<td>Unique function identifier</td>\n</tr>\n<tr>\n<td><code>ActiveInstances</code></td>\n<td><code>[]*FunctionInstance</code></td>\n<td>Instances in <code>InstanceStateWarm</code> or <code>InstanceStateActive</code> state</td>\n</tr>\n<tr>\n<td><code>PendingRequests</code></td>\n<td><code>*RequestQueue</code></td>\n<td>Queue of requests waiting for instances</td>\n</tr>\n<tr>\n<td><code>ConcurrentInvocations</code></td>\n<td><code>int</code></td>\n<td>Current number of in-flight requests</td>\n</tr>\n<tr>\n<td><code>MaxConcurrency</code></td>\n<td><code>int</code></td>\n<td>Maximum concurrent executions allowed</td>\n</tr>\n<tr>\n<td><code>CircuitBreaker</code></td>\n<td><code>*CircuitBreaker</code></td>\n<td>Tracks instance health for fail-fast behavior</td>\n</tr>\n<tr>\n<td><code>LastScaleUpTime</code></td>\n<td><code>time.Time</code></td>\n<td>When last scale-up occurred (for cooldown)</td>\n</tr>\n</tbody></table>\n<h4 id=\"instance-selection-algorithm\">Instance Selection Algorithm</h4>\n<p>The instance selection process follows these steps:</p>\n<ol>\n<li><strong>Filter by state</strong>: Only consider instances with <code>IsActive() == true</code> (typically <code>InstanceStateWarm</code> or <code>InstanceStateActive</code> but not <code>InstanceStateDraining</code>).</li>\n<li><strong>Apply stickiness</strong>: If <code>InvocationRequest.PreferredInstanceID</code> is set and that instance is active, use it (for stateful functions).</li>\n<li><strong>Check circuit breakers</strong>: Skip instances marked as unhealthy (recent failures exceed threshold).</li>\n<li><strong>Apply load balancing strategy</strong>: Use the configured strategy (round-robin, least-connections, etc.) to select from remaining instances.</li>\n<li><strong>Fallback to queuing</strong>: If no instances available, attempt to queue (for synchronous requests) or immediately fail (for async if no retry capacity).</li>\n</ol>\n<h4 id=\"request-queue-design\">Request Queue Design</h4>\n<p>The request queue buffers incoming requests when all instances are busy. It&#39;s implemented as a bounded priority queue:</p>\n<table>\n<thead>\n<tr>\n<th>Queue Characteristic</th>\n<th>Specification</th>\n<th>Rationale</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Maximum Size</strong></td>\n<td>Configurable per function (default: 100)</td>\n<td>Prevents memory exhaustion during traffic spikes</td>\n</tr>\n<tr>\n<td><strong>Priority Scheme</strong></td>\n<td>FIFO with optional priority based on timeout</td>\n<td>Ensures fairness; requests with earlier deadlines get priority</td>\n</tr>\n<tr>\n<td><strong>Eviction Policy</strong></td>\n<td>Oldest requests evicted when queue full (configurable)</td>\n<td>Better to fail fast than stall entire system</td>\n</tr>\n<tr>\n<td><strong>Queue Drain</strong></td>\n<td>On scale-up, drain queue to new instances</td>\n<td>Utilizes new capacity immediately</td>\n</tr>\n<tr>\n<td><strong>Monitoring</strong></td>\n<td>Queue depth, wait time, eviction count metrics</td>\n<td>Essential for capacity planning</td>\n</tr>\n</tbody></table>\n<h3 id=\"adr-load-balancing-strategy\">ADR: Load Balancing Strategy</h3>\n<blockquote>\n<p><strong>Decision: Least-Connections with Circuit Breaking</strong></p>\n<ul>\n<li><strong>Context</strong>: We need to distribute requests across multiple function instances to maximize throughput, minimize latency, and handle instance failures gracefully. The strategy must work with auto-scaling (instances come and go) and support both stateless and stateful functions.</li>\n<li><strong>Options Considered</strong>:<ol>\n<li><strong>Round-Robin</strong>: Simple rotation through available instances</li>\n<li><strong>Least-Connections</strong>: Send to instance with fewest active requests</li>\n<li><strong>Consistent Hashing</strong>: Map requests to specific instances based on request attributes</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Least-connections as the default, with optional consistent hashing for stateful functions via <code>PreferredInstanceID</code>.</li>\n<li><strong>Rationale</strong>: Least-connections naturally balances load when instances have variable execution times (common in serverless). It prevents overloading slow instances and works well with auto-scaling as new instances start with zero connections. Round-robin can overload instances processing long requests. Consistent hashing adds complexity but is valuable for stateful functions, which we support through explicit instance preference rather than automatic hashing.</li>\n<li><strong>Consequences</strong>: Requires tracking active invocation count per instance (already needed for scaling). Adds slight overhead vs. round-robin but provides better load distribution. Stateful functions need client cooperation to specify preferred instance.</li>\n</ul>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Option</th>\n<th>Pros</th>\n<th>Cons</th>\n<th>Chosen?</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Round-Robin</strong></td>\n<td>Simple, predictable, no state needed</td>\n<td>Can overload instances with long-running requests, doesn&#39;t account for instance capacity differences</td>\n<td>No (fallback when connection counts unavailable)</td>\n</tr>\n<tr>\n<td><strong>Least-Connections</strong></td>\n<td>Adapts to instance performance variations, naturally balances load, works well with auto-scaling</td>\n<td>Requires tracking per-instance invocation counts, slightly more complex</td>\n<td><strong>Yes</strong> (default strategy)</td>\n</tr>\n<tr>\n<td><strong>Consistent Hashing</strong></td>\n<td>Enables sticky sessions for stateful functions, good cache locality</td>\n<td>Complex implementation, rehashing on scale events disrupts stickiness, uneven load distribution</td>\n<td>Partially (via <code>PreferredInstanceID</code> for explicit stickiness)</td>\n</tr>\n</tbody></table>\n<h3 id=\"common-pitfalls-in-request-routing\">Common Pitfalls in Request Routing</h3>\n<p>⚠️ <strong>Pitfall: Unbounded Queue Growth</strong></p>\n<ul>\n<li><strong>Description</strong>: Allowing request queues to grow without limits during traffic spikes.</li>\n<li><strong>Why it&#39;s wrong</strong>: Exhausts system memory, increases latency unpredictably, and can cause cascading failures when queues consume all available RAM.</li>\n<li><strong>How to avoid</strong>: Implement <strong>bounded queues</strong> with configurable maximum size per function. Monitor queue depth and implement queue pressure signals to upstream clients (HTTP 429). Consider multiple queue tiers: in-memory for short bursts, disk-backed for important async workloads.</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Thundering Herd on Scale-Up</strong></p>\n<ul>\n<li><strong>Description</strong>: When a function scales from zero, all queued requests simultaneously rush to the single new instance, overwhelming it.</li>\n<li><strong>Why it&#39;s wrong</strong>: Causes immediate timeout or failure of the new instance, triggering unhealthy marks and potential scale oscillation.</li>\n<li><strong>How to avoid</strong>: Implement <strong>gradual queue draining</strong> - release requests to new instances at a controlled rate (e.g., max N per second). Use <strong>per-instance concurrency limits</strong> to prevent overloading single instances. Consider <strong>delayed scaling</strong> where you wait for multiple instances before draining queue.</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Improper Timeout Handling</strong></p>\n<ul>\n<li><strong>Description</strong>: Not propagating or respecting timeouts correctly through the routing chain.</li>\n<li><strong>Why it&#39;s wrong</strong>: Client receives timeout after function continues executing (wasting resources), or function times out before client deadline causing unnecessary retries.</li>\n<li><strong>How to avoid</strong>: Implement <strong>timeout deadline propagation</strong> from client request through all routing layers to function execution. Use a <strong>timeout hierarchy</strong>: client timeout &gt; gateway timeout &gt; function timeout. Always cancel downstream operations when upstream timeout occurs.</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Ignoring Cold Start Latency in Routing Decisions</strong></p>\n<ul>\n<li><strong>Description</strong>: Routing requests to cold instances when warm ones are available, or not accounting for cold start time in queue wait calculations.</li>\n<li><strong>Why it&#39;s wrong</strong>: Increases tail latency unpredictably, especially for low-traffic functions.</li>\n<li><strong>How to avoid</strong>: Track instance <strong>warm/cold status</strong> and prefer warm instances. Adjust queue timeout calculations to include estimated cold start time. Implement <strong>predictive pre-warming</strong> based on queue depth and historical patterns.</li>\n</ul>\n<p>⚠️ <strong>Pitfall: No Circuit Breaking for Unhealthy Instances</strong></p>\n<ul>\n<li><strong>Description</strong>: Continuing to route requests to instances that are failing or slow.</li>\n<li><strong>Why it&#39;s wrong</strong>: Degrades overall system performance, amplifies failures, and creates negative user experience.</li>\n<li><strong>How to avoid</strong>: Implement <strong>circuit breaker pattern</strong> per instance: track failure rates and temporarily remove instances from rotation after threshold breaches. Combine with health checks for proactive failure detection. Allow <strong>gradual recovery</strong> (probation period) for healed instances.</li>\n</ul>\n<h3 id=\"implementation-guidance-for-routing\">Implementation Guidance for Routing</h3>\n<h4 id=\"technology-recommendations-table\">Technology Recommendations Table</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n<th>Recommendation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>HTTP Gateway</strong></td>\n<td>Go <code>net/http</code> with middleware</td>\n<td><code>gorilla/mux</code> for routing, <code>chi</code> for middleware</td>\n<td><code>net/http</code> with custom routing (keeps dependencies minimal)</td>\n</tr>\n<tr>\n<td><strong>Load Balancer</strong></td>\n<td>In-memory round-robin</td>\n<td>Distributed consistent hashing with rendezvous hashing</td>\n<td>Least-connections with atomic counters</td>\n</tr>\n<tr>\n<td><strong>Request Queue</strong></td>\n<td>Go channel with buffer</td>\n<td>Disk-backed queue (Redis, Kafka) for persistence</td>\n<td>Bounded channel queue with priority via heap</td>\n</tr>\n<tr>\n<td><strong>Circuit Breaker</strong></td>\n<td>Simple counter with timeout</td>\n<td>Adaptive breaker with rolling windows</td>\n<td><code>github.com/sony/gobreaker</code> or similar</td>\n</tr>\n<tr>\n<td><strong>Metrics</strong></td>\n<td>Prometheus counters/gauges</td>\n<td>Distributed tracing (OpenTelemetry)</td>\n<td>Prometheus for metrics, context propagation for traces</td>\n</tr>\n</tbody></table>\n<h4 id=\"recommended-filemodule-structure\">Recommended File/Module Structure</h4>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>project-root/\n  cmd/\n    gateway/                    # Gateway entry point\n      main.go                   # Starts HTTP gateway server\n  internal/\n    gateway/                    # Request routing component\n      gateway.go                # Main gateway struct and HTTP handlers\n      router.go                 # Routing logic and load balancing\n      queue/                    # Request queue implementation\n        queue.go                # Bounded priority queue\n        manager.go              # Queue lifecycle management\n      circuit/                  # Circuit breaker implementation\n        breaker.go              # Circuit breaker logic\n        health_check.go         # Instance health checks\n      middleware/               # HTTP middleware\n        logging.go              # Request logging\n        metrics.go              # Prometheus metrics\n        timeout.go              # Deadline propagation\n      api/                      # Gateway API definitions\n        models.go               # Request/response types\n        errors.go               # Gateway-specific errors\n    controller/                 # (Referenced, not in this component)\n    worker/                     # (Referenced, not in this component)\n    types/                      # Shared types (already defined)</code></pre></div>\n\n<h4 id=\"infrastructure-starter-code\">Infrastructure Starter Code</h4>\n<p><strong>Complete HTTP Gateway Server</strong> (ready to use):</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/gateway/gateway.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> gateway</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">encoding/json</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">strconv</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourproject/internal/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/prometheus/client_golang/prometheus</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/prometheus/client_golang/prometheus/promhttp</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Gateway is the main HTTP gateway for function invocations</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Gateway</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    router         </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Router</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    queueManager   </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">queue</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Manager</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    metrics        </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">gatewayMetrics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    config         </span><span style=\"color:#B392F0\">GatewayConfig</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    server         </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Server</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GatewayConfig holds gateway configuration</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> GatewayConfig</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Addr                 </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MaxRequestBodyBytes  </span><span style=\"color:#F97583\">int64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DefaultTimeout       </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EnableMetrics        </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MetricsPath          </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    HealthCheckPath      </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// gatewayMetrics holds Prometheus metrics for the gateway</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> gatewayMetrics</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    requestsTotal      </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterVec</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    requestDuration    </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HistogramVec</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    queueDepth         </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">GaugeVec</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    activeInvocations  </span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Gauge</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    errorsTotal        </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterVec</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewGateway creates a new gateway instance</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewGateway</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">router</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">Router</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">qm</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">queue</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Manager</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">config</span><span style=\"color:#B392F0\"> GatewayConfig</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Gateway</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    gm </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">gatewayMetrics</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        requestsTotal: prometheus.</span><span style=\"color:#B392F0\">NewCounterVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name: </span><span style=\"color:#9ECBFF\">\"gateway_requests_total\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help: </span><span style=\"color:#9ECBFF\">\"Total number of HTTP requests processed\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"method\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"status\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        requestDuration: prometheus.</span><span style=\"color:#B392F0\">NewHistogramVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HistogramOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name:    </span><span style=\"color:#9ECBFF\">\"gateway_request_duration_seconds\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help:    </span><span style=\"color:#9ECBFF\">\"HTTP request duration in seconds\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Buckets: prometheus.DefBuckets,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"method\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        queueDepth: prometheus.</span><span style=\"color:#B392F0\">NewGaugeVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">GaugeOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name: </span><span style=\"color:#9ECBFF\">\"gateway_queue_depth\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help: </span><span style=\"color:#9ECBFF\">\"Current depth of request queues\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        activeInvocations: prometheus.</span><span style=\"color:#B392F0\">NewGauge</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">GaugeOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name: </span><span style=\"color:#9ECBFF\">\"gateway_active_invocations\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help: </span><span style=\"color:#9ECBFF\">\"Number of currently active function invocations\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        errorsTotal: prometheus.</span><span style=\"color:#B392F0\">NewCounterVec</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            prometheus</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CounterOpts</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Name: </span><span style=\"color:#9ECBFF\">\"gateway_errors_total\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Help: </span><span style=\"color:#9ECBFF\">\"Total number of gateway errors by type\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error_type\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    prometheus.</span><span style=\"color:#B392F0\">MustRegister</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        gm.requestsTotal,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        gm.requestDuration,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        gm.queueDepth,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        gm.activeInvocations,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        gm.errorsTotal,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Gateway</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        router:       router,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        queueManager: qm,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        metrics:      gm,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        config:       config,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Start begins serving HTTP requests</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">g </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Gateway</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Start</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">NewServeMux</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Main invocation endpoint</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/invoke/\"</span><span style=\"color:#E1E4E8\">, g.invokeHandler)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Health check endpoint</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(g.config.HealthCheckPath, </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(http.StatusOK)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        w.</span><span style=\"color:#B392F0\">Write</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"OK\"</span><span style=\"color:#E1E4E8\">))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Metrics endpoint (optional)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> g.config.EnableMetrics {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(g.config.MetricsPath, promhttp.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Apply middleware chain</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    handler </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> g.</span><span style=\"color:#B392F0\">applyMiddleware</span><span style=\"color:#E1E4E8\">(mux)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    g.server </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Server</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Addr:         g.config.Addr,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Handler:      handler,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ReadTimeout:  </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        WriteTimeout: </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> g.server.</span><span style=\"color:#B392F0\">ListenAndServe</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Shutdown gracefully stops the gateway</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">g </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Gateway</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Shutdown</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> g.server.</span><span style=\"color:#B392F0\">Shutdown</span><span style=\"color:#E1E4E8\">(ctx)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// applyMiddleware chains middleware in correct order</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">g </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Gateway</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">applyMiddleware</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">h</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Order matters: last added = first executed</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> timeoutMiddleware</span><span style=\"color:#E1E4E8\">(g.config.DefaultTimeout)(h)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> metricsMiddleware</span><span style=\"color:#E1E4E8\">(g.metrics)(h)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> loggingMiddleware</span><span style=\"color:#E1E4E8\">()(h)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> recoveryMiddleware</span><span style=\"color:#E1E4E8\">()(h)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> sizeLimitMiddleware</span><span style=\"color:#E1E4E8\">(g.config.MaxRequestBodyBytes)(h)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> h</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// invokeHandler handles /invoke/{functionName} requests</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">g </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Gateway</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">invokeHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    start </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Extract function name from path</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    functionName </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> extractFunctionName</span><span style=\"color:#E1E4E8\">(r.URL.Path)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> functionName </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#9ECBFF\">\"Function name required\"</span><span style=\"color:#E1E4E8\">, http.StatusBadRequest)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Parse invocation parameters</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> g.</span><span style=\"color:#B392F0\">parseInvocationRequest</span><span style=\"color:#E1E4E8\">(r, functionName)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(w, err.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(), http.StatusBadRequest)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Route the request</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    resp, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> g.router.</span><span style=\"color:#B392F0\">Route</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">(), req)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Record metrics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    status </span><span style=\"color:#F97583\">:=</span><span style=\"color:#9ECBFF\"> \"200\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        status </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> errorToStatusCode</span><span style=\"color:#E1E4E8\">(err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    g.metrics.requestsTotal.</span><span style=\"color:#B392F0\">WithLabelValues</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        functionName, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        r.Method, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        status,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ).</span><span style=\"color:#B392F0\">Inc</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    g.metrics.requestDuration.</span><span style=\"color:#B392F0\">WithLabelValues</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        functionName, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        r.Method,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ).</span><span style=\"color:#B392F0\">Observe</span><span style=\"color:#E1E4E8\">(time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(start).</span><span style=\"color:#B392F0\">Seconds</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Write response</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        g.</span><span style=\"color:#B392F0\">writeError</span><span style=\"color:#E1E4E8\">(w, err)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/octet-stream\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Request-ID\"</span><span style=\"color:#E1E4E8\">, resp.RequestID)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Instance-ID\"</span><span style=\"color:#E1E4E8\">, resp.InstanceID)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(http.StatusOK)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Write</span><span style=\"color:#E1E4E8\">(resp.Payload)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Helper functions (implemented elsewhere)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> extractFunctionName</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">path</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#6A737D\">/* implementation */</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">g </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Gateway</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">parseInvocationRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">fn</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) { </span><span style=\"color:#6A737D\">/* implementation */</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> errorToStatusCode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#6A737D\">/* implementation */</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">g </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Gateway</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">writeError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">) { </span><span style=\"color:#6A737D\">/* implementation */</span><span style=\"color:#E1E4E8\"> }</span></span></code></pre></div>\n\n<h4 id=\"core-logic-skeleton-code\">Core Logic Skeleton Code</h4>\n<p><strong>Router with Least-Connections Load Balancing</strong>:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/gateway/router.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> gateway</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync/atomic</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourproject/internal/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Router manages routing of invocation requests to function instances</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Router</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu              </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">RWMutex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    functions       </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">functionRoutingTable</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    instanceManager </span><span style=\"color:#B392F0\">InstanceManager</span><span style=\"color:#6A737D\"> // Interface to manage instances</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    config          </span><span style=\"color:#B392F0\">RouterConfig</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// functionRoutingTable tracks instances and routing state for a single function</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> functionRoutingTable</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    functionName     </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    instances        []</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">routedInstance</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    concurrencyLimit </span><span style=\"color:#F97583\">int32</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    activeCount      </span><span style=\"color:#F97583\">int32</span><span style=\"color:#6A737D\"> // Atomic counter</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    circuitBreaker   </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">circuit</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Breaker</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    lastScaleUpTime  </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// routedInstance wraps a FunctionInstance with routing metadata</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> routedInstance</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    instance      </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionInstance</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    activeReqs    </span><span style=\"color:#F97583\">int32</span><span style=\"color:#6A737D\"> // Atomic counter for least-connections</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    lastUsed      </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    failures      </span><span style=\"color:#F97583\">int32</span><span style=\"color:#6A737D\"> // Recent failure count for circuit breaking</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    healthy       </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RouterConfig holds routing configuration</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RouterConfig</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DefaultConcurrencyLimit </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CircuitBreakerThreshold </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CircuitBreakerTimeout   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    StickySessionTTL        </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewRouter creates a new router</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewRouter</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">im</span><span style=\"color:#B392F0\"> InstanceManager</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">config</span><span style=\"color:#B392F0\"> RouterConfig</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Router</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Router</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        functions:       </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">functionRoutingTable</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        instanceManager: im,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        config:          config,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Route routes an invocation request to an appropriate instance</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">r </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Router</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Route</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationResponse</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Validate request is not expired (check req.IsExpired())</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Lookup or create routing table for this function (use getOrCreateRoutingTable)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Check if function is at concurrency limit (compare activeCount vs limit)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: If at limit and request is synchronous, attempt to queue (via queueManager)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Select instance using least-connections strategy (call selectInstance)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: If no instance available but can scale, trigger scale-up and queue request</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 7: Forward request to selected instance (call forwardRequest)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 8: On success, update instance metrics and return response</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 9: On failure, mark instance unhealthy, update circuit breaker, and retry if appropriate</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 10: Ensure atomic updates to activeCount and instance activeReqs counters</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Use context.WithTimeout to ensure forwarding doesn't exceed request deadline</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Implement retry logic only for idempotent operations (check request metadata)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not implemented\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// selectInstance chooses an instance using least-connections strategy</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">r </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Router</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">selectInstance</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">rt</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">functionRoutingTable</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">routedInstance</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    r.mu.</span><span style=\"color:#B392F0\">RLock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> r.mu.</span><span style=\"color:#B392F0\">RUnlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Filter instances to only healthy, active ones (InstanceStateWarm or InstanceStateActive)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: If req.PreferredInstanceID is set, try to use that instance if available and healthy</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Among remaining instances, find the one with lowest activeReqs count</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Handle tie-breakers (e.g., oldest instance, most recently used)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: If no instances available, return appropriate error (ErrNoInstancesAvailable)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Increment the selected instance's activeReqs count atomically</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Use atomic.LoadInt32 to read counters without full lock</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Consider weighted least-connections if instances have different capacities</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not implemented\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// forwardRequest sends the request to a specific instance</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">r </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Router</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">forwardRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">instance</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">routedInstance</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationResponse</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Build HTTP/gRPC request to instance endpoint (instance.instance.Host:Port)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Copy original request headers and body</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Propagate timeout: calculate remaining time from ctx.Deadline()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Send request and await response</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Parse response into InvocationResponse struct</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Handle transport errors (network issues) vs. function errors (returned in response)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 7: Update instance.lastUsed timestamp on success</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 8: On timeout, cancel the request and mark instance for health check</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Use http.Client with timeout or context-aware transport</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Consider connection pooling to instances for performance</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not implemented\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// updateInstanceHealth updates circuit breaker based on success/failure</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">r </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Router</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">updateInstanceHealth</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">instance</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">routedInstance</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">success</span><span style=\"color:#F97583\"> bool</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: If success, reset failure count and mark healthy</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: If failure, increment failure count atomically</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: If failure count exceeds threshold, mark instance unhealthy</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Schedule health check for unhealthy instances after timeout</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Notify instance manager to potentially terminate and replace instance</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Use exponential backoff for health check retries</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Bounded Priority Request Queue</strong>:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/gateway/queue/queue.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> queue</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">container/heap</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourproject/internal/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// QueuedRequest represents a request waiting for an instance</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> QueuedRequest</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Request    </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationRequest</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EnqueuedAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Priority   </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\"> // Lower number = higher priority</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    index      </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\"> // Required by heap.Interface</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RequestQueue implements a bounded priority queue</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RequestQueue</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu       </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Mutex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    heap     </span><span style=\"color:#B392F0\">requestHeap</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    maxSize  </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    notEmpty </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Cond</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    notFull  </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Cond</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    closed   </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewRequestQueue creates a new bounded priority queue</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewRequestQueue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">maxSize</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RequestQueue</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    q </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">RequestQueue</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        heap:    </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">requestHeap</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        maxSize: maxSize,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    q.notEmpty </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> sync.</span><span style=\"color:#B392F0\">NewCond</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">q.mu)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    q.notFull </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> sync.</span><span style=\"color:#B392F0\">NewCond</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">q.mu)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    heap.</span><span style=\"color:#B392F0\">Init</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">q.heap)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> q</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Enqueue adds a request to the queue with timeout</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">q </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RequestQueue</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Enqueue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">QueuedRequest</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    q.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Wait for queue not full with context timeout (use waitWithTimeout helper)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: If queue is closed, return ErrQueueClosed</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Set req.EnqueuedAt = time.Now()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Push request onto heap (heap.Push)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Signal notEmpty condition variable</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Update queue depth metrics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Calculate priority based on req.Request.TimeRemaining() - shorter remaining time = higher priority</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    q.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Dequeue removes and returns the highest priority request</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">q </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RequestQueue</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Dequeue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">QueuedRequest</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    q.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> q.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Wait for queue not empty with context timeout</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: If queue is closed, return ErrQueueClosed</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Pop highest priority request from heap (heap.Pop)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Signal notFull condition variable</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Update queue depth metrics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Check if request has expired (req.Request.IsExpired()) - if so, discard and retry</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Implement loop that skips expired requests until finding valid one or queue empty</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RemoveExpired removes and returns count of expired requests</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">q </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RequestQueue</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RemoveExpired</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">deadline</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Iterate through heap (without removing)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Find requests where req.Request.Deadline.Before(deadline)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Remove them from heap (maintaining heap property)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Return count of removed requests</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Update metrics for expired requests</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hint: Build list of indices to remove, then rebuild heap or use heap.Remove</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> 0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// requestHeap implements heap.Interface for priority queue</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> requestHeap</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">QueuedRequest</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#B392F0\">requestHeap</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Len</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\">           { </span><span style=\"color:#F97583\">return</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(h) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#B392F0\">requestHeap</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Less</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">i</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">j</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> h[i].Priority </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> h[j].Priority }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#B392F0\">requestHeap</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Swap</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">i</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">j</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">)      { h[i], h[j] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> h[j], h[i]; h[i].index </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> i; h[j].index </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> j }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">requestHeap</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Push</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">x</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\">{}) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    n </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">h)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    item </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> x.(</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">QueuedRequest</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    item.index </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> n</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    *</span><span style=\"color:#E1E4E8\">h </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> append</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">h, item)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">requestHeap</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Pop</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">interface</span><span style=\"color:#E1E4E8\">{} {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    old </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\">h</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    n </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(old)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    item </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> old[n</span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    item.index </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> -</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    *</span><span style=\"color:#E1E4E8\">h </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> old[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\"> : n</span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> item</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"language-specific-hints\">Language-Specific Hints</h4>\n<p><strong>Go-Specific Implementation Tips</strong>:</p>\n<ol>\n<li><p><strong>Concurrency Control</strong>: Use <code>sync.RWMutex</code> for routing table (many reads, few writes). Use <code>atomic</code> operations for instance request counters to avoid lock contention on hot paths.</p>\n</li>\n<li><p><strong>Context Propagation</strong>: Always pass <code>context.Context</code> through function calls. Use <code>context.WithTimeout</code> to enforce deadlines. Check <code>ctx.Err()</code> before starting expensive operations.</p>\n</li>\n<li><p><strong>HTTP Client Pooling</strong>: Create a shared <code>http.Client</code> with <code>Transport: &amp;http.Transport{MaxIdleConnsPerHost: 100}</code> to reuse connections to function instances.</p>\n</li>\n<li><p><strong>Channel-based Queue Alternative</strong>: For simpler implementations, use buffered channels as bounded queues: <code>make(chan *QueuedRequest, maxSize)</code>. Use <code>select</code> with <code>ctx.Done()</code> for timeouts.</p>\n</li>\n<li><p><strong>Prometheus Metrics</strong>: Register metrics once, use <code>WithLabelValues</code> for dynamic labels. Consider using <code>promauto</code> for automatic registration.</p>\n</li>\n<li><p><strong>Graceful Shutdown</strong>: Implement <code>Shutdown(ctx context.Context)</code> method that stops accepting new requests, waits for in-flight requests, and drains queues with context timeout.</p>\n</li>\n<li><p><strong>Connection Management</strong>: Use <code>http.Client.Timeout</code> and <code>DialContext</code> for fine-grained control. Consider implementing connection health checks with <code>Transport.IdleConnTimeout</code>.</p>\n</li>\n</ol>\n<h4 id=\"milestone-checkpoint\">Milestone Checkpoint</h4>\n<p>After implementing request routing, verify functionality with these tests:</p>\n<ol>\n<li><strong>Basic Routing Test</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">   # Start gateway on port 8080</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   go</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#9ECBFF\"> cmd/gateway/main.go</span><span style=\"color:#79B8FF\"> --addr</span><span style=\"color:#9ECBFF\"> :8080</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">   </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">   # Send test request</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/invoke/myFunction</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -d</span><span style=\"color:#9ECBFF\"> '{\"test\": \"data\"}'</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -v</span></span></code></pre></div>\n<p>   <strong>Expected</strong>: Gateway starts, accepts request, returns 503 (no instances available yet).</p>\n<ol start=\"2\">\n<li><strong>Queue Test</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">   # Configure function with max concurrency 1, queue size 5</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">   # Start one instance, send 3 concurrent requests</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   ab</span><span style=\"color:#79B8FF\"> -n</span><span style=\"color:#79B8FF\"> 3</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#79B8FF\"> 3</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#9ECBFF\"> test.json</span><span style=\"color:#79B8FF\"> -T</span><span style=\"color:#9ECBFF\"> application/json</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">     http://localhost:8080/invoke/myFunction</span></span></code></pre></div>\n<p>   <strong>Expected</strong>: One request executes immediately, two queue. Check logs for queue depth metrics.</p>\n<ol start=\"3\">\n<li><strong>Load Balancing Verification</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">   # Start 3 instances, send 10 requests</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">   for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> {</span><span style=\"color:#B392F0\">1..10}</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">     curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/invoke/myFunction</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> \"req-</span><span style=\"color:#E1E4E8\">$i</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\"> &#x26;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">   done</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">   wait</span></span></code></pre></div>\n<p>   <strong>Expected</strong>: Requests distributed across instances (check instance logs). Roughly equal distribution with least-connections.</p>\n<ol start=\"4\">\n<li><strong>Timeout Test</strong>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">   # Set function timeout to 1s, send request that sleeps 2s</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/invoke/slowFunction</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -H</span><span style=\"color:#9ECBFF\"> \"X-Function-Timeout: 1000\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">     -d</span><span style=\"color:#9ECBFF\"> '{\"sleep\": 2000}'</span></span></code></pre></div>\n<p>   <strong>Expected</strong>: Request times out after 1s with 504 status or function error response.</p>\n<p><strong>Signs of Correct Implementation</strong>:</p>\n<ul>\n<li>Gateway starts without errors and binds to configured port</li>\n<li>Request logs show routing decisions (instance selection, queueing)</li>\n<li>Prometheus metrics show request counts, durations, queue depths</li>\n<li>Multiple instances receive balanced load</li>\n<li>Queue prevents overload when all instances busy</li>\n<li>Timeouts are respected and propagated</li>\n</ul>\n<p><strong>Common Issues and Diagnostics</strong>:</p>\n<ul>\n<li><strong>&quot;Gateway returns 503 immediately&quot;</strong>: Check instance registration with router</li>\n<li><strong>&quot;All requests go to one instance&quot;</strong>: Verify least-connections counters are updating</li>\n<li><strong>&quot;Queue never drains&quot;</strong>: Check scale-up triggers and instance availability</li>\n<li><strong>&quot;Memory grows unbounded&quot;</strong>: Verify queue bounds and request eviction</li>\n<li><strong>&quot;Timeouts not working&quot;</strong>: Check deadline propagation through context chain</li>\n</ul>\n<h2 id=\"component-design-auto-scaling\">Component Design: Auto-Scaling</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 5</p>\n</blockquote>\n<p>The auto-scaling component is the <strong>elastic nervous system</strong> of the serverless runtime—it continuously monitors demand and dynamically adjusts the supply of execution environments to match workload patterns while respecting resource constraints and minimizing costs. This component embodies the core promise of serverless computing: scaling from zero to handle sudden bursts, then scaling back to zero when idle, all without human intervention. Unlike traditional autoscalers that operate on minute-long granularities, serverless auto-scaling must react within seconds to accommodate ephemeral, event-driven workloads while accounting for the latency penalty of <strong>cold starts</strong>.</p>\n<h3 id=\"mental-model-the-elastic-concert-hall\">Mental Model: The Elastic Concert Hall</h3>\n<p>Imagine managing a large concert hall with retractable seating sections. When ticket sales (requests) begin, you start with a minimal central section open. As the queue at the entrance (request queue) grows, you dynamically unfold additional seating sections (function instances) to accommodate more attendees. Each section takes time to deploy (cold start latency), so you monitor the arrival rate and sometimes pre-deploy sections based on historical patterns (predictive warming). When sections remain empty for a configured idle period, you retract them to save on heating and cleaning costs (scale-to-zero). The hall enforces fire code limits (maximum instances) and always keeps a few sections minimally prepared for VIP guests (provisioned concurrency). This elastic capacity management—balancing responsiveness against resource efficiency—captures the essence of auto-scaling in serverless systems.</p>\n<h3 id=\"scaler-interface-and-metrics\">Scaler Interface and Metrics</h3>\n<p>The auto-scaler operates as a control loop that periodically evaluates scaling decisions for each deployed function. It interacts with the <strong>router</strong> (to understand current request load and instance utilization), the <strong>warm pool manager</strong> (to provision or terminate instances), and the <strong>metrics subsystem</strong> (to gather historical data). The core interface abstracts these interactions:</p>\n<table>\n<thead>\n<tr>\n<th>Method Name</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>EvaluateScaling(ctx context.Context, functionName string)</code></td>\n<td><code>functionName</code>: Name of function to evaluate</td>\n<td><code>ScaleDecision</code> (struct containing direction and count)</td>\n<td>Evaluates current metrics against scaling policies to determine if scaling action is needed</td>\n</tr>\n<tr>\n<td><code>RecordInvocationMetric(ctx context.Context, functionName string, timestamp time.Time)</code></td>\n<td><code>functionName</code>: Function identifier, <code>timestamp</code>: When invocation occurred</td>\n<td><code>error</code></td>\n<td>Records an invocation event for rate calculation (called by gateway on each request)</td>\n</tr>\n<tr>\n<td><code>GetFunctionScalingConfig(ctx context.Context, functionName string)</code></td>\n<td><code>functionName</code>: Function identifier</td>\n<td><code>*ScalingConfig</code></td>\n<td>Retrieves scaling configuration (min/max instances, thresholds, cooldowns)</td>\n</tr>\n<tr>\n<td><code>UpdateScalingConfig(ctx context.Context, functionName string, config ScalingConfig)</code></td>\n<td><code>functionName</code>: Function identifier, <code>config</code>: New scaling configuration</td>\n<td><code>error</code></td>\n<td>Updates scaling configuration for a function</td>\n</tr>\n<tr>\n<td><code>StartScalingLoop(ctx context.Context)</code></td>\n<td>None</td>\n<td><code>error</code></td>\n<td>Starts the periodic scaling evaluation loop for all active functions</td>\n</tr>\n<tr>\n<td><code>StopScalingLoop(ctx context.Context)</code></td>\n<td>None</td>\n<td><code>error</code></td>\n<td>Stops the scaling evaluation loop</td>\n</tr>\n</tbody></table>\n<p>The auto-scaler&#39;s decisions are driven by two primary metrics computed over a sliding window (typically 15-60 seconds):</p>\n<ol>\n<li><strong>Request Rate (RPS)</strong>: Invocations per second, measured as a moving average. This indicates demand volume.</li>\n<li><strong>Concurrent Executions</strong>: Number of simultaneously active invocations across all instances of a function. This indicates utilization of existing capacity.</li>\n</ol>\n<p>Additional derived metrics include:</p>\n<ul>\n<li><strong>Queue Depth</strong>: Number of requests waiting in the per-function queue (from the router)</li>\n<li><strong>Instance Utilization</strong>: <code>ConcurrentExecutions / (ActiveInstances * PerInstanceConcurrencyLimit)</code></li>\n<li><strong>Cold Start Ratio</strong>: Percentage of invocations experiencing cold starts</li>\n</ul>\n<p>The core data structure for scaling configuration:</p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>FunctionName</code></td>\n<td><code>string</code></td>\n<td>Name of the function this configuration applies to</td>\n</tr>\n<tr>\n<td><code>MinInstances</code></td>\n<td><code>int</code></td>\n<td>Minimum number of instances to keep running (including warm)</td>\n</tr>\n<tr>\n<td><code>MaxInstances</code></td>\n<td><code>int</code></td>\n<td>Maximum number of instances allowed</td>\n</tr>\n<tr>\n<td><code>TargetConcurrency</code></td>\n<td><code>int</code></td>\n<td>Desired number of concurrent executions per instance (used to calculate desired instance count)</td>\n</tr>\n<tr>\n<td><code>ScaleUpThreshold</code></td>\n<td><code>float64</code></td>\n<td>Utilization threshold (0.0-1.0) that triggers scale-up (e.g., 0.8 = 80% utilization)</td>\n</tr>\n<tr>\n<td><code>ScaleDownThreshold</code></td>\n<td><code>float64</code></td>\n<td>Utilization threshold (0.0-1.0) that triggers scale-down</td>\n</tr>\n<tr>\n<td><code>ScaleUpCooldown</code></td>\n<td><code>time.Duration</code></td>\n<td>Minimum time between scale-up actions (prevents rapid oscillation)</td>\n</tr>\n<tr>\n<td><code>ScaleDownCooldown</code></td>\n<td><code>time.Duration</code></td>\n<td>Minimum time between scale-down actions</td>\n</tr>\n<tr>\n<td><code>IdleTimeout</code></td>\n<td><code>time.Duration</code></td>\n<td>How long an instance must be idle before being considered for termination (scale-to-zero)</td>\n</tr>\n<tr>\n<td><code>WarmPoolSize</code></td>\n<td><code>int</code></td>\n<td>Number of instances to keep in warm pool (provisioned concurrency)</td>\n</tr>\n<tr>\n<td><code>MetricsWindow</code></td>\n<td><code>time.Duration</code></td>\n<td>Time window for calculating metrics (e.g., 30s)</td>\n</tr>\n</tbody></table>\n<h3 id=\"adr-scaling-algorithm-reactive-vs-predictive\">ADR: Scaling Algorithm - Reactive vs. Predictive</h3>\n<blockquote>\n<p><strong>Decision: Threshold-Based Reactive Scaling with Predictive Warming Hints</strong></p>\n<ul>\n<li><strong>Context</strong>: The serverless runtime must scale function instances efficiently under unpredictable, bursty workloads typical of event-driven architectures. We need to choose between simple reactive approaches (responding to current load) and more complex predictive approaches (forecasting future load).</li>\n<li><strong>Options Considered</strong>:<ol>\n<li><strong>Pure Reactive Scaling</strong>: Monitor current metrics (concurrency, queue depth) and scale when thresholds are breached.</li>\n<li><strong>Predictive Scaling</strong>: Use time-series forecasting (ARIMA, ML models) to predict future demand and pre-scale.</li>\n<li><strong>Hybrid Approach</strong>: Reactive scaling as baseline, with simple predictive warming for known patterns.</li>\n</ol>\n</li>\n<li><strong>Decision</strong>: Implement threshold-based reactive scaling with optional predictive warming hints based on time-of-day/day-of-week patterns.</li>\n<li><strong>Rationale</strong>: Pure predictive scaling requires extensive historical data, adds significant complexity, and can be inaccurate for truly sporadic workloads. Reactive scaling is simpler, more robust, and sufficient for most serverless patterns. The hybrid approach gives us the best of both: reliability of reactive scaling with the ability to pre-warm for predictable patterns (like daily cron jobs or business-hour traffic). We avoid full ML-based prediction due to implementation complexity and the &quot;cold start problem&quot; for prediction models themselves.</li>\n<li><strong>Consequences</strong>: <ul>\n<li>Positive: Simpler implementation, easier debugging, robust to unpredictable traffic.</li>\n<li>Negative: May miss optimization opportunities for highly predictable workloads.</li>\n<li>Trade-off: Accept slightly higher cold start latency for truly unpredictable bursts in exchange for system simplicity.</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Option</th>\n<th>Pros</th>\n<th>Cons</th>\n<th>Chosen?</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Pure Reactive Scaling</td>\n<td>Simple to implement, robust, no historical data needed, immediate response to actual load</td>\n<td>Always reacts after load arrives (never pre-warms), can cause latency spikes during sudden bursts</td>\n<td>Partially (as baseline)</td>\n</tr>\n<tr>\n<td>Predictive Scaling</td>\n<td>Can pre-warm before load arrives, minimizes cold starts for predictable patterns</td>\n<td>Complex implementation, requires historical data, prediction inaccuracies can waste resources, &quot;cold start&quot; for the predictor itself</td>\n<td>No</td>\n</tr>\n<tr>\n<td>Hybrid Approach</td>\n<td>Balances simplicity with optimization, can handle both unpredictable and predictable workloads</td>\n<td>More complex than pure reactive, still requires some historical data for predictive part</td>\n<td><strong>Yes</strong></td>\n</tr>\n</tbody></table>\n<p>The scaling algorithm operates as a periodic control loop with the following decision logic (illustrated in the flowchart <code>![Flowchart: Scale-Up Decision Logic](/api/project/serverless-runtime/architecture-doc/asset?path=diagrams%2Fflowchart-scaling-logic.svg)</code>):</p>\n<ol>\n<li><strong>For each active function, every evaluation interval (e.g., 10 seconds):</strong><ol>\n<li>Retrieve current metrics: <code>activeInstances</code>, <code>concurrentExecutions</code>, <code>queueDepth</code></li>\n<li>Calculate desired instances: <code>desired = ceil(concurrentExecutions / targetConcurrency)</code></li>\n<li>Apply bounds: <code>desired = max(minInstances, min(maxInstances, desired))</code></li>\n<li>If <code>desired &gt; activeInstances</code> AND <code>scaleUpCooldown</code> elapsed since last scale-up:<ul>\n<li>Trigger scale-up of <code>(desired - activeInstances)</code> instances</li>\n<li>Record scale-up timestamp</li>\n</ul>\n</li>\n<li>If <code>desired &lt; activeInstances</code> AND <code>scaleDownCooldown</code> elapsed:<ul>\n<li>Identify idle instances (those with <code>IdleDuration() &gt; idleTimeout</code>)</li>\n<li>Mark up to <code>(activeInstances - desired)</code> idle instances as <code>InstanceStateDraining</code></li>\n</ul>\n</li>\n<li>For scale-to-zero: If <code>activeInstances &gt; minInstances</code> AND all instances have been idle beyond <code>idleTimeout</code>:<ul>\n<li>Mark all excess instances as <code>InstanceStateDraining</code></li>\n</ul>\n</li>\n</ol>\n</li>\n</ol>\n<p>The state transitions for scaling actions align with the instance lifecycle shown in <code>![Function Instance Lifecycle](/api/project/serverless-runtime/architecture-doc/asset?path=diagrams%2Finstance-state-machine.svg)</code>:</p>\n<table>\n<thead>\n<tr>\n<th>Current State</th>\n<th>Event</th>\n<th>Next State</th>\n<th>Action Taken</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>InstanceStateWarm</code></td>\n<td>Scale-down signal (instance selected for removal)</td>\n<td><code>InstanceStateDraining</code></td>\n<td>Instance stops accepting new requests, completes in-flight requests</td>\n</tr>\n<tr>\n<td><code>InstanceStateDraining</code></td>\n<td>All in-flight requests completed</td>\n<td><code>InstanceStateTerminated</code></td>\n<td>Container stopped and removed, resources freed</td>\n</tr>\n<tr>\n<td>(No instance exists)</td>\n<td>Scale-up signal (need new instance)</td>\n<td><code>InstanceStateProvisioning</code></td>\n<td><code>CreateContainer</code> called, instance added to warm pool</td>\n</tr>\n</tbody></table>\n<h3 id=\"common-pitfalls-in-auto-scaling\">Common Pitfalls in Auto-Scaling</h3>\n<p>⚠️ <strong>Pitfall: Scaling Thrashing (Rapid Oscillation)</strong></p>\n<ul>\n<li><strong>Description</strong>: The scaler repeatedly adds and removes instances in quick succession due to metrics fluctuating around thresholds.</li>\n<li><strong>Why it&#39;s wrong</strong>: Causes instance churn, increased cold starts, wasted resources on container lifecycle operations, and potential request failures during transitions.</li>\n<li><strong>How to avoid</strong>: Implement cooldown periods (<code>ScaleUpCooldown</code>, <code>ScaleDownCooldown</code>) that prevent another scaling action of the same direction for a minimum time. Use hysteresis by having different thresholds for scale-up (e.g., 80% utilization) and scale-down (e.g., 30% utilization).</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Ignoring Cold Start Latency in Scaling Decisions</strong></p>\n<ul>\n<li><strong>Description</strong>: Scaling logic treats newly provisioned instances as immediately available, but they incur cold start latency (seconds for some runtimes).</li>\n<li><strong>Why it&#39;s wrong</strong>: During rapid traffic increase, newly scaled instances won&#39;t be ready in time to handle the surge, causing queue buildup and timeouts.</li>\n<li><strong>How to avoid</strong>: Incorporate cold start latency into scaling calculations: when scaling up, assume new instances will be unavailable for their runtime&#39;s typical cold start duration. Alternatively, use predictive warming or maintain a small warm buffer.</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Over-Provisioning from Minimum Instance Counts</strong></p>\n<ul>\n<li><strong>Description</strong>: Setting <code>MinInstances &gt; 0</code> for many functions &quot;just to be safe,&quot; leading to constantly running idle instances.</li>\n<li><strong>Why it&#39;s wrong</strong>: Violates the serverless cost model—you pay for idle capacity. For sporadic workloads, this can multiply costs significantly.</li>\n<li><strong>How to avoid</strong>: Default <code>MinInstances</code> to 0. Use <code>WarmPoolSize</code> (provisioned concurrency) only for latency-critical functions with known baseline load. Educate users on the cost-performance trade-off.</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Not Accounting for Burst Traffic Patterns</strong></p>\n<ul>\n<li><strong>Description</strong>: The scaler uses smooth averages (e.g., 30-second RPS) and misses short, intense bursts that arrive and complete within the metrics window.</li>\n<li><strong>Why it&#39;s wrong</strong>: Bursts cause timeouts or dropped requests because scaling doesn&#39;t react quickly enough.</li>\n<li><strong>How to avoid</strong>: Include queue depth as a scaling signal—if queue is growing despite high utilization, scale up immediately. Use shorter metrics windows (e.g., 5 seconds) for highly variable workloads.</li>\n</ul>\n<p>⚠️ <strong>Pitfall: Scale-Down Too Aggressive for Stateful Functions</strong></p>\n<ul>\n<li><strong>Description</strong>: Scaling down instances while they hold in-memory state (caches, WebSocket connections) not meant to be shared across instances.</li>\n<li><strong>Why it&#39;s wrong</strong>: Terminating instances loses state, breaking application logic. Serverless functions should ideally be stateless, but some frameworks encourage in-memory caching for performance.</li>\n<li><strong>How to avoid</strong>: Provide configuration to disable scale-to-zero for stateful functions, or implement graceful shutdown hooks that persist state to external storage before termination.</li>\n</ul>\n<h3 id=\"implementation-guidance-for-auto-scaling\">Implementation Guidance for Auto-Scaling</h3>\n<h4 id=\"a-technology-recommendations-table\">A. Technology Recommendations Table</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Metrics Collection</td>\n<td>In-memory counters with sliding window (Go <code>container/ring</code>)</td>\n<td>Prometheus metrics with custom exporters</td>\n</tr>\n<tr>\n<td>Scaling Loop</td>\n<td>Periodic goroutine with <code>time.Ticker</code></td>\n<td>Kubernetes-style controller pattern with work queue</td>\n</tr>\n<tr>\n<td>Configuration Storage</td>\n<td>In-memory map (for prototype)</td>\n<td>Persistent key-value store (etcd, Redis)</td>\n</tr>\n<tr>\n<td>Predictive Warming</td>\n<td>Time-of-day/day-of-week pattern matching</td>\n<td>ML forecasting (Facebook Prophet, ARIMA)</td>\n</tr>\n</tbody></table>\n<h4 id=\"b-recommended-filemodule-structure\">B. Recommended File/Module Structure</h4>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>project-root/\n  cmd/scaler/main.go                 # Scaler service entry point\n  internal/scaler/\n    scaler.go                        # Main scaling logic and control loop\n    config.go                        # ScalingConfig type and validation\n    metrics.go                       # Metrics collection and calculations\n    predictor.go                     # Simple predictive warming (time-based patterns)\n    scaler_test.go                   # Unit tests\n  internal/gateway/                  # (Existing) - calls RecordInvocationMetric\n  internal/router/                   # (Existing) - provides queue depth and instance counts\n  internal/pool/                     # (Existing) - WarmPoolManager for instance lifecycle</code></pre></div>\n\n<h4 id=\"c-infrastructure-starter-code-metrics-collector\">C. Infrastructure Starter Code (Metrics Collector)</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/scaler/metrics.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> scaler</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">container/ring</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// InvocationEvent records a single function invocation for rate calculation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> InvocationEvent</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Timestamp </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    FunctionName </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// MetricsCollector maintains sliding window metrics for scaling decisions</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> MetricsCollector</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">RWMutex</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Per-function ring buffers of invocation timestamps</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    invocationBuffers </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">ring</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Ring</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    windowSize </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Current concurrency counts</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    concurrency </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">int64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewMetricsCollector creates a collector with specified time window</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewMetricsCollector</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">windowSize</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">MetricsCollector</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">MetricsCollector</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        invocationBuffers: </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">ring</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Ring</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        windowSize:        windowSize,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        concurrency:       </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RecordInvocation adds an invocation timestamp for rate calculation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">MetricsCollector</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RecordInvocation</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">functionName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">ts</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> m.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    buf, exists </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> m.invocationBuffers[functionName]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">exists {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Estimate max invocations per window: assume 1000 RPS max</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        maxEvents </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">(m.windowSize.</span><span style=\"color:#B392F0\">Seconds</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\"> 1000</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        buf </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> ring.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(maxEvents)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        m.invocationBuffers[functionName] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> buf</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    buf.Value </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> ts</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    buf </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> buf.</span><span style=\"color:#B392F0\">Next</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.invocationBuffers[functionName] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> buf</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// IncrementConcurrency increases concurrent execution count</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">MetricsCollector</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">IncrementConcurrency</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">functionName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> m.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.concurrency[functionName]</span><span style=\"color:#F97583\">++</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// DecrementConcurrency decreases concurrent execution count</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">MetricsCollector</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">DecrementConcurrency</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">functionName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> m.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.concurrency[functionName]</span><span style=\"color:#F97583\">--</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GetRequestRate calculates requests per second over the sliding window</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">MetricsCollector</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetRequestRate</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">functionName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">float64</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.mu.</span><span style=\"color:#B392F0\">RLock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> m.mu.</span><span style=\"color:#B392F0\">RUnlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    buf, exists </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> m.invocationBuffers[functionName]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">exists {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> 0.0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cutoff </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Add</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">-</span><span style=\"color:#E1E4E8\">m.windowSize)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    count </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Walk the ring buffer counting events within window</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    buf.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">value</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\">{}) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> value </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ts </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> value.(</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> ts.</span><span style=\"color:#B392F0\">After</span><span style=\"color:#E1E4E8\">(cutoff) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            count</span><span style=\"color:#F97583\">++</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> float64</span><span style=\"color:#E1E4E8\">(count) </span><span style=\"color:#F97583\">/</span><span style=\"color:#E1E4E8\"> m.windowSize.</span><span style=\"color:#B392F0\">Seconds</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GetConcurrency returns current concurrent executions</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">MetricsCollector</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetConcurrency</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">functionName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.mu.</span><span style=\"color:#B392F0\">RLock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> m.mu.</span><span style=\"color:#B392F0\">RUnlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> m.concurrency[functionName]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"d-core-logic-skeleton-code-scaler-main-logic\">D. Core Logic Skeleton Code (Scaler Main Logic)</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/scaler/scaler.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> scaler</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">log</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourproject/internal/pool</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourproject/internal/router</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourproject/internal/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ScaleDecision represents a scaling action to take</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ScaleDecision</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    FunctionName </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Direction    </span><span style=\"color:#B392F0\">ScaleDirection</span><span style=\"color:#6A737D\"> // \"up\", \"down\", \"none\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Count        </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">           // Number of instances to add/remove</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Reason       </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ScaleDirection</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ScaleUp</span><span style=\"color:#B392F0\">   ScaleDirection</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"up\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ScaleDown</span><span style=\"color:#B392F0\"> ScaleDirection</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"down\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ScaleNone</span><span style=\"color:#B392F0\"> ScaleDirection</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"none\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Scaler is the main auto-scaling component</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Scaler</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">RWMutex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Dependencies</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    metricsCollector </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">MetricsCollector</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    warmPool         </span><span style=\"color:#B392F0\">pool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">WarmPoolManager</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    router           </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">router</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Router</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    configStore      </span><span style=\"color:#B392F0\">ConfigStore</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // State</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    activeFunctions   </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    lastScaleUpTime   </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    lastScaleDownTime </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Control</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ticker      </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Ticker</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    stopChan    </span><span style=\"color:#F97583\">chan</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    evalInterval </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewScaler creates a new auto-scaler</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewScaler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">mc</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">MetricsCollector</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">wp</span><span style=\"color:#B392F0\"> pool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">WarmPoolManager</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">               r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">router</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Router</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">interval</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Scaler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Scaler</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        metricsCollector: mc,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        warmPool:         wp,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        router:           r,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        activeFunctions:  </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        lastScaleUpTime:  </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        lastScaleDownTime: </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        evalInterval:     interval,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        stopChan:         </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">chan</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\">{}),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// StartScalingLoop begins the periodic scaling evaluation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Scaler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">StartScalingLoop</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    s.ticker </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">NewTicker</span><span style=\"color:#E1E4E8\">(s.evalInterval)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    go</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        for</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            select</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">s.ticker.C:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                s.</span><span style=\"color:#B392F0\">evaluateAllFunctions</span><span style=\"color:#E1E4E8\">(ctx)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">s.stopChan:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                s.ticker.</span><span style=\"color:#B392F0\">Stop</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                return</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">ctx.</span><span style=\"color:#B392F0\">Done</span><span style=\"color:#E1E4E8\">():</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                s.ticker.</span><span style=\"color:#B392F0\">Stop</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Scaling loop started with interval </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, s.evalInterval)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// evaluateAllFunctions checks each active function for scaling needs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Scaler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">evaluateAllFunctions</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    s.mu.</span><span style=\"color:#B392F0\">RLock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    functions </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(s.activeFunctions))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> fn </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> s.activeFunctions {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        functions </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> append</span><span style=\"color:#E1E4E8\">(functions, fn)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    s.mu.</span><span style=\"color:#B392F0\">RUnlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, fn </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> functions {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        decision </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> s.</span><span style=\"color:#B392F0\">EvaluateScaling</span><span style=\"color:#E1E4E8\">(ctx, fn)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> decision.Direction </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> ScaleNone {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            s.</span><span style=\"color:#B392F0\">executeScaling</span><span style=\"color:#E1E4E8\">(ctx, decision)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// EvaluateScaling implements the core scaling algorithm</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Scaler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">EvaluateScaling</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">functionName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ScaleDecision</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Retrieve scaling configuration for this function</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // config, err := s.configStore.GetFunctionScalingConfig(ctx, functionName)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // If no config, return ScaleNone</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Gather current metrics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // requestRate := s.metricsCollector.GetRequestRate(functionName)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // concurrency := s.metricsCollector.GetConcurrency(functionName)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // queueDepth := s.router.GetQueueDepth(functionName)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // activeInstances := s.router.GetActiveInstanceCount(functionName)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Calculate desired instances based on target concurrency</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // desired := int(math.Ceil(float64(concurrency) / float64(config.TargetConcurrency)))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Apply min/max bounds: desired = max(config.MinInstances, min(config.MaxInstances, desired))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Check cooldown periods</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // now := time.Now()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // lastUp := s.lastScaleUpTime[functionName]</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // lastDown := s.lastScaleDownTime[functionName]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Determine scaling direction</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // if desired > activeInstances &#x26;&#x26; now.Sub(lastUp) >= config.ScaleUpCooldown {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //     return ScaleDecision{</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //         FunctionName: functionName,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //         Direction:    ScaleUp,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //         Count:        desired - activeInstances,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //         Reason:       fmt.Sprintf(\"Concurrency %d exceeds threshold\", concurrency),</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //     }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Check for scale-down (consider idle instances)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // if desired &#x3C; activeInstances &#x26;&#x26; now.Sub(lastDown) >= config.ScaleDownCooldown {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //     // Get idle instances from router</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //     idleCount := s.router.GetIdleInstanceCount(functionName, config.IdleTimeout)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //     removeCount := min(activeInstances - desired, idleCount)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //     if removeCount > 0 {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //         return ScaleDecision{...}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //     }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 7: Check for scale-to-zero (if minInstances == 0 and all instances idle beyond timeout)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#B392F0\"> ScaleDecision</span><span style=\"color:#E1E4E8\">{Direction: ScaleNone}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// executeScaling performs the actual scaling action</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Scaler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">executeScaling</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">decision</span><span style=\"color:#B392F0\"> ScaleDecision</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    switch</span><span style=\"color:#E1E4E8\"> decision.Direction {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> ScaleUp:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 8: Trigger warm pool to create new instances</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // s.warmPool.PreWarm(ctx, decision.FunctionName, \"latest\", decision.Count)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Update lastScaleUpTime</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Scaling UP </span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\"> by </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> instances: </span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            decision.FunctionName, decision.Count, decision.Reason)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> ScaleDown:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 9: Get idle instances from router and mark them as DRAINING</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // The router will handle graceful termination after in-flight requests complete</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Printf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Scaling DOWN </span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\"> by </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> instances: </span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            decision.FunctionName, decision.Count, decision.Reason)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RecordInvocationMetric is called by gateway on each request</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Scaler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RecordInvocationMetric</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">                                      functionName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">                                      timestamp</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 10: Mark function as active for scaling consideration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    s.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    s.activeFunctions[functionName] </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> true</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    s.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Record the invocation for rate calculation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    s.metricsCollector.</span><span style=\"color:#B392F0\">RecordInvocation</span><span style=\"color:#E1E4E8\">(functionName, timestamp)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// StopScalingLoop halts the scaling evaluation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Scaler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">StopScalingLoop</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    close</span><span style=\"color:#E1E4E8\">(s.stopChan)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"e-language-specific-hints\">E. Language-Specific Hints</h4>\n<ol>\n<li><strong>Concurrency Safety</strong>: Use <code>sync.RWMutex</code> for metrics maps that are read-heavy. The scaling loop reads metrics frequently while the gateway writes to them.</li>\n<li><strong>Time Management</strong>: Use <code>time.Ticker</code> for periodic evaluation rather than <code>time.Sleep</code> in a loop—it provides more consistent intervals.</li>\n<li><strong>Context Propagation</strong>: Pass <code>context.Context</code> through all scaling operations to allow cancellation during shutdown.</li>\n<li><strong>Error Handling</strong>: Scale operations should be best-effort. Log errors but don&#39;t fail the entire scaling loop for one function&#39;s failure.</li>\n<li><strong>Memory Efficiency</strong>: For the sliding window metrics, <code>container/ring</code> provides O(1) operations but requires type assertions. Consider a typed ring buffer for production.</li>\n</ol>\n<h4 id=\"f-milestone-checkpoint\">F. Milestone Checkpoint</h4>\n<p>After implementing the auto-scaler, verify it works correctly:</p>\n<ol>\n<li><strong>Start the system</strong> with a sample Python function deployed:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">   go</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#9ECBFF\"> cmd/server/main.go</span></span></code></pre></div>\n\n<ol start=\"2\">\n<li><strong>Send a burst of requests</strong> using a load testing tool:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">   hey</span><span style=\"color:#79B8FF\"> -n</span><span style=\"color:#79B8FF\"> 100</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#79B8FF\"> 20</span><span style=\"color:#9ECBFF\"> http://localhost:8080/invoke/my-function</span></span></code></pre></div>\n\n<ol start=\"3\">\n<li><p><strong>Monitor scaling behavior</strong>:</p>\n<ul>\n<li>Check logs for scale-up messages</li>\n<li>Observe instance count increase in metrics (<code>GET /metrics</code> endpoint)</li>\n<li>Wait for traffic to subside and verify scale-down occurs after cooldown period</li>\n<li>Verify scale-to-zero eventually terminates all instances (if <code>MinInstances=0</code>)</li>\n</ul>\n</li>\n<li><p><strong>Expected observations</strong>:</p>\n<ul>\n<li>Initial requests may experience cold starts</li>\n<li>After scale-up, subsequent requests should use warm instances</li>\n<li>Instance count should not exceed <code>MaxInstances</code></li>\n<li>After idle period, instances should terminate</li>\n</ul>\n</li>\n<li><p><strong>Signs of problems</strong>:</p>\n<ul>\n<li>No scaling occurs: Check metrics collection and threshold values</li>\n<li>Constant scaling oscillations: Adjust cooldown periods or add hysteresis</li>\n<li>Instances not terminating: Verify <code>IdleTimeout</code> and draining logic</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"interactions-and-data-flow\">Interactions and Data Flow</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 4 (Request Routing) and Milestone 5 (Auto-Scaling), with dependencies on Milestone 2 (Execution Environment) and Milestone 3 (Cold Start Optimization)</p>\n</blockquote>\n<p>This section traces the complete journey of a function invocation through the system, from the initial HTTP request to the final response. Understanding these interactions is critical to grasping how the architectural components collaborate to deliver the serverless experience. We&#39;ll examine both the <strong>synchronous invocation flow</strong> (where the client waits for the result) and the <strong>lifecycle events</strong> that govern function instance behavior.</p>\n<h3 id=\"synchronous-invocation-flow\">Synchronous Invocation Flow</h3>\n<p>Think of this flow as a <strong>restaurant dinner service</strong>:</p>\n<ol>\n<li>A customer (client) arrives and tells the host (Gateway) what they want to eat (which function to invoke)</li>\n<li>The host checks if there&#39;s an available table (warm instance) with a free seat (concurrency capacity)</li>\n<li>If not, the host might ask the kitchen to prepare a new table (cold start) or add the customer to a waitlist (queue)</li>\n<li>Once seated, a waiter (Container) takes the order (request), the kitchen (function code) prepares the meal (executes), and the result is delivered back through the chain</li>\n<li>After the meal, the table is cleaned (instance reset) and made available for the next customer</li>\n</ol>\n<h4 id=\"complete-step-by-step-walkthrough\">Complete Step-by-Step Walkthrough</h4>\n<p>The following numbered steps trace a synchronous HTTP function call from initial request to final response, highlighting the interactions between all system components:</p>\n<ol>\n<li><p><strong>Client Request Submission</strong></p>\n<ul>\n<li>The client sends an HTTP POST request to <code>https://gateway.example.com/invoke/{functionName}</code></li>\n<li>The request includes the function payload in the request body and any required headers</li>\n<li>The client may specify a timeout via the <code>X-Timeout-Seconds</code> header or it defaults to the function&#39;s configured timeout</li>\n</ul>\n</li>\n<li><p><strong>Gateway Reception and Validation</strong></p>\n<ul>\n<li>The <code>Gateway</code> receives the request through its HTTP server</li>\n<li>It validates the function name exists in the system by checking with the <code>Router</code></li>\n<li>It enforces request size limits (configured via <code>GatewayConfig.MaxRequestBodyBytes</code>)</li>\n<li>It creates an <code>InvocationRequest</code> with:<ul>\n<li>A unique <code>RequestID</code> for tracking</li>\n<li>The function name and preferred version</li>\n<li>The payload bytes</li>\n<li><code>Synchronous: true</code></li>\n<li>A <code>Deadline</code> calculated from the current time plus timeout</li>\n</ul>\n</li>\n<li>The gateway records metrics via <code>gatewayMetrics.requestsTotal</code> and starts a timer for request duration</li>\n</ul>\n</li>\n<li><p><strong>Router Request Processing</strong></p>\n<ul>\n<li>The <code>Router.Route()</code> method is called with the <code>InvocationRequest</code></li>\n<li>The router looks up the <code>functionRoutingTable</code> for the specified function</li>\n<li>It checks if the function&#39;s circuit breaker is open (too many recent failures) → if so, returns error immediately</li>\n<li>It calls <code>selectInstance()</code> to choose an appropriate <code>FunctionInstance</code></li>\n</ul>\n</li>\n<li><p><strong>Instance Selection Process</strong></p>\n<ul>\n<li><strong>Warm Path (Ideal)</strong>: If warm instances exist in the routing table:<ul>\n<li>The router applies <strong>least-connections</strong> strategy, preferring instances with lowest <code>activeReqs</code></li>\n<li>It checks that the selected instance&#39;s <code>activeReqs &lt; concurrencyLimit</code> (per-instance concurrency)</li>\n<li>It verifies the instance is healthy (not marked as unhealthy in <code>routedInstance.healthy</code>)</li>\n<li>It increments the instance&#39;s <code>activeReqs</code> counter</li>\n</ul>\n</li>\n<li><strong>Cold Path (No Warm Instance Available)</strong>:<ul>\n<li>The router calls the <code>Scaler</code> to potentially scale up</li>\n<li>The scaler&#39;s <code>EvaluateScaling()</code> determines if a new instance should be created</li>\n<li>If scaling is triggered, the scaler interacts with the <code>WarmPoolManager</code> to create a new instance</li>\n<li>Meanwhile, the request may be queued (see step 5) or fail fast depending on configuration</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p><strong>Request Queue Management (When No Instance Available)</strong></p>\n<ul>\n<li>If all warm instances are at capacity (<code>activeReqs &gt;= concurrencyLimit</code>):<ul>\n<li>The router creates a <code>QueuedRequest</code> with priority based on request deadline (earlier deadline = higher priority)</li>\n<li>It calls <code>RequestQueue.Enqueue()</code> to add the request to the function-specific queue</li>\n<li>The gateway sets an HTTP timeout and waits for dequeue notification</li>\n<li>The <code>gatewayMetrics.queueDepth</code> is incremented to monitor queue size</li>\n</ul>\n</li>\n<li><strong>Queue Full Scenario</strong>: If the queue reaches its <code>maxSize</code>, new requests receive HTTP 503 &quot;Service Unavailable&quot;</li>\n</ul>\n</li>\n<li><p><strong>Instance Acquisition and Preparation</strong></p>\n<ul>\n<li>Once an instance is selected (or becomes available):<ul>\n<li>The router calls <code>WarmPoolManager.AcquireWarmInstance()</code> for the function</li>\n<li>The warm pool manager:<ul>\n<li>Marks the instance state as <code>InstanceStateActive</code> from <code>InstanceStateWarm</code></li>\n<li>Updates <code>LastUsedAt</code> timestamp</li>\n<li>Returns the <code>FunctionInstance</code> with its container details (host, port)</li>\n</ul>\n</li>\n<li>The router records the instance assignment in the <code>InvocationRequest.PreferredInstanceID</code></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p><strong>Request Forwarding to Instance</strong></p>\n<ul>\n<li>The router calls <code>forwardRequest()</code> which:<ul>\n<li>Establishes an HTTP connection to the instance&#39;s container (at <code>instance.Host:instance.Port</code>)</li>\n<li>Forwards the original request payload with additional headers:<ul>\n<li><code>X-Function-Request-ID</code>: The unique request identifier</li>\n<li><code>X-Deadline-Timestamp</code>: The absolute deadline as Unix timestamp</li>\n<li><code>X-Instance-ID</code>: The instance identifier for tracking</li>\n</ul>\n</li>\n<li>Sets appropriate timeouts based on the remaining deadline</li>\n</ul>\n</li>\n<li>The instance container (running the function runtime) receives and processes the request</li>\n</ul>\n</li>\n<li><p><strong>Function Execution Within Container</strong></p>\n<ul>\n<li>The container&#39;s runtime (e.g., a Go HTTP server) receives the forwarded request</li>\n<li>It extracts the function handler name from environment variables</li>\n<li>It loads the function code (already present in the container from packaging)</li>\n<li>It invokes the handler function with the request payload</li>\n<li>The handler executes with the configured resource limits (monitored via cgroups)</li>\n<li>The runtime captures stdout/stderr and any returned values</li>\n</ul>\n</li>\n<li><p><strong>Response Propagation Back Through Chain</strong></p>\n<ul>\n<li>The instance container sends an HTTP response back to the router&#39;s <code>forwardRequest()</code></li>\n<li>The router:<ul>\n<li>Decrements the instance&#39;s <code>activeReqs</code> counter</li>\n<li>Calls <code>updateInstanceHealth()</code> with success/failure based on HTTP status code</li>\n<li>If successful, marks the instance as healthy; if failed, increments failure count</li>\n</ul>\n</li>\n<li>The router packages the response into an <code>InvocationResponse</code> with:<ul>\n<li>The response payload</li>\n<li>Duration metrics</li>\n<li>Memory usage (from container stats)</li>\n<li>Any errors that occurred</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p><strong>Instance Release and Cleanup</strong></p>\n<ul>\n<li>The router calls <code>WarmPoolManager.ReleaseInstance()</code> with the instance and health status</li>\n<li>The warm pool manager:<ul>\n<li>If the instance is healthy and under its TTL/idle timeout, returns it to the pool (state <code>InstanceStateWarm</code>)</li>\n<li>If unhealthy or expired, triggers cleanup via <code>CleanupInstance()</code></li>\n<li>Updates <code>LastUsedAt</code> timestamp</li>\n</ul>\n</li>\n<li>The <code>Scaler</code> records the completion via <code>DecrementConcurrency()</code> for concurrency tracking</li>\n</ul>\n</li>\n<li><p><strong>Final Response to Client</strong></p>\n<ul>\n<li>The gateway receives the <code>InvocationResponse</code> from the router</li>\n<li>It sets appropriate HTTP status code (200 for success, 5xx for errors)</li>\n<li>It returns the response payload in the HTTP body</li>\n<li>It adds response headers:<ul>\n<li><code>X-Request-ID</code>: For client correlation</li>\n<li><code>X-Function-Duration-MS</code>: Execution time in milliseconds</li>\n<li><code>X-Billed-Duration-MS</code>: Rounded-up billing duration</li>\n</ul>\n</li>\n<li>The gateway records final metrics:<ul>\n<li>Request duration in <code>gatewayMetrics.requestDuration</code></li>\n<li>Success/error counts in <code>gatewayMetrics.errorsTotal</code></li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"cold-start-vs-warm-start-variation\">Cold Start vs Warm Start Variation</h4>\n<p>The key difference between cold and warm starts occurs in steps 4-6:</p>\n<p><strong>Warm Start Path (Sub-100ms):</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Router → WarmPoolManager.AcquireWarmInstance() → existing warm container → execute function</code></pre></div>\n<ul>\n<li>No container creation overhead</li>\n<li>Runtime already initialized</li>\n<li>Dependencies pre-loaded</li>\n<li>Typically completes in &lt;100ms total</li>\n</ul>\n<p><strong>Cold Start Path (500ms-2000ms):</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Router → Scaler → WarmPoolManager.PreWarm() → ContainerManager.CreateContainer() → \nContainerManager.StartContainer() → dependency loading → execute function</code></pre></div>\n<ul>\n<li>Full container creation (100-500ms)</li>\n<li>Image pulling if not cached (variable, 0-2000ms)</li>\n<li>Runtime initialization (JVM: 500ms+, Go: &lt;50ms)</li>\n<li>Dependency loading/imports (variable)</li>\n<li>Typically 500ms-2000ms total</li>\n</ul>\n<blockquote>\n<p><strong>Key Insight:</strong> The system&#39;s performance goal is to maximize warm starts through intelligent pooling and predictive warming while maintaining the flexibility to handle unpredictable loads with cold starts when necessary.</p>\n</blockquote>\n<p><img src=\"/api/project/serverless-runtime/architecture-doc/asset?path=diagrams%2Fsequence-sync-invocation.svg\" alt=\"Sequence: Synchronous Invocation (Cold Start)\"></p>\n<p><em>Diagram showing the complete interaction sequence between User, Gateway, Router, Scaler, WarmPoolManager, ContainerManager, and Storage for a cold start invocation.</em></p>\n<h4 id=\"data-transformation-through-the-pipeline\">Data Transformation Through the Pipeline</h4>\n<table>\n<thead>\n<tr>\n<th>Stage</th>\n<th>Input Data</th>\n<th>Output Data</th>\n<th>Key Transformation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Client → Gateway</td>\n<td>Raw HTTP request</td>\n<td><code>InvocationRequest</code></td>\n<td>HTTP headers/body packaged into structured request</td>\n</tr>\n<tr>\n<td>Gateway → Router</td>\n<td><code>InvocationRequest</code></td>\n<td><code>QueuedRequest</code> (if queued)</td>\n<td>Priority calculation based on deadline</td>\n</tr>\n<tr>\n<td>Router → WarmPool</td>\n<td>Function name, version</td>\n<td><code>FunctionInstance</code></td>\n<td>Instance selection from pool or creation</td>\n</tr>\n<tr>\n<td>Router → Container</td>\n<td><code>InvocationRequest</code></td>\n<td>HTTP request to container</td>\n<td>Request forwarding with metadata headers</td>\n</tr>\n<tr>\n<td>Container → Function</td>\n<td>HTTP request</td>\n<td>Handler invocation</td>\n<td>Payload deserialization to function parameters</td>\n</tr>\n<tr>\n<td>Function → Container</td>\n<td>Return value</td>\n<td>HTTP response</td>\n<td>Result serialization to HTTP response</td>\n</tr>\n<tr>\n<td>Container → Router</td>\n<td>HTTP response</td>\n<td><code>InvocationResponse</code></td>\n<td>Response packaging with metrics</td>\n</tr>\n<tr>\n<td>Router → Gateway</td>\n<td><code>InvocationResponse</code></td>\n<td>HTTP response</td>\n<td>Structured response to HTTP translation</td>\n</tr>\n<tr>\n<td>Gateway → Client</td>\n<td>HTTP response</td>\n<td>Raw HTTP response</td>\n<td>Final delivery to client</td>\n</tr>\n</tbody></table>\n<h3 id=\"function-instance-lifecycle-events\">Function Instance Lifecycle Events</h3>\n<p>Think of a function instance&#39;s lifecycle as a <strong>theater actor&#39;s backstage workflow</strong>:</p>\n<ul>\n<li><strong>PROVISIONING</strong>: Actor getting into costume and makeup (container being created)</li>\n<li><strong>WARM</strong>: Actor waiting in the wings, ready to go on stage (instance idle in pool)</li>\n<li><strong>ACTIVE</strong>: Actor performing on stage (executing a request)</li>\n<li><strong>DRAINING</strong>: Actor taking final bow but still on stage (finishing requests during scale-down)</li>\n<li><strong>TERMINATED</strong>: Actor has left the theater (container destroyed)</li>\n<li><strong>ERROR</strong>: Actor fell ill and can&#39;t perform (container in error state)</li>\n</ul>\n<p>Each state transition is triggered by specific events in the system, which we&#39;ll explore through both a state machine table and detailed event descriptions.</p>\n<h4 id=\"instance-state-transition-table\">Instance State Transition Table</h4>\n<p>The following table defines all possible state transitions for a <code>FunctionInstance</code>, including the triggering events, conditions, and resulting actions:</p>\n<table>\n<thead>\n<tr>\n<th>Current State</th>\n<th>Event</th>\n<th>Next State</th>\n<th>Conditions</th>\n<th>Actions Taken</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>(none)</td>\n<td><code>CreateInstance</code></td>\n<td><code>InstanceStateProvisioning</code></td>\n<td>Valid function definition exists</td>\n<td>1. Call <code>ContainerManager.CreateContainer()</code><br>2. Set <code>CreatedAt</code> timestamp<br>3. Generate unique <code>ID</code></td>\n</tr>\n<tr>\n<td><code>InstanceStateProvisioning</code></td>\n<td><code>ContainerStarted</code></td>\n<td><code>InstanceStateWarm</code></td>\n<td>Container started successfully</td>\n<td>1. Mark container as running<br>2. Initialize runtime environment<br>3. Pre-load dependencies<br>4. Add to warm pool</td>\n</tr>\n<tr>\n<td><code>InstanceStateProvisioning</code></td>\n<td><code>ContainerStartFailed</code></td>\n<td><code>InstanceStateError</code></td>\n<td>Container failed to start</td>\n<td>1. Record error details<br>2. Schedule cleanup<br>3. Trigger scaling retry if needed</td>\n</tr>\n<tr>\n<td><code>InstanceStateWarm</code></td>\n<td><code>RequestAssigned</code></td>\n<td><code>InstanceStateActive</code></td>\n<td>Instance selected by router</td>\n<td>1. Increment <code>InvocationCount</code><br>2. Update <code>LastUsedAt</code><br>3. Mark as active in routing table</td>\n</tr>\n<tr>\n<td><code>InstanceStateActive</code></td>\n<td><code>RequestCompleted</code></td>\n<td><code>InstanceStateWarm</code></td>\n<td>Request finished successfully<br>AND instance under TTL/idle limits</td>\n<td>1. Decrement active request count<br>2. Reset container state if needed<br>3. Return to warm pool</td>\n</tr>\n<tr>\n<td><code>InstanceStateActive</code></td>\n<td><code>RequestFailed</code></td>\n<td><code>InstanceStateWarm</code> or <code>InstanceStateError</code></td>\n<td>Request failed<br>If recoverable error → WARM<br>If unrecoverable → ERROR</td>\n<td>Recoverable: Reset container<br>Unrecoverable: Mark unhealthy, schedule replacement</td>\n</tr>\n<tr>\n<td><code>InstanceStateWarm</code></td>\n<td><code>TTLExpired</code></td>\n<td><code>InstanceStateDraining</code></td>\n<td>Instance age &gt; <code>InstanceTTL</code></td>\n<td>1. Mark for termination<br>2. Remove from warm pool<br>3. Start graceful shutdown</td>\n</tr>\n<tr>\n<td><code>InstanceStateWarm</code></td>\n<td><code>IdleTimeout</code></td>\n<td><code>InstanceStateDraining</code></td>\n<td><code>IdleDuration()</code> &gt; <code>IdleTimeout</code></td>\n<td>1. Mark for termination<br>2. Remove from routing table<br>3. Start graceful shutdown</td>\n</tr>\n<tr>\n<td><code>InstanceStateWarm</code></td>\n<td><code>ScaleDownSignal</code></td>\n<td><code>InstanceStateDraining</code></td>\n<td>Scaler determines excess capacity</td>\n<td>1. Select instance for termination (oldest/last used)<br>2. Begin drain process</td>\n</tr>\n<tr>\n<td><code>InstanceStateActive</code></td>\n<td><code>ScaleDownSignal</code></td>\n<td><code>InstanceStateDraining</code></td>\n<td>Scaler needs to reduce capacity<br>AND instance has no active requests</td>\n<td>1. Wait for current request to complete<br>2. Transition to DRAINING after completion</td>\n</tr>\n<tr>\n<td><code>InstanceStateDraining</code></td>\n<td><code>DrainCompleted</code></td>\n<td><code>InstanceStateTerminated</code></td>\n<td>All requests completed<br>OR force timeout reached</td>\n<td>1. Call <code>ContainerManager.StopContainer()</code><br>2. Call <code>ContainerManager.RemoveContainer()</code><br>3. Update <code>TerminatedAt</code> timestamp</td>\n</tr>\n<tr>\n<td><code>InstanceStateDraining</code></td>\n<td><code>ForceTerminate</code></td>\n<td><code>InstanceStateTerminated</code></td>\n<td>Scale-down timeout reached<br>OR system shutdown</td>\n<td>1. Force kill container processes<br>2. Remove container resources<br>3. Clean up network/volumes</td>\n</tr>\n<tr>\n<td><code>InstanceStateError</code></td>\n<td><code>HealthCheckFailed</code></td>\n<td><code>InstanceStateTerminated</code></td>\n<td>Container unrecoverable<br>OR consecutive failures</td>\n<td>1. Log error details<br>2. Force remove container<br>3. Notify monitoring system</td>\n</tr>\n<tr>\n<td>Any state</td>\n<td><code>SystemShutdown</code></td>\n<td><code>InstanceStateTerminated</code></td>\n<td>System graceful shutdown initiated</td>\n<td>1. Stop accepting new requests<br>2. Wait for in-flight requests<br>3. Terminate all containers</td>\n</tr>\n</tbody></table>\n<p><img src=\"/api/project/serverless-runtime/architecture-doc/asset?path=diagrams%2Finstance-state-machine.svg\" alt=\"Function Instance Lifecycle\"></p>\n<p><em>Diagram showing the state machine for a FunctionInstance with transitions between PROVISIONING, WARM, ACTIVE, DRAINING, TERMINATED, and ERROR states.</em></p>\n<h4 id=\"detailed-event-descriptions\">Detailed Event Descriptions</h4>\n<p>Each event in the state machine corresponds to specific system operations or conditions:</p>\n<p><strong>1. CreateInstance Event</strong></p>\n<ul>\n<li><strong>Triggered by</strong>: <code>WarmPoolManager.PreWarm()</code> or <code>Scaler.executeScaling(ScaleUp)</code></li>\n<li><strong>Source</strong>: Auto-scaling logic or predictive warming</li>\n<li><strong>Data</strong>: <code>FunctionDefinition</code> containing runtime, handler, resource limits</li>\n<li><strong>Outcome</strong>: Container creation initiated via <code>ContainerManager</code></li>\n</ul>\n<p><strong>2. ContainerStarted Event</strong></p>\n<ul>\n<li><strong>Triggered by</strong>: Successful return from <code>ContainerManager.StartContainer()</code></li>\n<li><strong>Source</strong>: Container management layer</li>\n<li><strong>Data</strong>: Container ID, host/port assignment, startup duration</li>\n<li><strong>Outcome</strong>: Instance marked as ready, added to routing table and warm pool</li>\n</ul>\n<p><strong>3. RequestAssigned Event</strong></p>\n<ul>\n<li><strong>Triggered by</strong>: <code>Router.selectInstance()</code> choosing this instance</li>\n<li><strong>Source</strong>: Request routing layer</li>\n<li><strong>Data</strong>: <code>InvocationRequest</code> details, request deadline</li>\n<li><strong>Outcome</strong>: Instance state changes to ACTIVE, concurrency counters incremented</li>\n</ul>\n<p><strong>4. RequestCompleted Event</strong></p>\n<ul>\n<li><strong>Triggered by</strong>: Successful return from <code>forwardRequest()</code></li>\n<li><strong>Source</strong>: Request routing layer after instance responds</li>\n<li><strong>Data</strong>: <code>InvocationResponse</code> with duration, memory usage, result</li>\n<li><strong>Outcome</strong>: Instance returned to pool if healthy, metrics recorded</li>\n</ul>\n<p><strong>5. RequestFailed Event</strong></p>\n<ul>\n<li><strong>Triggered by</strong>: Error from <code>forwardRequest()</code> (timeout, crash, error response)</li>\n<li><strong>Source</strong>: Request routing layer or container health check</li>\n<li><strong>Data</strong>: Error type, stack trace (if available), HTTP status code</li>\n<li><strong>Outcome</strong>: Instance may be retired (ERROR) or reset (WARM) based on error severity</li>\n</ul>\n<p><strong>6. TTLExpired Event</strong></p>\n<ul>\n<li><strong>Triggered by</strong>: <code>WarmPoolManager.cleanupExpired()</code> periodic check</li>\n<li><strong>Source</strong>: Warm pool maintenance goroutine</li>\n<li><strong>Condition</strong>: <code>instance.Age() &gt; PoolConfig.InstanceTTL</code></li>\n<li><strong>Outcome</strong>: Instance removed from pool, scheduled for termination</li>\n</ul>\n<p><strong>7. IdleTimeout Event</strong></p>\n<ul>\n<li><strong>Triggered by</strong>: <code>WarmPoolManager.cleanupExpired()</code> periodic check</li>\n<li><strong>Source</strong>: Warm pool maintenance goroutine</li>\n<li><strong>Condition</strong>: <code>instance.IdleDuration() &gt; PoolConfig.IdleTimeout</code></li>\n<li><strong>Outcome</strong>: Instance marked for scale-to-zero termination</li>\n</ul>\n<p><strong>8. ScaleDownSignal Event</strong></p>\n<ul>\n<li><strong>Triggered by</strong>: <code>Scaler.EvaluateScaling()</code> returning <code>ScaleDown</code> decision</li>\n<li><strong>Source</strong>: Auto-scaling component</li>\n<li><strong>Condition</strong>: Low utilization metrics and cooldown period elapsed</li>\n<li><strong>Outcome</strong>: Instance transitioned to DRAINING state, removed from routing</li>\n</ul>\n<p><strong>9. DrainCompleted Event</strong></p>\n<ul>\n<li><strong>Triggered by</strong>: All active requests finished on DRAINING instance</li>\n<li><strong>Source</strong>: Router monitoring request completion</li>\n<li><strong>Condition</strong>: <code>instance.activeReqs == 0</code> for DRAINING instance</li>\n<li><strong>Outcome</strong>: Container termination process initiated</li>\n</ul>\n<p><strong>10. ForceTerminate Event</strong></p>\n<ul>\n<li><strong>Triggered by</strong>: Drain timeout expiration or system shutdown</li>\n<li><strong>Source</strong>: Drain timeout timer or shutdown coordinator</li>\n<li><strong>Condition</strong>: DRAINING state duration &gt; max drain timeout</li>\n<li><strong>Outcome</strong>: Forced container kill, immediate resource cleanup</li>\n</ul>\n<p><strong>11. HealthCheckFailed Event</strong></p>\n<ul>\n<li><strong>Triggered by</strong>: Container health check failure or OOM kill</li>\n<li><strong>Source</strong>: Container manager health monitoring</li>\n<li><strong>Condition</strong>: Container process died or unreachable</li>\n<li><strong>Outcome</strong>: Emergency cleanup, error logging, replacement instance creation</li>\n</ul>\n<h4 id=\"event-driven-interactions-between-components\">Event-Driven Interactions Between Components</h4>\n<p>The following table shows how different system components interact through these lifecycle events:</p>\n<table>\n<thead>\n<tr>\n<th>Event</th>\n<th>Primary Component</th>\n<th>Secondary Component</th>\n<th>Communication Method</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>CreateInstance</code></td>\n<td><code>Scaler</code> →</td>\n<td><code>WarmPoolManager</code></td>\n<td>Direct method call</td>\n</tr>\n<tr>\n<td><code>ContainerStarted</code></td>\n<td><code>ContainerManager</code> →</td>\n<td><code>WarmPoolManager</code></td>\n<td>Callback/notification channel</td>\n</tr>\n<tr>\n<td><code>RequestAssigned</code></td>\n<td><code>Router</code> →</td>\n<td><code>FunctionInstance</code></td>\n<td>Direct state mutation</td>\n</tr>\n<tr>\n<td><code>RequestCompleted</code></td>\n<td><code>Router</code> →</td>\n<td><code>WarmPoolManager</code></td>\n<td><code>ReleaseInstance()</code> call</td>\n</tr>\n<tr>\n<td><code>ScaleDownSignal</code></td>\n<td><code>Scaler</code> →</td>\n<td><code>Router</code></td>\n<td>Update routing table</td>\n</tr>\n<tr>\n<td><code>DrainCompleted</code></td>\n<td><code>Router</code> →</td>\n<td><code>ContainerManager</code></td>\n<td><code>StopContainer()</code> call</td>\n</tr>\n<tr>\n<td><code>HealthCheckFailed</code></td>\n<td>Health monitor →</td>\n<td><code>WarmPoolManager</code></td>\n<td>Error channel notification</td>\n</tr>\n</tbody></table>\n<h4 id=\"lifecycle-metrics-and-monitoring\">Lifecycle Metrics and Monitoring</h4>\n<p>Each state transition generates valuable metrics for system observability:</p>\n<table>\n<thead>\n<tr>\n<th>Metric</th>\n<th>Calculation</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Provisioning Duration</td>\n<td><code>ContainerStarted</code> timestamp - <code>CreateInstance</code> timestamp</td>\n<td>Measure cold start container creation time</td>\n</tr>\n<tr>\n<td>Warm Pool Size</td>\n<td>Count of instances in <code>InstanceStateWarm</code></td>\n<td>Monitor resource allocation for warm starts</td>\n</tr>\n<tr>\n<td>Active Invocations</td>\n<td>Count of instances in <code>InstanceStateActive</code></td>\n<td>Measure current system load</td>\n</tr>\n<tr>\n<td>Drain Time</td>\n<td><code>DrainCompleted</code> timestamp - ScaleDownSignal timestamp</td>\n<td>Assess graceful shutdown efficiency</td>\n</tr>\n<tr>\n<td>Instance Lifetime</td>\n<td><code>TerminatedAt</code> timestamp - <code>CreatedAt</code> timestamp</td>\n<td>Calculate container churn rate</td>\n</tr>\n<tr>\n<td>Error Rate</td>\n<td>Instances transitioning to <code>InstanceStateError</code> / Total instances</td>\n<td>Measure system stability</td>\n</tr>\n</tbody></table>\n<h4 id=\"concurrency-and-state-consistency\">Concurrency and State Consistency</h4>\n<p>Maintaining consistent state across concurrent operations requires careful coordination:</p>\n<ol>\n<li><strong>State Transition Locking</strong>: Each <code>FunctionInstance</code> has a mutex protecting state field updates</li>\n<li><strong>Atomic Counters</strong>: <code>activeReqs</code> uses <code>int32</code> with atomic operations for concurrency safety</li>\n<li><strong>Optimistic Concurrency Control</strong>: Before transitioning from WARM to ACTIVE, verify <code>activeReqs &lt; concurrencyLimit</code> with atomic check</li>\n<li><strong>Event Serialization</strong>: Lifecycle events for the same instance are processed sequentially through the router&#39;s state machine</li>\n</ol>\n<blockquote>\n<p><strong>Critical Design Principle:</strong> The instance lifecycle follows a <strong>single-writer principle</strong>—only the component that &quot;owns&quot; the current state (Router for ACTIVE, WarmPoolManager for WARM, Scaler for PROVISIONING) can initiate state transitions for that instance, preventing race conditions.</p>\n</blockquote>\n<h4 id=\"recovery-from-mid-transition-failures\">Recovery from Mid-Transition Failures</h4>\n<p>The system must handle cases where events fail mid-transition:</p>\n<table>\n<thead>\n<tr>\n<th>Failure Scenario</th>\n<th>Detection Method</th>\n<th>Recovery Action</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Container creation timeout</td>\n<td><code>CreateContainer()</code> timeout</td>\n<td>Mark as ERROR, retry with exponential backoff</td>\n</tr>\n<tr>\n<td>State transition deadlock</td>\n<td>Watchdog timer on state duration</td>\n<td>Force transition based on heuristic (e.g., if PROVISIONING &gt; 2min → ERROR)</td>\n</tr>\n<tr>\n<td>Lost instance (network partition)</td>\n<td>Health check failures + lack of heartbeats</td>\n<td>Mark as ERROR, remove from routing tables, create replacement</td>\n</tr>\n<tr>\n<td>Orphaned ACTIVE instance</td>\n<td>No request completion after timeout + no router assignment</td>\n<td>Force transition to ERROR via cleanup sweep</td>\n</tr>\n</tbody></table>\n<p>The interaction patterns and lifecycle events described here form the operational heartbeat of the serverless runtime. By understanding these flows, developers can effectively debug issues, optimize performance, and extend the system with new capabilities while maintaining the consistency and reliability expected from a production-grade serverless platform.</p>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<h4 id=\"technology-recommendations-table\">Technology Recommendations Table</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Request/Response Flow</td>\n<td>HTTP/1.1 with Keep-Alive (<code>net/http</code>)</td>\n<td>HTTP/2 with multiplexing (<code>golang.org/x/net/http2</code>)</td>\n</tr>\n<tr>\n<td>Internal Communication</td>\n<td>Direct method calls + channels</td>\n<td>gRPC with streaming for instance updates</td>\n</tr>\n<tr>\n<td>State Synchronization</td>\n<td><code>sync.RWMutex</code> per instance</td>\n<td>Distributed consensus (etcd/Raft) for multi-node</td>\n</tr>\n<tr>\n<td>Event Propagation</td>\n<td>Go channels with select loops</td>\n<td>Message bus (NATS, Kafka) for distributed events</td>\n</tr>\n<tr>\n<td>Timeout Management</td>\n<td><code>context.WithTimeout</code> + deadlines</td>\n<td>Hierarchical timeout chains with propagation</td>\n</tr>\n<tr>\n<td>Queue Implementation</td>\n<td>Heap-based priority queue (<code>container/heap</code>)</td>\n<td>Redis-backed queue with persistence</td>\n</tr>\n</tbody></table>\n<h4 id=\"recommended-filemodule-structure\">Recommended File/Module Structure</h4>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>project-root/\n  cmd/\n    gateway/                  # HTTP gateway entry point\n      main.go\n    controller/               # Management plane entry point\n      main.go\n  internal/\n    gateway/                  # Request routing component\n      gateway.go              # HTTP server and middleware\n      router.go               # Request routing logic\n      queue.go                # Request queue implementation\n      loadbalancer.go         # Instance selection algorithms\n      metrics.go              # Gateway-specific metrics\n    lifecycle/                # Instance lifecycle management\n      events.go               # Lifecycle event definitions\n      statemachine.go         # State transition logic\n      healthcheck.go          # Instance health monitoring\n    flows/                    # Data flow orchestration\n      synchronous.go          # Synchronous invocation flow\n      asynchronous.go         # Async invocation flow (future)\n      errorhandling.go        # Flow-level error recovery\n    integration/              # Component integration points\n      coordinator.go          # Orchestrates cross-component flows\n      hooks.go                # Lifecycle hooks for extensibility</code></pre></div>\n\n<h4 id=\"infrastructure-starter-code\">Infrastructure Starter Code</h4>\n<p><strong>Complete Flow Coordinator (Ready to Use):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/integration/coordinator.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> integration</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/ourproject/internal/gateway</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/ourproject/internal/lifecycle</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/ourproject/internal/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// FlowCoordinator orchestrates the complete invocation flow</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> FlowCoordinator</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    router        </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">gateway</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Router</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    warmPool      </span><span style=\"color:#B392F0\">pool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">WarmPoolManager</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    scaler        </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">scaler</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Scaler</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    metrics       </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Metrics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    eventBus      </span><span style=\"color:#F97583\">chan</span><span style=\"color:#B392F0\"> lifecycle</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InstanceEvent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    timeoutConfig </span><span style=\"color:#B392F0\">TimeoutConfig</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> TimeoutConfig</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    GatewayTimeout     </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RoutingTimeout     </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ForwardingTimeout  </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DrainTimeout       </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    HealthCheckTimeout </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewFlowCoordinator creates a new coordinator</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewFlowCoordinator</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">router</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">gateway</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Router</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">warmPool</span><span style=\"color:#B392F0\"> pool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">WarmPoolManager</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    scaler</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">scaler</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Scaler</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">metrics</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Metrics</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FlowCoordinator</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">FlowCoordinator</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        router:   router,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        warmPool: warmPool,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        scaler:   scaler,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        metrics:  metrics,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        eventBus: </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">chan</span><span style=\"color:#B392F0\"> lifecycle</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InstanceEvent</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        timeoutConfig: </span><span style=\"color:#B392F0\">TimeoutConfig</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            GatewayTimeout:     </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            RoutingTimeout:     </span><span style=\"color:#79B8FF\">5</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            ForwardingTimeout:  </span><span style=\"color:#79B8FF\">25</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            DrainTimeout:       </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            HealthCheckTimeout: </span><span style=\"color:#79B8FF\">2</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// StartEventProcessor processes lifecycle events</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">fc </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FlowCoordinator</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">StartEventProcessor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    go</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        for</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            select</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">ctx.</span><span style=\"color:#B392F0\">Done</span><span style=\"color:#E1E4E8\">():</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                return</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            case</span><span style=\"color:#E1E4E8\"> event </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">fc.eventBus:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                fc.</span><span style=\"color:#B392F0\">handleEvent</span><span style=\"color:#E1E4E8\">(ctx, event)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// handleEvent processes a single lifecycle event</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">fc </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FlowCoordinator</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">handleEvent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">event</span><span style=\"color:#B392F0\"> lifecycle</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InstanceEvent</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    switch</span><span style=\"color:#E1E4E8\"> event.Type {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> lifecycle.EventContainerStarted:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        fc.</span><span style=\"color:#B392F0\">onContainerStarted</span><span style=\"color:#E1E4E8\">(ctx, event)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> lifecycle.EventRequestCompleted:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        fc.</span><span style=\"color:#B392F0\">onRequestCompleted</span><span style=\"color:#E1E4E8\">(ctx, event)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> lifecycle.EventHealthCheckFailed:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        fc.</span><span style=\"color:#B392F0\">onHealthCheckFailed</span><span style=\"color:#E1E4E8\">(ctx, event)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Helper for consistent timeout handling</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">fc </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FlowCoordinator</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">withTimeout</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">timeout</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    operation</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CancelFunc</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    fc.metrics.OperationDuration.</span><span style=\"color:#B392F0\">WithLabelValues</span><span style=\"color:#E1E4E8\">(operation).</span><span style=\"color:#B392F0\">Observe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    start </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ctx, cancel </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithTimeout</span><span style=\"color:#E1E4E8\">(ctx, timeout)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Record duration on completion</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    go</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        &#x3C;-</span><span style=\"color:#E1E4E8\">ctx.</span><span style=\"color:#B392F0\">Done</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        duration </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(start).</span><span style=\"color:#B392F0\">Seconds</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        fc.metrics.OperationDuration.</span><span style=\"color:#B392F0\">WithLabelValues</span><span style=\"color:#E1E4E8\">(operation).</span><span style=\"color:#B392F0\">Observe</span><span style=\"color:#E1E4E8\">(duration)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> ctx, cancel</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Lifecycle Event Definitions (Ready to Use):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/lifecycle/events.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> lifecycle</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/ourproject/internal/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// InstanceEventType represents types of lifecycle events</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> InstanceEventType</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventCreateInstance</span><span style=\"color:#B392F0\">      InstanceEventType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"create_instance\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventContainerStarted</span><span style=\"color:#B392F0\">    InstanceEventType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"container_started\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventRequestAssigned</span><span style=\"color:#B392F0\">     InstanceEventType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"request_assigned\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventRequestCompleted</span><span style=\"color:#B392F0\">    InstanceEventType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"request_completed\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventRequestFailed</span><span style=\"color:#B392F0\">       InstanceEventType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"request_failed\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventTTLExpired</span><span style=\"color:#B392F0\">          InstanceEventType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"ttl_expired\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventIdleTimeout</span><span style=\"color:#B392F0\">         InstanceEventType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"idle_timeout\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventScaleDownSignal</span><span style=\"color:#B392F0\">     InstanceEventType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"scale_down_signal\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventDrainCompleted</span><span style=\"color:#B392F0\">      InstanceEventType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"drain_completed\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventForceTerminate</span><span style=\"color:#B392F0\">      InstanceEventType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"force_terminate\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventHealthCheckFailed</span><span style=\"color:#B392F0\">   InstanceEventType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"health_check_failed\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// InstanceEvent represents a lifecycle event</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> InstanceEvent</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Type        </span><span style=\"color:#B392F0\">InstanceEventType</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    InstanceID  </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    FunctionName </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Timestamp   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Data        </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">interface</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Source      </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewInstanceEvent creates a new lifecycle event</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewInstanceEvent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">eventType</span><span style=\"color:#B392F0\"> InstanceEventType</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">instance</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionInstance</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    source</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">InstanceEvent</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#B392F0\"> InstanceEvent</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Type:        eventType,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        InstanceID:  instance.ID,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        FunctionName: instance.FunctionName,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Timestamp:   time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Data:        </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">interface</span><span style=\"color:#E1E4E8\">{}),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Source:      source,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// EventDispatcher manages event distribution</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> EventDispatcher</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    subscribers </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">chan</span><span style=\"color:#B392F0\"> InstanceEvent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu          </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">RWMutex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Subscribe adds a subscriber for events</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">ed </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">EventDispatcher</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Subscribe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">id</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">bufferSize</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">&#x3C;-chan</span><span style=\"color:#B392F0\"> InstanceEvent</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ed.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> ed.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ch </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">chan</span><span style=\"color:#B392F0\"> InstanceEvent</span><span style=\"color:#E1E4E8\">, bufferSize)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ed.subscribers[id] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> ch</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> ch</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Publish sends an event to all subscribers</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">ed </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">EventDispatcher</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Publish</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">event</span><span style=\"color:#B392F0\"> InstanceEvent</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ed.mu.</span><span style=\"color:#B392F0\">RLock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> ed.mu.</span><span style=\"color:#B392F0\">RUnlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, ch </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> ed.subscribers {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        select</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        case</span><span style=\"color:#E1E4E8\"> ch </span><span style=\"color:#F97583\">&#x3C;-</span><span style=\"color:#E1E4E8\"> event:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // Event sent successfully</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        default</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // Channel full, drop event (monitor this)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"core-logic-skeleton-code\">Core Logic Skeleton Code</h4>\n<p><strong>Synchronous Invocation Handler (To Implement):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/flows/synchronous.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> flows</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/ourproject/internal/gateway</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/ourproject/internal/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/ourproject/internal/lifecycle</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// SynchronousInvoker handles synchronous function invocations</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> SynchronousInvoker</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    router       </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">gateway</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Router</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    eventDispatcher </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">lifecycle</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">EventDispatcher</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    metrics      </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Metrics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    config       </span><span style=\"color:#B392F0\">SyncInvokerConfig</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> SyncInvokerConfig</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MaxQueueTime      </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RetryOnColdStart  </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MaxRetries        </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EnableStickyRouting </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Invoke handles a synchronous invocation request</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">si </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">SynchronousInvoker</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Invoke</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    req</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationResponse</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Validate the request has all required fields</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Check req.FunctionName, req.Payload, req.Deadline</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Return error if validation fails</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Record invocation start in metrics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Use si.metrics.RecordInvocation() to track start time</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Increment concurrency counter for the function</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Route the request through the router</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Call si.router.Route(ctx, req) to get response</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Handle context cancellation and deadlines</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Process the response</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // If error, determine if retry is appropriate (cold start timeout)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // For retryable errors, implement exponential backoff with MaxRetries</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Record completion metrics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Record duration, memory usage, success/failure</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Decrement concurrency counter</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Handle sticky session if enabled</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // If EnableStickyRouting and successful, store instance preference</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // For subsequent requests from same client, use PreferredInstanceID</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 7: Return final response or error</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Ensure error wrapping for proper error types (timeout vs. function error)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#6A737D\"> // Replace with actual implementation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// handleColdStartRetry determines if a cold start timeout should be retried</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">si </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">SynchronousInvoker</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">handleColdStartRetry</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    originalErr</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">attempt</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Check if error is a cold start timeout</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Look for \"container startup timeout\" or similar patterns</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Verify we haven't exceeded MaxRetries</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Return false if attempt >= si.config.MaxRetries</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Check if retry is enabled in config</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Return false if !si.config.RetryOnColdStart</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Calculate backoff delay</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Use exponential backoff: delay = baseDelay * (2^attempt)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Implement jitter to avoid thundering herd</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Wait for backoff period with context awareness</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Use time.Sleep or &#x3C;-time.After with select on ctx.Done()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Return true to indicate retry should be attempted</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#6A737D\"> // Replace with actual implementation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Instance State Machine (To Implement):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/lifecycle/statemachine.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> lifecycle</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/ourproject/internal/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// StateMachine manages state transitions for FunctionInstance</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> StateMachine</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    instance </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionInstance</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu       </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">RWMutex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    handlers </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionInstanceState</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#B392F0\">StateHandler</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    eventCh  </span><span style=\"color:#F97583\">chan</span><span style=\"color:#B392F0\"> InstanceEvent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// StateHandler processes events for a specific state</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> StateHandler</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    HandleEvent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">event</span><span style=\"color:#B392F0\"> InstanceEvent</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">        instance</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionInstance</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionInstanceState</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Transition performs a state transition with validation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">sm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">StateMachine</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Transition</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    newState</span><span style=\"color:#B392F0\"> types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionInstanceState</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">reason</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    sm.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> sm.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Validate transition is allowed</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Check validTransitions[sm.instance.State][newState] map</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Return error if transition is invalid</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Execute exit actions for current state</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Call sm.handlers[sm.instance.State].Exit() if exists</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Clean up resources specific to current state</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Update instance state</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Set sm.instance.State = newState</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Update timestamps based on state (LastUsedAt for ACTIVE, etc.)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Execute entry actions for new state</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Call sm.handlers[newState].Enter() if exists</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Initialize resources needed for new state</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Log the transition for observability</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Use structured logging with instance ID, old state, new state, reason</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Publish state change event</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Send to eventCh for subscribers (monitoring, scaling decisions)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 7: Update metrics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Decrement counter for old state, increment for new state</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#6A737D\"> // Replace with actual implementation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ProcessEvent handles incoming lifecycle events</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">sm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">StateMachine</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ProcessEvent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">event</span><span style=\"color:#B392F0\"> InstanceEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Get current state handler</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // handler := sm.handlers[sm.instance.State]</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Return error if no handler for current state</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Delegate event handling to state-specific handler</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // newState, err := handler.HandleEvent(ctx, event, sm.instance)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Return error if handler returns error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Transition to new state if different</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // if newState != sm.instance.State {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //     return sm.Transition(ctx, newState, string(event.Type))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Handle same-state events (e.g., heartbeat in WARM state)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Update instance metadata without state change</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#6A737D\"> // Replace with actual implementation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// validateTransition defines allowed state transitions</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">sm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">StateMachine</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">validateTransition</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">oldState</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">newState</span><span style=\"color:#B392F0\"> types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionInstanceState</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO: Implement validation logic based on state transition table</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Return true only for allowed transitions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Example: PROVISIONING -> WARM (allowed), WARM -> PROVISIONING (not allowed)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> false</span><span style=\"color:#6A737D\"> // Replace with actual implementation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"language-specific-hints\">Language-Specific Hints</h4>\n<ol>\n<li><p><strong>Context Propagation</strong>: Use <code>context.Context</code> consistently through the call chain. Create derived contexts with <code>context.WithTimeout()</code> for each stage (gateway, routing, forwarding) to ensure proper timeout cascading.</p>\n</li>\n<li><p><strong>Error Wrapping</strong>: Use <code>fmt.Errorf()</code> with <code>%w</code> verb to wrap errors while preserving the original error type for downstream handling decisions.</p>\n</li>\n<li><p><strong>Concurrent State Updates</strong>: Use <code>sync.RWMutex</code> for <code>FunctionInstance</code> state fields. For counters like <code>activeReqs</code>, use <code>atomic</code> operations (<code>atomic.AddInt32</code>, <code>atomic.LoadInt32</code>) for better performance.</p>\n</li>\n<li><p><strong>Channel Patterns</strong>: Use buffered channels for event distribution. Size buffers based on expected throughput (e.g., 100 for event bus). Always include <code>select</code> with <code>default</code> case or monitor channel capacity to prevent deadlocks.</p>\n</li>\n<li><p><strong>Metrics Collection</strong>: Use Prometheus histograms with appropriate buckets for timing metrics (e.g., <code>prometheus.DefBuckets</code> for seconds). Label metrics with <code>function_name</code> and <code>instance_id</code> for granular observability.</p>\n</li>\n<li><p><strong>Graceful Shutdown</strong>: Implement <code>Shutdown()</code> methods that first stop accepting new requests, wait for in-flight requests with a timeout, then clean up resources. Use <code>sync.WaitGroup</code> to track active goroutines.</p>\n</li>\n</ol>\n<h4 id=\"debugging-tips\">Debugging Tips</h4>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>How to Diagnose</th>\n<th>Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Request times out immediately</td>\n<td>No warm instances and cold start timeout too short</td>\n<td>Check warm pool metrics, container startup logs</td>\n<td>Increase cold start timeout, configure predictive warming</td>\n</tr>\n<tr>\n<td>Instance stuck in PROVISIONING</td>\n<td>Container image pull failure or resource constraints</td>\n<td>Check container manager logs, docker daemon status</td>\n<td>Verify base images exist, increase resource limits</td>\n</tr>\n<tr>\n<td>Memory usage grows indefinitely</td>\n<td>Instance not being returned to pool after errors</td>\n<td>Monitor instance state transitions, check error handling in router</td>\n<td>Ensure <code>ReleaseInstance</code> is called in all code paths</td>\n</tr>\n<tr>\n<td>Queue depth constantly high</td>\n<td>Insufficient instances for load</td>\n<td>Check scaling metrics, concurrency limits</td>\n<td>Adjust scaling thresholds, increase MaxInstances limit</td>\n</tr>\n<tr>\n<td>Stale instances in warm pool</td>\n<td>TTL/idle timeout not enforced</td>\n<td>Check <code>cleanupExpired</code> goroutine, instance timestamps</td>\n<td>Ensure cleanup goroutine is running, verify time calculations</td>\n</tr>\n<tr>\n<td>Response times spike intermittently</td>\n<td>Garbage collection in long-running instances</td>\n<td>Monitor Go GC pauses, memory allocation patterns</td>\n<td>Implement instance rotation, limit instance lifetime</td>\n</tr>\n</tbody></table>\n<h2 id=\"error-handling-and-edge-cases\">Error Handling and Edge Cases</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 2 (Execution Environment), Milestone 3 (Cold Start Optimization), Milestone 4 (Request Routing), Milestone 5 (Auto-Scaling)</p>\n</blockquote>\n<p>In a distributed serverless runtime, <strong>errors are not exceptional—they&#39;re expected</strong>. Functions execute in ephemeral, isolated environments with strict resource limits, and the control plane must manage thousands of these environments simultaneously. This section catalogs the <strong>failure modes</strong> our system will encounter and the <strong>recovery strategies</strong> that maintain system resilience while meeting service-level objectives. The design follows a <strong>defense-in-depth</strong> approach: each component has local error handling, while the <code>FlowCoordinator</code> orchestrates cross-component recovery when local strategies fail.</p>\n<h3 id=\"the-emergency-response-analogy\">The Emergency Response Analogy</h3>\n<p>Think of the runtime as a <strong>city emergency response system</strong>. When a fire (error) breaks out in one building (function instance), the system must:</p>\n<ol>\n<li><strong>Detect the emergency quickly</strong> (smoke alarms, 911 calls)</li>\n<li><strong>Contain the damage</strong> (firefighters cordon off the building)</li>\n<li><strong>Evacuate and reroute</strong> (redirect traffic, provide alternate routes)</li>\n<li><strong>Restore normal operations</strong> (repair the building or rebuild it)</li>\n<li><strong>Learn and improve</strong> (analyze what caused the fire to prevent recurrence)</li>\n</ol>\n<p>Our error handling follows this same pattern: detection → containment → redirection → recovery → learning. Each component has &quot;sensors&quot; (health checks, timeouts, metrics) and &quot;responders&quot; (circuit breakers, retry logic, instance replacement) that work together to maintain system stability.</p>\n<h3 id=\"failure-modes-and-mitigations\">Failure Modes and Mitigations</h3>\n<p>The table below categorizes failures by their <strong>failure domain</strong>—whether they occur in the data plane (during function execution) or control plane (during orchestration). Each row specifies the failure, how we detect it, and the automatic recovery action. The <strong>recovery principle</strong> column explains the underlying strategy guiding the specific actions.</p>\n<table>\n<thead>\n<tr>\n<th>Failure Domain</th>\n<th>Failure Mode</th>\n<th>Description</th>\n<th>Detection Mechanism</th>\n<th>Recovery Action</th>\n<th>Recovery Principle</th>\n<th>Component(s) Involved</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Function Execution</strong></td>\n<td><strong>Out-of-Memory (OOM) Kill</strong></td>\n<td>Function exceeds its <code>MemoryMB</code> limit, triggering Linux OOM killer or container runtime termination</td>\n<td>Container exits with SIGKILL (137) or OOM-specific exit code; <code>ContainerManager.GetContainerStats()</code> shows abrupt termination; <code>Container</code> status changes to <code>StatusDead</code></td>\n<td>1. <strong>Immediate</strong>: Record OOM in <code>Metrics.InvocationErrors</code> with label <code>error_type=&quot;oom&quot;</code><br>2. <strong>Instance cleanup</strong>: Call <code>CleanupInstance()</code> to remove the failed container<br>3. <strong>Request retry</strong>: For synchronous invocations with <code>RetryOnColdStart=true</code>, retry on a fresh instance (max 1 retry for OOM)<br>4. <strong>Circuit breaker</strong>: Increment failure count in <code>routedInstance.failures</code>, possibly tripping circuit breaker</td>\n<td><strong>Fail-fast with controlled retry</strong>: OOMs are likely due to function behavior, so retry cautiously with backpressure</td>\n<td><code>Executor</code>, <code>ContainerManager</code>, <code>Router</code>, <code>SynchronousInvoker</code></td>\n</tr>\n<tr>\n<td><strong>Function Execution</strong></td>\n<td><strong>Timeout Exceeded</strong></td>\n<td>Function execution exceeds configured <code>Timeout</code> (wall-clock time)</td>\n<td><code>Executor.ExecuteFunction()</code> context deadline exceeded; <code>InvocationStatus</code> changes to <code>InvocationStatusTimeout</code>; Request <code>Deadline</code> passes <code>TimeRemaining() &lt;= 0</code></td>\n<td>1. <strong>Terminate execution</strong>: Call <code>StopContainer()</code> with <code>timeout=0</code> (force kill)<br>2. <strong>Cleanup</strong>: Remove container via <code>RemoveContainer()</code><br>3. <strong>No retry by default</strong>: Return timeout error to client (retries would likely timeout again)<br>4. <strong>Circuit breaker</strong>: Mark instance as unhealthy if multiple timeouts occur</td>\n<td><strong>Graceful degradation</strong>: Timeouts indicate function slowness, not transient failure; avoid retry storms</td>\n<td><code>Executor</code>, <code>Router</code>, <code>Gateway</code></td>\n</tr>\n<tr>\n<td><strong>Function Execution</strong></td>\n<td><strong>Function Crash (Non-zero exit)</strong></td>\n<td>Function process exits with non-zero exit code (application error, panic, unhandled exception)</td>\n<td>Container exits with non-zero status; <code>Container.Status</code> becomes <code>StatusExited</code>; <code>ExecuteInContainer()</code> returns error with exit code</td>\n<td>1. <strong>Error classification</strong>: Parse exit code to determine if retryable (e.g., temporary file error) or non-retryable (e.g., syntax error)<br>2. <strong>Retry policy</strong>: For retryable errors, retry on same instance if healthy, otherwise new instance (max 2 retries)<br>3. <strong>Instance health</strong>: Increment <code>routedInstance.failures</code>; if exceeds threshold, mark <code>healthy=false</code><br>4. <strong>Metrics</strong>: Record in <code>InvocationErrors</code> with <code>error_type=&quot;crash&quot;</code></td>\n<td><strong>Semantic retry</strong>: Distinguish between transient and permanent failures using exit codes</td>\n<td><code>Executor</code>, <code>Router</code>, <code>SynchronousInvoker</code></td>\n</tr>\n<tr>\n<td><strong>Function Execution</strong></td>\n<td><strong>Sandbox Escape Attempt</strong></td>\n<td>Function attempts to break out of isolation via privileged syscall, container breakout, or resource exhaustion attack</td>\n<td>Seccomp/AppArmor violation (SIGSYS); <code>ContainerManager</code> logs security violation; abnormal resource usage patterns in <code>ContainerStats</code></td>\n<td>1. <strong>Immediate termination</strong>: Kill container via <code>StopContainer()</code> with <code>timeout=0</code><br>2. <strong>Blacklist</strong>: Optionally blacklist function version if repeated violations<br>3. <strong>No retry</strong>: Fail request immediately with security violation error<br>4. <strong>Alert</strong>: Raise security alert to operator</td>\n<td><strong>Zero-tolerance containment</strong>: Security violations are non-retryable and require operator investigation</td>\n<td><code>ContainerManager</code>, <code>Executor</code>, <code>Gateway</code></td>\n</tr>\n<tr>\n<td><strong>Function Execution</strong></td>\n<td><strong>Resource Leak (File descriptors, threads)</strong></td>\n<td>Function exhausts per-container resources without triggering OOM</td>\n<td><code>ContainerStats.PIDs</code> approaches limit; <code>GetContainerStats()</code> shows high FD usage; subsequent invocations fail with &quot;resource unavailable&quot; errors</td>\n<td>1. <strong>Proactive recycling</strong>: <code>WarmPoolManager</code> calls <code>CleanupInstance()</code> between invocations to reset environment<br>2. <strong>Health checks</strong>: Periodic <code>ExecuteInContainer()</code> with simple &quot;ping&quot; command to verify instance health before reuse<br>3. <strong>Instance replacement</strong>: If resource usage exceeds 80% of limit, mark instance for replacement after current invocation</td>\n<td><strong>Preventive maintenance</strong>: Assume functions are buggy; proactively clean and validate between uses</td>\n<td><code>WarmPoolManager</code>, <code>Executor</code>, <code>RuntimeCleaner</code></td>\n</tr>\n<tr>\n<td><strong>Control Plane</strong></td>\n<td><strong>Cold Start Timeout</strong></td>\n<td>Creating/initializing a new instance exceeds acceptable latency (e.g., &gt;10 seconds)</td>\n<td><code>RecordColdStart()</code> measures time from <code>EventCreateInstance</code> to <code>EventContainerStarted</code>; <code>Metrics.ColdStartLatency</code> exceeds threshold; <code>InstanceState</code> stuck in <code>InstanceStateProvisioning</code></td>\n<td>1. <strong>Abandon creation</strong>: Cancel the pending container creation context<br>2. <strong>Retry on alternate node</strong>: For multi-node deployments, retry creation on different worker<br>3. <strong>Fallback to warm</strong>: If available, use existing warm instance even if not ideal (e.g., different version)<br>4. <strong>Queue timeout</strong>: If no instance ready within timeout, fail request with &quot;cold start timeout&quot;</td>\n<td><strong>Time-bound provisioning</strong>: Don&#39;t let slow provisioning block request processing indefinitely</td>\n<td><code>WarmPoolManager</code>, <code>Executor</code>, <code>SynchronousInvoker</code></td>\n</tr>\n<tr>\n<td><strong>Control Plane</strong></td>\n<td><strong>Container Startup Failure</strong></td>\n<td>Container fails to start due to missing base image, invalid command, or runtime conflict</td>\n<td><code>ContainerManager.CreateContainer()</code> or <code>StartContainer()</code> returns error; <code>Container.Status</code> becomes <code>StatusDead</code> without reaching <code>StatusRunning</code></td>\n<td>1. <strong>Exponential backoff</strong>: Delay retry with exponential backoff (1s, 2s, 4s...)<br>2. <strong>Image pre-pull</strong>: Ensure base images are pre-pulled to worker nodes<br>3. <strong>Fallback image</strong>: Use older compatible runtime image if latest fails<br>4. <strong>Alert</strong>: Notify operator of persistent image pull failures</td>\n<td><strong>Degraded operation</strong>: Continue serving other functions while diagnosing image issues</td>\n<td><code>ContainerManager</code>, <code>WarmPoolManager</code>, <code>FlowCoordinator</code></td>\n</tr>\n<tr>\n<td><strong>Request Routing</strong></td>\n<td><strong>Instance Unhealthy (Zombie)</strong></td>\n<td>Instance appears healthy but doesn&#39;t respond to requests (network partition, hung process)</td>\n<td>Health check fails (TCP connection refused, HTTP 5xx); <code>forwardRequest()</code> timeout; <code>CircuitBreaker</code> trips after consecutive failures</td>\n<td>1. <strong>Circuit breaker</strong>: Trip circuit for that instance; stop routing requests to it<br>2. <strong>Replacement</strong>: Schedule instance for termination via <code>EventForceTerminate</code><br>3. <strong>Drain existing</strong>: If instance has <code>activeReqs &gt; 0</code>, wait <code>DrainTimeout</code> before force termination<br>4. <strong>New instance</strong>: Trigger scale-up to replace lost capacity</td>\n<td><strong>Failover with isolation</strong>: Isolate failed instance before removing it to avoid interrupting in-flight requests</td>\n<td><code>Router</code>, <code>CircuitBreaker</code>, <code>FlowCoordinator</code></td>\n</tr>\n<tr>\n<td><strong>Request Routing</strong></td>\n<td><strong>Request Queue Overflow</strong></td>\n<td>Request queue reaches <code>maxSize</code>, unable to accept new requests</td>\n<td><code>RequestQueue.Enqueue()</code> returns &quot;queue full&quot; error; <code>gatewayMetrics.queueDepth</code> at 100% capacity</td>\n<td>1. <strong>Load shedding</strong>: Reject new requests with HTTP 503 &quot;Service Unavailable&quot;<br>2. <strong>Priority-based eviction</strong>: If using priority queue, evict lowest-priority requests first<br>3. <strong>Emergency scale-up</strong>: Bypass cooldown to scale up immediately<br>4. <strong>Client backoff</strong>: Include <code>Retry-After</code> header in 503 response</td>\n<td><strong>Graceful load shedding</strong>: Better to reject some requests than fail all due to overload</td>\n<td><code>Gateway</code>, <code>RequestQueue</code>, <code>Scaler</code></td>\n</tr>\n<tr>\n<td><strong>Request Routing</strong></td>\n<td><strong>Gateway Timeout</strong></td>\n<td>Entire request path exceeds <code>GatewayTimeout</code> before reaching function</td>\n<td><code>Gateway</code> middleware cancels context after timeout; <code>InvocationStatus</code> remains <code>InvocationStatusPending</code></td>\n<td>1. <strong>Cancel downstream</strong>: Cancel context for all downstream operations (queue, routing, execution)<br>2. <strong>Cleanup</strong>: If request was dequeued but not yet assigned, return to queue (if idempotent)<br>3. <strong>Client response</strong>: Return HTTP 504 &quot;Gateway Timeout&quot;<br>4. <strong>Avoid retry storm</strong>: Client should use exponential backoff after gateway timeout</td>\n<td><strong>Holistic timeout propagation</strong>: All components respect the same timeout chain</td>\n<td><code>Gateway</code>, <code>Router</code>, <code>RequestQueue</code></td>\n</tr>\n<tr>\n<td><strong>Auto-Scaling</strong></td>\n<td><strong>Scaling Thrashing</strong></td>\n<td>Rapid oscillation between scale-up and scale-down due to metric noise or misconfigured thresholds</td>\n<td><code>Scaler</code> metrics show frequent <code>ScaleDecision</code> changes; <code>ScaleUp</code> immediately followed by <code>ScaleDown</code>; high <code>ContainerOperations</code> churn rate</td>\n<td>1. <strong>Hysteresis</strong>: Use different thresholds for scale-up vs scale-down (e.g., scale-up at 70% concurrency, scale-down at 30%)<br>2. <strong>Cooldown periods</strong>: Enforce <code>ScaleUpCooldown</code> and <code>ScaleDownCooldown</code> between scale actions<br>3. <strong>Smoothing</strong>: Use moving averages instead of instantaneous metrics<br>4. <strong>Minimum instance lifetime</strong>: Ensure instances live for at least <code>InstanceTTL</code> before scale-down</td>\n<td><strong>Stability over optimality</strong>: Prefer slightly suboptimal scaling to constant churn</td>\n<td><code>Scaler</code>, <code>MetricsCollector</code></td>\n</tr>\n<tr>\n<td><strong>Auto-Scaling</strong></td>\n<td><strong>Scale-to-Zero Race Condition</strong></td>\n<td>Last instance terminates while new request arrives</td>\n<td><code>InstanceState</code> transitions to <code>InstanceStateTerminated</code> while request in flight or queued</td>\n<td>1. <strong>Termination delay</strong>: When scaling to zero, wait <code>IdleTimeout + buffer</code> before terminating last instance<br>2. <strong>Recreate on demand</strong>: If request arrives after termination, trigger cold start<br>3. <strong>Request preservation</strong>: Maintain queue across scale-to-zero transitions<br>4. <strong>Idle instance promotion</strong>: Keep one instance in <code>InstanceStateWarm</code> if requests pending</td>\n<td><strong>Lazy termination</strong>: Verify true idle state before terminating last instance</td>\n<td><code>Scaler</code>, <code>WarmPoolManager</code>, <code>Router</code></td>\n</tr>\n<tr>\n<td><strong>Data Persistence</strong></td>\n<td><strong>Artifact Storage Unavailable</strong></td>\n<td>Backend storage (S3, filesystem) fails during function package upload or retrieval</td>\n<td><code>ProcessUpload()</code> returns storage error; <code>GetArtifact()</code> fails; <code>ArtifactStorage</code> health check fails</td>\n<td>1. <strong>Retry with backoff</strong>: Retry storage operations with exponential backoff<br>2. <strong>Local cache</strong>: Use local filesystem cache for frequently accessed artifacts<br>3. <strong>Degraded upload</strong>: Accept uploads but mark as &quot;pending storage&quot;<br>4. <strong>Read-only mode</strong>: If storage completely unavailable, serve existing functions but reject new deployments</td>\n<td><strong>Caching with eventual consistency</strong>: Prefer serving stale artifacts over complete failure</td>\n<td><code>Coordinator</code>, <code>ArtifactStorage</code></td>\n</tr>\n<tr>\n<td><strong>Lifecycle Management</strong></td>\n<td><strong>Drain Stuck</strong></td>\n<td>Instance in <code>InstanceStateDraining</code> never completes (hung request, infinite loop)</td>\n<td><code>Instance</code> remains in <code>InstanceStateDraining</code> beyond <code>DrainTimeout</code>; <code>activeReqs</code> stays &gt;0</td>\n<td>1. <strong>Force termination</strong>: After <code>DrainTimeout</code>, send <code>EventForceTerminate</code><br>2. <strong>Lossy shutdown</strong>: Kill container via <code>StopContainer()</code> with <code>timeout=0</code><br>3. <strong>Client notification</strong>: If possible, notify client of interrupted request<br>4. <strong>Post-mortem</strong>: Log container state before termination for debugging</td>\n<td><strong>Bounded graceful period</strong>: Graceful shutdown has a time limit</td>\n<td><code>StateMachine</code>, <code>FlowCoordinator</code>, <code>ContainerManager</code></td>\n</tr>\n<tr>\n<td><strong>Multi-Tenancy</strong></td>\n<td><strong>Noisy Neighbor</strong></td>\n<td>One function monopolizes shared resources (CPU, I/O), affecting others</td>\n<td><code>ContainerStats</code> shows sustained high CPU/IO for one container while others starve; elevated <code>InvocationDuration</code> for unaffected functions</td>\n<td>1. <strong>Resource enforcement</strong>: Strict <code>CPUQuota</code> via cgroups CPU shares<br>2. <strong>I/O throttling</strong>: Use blkio cgroup to limit disk I/O<br>3. <strong>Workload isolation</strong>: Schedule aggressive functions on separate worker nodes<br>4. <strong>SLA enforcement</strong>: Preemptively throttle or reject requests from misbehaving functions</td>\n<td><strong>Strong isolation boundaries</strong>: Assume worst-case behavior and enforce hard limits</td>\n<td><code>ContainerManager</code>, <code>CGroupHelper</code>, <code>Scheduler</code></td>\n</tr>\n<tr>\n<td><strong>Network</strong></td>\n<td><strong>Network Partition</strong></td>\n<td>Worker node loses connectivity to control plane or storage</td>\n<td>Health checks fail; <code>ContainerManager.HealthCheck()</code> returns error; metrics stop flowing</td>\n<td>1. <strong>Fencing</strong>: Control plane marks node as unhealthy and stops routing to it<br>2. <strong>Self-termination</strong>: Worker node self-terminates its containers after grace period<br>3. <strong>Reconciliation</strong>: Control plane recreates lost instances on healthy nodes<br>4. <strong>Client redirection</strong>: Update DNS/routing to bypass partitioned node</td>\n<td><strong>Fail-stop then rebuild</strong>: Assume partitioned nodes are lost and rebuild elsewhere</td>\n<td><code>FlowCoordinator</code>, <code>Router</code>, <code>ContainerManager</code></td>\n</tr>\n</tbody></table>\n<h3 id=\"error-recovery-architecture\">Error Recovery Architecture</h3>\n<p>The table above shows individual failure modes, but the system&#39;s resilience comes from <strong>coordinated recovery across components</strong>. The architecture follows these principles:</p>\n<ol>\n<li><strong>Defense in Depth</strong>: Each component handles local errors, with escalation to <code>FlowCoordinator</code> for cross-component issues</li>\n<li><strong>Graceful Degradation</strong>: When optimal operation isn&#39;t possible, provide degraded but functional service</li>\n<li><strong>Observability-Driven</strong>: All errors are captured in metrics and logs for analysis and improvement</li>\n<li><strong>Idempotent Operations</strong>: Recovery actions can be safely retried without double side effects</li>\n</ol>\n<p>The <code>FlowCoordinator</code> serves as the <strong>central nervous system</strong> for error recovery. It subscribes to <code>InstanceEvent</code> streams from all components and implements the following recovery state machine:</p>\n<table>\n<thead>\n<tr>\n<th>Current State</th>\n<th>Trigger Event</th>\n<th>Recovery Action</th>\n<th>Next State</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>InstanceHealthy</code></td>\n<td><code>EventHealthCheckFailed</code> (1x)</td>\n<td>Mark instance <code>healthy=false</code> in router</td>\n<td><code>InstanceUnhealthy</code></td>\n</tr>\n<tr>\n<td><code>InstanceUnhealthy</code></td>\n<td><code>EventHealthCheckFailed</code> (3x)</td>\n<td>Trip circuit breaker; schedule replacement</td>\n<td><code>InstanceReplacing</code></td>\n</tr>\n<tr>\n<td><code>InstanceReplacing</code></td>\n<td><code>EventCreateInstance</code> (new)</td>\n<td>Route traffic to new instance</td>\n<td><code>InstanceHealthy</code></td>\n</tr>\n<tr>\n<td><code>InstanceReplacing</code></td>\n<td><code>EventForceTerminate</code> (old)</td>\n<td>Force kill old container</td>\n<td><code>InstanceTerminated</code></td>\n</tr>\n<tr>\n<td><code>ScaleOscillation</code></td>\n<td>Consecutive <code>ScaleUp</code>/<code>ScaleDown</code></td>\n<td>Increase cooldown periods; log alert</td>\n<td><code>ScaleStabilized</code></td>\n</tr>\n<tr>\n<td><code>StorageDegraded</code></td>\n<td>Storage errors &gt; threshold</td>\n<td>Enable read-only mode; alert operator</td>\n<td><code>StorageMaintenance</code></td>\n</tr>\n</tbody></table>\n<h3 id=\"common-error-propagation-patterns\">Common Error Propagation Patterns</h3>\n<p>When an error occurs, it propagates through the system following these paths:</p>\n<ol>\n<li><strong>Execution Error → Router → Client</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   Function OOM → Executor detects exit code → Router.forwardRequest() returns error → \n   Router.updateInstanceHealth() marks instance unhealthy → Gateway returns 500 to client</code></pre></div>\n\n<ol start=\"2\">\n<li><strong>Infrastructure Error → FlowCoordinator → Auto-recovery</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   Container startup failure → WarmPoolManager emits EventContainerStartFailed →\n   FlowCoordinator.handleEvent() → Scaler.evaluateScaling() triggers scale-up →\n   New instance created → Router updates routing table</code></pre></div>\n\n<ol start=\"3\">\n<li><strong>Resource Exhaustion → Multiple Components → Load Shedding</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>   Memory pressure → Multiple OOM events → Metrics show high error rate →\n   Scaler triggers scale-up → RequestQueue fills → Gateway returns 503 →\n   Client backs off → System stabilizes</code></pre></div>\n\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<blockquote>\n<p><strong>Technology Recommendations</strong></p>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Error Detection</td>\n<td>Exit code parsing, timeout contexts</td>\n<td>eBPF probes for deep container inspection, distributed tracing</td>\n</tr>\n<tr>\n<td>Health Checking</td>\n<td>TCP/HTTP health checks</td>\n<td>Custom protocol with version/checksum validation</td>\n</tr>\n<tr>\n<td>Circuit Breaking</td>\n<td>Simple failure count threshold</td>\n<td>Adaptive circuit breaking based on latency percentiles</td>\n</tr>\n<tr>\n<td>Retry Logic</td>\n<td>Fixed-count retry with jitter</td>\n<td>Exponential backoff with retry budgets across function boundaries</td>\n</tr>\n<tr>\n<td>Error Metrics</td>\n<td>Prometheus counters with error type labels</td>\n<td>Structured logging with error causality chains</td>\n</tr>\n</tbody></table>\n</blockquote>\n<h4 id=\"error-handling-infrastructure\">Error Handling Infrastructure</h4>\n<p>Create a shared error handling package that standardizes error classification and recovery policies:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/errors/errors.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> errors</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">errors</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ErrorType categorizes errors for metrics and recovery decisions</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ErrorType</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ErrorTypeOOM</span><span style=\"color:#B392F0\">          ErrorType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"oom\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ErrorTypeTimeout</span><span style=\"color:#B392F0\">      ErrorType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"timeout\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ErrorTypeCrash</span><span style=\"color:#B392F0\">        ErrorType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"crash\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ErrorTypeSandbox</span><span style=\"color:#B392F0\">      ErrorType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"sandbox_escape\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ErrorTypeNetwork</span><span style=\"color:#B392F0\">      ErrorType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"network\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ErrorTypeStorage</span><span style=\"color:#B392F0\">      ErrorType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"storage\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ErrorTypeStartup</span><span style=\"color:#B392F0\">      ErrorType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"startup\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ErrorTypeHealthCheck</span><span style=\"color:#B392F0\">  ErrorType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"health_check\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ClassifiedError wraps an error with classification metadata</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ClassifiedError</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Err         </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Type        </span><span style=\"color:#B392F0\">ErrorType</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Retryable   </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExitCode    </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    InstanceID  </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Function    </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Timestamp   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RecoveryPolicy determines retry behavior based on error type</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RecoveryPolicy</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MaxRetries      </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    BackoffBase     </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    BackoffMax      </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RetryOnSameInstance </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// PolicyForErrorType returns recovery policy for error type</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> PolicyForErrorType</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#B392F0\"> ErrorType</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RecoveryPolicy</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    switch</span><span style=\"color:#E1E4E8\"> t {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> ErrorTypeOOM:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> RecoveryPolicy</span><span style=\"color:#E1E4E8\">{MaxRetries: </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, BackoffBase: </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">, RetryOnSameInstance: </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> ErrorTypeTimeout:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> RecoveryPolicy</span><span style=\"color:#E1E4E8\">{MaxRetries: </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">} </span><span style=\"color:#6A737D\">// No retry for timeouts</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> ErrorTypeCrash:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> RecoveryPolicy</span><span style=\"color:#E1E4E8\">{MaxRetries: </span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, BackoffBase: </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Millisecond, RetryOnSameInstance: </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> ErrorTypeNetwork:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> RecoveryPolicy</span><span style=\"color:#E1E4E8\">{MaxRetries: </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">, BackoffBase: </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second, RetryOnSameInstance: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    default</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> RecoveryPolicy</span><span style=\"color:#E1E4E8\">{MaxRetries: </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, BackoffBase: </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ShouldRetry determines if error should be retried based on policy and attempt count</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> ShouldRetry</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">ClassifiedError</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">attempt</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    policy </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> PolicyForErrorType</span><span style=\"color:#E1E4E8\">(err.Type)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> err.Retryable </span><span style=\"color:#F97583\">&#x26;&#x26;</span><span style=\"color:#E1E4E8\"> attempt </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> policy.MaxRetries</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"enhanced-executor-with-error-classification\">Enhanced Executor with Error Classification</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/executor/executor.go (partial)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> executor</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">syscall</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/ourproject/internal/errors</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// executeWithRecovery wraps function execution with error classification and recovery</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Executor</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">executeWithRecovery</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">def</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationResponse</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> attempt </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> lastErr </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">errors</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ClassifiedError</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> attempt </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; attempt </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> maxTotalAttempts; attempt</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        resp, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> e.</span><span style=\"color:#B392F0\">executeSingle</span><span style=\"color:#E1E4E8\">(ctx, def, req)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#E1E4E8\"> resp, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Classify the error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        classified </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> e.</span><span style=\"color:#B392F0\">classifyExecutionError</span><span style=\"color:#E1E4E8\">(err, def, req)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        lastErr </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> classified</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Record metrics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        e.metrics.InvocationErrors.</span><span style=\"color:#B392F0\">WithLabelValues</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">(classified.Type), def.Name).</span><span style=\"color:#B392F0\">Inc</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Check if we should retry</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">errors.</span><span style=\"color:#B392F0\">ShouldRetry</span><span style=\"color:#E1E4E8\">(classified, attempt) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            break</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Apply backoff if needed</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        policy </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">PolicyForErrorType</span><span style=\"color:#E1E4E8\">(classified.Type)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> policy.BackoffBase </span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            select</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">ctx.</span><span style=\"color:#B392F0\">Done</span><span style=\"color:#E1E4E8\">():</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, ctx.</span><span style=\"color:#B392F0\">Err</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">time.</span><span style=\"color:#B392F0\">After</span><span style=\"color:#E1E4E8\">(policy.BackoffBase </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#F97583\"> &#x3C;&#x3C;</span><span style=\"color:#E1E4E8\"> attempt)): </span><span style=\"color:#6A737D\">// Exponential backoff</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // Continue to retry</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // If not retrying on same instance, clean up and get new instance</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">policy.RetryOnSameInstance {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // TODO: Clean up current container and acquire fresh instance</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // All retries exhausted or non-retryable error</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">errors</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ClassifiedError</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Err:        fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"execution failed after </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> attempts: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, attempt</span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, lastErr.Err),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Type:       lastErr.Type,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Retryable:  </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        InstanceID: lastErr.InstanceID,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Function:   def.Name,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Timestamp:  time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// classifyExecutionError maps raw execution errors to classified types</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Executor</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">classifyExecutionError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">rawErr</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">def</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">FunctionDefinition</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">req</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">errors</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ClassifiedError</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Check if error is context deadline exceeded → ErrorTypeTimeout</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Parse exit code: 137 (SIGKILL) → ErrorTypeOOM</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Check seccomp violation → ErrorTypeSandbox  </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Check network errors → ErrorTypeNetwork</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Default to ErrorTypeCrash for other non-zero exits</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Set Retryable based on error type and exit code</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 7: Extract instance ID from context or request metadata</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">errors</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ClassifiedError</span><span style=\"color:#E1E4E8\">{Type: errors.ErrorTypeCrash, Retryable: </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"flowcoordinator-event-handler\">FlowCoordinator Event Handler</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/coordinator/flow_coordinator.go (partial)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">fc </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FlowCoordinator</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">handleEvent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">event</span><span style=\"color:#B392F0\"> lifecycle</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InstanceEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    fc.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> fc.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    switch</span><span style=\"color:#E1E4E8\"> event.Type {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> lifecycle.EventHealthCheckFailed:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Get instance from router's routing table</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Increment failure count for the instance</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: If failure count > threshold, trip circuit breaker</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Schedule instance replacement via Scaler</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 5: Emit EventForceTerminate if instance is unrecoverable</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> lifecycle.EventRequestFailed:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Parse error type from event.Data</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Update instance health in router</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: If error indicates resource exhaustion, trigger scale-up</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Record failure in Metrics.InvocationErrors</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> lifecycle.EventContainerStarted:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Update instance state to InstanceStateWarm</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: Register instance with router</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: Update warm pool metrics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> lifecycle.EventTTLExpired:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 1: Check if instance has active requests (activeReqs > 0)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 2: If no active requests, terminate immediately</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 3: If has active requests, transition to InstanceStateDraining</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // TODO 4: Set drain timeout</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"debugging-error-scenarios\">Debugging Error Scenarios</h4>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>How to Diagnose</th>\n<th>Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Functions timeout immediately</strong></td>\n<td>Cold start latency exceeds timeout; misconfigured timeout values</td>\n<td>Check <code>Metrics.ColdStartLatency</code> percentiles; verify function <code>Timeout</code> configuration</td>\n<td>Increase function timeout; improve cold start optimization; use provisioned concurrency</td>\n</tr>\n<tr>\n<td><strong>High OOM error rate</strong></td>\n<td>Memory limits too low; function has memory leak</td>\n<td>Check <code>ContainerStats.MemoryUsage</code> before OOM; compare with <code>MemoryMB</code> limit</td>\n<td>Increase memory limit; add memory profiling to functions; implement garbage collection between invocations</td>\n</tr>\n<tr>\n<td><strong>Request queue constantly full</strong></td>\n<td>Insufficient instances; scaling too slow</td>\n<td>Check <code>queueDepth</code> metrics; examine <code>Scaler</code> decisions and cooldown periods</td>\n<td>Adjust scaling thresholds; reduce cooldown periods; increase max instances</td>\n</tr>\n<tr>\n<td><strong>Instance churn (high create/delete rate)</strong></td>\n<td>Scaling thrashing; idle timeout too short</td>\n<td>Check <code>ContainerOperations</code> counter; examine scale decision log for rapid oscillations</td>\n<td>Implement hysteresis; increase cooldown periods; adjust scale thresholds</td>\n</tr>\n<tr>\n<td><strong>Functions return &quot;connection refused&quot;</strong></td>\n<td>Instance died but still in routing table; network partition</td>\n<td>Check instance health status in router; verify container actually running</td>\n<td>Implement active health checks; add circuit breakers; reduce health check interval</td>\n</tr>\n<tr>\n<td><strong>Cold starts take &gt;10 seconds</strong></td>\n<td>Large dependencies; slow storage; image pull latency</td>\n<td>Profile cold start phases: image pull, container create, runtime init, handler load</td>\n<td>Use pre-warmed base images; implement dependency caching; use snapshot/restore</td>\n</tr>\n</tbody></table>\n<h4 id=\"testing-error-recovery\">Testing Error Recovery</h4>\n<p>Create integration tests that simulate failures and verify recovery:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Test OOM recovery</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">$</span><span style=\"color:#9ECBFF\"> curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/invoke/leaky-function</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"action\": \"allocate_memory\", \"mb\": 1024}'</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Should return 500 on first attempt, then potentially succeed on retry</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify metrics show ErrorTypeOOM increment</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Test timeout handling  </span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">$</span><span style=\"color:#9ECBFF\"> curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/invoke/slow-function</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"sleep_ms\": 10000}'</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  --max-time</span><span style=\"color:#79B8FF\"> 5</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Should return 504 Gateway Timeout after 5 seconds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify instance is marked unhealthy after multiple timeouts</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Test circuit breaker</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">$</span><span style=\"color:#9ECBFF\"> for</span><span style=\"color:#9ECBFF\"> i</span><span style=\"color:#9ECBFF\"> in</span><span style=\"color:#9ECBFF\"> {1..10}</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/invoke/unhealthy-function</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  done</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># First few should return 500, then circuit should trip and return 503</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify circuit breaker metrics</span></span></code></pre></div>\n\n\n<h2 id=\"testing-strategy\">Testing Strategy</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 1, Milestone 2, Milestone 3, Milestone 4, Milestone 5</p>\n</blockquote>\n<p>The testing strategy for the serverless function runtime follows a <strong>layered pyramid approach</strong>, emphasizing unit tests at the component level, integration tests for cross-component interactions, and end-to-end system tests for complete workflows. Given the system&#39;s distributed nature and reliance on Linux kernel features (cgroups, namespaces), we employ a combination of in-process testing for business logic and container-based testing for isolation features. The testing philosophy prioritizes <strong>deterministic behavior</strong> for core routing and scaling logic while acknowledging <strong>probabilistic outcomes</strong> for race conditions in concurrent scenarios.</p>\n<h3 id=\"testing-philosophy-and-levels\">Testing Philosophy and Levels</h3>\n<p>The testing approach is organized into four distinct levels, each serving a specific verification purpose:</p>\n<ol>\n<li><strong>Unit Tests</strong> - Test individual components in isolation using mocks and fakes for dependencies</li>\n<li><strong>Integration Tests</strong> - Test interactions between 2-3 components with real implementations</li>\n<li><strong>System Tests</strong> - Test complete workflows using containerized test environments</li>\n<li><strong>Property-Based Tests</strong> - Test invariants and edge cases using generated inputs</li>\n</ol>\n<p>The testing pyramid distribution targets 70% unit tests, 20% integration tests, and 10% system tests. Property-based tests supplement each level to uncover edge cases that example-based testing might miss.</p>\n<h4 id=\"unit-testing-strategy\">Unit Testing Strategy</h4>\n<p>Unit tests focus on <strong>pure business logic</strong> without external dependencies. Each component&#39;s public API is tested against a comprehensive matrix of inputs, including error conditions. The table below outlines the key unit testing patterns:</p>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Testing Focus</th>\n<th>Mock Dependencies</th>\n<th>Key Assertions</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Router</code></td>\n<td>Routing logic, load balancing, circuit breaking</td>\n<td><code>InstanceManager</code>, network calls</td>\n<td>Instance selection correctness, circuit breaker state transitions</td>\n</tr>\n<tr>\n<td><code>Scaler</code></td>\n<td>Scaling decisions, metrics aggregation</td>\n<td><code>MetricsCollector</code>, <code>WarmPoolManager</code></td>\n<td>Scale decision triggers, cooldown enforcement, threshold calculations</td>\n</tr>\n<tr>\n<td><code>WarmPoolManager</code></td>\n<td>Pool management, TTL enforcement</td>\n<td><code>ContainerManager</code>, time source</td>\n<td>Pool size limits, instance reuse, cleanup scheduling</td>\n</tr>\n<tr>\n<td><code>Coordinator</code> (packaging)</td>\n<td>Dependency resolution, artifact building</td>\n<td>Filesystem, network calls</td>\n<td>Artifact integrity, dependency conflict handling</td>\n</tr>\n<tr>\n<td><code>Executor</code></td>\n<td>Container lifecycle, resource limits</td>\n<td><code>ContainerManager</code>, cgroup operations</td>\n<td>Resource limit application, timeout enforcement</td>\n</tr>\n</tbody></table>\n<p>Each unit test follows the <strong>Arrange-Act-Assert</strong> pattern with clear separation of test setup, execution, and verification. Mock implementations use the Go <code>interface</code> types defined in the architecture, allowing dependency injection.</p>\n<h4 id=\"integration-testing-strategy\">Integration Testing Strategy</h4>\n<p>Integration tests verify that components work correctly together, particularly focusing on:</p>\n<ul>\n<li><strong>Lifecycle coordination</strong> between router, warm pool, and scaler</li>\n<li><strong>Error propagation</strong> across component boundaries</li>\n<li><strong>Concurrent access patterns</strong> with realistic timing</li>\n<li><strong>State consistency</strong> during failure recovery</li>\n</ul>\n<p>Integration tests use <strong>real implementations</strong> for adjacent components but may mock outbound dependencies like Docker daemon or storage backends. The test environment provides <strong>deterministic time</strong> via a mockable clock interface to eliminate timing flakiness.</p>\n<h4 id=\"system-testing-strategy\">System Testing Strategy</h4>\n<p>System tests execute complete workflows in an environment that approximates production:</p>\n<ul>\n<li><strong>Container-based test runner</strong> that creates isolated Docker networks</li>\n<li><strong>Function simulation</strong> using lightweight HTTP servers in containers</li>\n<li><strong>Load generation</strong> to test scaling behavior under realistic patterns</li>\n<li><strong>Failure injection</strong> to verify recovery mechanisms</li>\n</ul>\n<p>System tests are <strong>resource-intensive</strong> and run in CI/CD pipelines rather than developer workstations. They use the <code>testcontainers</code> pattern to spin up necessary dependencies (Docker daemon, mock storage) and clean them up after test completion.</p>\n<h3 id=\"test-environment-architecture\">Test Environment Architecture</h3>\n<p>The test environment is structured to support all testing levels while maintaining reproducibility:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>test-environment/\n├── mocks/                    # Generated mock implementations\n├── fixtures/                 # Test data and function code samples\n├── integration/              # Integration test suites\n├── system/                   # System test suites\n└── helpers/                  # Reusable test utilities</code></pre></div>\n\n<p>Key test utilities include:</p>\n<table>\n<thead>\n<tr>\n<th>Utility</th>\n<th>Purpose</th>\n<th>Used In</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>MockContainerManager</code></td>\n<td>Simulates container operations without Docker</td>\n<td>Unit &amp; integration tests</td>\n</tr>\n<tr>\n<td><code>FakeClock</code></td>\n<td>Provides controllable time for timing-sensitive tests</td>\n<td>All test levels</td>\n</tr>\n<tr>\n<td><code>RecordingMetrics</code></td>\n<td>Captures metric emissions for verification</td>\n<td>Unit &amp; integration tests</td>\n</tr>\n<tr>\n<td><code>TestFunctionServer</code></td>\n<td>HTTP server simulating function behavior</td>\n<td>Integration &amp; system tests</td>\n</tr>\n<tr>\n<td><code>InMemoryStorage</code></td>\n<td>Ephemeral storage for artifacts and metadata</td>\n<td>Unit &amp; integration tests</td>\n</tr>\n</tbody></table>\n<h3 id=\"testing-edge-cases-and-failure-modes\">Testing Edge Cases and Failure Modes</h3>\n<p>The testing strategy explicitly addresses the failure modes documented in the &quot;Error Handling and Edge Cases&quot; section. Each failure mode has corresponding test scenarios:</p>\n<table>\n<thead>\n<tr>\n<th>Failure Mode</th>\n<th>Test Category</th>\n<th>Verification Approach</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Container OOM kill</td>\n<td>System test</td>\n<td>Configure memory limit below function requirement, verify error classification</td>\n</tr>\n<tr>\n<td>Cold start timeout</td>\n<td>Integration test</td>\n<td>Mock slow container startup, verify retry logic</td>\n</tr>\n<tr>\n<td>Scaling thrashing</td>\n<td>Property-based test</td>\n<td>Generate oscillating load patterns, verify cooldown prevents thrashing</td>\n</tr>\n<tr>\n<td>Queue overflow</td>\n<td>Integration test</td>\n<td>Send requests exceeding queue capacity, verify load shedding</td>\n</tr>\n<tr>\n<td>Network partition</td>\n<td>System test</td>\n<td>Simulate network failure between components, verify circuit breaking</td>\n</tr>\n<tr>\n<td>Resource exhaustion</td>\n<td>Integration test</td>\n<td>Exhaust file descriptors, CPU, memory; verify graceful degradation</td>\n</tr>\n</tbody></table>\n<p>Property-based tests using the <code>quick</code> or <code>gopter</code> libraries generate random inputs to discover edge cases in state transitions, especially in the <code>StateMachine</code> and <code>Router</code> components.</p>\n<h3 id=\"performance-and-benchmark-testing\">Performance and Benchmark Testing</h3>\n<p>Beyond functional correctness, the system includes performance benchmarks to track:</p>\n<ul>\n<li><strong>Cold start latency</strong> under various configurations</li>\n<li><strong>Memory footprint</strong> of warm pool instances</li>\n<li><strong>Routing overhead</strong> at different request rates</li>\n<li><strong>Scaling decision latency</strong> during load spikes</li>\n</ul>\n<p>Benchmarks use the Go <code>testing.B</code> framework and produce comparative reports. Performance regressions trigger alerts in the CI pipeline.</p>\n<h3 id=\"test-data-management\">Test Data Management</h3>\n<p>Test data follows these principles:</p>\n<ul>\n<li><strong>Minimal representative samples</strong> for function code (hello-world handlers)</li>\n<li><strong>Generated test cases</strong> for dependency resolution scenarios</li>\n<li><strong>Golden files</strong> for expected artifact structures</li>\n<li><strong>Seeded randomness</strong> for reproducible property tests</li>\n</ul>\n<p>Function test fixtures include examples for each supported runtime (Go, Python, Node.js) with varying complexity levels.</p>\n<h3 id=\"continuous-integration-pipeline\">Continuous Integration Pipeline</h3>\n<p>The CI pipeline executes tests in this sequence:</p>\n<ol>\n<li><strong>Static analysis</strong> (go vet, staticcheck, security scanning)</li>\n<li><strong>Unit tests</strong> (fast, mandatory for all PRs)</li>\n<li><strong>Integration tests</strong> (medium duration, required for main branch)</li>\n<li><strong>System tests</strong> (long duration, nightly runs)</li>\n<li><strong>Benchmarks</strong> (performance tracking, weekly runs)</li>\n</ol>\n<p>Test results include coverage reports, with a minimum threshold of 80% line coverage for the core components (<code>Router</code>, <code>Scaler</code>, <code>WarmPoolManager</code>, <code>Executor</code>).</p>\n<h3 id=\"milestone-implementation-checkpoints\">Milestone Implementation Checkpoints</h3>\n<p>Each milestone has specific verification checkpoints to ensure incremental progress. The checkpoints progress from isolated component behavior to integrated system behavior.</p>\n<h4 id=\"milestone-1-function-packaging-checkpoints\">Milestone 1: Function Packaging Checkpoints</h4>\n<blockquote>\n<p><strong>Objective:</strong> Verify that function code can be uploaded, packaged with dependencies, stored, and retrieved.</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Checkpoint</th>\n<th>Expected Behavior</th>\n<th>Verification Commands</th>\n<th>Success Criteria</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>1.1 - Upload API</strong></td>\n<td>HTTP endpoint accepts multipart file upload and returns function ID</td>\n<td><code>curl -X POST -F &quot;file=@hello.go&quot; http://localhost:8080/upload</code></td>\n<td>Returns JSON with <code>{&quot;function_name&quot;: &quot;hello&quot;, &quot;version&quot;: &quot;v1&quot;, &quot;artifact_hash&quot;: &quot;sha256:...&quot;}</code></td>\n</tr>\n<tr>\n<td><strong>1.2 - Dependency Resolution</strong></td>\n<td>Go dependencies resolved from <code>go.mod</code> and bundled</td>\n<td>Upload function with imports; inspect generated artifact</td>\n<td>Artifact contains all transitive dependencies in <code>vendor/</code> directory</td>\n</tr>\n<tr>\n<td><strong>1.3 - Artifact Storage</strong></td>\n<td>Package stored durably and retrievable by hash</td>\n<td>Upload function, then <code>curl http://localhost:8080/artifacts/{hash}</code></td>\n<td>Returns exact same bytes as uploaded (verified by hash comparison)</td>\n</tr>\n<tr>\n<td><strong>1.4 - Multi-Runtime Support</strong></td>\n<td>Python and Node.js functions packaged correctly</td>\n<td>Upload Python function with <code>requirements.txt</code>, Node.js with <code>package.json</code></td>\n<td>Python artifact includes virtualenv, Node.js includes <code>node_modules</code></td>\n</tr>\n<tr>\n<td><strong>1.5 - Version Immutability</strong></td>\n<td>Same code produces same hash, preventing modification</td>\n<td>Upload identical function twice</td>\n<td>Same artifact hash returned; storage reports duplicate</td>\n</tr>\n<tr>\n<td><strong>1.6 - Validation</strong></td>\n<td>Invalid function definitions rejected</td>\n<td>Upload function without handler, with unsupported runtime</td>\n<td>Returns 400 Bad Request with specific error message</td>\n</tr>\n</tbody></table>\n<p><strong>Verification workflow:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Run unit tests for packaging components</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./internal/packaging/...</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#79B8FF\"> -count=1</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Start test server with in-memory storage</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#9ECBFF\"> cmd/test-server/main.go</span><span style=\"color:#79B8FF\"> --storage=memory</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Upload test function (from testdata directory)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#79B8FF\"> -F</span><span style=\"color:#9ECBFF\"> \"file=@testdata/hello-go/hello.go\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -F</span><span style=\"color:#9ECBFF\"> \"runtime=go\"</span><span style=\"color:#79B8FF\"> -F</span><span style=\"color:#9ECBFF\"> \"handler=Handler\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  http://localhost:8080/upload</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify artifact exists</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8080/artifacts/{hash-from-response}</span></span></code></pre></div>\n\n<p><strong>Expected observations:</strong></p>\n<ul>\n<li>Upload endpoint responds within 500ms for simple functions</li>\n<li>Artifact size correlates with dependency count (e.g., empty function ~10KB, with dependencies ~1-10MB)</li>\n<li>Hash changes when any file content changes (code or dependencies)</li>\n<li>Storage backend reports deduplication for identical uploads</li>\n</ul>\n<h4 id=\"milestone-2-execution-environment-checkpoints\">Milestone 2: Execution Environment Checkpoints</h4>\n<blockquote>\n<p><strong>Objective:</strong> Verify that functions execute in isolated containers with enforced resource limits.</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Checkpoint</th>\n<th>Expected Behavior</th>\n<th>Verification Commands</th>\n<th>Success Criteria</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>2.1 - Container Creation</strong></td>\n<td>Isolated environment created from base image</td>\n<td><code>executor.ExecuteFunction</code> with simple function</td>\n<td>Container created with unique ID, runtime-specific base image</td>\n</tr>\n<tr>\n<td><strong>2.2 - Resource Limits</strong></td>\n<td>Memory and CPU limits enforced</td>\n<td>Function that allocates memory beyond limit</td>\n<td>Container terminated with OOM kill, <code>ErrorTypeOOM</code> classification</td>\n</tr>\n<tr>\n<td><strong>2.3 - Timeout Enforcement</strong></td>\n<td>Execution terminated after timeout</td>\n<td>Function with <code>time.Sleep</code> exceeding timeout</td>\n<td>Returns <code>ErrorTypeTimeout</code> after configured duration</td>\n</tr>\n<tr>\n<td><strong>2.4 - Filesystem Isolation</strong></td>\n<td>Clean <code>/tmp</code> per invocation</td>\n<td>Function writes to <code>/tmp/test.txt</code></td>\n<td>File exists during execution, not visible to other invocations</td>\n</tr>\n<tr>\n<td><strong>2.5 - Network Isolation</strong></td>\n<td>Outbound connectivity controlled</td>\n<td>Function attempts to connect to external service</td>\n<td>Connection succeeds/fails per network policy configuration</td>\n</tr>\n<tr>\n<td><strong>2.6 - Cleanup</strong></td>\n<td>Resources released after execution</td>\n<td>Monitor Docker containers before/after execution</td>\n<td>No lingering containers from completed executions</td>\n</tr>\n</tbody></table>\n<p><strong>Verification workflow:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Test resource limit enforcement</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./internal/executor/...</span><span style=\"color:#79B8FF\"> -run</span><span style=\"color:#9ECBFF\"> TestMemoryLimit</span><span style=\"color:#79B8FF\"> -v</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Run integration test with actual Docker</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">DOCKER_HOST</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">unix:///var/run/docker.sock</span><span style=\"color:#B392F0\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./integration/executor/...</span><span style=\"color:#79B8FF\"> -v</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Manual test: run memory-hungry function</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cat</span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> memory_test.go</span><span style=\"color:#F97583\"> &#x3C;&#x3C;</span><span style=\"color:#9ECBFF\"> 'EOF'</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">package main</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">func Handler() string {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  // Allocate 200MB when limit is 128MB</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  data := make([]byte, 200*1024*1024)</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  return \"ok\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">}</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">EOF</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Upload and invoke with 128MB memory limit</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect OOM error in response</span></span></code></pre></div>\n\n<p><strong>Expected observations:</strong></p>\n<ul>\n<li>Container creation takes 500ms-2s depending on base image size</li>\n<li>Memory limit violations detected within 100ms of allocation</li>\n<li>Timeout precision within ±50ms of configured value</li>\n<li>Post-execution Docker <code>ps</code> shows no containers with project labels</li>\n<li>CPU throttling observable via <code>docker stats</code> during CPU-intensive functions</li>\n</ul>\n<h4 id=\"milestone-3-cold-start-optimization-checkpoints\">Milestone 3: Cold Start Optimization Checkpoints</h4>\n<blockquote>\n<p><strong>Objective:</strong> Verify that warm instances reduce startup latency and snapshot/restore works correctly.</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Checkpoint</th>\n<th>Expected Behavior</th>\n<th>Verification Commands</th>\n<th>Success Criteria</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>3.1 - Warm Pool Population</strong></td>\n<td>Instances created and added to pool</td>\n<td><code>PreWarm</code> called for function</td>\n<td>Specified number of containers in <code>StatusRunning</code> but idle</td>\n</tr>\n<tr>\n<td><strong>3.2 - Warm Start Latency</strong></td>\n<td>Request to warm instance faster than cold</td>\n<td>Measure <code>AcquireWarmInstance</code> + execution vs cold path</td>\n<td>Warm start &lt; 100ms, cold start &gt; 500ms (language-dependent)</td>\n</tr>\n<tr>\n<td><strong>3.3 - Instance Reuse</strong></td>\n<td>Instance returns to pool after execution</td>\n<td>Invoke function twice with <code>ReleaseInstance</code></td>\n<td>Same container ID used for both invocations</td>\n</tr>\n<tr>\n<td><strong>3.4 - Pool Size Limits</strong></td>\n<td>Pool respects max/min instance counts</td>\n<td>Call <code>PreWarm</code> beyond max, monitor pool</td>\n<td>Extra instances not created or immediately cleaned up</td>\n</tr>\n<tr>\n<td><strong>3.5 - TTL Expiration</strong></td>\n<td>Old instances removed from pool</td>\n<td>Create instance, wait beyond TTL, check cleanup</td>\n<td>Instance terminated, removed from pool store</td>\n</tr>\n<tr>\n<td><strong>3.6 - Snapshot/Restore</strong></td>\n<td>Checkpointed container restores quickly</td>\n<td>Use CRIU to checkpoint, measure restore time</td>\n<td>Restore &lt; 50ms from snapshot file</td>\n</tr>\n</tbody></table>\n<p><strong>Verification workflow:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Benchmark cold vs warm starts</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./internal/pool/...</span><span style=\"color:#79B8FF\"> -bench=</span><span style=\"color:#9ECBFF\">\".*Start.*\"</span><span style=\"color:#79B8FF\"> -benchtime=10s</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Test pool lifecycle</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./internal/pool/...</span><span style=\"color:#79B8FF\"> -run</span><span style=\"color:#9ECBFF\"> TestPoolLifecycle</span><span style=\"color:#79B8FF\"> -v</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Manual test: observe container reuse</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Terminal 1: Start gateway with verbose logging</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">LOG_LEVEL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">debug</span><span style=\"color:#B392F0\"> go</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#9ECBFF\"> cmd/gateway/main.go</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Terminal 2: Invoke function twice with 1s gap</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8080/invoke/hello</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8080/invoke/hello</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Check logs: second request should show \"using warm instance\"</span></span></code></pre></div>\n\n<p><strong>Expected observations:</strong></p>\n<ul>\n<li>First invocation shows &quot;cold start&quot; in logs with 500ms+ duration</li>\n<li>Second invocation shows &quot;warm start&quot; with &lt;100ms duration</li>\n<li><code>docker ps</code> shows container persists between invocations</li>\n<li>Pool metrics show instance count stabilizing at configured max/min</li>\n<li>Memory usage increases with pool size but stabilizes</li>\n<li>Old instances cleaned up exactly at TTL expiration</li>\n</ul>\n<h4 id=\"milestone-4-request-routing-checkpoints\">Milestone 4: Request Routing Checkpoints</h4>\n<blockquote>\n<p><strong>Objective:</strong> Verify that requests are correctly routed, queued, load balanced, and timed out.</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Checkpoint</th>\n<th>Expected Behavior</th>\n<th>Verification Commands</th>\n<th>Success Criteria</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>4.1 - HTTP Gateway</strong></td>\n<td>Endpoint accepts requests, routes to function</td>\n<td><code>curl http://localhost:8080/invoke/hello</code></td>\n<td>Request forwarded to function instance, response returned</td>\n</tr>\n<tr>\n<td><strong>4.2 - Load Balancing</strong></td>\n<td>Requests distributed across instances</td>\n<td>Launch 3 instances, send 10 requests</td>\n<td>Requests spread across instances (round-robin or least-connections)</td>\n</tr>\n<tr>\n<td><strong>4.3 - Request Queuing</strong></td>\n<td>Queue buffers requests when busy</td>\n<td>All instances busy, send additional request</td>\n<td>Request queued, executes when instance available</td>\n</tr>\n<tr>\n<td><strong>4.4 - Concurrency Limits</strong></td>\n<td>Per-function concurrency enforced</td>\n<td>Send parallel requests exceeding limit</td>\n<td>Excess requests queued or rejected (per configuration)</td>\n</tr>\n<tr>\n<td><strong>4.5 - Circuit Breaking</strong></td>\n<td>Unhealthy instances avoided</td>\n<td>Kill container, send requests</td>\n<td>Failures counted, instance marked unhealthy after threshold</td>\n</tr>\n<tr>\n<td><strong>4.6 - Timeout Propagation</strong></td>\n<td>Deadline passed through layers</td>\n<td>Function sleeps beyond timeout</td>\n<td>Request cancelled at all levels with <code>InvocationStatusTimeout</code></td>\n</tr>\n</tbody></table>\n<p><strong>Verification workflow:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Test routing logic</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./internal/gateway/...</span><span style=\"color:#79B8FF\"> -run</span><span style=\"color:#9ECBFF\"> TestRouter</span><span style=\"color:#79B8FF\"> -v</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Start gateway with test configuration</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#9ECBFF\"> cmd/gateway/main.go</span><span style=\"color:#79B8FF\"> --config</span><span style=\"color:#9ECBFF\"> testdata/gateway-config.yaml</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Load test with multiple concurrent requests</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Using hey or vegeta</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> '{\"message\": \"test\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> vegeta</span><span style=\"color:#9ECBFF\"> attack</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -duration=10s</span><span style=\"color:#79B8FF\"> -rate=10</span><span style=\"color:#79B8FF\"> -targets=targets.txt</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  |</span><span style=\"color:#B392F0\"> vegeta</span><span style=\"color:#9ECBFF\"> report</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Test queue behavior by saturating instances</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Terminal 1: Slow function</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cat</span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> slow.go</span><span style=\"color:#F97583\"> &#x3C;&#x3C;</span><span style=\"color:#9ECBFF\"> 'EOF'</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">package main</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">import \"time\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">func Handler() string {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  time.Sleep(5 * time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  return \"done\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">}</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">EOF</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Terminal 2: Send burst of requests</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> {</span><span style=\"color:#B392F0\">1..10}</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  curl</span><span style=\"color:#9ECBFF\"> http://localhost:8080/invoke/slow</span><span style=\"color:#E1E4E8\"> &#x26;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">done</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Observe: first N execute immediately (N = concurrency limit),</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># rest queue, execute as instances free up</span></span></code></pre></div>\n\n<p><strong>Expected observations:</strong></p>\n<ul>\n<li>Gateway responds to health check at <code>/health</code></li>\n<li>Round-robin distribution visible in instance assignment logs</li>\n<li>Queue depth metric increases when all instances busy</li>\n<li>Circuit breaker trips after 5 consecutive failures (default)</li>\n<li>Request cancellation propagates within 100ms of timeout</li>\n<li>Sticky routing (if enabled) sends same client to same instance</li>\n</ul>\n<h4 id=\"milestone-5-auto-scaling-checkpoints\">Milestone 5: Auto-Scaling Checkpoints</h4>\n<blockquote>\n<p><strong>Objective:</strong> Verify that instances scale up/down based on load and scale to zero after inactivity.</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>Checkpoint</th>\n<th>Expected Behavior</th>\n<th>Verification Commands</th>\n<th>Success Criteria</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>5.1 - Metrics Collection</strong></td>\n<td>Invocation rate and concurrency tracked</td>\n<td>Send requests at varying rates</td>\n<td><code>GetRequestRate()</code> returns accurate RPS over sliding window</td>\n</tr>\n<tr>\n<td><strong>5.2 - Scale-Up Trigger</strong></td>\n<td>New instances created when threshold exceeded</td>\n<td>Send requests above target concurrency</td>\n<td>New containers created, added to pool/routing table</td>\n</tr>\n<tr>\n<td><strong>5.3 - Scale-Down Cooldown</strong></td>\n<td>Instances not removed too quickly</td>\n<td>Spike traffic, then drop to zero, monitor</td>\n<td>Scale-down waits for cooldown period before removing instances</td>\n</tr>\n<tr>\n<td><strong>5.4 - Scale-to-Zero</strong></td>\n<td>All instances removed after idle timeout</td>\n<td>No requests for &gt; idle timeout</td>\n<td>Container count drops to zero, warm pool empty</td>\n</tr>\n<tr>\n<td><strong>5.5 - Provisioned Concurrency</strong></td>\n<td>Minimum instances kept warm</td>\n<td>Configure min=2, monitor during idle</td>\n<td>2 instances remain in warm pool regardless of traffic</td>\n</tr>\n<tr>\n<td><strong>5.6 - Scaling Metrics</strong></td>\n<td>Scale events recorded in metrics</td>\n<td>Scale up/down several times</td>\n<td><code>scaling_operations_total</code> counter increments with direction labels</td>\n</tr>\n</tbody></table>\n<p><strong>Verification workflow:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Test scaling logic</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./internal/scaler/...</span><span style=\"color:#79B8FF\"> -run</span><span style=\"color:#9ECBFF\"> TestScaleDecision</span><span style=\"color:#79B8FF\"> -v</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Integration test with simulated traffic</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./integration/scaler/...</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#79B8FF\"> -timeout=2m</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Manual test: observe scaling behavior</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Start system with auto-scaling enabled</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#9ECBFF\"> cmd/coordinator/main.go</span><span style=\"color:#79B8FF\"> --enable-scaling</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Generate load pattern</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Phase 1: Low traffic (should scale to min or zero)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 30</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Phase 2: Burst traffic (should scale up)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">hey</span><span style=\"color:#79B8FF\"> -z</span><span style=\"color:#9ECBFF\"> 30s</span><span style=\"color:#79B8FF\"> -q</span><span style=\"color:#79B8FF\"> 10</span><span style=\"color:#9ECBFF\"> http://localhost:8080/invoke/hello</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Phase 3: Steady moderate traffic (should maintain)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">hey</span><span style=\"color:#79B8FF\"> -z</span><span style=\"color:#9ECBFF\"> 60s</span><span style=\"color:#79B8FF\"> -q</span><span style=\"color:#79B8FF\"> 5</span><span style=\"color:#9ECBFF\"> http://localhost:8080/invoke/hello</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Phase 4: No traffic (should scale down after cooldown)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 90</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Monitor scaling events in logs and metrics endpoint</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8080/metrics</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#9ECBFF\"> scaling_</span></span></code></pre></div>\n\n<p><strong>Expected observations:</strong></p>\n<ul>\n<li>Scale-up occurs within 10-30 seconds of sustained load (configurable)</li>\n<li>Scale-down respects cooldown period (default 300s)</li>\n<li>Scale-to-zero removes last instance after idle timeout (default 600s)</li>\n<li>Provisioned concurrency keeps instances warm even with no traffic</li>\n<li>Scaling decisions logged with rationale (e.g., &quot;scale up: concurrency 12 &gt; threshold 10&quot;)</li>\n<li>No thrashing: stable traffic produces stable instance count</li>\n</ul>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<h4 id=\"a-technology-recommendations-table\">A. Technology Recommendations Table</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Unit Testing</td>\n<td>Standard <code>testing</code> package + <code>testify/assert</code></td>\n<td><code>ginkgo</code>/<code>gomega</code> BDD framework</td>\n</tr>\n<tr>\n<td>Mock Generation</td>\n<td>Manual interface implementations</td>\n<td><code>mockery</code> or <code>moq</code> code generation</td>\n</tr>\n<tr>\n<td>Integration Testing</td>\n<td>Docker SDK + testcontainers</td>\n<td>Kubernetes in Docker (kind) cluster</td>\n</tr>\n<tr>\n<td>Property Testing</td>\n<td><code>testing/quick</code></td>\n<td><code>gopter</code> with custom generators</td>\n</tr>\n<tr>\n<td>Benchmarking</td>\n<td><code>testing.B</code> with <code>-bench</code></td>\n<td>Custom benchmark harness with percentile metrics</td>\n</tr>\n<tr>\n<td>Coverage Analysis</td>\n<td><code>go test -cover</code></td>\n<td><code>goverage</code> or <code>codecov</code> integration</td>\n</tr>\n<tr>\n<td>Load Testing</td>\n<td><code>vegeta</code> command line</td>\n<td>Custom load generator with scenario modeling</td>\n</tr>\n</tbody></table>\n<h4 id=\"b-recommended-filemodule-structure-for-testing\">B. Recommended File/Module Structure for Testing</h4>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>serverless-runtime/\n├── cmd/\n│   ├── test-server/           # Dedicated test server\n│   │   └── main.go\n│   └── load-generator/        # Load testing tool\n│       └── main.go\n├── internal/\n│   ├── gateway/\n│   │   ├── gateway.go\n│   │   ├── gateway_test.go    # Unit tests\n│   │   └── integration_test.go # Integration tests\n│   ├── scaler/\n│   │   ├── scaler.go\n│   │   ├── scaler_test.go\n│   │   └── benchmark_test.go  # Benchmarks\n│   └── ... (other components)\n├── test/\n│   ├── mocks/                 # Generated mocks\n│   │   ├── container_manager_mock.go\n│   │   └── metrics_mock.go\n│   ├── fixtures/              # Test data\n│   │   ├── functions/\n│   │   │   ├── hello-go/\n│   │   │   ├── hello-python/\n│   │   │   └── hello-node/\n│   │   └── configs/\n│   ├── integration/           # Integration test suites\n│   │   ├── setup.go\n│   │   ├── test_router_scaler.go\n│   │   └── test_pool_lifecycle.go\n│   ├── system/               # System tests\n│   │   ├── docker_test.go\n│   │   └── scaling_test.go\n│   └── helpers/              # Test utilities\n│       ├── clock.go\n│       ├── container_helper.go\n│       └── metrics_helper.go\n├── go.mod\n└── go.sum</code></pre></div>\n\n<h4 id=\"c-infrastructure-starter-code-for-test-utilities\">C. Infrastructure Starter Code for Test Utilities</h4>\n<p><strong><code>test/helpers/clock.go</code> - Deterministic time for tests:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> helpers</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// FakeClock provides deterministic time control for tests</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> FakeClock</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu      </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">RWMutex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    current </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    timers  []</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">fakeTimer</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewFakeClock creates a FakeClock at the given time</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewFakeClock</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">initial</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FakeClock</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">FakeClock</span><span style=\"color:#E1E4E8\">{current: initial}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Now returns the current fake time</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">c </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FakeClock</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    c.mu.</span><span style=\"color:#B392F0\">RLock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> c.mu.</span><span style=\"color:#B392F0\">RUnlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> c.current</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Advance moves time forward by duration</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">c </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FakeClock</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Advance</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">d</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    c.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> c.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    c.current </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> c.current.</span><span style=\"color:#B392F0\">Add</span><span style=\"color:#E1E4E8\">(d)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Trigger any timers that have expired</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, t </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> c.timers {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">check</span><span style=\"color:#E1E4E8\">(c.current)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// AfterFunc mimics time.AfterFunc</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">c </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">FakeClock</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">AfterFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">d</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">f</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">()) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">fakeTimer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    c.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> c.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    t </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">fakeTimer</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        expiry: c.current.</span><span style=\"color:#B392F0\">Add</span><span style=\"color:#E1E4E8\">(d),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        f:      f,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        active: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    c.timers </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> append</span><span style=\"color:#E1E4E8\">(c.timers, t)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> t</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> fakeTimer</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    expiry </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    f      </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    active </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">t </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">fakeTimer</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">check</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">now</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> t.active </span><span style=\"color:#F97583\">&#x26;&#x26;</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">now.</span><span style=\"color:#B392F0\">Before</span><span style=\"color:#E1E4E8\">(t.expiry) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.active </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> false</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        go</span><span style=\"color:#E1E4E8\"> t.</span><span style=\"color:#B392F0\">f</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>test/helpers/metrics_helper.go</code> - Metrics recording for verification:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> helpers</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/prometheus/client_golang/prometheus</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RecordingMetrics captures metric emissions for test verification</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RecordingMetrics</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">RWMutex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Capture cold start latencies</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ColdStartLatencies []</span><span style=\"color:#F97583\">float64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Capture invocation counts by function</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    InvocationCounts </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Capture error counts by type</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrorCounts </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewRecordingMetrics creates a new RecordingMetrics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewRecordingMetrics</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RecordingMetrics</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">RecordingMetrics</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        InvocationCounts: </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ErrorCounts:      </span><span style=\"color:#B392F0\">make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RecordColdStart captures a cold start duration</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">rm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RecordingMetrics</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RecordColdStart</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">duration</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rm.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> rm.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rm.ColdStartLatencies </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> append</span><span style=\"color:#E1E4E8\">(rm.ColdStartLatencies, duration.</span><span style=\"color:#B392F0\">Seconds</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\">1000</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// Convert to ms</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RecordInvocation captures an invocation completion</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">rm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RecordingMetrics</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RecordInvocation</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">functionName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">duration</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rm.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> rm.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rm.InvocationCounts[functionName]</span><span style=\"color:#F97583\">++</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        errType </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> classifyTestError</span><span style=\"color:#E1E4E8\">(err)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> rm.ErrorCounts[functionName] </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            rm.ErrorCounts[functionName] </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        rm.ErrorCounts[functionName][errType]</span><span style=\"color:#F97583\">++</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GetColdStartP95 returns the 95th percentile cold start latency</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">rm </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RecordingMetrics</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetColdStartP95</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">float64</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rm.mu.</span><span style=\"color:#B392F0\">RLock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> rm.mu.</span><span style=\"color:#B392F0\">RUnlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(rm.ColdStartLatencies) </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> 0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Sort and calculate percentile</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    latencies </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">float64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(rm.ColdStartLatencies))</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    copy</span><span style=\"color:#E1E4E8\">(latencies, rm.ColdStartLatencies)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    sort.</span><span style=\"color:#B392F0\">Float64s</span><span style=\"color:#E1E4E8\">(latencies)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    index </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">float64</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(latencies)) </span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\"> 0.95</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> index </span><span style=\"color:#F97583\">>=</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(latencies) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        index </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(latencies) </span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> latencies[index]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"d-core-logic-skeleton-code-for-test-verification\">D. Core Logic Skeleton Code for Test Verification</h4>\n<p><strong><code>test/integration/scaling_test.go</code> - Integration test for auto-scaling:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> integration</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/stretchr/testify/assert</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/stretchr/testify/require</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">serverless-runtime/internal/scaler</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">serverless-runtime/internal/pool</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">serverless-runtime/test/helpers</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestScaleUpOnHighConcurrency</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Create mock container manager and metrics collector</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mockCM </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> helpers.</span><span style=\"color:#B392F0\">NewMockContainerManager</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    metrics </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> helpers.</span><span style=\"color:#B392F0\">NewRecordingMetrics</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Initialize warm pool with zero instances</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    poolConfig </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> pool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">PoolConfig</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        MaxWarmInstances: </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        MinWarmInstances: </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        InstanceTTL:      </span><span style=\"color:#79B8FF\">5</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Minute,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        IdleTimeout:      </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Minute,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    warmPool, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> pool.</span><span style=\"color:#B392F0\">NewWarmPoolManager</span><span style=\"color:#E1E4E8\">(mockCM, poolConfig, metrics)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    require.</span><span style=\"color:#B392F0\">NoError</span><span style=\"color:#E1E4E8\">(t, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Initialize scaler with target concurrency of 2</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    scalingConfig </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> scaler</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ScalingConfig</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        FunctionName:        </span><span style=\"color:#9ECBFF\">\"test-function\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        MinInstances:        </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        MaxInstances:        </span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        TargetConcurrency:   </span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ScaleUpThreshold:    </span><span style=\"color:#79B8FF\">1.5</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#6A737D\">// 150% of target</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ScaleDownThreshold:  </span><span style=\"color:#79B8FF\">0.5</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#6A737D\">// 50% of target</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ScaleUpCooldown:     </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ScaleDownCooldown:   </span><span style=\"color:#79B8FF\">5</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Minute,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    scaler, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> scaler.</span><span style=\"color:#B392F0\">NewScaler</span><span style=\"color:#E1E4E8\">(metrics, warmPool, scalingConfig)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    require.</span><span style=\"color:#B392F0\">NoError</span><span style=\"color:#E1E4E8\">(t, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Simulate 5 concurrent executions (exceeding threshold)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 5</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        metrics.</span><span style=\"color:#B392F0\">RecordInvocation</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"test-function\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Millisecond, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        metrics.</span><span style=\"color:#B392F0\">IncrementConcurrency</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"test-function\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Trigger scaling evaluation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    decision </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> scaler.</span><span style=\"color:#B392F0\">EvaluateScaling</span><span style=\"color:#E1E4E8\">(ctx, </span><span style=\"color:#9ECBFF\">\"test-function\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: Verify scale-up decision</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    assert.</span><span style=\"color:#B392F0\">Equal</span><span style=\"color:#E1E4E8\">(t, scaler.ScaleUp, decision.Direction)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    assert.</span><span style=\"color:#B392F0\">Equal</span><span style=\"color:#E1E4E8\">(t, </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">, decision.Count) </span><span style=\"color:#6A737D\">// Expected: ceil(5 current / 2 target) = 3 instances</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    assert.</span><span style=\"color:#B392F0\">Contains</span><span style=\"color:#E1E4E8\">(t, decision.Reason, </span><span style=\"color:#9ECBFF\">\"concurrency\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 7: Execute scaling decision</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> scaler.</span><span style=\"color:#B392F0\">executeScaling</span><span style=\"color:#E1E4E8\">(ctx, decision)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    require.</span><span style=\"color:#B392F0\">NoError</span><span style=\"color:#E1E4E8\">(t, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 8: Verify new instances created in warm pool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    instances, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> warmPool.</span><span style=\"color:#B392F0\">ListInstances</span><span style=\"color:#E1E4E8\">(ctx, </span><span style=\"color:#9ECBFF\">\"test-function\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    require.</span><span style=\"color:#B392F0\">NoError</span><span style=\"color:#E1E4E8\">(t, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    assert.</span><span style=\"color:#B392F0\">Len</span><span style=\"color:#E1E4E8\">(t, instances, </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 9: Simulate executions completing</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 5</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        metrics.</span><span style=\"color:#B392F0\">DecrementConcurrency</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"test-function\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 10: Verify scale-down doesn't happen immediately (cooldown)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    decision2 </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> scaler.</span><span style=\"color:#B392F0\">EvaluateScaling</span><span style=\"color:#E1E4E8\">(ctx, </span><span style=\"color:#9ECBFF\">\"test-function\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    assert.</span><span style=\"color:#B392F0\">Equal</span><span style=\"color:#E1E4E8\">(t, scaler.ScaleNone, decision2.Direction)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    assert.</span><span style=\"color:#B392F0\">Contains</span><span style=\"color:#E1E4E8\">(t, decision2.Reason, </span><span style=\"color:#9ECBFF\">\"cooldown\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>test/helpers/mock_container_manager.go</code> - Mock for container operations:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> helpers</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">serverless-runtime/internal/container</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">serverless-runtime/internal/types</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// MockContainerManager simulates container operations for tests</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> MockContainerManager</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu          </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">RWMutex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    containers  </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Container</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    createDelay </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    startDelay  </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    failCreate  </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    failStart   </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    opsRecorded []</span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CreateContainer simulates container creation</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">MockContainerManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">CreateContainer</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    req</span><span style=\"color:#B392F0\"> types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CreateContainerRequest</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Container</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> m.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.opsRecorded </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> append</span><span style=\"color:#E1E4E8\">(m.opsRecorded, </span><span style=\"color:#9ECBFF\">\"CreateContainer\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> m.failCreate {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"mock container creation failed\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Simulate delay</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> m.createDelay </span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        select</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">time.</span><span style=\"color:#B392F0\">After</span><span style=\"color:#E1E4E8\">(m.createDelay):</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">ctx.</span><span style=\"color:#B392F0\">Done</span><span style=\"color:#E1E4E8\">():</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, ctx.</span><span style=\"color:#B392F0\">Err</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    containerID </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"mock-container-</span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(m.containers))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    container </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Container</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ID:        containerID,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Image:     req.Image,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Status:    types.StatusCreated,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        CreatedAt: time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Labels:    req.Labels,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    m.containers[containerID] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> container</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> container, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// StartContainer simulates container startup</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">MockContainerManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">StartContainer</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    containerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Check if container exists</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Simulate startup delay if configured</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Update container status to StatusRunning</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Record operation in opsRecorded</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Return mock error if failStart is true</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ListContainers returns mock containers</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">MockContainerManager</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ListContainers</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    filter</span><span style=\"color:#B392F0\"> types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ListFilter</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Container</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Filter containers by labels and status</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Return matching containers</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Record operation in opsRecorded</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"e-language-specific-hints-for-go-testing\">E. Language-Specific Hints for Go Testing</h4>\n<ul>\n<li><strong>Table-Driven Tests:</strong> Use the pattern with <code>tt := range tests</code> for comprehensive input coverage</li>\n<li><strong>Parallel Execution:</strong> Use <code>t.Parallel()</code> judiciously for unit tests, but avoid for integration tests with shared resources</li>\n<li><strong>Test Helpers:</strong> Create <code>testHelper</code> functions that accept <code>testing.TB</code> (interface for <code>testing.T</code> and <code>testing.B</code>)</li>\n<li><strong>Golden Files:</strong> Use <code>go:embed</code> to embed test fixtures directly in test files</li>\n<li><strong>Benchmark Memory:</strong> Use <code>b.ReportAllocs()</code> to track memory allocations in benchmarks</li>\n<li><strong>Cleanup:</strong> Use <code>t.Cleanup()</code> for resource cleanup instead of defer in subtests</li>\n<li><strong>Error Testing:</strong> Use <code>errors.Is()</code> and <code>errors.As()</code> for error type assertions</li>\n<li><strong>Context Testing:</strong> Use <code>context.WithTimeout</code> in tests to prevent hangs, but mock time for deterministic behavior</li>\n</ul>\n<h4 id=\"f-debugging-tips-for-test-failures\">F. Debugging Tips for Test Failures</h4>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>How to Diagnose</th>\n<th>Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Test passes locally but fails in CI</strong></td>\n<td>Timing differences, race conditions</td>\n<td>Run with <code>-race</code> flag, add logging with timestamps</td>\n<td>Use <code>FakeClock</code>, increase timeouts, fix data races</td>\n</tr>\n<tr>\n<td><strong>Container cleanup failing</strong></td>\n<td>Docker API rate limiting, zombie containers</td>\n<td>Check Docker logs, monitor container count</td>\n<td>Implement retry with backoff, force remove in cleanup</td>\n</tr>\n<tr>\n<td><strong>Metrics showing incorrect values</strong></td>\n<td>Race condition in metric updates</td>\n<td>Use <code>-race</code> detector, add metric value snapshots</td>\n<td>Protect metric updates with mutex, use atomic operations</td>\n</tr>\n<tr>\n<td><strong>Scaling thrashing in tests</strong></td>\n<td>Too sensitive thresholds, no hysteresis</td>\n<td>Log scaling decisions with metrics values</td>\n<td>Increase cooldown periods, add hysteresis (different up/down thresholds)</td>\n</tr>\n<tr>\n<td><strong>Cold start timeout flakiness</strong></td>\n<td>Variable container startup time</td>\n<td>Measure actual startup times, log each phase</td>\n<td>Increase timeout buffer, use faster base images</td>\n</tr>\n<tr>\n<td><strong>Queue test deadlock</strong></td>\n<td>Unbounded queue growth blocking producers</td>\n<td>Monitor queue depth metric, add timeout to enqueue</td>\n<td>Implement queue size limits, rejection policy for full queues</td>\n</tr>\n<tr>\n<td><strong>Race detector reports data race</strong></td>\n<td>Concurrent map access, unprotected field writes</td>\n<td>Identify the exact line from race report</td>\n<td>Use <code>sync.Map</code> or <code>sync.RWMutex</code>, copy data before goroutine</td>\n</tr>\n</tbody></table>\n<h4 id=\"g-milestone-verification-commands-summary\">G. Milestone Verification Commands Summary</h4>\n<p><strong>Complete test suite execution:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Run all unit tests with race detection</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./internal/...</span><span style=\"color:#79B8FF\"> -race</span><span style=\"color:#79B8FF\"> -count=1</span><span style=\"color:#79B8FF\"> -timeout=5m</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Run integration tests (requires Docker)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">DOCKER_HOST</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">unix:///var/run/docker.sock</span><span style=\"color:#B392F0\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./test/integration/...</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#79B8FF\"> -timeout=10m</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Run benchmarks</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./internal/scaler/...</span><span style=\"color:#79B8FF\"> -bench=.</span><span style=\"color:#79B8FF\"> -benchtime=5s</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Check test coverage</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./internal/...</span><span style=\"color:#79B8FF\"> -coverprofile=coverage.out</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> tool</span><span style=\"color:#9ECBFF\"> cover</span><span style=\"color:#79B8FF\"> -html=coverage.out</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> coverage.html</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Run property-based tests</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./internal/router/...</span><span style=\"color:#79B8FF\"> -run</span><span style=\"color:#9ECBFF\"> TestPropertyBased</span><span style=\"color:#79B8FF\"> -v</span></span></code></pre></div>\n\n<p><strong>Post-implementation verification checklist:</strong></p>\n<ul>\n<li><input disabled=\"\" type=\"checkbox\"> All unit tests pass with <code>-race</code> detector enabled</li>\n<li><input disabled=\"\" type=\"checkbox\"> Integration tests pass with real Docker daemon</li>\n<li><input disabled=\"\" type=\"checkbox\"> Benchmarks show no significant performance regressions</li>\n<li><input disabled=\"\" type=\"checkbox\"> Test coverage &gt; 80% for core components</li>\n<li><input disabled=\"\" type=\"checkbox\"> No flaky tests (run test suite 10 times consecutively)</li>\n<li><input disabled=\"\" type=\"checkbox\"> System tests pass in CI environment</li>\n<li><input disabled=\"\" type=\"checkbox\"> Load tests demonstrate scaling behavior matches specifications</li>\n<li><input disabled=\"\" type=\"checkbox\"> Error injection tests verify recovery mechanisms work</li>\n</ul>\n<hr>\n<h2 id=\"debugging-guide\">Debugging Guide</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> Milestone 1, Milestone 2, Milestone 3, Milestone 4, Milestone 5</p>\n</blockquote>\n<p>Debugging a serverless function runtime is challenging because it&#39;s a <strong>distributed system with multiple interacting components</strong>, each with their own failure modes. The ephemeral nature of function instances, the complexity of container isolation, and the dynamic scaling behavior create unique debugging scenarios. This guide provides a systematic approach to diagnosing and fixing common issues during development, organized by observable symptoms. Think of debugging this system as <strong>being a detective at a crime scene</strong>—you have multiple witnesses (logs, metrics, traces), circumstantial evidence (system state), and a crime scene that disappears after the crime (ephemeral containers). Your job is to reconstruct what happened from the available evidence.</p>\n<h3 id=\"common-bug-symptoms-and-fixes\">Common Bug Symptoms and Fixes</h3>\n<p>The following tables organize debugging by observable symptom, grouping related symptoms from different components. Each symptom includes the <strong>observable behavior</strong> (what you see), the <strong>likely root cause</strong> (what&#39;s probably wrong), and <strong>step-by-step investigation and fix</strong>. Use this as a starting point when encountering issues during development.</p>\n<h4 id=\"function-packaging-and-deployment-issues\">Function Packaging and Deployment Issues</h4>\n<p>These symptoms occur during function upload, packaging, or when functions fail to initialize properly.</p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>Steps to Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Function upload fails with &quot;invalid handler&quot; error</strong></td>\n<td>The handler path specified in the <code>FunctionDefinition</code> doesn&#39;t match an actual function in the uploaded code. This is often caused by incorrect handler syntax (e.g., <code>handler.main</code> for Go when the function is named <code>HandleRequest</code>), or the handler file being missing from the uploaded archive.</td>\n<td>1. <strong>Check the handler format</strong>: For Go, the handler should be the package-qualified function name (e.g., <code>main.Handler</code>). For Python, it should be <code>module.function_name</code>. 2. <strong>Verify the uploaded code</strong>: Use the <code>ValidateHandler</code> method in the bundler to confirm the handler exists in the workspace. 3. <strong>Inspect the artifact</strong>: Download the stored artifact and examine its structure—ensure the main file with the handler is present.</td>\n</tr>\n<tr>\n<td><strong>Function deployment succeeds but instances fail to start with &quot;dependency resolution failed&quot;</strong></td>\n<td>The dependency resolution step during packaging didn&#39;t capture all required libraries, or there are version conflicts between transitive dependencies. This is particularly common in Python with <code>requirements.txt</code> or Node.js with complex dependency trees.</td>\n<td>1. <strong>Examine the bundler logs</strong>: The <code>ResolveDependencies</code> method should log the resolved dependency graph. Check for warnings about missing or conflicting versions. 2. <strong>Test the build artifact locally</strong>: Extract the built artifact and run it in a minimal environment to see if dependencies are missing. 3. <strong>Add explicit version pins</strong>: In the function&#39;s dependency manifest, add explicit versions for transitive dependencies to avoid conflicts. 4. <strong>Check for platform-specific dependencies</strong>: Ensure dependencies are compatible with the runtime&#39;s base image (e.g., Linux wheels for Python).</td>\n</tr>\n<tr>\n<td><strong>Function package size is unexpectedly large (&gt;100MB)</strong></td>\n<td>The packaging process included unnecessary files (development dependencies, test directories, virtual environments, or large binary files) that bloat the artifact. This increases cold start times and storage costs.</td>\n<td>1. <strong>Implement <code>.faasignore</code></strong>: Create an ignore file similar to <code>.dockerignore</code> that excludes common development artifacts like <code>node_modules</code>, <code>.git</code>, <code>__pycache__</code>, and test directories. 2. <strong>Use dependency pruning</strong>: For interpreted languages, analyze the actual imports and strip unused dependencies. 3. <strong>Enable artifact compression</strong>: Compress the artifact using gzip or zstd before storage. 4. <strong>Check for duplicated layers</strong>: If using container images, ensure common runtime layers are shared across functions.</td>\n</tr>\n<tr>\n<td><strong>Function versioning shows incorrect or duplicate versions</strong></td>\n<td>The version generation logic (likely based on content hash) is collision-prone or the storage backend isn&#39;t properly isolating versions. This can happen when two different functions produce the same hash (rare) or when the storage layer overwrites existing artifacts.</td>\n<td>1. <strong>Verify the hash algorithm</strong>: Use a secure hash (SHA-256) that includes the function code, dependencies, and runtime configuration. 2. <strong>Check for non-deterministic builds</strong>: Ensure builds are reproducible—Go builds should use module mode with fixed versions, Python should use locked dependency files. 3. <strong>Inspect the storage backend</strong>: Ensure the artifact storage uses the full hash as the key and doesn&#39;t allow overwrites. 4. <strong>Add a version manifest</strong>: Store a separate manifest mapping human-readable versions (e.g., &quot;v1.2&quot;) to content hashes.</td>\n</tr>\n<tr>\n<td><strong>Upload API times out for large function packages</strong></td>\n<td>The <code>UploadHandler</code> is blocking on processing the entire upload before responding, or the dependency resolution/building step takes too long without streaming progress. This makes large functions difficult to deploy.</td>\n<td>1. <strong>Implement asynchronous upload processing</strong>: Accept the upload, return an immediate response with a job ID, and process the packaging in the background. 2. <strong>Add progress reporting</strong>: For synchronous uploads, implement chunked uploads and periodic status updates. 3. <strong>Set reasonable timeouts</strong>: Configure the gateway timeout (<code>GatewayConfig.DefaultTimeout</code>) to allow for large builds but fail fast on truly stuck uploads. 4. <strong>Optimize dependency resolution</strong>: Cache resolved dependencies across functions to speed up subsequent uploads.</td>\n</tr>\n</tbody></table>\n<h4 id=\"execution-environment-and-isolation-issues\">Execution Environment and Isolation Issues</h4>\n<p>These symptoms relate to container lifecycle, resource limits, and security isolation.</p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>Steps to Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Function times out immediately on every invocation</strong></td>\n<td>The container is failing to start or the entrypoint command is incorrect, causing the function to exit immediately. The <code>Executor</code> then times out waiting for a response. This often happens when the base image doesn&#39;t match the runtime or the handler binary is missing.</td>\n<td>1. <strong>Check container logs</strong>: The <code>ContainerManager</code> should capture container stdout/stderr. Look for &quot;executable not found&quot; or &quot;no such file&quot; errors. 2. <strong>Verify the base image</strong>: Ensure <code>GetBaseImage</code> returns the correct image for the runtime (e.g., <code>golang:alpine</code> for Go, <code>python:slim</code> for Python). 3. <strong>Test the container manually</strong>: Use <code>docker run</code> with the same image and command to see if it starts. 4. <strong>Inspect the <code>CreateContainerRequest</code></strong>: Ensure <code>Cmd</code> and <code>WorkingDir</code> are correctly set for the runtime.</td>\n</tr>\n<tr>\n<td><strong>Function exceeds memory limit but isn&#39;t terminated</strong></td>\n<td>The cgroup memory limit isn&#39;t being enforced properly, or the OOM killer is configured incorrectly. This can happen if the <code>CGroupHelper.SetMemoryLimit</code> isn&#39;t setting both <code>memory.limit_in_bytes</code> and <code>memory.memsw.limit_in_bytes</code> (for swap), or if the container isn&#39;t being added to the correct cgroup.</td>\n<td>1. <strong>Verify cgroup configuration</strong>: Check <code>/sys/fs/cgroup/memory/</code> (or <code>/sys/fs/cgroup/system.slice/</code> for systemd) for the container&#39;s cgroup and confirm limits are set. 2. <strong>Test with a memory-hungry function</strong>: Write a test function that allocates memory aggressively and verify it gets OOM-killed. 3. <strong>Check for swap</strong>: If swap is enabled, ensure both memory and swap limits are set. 4. <strong>Update the seccomp profile</strong>: Some older Docker versions require specific seccomp rules for cgroup enforcement.</td>\n</tr>\n<tr>\n<td><strong>Function instances accumulate and aren&#39;t cleaned up (&quot;zombie containers&quot;)</strong></td>\n<td>The cleanup logic in <code>CleanupIdleContainers</code> isn&#39;t running or isn&#39;t finding the containers, or the <code>RemoveContainer</code> method is failing silently. This leads to resource exhaustion over time.</td>\n<td>1. <strong>Check the cleanup schedule</strong>: Ensure the <code>WarmPoolManager.cleanupTicker</code> is running and <code>cleanupExpired</code> is being called. 2. <strong>Verify container listing</strong>: Use <code>ListContainers</code> with appropriate filters to see if the manager can find the containers. 3. <strong>Inspect removal errors</strong>: Add logging to <code>RemoveContainer</code> and check for &quot;container not found&quot; or permission errors. 4. <strong>Add a garbage collector</strong>: Implement a periodic sweep that removes any container not tracked in the <code>WarmPoolManager.store</code>.</td>\n</tr>\n<tr>\n<td><strong>Function can access host resources or other function&#39;s files</strong></td>\n<td>Insufficient namespace isolation—the container might be running with host network, PID, or filesystem namespaces. This is a critical security issue.</td>\n<td>1. <strong>Review <code>CreateContainerRequest</code> security options</strong>: Ensure <code>NetworkMode</code> is set to <code>bridge</code> (not <code>host</code>), and <code>SecurityOpts</code> include <code>no-new-privileges:true</code>. 2. <strong>Verify namespace flags</strong>: Check that the container manager is creating containers with all namespaces (<code>pid</code>, <code>net</code>, <code>ipc</code>, <code>mnt</code>, <code>uts</code>). 3. <strong>Test isolation</strong>: Write a function that tries to list processes (<code>ps aux</code>) or read <code>/etc/hostname</code>—it should only see its own isolated environment. 4. <strong>Use a security scanner</strong>: Run tools like <code>docker-bench-security</code> to check for misconfigurations.</td>\n</tr>\n<tr>\n<td><strong>Function execution is much slower than expected</strong></td>\n<td>CPU throttling from cgroups is too aggressive, or the container lacks sufficient CPU shares. The <code>CPUQuota</code> might be set too low (e.g., 50,000 for 50% of a CPU core).</td>\n<td>1. <strong>Check CPU quota settings</strong>: Verify <code>CreateContainerRequest.CPUQuota</code> is reasonable (100,000 = 1 CPU core). Consider increasing for CPU-intensive functions. 2. <strong>Monitor CPU throttling</strong>: Use <code>GetContainerStats</code> to see <code>CPUPercent</code> and check <code>/sys/fs/cgroup/cpu/</code> for <code>nr_throttled</code> events. 3. <strong>Adjust CPU period</strong>: The default period is 100ms; decreasing it can provide more fine-grained scheduling but may increase overhead. 4. <strong>Consider CPU pinning</strong>: For performance-critical functions, use CPU sets to dedicate cores.</td>\n</tr>\n</tbody></table>\n<h4 id=\"cold-start-and-warm-pool-issues\">Cold Start and Warm Pool Issues</h4>\n<p>These symptoms manifest as high latency for first requests or inefficient resource usage.</p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>Steps to Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Cold start latency is consistently &gt;1s despite warm pool</strong></td>\n<td>The warm pool is empty or instances are expired before use. This could be due to <code>PoolConfig.MinWarmInstances</code> being set to 0, <code>InstanceTTL</code> being too short, or the pre-warming logic not triggering.</td>\n<td>1. <strong>Check warm pool metrics</strong>: Use <code>Metrics.ContainerCount</code> to see how many warm instances exist per function. 2. <strong>Verify TTL configuration</strong>: Ensure <code>InstanceTTL</code> is longer than the typical idle period between invocations. 3. <strong>Test pre-warming</strong>: Invoke the function once, then check if a warm instance remains in the pool after execution. 4. <strong>Adjust <code>PreWarmThreshold</code></strong>: Lower the threshold if traffic patterns are predictable.</td>\n</tr>\n<tr>\n<td><strong>Warm pool consumes excessive memory even when idle</strong></td>\n<td>Too many instances are kept warm (<code>MaxWarmInstances</code> is too high), or instances aren&#39;t being released after use (<code>ReleaseInstance</code> isn&#39;t called). This wastes resources and can lead to host memory pressure.</td>\n<td>1. <strong>Monitor pool size</strong>: Track <code>ContainerCount</code> gauge over time and set alerts for high idle counts. 2. <strong>Implement memory-based eviction</strong>: Add logic to <code>cleanupExpired</code> that removes instances when system memory pressure is high. 3. <strong>Adjust per-function limits</strong>: Set <code>MaxWarmInstances</code> based on actual usage patterns—most functions need only 1-2 warm instances. 4. <strong>Add LRU eviction</strong>: When the pool is full, evict the least recently used instance rather than rejecting new ones.</td>\n</tr>\n<tr>\n<td><strong>Function state persists between invocations (unexpected side effects)</strong></td>\n<td>The container isn&#39;t being properly reset between uses. The <code>CleanupInstance</code> method might not be clearing the <code>/tmp</code> directory or environment variables from previous invocations.</td>\n<td>1. <strong>Verify cleanup hooks</strong>: Ensure <code>RuntimeCleaner.Clean</code> is called between invocations and resets the filesystem state. 2. <strong>Check filesystem isolation</strong>: Each invocation should get a fresh overlay filesystem layer; ensure <code>Binds</code> includes a unique <code>/tmp</code> mount. 3. <strong>Test with a counter</strong>: Write a function that increments a counter in <code>/tmp/count.txt</code>—it should reset to 1 on each cold start and warm reuse. 4. <strong>Use read-only root filesystem</strong>: Mount the function code as read-only and only allow writes to <code>/tmp</code>.</td>\n</tr>\n<tr>\n<td><strong>Snapshot/restore (CRIU) fails with &quot;pre-dump not found&quot; error</strong></td>\n<td>The container state is too complex to checkpoint (e.g., open network connections, pending signals), or CRIU isn&#39;t properly configured for the container runtime. This prevents fast restoration from snapshots.</td>\n<td>1. <strong>Simplify container state</strong>: Ensure containers are checkpointed at a consistent point (e.g., after initialization but before any request). 2. <strong>Check CRIU version</strong>: Use a recent version (≥3.15) with full container support. 3. <strong>Pre-dump memory</strong>: Use iterative memory dumping to reduce pause times during checkpoint. 4. <strong>Fallback to traditional start</strong>: If snapshot fails after retries, fall back to regular container creation and log the error for investigation.</td>\n</tr>\n<tr>\n<td><strong>Predictive warming creates instances that are never used</strong></td>\n<td>The prediction algorithm is too aggressive or based on noisy metrics. This wastes resources and can cause scale-up/down oscillations.</td>\n<td>1. <strong>Tune prediction parameters</strong>: Adjust <code>PreWarmThreshold</code> based on actual hit rate—monitor how many pre-warmed instances are actually used. 2. <strong>Add confidence scoring</strong>: Only pre-warm when the prediction confidence exceeds a threshold. 3. <strong>Correlate with external metrics</strong>: Use request queue depth or upstream event sources (like message queue backlog) as stronger signals. 4. <strong>Implement graceful degradation</strong>: If predictive warming accuracy is low, disable it and rely on reactive warming only.</td>\n</tr>\n</tbody></table>\n<h4 id=\"request-routing-and-gateway-issues\">Request Routing and Gateway Issues</h4>\n<p>These symptoms affect request handling, load balancing, and queuing behavior.</p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>Steps to Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Requests hang indefinitely without timeout</strong></td>\n<td>The gateway&#39;s timeout chain is broken—<code>GatewayConfig.DefaultTimeout</code> might not be propagating to the <code>Router.Route</code> context, or the <code>forwardRequest</code> isn&#39;t respecting the deadline. This causes client connections to hang.</td>\n<td>1. <strong>Check timeout propagation</strong>: Use <code>withTimeout</code> at each layer (gateway → router → instance) and ensure deadlines are decreasing. 2. <strong>Verify context cancellation</strong>: When a request times out, ensure all downstream operations (container execution, network calls) are cancelled. 3. <strong>Add request-scoped timeouts</strong>: The <code>InvocationRequest.Deadline</code> should be set by the gateway and respected throughout. 4. <strong>Test with slow functions</strong>: Create a function that sleeps longer than the timeout and verify it&#39;s properly terminated.</td>\n</tr>\n<tr>\n<td><strong>Load balancing sends all requests to one instance</strong></td>\n<td>The load balancing algorithm (likely in <code>selectInstance</code>) is stuck on a single instance due to sticky sessions or a bug in least-connections counting. This overloads one instance while others sit idle.</td>\n<td>1. <strong>Check <code>routedInstance.activeReqs</code></strong>: Ensure the atomic counter is being incremented/decremented correctly in <code>forwardRequest</code>. 2. <strong>Disable sticky routing</strong>: If <code>RouterConfig.StickySessionTTL</code> &gt; 0, set it to 0 to test if the issue persists. 3. <strong>Verify instance health</strong>: Unhealthy instances might be excluded, leaving only one healthy instance. Check <code>circuitBreaker</code> state. 4. <strong>Test with concurrent requests</strong>: Send multiple parallel requests and verify they distribute across all warm instances.</td>\n</tr>\n<tr>\n<td><strong>Request queue grows without bound, causing memory exhaustion</strong></td>\n<td>The <code>RequestQueue</code> isn&#39;t bounded properly (<code>maxSize</code> is too large or not enforced), or the dequeue rate is slower than enqueue rate due to stuck instances. This can lead to the gateway being OOM-killed.</td>\n<td>1. <strong>Check queue bounds</strong>: Verify <code>NewRequestQueue</code> is called with a reasonable <code>maxSize</code> (e.g., 1000 per function). 2. <strong>Implement load shedding</strong>: When queue is full, reject new requests with 429 (Too Many Requests) instead of queuing. 3. <strong>Monitor dequeuing rate</strong>: If <code>Dequeue</code> is slow, check for lock contention in the queue or blocked workers. 4. <strong>Add queue timeouts</strong>: Use <code>RemoveExpired</code> to clean up requests that have waited too long.</td>\n</tr>\n<tr>\n<td><strong>Circuit breaker trips unnecessarily, causing healthy instances to be avoided</strong></td>\n<td>The <code>CircuitBreakerThreshold</code> is too low or the timeout (<code>CircuitBreakerTimeout</code>) is too short for normal function execution. This causes temporary slowness to be interpreted as failure.</td>\n<td>1. <strong>Adjust breaker parameters</strong>: Increase the threshold (e.g., from 5 to 10 failures) and lengthen the timeout to match function SLA. 2. <strong>Distinguish error types</strong>: Only count network errors or timeouts toward the breaker, not application errors (like 400 Bad Request). 3. <strong>Add half-open state</strong>: After the timeout, allow a trial request before fully closing the breaker again. 4. <strong>Monitor breaker metrics</strong>: Track how often breakers trip and for which functions—adjust per-function if needed.</td>\n</tr>\n<tr>\n<td><strong>Gateway returns 502 Bad Gateway but instances appear healthy</strong></td>\n<td>The network between gateway and instances is failing, or the instance health check (<code>IsActive</code>) is incorrectly reporting healthy when the container is actually dead. This can happen if the container died but the <code>FunctionInstance</code> state wasn&#39;t updated.</td>\n<td>1. <strong>Check instance connectivity</strong>: Use <code>net.Dial</code> from the gateway to the instance&#39;s <code>Host:Port</code> to verify TCP connectivity. 2. <strong>Implement active health checks</strong>: The <code>Router</code> should periodically ping instances (HTTP GET /health) and mark unhealthy ones. 3. <strong>Watch for state desync</strong>: Ensure lifecycle events (<code>EventHealthCheckFailed</code>, <code>EventForceTerminate</code>) update the <code>FunctionInstance.State</code> promptly. 4. <strong>Add retry with different instance</strong>: On 502, the gateway should retry the request with a different instance before failing.</td>\n</tr>\n</tbody></table>\n<h4 id=\"auto-scaling-and-resource-management-issues\">Auto-Scaling and Resource Management Issues</h4>\n<p>These symptoms involve incorrect scaling decisions, instance churn, or resource waste.</p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>Steps to Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Scaling oscillates rapidly (thrashing) — instances constantly created and destroyed</strong></td>\n<td>The scaling thresholds (<code>ScaleUpThreshold</code>, <code>ScaleDownThreshold</code>) are too close together, or the cooldown periods (<code>ScaleUpCooldown</code>, <code>ScaleDownCooldown</code>) are too short. This causes the system to overreact to small load fluctuations.</td>\n<td>1. <strong>Add hysteresis</strong>: Ensure scale-up threshold (e.g., 70% concurrency) is significantly higher than scale-down threshold (e.g., 30%). 2. <strong>Increase cooldowns</strong>: Set cooldowns to at least 30-60 seconds to prevent rapid successive decisions. 3. <strong>Smooth metrics</strong>: Use moving averages for concurrency/RPS instead of instantaneous values. 4. <strong>Implement scaling stabilization</strong>: Keep track of recent scaling actions and suppress opposite-direction actions for a stabilization window.</td>\n</tr>\n<tr>\n<td><strong>Scale-to-zero removes instances too aggressively, causing cold starts on every request</strong></td>\n<td>The <code>IdleTimeout</code> is too short for the function&#39;s invocation pattern. Intermittent workloads (e.g., cron jobs every 5 minutes) need longer idle timeouts than the interval between invocations.</td>\n<td>1. <strong>Analyze invocation patterns</strong>: Check metrics for the time between invocations—set <code>IdleTimeout</code> to at least 2-3x the typical interval. 2. <strong>Add predictive keep-alive</strong>: If historical data shows regular intervals, keep at least one instance warm for predictable workloads. 3. <strong>Implement per-function tuning</strong>: Some functions may need longer idle timeouts than others. 4. <strong>Consider minimum instances</strong>: For latency-sensitive functions, set <code>MinInstances</code> to 1 instead of relying on scale-to-zero.</td>\n</tr>\n<tr>\n<td><strong>Scale-up is too slow during traffic spikes, causing queue buildup</strong></td>\n<td>The scaling decision loop (<code>EvaluateScaling</code>) runs too infrequently, or the metrics window (<code>MetricsWindow</code>) is too long, causing delayed detection of traffic increases.</td>\n<td>1. <strong>Reduce evaluation interval</strong>: The <code>Scaler.ticker</code> should run at least every 5 seconds during high traffic. 2. <strong>Use faster metrics</strong>: Combine short-term (5s) and long-term (60s) metrics to react quickly while avoiding noise. 3. <strong>Implement predictive scaling</strong>: If traffic patterns are predictable (e.g., daily peaks), scale up proactively. 4. <strong>Add queue-based scaling</strong>: Scale up when request queue depth exceeds a threshold, not just based on concurrency.</td>\n</tr>\n<tr>\n<td><strong>Scale-down doesn&#39;t happen even when instances are idle for hours</strong></td>\n<td>The scale-down logic requires instances to be idle <em>and</em> below threshold for the entire cooldown period, or there&#39;s a bug in <code>IdleDuration</code> calculation (<code>LastUsedAt</code> isn&#39;t updated properly).</td>\n<td>1. <strong>Verify <code>LastUsedAt</code> updates</strong>: Ensure <code>EventRequestCompleted</code> updates the instance&#39;s <code>LastUsedAt</code> timestamp. 2. <strong>Check idle detection</strong>: The scaler should consider both low concurrency AND idle time before scaling down. 3. <strong>Test with synthetic load</strong>: Create a burst of traffic, then let the system idle and verify scale-down occurs after <code>IdleTimeout</code>. 4. <strong>Add forced scale-down</strong>: If instances have been idle for an extended period (e.g., 24 hours), force termination regardless of thresholds.</td>\n</tr>\n<tr>\n<td><strong>Provisioned concurrency instances aren&#39;t kept warm</strong></td>\n<td>The warm pool manager isn&#39;t aware of provisioned concurrency requirements, or the instances are being recycled due to TTL expiration. This defeats the purpose of provisioned concurrency.</td>\n<td>1. <strong>Integrate with warm pool</strong>: The <code>Scaler</code> should call <code>PreWarm</code> for provisioned concurrency instances and ensure they&#39;re excluded from TTL-based cleanup. 2. <strong>Mark provisioned instances</strong>: Add a label to instances created for provisioned concurrency so the pool manager treats them specially. 3. <strong>Monitor warm count</strong>: Alert if the number of warm instances for a function with provisioned concurrency drops below the minimum. 4. <strong>Implement health checks</strong>: Provisioned instances should have active health checks and be recreated if unhealthy.</td>\n</tr>\n</tbody></table>\n<h4 id=\"cross-component-integration-issues\">Cross-Component Integration Issues</h4>\n<p>These symptoms involve interactions between multiple components and are often the trickiest to debug.</p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>Steps to Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Lifecycle events are lost or processed out of order</strong></td>\n<td>The <code>EventDispatcher</code> has subscribers with small buffers, or events are being published from multiple goroutines without proper ordering guarantees. This can cause state machine corruption.</td>\n<td>1. <strong>Increase buffer sizes</strong>: Use buffered channels sized for expected event volume (e.g., 1000). 2. <strong>Sequence events</strong>: Add a monotonically increasing sequence number to <code>InstanceEvent</code> and have subscribers detect gaps. 3. <strong>Use a single publisher</strong>: Ensure all events go through a single goroutine that sequences them before publishing. 4. <strong>Add event persistence</strong>: For critical events, write them to a WAL before processing so they can be replayed after crashes.</td>\n</tr>\n<tr>\n<td><strong>State machine gets stuck in <code>InstanceStateDraining</code> indefinitely</strong></td>\n<td>The drain timeout is too long, or the instance still has active requests that aren&#39;t completing. This blocks scale-down and wastes resources.</td>\n<td>1. <strong>Check active request count</strong>: Verify <code>routedInstance.activeReqs</code> reaches zero during draining. 2. <strong>Enforce drain timeout</strong>: The <code>FlowCoordinator</code> should force-terminate instances after <code>DrainTimeout</code>. 3. <strong>Verify request completion</strong>: Ensure <code>EventRequestCompleted</code> is emitted even for failed requests. 4. <strong>Add watchdog timer</strong>: If an instance stays draining beyond timeout, emit <code>EventForceTerminate</code>.</td>\n</tr>\n<tr>\n<td><strong>Memory leak in gateway or controller over time</strong></td>\n<td>Goroutines aren&#39;t being cleaned up after requests complete, or objects are retained in global maps (like <code>Router.functions</code>) without cleanup. This is common with improper context usage.</td>\n<td>1. <strong>Profile heap usage</strong>: Use <code>pprof</code> to see which types are accumulating. 2. <strong>Check for goroutine leaks</strong>: Monitor goroutine count over time; use <code>net/http/pprof</code> to see stack traces. 3. <strong>Clean up stale entries</strong>: Remove function entries from the router when functions are deleted. 4. <strong>Use weak references</strong>: For caches, use <code>sync.Map</code> with time-based expiration.</td>\n</tr>\n<tr>\n<td><strong>Metrics show unrealistic values (e.g., negative durations)</strong></td>\n<td>Race conditions in metric updates, or timestamps being recorded in different time sources (e.g., <code>time.Now()</code> vs <code>time.Since()</code>). This makes monitoring unreliable.</td>\n<td>1. <strong>Use atomic operations</strong>: For counters and gauges updated concurrently, use <code>atomic</code> package or Prometheus&#39;s built-in atomicity. 2. <strong>Standardize time source</strong>: Use <code>time.Now()</code> at the start of operations and calculate durations from that single reference. 3. <strong>Validate metrics</strong>: Add sanity checks (e.g., duration ≥ 0) before recording. 4. <strong>Test with race detector</strong>: Run tests with <code>-race</code> flag to catch concurrent updates.</td>\n</tr>\n</tbody></table>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<blockquote>\n<p><strong>Debugging Philosophy</strong>: The best debugging strategy is <strong>observability by design</strong>—instrument first, debug second. Add structured logs, metrics, and traces during initial implementation rather than as an afterthought.</p>\n</blockquote>\n<h4 id=\"a-technology-recommendations-table\">A. Technology Recommendations Table</h4>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Logging</strong></td>\n<td>Structured JSON logging with <code>log/slog</code> (Go 1.21+) or <code>zerolog</code></td>\n<td>Distributed tracing with OpenTelemetry + Jaeger</td>\n</tr>\n<tr>\n<td><strong>Metrics</strong></td>\n<td>Prometheus client library with built-in <code>/metrics</code> endpoint</td>\n<td>Prometheus + Grafana with custom dashboards per component</td>\n</tr>\n<tr>\n<td><strong>Tracing</strong></td>\n<td>Request IDs propagated via HTTP headers</td>\n<td>Full OpenTelemetry instrumentation with span context</td>\n</tr>\n<tr>\n<td><strong>Profiling</strong></td>\n<td><code>net/http/pprof</code> endpoints for CPU/memory profiles</td>\n<td>Continuous profiling with Pyroscope or Parca</td>\n</tr>\n<tr>\n<td><strong>Debug Tools</strong></td>\n<td><code>delve</code> debugger for Go, <code>docker inspect</code> for containers</td>\n<td><code>kubectl debug</code> for live container inspection</td>\n</tr>\n</tbody></table>\n<h4 id=\"b-recommended-debugging-infrastructure\">B. Recommended Debugging Infrastructure</h4>\n<p>Create a dedicated <code>internal/observability/</code> directory for shared debugging utilities:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>project-root/\n  internal/observability/\n    logging.go           ← Structured logger setup\n    metrics.go           ← Prometheus metric registration helpers\n    tracing.go           ← OpenTelemetry tracer provider\n    middleware.go        ← HTTP middleware for request ID, logging\n    debug_endpoints.go   ← pprof, health check endpoints\n  cmd/debug-tools/       ← Standalone debugging utilities\n    container-inspector/ ← Tool to examine container state\n    trace-replayer/      ← Replay captured invocation traces</code></pre></div>\n\n<h4 id=\"c-complete-debugging-helper-request-id-propagation\">C. Complete Debugging Helper: Request ID Propagation</h4>\n<p>Here&#39;s a complete implementation for request ID propagation across components—essential for tracing a single invocation through the system:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/observability/middleware.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> observability</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/google/uuid</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> contextKey</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> requestIDKey</span><span style=\"color:#B392F0\"> contextKey</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"request_id\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RequestIDMiddleware adds a unique request ID to all incoming requests</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> RequestIDMiddleware</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">next</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Check for existing request ID header (for trace continuity)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        requestID </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> r.Header.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Request-ID\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> requestID </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            requestID </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> uuid.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Add to response headers for client debugging</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Request-ID\"</span><span style=\"color:#E1E4E8\">, requestID)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Store in context for downstream components</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithValue</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">(), requestIDKey, requestID)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        next.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(w, r.</span><span style=\"color:#B392F0\">WithContext</span><span style=\"color:#E1E4E8\">(ctx))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GetRequestID extracts the request ID from context</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> GetRequestID</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> id, ok </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> ctx.</span><span style=\"color:#B392F0\">Value</span><span style=\"color:#E1E4E8\">(requestIDKey).(</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">); ok {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> id</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#9ECBFF\"> \"unknown\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// LoggingMiddleware adds structured logging with request ID</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> LoggingMiddleware</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">logger</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">next</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        start </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        requestID </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> GetRequestID</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Wrap response writer to capture status code</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        rw </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">responseWriter</span><span style=\"color:#E1E4E8\">{ResponseWriter: w, statusCode: http.StatusOK}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Log request start</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        logger.</span><span style=\"color:#B392F0\">InfoContext</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"request started\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"method\"</span><span style=\"color:#E1E4E8\">, r.Method,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"path\"</span><span style=\"color:#E1E4E8\">, r.URL.Path,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"request_id\"</span><span style=\"color:#E1E4E8\">, requestID,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        next.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(rw, r)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        </span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Log request completion</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        logger.</span><span style=\"color:#B392F0\">InfoContext</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"request completed\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"method\"</span><span style=\"color:#E1E4E8\">, r.Method,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"path\"</span><span style=\"color:#E1E4E8\">, r.URL.Path,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"status\"</span><span style=\"color:#E1E4E8\">, rw.statusCode,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"duration_ms\"</span><span style=\"color:#E1E4E8\">, time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(start).</span><span style=\"color:#B392F0\">Milliseconds</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"request_id\"</span><span style=\"color:#E1E4E8\">, requestID,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> responseWriter</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    statusCode </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">rw </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">responseWriter</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">statusCode</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rw.statusCode </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> statusCode</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rw.ResponseWriter.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(statusCode)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h4 id=\"d-core-debugging-skeleton-diagnostic-endpoint\">D. Core Debugging Skeleton: Diagnostic Endpoint</h4>\n<p>Add a diagnostic endpoint to the gateway that reveals internal state—crucial for debugging routing and scaling issues:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/gateway/debug.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> gateway</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">encoding/json</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync/atomic</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// DebugHandler exposes internal state for debugging</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> DebugHandler</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    router </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Router</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    warmPool </span><span style=\"color:#B392F0\">pool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">WarmPoolManager</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    scaler </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">scaler</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Scaler</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ServeHTTP handles debug requests</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DebugHandler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    switch</span><span style=\"color:#E1E4E8\"> r.URL.</span><span style=\"color:#B392F0\">Query</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"view\"</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#9ECBFF\"> \"routing\"</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        h.</span><span style=\"color:#B392F0\">handleRoutingDebug</span><span style=\"color:#E1E4E8\">(w, r)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#9ECBFF\"> \"warmpool\"</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        h.</span><span style=\"color:#B392F0\">handleWarmPoolDebug</span><span style=\"color:#E1E4E8\">(w, r)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#9ECBFF\"> \"scaling\"</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        h.</span><span style=\"color:#B392F0\">handleScalingDebug</span><span style=\"color:#E1E4E8\">(w, r)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    default</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        h.</span><span style=\"color:#B392F0\">handleOverview</span><span style=\"color:#E1E4E8\">(w, r)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// handleRoutingDebug shows current routing table state</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">DebugHandler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">handleRoutingDebug</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h.router.mu.</span><span style=\"color:#B392F0\">RLock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> h.router.mu.</span><span style=\"color:#B392F0\">RUnlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    type</span><span style=\"color:#B392F0\"> instanceInfo</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ID         </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        State      </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"state\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Host       </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"host\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Port       </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">       `json:\"port\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ActiveReqs </span><span style=\"color:#F97583\">int32</span><span style=\"color:#9ECBFF\">     `json:\"active_reqs\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        LastUsed   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"last_used\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Healthy    </span><span style=\"color:#F97583\">bool</span><span style=\"color:#9ECBFF\">      `json:\"healthy\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    type</span><span style=\"color:#B392F0\"> functionInfo</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Name          </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">        `json:\"name\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Instances     []</span><span style=\"color:#B392F0\">instanceInfo</span><span style=\"color:#9ECBFF\"> `json:\"instances\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ConcurrencyLimit </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">        `json:\"concurrency_limit\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ActiveCount   </span><span style=\"color:#F97583\">int32</span><span style=\"color:#9ECBFF\">         `json:\"active_count\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    functions </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#B392F0\">functionInfo</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(h.router.functions))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> name, rt </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> h.router.functions {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        instances </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#B392F0\">instanceInfo</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(rt.instances))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        for</span><span style=\"color:#E1E4E8\"> _, ri </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> rt.instances {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            instances </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> append</span><span style=\"color:#E1E4E8\">(instances, </span><span style=\"color:#B392F0\">instanceInfo</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                ID:         ri.instance.ID,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                State:      </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">(ri.instance.State),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Host:       ri.instance.Host,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Port:       ri.instance.Port,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                ActiveReqs: atomic.</span><span style=\"color:#B392F0\">LoadInt32</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">ri.activeReqs),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                LastUsed:   ri.lastUsed,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                Healthy:    ri.healthy,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        functions </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> append</span><span style=\"color:#E1E4E8\">(functions, </span><span style=\"color:#B392F0\">functionInfo</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            Name:            name,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            Instances:       instances,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            ConcurrencyLimit: </span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\">(rt.concurrencyLimit),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            ActiveCount:     atomic.</span><span style=\"color:#B392F0\">LoadInt32</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">rt.activeCount),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    </span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">NewEncoder</span><span style=\"color:#E1E4E8\">(w).</span><span style=\"color:#B392F0\">Encode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">interface</span><span style=\"color:#E1E4E8\">{}{</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"timestamp\"</span><span style=\"color:#E1E4E8\">: time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Format</span><span style=\"color:#E1E4E8\">(time.RFC3339),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"functions\"</span><span style=\"color:#E1E4E8\">: functions,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TODO: Implement handleWarmPoolDebug to show warm pool contents</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TODO: Implement handleScalingDebug to show scaling decisions and metrics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TODO: Implement handleOverview to show system health summary</span></span></code></pre></div>\n\n<h4 id=\"e-language-specific-debugging-hints-for-go\">E. Language-Specific Debugging Hints for Go</h4>\n<ol>\n<li><p><strong>Memory Profiling</strong>: Run <code>go tool pprof http://localhost:6060/debug/pprof/heap</code> to analyze memory usage. Use <code>-base</code> flag to compare two profiles.</p>\n</li>\n<li><p><strong>Goroutine Leaks</strong>: Check <code>/debug/pprof/goroutine?debug=2</code> for full stack traces. Look for goroutines stuck in channel operations without timeouts.</p>\n</li>\n<li><p><strong>Race Detection</strong>: Always run tests with <code>go test -race ./...</code>. For production debugging, build with <code>-race</code> flag (2-10x slowdown) during staging.</p>\n</li>\n<li><p><strong>Context Timeout Chains</strong>: Use <code>context.WithTimeout</code> at each layer and ensure child contexts are cancelled when parent times out. Add logging when contexts are cancelled to trace timeout propagation.</p>\n</li>\n<li><p><strong>Container Debugging</strong>: When a container fails, capture its logs before removal. Store logs in a ring buffer keyed by container ID, accessible via debug API.</p>\n</li>\n</ol>\n<h4 id=\"f-debugging-workflow-checklist\">F. Debugging Workflow Checklist</h4>\n<p>When encountering a bug, follow this systematic workflow:</p>\n<ol>\n<li><p><strong>Reproduce the Issue</strong></p>\n<ul>\n<li>Can you reproduce it consistently? If not, add more logging and try again.</li>\n<li>What are the minimal conditions (function code, load pattern, configuration)?</li>\n</ul>\n</li>\n<li><p><strong>Check the Obvious First</strong></p>\n<ul>\n<li>Are all services running? (<code>docker ps</code>, <code>systemctl status</code>)</li>\n<li>Are there error logs in any component? (Check <code>journalctl</code> or component logs)</li>\n<li>Is the system under resource pressure? (<code>htop</code>, <code>df -h</code>, <code>docker stats</code>)</li>\n</ul>\n</li>\n<li><p><strong>Isolate the Component</strong></p>\n<ul>\n<li>Does the issue happen during packaging, routing, execution, or scaling?</li>\n<li>Can you bypass components (e.g., invoke container directly vs through gateway)?</li>\n<li>Use the debug endpoints (<code>/debug/routing</code>, <code>/debug/warmpool</code>) to inspect state.</li>\n</ul>\n</li>\n<li><p><strong>Add Targeted Instrumentation</strong></p>\n<ul>\n<li>Increase log level for the suspected component.</li>\n<li>Add temporary metrics or traces around the problematic code path.</li>\n<li>Use conditional breakpoints if debugging locally.</li>\n</ul>\n</li>\n<li><p><strong>Analyze the Evidence</strong></p>\n<ul>\n<li>Collect logs, metrics, and profiles from the time of the issue.</li>\n<li>Look for patterns (e.g., &quot;always fails after 100 invocations&quot;, &quot;only when memory &gt; 80%&quot;).</li>\n<li>Correlate events across components using request IDs.</li>\n</ul>\n</li>\n<li><p><strong>Form and Test Hypothesis</strong></p>\n<ul>\n<li>Based on evidence, what&#39;s the most likely root cause?</li>\n<li>Can you write a test that reproduces the issue?</li>\n<li>Fix the issue and verify with the same reproduction steps.</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"g-common-debugging-command-cheat-sheet\">G. Common Debugging Command Cheat Sheet</h4>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># View container logs for a specific function instance</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> logs</span><span style=\"color:#E1E4E8\"> $(</span><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> ps</span><span style=\"color:#79B8FF\"> -qf</span><span style=\"color:#9ECBFF\"> \"label=function.name=myfunc\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Inspect container resource limits</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> inspect</span><span style=\"color:#E1E4E8\"> $(</span><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> ps</span><span style=\"color:#79B8FF\"> -qf</span><span style=\"color:#9ECBFF\"> \"name=worker\"</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#79B8FF\">--format=</span><span style=\"color:#9ECBFF\">'{{.HostConfig.Memory}} {{.HostConfig.CpuQuota}}'</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Check cgroup memory usage for a container</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cat</span><span style=\"color:#9ECBFF\"> /sys/fs/cgroup/memory/docker/</span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#9ECBFF\">container-i</span><span style=\"color:#E1E4E8\">d</span><span style=\"color:#F97583\">></span><span style=\"color:#9ECBFF\">/memory.usage_in_bytes</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Profile Go service with pprof</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> tool</span><span style=\"color:#9ECBFF\"> pprof</span><span style=\"color:#79B8FF\"> -http=:8080</span><span style=\"color:#9ECBFF\"> http://localhost:6060/debug/pprof/profile?seconds=</span><span style=\"color:#79B8FF\">30</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Trace HTTP requests through the system</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"X-Request-ID: debug-123\"</span><span style=\"color:#9ECBFF\"> http://gateway/invoke/myfunc</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Monitor scaling decisions in real-time</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">watch</span><span style=\"color:#79B8FF\"> -n</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#9ECBFF\"> 'curl -s http://gateway/debug?view=scaling | jq'</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Force garbage collection and view memory stats</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:6060/debug/pprof/heap?gc=</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Check for goroutine leaks</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:6060/debug/pprof/goroutine?debug=</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"goroutine\"</span></span></code></pre></div>\n\n<p>Remember: <strong>The most important debugging tool is a reproducible test case.</strong> When you encounter a bug, immediately write a test that reproduces it before fixing it. This prevents regression and helps understand the root cause.</p>\n<h2 id=\"future-extensions\">Future Extensions</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> This forward-looking section describes enhancements that build upon the foundational architecture established in Milestones 1-5. It illustrates how the current design&#39;s modularity and clear interfaces naturally accommodate evolving requirements.</p>\n</blockquote>\n<p>The serverless function runtime has been designed with <strong>extensibility as a first-class concern</strong>. Its component-based architecture, well-defined interfaces, and event-driven communication patterns create a foundation that can gracefully accommodate new capabilities without requiring significant refactoring. This section explores several potential enhancements that could be built upon the current system, explaining how each aligns with existing components and what modifications would be required.</p>\n<h3 id=\"custom-domains-and-api-gateway-features\">Custom Domains and API Gateway Features</h3>\n<p><strong>Mental Model: The Hotel Concierge Service</strong>\nImagine upgrading from a simple reception desk (the current HTTP gateway) to a full-service hotel concierge. Instead of just directing guests to their rooms (functions), the concierge can handle complex requests: &quot;Route <code>api.example.com/v1/orders</code> to the <code>order-processor</code> function, but send <code>webhooks.example.com</code> to the <code>webhook-handler</code> function, and apply rate limiting of 100 requests per minute for the <code>public-api</code> function.&quot; This enhanced routing layer transforms the runtime from a simple function executor into a full-fledged API management platform.</p>\n<p><strong>Extension Description:</strong> Currently, the <code>Gateway</code> routes all requests through a single endpoint pattern (<code>/invoke/{functionName}</code>). A custom domains extension would allow users to map their own domain names to specific functions or groups of functions, with advanced routing rules, authentication, and rate limiting.</p>\n<p><strong>How Current Design Accommodates It:</strong></p>\n<ul>\n<li>The <code>Gateway</code> component already provides a pluggable middleware chain via the <code>applyMiddleware</code> method, making it straightforward to add authentication, rate limiting, and request transformation logic.</li>\n<li>The <code>Router</code> already performs function-based routing; extending it to support host/path-based routing would primarily involve enhancing the <code>functionRoutingTable</code> to support multiple lookup keys (e.g., hostname + path prefix).</li>\n<li>The <code>InvocationRequest</code> type already includes a <code>Source</code> field that could be enriched with original host/path information for routing decisions.</li>\n</ul>\n<p><strong>Required Changes:</strong></p>\n<ol>\n<li><strong>Enhanced Routing Table:</strong> Extend the <code>functionRoutingTable</code> to support mapping from <code>(host, path)</code> tuples to a target function, with priority matching for path prefixes.</li>\n<li><strong>Domain Configuration Store:</strong> Add a new configuration component to manage domain-to-function mappings, likely persisted in the same storage backend used for function artifacts.</li>\n<li><strong>Gateway Middleware:</strong> Implement new middleware for TLS termination (if handling HTTPS), JWT validation, API key checking, and rate limiting per API key or IP address.</li>\n<li><strong>Public API Endpoint:</strong> Add a control plane API for users to configure custom domains and routing rules.</li>\n</ol>\n<p><strong>Example Routing Configuration Table:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Host</th>\n<th>Path Pattern</th>\n<th>Target Function</th>\n<th>Rate Limit</th>\n<th>Authentication</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>api.company.com</code></td>\n<td><code>/v1/orders/*</code></td>\n<td><code>order-processor</code></td>\n<td>1000 RPM</td>\n<td>JWT</td>\n</tr>\n<tr>\n<td><code>webhooks.company.com</code></td>\n<td><code>/stripe</code></td>\n<td><code>stripe-webhook</code></td>\n<td>None</td>\n<td>HMAC Signature</td>\n</tr>\n<tr>\n<td><code>(default)</code></td>\n<td><code>/admin/*</code></td>\n<td><code>admin-backend</code></td>\n<td>100 RPM</td>\n<td>API Key</td>\n</tr>\n</tbody></table>\n<h3 id=\"function-composition-and-workflows\">Function Composition and Workflows</h3>\n<p><strong>Mental Model: The Assembly Line</strong>\nThink of moving from a single, isolated workshop (individual function) to a coordinated assembly line. A raw material (request) enters the line, passes through station A (function A) for initial processing, then moves to station B (function B) for enrichment, and finally to station C (function C) for packaging the response. The assembly line controller manages the flow, handles errors at any station, and ensures the final product is delivered. This enables building complex applications by composing small, reusable functions.</p>\n<p><strong>Extension Description:</strong> Function composition allows users to define workflows where the output of one function becomes the input to another, either sequentially or in parallel. This enables building complex serverless applications without requiring a separate orchestration service.</p>\n<p><strong>How Current Design Accommodates It:</strong></p>\n<ul>\n<li>The existing <code>InvocationRequest</code> and <code>InvocationResponse</code> structures already encapsulate payloads and metadata, providing a natural format for passing data between functions.</li>\n<li>The <code>Gateway</code> and <code>Router</code> components already manage request routing; they could be extended to support internal function-to-function calls without leaving the cluster (reducing latency).</li>\n<li>The event-driven architecture with the <code>EventDispatcher</code> provides a foundation for choreographing workflows, where completion of one function triggers the next.</li>\n</ul>\n<p><strong>Required Changes:</strong></p>\n<ol>\n<li><strong>Workflow Definition Language:</strong> Introduce a new <code>WorkflowDefinition</code> type that describes the sequence, parallel branches, error handling, and retry logic.</li>\n<li><strong>Workflow Engine:</strong> Create a new <code>WorkflowExecutor</code> component that interprets workflow definitions, manages state (e.g., which step is next), and emits events for each step&#39;s start/completion.</li>\n<li><strong>Internal Service Discovery:</strong> Enhance the <code>Router</code> to support routing to a local function instance without going through the public gateway, perhaps via a dedicated internal hostname or port.</li>\n<li><strong>State Persistence:</strong> For long-running workflows, introduce a durable state store (e.g., Redis or a database) to track workflow execution progress, allowing recovery after failures.</li>\n</ol>\n<p><strong>Example Workflow Definition Structure:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Name</code></td>\n<td><code>string</code></td>\n<td>Unique workflow identifier</td>\n</tr>\n<tr>\n<td><code>Version</code></td>\n<td><code>string</code></td>\n<td>Immutable version tag</td>\n</tr>\n<tr>\n<td><code>StartAt</code></td>\n<td><code>string</code></td>\n<td>Name of the first step</td>\n</tr>\n<tr>\n<td><code>Steps</code></td>\n<td><code>map[string]WorkflowStep</code></td>\n<td>Map of step name to step definition</td>\n</tr>\n<tr>\n<td><code>Timeout</code></td>\n<td><code>int</code></td>\n<td>Maximum total execution time in seconds</td>\n</tr>\n</tbody></table>\n<p><strong>WorkflowStep Structure:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Type</code></td>\n<td><code>string</code></td>\n<td><code>&quot;function&quot;</code>, <code>&quot;parallel&quot;</code>, <code>&quot;choice&quot;</code></td>\n</tr>\n<tr>\n<td><code>FunctionName</code></td>\n<td><code>string</code></td>\n<td>Target function (for <code>&quot;function&quot;</code> type)</td>\n</tr>\n<tr>\n<td><code>Next</code></td>\n<td><code>string</code></td>\n<td>Name of next step on success</td>\n</tr>\n<tr>\n<td><code>Catch</code></td>\n<td><code>[]ErrorHandler</code></td>\n<td>Array of error handlers for this step</td>\n</tr>\n<tr>\n<td><code>Retry</code></td>\n<td><code>[]RetryPolicy</code></td>\n<td>Array of retry policies for transient failures</td>\n</tr>\n</tbody></table>\n<h3 id=\"advanced-observability-and-distributed-tracing\">Advanced Observability and Distributed Tracing</h3>\n<p><strong>Mental Model: The Air Traffic Control Radar</strong>\nImagine upgrading from simple flight logs (current metrics) to a comprehensive air traffic control radar system. You can now see not only each plane&#39;s (function&#39;s) current status but also its entire flight path (request journey) through different airspaces (components), with detailed telemetry on altitude (resource usage), speed (latency), and any turbulence (errors). This end-to-end visibility is crucial for debugging complex interactions in a distributed system.</p>\n<p><strong>Extension Description:</strong> While the current design includes basic metrics via Prometheus (<code>Metrics</code> type), advanced observability would add distributed tracing (e.g., OpenTelemetry), structured logging with correlation IDs, and a real-time dashboard for visualizing function dependencies, invocation chains, and performance bottlenecks.</p>\n<p><strong>How Current Design Accommodates It:</strong></p>\n<ul>\n<li>The <code>InvocationRequest</code> already includes a <code>RequestID</code> field, which can be propagated through all components to correlate logs and traces.</li>\n<li>The <code>EventDispatcher</code> already emits lifecycle events (<code>InstanceEvent</code>); these events could be automatically enriched with trace spans and exported to an observability backend.</li>\n<li>The middleware architecture in the <code>Gateway</code> makes it easy to inject and extract trace context headers (e.g., W3C Trace Context).</li>\n</ul>\n<p><strong>Required Changes:</strong></p>\n<ol>\n<li><strong>Tracing Integration:</strong> Integrate an OpenTelemetry SDK to create spans for key operations: gateway request handling, routing, container creation, function execution, and scaling decisions.</li>\n<li><strong>Context Propagation:</strong> Ensure the trace context is passed through the <code>InvocationRequest</code> (e.g., via a <code>TraceContext map[string]string</code> field) and used when making internal HTTP calls between components.</li>\n<li><strong>Enhanced Logging:</strong> Replace simple log statements with structured logging using a library like <code>slog</code> (Go 1.21+), ensuring all logs include the request ID, function name, and trace ID.</li>\n<li><strong>Observability Backend:</strong> Deploy a tracing backend (e.g., Jaeger or Tempo) and a log aggregation system (e.g., Loki) to store and query traces and logs.</li>\n</ol>\n<p><strong>Example Trace Context Addition to <code>InvocationRequest</code>:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> InvocationRequest</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ... existing fields ...</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TraceContext </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"traceContext,omitempty\"`</span><span style=\"color:#6A737D\"> // W3C Trace Context headers</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Observability Event Flow:</strong></p>\n<ol>\n<li>Gateway receives request → creates root span, extracts/injects trace context.</li>\n<li>Router selects instance → adds span for routing logic.</li>\n<li>Warm pool provides instance → adds span for pool acquisition.</li>\n<li>Function executes → adds span for execution duration.</li>\n<li>All spans are linked via trace ID and exported to collector.</li>\n</ol>\n<h3 id=\"stateful-functions-and-ephemeral-storage\">Stateful Functions and Ephemeral Storage</h3>\n<p><strong>Mental Model: The Hotel Room with a Safe</strong>\nCurrently, each function invocation gets a completely fresh &quot;pop-up shop&quot; with no memory of previous customers. Imagine if each shop could have a small, private safe (<code>ephemeral storage</code>) that persists only for the lifetime of that specific shop instance. Multiple visits by the same customer (requests routed to the same instance) could access and update the safe&#39;s contents, enabling caching or session state, but when the shop closes (instance terminates), the safe is destroyed. This provides limited, instance-local state without the complexity of external databases.</p>\n<p><strong>Extension Description:</strong> While serverless functions are ideally stateless, some workloads benefit from temporary, instance-local storage that persists across invocations on the same instance (e.g., caching fetched data, accumulating metrics, or maintaining WebSocket connections). This extension would provide a managed, filesystem-based cache that lives alongside the function instance and is automatically cleaned up when the instance is terminated.</p>\n<p><strong>How Current Design Accommodates It:</strong></p>\n<ul>\n<li>The <code>FunctionInstance</code> already has a lifecycle and identity (<code>ID</code>). The <code>ContainerManager</code> could attach a volume or directory that persists as long as the container lives.</li>\n<li>The <code>WarmPoolManager</code> already manages instance reuse; it could preserve the ephemeral storage when returning an instance to the pool.</li>\n<li>The <code>RuntimeCleaner</code> interface already defines a <code>Clean</code> method, which could be extended to optionally preserve (or securely wipe) the ephemeral storage directory.</li>\n</ul>\n<p><strong>Required Changes:</strong></p>\n<ol>\n<li><strong>Ephemeral Storage Configuration:</strong> Add a field to <code>FunctionDefinition</code> to request ephemeral storage (size, mount path).</li>\n<li><strong>Container Volume Attachment:</strong> Extend <code>CreateContainerRequest</code> to include volume mounts for ephemeral storage, using a unique directory per <code>FunctionInstance.ID</code>.</li>\n<li><strong>Lifecycle Management:</strong> Modify the <code>WarmPoolManager</code> to not delete the ephemeral storage when releasing an instance back to the pool (only on full termination).</li>\n<li><strong>Security Hardening:</strong> Ensure the ephemeral storage is isolated per function and instance (using filesystem permissions or separate volumes) to prevent cross-tenant access.</li>\n</ol>\n<p><strong>Example Addition to <code>FunctionDefinition</code>:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>EphemeralStorageMB</code></td>\n<td><code>int</code></td>\n<td>Size in MB of instance-local persistent storage (0 for none)</td>\n</tr>\n<tr>\n<td><code>EphemeralStoragePath</code></td>\n<td><code>string</code></td>\n<td>Mount path inside container (default <code>/cache</code>)</td>\n</tr>\n</tbody></table>\n<h3 id=\"gpu-and-specialized-hardware-support\">GPU and Specialized Hardware Support</h3>\n<p><strong>Mental Model: The Specialty Kitchen</strong>\nOur current &quot;pop-up shops&quot; are equipped with standard kitchen appliances (CPU, memory). Some recipes (workloads) require specialty equipment: a blast chiller for rapid cooling (GPU for matrix math), a sous-vide precision cooker (FPGA for cryptographic operations), or a commercial dough sheeter (TPU for machine learning). This extension allows users to request shops with specific hardware accelerators for compute-intensive tasks.</p>\n<p><strong>Extension Description:</strong> Extend the runtime to schedule functions on worker nodes with specialized hardware (GPUs, FPGAs, TPUs) and expose that hardware to the function container. This opens up serverless to machine learning inference, video encoding, scientific computing, and other accelerated workloads.</p>\n<p><strong>How Current Design Accommodates It:</strong></p>\n<ul>\n<li>The <code>ContainerManager</code> interface already abstracts container creation; implementations (like <code>DockerManager</code>) can be extended to pass device mappings (<code>--device</code> flag in Docker).</li>\n<li>The <code>Executor</code> already handles resource limits (CPU, memory); it could be extended to request and track specialized hardware units.</li>\n<li>The <code>Scaler</code> would need awareness of heterogeneous worker nodes (some with GPU, some without) to make appropriate scaling decisions.</li>\n</ul>\n<p><strong>Required Changes:</strong></p>\n<ol>\n<li><strong>Hardware Resource Model:</strong> Extend <code>FunctionDefinition</code> with optional fields like <code>GPUCount</code>, <code>GPUType</code>, <code>FPGA</code>, etc.</li>\n<li><strong>Node Labeling and Scheduling:</strong> Implement a labeling system for worker nodes (e.g., <code>hardware:gpu-p100</code>) and modify the <code>Executor</code> to select a node with matching capabilities when creating a container.</li>\n<li><strong>Container Device Mapping:</strong> Update <code>CreateContainerRequest</code> to include device requests, which the <code>ContainerManager</code> implementation translates to runtime-specific flags.</li>\n<li><strong>Cost and Billing:</strong> Track usage of specialized hardware separately for metering and billing purposes.</li>\n</ol>\n<p><strong>Example Addition to <code>CreateContainerRequest</code>:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Devices</code></td>\n<td><code>[]DeviceMapping</code></td>\n<td>List of host devices to map into container</td>\n</tr>\n<tr>\n<td><code>DeviceRequests</code></td>\n<td><code>[]DeviceRequest</code></td>\n<td>Docker-specific device requests (for GPU)</td>\n</tr>\n</tbody></table>\n<p><strong>DeviceMapping Structure:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>HostPath</code></td>\n<td><code>string</code></td>\n<td>Path on host</td>\n</tr>\n<tr>\n<td><code>ContainerPath</code></td>\n<td><code>string</code></td>\n<td>Path in container</td>\n</tr>\n<tr>\n<td><code>Permissions</code></td>\n<td><code>string</code></td>\n<td><code>&quot;rwm&quot;</code> (read, write, mknod)</td>\n</tr>\n</tbody></table>\n<h3 id=\"multi-cloud-and-hybrid-deployment\">Multi-Cloud and Hybrid Deployment</h3>\n<p><strong>Mental Model: The Franchise Model</strong>\nOur current runtime operates in a single data center (cloud region). Imagine expanding to a franchise model: identical shops (function instances) can be launched in multiple locations (clouds or on-premises), with a central management system that routes customers to the nearest location or the one with lowest latency. This provides resilience against regional outages and compliance with data sovereignty requirements.</p>\n<p><strong>Extension Description:</strong> Deploy the serverless runtime control plane once, but have it manage worker pools across multiple cloud providers (AWS, GCP, Azure) and/or on-premises data centers. Functions can be deployed globally, with invocations routed to the nearest available instance.</p>\n<p><strong>How Current Design Accommodates It:</strong></p>\n<ul>\n<li>The architecture already separates the <strong>control plane</strong> (Gateway, Controller, Scaler) from the <strong>data plane</strong> (Worker Pool). This separation allows the control plane to manage multiple remote worker pools.</li>\n<li>The <code>ContainerManager</code> interface abstracts the underlying infrastructure; different implementations could target different clouds (e.g., <code>AWSLambdaManager</code>, <code>KubernetesManager</code>).</li>\n<li>The <code>Router</code> could be enhanced with geo-aware routing based on the source IP of the request.</li>\n</ul>\n<p><strong>Required Changes:</strong></p>\n<ol>\n<li><strong>Multi-Cluster Management:</strong> Extend the <code>Scaler</code> and <code>WarmPoolManager</code> to manage pools of instances across multiple clusters, each with its own <code>ContainerManager</code>.</li>\n<li><strong>Service Discovery Across Clouds:</strong> Implement a global service discovery mechanism (e.g., using a distributed key-value store like etcd) to track available instances across regions.</li>\n<li><strong>Latency-Based Routing:</strong> Enhance the <code>Router</code> with latency measurements or geo-IP databases to select the optimal region for each request.</li>\n<li><strong>Cross-Cloud Networking:</strong> Establish secure network connectivity (VPN or cloud interconnect) between control plane and worker pools in different clouds.</li>\n</ol>\n<p><strong>Example Multi-Cluster Configuration:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Cluster Name</th>\n<th>Provider</th>\n<th>Region</th>\n<th>ContainerManager Type</th>\n<th>Endpoint</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>us-east</code></td>\n<td>AWS</td>\n<td>us-east-1</td>\n<td><code>DockerManager</code></td>\n<td><code>https://worker-us-east.internal</code></td>\n</tr>\n<tr>\n<td><code>eu-central</code></td>\n<td>GCP</td>\n<td>europe-west3</td>\n<td><code>KubernetesManager</code></td>\n<td><code>https://worker-eu.internal</code></td>\n</tr>\n<tr>\n<td><code>on-prem</code></td>\n<td>On-prem</td>\n<td>datacenter-1</td>\n<td><code>DockerManager</code></td>\n<td><code>https://worker-onprem.internal</code></td>\n</tr>\n</tbody></table>\n<h3 id=\"event-driven-architecture-with-multiple-sources\">Event-Driven Architecture with Multiple Sources</h3>\n<p><strong>Mental Model: The Universal Adapter Hub</strong>\nCurrently, functions are primarily triggered by HTTP requests. Imagine adding a universal adapter hub that can connect to any event source: message queues (Kafka, RabbitMQ), cloud storage (S3 bucket notifications), database change streams (MongoDB change streams, PostgreSQL LISTEN/NOTIFY), or cron schedules. The hub converts these diverse events into a standard <code>InvocationRequest</code> and feeds them into the existing gateway or a dedicated async invoker.</p>\n<p><strong>Extension Description:</strong> Expand the event sources beyond HTTP to include message queues, streaming platforms, cloud storage events, and scheduled (cron) invocations. This transforms the runtime into a general-purpose event-driven compute platform.</p>\n<p><strong>How Current Design Accommodates It:</strong></p>\n<ul>\n<li>The <code>InvocationRequest</code> type is already source-agnostic, with a <code>Source</code> field indicating origin.</li>\n<li>The asynchronous invocation mode (queued request) already decouples event receipt from function execution.</li>\n<li>The <code>EventDispatcher</code> can be used to propagate events from new sources to internal components.</li>\n</ul>\n<p><strong>Required Changes:</strong></p>\n<ol>\n<li><strong>Event Source Connectors:</strong> Develop a set of pluggable connectors (<code>KafkaConnector</code>, <code>S3EventsConnector</code>, <code>CronScheduler</code>) that poll or listen for events and convert them to <code>InvocationRequest</code>s.</li>\n<li><strong>Event Router:</strong> Create a new <code>EventRouter</code> component that receives events from all connectors, applies optional filtering/transformation, and forwards them to the appropriate function (via the existing <code>Gateway</code> or a new async path).</li>\n<li><strong>Enhanced Async Invoker:</strong> Extend the asynchronous invocation pathway to support larger payloads (by storing them in object storage) and guaranteed delivery with retries (using a durable queue like Redis Streams or Apache Pulsar).</li>\n</ol>\n<p><strong>Event Source Connector Interface:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Parameters</th>\n<th>Returns</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>Start</code></td>\n<td><code>ctx context.Context, eventHandler func(InvocationRequest) error</code></td>\n<td><code>error</code></td>\n<td>Starts listening for events and calls handler for each</td>\n</tr>\n<tr>\n<td><code>Stop</code></td>\n<td><code>ctx context.Context</code></td>\n<td><code>error</code></td>\n<td>Stops the connector gracefully</td>\n</tr>\n<tr>\n<td><code>Health</code></td>\n<td><code>ctx context.Context</code></td>\n<td><code>error</code></td>\n<td>Returns health status of the connection to event source</td>\n</tr>\n</tbody></table>\n<h3 id=\"design-principles-for-extensibility\">Design Principles for Extensibility</h3>\n<p>Throughout these extensions, several core design principles embedded in the current architecture prove invaluable:</p>\n<ol>\n<li><strong>Interface-Based Abstraction:</strong> Key components like <code>ContainerManager</code>, <code>WarmPoolManager</code>, and <code>EventDispatcher</code> are defined as interfaces, allowing multiple implementations without changing dependent code.</li>\n<li><strong>Event-Driven Communication:</strong> The lifecycle event system (<code>InstanceEvent</code>) creates a loosely coupled architecture where new components can subscribe to relevant events without modifying event publishers.</li>\n<li><strong>Modular Configuration:</strong> The use of configuration structs (<code>GatewayConfig</code>, <code>ScalingConfig</code>, <code>PoolConfig</code>) makes it easy to add new knobs for tuning extended features.</li>\n<li><strong>Clear Data Flow:</strong> The well-defined data structures (<code>FunctionDefinition</code>, <code>InvocationRequest</code>, <code>FunctionInstance</code>) serve as a consistent &quot;language&quot; across components, making it natural to add new fields for extended capabilities.</li>\n<li><strong>Layered Architecture:</strong> Separation between control plane (orchestration) and data plane (execution) allows each to evolve independently and scale differently.</li>\n</ol>\n<p>By adhering to these principles, the serverless function runtime maintains its agility—ready to evolve as new requirements emerge from users and the ever-changing landscape of cloud computing.</p>\n<h3 id=\"implementation-guidance\">Implementation Guidance</h3>\n<p><strong>Technology Recommendations Table:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Extension</th>\n<th>Simple Option</th>\n<th>Advanced Option</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Custom Domains</td>\n<td>Nginx proxy in front of Gateway with manual config</td>\n<td>Envoy Proxy with dynamic configuration via xDS API</td>\n</tr>\n<tr>\n<td>Function Composition</td>\n<td>Simple sequential chaining in Gateway middleware</td>\n<td>Apache Airflow or Temporal integration for complex DAGs</td>\n</tr>\n<tr>\n<td>Distributed Tracing</td>\n<td>OpenTelemetry SDK with stdout exporter</td>\n<td>Jaeger or Grafana Tempo backend with sampling and aggregation</td>\n</tr>\n<tr>\n<td>Ephemeral Storage</td>\n<td>Host-mounted volumes with per-instance directories</td>\n<td>Network-attached storage (e.g., EFS) with faster cleanup</td>\n</tr>\n<tr>\n<td>GPU Support</td>\n<td>Docker <code>--gpus all</code> flag with NVIDIA runtime</td>\n<td>Kubernetes Device Plugins with resource quotas</td>\n</tr>\n<tr>\n<td>Multi-Cloud</td>\n<td>Separate deployments per cloud with manual failover</td>\n<td>HashiCorp Consul for service mesh across clouds</td>\n</tr>\n<tr>\n<td>Event Sources</td>\n<td>Cron scheduler built into Controller</td>\n<td>Apache Camel or Spring Cloud Stream for connector framework</td>\n</tr>\n</tbody></table>\n<p><strong>Recommended File/Module Structure:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>project-root/\n  cmd/\n    server/                 # Main control plane server\n    worker/                 # Optional separate worker agent\n  internal/\n    extensions/             # New directory for extension implementations\n      apigateway/           # Custom domains and API Gateway features\n        router_ext.go       # Enhanced routing table\n        middleware/         # Auth, rate limiting middleware\n      workflows/            # Function composition\n        workflow_def.go     # WorkflowDefinition type\n        executor.go         # WorkflowExecutor\n      observability/        # Advanced tracing\n        tracing.go          # OpenTelemetry setup\n        correlated_logger.go # Structured logging\n      storage/              # Ephemeral storage\n        ephemeral_manager.go # Manages instance-local volumes\n      hardware/             # GPU support\n        device_manager.go   # Detects and allocates devices\n      multicloud/           # Multi-cloud deployment\n        cluster_manager.go  # Manages multiple worker clusters\n      eventsources/         # Event-driven sources\n        connectors/         # Kafka, S3, Cron connectors\n        event_router.go     # Routes events to functions</code></pre></div>\n\n<p><strong>Infrastructure Starter Code (OpenTelemetry Setup):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/extensions/observability/tracing.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> observability</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">go.opentelemetry.io/otel</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">go.opentelemetry.io/otel/attribute</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">go.opentelemetry.io/otel/exporters/jaeger</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">go.opentelemetry.io/otel/propagation</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">go.opentelemetry.io/otel/sdk/resource</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    sdktrace </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#B392F0\">go.opentelemetry.io/otel/sdk/trace</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    semconv </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#B392F0\">go.opentelemetry.io/otel/semconv/v1.17.0</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">go.opentelemetry.io/otel/trace</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// InitTracer initializes OpenTelemetry tracing with Jaeger exporter.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Call this once at application startup.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> InitTracer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">serviceName</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">jaegerEndpoint</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    exp, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> jaeger.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(jaeger.</span><span style=\"color:#B392F0\">WithCollectorEndpoint</span><span style=\"color:#E1E4E8\">(jaeger.</span><span style=\"color:#B392F0\">WithEndpoint</span><span style=\"color:#E1E4E8\">(jaegerEndpoint)))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, err</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    tp </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> sdktrace.</span><span style=\"color:#B392F0\">NewTracerProvider</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        sdktrace.</span><span style=\"color:#B392F0\">WithBatcher</span><span style=\"color:#E1E4E8\">(exp),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        sdktrace.</span><span style=\"color:#B392F0\">WithResource</span><span style=\"color:#E1E4E8\">(resource.</span><span style=\"color:#B392F0\">NewWithAttributes</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            semconv.SchemaURL,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            semconv.</span><span style=\"color:#B392F0\">ServiceName</span><span style=\"color:#E1E4E8\">(serviceName),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            attribute.</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"environment\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"production\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        )),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    otel.</span><span style=\"color:#B392F0\">SetTracerProvider</span><span style=\"color:#E1E4E8\">(tp)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    otel.</span><span style=\"color:#B392F0\">SetTextMapPropagator</span><span style=\"color:#E1E4E8\">(propagation.</span><span style=\"color:#B392F0\">NewCompositeTextMapPropagator</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        propagation</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">TraceContext</span><span style=\"color:#E1E4E8\">{},</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        propagation</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Baggage</span><span style=\"color:#E1E4E8\">{},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ))</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> tp.Shutdown, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TraceContextFromRequest extracts trace context from HTTP headers.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TraceContextFromRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> otel.</span><span style=\"color:#B392F0\">GetTextMapPropagator</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Extract</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">(), propagation.</span><span style=\"color:#B392F0\">HeaderCarrier</span><span style=\"color:#E1E4E8\">(r.Header))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    carrier </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> propagation</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HeaderCarrier</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    otel.</span><span style=\"color:#B392F0\">GetTextMapPropagator</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Inject</span><span style=\"color:#E1E4E8\">(ctx, carrier)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">(carrier)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// AddTraceContextToInvocationRequest adds trace context to an InvocationRequest.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> AddTraceContextToInvocationRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">req</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">InvocationRequest</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">traceCtx</span><span style=\"color:#F97583\"> map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> req.TraceContext </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        req.TraceContext </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> k, v </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> traceCtx {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        req.TraceContext[k] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> v</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Core Logic Skeleton Code (Workflow Executor):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// internal/extensions/workflows/executor.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> workflows</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// WorkflowExecutor manages the execution of a workflow definition.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> WorkflowExecutor</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    workflowDef </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">WorkflowDefinition</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    stateStore  </span><span style=\"color:#B392F0\">StateStore</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    router      </span><span style=\"color:#B392F0\">gateway</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Router</span><span style=\"color:#6A737D\"> // Use the existing router for function calls</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    metrics     </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">types</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Metrics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Execute starts workflow execution and returns immediately (async execution).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Use GetStatus to poll for completion.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">WorkflowExecutor</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Execute</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">input</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Generate a unique execution ID for this workflow run</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Persist initial state to StateStore with status \"RUNNING\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: Start a goroutine to actually run the workflow steps</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Return the execution ID to the caller</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// runWorkflow is the internal goroutine that executes workflow steps.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">WorkflowExecutor</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">runWorkflow</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">execID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">input</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Load workflow definition and current state</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Start from the step defined in workflowDef.StartAt</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 3: For each step:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //   - If type is \"function\", invoke the function via router.Route</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //   - If type is \"parallel\", invoke all branches concurrently</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //   - If type is \"choice\", evaluate conditions to select next step</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 4: Handle step errors using the Catch/Retry policies</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 5: Update state store after each step completion</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 6: When workflow completes (or fails), update final status</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GetStatus returns the current status of a workflow execution.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">WorkflowExecutor</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetStatus</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">execID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">WorkflowStatus</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 1: Retrieve execution state from StateStore</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TODO 2: Return current step, overall status, and any outputs collected so far</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// StateStore interface abstracts persistence for workflow state.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> StateStore</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    SaveState</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">execID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">state</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">WorkflowState</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    LoadState</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">execID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">WorkflowState</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Language-Specific Hints (Go):</strong></p>\n<ul>\n<li>Use <code>context.Context</code> to propagate trace spans and cancellation across goroutines.</li>\n<li>For custom domains, consider using the <code>gorilla/mux</code> router for advanced path matching.</li>\n<li>For GPU support, use <code>github.com/NVIDIA/nvidia-container-runtime</code> to interface with Docker.</li>\n<li>For event sources, use <code>github.com/segmentio/kafka-go</code> for Kafka connectivity and <code>github.com/robfig/cron/v3</code> for cron scheduling.</li>\n</ul>\n<p><strong>Milestone Checkpoint (Testing Custom Domains):</strong>\nAfter implementing custom domain routing:</p>\n<ol>\n<li>Start the gateway with the enhanced router.</li>\n<li>Configure a domain mapping: <code>api.test.local -&gt; test-function</code>.</li>\n<li>Use curl to test: <code>curl -H &quot;Host: api.test.local&quot; http://localhost:8080/any/path</code></li>\n<li>Verify the request is routed to <code>test-function</code> and the <code>InvocationRequest.Source</code> field contains the original host and path.</li>\n<li>Check logs to confirm the correct routing decision.</li>\n</ol>\n<p><strong>Debugging Tips for Extensions:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Symptom</th>\n<th>Likely Cause</th>\n<th>How to Diagnose</th>\n<th>Fix</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Custom domain requests return 404</td>\n<td>Routing table not populated</td>\n<td>Check that domain mappings are loaded into router at startup</td>\n<td>Ensure configuration is loaded before gateway starts</td>\n</tr>\n<tr>\n<td>Workflow steps execute out of order</td>\n<td>Race conditions in parallel steps</td>\n<td>Add detailed logging of step start/end times</td>\n<td>Use <code>sync.WaitGroup</code> to wait for all parallel steps before proceeding</td>\n</tr>\n<tr>\n<td>Trace spans are not connected</td>\n<td>Context propagation missing in internal calls</td>\n<td>Check if <code>TraceContext</code> is being passed in <code>InvocationRequest</code></td>\n<td>Ensure all internal HTTP calls include trace headers</td>\n</tr>\n<tr>\n<td>GPU function fails to start</td>\n<td>NVIDIA runtime not installed on worker node</td>\n<td>Check container logs for &quot;could not select device driver&quot;</td>\n<td>Install NVIDIA container toolkit on worker nodes</td>\n</tr>\n<tr>\n<td>Multi-cloud instance unhealthy</td>\n<td>Network connectivity between control plane and worker</td>\n<td>Check if control plane can reach worker endpoint</td>\n<td>Configure proper security groups and VPN tunnels</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"glossary\">Glossary</h2>\n<blockquote>\n<p><strong>Milestone(s):</strong> This reference section defines key terminology used throughout the design document, providing clarity for concepts spanning all milestones (1-5).</p>\n</blockquote>\n<p>The serverless function runtime design introduces many specialized terms and concepts. This glossary provides clear definitions to ensure consistent understanding across the team and document.</p>\n<h3 id=\"general-serverless-concepts\">General Serverless Concepts</h3>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context &amp; Examples</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Cold Start</strong></td>\n<td>The latency incurred when a function invocation requires the creation and initialization of a new execution environment from scratch. This includes loading the runtime, dependencies, and function code before execution can begin.</td>\n<td>Occurs when no warm instances are available and a new container/microVM must be provisioned. Measured as the time from invocation request to when the handler begins executing.</td>\n</tr>\n<tr>\n<td><strong>Warm Start</strong></td>\n<td>A function invocation that uses a pre-initialized execution environment from the warm pool, avoiding the overhead of environment provisioning and initialization.</td>\n<td>Happens when a previously used instance is reused. Typically 10-100x faster than cold starts.</td>\n</tr>\n<tr>\n<td><strong>Isolation</strong></td>\n<td>The architectural principle of preventing one function from observing, interfering with, or exhausting resources allocated to another function, ensuring security and predictable performance in multi-tenant environments.</td>\n<td>Implemented through container namespaces, cgroups, seccomp, and/or microVMs. Critical for preventing &quot;noisy neighbor&quot; problems.</td>\n</tr>\n<tr>\n<td><strong>Handler</strong></td>\n<td>The entry point function written by developers that processes invocation requests. The runtime loads and invokes this function when a request arrives.</td>\n<td>In Go: <code>func HandleRequest(ctx context.Context, payload []byte) ([]byte, error)</code>. Specified in the <code>FunctionDefinition.Handler</code> field.</td>\n</tr>\n<tr>\n<td><strong>Artifact</strong></td>\n<td>A self-contained package containing function code and all its dependencies, ready for deployment and execution in the runtime environment.</td>\n<td>Created during packaging (Milestone 1). For Go, this is a statically linked binary; for Python, a zip with code and virtualenv.</td>\n</tr>\n<tr>\n<td><strong>Immutable Versioning</strong></td>\n<td>A versioning scheme where once a function version is created, it cannot be modified. Each change produces a new version with a unique identifier, enabling rollbacks and consistent deployments.</td>\n<td>Implemented using content-addressable storage where the artifact hash becomes the version identifier.</td>\n</tr>\n<tr>\n<td><strong>Control Plane</strong></td>\n<td>The system components responsible for orchestration, scaling, and management decisions—coordinating what should happen but not directly processing requests.</td>\n<td>Includes the Controller, Scaler, and WarmPoolManager. Makes decisions about when to create/destroy instances.</td>\n</tr>\n<tr>\n<td><strong>Data Plane</strong></td>\n<td>The system components responsible for actual request processing and function execution—handling the &quot;data path&quot; of invocations.</td>\n<td>Includes the Gateway, Router, and Worker instances. Processes user requests end-to-end.</td>\n</tr>\n<tr>\n<td><strong>Multi-tenancy</strong></td>\n<td>The ability of the system to securely run functions from multiple customers (tenants) on shared infrastructure while maintaining isolation between them.</td>\n<td>Achieved through strong isolation boundaries at container/microVM level and per-tenant resource quotas.</td>\n</tr>\n<tr>\n<td><strong>Ephemeral Storage</strong></td>\n<td>Instance-local persistent storage that lasts for the lifetime of a function instance, typically mounted at <code>/tmp</code>, which is cleaned up when the instance terminates.</td>\n<td>Used for temporary files, caching, or any data that doesn&#39;t need to persist across invocations. Different from durable object storage.</td>\n</tr>\n<tr>\n<td><strong>Event Sources</strong></td>\n<td>External systems that trigger function invocations, such as message queues, storage bucket events, HTTP gateways, or scheduled timers.</td>\n<td>The runtime&#39;s HTTP Gateway is one event source; future extensions could add S3-compatible storage events or Kafka integration.</td>\n</tr>\n</tbody></table>\n<h3 id=\"isolation-amp-security-technologies\">Isolation &amp; Security Technologies</h3>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context &amp; Examples</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>MicroVM</strong></td>\n<td>A lightweight virtual machine optimized for serverless workloads, providing hardware-enforced isolation with minimal overhead. Firecracker is the canonical example.</td>\n<td>Offers stronger security than containers with similar startup times when using snapshot restore. Used when maximum isolation is required.</td>\n</tr>\n<tr>\n<td><strong>cgroups (Control Groups)</strong></td>\n<td>A Linux kernel feature that limits, accounts for, and isolates the resource usage (CPU, memory, disk I/O, network) of a collection of processes.</td>\n<td>Used to enforce memory limits (<code>memory.limit_in_bytes</code>) and CPU quotas (<code>cpu.cfs_quota_us</code>). Critical for preventing resource exhaustion attacks.</td>\n</tr>\n<tr>\n<td><strong>Namespaces</strong></td>\n<td>A Linux kernel feature that partitions kernel resources such that one set of processes sees one set of resources while another set of processes sees a different set, providing isolation for processes.</td>\n<td>Includes PID (process ID), network, mount, UTS (hostname), IPC, and user namespaces. Containers use these to isolate processes from the host.</td>\n</tr>\n<tr>\n<td><strong>seccomp (Secure Computing)</strong></td>\n<td>A Linux kernel feature that restricts the system calls a process can make, effectively creating a sandbox at the syscall level.</td>\n<td>Used with a restrictive profile that only allows necessary syscalls (read, write, exit) and blocks dangerous ones (ptrace, reboot).</td>\n</tr>\n<tr>\n<td><strong>AppArmor</strong></td>\n<td>A Linux Security Module (LSM) that allows system administrators to restrict programs&#39; capabilities with per-program profiles, providing mandatory access control.</td>\n<td>Can be used to restrict file access, network capabilities, and library loading beyond what namespaces provide.</td>\n</tr>\n<tr>\n<td><strong>Security Hardening</strong></td>\n<td>The process of securing a system by reducing its attack surface and eliminating vulnerabilities through configuration, least-privilege principles, and defensive coding.</td>\n<td>Includes using minimal base images, dropping capabilities, setting no-new-privileges, and applying seccomp/AppArmor profiles.</td>\n</tr>\n<tr>\n<td><strong>Zombie Containers</strong></td>\n<td>Containers that weren&#39;t properly cleaned up and continue consuming system resources (memory, PIDs) despite having exited or being orphaned.</td>\n<td>Caused by improper lifecycle management. The <code>ContainerManager</code> must ensure <code>RemoveContainer</code> is called even if <code>StopContainer</code> fails.</td>\n</tr>\n<tr>\n<td><strong>OOM Killer (Out-Of-Memory Killer)</strong></td>\n<td>A Linux kernel component that terminates processes when the system is critically low on memory, selected based on heuristics and oom_score.</td>\n<td>Triggered when a function exceeds its memory limit without proper cgroup constraints. Proper cgroup configuration ensures the function process itself is killed, not other system processes.</td>\n</tr>\n</tbody></table>\n<h3 id=\"packaging-amp-dependencies\">Packaging &amp; Dependencies</h3>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context &amp; Examples</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Dependency Resolution</strong></td>\n<td>The process of determining all required libraries and their compatible versions for a function, handling conflicts and ensuring reproducible builds.</td>\n<td>For Python: reading <code>requirements.txt</code> and resolving transitive dependencies. For Go: running <code>go mod tidy</code> to update <code>go.mod</code> and <code>go.sum</code>.</td>\n</tr>\n<tr>\n<td><strong>Content-Addressable Storage (CAS)</strong></td>\n<td>A storage system where content is retrieved by its cryptographic hash rather than location or name, providing deduplication and integrity verification.</td>\n<td>Used for storing function artifacts. The SHA-256 hash of the artifact becomes its address, enabling immutable versions and efficient caching.</td>\n</tr>\n<tr>\n<td><strong>Dependency Hell</strong></td>\n<td>A situation where different functions or versions require incompatible versions of the same library, causing conflicts that prevent proper execution.</td>\n<td>Mitigated by isolated execution environments (each function gets its own dependencies) and careful version pinning during packaging.</td>\n</tr>\n<tr>\n<td><strong>Language-Specific Runtime Bundling</strong></td>\n<td>The process of packaging function code with its language runtime and dependencies into a self-contained executable or archive.</td>\n<td>Go: compiled to static binary. Python: virtualenv zipped with handler. Java: Uber JAR with all dependencies.</td>\n</tr>\n<tr>\n<td><strong>Base Image</strong></td>\n<td>A minimal container image containing just the language runtime and essential system libraries, used as the foundation for function execution environments.</td>\n<td>Examples: <code>golang:alpine</code> for Go, <code>python:3.9-slim</code> for Python. The function artifact is injected into this base image at runtime.</td>\n</tr>\n<tr>\n<td><strong>Overlay Filesystem</strong></td>\n<td>A union filesystem that layers a writable layer on top of read-only base layers, allowing multiple containers to share the same base image while having individual writeable spaces.</td>\n<td>Used to efficiently share common runtime layers across function instances while giving each instance its own <code>/tmp</code> directory.</td>\n</tr>\n</tbody></table>\n<h3 id=\"execution-amp-optimization\">Execution &amp; Optimization</h3>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context &amp; Examples</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Warm Pool</strong></td>\n<td>A collection of pre-initialized function instances ready for immediate use, maintained to reduce cold start latency for incoming requests.</td>\n<td>Managed by the <code>WarmPoolManager</code>. Contains instances in <code>InstanceStateWarm</code> state, waiting for assignment.</td>\n</tr>\n<tr>\n<td><strong>Instance Reuse</strong></td>\n<td>The practice of returning a container to the warm pool after execution completes (if healthy) for reuse by subsequent invocations, avoiding teardown/creation overhead.</td>\n<td>Controlled by the <code>ReleaseInstance</code> method with a <code>healthy</code> boolean indicating whether the instance can be reused.</td>\n</tr>\n<tr>\n<td><strong>Predictive Warming</strong></td>\n<td>Proactively creating warm instances based on traffic pattern analysis, historical data, or scheduled events, anticipating demand before it arrives.</td>\n<td>The <code>PreWarm</code> method creates instances ahead of expected load. More advanced than reactive scaling.</td>\n</tr>\n<tr>\n<td><strong>Snapshot/Restore</strong></td>\n<td>The technique of capturing a running container&#39;s state (memory, process tree, open files) to disk and later restoring it to running state much faster than starting from scratch.</td>\n<td>Implemented with CRIU (Checkpoint/Restore In Userspace). Can achieve sub-100ms restores for prepared environments.</td>\n</tr>\n<tr>\n<td><strong>Just-In-Time (JIT) Compilation Caching</strong></td>\n<td>Caching the results of runtime compilation (e.g., Python bytecode, JVM JIT optimizations) across invocations to reduce execution latency.</td>\n<td>For Python: <code>.pyc</code> files cached in the container&#39;s filesystem. For Java: HotSpot JVM profile data persisted across warm starts.</td>\n</tr>\n<tr>\n<td><strong>Instance Cleanup</strong></td>\n<td>The process of resetting an execution environment to a fresh state before reuse, removing any temporary files, resetting network connections, and clearing memory.</td>\n<td>Implemented by the <code>RuntimeCleaner</code> interface. Ensures no data leaks between invocations on the same instance.</td>\n</tr>\n<tr>\n<td><strong>Provisioned Concurrency</strong></td>\n<td>A configuration that keeps a minimum number of instances always warm, guaranteeing zero cold starts for those instances up to the provisioned level.</td>\n<td>Useful for latency-sensitive workloads. Implemented as <code>MinWarmInstances</code> in the <code>PoolConfig</code>.</td>\n</tr>\n</tbody></table>\n<h3 id=\"routing-amp-load-management\">Routing &amp; Load Management</h3>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context &amp; Examples</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Least-Connections</strong></td>\n<td>A load balancing strategy that sends incoming requests to the instance with the fewest active connections/requests, promoting even distribution of load.</td>\n<td>Used by the <code>Router.selectInstance</code> method. Helps balance load across instances with varying execution times.</td>\n</tr>\n<tr>\n<td><strong>Circuit Breaker</strong></td>\n<td>A design pattern that prevents requests from being sent to unhealthy instances by temporarily &quot;opening the circuit&quot; after a threshold of failures is reached.</td>\n<td>Implemented in <code>functionRoutingTable.circuitBreaker</code>. Stops routing to an instance that consistently fails, giving it time to recover.</td>\n</tr>\n<tr>\n<td><strong>Request Queue</strong></td>\n<td>A bounded buffer that holds incoming requests when all available instances are busy, preventing immediate rejection during traffic spikes.</td>\n<td>Implemented as a priority queue in <code>RequestQueue</code>. Configurable maximum size to prevent memory exhaustion.</td>\n</tr>\n<tr>\n<td><strong>Timeout Propagation</strong></td>\n<td>The practice of passing deadline information from the client through all system layers to the function execution, ensuring consistent timeout handling across the stack.</td>\n<td>The <code>InvocationRequest.Deadline</code> is set by the gateway and respected by the router, executor, and container manager.</td>\n</tr>\n<tr>\n<td><strong>Concurrency Limit</strong></td>\n<td>The maximum number of simultaneous requests a function instance can handle, preventing over-subscription and resource contention.</td>\n<td>Enforced per instance (<code>routedInstance.activeReqs</code>) and per function (<code>functionRoutingTable.concurrencyLimit</code>).</td>\n</tr>\n<tr>\n<td><strong>Sticky Routing</strong></td>\n<td>Sending subsequent requests from the same client/session to the same function instance, useful for maintaining in-memory state or warming caches.</td>\n<td>Optional feature using <code>InvocationRequest.PreferredInstanceID</code>. Implemented with a TTL to handle instance termination.</td>\n</tr>\n<tr>\n<td><strong>Load Shedding</strong></td>\n<td>Intentionally rejecting requests (with 503 Service Unavailable) when the system is overloaded, protecting critical components from collapse under excessive load.</td>\n<td>Implemented when the request queue is full or when system-wide resource thresholds are exceeded.</td>\n</tr>\n<tr>\n<td><strong>Backpressure</strong></td>\n<td>A mechanism that signals upstream components to slow down when downstream components are overloaded, preventing cascading failures.</td>\n<td>The request queue depth metrics can feed back to the gateway to adjust admission control.</td>\n</tr>\n</tbody></table>\n<h3 id=\"scaling-amp-lifecycle\">Scaling &amp; Lifecycle</h3>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context &amp; Examples</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Auto-Scaling</strong></td>\n<td>The dynamic adjustment of function instances based on demand, automatically adding instances during load increases and removing them during decreases.</td>\n<td>Implemented by the <code>Scaler</code> component, which evaluates metrics and makes <code>ScaleDecision</code>s.</td>\n</tr>\n<tr>\n<td><strong>Scale-to-Zero</strong></td>\n<td>The capability to remove all running instances of a function after a period of inactivity (idle timeout), eliminating resource consumption when not in use.</td>\n<td>Triggered by <code>Scaler</code> when <code>IdleTimeout</code> is reached. All instances transition through <code>InstanceStateDraining</code> to <code>InstanceStateTerminated</code>.</td>\n</tr>\n<tr>\n<td><strong>Target Concurrency</strong></td>\n<td>The desired number of concurrent executions per instance used as a scaling target; scaling occurs to maintain actual concurrency near this target.</td>\n<td>Set in <code>ScalingConfig.TargetConcurrency</code>. If actual concurrency per instance exceeds this, scale up; if below, scale down.</td>\n</tr>\n<tr>\n<td><strong>Scaling Thrashing</strong></td>\n<td>Rapid oscillation between scale-up and scale-down actions caused by overly sensitive thresholds or insufficient stabilization periods.</td>\n<td>Prevented by cooldown periods (<code>ScaleUpCooldown</code>, <code>ScaleDownCooldown</code>) and hysteresis (different up/down thresholds).</td>\n</tr>\n<tr>\n<td><strong>Cooldown Period</strong></td>\n<td>A minimum time that must elapse between scaling actions of the same direction, preventing rapid successive adjustments and allowing metrics to stabilize.</td>\n<td>Configurable per function in <code>ScalingConfig</code>. The <code>Scaler</code> tracks <code>lastScaleUpTime</code> and <code>lastScaleDownTime</code>.</td>\n</tr>\n<tr>\n<td><strong>Idle Timeout</strong></td>\n<td>The duration an instance must be idle (no active requests) before being considered for termination during scale-down operations.</td>\n<td>Different from TTL (absolute maximum lifetime). An instance may be terminated earlier due to scale-down even if not idle.</td>\n</tr>\n<tr>\n<td><strong>Hysteresis</strong></td>\n<td>Using different thresholds for scale-up versus scale-down to create a &quot;dead band&quot; that prevents oscillation around a single threshold.</td>\n<td>Example: scale up at 70% utilization, scale down at 30% utilization, preventing thrashing at 50% utilization.</td>\n</tr>\n<tr>\n<td><strong>Reactive Scaling</strong></td>\n<td>Scaling based on current metrics (e.g., current concurrency, queue depth), responding to observed load changes.</td>\n<td>Simpler to implement. The default approach in the <code>Scaler.EvaluateScaling</code> method.</td>\n</tr>\n<tr>\n<td><strong>Predictive Scaling</strong></td>\n<td>Scaling based on predicted future demand using historical patterns, time series forecasting, or scheduled events.</td>\n<td>More complex but can pre-warm instances before load arrives. Future extension using machine learning models.</td>\n</tr>\n</tbody></table>\n<h3 id=\"state-management-amp-events\">State Management &amp; Events</h3>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context &amp; Examples</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Lifecycle Event</strong></td>\n<td>A discrete occurrence in the system that triggers state transitions, such as instance creation, request assignment, or timeout expiration.</td>\n<td>Represented by <code>InstanceEvent</code> with <code>Type</code>, <code>Timestamp</code>, and related data. Published via <code>EventDispatcher</code>.</td>\n</tr>\n<tr>\n<td><strong>State Machine</strong></td>\n<td>A component that manages state transitions with validation, ensuring an entity moves through predefined states according to business rules.</td>\n<td>The <code>StateMachine</code> for <code>FunctionInstance</code> validates transitions using <code>validateTransition</code> and executes handlers for each state.</td>\n</tr>\n<tr>\n<td><strong>Flow Coordinator</strong></td>\n<td>An orchestrator component that coordinates cross-component interactions during complex workflows like invocation handling with fallbacks.</td>\n<td>The <code>FlowCoordinator</code> manages the end-to-end flow of a request, handling timeouts, retries, and error recovery.</td>\n</tr>\n<tr>\n<td><strong>Event Dispatcher</strong></td>\n<td>A component that distributes events to subscribers using channels or callbacks, enabling loose coupling between components.</td>\n<td>The <code>EventDispatcher</code> allows components like <code>Scaler</code>, <code>WarmPoolManager</code>, and metrics collectors to react to events.</td>\n</tr>\n<tr>\n<td><strong>Transition Validation</strong></td>\n<td>The process of checking whether a state change is allowed according to defined rules before executing the transition.</td>\n<td>The <code>StateMachine.validateTransition</code> method ensures illegal transitions (e.g., <code>Terminated</code> → <code>Active</code>) are rejected.</td>\n</tr>\n<tr>\n<td><strong>Drain Timeout</strong></td>\n<td>The maximum time allowed for graceful shutdown of an instance, during which it completes in-flight requests but accepts no new ones.</td>\n<td>When scaling down, instances transition to <code>InstanceStateDraining</code> and have until the drain timeout to finish.</td>\n</tr>\n<tr>\n<td><strong>Graceful Degradation</strong></td>\n<td>The system&#39;s ability to provide reduced functionality when under stress or partial failure, rather than completely failing.</td>\n<td>Example: When storage is unavailable, the system might accept invocations but disable function uploads, rather than rejecting all requests.</td>\n</tr>\n</tbody></table>\n<h3 id=\"error-handling-amp-resilience\">Error Handling &amp; Resilience</h3>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context &amp; Examples</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Defense-in-Depth</strong></td>\n<td>A layered approach to error handling and security with multiple fallbacks, so if one mechanism fails, others still provide protection.</td>\n<td>Example: Functions run in containers (layer 1) with cgroup limits (layer 2) and seccomp filters (layer 3).</td>\n</tr>\n<tr>\n<td><strong>Error Propagation</strong></td>\n<td>The pattern of passing error information through system components with appropriate context, enabling meaningful logging and recovery decisions.</td>\n<td><code>ClassifiedError</code> wraps raw errors with type, retryability, and context, flowing from executor to gateway.</td>\n</tr>\n<tr>\n<td><strong>Exponential Backoff</strong></td>\n<td>A retry strategy where the delay between retries increases exponentially, reducing load on recovering systems and preventing retry storms.</td>\n<td>Used when retrying failed invocations or container operations. Configurable with <code>BackoffBase</code> and <code>BackoffMax</code>.</td>\n</tr>\n<tr>\n<td><strong>Fail-Stop</strong></td>\n<td>A design where components stop completely on failure (with clear error signals) rather than continuing in an undefined or corrupted state.</td>\n<td>Preferable in isolation components: if a container cannot be securely created, fail completely rather than run with weakened isolation.</td>\n</tr>\n<tr>\n<td><strong>Cold Start Retry</strong></td>\n<td>Specifically retrying an invocation that failed due to cold start timeout, giving a newly created instance more time to initialize.</td>\n<td>Controlled by <code>SyncInvokerConfig.RetryOnColdStart</code>. The <code>handleColdStartRetry</code> method determines if retry is appropriate.</td>\n</tr>\n<tr>\n<td><strong>Recovery State Machine</strong></td>\n<td>A specialized state machine that manages the recovery lifecycle of a failed instance, attempting cleanup, health checks, and potential restart.</td>\n<td>Future extension: when an instance enters <code>InstanceStateError</code>, a recovery state machine could attempt automated repair.</td>\n</tr>\n</tbody></table>\n<h3 id=\"testing-amp-observability\">Testing &amp; Observability</h3>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context &amp; Examples</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Arrange-Act-Assert</strong></td>\n<td>A unit test pattern with clear separation of test setup (Arrange), execution (Act), and verification (Assert), improving test readability.</td>\n<td>Used throughout the test suite. Example: Arrange a mock container manager, Act by calling <code>CreateContainer</code>, Assert that container exists.</td>\n</tr>\n<tr>\n<td><strong>Property-Based Tests</strong></td>\n<td>Tests that generate random inputs according to specified properties to discover edge cases, rather than testing specific predefined examples.</td>\n<td>Useful for testing the router&#39;s load balancing algorithm with random request distributions and instance health states.</td>\n</tr>\n<tr>\n<td><strong>Golden Files</strong></td>\n<td>Reference test output files stored alongside tests for comparison, ensuring output format stability across refactorings.</td>\n<td>Used for testing serialization formats (e.g., <code>FunctionDefinition</code> JSON marshaling) and CLI command outputs.</td>\n</tr>\n<tr>\n<td><strong>Testcontainers</strong></td>\n<td>A pattern for spinning up real container dependencies (like databases) in tests, providing more realistic integration testing.</td>\n<td>Used in integration tests that require actual Docker containers rather than mocks.</td>\n</tr>\n<tr>\n<td><strong>Deterministic Time</strong></td>\n<td>A controllable time source (like <code>FakeClock</code>) used in timing-sensitive tests, allowing precise control over time-based behavior.</td>\n<td>Critical for testing timeout logic, TTL expiration, and scaling cooldowns without actually sleeping.</td>\n</tr>\n<tr>\n<td><strong>Distributed Tracing</strong></td>\n<td>End-to-end tracking of requests across service boundaries using unique trace IDs and span IDs, enabling performance analysis in complex systems.</td>\n<td>Implemented via OpenTelemetry with Jaeger. <code>TraceContextFromRequest</code> extracts and propagates trace context.</td>\n</tr>\n<tr>\n<td><strong>Trace Context</strong></td>\n<td>A set of headers (trace ID, span ID, sampling flags) that propagate across services for distributed tracing, following the W3C Trace Context standard.</td>\n<td>Added to <code>InvocationRequest</code> via <code>AddTraceContextToInvocationRequest</code> and passed through all components.</td>\n</tr>\n<tr>\n<td><strong>Observability</strong></td>\n<td>The measure of how well internal states of a system can be inferred from its external outputs (logs, metrics, traces), beyond simple monitoring.</td>\n<td>The runtime provides metrics (Prometheus), structured logs, and distributed traces for full observability.</td>\n</tr>\n</tbody></table>\n<h3 id=\"advanced-concepts-amp-extensions\">Advanced Concepts &amp; Extensions</h3>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Definition</th>\n<th>Context &amp; Examples</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Custom Domains</strong></td>\n<td>Mapping user domain names (e.g., <code>api.example.com</code>) to specific functions with advanced routing rules, TLS termination, and custom middleware.</td>\n<td>Future extension: adds a domain manager component that integrates with the gateway for host-based routing.</td>\n</tr>\n<tr>\n<td><strong>Function Composition</strong></td>\n<td>Orchestrating multiple functions into workflows where the output of one function becomes the input to another, creating serverless applications.</td>\n<td>Implemented via the <code>WorkflowEngine</code> interpreting <code>WorkflowDefinition</code> with steps, error handlers, and retry policies.</td>\n</tr>\n<tr>\n<td><strong>Workflow Engine</strong></td>\n<td>A component that interprets workflow definitions and manages stateful execution of steps, handling retries, error branching, and parallel execution.</td>\n<td>Manages <code>WorkflowState</code> persistence and coordinates function invocations as defined in <code>WorkflowStep</code> configurations.</td>\n</tr>\n<tr>\n<td><strong>GPU Support</strong></td>\n<td>Allocating and exposing graphics processing units (or other accelerators) to functions for machine learning, video processing, or scientific computing.</td>\n<td>Requires specialized container configuration (nvidia-docker), GPU-aware scheduling, and billing for accelerator time.</td>\n</tr>\n<tr>\n<td><strong>Specialized Hardware</strong></td>\n<td>Accelerators like GPUs, FPGAs, or TPUs allocated to functions for compute-intensive workloads beyond general-purpose CPUs.</td>\n<td>Future extension requiring hardware inventory management, driver isolation, and specialized scheduling algorithms.</td>\n</tr>\n<tr>\n<td><strong>Multi-Cloud Deployment</strong></td>\n<td>Running the runtime across multiple cloud providers and/or on-premises data centers, with unified management and function portability.</td>\n<td>Architecture designed with pluggable components (storage, container runtime) to support different infrastructure backends.</td>\n</tr>\n<tr>\n<td><strong>Edge Deployment</strong></td>\n<td>Running function instances geographically close to end-users for reduced latency, with synchronization challenges for state and code distribution.</td>\n<td>Requires lightweight worker nodes, efficient artifact distribution, and location-aware routing in the gateway.</td>\n</tr>\n</tbody></table>\n<hr>\n<blockquote>\n<p><strong>Key Insight:</strong> Consistent terminology is crucial in distributed systems. This glossary not only defines terms but reveals the conceptual framework of the runtime—how isolation, speed, and efficiency trade-offs are managed through specific technologies and patterns. When implementing, ensure your team uses these exact terms to avoid confusion.</p>\n</blockquote>\n<h3 id=\"common-acronyms\">Common Acronyms</h3>\n<table>\n<thead>\n<tr>\n<th>Acronym</th>\n<th>Full Form</th>\n<th>Context</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>CAS</strong></td>\n<td>Content-Addressable Storage</td>\n<td>Used for artifact storage (Milestone 1)</td>\n</tr>\n<tr>\n<td><strong>CRIU</strong></td>\n<td>Checkpoint/Restore In Userspace</td>\n<td>Used for container snapshot/restore (Milestone 3)</td>\n</tr>\n<tr>\n<td><strong>OOM</strong></td>\n<td>Out-Of-Memory</td>\n<td>Error type when function exceeds memory limits</td>\n</tr>\n<tr>\n<td><strong>RPS</strong></td>\n<td>Requests Per Second</td>\n<td>Key scaling metric (Milestone 5)</td>\n</tr>\n<tr>\n<td><strong>TTL</strong></td>\n<td>Time-To-Live</td>\n<td>Maximum lifetime for warm instances</td>\n</tr>\n<tr>\n<td><strong>JIT</strong></td>\n<td>Just-In-Time</td>\n<td>Compilation caching optimization</td>\n</tr>\n<tr>\n<td><strong>JVM</strong></td>\n<td>Java Virtual Machine</td>\n<td>Runtime for Java functions</td>\n</tr>\n<tr>\n<td><strong>VM</strong></td>\n<td>Virtual Machine</td>\n<td>General virtualization technology</td>\n</tr>\n<tr>\n<td><strong>LSM</strong></td>\n<td>Linux Security Module</td>\n<td>AppArmor, SELinux security frameworks</td>\n</tr>\n<tr>\n<td><strong>API</strong></td>\n<td>Application Programming Interface</td>\n<td>How users interact with the system</td>\n</tr>\n<tr>\n<td><strong>HTTP</strong></td>\n<td>Hypertext Transfer Protocol</td>\n<td>Primary invocation protocol</td>\n</tr>\n<tr>\n<td><strong>JSON</strong></td>\n<td>JavaScript Object Notation</td>\n<td>Data serialization format</td>\n</tr>\n<tr>\n<td><strong>CLI</strong></td>\n<td>Command Line Interface</td>\n<td>Administrative tooling</td>\n</tr>\n<tr>\n<td><strong>UI</strong></td>\n<td>User Interface</td>\n<td>Web-based management console (future)</td>\n</tr>\n<tr>\n<td><strong>IPC</strong></td>\n<td>Inter-Process Communication</td>\n<td>Namespace type for container isolation</td>\n</tr>\n<tr>\n<td><strong>UTS</strong></td>\n<td>UNIX Timesharing System</td>\n<td>Namespace for hostname isolation</td>\n</tr>\n<tr>\n<td><strong>PID</strong></td>\n<td>Process ID</td>\n<td>Namespace for process tree isolation</td>\n</tr>\n</tbody></table>\n","toc":[{"level":1,"text":"Serverless Function Runtime: Design Document","id":"serverless-function-runtime-design-document"},{"level":2,"text":"Overview","id":"overview"},{"level":2,"text":"Context and Problem Statement","id":"context-and-problem-statement"},{"level":3,"text":"Mental Model: The Instant Coffee Machine vs. The Barista","id":"mental-model-the-instant-coffee-machine-vs-the-barista"},{"level":3,"text":"The Core Technical Challenge: Isolation vs. Speed","id":"the-core-technical-challenge-isolation-vs-speed"},{"level":3,"text":"Survey of Existing Approaches","id":"survey-of-existing-approaches"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":2,"text":"Goals and Non-Goals","id":"goals-and-non-goals"},{"level":3,"text":"Guiding Principles","id":"guiding-principles"},{"level":3,"text":"Goals","id":"goals"},{"level":3,"text":"Non-Goals","id":"non-goals"},{"level":3,"text":"Architecture Decision Record: Foundational Isolation Technology","id":"architecture-decision-record-foundational-isolation-technology"},{"level":3,"text":"Common Pitfalls in Scope Definition","id":"common-pitfalls-in-scope-definition"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"A. Technology Recommendations Table","id":"a-technology-recommendations-table"},{"level":4,"text":"B. Recommended File/Module Structure","id":"b-recommended-filemodule-structure"},{"level":4,"text":"C. Core Logic Skeleton: Goal Validation Metric","id":"c-core-logic-skeleton-goal-validation-metric"},{"level":4,"text":"D. Language-Specific Hints (Go)","id":"d-language-specific-hints-go"},{"level":4,"text":"E. Milestone Checkpoint: Goal Validation","id":"e-milestone-checkpoint-goal-validation"},{"level":2,"text":"High-Level Architecture","id":"high-level-architecture"},{"level":3,"text":"Component Overview and Responsibilities","id":"component-overview-and-responsibilities"},{"level":4,"text":"HTTP Gateway: The Public Entry Point","id":"http-gateway-the-public-entry-point"},{"level":4,"text":"Controller: The Orchestration Brain","id":"controller-the-orchestration-brain"},{"level":4,"text":"Worker Pool: The Execution Fabric","id":"worker-pool-the-execution-fabric"},{"level":4,"text":"Storage: The Durable Backbone","id":"storage-the-durable-backbone"},{"level":3,"text":"Recommended File and Module Structure","id":"recommended-file-and-module-structure"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"A. Technology Recommendations Table","id":"a-technology-recommendations-table"},{"level":4,"text":"B. Core Infrastructure Starter Code","id":"b-core-infrastructure-starter-code"},{"level":4,"text":"C. Entry Point Skeleton Code","id":"c-entry-point-skeleton-code"},{"level":4,"text":"D. Language-Specific Hints for Go","id":"d-language-specific-hints-for-go"},{"level":4,"text":"E. Milestone Checkpoint for Architecture Foundation","id":"e-milestone-checkpoint-for-architecture-foundation"},{"level":2,"text":"Data Model","id":"data-model"},{"level":3,"text":"Core Types and Structures","id":"core-types-and-structures"},{"level":4,"text":"FunctionDefinition: The Blueprint","id":"functiondefinition-the-blueprint"},{"level":4,"text":"FunctionInstance: The Running Process","id":"functioninstance-the-running-process"},{"level":4,"text":"InvocationRequest: The Work Item","id":"invocationrequest-the-work-item"},{"level":4,"text":"Supporting Data Structures","id":"supporting-data-structures"},{"level":3,"text":"Lifecycle State Definitions","id":"lifecycle-state-definitions"},{"level":4,"text":"FunctionInstanceState Constants","id":"functioninstancestate-constants"},{"level":4,"text":"State Transition Logic","id":"state-transition-logic"},{"level":4,"text":"Container Status Mapping","id":"container-status-mapping"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"Recommended File Structure","id":"recommended-file-structure"},{"level":4,"text":"Core Data Structure Implementation","id":"core-data-structure-implementation"},{"level":4,"text":"Data Model Validation Helper","id":"data-model-validation-helper"},{"level":4,"text":"Language-Specific Tips for Go Implementation","id":"language-specific-tips-for-go-implementation"},{"level":4,"text":"Milestone Checkpoint: Data Model Validation","id":"milestone-checkpoint-data-model-validation"},{"level":2,"text":"Component Design: Function Packaging","id":"component-design-function-packaging"},{"level":3,"text":"Mental Model: The Shipping Dock and Warehouse","id":"mental-model-the-shipping-dock-and-warehouse"},{"level":3,"text":"Interface and Workflow","id":"interface-and-workflow"},{"level":4,"text":"External API: Function Upload and Management","id":"external-api-function-upload-and-management"},{"level":4,"text":"Internal Workflow: From Upload to Stored Artifact","id":"internal-workflow-from-upload-to-stored-artifact"},{"level":4,"text":"Internal Interfaces for Language Bundlers","id":"internal-interfaces-for-language-bundlers"},{"level":3,"text":"ADR: Artifact Storage Strategy","id":"adr-artifact-storage-strategy"},{"level":3,"text":"Common Pitfalls in Function Packaging","id":"common-pitfalls-in-function-packaging"},{"level":3,"text":"Implementation Guidance for Packaging","id":"implementation-guidance-for-packaging"},{"level":4,"text":"Technology Recommendations","id":"technology-recommendations"},{"level":4,"text":"Recommended File/Module Structure","id":"recommended-filemodule-structure"},{"level":4,"text":"Infrastructure Starter Code: Upload API Handler","id":"infrastructure-starter-code-upload-api-handler"},{"level":4,"text":"Core Logic Skeleton: Packaging Coordinator","id":"core-logic-skeleton-packaging-coordinator"},{"level":4,"text":"Core Logic Skeleton: Go Language Bundler","id":"core-logic-skeleton-go-language-bundler"},{"level":4,"text":"Language-Specific Hints for Go Implementation","id":"language-specific-hints-for-go-implementation"},{"level":4,"text":"Milestone Checkpoint: Verifying Function Packaging","id":"milestone-checkpoint-verifying-function-packaging"},{"level":2,"text":"Component Design: Execution Environment","id":"component-design-execution-environment"},{"level":3,"text":"Mental Model: The Pop-Up Shop","id":"mental-model-the-pop-up-shop"},{"level":3,"text":"Container Manager Interface","id":"container-manager-interface"},{"level":3,"text":"ADR: Container vs. MicroVM Isolation","id":"adr-container-vs-microvm-isolation"},{"level":3,"text":"Common Pitfalls in Execution Environment","id":"common-pitfalls-in-execution-environment"},{"level":3,"text":"Implementation Guidance for Execution Environment","id":"implementation-guidance-for-execution-environment"},{"level":4,"text":"Technology Recommendations","id":"technology-recommendations"},{"level":4,"text":"Recommended File/Module Structure","id":"recommended-filemodule-structure"},{"level":4,"text":"Infrastructure Starter Code","id":"infrastructure-starter-code"},{"level":4,"text":"Core Logic Skeleton Code","id":"core-logic-skeleton-code"},{"level":4,"text":"Language-Specific Hints","id":"language-specific-hints"},{"level":4,"text":"Milestone Checkpoint","id":"milestone-checkpoint"},{"level":2,"text":"Component Design: Cold Start Optimization","id":"component-design-cold-start-optimization"},{"level":3,"text":"Mental Model: The Taxi Stand","id":"mental-model-the-taxi-stand"},{"level":3,"text":"Warm Pool Manager Interface","id":"warm-pool-manager-interface"},{"level":3,"text":"ADR: Pooling Strategy - Eager vs. Lazy","id":"adr-pooling-strategy-eager-vs-lazy"},{"level":3,"text":"Common Pitfalls in Cold Start Optimization","id":"common-pitfalls-in-cold-start-optimization"},{"level":3,"text":"Implementation Guidance for Cold Start","id":"implementation-guidance-for-cold-start"},{"level":2,"text":"Component Design: Request Routing","id":"component-design-request-routing"},{"level":3,"text":"Mental Model: The Restaurant Host and Waitlist","id":"mental-model-the-restaurant-host-and-waitlist"},{"level":3,"text":"Gateway API and Internal Routing","id":"gateway-api-and-internal-routing"},{"level":4,"text":"Public HTTP Gateway API","id":"public-http-gateway-api"},{"level":4,"text":"Internal Routing Mechanism","id":"internal-routing-mechanism"},{"level":4,"text":"Instance Selection Algorithm","id":"instance-selection-algorithm"},{"level":4,"text":"Request Queue Design","id":"request-queue-design"},{"level":3,"text":"ADR: Load Balancing Strategy","id":"adr-load-balancing-strategy"},{"level":3,"text":"Common Pitfalls in Request Routing","id":"common-pitfalls-in-request-routing"},{"level":3,"text":"Implementation Guidance for Routing","id":"implementation-guidance-for-routing"},{"level":4,"text":"Technology Recommendations Table","id":"technology-recommendations-table"},{"level":4,"text":"Recommended File/Module Structure","id":"recommended-filemodule-structure"},{"level":4,"text":"Infrastructure Starter Code","id":"infrastructure-starter-code"},{"level":4,"text":"Core Logic Skeleton Code","id":"core-logic-skeleton-code"},{"level":4,"text":"Language-Specific Hints","id":"language-specific-hints"},{"level":4,"text":"Milestone Checkpoint","id":"milestone-checkpoint"},{"level":2,"text":"Component Design: Auto-Scaling","id":"component-design-auto-scaling"},{"level":3,"text":"Mental Model: The Elastic Concert Hall","id":"mental-model-the-elastic-concert-hall"},{"level":3,"text":"Scaler Interface and Metrics","id":"scaler-interface-and-metrics"},{"level":3,"text":"ADR: Scaling Algorithm - Reactive vs. Predictive","id":"adr-scaling-algorithm-reactive-vs-predictive"},{"level":3,"text":"Common Pitfalls in Auto-Scaling","id":"common-pitfalls-in-auto-scaling"},{"level":3,"text":"Implementation Guidance for Auto-Scaling","id":"implementation-guidance-for-auto-scaling"},{"level":4,"text":"A. Technology Recommendations Table","id":"a-technology-recommendations-table"},{"level":4,"text":"B. Recommended File/Module Structure","id":"b-recommended-filemodule-structure"},{"level":4,"text":"C. Infrastructure Starter Code (Metrics Collector)","id":"c-infrastructure-starter-code-metrics-collector"},{"level":4,"text":"D. Core Logic Skeleton Code (Scaler Main Logic)","id":"d-core-logic-skeleton-code-scaler-main-logic"},{"level":4,"text":"E. Language-Specific Hints","id":"e-language-specific-hints"},{"level":4,"text":"F. Milestone Checkpoint","id":"f-milestone-checkpoint"},{"level":2,"text":"Interactions and Data Flow","id":"interactions-and-data-flow"},{"level":3,"text":"Synchronous Invocation Flow","id":"synchronous-invocation-flow"},{"level":4,"text":"Complete Step-by-Step Walkthrough","id":"complete-step-by-step-walkthrough"},{"level":4,"text":"Cold Start vs Warm Start Variation","id":"cold-start-vs-warm-start-variation"},{"level":4,"text":"Data Transformation Through the Pipeline","id":"data-transformation-through-the-pipeline"},{"level":3,"text":"Function Instance Lifecycle Events","id":"function-instance-lifecycle-events"},{"level":4,"text":"Instance State Transition Table","id":"instance-state-transition-table"},{"level":4,"text":"Detailed Event Descriptions","id":"detailed-event-descriptions"},{"level":4,"text":"Event-Driven Interactions Between Components","id":"event-driven-interactions-between-components"},{"level":4,"text":"Lifecycle Metrics and Monitoring","id":"lifecycle-metrics-and-monitoring"},{"level":4,"text":"Concurrency and State Consistency","id":"concurrency-and-state-consistency"},{"level":4,"text":"Recovery from Mid-Transition Failures","id":"recovery-from-mid-transition-failures"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"Technology Recommendations Table","id":"technology-recommendations-table"},{"level":4,"text":"Recommended File/Module Structure","id":"recommended-filemodule-structure"},{"level":4,"text":"Infrastructure Starter Code","id":"infrastructure-starter-code"},{"level":4,"text":"Core Logic Skeleton Code","id":"core-logic-skeleton-code"},{"level":4,"text":"Language-Specific Hints","id":"language-specific-hints"},{"level":4,"text":"Debugging Tips","id":"debugging-tips"},{"level":2,"text":"Error Handling and Edge Cases","id":"error-handling-and-edge-cases"},{"level":3,"text":"The Emergency Response Analogy","id":"the-emergency-response-analogy"},{"level":3,"text":"Failure Modes and Mitigations","id":"failure-modes-and-mitigations"},{"level":3,"text":"Error Recovery Architecture","id":"error-recovery-architecture"},{"level":3,"text":"Common Error Propagation Patterns","id":"common-error-propagation-patterns"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"Error Handling Infrastructure","id":"error-handling-infrastructure"},{"level":4,"text":"Enhanced Executor with Error Classification","id":"enhanced-executor-with-error-classification"},{"level":4,"text":"FlowCoordinator Event Handler","id":"flowcoordinator-event-handler"},{"level":4,"text":"Debugging Error Scenarios","id":"debugging-error-scenarios"},{"level":4,"text":"Testing Error Recovery","id":"testing-error-recovery"},{"level":2,"text":"Testing Strategy","id":"testing-strategy"},{"level":3,"text":"Testing Philosophy and Levels","id":"testing-philosophy-and-levels"},{"level":4,"text":"Unit Testing Strategy","id":"unit-testing-strategy"},{"level":4,"text":"Integration Testing Strategy","id":"integration-testing-strategy"},{"level":4,"text":"System Testing Strategy","id":"system-testing-strategy"},{"level":3,"text":"Test Environment Architecture","id":"test-environment-architecture"},{"level":3,"text":"Testing Edge Cases and Failure Modes","id":"testing-edge-cases-and-failure-modes"},{"level":3,"text":"Performance and Benchmark Testing","id":"performance-and-benchmark-testing"},{"level":3,"text":"Test Data Management","id":"test-data-management"},{"level":3,"text":"Continuous Integration Pipeline","id":"continuous-integration-pipeline"},{"level":3,"text":"Milestone Implementation Checkpoints","id":"milestone-implementation-checkpoints"},{"level":4,"text":"Milestone 1: Function Packaging Checkpoints","id":"milestone-1-function-packaging-checkpoints"},{"level":4,"text":"Milestone 2: Execution Environment Checkpoints","id":"milestone-2-execution-environment-checkpoints"},{"level":4,"text":"Milestone 3: Cold Start Optimization Checkpoints","id":"milestone-3-cold-start-optimization-checkpoints"},{"level":4,"text":"Milestone 4: Request Routing Checkpoints","id":"milestone-4-request-routing-checkpoints"},{"level":4,"text":"Milestone 5: Auto-Scaling Checkpoints","id":"milestone-5-auto-scaling-checkpoints"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"A. Technology Recommendations Table","id":"a-technology-recommendations-table"},{"level":4,"text":"B. Recommended File/Module Structure for Testing","id":"b-recommended-filemodule-structure-for-testing"},{"level":4,"text":"C. Infrastructure Starter Code for Test Utilities","id":"c-infrastructure-starter-code-for-test-utilities"},{"level":4,"text":"D. Core Logic Skeleton Code for Test Verification","id":"d-core-logic-skeleton-code-for-test-verification"},{"level":4,"text":"E. Language-Specific Hints for Go Testing","id":"e-language-specific-hints-for-go-testing"},{"level":4,"text":"F. Debugging Tips for Test Failures","id":"f-debugging-tips-for-test-failures"},{"level":4,"text":"G. Milestone Verification Commands Summary","id":"g-milestone-verification-commands-summary"},{"level":2,"text":"Debugging Guide","id":"debugging-guide"},{"level":3,"text":"Common Bug Symptoms and Fixes","id":"common-bug-symptoms-and-fixes"},{"level":4,"text":"Function Packaging and Deployment Issues","id":"function-packaging-and-deployment-issues"},{"level":4,"text":"Execution Environment and Isolation Issues","id":"execution-environment-and-isolation-issues"},{"level":4,"text":"Cold Start and Warm Pool Issues","id":"cold-start-and-warm-pool-issues"},{"level":4,"text":"Request Routing and Gateway Issues","id":"request-routing-and-gateway-issues"},{"level":4,"text":"Auto-Scaling and Resource Management Issues","id":"auto-scaling-and-resource-management-issues"},{"level":4,"text":"Cross-Component Integration Issues","id":"cross-component-integration-issues"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":4,"text":"A. Technology Recommendations Table","id":"a-technology-recommendations-table"},{"level":4,"text":"B. Recommended Debugging Infrastructure","id":"b-recommended-debugging-infrastructure"},{"level":4,"text":"C. Complete Debugging Helper: Request ID Propagation","id":"c-complete-debugging-helper-request-id-propagation"},{"level":4,"text":"D. Core Debugging Skeleton: Diagnostic Endpoint","id":"d-core-debugging-skeleton-diagnostic-endpoint"},{"level":4,"text":"E. Language-Specific Debugging Hints for Go","id":"e-language-specific-debugging-hints-for-go"},{"level":4,"text":"F. Debugging Workflow Checklist","id":"f-debugging-workflow-checklist"},{"level":4,"text":"G. Common Debugging Command Cheat Sheet","id":"g-common-debugging-command-cheat-sheet"},{"level":2,"text":"Future Extensions","id":"future-extensions"},{"level":3,"text":"Custom Domains and API Gateway Features","id":"custom-domains-and-api-gateway-features"},{"level":3,"text":"Function Composition and Workflows","id":"function-composition-and-workflows"},{"level":3,"text":"Advanced Observability and Distributed Tracing","id":"advanced-observability-and-distributed-tracing"},{"level":3,"text":"Stateful Functions and Ephemeral Storage","id":"stateful-functions-and-ephemeral-storage"},{"level":3,"text":"GPU and Specialized Hardware Support","id":"gpu-and-specialized-hardware-support"},{"level":3,"text":"Multi-Cloud and Hybrid Deployment","id":"multi-cloud-and-hybrid-deployment"},{"level":3,"text":"Event-Driven Architecture with Multiple Sources","id":"event-driven-architecture-with-multiple-sources"},{"level":3,"text":"Design Principles for Extensibility","id":"design-principles-for-extensibility"},{"level":3,"text":"Implementation Guidance","id":"implementation-guidance"},{"level":2,"text":"Glossary","id":"glossary"},{"level":3,"text":"General Serverless Concepts","id":"general-serverless-concepts"},{"level":3,"text":"Isolation &amp; Security Technologies","id":"isolation-amp-security-technologies"},{"level":3,"text":"Packaging &amp; Dependencies","id":"packaging-amp-dependencies"},{"level":3,"text":"Execution &amp; Optimization","id":"execution-amp-optimization"},{"level":3,"text":"Routing &amp; Load Management","id":"routing-amp-load-management"},{"level":3,"text":"Scaling &amp; Lifecycle","id":"scaling-amp-lifecycle"},{"level":3,"text":"State Management &amp; Events","id":"state-management-amp-events"},{"level":3,"text":"Error Handling &amp; Resilience","id":"error-handling-amp-resilience"},{"level":3,"text":"Testing &amp; Observability","id":"testing-amp-observability"},{"level":3,"text":"Advanced Concepts &amp; Extensions","id":"advanced-concepts-amp-extensions"},{"level":3,"text":"Common Acronyms","id":"common-acronyms"}],"title":"Serverless Function Runtime: Design Document","markdown":"# Serverless Function Runtime: Design Document\n\n\n## Overview\n\nThis system provides a platform for running ephemeral, event-driven functions without managing servers. The key architectural challenge it solves is balancing strong isolation and fast startup times (cold start optimization) while efficiently scaling from zero to handle unpredictable workloads.\n\n\n> This guide is meant to help you understand the big picture before diving into each milestone. Refer back to it whenever you need context on how components connect.\n\n\n## Context and Problem Statement\n\n> **Milestone(s):** This foundational section establishes the core problem space that all subsequent milestones address: balancing isolation, speed, and efficiency in serverless function execution.\n\nServerless computing represents a paradigm shift in how applications are built and deployed. Instead of provisioning and managing long-lived servers, developers write discrete functions that automatically scale and execute in response to events. The platform handles all infrastructure concerns—provisioning, scaling, patching, and monitoring—allowing developers to focus solely on business logic. This model offers compelling advantages: **cost efficiency** (pay only for execution time), **elastic scaling** (automatic response to load), and **reduced operational overhead** (no server management).\n\nHowever, beneath this simplified abstraction lies a complex technical challenge. Functions must execute with strong **isolation** (preventing one tenant's code from affecting another) while maintaining **fast startup times** (responding to requests within milliseconds) and **resource efficiency** (minimizing overhead for idle functions). These requirements often conflict, creating the central tension in serverless runtime design.\n\n### Mental Model: The Instant Coffee Machine vs. The Barista\n\nTo understand the fundamental trade-offs in serverless computing, consider two approaches to serving coffee:\n\n**The Instant Coffee Machine (Fast but Limited)**\n- **Operation**: Press a button → get coffee instantly\n- **Preparation**: Coffee is pre-ground, pre-measured, and pre-packaged in single-serving capsules\n- **Customization**: Limited to pre-defined options (espresso, lungo, americano)\n- **Isolation**: Each capsule is completely self-contained; no cross-contamination between servings\n- **Cleanup**: Capsule is discarded; machine is ready for next user immediately\n- **Analogous to**: Pre-initialized, templated execution environments with limited runtime customization\n\n**The Barista (Customizable but Slower)**\n- **Operation**: Place order → barista grinds beans, tamps, steams milk, pours art\n- **Preparation**: Everything done fresh per order with high-quality ingredients\n- **Customization**: Infinite variations (bean origin, grind size, milk temperature, syrup)\n- **Isolation**: Shared equipment cleaned between uses (risk of cross-contamination)\n- **Cleanup**: Thorough cleaning of portafilter, steam wand, and work area required\n- **Analogous to**: Full container or VM per function with complete environment customization\n\nThe instant coffee machine represents the ideal of serverless: **predictable, fast, and isolated execution**. Each function invocation gets its own \"capsule\"—a pre-packaged execution environment that starts instantly. However, this comes at the cost of flexibility: you're limited to the runtimes and dependencies that fit in the capsule format.\n\nThe barista model offers maximum flexibility: you can bring any coffee beans (dependencies), any milk (runtime version), and request any preparation method (custom initialization). But each order takes time to prepare, and thorough cleaning is needed between customers to prevent flavor mixing (security isolation).\n\nThe challenge in building a serverless runtime is creating a system that feels like an **instant coffee machine** to the user (fast, simple, predictable) while internally supporting the **flexibility of a barista** (arbitrary code, dependencies, runtimes). We need the speed of pre-packaged execution with the isolation guarantees of fresh preparation for each customer.\n\n### The Core Technical Challenge: Isolation vs. Speed\n\nThe fundamental tension in serverless runtime design manifests as a three-way optimization problem between **isolation strength**, **startup latency**, and **resource efficiency**.\n\n**Isolation Requirements**\nServerless platforms typically host code from multiple untrusted tenants on shared hardware. Strong isolation is non-negotiable to prevent:\n- **Resource interference**: One function consuming all CPU/memory/IO, starving others\n- **Security breaches**: A function accessing another tenant's data or code\n- **Noisy neighbors**: Performance degradation due to shared resources\n- **Privilege escalation**: Gaining host-level access through kernel vulnerabilities\n\n**Startup Latency Constraints**\nThe \"serverless promise\" includes sub-second response times, even for the first invocation (cold start). Real-world applications have strict latency budgets:\n- **User-facing APIs**: Typically require < 200ms total response time\n- **Event processing**: Often batch processing with < 1s latency requirements\n- **Cold start penalty**: The additional time to initialize a function from scratch\n\n**Resource Efficiency Demands**\nSince customers pay only for execution time, the platform must minimize overhead:\n- **Memory footprint**: Idle environments consume memory even when not executing\n- **CPU overhead**: Environment creation/teardown consumes CPU cycles\n- **Storage costs**: Function packages and runtime images require storage\n- **Network bandwidth**: Downloading dependencies on each cold start\n\nThis creates a challenging optimization landscape:\n\n| Goal | Improves | Conflicts With |\n|------|----------|----------------|\n| Stronger isolation | Security, reliability | Startup speed (more setup), Resource efficiency (more overhead) |\n| Faster startup | User experience, throughput | Isolation (less validation), Efficiency (pre-warming costs) |\n| Higher efficiency | Cost reduction, density | Isolation (sharing resources), Startup speed (less pre-warming) |\n\n> **Key Insight**: The \"cold start problem\" is not just about speed—it's the visible symptom of this deeper trade-off. When we optimize for isolation (fresh environment per invocation) and efficiency (no pre-warmed instances), we necessarily sacrifice startup speed. Conversely, when we optimize for speed (pre-warmed pools), we sacrifice efficiency (idle resource consumption) and potentially isolation (shared/reused environments).\n\n**Formalizing the Problem**\nGiven:\n- A set of functions `F = {f₁, f₂, ..., fₙ}` with arbitrary code and dependencies\n- A stream of invocation requests `R = {r₁(t₁), r₂(t₂), ...}` at unpredictable times\n- Hardware resources `H = {CPU, memory, storage, network}` shared across tenants\n- Security requirements `S = {isolation, quotas, audit}` for multi-tenancy\n\nDesign a runtime system that:\n1. **Minimizes P99 latency**: `P99(response_time(rᵢ)) ≤ L_max` (e.g., 200ms)\n2. **Enforces strong isolation**: `∀fᵢ, fⱼ ∈ F, i ≠ j: isolation(fᵢ, fⱼ) ≥ I_min`\n3. **Maximizes resource utilization**: `utilization(H) → 1` while `cost → min`\n4. **Scales elastically**: `instances(fᵢ) ∝ load(fᵢ)` with minimal hysteresis\n\nThis is the core problem our serverless runtime must solve, and each milestone represents a piece of the solution.\n\n### Survey of Existing Approaches\n\nThe industry has explored multiple isolation technologies for serverless workloads, each with different trade-offs on the isolation-speed-efficiency spectrum. Understanding these approaches informs our architecture decisions.\n\n**1. Linux Container Namespaces & cgroups (Docker-like)**\n\n| Aspect | Characteristics |\n|--------|-----------------|\n| **Isolation Mechanism** | Kernel namespaces (pid, net, mount, user, ipc, uts) + cgroups for resource limits |\n| **Startup Time** | 100-500ms for fresh container, ~50ms for pre-initialized |\n| **Isolation Strength** | Moderate (shared kernel, potential for kernel exploits) |\n| **Memory Overhead** | Low (~10MB per container for runtime) |\n| **Implementation Complexity** | Medium (leveraging existing container runtimes) |\n| **Multi-tenant Security** | Requires additional hardening (seccomp, AppArmor, SELinux) |\n\n**Pros**:\n- Mature ecosystem (Docker, containerd, CRI-O)\n- Fast startup with image layering and copy-on-write\n- Low overhead compared to full virtualization\n- Excellent tooling for packaging and distribution\n\n**Cons**:\n- Shared kernel creates larger attack surface\n- Requires careful configuration for production multi-tenancy\n- Namespace escape vulnerabilities periodically discovered\n- Less familiar to non-Linux developers\n\n**Use Cases**: AWS Lambda (2018-2020), Google Cloud Run, OpenFaaS, most on-prem serverless platforms.\n\n**2. MicroVMs (Firecracker)**\n\n| Aspect | Characteristics |\n|--------|-----------------|\n| **Isolation Mechanism** | Hardware virtualization (KVM) with minimal, specialized hypervisor |\n| **Startup Time** | 125-150ms for fresh microVM, <10ms from snapshot |\n| **Isolation Strength** | Very high (hardware-enforced isolation) |\n| **Memory Overhead** | Moderate (~5MB per microVM + guest memory) |\n| **Implementation Complexity** | High (managing VMM lifecycle, device models) |\n| **Multi-tenant Security** | Excellent (hardware isolation, minimal attack surface) |\n\n**Pros**:\n- Near-bare-metal performance with hardware isolation\n- Extremely fast snapshot/restore (<10ms)\n- Minimal attack surface (Firecracker <50K lines vs QEMU 1.5M)\n- Designed specifically for serverless workloads\n\n**Cons**:\n- Still heavier than containers\n- More complex to integrate with container ecosystem\n- Limited device support (intentionally)\n- Requires virtualization extensions (Intel VT-x/AMD-V)\n\n**Use Cases**: AWS Lambda (current), AWS Fargate, Cloudflare Workers (isolates).\n\n**3. Process-based Sandboxes (gVisor, nsjail)**\n\n| Aspect | Characteristics |\n|--------|-----------------|\n| **Isolation Mechanism** | Userspace kernel implementation + namespace isolation |\n| **Startup Time** | 20-100ms (lightweight process creation) |\n| **Isolation Strength** | High (syscall filtering, userspace kernel) |\n| **Memory Overhead** | Low to moderate (shared runsc runtime) |\n| **Implementation Complexity** | High (custom kernel implementation) |\n| **Multi-tenant Security** | Very good (syscall interception, no shared kernel) |\n\n**Pros**:\n- No virtualization required\n- Fast startup (lightweight processes)\n- Strong isolation without VM overhead\n- Compatible with container images\n\n**Cons**:\n- Performance overhead for syscall-heavy workloads\n- Compatibility issues with some syscalls\n- Complex implementation and debugging\n- Less battle-tested than containers/VMs\n\n**Use Cases**: Google Cloud Run (gVisor), sandboxed CI/CD environments.\n\n**4. Language-Specific Runtimes (WebAssembly)**\n\n| Aspect | Characteristics |\n|--------|-----------------|\n| **Isolation Mechanism** | Capability-based security within runtime |\n| **Startup Time** | <1ms (pre-compiled bytecode) |\n| **Isolation Strength** | Language-dependent (memory-safe languages higher) |\n| **Memory Overhead** | Very low (shared runtime, per-instance memory) |\n| **Implementation Complexity** | High (per-language runtime modifications) |\n| **Multi-tenant Security** | Good within runtime, depends on host isolation |\n\n**Pros**:\n- Extremely fast startup (pre-compiled)\n- Portable across platforms\n- Fine-grained resource control\n- Growing ecosystem\n\n**Cons**:\n- Limited language support\n- System call interface still evolving\n- Less mature tooling\n- Runtime-specific vulnerabilities possible\n\n**Use Cases**: Fastly Compute@Edge, Fermyon Spin, experimental platforms.\n\n**Comparison Table**\n\n| Technology | Startup Time | Isolation | Overhead | Maturity | Our Use Case |\n|------------|--------------|-----------|----------|----------|--------------|\n| **Containers** | 100-500ms | Moderate | Low | Very High | Baseline for comparison, good starting point |\n| **MicroVMs** | 10-150ms | Very High | Moderate | High | Production multi-tenant with strong security |\n| **Process Sandboxes** | 20-100ms | High | Low-Moderate | Medium | When virtualization unavailable, good security |\n| **WebAssembly** | <1ms | Language-dependent | Very Low | Emerging | Specialized use cases, fastest cold starts |\n\n> **Decision: Container-Based Isolation for Initial Implementation**\n> - **Context**: We need a practical starting point that balances implementation complexity, performance, and isolation while leveraging existing ecosystems.\n> - **Options Considered**: \n>   1. Linux containers (namespaces + cgroups)\n>   2. Firecracker microVMs\n>   3. gVisor process sandboxes\n> - **Decision**: Start with container-based isolation using runc/containerd.\n> - **Rationale**: \n>   - Containers provide sufficient isolation for many use cases with proper hardening\n>   - Vast ecosystem for packaging, distribution, and management\n>   - Easier debugging and development experience\n>   - Can be augmented with additional security (seccomp, AppArmor)\n>   - Natural migration path to microVMs later via containerd's shim API\n> - **Consequences**:\n>   - We'll need to implement additional security hardening for production\n>   - Cold starts will be slower than microVM snapshot/restore\n>   - We can later swap container runtime for Firecracker with minimal API changes\n\n**Industry Trend: Blending Approaches**\nModern serverless platforms often combine multiple isolation technologies:\n\n- **AWS Lambda**: Uses Firecracker microVMs but maintains container compatibility via OCI images\n- **Google Cloud Run**: Offers both gVisor and container-based isolation options\n- **Azure Container Instances**: Uses Hyper-V isolation for multi-tenant, containers for single-tenant\n- **OpenFaaS**: Primarily container-based but supports Kata Containers (lightweight VMs)\n\nThe trend is toward **defense-in-depth**: using stronger isolation for less-trusted workloads while optimizing for speed where appropriate. Our architecture should support this evolution.\n\n**Common Pitfalls in Isolation Technology Selection**\n\n⚡ **Pitfall: Over-engineering isolation for all use cases**\n- **Description**: Implementing the strongest possible isolation (e.g., full VMs) for all functions, even internal trusted functions.\n- **Why it's wrong**: Creates unnecessary overhead, slower startups, and higher costs without corresponding security benefit.\n- **How to avoid**: Implement tiered isolation levels based on function trust level or tenant requirements.\n\n⚡ **Pitfall: Underestimating kernel attack surface**\n- **Description**: Assuming container isolation is \"secure enough\" without additional hardening.\n- **Why it's wrong**: New container escape vulnerabilities are regularly discovered (e.g., CVE-2019-5736 runc escape).\n- **How to avoid**: Always enable seccomp, AppArmor/SELinux, and capability dropping. Consider gVisor or microVMs for untrusted code.\n\n⚡ **Pitfall: Ignoring initialization time variability**\n- **Description**: Assuming all functions have similar startup characteristics regardless of runtime.\n- **Why it's wrong**: JVM functions take ~1s+ to start, Python ~100ms, Go binary ~10ms.\n- **How to avoid**: Measure actual startup times per runtime and adjust warm pool strategies accordingly.\n\n⚡ **Pitfall: Tight coupling to specific isolation technology**\n- **Description**: Building the entire system around Docker API calls or Firecracker-specific features.\n- **Why it's wrong**: Makes migration to new technologies difficult as the ecosystem evolves.\n- **How to avoid**: Define abstraction interfaces (ContainerManager, SandboxManager) that can have multiple implementations.\n\n### Implementation Guidance\n\nWhile this section focuses on problem definition rather than implementation, we'll establish the foundational project structure and provide tools to explore the isolation technologies discussed.\n\n**A. Technology Recommendations Table**\n\n| Component | Simple Option (Learning) | Production Option (Advanced) |\n|-----------|--------------------------|------------------------------|\n| **Isolation** | Docker Engine API | containerd + runc |\n| **Orchestration** | Custom Go controller | Kubernetes Custom Resources |\n| **Storage** | Local filesystem | S3-compatible object storage |\n| **Networking** | Docker bridge network | CNI plugins (bridge, macvlan) |\n| **Monitoring** | Prometheus metrics | OpenTelemetry + distributed tracing |\n\n**B. Recommended File/Module Structure**\n\n```\nserverless-runtime/\n├── cmd/\n│   ├── controller/          # Main orchestrator\n│   │   └── main.go\n│   ├── gateway/             # HTTP gateway\n│   │   └── main.go\n│   └── worker/              # Worker node daemon\n│       └── main.go\n├── internal/\n│   ├── api/                 # Public API definitions\n│   │   ├── types.go         # Request/response types\n│   │   └── server.go        # HTTP handlers\n│   ├── container/           # Container abstraction layer\n│   │   ├── manager.go       # ContainerManager interface\n│   │   ├── docker.go        # Docker implementation\n│   │   └── firecracker.go   # Firecracker implementation (future)\n│   ├── registry/            # Function package storage\n│   │   ├── storage.go       # Storage interface\n│   │   ├── s3.go            # S3 implementation\n│   │   └── local.go         # Local filesystem implementation\n│   ├── scheduler/           # Request routing & scaling\n│   │   ├── gateway.go       # HTTP gateway logic\n│   │   ├── scaler.go        # Auto-scaling logic\n│   │   └── queue.go         # Request queue\n│   └── runtime/             # Language-specific runtime support\n│       ├── builder.go       # Function package builder\n│       ├── go.go            # Go runtime\n│       ├── python.go        # Python runtime\n│       └── nodejs.go        # Node.js runtime\n├── pkg/\n│   ├── function/            # Function definition types\n│   │   └── types.go\n│   ├── invocation/          # Invocation tracking\n│   │   └── types.go\n│   └── metrics/             # Metrics collection\n│       └── collector.go\n├── scripts/\n│   ├── benchmark/           # Performance testing\n│   └── setup/               # Environment setup\n├── go.mod\n└── README.md\n```\n\n**C. Infrastructure Starter Code: Container Exploration Tool**\n\nTo understand the practical differences between isolation technologies, here's a tool that measures startup times:\n\n```go\n// cmd/explore/main.go - Container isolation exploration tool\npackage main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"log\"\n\t\"time\"\n\n\t\"github.com/docker/docker/api/types\"\n\t\"github.com/docker/docker/api/types/container\"\n\t\"github.com/docker/docker/client\"\n)\n\ntype IsolationBenchmark struct {\n\tTechnology string\n\tImage      string\n\tCommand    []string\n}\n\nfunc main() {\n\tbenchmarks := []IsolationBenchmark{\n\t\t{\n\t\t\tTechnology: \"Container (Alpine)\",\n\t\t\tImage:      \"alpine:latest\",\n\t\t\tCommand:    []string{\"echo\", \"Hello from container\"},\n\t\t},\n\t\t{\n\t\t\tTechnology: \"Container (Python)\",\n\t\t\tImage:      \"python:3.9-slim\",\n\t\t\tCommand:    []string{\"python\", \"-c\", \"print('Python ready')\"},\n\t\t},\n\t\t// Add more benchmarks for different technologies\n\t}\n\n\tctx := context.Background()\n\tcli, err := client.NewClientWithOpts(client.FromEnv, client.WithAPIVersionNegotiation())\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tfmt.Println(\"Isolation Technology Benchmark\")\n\tfmt.Println(\"==============================\")\n\n\tfor _, bench := range benchmarks {\n\t\tfmt.Printf(\"\\nBenchmarking: %s\\n\", bench.Technology)\n\t\t\n\t\t// Pull image (simulates dependency download)\n\t\tstart := time.Now()\n\t\tfmt.Printf(\"  Pulling image %s... \", bench.Image)\n\t\treader, err := cli.ImagePull(ctx, bench.Image, types.ImagePullOptions{})\n\t\tif err != nil {\n\t\t\tlog.Printf(\"Failed to pull image: %v\", err)\n\t\t\tcontinue\n\t\t}\n\t\t// Drain the reader\n\t\tbuf := make([]byte, 1024)\n\t\tfor {\n\t\t\t_, err := reader.Read(buf)\n\t\t\tif err != nil {\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\treader.Close()\n\t\tpullTime := time.Since(start)\n\t\tfmt.Printf(\"%v\\n\", pullTime)\n\n\t\t// Create container (environment setup)\n\t\tstart = time.Now()\n\t\tfmt.Printf(\"  Creating container... \")\n\t\tresp, err := cli.ContainerCreate(ctx, &container.Config{\n\t\t\tImage: bench.Image,\n\t\t\tCmd:   bench.Command,\n\t\t}, nil, nil, nil, \"\")\n\t\tif err != nil {\n\t\t\tlog.Printf(\"Failed to create container: %v\", err)\n\t\t\tcontinue\n\t\t}\n\t\tcreateTime := time.Since(start)\n\t\tfmt.Printf(\"%v\\n\", createTime)\n\n\t\t// Start container (runtime initialization)\n\t\tstart = time.Now()\n\t\tfmt.Printf(\"  Starting container... \")\n\t\terr = cli.ContainerStart(ctx, resp.ID, types.ContainerStartOptions{})\n\t\tif err != nil {\n\t\t\tlog.Printf(\"Failed to start container: %v\", err)\n\t\t\tcontinue\n\t\t}\n\t\tstartTime := time.Since(start)\n\t\tfmt.Printf(\"%v\\n\", startTime)\n\n\t\t// Wait for completion (execution time)\n\t\tstatusCh, errCh := cli.ContainerWait(ctx, resp.ID, container.WaitConditionNotRunning)\n\t\tselect {\n\t\tcase err := <-errCh:\n\t\t\tif err != nil {\n\t\t\t\tlog.Printf(\"Error waiting for container: %v\", err)\n\t\t\t}\n\t\tcase <-statusCh:\n\t\t\t// Container finished\n\t\t}\n\n\t\t// Clean up\n\t\t_ = cli.ContainerRemove(ctx, resp.ID, types.ContainerRemoveOptions{})\n\n\t\tfmt.Printf(\"  Total cold start: %v\\n\", pullTime+createTime+startTime)\n\t}\n}\n```\n\n**D. Core Logic Skeleton: Isolation Interface**\n\n```go\n// internal/container/manager.go - Abstract isolation interface\npackage container\n\nimport (\n\t\"context\"\n\t\"io\"\n\t\"time\"\n)\n\n// ContainerManager defines the interface for managing isolated execution environments.\n// This abstraction allows swapping Docker for Firecracker or other technologies.\ntype ContainerManager interface {\n\t// CreateContainer creates a new isolated environment from an image\n\t// TODO 1: Validate image exists locally, pull if missing with retry logic\n\t// TODO 2: Generate unique container ID for tracking\n\t// TODO 3: Apply resource limits (CPU, memory) from config\n\t// TODO 4: Set up namespaces and cgroups for isolation\n\t// TODO 5: Mount function code volume at /function\n\t// TODO 6: Configure network namespace (bridge, host, or none)\n\t// TODO 7: Set up seccomp and AppArmor profiles for security\n\tCreateContainer(ctx context.Context, req CreateContainerRequest) (*Container, error)\n\t\n\t// StartContainer begins execution of the container\n\t// TODO 1: Validate container is in created state\n\t// TODO 2: Start the container process with proper stdio pipes\n\t// TODO 3: Wait for container to reach running state (health check)\n\t// TODO 4: Start timeout timer for startup\n\t// TODO 5: Log container startup events for debugging\n\tStartContainer(ctx context.Context, containerID string) error\n\t\n\t// ExecuteInContainer runs a command inside a running container\n\t// TODO 1: Validate container is running\n\t// TODO 2: Create exec instance with command and environment\n\t// TODO 3: Attach to stdin/stdout/stderr streams\n\t// TODO 4: Start execution and monitor for completion\n\t// TODO 5: Handle timeouts and cancellations\n\t// TODO 6: Capture exit code and output\n\tExecuteInContainer(ctx context.Context, containerID string, cmd []string, \n\t\tinput io.Reader, output io.Writer) (int, error)\n\t\n\t// StopContainer gracefully stops a running container\n\t// TODO 1: Send SIGTERM to container process\n\t// TODO 2: Wait for graceful shutdown (configurable timeout)\n\t// TODO 3: If timeout exceeded, send SIGKILL\n\t// TODO 4: Ensure all resources are cleaned up\n\tStopContainer(ctx context.Context, containerID string, timeout time.Duration) error\n\t\n\t// RemoveContainer cleans up container resources\n\t// TODO 1: Ensure container is stopped\n\t// TODO 2: Remove container filesystem\n\t// TODO 3: Clean up network namespace\n\t// TODO 4: Remove cgroup\n\t// TODO 5: Delete container metadata\n\tRemoveContainer(ctx context.Context, containerID string) error\n\t\n\t// GetContainerStats returns resource usage statistics\n\t// TODO 1: Read cgroup metrics for CPU, memory, I/O\n\t// TODO 2: Calculate utilization percentages\n\t// TODO 3: Include network statistics if available\n\t// TODO 4: Return structured metrics for monitoring\n\tGetContainerStats(ctx context.Context, containerID string) (*ContainerStats, error)\n\t\n\t// ListContainers returns all managed containers\n\t// TODO 1: Query container runtime for all containers\n\t// TODO 2: Filter by labels (e.g., function-id)\n\t// TODO 3: Include status and resource information\n\t// TODO 4: Support pagination for large numbers\n\tListContainers(ctx context.Context, filter ListFilter) ([]Container, error)\n}\n\n// Container represents an isolated execution environment\ntype Container struct {\n\tID        string\n\tImage     string\n\tStatus    ContainerStatus\n\tCreatedAt time.Time\n\tLabels    map[string]string\n\t// TODO: Add resource limits, network info, mount points\n}\n\ntype ContainerStatus string\n\nconst (\n\tStatusCreated    ContainerStatus = \"created\"\n\tStatusRunning    ContainerStatus = \"running\"\n\tStatusPaused     ContainerStatus = \"paused\"\n\tStatusRestarting ContainerStatus = \"restarting\"\n\tStatusExited     ContainerStatus = \"exited\"\n\tStatusDead       ContainerStatus = \"dead\"\n)\n\ntype CreateContainerRequest struct {\n\tImage        string\n\tCmd          []string\n\tEnv          []string\n\tLabels       map[string]string\n\tCPUQuota     int64    // in microseconds\n\tMemoryLimit  int64    // in bytes\n\tNetworkMode  string\n\tBinds        []string // volume mounts\n\t// TODO: Add security options, working directory, user\n}\n\n// internal/container/docker.go - Docker implementation skeleton\ntype DockerManager struct {\n\tclient *docker.Client\n}\n\nfunc NewDockerManager() (*DockerManager, error) {\n\t// TODO 1: Initialize Docker client with proper options\n\t// TODO 2: Verify Docker daemon is reachable\n\t// TODO 3: Set up context with timeout\n\t// TODO 4: Configure client for API version negotiation\n\treturn nil, nil\n}\n\nfunc (dm *DockerManager) CreateContainer(ctx context.Context, req CreateContainerRequest) (*Container, error) {\n\t// TODO: Implement using Docker SDK\n\treturn nil, nil\n}\n```\n\n**E. Language-Specific Hints for Go**\n\n1. **Docker SDK**: Use `github.com/docker/docker/client` for the official Go client. Remember to negotiate API version: `client.WithAPIVersionNegotiation()`.\n\n2. **Context Usage**: Always pass `context.Context` to container operations for cancellation and timeouts. Use `context.WithTimeout` for operations that should have deadlines.\n\n3. **Resource Limits**: When setting cgroup limits via Docker:\n   ```go\n   // CPU: 100000 means 100% of one CPU core, 50000 means 50%\n   HostConfig: &container.HostConfig{\n       Resources: container.Resources{\n           CPUQuota:  50000,  // 0.5 CPU\n           Memory:    128 * 1024 * 1024,  // 128MB\n       },\n   }\n   ```\n\n4. **Error Handling**: Container operations can fail in many ways. Check for:\n   - `errdefs.IsNotFound(err)` for missing images/containers\n   - `errdefs.IsConflict(err)` for concurrent modifications\n   - `errdefs.IsNotModified(err)` for idempotent operations\n\n5. **Cleanup**: Always implement defer or finally blocks to clean up containers, especially in error paths to prevent resource leaks.\n\n**F. Milestone Checkpoint: Understanding Isolation Technologies**\n\nAfter studying this section, you should be able to:\n\n1. **Run the exploration tool** to measure container startup times:\n   ```bash\n   cd serverless-runtime\n   go run cmd/explore/main.go\n   ```\n   Expected output shows timing for different container types.\n\n2. **Understand the trade-offs** by answering:\n   - Why would you choose containers over VMs for internal functions?\n   - What additional security measures would you add to containers for production?\n   - How does startup time change with image size?\n\n3. **Experiment with security profiles**:\n   ```bash\n   # Run a container with seccomp profile\n   docker run --security-opt seccomp=default.json alpine echo \"hello\"\n   \n   # Run without any capabilities\n   docker run --cap-drop=ALL alpine echo \"hello\"\n   ```\n\n**G. Debugging Tips: Container Startup Issues**\n\n| Symptom | Likely Cause | How to Diagnose | Fix |\n|---------|--------------|-----------------|-----|\n| **Container fails to start with \"exec format error\"** | Wrong architecture or corrupted image | `docker image inspect <image>` check architecture | Pull correct image, verify download integrity |\n| **Container starts but immediately exits** | Missing command or entrypoint | `docker logs <container>` for error messages | Specify CMD in Dockerfile or override at runtime |\n| **Permission denied errors in container** | User/group mismatch or SELinux/AppArmor | `docker run --security-opt apparmor=unconfined` test | Fix file permissions or adjust security profile |\n| **High memory usage reported** | Memory limit not applied | `docker stats` shows actual usage | Verify memory limit in container config, check for memory leaks |\n| **Slow container startup** | Large image layers or slow storage | `time docker run --rm alpine true` measure | Use smaller base images, enable layer caching |\n\n---\n\n\n## Goals and Non-Goals\n\n> **Milestone(s):** This foundational section establishes the guiding principles and constraints that shape all subsequent design decisions across Milestones 1-5. It defines the measurable success criteria for the entire runtime system and explicitly scopes the project to a manageable, focused initial implementation.\n\nThis section crystallizes the **what** and **what not** of our serverless runtime. Given the vast landscape of possible features in cloud computing, explicit boundaries are essential to maintain project focus, allocate engineering effort effectively, and set clear expectations. The goals are derived from the core value proposition of serverless computing: effortless scaling, cost efficiency, and developer productivity. The non-goals represent deliberate omissions—features that, while potentially valuable, would derail us from our primary mission or are better handled by adjacent systems.\n\n### Guiding Principles\n\nBefore enumerating specific goals, we establish three overarching principles that inform every architectural choice:\n\n1.  **Isolation is Non-Negotiable:** In a multi-tenant environment, one function must not be able to observe, interfere with, or exhaust resources allocated to another. Security and fairness are foundational.\n2.  **Cold Start Latency is the Primary Performance Metric:** The time from invocation request to function code beginning execution defines user-perceived performance. Optimizing this is our central technical challenge.\n3.  **Scale-to-Zero is a Core Efficiency Requirement:** The runtime must truly be serverless, consuming no compute resources when there is no demand, while balancing this with the cold start penalty.\n\n### Goals\n\nThe following table defines the specific, measurable outcomes that constitute a successful implementation of our serverless function runtime. Each goal is tied to a key user benefit and has concrete, testable acceptance criteria.\n\n| Goal | Success Criteria | Rationale & User Benefit |\n| :--- | :--- | :--- |\n| **G1: Strong Multi-Tenant Isolation** | 1. A function cannot access another function's memory, files, or network traffic. <br> 2. A function cannot cause a denial-of-service via resource exhaustion (CPU, memory, disk, PIDs) to the host or other functions. <br> 3. Functions run with no inherent privileges; they cannot escalate to host root or modify host kernel parameters. | Provides security and predictability. Users can run untrusted or sensitive code without fear of cross-contamination or hostile actors. This is the bedrock of a public or multi-team platform. |\n| **G2: Sub-Second Cold Start Latency (P95)** | The 95th percentile latency for a cold start invocation (including environment provisioning, code loading, and runtime initialization) is under 1 second for supported runtimes (Go, Python, Node.js). | Delivers a responsive user experience. Functions feel \"instant\" even after periods of inactivity, making serverless viable for user-facing, synchronous APIs. |\n| **G3: Efficient Scale-to-Zero** | 1. The system releases all compute resources (CPU, memory) for a function after a configurable idle period (e.g., 5-15 minutes). <br> 2. The cost of maintaining zero active instances is negligible (only metadata storage). | Enables true pay-per-use pricing. Users incur no cost when their code isn't running, which is the primary economic appeal of serverless. |\n| **G4: Rapid, Metric-Driven Autoscaling** | 1. The system can scale from zero to *N* concurrent instances to match incoming request load within seconds. <br> 2. Scaling decisions are based on observable metrics (requests-per-second, concurrent executions) with configurable thresholds. <br> 3. Scaling oscillations (thrashing) are minimized through cooldown periods and hysteresis. | Handles unpredictable or bursty workloads automatically. Users do not need to provision or manage capacity; the platform seamlessly absorbs traffic spikes. |\n| **G5: Polyglot Runtime Support** | The platform supports at least three popular language runtimes: Go (compiled binary), Python (interpreted), and Node.js (interpreted). Each is provided with a standard library environment and a mechanism for user-supplied dependencies. | Meets developers where they are. Teams can use their preferred language without being locked into a proprietary ecosystem, increasing adoption. |\n| **G6: Simple, Declarative Function Packaging** | Developers can deploy a function by providing source code and a simple declaration file (e.g., `func.yaml`) specifying the handler, runtime, and dependencies. The system handles the rest: building, bundling, and storage. | Reduces operational complexity and cognitive load. The developer experience is focused on business logic, not infrastructure plumbing. |\n| **G7: Comprehensive Observability** | The system emits structured logs, metrics (invocations, durations, errors, cold starts), and traces for every function invocation. This data is accessible via an API or integrated dashboard. | Enables debugging, performance tuning, and cost analysis. Users gain visibility into their application's behavior without manual instrumentation. |\n| **G8: Predictable, Enforceable Resource Limits** | Every function invocation is executed within strictly enforced limits for execution time (timeout), memory, and CPU allocation. Limits are defined at deployment and cannot be exceeded. | Prevents buggy or malicious code from consuming unbounded resources. Provides cost and performance predictability for platform operators and users. |\n\n### Non-Goals\n\nEqually important are the features we explicitly **will not** build in the initial version. These non-goals prevent scope creep and allow us to ship a robust, focused V1. Each is listed with a reason for exclusion, which is often that the feature is out of scope, overly complex, or better provided by a complementary system.\n\n| Non-Goal | Reason for Exclusion | Potential Future Consideration |\n| :--- | :--- | :--- |\n| **NG1: Stateful Function Instances** | The runtime assumes functions are stateless. We will not provide durable, mutable local disk or memory that persists across invocations. | State belongs in managed databases, caches, or object storage. Adding instance-persistent state dramatically complicates scaling, recovery, and data durability. |\n| **NG2: Long-Running Functions (Hours/Days)** | The system is optimized for short, ephemeral execution (seconds to minutes). We will not support functions that run for hours or days. | Use a traditional container service or virtual machine for long-running processes. Our scheduling, billing, and fault recovery models are built for brevity. |\n| **NG3: Custom Hardware or GPU Access** | Functions cannot request or access specialized hardware like GPUs, TPUs, or high-performance network interfaces. | The isolation and scheduling complexity for heterogeneous hardware is immense. This is a specialized niche outside our core focus on general-purpose compute. |\n| **NG4: Complex Event Source Integration** | We will not build first-class, built-in integrations with dozens of event sources (e.g., Kafka, RabbitMQ, DynamoDB streams). Our primary trigger is HTTP. | The function runtime is an execution layer. Event sources should be configured externally (e.g., via a message queue that calls our HTTP endpoint). This keeps the runtime simple and composable. |\n| **NG5: Advanced Networking (VPC Peering, Private Endpoints)** | Functions initially run in a shared, platform-managed network with outbound internet access. We will not support complex networking topologies like VPC peering or placement in a user's private subnet. | Networking is a complex domain that conflicts with our goal of simplicity and multi-tenancy. This can be added later if enterprise demand is high, but it significantly increases operational burden. |\n| **NG6: Function Composition or Workflow Orchestration** | We will not provide a built-in DSL or engine for chaining functions together into workflows (e.g., parallel execution, fan-out/fan-in). | Workflow orchestration is a separate concern. Our runtime executes a single unit of work. Orchestration can be implemented at the application layer or by a dedicated service (like AWS Step Functions) that invokes our functions. |\n| **NG7: Real-Time Live Code Updates** | A deployed function version is immutable. We will not support hot-swapping code or configuration into a running function instance. | Immutability simplifies versioning, rollbacks, and consistency. Updates require a new deployment, which creates a new immutable version. This is a core principle for reliability. |\n| **NG8: Full Operating System Compatibility** | The execution environment is a constrained, purpose-built runtime, not a full general-purpose OS. We will not guarantee compatibility with all system calls, kernel modules, or filesystem operations. | We use security profiles (`seccomp`, `AppArmor`) to limit the attack surface. This inherently restricts some OS features. Our environment is tailored for application code, not system administration. |\n\n### Architecture Decision Record: Foundational Isolation Technology\n\n> **Decision: Use Linux Container Namespaces and cgroups as the Primary Isolation Mechanism (V1)**\n> - **Context**: We require strong isolation between untrusted function codes in a multi-tenant Linux environment. The choice of isolation technology fundamentally impacts security, performance (cold start), and implementation complexity.\n> - **Options Considered**:\n>     1. **Linux Containers (namespaces, cgroups, seccomp)**: The industry-standard approach used by Docker, providing process, filesystem, and network isolation at the kernel level.\n>     2. **MicroVMs (Firecracker)**: Lightweight virtual machines that offer stronger hardware-enforced isolation, pioneered by AWS Lambda.\n>     3. **gVisor (User-space Kernel)**: A sandbox that intercepts application syscalls and implements them in a user-space kernel, providing a different security boundary.\n> - **Decision**: For V1, we will implement isolation using **Linux containers** (via a low-level library like `containerd` or direct `runc` calls), augmented with `seccomp` and `AppArmor` profiles.\n> - **Rationale**:\n>     - **Maturity & Ecosystem**: Containers have a vast ecosystem of tools, images, and knowledge. Debugging and operational tooling are readily available.\n>     - **Cold Start Performance**: Container startup, especially with optimized base images and shared layers, can be extremely fast (tens of milliseconds), which is critical for our cold start goals.\n>     - **Implementation Simplicity**: Managing containers is a well-understood problem. We can leverage existing battle-tested libraries, reducing our initial implementation risk.\n>     - **Sufficient Isolation for V1**: With careful hardening (dropping capabilities, applying strict `seccomp` filters, using read-only root filesystems), containers provide a robust level of isolation suitable for many multi-tenant scenarios.\n> - **Consequences**:\n>     - **Positive**: Faster path to a working V1, easier debugging, better community support.\n>     - **Negative**: The isolation boundary is the Linux kernel, which has a large attack surface compared to a MicroVM. A kernel vulnerability could potentially be exploited to break out of the container.\n>     - **Migration Path**: The design will abstract the isolation layer behind a `ContainerManager` interface, making a future migration to Firecracker or gVisor possible without changing the core runtime logic.\n\nThe following table compares the isolation options in more detail, highlighting why containers were chosen for our initial implementation:\n\n| Option | Pros | Cons | Applicability to Our Goals |\n| :--- | :--- | :--- | :--- |\n| **Linux Containers** | - Extremely fast startup (ms). <br> - Mature, stable tooling (`runc`, `containerd`). <br> - Fine-grained resource control via `cgroups`. <br> - Rich security hardening via `seccomp`, `AppArmor`, capabilities. | - Isolation depends on a shared kernel. Kernel vulnerabilities can lead to container escape. <br> - Requires host kernel configuration (namespaces, `cgroups`). | **CHOSEN**. Best aligns with our **cold start latency (G2)** and **implementation simplicity** goals for V1. Provides sufficient isolation for many use cases. |\n| **MicroVMs (Firecracker)** | - Strong, hardware-enforced isolation (each function gets its own kernel). <br> - Minimal attack surface (specially built kernel). <br> - Excellent security story for hostile multi-tenancy. | - Higher cold start latency (~100-400ms) due to VM boot, though snapshotting helps. <br> - More complex to implement and manage (requires KVM, device emulation). <br> - Higher memory overhead per instance. | A strong candidate for a future V2 focused on maximum security, especially for public cloud offerings. The cold start trade-off is notable. |\n| **gVisor** | - No need for hardware virtualization. <br> - Syscall filtering provides a strong security boundary different from containers. <br> - Good compatibility with many applications. | - Higher performance overhead for syscall-heavy workloads. <br> - Some compatibility gaps with certain syscalls or applications. <br> - Cold start similar to containers. | An interesting middle ground. However, the performance characteristics and maturity were deemed less certain than pure containers for our V1. |\n\n### Common Pitfalls in Scope Definition\n\n⚠️ **Pitfall: Under-Scoping (The \"Just One More Feature\" Trap)**\n*   **Description**: Continuously adding \"small\" features from the Non-Goals list because they seem easy or are requested by early users.\n*   **Why it's Wrong**: It leads to a bloated, complex V1 that never ships. It diverts effort from perfecting the core goals (like cold start optimization) and creates a confusing product identity.\n*   **How to Avoid**: Be militant about the Non-Goals list. New features must be explicitly justified against the core goals. Create a \"Future Extensions\" backlog for ideas that don't fit V1.\n\n⚠️ **Pitfall: Over-Scoping (The \"All-or-Nothing\" Isolation Fallacy)**\n*   **Description**: Believing that because containers don't offer perfect, theoretical isolation, they are unacceptable, and therefore we must start with the most secure option (MicroVMs), regardless of complexity.\n*   **Why it's Wrong**: It ignores pragmatic trade-offs. The risk profile of many multi-tenant environments (e.g., internal company platforms, trusted communities) is well-managed by hardened containers. Starting with MicroVMs could delay the project by months and make cold start optimization much harder.\n*   **How to Avoid**: Conduct a realistic threat model for your target users. Choose the simplest isolation technology that mitigates the actual identified threats. Plan for iterative improvement.\n\n⚠️ **Pitfall: Vague Success Criteria**\n*   **Description**: Defining goals with ambiguous terms like \"fast,\" \"scalable,\" or \"reliable\" without quantifiable metrics.\n*   **Why it's Wrong**: It makes it impossible to objectively determine if the project is successful. It leads to debates and moving goalposts.\n*   **How to Avoid**: Every goal must have a **measurable** success criterion, as shown in the Goals table. \"Sub-second cold start (P95)\" is measurable. \"Fast cold start\" is not.\n\n### Implementation Guidance\n\nWhile this section is primarily conceptual, establishing clear goals and non-goals has direct implications for our code structure and testing strategy from the very beginning.\n\n#### A. Technology Recommendations Table\n\n| Component | Simple Option (V1) | Advanced Option (Future) | Rationale for V1 Choice |\n| :--- | :--- | :--- | :--- |\n| **Isolation Layer** | `containerd` Go client (or direct `runc`) | Firecracker Go SDK (`firecracker-go-sdk`) | `containerd` is the industry-standard container runtime, providing a stable API and handling low-level details. It's the path of least resistance. |\n| **Resource Limits** | Linux `cgroups` v2 (via `containerd` or `github.com/containerd/cgroups`) | Custom cgroup manager + quota enforcement | Letting `containerd` manage cgroups simplifies setup and ensures compatibility. |\n| **Security Hardening** | Default `seccomp` profile (Docker's) + dropped capabilities + read-only rootfs | Custom AppArmor profiles, SELinux policies | Starting with well-known, conservative defaults is safe. Custom policies can be added later based on need. |\n| **Metrics & Observability** | Prometheus client library (`github.com/prometheus/client_golang`) + structured logging (`logrus`/`zap`) | OpenTelemetry SDK for distributed tracing | Prometheus is the de facto standard for metrics. Structured logs are essential for debugging. |\n\n#### B. Recommended File/Module Structure\n\nThe goals and non-goals inform a clean separation of concerns from the project's inception. Here is the recommended high-level directory structure:\n\n```\nserverless-runtime/\n├── cmd/\n│   ├── controller/          # Main orchestrator (scaling, instance management)\n│   │   └── main.go\n│   ├── gateway/             # HTTP gateway (request routing)\n│   │   └── main.go\n│   └── cli/                 # Command-line tool for deploying functions\n│       └── main.go\n├── internal/                # Private application code\n│   ├── api/                 # Internal APIs and data types\n│   │   ├── types.go         # Core types: FunctionDefinition, InvocationRequest, etc.\n│   │   └── storage.go       # Storage backend interface\n│   ├── builder/             # **Milestone 1**: Function packaging & dependency bundling\n│   │   ├── go_bundler.go\n│   │   ├── python_bundler.go\n│   │   └── node_bundler.go\n│   ├── container/           # **Milestone 2 & 3**: Isolation & cold start optimization\n│   │   ├── manager.go       # ContainerManager interface\n│   │   ├── cgroup_utils.go  # Helper for cgroups\n│   │   ├── warm_pool.go     # WarmPoolManager\n│   │   └── criu_helper.go   # Snapshot/restore logic (if implemented)\n│   ├── gateway/             # **Milestone 4**: Request routing\n│   │   ├── router.go        HTTP routing logic\n│   │   ├── queue.go         # Request queue implementation\n│   │   └── loadbalancer.go  # Instance selection logic\n│   ├── scaler/              # **Milestone 5**: Auto-scaling\n│   │   ├── metrics.go       # Collects RPS, concurrency\n│   │   └── decision.go      # Scaling algorithm\n│   └── store/               # Storage implementations\n│       ├── s3_store.go      # S3 backend for function artifacts\n│       └── local_store.go   # Local disk backend for development\n├── pkg/                     # Public, reusable libraries (if any)\n│   └── function_spec/       # Public definition of func.yaml format\n├── go.mod\n└── README.md\n```\n\n#### C. Core Logic Skeleton: Goal Validation Metric\n\nTo embody the principle of measurable goals, we can create a simple metric collection point from day one. This code doesn't implement the logic but sets up the scaffolding for tracking our key success metric: cold start latency.\n\n```go\n// internal/api/metrics.go\npackage api\n\nimport (\n\t\"time\"\n\t\"github.com/prometheus/client_golang/prometheus\"\n\t\"github.com/prometheus/client_golang/prometheus/promauto\"\n)\n\n// Metrics is a centralized struct holding all Prometheus metrics for the runtime.\n// This ensures we track the data needed to validate our Goals (G2, G4, G7, G8).\ntype Metrics struct {\n\t// ColdStartLatency tracks the duration from when a request is received\n\t// for a function with no warm instance to when the function code begins execution.\n\t// This is our KEY metric for Goal G2.\n\tColdStartLatency prometheus.Histogram\n\n\t// InvocationDuration tracks total function execution time.\n\tInvocationDuration prometheus.Histogram\n\n\t// ActiveInvocations is a gauge of currently running functions.\n\tActiveInvocations prometheus.Gauge\n\n\t// InvocationErrors counts failures by type (timeout, OOM, crash).\n\tInvocationErrors *prometheus.CounterVec\n\n\t// FunctionInvocations counts total invocations per function.\n\tFunctionInvocations *prometheus.CounterVec\n}\n\n// NewMetrics creates and registers all metrics. Call this once at startup.\nfunc NewMetrics() *Metrics {\n\treturn &Metrics{\n\t\tColdStartLatency: promauto.NewHistogram(prometheus.HistogramOpts{\n\t\t\tName:    \"function_cold_start_latency_seconds\",\n\t\t\tHelp:    \"Time from cold invocation request to code execution start.\",\n\t\t\tBuckets: prometheus.DefBuckets, // Default buckets are good for sub-second latencies\n\t\t}),\n\t\tInvocationDuration: promauto.NewHistogram(prometheus.HistogramOpts{\n\t\t\tName:    \"function_invocation_duration_seconds\",\n\t\t\tHelp:    \"Total duration of function execution.\",\n\t\t\tBuckets: prometheus.DefBuckets,\n\t\t}),\n\t\tActiveInvocations: promauto.NewGauge(prometheus.GaugeOpts{\n\t\t\tName: \"function_active_invocations\",\n\t\t\tHelp: \"Current number of concurrently executing function invocations.\",\n\t\t}),\n\t\tInvocationErrors: promauto.NewCounterVec(prometheus.CounterOpts{\n\t\t\tName: \"function_invocation_errors_total\",\n\t\t\tHelp: \"Total number of failed function invocations by error type.\",\n\t\t}, []string{\"function\", \"error_type\"}), // error_type: \"timeout\", \"oom\", \"crash\", \"system\"\n\t\tFunctionInvocations: promauto.NewCounterVec(prometheus.CounterOpts{\n\t\t\tName: \"function_invocations_total\",\n\t\t\tHelp: \"Total number of function invocations.\",\n\t\t}, []string{\"function\"}),\n\t}\n}\n\n// RecordColdStart should be called when a cold start is completed.\n// `startTime` should be the time the request was first routed (before acquiring an instance).\nfunc (m *Metrics) RecordColdStart(startTime time.Time) {\n\tduration := time.Since(startTime).Seconds()\n\tm.ColdStartLatency.Observe(duration)\n}\n\n// RecordInvocation should be called when a function invocation finishes.\nfunc (m *Metrics) RecordInvocation(functionName string, startTime time.Time, err error) {\n\tduration := time.Since(startTime).Seconds()\n\tm.InvocationDuration.Observe(duration)\n\tm.FunctionInvocations.WithLabelValues(functionName).Inc()\n\tm.ActiveInvocations.Dec() // Assuming we .Inc() when starting an invocation\n\n\tif err != nil {\n\t\t// TODO: Classify the error type (timeout, OOM, etc.)\n\t\terrorType := classifyError(err)\n\t\tm.InvocationErrors.WithLabelValues(functionName, errorType).Inc()\n\t}\n}\n\n// classifyError is a helper to categorize errors for metrics.\n// This is a simplistic example; real implementation would be more robust.\nfunc classifyError(err error) string {\n\t// TODO: Implement error type classification based on your runtime's error types.\n\t// Example: check for context.DeadlineExceeded, or OOM messages from the container.\n\treturn \"unknown\"\n}\n```\n\n#### D. Language-Specific Hints (Go)\n\n*   **Prometheus Integration**: Use the official `prometheus/client_golang` library. The `promauto` package is convenient for automatically registering metrics.\n*   **Time Measurement**: Use `time.Now()` or `time.Since()` for latency measurements. For high precision, consider `time.Now().UnixNano()`.\n*   **Concurrency with Gauges**: Be careful to call `metrics.ActiveInvocations.Inc()` and `.Dec()` in a thread-safe manner, ideally within a synchronized request handler.\n\n#### E. Milestone Checkpoint: Goal Validation\n\nAfter implementing the initial scaffolding (even before full routing), you should be able to validate that your metrics infrastructure is working.\n\n1.  **Command**: Start your controller or gateway with the metrics code integrated. The Prometheus client will expose a `/metrics` HTTP endpoint by default on the same port as your application (if you use `promhttp.Handler()`).\n2.  **Expected Output**: Run `curl http://localhost:<port>/metrics`. You should see the raw Prometheus metrics, including the histograms and counters defined above (their values will be zero initially).\n3.  **Sign of Success**: The metric names appear correctly in the output. If you see `function_cold_start_latency_seconds` listed, your instrumentation is correctly registered.\n4.  **Troubleshooting**: If metrics are missing, ensure you've called `NewMetrics()` and that the metrics variables are not garbage collected (they should be in a long-lived struct). Also verify the Prometheus handler is registered with your HTTP server: `http.Handle(\"/metrics\", promhttp.Handler())`.\n\n---\n\n\n## High-Level Architecture\n\n> **Milestone(s):** This foundational section establishes the architectural blueprint that all subsequent milestones (1-5) will implement. It defines the major system components, their responsibilities, and how they interact to solve the core challenge of balancing isolation, speed, and efficient scaling.\n\n### Component Overview and Responsibilities\n\n**Mental Model: The Instant Kitchen Factory**\n\nImagine you're running a gourmet meal delivery service that needs to prepare thousands of unique dishes on demand. Each dish (function) requires specific ingredients (code + dependencies) and cooking equipment (runtime). You face three key challenges:\n\n1. **Speed**: Customers want their meals in seconds, not hours\n2. **Isolation**: You can't let the garlic from one dish contaminate the dessert\n3. **Efficiency**: You can't keep every possible kitchen setup running 24/7 when demand fluctuates\n\nYour solution is an \"Instant Kitchen Factory\" with these specialized departments:\n\n- **The Order Desk (Gateway)**: Where customers place orders, get queued if all kitchens are busy, and receive their finished meals\n- **The Control Room (Controller)**: The brain that tracks which kitchens are available, creates new ones when needed, and shuts down idle ones\n- **The Kitchen Stations (Worker Pool)**: Individual, isolated kitchens where meals are actually prepared, each with its own equipment and ingredients\n- **The Warehouse (Storage)**: Where recipe books (function code), pre-measured ingredient kits (dependencies), and cooking equipment (runtime images) are stored\n\nThis factory can instantly deploy a fully-equipped kitchen for any recipe, clean it up when done, and keep a few popular kitchens \"warm\" and ready to go. Now let's translate this mental model to our technical architecture.\n\n![System Component Overview](./diagrams/sys-component-diagram.svg)\n\nThe system comprises four core components that work together to provide serverless function execution. Each component is designed for specific responsibilities while maintaining clear boundaries and well-defined interfaces.\n\n#### HTTP Gateway: The Public Entry Point\n\nThe Gateway serves as the single entry point for all function invocations, handling request routing, load balancing, and traffic management. Think of it as the restaurant host who greets customers, checks reservations (function names), and seats them at available tables (function instances).\n\n| Responsibility | Description |\n|----------------|-------------|\n| Request Reception | Accepts HTTP requests on a public endpoint (e.g., `POST /invoke/{functionName}`) with function input as request body |\n| Request Validation | Validates incoming requests against function specifications (timeout limits, payload size) before forwarding |\n| Function Resolution | Maps URL paths or headers to specific function names and versions (e.g., `/api/users/create` → `createUser:v1.2`) |\n| Load Balancing | Distributes requests across available function instances using configurable strategies (round-robin, least connections) |\n| Request Queuing | Maintains per-function queues when all instances are busy, applying backpressure and fairness policies |\n| Synchronous/Async Mode | Supports immediate response (synchronous) and fire-and-forget (asynchronous) invocation patterns |\n| Response Aggregation | Collects function output (or error) and returns appropriate HTTP status codes and headers to the caller |\n| Request Timeout Enforcement | Terminates requests that exceed configured timeouts, returning appropriate error responses |\n\nThe Gateway maintains minimal state—primarily request queues and circuit breakers—and delegates instance management to the Controller. It communicates with the Controller via gRPC or HTTP for instance assignment.\n\n#### Controller: The Orchestration Brain\n\nThe Controller is the central coordination point that manages function lifecycle, scaling decisions, and system state. Imagine it as the air traffic control tower that monitors all aircraft (function instances), decides when to launch new ones, and directs them to landing spots (request assignments).\n\n| Responsibility | Description |\n|----------------|-------------|\n| Function Deployment | Processes function uploads, coordinates packaging with Storage, and registers new function versions |\n| Instance Lifecycle Management | Creates, monitors, and destroys function instances (`FunctionInstance` objects) throughout their lifecycle |\n| Warm Pool Management | Maintains pre-initialized instances ready for immediate execution, applying eviction and refresh policies |\n| Auto-Scaling Decisions | Analyzes metrics (requests/second, concurrent executions) to scale instances up or down per function |\n| Health Monitoring | Periodically checks instance health via heartbeat mechanisms and replaces unhealthy instances |\n| System Metrics Collection | Aggregates performance data (cold starts, execution times, errors) for observability and scaling decisions |\n| Configuration Management | Stores and applies function-specific configurations (timeouts, memory limits, environment variables) |\n| Instance Assignment | Provides available instances to the Gateway upon request, considering load distribution and locality |\n\nThe Controller maintains the authoritative view of system state, including all function definitions, active instances, and scaling policies. It uses the `ContainerManager` interface to manage execution environments and interacts with Storage for artifact retrieval.\n\n#### Worker Pool: The Execution Fabric\n\nThe Worker Pool represents the actual compute resources where functions execute—a collection of isolated environments (containers or microVMs) running on physical or virtual hosts. Think of each worker as a self-contained kitchen with its own stove, sink, and pantry, completely isolated from other kitchens.\n\n| Responsibility | Description |\n|----------------|-------------|\n| Isolation Enforcement | Provides secure multi-tenant isolation using containers, namespaces, cgroups, and security profiles |\n| Resource Management | Enforces CPU, memory, disk, and network limits for each function instance |\n| Function Execution | Loads function code into the isolated environment and executes the handler with provided input |\n| Runtime Lifecycle | Manages runtime-specific initialization (Python interpreter, JVM, Go binary) before function execution |\n| Local Caching | Caches frequently used function artifacts and runtime layers to reduce startup latency |\n| Metrics Reporting | Reports per-instance resource usage (CPU%, memory MB) and execution metrics to Controller |\n| Cleanup | Ensures complete cleanup of execution environments after function completion or timeout |\n\nThe Worker Pool isn't a centralized service but a distributed capability—each host runs a worker agent that communicates with the Controller. Multiple workers can run on a single host for density, but each function instance runs in its own isolated environment.\n\n#### Storage: The Durable Backbone\n\nStorage provides durable, scalable persistence for function artifacts, system state, and operational data. Imagine it as the warehouse + filing cabinet that stores everything from recipe books (code) to order records (invocation logs).\n\n| Responsibility | Description |\n|----------------|-------------|\n| Function Artifact Storage | Stores packaged function code with dependencies, supporting versioning and immutability |\n| Runtime Image Repository | Stores base runtime images (Python, Node.js, Go) and common dependency layers |\n| System State Persistence | Optionally persists function definitions, scaling policies, and instance assignments (for fault tolerance) |\n| Log Aggregation | Collects and stores function execution logs for debugging and audit purposes |\n| Metrics Archival | Stores historical metrics for trend analysis and capacity planning |\n| Snapshot Storage | Stores container snapshots for fast restoration (if using CRIU checkpoint/restore) |\n\nStorage is designed as a pluggable backend, supporting cloud object storage (AWS S3, Google Cloud Storage), container registries (Docker Hub, AWS ECR), and local filesystems for development.\n\n**Component Interaction Patterns:**\n\nThe components follow a clear hierarchy and communication pattern:\n\n1. **North-South Traffic (User Requests)**: \n   ```\n   User → HTTP Gateway → Controller → Worker Pool → Function Execution\n   ```\n\n2. **East-West Traffic (Control Plane)**:\n   ```\n   Controller ↔ Storage (for artifacts)\n   Controller ↔ Worker Pool (for lifecycle management)\n   Gateway ↔ Controller (for instance assignment)\n   ```\n\n3. **Data Flow**:\n   - Control signals flow from Controller to Workers\n   - Metrics flow from Workers to Controller\n   - Artifacts flow from Storage to Workers\n   - Requests flow from Gateway to Workers (via Controller assignment)\n\n> **Design Insight:** We deliberately separate the data plane (Gateway → Worker) from the control plane (Controller ↔ Worker). This allows the Gateway to communicate directly with Workers for low-latency request/response while the Controller manages orchestration without being in the hot path.\n\n### Recommended File and Module Structure\n\nA well-organized codebase is critical for maintaining a complex system like this. Following Go conventions and separation of concerns, we recommend this project structure:\n\n**Mental Model: The Office Building**\n\nThink of the project structure as a well-organized office building:\n\n- **`/cmd`**: The reception desks and main entrances (executable programs)\n- **`/internal`**: The specialized departments with restricted access (private implementation)\n- **`/pkg`**: The public-facing services anyone can visit (reusable libraries)\n- **`/api`**: The building blueprints and interface specifications (contracts)\n- **`/deployments`**: The building maintenance plans and utility hookups (infrastructure)\n\nHere's the complete structure:\n\n```\nserverless-runtime/\n├── cmd/                          # Application entry points\n│   ├── gateway/                  # HTTP Gateway service\n│   │   ├── main.go               # Gateway entry point with CLI flags\n│   │   └── config/               # Gateway-specific configuration\n│   ├── controller/               # Controller service  \n│   │   ├── main.go               # Controller entry point\n│   │   └── config/               # Controller configuration\n│   └── worker/                   # Worker agent (optional separate binary)\n│       └── main.go               # Worker entry point\n├── internal/                     # Private application code\n│   ├── gateway/                  # Gateway implementation\n│   │   ├── gateway.go            # Main Gateway struct and initialization\n│   │   ├── router.go             # HTTP routing and middleware\n│   │   ├── handler/              # HTTP request handlers\n│   │   │   ├── invoke.go         # Function invocation handler\n│   │   │   ├── async.go          # Async invocation handler\n│   │   │   └── health.go         # Health check endpoint\n│   │   ├── queue/                # Request queuing subsystem\n│   │   │   ├── manager.go        # Queue manager interface\n│   │   │   ├── memory_queue.go   # In-memory queue implementation\n│   │   │   └── priority_queue.go # Priority-based queuing\n│   │   ├── balancer/             # Load balancing logic\n│   │   │   ├── balancer.go       # LoadBalancer interface\n│   │   │   ├── round_robin.go    # Round-robin implementation\n│   │   │   └── least_conn.go     # Least-connections implementation\n│   │   └── client/               # Client to talk to Controller\n│   │       └── controller_client.go # gRPC/HTTP client for Controller\n│   ├── controller/               # Controller implementation\n│   │   ├── controller.go         # Main Controller struct and coordination\n│   │   ├── manager/              # Core management subsystems\n│   │   │   ├── function/         # Function lifecycle management\n│   │   │   │   ├── manager.go    # FunctionManager interface\n│   │   │   │   ├── registry.go   # In-memory function registry\n│   │   │   │   └── deployer.go   # Function deployment logic\n│   │   │   ├── instance/         # Instance lifecycle management\n│   │   │   │   ├── manager.go    # InstanceManager interface\n│   │   │   │   ├── lifecycle.go  # State transitions and lifecycle\n│   │   │   │   └── health.go     # Health checking logic\n│   │   │   └── warmpool/         # Warm pool management\n│   │   │       ├── manager.go    # WarmPoolManager interface\n│   │   │       ├── pool.go       # Pool implementation\n│   │   │       └── eviction.go   # Eviction policies (LRU, LFU)\n│   │   ├── scaler/               # Auto-scaling logic\n│   │   │   ├── scaler.go         # Scaler interface\n│   │   │   ├── reactive.go       # Reactive scaling implementation\n│   │   │   ├── metrics/          # Metrics collection for scaling\n│   │   │   │   ├── collector.go  # Metrics collector interface\n│   │   │   │   └── prometheus.go # Prometheus implementation\n│   │   │   └── decision/         # Scaling decision logic\n│   │   │       ├── engine.go     # Decision engine\n│   │   │       └── policies.go   # Scaling policies\n│   │   ├── api/                  # Controller API (gRPC/HTTP)\n│   │   │   ├── server.go         # API server implementation\n│   │   │   ├── service.go        # gRPC service definition\n│   │   │   └── handlers/         # HTTP handlers (if dual protocol)\n│   │   └── storage/              # Controller's storage client\n│   │       └── client.go         # Client to Storage service\n│   ├── worker/                   # Worker implementation\n│   │   ├── runtime/              # Runtime environment management\n│   │   │   ├── manager.go        # RuntimeManager interface\n│   │   │   ├── container/        # Container-based runtime\n│   │   │   │   ├── manager.go    # Container runtime manager\n│   │   │   │   └── executor.go   # Container execution logic\n│   │   │   └── microvm/          # MicroVM-based runtime (optional)\n│   │   │       ├── manager.go    # Firecracker manager\n│   │   │       └── executor.go   # MicroVM execution logic\n│   │   ├── invoker/              # Function invocation\n│   │   │   ├── invoker.go        # Invoker interface\n│   │   │   ├── http_invoker.go   # HTTP-triggered invocation\n│   │   │   └── event_invoker.go  # Event-triggered invocation\n│   │   ├── isolation/            # Isolation setup\n│   │   │   ├── cgroups.go        # cgroups setup and management\n│   │   │   ├── namespaces.go     # Linux namespace setup\n│   │   │   └── security.go       # seccomp/AppArmor profiles\n│   │   └── snapshot/             # Snapshot/restore functionality\n│   │       ├── criu.go           # CRIU integration\n│   │       └── snapshotter.go    # Snapshot manager\n│   ├── packaging/                # Function packaging subsystem\n│   │   ├── bundler/              # Language-specific bundlers\n│   │   │   ├── bundler.go        # Bundler interface\n│   │   │   ├── go_bundler.go     # Go bundler implementation\n│   │   │   ├── python_bundler.go # Python bundler\n│   │   │   └── node_bundler.go   # Node.js bundler\n│   │   ├── registry/             # Function registry and storage\n│   │   │   ├── storage.go        # Storage interface for artifacts\n│   │   │   ├── s3_storage.go     # S3-backed storage\n│   │   │   └── local_storage.go  # Local filesystem storage\n│   │   └── builder/              # Build system integration\n│   │       └── builder.go        # Build orchestration\n│   ├── models/                   # Shared data structures\n│   │   ├── function.go           # FunctionDefinition and related types\n│   │   ├── instance.go           # FunctionInstance and states\n│   │   ├── invocation.go         # InvocationRequest and response types\n│   │   ├── container.go          # Container and ContainerStatus\n│   │   └── metrics.go            # Metrics data structures\n│   └── util/                     # Shared utilities\n│       ├── logging/              # Structured logging\n│       ├── config/               # Configuration parsing\n│       ├── retry/                # Retry utilities\n│       └── telemetry/            # Tracing and telemetry\n├── pkg/                          # Public reusable packages\n│   ├── container/                # Container management abstraction\n│   │   ├── manager.go            # ContainerManager interface\n│   │   ├── types.go              # Container, CreateContainerRequest, etc.\n│   │   └── docker/               # Docker implementation\n│   │       ├── docker_manager.go # DockerManager implementation\n│   │       └── client.go         # Docker client wrapper\n│   └── metrics/                  # Metrics collection utilities\n│       ├── metrics.go            # Metrics struct and factory\n│       └── prometheus.go         # Prometheus implementation\n├── api/                          # API definitions and contracts\n│   ├── v1/                       # Version 1 API\n│   │   ├── gateway/              # Gateway API definitions\n│   │   │   ├── gateway.proto     # gRPC service definition\n│   │   │   └── openapi.yaml     # OpenAPI/Swagger spec\n│   │   ├── controller/           # Controller API definitions\n│   │   │   └── controller.proto # Controller gRPC service\n│   │   └── models/               # Shared message types\n│   │       └── models.proto      # Common protobuf messages\n│   └── buf.yaml                  # buf.build configuration\n├── deployments/                  # Deployment configurations\n│   ├── docker/                   # Docker-related files\n│   │   ├── Dockerfile.gateway    # Gateway Dockerfile\n│   │   ├── Dockerfile.controller # Controller Dockerfile\n│   │   └── docker-compose.yml    # Local development setup\n│   └── kubernetes/               # Kubernetes manifests\n│       ├── namespace.yaml        # K8s namespace\n│       ├── gateway/              # Gateway deployment\n│       ├── controller/           # Controller deployment\n│       └── worker/               # Worker DaemonSet\n├── scripts/                      # Build and development scripts\n│   ├── build.sh                  # Build script\n│   ├── test.sh                   # Test script\n│   └── deploy/                   # Deployment scripts\n├── configs/                      # Configuration files\n│   ├── gateway.yaml.example      # Gateway config example\n│   ├── controller.yaml.example   # Controller config example\n│   └── worker.yaml.example       # Worker config example\n├── tests/                        # Integration and e2e tests\n│   ├── integration/              # Integration tests\n│   └── e2e/                      # End-to-end tests\n├── docs/                         # Documentation\n│   ├── architecture/             # Architecture diagrams and docs\n│   └── api/                      # API documentation\n├── go.mod                        # Go module definition\n├── go.sum                        # Go dependencies checksum\n├── Makefile                      # Common tasks automation\n└── README.md                     # Project overview\n```\n\n**Key Organizational Principles:**\n\n1. **Clear Separation of Concerns**: Each component lives in its own directory with well-defined interfaces between them.\n\n2. **Dependency Direction**: \n   - Higher-level components (`gateway`, `controller`) depend on abstractions in `pkg/`\n   - Lower-level implementations (`docker`, `s3_storage`) implement those abstractions\n   - Dependencies flow inward: `cmd/` → `internal/` → `pkg/`\n\n3. **Test Organization**: Unit tests live alongside the code they test (e.g., `gateway_test.go` next to `gateway.go`), while integration and end-to-end tests are separate.\n\n4. **Configuration Management**: Each service has its own configuration structure, with examples provided and environment-specific overrides.\n\n5. **API-First Design**: Protobuf/OpenAPI definitions are the source of truth for external APIs, enabling code generation for multiple languages.\n\n> **Design Insight:** This structure supports incremental development across milestones. You can implement the `packaging/` directory for Milestone 1, `worker/runtime/` for Milestone 2, `worker/snapshot/` for Milestone 3, `gateway/queue/` for Milestone 4, and `controller/scaler/` for Milestone 5—each in isolation while maintaining clear interfaces.\n\n### Implementation Guidance\n\n#### A. Technology Recommendations Table\n\n| Component | Simple Option (for learning/getting started) | Advanced Option (production-ready) |\n|-----------|---------------------------------------------|-----------------------------------|\n| **Gateway Transport** | HTTP/1.1 with Go's `net/http` | HTTP/2 with gRPC-gateway for dual REST/gRPC |\n| **Controller-Worker Communication** | HTTP REST with JSON | gRPC streaming for real-time control |\n| **Storage Backend** | Local filesystem with directory structure | S3-compatible object storage with versioning |\n| **Container Runtime** | Docker Engine via Docker SDK | containerd with CRI plugin for lower overhead |\n| **Metrics** | Prometheus client library with in-memory aggregation | OpenTelemetry with Jaeger/Datadog export |\n| **Service Discovery** | Static configuration in YAML | Consul or etcd for dynamic registration |\n| **Queue Implementation** | In-memory Go channels with buffering | Redis Streams or Apache Kafka for persistence |\n\n#### B. Core Infrastructure Starter Code\n\nSince the high-level architecture establishes the foundation, here's complete starter code for the shared models and interfaces that all components will use:\n\n**File: `internal/models/function.go`**\n```go\npackage models\n\nimport (\n    \"time\"\n)\n\n// FunctionDefinition represents a deployable function with its configuration\ntype FunctionDefinition struct {\n    // Unique identifier for the function (e.g., \"user-auth\")\n    Name string `json:\"name\" yaml:\"name\"`\n    \n    // Runtime environment (e.g., \"go1.19\", \"python3.9\", \"nodejs18\")\n    Runtime string `json:\"runtime\" yaml:\"runtime\"`\n    \n    // Handler entry point (e.g., \"main.Handler\", \"index.handler\")\n    Handler string `json:\"handler\" yaml:\"handler\"`\n    \n    // Path to the function code in storage\n    CodePath string `json:\"codePath\" yaml:\"codePath\"`\n    \n    // Maximum execution time in seconds\n    Timeout int `json:\"timeout\" yaml:\"timeout\"`\n    \n    // Memory limit in megabytes\n    MemoryMB int `json:\"memoryMB\" yaml:\"memoryMB\"`\n    \n    // CPU quota as percentage of a single core (100 = full core)\n    CPUQuota int64 `json:\"cpuQuota\" yaml:\"cpuQuota\"`\n    \n    // Environment variables to inject\n    EnvVars map[string]string `json:\"envVars\" yaml:\"envVars\"`\n    \n    // Language-specific dependencies\n    Dependencies []string `json:\"dependencies\" yaml:\"dependencies\"`\n    \n    // Metadata\n    Version    string    `json:\"version\" yaml:\"version\"`\n    CreatedAt  time.Time `json:\"createdAt\" yaml:\"createdAt\"`\n    UpdatedAt  time.Time `json:\"updatedAt\" yaml:\"updatedAt\"`\n}\n\n// FunctionInstance represents a running instance of a function\ntype FunctionInstance struct {\n    // Unique instance identifier\n    ID string `json:\"id\" yaml:\"id\"`\n    \n    // Function this instance belongs to\n    FunctionName    string `json:\"functionName\" yaml:\"functionName\"`\n    FunctionVersion string `json:\"functionVersion\" yaml:\"functionVersion\"`\n    \n    // Current state (see constants below)\n    State FunctionInstanceState `json:\"state\" yaml:\"state\"`\n    \n    // Underlying container/microVM identifier\n    ContainerID string `json:\"containerId\" yaml:\"containerId\"`\n    \n    // Host where this instance is running\n    Host string `json:\"host\" yaml:\"host\"`\n    \n    // Port for HTTP communication (if applicable)\n    Port int `json:\"port\" yaml:\"port\"`\n    \n    // Resource usage tracking\n    MemoryUsageMB int `json:\"memoryUsageMB\" yaml:\"memoryUsageMB\"`\n    CPUUsage      float64 `json:\"cpuUsage\" yaml:\"cpuUsage\"`\n    \n    // Lifecycle timestamps\n    CreatedAt   time.Time `json:\"createdAt\" yaml:\"createdAt\"`\n    LastUsedAt  time.Time `json:\"lastUsedAt\" yaml:\"lastUsedAt\"`\n    TerminatedAt *time.Time `json:\"terminatedAt,omitempty\" yaml:\"terminatedAt,omitempty\"`\n    \n    // Statistics\n    InvocationCount int `json:\"invocationCount\" yaml:\"invocationCount\"`\n    TotalDurationMS int64 `json:\"totalDurationMS\" yaml:\"totalDurationMS\"`\n}\n\n// FunctionInstanceState represents the lifecycle state of a function instance\ntype FunctionInstanceState string\n\nconst (\n    // InstanceStateProvisioning - Container is being created/started\n    InstanceStateProvisioning FunctionInstanceState = \"PROVISIONING\"\n    \n    // InstanceStateWarm - Container is running and ready for requests\n    InstanceStateWarm FunctionInstanceState = \"WARM\"\n    \n    // InstanceStateActive - Container is currently executing a request\n    InstanceStateActive FunctionInstanceState = \"ACTIVE\"\n    \n    // InstanceStateDraining - Container is finishing current requests, no new requests\n    InstanceStateDraining FunctionInstanceState = \"DRAINING\"\n    \n    // InstanceStateTerminated - Container has been stopped and cleaned up\n    InstanceStateTerminated FunctionInstanceState = \"TERMINATED\"\n    \n    // InstanceStateError - Container is in an error state and needs recovery\n    InstanceStateError FunctionInstanceState = \"ERROR\"\n)\n\n// Validate checks if the FunctionDefinition has required fields\nfunc (fd *FunctionDefinition) Validate() error {\n    // TODO 1: Check that Name is non-empty and follows naming conventions\n    // TODO 2: Validate Runtime is supported (go, python, nodejs, etc.)\n    // TODO 3: Validate Handler format based on runtime\n    // TODO 4: Ensure Timeout is between 1 and maximum allowed (e.g., 900 seconds)\n    // TODO 5: Ensure MemoryMB is within allowed range (e.g., 128MB to 3008MB)\n    // TODO 6: Validate CPUQuota is positive and within limits\n    return nil\n}\n\n// IsActive returns true if the instance can accept new requests\nfunc (fi *FunctionInstance) IsActive() bool {\n    return fi.State == InstanceStateWarm || fi.State == InstanceStateActive\n}\n\n// Age returns how long the instance has been running\nfunc (fi *FunctionInstance) Age() time.Duration {\n    return time.Since(fi.CreatedAt)\n}\n\n// IdleDuration returns how long the instance has been idle\nfunc (fi *FunctionInstance) IdleDuration() time.Duration {\n    return time.Since(fi.LastUsedAt)\n}\n```\n\n**File: `internal/models/invocation.go`**\n```go\npackage models\n\nimport (\n    \"time\"\n)\n\n// InvocationRequest represents a request to execute a function\ntype InvocationRequest struct {\n    // Unique identifier for this invocation\n    ID string `json:\"id\" yaml:\"id\"`\n    \n    // Function to invoke\n    FunctionName    string `json:\"functionName\" yaml:\"functionName\"`\n    FunctionVersion string `json:\"functionVersion\" yaml:\"functionVersion\"`\n    \n    // Input payload (JSON, binary, etc.)\n    Payload []byte `json:\"payload\" yaml:\"payload\"`\n    \n    // Synchronous (wait for response) vs asynchronous (fire and forget)\n    Synchronous bool `json:\"synchronous\" yaml:\"synchronous\"`\n    \n    // When this request must be completed by\n    Deadline time.Time `json:\"deadline\" yaml:\"deadline\"`\n    \n    // Metadata\n    RequestID string    `json:\"requestId\" yaml:\"requestId\"` // External request ID\n    Source    string    `json:\"source\" yaml:\"source\"`       // Source of invocation (HTTP, event, etc.)\n    CreatedAt time.Time `json:\"createdAt\" yaml:\"createdAt\"`\n    \n    // Routing hints (optional)\n    PreferredInstanceID string `json:\"preferredInstanceId,omitempty\" yaml:\"preferredInstanceId,omitempty\"`\n    \n    // Callback URL for async invocations\n    CallbackURL string `json:\"callbackUrl,omitempty\" yaml:\"callbackUrl,omitempty\"`\n}\n\n// InvocationResponse represents the result of a function execution\ntype InvocationResponse struct {\n    // Corresponding request ID\n    RequestID string `json:\"requestId\" yaml:\"requestId\"`\n    \n    // Function output\n    Payload []byte `json:\"payload\" yaml:\"payload\"`\n    \n    // Execution metadata\n    DurationMS   int64     `json:\"durationMS\" yaml:\"durationMS\"`\n    MemoryUsedMB int       `json:\"memoryUsedMB\" yaml:\"memoryUsedMB\"`\n    BilledDurationMS int64 `json:\"billedDurationMS\" yaml:\"billedDurationMS\"`\n    \n    // Error information (if any)\n    Error     string `json:\"error,omitempty\" yaml:\"error,omitempty\"`\n    ErrorType string `json:\"errorType,omitempty\" yaml:\"errorType,omitempty\"` // Runtime, Timeout, etc.\n    \n    // Instance that executed this\n    InstanceID string `json:\"instanceId\" yaml:\"instanceId\"`\n    \n    // Timestamps\n    StartedAt  time.Time `json:\"startedAt\" yaml:\"startedAt\"`\n    FinishedAt time.Time `json:\"finishedAt\" yaml:\"finishedAt\"`\n}\n\n// InvocationStatus represents the status of an asynchronous invocation\ntype InvocationStatus struct {\n    RequestID   string               `json:\"requestId\" yaml:\"requestId\"`\n    Status      InvocationStatusType `json:\"status\" yaml:\"status\"`\n    Result      *InvocationResponse  `json:\"result,omitempty\" yaml:\"result,omitempty\"`\n    LastUpdated time.Time            `json:\"lastUpdated\" yaml:\"lastUpdated\"`\n}\n\ntype InvocationStatusType string\n\nconst (\n    InvocationStatusPending   InvocationStatusType = \"PENDING\"\n    InvocationStatusRunning   InvocationStatusType = \"RUNNING\"\n    InvocationStatusCompleted InvocationStatusType = \"COMPLETED\"\n    InvocationStatusFailed    InvocationStatusType = \"FAILED\"\n    InvocationStatusTimeout   InvocationStatusType = \"TIMEOUT\"\n)\n\n// IsExpired returns true if the request has passed its deadline\nfunc (ir *InvocationRequest) IsExpired() bool {\n    return time.Now().After(ir.Deadline)\n}\n\n// TimeRemaining returns how much time is left before the deadline\nfunc (ir *InvocationRequest) TimeRemaining() time.Duration {\n    return ir.Deadline.Sub(time.Now())\n}\n```\n\n**File: `pkg/container/manager.go`**\n```go\npackage container\n\nimport (\n    \"context\"\n    \"io\"\n    \"time\"\n)\n\n// ContainerManager defines the interface for managing isolated execution environments\ntype ContainerManager interface {\n    // CreateContainer creates a new container with the specified configuration\n    CreateContainer(ctx context.Context, req CreateContainerRequest) (*Container, error)\n    \n    // StartContainer begins execution of the container\n    StartContainer(ctx context.Context, containerID string) error\n    \n    // ExecuteInContainer runs a command inside a running container\n    ExecuteInContainer(ctx context.Context, containerID string, cmd []string, input io.Reader, output io.Writer) (int, error)\n    \n    // StopContainer gracefully stops a running container\n    StopContainer(ctx context.Context, containerID string, timeout time.Duration) error\n    \n    // RemoveContainer cleans up container resources\n    RemoveContainer(ctx context.Context, containerID string) error\n    \n    // GetContainerStats returns resource usage statistics\n    GetContainerStats(ctx context.Context, containerID string) (*ContainerStats, error)\n    \n    // ListContainers returns all managed containers\n    ListContainers(ctx context.Context, filter ListFilter) ([]Container, error)\n    \n    // HealthCheck verifies the container manager is operational\n    HealthCheck(ctx context.Context) error\n}\n\n// CreateContainerRequest contains all parameters needed to create a container\ntype CreateContainerRequest struct {\n    // Container image name and tag\n    Image string `json:\"image\" yaml:\"image\"`\n    \n    // Command to run (overrides image's CMD)\n    Cmd []string `json:\"cmd\" yaml:\"cmd\"`\n    \n    // Environment variables\n    Env []string `json:\"env\" yaml:\"env\"`\n    \n    // Labels for metadata\n    Labels map[string]string `json:\"labels\" yaml:\"labels\"`\n    \n    // CPU quota (percentage of a single core, 100 = full core)\n    CPUQuota int64 `json:\"cpuQuota\" yaml:\"cpuQuota\"`\n    \n    // Memory limit in bytes\n    MemoryLimit int64 `json:\"memoryLimit\" yaml:\"memoryLimit\"`\n    \n    // Network mode (bridge, host, none)\n    NetworkMode string `json:\"networkMode\" yaml:\"networkMode\"`\n    \n    // Volume bindings (host:container:mode)\n    Binds []string `json:\"binds\" yaml:\"binds\"`\n    \n    // Working directory inside container\n    WorkingDir string `json:\"workingDir\" yaml:\"workingDir\"`\n    \n    // User to run as (uid:gid)\n    User string `json:\"user\" yaml:\"user\"`\n    \n    // Security options (seccomp, AppArmor)\n    SecurityOpts []string `json:\"securityOpts\" yaml:\"securityOpts\"`\n    \n    // Exposed ports\n    ExposedPorts map[string]struct{} `json:\"exposedPorts\" yaml:\"exposedPorts\"`\n    \n    // Port bindings\n    PortBindings map[string][]PortBinding `json:\"portBindings\" yaml:\"portBindings\"`\n}\n\n// Container represents a container instance\ntype Container struct {\n    // Unique identifier\n    ID string `json:\"id\" yaml:\"id\"`\n    \n    // Container image\n    Image string `json:\"image\" yaml:\"image\"`\n    \n    // Current status\n    Status ContainerStatus `json:\"status\" yaml:\"status\"`\n    \n    // Creation timestamp\n    CreatedAt time.Time `json:\"createdAt\" yaml:\"createdAt\"`\n    \n    // Labels for metadata\n    Labels map[string]string `json:\"labels\" yaml:\"labels\"`\n    \n    // Additional metadata\n    Names []string `json:\"names\" yaml:\"names\"`\n    Ports []Port   `json:\"ports\" yaml:\"ports\"`\n}\n\n// ContainerStatus represents the lifecycle state of a container\ntype ContainerStatus string\n\nconst (\n    StatusCreated    ContainerStatus = \"created\"\n    StatusRunning    ContainerStatus = \"running\"\n    StatusPaused     ContainerStatus = \"paused\"\n    StatusRestarting ContainerStatus = \"restarting\"\n    StatusExited     ContainerStatus = \"exited\"\n    StatusDead       ContainerStatus = \"dead\"\n)\n\n// ContainerStats contains resource usage statistics\ntype ContainerStats struct {\n    CPUPercent    float64   `json:\"cpuPercent\" yaml:\"cpuPercent\"`\n    MemoryUsage   int64     `json:\"memoryUsage\" yaml:\"memoryUsage\"`\n    MemoryLimit   int64     `json:\"memoryLimit\" yaml:\"memoryLimit\"`\n    MemoryPercent float64   `json:\"memoryPercent\" yaml:\"memoryPercent\"`\n    NetworkRx     int64     `json:\"networkRx\" yaml:\"networkRx\"`\n    NetworkTx     int64     `json:\"networkTx\" yaml:\"networkTx\"`\n    BlockRead     int64     `json:\"blockRead\" yaml:\"blockRead\"`\n    BlockWrite    int64     `json:\"blockWrite\" yaml:\"blockWrite\"`\n    PIDs          int       `json:\"pids\" yaml:\"pids\"`\n    ReadAt        time.Time `json:\"readAt\" yaml:\"readAt\"`\n}\n\n// ListFilter allows filtering containers by criteria\ntype ListFilter struct {\n    Labels map[string]string `json:\"labels\" yaml:\"labels\"`\n    Status []ContainerStatus `json:\"status\" yaml:\"status\"`\n}\n\n// Port represents a network port mapping\ntype Port struct {\n    IP          string `json:\"ip\" yaml:\"ip\"`\n    PrivatePort uint16 `json:\"privatePort\" yaml:\"privatePort\"`\n    PublicPort  uint16 `json:\"publicPort\" yaml:\"publicPort\"`\n    Type        string `json:\"type\" yaml:\"type\"`\n}\n\n// PortBinding represents a port binding configuration\ntype PortBinding struct {\n    HostIP   string `json:\"hostIp\" yaml:\"hostIp\"`\n    HostPort string `json:\"hostPort\" yaml:\"hostPort\"`\n}\n```\n\n**File: `pkg/metrics/metrics.go`**\n```go\npackage metrics\n\nimport (\n    \"time\"\n    \n    \"github.com/prometheus/client_golang/prometheus\"\n)\n\n// Metrics encapsulates all Prometheus metrics for the runtime\ntype Metrics struct {\n    // Cold start latency histogram (seconds)\n    ColdStartLatency prometheus.Histogram\n    \n    // Function invocation duration histogram (seconds)\n    InvocationDuration prometheus.Histogram\n    \n    // Currently active invocations gauge\n    ActiveInvocations prometheus.Gauge\n    \n    // Invocation errors counter (by error type)\n    InvocationErrors *prometheus.CounterVec\n    \n    // Function invocations counter (by function name)\n    FunctionInvocations *prometheus.CounterVec\n    \n    // Container operations counter\n    ContainerOperations *prometheus.CounterVec\n    \n    // Resource usage gauges\n    MemoryUsageMB     *prometheus.GaugeVec\n    CPUUsagePercent   *prometheus.GaugeVec\n    ContainerCount    *prometheus.GaugeVec\n}\n\n// NewMetrics creates and registers all Prometheus metrics for the runtime\nfunc NewMetrics() *Metrics {\n    m := &Metrics{\n        ColdStartLatency: prometheus.NewHistogram(\n            prometheus.HistogramOpts{\n                Name:    \"function_cold_start_latency_seconds\",\n                Help:    \"Time taken for cold start initialization\",\n                Buckets: prometheus.ExponentialBuckets(0.1, 2, 10), // 100ms to ~51.2s\n            },\n        ),\n        \n        InvocationDuration: prometheus.NewHistogram(\n            prometheus.HistogramOpts{\n                Name:    \"function_invocation_duration_seconds\",\n                Help:    \"Time taken for function execution\",\n                Buckets: prometheus.ExponentialBuckets(0.01, 2, 12), // 10ms to ~20.48s\n            },\n        ),\n        \n        ActiveInvocations: prometheus.NewGauge(\n            prometheus.GaugeOpts{\n                Name: \"active_invocations_total\",\n                Help: \"Number of currently executing function invocations\",\n            },\n        ),\n        \n        InvocationErrors: prometheus.NewCounterVec(\n            prometheus.CounterOpts{\n                Name: \"invocation_errors_total\",\n                Help: \"Total number of invocation errors by type\",\n            },\n            []string{\"function\", \"error_type\"},\n        ),\n        \n        FunctionInvocations: prometheus.NewCounterVec(\n            prometheus.CounterOpts{\n                Name: \"function_invocations_total\",\n                Help: \"Total number of function invocations\",\n            },\n            []string{\"function\", \"runtime\", \"status\"},\n        ),\n        \n        ContainerOperations: prometheus.NewCounterVec(\n            prometheus.CounterOpts{\n                Name: \"container_operations_total\",\n                Help: \"Total number of container operations\",\n            },\n            []string{\"operation\", \"status\"},\n        ),\n        \n        MemoryUsageMB: prometheus.NewGaugeVec(\n            prometheus.GaugeOpts{\n                Name: \"container_memory_usage_mb\",\n                Help: \"Memory usage of containers in MB\",\n            },\n            []string{\"function\", \"instance_id\"},\n        ),\n        \n        CPUUsagePercent: prometheus.NewGaugeVec(\n            prometheus.GaugeOpts{\n                Name: \"container_cpu_usage_percent\",\n                Help: \"CPU usage of containers as percentage\",\n            },\n            []string{\"function\", \"instance_id\"},\n        ),\n        \n        ContainerCount: prometheus.NewGaugeVec(\n            prometheus.GaugeOpts{\n                Name: \"container_count_total\",\n                Help: \"Number of containers by state\",\n            },\n            []string{\"function\", \"state\"},\n        ),\n    }\n    \n    // Register all metrics\n    prometheus.MustRegister(\n        m.ColdStartLatency,\n        m.InvocationDuration,\n        m.ActiveInvocations,\n        m.InvocationErrors,\n        m.FunctionInvocations,\n        m.ContainerOperations,\n        m.MemoryUsageMB,\n        m.CPUUsagePercent,\n        m.ContainerCount,\n    )\n    \n    return m\n}\n\n// RecordColdStart records the duration of a cold start invocation\nfunc (m *Metrics) RecordColdStart(startTime time.Time) {\n    duration := time.Since(startTime).Seconds()\n    m.ColdStartLatency.Observe(duration)\n}\n\n// RecordInvocation records the completion of a function invocation\nfunc (m *Metrics) RecordInvocation(functionName string, startTime time.Time, err error) {\n    duration := time.Since(startTime).Seconds()\n    m.InvocationDuration.Observe(duration)\n    \n    // Update counters based on success/error\n    status := \"success\"\n    if err != nil {\n        status = \"error\"\n        m.InvocationErrors.WithLabelValues(functionName, \"execution_error\").Inc()\n    }\n    \n    m.FunctionInvocations.WithLabelValues(functionName, \"\", status).Inc()\n}\n```\n\n#### C. Entry Point Skeleton Code\n\n**File: `cmd/controller/main.go`**\n```go\npackage main\n\nimport (\n    \"context\"\n    \"log\"\n    \"net/http\"\n    \"os\"\n    \"os/signal\"\n    \"syscall\"\n    \"time\"\n    \n    \"github.com/yourorg/serverless-runtime/internal/controller\"\n    \"github.com/yourorg/serverless-runtime/pkg/metrics\"\n    \"github.com/prometheus/client_golang/prometheus/promhttp\"\n)\n\nfunc main() {\n    // TODO 1: Load configuration from file and environment variables\n    // TODO 2: Initialize structured logger with appropriate level\n    \n    // Create metrics instance\n    metrics := metrics.NewMetrics()\n    \n    // Initialize controller\n    // TODO 3: Create ContainerManager implementation (DockerManager)\n    // TODO 4: Create Storage client\n    // TODO 5: Create FunctionManager, InstanceManager, WarmPoolManager\n    // TODO 6: Create Scaler with appropriate strategy\n    // TODO 7: Initialize Controller with all dependencies\n    \n    ctrl, err := controller.NewController(controller.Config{\n        // TODO 8: Populate configuration\n    })\n    if err != nil {\n        log.Fatalf(\"Failed to create controller: %v\", err)\n    }\n    \n    // Start controller\n    ctx, cancel := context.WithCancel(context.Background())\n    defer cancel()\n    \n    // Start metrics server\n    go func() {\n        http.Handle(\"/metrics\", promhttp.Handler())\n        http.HandleFunc(\"/health\", func(w http.ResponseWriter, r *http.Request) {\n            // TODO 9: Implement health check that verifies all subsystems\n            w.WriteHeader(http.StatusOK)\n        })\n        \n        log.Println(\"Starting metrics server on :9090\")\n        if err := http.ListenAndServe(\":9090\", nil); err != nil {\n            log.Printf(\"Metrics server error: %v\", err)\n        }\n    }()\n    \n    // Start gRPC/HTTP API server\n    // TODO 10: Start API server for Gateway communication\n    \n    // Start scaling decision loop\n    // TODO 11: Start periodic scaling evaluation in goroutine\n    \n    // Start warm pool maintenance\n    // TODO 12: Start periodic warm pool cleanup and refresh\n    \n    log.Println(\"Controller started successfully\")\n    \n    // Wait for shutdown signal\n    sigChan := make(chan os.Signal, 1)\n    signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)\n    \n    <-sigChan\n    log.Println(\"Shutdown signal received\")\n    \n    // Graceful shutdown\n    shutdownCtx, shutdownCancel := context.WithTimeout(context.Background(), 30*time.Second)\n    defer shutdownCancel()\n    \n    // TODO 13: Implement graceful shutdown - stop accepting new requests,\n    //          drain existing requests, clean up resources\n    if err := ctrl.Shutdown(shutdownCtx); err != nil {\n        log.Printf(\"Error during shutdown: %v\", err)\n    }\n    \n    log.Println(\"Controller shutdown complete\")\n}\n```\n\n#### D. Language-Specific Hints for Go\n\n1. **Concurrency**: Use `sync.WaitGroup` for coordinating goroutine completion and `errgroup` for error propagation in concurrent operations.\n\n2. **Context Propagation**: Always pass `context.Context` through function calls to enable cancellation and timeouts across the entire call chain.\n\n3. **Error Handling**: Use `fmt.Errorf` with `%w` for wrapping errors and implement custom error types for specific error categories (e.g., `ErrFunctionNotFound`, `ErrInstanceBusy`).\n\n4. **Configuration**: Consider using `viper` for configuration management with support for multiple formats (YAML, JSON, env vars) and `validator` for struct validation.\n\n5. **HTTP Client Pooling**: Reuse HTTP clients with appropriate timeouts:\n   ```go\n   httpClient := &http.Client{\n       Timeout: 30 * time.Second,\n       Transport: &http.Transport{\n           MaxIdleConns:        100,\n           MaxIdleConnsPerHost: 10,\n           IdleConnTimeout:     90 * time.Second,\n       },\n   }\n   ```\n\n6. **Graceful Shutdown Pattern**: Implement graceful shutdown using contexts and wait for in-flight operations to complete before exiting.\n\n7. **Structured Logging**: Use `slog` (Go 1.21+) or `logrus`/`zap` for structured logging with fields for correlation IDs and request tracing.\n\n8. **Metrics Collection**: Use the Prometheus client library and expose metrics on a separate port (typically `:9090`) for scraping by monitoring systems.\n\n9. **Interface-Based Design**: Define clear interfaces between components to enable testing and alternative implementations (e.g., different `ContainerManager` implementations).\n\n10. **Dependency Injection**: Use constructor-based dependency injection to make components testable and configurable.\n\n#### E. Milestone Checkpoint for Architecture Foundation\n\nAfter setting up the basic structure:\n\n1. **Verify Project Structure**:\n   ```\n   $ tree -L 3 serverless-runtime/\n   # Should show the directory structure as outlined above\n   ```\n\n2. **Build the Project**:\n   ```\n   $ cd serverless-runtime\n   $ go mod init github.com/yourorg/serverless-runtime\n   $ go mod tidy\n   $ go build ./cmd/controller\n   $ go build ./cmd/gateway\n   ```\n\n3. **Run Basic Tests**:\n   ```\n   $ go test ./internal/models/... -v\n   # Should pass model validation tests\n   ```\n\n4. **Check Dependencies**:\n   ```\n   $ go list -m all | grep -E \"(prometheus|docker|grpc)\"\n   # Should show required dependencies\n   ```\n\n5. **Expected Signs of Correct Setup**:\n   - All Go files compile without errors\n   - Models package can be imported by other packages\n   - Prometheus metrics can be registered without panic\n   - Basic `FunctionDefinition` validation logic works\n\n6. **Common Early Issues**:\n   - **Symptom**: \"Cannot find package\" errors\n     - **Fix**: Ensure `go.mod` is in the root directory and run `go mod tidy`\n   - **Symptom**: Circular import dependencies\n     - **Fix**: Re-evaluate package structure - higher-level packages should not import lower-level implementation packages\n   - **Symptom**: Interface implementation errors\n     - **Fix**: Ensure all interface methods are implemented with exact signatures\n\nThis architectural foundation sets the stage for implementing each milestone systematically. The clear separation of concerns allows you to work on packaging (Milestone 1), execution (Milestone 2), optimization (Milestone 3), routing (Milestone 4), and scaling (Milestone 5) in parallel or sequence with well-defined interfaces between components.\n\n\n## Data Model\n> **Milestone(s):** This section establishes the fundamental data structures that all subsequent milestones (1-5) will use to represent functions, their execution environments, and invocation requests. It provides the \"vocabulary\" for the entire system.\n\nA serverless runtime's data model serves as the system's shared language—it defines what a function *is*, how an invocation *is represented*, and what state an execution environment *can be in*. Without a precise data model, components would pass ambiguous messages, leading to race conditions, resource leaks, and incorrect behavior. Think of this as the **blueprint and vocabulary** that every component (gateway, controller, worker pool) must agree upon to collaborate effectively.\n\nThis section defines the core entities and their relationships. First, we'll establish the key data structures through detailed tables, then formalize the lifecycle states that function instances transition through during their existence.\n\n### Core Types and Structures\n\nThe system revolves around three primary entities: **Function Definitions** (the code and configuration), **Function Instances** (running environments executing that code), and **Invocation Requests** (individual calls to execute the function). Their relationships can be visualized as:\n\n![Core Data Relationships](./diagrams/data-model-diagram.svg)\n\nA single `FunctionDefinition` can have many `FunctionInstance`s running simultaneously (for scaling). Each `FunctionInstance` processes one `InvocationRequest` at a time (though it may process multiple sequentially). An `InvocationRequest` targets a specific `FunctionDefinition` but may be routed to any available `FunctionInstance` for that function.\n\n#### FunctionDefinition: The Blueprint\n\nThink of a `FunctionDefinition` as a **recipe card** for your function. It contains all the instructions needed to create an execution environment: what code to run, which runtime to use, how much memory to allocate, and what environment variables to set. This is an immutable specification—once created, it represents a specific version of your function code and configuration.\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `Name` | `string` | Unique identifier for the function (e.g., \"image-processor\"). Used in API paths and logging. |\n| `Runtime` | `string` | Execution environment language and version (e.g., \"python3.9\", \"go1.19\", \"nodejs18\"). Determines which base container image to use. |\n| `Handler` | `string` | Entry point within the code package. Format varies by runtime: Python uses \"module.function\", Go uses compiled binary name, Node.js uses \"module.export\". |\n| `CodePath` | `string` | Storage location URI for the packaged function artifact (e.g., \"s3://bucket/functions/image-processor-v1.zip\"). References the actual code bytes. |\n| `Timeout` | `int` | Maximum execution duration in seconds before the function is forcibly terminated. Critical for preventing runaway executions. |\n| `MemoryMB` | `int` | Memory allocation in megabytes. This determines both the container's memory limit and billing granularity in production systems. |\n| `CPUQuota` | `int64` | CPU allocation as a percentage of a single core (100 = 1 core, 200 = 2 cores). Used to set cgroup CPU quotas for fair sharing. |\n| `EnvVars` | `map[string]string` | Key-value pairs injected as environment variables into the execution environment. Used for configuration like API keys or feature flags. |\n| `Dependencies` | `[]string` | List of dependency package names/versions (language-specific). For Python: `[\"requests==2.28.0\", \"pillow>=9.0\"]`. For Go: empty (dependencies compiled in). |\n\n> **Key Insight:** The `FunctionDefinition` is **immutable** once stored. When you update a function, you create a new `FunctionDefinition` with a new version identifier, leaving previous versions intact for rollback and audit purposes.\n\n#### FunctionInstance: The Running Process\n\nA `FunctionInstance` represents an **actual, running execution environment**—a container or microVM that has been instantiated from a `FunctionDefinition`. Think of it as a **kitchen that has been set up according to a recipe card**. It has its own resources, lifecycle, and current state.\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `ID` | `string` | Unique identifier for this specific instance (UUID). Used for routing, logging, and management. |\n| `FunctionName` | `string` | References the `FunctionDefinition.Name` this instance was created from. |\n| `FunctionVersion` | `string` | References the specific version of the function (e.g., \"v1.2.3\"). Together with `FunctionName`, fully identifies the blueprint. |\n| `State` | `FunctionInstanceState` | Current lifecycle state (see next subsection). Determines whether the instance can accept new requests. |\n| `ContainerID` | `string` | Reference to the underlying container or microVM (e.g., Docker container ID, Firecracker VM ID). |\n| `Host` | `string` | IP address or hostname where the instance is running. Used by the gateway to route HTTP requests. |\n| `Port` | `int` | TCP port where the instance's HTTP server is listening. Combined with `Host` forms the endpoint. |\n| `MemoryUsageMB` | `int` | Current memory usage in megabytes. Updated periodically from container stats for monitoring and scaling decisions. |\n| `CPUUsage` | `float64` | Current CPU usage as percentage of allocated quota. Also from container stats. |\n| `CreatedAt` | `time.Time` | When the instance was first created. Used to calculate age for cleanup of stale instances. |\n| `LastUsedAt` | `time.Time` | When the instance last processed a request. Critical for determining idle time and scale-down decisions. |\n| `TerminatedAt` | `*time.Time` | When the instance was terminated (nil if still running). Used for cleanup and accounting. |\n| `InvocationCount` | `int` | Number of requests this instance has processed. Helps identify \"hot\" instances for sticky routing or debugging. |\n| `TotalDurationMS` | `int64` | Cumulative milliseconds spent executing requests. Used for performance analysis and cost estimation. |\n\n> **Design Rationale:** Separating the blueprint (`FunctionDefinition`) from the running instance (`FunctionInstance`) allows multiple instances of the same function to run concurrently (for scaling) while sharing the same immutable specification. The instance tracks runtime-specific details like resource usage and lifecycle state.\n\n#### InvocationRequest: The Work Item\n\nAn `InvocationRequest` represents a **single call to execute a function**. Think of it as a **customer order ticket** that arrives at the restaurant—it specifies what function to run, provides input data, and includes metadata about how to handle the request (deadlines, callbacks, etc.).\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `ID` | `string` | Unique identifier for this invocation (UUID). Used for idempotency, tracing, and result lookup. |\n| `FunctionName` | `string` | Name of the function to invoke. The gateway uses this to route to the appropriate function pool. |\n| `FunctionVersion` | `string` | Optional version constraint (e.g., \"latest\", \"v1.2\"). If empty, defaults to the latest active version. |\n| `Payload` | `[]byte` | Raw request body (e.g., JSON, binary data) passed to the function as input. |\n| `Synchronous` | `bool` | Whether the caller waits for a response (true) or the request is queued for async execution (false). |\n| `Deadline` | `time.Time` | Absolute time by which the function must complete. Used for timeout enforcement and queue priority. |\n| `RequestID` | `string` | Client-provided identifier for correlation (often passed through in headers). Distinct from system `ID`. |\n| `Source` | `string` | Event source that triggered the invocation (e.g., \"api-gateway\", \"s3:bucket-created\", \"cron:nightly\"). |\n| `CreatedAt` | `time.Time` | When the request arrived at the system. Used for queue latency metrics. |\n| `PreferredInstanceID` | `string` | Optional hint for sticky routing—if provided, the gateway tries to route to this specific instance. |\n| `CallbackURL` | `string` | For async invocations, URL to POST the result to when complete. Empty for synchronous requests. |\n\n> **Key Insight:** The `InvocationRequest` captures both the **data** (`Payload`) and **metadata** (`Deadline`, `CallbackURL`) about an execution. This separation allows the system to handle scheduling, routing, and lifecycle management independently of the actual function logic.\n\n#### Supporting Data Structures\n\nSeveral supporting types enable detailed management and observability:\n\n**Container and ContainerManager Types**\nThese types abstract over the underlying container runtime (Docker, containerd, Firecracker):\n\n| Type/Field | Description |\n|------------|-------------|\n| `Container` | Represents a managed container/microVM with its ID, image, status, labels, and network ports. |\n| `CreateContainerRequest` | Configuration for creating a new isolated environment—image, command, environment variables, resource limits, security options, and port bindings. |\n| `ContainerStats` | Resource usage metrics sampled from a running container: CPU %, memory usage/limit, network I/O, block I/O, and process count. |\n| `ContainerManager` | Interface defining operations for managing isolated environments: create, start, stop, remove, execute commands, and collect stats. |\n| `ListFilter` | Criteria for listing containers (by labels, status). Used to find function instances by function name/version. |\n\n**Invocation Tracking Types**\nThese types track the progress and outcome of function executions:\n\n| Type/Field | Description |\n|------------|-------------|\n| `InvocationResponse` | Result returned from a function execution: output payload, duration, memory used, any error, and which instance processed it. |\n| `InvocationStatus` | Tracks the state of an asynchronous invocation: pending, running, completed, failed, or timed out, with pointer to the result when available. |\n\n**Metrics Type**\nThe `Metrics` struct aggregates all Prometheus metrics for observability: cold start latency histograms, invocation duration histograms, active invocation gauges, error counters categorized by function and error type, container operation counters, and resource usage gauges per instance.\n\n### Lifecycle State Definitions\n\nA `FunctionInstance` transitions through a well-defined set of states during its lifetime. Understanding these states is critical for proper request routing, scaling decisions, and resource cleanup. The state transitions can be visualized as:\n\n![Function Instance Lifecycle](./diagrams/instance-state-machine.svg)\n\n#### FunctionInstanceState Constants\n\nEach state represents a specific phase in the instance's existence:\n\n| Constant | Description |\n|----------|-------------|\n| `InstanceStateProvisioning` | The container is being created and started. The runtime environment is being prepared but is not yet ready to accept requests. This is the initial state after `CreateContainer`. |\n| `InstanceStateWarm` | The container is running, the function runtime (e.g., Python interpreter, JVM) is initialized, dependencies are loaded, and the instance is **ready to immediately accept requests**. This is the state for instances in the warm pool. |\n| `InstanceStateActive` | The instance is currently executing a request. No new requests should be routed to it until it completes. This state ensures per-instance concurrency limits are enforced. |\n| `InstanceStateDraining` | The instance is finishing its current request(s) but will not accept new ones. Used during scale-down or before termination to gracefully handle in-flight requests. |\n| `InstanceStateTerminated` | The container has been stopped and all resources cleaned up. This is a terminal state—the instance record may be kept for auditing but is no longer active. |\n| `InstanceStateError` | The container has crashed, failed health checks, or entered an unrecoverable state. The system should replace it with a new instance and log the error for debugging. |\n\n#### State Transition Logic\n\nThe following table defines the events that trigger state changes and the actions the system must take during each transition:\n\n| Current State | Event | Next State | Action Taken |\n|---------------|-------|------------|--------------|\n| `Provisioning` | Container started successfully, runtime initialized | `Warm` | Add instance to warm pool; make it available for routing |\n| `Provisioning` | Container startup failed (timeout, OOM, image pull error) | `Error` | Log error; notify controller to possibly retry creation |\n| `Warm` | Request assigned to instance | `Active` | Mark instance as busy; start execution timeout timer |\n| `Active` | Request completed (success or error) | `Warm` | Update `LastUsedAt`; return to warm pool if healthy |\n| `Active` | Request timed out or instance crashed | `Error` | Force stop container; log failure; remove from pools |\n| `Warm` | Scale-down signal received (instance selected for termination) | `Draining` | Remove from warm pool; allow current request to finish but don't assign new ones |\n| `Warm` | Health check failed | `Error` | Mark unhealthy; schedule replacement instance |\n| `Draining` | Current request completed (if any) | `Terminated` | Call `StopContainer` and `RemoveContainer`; clean up resources |\n| `Draining` | Draining timeout exceeded (requests taking too long) | `Error` | Force terminate container; log warning about stuck requests |\n| Any state except `Terminated` | System shutdown or forced termination | `Terminated` | Immediately stop container; skip graceful draining |\n\n> **Critical Design Principle:** State transitions must be **atomic and thread-safe**. Multiple components (gateway assigning requests, health checker, scaler) may concurrently attempt to modify an instance's state. Use a state machine with proper locking or compare-and-swap operations to prevent race conditions.\n\n#### Container Status Mapping\n\nThe `FunctionInstanceState` is a higher-level abstraction than the underlying `ContainerStatus`. While they correlate, they serve different purposes:\n- `ContainerStatus` (e.g., `StatusRunning`, `StatusExited`) reflects the raw container runtime state\n- `FunctionInstanceState` reflects the business logic state of the instance within our serverless system\n\nThe typical mapping is:\n- `ContainerStatus` = `StatusCreated` → `FunctionInstanceState` = `Provisioning`\n- `ContainerStatus` = `StatusRunning` → `FunctionInstanceState` = `Warm` or `Active`\n- `ContainerStatus` = `StatusExited` → `FunctionInstanceState` = `Terminated` or `Error`\n\n> **Key Insight:** The `FunctionInstanceState` adds semantic meaning beyond the container's raw status. An instance in `Warm` state has a `StatusRunning` container, but not all `StatusRunning` containers are necessarily in `Warm` state—they could be in `Active` or `Draining`. This additional layer of abstraction allows the system to implement higher-level behaviors like warm pooling and graceful shutdown.\n\n### Implementation Guidance\n\n> **Technology Note:** The data model is primarily implemented through Go structs with JSON tags for serialization. We'll use the `time.Time` type for timestamps (which serializes to RFC3339 format in JSON) and pointers for optional fields (like `TerminatedAt`).\n\n#### Recommended File Structure\n\nOrganize the data model types logically by domain:\n\n```\nproject-root/\n├── internal/\n│   ├── types/\n│   │   ├── function.go          # FunctionDefinition, FunctionInstance, FunctionInstanceState\n│   │   ├── invocation.go        # InvocationRequest, InvocationResponse, InvocationStatus\n│   │   ├── container.go         # Container, CreateContainerRequest, ContainerStats, ListFilter\n│   │   ├── metrics.go           # Metrics struct and constructor\n│   │   └── constants.go         # All constants (InstanceState*, ContainerStatus*, etc.)\n│   ├── container/\n│   │   └── manager.go           # ContainerManager interface and implementations\n│   └── api/\n│       └── models.go            # Request/Response structs for HTTP API (if different)\n└── pkg/\n    └── timeutil/                # Optional: time utilities for deadline calculations\n```\n\n#### Core Data Structure Implementation\n\nHere's starter code for the key data structures with proper JSON serialization:\n\n```go\n// internal/types/function.go\npackage types\n\nimport (\n\t\"time\"\n)\n\n// FunctionDefinition represents the immutable blueprint for a function\ntype FunctionDefinition struct {\n\tName         string            `json:\"name\"`\n\tRuntime      string            `json:\"runtime\"`\n\tHandler      string            `json:\"handler\"`\n\tCodePath     string            `json:\"codePath\"`\n\tTimeout      int               `json:\"timeout\"`      // seconds\n\tMemoryMB     int               `json:\"memoryMB\"`\n\tCPUQuota     int64             `json:\"cpuQuota\"`     // percentage of a core (100 = 1 core)\n\tEnvVars      map[string]string `json:\"envVars\"`\n\tDependencies []string          `json:\"dependencies\"`\n}\n\n// Validate checks if the FunctionDefinition has required fields\nfunc (fd *FunctionDefinition) Validate() error {\n\t// TODO 1: Check that Name is non-empty and matches allowed pattern (e.g., no spaces)\n\t// TODO 2: Verify Runtime is supported (e.g., \"python3.9\", \"go1.19\", \"nodejs18\")\n\t// TODO 3: Ensure Handler is non-empty\n\t// TODO 4: Validate Timeout is between 1 and maximum allowed (e.g., 900 seconds)\n\t// TODO 5: Validate MemoryMB is between minimum (e.g., 128) and maximum allowed\n\t// TODO 6: Verify CPUQuota is positive and within limits\n\t// TODO 7: Check CodePath is a valid URI format\n\treturn nil\n}\n\n// FunctionInstanceState represents the lifecycle state of a FunctionInstance\ntype FunctionInstanceState string\n\nconst (\n\tInstanceStateProvisioning FunctionInstanceState = \"PROVISIONING\"\n\tInstanceStateWarm         FunctionInstanceState = \"WARM\"\n\tInstanceStateActive       FunctionInstanceState = \"ACTIVE\"\n\tInstanceStateDraining     FunctionInstanceState = \"DRAINING\"\n\tInstanceStateTerminated   FunctionInstanceState = \"TERMINATED\"\n\tInstanceStateError        FunctionInstanceState = \"ERROR\"\n)\n\n// FunctionInstance represents a running instance of a function\ntype FunctionInstance struct {\n\tID               string               `json:\"id\"`\n\tFunctionName     string               `json:\"functionName\"`\n\tFunctionVersion  string               `json:\"functionVersion\"`\n\tState            FunctionInstanceState `json:\"state\"`\n\tContainerID      string               `json:\"containerId\"`\n\tHost             string               `json:\"host\"`\n\tPort             int                  `json:\"port\"`\n\tMemoryUsageMB    int                  `json:\"memoryUsageMB\"`\n\tCPUUsage         float64              `json:\"cpuUsage\"`\n\tCreatedAt        time.Time            `json:\"createdAt\"`\n\tLastUsedAt       time.Time            `json:\"lastUsedAt\"`\n\tTerminatedAt     *time.Time           `json:\"terminatedAt,omitempty\"` // Pointer for optional field\n\tInvocationCount  int                  `json:\"invocationCount\"`\n\tTotalDurationMS  int64                `json:\"totalDurationMs\"`\n}\n\n// IsActive returns true if the instance can accept new requests\nfunc (fi *FunctionInstance) IsActive() bool {\n\t// TODO 1: Return true only if State is InstanceStateWarm\n\t// TODO 2: Consider also checking that ContainerID is not empty\n\t// TODO 3: Consider adding a health check timestamp to avoid routing to stale instances\n\treturn false\n}\n\n// Age returns how long the instance has been running\nfunc (fi *FunctionInstance) Age() time.Duration {\n\t// TODO 1: If TerminatedAt is set, return TerminatedAt.Sub(CreatedAt)\n\t// TODO 2: Otherwise, return time.Since(CreatedAt)\n\treturn 0\n}\n\n// IdleDuration returns how long the instance has been idle\nfunc (fi *FunctionInstance) IdleDuration() time.Duration {\n\t// TODO 1: Return time.Since(LastUsedAt)\n\t// TODO 2: Handle edge case where LastUsedAt is zero time (never used)\n\treturn 0\n}\n```\n\n```go\n// internal/types/invocation.go\npackage types\n\nimport (\n\t\"time\"\n)\n\n// InvocationRequest represents a single function execution request\ntype InvocationRequest struct {\n\tID                  string    `json:\"id\"`\n\tFunctionName        string    `json:\"functionName\"`\n\tFunctionVersion     string    `json:\"functionVersion,omitempty\"`\n\tPayload             []byte    `json:\"payload\"`\n\tSynchronous         bool      `json:\"synchronous\"`\n\tDeadline            time.Time `json:\"deadline\"`\n\tRequestID           string    `json:\"requestId,omitempty\"`\n\tSource              string    `json:\"source,omitempty\"`\n\tCreatedAt           time.Time `json:\"createdAt\"`\n\tPreferredInstanceID string    `json:\"preferredInstanceId,omitempty\"`\n\tCallbackURL         string    `json:\"callbackUrl,omitempty\"`\n}\n\n// IsExpired returns true if the request has passed its deadline\nfunc (ir *InvocationRequest) IsExpired() bool {\n\t// TODO 1: Return true if time.Now().After(Deadline)\n\t// TODO 2: Consider adding a small grace period (e.g., 100ms) for clock skew\n\treturn false\n}\n\n// TimeRemaining returns how much time is left before the deadline\nfunc (ir *InvocationRequest) TimeRemaining() time.Duration {\n\t// TODO 1: Return Deadline.Sub(time.Now())\n\t// TODO 2: Clamp to minimum of 0 (no negative durations)\n\treturn 0\n}\n\n// InvocationStatusType represents the state of an asynchronous invocation\ntype InvocationStatusType string\n\nconst (\n\tInvocationStatusPending   InvocationStatusType = \"PENDING\"\n\tInvocationStatusRunning   InvocationStatusType = \"RUNNING\"\n\tInvocationStatusCompleted InvocationStatusType = \"COMPLETED\"\n\tInvocationStatusFailed    InvocationStatusType = \"FAILED\"\n\tInvocationStatusTimeout   InvocationStatusType = \"TIMEOUT\"\n)\n\n// InvocationStatus tracks the progress of an asynchronous invocation\ntype InvocationStatus struct {\n\tRequestID    string                `json:\"requestId\"`\n\tStatus       InvocationStatusType  `json:\"status\"`\n\tResult       *InvocationResponse   `json:\"result,omitempty\"`\n\tLastUpdated  time.Time             `json:\"lastUpdated\"`\n}\n\n// InvocationResponse contains the result of a function execution\ntype InvocationResponse struct {\n\tRequestID      string    `json:\"requestId\"`\n\tPayload        []byte    `json:\"payload,omitempty\"`\n\tDurationMS     int64     `json:\"durationMs\"`\n\tMemoryUsedMB   int       `json:\"memoryUsedMb\"`\n\tBilledDurationMS int64   `json:\"billedDurationMs\"` // Rounded up to nearest billing increment\n\tError          string    `json:\"error,omitempty\"`\n\tErrorType      string    `json:\"errorType,omitempty\"` // e.g., \"UserError\", \"RuntimeError\"\n\tInstanceID     string    `json:\"instanceId\"`\n\tStartedAt      time.Time `json:\"startedAt\"`\n\tFinishedAt     time.Time `json:\"finishedAt\"`\n}\n```\n\n```go\n// internal/types/constants.go\npackage types\n\n// ContainerStatus represents the state of a container in the container runtime\ntype ContainerStatus string\n\nconst (\n\tStatusCreated    ContainerStatus = \"created\"\n\tStatusRunning    ContainerStatus = \"running\"\n\tStatusPaused     ContainerStatus = \"paused\"\n\tStatusRestarting ContainerStatus = \"restarting\"\n\tStatusExited     ContainerStatus = \"exited\"\n\tStatusDead       ContainerStatus = \"dead\"\n)\n```\n\n#### Data Model Validation Helper\n\nAdd a simple validation utility to ensure data integrity:\n\n```go\n// internal/types/validation.go\npackage types\n\nimport (\n\t\"errors\"\n\t\"net/url\"\n\t\"regexp\"\n)\n\nvar (\n\tErrInvalidFunctionName = errors.New(\"function name must contain only alphanumeric characters and hyphens\")\n\tErrInvalidRuntime      = errors.New(\"unsupported runtime\")\n\tErrInvalidTimeout      = errors.New(\"timeout must be between 1 and 900 seconds\")\n\tErrInvalidMemory       = errors.New(\"memory must be between 128 and 10240 MB\")\n)\n\n// ValidateFunctionDefinition performs comprehensive validation\nfunc ValidateFunctionDefinition(fd *FunctionDefinition) error {\n\t// Name validation\n\tnameRegex := regexp.MustCompile(`^[a-zA-Z0-9\\-]+$`)\n\tif !nameRegex.MatchString(fd.Name) {\n\t\treturn ErrInvalidFunctionName\n\t}\n\n\t// Runtime validation\n\tsupportedRuntimes := map[string]bool{\n\t\t\"python3.9\": true,\n\t\t\"go1.19\":    true,\n\t\t\"nodejs18\":  true,\n\t}\n\tif !supportedRuntimes[fd.Runtime] {\n\t\treturn ErrInvalidRuntime\n\t}\n\n\t// Timeout validation\n\tif fd.Timeout < 1 || fd.Timeout > 900 {\n\t\treturn ErrInvalidTimeout\n\t}\n\n\t// Memory validation\n\tif fd.MemoryMB < 128 || fd.MemoryMB > 10240 {\n\t\treturn ErrInvalidMemory\n\t}\n\n\t// CodePath validation\n\tif _, err := url.Parse(fd.CodePath); err != nil {\n\t\treturn errors.New(\"invalid CodePath URL\")\n\t}\n\n\t// Handler must be non-empty\n\tif fd.Handler == \"\" {\n\t\treturn errors.New(\"handler cannot be empty\")\n\t}\n\n\treturn nil\n}\n```\n\n#### Language-Specific Tips for Go Implementation\n\n1. **Use `time.Time` for timestamps**: It serializes well to JSON (RFC3339) and has rich methods for time calculations.\n2. **Use pointer fields for optional values**: Fields like `TerminatedAt *time.Time` will be omitted from JSON when nil.\n3. **Validate early**: Implement `Validate()` methods and call them before persisting or using data structures.\n4. **Make state transitions atomic**: Use `sync.Mutex` or `sync.RWMutex` in the struct that manages `FunctionInstance` states to prevent race conditions.\n5. **Consider using UUIDs for IDs**: Use `github.com/google/uuid` to generate unique identifiers that are globally unique and not guessable.\n\n#### Milestone Checkpoint: Data Model Validation\n\nAfter implementing the data structures, verify they work correctly:\n\n```bash\n# Run unit tests for the types package\ngo test ./internal/types/... -v\n\n# Expected output should show tests passing for:\n# - FunctionDefinition validation (valid and invalid cases)\n# - FunctionInstance state methods (IsActive, Age, IdleDuration)\n# - InvocationRequest deadline methods (IsExpired, TimeRemaining)\n```\n\nCreate a simple test to verify serialization:\n\n```go\n// internal/types/function_test.go (example test)\nfunc TestFunctionDefinition_JSONRoundTrip(t *testing.T) {\n\tfd := &FunctionDefinition{\n\t\tName:     \"test-function\",\n\t\tRuntime:  \"python3.9\",\n\t\tHandler:  \"handler.main\",\n\t\tCodePath: \"s3://bucket/test-v1.zip\",\n\t\tTimeout:  30,\n\t\tMemoryMB: 256,\n\t\tCPUQuota: 100,\n\t\tEnvVars:  map[string]string{\"KEY\": \"VALUE\"},\n\t}\n\t\n\t// Marshal to JSON\n\tjsonData, err := json.Marshal(fd)\n\tassert.NoError(t, err)\n\t\n\t// Unmarshal back\n\tvar fd2 FunctionDefinition\n\terr = json.Unmarshal(jsonData, &fd2)\n\tassert.NoError(t, err)\n\t\n\t// Should be equal\n\tassert.Equal(t, fd.Name, fd2.Name)\n\tassert.Equal(t, fd.Runtime, fd2.Runtime)\n}\n\n```\n\n\n## Component Design: Function Packaging\n> **Milestone(s):** Milestone 1\n\n### Mental Model: The Shipping Dock and Warehouse\n\nImagine you're managing a massive shipping facility where customers send you boxes of parts and instructions to assemble specialized machines. Each customer's box contains the blueprints (source code), a list of required components (dependencies), and assembly instructions (build configuration). Your job is to:\n\n1. **Receive shipments** at the dock (upload API)\n2. **Inspect and validate** the contents (package validation)\n3. **Assemble complete machines** by gathering all required parts (dependency resolution)\n4. **Test the assembly** to ensure it works (build validation)\n5. **Store finished machines** in labeled warehouse bins with unique serial numbers (content-addressable storage)\n6. **Track revisions** so you can always retrieve the exact same machine later (immutable versioning)\n\nJust as a warehouse worker doesn't need to know how to operate every machine, the runtime doesn't need to understand the function's internal logic—it just needs to retrieve the pre-assembled package and plug it into an execution environment. This separation of concerns allows the packaging subsystem to focus on reliable, reproducible builds while the execution subsystem focuses on fast, secure runtime.\n\nThe critical insight is that **packaging happens once per deployment, but execution happens thousands or millions of times**. Therefore, we invest more computational resources during packaging (thorough dependency resolution, optimization, validation) to make execution as lightweight and predictable as possible.\n\n### Interface and Workflow\n\nThe packaging subsystem exposes two primary interfaces: an external HTTP API for users to upload functions, and internal interfaces for language-specific bundlers to process those functions.\n\n#### External API: Function Upload and Management\n\nUsers interact with the packaging system through a RESTful HTTP API that supports:\n\n| Endpoint | Method | Request Body | Response | Description |\n|----------|--------|--------------|----------|-------------|\n| `/v1/functions` | `POST` | Multipart form with code archive, `function.yaml` | `201 Created` with `{\"function_id\": \"...\", \"version\": \"...\"}` | Upload new function version |\n| `/v1/functions/{name}/versions` | `GET` | None | `200 OK` with list of versions | List all versions of a function |\n| `/v1/functions/{name}/versions/{version}` | `GET` | None | `200 OK` with function metadata | Get specific version details |\n| `/v1/functions/{name}/versions/{version}` | `DELETE` | None | `204 No Content` | Delete specific version (if not in use) |\n\nThe `function.yaml` configuration file follows this schema:\n\n| Field | Type | Required | Description |\n|-------|------|----------|-------------|\n| `name` | string | Yes | Unique function name (slug format: `[a-z0-9-]+`) |\n| `runtime` | string | Yes | One of: `go1.x`, `python3.9`, `nodejs18.x`, `java11` |\n| `handler` | string | Yes | Entry point format varies by runtime:<br>- Go: `package.FunctionName`<br>- Python: `module.function`<br>- Node.js: `module.exportName`<br>- Java: `com.example.Handler::handleRequest` |\n| `timeout` | integer | No | Maximum execution time in seconds (default: 30) |\n| `memory` | integer | No | Memory allocation in MB (default: 128) |\n| `environment` | map[string]string | No | Environment variables injected at runtime |\n| `dependencies` | array of strings | No | Language-specific dependency specifiers |\n\n#### Internal Workflow: From Upload to Stored Artifact\n\nWhen a function upload request arrives, the system executes this 10-step workflow:\n\n1. **Request Validation**: Verify the multipart form contains both `function.yaml` and at least one code file (ZIP, TAR, or single file).\n2. **Configuration Parsing**: Parse `function.yaml` into a `FunctionDefinition` struct, validating all required fields and runtime compatibility.\n3. **Temporary Storage**: Extract uploaded files to a temporary working directory with a unique session ID.\n4. **Language Detection**: Based on the `runtime` field, route to the appropriate language bundler.\n5. **Dependency Resolution**: The language bundler analyzes the code to identify all required dependencies:\n   - For interpreted languages (Python, Node.js): Parse dependency manifests (`requirements.txt`, `package.json`) and resolve transitive dependencies, handling version conflicts.\n   - For compiled languages (Go, Java): Compile the code, capturing all imported packages and libraries.\n6. **Build Process**: Create a complete, self-contained artifact:\n   - **Python**: Create a virtual environment with all dependencies, then package into a ZIP with the function code.\n   - **Node.js**: Run `npm install --production` and bundle into a single directory.\n   - **Go**: Compile to a standalone binary for the target architecture.\n   - **Java**: Compile to a JAR with all dependencies shaded/fat-jarred.\n7. **Artifact Optimization**: Apply optimizations to reduce package size:\n   - Remove development dependencies, documentation, test files.\n   - Compress resources (minify JavaScript, strip debug symbols from binaries).\n   - Deduplicate common dependencies across functions (layer sharing).\n8. **Integrity Check**: Compute SHA-256 hash of the final artifact for content addressing.\n9. **Storage**: Store the artifact in the content-addressable storage backend using the hash as the key.\n10. **Metadata Registration**: Record the function version metadata in the registry, linking the function name and version to the storage hash.\n\n#### Internal Interfaces for Language Bundlers\n\nThe packaging subsystem defines this interface for language-specific implementations:\n\n| Method | Parameters | Returns | Description |\n|--------|------------|---------|-------------|\n| `ResolveDependencies` | `ctx context.Context, workDir string, deps []string` | `([]string, error)` | Analyze code and return complete dependency list |\n| `BuildArtifact` | `ctx context.Context, workDir string, def FunctionDefinition` | `(string, error)` | Build self-contained artifact, return path |\n| `ValidateHandler` | `ctx context.Context, workDir string, def FunctionDefinition` | `error` | Verify handler exists and is callable |\n| `GetBaseImage` | `runtime string` | `string` | Return container image name for this runtime |\n\nEach language runtime (Go, Python, Node.js, Java) provides its own implementation of this interface. The packaging coordinator calls these methods in sequence, handling errors and cleanup between steps.\n\n### ADR: Artifact Storage Strategy\n\n> **Decision: Use Content-Addressable Storage with Registry Index**\n>\n> **Context**: We need to store function artifacts durably and retrieve them efficiently. Artifacts range from small (Go binaries ~5MB) to large (Java applications with dependencies ~100MB+). We must support:\n> - Immutable versioning (once stored, never modified)\n> - Efficient deduplication (identical dependencies across functions)\n> - Fast retrieval by both content hash and function name/version\n> - Scalability to thousands of functions with multiple versions each\n>\n> **Options Considered**:\n>\n> 1. **Object Storage with Hierarchical Keys** (e.g., S3 with `{function}/{version}/artifact.zip`)\n> 2. **Content-Addressable Storage** (e.g., store by SHA-256 hash, maintain separate index)\n> 3. **Container Registry** (e.g., Docker registry, store as OCI images)\n>\n> **Decision**: Use content-addressable storage (option 2) with a separate registry database indexing function names and versions to content hashes.\n>\n> **Rationale**:\n> - **Deduplication**: Identical artifacts (common dependencies, same code) automatically deduplicate because they have the same hash. This saves significant storage for common runtimes and libraries.\n> - **Immutability**: Content addressing guarantees immutability—the hash is the content's fingerprint. Any tampering changes the hash, making detection trivial.\n> - **Cache Efficiency**: CDNs and caching layers can use the hash as a perfect cache key. Two functions with identical dependencies can share cached layers.\n> - **Simplified Garbage Collection**: We can implement reference counting on hashes—delete artifacts only when no function version references them.\n> - **Flexibility**: We can store artifacts in any backing store (S3, filesystem, IPFS) since the abstraction depends only on hash-based retrieval.\n>\n> **Consequences**:\n> - **Added Complexity**: Need a separate registry database to map `(function, version) → hash`. Two-phase writes (store artifact, then update registry).\n> - **Slower Lookup**: To get an artifact by function name, we must first query the registry for the hash, then fetch by hash (two operations).\n> - **No Native Versioning**: The storage layer doesn't understand semantic versioning—that's managed by the registry.\n\n| Option | Pros | Cons | Why Not Chosen |\n|--------|------|------|----------------|\n| Object Storage with Hierarchical Keys | Simple, direct mapping, S3 versioning available | No automatic deduplication, harder cache optimization, mutable without proper discipline | Lacks automatic deduplication which is critical for common dependencies like AWS SDK |\n| **Content-Addressable Storage** | **Automatic deduplication, immutable by design, cache-friendly, storage-agnostic** | **Requires separate index, two-step retrieval** | **Chosen for deduplication and immutability benefits** |\n| Container Registry (OCI) | Standard format, tooling ecosystem, layer sharing | Heavyweight for simple functions, complex to implement, overkill for non-container execution | Too complex for our needs; we're not running containers directly but might use them as base images |\n\n### Common Pitfalls in Function Packaging\n\n⚠️ **Pitfall: Dependency Hell and Version Conflicts**\n\n**Description**: When function A requires `library-v1.2` and function B requires `library-v2.0`, but they share a common base environment, one function will break. Transitive dependencies compound this—`library-v1.2` might require `dep-alpha-v3.0` while `library-v2.0` requires `dep-alpha-v4.0`, which are incompatible.\n\n**Why It's Wrong**: This causes non-deterministic behavior. A function that works during packaging might fail at runtime if a different function's deployment changes the shared environment. It violates the principle of isolation between functions.\n\n**How to Fix**: \n- Use **per-function virtual environments** (Python), `node_modules` isolation (Node.js), or shaded JARs (Java).\n- For compiled languages (Go), statically link dependencies into the binary.\n- Never share mutable dependency directories between functions.\n- Implement **dependency conflict detection** during packaging—fail the build if incompatible transitive dependencies are detected.\n\n⚠️ **Pitfall: Bloated Packages from Development Artifacts**\n\n**Description**: Including `node_modules` with dev dependencies, Python virtual environments with `.pyc` files, Java JARs with source code and documentation, or Go binaries with debug symbols. A simple 50-line function can become a 300MB package.\n\n**Why It's Wrong**: Large packages increase cold start time (more data to transfer), consume more storage, and waste memory. They also expose potentially sensitive information (source code, comments, debug symbols).\n\n**How to Fix**:\n- Implement **production-only packaging**: Exclude dev dependencies, documentation, tests, examples.\n- Apply **aggressive compression**: Use ZIP with maximum compression, strip debug symbols from binaries.\n- **Deduplicate common layers**: Store common runtime dependencies (like AWS SDK) as shared layers that can be mounted read-only.\n- Set **maximum package size limits** (e.g., 250MB) and reject oversized packages.\n\n⚠️ **Pitfall: Improper or Missing Versioning**\n\n**Description**: Using mutable tags like `latest`, auto-incrementing version numbers without consistency, or allowing package modification after upload.\n\n**Why It's Wrong**: Breaks reproducibility and rollback capabilities. If a function starts failing, you cannot reliably revert to the previous working version. Also prevents deterministic deployments across environments (dev, staging, prod).\n\n**How to Fix**:\n- Use **immutable, content-based versioning**: The artifact hash (SHA-256) becomes part of the version identifier.\n- Support **semantic versioning** as user-friendly aliases: `myfunction:v1.2.3` points to hash `abc123...`.\n- Implement **version immutability guarantee**: Once stored, an artifact cannot be modified or deleted while referenced.\n- Maintain **version lineage**: Track which version succeeded which, enabling rollback graphs.\n\n⚠️ **Pitfall: Incomplete Validation Leading to Runtime Failures**\n\n**Description**: Only validating the package structure but not testing if the function actually works. The handler might not exist, dependencies might be missing at runtime, or the function signature might be wrong.\n\n**Why It's Wrong**: Defers discovery of problems until invocation time, which is worse for users (harder to debug) and the system (wastes resources provisioning environments for broken functions).\n\n**How to Fix**:\n- **Validate handler existence**: For interpreted languages, parse the code to ensure the handler module/function exists.\n- **Test compilation**: For compiled languages, actually compile the code during packaging.\n- **Optional smoke test**: Provide a flag to run a test invocation during packaging with a sample payload.\n- **Runtime compatibility check**: Verify the function works with the specific runtime version (Python 3.9 vs 3.10 differences).\n\n### Implementation Guidance for Packaging\n\n#### Technology Recommendations\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| Upload API | HTTP multipart form with `net/http` | gRPC with chunked streaming for large packages |\n| Dependency Resolution | Language-native tools (`go mod`, `npm`, `pip`) | Custom resolver with vulnerability scanning |\n| Artifact Storage | Local filesystem with hash-based directories | S3/MinIO with content addressing |\n| Registry Database | SQLite (embedded) | PostgreSQL with connection pooling |\n| Build Environment | Local OS with language runtimes installed | Docker containers for hermetic builds |\n\n#### Recommended File/Module Structure\n\n```\nserverless-runtime/\n├── cmd/\n│   ├── packaging-server/          # Standalone packaging service\n│   │   └── main.go\n│   └── gateway/                   # Main gateway (includes packaging routes)\n│       └── main.go\n├── internal/\n│   ├── packaging/\n│   │   ├── api/                   # HTTP/API handlers\n│   │   │   ├── upload.go\n│   │   │   ├── versions.go\n│   │   │   └── middleware.go\n│   │   ├── bundler/               # Language-specific bundlers\n│   │   │   ├── interface.go\n│   │   │   ├── go_bundler.go\n│   │   │   ├── python_bundler.go\n│   │   │   ├── nodejs_bundler.go\n│   │   │   └── java_bundler.go\n│   │   ├── registry/              # Function version registry\n│   │   │   ├── registry.go\n│   │   │   ├── sqlite_store.go\n│   │   │   └── postgres_store.go\n│   │   ├── storage/               # Artifact storage backends\n│   │   │   ├── interface.go\n│   │   │   ├── filesystem_store.go\n│   │   │   └── s3_store.go\n│   │   ├── types/                 # Packaging-specific types\n│   │   │   ├── function_def.go\n│   │   │   └── artifact.go\n│   │   └── coordinator.go         # Orchestrates the packaging workflow\n│   └── function/                  # Shared function types (from Data Model)\n│       └── types.go\n└── pkg/\n    └── compression/               # Reusable compression utilities\n        ├── zip.go\n        └── tar.go\n```\n\n#### Infrastructure Starter Code: Upload API Handler\n\n```go\n// internal/packaging/api/upload.go\npackage api\n\nimport (\n    \"context\"\n    \"crypto/sha256\"\n    \"encoding/hex\"\n    \"fmt\"\n    \"io\"\n    \"mime/multipart\"\n    \"net/http\"\n    \"os\"\n    \"path/filepath\"\n    \"time\"\n\n    \"github.com/your-org/serverless-runtime/internal/packaging\"\n    \"github.com/your-org/serverless-runtime/internal/packaging/types\"\n)\n\n// UploadHandler handles multipart form uploads for function packages\ntype UploadHandler struct {\n    coordinator *packaging.Coordinator\n    maxUploadMB int64\n    tempDir     string\n}\n\n// NewUploadHandler creates a new upload handler with configuration\nfunc NewUploadHandler(coordinator *packaging.Coordinator, maxUploadMB int64) *UploadHandler {\n    return &UploadHandler{\n        coordinator: coordinator,\n        maxUploadMB: maxUploadMB,\n        tempDir:     os.TempDir(),\n    }\n}\n\n// ServeHTTP implements http.Handler\nfunc (h *UploadHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    // 1. Limit request size\n    r.Body = http.MaxBytesReader(w, r.Body, h.maxUploadMB*1024*1024)\n    \n    // 2. Parse multipart form\n    if err := r.ParseMultipartForm(10 << 20); // 10MB in memory, rest on disk\n    err != nil {\n        http.Error(w, \"Failed to parse multipart form: \"+err.Error(), http.StatusBadRequest)\n        return\n    }\n    \n    // 3. Extract function.yaml\n    funcFile, funcHeader, err := r.FormFile(\"function.yaml\")\n    if err != nil {\n        http.Error(w, \"Missing required file: function.yaml\", http.StatusBadRequest)\n        return\n    }\n    defer funcFile.Close()\n    \n    // 4. Extract code archive\n    codeFile, codeHeader, err := r.FormFile(\"code\")\n    if err != nil {\n        http.Error(w, \"Missing required file: code\", http.StatusBadRequest)\n        return\n    }\n    defer codeFile.Close()\n    \n    // 5. Create temporary workspace\n    workspace, err := h.createWorkspace()\n    if err != nil {\n        http.Error(w, \"Failed to create workspace: \"+err.Error(), http.StatusInternalServerError)\n        return\n    }\n    defer os.RemoveAll(workspace) // Cleanup\n    \n    // 6. Save uploaded files to workspace\n    funcDefPath, err := h.saveUploadedFile(funcFile, funcHeader, workspace, \"function.yaml\")\n    if err != nil {\n        http.Error(w, \"Failed to save function definition: \"+err.Error(), http.StatusInternalServerError)\n        return\n    }\n    \n    codePath, err := h.saveUploadedFile(codeFile, codeHeader, workspace, \"code\")\n    if err != nil {\n        http.Error(w, \"Failed to save code: \"+err.Error(), http.StatusInternalServerError)\n        return\n    }\n    \n    // 7. Parse and validate function definition\n    funcDef, err := h.parseFunctionDefinition(funcDefPath)\n    if err != nil {\n        http.Error(w, \"Invalid function definition: \"+err.Error(), http.StatusBadRequest)\n        return\n    }\n    \n    // 8. Extract code archive if it's a ZIP/TAR\n    if err := h.extractArchive(codePath, workspace); err != nil {\n        http.Error(w, \"Failed to extract code archive: \"+err.Error(), http.StatusBadRequest)\n        return\n    }\n    \n    // 9. Process through coordinator\n    ctx, cancel := context.WithTimeout(r.Context(), 5*time.Minute)\n    defer cancel()\n    \n    result, err := h.coordinator.ProcessUpload(ctx, funcDef, workspace)\n    if err != nil {\n        http.Error(w, \"Packaging failed: \"+err.Error(), http.StatusInternalServerError)\n        return\n    }\n    \n    // 10. Return success response\n    w.Header().Set(\"Content-Type\", \"application/json\")\n    w.WriteHeader(http.StatusCreated)\n    fmt.Fprintf(w, `{\"function_id\": \"%s\", \"version\": \"%s\", \"artifact_hash\": \"%s\"}`, \n        result.FunctionName, result.Version, result.ArtifactHash)\n}\n\n// Helper method to create unique workspace directory\nfunc (h *UploadHandler) createWorkspace() (string, error) {\n    dir := filepath.Join(h.tempDir, fmt.Sprintf(\"func-pkg-%d\", time.Now().UnixNano()))\n    if err := os.MkdirAll(dir, 0755); err != nil {\n        return \"\", fmt.Errorf(\"mkdir failed: %w\", err)\n    }\n    return dir, nil\n}\n\n// Helper method to save uploaded file\nfunc (h *UploadHandler) saveUploadedFile(file multipart.File, header *multipart.FileHeader, workspace, destName string) (string, error) {\n    destPath := filepath.Join(workspace, destName)\n    dest, err := os.Create(destPath)\n    if err != nil {\n        return \"\", fmt.Errorf(\"create file failed: %w\", err)\n    }\n    defer dest.Close()\n    \n    if _, err := io.Copy(dest, file); err != nil {\n        return \"\", fmt.Errorf(\"copy failed: %w\", err)\n    }\n    \n    return destPath, nil\n}\n\n// Helper method to compute file hash\nfunc computeFileHash(path string) (string, error) {\n    f, err := os.Open(path)\n    if err != nil {\n        return \"\", err\n    }\n    defer f.Close()\n    \n    hasher := sha256.New()\n    if _, err := io.Copy(hasher, f); err != nil {\n        return \"\", err\n    }\n    \n    return hex.EncodeToString(hasher.Sum(nil)), nil\n}\n```\n\n#### Core Logic Skeleton: Packaging Coordinator\n\n```go\n// internal/packaging/coordinator.go\npackage packaging\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"os\"\n    \"path/filepath\"\n\n    \"github.com/your-org/serverless-runtime/internal/packaging/bundler\"\n    \"github.com/your-org/serverless-runtime/internal/packaging/registry\"\n    \"github.com/your-org/serverless-runtime/internal/packaging/storage\"\n    \"github.com/your-org/serverless-runtime/internal/packaging/types\"\n)\n\n// Coordinator orchestrates the packaging workflow\ntype Coordinator struct {\n    registry    registry.Registry\n    storage     storage.ArtifactStorage\n    bundlers    map[string]bundler.Bundler // keyed by runtime\n    workspaceDir string\n}\n\n// ProcessUploadResult contains results of a successful packaging operation\ntype ProcessUploadResult struct {\n    FunctionName  string\n    Version       string\n    ArtifactHash  string\n    ArtifactSize  int64\n    Dependencies  []string\n}\n\n// ProcessUpload executes the complete packaging workflow\nfunc (c *Coordinator) ProcessUpload(ctx context.Context, def *types.FunctionDefinition, sourceDir string) (*ProcessUploadResult, error) {\n    // TODO 1: Validate the FunctionDefinition (check required fields, runtime support)\n    // Hint: Use def.Validate() method\n    \n    // TODO 2: Select appropriate bundler based on def.Runtime\n    // Hint: Look up in c.bundlers map, return error if runtime not supported\n    \n    // TODO 3: Validate the handler exists in source code\n    // Hint: Call bundler.ValidateHandler(ctx, sourceDir, def)\n    \n    // TODO 4: Resolve dependencies\n    // Hint: Call bundler.ResolveDependencies(ctx, sourceDir, def.Dependencies)\n    // Store the complete dependency list for metadata\n    \n    // TODO 5: Create temporary build directory\n    // Hint: Use os.MkdirTemp with c.workspaceDir as parent\n    \n    // TODO 6: Build artifact\n    // Hint: Call bundler.BuildArtifact(ctx, sourceDir, def)\n    // The bundler returns path to the built artifact file\n    \n    // TODO 7: Compute artifact hash (SHA-256)\n    // Hint: Read the artifact file and compute hash using sha256.Sum256\n    // Convert to hex string for storage key\n    \n    // TODO 8: Check if artifact already exists in storage (deduplication)\n    // Hint: Call c.storage.Exists(ctx, hash)\n    // If exists, skip to step 10\n    \n    // TODO 9: Store artifact in content-addressable storage\n    // Hint: Call c.storage.Store(ctx, hash, artifactPath)\n    // Get artifact size for metadata\n    \n    // TODO 10: Register function version in registry\n    // Hint: Create registry.FunctionVersion record with:\n    // - FunctionName: def.Name\n    // - Version: generateVersion(def, hash) \n    // - ArtifactHash: hash\n    // - Metadata: size, dependencies, creation time\n    \n    // TODO 11: Clean up temporary build directory\n    // Hint: os.RemoveAll on build directory\n    \n    // TODO 12: Return ProcessUploadResult with all metadata\n    return nil, fmt.Errorf(\"not implemented\")\n}\n\n// GetBundler returns the bundler for a runtime\nfunc (c *Coordinator) GetBundler(runtime string) (bundler.Bundler, error) {\n    b, ok := c.bundlers[runtime]\n    if !ok {\n        return nil, fmt.Errorf(\"unsupported runtime: %s\", runtime)\n    }\n    return b, nil\n}\n\n// generateVersion creates a version identifier from function definition and hash\nfunc generateVersion(def *types.FunctionDefinition, hash string) string {\n    // Use short hash (first 12 chars) for readability\n    shortHash := hash[:12]\n    return fmt.Sprintf(\"%s-%s\", def.Name, shortHash)\n}\n```\n\n#### Core Logic Skeleton: Go Language Bundler\n\n```go\n// internal/packaging/bundler/go_bundler.go\npackage bundler\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"os\"\n    \"os/exec\"\n    \"path/filepath\"\n    \"strings\"\n\n    \"github.com/your-org/serverless-runtime/internal/packaging/types\"\n)\n\n// GoBundler implements Bundler interface for Go functions\ntype GoBundler struct {\n    goPath      string // Path to go binary\n    buildTarget string // Target OS/architecture, e.g., \"linux/amd64\"\n}\n\n// NewGoBundler creates a new Go bundler\nfunc NewGoBundler() (*GoBundler, error) {\n    goPath, err := exec.LookPath(\"go\")\n    if err != nil {\n        return nil, fmt.Errorf(\"go not found in PATH: %w\", err)\n    }\n    \n    return &GoBundler{\n        goPath:      goPath,\n        buildTarget: \"linux/amd64\", // Standard serverless target\n    }, nil\n}\n\n// ResolveDependencies resolves Go dependencies using go mod\nfunc (b *GoBundler) ResolveDependencies(ctx context.Context, workDir string, deps []string) ([]string, error) {\n    // TODO 1: Check if go.mod exists in workDir\n    // Hint: Use os.Stat on filepath.Join(workDir, \"go.mod\")\n    // If not exists, create a minimal go.mod with module name\n    \n    // TODO 2: Run 'go mod tidy' to ensure go.mod and go.sync are consistent\n    // Hint: Use exec.CommandContext with b.goPath, \"mod\", \"tidy\"\n    // Set Dir to workDir, capture output\n    \n    // TODO 3: If deps provided, add them to go.mod\n    // Hint: For each dep in deps, run 'go get <dep>'\n    \n    // TODO 4: Run 'go list -m all' to get complete dependency list\n    // Hint: Parse output to get all module paths and versions\n    \n    // TODO 5: Return list of dependencies in format \"module@version\"\n    return []string{}, fmt.Errorf(\"not implemented\")\n}\n\n// BuildArtifact builds a standalone Go binary\nfunc (b *GoBundler) BuildArtifact(ctx context.Context, workDir string, def types.FunctionDefinition) (string, error) {\n    // TODO 1: Parse handler to extract package and function name\n    // Go handlers format: \"package.FunctionName\"\n    // Hint: Split on last \".\" - everything before is import path, after is function\n    \n    // TODO 2: Create temporary output directory for the binary\n    // Hint: os.MkdirTemp\n    \n    // TODO 3: Build command: go build -o <output> <build flags>\n    // Required flags:\n    // - -ldflags=\"-s -w\" // Strip debug symbols\n    // - -trimpath        // Remove file system paths\n    // - GOOS=linux, GOARCH=amd64 environment variables\n    \n    // TODO 4: Execute build command\n    // Hint: Use exec.CommandContext, set Dir to workDir\n    // Capture stdout/stderr for error reporting\n    \n    // TODO 5: Verify binary was created and is executable\n    // Hint: os.Stat on output path, check file mode\n    \n    // TODO 6: Return path to built binary\n    return \"\", fmt.Errorf(\"not implemented\")\n}\n\n// ValidateHandler verifies the handler exists in Go code\nfunc (b *GoBundler) ValidateHandler(ctx context.Context, workDir string, def types.FunctionDefinition) error {\n    // TODO 1: Parse handler string format: \"package.FunctionName\"\n    // Hint: strings.Split for last \".\"\n    \n    // TODO 2: Check if package directory exists in workDir\n    // For relative packages (starting with \"./\"), check relative to workDir\n    // For absolute packages, they should be in GOPATH/module cache\n    \n    // TODO 3: Use 'go list' to verify function exists in package\n    // Command: go list -f '{{.Name}} {{.Doc}}' <package>\n    // Parse output to find function\n    \n    // TODO 4: Check function signature matches expected handler format\n    // Serverless Go handlers should be: func Handler(ctx context.Context, payload []byte) ([]byte, error)\n    // We can't fully validate without compilation, but we can check via go/ast parsing\n    // Simple approach: grep for function definition in source files\n    \n    return fmt.Errorf(\"not implemented\")\n}\n\n// GetBaseImage returns container image for Go runtime\nfunc (b *GoBundler) GetBaseImage(runtime string) string {\n    // Use lightweight Alpine-based image for Go\n    return \"golang:alpine\"\n}\n```\n\n#### Language-Specific Hints for Go Implementation\n\n- **Dependency Management**: Use `go mod` commands programmatically via `exec.Command`. Set `GOPROXY=direct` to avoid proxy caching during builds.\n- **Cross-Compilation**: Set `GOOS=linux` and `GOARCH=amd64` environment variables when building for the serverless environment.\n- **Binary Optimization**: Use `-ldflags=\"-s -w\"` to strip debug symbols and reduce binary size by 20-30%.\n- **Handler Validation**: For thorough validation, use the `go/ast` package to parse source files and verify function signatures match `func(context.Context, []byte) ([]byte, error)`.\n- **Temporary Files**: Use `os.MkdirTemp` with cleanup deferred. For large builds, ensure adequate disk space in the temporary directory.\n\n#### Milestone Checkpoint: Verifying Function Packaging\n\nAfter implementing the packaging subsystem, verify it works:\n\n1. **Start the packaging server**:\n   ```bash\n   go run cmd/packaging-server/main.go --port 8080 --storage-dir /tmp/func-storage\n   ```\n\n2. **Create a test function**:\n   ```bash\n   mkdir test-function\n   cat > test-function/function.yaml << 'EOF'\n   name: hello-world\n   runtime: go1.x\n   handler: main.Handler\n   timeout: 30\n   memory: 128\n   EOF\n   \n   cat > test-function/main.go << 'EOF'\n   package main\n   \n   import (\n       \"context\"\n       \"fmt\"\n   )\n   \n   func Handler(ctx context.Context, input []byte) ([]byte, error) {\n       return []byte(fmt.Sprintf(\"Hello, %s!\", string(input))), nil\n   }\n   EOF\n   \n   cat > test-function/go.mod << 'EOF'\n   module example.com/hello\n   \n   go 1.21\n   EOF\n   ```\n\n3. **Package the function**:\n   ```bash\n   curl -X POST http://localhost:8080/v1/functions \\\n     -F \"function.yaml=@test-function/function.yaml\" \\\n     -F \"code=@test-function/main.go\" \\\n     -F \"code=@test-function/go.mod\"\n   ```\n   \n   **Expected Response**:\n   ```json\n   {\n     \"function_id\": \"hello-world\",\n     \"version\": \"hello-world-a1b2c3d4e5f6\",\n     \"artifact_hash\": \"a1b2c3d4e5f67890...\",\n     \"artifact_size\": 2850367\n   }\n   ```\n\n4. **Verify artifact storage**:\n   ```bash\n   # Check artifact exists in storage\n   ls -la /tmp/func-storage/artifacts/a1/b2/c3/\n   \n   # List function versions\n   curl http://localhost:8080/v1/functions/hello-world/versions\n   ```\n\n5. **Signs of Correct Implementation**:\n   - Artifact file exists at hash-based path\n   - Binary is Linux executable (`file` shows \"ELF 64-bit LSB executable\")\n   - Binary is stripped (no debug symbols, reduced size)\n   - Registry shows the function version with correct metadata\n   - Re-uploading identical code returns same hash (deduplication works)\n\n6. **Common Issues and Fixes**:\n   - **\"Handler not found\"**: Check handler parsing logic; ensure package path matches directory structure.\n   - **\"Build failed\"**: Check Go installation and environment variables for cross-compilation.\n   - **\"Artifact too large\"**: Verify `-ldflags=\"-s -w\"` is being used; strip debug symbols.\n   - **\"Dependency resolution failed\"**: Ensure `go.mod` exists or is created automatically for simple functions.\n\n---\n\n\n## Component Design: Execution Environment\n\n> **Milestone(s):** Milestone 2\n\n### Mental Model: The Pop-Up Shop\n\nImagine you're opening a series of temporary, identical retail shops in a busy market district. Each shop must be fully self-contained with all necessary inventory, equipment, and staff. When a customer arrives, you need to instantly open a shop, serve them in complete privacy, then close it down without leaving any trace. This is exactly what our execution environment does for serverless functions.\n\nThink of our system as a **pop-up shop management company**:\n- **Shop Blueprint** = The base container image with language runtime and system dependencies\n- **Shop Inventory** = The function code and its specific dependencies\n- **Shop Staff** = The handler process that actually serves requests\n- **Shop Security** = Resource limits (budget), time limits (operating hours), and isolation walls (private spaces)\n- **Shop Manager** = Our ContainerManager interface that handles setup, operations, and teardown\n\nWhen a request arrives (a customer), we either reuse an already-open shop (warm instance) or rapidly set up a new one from the blueprint (cold start). Each shop operates independently—customers in one shop can't see or interfere with customers in another, even if they're right next door. After serving its customer, the shop stays open for a short time in case more customers arrive, then closes completely, returning all resources to the market.\n\nThis mental model helps us understand the **ephemeral**, **isolated**, and **resource-bound** nature of serverless execution environments. We're not running permanent servers but creating temporary, fully-contained execution spaces that appear and disappear on demand.\n\n### Container Manager Interface\n\nThe `ContainerManager` interface abstracts the underlying isolation technology (containers, microVMs, etc.) and provides a uniform API for managing function execution environments. This interface sits at the heart of our execution plane, responsible for creating, managing, and destroying isolated environments with precise resource controls.\n\n| Method | Parameters | Returns | Description |\n|--------|------------|---------|-------------|\n| `CreateContainer` | `ctx context.Context`, `req CreateContainerRequest` | `(*Container, error)` | Creates a new isolated environment with the specified configuration but doesn't start it |\n| `StartContainer` | `ctx context.Context`, `containerID string` | `error` | Begins execution of a previously created container |\n| `ExecuteInContainer` | `ctx context.Context`, `containerID string`, `cmd []string`, `input io.Reader`, `output io.Writer` | `(int, error)` | Runs a command inside a running container, capturing stdin/stdout and returning exit code |\n| `StopContainer` | `ctx context.Context`, `containerID string`, `timeout time.Duration` | `error` | Gracefully stops a running container with SIGTERM then SIGKILL |\n| `RemoveContainer` | `ctx context.Context`, `containerID string` | `error` | Completely cleans up all container resources (network, storage, process) |\n| `GetContainerStats` | `ctx context.Context`, `containerID string` | `(*ContainerStats, error)` | Returns current resource usage statistics for monitoring and scaling |\n| `ListContainers` | `ctx context.Context`, `filter ListFilter` | `([]Container, error)` | Returns all managed containers matching filter criteria |\n| `HealthCheck` | `ctx context.Context` | `error` | Verifies the underlying container runtime is operational |\n\nThe `CreateContainerRequest` structure defines the complete specification for an isolated environment:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `Image` | `string` | Base container image (e.g., \"golang:1.21-alpine\") |\n| `Cmd` | `[]string` | Command to execute when container starts |\n| `Env` | `[]string` | Environment variables in \"KEY=VALUE\" format |\n| `Labels` | `map[string]string` | Metadata labels for tracking and filtering |\n| `CPUQuota` | `int64` | CPU allocation in microseconds per second (e.g., 500000 = 0.5 CPU) |\n| `MemoryLimit` | `int64` | Maximum memory in bytes |\n| `NetworkMode` | `string` | Network isolation mode (\"none\", \"bridge\", \"host\") |\n| `Binds` | `[]string` | Volume mounts in \"host:container:options\" format |\n| `WorkingDir` | `string` | Working directory inside container |\n| `User` | `string` | User:group to run as (e.g., \"1000:1000\") |\n| `SecurityOpts` | `[]string` | Security options (seccomp, AppArmor, capabilities) |\n| `ExposedPorts` | `map[string]struct{}` | Ports to expose internally |\n| `PortBindings` | `map[string][]PortBinding` | Port mappings to host |\n\nWhen a function needs to execute, the system follows this workflow:\n\n1. **Environment Creation**: The `ContainerManager` receives a `CreateContainerRequest` with the function's base image, resource limits, and configuration.\n2. **Resource Allocation**: The underlying runtime (e.g., Docker) creates a container with the specified cgroups, namespaces, and security profiles.\n3. **Code Injection**: The function artifact (from Milestone 1) is mounted into the container's filesystem.\n4. **Process Start**: The container starts, initializing the language runtime and loading dependencies.\n5. **Execution**: The handler process begins listening for invocations via HTTP or stdin.\n6. **Monitoring**: Resource usage is continuously tracked via `GetContainerStats`.\n7. **Cleanup**: After the function completes or times out, the container is stopped and removed.\n\n### ADR: Container vs. MicroVM Isolation\n\n> **Decision: Use Linux Containers with Enhanced Security Hardening**\n> \n> **Context**: We need strong **isolation** between untrusted user functions while maintaining **fast startup times** for cold starts. The isolation boundary must prevent functions from accessing host resources, other functions' memory/files, and must enforce strict resource limits (CPU, memory, network). We evaluated two primary approaches: traditional Linux containers (namespaces + cgroups) and lightweight virtual machines (microVMs).\n> \n> **Options Considered**:\n> 1. **Linux Containers with Enhanced Hardening**: Use Docker/containerd with namespace isolation, cgroups for resources, plus seccomp, AppArmor, and capability dropping\n> 2. **Firecracker MicroVMs**: Use lightweight KVM-based virtual machines with minimal device emulation and optimized boot time\n> 3. **gVisor/Sandboxed Containers**: Use a userspace kernel that intercepts system calls for stronger isolation than containers but weaker than VMs\n> \n> **Decision**: We chose **Option 1: Linux Containers with Enhanced Hardening** as our primary isolation mechanism.\n> \n> **Rationale**:\n> 1. **Cold Start Performance**: Containers start in 100-500ms vs. microVMs at 100-300ms with snapshotting. Without snapshotting, microVMs take 1-3 seconds. Our goal of sub-100ms cold starts (Milestone 3) is more achievable with container checkpoint/restore (CRIU).\n> 2. **Resource Efficiency**: Containers share the host kernel, allowing for higher density (more functions per host) and lower memory overhead (~5MB per container vs. ~5MB + VM memory overhead).\n> 3. **Maturity and Tooling**: The container ecosystem (Docker, containerd, Kubernetes) provides battle-tested tooling for lifecycle management, networking, and storage.\n> 4. **Sufficient Isolation for Most Workloads**: With proper security hardening (no root, read-only rootfs, dropped capabilities, seccomp, AppArmor), containers provide adequate isolation for multi-tenant serverless functions where users don't control the underlying infrastructure.\n> 5. **Simpler Implementation**: Container APIs are standardized (OCI) and Go libraries (Docker SDK) are mature, reducing implementation complexity.\n> \n> **Consequences**:\n> - **Positive**: Faster cold starts, higher density, simpler implementation, extensive tooling\n> - **Negative**: Requires careful security configuration to prevent kernel-level escapes\n> - **Mitigation**: We implement defense-in-depth with multiple security layers and will support microVMs as an optional, more secure backend for high-risk workloads\n\n| Isolation Technology | Startup Time (cold) | Isolation Strength | Memory Overhead | Implementation Complexity | Best For |\n|---------------------|---------------------|-------------------|-----------------|--------------------------|----------|\n| **Linux Containers (hardened)** | 100-500ms | Moderate (kernel sharing) | ~5-50MB | Medium | General-purpose serverless, fast cold starts |\n| **Firecracker MicroVMs** | 100-300ms (with snapshot) 1-3s (fresh) | Strong (hardware virtualization) | ~5MB + VM memory | High | Security-critical multi-tenant, financial/healthcare workloads |\n| **gVisor/Sandboxed** | 200-800ms | Strong (userspace kernel) | ~20-100MB | Medium-High | Additional security without full virtualization |\n\nWe'll design the `ContainerManager` interface to be pluggable, allowing us to implement a `FirecrackerManager` in the future while maintaining the same API. The initial implementation will use Docker via the `DockerManager` struct.\n\n### Common Pitfalls in Execution Environment\n\n⚠️ **Pitfall: Misconfigured Resource Limits Causing Premature Termination**\n\n**Description**: Setting memory limits too close to the function's actual usage, or not accounting for runtime overhead (JVM heap, Python interpreter, etc.), causes functions to be killed by the OOM (Out-Of-Memory) killer before completing their work.\n\n**Why It's Wrong**: Functions fail unpredictably with cryptic \"signal: killed\" errors instead of clean memory exhaustion errors. This makes debugging difficult and reduces platform reliability.\n\n**How to Fix**:\n1. Always add a memory buffer (e.g., 20-30%) above the function's declared memory limit for runtime overhead\n2. Use memory-swap limits to disable swapping (set `MemorySwap` = `MemoryLimit`) to ensure predictable performance\n3. Monitor actual usage with `GetContainerStats` and adjust default limits based on runtime\n4. Provide clear error messages when containers are OOM-killed\n\n⚠️ **Pitfall: Zombie Containers Accumulating and Exhausting Host Resources**\n\n**Description**: When containers aren't properly cleaned up after function execution (due to crashes, timeouts, or programming errors), they accumulate as \"zombie\" processes consuming memory, file descriptors, and other system resources.\n\n**Why It's Wrong**: Resource leaks eventually cause host exhaustion, leading to \"no space left on device\" or \"too many open files\" errors that affect all functions on the host.\n\n**How to Fix**:\n1. Implement a garbage collection routine in the `ContainerManager` that periodically lists all containers and removes those not in the active inventory\n2. Use container labels to track ownership and expected lifetime\n3. Always call `RemoveContainer` in a `defer` statement or finally block after container use\n4. Set container auto-remove flags where supported by the runtime\n\n⚠️ **Pitfall: Inadequate Sandboxing Allowing Privilege Escalation**\n\n**Description**: Running containers as root, with excessive Linux capabilities, or without seccomp/AppArmor profiles allows malicious functions to escape isolation and access the host or other functions.\n\n**Why It's Wrong**: Complete security breach violating multi-tenancy. Functions can read secrets, modify other functions' code, or attack the host system.\n\n**How to Fix**:\n1. Always run containers as non-root users (specify `User: \"1000:1000\"` in `CreateContainerRequest`)\n2. Drop all capabilities and add back only specifically required ones: `SecurityOpts: [\"no-new-privileges\", \"cap-drop=ALL\"]`\n3. Apply restrictive seccomp profiles that block dangerous syscalls (clone, ptrace, kernel module operations)\n4. Use read-only root filesystem where possible, with only `/tmp` writable\n5. Disable inter-container communication at the network level\n\n⚠️ **Pitfall: Shared Mutable State Between Invocations Causing Data Leaks**\n\n**Description**: Reusing the same container for multiple invocations without resetting the filesystem or memory state allows one invocation to see another's data.\n\n**Why It's Wrong**: Violates the serverless principle that functions should be stateless. User A's data could be visible to User B if they happen to use the same container.\n\n**How to Fix**:\n1. Treat containers as single-use for security-critical workloads, creating a new container per invocation\n2. For performance (warm starts), only reuse containers for the same function version and reset writable areas between invocations\n3. Use overlay filesystems with a fresh upper layer for each invocation\n4. Clear environment variables, process memory is harder—consider it contaminated and don't reuse for different users\n\n### Implementation Guidance for Execution Environment\n\n#### Technology Recommendations\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| Container Runtime | Docker Engine (docker.io) | containerd with CRI plugin |\n| Container SDK | Docker Go SDK (github.com/docker/docker/client) | Direct containerd Go client (github.com/containerd/containerd) |\n| Resource Limits | cgroups v2 via container runtime | Manual cgroup setup via `github.com/containerd/cgroups` |\n| Security Profiles | Default Docker seccomp + custom AppArmor | Custom seccomp JSON profiles + SELinux |\n\n#### Recommended File/Module Structure\n\n```\nproject-root/\n├── cmd/\n│   └── server/\n│       └── main.go                 # Entry point\n├── internal/\n│   ├── containermanager/           # Container isolation subsystem\n│   │   ├── manager.go              # ContainerManager interface\n│   │   ├── docker_manager.go       # DockerManager implementation\n│   │   ├── firecracker_manager.go  # Future: Firecracker implementation\n│   │   ├── cgroup_helper.go        # Low-level cgroup utilities\n│   │   ├── security/               # Security profiles\n│   │   │   ├── seccomp.go          # Seccomp profile generator\n│   │   │   └── apparmor.go         # AppArmor profile templates\n│   │   └── tests/\n│   │       └── manager_test.go     # Integration tests\n│   ├── execution/                  # Execution coordination\n│   │   ├── executor.go             # Orchestrates container lifecycle per function\n│   │   └── runtime/                # Language-specific runtime configurations\n│   │       ├── golang.go           # Go runtime setup\n│   │       ├── python.go           # Python runtime setup\n│   │       └── nodejs.go           # Node.js runtime setup\n│   └── metrics/                    # Metrics collection\n│       └── container_metrics.go    # Container-specific metrics\n└── pkg/\n    └── types/                      # Shared types (already defined)\n        └── container.go            # Container, CreateContainerRequest types\n```\n\n#### Infrastructure Starter Code\n\n**cgroup_helper.go** - Low-level cgroup utilities for manual resource limiting:\n\n```go\npackage containermanager\n\nimport (\n\t\"fmt\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"strconv\"\n\n\t\"github.com/containerd/cgroups/v3\"\n\t\"github.com/containerd/cgroups/v3/cgroup1\"\n\tcgroupv2 \"github.com/containerd/cgroups/v3/cgroup2\"\n)\n\n// CGroupHelper provides utilities for managing cgroups manually\n// Used when container runtime doesn't provide sufficient control\ntype CGroupHelper struct {\n\tcgroupPath string\n\tisV2       bool\n}\n\n// NewCGroupHelper creates a cgroup at the specified path\nfunc NewCGroupHelper(path string) (*CGroupHelper, error) {\n\t// Detect cgroup version\n\tisV2 := cgroups.Mode() == cgroups.Unified\n\t\n\treturn &CGroupHelper{\n\t\tcgroupPath: path,\n\t\tisV2:       isV2,\n\t}, nil\n}\n\n// SetMemoryLimit configures memory limit and swap (if supported)\nfunc (h *CGroupHelper) SetMemoryLimit(limitBytes int64, swapBytes int64) error {\n\tif h.isV2 {\n\t\treturn h.setMemoryLimitV2(limitBytes)\n\t}\n\treturn h.setMemoryLimitV1(limitBytes, swapBytes)\n}\n\n// setMemoryLimitV1 sets memory limit for cgroup v1\nfunc (h *CGroupHelper) setMemoryLimitV1(limitBytes int64, swapBytes int64) error {\n\tmemoryPath := filepath.Join(\"/sys/fs/cgroup/memory\", h.cgroupPath)\n\t\n\t// Create cgroup directory if it doesn't exist\n\tif err := os.MkdirAll(memoryPath, 0755); err != nil {\n\t\treturn fmt.Errorf(\"failed to create cgroup dir: %w\", err)\n\t}\n\t\n\t// Set memory limit\n\tlimitFile := filepath.Join(memoryPath, \"memory.limit_in_bytes\")\n\tif err := os.WriteFile(limitFile, []byte(strconv.FormatInt(limitBytes, 10)), 0644); err != nil {\n\t\treturn fmt.Errorf(\"failed to set memory limit: %w\", err)\n\t}\n\t\n\t// Set memory+swap limit (must be >= memory limit)\n\tif swapBytes > 0 {\n\t\tmemswFile := filepath.Join(memoryPath, \"memory.memsw.limit_in_bytes\")\n\t\tif err := os.WriteFile(memswFile, []byte(strconv.FormatInt(swapBytes, 10)), 0644); err != nil {\n\t\t\t// Some systems don't have swap accounting enabled\n\t\t\tif !os.IsNotExist(err) {\n\t\t\t\treturn fmt.Errorf(\"failed to set swap limit: %w\", err)\n\t\t\t}\n\t\t}\n\t}\n\t\n\treturn nil\n}\n\n// setMemoryLimitV2 sets memory limit for cgroup v2\nfunc (h *CGroupHelper) setMemoryLimitV2(limitBytes int64) error {\n\t// For cgroup v2, we use the containerd library\n\tres := cgroupv2.Resources{\n\t\tMemory: &cgroupv2.Memory{\n\t\t\tMax: cgroupv2.NewPointer(uint64(limitBytes)),\n\t\t},\n\t}\n\t\n\tcg, err := cgroupv2.NewManager(\"/sys/fs/cgroup\", h.cgroupPath, &res)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to create cgroup v2: %w\", err)\n\t}\n\tdefer cg.Delete()\n\t\n\treturn nil\n}\n\n// AddProcess adds a process to the cgroup\nfunc (h *CGroupHelper) AddProcess(pid int) error {\n\tif h.isV2 {\n\t\treturn h.addProcessV2(pid)\n\t}\n\treturn h.addProcessV1(pid)\n}\n\n// addProcessV1 adds process to cgroup v1\nfunc (h *CGroupHelper) addProcessV1(pid int) error {\n\tprocsFile := filepath.Join(\"/sys/fs/cgroup/memory\", h.cgroupPath, \"cgroup.procs\")\n\treturn os.WriteFile(procsFile, []byte(strconv.Itoa(pid)), 0644)\n}\n\n// addProcessV2 adds process to cgroup v2\nfunc (h *CGroupHelper) addProcessV2(pid int) error {\n\t// Implementation with containerd library\n\tres := cgroupv2.Resources{}\n\tcg, err := cgroupv2.NewManager(\"/sys/fs/cgroup\", h.cgroupPath, &res)\n\tif err != nil {\n\t\treturn err\n\t}\n\tdefer cg.Delete()\n\t\n\treturn cg.AddProc(uint64(pid))\n}\n\n// Cleanup removes the cgroup\nfunc (h *CGroupHelper) Cleanup() error {\n\tif h.isV2 {\n\t\treturn h.cleanupV2()\n\t}\n\treturn h.cleanupV1()\n}\n\n// cleanupV1 removes cgroup v1 directory\nfunc (h *CGroupHelper) cleanupV1() error {\n\tmemoryPath := filepath.Join(\"/sys/fs/cgroup/memory\", h.cgroupPath)\n\t\n\t// Move any remaining processes to parent cgroup\n\tprocsFile := filepath.Join(memoryPath, \"cgroup.procs\")\n\tif procs, err := os.ReadFile(procsFile); err == nil && len(procs) > 0 {\n\t\tparentProcs := filepath.Join(filepath.Dir(memoryPath), \"cgroup.procs\")\n\t\tos.WriteFile(parentProcs, procs, 0644)\n\t}\n\t\n\treturn os.RemoveAll(memoryPath)\n}\n\n// cleanupV2 removes cgroup v2\nfunc (h *CGroupHelper) cleanupV2() error {\n\tcg, err := cgroupv2.Load(\"/sys/fs/cgroup\", h.cgroupPath)\n\tif err != nil {\n\t\t// Already cleaned up\n\t\treturn nil\n\t}\n\treturn cg.Delete()\n}\n```\n\n**security/seccomp.go** - Default seccomp profile for serverless functions:\n\n```go\npackage security\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n)\n\n// SeccompProfile defines a restrictive seccomp filter for serverless functions\ntype SeccompProfile struct {\n\tDefaultAction string          `json:\"defaultAction\"`\n\tArchitectures []string        `json:\"architectures\"`\n\tSyscalls      []SeccompSyscall `json:\"syscalls\"`\n}\n\n// SeccompSyscall defines a single syscall rule\ntype SeccompSyscall struct {\n\tName   string   `json:\"name\"`\n\tAction string   `json:\"action\"`\n\tArgs   []SeccompArg `json:\"args,omitempty\"`\n}\n\n// SeccompArg defines an argument filter for syscalls\ntype SeccompArg struct {\n\tIndex    uint     `json:\"index\"`\n\tValue    uint64   `json:\"value\"`\n\tValueTwo uint64   `json:\"valueTwo,omitempty\"`\n\tOp       string   `json:\"op\"`\n}\n\n// DefaultSeccompProfile returns a restrictive seccomp profile for serverless functions\nfunc DefaultSeccompProfile() (string, error) {\n\tprofile := SeccompProfile{\n\t\tDefaultAction: \"SCMP_ACT_ERRNO\",\n\t\tArchitectures: []string{\"SCMP_ARCH_X86_64\", \"SCMP_ARCH_X86\", \"SCMP_ARCH_X32\"},\n\t\tSyscalls: []SeccompSyscall{\n\t\t\t// Basic required syscalls\n\t\t\t{Name: \"accept\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"accept4\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"access\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"alarm\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"bind\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"brk\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"capget\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"capset\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"chdir\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"chmod\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"chown\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"chown32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"clock_getres\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"clock_gettime\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"clock_nanosleep\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"clone\", Action: \"SCMP_ACT_ALLOW\", Args: []SeccompArg{\n\t\t\t\t{Index: 0, Value: 2114060288, Op: \"SCMP_CMP_MASKED_EQ\"},\n\t\t\t}},\n\t\t\t{Name: \"close\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"connect\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"copy_file_range\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"creat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"dup\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"dup2\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"dup3\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"epoll_create\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"epoll_create1\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"epoll_ctl\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"epoll_pwait\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"epoll_wait\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"eventfd\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"eventfd2\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"execve\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"execveat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"exit\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"exit_group\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"faccessat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fadvise64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fallocate\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fchdir\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fchmod\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fchmodat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fchown\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fchown32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fchownat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fcntl\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fcntl64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fdatasync\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fgetxattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"flistxattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"flock\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fork\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fremovexattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fsetxattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fstat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fstat64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fstatat64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fstatfs\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fstatfs64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"fsync\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"ftruncate\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"ftruncate64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"futex\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getcwd\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getdents\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getdents64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getegid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getegid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"geteuid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"geteuid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getgid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getgid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getgroups\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getgroups32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getitimer\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getpeername\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getpgid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getpgrp\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getpid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getppid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getpriority\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getrandom\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getresgid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getresgid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getresuid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getresuid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getrlimit\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"get_robust_list\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getrusage\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getsid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getsockname\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getsockopt\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"gettid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"gettimeofday\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getuid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getuid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"getxattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"inotify_add_watch\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"inotify_init\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"inotify_init1\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"inotify_rm_watch\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"io_cancel\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"ioctl\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"io_destroy\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"io_getevents\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"ioprio_get\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"ioprio_set\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"io_setup\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"io_submit\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"ipc\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"kill\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"lchown\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"lchown32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"lgetxattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"link\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"linkat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"listen\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"listxattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"llistxattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"_llseek\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"lremovexattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"lseek\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"lsetxattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"lstat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"lstat64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"madvise\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"memfd_create\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mincore\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mkdir\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mkdirat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mknod\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mknodat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mlock\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mlock2\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mlockall\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mmap\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mmap2\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mprotect\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mq_getsetattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mq_notify\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mq_open\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mq_timedreceive\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mq_timedsend\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mq_unlink\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"mremap\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"msgctl\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"msgget\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"msgrcv\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"msgsnd\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"msync\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"munlock\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"munlockall\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"munmap\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"nanosleep\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"newfstatat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"_newselect\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"open\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"openat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"pause\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"pipe\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"pipe2\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"poll\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"ppoll\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"prctl\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"pread64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"preadv\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"preadv2\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"prlimit64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"pselect6\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"pwrite64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"pwritev\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"pwritev2\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"read\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"readahead\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"readlink\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"readlinkat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"readv\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"recv\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"recvfrom\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"recvmmsg\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"recvmsg\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"remap_file_pages\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"removexattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"rename\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"renameat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"renameat2\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"rmdir\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"rt_sigaction\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"rt_sigpending\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"rt_sigprocmask\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"rt_sigqueueinfo\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"rt_sigreturn\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"rt_sigsuspend\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"rt_sigtimedwait\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"rt_tgsigqueueinfo\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sched_getaffinity\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sched_getparam\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sched_getscheduler\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sched_get_priority_max\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sched_get_priority_min\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sched_rr_get_interval\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sched_setaffinity\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sched_setparam\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sched_setscheduler\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sched_yield\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"seccomp\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"select\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"semctl\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"semget\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"semop\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"semtimedop\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"send\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sendfile\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sendfile64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sendmmsg\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sendmsg\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sendto\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setfsgid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setfsgid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setfsuid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setfsuid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setgid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setgid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setgroups\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setgroups32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setitimer\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setpgid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setpriority\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setregid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setregid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setresgid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setresgid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setresuid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setresuid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setreuid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setreuid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setrlimit\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setsid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setsockopt\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"set_tid_address\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setuid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setuid32\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"setxattr\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"shmat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"shmctl\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"shmdt\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"shmget\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"shutdown\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sigaltstack\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"signalfd\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"signalfd4\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sigreturn\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"socket\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"socketcall\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"socketpair\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"splice\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"stat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"stat64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"statfs\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"statfs64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"symlink\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"symlinkat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sync\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sync_file_range\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"sysinfo\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"tee\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"tgkill\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"time\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"timer_create\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"timer_delete\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"timer_getoverrun\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"timer_gettime\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"timer_settime\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"timerfd_create\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"timerfd_gettime\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"timerfd_settime\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"times\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"tkill\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"truncate\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"truncate64\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"ugetrlimit\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"umask\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"uname\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"unlink\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"unlinkat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"utime\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"utimensat\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"utimes\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"vfork\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"vmsplice\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"wait4\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"waitid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"waitpid\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"write\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t\t{Name: \"writev\", Action: \"SCMP_ACT_ALLOW\"},\n\t\t},\n\t}\n\t\n\tjsonData, err := json.MarshalIndent(profile, \"\", \"  \")\n\tif err != nil {\n\t\treturn \"\", fmt.Errorf(\"failed to marshal seccomp profile: %w\", err)\n\t}\n\t\n\treturn string(jsonData), nil\n}\n```\n\n#### Core Logic Skeleton Code\n\n**docker_manager.go** - Docker implementation of ContainerManager:\n\n```go\npackage containermanager\n\nimport (\n\t\"context\"\n\t\"io\"\n\t\"time\"\n\n\t\"github.com/docker/docker/api/types\"\n\t\"github.com/docker/docker/api/types/container\"\n\t\"github.com/docker/docker/api/types/filters\"\n\t\"github.com/docker/docker/api/types/network\"\n\t\"github.com/docker/docker/client\"\n\n\t\"yourproject/pkg/types\"\n)\n\n// DockerManager implements ContainerManager using Docker Engine\ntype DockerManager struct {\n\tclient *docker.Client\n}\n\n// NewDockerManager creates a new DockerManager\nfunc NewDockerManager() (*DockerManager, error) {\n\t// TODO 1: Create Docker client using client.NewClientWithOpts()\n\t// TODO 2: Configure client with appropriate API version and timeout\n\t// TODO 3: Verify connection with Ping() and return error if Docker is unavailable\n\t// TODO 4: Return initialized DockerManager with client\n\treturn nil, nil\n}\n\n// CreateContainer creates a new Docker container with the specified configuration\nfunc (dm *DockerManager) CreateContainer(ctx context.Context, req types.CreateContainerRequest) (*types.Container, error) {\n\t// TODO 1: Convert MemoryLimit from bytes to megabytes for Docker (divide by 1024*1024)\n\t// TODO 2: Prepare container configuration with:\n\t//         - Image: req.Image\n\t//         - Cmd: req.Cmd\n\t//         - Env: req.Env\n\t//         - WorkingDir: req.WorkingDir\n\t//         - User: req.User\n\t//         - Labels: req.Labels\n\t//         - ExposedPorts: req.ExposedPorts\n\t// TODO 3: Prepare host configuration with:\n\t//         - Memory: req.MemoryLimit\n\t//         - MemorySwap: req.MemoryLimit (to disable swap)\n\t//         - NanoCPUs: req.CPUQuota * 100 (convert to nanoseconds)\n\t//         - Binds: req.Binds\n\t//         - PortBindings: req.PortBindings\n\t//         - SecurityOpt: append(req.SecurityOpts, \"no-new-privileges\", \"seccomp=...\")\n\t//         - ReadonlyRootfs: true (except for /tmp)\n\t// TODO 4: Call dm.client.ContainerCreate() with configs\n\t// TODO 5: On success, create and return types.Container with:\n\t//         - ID from response\n\t//         - Status: StatusCreated\n\t//         - Labels: req.Labels\n\t//         - CreatedAt: time.Now()\n\t// TODO 6: Handle errors (image pull, invalid config, etc.)\n\treturn nil, nil\n}\n\n// StartContainer starts a previously created container\nfunc (dm *DockerManager) StartContainer(ctx context.Context, containerID string) error {\n\t// TODO 1: Call dm.client.ContainerStart() with containerID\n\t// TODO 2: Handle specific errors (container already running, not found)\n\t// TODO 3: Wait briefly to ensure container is actually running\n\t// TODO 4: Return nil on success, error on failure\n\treturn nil\n}\n\n// ExecuteInContainer runs a command inside a running container\nfunc (dm *DockerManager) ExecuteInContainer(ctx context.Context, containerID string, cmd []string, input io.Reader, output io.Writer) (int, error) {\n\t// TODO 1: Create exec configuration with Cmd, User, Privileged: false\n\t// TODO 2: Call dm.client.ContainerExecCreate() to create exec instance\n\t// TODO 3: Call dm.client.ContainerExecStart() with hijacked response\n\t// TODO 4: Stream input to exec's stdin if provided\n\t// TODO 5: Stream exec's stdout/stderr to output\n\t// TODO 6: Wait for exec to complete with ContainerExecInspect\n\t// TODO 7: Return exit code and any error\n\treturn 0, nil\n}\n\n// StopContainer gracefully stops a running container\nfunc (dm *DockerManager) StopContainer(ctx context.Context, containerID string, timeout time.Duration) error {\n\t// TODO 1: Convert timeout to seconds (Docker uses seconds)\n\t// TODO 2: Call dm.client.ContainerStop() with containerID and timeout\n\t// TODO 3: If force is needed after timeout, call ContainerKill()\n\t// TODO 4: Return error only if both stop and kill fail\n\treturn nil\n}\n\n// RemoveContainer cleans up container resources\nfunc (dm *DockerManager) RemoveContainer(ctx context.Context, containerID string) error {\n\t// TODO 1: Set remove options: RemoveVolumes: true, Force: true, RemoveLinks: false\n\t// TODO 2: Call dm.client.ContainerRemove() with options\n\t// TODO 3: Log warning but don't fail if container doesn't exist (already removed)\n\t// TODO 4: Return actual error only for unexpected failures\n\treturn nil\n}\n\n// GetContainerStats returns current resource usage statistics\nfunc (dm *DockerManager) GetContainerStats(ctx context.Context, containerID string) (*types.ContainerStats, error) {\n\t// TODO 1: Call dm.client.ContainerStats() with containerID and stream: false\n\t// TODO 2: Decode the stats response (types.StatsJSON)\n\t// TODO 3: Calculate CPU percentage: (cpuDelta / systemDelta) * 100\n\t// TODO 4: Extract memory usage, limit, and percentage\n\t// TODO 5: Extract network I/O statistics\n\t// TODO 6: Extract block I/O statistics\n\t// TODO 7: Return types.ContainerStats with all calculated values\n\treturn nil, nil\n}\n\n// ListContainers returns all managed containers matching filter criteria\nfunc (dm *DockerManager) ListContainers(ctx context.Context, filter types.ListFilter) ([]types.Container, error) {\n\t// TODO 1: Build Docker filters from filter.Labels\n\t// TODO 2: Call dm.client.ContainerList() with All: true and filters\n\t// TODO 3: Convert each Docker container to types.Container\n\t// TODO 4: Apply status filtering if filter.Status is specified\n\t// TODO 5: Return slice of matching containers\n\treturn nil, nil\n}\n\n// HealthCheck verifies Docker daemon is operational\nfunc (dm *DockerManager) HealthCheck(ctx context.Context) error {\n\t// TODO 1: Call dm.client.Ping() with context\n\t// TODO 2: Verify API version compatibility\n\t// TODO 3: Check disk space if possible\n\t// TODO 4: Return nil if healthy, error otherwise\n\treturn nil\n}\n```\n\n**executor.go** - Orchestrates container lifecycle for function execution:\n\n```go\npackage execution\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"time\"\n\n\t\"yourproject/internal/containermanager\"\n\t\"yourproject/pkg/types\"\n)\n\n// Executor manages the complete lifecycle of function execution\ntype Executor struct {\n\tcontainerManager containermanager.ContainerManager\n\tmetrics          *types.Metrics\n\tconfig           ExecutorConfig\n}\n\n// ExecutorConfig holds configuration for the executor\ntype ExecutorConfig struct {\n\tDefaultTimeout    time.Duration\n\tMaxMemoryMB       int64\n\tMaxCPUQuota       int64\n\tTempDir           string\n\tBaseImages        map[string]string // runtime -> image\n}\n\n// NewExecutor creates a new function executor\nfunc NewExecutor(cm containermanager.ContainerManager, metrics *types.Metrics, config ExecutorConfig) *Executor {\n\t// TODO 1: Validate config has required fields\n\t// TODO 2: Set defaults for missing values\n\t// TODO 3: Return initialized Executor\n\treturn &Executor{\n\t\tcontainerManager: cm,\n\t\tmetrics:          metrics,\n\t\tconfig:           config,\n\t}\n}\n\n// ExecuteFunction runs a function in an isolated container\nfunc (e *Executor) ExecuteFunction(ctx context.Context, def *types.FunctionDefinition, req *types.InvocationRequest) (*types.InvocationResponse, error) {\n\t// TODO 1: Validate function definition has required fields\n\t// TODO 2: Check if request has already expired (req.IsExpired())\n\t// TODO 3: Create container request from function definition:\n\t//         - Image: e.config.BaseImages[def.Runtime]\n\t//         - Cmd: language-specific command (e.g., [\"/function\", \"handler\"])\n\t//         - Env: combine def.EnvVars with system variables\n\t//         - MemoryLimit: def.MemoryMB * 1024 * 1024\n\t//         - CPUQuota: def.CPUQuota\n\t//         - Labels: map with function name, version, request ID\n\t//         - SecurityOpts: restrictive defaults\n\t// TODO 4: Call e.containerManager.CreateContainer()\n\t// TODO 5: Start container and record start time\n\t// TODO 6: Mount function artifact into container (/function directory)\n\t// TODO 7: Execute the handler with request payload as input\n\t// TODO 8: Capture output and record end time\n\t// TODO 9: Calculate duration, memory usage from stats\n\t// TODO 10: Build InvocationResponse with results\n\t// TODO 11: Always clean up container in defer\n\t// TODO 12: Return response and any execution error\n\treturn nil, nil\n}\n\n// CleanupIdleContainers removes containers that have been idle beyond threshold\nfunc (e *Executor) CleanupIdleContainers(ctx context.Context, idleThreshold time.Duration) error {\n\t// TODO 1: List all containers with function labels\n\t// TODO 2: For each container, check last used time from labels\n\t// TODO 3: If idle longer than threshold, stop and remove\n\t// TODO 4: Log cleanup actions\n\t// TODO 5: Return error only if cleanup fails catastrophically\n\treturn nil\n}\n```\n\n#### Language-Specific Hints\n\n1. **Docker Go SDK**: Use `github.com/docker/docker/client` version `v20.10.17+incompatible` or later. Remember to close responses: `defer response.Body.Close()`.\n\n2. **Resource Limits**: When setting CPU limits, Docker uses nanoseconds of CPU time per second. Convert percentage to nanoseconds: `CPUQuota = percentage * 10000` (e.g., 50% = 500000).\n\n3. **Error Handling**: Docker API calls can fail with `ErrNotFound`, `ErrNotRunning`, etc. Use `client.IsErrNotFound(err)` to check error types.\n\n4. **Context Propagation**: Always pass the context through to Docker API calls to support cancellation and timeouts.\n\n5. **Security**: Generate seccomp profile JSON and pass as string: `SecurityOpt: []string{\"seccomp=\" + profileJSON}`.\n\n6. **Metrics Integration**: Use the `types.Metrics` struct to record container operations: `e.metrics.ContainerOperations.WithLabelValues(\"create\").Inc()`.\n\n#### Milestone Checkpoint\n\nAfter implementing the execution environment, verify it works:\n\n1. **Test Container Creation**:\n   ```bash\n   # Start the server\n   go run cmd/server/main.go\n   \n   # In another terminal, test with curl\n   curl -X POST http://localhost:8080/v1/functions \\\n     -H \"Content-Type: multipart/form-data\" \\\n     -F \"code=@hello.go\" \\\n     -F \"runtime=go\" \\\n     -F \"handler=Handler\" \\\n     -F \"name=test-func\"\n   \n   # Expected: Function created response with version ID\n   ```\n\n2. **Test Function Execution**:\n   ```bash\n   # Invoke the function\n   curl -X POST http://localhost:8080/v1/functions/test-func/invoke \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"name\": \"World\"}'\n   \n   # Expected: Response from function, check Docker containers are created\n   docker ps --filter \"label=function=test-func\"\n   ```\n\n3. **Verify Resource Limits**:\n   ```bash\n   # Check container stats while function is running\n   CONTAINER_ID=$(docker ps -q --filter \"label=function=test-func\")\n   docker stats $CONTAINER_ID\n   \n   # Should show memory limit enforced\n   ```\n\n4. **Test Cleanup**:\n   ```bash\n   # Wait for function timeout + cleanup period\n   sleep 120\n   \n   # Verify containers are removed\n   docker ps -a --filter \"label=function=test-func\"\n   # Expected: No containers (or only exited ones)\n   ```\n\n**Signs of Problems**:\n- **\"Cannot connect to Docker daemon\"**: Docker isn't running or user lacks permissions\n- **\"No such image\"**: Base images not pulled; run `docker pull` for runtime images\n- **\"Permission denied\"**: Security options too restrictive; check seccomp profile\n- **Containers not cleaned up**: Garbage collection not running; check cleanup timer\n\n---\n\n\n## Component Design: Cold Start Optimization\n> **Milestone(s):** Milestone 3\n\n### Mental Model: The Taxi Stand\n\nImagine you're managing a large taxi service in a busy city. There are two ways passengers get rides:\n\n1. **The Taxi Stand Approach:** You maintain a fleet of taxis parked at strategic locations around the city. Each taxi is clean, fueled, and the engine is running. When a passenger arrives, they can immediately get into a waiting taxi and drive away. The taxi driver is already behind the wheel, knows the city layout, and is ready to go. The passenger's journey starts within seconds.\n\n2. **The Custom-Built Approach:** When a passenger arrives, you call a factory to manufacture a new taxi from scratch. Workers assemble the chassis, install the engine, paint the exterior, install seats, and hire/train a driver. Only then can the passenger begin their journey. This process takes minutes, not seconds.\n\n**Cold starts in serverless functions are exactly this problem.** The \"custom-built approach\" represents a true **cold start**: when a function hasn't been invoked recently, the system must:\n- Provision a new execution environment (assemble the taxi)\n- Install the runtime and dependencies (install the engine and seats)\n- Load the function code (train the driver on the specific route)\n- Execute the handler (begin the journey)\n\nThe **taxi stand approach** represents **warm start optimization**: we maintain a pool of pre-initialized, ready-to-go execution environments (warm containers). When a request arrives, we simply assign it to an available warm environment, eliminating most of the startup overhead.\n\nThe key insight is that we're trading **resource efficiency** (keeping idle instances ready consumes memory and CPU) for **performance** (sub-100ms response times). Our design must intelligently balance this trade-off by determining how many taxis to keep idling, where to park them, and when to send them back to the factory for recycling.\n\n### Warm Pool Manager Interface\n\nThe **Warm Pool Manager** is the component responsible for maintaining a pool of pre-initialized `FunctionInstance` objects and allocating them to incoming requests. It serves as the intermediary between the **Request Router** (which needs execution environments) and the **Container Manager** (which creates and destroys them). Think of it as the dispatcher at the taxi stand who tracks which taxis are available, which are currently on trips, and decides when to call for more taxis from the factory.\n\nThe manager operates on two key principles:\n1. **Instance Reuse:** Once a function finishes executing, its container environment is returned to the warm pool (after cleanup) rather than destroyed, ready for the next invocation of the same function.\n2. **Pre-warming:** Based on traffic patterns, the system can proactively create and initialize instances before they're needed, anticipating demand spikes.\n\nHere are the core data structures and interfaces:\n\n| Type/Interface | Purpose |\n|----------------|---------|\n| `WarmPoolManager` | Main interface for managing warm instances |\n| `PoolConfig` | Configuration for pool behavior and limits |\n| `AcquireRequest` | Request to obtain a warm instance |\n| `PoolMetrics` | Metrics tracking pool efficiency and performance |\n\n**Pool Configuration:**\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `MaxWarmInstances` | `int` | Maximum number of warm instances to keep per function (prevents memory bloat) |\n| `MinWarmInstances` | `int` | Minimum number of warm instances to maintain per function (for latency-sensitive workloads) |\n| `InstanceTTL` | `time.Duration` | Maximum lifetime of a warm instance before it's recycled (prevents stale environments) |\n| `IdleTimeout` | `time.Duration` | How long an instance can sit idle in the warm pool before being terminated (scale-to-zero within pool) |\n| `PreWarmThreshold` | `float64` | Request rate threshold that triggers pre-warming (requests per second) |\n| `CleanupInterval` | `time.Duration` | How often to run cleanup of expired/stale instances |\n\n**Warm Pool Manager Interface:**\n\n| Method | Parameters | Returns | Description |\n|--------|------------|---------|-------------|\n| `AcquireWarmInstance` | `ctx context.Context`, `functionName string`, `version string` | `(*FunctionInstance, error)` | Gets a warm instance for the specified function. Creates one if needed and pool limits allow. |\n| `ReleaseInstance` | `ctx context.Context`, `instance *FunctionInstance`, `healthy bool` | `error` | Returns an instance to the pool after execution. If `healthy` is false, the instance is destroyed instead. |\n| `PreWarm` | `ctx context.Context`, `functionName string`, `version string`, `count int` | `error` | Proactively creates `count` warm instances for the function. |\n| `DrainPool` | `ctx context.Context`, `functionName string`, `version string` | `error` | Terminates all warm instances for a function (used during updates or scale-to-zero). |\n| `GetPoolStats` | `ctx context.Context`, `functionName string`, `version string` | `(*PoolStats, error)` | Returns current pool statistics (available instances, total instances, etc.). |\n| `CleanupExpired` | `ctx context.Context` | `error` | Removes instances that have exceeded their TTL or idle timeout. |\n\n**Instance States with Pool Transitions:**\nThe `FunctionInstanceState` machine from our data model expands with pool-specific transitions:\n\n| Current State | Event | Next State | Action Taken |\n|---------------|-------|------------|--------------|\n| `InstanceStateWarm` | `AcquireWarmInstance` called | `InstanceStateActive` | Instance removed from available pool, assigned to request |\n| `InstanceStateActive` | Execution completes | `InstanceStateWarm` | Instance cleaned up (filesystem reset), returned to warm pool |\n| `InstanceStateWarm` | `IdleTimeout` expires | `InstanceStateDraining` | Begin graceful termination (finish any in-progress operations) |\n| `InstanceStateWarm` | `InstanceTTL` expires | `InstanceStateDraining` | Begin graceful termination (instance is stale) |\n| `InstanceStateWarm` | Function version updated | `InstanceStateDraining` | Old version instances are drained during updates |\n| Any state | Container health check fails | `InstanceStateError` | Instance marked unhealthy, removed from pool, replacement created |\n\n> **Design Insight:** The warm pool isn't just about keeping containers running—it's about keeping *initialized* containers. True cold start optimization requires that the runtime environment (language interpreter, loaded libraries, framework initialization) is already prepared. Our warm instances are \"pre-heated\" execution environments with the function code loaded and the handler initialized, ready to process the first instruction immediately.\n\n### ADR: Pooling Strategy - Eager vs. Lazy\n\n> **Decision: Lazy Warm Pool with Predictive Top-Ups**\n> - **Context:** We need to minimize cold starts while avoiding excessive resource consumption. Keeping thousands of instances warm \"just in case\" would waste memory and CPU, especially for infrequently invoked functions. However, waiting for a cold start on every invocation defeats the purpose of optimization.\n> - **Options Considered:**\n>   1. **Eager Pooling (Fixed-Size):** Maintain a fixed number of warm instances per function at all times, regardless of traffic.\n>   2. **Lazy Pooling (On-Demand):** Create warm instances only when a request arrives and no warm instance is available.\n>   3. **Hybrid Predictive:** Use lazy pooling as baseline, but proactively create instances when traffic patterns suggest increased demand.\n> - **Decision:** We choose **Hybrid Predictive** with lazy creation as the default behavior.\n> - **Rationale:** \n>   - **Eager pooling** wastes resources for low-traffic functions (keeping instances warm for hours between invocations).\n>   - **Pure lazy pooling** still incurs cold start latency for the first request after idle periods.\n>   - **Hybrid predictive** gives us the best of both: minimal resource usage during quiet periods, but reduced latency when traffic patterns change. By monitoring request rates and using simple heuristics (like \"if requests-per-second increases by X% over Y seconds, pre-warm Z instances\"), we can anticipate demand without complex ML models.\n> - **Consequences:**\n>   - **Positive:** Good balance of resource efficiency and performance, adaptable to changing workloads.\n>   - **Negative:** Requires implementing traffic pattern analysis and prediction logic, adds complexity.\n>   - **Trade-off:** Some cold starts still occur for truly unpredictable traffic spikes, but this is acceptable for most workloads.\n\n**Options Comparison:**\n\n| Option | Pros | Cons | Why Not Chosen |\n|--------|------|------|----------------|\n| **Eager Pooling** | - Guaranteed zero cold starts for first N concurrent requests<br>- Simple implementation (static pool) | - Wastes resources for infrequent functions<br>- Doesn't adapt to traffic patterns<br>- Higher memory footprint increases hosting costs | Too resource-inefficient for a multi-tenant system where most functions are invoked infrequently |\n| **Lazy Pooling** | - Optimal resource usage (zero idle instances)<br>- Simple to implement | - Every scale-up event incurs cold start latency<br>- Poor user experience during traffic spikes<br>- Could cause request queuing during sudden load | Unacceptable latency during traffic growth; violates performance goals |\n| **Hybrid Predictive** | - Balances resources and performance<br>- Adapts to workload patterns<br>- Can be tuned based on function importance/cost | - More complex implementation<br>- Requires metrics collection and analysis<br>- Prediction can be wrong (false positives waste resources) | **CHOSEN:** Provides the best trade-off for our target workloads; complexity is manageable |\n\n### Common Pitfalls in Cold Start Optimization\n\n⚠️ **Pitfall: Memory Bloat from Unlimited Warm Pools**\n\n**The Mistake:** Keeping an unlimited number of warm instances per function, or setting `MaxWarmInstances` too high. Each warm instance consumes memory (the container's resident memory plus any loaded libraries). If you keep 100 instances warm for a function that uses 256MB each, that's 25GB of RAM occupied—even if the function only gets invoked once per hour.\n\n**Why It's Wrong:** This wastes expensive memory resources and reduces overall system density. In a multi-tenant environment, one greedy function could starve others of resources. It also increases costs for the platform operator.\n\n**How to Fix:** Implement strict per-function limits (`MaxWarmInstances`) based on function tier/plan. Use metrics to monitor pool memory consumption. Implement **instance eviction** policies: when at capacity, evict the least-recently-used warm instance to make room for new ones.\n\n⚠️ **Pitfall: Stale Environment State Between Invocations**\n\n**The Mistake:** Returning a container to the warm pool without properly resetting its state. For example, if a function writes files to `/tmp` or modifies environment variables, those changes persist to the next invocation, potentially leaking data between users or causing unexpected behavior.\n\n**Why It's Wrong:** Violates the principle of isolation between invocations. User A's data could be visible to User B, creating security vulnerabilities. Stateful behavior makes debugging difficult and breaks the \"stateless\" assumption of serverless functions.\n\n**How to Fix:** Implement a **cleanup hook** before returning an instance to the warm pool:\n1. Delete all files in the container's writable filesystem (especially `/tmp`)\n2. Reset environment variables to their original values\n3. Clear any in-memory caches (language runtime specific)\n4. Restart the container's entrypoint process (if possible) to ensure fresh runtime state\nConsider using copy-on-write filesystem layers to efficiently create fresh filesystem state for each invocation.\n\n⚠️ **Pitfall: Over-Complicated Snapshot/Restore Mechanisms**\n\n**The Mistake:** Attempting to implement full container checkpoint/restore (CRIU) or VM snapshotting without understanding the complexity and edge cases. These technologies promise near-instant restores but come with significant limitations: large snapshot files, compatibility issues with certain syscalls, and high implementation complexity.\n\n**Why It's Wrong:** The development time and maintenance burden often outweigh the benefits. Snapshot files can be large (hundreds of MB), requiring significant storage I/O that might negate latency gains. CRIU has limitations with multi-threaded applications, certain kernel versions, and network connections.\n\n**How to Fix:** Start with **simple warm pooling** (keeping containers running), which provides 80% of the benefit with 20% of the complexity. Only consider snapshot/restore for specific use cases after measuring actual cold start bottlenecks. If implemented, use it selectively for large runtimes (like JVM) where initialization is truly expensive, not for lightweight runtimes like Go.\n\n⚠️ **Pitfall: Ignoring Language-Specific Initialization Costs**\n\n**The Mistake:** Treating all runtime environments equally. A pre-initialized Node.js container might start in 50ms, while a JVM container with Spring Boot could take 10 seconds to initialize classes and dependencies.\n\n**Why It's Wrong:** Different runtimes have vastly different cold start characteristics. A one-size-fits-all pooling strategy will either over-provision (wasting resources on fast runtimes) or under-provision (causing unacceptable latency for slow runtimes).\n\n**How to Fix:** Implement **runtime-aware pooling**:\n- Set different `MinWarmInstances` based on runtime (higher for JVM, lower for Go)\n- Use runtime-specific optimizations: for JVM, consider keeping instances in \"warm\" state with classpath pre-loaded but no application context initialized\n- Implement **gradual warmup**: initialize heavy frameworks in the background while serving simple requests\n- Track cold start duration per runtime in metrics and adjust pooling parameters accordingly\n\n### Implementation Guidance for Cold Start\n\n**Technology Recommendations:**\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| **Pool Storage** | In-memory map with mutex synchronization | Redis with distributed locking for multi-node deployments |\n| **Instance Cleanup** | Basic filesystem wipe (`os.RemoveAll`) | Overlay filesystem with fresh writable layer per invocation |\n| **Metrics Collection** | Prometheus counters and gauges | OpenTelemetry with distributed tracing for end-to-end latency analysis |\n| **Predictive Warming** | Simple rate-of-change threshold | Machine learning model trained on historical invocation patterns |\n\n**Recommended File/Module Structure:**\n\n```\nproject-root/\n  cmd/\n    server/main.go                    # Entry point\n  internal/\n    warmpool/                         # Warm pool component\n      manager.go                      # WarmPoolManager implementation\n      config.go                       # PoolConfig and related types\n      metrics.go                      # Pool-specific metrics\n      cleanup.go                      # Instance cleanup utilities\n      poolstore/                      # Storage backend for pool state\n        memory_store.go               # In-memory implementation\n        redis_store.go                # Redis implementation (optional)\n    container/                        # Container management (from Milestone 2)\n      manager.go                      # ContainerManager interface\n      docker_manager.go               # Docker implementation\n    executor/                         # Function execution (uses warm pool)\n      executor.go                     # Executor that acquires/releases instances\n    gateway/                          # HTTP gateway (from Milestone 4)\n      router.go                       # Request routing\n    scaling/                          # Auto-scaling (Milestone 5)\n      scaler.go                       # Uses pool metrics for decisions\n```\n\n**Infrastructure Starter Code - Warm Pool Manager Base Implementation:**\n\n```go\n// internal/warmpool/manager.go\npackage warmpool\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"sync\"\n    \"time\"\n    \n    \"github.com/prometheus/client_golang/prometheus\"\n    \"project/internal/types\"\n    \"project/internal/container\"\n)\n\nvar (\n    // Pool metrics\n    warmPoolSize = prometheus.NewGaugeVec(\n        prometheus.GaugeOpts{\n            Name: \"warm_pool_size\",\n            Help: \"Number of instances in warm pool per function\",\n        },\n        []string{\"function\", \"runtime\"},\n    )\n    coldStarts = prometheus.NewCounterVec(\n        prometheus.CounterOpts{\n            Name: \"cold_starts_total\",\n            Help: \"Total number of cold starts\",\n        },\n        []string{\"function\", \"runtime\"},\n    )\n    poolHits = prometheus.NewCounterVec(\n        prometheus.CounterOpts{\n            Name: \"warm_pool_hits_total\",\n            Help: \"Number of times warm instance was available\",\n        },\n        []string{\"function\", \"runtime\"},\n    )\n    poolMisses = prometheus.NewCounterVec(\n        prometheus.CounterOpts{\n            Name: \"warm_pool_misses_total\",\n            Help: \"Number of times warm instance was not available\",\n        },\n        []string{\"function\", \"runtime\"},\n    )\n)\n\nfunc init() {\n    prometheus.MustRegister(warmPoolSize, coldStarts, poolHits, poolMisses)\n}\n\n// PoolConfig holds configuration for warm pool behavior\ntype PoolConfig struct {\n    MaxWarmInstances   int           // Maximum warm instances per function\n    MinWarmInstances   int           // Minimum warm instances to maintain\n    InstanceTTL        time.Duration // Max lifetime of a warm instance\n    IdleTimeout        time.Duration // Time before idle instance is terminated\n    CleanupInterval    time.Duration // How often to run cleanup\n    PreWarmThreshold   float64       // RPS threshold for pre-warming\n}\n\n// WarmPoolManager manages a pool of warm function instances\ntype WarmPoolManager struct {\n    containerManager container.ContainerManager\n    config           PoolConfig\n    store            PoolStore\n    metrics          *types.Metrics\n    cleanupTicker    *time.Ticker\n    mu               sync.RWMutex\n    \n    // Function definitions cache for creating new instances\n    functionDefs map[string]*types.FunctionDefinition\n}\n\n// NewWarmPoolManager creates a new warm pool manager\nfunc NewWarmPoolManager(cm container.ContainerManager, config PoolConfig, metrics *types.Metrics) *WarmPoolManager {\n    wpm := &WarmPoolManager{\n        containerManager: cm,\n        config:           config,\n        store:            NewMemoryStore(),\n        metrics:          metrics,\n        functionDefs:     make(map[string]*types.FunctionDefinition),\n        cleanupTicker:    time.NewTicker(config.CleanupInterval),\n    }\n    \n    // Start background cleanup goroutine\n    go wpm.cleanupLoop()\n    \n    return wpm\n}\n\n// AcquireWarmInstance gets a warm instance for a function\nfunc (wpm *WarmPoolManager) AcquireWarmInstance(ctx context.Context, functionName, version string) (*types.FunctionInstance, error) {\n    // TODO 1: Generate a composite key from functionName and version\n    // TODO 2: Check if a warm instance is available in the store\n    // TODO 3: If available: remove from pool, update metrics (poolHits), update instance state to ACTIVE, return it\n    // TODO 4: If not available: update metrics (poolMisses, coldStarts)\n    // TODO 5: Check if we're below MaxWarmInstances limit for this function\n    // TODO 6: If under limit: create a new instance (cold start), set state to ACTIVE, return it\n    // TODO 7: If at limit: wait for an instance to become available (with timeout) or return error\n    return nil, fmt.Errorf(\"not implemented\")\n}\n\n// ReleaseInstance returns an instance to the pool after execution\nfunc (wpm *WarmPoolManager) ReleaseInstance(ctx context.Context, instance *types.FunctionInstance, healthy bool) error {\n    // TODO 1: If instance is not healthy: destroy it completely, return nil\n    // TODO 2: Clean up the instance: reset filesystem, clear environment state\n    // TODO 3: Check if instance has exceeded InstanceTTL\n    // TODO 4: If exceeded TTL: destroy it, return nil\n    // TODO 5: Update instance state to WARM, set LastUsedAt to now\n    // TODO 6: Add instance back to the pool store\n    // TODO 7: Update warmPoolSize metrics\n    return fmt.Errorf(\"not implemented\")\n}\n\n// PreWarm proactively creates warm instances\nfunc (wpm *WarmPoolManager) PreWarm(ctx context.Context, functionName, version string, count int) error {\n    // TODO 1: Get current warm instance count for this function\n    // TODO 2: Calculate how many new instances to create (respecting MaxWarmInstances)\n    // TODO 3: For each instance to create: launch async creation goroutine\n    // TODO 4: Each goroutine: create container, initialize it, add to warm pool\n    // TODO 5: Return early (don't wait for all instances to be ready)\n    return fmt.Errorf(\"not implemented\")\n}\n\n// cleanupLoop runs periodic cleanup of expired instances\nfunc (wpm *WarmPoolManager) cleanupLoop() {\n    for range wpm.cleanupTicker.C {\n        wpm.cleanupExpired(context.Background())\n    }\n}\n\nfunc (wpm *WarmPoolManager) cleanupExpired(ctx context.Context) error {\n    // TODO 1: Iterate through all instances in the store\n    // TODO 2: For each instance: check if IdleTimeout has expired\n    // TODO 3: If expired: remove from pool, destroy container\n    // TODO 4: Update warmPoolSize metrics\n    return nil\n}\n```\n\n**Core Logic Skeleton Code - Instance Cleanup Hook:**\n\n```go\n// internal/warmpool/cleanup.go\npackage warmpool\n\nimport (\n    \"context\"\n    \"os\"\n    \"path/filepath\"\n    \n    \"project/internal/container\"\n    \"project/internal/types\"\n)\n\n// CleanupInstance resets an instance to a clean state before returning to pool\nfunc CleanupInstance(ctx context.Context, cm container.ContainerManager, instance *types.FunctionInstance) error {\n    // TODO 1: Clean filesystem - execute command in container to delete all files in /tmp\n    // Hint: Use cm.ExecuteInContainer with command: [\"sh\", \"-c\", \"rm -rf /tmp/*\"]\n    \n    // TODO 2: Reset environment variables - restart the container's entrypoint process\n    // Hint: For Docker: stop and start the container (or send signal to restart process)\n    \n    // TODO 3: Clear runtime-specific caches\n    // Hint: Detect runtime from instance and apply runtime-specific cleanup\n    // - Node.js: Clear require.cache? (difficult in separate process)\n    // - Python: Might need to restart Python process entirely\n    // - JVM: Consider keeping JVM warm but reset application context\n    \n    // TODO 4: Verify container health (run a simple echo command)\n    // TODO 5: If any cleanup step fails, mark instance as unhealthy\n    \n    return nil\n}\n\n// Runtime-specific cleanup strategies\ntype RuntimeCleaner interface {\n    Clean(ctx context.Context, containerID string) error\n}\n\nfunc GetCleanerForRuntime(runtime string) RuntimeCleaner {\n    switch runtime {\n    case \"go\":\n        return &GoCleaner{}\n    case \"python\":\n        return &PythonCleaner{}\n    case \"node\":\n        return &NodeJSCleaner{}\n    case \"java\":\n        return &JavaCleaner{}\n    default:\n        return &GenericCleaner{}\n    }\n}\n```\n\n**Integration with Executor - Modified ExecuteFunction Method:**\n\n```go\n// internal/executor/executor.go - Modified from Milestone 2\nfunc (e *Executor) ExecuteFunction(ctx context.Context, def *types.FunctionDefinition, req *types.InvocationRequest) (*types.InvocationResponse, error) {\n    // TODO 1: Acquire warm instance from pool (instead of creating new container)\n    instance, err := e.warmPool.AcquireWarmInstance(ctx, def.Name, req.FunctionVersion)\n    if err != nil {\n        return nil, fmt.Errorf(\"failed to acquire instance: %w\", err)\n    }\n    \n    // TODO 2: If instance is nil (pool empty and at max capacity), wait or return error\n    \n    // TODO 3: Execute function in the acquired container\n    // ... existing execution logic from Milestone 2 ...\n    \n    // TODO 4: After execution completes, release instance back to pool\n    defer func() {\n        // Pass true if execution succeeded, false if container should be destroyed\n        healthy := (err == nil)\n        releaseErr := e.warmPool.ReleaseInstance(ctx, instance, healthy)\n        if releaseErr != nil {\n            // Log error but don't fail the invocation\n            e.metrics.ContainerOperations.WithLabelValues(\"release_failed\").Inc()\n        }\n    }()\n    \n    // ... rest of execution ...\n}\n```\n\n**Language-Specific Hints for Go:**\n\n1. **Concurrency Management:** Use `sync.RWMutex` for pool store access—multiple goroutines can read concurrently, but only one can write. For the pool store map: `map[string][]*FunctionInstance`.\n\n2. **Background Goroutines:** Use `context.Context` to gracefully stop the cleanup goroutine on shutdown:\n   ```go\n   go func() {\n       for {\n           select {\n           case <-ctx.Done():\n               return\n           case <-wpm.cleanupTicker.C:\n               wpm.cleanupExpired(ctx)\n           }\n       }\n   }()\n   ```\n\n3. **Metrics Collection:** Use Prometheus histogram for cold start duration:\n   ```go\n   coldStartDuration := prometheus.NewHistogramVec(\n       prometheus.HistogramOpts{\n           Name: \"cold_start_duration_ms\",\n           Help: \"Duration of cold starts in milliseconds\",\n           Buckets: []float64{10, 50, 100, 200, 500, 1000, 5000},\n       },\n       []string{\"function\", \"runtime\"},\n   )\n   ```\n\n4. **Instance Identification:** Create a unique key for each function version:\n   ```go\n   func poolKey(functionName, version string) string {\n       return fmt.Sprintf(\"%s:%s\", functionName, version)\n   }\n   ```\n\n**Milestone Checkpoint Verification:**\n\nAfter implementing the warm pool, verify the following behaviors:\n\n1. **Cold Start Reduction:**\n   ```\n   # Send two requests sequentially with a small delay\n   curl -X POST http://localhost:8080/functions/myfunc\n   # First request should show \"cold_start: true\" in logs or metrics\n   \n   curl -X POST http://localhost:8080/functions/myfunc  \n   # Second request should show \"cold_start: false\" (warm start)\n   ```\n\n2. **Pool Metrics Exposure:**\n   ```\n   curl http://localhost:9090/metrics | grep warm_pool\n   # Should see:\n   # warm_pool_size{function=\"myfunc\",runtime=\"go\"} 1\n   # warm_pool_hits_total{function=\"myfunc\",runtime=\"go\"} 1\n   ```\n\n3. **Instance Cleanup Verification:**\n   ```\n   # Check container count before and after idle timeout\n   docker ps | grep myfunc\n   # Wait for IdleTimeout duration (e.g., 5 minutes)\n   # Check again - idle instances should be removed\n   ```\n\n4. **Concurrent Request Handling:**\n   ```\n   # Send 10 concurrent requests\n   for i in {1..10}; do\n     curl -X POST http://localhost:8080/functions/myfunc &\n   done\n   # Should see multiple warm instances created (up to MaxWarmInstances)\n   # Check warm_pool_size metric\n   ```\n\n**Common Debugging Tips:**\n\n| Symptom | Likely Cause | How to Diagnose | Fix |\n|---------|--------------|-----------------|-----|\n| **All requests show cold starts** | Warm pool not being populated | Check if `ReleaseInstance` is being called after execution | Ensure executor calls `ReleaseInstance` in `defer` |\n| **Memory usage grows indefinitely** | Instances not being cleaned up | Check `cleanupExpired` logs; verify `IdleTimeout` is > 0 | Ensure cleanup goroutine is running; check for deadlocks |\n| **Instance reuse causes state leakage** | Cleanup not working properly | Add debug logs in `CleanupInstance`; check `/tmp` contents in container | Ensure cleanup commands execute successfully in container |\n| **High latency on first request after idle** | `MinWarmInstances` set to 0 | Check pool size metrics during idle period | Increase `MinWarmInstances` or implement predictive warming |\n| **\"Too many warm instances\" errors** | `MaxWarmInstances` too low for concurrent load | Monitor concurrent request rate vs pool size | Increase `MaxWarmInstances` or implement request queuing |\n\n---\n\n\n## Component Design: Request Routing\n> **Milestone(s):** Milestone 4\n\nThe request routing component serves as the system's **front door**—it receives incoming function invocation requests, determines which function instance should handle each request, manages request flow when all instances are busy, and ensures reliable delivery even during scaling events and failures. This component bridges external HTTP traffic with the internal execution infrastructure, making critical decisions about load distribution, timeout handling, and concurrency management.\n\n### Mental Model: The Restaurant Host and Waitlist\n\nImagine a popular restaurant with multiple identical dining rooms (function instances). When customers (requests) arrive, they're greeted by a host (gateway) who must decide:\n\n1. **Which dining room to seat them in**: The host looks at currently available rooms (warm instances) that match the requested cuisine type (function). If multiple rooms are available, the host uses a strategy (load balancing) to distribute customers evenly.\n\n2. **What to do when all rooms are full**: The host maintains a waitlist (request queue) where new arrivals wait for the next available room. The waitlist has limited capacity to prevent overcrowding in the entrance area (memory exhaustion).\n\n3. **When to turn customers away**: If the waitlist is full, or if customers have been waiting too long (timeout), the host politely informs them they cannot be served today (returns an error).\n\n4. **How to handle special requests**: Some customers request a specific room they've used before (sticky routing for stateful functions), while others don't care. Some customers want to wait for their meal (synchronous invocation), while others leave their phone number and want to be called when it's ready (asynchronous invocation).\n\nThis mental model captures the core responsibilities of request routing: **matching**, **queueing**, **timeout management**, and **load distribution** while maintaining system stability under varying load.\n\n### Gateway API and Internal Routing\n\nThe gateway exposes a simple HTTP API that accepts function invocation requests and routes them to appropriate function instances. Internally, it implements a sophisticated routing engine that considers instance availability, load, and health status.\n\n#### Public HTTP Gateway API\n\nThe gateway accepts HTTP POST requests at `/invoke/{functionName}` with the following characteristics:\n\n| Request Component | Specification | Purpose |\n|------------------|---------------|---------|\n| **URL Path** | `/invoke/{functionName}[:{versionTag}]` | Identifies the target function and optional version (default: latest) |\n| **HTTP Method** | POST | All invocation types use POST to include payload |\n| **Headers** | `X-Function-Timeout`: Override default timeout (milliseconds)<br>`X-Synchronous`: \"true\"/\"false\" (default: true)<br>`X-Callback-URL`: For async invocations<br>`X-Request-ID`: Client-provided correlation ID | Control invocation behavior and metadata |\n| **Body** | Arbitrary bytes (content-type preserved) | Function input payload |\n| **Query Params** | `async=true`, `timeout=5000`, `version=v1.2` | Alternative to headers for simpler clients |\n\nThe gateway returns:\n- **200 OK** with function output in body for synchronous invocations\n- **202 Accepted** with `X-Request-ID` for asynchronous invocations\n- **429 Too Many Requests** when request queue is full\n- **503 Service Unavailable** when function is scaling or unhealthy\n- **504 Gateway Timeout** when function execution exceeds timeout\n\n#### Internal Routing Mechanism\n\nWhen a request arrives, the gateway follows this routing pipeline:\n\n1. **Request Validation**: Parse and validate the function name, version, timeout, and payload size.\n2. **Function Resolution**: Resolve the function name to a specific `FunctionDefinition` and check if it's active.\n3. **Instance Selection**: Use the load balancing strategy to select an appropriate `FunctionInstance`.\n4. **Queue Management**: If no instances are available, attempt to queue the request (if synchronous and queue not full).\n5. **Request Forwarding**: Forward the request to the selected instance via HTTP or gRPC.\n6. **Response Handling**: Collect the response, apply any transformations, and return to client.\n7. **Error Recovery**: Handle instance failures with retries (when appropriate) and circuit breaking.\n\nThe internal routing table maintains a mapping from function name to available instances:\n\n| Routing Table Entry Field | Type | Description |\n|---------------------------|------|-------------|\n| `FunctionName` | `string` | Unique function identifier |\n| `ActiveInstances` | `[]*FunctionInstance` | Instances in `InstanceStateWarm` or `InstanceStateActive` state |\n| `PendingRequests` | `*RequestQueue` | Queue of requests waiting for instances |\n| `ConcurrentInvocations` | `int` | Current number of in-flight requests |\n| `MaxConcurrency` | `int` | Maximum concurrent executions allowed |\n| `CircuitBreaker` | `*CircuitBreaker` | Tracks instance health for fail-fast behavior |\n| `LastScaleUpTime` | `time.Time` | When last scale-up occurred (for cooldown) |\n\n#### Instance Selection Algorithm\n\nThe instance selection process follows these steps:\n\n1. **Filter by state**: Only consider instances with `IsActive() == true` (typically `InstanceStateWarm` or `InstanceStateActive` but not `InstanceStateDraining`).\n2. **Apply stickiness**: If `InvocationRequest.PreferredInstanceID` is set and that instance is active, use it (for stateful functions).\n3. **Check circuit breakers**: Skip instances marked as unhealthy (recent failures exceed threshold).\n4. **Apply load balancing strategy**: Use the configured strategy (round-robin, least-connections, etc.) to select from remaining instances.\n5. **Fallback to queuing**: If no instances available, attempt to queue (for synchronous requests) or immediately fail (for async if no retry capacity).\n\n#### Request Queue Design\n\nThe request queue buffers incoming requests when all instances are busy. It's implemented as a bounded priority queue:\n\n| Queue Characteristic | Specification | Rationale |\n|----------------------|---------------|-----------|\n| **Maximum Size** | Configurable per function (default: 100) | Prevents memory exhaustion during traffic spikes |\n| **Priority Scheme** | FIFO with optional priority based on timeout | Ensures fairness; requests with earlier deadlines get priority |\n| **Eviction Policy** | Oldest requests evicted when queue full (configurable) | Better to fail fast than stall entire system |\n| **Queue Drain** | On scale-up, drain queue to new instances | Utilizes new capacity immediately |\n| **Monitoring** | Queue depth, wait time, eviction count metrics | Essential for capacity planning |\n\n### ADR: Load Balancing Strategy\n\n> **Decision: Least-Connections with Circuit Breaking**\n> - **Context**: We need to distribute requests across multiple function instances to maximize throughput, minimize latency, and handle instance failures gracefully. The strategy must work with auto-scaling (instances come and go) and support both stateless and stateful functions.\n> - **Options Considered**:\n>   1. **Round-Robin**: Simple rotation through available instances\n>   2. **Least-Connections**: Send to instance with fewest active requests\n>   3. **Consistent Hashing**: Map requests to specific instances based on request attributes\n> - **Decision**: Least-connections as the default, with optional consistent hashing for stateful functions via `PreferredInstanceID`.\n> - **Rationale**: Least-connections naturally balances load when instances have variable execution times (common in serverless). It prevents overloading slow instances and works well with auto-scaling as new instances start with zero connections. Round-robin can overload instances processing long requests. Consistent hashing adds complexity but is valuable for stateful functions, which we support through explicit instance preference rather than automatic hashing.\n> - **Consequences**: Requires tracking active invocation count per instance (already needed for scaling). Adds slight overhead vs. round-robin but provides better load distribution. Stateful functions need client cooperation to specify preferred instance.\n\n| Option | Pros | Cons | Chosen? |\n|--------|------|------|---------|\n| **Round-Robin** | Simple, predictable, no state needed | Can overload instances with long-running requests, doesn't account for instance capacity differences | No (fallback when connection counts unavailable) |\n| **Least-Connections** | Adapts to instance performance variations, naturally balances load, works well with auto-scaling | Requires tracking per-instance invocation counts, slightly more complex | **Yes** (default strategy) |\n| **Consistent Hashing** | Enables sticky sessions for stateful functions, good cache locality | Complex implementation, rehashing on scale events disrupts stickiness, uneven load distribution | Partially (via `PreferredInstanceID` for explicit stickiness) |\n\n### Common Pitfalls in Request Routing\n\n⚠️ **Pitfall: Unbounded Queue Growth**\n- **Description**: Allowing request queues to grow without limits during traffic spikes.\n- **Why it's wrong**: Exhausts system memory, increases latency unpredictably, and can cause cascading failures when queues consume all available RAM.\n- **How to avoid**: Implement **bounded queues** with configurable maximum size per function. Monitor queue depth and implement queue pressure signals to upstream clients (HTTP 429). Consider multiple queue tiers: in-memory for short bursts, disk-backed for important async workloads.\n\n⚠️ **Pitfall: Thundering Herd on Scale-Up**\n- **Description**: When a function scales from zero, all queued requests simultaneously rush to the single new instance, overwhelming it.\n- **Why it's wrong**: Causes immediate timeout or failure of the new instance, triggering unhealthy marks and potential scale oscillation.\n- **How to avoid**: Implement **gradual queue draining** - release requests to new instances at a controlled rate (e.g., max N per second). Use **per-instance concurrency limits** to prevent overloading single instances. Consider **delayed scaling** where you wait for multiple instances before draining queue.\n\n⚠️ **Pitfall: Improper Timeout Handling**\n- **Description**: Not propagating or respecting timeouts correctly through the routing chain.\n- **Why it's wrong**: Client receives timeout after function continues executing (wasting resources), or function times out before client deadline causing unnecessary retries.\n- **How to avoid**: Implement **timeout deadline propagation** from client request through all routing layers to function execution. Use a **timeout hierarchy**: client timeout > gateway timeout > function timeout. Always cancel downstream operations when upstream timeout occurs.\n\n⚠️ **Pitfall: Ignoring Cold Start Latency in Routing Decisions**\n- **Description**: Routing requests to cold instances when warm ones are available, or not accounting for cold start time in queue wait calculations.\n- **Why it's wrong**: Increases tail latency unpredictably, especially for low-traffic functions.\n- **How to avoid**: Track instance **warm/cold status** and prefer warm instances. Adjust queue timeout calculations to include estimated cold start time. Implement **predictive pre-warming** based on queue depth and historical patterns.\n\n⚠️ **Pitfall: No Circuit Breaking for Unhealthy Instances**\n- **Description**: Continuing to route requests to instances that are failing or slow.\n- **Why it's wrong**: Degrades overall system performance, amplifies failures, and creates negative user experience.\n- **How to avoid**: Implement **circuit breaker pattern** per instance: track failure rates and temporarily remove instances from rotation after threshold breaches. Combine with health checks for proactive failure detection. Allow **gradual recovery** (probation period) for healed instances.\n\n### Implementation Guidance for Routing\n\n#### Technology Recommendations Table\n\n| Component | Simple Option | Advanced Option | Recommendation |\n|-----------|---------------|-----------------|----------------|\n| **HTTP Gateway** | Go `net/http` with middleware | `gorilla/mux` for routing, `chi` for middleware | `net/http` with custom routing (keeps dependencies minimal) |\n| **Load Balancer** | In-memory round-robin | Distributed consistent hashing with rendezvous hashing | Least-connections with atomic counters |\n| **Request Queue** | Go channel with buffer | Disk-backed queue (Redis, Kafka) for persistence | Bounded channel queue with priority via heap |\n| **Circuit Breaker** | Simple counter with timeout | Adaptive breaker with rolling windows | `github.com/sony/gobreaker` or similar |\n| **Metrics** | Prometheus counters/gauges | Distributed tracing (OpenTelemetry) | Prometheus for metrics, context propagation for traces |\n\n#### Recommended File/Module Structure\n\n```\nproject-root/\n  cmd/\n    gateway/                    # Gateway entry point\n      main.go                   # Starts HTTP gateway server\n  internal/\n    gateway/                    # Request routing component\n      gateway.go                # Main gateway struct and HTTP handlers\n      router.go                 # Routing logic and load balancing\n      queue/                    # Request queue implementation\n        queue.go                # Bounded priority queue\n        manager.go              # Queue lifecycle management\n      circuit/                  # Circuit breaker implementation\n        breaker.go              # Circuit breaker logic\n        health_check.go         # Instance health checks\n      middleware/               # HTTP middleware\n        logging.go              # Request logging\n        metrics.go              # Prometheus metrics\n        timeout.go              # Deadline propagation\n      api/                      # Gateway API definitions\n        models.go               # Request/response types\n        errors.go               # Gateway-specific errors\n    controller/                 # (Referenced, not in this component)\n    worker/                     # (Referenced, not in this component)\n    types/                      # Shared types (already defined)\n```\n\n#### Infrastructure Starter Code\n\n**Complete HTTP Gateway Server** (ready to use):\n\n```go\n// internal/gateway/gateway.go\npackage gateway\n\nimport (\n    \"context\"\n    \"encoding/json\"\n    \"fmt\"\n    \"net/http\"\n    \"strconv\"\n    \"time\"\n    \n    \"github.com/yourproject/internal/types\"\n    \"github.com/prometheus/client_golang/prometheus\"\n    \"github.com/prometheus/client_golang/prometheus/promhttp\"\n)\n\n// Gateway is the main HTTP gateway for function invocations\ntype Gateway struct {\n    router         *Router\n    queueManager   *queue.Manager\n    metrics        *gatewayMetrics\n    config         GatewayConfig\n    server         *http.Server\n}\n\n// GatewayConfig holds gateway configuration\ntype GatewayConfig struct {\n    Addr                 string\n    MaxRequestBodyBytes  int64\n    DefaultTimeout       time.Duration\n    EnableMetrics        bool\n    MetricsPath          string\n    HealthCheckPath      string\n}\n\n// gatewayMetrics holds Prometheus metrics for the gateway\ntype gatewayMetrics struct {\n    requestsTotal      *prometheus.CounterVec\n    requestDuration    *prometheus.HistogramVec\n    queueDepth         *prometheus.GaugeVec\n    activeInvocations  prometheus.Gauge\n    errorsTotal        *prometheus.CounterVec\n}\n\n// NewGateway creates a new gateway instance\nfunc NewGateway(router *Router, qm *queue.Manager, config GatewayConfig) *Gateway {\n    gm := &gatewayMetrics{\n        requestsTotal: prometheus.NewCounterVec(\n            prometheus.CounterOpts{\n                Name: \"gateway_requests_total\",\n                Help: \"Total number of HTTP requests processed\",\n            },\n            []string{\"function\", \"method\", \"status\"},\n        ),\n        requestDuration: prometheus.NewHistogramVec(\n            prometheus.HistogramOpts{\n                Name:    \"gateway_request_duration_seconds\",\n                Help:    \"HTTP request duration in seconds\",\n                Buckets: prometheus.DefBuckets,\n            },\n            []string{\"function\", \"method\"},\n        ),\n        queueDepth: prometheus.NewGaugeVec(\n            prometheus.GaugeOpts{\n                Name: \"gateway_queue_depth\",\n                Help: \"Current depth of request queues\",\n            },\n            []string{\"function\"},\n        ),\n        activeInvocations: prometheus.NewGauge(\n            prometheus.GaugeOpts{\n                Name: \"gateway_active_invocations\",\n                Help: \"Number of currently active function invocations\",\n            },\n        ),\n        errorsTotal: prometheus.NewCounterVec(\n            prometheus.CounterOpts{\n                Name: \"gateway_errors_total\",\n                Help: \"Total number of gateway errors by type\",\n            },\n            []string{\"function\", \"error_type\"},\n        ),\n    }\n    \n    prometheus.MustRegister(\n        gm.requestsTotal,\n        gm.requestDuration,\n        gm.queueDepth,\n        gm.activeInvocations,\n        gm.errorsTotal,\n    )\n    \n    return &Gateway{\n        router:       router,\n        queueManager: qm,\n        metrics:      gm,\n        config:       config,\n    }\n}\n\n// Start begins serving HTTP requests\nfunc (g *Gateway) Start() error {\n    mux := http.NewServeMux()\n    \n    // Main invocation endpoint\n    mux.HandleFunc(\"/invoke/\", g.invokeHandler)\n    \n    // Health check endpoint\n    mux.HandleFunc(g.config.HealthCheckPath, func(w http.ResponseWriter, r *http.Request) {\n        w.WriteHeader(http.StatusOK)\n        w.Write([]byte(\"OK\"))\n    })\n    \n    // Metrics endpoint (optional)\n    if g.config.EnableMetrics {\n        mux.Handle(g.config.MetricsPath, promhttp.Handler())\n    }\n    \n    // Apply middleware chain\n    handler := g.applyMiddleware(mux)\n    \n    g.server = &http.Server{\n        Addr:         g.config.Addr,\n        Handler:      handler,\n        ReadTimeout:  30 * time.Second,\n        WriteTimeout: 30 * time.Second,\n    }\n    \n    return g.server.ListenAndServe()\n}\n\n// Shutdown gracefully stops the gateway\nfunc (g *Gateway) Shutdown(ctx context.Context) error {\n    return g.server.Shutdown(ctx)\n}\n\n// applyMiddleware chains middleware in correct order\nfunc (g *Gateway) applyMiddleware(h http.Handler) http.Handler {\n    // Order matters: last added = first executed\n    h = timeoutMiddleware(g.config.DefaultTimeout)(h)\n    h = metricsMiddleware(g.metrics)(h)\n    h = loggingMiddleware()(h)\n    h = recoveryMiddleware()(h)\n    h = sizeLimitMiddleware(g.config.MaxRequestBodyBytes)(h)\n    return h\n}\n\n// invokeHandler handles /invoke/{functionName} requests\nfunc (g *Gateway) invokeHandler(w http.ResponseWriter, r *http.Request) {\n    start := time.Now()\n    \n    // Extract function name from path\n    functionName := extractFunctionName(r.URL.Path)\n    if functionName == \"\" {\n        http.Error(w, \"Function name required\", http.StatusBadRequest)\n        return\n    }\n    \n    // Parse invocation parameters\n    req, err := g.parseInvocationRequest(r, functionName)\n    if err != nil {\n        http.Error(w, err.Error(), http.StatusBadRequest)\n        return\n    }\n    \n    // Route the request\n    resp, err := g.router.Route(r.Context(), req)\n    \n    // Record metrics\n    status := \"200\"\n    if err != nil {\n        status = errorToStatusCode(err)\n    }\n    g.metrics.requestsTotal.WithLabelValues(\n        functionName, \n        r.Method, \n        status,\n    ).Inc()\n    g.metrics.requestDuration.WithLabelValues(\n        functionName, \n        r.Method,\n    ).Observe(time.Since(start).Seconds())\n    \n    // Write response\n    if err != nil {\n        g.writeError(w, err)\n        return\n    }\n    \n    w.Header().Set(\"Content-Type\", \"application/octet-stream\")\n    w.Header().Set(\"X-Request-ID\", resp.RequestID)\n    w.Header().Set(\"X-Instance-ID\", resp.InstanceID)\n    w.WriteHeader(http.StatusOK)\n    w.Write(resp.Payload)\n}\n\n// Helper functions (implemented elsewhere)\nfunc extractFunctionName(path string) string { /* implementation */ }\nfunc (g *Gateway) parseInvocationRequest(r *http.Request, fn string) (*types.InvocationRequest, error) { /* implementation */ }\nfunc errorToStatusCode(err error) string { /* implementation */ }\nfunc (g *Gateway) writeError(w http.ResponseWriter, err error) { /* implementation */ }\n```\n\n#### Core Logic Skeleton Code\n\n**Router with Least-Connections Load Balancing**:\n\n```go\n// internal/gateway/router.go\npackage gateway\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"sync\"\n    \"sync/atomic\"\n    \"time\"\n    \n    \"github.com/yourproject/internal/types\"\n)\n\n// Router manages routing of invocation requests to function instances\ntype Router struct {\n    mu              sync.RWMutex\n    functions       map[string]*functionRoutingTable\n    instanceManager InstanceManager // Interface to manage instances\n    config          RouterConfig\n}\n\n// functionRoutingTable tracks instances and routing state for a single function\ntype functionRoutingTable struct {\n    functionName     string\n    instances        []*routedInstance\n    concurrencyLimit int32\n    activeCount      int32 // Atomic counter\n    circuitBreaker   *circuit.Breaker\n    lastScaleUpTime  time.Time\n}\n\n// routedInstance wraps a FunctionInstance with routing metadata\ntype routedInstance struct {\n    instance      *types.FunctionInstance\n    activeReqs    int32 // Atomic counter for least-connections\n    lastUsed      time.Time\n    failures      int32 // Recent failure count for circuit breaking\n    healthy       bool\n}\n\n// RouterConfig holds routing configuration\ntype RouterConfig struct {\n    DefaultConcurrencyLimit int\n    CircuitBreakerThreshold int\n    CircuitBreakerTimeout   time.Duration\n    StickySessionTTL        time.Duration\n}\n\n// NewRouter creates a new router\nfunc NewRouter(im InstanceManager, config RouterConfig) *Router {\n    return &Router{\n        functions:       make(map[string]*functionRoutingTable),\n        instanceManager: im,\n        config:          config,\n    }\n}\n\n// Route routes an invocation request to an appropriate instance\nfunc (r *Router) Route(ctx context.Context, req *types.InvocationRequest) (*types.InvocationResponse, error) {\n    // TODO 1: Validate request is not expired (check req.IsExpired())\n    // TODO 2: Lookup or create routing table for this function (use getOrCreateRoutingTable)\n    // TODO 3: Check if function is at concurrency limit (compare activeCount vs limit)\n    // TODO 4: If at limit and request is synchronous, attempt to queue (via queueManager)\n    // TODO 5: Select instance using least-connections strategy (call selectInstance)\n    // TODO 6: If no instance available but can scale, trigger scale-up and queue request\n    // TODO 7: Forward request to selected instance (call forwardRequest)\n    // TODO 8: On success, update instance metrics and return response\n    // TODO 9: On failure, mark instance unhealthy, update circuit breaker, and retry if appropriate\n    // TODO 10: Ensure atomic updates to activeCount and instance activeReqs counters\n    // Hint: Use context.WithTimeout to ensure forwarding doesn't exceed request deadline\n    // Hint: Implement retry logic only for idempotent operations (check request metadata)\n    return nil, fmt.Errorf(\"not implemented\")\n}\n\n// selectInstance chooses an instance using least-connections strategy\nfunc (r *Router) selectInstance(rt *functionRoutingTable, req *types.InvocationRequest) (*routedInstance, error) {\n    r.mu.RLock()\n    defer r.mu.RUnlock()\n    \n    // TODO 1: Filter instances to only healthy, active ones (InstanceStateWarm or InstanceStateActive)\n    // TODO 2: If req.PreferredInstanceID is set, try to use that instance if available and healthy\n    // TODO 3: Among remaining instances, find the one with lowest activeReqs count\n    // TODO 4: Handle tie-breakers (e.g., oldest instance, most recently used)\n    // TODO 5: If no instances available, return appropriate error (ErrNoInstancesAvailable)\n    // TODO 6: Increment the selected instance's activeReqs count atomically\n    // Hint: Use atomic.LoadInt32 to read counters without full lock\n    // Hint: Consider weighted least-connections if instances have different capacities\n    return nil, fmt.Errorf(\"not implemented\")\n}\n\n// forwardRequest sends the request to a specific instance\nfunc (r *Router) forwardRequest(ctx context.Context, instance *routedInstance, req *types.InvocationRequest) (*types.InvocationResponse, error) {\n    // TODO 1: Build HTTP/gRPC request to instance endpoint (instance.instance.Host:Port)\n    // TODO 2: Copy original request headers and body\n    // TODO 3: Propagate timeout: calculate remaining time from ctx.Deadline()\n    // TODO 4: Send request and await response\n    // TODO 5: Parse response into InvocationResponse struct\n    // TODO 6: Handle transport errors (network issues) vs. function errors (returned in response)\n    // TODO 7: Update instance.lastUsed timestamp on success\n    // TODO 8: On timeout, cancel the request and mark instance for health check\n    // Hint: Use http.Client with timeout or context-aware transport\n    // Hint: Consider connection pooling to instances for performance\n    return nil, fmt.Errorf(\"not implemented\")\n}\n\n// updateInstanceHealth updates circuit breaker based on success/failure\nfunc (r *Router) updateInstanceHealth(instance *routedInstance, success bool) {\n    // TODO 1: If success, reset failure count and mark healthy\n    // TODO 2: If failure, increment failure count atomically\n    // TODO 3: If failure count exceeds threshold, mark instance unhealthy\n    // TODO 4: Schedule health check for unhealthy instances after timeout\n    // TODO 5: Notify instance manager to potentially terminate and replace instance\n    // Hint: Use exponential backoff for health check retries\n}\n```\n\n**Bounded Priority Request Queue**:\n\n```go\n// internal/gateway/queue/queue.go\npackage queue\n\nimport (\n    \"container/heap\"\n    \"context\"\n    \"sync\"\n    \"time\"\n    \n    \"github.com/yourproject/internal/types\"\n)\n\n// QueuedRequest represents a request waiting for an instance\ntype QueuedRequest struct {\n    Request    *types.InvocationRequest\n    EnqueuedAt time.Time\n    Priority   int // Lower number = higher priority\n    index      int // Required by heap.Interface\n}\n\n// RequestQueue implements a bounded priority queue\ntype RequestQueue struct {\n    mu       sync.Mutex\n    heap     requestHeap\n    maxSize  int\n    notEmpty *sync.Cond\n    notFull  *sync.Cond\n    closed   bool\n}\n\n// NewRequestQueue creates a new bounded priority queue\nfunc NewRequestQueue(maxSize int) *RequestQueue {\n    q := &RequestQueue{\n        heap:    make(requestHeap, 0),\n        maxSize: maxSize,\n    }\n    q.notEmpty = sync.NewCond(&q.mu)\n    q.notFull = sync.NewCond(&q.mu)\n    heap.Init(&q.heap)\n    return q\n}\n\n// Enqueue adds a request to the queue with timeout\nfunc (q *RequestQueue) Enqueue(ctx context.Context, req *QueuedRequest) error {\n    q.mu.Lock()\n    \n    // TODO 1: Wait for queue not full with context timeout (use waitWithTimeout helper)\n    // TODO 2: If queue is closed, return ErrQueueClosed\n    // TODO 3: Set req.EnqueuedAt = time.Now()\n    // TODO 4: Push request onto heap (heap.Push)\n    // TODO 5: Signal notEmpty condition variable\n    // TODO 6: Update queue depth metrics\n    // Hint: Calculate priority based on req.Request.TimeRemaining() - shorter remaining time = higher priority\n    q.mu.Unlock()\n    return nil\n}\n\n// Dequeue removes and returns the highest priority request\nfunc (q *RequestQueue) Dequeue(ctx context.Context) (*QueuedRequest, error) {\n    q.mu.Lock()\n    defer q.mu.Unlock()\n    \n    // TODO 1: Wait for queue not empty with context timeout\n    // TODO 2: If queue is closed, return ErrQueueClosed\n    // TODO 3: Pop highest priority request from heap (heap.Pop)\n    // TODO 4: Signal notFull condition variable\n    // TODO 5: Update queue depth metrics\n    // TODO 6: Check if request has expired (req.Request.IsExpired()) - if so, discard and retry\n    // Hint: Implement loop that skips expired requests until finding valid one or queue empty\n    return nil, nil\n}\n\n// RemoveExpired removes and returns count of expired requests\nfunc (q *RequestQueue) RemoveExpired(deadline time.Time) int {\n    // TODO 1: Iterate through heap (without removing)\n    // TODO 2: Find requests where req.Request.Deadline.Before(deadline)\n    // TODO 3: Remove them from heap (maintaining heap property)\n    // TODO 4: Return count of removed requests\n    // TODO 5: Update metrics for expired requests\n    // Hint: Build list of indices to remove, then rebuild heap or use heap.Remove\n    return 0\n}\n\n// requestHeap implements heap.Interface for priority queue\ntype requestHeap []*QueuedRequest\n\nfunc (h requestHeap) Len() int           { return len(h) }\nfunc (h requestHeap) Less(i, j int) bool { return h[i].Priority < h[j].Priority }\nfunc (h requestHeap) Swap(i, j int)      { h[i], h[j] = h[j], h[i]; h[i].index = i; h[j].index = j }\n\nfunc (h *requestHeap) Push(x interface{}) {\n    n := len(*h)\n    item := x.(*QueuedRequest)\n    item.index = n\n    *h = append(*h, item)\n}\n\nfunc (h *requestHeap) Pop() interface{} {\n    old := *h\n    n := len(old)\n    item := old[n-1]\n    item.index = -1\n    *h = old[0 : n-1]\n    return item\n}\n```\n\n#### Language-Specific Hints\n\n**Go-Specific Implementation Tips**:\n\n1. **Concurrency Control**: Use `sync.RWMutex` for routing table (many reads, few writes). Use `atomic` operations for instance request counters to avoid lock contention on hot paths.\n\n2. **Context Propagation**: Always pass `context.Context` through function calls. Use `context.WithTimeout` to enforce deadlines. Check `ctx.Err()` before starting expensive operations.\n\n3. **HTTP Client Pooling**: Create a shared `http.Client` with `Transport: &http.Transport{MaxIdleConnsPerHost: 100}` to reuse connections to function instances.\n\n4. **Channel-based Queue Alternative**: For simpler implementations, use buffered channels as bounded queues: `make(chan *QueuedRequest, maxSize)`. Use `select` with `ctx.Done()` for timeouts.\n\n5. **Prometheus Metrics**: Register metrics once, use `WithLabelValues` for dynamic labels. Consider using `promauto` for automatic registration.\n\n6. **Graceful Shutdown**: Implement `Shutdown(ctx context.Context)` method that stops accepting new requests, waits for in-flight requests, and drains queues with context timeout.\n\n7. **Connection Management**: Use `http.Client.Timeout` and `DialContext` for fine-grained control. Consider implementing connection health checks with `Transport.IdleConnTimeout`.\n\n#### Milestone Checkpoint\n\nAfter implementing request routing, verify functionality with these tests:\n\n1. **Basic Routing Test**:\n   ```bash\n   # Start gateway on port 8080\n   go run cmd/gateway/main.go --addr :8080\n   \n   # Send test request\n   curl -X POST http://localhost:8080/invoke/myFunction \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"test\": \"data\"}' \\\n     -v\n   ```\n   **Expected**: Gateway starts, accepts request, returns 503 (no instances available yet).\n\n2. **Queue Test**:\n   ```bash\n   # Configure function with max concurrency 1, queue size 5\n   # Start one instance, send 3 concurrent requests\n   ab -n 3 -c 3 -p test.json -T application/json \\\n     http://localhost:8080/invoke/myFunction\n   ```\n   **Expected**: One request executes immediately, two queue. Check logs for queue depth metrics.\n\n3. **Load Balancing Verification**:\n   ```bash\n   # Start 3 instances, send 10 requests\n   for i in {1..10}; do\n     curl -X POST http://localhost:8080/invoke/myFunction -d \"req-$i\" &\n   done\n   wait\n   ```\n   **Expected**: Requests distributed across instances (check instance logs). Roughly equal distribution with least-connections.\n\n4. **Timeout Test**:\n   ```bash\n   # Set function timeout to 1s, send request that sleeps 2s\n   curl -X POST http://localhost:8080/invoke/slowFunction \\\n     -H \"X-Function-Timeout: 1000\" \\\n     -d '{\"sleep\": 2000}'\n   ```\n   **Expected**: Request times out after 1s with 504 status or function error response.\n\n**Signs of Correct Implementation**:\n- Gateway starts without errors and binds to configured port\n- Request logs show routing decisions (instance selection, queueing)\n- Prometheus metrics show request counts, durations, queue depths\n- Multiple instances receive balanced load\n- Queue prevents overload when all instances busy\n- Timeouts are respected and propagated\n\n**Common Issues and Diagnostics**:\n- **\"Gateway returns 503 immediately\"**: Check instance registration with router\n- **\"All requests go to one instance\"**: Verify least-connections counters are updating\n- **\"Queue never drains\"**: Check scale-up triggers and instance availability\n- **\"Memory grows unbounded\"**: Verify queue bounds and request eviction\n- **\"Timeouts not working\"**: Check deadline propagation through context chain\n\n\n## Component Design: Auto-Scaling\n> **Milestone(s):** Milestone 5\n\nThe auto-scaling component is the **elastic nervous system** of the serverless runtime—it continuously monitors demand and dynamically adjusts the supply of execution environments to match workload patterns while respecting resource constraints and minimizing costs. This component embodies the core promise of serverless computing: scaling from zero to handle sudden bursts, then scaling back to zero when idle, all without human intervention. Unlike traditional autoscalers that operate on minute-long granularities, serverless auto-scaling must react within seconds to accommodate ephemeral, event-driven workloads while accounting for the latency penalty of **cold starts**.\n\n### Mental Model: The Elastic Concert Hall\n\nImagine managing a large concert hall with retractable seating sections. When ticket sales (requests) begin, you start with a minimal central section open. As the queue at the entrance (request queue) grows, you dynamically unfold additional seating sections (function instances) to accommodate more attendees. Each section takes time to deploy (cold start latency), so you monitor the arrival rate and sometimes pre-deploy sections based on historical patterns (predictive warming). When sections remain empty for a configured idle period, you retract them to save on heating and cleaning costs (scale-to-zero). The hall enforces fire code limits (maximum instances) and always keeps a few sections minimally prepared for VIP guests (provisioned concurrency). This elastic capacity management—balancing responsiveness against resource efficiency—captures the essence of auto-scaling in serverless systems.\n\n### Scaler Interface and Metrics\n\nThe auto-scaler operates as a control loop that periodically evaluates scaling decisions for each deployed function. It interacts with the **router** (to understand current request load and instance utilization), the **warm pool manager** (to provision or terminate instances), and the **metrics subsystem** (to gather historical data). The core interface abstracts these interactions:\n\n| Method Name | Parameters | Returns | Description |\n|-------------|------------|---------|-------------|\n| `EvaluateScaling(ctx context.Context, functionName string)` | `functionName`: Name of function to evaluate | `ScaleDecision` (struct containing direction and count) | Evaluates current metrics against scaling policies to determine if scaling action is needed |\n| `RecordInvocationMetric(ctx context.Context, functionName string, timestamp time.Time)` | `functionName`: Function identifier, `timestamp`: When invocation occurred | `error` | Records an invocation event for rate calculation (called by gateway on each request) |\n| `GetFunctionScalingConfig(ctx context.Context, functionName string)` | `functionName`: Function identifier | `*ScalingConfig` | Retrieves scaling configuration (min/max instances, thresholds, cooldowns) |\n| `UpdateScalingConfig(ctx context.Context, functionName string, config ScalingConfig)` | `functionName`: Function identifier, `config`: New scaling configuration | `error` | Updates scaling configuration for a function |\n| `StartScalingLoop(ctx context.Context)` | None | `error` | Starts the periodic scaling evaluation loop for all active functions |\n| `StopScalingLoop(ctx context.Context)` | None | `error` | Stops the scaling evaluation loop |\n\nThe auto-scaler's decisions are driven by two primary metrics computed over a sliding window (typically 15-60 seconds):\n\n1. **Request Rate (RPS)**: Invocations per second, measured as a moving average. This indicates demand volume.\n2. **Concurrent Executions**: Number of simultaneously active invocations across all instances of a function. This indicates utilization of existing capacity.\n\nAdditional derived metrics include:\n- **Queue Depth**: Number of requests waiting in the per-function queue (from the router)\n- **Instance Utilization**: `ConcurrentExecutions / (ActiveInstances * PerInstanceConcurrencyLimit)`\n- **Cold Start Ratio**: Percentage of invocations experiencing cold starts\n\nThe core data structure for scaling configuration:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `FunctionName` | `string` | Name of the function this configuration applies to |\n| `MinInstances` | `int` | Minimum number of instances to keep running (including warm) |\n| `MaxInstances` | `int` | Maximum number of instances allowed |\n| `TargetConcurrency` | `int` | Desired number of concurrent executions per instance (used to calculate desired instance count) |\n| `ScaleUpThreshold` | `float64` | Utilization threshold (0.0-1.0) that triggers scale-up (e.g., 0.8 = 80% utilization) |\n| `ScaleDownThreshold` | `float64` | Utilization threshold (0.0-1.0) that triggers scale-down |\n| `ScaleUpCooldown` | `time.Duration` | Minimum time between scale-up actions (prevents rapid oscillation) |\n| `ScaleDownCooldown` | `time.Duration` | Minimum time between scale-down actions |\n| `IdleTimeout` | `time.Duration` | How long an instance must be idle before being considered for termination (scale-to-zero) |\n| `WarmPoolSize` | `int` | Number of instances to keep in warm pool (provisioned concurrency) |\n| `MetricsWindow` | `time.Duration` | Time window for calculating metrics (e.g., 30s) |\n\n### ADR: Scaling Algorithm - Reactive vs. Predictive\n\n> **Decision: Threshold-Based Reactive Scaling with Predictive Warming Hints**\n> - **Context**: The serverless runtime must scale function instances efficiently under unpredictable, bursty workloads typical of event-driven architectures. We need to choose between simple reactive approaches (responding to current load) and more complex predictive approaches (forecasting future load).\n> - **Options Considered**:\n>   1. **Pure Reactive Scaling**: Monitor current metrics (concurrency, queue depth) and scale when thresholds are breached.\n>   2. **Predictive Scaling**: Use time-series forecasting (ARIMA, ML models) to predict future demand and pre-scale.\n>   3. **Hybrid Approach**: Reactive scaling as baseline, with simple predictive warming for known patterns.\n> - **Decision**: Implement threshold-based reactive scaling with optional predictive warming hints based on time-of-day/day-of-week patterns.\n> - **Rationale**: Pure predictive scaling requires extensive historical data, adds significant complexity, and can be inaccurate for truly sporadic workloads. Reactive scaling is simpler, more robust, and sufficient for most serverless patterns. The hybrid approach gives us the best of both: reliability of reactive scaling with the ability to pre-warm for predictable patterns (like daily cron jobs or business-hour traffic). We avoid full ML-based prediction due to implementation complexity and the \"cold start problem\" for prediction models themselves.\n> - **Consequences**: \n>   - Positive: Simpler implementation, easier debugging, robust to unpredictable traffic.\n>   - Negative: May miss optimization opportunities for highly predictable workloads.\n>   - Trade-off: Accept slightly higher cold start latency for truly unpredictable bursts in exchange for system simplicity.\n\n| Option | Pros | Cons | Chosen? |\n|--------|------|------|---------|\n| Pure Reactive Scaling | Simple to implement, robust, no historical data needed, immediate response to actual load | Always reacts after load arrives (never pre-warms), can cause latency spikes during sudden bursts | Partially (as baseline) |\n| Predictive Scaling | Can pre-warm before load arrives, minimizes cold starts for predictable patterns | Complex implementation, requires historical data, prediction inaccuracies can waste resources, \"cold start\" for the predictor itself | No |\n| Hybrid Approach | Balances simplicity with optimization, can handle both unpredictable and predictable workloads | More complex than pure reactive, still requires some historical data for predictive part | **Yes** |\n\nThe scaling algorithm operates as a periodic control loop with the following decision logic (illustrated in the flowchart `![Flowchart: Scale-Up Decision Logic](./diagrams/flowchart-scaling-logic.svg)`):\n\n1. **For each active function, every evaluation interval (e.g., 10 seconds):**\n   1. Retrieve current metrics: `activeInstances`, `concurrentExecutions`, `queueDepth`\n   2. Calculate desired instances: `desired = ceil(concurrentExecutions / targetConcurrency)`\n   3. Apply bounds: `desired = max(minInstances, min(maxInstances, desired))`\n   4. If `desired > activeInstances` AND `scaleUpCooldown` elapsed since last scale-up:\n      - Trigger scale-up of `(desired - activeInstances)` instances\n      - Record scale-up timestamp\n   5. If `desired < activeInstances` AND `scaleDownCooldown` elapsed:\n      - Identify idle instances (those with `IdleDuration() > idleTimeout`)\n      - Mark up to `(activeInstances - desired)` idle instances as `InstanceStateDraining`\n   6. For scale-to-zero: If `activeInstances > minInstances` AND all instances have been idle beyond `idleTimeout`:\n      - Mark all excess instances as `InstanceStateDraining`\n\nThe state transitions for scaling actions align with the instance lifecycle shown in `![Function Instance Lifecycle](./diagrams/instance-state-machine.svg)`:\n\n| Current State | Event | Next State | Action Taken |\n|---------------|-------|------------|--------------|\n| `InstanceStateWarm` | Scale-down signal (instance selected for removal) | `InstanceStateDraining` | Instance stops accepting new requests, completes in-flight requests |\n| `InstanceStateDraining` | All in-flight requests completed | `InstanceStateTerminated` | Container stopped and removed, resources freed |\n| (No instance exists) | Scale-up signal (need new instance) | `InstanceStateProvisioning` | `CreateContainer` called, instance added to warm pool |\n\n### Common Pitfalls in Auto-Scaling\n\n⚠️ **Pitfall: Scaling Thrashing (Rapid Oscillation)**\n- **Description**: The scaler repeatedly adds and removes instances in quick succession due to metrics fluctuating around thresholds.\n- **Why it's wrong**: Causes instance churn, increased cold starts, wasted resources on container lifecycle operations, and potential request failures during transitions.\n- **How to avoid**: Implement cooldown periods (`ScaleUpCooldown`, `ScaleDownCooldown`) that prevent another scaling action of the same direction for a minimum time. Use hysteresis by having different thresholds for scale-up (e.g., 80% utilization) and scale-down (e.g., 30% utilization).\n\n⚠️ **Pitfall: Ignoring Cold Start Latency in Scaling Decisions**\n- **Description**: Scaling logic treats newly provisioned instances as immediately available, but they incur cold start latency (seconds for some runtimes).\n- **Why it's wrong**: During rapid traffic increase, newly scaled instances won't be ready in time to handle the surge, causing queue buildup and timeouts.\n- **How to avoid**: Incorporate cold start latency into scaling calculations: when scaling up, assume new instances will be unavailable for their runtime's typical cold start duration. Alternatively, use predictive warming or maintain a small warm buffer.\n\n⚠️ **Pitfall: Over-Provisioning from Minimum Instance Counts**\n- **Description**: Setting `MinInstances > 0` for many functions \"just to be safe,\" leading to constantly running idle instances.\n- **Why it's wrong**: Violates the serverless cost model—you pay for idle capacity. For sporadic workloads, this can multiply costs significantly.\n- **How to avoid**: Default `MinInstances` to 0. Use `WarmPoolSize` (provisioned concurrency) only for latency-critical functions with known baseline load. Educate users on the cost-performance trade-off.\n\n⚠️ **Pitfall: Not Accounting for Burst Traffic Patterns**\n- **Description**: The scaler uses smooth averages (e.g., 30-second RPS) and misses short, intense bursts that arrive and complete within the metrics window.\n- **Why it's wrong**: Bursts cause timeouts or dropped requests because scaling doesn't react quickly enough.\n- **How to avoid**: Include queue depth as a scaling signal—if queue is growing despite high utilization, scale up immediately. Use shorter metrics windows (e.g., 5 seconds) for highly variable workloads.\n\n⚠️ **Pitfall: Scale-Down Too Aggressive for Stateful Functions**\n- **Description**: Scaling down instances while they hold in-memory state (caches, WebSocket connections) not meant to be shared across instances.\n- **Why it's wrong**: Terminating instances loses state, breaking application logic. Serverless functions should ideally be stateless, but some frameworks encourage in-memory caching for performance.\n- **How to avoid**: Provide configuration to disable scale-to-zero for stateful functions, or implement graceful shutdown hooks that persist state to external storage before termination.\n\n### Implementation Guidance for Auto-Scaling\n\n#### A. Technology Recommendations Table\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| Metrics Collection | In-memory counters with sliding window (Go `container/ring`) | Prometheus metrics with custom exporters |\n| Scaling Loop | Periodic goroutine with `time.Ticker` | Kubernetes-style controller pattern with work queue |\n| Configuration Storage | In-memory map (for prototype) | Persistent key-value store (etcd, Redis) |\n| Predictive Warming | Time-of-day/day-of-week pattern matching | ML forecasting (Facebook Prophet, ARIMA) |\n\n#### B. Recommended File/Module Structure\n\n```\nproject-root/\n  cmd/scaler/main.go                 # Scaler service entry point\n  internal/scaler/\n    scaler.go                        # Main scaling logic and control loop\n    config.go                        # ScalingConfig type and validation\n    metrics.go                       # Metrics collection and calculations\n    predictor.go                     # Simple predictive warming (time-based patterns)\n    scaler_test.go                   # Unit tests\n  internal/gateway/                  # (Existing) - calls RecordInvocationMetric\n  internal/router/                   # (Existing) - provides queue depth and instance counts\n  internal/pool/                     # (Existing) - WarmPoolManager for instance lifecycle\n```\n\n#### C. Infrastructure Starter Code (Metrics Collector)\n\n```go\n// internal/scaler/metrics.go\npackage scaler\n\nimport (\n    \"container/ring\"\n    \"sync\"\n    \"time\"\n)\n\n// InvocationEvent records a single function invocation for rate calculation\ntype InvocationEvent struct {\n    Timestamp time.Time\n    FunctionName string\n}\n\n// MetricsCollector maintains sliding window metrics for scaling decisions\ntype MetricsCollector struct {\n    mu sync.RWMutex\n    // Per-function ring buffers of invocation timestamps\n    invocationBuffers map[string]*ring.Ring\n    windowSize time.Duration\n    // Current concurrency counts\n    concurrency map[string]int64\n}\n\n// NewMetricsCollector creates a collector with specified time window\nfunc NewMetricsCollector(windowSize time.Duration) *MetricsCollector {\n    return &MetricsCollector{\n        invocationBuffers: make(map[string]*ring.Ring),\n        windowSize:        windowSize,\n        concurrency:       make(map[string]int64),\n    }\n}\n\n// RecordInvocation adds an invocation timestamp for rate calculation\nfunc (m *MetricsCollector) RecordInvocation(functionName string, ts time.Time) {\n    m.mu.Lock()\n    defer m.mu.Unlock()\n    \n    buf, exists := m.invocationBuffers[functionName]\n    if !exists {\n        // Estimate max invocations per window: assume 1000 RPS max\n        maxEvents := int(m.windowSize.Seconds() * 1000)\n        buf = ring.New(maxEvents)\n        m.invocationBuffers[functionName] = buf\n    }\n    \n    buf.Value = ts\n    buf = buf.Next()\n    m.invocationBuffers[functionName] = buf\n}\n\n// IncrementConcurrency increases concurrent execution count\nfunc (m *MetricsCollector) IncrementConcurrency(functionName string) {\n    m.mu.Lock()\n    defer m.mu.Unlock()\n    m.concurrency[functionName]++\n}\n\n// DecrementConcurrency decreases concurrent execution count\nfunc (m *MetricsCollector) DecrementConcurrency(functionName string) {\n    m.mu.Lock()\n    defer m.mu.Unlock()\n    m.concurrency[functionName]--\n}\n\n// GetRequestRate calculates requests per second over the sliding window\nfunc (m *MetricsCollector) GetRequestRate(functionName string) float64 {\n    m.mu.RLock()\n    defer m.mu.RUnlock()\n    \n    buf, exists := m.invocationBuffers[functionName]\n    if !exists {\n        return 0.0\n    }\n    \n    cutoff := time.Now().Add(-m.windowSize)\n    count := 0\n    \n    // Walk the ring buffer counting events within window\n    buf.Do(func(value interface{}) {\n        if value == nil {\n            return\n        }\n        ts := value.(time.Time)\n        if ts.After(cutoff) {\n            count++\n        }\n    })\n    \n    return float64(count) / m.windowSize.Seconds()\n}\n\n// GetConcurrency returns current concurrent executions\nfunc (m *MetricsCollector) GetConcurrency(functionName string) int64 {\n    m.mu.RLock()\n    defer m.mu.RUnlock()\n    return m.concurrency[functionName]\n}\n```\n\n#### D. Core Logic Skeleton Code (Scaler Main Logic)\n\n```go\n// internal/scaler/scaler.go\npackage scaler\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"log\"\n    \"sync\"\n    \"time\"\n    \n    \"github.com/yourproject/internal/pool\"\n    \"github.com/yourproject/internal/router\"\n    \"github.com/yourproject/internal/types\"\n)\n\n// ScaleDecision represents a scaling action to take\ntype ScaleDecision struct {\n    FunctionName string\n    Direction    ScaleDirection // \"up\", \"down\", \"none\"\n    Count        int           // Number of instances to add/remove\n    Reason       string\n}\n\ntype ScaleDirection string\n\nconst (\n    ScaleUp   ScaleDirection = \"up\"\n    ScaleDown ScaleDirection = \"down\"\n    ScaleNone ScaleDirection = \"none\"\n)\n\n// Scaler is the main auto-scaling component\ntype Scaler struct {\n    mu sync.RWMutex\n    \n    // Dependencies\n    metricsCollector *MetricsCollector\n    warmPool         pool.WarmPoolManager\n    router           *router.Router\n    configStore      ConfigStore\n    \n    // State\n    activeFunctions   map[string]bool\n    lastScaleUpTime   map[string]time.Time\n    lastScaleDownTime map[string]time.Time\n    \n    // Control\n    ticker      *time.Ticker\n    stopChan    chan struct{}\n    evalInterval time.Duration\n}\n\n// NewScaler creates a new auto-scaler\nfunc NewScaler(mc *MetricsCollector, wp pool.WarmPoolManager, \n               r *router.Router, interval time.Duration) *Scaler {\n    return &Scaler{\n        metricsCollector: mc,\n        warmPool:         wp,\n        router:           r,\n        activeFunctions:  make(map[string]bool),\n        lastScaleUpTime:  make(map[string]time.Time),\n        lastScaleDownTime: make(map[string]time.Time),\n        evalInterval:     interval,\n        stopChan:         make(chan struct{}),\n    }\n}\n\n// StartScalingLoop begins the periodic scaling evaluation\nfunc (s *Scaler) StartScalingLoop(ctx context.Context) error {\n    s.ticker = time.NewTicker(s.evalInterval)\n    \n    go func() {\n        for {\n            select {\n            case <-s.ticker.C:\n                s.evaluateAllFunctions(ctx)\n            case <-s.stopChan:\n                s.ticker.Stop()\n                return\n            case <-ctx.Done():\n                s.ticker.Stop()\n                return\n            }\n        }\n    }()\n    \n    log.Printf(\"Scaling loop started with interval %v\", s.evalInterval)\n    return nil\n}\n\n// evaluateAllFunctions checks each active function for scaling needs\nfunc (s *Scaler) evaluateAllFunctions(ctx context.Context) {\n    s.mu.RLock()\n    functions := make([]string, 0, len(s.activeFunctions))\n    for fn := range s.activeFunctions {\n        functions = append(functions, fn)\n    }\n    s.mu.RUnlock()\n    \n    for _, fn := range functions {\n        decision := s.EvaluateScaling(ctx, fn)\n        if decision.Direction != ScaleNone {\n            s.executeScaling(ctx, decision)\n        }\n    }\n}\n\n// EvaluateScaling implements the core scaling algorithm\nfunc (s *Scaler) EvaluateScaling(ctx context.Context, functionName string) ScaleDecision {\n    // TODO 1: Retrieve scaling configuration for this function\n    // config, err := s.configStore.GetFunctionScalingConfig(ctx, functionName)\n    // If no config, return ScaleNone\n    \n    // TODO 2: Gather current metrics\n    // requestRate := s.metricsCollector.GetRequestRate(functionName)\n    // concurrency := s.metricsCollector.GetConcurrency(functionName)\n    // queueDepth := s.router.GetQueueDepth(functionName)\n    // activeInstances := s.router.GetActiveInstanceCount(functionName)\n    \n    // TODO 3: Calculate desired instances based on target concurrency\n    // desired := int(math.Ceil(float64(concurrency) / float64(config.TargetConcurrency)))\n    // Apply min/max bounds: desired = max(config.MinInstances, min(config.MaxInstances, desired))\n    \n    // TODO 4: Check cooldown periods\n    // now := time.Now()\n    // lastUp := s.lastScaleUpTime[functionName]\n    // lastDown := s.lastScaleDownTime[functionName]\n    \n    // TODO 5: Determine scaling direction\n    // if desired > activeInstances && now.Sub(lastUp) >= config.ScaleUpCooldown {\n    //     return ScaleDecision{\n    //         FunctionName: functionName,\n    //         Direction:    ScaleUp,\n    //         Count:        desired - activeInstances,\n    //         Reason:       fmt.Sprintf(\"Concurrency %d exceeds threshold\", concurrency),\n    //     }\n    // }\n    \n    // TODO 6: Check for scale-down (consider idle instances)\n    // if desired < activeInstances && now.Sub(lastDown) >= config.ScaleDownCooldown {\n    //     // Get idle instances from router\n    //     idleCount := s.router.GetIdleInstanceCount(functionName, config.IdleTimeout)\n    //     removeCount := min(activeInstances - desired, idleCount)\n    //     if removeCount > 0 {\n    //         return ScaleDecision{...}\n    //     }\n    // }\n    \n    // TODO 7: Check for scale-to-zero (if minInstances == 0 and all instances idle beyond timeout)\n    \n    return ScaleDecision{Direction: ScaleNone}\n}\n\n// executeScaling performs the actual scaling action\nfunc (s *Scaler) executeScaling(ctx context.Context, decision ScaleDecision) {\n    switch decision.Direction {\n    case ScaleUp:\n        // TODO 8: Trigger warm pool to create new instances\n        // s.warmPool.PreWarm(ctx, decision.FunctionName, \"latest\", decision.Count)\n        // Update lastScaleUpTime\n        log.Printf(\"Scaling UP %s by %d instances: %s\", \n            decision.FunctionName, decision.Count, decision.Reason)\n        \n    case ScaleDown:\n        // TODO 9: Get idle instances from router and mark them as DRAINING\n        // The router will handle graceful termination after in-flight requests complete\n        log.Printf(\"Scaling DOWN %s by %d instances: %s\",\n            decision.FunctionName, decision.Count, decision.Reason)\n    }\n}\n\n// RecordInvocationMetric is called by gateway on each request\nfunc (s *Scaler) RecordInvocationMetric(ctx context.Context, \n                                      functionName string, \n                                      timestamp time.Time) error {\n    // TODO 10: Mark function as active for scaling consideration\n    s.mu.Lock()\n    s.activeFunctions[functionName] = true\n    s.mu.Unlock()\n    \n    // Record the invocation for rate calculation\n    s.metricsCollector.RecordInvocation(functionName, timestamp)\n    return nil\n}\n\n// StopScalingLoop halts the scaling evaluation\nfunc (s *Scaler) StopScalingLoop(ctx context.Context) error {\n    close(s.stopChan)\n    return nil\n}\n```\n\n#### E. Language-Specific Hints\n\n1. **Concurrency Safety**: Use `sync.RWMutex` for metrics maps that are read-heavy. The scaling loop reads metrics frequently while the gateway writes to them.\n2. **Time Management**: Use `time.Ticker` for periodic evaluation rather than `time.Sleep` in a loop—it provides more consistent intervals.\n3. **Context Propagation**: Pass `context.Context` through all scaling operations to allow cancellation during shutdown.\n4. **Error Handling**: Scale operations should be best-effort. Log errors but don't fail the entire scaling loop for one function's failure.\n5. **Memory Efficiency**: For the sliding window metrics, `container/ring` provides O(1) operations but requires type assertions. Consider a typed ring buffer for production.\n\n#### F. Milestone Checkpoint\n\nAfter implementing the auto-scaler, verify it works correctly:\n\n1. **Start the system** with a sample Python function deployed:\n   ```bash\n   go run cmd/server/main.go\n   ```\n\n2. **Send a burst of requests** using a load testing tool:\n   ```bash\n   hey -n 100 -c 20 http://localhost:8080/invoke/my-function\n   ```\n\n3. **Monitor scaling behavior**:\n   - Check logs for scale-up messages\n   - Observe instance count increase in metrics (`GET /metrics` endpoint)\n   - Wait for traffic to subside and verify scale-down occurs after cooldown period\n   - Verify scale-to-zero eventually terminates all instances (if `MinInstances=0`)\n\n4. **Expected observations**:\n   - Initial requests may experience cold starts\n   - After scale-up, subsequent requests should use warm instances\n   - Instance count should not exceed `MaxInstances`\n   - After idle period, instances should terminate\n\n5. **Signs of problems**:\n   - No scaling occurs: Check metrics collection and threshold values\n   - Constant scaling oscillations: Adjust cooldown periods or add hysteresis\n   - Instances not terminating: Verify `IdleTimeout` and draining logic\n\n\n## Interactions and Data Flow\n> **Milestone(s):** Milestone 4 (Request Routing) and Milestone 5 (Auto-Scaling), with dependencies on Milestone 2 (Execution Environment) and Milestone 3 (Cold Start Optimization)\n\nThis section traces the complete journey of a function invocation through the system, from the initial HTTP request to the final response. Understanding these interactions is critical to grasping how the architectural components collaborate to deliver the serverless experience. We'll examine both the **synchronous invocation flow** (where the client waits for the result) and the **lifecycle events** that govern function instance behavior.\n\n### Synchronous Invocation Flow\n\nThink of this flow as a **restaurant dinner service**:\n1. A customer (client) arrives and tells the host (Gateway) what they want to eat (which function to invoke)\n2. The host checks if there's an available table (warm instance) with a free seat (concurrency capacity)\n3. If not, the host might ask the kitchen to prepare a new table (cold start) or add the customer to a waitlist (queue)\n4. Once seated, a waiter (Container) takes the order (request), the kitchen (function code) prepares the meal (executes), and the result is delivered back through the chain\n5. After the meal, the table is cleaned (instance reset) and made available for the next customer\n\n#### Complete Step-by-Step Walkthrough\n\nThe following numbered steps trace a synchronous HTTP function call from initial request to final response, highlighting the interactions between all system components:\n\n1. **Client Request Submission**\n   - The client sends an HTTP POST request to `https://gateway.example.com/invoke/{functionName}`\n   - The request includes the function payload in the request body and any required headers\n   - The client may specify a timeout via the `X-Timeout-Seconds` header or it defaults to the function's configured timeout\n\n2. **Gateway Reception and Validation**\n   - The `Gateway` receives the request through its HTTP server\n   - It validates the function name exists in the system by checking with the `Router`\n   - It enforces request size limits (configured via `GatewayConfig.MaxRequestBodyBytes`)\n   - It creates an `InvocationRequest` with:\n     - A unique `RequestID` for tracking\n     - The function name and preferred version\n     - The payload bytes\n     - `Synchronous: true`\n     - A `Deadline` calculated from the current time plus timeout\n   - The gateway records metrics via `gatewayMetrics.requestsTotal` and starts a timer for request duration\n\n3. **Router Request Processing**\n   - The `Router.Route()` method is called with the `InvocationRequest`\n   - The router looks up the `functionRoutingTable` for the specified function\n   - It checks if the function's circuit breaker is open (too many recent failures) → if so, returns error immediately\n   - It calls `selectInstance()` to choose an appropriate `FunctionInstance`\n\n4. **Instance Selection Process**\n   - **Warm Path (Ideal)**: If warm instances exist in the routing table:\n     - The router applies **least-connections** strategy, preferring instances with lowest `activeReqs`\n     - It checks that the selected instance's `activeReqs < concurrencyLimit` (per-instance concurrency)\n     - It verifies the instance is healthy (not marked as unhealthy in `routedInstance.healthy`)\n     - It increments the instance's `activeReqs` counter\n   - **Cold Path (No Warm Instance Available)**:\n     - The router calls the `Scaler` to potentially scale up\n     - The scaler's `EvaluateScaling()` determines if a new instance should be created\n     - If scaling is triggered, the scaler interacts with the `WarmPoolManager` to create a new instance\n     - Meanwhile, the request may be queued (see step 5) or fail fast depending on configuration\n\n5. **Request Queue Management (When No Instance Available)**\n   - If all warm instances are at capacity (`activeReqs >= concurrencyLimit`):\n     - The router creates a `QueuedRequest` with priority based on request deadline (earlier deadline = higher priority)\n     - It calls `RequestQueue.Enqueue()` to add the request to the function-specific queue\n     - The gateway sets an HTTP timeout and waits for dequeue notification\n     - The `gatewayMetrics.queueDepth` is incremented to monitor queue size\n   - **Queue Full Scenario**: If the queue reaches its `maxSize`, new requests receive HTTP 503 \"Service Unavailable\"\n\n6. **Instance Acquisition and Preparation**\n   - Once an instance is selected (or becomes available):\n     - The router calls `WarmPoolManager.AcquireWarmInstance()` for the function\n     - The warm pool manager:\n       - Marks the instance state as `InstanceStateActive` from `InstanceStateWarm`\n       - Updates `LastUsedAt` timestamp\n       - Returns the `FunctionInstance` with its container details (host, port)\n     - The router records the instance assignment in the `InvocationRequest.PreferredInstanceID`\n\n7. **Request Forwarding to Instance**\n   - The router calls `forwardRequest()` which:\n     - Establishes an HTTP connection to the instance's container (at `instance.Host:instance.Port`)\n     - Forwards the original request payload with additional headers:\n       - `X-Function-Request-ID`: The unique request identifier\n       - `X-Deadline-Timestamp`: The absolute deadline as Unix timestamp\n       - `X-Instance-ID`: The instance identifier for tracking\n     - Sets appropriate timeouts based on the remaining deadline\n   - The instance container (running the function runtime) receives and processes the request\n\n8. **Function Execution Within Container**\n   - The container's runtime (e.g., a Go HTTP server) receives the forwarded request\n   - It extracts the function handler name from environment variables\n   - It loads the function code (already present in the container from packaging)\n   - It invokes the handler function with the request payload\n   - The handler executes with the configured resource limits (monitored via cgroups)\n   - The runtime captures stdout/stderr and any returned values\n\n9. **Response Propagation Back Through Chain**\n   - The instance container sends an HTTP response back to the router's `forwardRequest()`\n   - The router:\n     - Decrements the instance's `activeReqs` counter\n     - Calls `updateInstanceHealth()` with success/failure based on HTTP status code\n     - If successful, marks the instance as healthy; if failed, increments failure count\n   - The router packages the response into an `InvocationResponse` with:\n     - The response payload\n     - Duration metrics\n     - Memory usage (from container stats)\n     - Any errors that occurred\n\n10. **Instance Release and Cleanup**\n    - The router calls `WarmPoolManager.ReleaseInstance()` with the instance and health status\n    - The warm pool manager:\n      - If the instance is healthy and under its TTL/idle timeout, returns it to the pool (state `InstanceStateWarm`)\n      - If unhealthy or expired, triggers cleanup via `CleanupInstance()`\n      - Updates `LastUsedAt` timestamp\n    - The `Scaler` records the completion via `DecrementConcurrency()` for concurrency tracking\n\n11. **Final Response to Client**\n    - The gateway receives the `InvocationResponse` from the router\n    - It sets appropriate HTTP status code (200 for success, 5xx for errors)\n    - It returns the response payload in the HTTP body\n    - It adds response headers:\n      - `X-Request-ID`: For client correlation\n      - `X-Function-Duration-MS`: Execution time in milliseconds\n      - `X-Billed-Duration-MS`: Rounded-up billing duration\n    - The gateway records final metrics:\n      - Request duration in `gatewayMetrics.requestDuration`\n      - Success/error counts in `gatewayMetrics.errorsTotal`\n\n#### Cold Start vs Warm Start Variation\n\nThe key difference between cold and warm starts occurs in steps 4-6:\n\n**Warm Start Path (Sub-100ms):**\n```\nRouter → WarmPoolManager.AcquireWarmInstance() → existing warm container → execute function\n```\n- No container creation overhead\n- Runtime already initialized\n- Dependencies pre-loaded\n- Typically completes in <100ms total\n\n**Cold Start Path (500ms-2000ms):**\n```\nRouter → Scaler → WarmPoolManager.PreWarm() → ContainerManager.CreateContainer() → \nContainerManager.StartContainer() → dependency loading → execute function\n```\n- Full container creation (100-500ms)\n- Image pulling if not cached (variable, 0-2000ms)\n- Runtime initialization (JVM: 500ms+, Go: <50ms)\n- Dependency loading/imports (variable)\n- Typically 500ms-2000ms total\n\n> **Key Insight:** The system's performance goal is to maximize warm starts through intelligent pooling and predictive warming while maintaining the flexibility to handle unpredictable loads with cold starts when necessary.\n\n![Sequence: Synchronous Invocation (Cold Start)](./diagrams/sequence-sync-invocation.svg)\n\n*Diagram showing the complete interaction sequence between User, Gateway, Router, Scaler, WarmPoolManager, ContainerManager, and Storage for a cold start invocation.*\n\n#### Data Transformation Through the Pipeline\n\n| Stage | Input Data | Output Data | Key Transformation |\n|-------|------------|-------------|-------------------|\n| Client → Gateway | Raw HTTP request | `InvocationRequest` | HTTP headers/body packaged into structured request |\n| Gateway → Router | `InvocationRequest` | `QueuedRequest` (if queued) | Priority calculation based on deadline |\n| Router → WarmPool | Function name, version | `FunctionInstance` | Instance selection from pool or creation |\n| Router → Container | `InvocationRequest` | HTTP request to container | Request forwarding with metadata headers |\n| Container → Function | HTTP request | Handler invocation | Payload deserialization to function parameters |\n| Function → Container | Return value | HTTP response | Result serialization to HTTP response |\n| Container → Router | HTTP response | `InvocationResponse` | Response packaging with metrics |\n| Router → Gateway | `InvocationResponse` | HTTP response | Structured response to HTTP translation |\n| Gateway → Client | HTTP response | Raw HTTP response | Final delivery to client |\n\n### Function Instance Lifecycle Events\n\nThink of a function instance's lifecycle as a **theater actor's backstage workflow**:\n- **PROVISIONING**: Actor getting into costume and makeup (container being created)\n- **WARM**: Actor waiting in the wings, ready to go on stage (instance idle in pool)\n- **ACTIVE**: Actor performing on stage (executing a request)\n- **DRAINING**: Actor taking final bow but still on stage (finishing requests during scale-down)\n- **TERMINATED**: Actor has left the theater (container destroyed)\n- **ERROR**: Actor fell ill and can't perform (container in error state)\n\nEach state transition is triggered by specific events in the system, which we'll explore through both a state machine table and detailed event descriptions.\n\n#### Instance State Transition Table\n\nThe following table defines all possible state transitions for a `FunctionInstance`, including the triggering events, conditions, and resulting actions:\n\n| Current State | Event | Next State | Conditions | Actions Taken |\n|---------------|-------|------------|------------|---------------|\n| (none) | `CreateInstance` | `InstanceStateProvisioning` | Valid function definition exists | 1. Call `ContainerManager.CreateContainer()`<br>2. Set `CreatedAt` timestamp<br>3. Generate unique `ID` |\n| `InstanceStateProvisioning` | `ContainerStarted` | `InstanceStateWarm` | Container started successfully | 1. Mark container as running<br>2. Initialize runtime environment<br>3. Pre-load dependencies<br>4. Add to warm pool |\n| `InstanceStateProvisioning` | `ContainerStartFailed` | `InstanceStateError` | Container failed to start | 1. Record error details<br>2. Schedule cleanup<br>3. Trigger scaling retry if needed |\n| `InstanceStateWarm` | `RequestAssigned` | `InstanceStateActive` | Instance selected by router | 1. Increment `InvocationCount`<br>2. Update `LastUsedAt`<br>3. Mark as active in routing table |\n| `InstanceStateActive` | `RequestCompleted` | `InstanceStateWarm` | Request finished successfully<br>AND instance under TTL/idle limits | 1. Decrement active request count<br>2. Reset container state if needed<br>3. Return to warm pool |\n| `InstanceStateActive` | `RequestFailed` | `InstanceStateWarm` or `InstanceStateError` | Request failed<br>If recoverable error → WARM<br>If unrecoverable → ERROR | Recoverable: Reset container<br>Unrecoverable: Mark unhealthy, schedule replacement |\n| `InstanceStateWarm` | `TTLExpired` | `InstanceStateDraining` | Instance age > `InstanceTTL` | 1. Mark for termination<br>2. Remove from warm pool<br>3. Start graceful shutdown |\n| `InstanceStateWarm` | `IdleTimeout` | `InstanceStateDraining` | `IdleDuration()` > `IdleTimeout` | 1. Mark for termination<br>2. Remove from routing table<br>3. Start graceful shutdown |\n| `InstanceStateWarm` | `ScaleDownSignal` | `InstanceStateDraining` | Scaler determines excess capacity | 1. Select instance for termination (oldest/last used)<br>2. Begin drain process |\n| `InstanceStateActive` | `ScaleDownSignal` | `InstanceStateDraining` | Scaler needs to reduce capacity<br>AND instance has no active requests | 1. Wait for current request to complete<br>2. Transition to DRAINING after completion |\n| `InstanceStateDraining` | `DrainCompleted` | `InstanceStateTerminated` | All requests completed<br>OR force timeout reached | 1. Call `ContainerManager.StopContainer()`<br>2. Call `ContainerManager.RemoveContainer()`<br>3. Update `TerminatedAt` timestamp |\n| `InstanceStateDraining` | `ForceTerminate` | `InstanceStateTerminated` | Scale-down timeout reached<br>OR system shutdown | 1. Force kill container processes<br>2. Remove container resources<br>3. Clean up network/volumes |\n| `InstanceStateError` | `HealthCheckFailed` | `InstanceStateTerminated` | Container unrecoverable<br>OR consecutive failures | 1. Log error details<br>2. Force remove container<br>3. Notify monitoring system |\n| Any state | `SystemShutdown` | `InstanceStateTerminated` | System graceful shutdown initiated | 1. Stop accepting new requests<br>2. Wait for in-flight requests<br>3. Terminate all containers |\n\n![Function Instance Lifecycle](./diagrams/instance-state-machine.svg)\n\n*Diagram showing the state machine for a FunctionInstance with transitions between PROVISIONING, WARM, ACTIVE, DRAINING, TERMINATED, and ERROR states.*\n\n#### Detailed Event Descriptions\n\nEach event in the state machine corresponds to specific system operations or conditions:\n\n**1. CreateInstance Event**\n- **Triggered by**: `WarmPoolManager.PreWarm()` or `Scaler.executeScaling(ScaleUp)`\n- **Source**: Auto-scaling logic or predictive warming\n- **Data**: `FunctionDefinition` containing runtime, handler, resource limits\n- **Outcome**: Container creation initiated via `ContainerManager`\n\n**2. ContainerStarted Event**\n- **Triggered by**: Successful return from `ContainerManager.StartContainer()`\n- **Source**: Container management layer\n- **Data**: Container ID, host/port assignment, startup duration\n- **Outcome**: Instance marked as ready, added to routing table and warm pool\n\n**3. RequestAssigned Event**\n- **Triggered by**: `Router.selectInstance()` choosing this instance\n- **Source**: Request routing layer\n- **Data**: `InvocationRequest` details, request deadline\n- **Outcome**: Instance state changes to ACTIVE, concurrency counters incremented\n\n**4. RequestCompleted Event**\n- **Triggered by**: Successful return from `forwardRequest()`\n- **Source**: Request routing layer after instance responds\n- **Data**: `InvocationResponse` with duration, memory usage, result\n- **Outcome**: Instance returned to pool if healthy, metrics recorded\n\n**5. RequestFailed Event**\n- **Triggered by**: Error from `forwardRequest()` (timeout, crash, error response)\n- **Source**: Request routing layer or container health check\n- **Data**: Error type, stack trace (if available), HTTP status code\n- **Outcome**: Instance may be retired (ERROR) or reset (WARM) based on error severity\n\n**6. TTLExpired Event**\n- **Triggered by**: `WarmPoolManager.cleanupExpired()` periodic check\n- **Source**: Warm pool maintenance goroutine\n- **Condition**: `instance.Age() > PoolConfig.InstanceTTL`\n- **Outcome**: Instance removed from pool, scheduled for termination\n\n**7. IdleTimeout Event**\n- **Triggered by**: `WarmPoolManager.cleanupExpired()` periodic check\n- **Source**: Warm pool maintenance goroutine\n- **Condition**: `instance.IdleDuration() > PoolConfig.IdleTimeout`\n- **Outcome**: Instance marked for scale-to-zero termination\n\n**8. ScaleDownSignal Event**\n- **Triggered by**: `Scaler.EvaluateScaling()` returning `ScaleDown` decision\n- **Source**: Auto-scaling component\n- **Condition**: Low utilization metrics and cooldown period elapsed\n- **Outcome**: Instance transitioned to DRAINING state, removed from routing\n\n**9. DrainCompleted Event**\n- **Triggered by**: All active requests finished on DRAINING instance\n- **Source**: Router monitoring request completion\n- **Condition**: `instance.activeReqs == 0` for DRAINING instance\n- **Outcome**: Container termination process initiated\n\n**10. ForceTerminate Event**\n- **Triggered by**: Drain timeout expiration or system shutdown\n- **Source**: Drain timeout timer or shutdown coordinator\n- **Condition**: DRAINING state duration > max drain timeout\n- **Outcome**: Forced container kill, immediate resource cleanup\n\n**11. HealthCheckFailed Event**\n- **Triggered by**: Container health check failure or OOM kill\n- **Source**: Container manager health monitoring\n- **Condition**: Container process died or unreachable\n- **Outcome**: Emergency cleanup, error logging, replacement instance creation\n\n#### Event-Driven Interactions Between Components\n\nThe following table shows how different system components interact through these lifecycle events:\n\n| Event | Primary Component | Secondary Component | Communication Method |\n|-------|------------------|---------------------|---------------------|\n| `CreateInstance` | `Scaler` → | `WarmPoolManager` | Direct method call |\n| `ContainerStarted` | `ContainerManager` → | `WarmPoolManager` | Callback/notification channel |\n| `RequestAssigned` | `Router` → | `FunctionInstance` | Direct state mutation |\n| `RequestCompleted` | `Router` → | `WarmPoolManager` | `ReleaseInstance()` call |\n| `ScaleDownSignal` | `Scaler` → | `Router` | Update routing table |\n| `DrainCompleted` | `Router` → | `ContainerManager` | `StopContainer()` call |\n| `HealthCheckFailed` | Health monitor → | `WarmPoolManager` | Error channel notification |\n\n#### Lifecycle Metrics and Monitoring\n\nEach state transition generates valuable metrics for system observability:\n\n| Metric | Calculation | Purpose |\n|--------|-------------|---------|\n| Provisioning Duration | `ContainerStarted` timestamp - `CreateInstance` timestamp | Measure cold start container creation time |\n| Warm Pool Size | Count of instances in `InstanceStateWarm` | Monitor resource allocation for warm starts |\n| Active Invocations | Count of instances in `InstanceStateActive` | Measure current system load |\n| Drain Time | `DrainCompleted` timestamp - ScaleDownSignal timestamp | Assess graceful shutdown efficiency |\n| Instance Lifetime | `TerminatedAt` timestamp - `CreatedAt` timestamp | Calculate container churn rate |\n| Error Rate | Instances transitioning to `InstanceStateError` / Total instances | Measure system stability |\n\n#### Concurrency and State Consistency\n\nMaintaining consistent state across concurrent operations requires careful coordination:\n\n1. **State Transition Locking**: Each `FunctionInstance` has a mutex protecting state field updates\n2. **Atomic Counters**: `activeReqs` uses `int32` with atomic operations for concurrency safety\n3. **Optimistic Concurrency Control**: Before transitioning from WARM to ACTIVE, verify `activeReqs < concurrencyLimit` with atomic check\n4. **Event Serialization**: Lifecycle events for the same instance are processed sequentially through the router's state machine\n\n> **Critical Design Principle:** The instance lifecycle follows a **single-writer principle**—only the component that \"owns\" the current state (Router for ACTIVE, WarmPoolManager for WARM, Scaler for PROVISIONING) can initiate state transitions for that instance, preventing race conditions.\n\n#### Recovery from Mid-Transition Failures\n\nThe system must handle cases where events fail mid-transition:\n\n| Failure Scenario | Detection Method | Recovery Action |\n|------------------|------------------|-----------------|\n| Container creation timeout | `CreateContainer()` timeout | Mark as ERROR, retry with exponential backoff |\n| State transition deadlock | Watchdog timer on state duration | Force transition based on heuristic (e.g., if PROVISIONING > 2min → ERROR) |\n| Lost instance (network partition) | Health check failures + lack of heartbeats | Mark as ERROR, remove from routing tables, create replacement |\n| Orphaned ACTIVE instance | No request completion after timeout + no router assignment | Force transition to ERROR via cleanup sweep |\n\nThe interaction patterns and lifecycle events described here form the operational heartbeat of the serverless runtime. By understanding these flows, developers can effectively debug issues, optimize performance, and extend the system with new capabilities while maintaining the consistency and reliability expected from a production-grade serverless platform.\n\n### Implementation Guidance\n\n#### Technology Recommendations Table\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| Request/Response Flow | HTTP/1.1 with Keep-Alive (`net/http`) | HTTP/2 with multiplexing (`golang.org/x/net/http2`) |\n| Internal Communication | Direct method calls + channels | gRPC with streaming for instance updates |\n| State Synchronization | `sync.RWMutex` per instance | Distributed consensus (etcd/Raft) for multi-node |\n| Event Propagation | Go channels with select loops | Message bus (NATS, Kafka) for distributed events |\n| Timeout Management | `context.WithTimeout` + deadlines | Hierarchical timeout chains with propagation |\n| Queue Implementation | Heap-based priority queue (`container/heap`) | Redis-backed queue with persistence |\n\n#### Recommended File/Module Structure\n\n```\nproject-root/\n  cmd/\n    gateway/                  # HTTP gateway entry point\n      main.go\n    controller/               # Management plane entry point\n      main.go\n  internal/\n    gateway/                  # Request routing component\n      gateway.go              # HTTP server and middleware\n      router.go               # Request routing logic\n      queue.go                # Request queue implementation\n      loadbalancer.go         # Instance selection algorithms\n      metrics.go              # Gateway-specific metrics\n    lifecycle/                # Instance lifecycle management\n      events.go               # Lifecycle event definitions\n      statemachine.go         # State transition logic\n      healthcheck.go          # Instance health monitoring\n    flows/                    # Data flow orchestration\n      synchronous.go          # Synchronous invocation flow\n      asynchronous.go         # Async invocation flow (future)\n      errorhandling.go        # Flow-level error recovery\n    integration/              # Component integration points\n      coordinator.go          # Orchestrates cross-component flows\n      hooks.go                # Lifecycle hooks for extensibility\n```\n\n#### Infrastructure Starter Code\n\n**Complete Flow Coordinator (Ready to Use):**\n\n```go\n// internal/integration/coordinator.go\npackage integration\n\nimport (\n    \"context\"\n    \"time\"\n    \"github.com/ourproject/internal/gateway\"\n    \"github.com/ourproject/internal/lifecycle\"\n    \"github.com/ourproject/internal/types\"\n)\n\n// FlowCoordinator orchestrates the complete invocation flow\ntype FlowCoordinator struct {\n    router        *gateway.Router\n    warmPool      pool.WarmPoolManager\n    scaler        *scaler.Scaler\n    metrics       *types.Metrics\n    eventBus      chan lifecycle.InstanceEvent\n    timeoutConfig TimeoutConfig\n}\n\ntype TimeoutConfig struct {\n    GatewayTimeout     time.Duration\n    RoutingTimeout     time.Duration\n    ForwardingTimeout  time.Duration\n    DrainTimeout       time.Duration\n    HealthCheckTimeout time.Duration\n}\n\n// NewFlowCoordinator creates a new coordinator\nfunc NewFlowCoordinator(router *gateway.Router, warmPool pool.WarmPoolManager,\n    scaler *scaler.Scaler, metrics *types.Metrics) *FlowCoordinator {\n    return &FlowCoordinator{\n        router:   router,\n        warmPool: warmPool,\n        scaler:   scaler,\n        metrics:  metrics,\n        eventBus: make(chan lifecycle.InstanceEvent, 100),\n        timeoutConfig: TimeoutConfig{\n            GatewayTimeout:     30 * time.Second,\n            RoutingTimeout:     5 * time.Second,\n            ForwardingTimeout:  25 * time.Second,\n            DrainTimeout:       10 * time.Second,\n            HealthCheckTimeout: 2 * time.Second,\n        },\n    }\n}\n\n// StartEventProcessor processes lifecycle events\nfunc (fc *FlowCoordinator) StartEventProcessor(ctx context.Context) {\n    go func() {\n        for {\n            select {\n            case <-ctx.Done():\n                return\n            case event := <-fc.eventBus:\n                fc.handleEvent(ctx, event)\n            }\n        }\n    }()\n}\n\n// handleEvent processes a single lifecycle event\nfunc (fc *FlowCoordinator) handleEvent(ctx context.Context, event lifecycle.InstanceEvent) {\n    switch event.Type {\n    case lifecycle.EventContainerStarted:\n        fc.onContainerStarted(ctx, event)\n    case lifecycle.EventRequestCompleted:\n        fc.onRequestCompleted(ctx, event)\n    case lifecycle.EventHealthCheckFailed:\n        fc.onHealthCheckFailed(ctx, event)\n    }\n}\n\n// Helper for consistent timeout handling\nfunc (fc *FlowCoordinator) withTimeout(ctx context.Context, timeout time.Duration, \n    operation string) (context.Context, context.CancelFunc) {\n    fc.metrics.OperationDuration.WithLabelValues(operation).Observe(0)\n    start := time.Now()\n    ctx, cancel := context.WithTimeout(ctx, timeout)\n    \n    // Record duration on completion\n    go func() {\n        <-ctx.Done()\n        duration := time.Since(start).Seconds()\n        fc.metrics.OperationDuration.WithLabelValues(operation).Observe(duration)\n    }()\n    \n    return ctx, cancel\n}\n```\n\n**Lifecycle Event Definitions (Ready to Use):**\n\n```go\n// internal/lifecycle/events.go\npackage lifecycle\n\nimport (\n    \"time\"\n    \"github.com/ourproject/internal/types\"\n)\n\n// InstanceEventType represents types of lifecycle events\ntype InstanceEventType string\n\nconst (\n    EventCreateInstance      InstanceEventType = \"create_instance\"\n    EventContainerStarted    InstanceEventType = \"container_started\"\n    EventRequestAssigned     InstanceEventType = \"request_assigned\"\n    EventRequestCompleted    InstanceEventType = \"request_completed\"\n    EventRequestFailed       InstanceEventType = \"request_failed\"\n    EventTTLExpired          InstanceEventType = \"ttl_expired\"\n    EventIdleTimeout         InstanceEventType = \"idle_timeout\"\n    EventScaleDownSignal     InstanceEventType = \"scale_down_signal\"\n    EventDrainCompleted      InstanceEventType = \"drain_completed\"\n    EventForceTerminate      InstanceEventType = \"force_terminate\"\n    EventHealthCheckFailed   InstanceEventType = \"health_check_failed\"\n)\n\n// InstanceEvent represents a lifecycle event\ntype InstanceEvent struct {\n    Type        InstanceEventType\n    InstanceID  string\n    FunctionName string\n    Timestamp   time.Time\n    Data        map[string]interface{}\n    Source      string\n}\n\n// NewInstanceEvent creates a new lifecycle event\nfunc NewInstanceEvent(eventType InstanceEventType, instance *types.FunctionInstance, \n    source string) InstanceEvent {\n    return InstanceEvent{\n        Type:        eventType,\n        InstanceID:  instance.ID,\n        FunctionName: instance.FunctionName,\n        Timestamp:   time.Now(),\n        Data:        make(map[string]interface{}),\n        Source:      source,\n    }\n}\n\n// EventDispatcher manages event distribution\ntype EventDispatcher struct {\n    subscribers map[string]chan InstanceEvent\n    mu          sync.RWMutex\n}\n\n// Subscribe adds a subscriber for events\nfunc (ed *EventDispatcher) Subscribe(id string, bufferSize int) <-chan InstanceEvent {\n    ed.mu.Lock()\n    defer ed.mu.Unlock()\n    \n    ch := make(chan InstanceEvent, bufferSize)\n    ed.subscribers[id] = ch\n    return ch\n}\n\n// Publish sends an event to all subscribers\nfunc (ed *EventDispatcher) Publish(event InstanceEvent) {\n    ed.mu.RLock()\n    defer ed.mu.RUnlock()\n    \n    for _, ch := range ed.subscribers {\n        select {\n        case ch <- event:\n            // Event sent successfully\n        default:\n            // Channel full, drop event (monitor this)\n        }\n    }\n}\n```\n\n#### Core Logic Skeleton Code\n\n**Synchronous Invocation Handler (To Implement):**\n\n```go\n// internal/flows/synchronous.go\npackage flows\n\nimport (\n    \"context\"\n    \"net/http\"\n    \"time\"\n    \"github.com/ourproject/internal/gateway\"\n    \"github.com/ourproject/internal/types\"\n    \"github.com/ourproject/internal/lifecycle\"\n)\n\n// SynchronousInvoker handles synchronous function invocations\ntype SynchronousInvoker struct {\n    router       *gateway.Router\n    eventDispatcher *lifecycle.EventDispatcher\n    metrics      *types.Metrics\n    config       SyncInvokerConfig\n}\n\ntype SyncInvokerConfig struct {\n    MaxQueueTime      time.Duration\n    RetryOnColdStart  bool\n    MaxRetries        int\n    EnableStickyRouting bool\n}\n\n// Invoke handles a synchronous invocation request\nfunc (si *SynchronousInvoker) Invoke(ctx context.Context, \n    req *types.InvocationRequest) (*types.InvocationResponse, error) {\n    \n    // TODO 1: Validate the request has all required fields\n    // Check req.FunctionName, req.Payload, req.Deadline\n    // Return error if validation fails\n    \n    // TODO 2: Record invocation start in metrics\n    // Use si.metrics.RecordInvocation() to track start time\n    // Increment concurrency counter for the function\n    \n    // TODO 3: Route the request through the router\n    // Call si.router.Route(ctx, req) to get response\n    // Handle context cancellation and deadlines\n    \n    // TODO 4: Process the response\n    // If error, determine if retry is appropriate (cold start timeout)\n    // For retryable errors, implement exponential backoff with MaxRetries\n    \n    // TODO 5: Record completion metrics\n    // Record duration, memory usage, success/failure\n    // Decrement concurrency counter\n    \n    // TODO 6: Handle sticky session if enabled\n    // If EnableStickyRouting and successful, store instance preference\n    // For subsequent requests from same client, use PreferredInstanceID\n    \n    // TODO 7: Return final response or error\n    // Ensure error wrapping for proper error types (timeout vs. function error)\n    \n    return nil, nil // Replace with actual implementation\n}\n\n// handleColdStartRetry determines if a cold start timeout should be retried\nfunc (si *SynchronousInvoker) handleColdStartRetry(ctx context.Context,\n    originalErr error, req *types.InvocationRequest, attempt int) (bool, error) {\n    // TODO 1: Check if error is a cold start timeout\n    // Look for \"container startup timeout\" or similar patterns\n    \n    // TODO 2: Verify we haven't exceeded MaxRetries\n    // Return false if attempt >= si.config.MaxRetries\n    \n    // TODO 3: Check if retry is enabled in config\n    // Return false if !si.config.RetryOnColdStart\n    \n    // TODO 4: Calculate backoff delay\n    // Use exponential backoff: delay = baseDelay * (2^attempt)\n    // Implement jitter to avoid thundering herd\n    \n    // TODO 5: Wait for backoff period with context awareness\n    // Use time.Sleep or <-time.After with select on ctx.Done()\n    \n    // TODO 6: Return true to indicate retry should be attempted\n    return false, nil // Replace with actual implementation\n}\n```\n\n**Instance State Machine (To Implement):**\n\n```go\n// internal/lifecycle/statemachine.go\npackage lifecycle\n\nimport (\n    \"context\"\n    \"sync\"\n    \"time\"\n    \"github.com/ourproject/internal/types\"\n)\n\n// StateMachine manages state transitions for FunctionInstance\ntype StateMachine struct {\n    instance *types.FunctionInstance\n    mu       sync.RWMutex\n    handlers map[types.FunctionInstanceState]StateHandler\n    eventCh  chan InstanceEvent\n}\n\n// StateHandler processes events for a specific state\ntype StateHandler interface {\n    HandleEvent(ctx context.Context, event InstanceEvent, \n        instance *types.FunctionInstance) (types.FunctionInstanceState, error)\n}\n\n// Transition performs a state transition with validation\nfunc (sm *StateMachine) Transition(ctx context.Context, \n    newState types.FunctionInstanceState, reason string) error {\n    \n    sm.mu.Lock()\n    defer sm.mu.Unlock()\n    \n    // TODO 1: Validate transition is allowed\n    // Check validTransitions[sm.instance.State][newState] map\n    // Return error if transition is invalid\n    \n    // TODO 2: Execute exit actions for current state\n    // Call sm.handlers[sm.instance.State].Exit() if exists\n    // Clean up resources specific to current state\n    \n    // TODO 3: Update instance state\n    // Set sm.instance.State = newState\n    // Update timestamps based on state (LastUsedAt for ACTIVE, etc.)\n    \n    // TODO 4: Execute entry actions for new state\n    // Call sm.handlers[newState].Enter() if exists\n    // Initialize resources needed for new state\n    \n    // TODO 5: Log the transition for observability\n    // Use structured logging with instance ID, old state, new state, reason\n    \n    // TODO 6: Publish state change event\n    // Send to eventCh for subscribers (monitoring, scaling decisions)\n    \n    // TODO 7: Update metrics\n    // Decrement counter for old state, increment for new state\n    \n    return nil // Replace with actual implementation\n}\n\n// ProcessEvent handles incoming lifecycle events\nfunc (sm *StateMachine) ProcessEvent(ctx context.Context, event InstanceEvent) error {\n    // TODO 1: Get current state handler\n    // handler := sm.handlers[sm.instance.State]\n    // Return error if no handler for current state\n    \n    // TODO 2: Delegate event handling to state-specific handler\n    // newState, err := handler.HandleEvent(ctx, event, sm.instance)\n    // Return error if handler returns error\n    \n    // TODO 3: Transition to new state if different\n    // if newState != sm.instance.State {\n    //     return sm.Transition(ctx, newState, string(event.Type))\n    // }\n    \n    // TODO 4: Handle same-state events (e.g., heartbeat in WARM state)\n    // Update instance metadata without state change\n    \n    return nil // Replace with actual implementation\n}\n\n// validateTransition defines allowed state transitions\nfunc (sm *StateMachine) validateTransition(oldState, newState types.FunctionInstanceState) bool {\n    // TODO: Implement validation logic based on state transition table\n    // Return true only for allowed transitions\n    // Example: PROVISIONING -> WARM (allowed), WARM -> PROVISIONING (not allowed)\n    return false // Replace with actual implementation\n}\n```\n\n#### Language-Specific Hints\n\n1. **Context Propagation**: Use `context.Context` consistently through the call chain. Create derived contexts with `context.WithTimeout()` for each stage (gateway, routing, forwarding) to ensure proper timeout cascading.\n\n2. **Error Wrapping**: Use `fmt.Errorf()` with `%w` verb to wrap errors while preserving the original error type for downstream handling decisions.\n\n3. **Concurrent State Updates**: Use `sync.RWMutex` for `FunctionInstance` state fields. For counters like `activeReqs`, use `atomic` operations (`atomic.AddInt32`, `atomic.LoadInt32`) for better performance.\n\n4. **Channel Patterns**: Use buffered channels for event distribution. Size buffers based on expected throughput (e.g., 100 for event bus). Always include `select` with `default` case or monitor channel capacity to prevent deadlocks.\n\n5. **Metrics Collection**: Use Prometheus histograms with appropriate buckets for timing metrics (e.g., `prometheus.DefBuckets` for seconds). Label metrics with `function_name` and `instance_id` for granular observability.\n\n6. **Graceful Shutdown**: Implement `Shutdown()` methods that first stop accepting new requests, wait for in-flight requests with a timeout, then clean up resources. Use `sync.WaitGroup` to track active goroutines.\n\n#### Debugging Tips\n\n| Symptom | Likely Cause | How to Diagnose | Fix |\n|---------|--------------|-----------------|-----|\n| Request times out immediately | No warm instances and cold start timeout too short | Check warm pool metrics, container startup logs | Increase cold start timeout, configure predictive warming |\n| Instance stuck in PROVISIONING | Container image pull failure or resource constraints | Check container manager logs, docker daemon status | Verify base images exist, increase resource limits |\n| Memory usage grows indefinitely | Instance not being returned to pool after errors | Monitor instance state transitions, check error handling in router | Ensure `ReleaseInstance` is called in all code paths |\n| Queue depth constantly high | Insufficient instances for load | Check scaling metrics, concurrency limits | Adjust scaling thresholds, increase MaxInstances limit |\n| Stale instances in warm pool | TTL/idle timeout not enforced | Check `cleanupExpired` goroutine, instance timestamps | Ensure cleanup goroutine is running, verify time calculations |\n| Response times spike intermittently | Garbage collection in long-running instances | Monitor Go GC pauses, memory allocation patterns | Implement instance rotation, limit instance lifetime |\n\n\n## Error Handling and Edge Cases\n\n> **Milestone(s):** Milestone 2 (Execution Environment), Milestone 3 (Cold Start Optimization), Milestone 4 (Request Routing), Milestone 5 (Auto-Scaling)\n\nIn a distributed serverless runtime, **errors are not exceptional—they're expected**. Functions execute in ephemeral, isolated environments with strict resource limits, and the control plane must manage thousands of these environments simultaneously. This section catalogs the **failure modes** our system will encounter and the **recovery strategies** that maintain system resilience while meeting service-level objectives. The design follows a **defense-in-depth** approach: each component has local error handling, while the `FlowCoordinator` orchestrates cross-component recovery when local strategies fail.\n\n### The Emergency Response Analogy\n\nThink of the runtime as a **city emergency response system**. When a fire (error) breaks out in one building (function instance), the system must:\n\n1. **Detect the emergency quickly** (smoke alarms, 911 calls)\n2. **Contain the damage** (firefighters cordon off the building)\n3. **Evacuate and reroute** (redirect traffic, provide alternate routes)\n4. **Restore normal operations** (repair the building or rebuild it)\n5. **Learn and improve** (analyze what caused the fire to prevent recurrence)\n\nOur error handling follows this same pattern: detection → containment → redirection → recovery → learning. Each component has \"sensors\" (health checks, timeouts, metrics) and \"responders\" (circuit breakers, retry logic, instance replacement) that work together to maintain system stability.\n\n### Failure Modes and Mitigations\n\nThe table below categorizes failures by their **failure domain**—whether they occur in the data plane (during function execution) or control plane (during orchestration). Each row specifies the failure, how we detect it, and the automatic recovery action. The **recovery principle** column explains the underlying strategy guiding the specific actions.\n\n| Failure Domain | Failure Mode | Description | Detection Mechanism | Recovery Action | Recovery Principle | Component(s) Involved |\n|----------------|--------------|-------------|-------------------|-----------------|-------------------|----------------------|\n| **Function Execution** | **Out-of-Memory (OOM) Kill** | Function exceeds its `MemoryMB` limit, triggering Linux OOM killer or container runtime termination | Container exits with SIGKILL (137) or OOM-specific exit code; `ContainerManager.GetContainerStats()` shows abrupt termination; `Container` status changes to `StatusDead` | 1. **Immediate**: Record OOM in `Metrics.InvocationErrors` with label `error_type=\"oom\"`<br>2. **Instance cleanup**: Call `CleanupInstance()` to remove the failed container<br>3. **Request retry**: For synchronous invocations with `RetryOnColdStart=true`, retry on a fresh instance (max 1 retry for OOM)<br>4. **Circuit breaker**: Increment failure count in `routedInstance.failures`, possibly tripping circuit breaker | **Fail-fast with controlled retry**: OOMs are likely due to function behavior, so retry cautiously with backpressure | `Executor`, `ContainerManager`, `Router`, `SynchronousInvoker` |\n| **Function Execution** | **Timeout Exceeded** | Function execution exceeds configured `Timeout` (wall-clock time) | `Executor.ExecuteFunction()` context deadline exceeded; `InvocationStatus` changes to `InvocationStatusTimeout`; Request `Deadline` passes `TimeRemaining() <= 0` | 1. **Terminate execution**: Call `StopContainer()` with `timeout=0` (force kill)<br>2. **Cleanup**: Remove container via `RemoveContainer()`<br>3. **No retry by default**: Return timeout error to client (retries would likely timeout again)<br>4. **Circuit breaker**: Mark instance as unhealthy if multiple timeouts occur | **Graceful degradation**: Timeouts indicate function slowness, not transient failure; avoid retry storms | `Executor`, `Router`, `Gateway` |\n| **Function Execution** | **Function Crash (Non-zero exit)** | Function process exits with non-zero exit code (application error, panic, unhandled exception) | Container exits with non-zero status; `Container.Status` becomes `StatusExited`; `ExecuteInContainer()` returns error with exit code | 1. **Error classification**: Parse exit code to determine if retryable (e.g., temporary file error) or non-retryable (e.g., syntax error)<br>2. **Retry policy**: For retryable errors, retry on same instance if healthy, otherwise new instance (max 2 retries)<br>3. **Instance health**: Increment `routedInstance.failures`; if exceeds threshold, mark `healthy=false`<br>4. **Metrics**: Record in `InvocationErrors` with `error_type=\"crash\"` | **Semantic retry**: Distinguish between transient and permanent failures using exit codes | `Executor`, `Router`, `SynchronousInvoker` |\n| **Function Execution** | **Sandbox Escape Attempt** | Function attempts to break out of isolation via privileged syscall, container breakout, or resource exhaustion attack | Seccomp/AppArmor violation (SIGSYS); `ContainerManager` logs security violation; abnormal resource usage patterns in `ContainerStats` | 1. **Immediate termination**: Kill container via `StopContainer()` with `timeout=0`<br>2. **Blacklist**: Optionally blacklist function version if repeated violations<br>3. **No retry**: Fail request immediately with security violation error<br>4. **Alert**: Raise security alert to operator | **Zero-tolerance containment**: Security violations are non-retryable and require operator investigation | `ContainerManager`, `Executor`, `Gateway` |\n| **Function Execution** | **Resource Leak (File descriptors, threads)** | Function exhausts per-container resources without triggering OOM | `ContainerStats.PIDs` approaches limit; `GetContainerStats()` shows high FD usage; subsequent invocations fail with \"resource unavailable\" errors | 1. **Proactive recycling**: `WarmPoolManager` calls `CleanupInstance()` between invocations to reset environment<br>2. **Health checks**: Periodic `ExecuteInContainer()` with simple \"ping\" command to verify instance health before reuse<br>3. **Instance replacement**: If resource usage exceeds 80% of limit, mark instance for replacement after current invocation | **Preventive maintenance**: Assume functions are buggy; proactively clean and validate between uses | `WarmPoolManager`, `Executor`, `RuntimeCleaner` |\n| **Control Plane** | **Cold Start Timeout** | Creating/initializing a new instance exceeds acceptable latency (e.g., >10 seconds) | `RecordColdStart()` measures time from `EventCreateInstance` to `EventContainerStarted`; `Metrics.ColdStartLatency` exceeds threshold; `InstanceState` stuck in `InstanceStateProvisioning` | 1. **Abandon creation**: Cancel the pending container creation context<br>2. **Retry on alternate node**: For multi-node deployments, retry creation on different worker<br>3. **Fallback to warm**: If available, use existing warm instance even if not ideal (e.g., different version)<br>4. **Queue timeout**: If no instance ready within timeout, fail request with \"cold start timeout\" | **Time-bound provisioning**: Don't let slow provisioning block request processing indefinitely | `WarmPoolManager`, `Executor`, `SynchronousInvoker` |\n| **Control Plane** | **Container Startup Failure** | Container fails to start due to missing base image, invalid command, or runtime conflict | `ContainerManager.CreateContainer()` or `StartContainer()` returns error; `Container.Status` becomes `StatusDead` without reaching `StatusRunning` | 1. **Exponential backoff**: Delay retry with exponential backoff (1s, 2s, 4s...)<br>2. **Image pre-pull**: Ensure base images are pre-pulled to worker nodes<br>3. **Fallback image**: Use older compatible runtime image if latest fails<br>4. **Alert**: Notify operator of persistent image pull failures | **Degraded operation**: Continue serving other functions while diagnosing image issues | `ContainerManager`, `WarmPoolManager`, `FlowCoordinator` |\n| **Request Routing** | **Instance Unhealthy (Zombie)** | Instance appears healthy but doesn't respond to requests (network partition, hung process) | Health check fails (TCP connection refused, HTTP 5xx); `forwardRequest()` timeout; `CircuitBreaker` trips after consecutive failures | 1. **Circuit breaker**: Trip circuit for that instance; stop routing requests to it<br>2. **Replacement**: Schedule instance for termination via `EventForceTerminate`<br>3. **Drain existing**: If instance has `activeReqs > 0`, wait `DrainTimeout` before force termination<br>4. **New instance**: Trigger scale-up to replace lost capacity | **Failover with isolation**: Isolate failed instance before removing it to avoid interrupting in-flight requests | `Router`, `CircuitBreaker`, `FlowCoordinator` |\n| **Request Routing** | **Request Queue Overflow** | Request queue reaches `maxSize`, unable to accept new requests | `RequestQueue.Enqueue()` returns \"queue full\" error; `gatewayMetrics.queueDepth` at 100% capacity | 1. **Load shedding**: Reject new requests with HTTP 503 \"Service Unavailable\"<br>2. **Priority-based eviction**: If using priority queue, evict lowest-priority requests first<br>3. **Emergency scale-up**: Bypass cooldown to scale up immediately<br>4. **Client backoff**: Include `Retry-After` header in 503 response | **Graceful load shedding**: Better to reject some requests than fail all due to overload | `Gateway`, `RequestQueue`, `Scaler` |\n| **Request Routing** | **Gateway Timeout** | Entire request path exceeds `GatewayTimeout` before reaching function | `Gateway` middleware cancels context after timeout; `InvocationStatus` remains `InvocationStatusPending` | 1. **Cancel downstream**: Cancel context for all downstream operations (queue, routing, execution)<br>2. **Cleanup**: If request was dequeued but not yet assigned, return to queue (if idempotent)<br>3. **Client response**: Return HTTP 504 \"Gateway Timeout\"<br>4. **Avoid retry storm**: Client should use exponential backoff after gateway timeout | **Holistic timeout propagation**: All components respect the same timeout chain | `Gateway`, `Router`, `RequestQueue` |\n| **Auto-Scaling** | **Scaling Thrashing** | Rapid oscillation between scale-up and scale-down due to metric noise or misconfigured thresholds | `Scaler` metrics show frequent `ScaleDecision` changes; `ScaleUp` immediately followed by `ScaleDown`; high `ContainerOperations` churn rate | 1. **Hysteresis**: Use different thresholds for scale-up vs scale-down (e.g., scale-up at 70% concurrency, scale-down at 30%)<br>2. **Cooldown periods**: Enforce `ScaleUpCooldown` and `ScaleDownCooldown` between scale actions<br>3. **Smoothing**: Use moving averages instead of instantaneous metrics<br>4. **Minimum instance lifetime**: Ensure instances live for at least `InstanceTTL` before scale-down | **Stability over optimality**: Prefer slightly suboptimal scaling to constant churn | `Scaler`, `MetricsCollector` |\n| **Auto-Scaling** | **Scale-to-Zero Race Condition** | Last instance terminates while new request arrives | `InstanceState` transitions to `InstanceStateTerminated` while request in flight or queued | 1. **Termination delay**: When scaling to zero, wait `IdleTimeout + buffer` before terminating last instance<br>2. **Recreate on demand**: If request arrives after termination, trigger cold start<br>3. **Request preservation**: Maintain queue across scale-to-zero transitions<br>4. **Idle instance promotion**: Keep one instance in `InstanceStateWarm` if requests pending | **Lazy termination**: Verify true idle state before terminating last instance | `Scaler`, `WarmPoolManager`, `Router` |\n| **Data Persistence** | **Artifact Storage Unavailable** | Backend storage (S3, filesystem) fails during function package upload or retrieval | `ProcessUpload()` returns storage error; `GetArtifact()` fails; `ArtifactStorage` health check fails | 1. **Retry with backoff**: Retry storage operations with exponential backoff<br>2. **Local cache**: Use local filesystem cache for frequently accessed artifacts<br>3. **Degraded upload**: Accept uploads but mark as \"pending storage\"<br>4. **Read-only mode**: If storage completely unavailable, serve existing functions but reject new deployments | **Caching with eventual consistency**: Prefer serving stale artifacts over complete failure | `Coordinator`, `ArtifactStorage` |\n| **Lifecycle Management** | **Drain Stuck** | Instance in `InstanceStateDraining` never completes (hung request, infinite loop) | `Instance` remains in `InstanceStateDraining` beyond `DrainTimeout`; `activeReqs` stays >0 | 1. **Force termination**: After `DrainTimeout`, send `EventForceTerminate`<br>2. **Lossy shutdown**: Kill container via `StopContainer()` with `timeout=0`<br>3. **Client notification**: If possible, notify client of interrupted request<br>4. **Post-mortem**: Log container state before termination for debugging | **Bounded graceful period**: Graceful shutdown has a time limit | `StateMachine`, `FlowCoordinator`, `ContainerManager` |\n| **Multi-Tenancy** | **Noisy Neighbor** | One function monopolizes shared resources (CPU, I/O), affecting others | `ContainerStats` shows sustained high CPU/IO for one container while others starve; elevated `InvocationDuration` for unaffected functions | 1. **Resource enforcement**: Strict `CPUQuota` via cgroups CPU shares<br>2. **I/O throttling**: Use blkio cgroup to limit disk I/O<br>3. **Workload isolation**: Schedule aggressive functions on separate worker nodes<br>4. **SLA enforcement**: Preemptively throttle or reject requests from misbehaving functions | **Strong isolation boundaries**: Assume worst-case behavior and enforce hard limits | `ContainerManager`, `CGroupHelper`, `Scheduler` |\n| **Network** | **Network Partition** | Worker node loses connectivity to control plane or storage | Health checks fail; `ContainerManager.HealthCheck()` returns error; metrics stop flowing | 1. **Fencing**: Control plane marks node as unhealthy and stops routing to it<br>2. **Self-termination**: Worker node self-terminates its containers after grace period<br>3. **Reconciliation**: Control plane recreates lost instances on healthy nodes<br>4. **Client redirection**: Update DNS/routing to bypass partitioned node | **Fail-stop then rebuild**: Assume partitioned nodes are lost and rebuild elsewhere | `FlowCoordinator`, `Router`, `ContainerManager` |\n\n### Error Recovery Architecture\n\nThe table above shows individual failure modes, but the system's resilience comes from **coordinated recovery across components**. The architecture follows these principles:\n\n1. **Defense in Depth**: Each component handles local errors, with escalation to `FlowCoordinator` for cross-component issues\n2. **Graceful Degradation**: When optimal operation isn't possible, provide degraded but functional service\n3. **Observability-Driven**: All errors are captured in metrics and logs for analysis and improvement\n4. **Idempotent Operations**: Recovery actions can be safely retried without double side effects\n\nThe `FlowCoordinator` serves as the **central nervous system** for error recovery. It subscribes to `InstanceEvent` streams from all components and implements the following recovery state machine:\n\n| Current State | Trigger Event | Recovery Action | Next State |\n|---------------|---------------|-----------------|------------|\n| `InstanceHealthy` | `EventHealthCheckFailed` (1x) | Mark instance `healthy=false` in router | `InstanceUnhealthy` |\n| `InstanceUnhealthy` | `EventHealthCheckFailed` (3x) | Trip circuit breaker; schedule replacement | `InstanceReplacing` |\n| `InstanceReplacing` | `EventCreateInstance` (new) | Route traffic to new instance | `InstanceHealthy` |\n| `InstanceReplacing` | `EventForceTerminate` (old) | Force kill old container | `InstanceTerminated` |\n| `ScaleOscillation` | Consecutive `ScaleUp`/`ScaleDown` | Increase cooldown periods; log alert | `ScaleStabilized` |\n| `StorageDegraded` | Storage errors > threshold | Enable read-only mode; alert operator | `StorageMaintenance` |\n\n### Common Error Propagation Patterns\n\nWhen an error occurs, it propagates through the system following these paths:\n\n1. **Execution Error → Router → Client**\n   ```\n   Function OOM → Executor detects exit code → Router.forwardRequest() returns error → \n   Router.updateInstanceHealth() marks instance unhealthy → Gateway returns 500 to client\n   ```\n\n2. **Infrastructure Error → FlowCoordinator → Auto-recovery**\n   ```\n   Container startup failure → WarmPoolManager emits EventContainerStartFailed →\n   FlowCoordinator.handleEvent() → Scaler.evaluateScaling() triggers scale-up →\n   New instance created → Router updates routing table\n   ```\n\n3. **Resource Exhaustion → Multiple Components → Load Shedding**\n   ```\n   Memory pressure → Multiple OOM events → Metrics show high error rate →\n   Scaler triggers scale-up → RequestQueue fills → Gateway returns 503 →\n   Client backs off → System stabilizes\n   ```\n\n### Implementation Guidance\n\n> **Technology Recommendations**\n> \n> | Component | Simple Option | Advanced Option |\n> |-----------|---------------|-----------------|\n> | Error Detection | Exit code parsing, timeout contexts | eBPF probes for deep container inspection, distributed tracing |\n> | Health Checking | TCP/HTTP health checks | Custom protocol with version/checksum validation |\n> | Circuit Breaking | Simple failure count threshold | Adaptive circuit breaking based on latency percentiles |\n> | Retry Logic | Fixed-count retry with jitter | Exponential backoff with retry budgets across function boundaries |\n> | Error Metrics | Prometheus counters with error type labels | Structured logging with error causality chains |\n\n#### Error Handling Infrastructure\n\nCreate a shared error handling package that standardizes error classification and recovery policies:\n\n```go\n// internal/errors/errors.go\npackage errors\n\nimport (\n    \"context\"\n    \"errors\"\n    \"time\"\n)\n\n// ErrorType categorizes errors for metrics and recovery decisions\ntype ErrorType string\n\nconst (\n    ErrorTypeOOM          ErrorType = \"oom\"\n    ErrorTypeTimeout      ErrorType = \"timeout\"\n    ErrorTypeCrash        ErrorType = \"crash\"\n    ErrorTypeSandbox      ErrorType = \"sandbox_escape\"\n    ErrorTypeNetwork      ErrorType = \"network\"\n    ErrorTypeStorage      ErrorType = \"storage\"\n    ErrorTypeStartup      ErrorType = \"startup\"\n    ErrorTypeHealthCheck  ErrorType = \"health_check\"\n)\n\n// ClassifiedError wraps an error with classification metadata\ntype ClassifiedError struct {\n    Err         error\n    Type        ErrorType\n    Retryable   bool\n    ExitCode    int\n    InstanceID  string\n    Function    string\n    Timestamp   time.Time\n}\n\n// RecoveryPolicy determines retry behavior based on error type\ntype RecoveryPolicy struct {\n    MaxRetries      int\n    BackoffBase     time.Duration\n    BackoffMax      time.Duration\n    RetryOnSameInstance bool\n}\n\n// PolicyForErrorType returns recovery policy for error type\nfunc PolicyForErrorType(t ErrorType) RecoveryPolicy {\n    switch t {\n    case ErrorTypeOOM:\n        return RecoveryPolicy{MaxRetries: 1, BackoffBase: 0, RetryOnSameInstance: false}\n    case ErrorTypeTimeout:\n        return RecoveryPolicy{MaxRetries: 0} // No retry for timeouts\n    case ErrorTypeCrash:\n        return RecoveryPolicy{MaxRetries: 2, BackoffBase: 100 * time.Millisecond, RetryOnSameInstance: false}\n    case ErrorTypeNetwork:\n        return RecoveryPolicy{MaxRetries: 3, BackoffBase: 1 * time.Second, RetryOnSameInstance: true}\n    default:\n        return RecoveryPolicy{MaxRetries: 1, BackoffBase: 0}\n    }\n}\n\n// ShouldRetry determines if error should be retried based on policy and attempt count\nfunc ShouldRetry(err *ClassifiedError, attempt int) bool {\n    policy := PolicyForErrorType(err.Type)\n    return err.Retryable && attempt < policy.MaxRetries\n}\n```\n\n#### Enhanced Executor with Error Classification\n\n```go\n// internal/executor/executor.go (partial)\npackage executor\n\nimport (\n    \"context\"\n    \"syscall\"\n    \"github.com/ourproject/internal/errors\"\n)\n\n// executeWithRecovery wraps function execution with error classification and recovery\nfunc (e *Executor) executeWithRecovery(ctx context.Context, def *types.FunctionDefinition, req *types.InvocationRequest) (*types.InvocationResponse, error) {\n    var attempt int\n    var lastErr *errors.ClassifiedError\n    \n    for attempt = 0; attempt < maxTotalAttempts; attempt++ {\n        resp, err := e.executeSingle(ctx, def, req)\n        \n        if err == nil {\n            return resp, nil\n        }\n        \n        // Classify the error\n        classified := e.classifyExecutionError(err, def, req)\n        lastErr = classified\n        \n        // Record metrics\n        e.metrics.InvocationErrors.WithLabelValues(string(classified.Type), def.Name).Inc()\n        \n        // Check if we should retry\n        if !errors.ShouldRetry(classified, attempt) {\n            break\n        }\n        \n        // Apply backoff if needed\n        policy := errors.PolicyForErrorType(classified.Type)\n        if policy.BackoffBase > 0 {\n            select {\n            case <-ctx.Done():\n                return nil, ctx.Err()\n            case <-time.After(policy.BackoffBase * (1 << attempt)): // Exponential backoff\n                // Continue to retry\n            }\n        }\n        \n        // If not retrying on same instance, clean up and get new instance\n        if !policy.RetryOnSameInstance {\n            // TODO: Clean up current container and acquire fresh instance\n        }\n    }\n    \n    // All retries exhausted or non-retryable error\n    return nil, &errors.ClassifiedError{\n        Err:        fmt.Errorf(\"execution failed after %d attempts: %v\", attempt+1, lastErr.Err),\n        Type:       lastErr.Type,\n        Retryable:  false,\n        InstanceID: lastErr.InstanceID,\n        Function:   def.Name,\n        Timestamp:  time.Now(),\n    }\n}\n\n// classifyExecutionError maps raw execution errors to classified types\nfunc (e *Executor) classifyExecutionError(rawErr error, def *types.FunctionDefinition, req *types.InvocationRequest) *errors.ClassifiedError {\n    // TODO 1: Check if error is context deadline exceeded → ErrorTypeTimeout\n    // TODO 2: Parse exit code: 137 (SIGKILL) → ErrorTypeOOM\n    // TODO 3: Check seccomp violation → ErrorTypeSandbox  \n    // TODO 4: Check network errors → ErrorTypeNetwork\n    // TODO 5: Default to ErrorTypeCrash for other non-zero exits\n    // TODO 6: Set Retryable based on error type and exit code\n    // TODO 7: Extract instance ID from context or request metadata\n    return &errors.ClassifiedError{Type: errors.ErrorTypeCrash, Retryable: false}\n}\n```\n\n#### FlowCoordinator Event Handler\n\n```go\n// internal/coordinator/flow_coordinator.go (partial)\nfunc (fc *FlowCoordinator) handleEvent(ctx context.Context, event lifecycle.InstanceEvent) error {\n    fc.mu.Lock()\n    defer fc.mu.Unlock()\n    \n    switch event.Type {\n    case lifecycle.EventHealthCheckFailed:\n        // TODO 1: Get instance from router's routing table\n        // TODO 2: Increment failure count for the instance\n        // TODO 3: If failure count > threshold, trip circuit breaker\n        // TODO 4: Schedule instance replacement via Scaler\n        // TODO 5: Emit EventForceTerminate if instance is unrecoverable\n        \n    case lifecycle.EventRequestFailed:\n        // TODO 1: Parse error type from event.Data\n        // TODO 2: Update instance health in router\n        // TODO 3: If error indicates resource exhaustion, trigger scale-up\n        // TODO 4: Record failure in Metrics.InvocationErrors\n        \n    case lifecycle.EventContainerStarted:\n        // TODO 1: Update instance state to InstanceStateWarm\n        // TODO 2: Register instance with router\n        // TODO 3: Update warm pool metrics\n        \n    case lifecycle.EventTTLExpired:\n        // TODO 1: Check if instance has active requests (activeReqs > 0)\n        // TODO 2: If no active requests, terminate immediately\n        // TODO 3: If has active requests, transition to InstanceStateDraining\n        // TODO 4: Set drain timeout\n    }\n    \n    return nil\n}\n```\n\n#### Debugging Error Scenarios\n\n| Symptom | Likely Cause | How to Diagnose | Fix |\n|---------|--------------|-----------------|-----|\n| **Functions timeout immediately** | Cold start latency exceeds timeout; misconfigured timeout values | Check `Metrics.ColdStartLatency` percentiles; verify function `Timeout` configuration | Increase function timeout; improve cold start optimization; use provisioned concurrency |\n| **High OOM error rate** | Memory limits too low; function has memory leak | Check `ContainerStats.MemoryUsage` before OOM; compare with `MemoryMB` limit | Increase memory limit; add memory profiling to functions; implement garbage collection between invocations |\n| **Request queue constantly full** | Insufficient instances; scaling too slow | Check `queueDepth` metrics; examine `Scaler` decisions and cooldown periods | Adjust scaling thresholds; reduce cooldown periods; increase max instances |\n| **Instance churn (high create/delete rate)** | Scaling thrashing; idle timeout too short | Check `ContainerOperations` counter; examine scale decision log for rapid oscillations | Implement hysteresis; increase cooldown periods; adjust scale thresholds |\n| **Functions return \"connection refused\"** | Instance died but still in routing table; network partition | Check instance health status in router; verify container actually running | Implement active health checks; add circuit breakers; reduce health check interval |\n| **Cold starts take >10 seconds** | Large dependencies; slow storage; image pull latency | Profile cold start phases: image pull, container create, runtime init, handler load | Use pre-warmed base images; implement dependency caching; use snapshot/restore |\n\n#### Testing Error Recovery\n\nCreate integration tests that simulate failures and verify recovery:\n\n```bash\n# Test OOM recovery\n$ curl -X POST http://localhost:8080/invoke/leaky-function \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"action\": \"allocate_memory\", \"mb\": 1024}'\n# Should return 500 on first attempt, then potentially succeed on retry\n# Verify metrics show ErrorTypeOOM increment\n\n# Test timeout handling  \n$ curl -X POST http://localhost:8080/invoke/slow-function \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"sleep_ms\": 10000}' \\\n  --max-time 5\n# Should return 504 Gateway Timeout after 5 seconds\n# Verify instance is marked unhealthy after multiple timeouts\n\n# Test circuit breaker\n$ for i in {1..10}; do\n    curl -X POST http://localhost:8080/invoke/unhealthy-function\n  done\n# First few should return 500, then circuit should trip and return 503\n# Verify circuit breaker metrics\n\n```\n\n\n## Testing Strategy\n> **Milestone(s):** Milestone 1, Milestone 2, Milestone 3, Milestone 4, Milestone 5\n\nThe testing strategy for the serverless function runtime follows a **layered pyramid approach**, emphasizing unit tests at the component level, integration tests for cross-component interactions, and end-to-end system tests for complete workflows. Given the system's distributed nature and reliance on Linux kernel features (cgroups, namespaces), we employ a combination of in-process testing for business logic and container-based testing for isolation features. The testing philosophy prioritizes **deterministic behavior** for core routing and scaling logic while acknowledging **probabilistic outcomes** for race conditions in concurrent scenarios.\n\n### Testing Philosophy and Levels\n\nThe testing approach is organized into four distinct levels, each serving a specific verification purpose:\n\n1. **Unit Tests** - Test individual components in isolation using mocks and fakes for dependencies\n2. **Integration Tests** - Test interactions between 2-3 components with real implementations\n3. **System Tests** - Test complete workflows using containerized test environments\n4. **Property-Based Tests** - Test invariants and edge cases using generated inputs\n\nThe testing pyramid distribution targets 70% unit tests, 20% integration tests, and 10% system tests. Property-based tests supplement each level to uncover edge cases that example-based testing might miss.\n\n#### Unit Testing Strategy\n\nUnit tests focus on **pure business logic** without external dependencies. Each component's public API is tested against a comprehensive matrix of inputs, including error conditions. The table below outlines the key unit testing patterns:\n\n| Component | Testing Focus | Mock Dependencies | Key Assertions |\n|-----------|---------------|-------------------|----------------|\n| `Router` | Routing logic, load balancing, circuit breaking | `InstanceManager`, network calls | Instance selection correctness, circuit breaker state transitions |\n| `Scaler` | Scaling decisions, metrics aggregation | `MetricsCollector`, `WarmPoolManager` | Scale decision triggers, cooldown enforcement, threshold calculations |\n| `WarmPoolManager` | Pool management, TTL enforcement | `ContainerManager`, time source | Pool size limits, instance reuse, cleanup scheduling |\n| `Coordinator` (packaging) | Dependency resolution, artifact building | Filesystem, network calls | Artifact integrity, dependency conflict handling |\n| `Executor` | Container lifecycle, resource limits | `ContainerManager`, cgroup operations | Resource limit application, timeout enforcement |\n\nEach unit test follows the **Arrange-Act-Assert** pattern with clear separation of test setup, execution, and verification. Mock implementations use the Go `interface` types defined in the architecture, allowing dependency injection.\n\n#### Integration Testing Strategy\n\nIntegration tests verify that components work correctly together, particularly focusing on:\n- **Lifecycle coordination** between router, warm pool, and scaler\n- **Error propagation** across component boundaries\n- **Concurrent access patterns** with realistic timing\n- **State consistency** during failure recovery\n\nIntegration tests use **real implementations** for adjacent components but may mock outbound dependencies like Docker daemon or storage backends. The test environment provides **deterministic time** via a mockable clock interface to eliminate timing flakiness.\n\n#### System Testing Strategy\n\nSystem tests execute complete workflows in an environment that approximates production:\n- **Container-based test runner** that creates isolated Docker networks\n- **Function simulation** using lightweight HTTP servers in containers\n- **Load generation** to test scaling behavior under realistic patterns\n- **Failure injection** to verify recovery mechanisms\n\nSystem tests are **resource-intensive** and run in CI/CD pipelines rather than developer workstations. They use the `testcontainers` pattern to spin up necessary dependencies (Docker daemon, mock storage) and clean them up after test completion.\n\n### Test Environment Architecture\n\nThe test environment is structured to support all testing levels while maintaining reproducibility:\n\n```\ntest-environment/\n├── mocks/                    # Generated mock implementations\n├── fixtures/                 # Test data and function code samples\n├── integration/              # Integration test suites\n├── system/                   # System test suites\n└── helpers/                  # Reusable test utilities\n```\n\nKey test utilities include:\n\n| Utility | Purpose | Used In |\n|---------|---------|---------|\n| `MockContainerManager` | Simulates container operations without Docker | Unit & integration tests |\n| `FakeClock` | Provides controllable time for timing-sensitive tests | All test levels |\n| `RecordingMetrics` | Captures metric emissions for verification | Unit & integration tests |\n| `TestFunctionServer` | HTTP server simulating function behavior | Integration & system tests |\n| `InMemoryStorage` | Ephemeral storage for artifacts and metadata | Unit & integration tests |\n\n### Testing Edge Cases and Failure Modes\n\nThe testing strategy explicitly addresses the failure modes documented in the \"Error Handling and Edge Cases\" section. Each failure mode has corresponding test scenarios:\n\n| Failure Mode | Test Category | Verification Approach |\n|--------------|---------------|----------------------|\n| Container OOM kill | System test | Configure memory limit below function requirement, verify error classification |\n| Cold start timeout | Integration test | Mock slow container startup, verify retry logic |\n| Scaling thrashing | Property-based test | Generate oscillating load patterns, verify cooldown prevents thrashing |\n| Queue overflow | Integration test | Send requests exceeding queue capacity, verify load shedding |\n| Network partition | System test | Simulate network failure between components, verify circuit breaking |\n| Resource exhaustion | Integration test | Exhaust file descriptors, CPU, memory; verify graceful degradation |\n\nProperty-based tests using the `quick` or `gopter` libraries generate random inputs to discover edge cases in state transitions, especially in the `StateMachine` and `Router` components.\n\n### Performance and Benchmark Testing\n\nBeyond functional correctness, the system includes performance benchmarks to track:\n- **Cold start latency** under various configurations\n- **Memory footprint** of warm pool instances\n- **Routing overhead** at different request rates\n- **Scaling decision latency** during load spikes\n\nBenchmarks use the Go `testing.B` framework and produce comparative reports. Performance regressions trigger alerts in the CI pipeline.\n\n### Test Data Management\n\nTest data follows these principles:\n- **Minimal representative samples** for function code (hello-world handlers)\n- **Generated test cases** for dependency resolution scenarios\n- **Golden files** for expected artifact structures\n- **Seeded randomness** for reproducible property tests\n\nFunction test fixtures include examples for each supported runtime (Go, Python, Node.js) with varying complexity levels.\n\n### Continuous Integration Pipeline\n\nThe CI pipeline executes tests in this sequence:\n1. **Static analysis** (go vet, staticcheck, security scanning)\n2. **Unit tests** (fast, mandatory for all PRs)\n3. **Integration tests** (medium duration, required for main branch)\n4. **System tests** (long duration, nightly runs)\n5. **Benchmarks** (performance tracking, weekly runs)\n\nTest results include coverage reports, with a minimum threshold of 80% line coverage for the core components (`Router`, `Scaler`, `WarmPoolManager`, `Executor`).\n\n### Milestone Implementation Checkpoints\n\nEach milestone has specific verification checkpoints to ensure incremental progress. The checkpoints progress from isolated component behavior to integrated system behavior.\n\n#### Milestone 1: Function Packaging Checkpoints\n\n> **Objective:** Verify that function code can be uploaded, packaged with dependencies, stored, and retrieved.\n\n| Checkpoint | Expected Behavior | Verification Commands | Success Criteria |\n|------------|-------------------|----------------------|------------------|\n| **1.1 - Upload API** | HTTP endpoint accepts multipart file upload and returns function ID | `curl -X POST -F \"file=@hello.go\" http://localhost:8080/upload` | Returns JSON with `{\"function_name\": \"hello\", \"version\": \"v1\", \"artifact_hash\": \"sha256:...\"}` |\n| **1.2 - Dependency Resolution** | Go dependencies resolved from `go.mod` and bundled | Upload function with imports; inspect generated artifact | Artifact contains all transitive dependencies in `vendor/` directory |\n| **1.3 - Artifact Storage** | Package stored durably and retrievable by hash | Upload function, then `curl http://localhost:8080/artifacts/{hash}` | Returns exact same bytes as uploaded (verified by hash comparison) |\n| **1.4 - Multi-Runtime Support** | Python and Node.js functions packaged correctly | Upload Python function with `requirements.txt`, Node.js with `package.json` | Python artifact includes virtualenv, Node.js includes `node_modules` |\n| **1.5 - Version Immutability** | Same code produces same hash, preventing modification | Upload identical function twice | Same artifact hash returned; storage reports duplicate |\n| **1.6 - Validation** | Invalid function definitions rejected | Upload function without handler, with unsupported runtime | Returns 400 Bad Request with specific error message |\n\n**Verification workflow:**\n```bash\n# Run unit tests for packaging components\ngo test ./internal/packaging/... -v -count=1\n\n# Start test server with in-memory storage\ngo run cmd/test-server/main.go --storage=memory\n\n# Upload test function (from testdata directory)\ncurl -X POST -F \"file=@testdata/hello-go/hello.go\" \\\n  -F \"runtime=go\" -F \"handler=Handler\" \\\n  http://localhost:8080/upload\n\n# Verify artifact exists\ncurl http://localhost:8080/artifacts/{hash-from-response}\n```\n\n**Expected observations:**\n- Upload endpoint responds within 500ms for simple functions\n- Artifact size correlates with dependency count (e.g., empty function ~10KB, with dependencies ~1-10MB)\n- Hash changes when any file content changes (code or dependencies)\n- Storage backend reports deduplication for identical uploads\n\n#### Milestone 2: Execution Environment Checkpoints\n\n> **Objective:** Verify that functions execute in isolated containers with enforced resource limits.\n\n| Checkpoint | Expected Behavior | Verification Commands | Success Criteria |\n|------------|-------------------|----------------------|------------------|\n| **2.1 - Container Creation** | Isolated environment created from base image | `executor.ExecuteFunction` with simple function | Container created with unique ID, runtime-specific base image |\n| **2.2 - Resource Limits** | Memory and CPU limits enforced | Function that allocates memory beyond limit | Container terminated with OOM kill, `ErrorTypeOOM` classification |\n| **2.3 - Timeout Enforcement** | Execution terminated after timeout | Function with `time.Sleep` exceeding timeout | Returns `ErrorTypeTimeout` after configured duration |\n| **2.4 - Filesystem Isolation** | Clean `/tmp` per invocation | Function writes to `/tmp/test.txt` | File exists during execution, not visible to other invocations |\n| **2.5 - Network Isolation** | Outbound connectivity controlled | Function attempts to connect to external service | Connection succeeds/fails per network policy configuration |\n| **2.6 - Cleanup** | Resources released after execution | Monitor Docker containers before/after execution | No lingering containers from completed executions |\n\n**Verification workflow:**\n```bash\n# Test resource limit enforcement\ngo test ./internal/executor/... -run TestMemoryLimit -v\n\n# Run integration test with actual Docker\nDOCKER_HOST=unix:///var/run/docker.sock \\\n  go test ./integration/executor/... -v\n\n# Manual test: run memory-hungry function\ncat > memory_test.go << 'EOF'\npackage main\nfunc Handler() string {\n  // Allocate 200MB when limit is 128MB\n  data := make([]byte, 200*1024*1024)\n  return \"ok\"\n}\nEOF\n\n# Upload and invoke with 128MB memory limit\n# Expect OOM error in response\n```\n\n**Expected observations:**\n- Container creation takes 500ms-2s depending on base image size\n- Memory limit violations detected within 100ms of allocation\n- Timeout precision within ±50ms of configured value\n- Post-execution Docker `ps` shows no containers with project labels\n- CPU throttling observable via `docker stats` during CPU-intensive functions\n\n#### Milestone 3: Cold Start Optimization Checkpoints\n\n> **Objective:** Verify that warm instances reduce startup latency and snapshot/restore works correctly.\n\n| Checkpoint | Expected Behavior | Verification Commands | Success Criteria |\n|------------|-------------------|----------------------|------------------|\n| **3.1 - Warm Pool Population** | Instances created and added to pool | `PreWarm` called for function | Specified number of containers in `StatusRunning` but idle |\n| **3.2 - Warm Start Latency** | Request to warm instance faster than cold | Measure `AcquireWarmInstance` + execution vs cold path | Warm start < 100ms, cold start > 500ms (language-dependent) |\n| **3.3 - Instance Reuse** | Instance returns to pool after execution | Invoke function twice with `ReleaseInstance` | Same container ID used for both invocations |\n| **3.4 - Pool Size Limits** | Pool respects max/min instance counts | Call `PreWarm` beyond max, monitor pool | Extra instances not created or immediately cleaned up |\n| **3.5 - TTL Expiration** | Old instances removed from pool | Create instance, wait beyond TTL, check cleanup | Instance terminated, removed from pool store |\n| **3.6 - Snapshot/Restore** | Checkpointed container restores quickly | Use CRIU to checkpoint, measure restore time | Restore < 50ms from snapshot file |\n\n**Verification workflow:**\n```bash\n# Benchmark cold vs warm starts\ngo test ./internal/pool/... -bench=\".*Start.*\" -benchtime=10s\n\n# Test pool lifecycle\ngo test ./internal/pool/... -run TestPoolLifecycle -v\n\n# Manual test: observe container reuse\n# Terminal 1: Start gateway with verbose logging\nLOG_LEVEL=debug go run cmd/gateway/main.go\n\n# Terminal 2: Invoke function twice with 1s gap\ncurl http://localhost:8080/invoke/hello\nsleep 1\ncurl http://localhost:8080/invoke/hello\n\n# Check logs: second request should show \"using warm instance\"\n```\n\n**Expected observations:**\n- First invocation shows \"cold start\" in logs with 500ms+ duration\n- Second invocation shows \"warm start\" with <100ms duration\n- `docker ps` shows container persists between invocations\n- Pool metrics show instance count stabilizing at configured max/min\n- Memory usage increases with pool size but stabilizes\n- Old instances cleaned up exactly at TTL expiration\n\n#### Milestone 4: Request Routing Checkpoints\n\n> **Objective:** Verify that requests are correctly routed, queued, load balanced, and timed out.\n\n| Checkpoint | Expected Behavior | Verification Commands | Success Criteria |\n|------------|-------------------|----------------------|------------------|\n| **4.1 - HTTP Gateway** | Endpoint accepts requests, routes to function | `curl http://localhost:8080/invoke/hello` | Request forwarded to function instance, response returned |\n| **4.2 - Load Balancing** | Requests distributed across instances | Launch 3 instances, send 10 requests | Requests spread across instances (round-robin or least-connections) |\n| **4.3 - Request Queuing** | Queue buffers requests when busy | All instances busy, send additional request | Request queued, executes when instance available |\n| **4.4 - Concurrency Limits** | Per-function concurrency enforced | Send parallel requests exceeding limit | Excess requests queued or rejected (per configuration) |\n| **4.5 - Circuit Breaking** | Unhealthy instances avoided | Kill container, send requests | Failures counted, instance marked unhealthy after threshold |\n| **4.6 - Timeout Propagation** | Deadline passed through layers | Function sleeps beyond timeout | Request cancelled at all levels with `InvocationStatusTimeout` |\n\n**Verification workflow:**\n```bash\n# Test routing logic\ngo test ./internal/gateway/... -run TestRouter -v\n\n# Start gateway with test configuration\ngo run cmd/gateway/main.go --config testdata/gateway-config.yaml\n\n# Load test with multiple concurrent requests\n# Using hey or vegeta\necho '{\"message\": \"test\"}' | vegeta attack \\\n  -duration=10s -rate=10 -targets=targets.txt \\\n  | vegeta report\n\n# Test queue behavior by saturating instances\n# Terminal 1: Slow function\ncat > slow.go << 'EOF'\npackage main\nimport \"time\"\nfunc Handler() string {\n  time.Sleep(5 * time.Second)\n  return \"done\"\n}\nEOF\n\n# Terminal 2: Send burst of requests\nfor i in {1..10}; do\n  curl http://localhost:8080/invoke/slow &\ndone\n\n# Observe: first N execute immediately (N = concurrency limit),\n# rest queue, execute as instances free up\n```\n\n**Expected observations:**\n- Gateway responds to health check at `/health`\n- Round-robin distribution visible in instance assignment logs\n- Queue depth metric increases when all instances busy\n- Circuit breaker trips after 5 consecutive failures (default)\n- Request cancellation propagates within 100ms of timeout\n- Sticky routing (if enabled) sends same client to same instance\n\n#### Milestone 5: Auto-Scaling Checkpoints\n\n> **Objective:** Verify that instances scale up/down based on load and scale to zero after inactivity.\n\n| Checkpoint | Expected Behavior | Verification Commands | Success Criteria |\n|------------|-------------------|----------------------|------------------|\n| **5.1 - Metrics Collection** | Invocation rate and concurrency tracked | Send requests at varying rates | `GetRequestRate()` returns accurate RPS over sliding window |\n| **5.2 - Scale-Up Trigger** | New instances created when threshold exceeded | Send requests above target concurrency | New containers created, added to pool/routing table |\n| **5.3 - Scale-Down Cooldown** | Instances not removed too quickly | Spike traffic, then drop to zero, monitor | Scale-down waits for cooldown period before removing instances |\n| **5.4 - Scale-to-Zero** | All instances removed after idle timeout | No requests for > idle timeout | Container count drops to zero, warm pool empty |\n| **5.5 - Provisioned Concurrency** | Minimum instances kept warm | Configure min=2, monitor during idle | 2 instances remain in warm pool regardless of traffic |\n| **5.6 - Scaling Metrics** | Scale events recorded in metrics | Scale up/down several times | `scaling_operations_total` counter increments with direction labels |\n\n**Verification workflow:**\n```bash\n# Test scaling logic\ngo test ./internal/scaler/... -run TestScaleDecision -v\n\n# Integration test with simulated traffic\ngo test ./integration/scaler/... -v -timeout=2m\n\n# Manual test: observe scaling behavior\n# Start system with auto-scaling enabled\ngo run cmd/coordinator/main.go --enable-scaling\n\n# Generate load pattern\n# Phase 1: Low traffic (should scale to min or zero)\nsleep 30\n\n# Phase 2: Burst traffic (should scale up)\nhey -z 30s -q 10 http://localhost:8080/invoke/hello\n\n# Phase 3: Steady moderate traffic (should maintain)\nhey -z 60s -q 5 http://localhost:8080/invoke/hello\n\n# Phase 4: No traffic (should scale down after cooldown)\nsleep 90\n\n# Monitor scaling events in logs and metrics endpoint\ncurl http://localhost:8080/metrics | grep scaling_\n```\n\n**Expected observations:**\n- Scale-up occurs within 10-30 seconds of sustained load (configurable)\n- Scale-down respects cooldown period (default 300s)\n- Scale-to-zero removes last instance after idle timeout (default 600s)\n- Provisioned concurrency keeps instances warm even with no traffic\n- Scaling decisions logged with rationale (e.g., \"scale up: concurrency 12 > threshold 10\")\n- No thrashing: stable traffic produces stable instance count\n\n### Implementation Guidance\n\n#### A. Technology Recommendations Table\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| Unit Testing | Standard `testing` package + `testify/assert` | `ginkgo`/`gomega` BDD framework |\n| Mock Generation | Manual interface implementations | `mockery` or `moq` code generation |\n| Integration Testing | Docker SDK + testcontainers | Kubernetes in Docker (kind) cluster |\n| Property Testing | `testing/quick` | `gopter` with custom generators |\n| Benchmarking | `testing.B` with `-bench` | Custom benchmark harness with percentile metrics |\n| Coverage Analysis | `go test -cover` | `goverage` or `codecov` integration |\n| Load Testing | `vegeta` command line | Custom load generator with scenario modeling |\n\n#### B. Recommended File/Module Structure for Testing\n\n```\nserverless-runtime/\n├── cmd/\n│   ├── test-server/           # Dedicated test server\n│   │   └── main.go\n│   └── load-generator/        # Load testing tool\n│       └── main.go\n├── internal/\n│   ├── gateway/\n│   │   ├── gateway.go\n│   │   ├── gateway_test.go    # Unit tests\n│   │   └── integration_test.go # Integration tests\n│   ├── scaler/\n│   │   ├── scaler.go\n│   │   ├── scaler_test.go\n│   │   └── benchmark_test.go  # Benchmarks\n│   └── ... (other components)\n├── test/\n│   ├── mocks/                 # Generated mocks\n│   │   ├── container_manager_mock.go\n│   │   └── metrics_mock.go\n│   ├── fixtures/              # Test data\n│   │   ├── functions/\n│   │   │   ├── hello-go/\n│   │   │   ├── hello-python/\n│   │   │   └── hello-node/\n│   │   └── configs/\n│   ├── integration/           # Integration test suites\n│   │   ├── setup.go\n│   │   ├── test_router_scaler.go\n│   │   └── test_pool_lifecycle.go\n│   ├── system/               # System tests\n│   │   ├── docker_test.go\n│   │   └── scaling_test.go\n│   └── helpers/              # Test utilities\n│       ├── clock.go\n│       ├── container_helper.go\n│       └── metrics_helper.go\n├── go.mod\n└── go.sum\n```\n\n#### C. Infrastructure Starter Code for Test Utilities\n\n**`test/helpers/clock.go` - Deterministic time for tests:**\n```go\npackage helpers\n\nimport (\n    \"sync\"\n    \"time\"\n)\n\n// FakeClock provides deterministic time control for tests\ntype FakeClock struct {\n    mu      sync.RWMutex\n    current time.Time\n    timers  []*fakeTimer\n}\n\n// NewFakeClock creates a FakeClock at the given time\nfunc NewFakeClock(initial time.Time) *FakeClock {\n    return &FakeClock{current: initial}\n}\n\n// Now returns the current fake time\nfunc (c *FakeClock) Now() time.Time {\n    c.mu.RLock()\n    defer c.mu.RUnlock()\n    return c.current\n}\n\n// Advance moves time forward by duration\nfunc (c *FakeClock) Advance(d time.Duration) {\n    c.mu.Lock()\n    defer c.mu.Unlock()\n    c.current = c.current.Add(d)\n    \n    // Trigger any timers that have expired\n    for _, t := range c.timers {\n        t.check(c.current)\n    }\n}\n\n// AfterFunc mimics time.AfterFunc\nfunc (c *FakeClock) AfterFunc(d time.Duration, f func()) *fakeTimer {\n    c.mu.Lock()\n    defer c.mu.Unlock()\n    \n    t := &fakeTimer{\n        expiry: c.current.Add(d),\n        f:      f,\n        active: true,\n    }\n    c.timers = append(c.timers, t)\n    return t\n}\n\ntype fakeTimer struct {\n    expiry time.Time\n    f      func()\n    active bool\n}\n\nfunc (t *fakeTimer) check(now time.Time) {\n    if t.active && !now.Before(t.expiry) {\n        t.active = false\n        go t.f()\n    }\n}\n```\n\n**`test/helpers/metrics_helper.go` - Metrics recording for verification:**\n```go\npackage helpers\n\nimport (\n    \"sync\"\n    \"github.com/prometheus/client_golang/prometheus\"\n)\n\n// RecordingMetrics captures metric emissions for test verification\ntype RecordingMetrics struct {\n    mu sync.RWMutex\n    \n    // Capture cold start latencies\n    ColdStartLatencies []float64\n    \n    // Capture invocation counts by function\n    InvocationCounts map[string]int\n    \n    // Capture error counts by type\n    ErrorCounts map[string]map[string]int\n}\n\n// NewRecordingMetrics creates a new RecordingMetrics\nfunc NewRecordingMetrics() *RecordingMetrics {\n    return &RecordingMetrics{\n        InvocationCounts: make(map[string]int),\n        ErrorCounts:      make(map[string]map[string]int),\n    }\n}\n\n// RecordColdStart captures a cold start duration\nfunc (rm *RecordingMetrics) RecordColdStart(duration time.Duration) {\n    rm.mu.Lock()\n    defer rm.mu.Unlock()\n    rm.ColdStartLatencies = append(rm.ColdStartLatencies, duration.Seconds()*1000) // Convert to ms\n}\n\n// RecordInvocation captures an invocation completion\nfunc (rm *RecordingMetrics) RecordInvocation(functionName string, duration time.Duration, err error) {\n    rm.mu.Lock()\n    defer rm.mu.Unlock()\n    \n    rm.InvocationCounts[functionName]++\n    \n    if err != nil {\n        errType := classifyTestError(err)\n        if rm.ErrorCounts[functionName] == nil {\n            rm.ErrorCounts[functionName] = make(map[string]int)\n        }\n        rm.ErrorCounts[functionName][errType]++\n    }\n}\n\n// GetColdStartP95 returns the 95th percentile cold start latency\nfunc (rm *RecordingMetrics) GetColdStartP95() float64 {\n    rm.mu.RLock()\n    defer rm.mu.RUnlock()\n    \n    if len(rm.ColdStartLatencies) == 0 {\n        return 0\n    }\n    \n    // Sort and calculate percentile\n    latencies := make([]float64, len(rm.ColdStartLatencies))\n    copy(latencies, rm.ColdStartLatencies)\n    sort.Float64s(latencies)\n    \n    index := int(float64(len(latencies)) * 0.95)\n    if index >= len(latencies) {\n        index = len(latencies) - 1\n    }\n    return latencies[index]\n}\n```\n\n#### D. Core Logic Skeleton Code for Test Verification\n\n**`test/integration/scaling_test.go` - Integration test for auto-scaling:**\n```go\npackage integration\n\nimport (\n    \"context\"\n    \"testing\"\n    \"time\"\n    \"github.com/stretchr/testify/assert\"\n    \"github.com/stretchr/testify/require\"\n    \n    \"serverless-runtime/internal/scaler\"\n    \"serverless-runtime/internal/pool\"\n    \"serverless-runtime/test/helpers\"\n)\n\nfunc TestScaleUpOnHighConcurrency(t *testing.T) {\n    // TODO 1: Create mock container manager and metrics collector\n    mockCM := helpers.NewMockContainerManager()\n    metrics := helpers.NewRecordingMetrics()\n    \n    // TODO 2: Initialize warm pool with zero instances\n    poolConfig := pool.PoolConfig{\n        MaxWarmInstances: 10,\n        MinWarmInstances: 0,\n        InstanceTTL:      5 * time.Minute,\n        IdleTimeout:      10 * time.Minute,\n    }\n    warmPool, err := pool.NewWarmPoolManager(mockCM, poolConfig, metrics)\n    require.NoError(t, err)\n    \n    // TODO 3: Initialize scaler with target concurrency of 2\n    scalingConfig := scaler.ScalingConfig{\n        FunctionName:        \"test-function\",\n        MinInstances:        0,\n        MaxInstances:        5,\n        TargetConcurrency:   2,\n        ScaleUpThreshold:    1.5,  // 150% of target\n        ScaleDownThreshold:  0.5,  // 50% of target\n        ScaleUpCooldown:     30 * time.Second,\n        ScaleDownCooldown:   5 * time.Minute,\n    }\n    \n    scaler, err := scaler.NewScaler(metrics, warmPool, scalingConfig)\n    require.NoError(t, err)\n    \n    ctx := context.Background()\n    \n    // TODO 4: Simulate 5 concurrent executions (exceeding threshold)\n    for i := 0; i < 5; i++ {\n        metrics.RecordInvocation(\"test-function\", 100*time.Millisecond, nil)\n        metrics.IncrementConcurrency(\"test-function\")\n    }\n    \n    // TODO 5: Trigger scaling evaluation\n    decision := scaler.EvaluateScaling(ctx, \"test-function\")\n    \n    // TODO 6: Verify scale-up decision\n    assert.Equal(t, scaler.ScaleUp, decision.Direction)\n    assert.Equal(t, 3, decision.Count) // Expected: ceil(5 current / 2 target) = 3 instances\n    assert.Contains(t, decision.Reason, \"concurrency\")\n    \n    // TODO 7: Execute scaling decision\n    err = scaler.executeScaling(ctx, decision)\n    require.NoError(t, err)\n    \n    // TODO 8: Verify new instances created in warm pool\n    instances, err := warmPool.ListInstances(ctx, \"test-function\")\n    require.NoError(t, err)\n    assert.Len(t, instances, 3)\n    \n    // TODO 9: Simulate executions completing\n    for i := 0; i < 5; i++ {\n        metrics.DecrementConcurrency(\"test-function\")\n    }\n    \n    // TODO 10: Verify scale-down doesn't happen immediately (cooldown)\n    decision2 := scaler.EvaluateScaling(ctx, \"test-function\")\n    assert.Equal(t, scaler.ScaleNone, decision2.Direction)\n    assert.Contains(t, decision2.Reason, \"cooldown\")\n}\n```\n\n**`test/helpers/mock_container_manager.go` - Mock for container operations:**\n```go\npackage helpers\n\nimport (\n    \"context\"\n    \"sync\"\n    \"time\"\n    \"serverless-runtime/internal/container\"\n    \"serverless-runtime/internal/types\"\n)\n\n// MockContainerManager simulates container operations for tests\ntype MockContainerManager struct {\n    mu          sync.RWMutex\n    containers  map[string]*types.Container\n    createDelay time.Duration\n    startDelay  time.Duration\n    failCreate  bool\n    failStart   bool\n    opsRecorded []string\n}\n\n// CreateContainer simulates container creation\nfunc (m *MockContainerManager) CreateContainer(\n    ctx context.Context, \n    req types.CreateContainerRequest,\n) (*types.Container, error) {\n    m.mu.Lock()\n    defer m.mu.Unlock()\n    \n    m.opsRecorded = append(m.opsRecorded, \"CreateContainer\")\n    \n    if m.failCreate {\n        return nil, fmt.Errorf(\"mock container creation failed\")\n    }\n    \n    // Simulate delay\n    if m.createDelay > 0 {\n        select {\n        case <-time.After(m.createDelay):\n        case <-ctx.Done():\n            return nil, ctx.Err()\n        }\n    }\n    \n    containerID := fmt.Sprintf(\"mock-container-%d\", len(m.containers))\n    container := &types.Container{\n        ID:        containerID,\n        Image:     req.Image,\n        Status:    types.StatusCreated,\n        CreatedAt: time.Now(),\n        Labels:    req.Labels,\n    }\n    \n    m.containers[containerID] = container\n    return container, nil\n}\n\n// StartContainer simulates container startup\nfunc (m *MockContainerManager) StartContainer(\n    ctx context.Context, \n    containerID string,\n) error {\n    // TODO 1: Check if container exists\n    // TODO 2: Simulate startup delay if configured\n    // TODO 3: Update container status to StatusRunning\n    // TODO 4: Record operation in opsRecorded\n    // TODO 5: Return mock error if failStart is true\n}\n\n// ListContainers returns mock containers\nfunc (m *MockContainerManager) ListContainers(\n    ctx context.Context, \n    filter types.ListFilter,\n) ([]types.Container, error) {\n    // TODO 1: Filter containers by labels and status\n    // TODO 2: Return matching containers\n    // TODO 3: Record operation in opsRecorded\n}\n```\n\n#### E. Language-Specific Hints for Go Testing\n\n- **Table-Driven Tests:** Use the pattern with `tt := range tests` for comprehensive input coverage\n- **Parallel Execution:** Use `t.Parallel()` judiciously for unit tests, but avoid for integration tests with shared resources\n- **Test Helpers:** Create `testHelper` functions that accept `testing.TB` (interface for `testing.T` and `testing.B`)\n- **Golden Files:** Use `go:embed` to embed test fixtures directly in test files\n- **Benchmark Memory:** Use `b.ReportAllocs()` to track memory allocations in benchmarks\n- **Cleanup:** Use `t.Cleanup()` for resource cleanup instead of defer in subtests\n- **Error Testing:** Use `errors.Is()` and `errors.As()` for error type assertions\n- **Context Testing:** Use `context.WithTimeout` in tests to prevent hangs, but mock time for deterministic behavior\n\n#### F. Debugging Tips for Test Failures\n\n| Symptom | Likely Cause | How to Diagnose | Fix |\n|---------|--------------|-----------------|-----|\n| **Test passes locally but fails in CI** | Timing differences, race conditions | Run with `-race` flag, add logging with timestamps | Use `FakeClock`, increase timeouts, fix data races |\n| **Container cleanup failing** | Docker API rate limiting, zombie containers | Check Docker logs, monitor container count | Implement retry with backoff, force remove in cleanup |\n| **Metrics showing incorrect values** | Race condition in metric updates | Use `-race` detector, add metric value snapshots | Protect metric updates with mutex, use atomic operations |\n| **Scaling thrashing in tests** | Too sensitive thresholds, no hysteresis | Log scaling decisions with metrics values | Increase cooldown periods, add hysteresis (different up/down thresholds) |\n| **Cold start timeout flakiness** | Variable container startup time | Measure actual startup times, log each phase | Increase timeout buffer, use faster base images |\n| **Queue test deadlock** | Unbounded queue growth blocking producers | Monitor queue depth metric, add timeout to enqueue | Implement queue size limits, rejection policy for full queues |\n| **Race detector reports data race** | Concurrent map access, unprotected field writes | Identify the exact line from race report | Use `sync.Map` or `sync.RWMutex`, copy data before goroutine |\n\n#### G. Milestone Verification Commands Summary\n\n**Complete test suite execution:**\n```bash\n# Run all unit tests with race detection\ngo test ./internal/... -race -count=1 -timeout=5m\n\n# Run integration tests (requires Docker)\nDOCKER_HOST=unix:///var/run/docker.sock \\\n  go test ./test/integration/... -v -timeout=10m\n\n# Run benchmarks\ngo test ./internal/scaler/... -bench=. -benchtime=5s\n\n# Check test coverage\ngo test ./internal/... -coverprofile=coverage.out\ngo tool cover -html=coverage.out -o coverage.html\n\n# Run property-based tests\ngo test ./internal/router/... -run TestPropertyBased -v\n```\n\n**Post-implementation verification checklist:**\n- [ ] All unit tests pass with `-race` detector enabled\n- [ ] Integration tests pass with real Docker daemon\n- [ ] Benchmarks show no significant performance regressions\n- [ ] Test coverage > 80% for core components\n- [ ] No flaky tests (run test suite 10 times consecutively)\n- [ ] System tests pass in CI environment\n- [ ] Load tests demonstrate scaling behavior matches specifications\n- [ ] Error injection tests verify recovery mechanisms work\n\n---\n\n\n## Debugging Guide\n> **Milestone(s):** Milestone 1, Milestone 2, Milestone 3, Milestone 4, Milestone 5\n\nDebugging a serverless function runtime is challenging because it's a **distributed system with multiple interacting components**, each with their own failure modes. The ephemeral nature of function instances, the complexity of container isolation, and the dynamic scaling behavior create unique debugging scenarios. This guide provides a systematic approach to diagnosing and fixing common issues during development, organized by observable symptoms. Think of debugging this system as **being a detective at a crime scene**—you have multiple witnesses (logs, metrics, traces), circumstantial evidence (system state), and a crime scene that disappears after the crime (ephemeral containers). Your job is to reconstruct what happened from the available evidence.\n\n### Common Bug Symptoms and Fixes\n\nThe following tables organize debugging by observable symptom, grouping related symptoms from different components. Each symptom includes the **observable behavior** (what you see), the **likely root cause** (what's probably wrong), and **step-by-step investigation and fix**. Use this as a starting point when encountering issues during development.\n\n#### Function Packaging and Deployment Issues\n\nThese symptoms occur during function upload, packaging, or when functions fail to initialize properly.\n\n| Symptom | Likely Cause | Steps to Fix |\n|---------|--------------|--------------|\n| **Function upload fails with \"invalid handler\" error** | The handler path specified in the `FunctionDefinition` doesn't match an actual function in the uploaded code. This is often caused by incorrect handler syntax (e.g., `handler.main` for Go when the function is named `HandleRequest`), or the handler file being missing from the uploaded archive. | 1. **Check the handler format**: For Go, the handler should be the package-qualified function name (e.g., `main.Handler`). For Python, it should be `module.function_name`. 2. **Verify the uploaded code**: Use the `ValidateHandler` method in the bundler to confirm the handler exists in the workspace. 3. **Inspect the artifact**: Download the stored artifact and examine its structure—ensure the main file with the handler is present. |\n| **Function deployment succeeds but instances fail to start with \"dependency resolution failed\"** | The dependency resolution step during packaging didn't capture all required libraries, or there are version conflicts between transitive dependencies. This is particularly common in Python with `requirements.txt` or Node.js with complex dependency trees. | 1. **Examine the bundler logs**: The `ResolveDependencies` method should log the resolved dependency graph. Check for warnings about missing or conflicting versions. 2. **Test the build artifact locally**: Extract the built artifact and run it in a minimal environment to see if dependencies are missing. 3. **Add explicit version pins**: In the function's dependency manifest, add explicit versions for transitive dependencies to avoid conflicts. 4. **Check for platform-specific dependencies**: Ensure dependencies are compatible with the runtime's base image (e.g., Linux wheels for Python). |\n| **Function package size is unexpectedly large (>100MB)** | The packaging process included unnecessary files (development dependencies, test directories, virtual environments, or large binary files) that bloat the artifact. This increases cold start times and storage costs. | 1. **Implement `.faasignore`**: Create an ignore file similar to `.dockerignore` that excludes common development artifacts like `node_modules`, `.git`, `__pycache__`, and test directories. 2. **Use dependency pruning**: For interpreted languages, analyze the actual imports and strip unused dependencies. 3. **Enable artifact compression**: Compress the artifact using gzip or zstd before storage. 4. **Check for duplicated layers**: If using container images, ensure common runtime layers are shared across functions. |\n| **Function versioning shows incorrect or duplicate versions** | The version generation logic (likely based on content hash) is collision-prone or the storage backend isn't properly isolating versions. This can happen when two different functions produce the same hash (rare) or when the storage layer overwrites existing artifacts. | 1. **Verify the hash algorithm**: Use a secure hash (SHA-256) that includes the function code, dependencies, and runtime configuration. 2. **Check for non-deterministic builds**: Ensure builds are reproducible—Go builds should use module mode with fixed versions, Python should use locked dependency files. 3. **Inspect the storage backend**: Ensure the artifact storage uses the full hash as the key and doesn't allow overwrites. 4. **Add a version manifest**: Store a separate manifest mapping human-readable versions (e.g., \"v1.2\") to content hashes. |\n| **Upload API times out for large function packages** | The `UploadHandler` is blocking on processing the entire upload before responding, or the dependency resolution/building step takes too long without streaming progress. This makes large functions difficult to deploy. | 1. **Implement asynchronous upload processing**: Accept the upload, return an immediate response with a job ID, and process the packaging in the background. 2. **Add progress reporting**: For synchronous uploads, implement chunked uploads and periodic status updates. 3. **Set reasonable timeouts**: Configure the gateway timeout (`GatewayConfig.DefaultTimeout`) to allow for large builds but fail fast on truly stuck uploads. 4. **Optimize dependency resolution**: Cache resolved dependencies across functions to speed up subsequent uploads. |\n\n#### Execution Environment and Isolation Issues\n\nThese symptoms relate to container lifecycle, resource limits, and security isolation.\n\n| Symptom | Likely Cause | Steps to Fix |\n|---------|--------------|--------------|\n| **Function times out immediately on every invocation** | The container is failing to start or the entrypoint command is incorrect, causing the function to exit immediately. The `Executor` then times out waiting for a response. This often happens when the base image doesn't match the runtime or the handler binary is missing. | 1. **Check container logs**: The `ContainerManager` should capture container stdout/stderr. Look for \"executable not found\" or \"no such file\" errors. 2. **Verify the base image**: Ensure `GetBaseImage` returns the correct image for the runtime (e.g., `golang:alpine` for Go, `python:slim` for Python). 3. **Test the container manually**: Use `docker run` with the same image and command to see if it starts. 4. **Inspect the `CreateContainerRequest`**: Ensure `Cmd` and `WorkingDir` are correctly set for the runtime. |\n| **Function exceeds memory limit but isn't terminated** | The cgroup memory limit isn't being enforced properly, or the OOM killer is configured incorrectly. This can happen if the `CGroupHelper.SetMemoryLimit` isn't setting both `memory.limit_in_bytes` and `memory.memsw.limit_in_bytes` (for swap), or if the container isn't being added to the correct cgroup. | 1. **Verify cgroup configuration**: Check `/sys/fs/cgroup/memory/` (or `/sys/fs/cgroup/system.slice/` for systemd) for the container's cgroup and confirm limits are set. 2. **Test with a memory-hungry function**: Write a test function that allocates memory aggressively and verify it gets OOM-killed. 3. **Check for swap**: If swap is enabled, ensure both memory and swap limits are set. 4. **Update the seccomp profile**: Some older Docker versions require specific seccomp rules for cgroup enforcement. |\n| **Function instances accumulate and aren't cleaned up (\"zombie containers\")** | The cleanup logic in `CleanupIdleContainers` isn't running or isn't finding the containers, or the `RemoveContainer` method is failing silently. This leads to resource exhaustion over time. | 1. **Check the cleanup schedule**: Ensure the `WarmPoolManager.cleanupTicker` is running and `cleanupExpired` is being called. 2. **Verify container listing**: Use `ListContainers` with appropriate filters to see if the manager can find the containers. 3. **Inspect removal errors**: Add logging to `RemoveContainer` and check for \"container not found\" or permission errors. 4. **Add a garbage collector**: Implement a periodic sweep that removes any container not tracked in the `WarmPoolManager.store`. |\n| **Function can access host resources or other function's files** | Insufficient namespace isolation—the container might be running with host network, PID, or filesystem namespaces. This is a critical security issue. | 1. **Review `CreateContainerRequest` security options**: Ensure `NetworkMode` is set to `bridge` (not `host`), and `SecurityOpts` include `no-new-privileges:true`. 2. **Verify namespace flags**: Check that the container manager is creating containers with all namespaces (`pid`, `net`, `ipc`, `mnt`, `uts`). 3. **Test isolation**: Write a function that tries to list processes (`ps aux`) or read `/etc/hostname`—it should only see its own isolated environment. 4. **Use a security scanner**: Run tools like `docker-bench-security` to check for misconfigurations. |\n| **Function execution is much slower than expected** | CPU throttling from cgroups is too aggressive, or the container lacks sufficient CPU shares. The `CPUQuota` might be set too low (e.g., 50,000 for 50% of a CPU core). | 1. **Check CPU quota settings**: Verify `CreateContainerRequest.CPUQuota` is reasonable (100,000 = 1 CPU core). Consider increasing for CPU-intensive functions. 2. **Monitor CPU throttling**: Use `GetContainerStats` to see `CPUPercent` and check `/sys/fs/cgroup/cpu/` for `nr_throttled` events. 3. **Adjust CPU period**: The default period is 100ms; decreasing it can provide more fine-grained scheduling but may increase overhead. 4. **Consider CPU pinning**: For performance-critical functions, use CPU sets to dedicate cores. |\n\n#### Cold Start and Warm Pool Issues\n\nThese symptoms manifest as high latency for first requests or inefficient resource usage.\n\n| Symptom | Likely Cause | Steps to Fix |\n|---------|--------------|--------------|\n| **Cold start latency is consistently >1s despite warm pool** | The warm pool is empty or instances are expired before use. This could be due to `PoolConfig.MinWarmInstances` being set to 0, `InstanceTTL` being too short, or the pre-warming logic not triggering. | 1. **Check warm pool metrics**: Use `Metrics.ContainerCount` to see how many warm instances exist per function. 2. **Verify TTL configuration**: Ensure `InstanceTTL` is longer than the typical idle period between invocations. 3. **Test pre-warming**: Invoke the function once, then check if a warm instance remains in the pool after execution. 4. **Adjust `PreWarmThreshold`**: Lower the threshold if traffic patterns are predictable. |\n| **Warm pool consumes excessive memory even when idle** | Too many instances are kept warm (`MaxWarmInstances` is too high), or instances aren't being released after use (`ReleaseInstance` isn't called). This wastes resources and can lead to host memory pressure. | 1. **Monitor pool size**: Track `ContainerCount` gauge over time and set alerts for high idle counts. 2. **Implement memory-based eviction**: Add logic to `cleanupExpired` that removes instances when system memory pressure is high. 3. **Adjust per-function limits**: Set `MaxWarmInstances` based on actual usage patterns—most functions need only 1-2 warm instances. 4. **Add LRU eviction**: When the pool is full, evict the least recently used instance rather than rejecting new ones. |\n| **Function state persists between invocations (unexpected side effects)** | The container isn't being properly reset between uses. The `CleanupInstance` method might not be clearing the `/tmp` directory or environment variables from previous invocations. | 1. **Verify cleanup hooks**: Ensure `RuntimeCleaner.Clean` is called between invocations and resets the filesystem state. 2. **Check filesystem isolation**: Each invocation should get a fresh overlay filesystem layer; ensure `Binds` includes a unique `/tmp` mount. 3. **Test with a counter**: Write a function that increments a counter in `/tmp/count.txt`—it should reset to 1 on each cold start and warm reuse. 4. **Use read-only root filesystem**: Mount the function code as read-only and only allow writes to `/tmp`. |\n| **Snapshot/restore (CRIU) fails with \"pre-dump not found\" error** | The container state is too complex to checkpoint (e.g., open network connections, pending signals), or CRIU isn't properly configured for the container runtime. This prevents fast restoration from snapshots. | 1. **Simplify container state**: Ensure containers are checkpointed at a consistent point (e.g., after initialization but before any request). 2. **Check CRIU version**: Use a recent version (≥3.15) with full container support. 3. **Pre-dump memory**: Use iterative memory dumping to reduce pause times during checkpoint. 4. **Fallback to traditional start**: If snapshot fails after retries, fall back to regular container creation and log the error for investigation. |\n| **Predictive warming creates instances that are never used** | The prediction algorithm is too aggressive or based on noisy metrics. This wastes resources and can cause scale-up/down oscillations. | 1. **Tune prediction parameters**: Adjust `PreWarmThreshold` based on actual hit rate—monitor how many pre-warmed instances are actually used. 2. **Add confidence scoring**: Only pre-warm when the prediction confidence exceeds a threshold. 3. **Correlate with external metrics**: Use request queue depth or upstream event sources (like message queue backlog) as stronger signals. 4. **Implement graceful degradation**: If predictive warming accuracy is low, disable it and rely on reactive warming only. |\n\n#### Request Routing and Gateway Issues\n\nThese symptoms affect request handling, load balancing, and queuing behavior.\n\n| Symptom | Likely Cause | Steps to Fix |\n|---------|--------------|--------------|\n| **Requests hang indefinitely without timeout** | The gateway's timeout chain is broken—`GatewayConfig.DefaultTimeout` might not be propagating to the `Router.Route` context, or the `forwardRequest` isn't respecting the deadline. This causes client connections to hang. | 1. **Check timeout propagation**: Use `withTimeout` at each layer (gateway → router → instance) and ensure deadlines are decreasing. 2. **Verify context cancellation**: When a request times out, ensure all downstream operations (container execution, network calls) are cancelled. 3. **Add request-scoped timeouts**: The `InvocationRequest.Deadline` should be set by the gateway and respected throughout. 4. **Test with slow functions**: Create a function that sleeps longer than the timeout and verify it's properly terminated. |\n| **Load balancing sends all requests to one instance** | The load balancing algorithm (likely in `selectInstance`) is stuck on a single instance due to sticky sessions or a bug in least-connections counting. This overloads one instance while others sit idle. | 1. **Check `routedInstance.activeReqs`**: Ensure the atomic counter is being incremented/decremented correctly in `forwardRequest`. 2. **Disable sticky routing**: If `RouterConfig.StickySessionTTL` > 0, set it to 0 to test if the issue persists. 3. **Verify instance health**: Unhealthy instances might be excluded, leaving only one healthy instance. Check `circuitBreaker` state. 4. **Test with concurrent requests**: Send multiple parallel requests and verify they distribute across all warm instances. |\n| **Request queue grows without bound, causing memory exhaustion** | The `RequestQueue` isn't bounded properly (`maxSize` is too large or not enforced), or the dequeue rate is slower than enqueue rate due to stuck instances. This can lead to the gateway being OOM-killed. | 1. **Check queue bounds**: Verify `NewRequestQueue` is called with a reasonable `maxSize` (e.g., 1000 per function). 2. **Implement load shedding**: When queue is full, reject new requests with 429 (Too Many Requests) instead of queuing. 3. **Monitor dequeuing rate**: If `Dequeue` is slow, check for lock contention in the queue or blocked workers. 4. **Add queue timeouts**: Use `RemoveExpired` to clean up requests that have waited too long. |\n| **Circuit breaker trips unnecessarily, causing healthy instances to be avoided** | The `CircuitBreakerThreshold` is too low or the timeout (`CircuitBreakerTimeout`) is too short for normal function execution. This causes temporary slowness to be interpreted as failure. | 1. **Adjust breaker parameters**: Increase the threshold (e.g., from 5 to 10 failures) and lengthen the timeout to match function SLA. 2. **Distinguish error types**: Only count network errors or timeouts toward the breaker, not application errors (like 400 Bad Request). 3. **Add half-open state**: After the timeout, allow a trial request before fully closing the breaker again. 4. **Monitor breaker metrics**: Track how often breakers trip and for which functions—adjust per-function if needed. |\n| **Gateway returns 502 Bad Gateway but instances appear healthy** | The network between gateway and instances is failing, or the instance health check (`IsActive`) is incorrectly reporting healthy when the container is actually dead. This can happen if the container died but the `FunctionInstance` state wasn't updated. | 1. **Check instance connectivity**: Use `net.Dial` from the gateway to the instance's `Host:Port` to verify TCP connectivity. 2. **Implement active health checks**: The `Router` should periodically ping instances (HTTP GET /health) and mark unhealthy ones. 3. **Watch for state desync**: Ensure lifecycle events (`EventHealthCheckFailed`, `EventForceTerminate`) update the `FunctionInstance.State` promptly. 4. **Add retry with different instance**: On 502, the gateway should retry the request with a different instance before failing. |\n\n#### Auto-Scaling and Resource Management Issues\n\nThese symptoms involve incorrect scaling decisions, instance churn, or resource waste.\n\n| Symptom | Likely Cause | Steps to Fix |\n|---------|--------------|--------------|\n| **Scaling oscillates rapidly (thrashing) — instances constantly created and destroyed** | The scaling thresholds (`ScaleUpThreshold`, `ScaleDownThreshold`) are too close together, or the cooldown periods (`ScaleUpCooldown`, `ScaleDownCooldown`) are too short. This causes the system to overreact to small load fluctuations. | 1. **Add hysteresis**: Ensure scale-up threshold (e.g., 70% concurrency) is significantly higher than scale-down threshold (e.g., 30%). 2. **Increase cooldowns**: Set cooldowns to at least 30-60 seconds to prevent rapid successive decisions. 3. **Smooth metrics**: Use moving averages for concurrency/RPS instead of instantaneous values. 4. **Implement scaling stabilization**: Keep track of recent scaling actions and suppress opposite-direction actions for a stabilization window. |\n| **Scale-to-zero removes instances too aggressively, causing cold starts on every request** | The `IdleTimeout` is too short for the function's invocation pattern. Intermittent workloads (e.g., cron jobs every 5 minutes) need longer idle timeouts than the interval between invocations. | 1. **Analyze invocation patterns**: Check metrics for the time between invocations—set `IdleTimeout` to at least 2-3x the typical interval. 2. **Add predictive keep-alive**: If historical data shows regular intervals, keep at least one instance warm for predictable workloads. 3. **Implement per-function tuning**: Some functions may need longer idle timeouts than others. 4. **Consider minimum instances**: For latency-sensitive functions, set `MinInstances` to 1 instead of relying on scale-to-zero. |\n| **Scale-up is too slow during traffic spikes, causing queue buildup** | The scaling decision loop (`EvaluateScaling`) runs too infrequently, or the metrics window (`MetricsWindow`) is too long, causing delayed detection of traffic increases. | 1. **Reduce evaluation interval**: The `Scaler.ticker` should run at least every 5 seconds during high traffic. 2. **Use faster metrics**: Combine short-term (5s) and long-term (60s) metrics to react quickly while avoiding noise. 3. **Implement predictive scaling**: If traffic patterns are predictable (e.g., daily peaks), scale up proactively. 4. **Add queue-based scaling**: Scale up when request queue depth exceeds a threshold, not just based on concurrency. |\n| **Scale-down doesn't happen even when instances are idle for hours** | The scale-down logic requires instances to be idle *and* below threshold for the entire cooldown period, or there's a bug in `IdleDuration` calculation (`LastUsedAt` isn't updated properly). | 1. **Verify `LastUsedAt` updates**: Ensure `EventRequestCompleted` updates the instance's `LastUsedAt` timestamp. 2. **Check idle detection**: The scaler should consider both low concurrency AND idle time before scaling down. 3. **Test with synthetic load**: Create a burst of traffic, then let the system idle and verify scale-down occurs after `IdleTimeout`. 4. **Add forced scale-down**: If instances have been idle for an extended period (e.g., 24 hours), force termination regardless of thresholds. |\n| **Provisioned concurrency instances aren't kept warm** | The warm pool manager isn't aware of provisioned concurrency requirements, or the instances are being recycled due to TTL expiration. This defeats the purpose of provisioned concurrency. | 1. **Integrate with warm pool**: The `Scaler` should call `PreWarm` for provisioned concurrency instances and ensure they're excluded from TTL-based cleanup. 2. **Mark provisioned instances**: Add a label to instances created for provisioned concurrency so the pool manager treats them specially. 3. **Monitor warm count**: Alert if the number of warm instances for a function with provisioned concurrency drops below the minimum. 4. **Implement health checks**: Provisioned instances should have active health checks and be recreated if unhealthy. |\n\n#### Cross-Component Integration Issues\n\nThese symptoms involve interactions between multiple components and are often the trickiest to debug.\n\n| Symptom | Likely Cause | Steps to Fix |\n|---------|--------------|--------------|\n| **Lifecycle events are lost or processed out of order** | The `EventDispatcher` has subscribers with small buffers, or events are being published from multiple goroutines without proper ordering guarantees. This can cause state machine corruption. | 1. **Increase buffer sizes**: Use buffered channels sized for expected event volume (e.g., 1000). 2. **Sequence events**: Add a monotonically increasing sequence number to `InstanceEvent` and have subscribers detect gaps. 3. **Use a single publisher**: Ensure all events go through a single goroutine that sequences them before publishing. 4. **Add event persistence**: For critical events, write them to a WAL before processing so they can be replayed after crashes. |\n| **State machine gets stuck in `InstanceStateDraining` indefinitely** | The drain timeout is too long, or the instance still has active requests that aren't completing. This blocks scale-down and wastes resources. | 1. **Check active request count**: Verify `routedInstance.activeReqs` reaches zero during draining. 2. **Enforce drain timeout**: The `FlowCoordinator` should force-terminate instances after `DrainTimeout`. 3. **Verify request completion**: Ensure `EventRequestCompleted` is emitted even for failed requests. 4. **Add watchdog timer**: If an instance stays draining beyond timeout, emit `EventForceTerminate`. |\n| **Memory leak in gateway or controller over time** | Goroutines aren't being cleaned up after requests complete, or objects are retained in global maps (like `Router.functions`) without cleanup. This is common with improper context usage. | 1. **Profile heap usage**: Use `pprof` to see which types are accumulating. 2. **Check for goroutine leaks**: Monitor goroutine count over time; use `net/http/pprof` to see stack traces. 3. **Clean up stale entries**: Remove function entries from the router when functions are deleted. 4. **Use weak references**: For caches, use `sync.Map` with time-based expiration. |\n| **Metrics show unrealistic values (e.g., negative durations)** | Race conditions in metric updates, or timestamps being recorded in different time sources (e.g., `time.Now()` vs `time.Since()`). This makes monitoring unreliable. | 1. **Use atomic operations**: For counters and gauges updated concurrently, use `atomic` package or Prometheus's built-in atomicity. 2. **Standardize time source**: Use `time.Now()` at the start of operations and calculate durations from that single reference. 3. **Validate metrics**: Add sanity checks (e.g., duration ≥ 0) before recording. 4. **Test with race detector**: Run tests with `-race` flag to catch concurrent updates. |\n\n### Implementation Guidance\n\n> **Debugging Philosophy**: The best debugging strategy is **observability by design**—instrument first, debug second. Add structured logs, metrics, and traces during initial implementation rather than as an afterthought.\n\n#### A. Technology Recommendations Table\n\n| Component | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| **Logging** | Structured JSON logging with `log/slog` (Go 1.21+) or `zerolog` | Distributed tracing with OpenTelemetry + Jaeger |\n| **Metrics** | Prometheus client library with built-in `/metrics` endpoint | Prometheus + Grafana with custom dashboards per component |\n| **Tracing** | Request IDs propagated via HTTP headers | Full OpenTelemetry instrumentation with span context |\n| **Profiling** | `net/http/pprof` endpoints for CPU/memory profiles | Continuous profiling with Pyroscope or Parca |\n| **Debug Tools** | `delve` debugger for Go, `docker inspect` for containers | `kubectl debug` for live container inspection |\n\n#### B. Recommended Debugging Infrastructure\n\nCreate a dedicated `internal/observability/` directory for shared debugging utilities:\n\n```\nproject-root/\n  internal/observability/\n    logging.go           ← Structured logger setup\n    metrics.go           ← Prometheus metric registration helpers\n    tracing.go           ← OpenTelemetry tracer provider\n    middleware.go        ← HTTP middleware for request ID, logging\n    debug_endpoints.go   ← pprof, health check endpoints\n  cmd/debug-tools/       ← Standalone debugging utilities\n    container-inspector/ ← Tool to examine container state\n    trace-replayer/      ← Replay captured invocation traces\n```\n\n#### C. Complete Debugging Helper: Request ID Propagation\n\nHere's a complete implementation for request ID propagation across components—essential for tracing a single invocation through the system:\n\n```go\n// internal/observability/middleware.go\npackage observability\n\nimport (\n    \"context\"\n    \"net/http\"\n    \"github.com/google/uuid\"\n)\n\ntype contextKey string\n\nconst requestIDKey contextKey = \"request_id\"\n\n// RequestIDMiddleware adds a unique request ID to all incoming requests\nfunc RequestIDMiddleware(next http.Handler) http.Handler {\n    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n        // Check for existing request ID header (for trace continuity)\n        requestID := r.Header.Get(\"X-Request-ID\")\n        if requestID == \"\" {\n            requestID = uuid.New().String()\n        }\n        \n        // Add to response headers for client debugging\n        w.Header().Set(\"X-Request-ID\", requestID)\n        \n        // Store in context for downstream components\n        ctx := context.WithValue(r.Context(), requestIDKey, requestID)\n        next.ServeHTTP(w, r.WithContext(ctx))\n    })\n}\n\n// GetRequestID extracts the request ID from context\nfunc GetRequestID(ctx context.Context) string {\n    if id, ok := ctx.Value(requestIDKey).(string); ok {\n        return id\n    }\n    return \"unknown\"\n}\n\n// LoggingMiddleware adds structured logging with request ID\nfunc LoggingMiddleware(logger *slog.Logger, next http.Handler) http.Handler {\n    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n        start := time.Now()\n        requestID := GetRequestID(r.Context())\n        \n        // Wrap response writer to capture status code\n        rw := &responseWriter{ResponseWriter: w, statusCode: http.StatusOK}\n        \n        // Log request start\n        logger.InfoContext(r.Context(), \"request started\",\n            \"method\", r.Method,\n            \"path\", r.URL.Path,\n            \"request_id\", requestID,\n        )\n        \n        next.ServeHTTP(rw, r)\n        \n        // Log request completion\n        logger.InfoContext(r.Context(), \"request completed\",\n            \"method\", r.Method,\n            \"path\", r.URL.Path,\n            \"status\", rw.statusCode,\n            \"duration_ms\", time.Since(start).Milliseconds(),\n            \"request_id\", requestID,\n        )\n    })\n}\n\ntype responseWriter struct {\n    http.ResponseWriter\n    statusCode int\n}\n\nfunc (rw *responseWriter) WriteHeader(statusCode int) {\n    rw.statusCode = statusCode\n    rw.ResponseWriter.WriteHeader(statusCode)\n}\n```\n\n#### D. Core Debugging Skeleton: Diagnostic Endpoint\n\nAdd a diagnostic endpoint to the gateway that reveals internal state—crucial for debugging routing and scaling issues:\n\n```go\n// internal/gateway/debug.go\npackage gateway\n\nimport (\n    \"encoding/json\"\n    \"net/http\"\n    \"sync/atomic\"\n)\n\n// DebugHandler exposes internal state for debugging\ntype DebugHandler struct {\n    router *Router\n    warmPool pool.WarmPoolManager\n    scaler *scaler.Scaler\n}\n\n// ServeHTTP handles debug requests\nfunc (h *DebugHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    switch r.URL.Query().Get(\"view\") {\n    case \"routing\":\n        h.handleRoutingDebug(w, r)\n    case \"warmpool\":\n        h.handleWarmPoolDebug(w, r)\n    case \"scaling\":\n        h.handleScalingDebug(w, r)\n    default:\n        h.handleOverview(w, r)\n    }\n}\n\n// handleRoutingDebug shows current routing table state\nfunc (h *DebugHandler) handleRoutingDebug(w http.ResponseWriter, r *http.Request) {\n    h.router.mu.RLock()\n    defer h.router.mu.RUnlock()\n    \n    type instanceInfo struct {\n        ID         string    `json:\"id\"`\n        State      string    `json:\"state\"`\n        Host       string    `json:\"host\"`\n        Port       int       `json:\"port\"`\n        ActiveReqs int32     `json:\"active_reqs\"`\n        LastUsed   time.Time `json:\"last_used\"`\n        Healthy    bool      `json:\"healthy\"`\n    }\n    \n    type functionInfo struct {\n        Name          string        `json:\"name\"`\n        Instances     []instanceInfo `json:\"instances\"`\n        ConcurrencyLimit int        `json:\"concurrency_limit\"`\n        ActiveCount   int32         `json:\"active_count\"`\n    }\n    \n    functions := make([]functionInfo, 0, len(h.router.functions))\n    for name, rt := range h.router.functions {\n        instances := make([]instanceInfo, 0, len(rt.instances))\n        for _, ri := range rt.instances {\n            instances = append(instances, instanceInfo{\n                ID:         ri.instance.ID,\n                State:      string(ri.instance.State),\n                Host:       ri.instance.Host,\n                Port:       ri.instance.Port,\n                ActiveReqs: atomic.LoadInt32(&ri.activeReqs),\n                LastUsed:   ri.lastUsed,\n                Healthy:    ri.healthy,\n            })\n        }\n        functions = append(functions, functionInfo{\n            Name:            name,\n            Instances:       instances,\n            ConcurrencyLimit: int(rt.concurrencyLimit),\n            ActiveCount:     atomic.LoadInt32(&rt.activeCount),\n        })\n    }\n    \n    w.Header().Set(\"Content-Type\", \"application/json\")\n    json.NewEncoder(w).Encode(map[string]interface{}{\n        \"timestamp\": time.Now().Format(time.RFC3339),\n        \"functions\": functions,\n    })\n}\n\n// TODO: Implement handleWarmPoolDebug to show warm pool contents\n// TODO: Implement handleScalingDebug to show scaling decisions and metrics\n// TODO: Implement handleOverview to show system health summary\n```\n\n#### E. Language-Specific Debugging Hints for Go\n\n1. **Memory Profiling**: Run `go tool pprof http://localhost:6060/debug/pprof/heap` to analyze memory usage. Use `-base` flag to compare two profiles.\n\n2. **Goroutine Leaks**: Check `/debug/pprof/goroutine?debug=2` for full stack traces. Look for goroutines stuck in channel operations without timeouts.\n\n3. **Race Detection**: Always run tests with `go test -race ./...`. For production debugging, build with `-race` flag (2-10x slowdown) during staging.\n\n4. **Context Timeout Chains**: Use `context.WithTimeout` at each layer and ensure child contexts are cancelled when parent times out. Add logging when contexts are cancelled to trace timeout propagation.\n\n5. **Container Debugging**: When a container fails, capture its logs before removal. Store logs in a ring buffer keyed by container ID, accessible via debug API.\n\n#### F. Debugging Workflow Checklist\n\nWhen encountering a bug, follow this systematic workflow:\n\n1. **Reproduce the Issue**\n   - Can you reproduce it consistently? If not, add more logging and try again.\n   - What are the minimal conditions (function code, load pattern, configuration)?\n\n2. **Check the Obvious First**\n   - Are all services running? (`docker ps`, `systemctl status`)\n   - Are there error logs in any component? (Check `journalctl` or component logs)\n   - Is the system under resource pressure? (`htop`, `df -h`, `docker stats`)\n\n3. **Isolate the Component**\n   - Does the issue happen during packaging, routing, execution, or scaling?\n   - Can you bypass components (e.g., invoke container directly vs through gateway)?\n   - Use the debug endpoints (`/debug/routing`, `/debug/warmpool`) to inspect state.\n\n4. **Add Targeted Instrumentation**\n   - Increase log level for the suspected component.\n   - Add temporary metrics or traces around the problematic code path.\n   - Use conditional breakpoints if debugging locally.\n\n5. **Analyze the Evidence**\n   - Collect logs, metrics, and profiles from the time of the issue.\n   - Look for patterns (e.g., \"always fails after 100 invocations\", \"only when memory > 80%\").\n   - Correlate events across components using request IDs.\n\n6. **Form and Test Hypothesis**\n   - Based on evidence, what's the most likely root cause?\n   - Can you write a test that reproduces the issue?\n   - Fix the issue and verify with the same reproduction steps.\n\n#### G. Common Debugging Command Cheat Sheet\n\n```bash\n# View container logs for a specific function instance\ndocker logs $(docker ps -qf \"label=function.name=myfunc\")\n\n# Inspect container resource limits\ndocker inspect $(docker ps -qf \"name=worker\") --format='{{.HostConfig.Memory}} {{.HostConfig.CpuQuota}}'\n\n# Check cgroup memory usage for a container\ncat /sys/fs/cgroup/memory/docker/<container-id>/memory.usage_in_bytes\n\n# Profile Go service with pprof\ngo tool pprof -http=:8080 http://localhost:6060/debug/pprof/profile?seconds=30\n\n# Trace HTTP requests through the system\ncurl -H \"X-Request-ID: debug-123\" http://gateway/invoke/myfunc\n\n# Monitor scaling decisions in real-time\nwatch -n 1 'curl -s http://gateway/debug?view=scaling | jq'\n\n# Force garbage collection and view memory stats\ncurl http://localhost:6060/debug/pprof/heap?gc=1\n\n# Check for goroutine leaks\ncurl -s http://localhost:6060/debug/pprof/goroutine?debug=1 | grep -c \"goroutine\"\n```\n\nRemember: **The most important debugging tool is a reproducible test case.** When you encounter a bug, immediately write a test that reproduces it before fixing it. This prevents regression and helps understand the root cause.\n\n\n## Future Extensions\n\n> **Milestone(s):** This forward-looking section describes enhancements that build upon the foundational architecture established in Milestones 1-5. It illustrates how the current design's modularity and clear interfaces naturally accommodate evolving requirements.\n\nThe serverless function runtime has been designed with **extensibility as a first-class concern**. Its component-based architecture, well-defined interfaces, and event-driven communication patterns create a foundation that can gracefully accommodate new capabilities without requiring significant refactoring. This section explores several potential enhancements that could be built upon the current system, explaining how each aligns with existing components and what modifications would be required.\n\n### Custom Domains and API Gateway Features\n\n**Mental Model: The Hotel Concierge Service**\nImagine upgrading from a simple reception desk (the current HTTP gateway) to a full-service hotel concierge. Instead of just directing guests to their rooms (functions), the concierge can handle complex requests: \"Route `api.example.com/v1/orders` to the `order-processor` function, but send `webhooks.example.com` to the `webhook-handler` function, and apply rate limiting of 100 requests per minute for the `public-api` function.\" This enhanced routing layer transforms the runtime from a simple function executor into a full-fledged API management platform.\n\n**Extension Description:** Currently, the `Gateway` routes all requests through a single endpoint pattern (`/invoke/{functionName}`). A custom domains extension would allow users to map their own domain names to specific functions or groups of functions, with advanced routing rules, authentication, and rate limiting.\n\n**How Current Design Accommodates It:**\n- The `Gateway` component already provides a pluggable middleware chain via the `applyMiddleware` method, making it straightforward to add authentication, rate limiting, and request transformation logic.\n- The `Router` already performs function-based routing; extending it to support host/path-based routing would primarily involve enhancing the `functionRoutingTable` to support multiple lookup keys (e.g., hostname + path prefix).\n- The `InvocationRequest` type already includes a `Source` field that could be enriched with original host/path information for routing decisions.\n\n**Required Changes:**\n1. **Enhanced Routing Table:** Extend the `functionRoutingTable` to support mapping from `(host, path)` tuples to a target function, with priority matching for path prefixes.\n2. **Domain Configuration Store:** Add a new configuration component to manage domain-to-function mappings, likely persisted in the same storage backend used for function artifacts.\n3. **Gateway Middleware:** Implement new middleware for TLS termination (if handling HTTPS), JWT validation, API key checking, and rate limiting per API key or IP address.\n4. **Public API Endpoint:** Add a control plane API for users to configure custom domains and routing rules.\n\n**Example Routing Configuration Table:**\n| Host | Path Pattern | Target Function | Rate Limit | Authentication |\n|------|--------------|-----------------|------------|----------------|\n| `api.company.com` | `/v1/orders/*` | `order-processor` | 1000 RPM | JWT |\n| `webhooks.company.com` | `/stripe` | `stripe-webhook` | None | HMAC Signature |\n| `(default)` | `/admin/*` | `admin-backend` | 100 RPM | API Key |\n\n### Function Composition and Workflows\n\n**Mental Model: The Assembly Line**\nThink of moving from a single, isolated workshop (individual function) to a coordinated assembly line. A raw material (request) enters the line, passes through station A (function A) for initial processing, then moves to station B (function B) for enrichment, and finally to station C (function C) for packaging the response. The assembly line controller manages the flow, handles errors at any station, and ensures the final product is delivered. This enables building complex applications by composing small, reusable functions.\n\n**Extension Description:** Function composition allows users to define workflows where the output of one function becomes the input to another, either sequentially or in parallel. This enables building complex serverless applications without requiring a separate orchestration service.\n\n**How Current Design Accommodates It:**\n- The existing `InvocationRequest` and `InvocationResponse` structures already encapsulate payloads and metadata, providing a natural format for passing data between functions.\n- The `Gateway` and `Router` components already manage request routing; they could be extended to support internal function-to-function calls without leaving the cluster (reducing latency).\n- The event-driven architecture with the `EventDispatcher` provides a foundation for choreographing workflows, where completion of one function triggers the next.\n\n**Required Changes:**\n1. **Workflow Definition Language:** Introduce a new `WorkflowDefinition` type that describes the sequence, parallel branches, error handling, and retry logic.\n2. **Workflow Engine:** Create a new `WorkflowExecutor` component that interprets workflow definitions, manages state (e.g., which step is next), and emits events for each step's start/completion.\n3. **Internal Service Discovery:** Enhance the `Router` to support routing to a local function instance without going through the public gateway, perhaps via a dedicated internal hostname or port.\n4. **State Persistence:** For long-running workflows, introduce a durable state store (e.g., Redis or a database) to track workflow execution progress, allowing recovery after failures.\n\n**Example Workflow Definition Structure:**\n| Field | Type | Description |\n|-------|------|-------------|\n| `Name` | `string` | Unique workflow identifier |\n| `Version` | `string` | Immutable version tag |\n| `StartAt` | `string` | Name of the first step |\n| `Steps` | `map[string]WorkflowStep` | Map of step name to step definition |\n| `Timeout` | `int` | Maximum total execution time in seconds |\n\n**WorkflowStep Structure:**\n| Field | Type | Description |\n|-------|------|-------------|\n| `Type` | `string` | `\"function\"`, `\"parallel\"`, `\"choice\"` |\n| `FunctionName` | `string` | Target function (for `\"function\"` type) |\n| `Next` | `string` | Name of next step on success |\n| `Catch` | `[]ErrorHandler` | Array of error handlers for this step |\n| `Retry` | `[]RetryPolicy` | Array of retry policies for transient failures |\n\n### Advanced Observability and Distributed Tracing\n\n**Mental Model: The Air Traffic Control Radar**\nImagine upgrading from simple flight logs (current metrics) to a comprehensive air traffic control radar system. You can now see not only each plane's (function's) current status but also its entire flight path (request journey) through different airspaces (components), with detailed telemetry on altitude (resource usage), speed (latency), and any turbulence (errors). This end-to-end visibility is crucial for debugging complex interactions in a distributed system.\n\n**Extension Description:** While the current design includes basic metrics via Prometheus (`Metrics` type), advanced observability would add distributed tracing (e.g., OpenTelemetry), structured logging with correlation IDs, and a real-time dashboard for visualizing function dependencies, invocation chains, and performance bottlenecks.\n\n**How Current Design Accommodates It:**\n- The `InvocationRequest` already includes a `RequestID` field, which can be propagated through all components to correlate logs and traces.\n- The `EventDispatcher` already emits lifecycle events (`InstanceEvent`); these events could be automatically enriched with trace spans and exported to an observability backend.\n- The middleware architecture in the `Gateway` makes it easy to inject and extract trace context headers (e.g., W3C Trace Context).\n\n**Required Changes:**\n1. **Tracing Integration:** Integrate an OpenTelemetry SDK to create spans for key operations: gateway request handling, routing, container creation, function execution, and scaling decisions.\n2. **Context Propagation:** Ensure the trace context is passed through the `InvocationRequest` (e.g., via a `TraceContext map[string]string` field) and used when making internal HTTP calls between components.\n3. **Enhanced Logging:** Replace simple log statements with structured logging using a library like `slog` (Go 1.21+), ensuring all logs include the request ID, function name, and trace ID.\n4. **Observability Backend:** Deploy a tracing backend (e.g., Jaeger or Tempo) and a log aggregation system (e.g., Loki) to store and query traces and logs.\n\n**Example Trace Context Addition to `InvocationRequest`:**\n```go\ntype InvocationRequest struct {\n    // ... existing fields ...\n    TraceContext map[string]string `json:\"traceContext,omitempty\"` // W3C Trace Context headers\n}\n```\n\n**Observability Event Flow:**\n1. Gateway receives request → creates root span, extracts/injects trace context.\n2. Router selects instance → adds span for routing logic.\n3. Warm pool provides instance → adds span for pool acquisition.\n4. Function executes → adds span for execution duration.\n5. All spans are linked via trace ID and exported to collector.\n\n### Stateful Functions and Ephemeral Storage\n\n**Mental Model: The Hotel Room with a Safe**\nCurrently, each function invocation gets a completely fresh \"pop-up shop\" with no memory of previous customers. Imagine if each shop could have a small, private safe (`ephemeral storage`) that persists only for the lifetime of that specific shop instance. Multiple visits by the same customer (requests routed to the same instance) could access and update the safe's contents, enabling caching or session state, but when the shop closes (instance terminates), the safe is destroyed. This provides limited, instance-local state without the complexity of external databases.\n\n**Extension Description:** While serverless functions are ideally stateless, some workloads benefit from temporary, instance-local storage that persists across invocations on the same instance (e.g., caching fetched data, accumulating metrics, or maintaining WebSocket connections). This extension would provide a managed, filesystem-based cache that lives alongside the function instance and is automatically cleaned up when the instance is terminated.\n\n**How Current Design Accommodates It:**\n- The `FunctionInstance` already has a lifecycle and identity (`ID`). The `ContainerManager` could attach a volume or directory that persists as long as the container lives.\n- The `WarmPoolManager` already manages instance reuse; it could preserve the ephemeral storage when returning an instance to the pool.\n- The `RuntimeCleaner` interface already defines a `Clean` method, which could be extended to optionally preserve (or securely wipe) the ephemeral storage directory.\n\n**Required Changes:**\n1. **Ephemeral Storage Configuration:** Add a field to `FunctionDefinition` to request ephemeral storage (size, mount path).\n2. **Container Volume Attachment:** Extend `CreateContainerRequest` to include volume mounts for ephemeral storage, using a unique directory per `FunctionInstance.ID`.\n3. **Lifecycle Management:** Modify the `WarmPoolManager` to not delete the ephemeral storage when releasing an instance back to the pool (only on full termination).\n4. **Security Hardening:** Ensure the ephemeral storage is isolated per function and instance (using filesystem permissions or separate volumes) to prevent cross-tenant access.\n\n**Example Addition to `FunctionDefinition`:**\n| Field | Type | Description |\n|-------|------|-------------|\n| `EphemeralStorageMB` | `int` | Size in MB of instance-local persistent storage (0 for none) |\n| `EphemeralStoragePath` | `string` | Mount path inside container (default `/cache`) |\n\n### GPU and Specialized Hardware Support\n\n**Mental Model: The Specialty Kitchen**\nOur current \"pop-up shops\" are equipped with standard kitchen appliances (CPU, memory). Some recipes (workloads) require specialty equipment: a blast chiller for rapid cooling (GPU for matrix math), a sous-vide precision cooker (FPGA for cryptographic operations), or a commercial dough sheeter (TPU for machine learning). This extension allows users to request shops with specific hardware accelerators for compute-intensive tasks.\n\n**Extension Description:** Extend the runtime to schedule functions on worker nodes with specialized hardware (GPUs, FPGAs, TPUs) and expose that hardware to the function container. This opens up serverless to machine learning inference, video encoding, scientific computing, and other accelerated workloads.\n\n**How Current Design Accommodates It:**\n- The `ContainerManager` interface already abstracts container creation; implementations (like `DockerManager`) can be extended to pass device mappings (`--device` flag in Docker).\n- The `Executor` already handles resource limits (CPU, memory); it could be extended to request and track specialized hardware units.\n- The `Scaler` would need awareness of heterogeneous worker nodes (some with GPU, some without) to make appropriate scaling decisions.\n\n**Required Changes:**\n1. **Hardware Resource Model:** Extend `FunctionDefinition` with optional fields like `GPUCount`, `GPUType`, `FPGA`, etc.\n2. **Node Labeling and Scheduling:** Implement a labeling system for worker nodes (e.g., `hardware:gpu-p100`) and modify the `Executor` to select a node with matching capabilities when creating a container.\n3. **Container Device Mapping:** Update `CreateContainerRequest` to include device requests, which the `ContainerManager` implementation translates to runtime-specific flags.\n4. **Cost and Billing:** Track usage of specialized hardware separately for metering and billing purposes.\n\n**Example Addition to `CreateContainerRequest`:**\n| Field | Type | Description |\n|-------|------|-------------|\n| `Devices` | `[]DeviceMapping` | List of host devices to map into container |\n| `DeviceRequests` | `[]DeviceRequest` | Docker-specific device requests (for GPU) |\n\n**DeviceMapping Structure:**\n| Field | Type | Description |\n|-------|------|-------------|\n| `HostPath` | `string` | Path on host |\n| `ContainerPath` | `string` | Path in container |\n| `Permissions` | `string` | `\"rwm\"` (read, write, mknod) |\n\n### Multi-Cloud and Hybrid Deployment\n\n**Mental Model: The Franchise Model**\nOur current runtime operates in a single data center (cloud region). Imagine expanding to a franchise model: identical shops (function instances) can be launched in multiple locations (clouds or on-premises), with a central management system that routes customers to the nearest location or the one with lowest latency. This provides resilience against regional outages and compliance with data sovereignty requirements.\n\n**Extension Description:** Deploy the serverless runtime control plane once, but have it manage worker pools across multiple cloud providers (AWS, GCP, Azure) and/or on-premises data centers. Functions can be deployed globally, with invocations routed to the nearest available instance.\n\n**How Current Design Accommodates It:**\n- The architecture already separates the **control plane** (Gateway, Controller, Scaler) from the **data plane** (Worker Pool). This separation allows the control plane to manage multiple remote worker pools.\n- The `ContainerManager` interface abstracts the underlying infrastructure; different implementations could target different clouds (e.g., `AWSLambdaManager`, `KubernetesManager`).\n- The `Router` could be enhanced with geo-aware routing based on the source IP of the request.\n\n**Required Changes:**\n1. **Multi-Cluster Management:** Extend the `Scaler` and `WarmPoolManager` to manage pools of instances across multiple clusters, each with its own `ContainerManager`.\n2. **Service Discovery Across Clouds:** Implement a global service discovery mechanism (e.g., using a distributed key-value store like etcd) to track available instances across regions.\n3. **Latency-Based Routing:** Enhance the `Router` with latency measurements or geo-IP databases to select the optimal region for each request.\n4. **Cross-Cloud Networking:** Establish secure network connectivity (VPN or cloud interconnect) between control plane and worker pools in different clouds.\n\n**Example Multi-Cluster Configuration:**\n| Cluster Name | Provider | Region | ContainerManager Type | Endpoint |\n|--------------|----------|--------|----------------------|----------|\n| `us-east` | AWS | us-east-1 | `DockerManager` | `https://worker-us-east.internal` |\n| `eu-central` | GCP | europe-west3 | `KubernetesManager` | `https://worker-eu.internal` |\n| `on-prem` | On-prem | datacenter-1 | `DockerManager` | `https://worker-onprem.internal` |\n\n### Event-Driven Architecture with Multiple Sources\n\n**Mental Model: The Universal Adapter Hub**\nCurrently, functions are primarily triggered by HTTP requests. Imagine adding a universal adapter hub that can connect to any event source: message queues (Kafka, RabbitMQ), cloud storage (S3 bucket notifications), database change streams (MongoDB change streams, PostgreSQL LISTEN/NOTIFY), or cron schedules. The hub converts these diverse events into a standard `InvocationRequest` and feeds them into the existing gateway or a dedicated async invoker.\n\n**Extension Description:** Expand the event sources beyond HTTP to include message queues, streaming platforms, cloud storage events, and scheduled (cron) invocations. This transforms the runtime into a general-purpose event-driven compute platform.\n\n**How Current Design Accommodates It:**\n- The `InvocationRequest` type is already source-agnostic, with a `Source` field indicating origin.\n- The asynchronous invocation mode (queued request) already decouples event receipt from function execution.\n- The `EventDispatcher` can be used to propagate events from new sources to internal components.\n\n**Required Changes:**\n1. **Event Source Connectors:** Develop a set of pluggable connectors (`KafkaConnector`, `S3EventsConnector`, `CronScheduler`) that poll or listen for events and convert them to `InvocationRequest`s.\n2. **Event Router:** Create a new `EventRouter` component that receives events from all connectors, applies optional filtering/transformation, and forwards them to the appropriate function (via the existing `Gateway` or a new async path).\n3. **Enhanced Async Invoker:** Extend the asynchronous invocation pathway to support larger payloads (by storing them in object storage) and guaranteed delivery with retries (using a durable queue like Redis Streams or Apache Pulsar).\n\n**Event Source Connector Interface:**\n| Method | Parameters | Returns | Description |\n|--------|------------|---------|-------------|\n| `Start` | `ctx context.Context, eventHandler func(InvocationRequest) error` | `error` | Starts listening for events and calls handler for each |\n| `Stop` | `ctx context.Context` | `error` | Stops the connector gracefully |\n| `Health` | `ctx context.Context` | `error` | Returns health status of the connection to event source |\n\n### Design Principles for Extensibility\n\nThroughout these extensions, several core design principles embedded in the current architecture prove invaluable:\n\n1. **Interface-Based Abstraction:** Key components like `ContainerManager`, `WarmPoolManager`, and `EventDispatcher` are defined as interfaces, allowing multiple implementations without changing dependent code.\n2. **Event-Driven Communication:** The lifecycle event system (`InstanceEvent`) creates a loosely coupled architecture where new components can subscribe to relevant events without modifying event publishers.\n3. **Modular Configuration:** The use of configuration structs (`GatewayConfig`, `ScalingConfig`, `PoolConfig`) makes it easy to add new knobs for tuning extended features.\n4. **Clear Data Flow:** The well-defined data structures (`FunctionDefinition`, `InvocationRequest`, `FunctionInstance`) serve as a consistent \"language\" across components, making it natural to add new fields for extended capabilities.\n5. **Layered Architecture:** Separation between control plane (orchestration) and data plane (execution) allows each to evolve independently and scale differently.\n\nBy adhering to these principles, the serverless function runtime maintains its agility—ready to evolve as new requirements emerge from users and the ever-changing landscape of cloud computing.\n\n### Implementation Guidance\n\n**Technology Recommendations Table:**\n\n| Extension | Simple Option | Advanced Option |\n|-----------|---------------|-----------------|\n| Custom Domains | Nginx proxy in front of Gateway with manual config | Envoy Proxy with dynamic configuration via xDS API |\n| Function Composition | Simple sequential chaining in Gateway middleware | Apache Airflow or Temporal integration for complex DAGs |\n| Distributed Tracing | OpenTelemetry SDK with stdout exporter | Jaeger or Grafana Tempo backend with sampling and aggregation |\n| Ephemeral Storage | Host-mounted volumes with per-instance directories | Network-attached storage (e.g., EFS) with faster cleanup |\n| GPU Support | Docker `--gpus all` flag with NVIDIA runtime | Kubernetes Device Plugins with resource quotas |\n| Multi-Cloud | Separate deployments per cloud with manual failover | HashiCorp Consul for service mesh across clouds |\n| Event Sources | Cron scheduler built into Controller | Apache Camel or Spring Cloud Stream for connector framework |\n\n**Recommended File/Module Structure:**\n\n```\nproject-root/\n  cmd/\n    server/                 # Main control plane server\n    worker/                 # Optional separate worker agent\n  internal/\n    extensions/             # New directory for extension implementations\n      apigateway/           # Custom domains and API Gateway features\n        router_ext.go       # Enhanced routing table\n        middleware/         # Auth, rate limiting middleware\n      workflows/            # Function composition\n        workflow_def.go     # WorkflowDefinition type\n        executor.go         # WorkflowExecutor\n      observability/        # Advanced tracing\n        tracing.go          # OpenTelemetry setup\n        correlated_logger.go # Structured logging\n      storage/              # Ephemeral storage\n        ephemeral_manager.go # Manages instance-local volumes\n      hardware/             # GPU support\n        device_manager.go   # Detects and allocates devices\n      multicloud/           # Multi-cloud deployment\n        cluster_manager.go  # Manages multiple worker clusters\n      eventsources/         # Event-driven sources\n        connectors/         # Kafka, S3, Cron connectors\n        event_router.go     # Routes events to functions\n```\n\n**Infrastructure Starter Code (OpenTelemetry Setup):**\n\n```go\n// internal/extensions/observability/tracing.go\npackage observability\n\nimport (\n    \"context\"\n    \"go.opentelemetry.io/otel\"\n    \"go.opentelemetry.io/otel/attribute\"\n    \"go.opentelemetry.io/otel/exporters/jaeger\"\n    \"go.opentelemetry.io/otel/propagation\"\n    \"go.opentelemetry.io/otel/sdk/resource\"\n    sdktrace \"go.opentelemetry.io/otel/sdk/trace\"\n    semconv \"go.opentelemetry.io/otel/semconv/v1.17.0\"\n    \"go.opentelemetry.io/otel/trace\"\n)\n\n// InitTracer initializes OpenTelemetry tracing with Jaeger exporter.\n// Call this once at application startup.\nfunc InitTracer(serviceName, jaegerEndpoint string) (func(context.Context) error, error) {\n    exp, err := jaeger.New(jaeger.WithCollectorEndpoint(jaeger.WithEndpoint(jaegerEndpoint)))\n    if err != nil {\n        return nil, err\n    }\n\n    tp := sdktrace.NewTracerProvider(\n        sdktrace.WithBatcher(exp),\n        sdktrace.WithResource(resource.NewWithAttributes(\n            semconv.SchemaURL,\n            semconv.ServiceName(serviceName),\n            attribute.String(\"environment\", \"production\"),\n        )),\n    )\n    otel.SetTracerProvider(tp)\n    otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(\n        propagation.TraceContext{},\n        propagation.Baggage{},\n    ))\n\n    return tp.Shutdown, nil\n}\n\n// TraceContextFromRequest extracts trace context from HTTP headers.\nfunc TraceContextFromRequest(r *http.Request) map[string]string {\n    ctx := otel.GetTextMapPropagator().Extract(r.Context(), propagation.HeaderCarrier(r.Header))\n    carrier := propagation.HeaderCarrier{}\n    otel.GetTextMapPropagator().Inject(ctx, carrier)\n    return map[string]string(carrier)\n}\n\n// AddTraceContextToInvocationRequest adds trace context to an InvocationRequest.\nfunc AddTraceContextToInvocationRequest(req *types.InvocationRequest, traceCtx map[string]string) {\n    if req.TraceContext == nil {\n        req.TraceContext = make(map[string]string)\n    }\n    for k, v := range traceCtx {\n        req.TraceContext[k] = v\n    }\n}\n```\n\n**Core Logic Skeleton Code (Workflow Executor):**\n\n```go\n// internal/extensions/workflows/executor.go\npackage workflows\n\nimport (\n    \"context\"\n    \"time\"\n)\n\n// WorkflowExecutor manages the execution of a workflow definition.\ntype WorkflowExecutor struct {\n    workflowDef *WorkflowDefinition\n    stateStore  StateStore\n    router      gateway.Router // Use the existing router for function calls\n    metrics     *types.Metrics\n}\n\n// Execute starts workflow execution and returns immediately (async execution).\n// Use GetStatus to poll for completion.\nfunc (e *WorkflowExecutor) Execute(ctx context.Context, input []byte) (string, error) {\n    // TODO 1: Generate a unique execution ID for this workflow run\n    // TODO 2: Persist initial state to StateStore with status \"RUNNING\"\n    // TODO 3: Start a goroutine to actually run the workflow steps\n    // TODO 4: Return the execution ID to the caller\n    return \"\", nil\n}\n\n// runWorkflow is the internal goroutine that executes workflow steps.\nfunc (e *WorkflowExecutor) runWorkflow(ctx context.Context, execID string, input []byte) {\n    // TODO 1: Load workflow definition and current state\n    // TODO 2: Start from the step defined in workflowDef.StartAt\n    // TODO 3: For each step:\n    //   - If type is \"function\", invoke the function via router.Route\n    //   - If type is \"parallel\", invoke all branches concurrently\n    //   - If type is \"choice\", evaluate conditions to select next step\n    // TODO 4: Handle step errors using the Catch/Retry policies\n    // TODO 5: Update state store after each step completion\n    // TODO 6: When workflow completes (or fails), update final status\n}\n\n// GetStatus returns the current status of a workflow execution.\nfunc (e *WorkflowExecutor) GetStatus(ctx context.Context, execID string) (*WorkflowStatus, error) {\n    // TODO 1: Retrieve execution state from StateStore\n    // TODO 2: Return current step, overall status, and any outputs collected so far\n    return nil, nil\n}\n\n// StateStore interface abstracts persistence for workflow state.\ntype StateStore interface {\n    SaveState(ctx context.Context, execID string, state *WorkflowState) error\n    LoadState(ctx context.Context, execID string) (*WorkflowState, error)\n}\n```\n\n**Language-Specific Hints (Go):**\n- Use `context.Context` to propagate trace spans and cancellation across goroutines.\n- For custom domains, consider using the `gorilla/mux` router for advanced path matching.\n- For GPU support, use `github.com/NVIDIA/nvidia-container-runtime` to interface with Docker.\n- For event sources, use `github.com/segmentio/kafka-go` for Kafka connectivity and `github.com/robfig/cron/v3` for cron scheduling.\n\n**Milestone Checkpoint (Testing Custom Domains):**\nAfter implementing custom domain routing:\n1. Start the gateway with the enhanced router.\n2. Configure a domain mapping: `api.test.local -> test-function`.\n3. Use curl to test: `curl -H \"Host: api.test.local\" http://localhost:8080/any/path`\n4. Verify the request is routed to `test-function` and the `InvocationRequest.Source` field contains the original host and path.\n5. Check logs to confirm the correct routing decision.\n\n**Debugging Tips for Extensions:**\n\n| Symptom | Likely Cause | How to Diagnose | Fix |\n|---------|--------------|-----------------|-----|\n| Custom domain requests return 404 | Routing table not populated | Check that domain mappings are loaded into router at startup | Ensure configuration is loaded before gateway starts |\n| Workflow steps execute out of order | Race conditions in parallel steps | Add detailed logging of step start/end times | Use `sync.WaitGroup` to wait for all parallel steps before proceeding |\n| Trace spans are not connected | Context propagation missing in internal calls | Check if `TraceContext` is being passed in `InvocationRequest` | Ensure all internal HTTP calls include trace headers |\n| GPU function fails to start | NVIDIA runtime not installed on worker node | Check container logs for \"could not select device driver\" | Install NVIDIA container toolkit on worker nodes |\n| Multi-cloud instance unhealthy | Network connectivity between control plane and worker | Check if control plane can reach worker endpoint | Configure proper security groups and VPN tunnels |\n\n---\n\n\n## Glossary\n\n> **Milestone(s):** This reference section defines key terminology used throughout the design document, providing clarity for concepts spanning all milestones (1-5).\n\nThe serverless function runtime design introduces many specialized terms and concepts. This glossary provides clear definitions to ensure consistent understanding across the team and document.\n\n### General Serverless Concepts\n\n| Term | Definition | Context & Examples |\n|------|------------|-------------------|\n| **Cold Start** | The latency incurred when a function invocation requires the creation and initialization of a new execution environment from scratch. This includes loading the runtime, dependencies, and function code before execution can begin. | Occurs when no warm instances are available and a new container/microVM must be provisioned. Measured as the time from invocation request to when the handler begins executing. |\n| **Warm Start** | A function invocation that uses a pre-initialized execution environment from the warm pool, avoiding the overhead of environment provisioning and initialization. | Happens when a previously used instance is reused. Typically 10-100x faster than cold starts. |\n| **Isolation** | The architectural principle of preventing one function from observing, interfering with, or exhausting resources allocated to another function, ensuring security and predictable performance in multi-tenant environments. | Implemented through container namespaces, cgroups, seccomp, and/or microVMs. Critical for preventing \"noisy neighbor\" problems. |\n| **Handler** | The entry point function written by developers that processes invocation requests. The runtime loads and invokes this function when a request arrives. | In Go: `func HandleRequest(ctx context.Context, payload []byte) ([]byte, error)`. Specified in the `FunctionDefinition.Handler` field. |\n| **Artifact** | A self-contained package containing function code and all its dependencies, ready for deployment and execution in the runtime environment. | Created during packaging (Milestone 1). For Go, this is a statically linked binary; for Python, a zip with code and virtualenv. |\n| **Immutable Versioning** | A versioning scheme where once a function version is created, it cannot be modified. Each change produces a new version with a unique identifier, enabling rollbacks and consistent deployments. | Implemented using content-addressable storage where the artifact hash becomes the version identifier. |\n| **Control Plane** | The system components responsible for orchestration, scaling, and management decisions—coordinating what should happen but not directly processing requests. | Includes the Controller, Scaler, and WarmPoolManager. Makes decisions about when to create/destroy instances. |\n| **Data Plane** | The system components responsible for actual request processing and function execution—handling the \"data path\" of invocations. | Includes the Gateway, Router, and Worker instances. Processes user requests end-to-end. |\n| **Multi-tenancy** | The ability of the system to securely run functions from multiple customers (tenants) on shared infrastructure while maintaining isolation between them. | Achieved through strong isolation boundaries at container/microVM level and per-tenant resource quotas. |\n| **Ephemeral Storage** | Instance-local persistent storage that lasts for the lifetime of a function instance, typically mounted at `/tmp`, which is cleaned up when the instance terminates. | Used for temporary files, caching, or any data that doesn't need to persist across invocations. Different from durable object storage. |\n| **Event Sources** | External systems that trigger function invocations, such as message queues, storage bucket events, HTTP gateways, or scheduled timers. | The runtime's HTTP Gateway is one event source; future extensions could add S3-compatible storage events or Kafka integration. |\n\n### Isolation & Security Technologies\n\n| Term | Definition | Context & Examples |\n|------|------------|-------------------|\n| **MicroVM** | A lightweight virtual machine optimized for serverless workloads, providing hardware-enforced isolation with minimal overhead. Firecracker is the canonical example. | Offers stronger security than containers with similar startup times when using snapshot restore. Used when maximum isolation is required. |\n| **cgroups (Control Groups)** | A Linux kernel feature that limits, accounts for, and isolates the resource usage (CPU, memory, disk I/O, network) of a collection of processes. | Used to enforce memory limits (`memory.limit_in_bytes`) and CPU quotas (`cpu.cfs_quota_us`). Critical for preventing resource exhaustion attacks. |\n| **Namespaces** | A Linux kernel feature that partitions kernel resources such that one set of processes sees one set of resources while another set of processes sees a different set, providing isolation for processes. | Includes PID (process ID), network, mount, UTS (hostname), IPC, and user namespaces. Containers use these to isolate processes from the host. |\n| **seccomp (Secure Computing)** | A Linux kernel feature that restricts the system calls a process can make, effectively creating a sandbox at the syscall level. | Used with a restrictive profile that only allows necessary syscalls (read, write, exit) and blocks dangerous ones (ptrace, reboot). |\n| **AppArmor** | A Linux Security Module (LSM) that allows system administrators to restrict programs' capabilities with per-program profiles, providing mandatory access control. | Can be used to restrict file access, network capabilities, and library loading beyond what namespaces provide. |\n| **Security Hardening** | The process of securing a system by reducing its attack surface and eliminating vulnerabilities through configuration, least-privilege principles, and defensive coding. | Includes using minimal base images, dropping capabilities, setting no-new-privileges, and applying seccomp/AppArmor profiles. |\n| **Zombie Containers** | Containers that weren't properly cleaned up and continue consuming system resources (memory, PIDs) despite having exited or being orphaned. | Caused by improper lifecycle management. The `ContainerManager` must ensure `RemoveContainer` is called even if `StopContainer` fails. |\n| **OOM Killer (Out-Of-Memory Killer)** | A Linux kernel component that terminates processes when the system is critically low on memory, selected based on heuristics and oom_score. | Triggered when a function exceeds its memory limit without proper cgroup constraints. Proper cgroup configuration ensures the function process itself is killed, not other system processes. |\n\n### Packaging & Dependencies\n\n| Term | Definition | Context & Examples |\n|------|------------|-------------------|\n| **Dependency Resolution** | The process of determining all required libraries and their compatible versions for a function, handling conflicts and ensuring reproducible builds. | For Python: reading `requirements.txt` and resolving transitive dependencies. For Go: running `go mod tidy` to update `go.mod` and `go.sum`. |\n| **Content-Addressable Storage (CAS)** | A storage system where content is retrieved by its cryptographic hash rather than location or name, providing deduplication and integrity verification. | Used for storing function artifacts. The SHA-256 hash of the artifact becomes its address, enabling immutable versions and efficient caching. |\n| **Dependency Hell** | A situation where different functions or versions require incompatible versions of the same library, causing conflicts that prevent proper execution. | Mitigated by isolated execution environments (each function gets its own dependencies) and careful version pinning during packaging. |\n| **Language-Specific Runtime Bundling** | The process of packaging function code with its language runtime and dependencies into a self-contained executable or archive. | Go: compiled to static binary. Python: virtualenv zipped with handler. Java: Uber JAR with all dependencies. |\n| **Base Image** | A minimal container image containing just the language runtime and essential system libraries, used as the foundation for function execution environments. | Examples: `golang:alpine` for Go, `python:3.9-slim` for Python. The function artifact is injected into this base image at runtime. |\n| **Overlay Filesystem** | A union filesystem that layers a writable layer on top of read-only base layers, allowing multiple containers to share the same base image while having individual writeable spaces. | Used to efficiently share common runtime layers across function instances while giving each instance its own `/tmp` directory. |\n\n### Execution & Optimization\n\n| Term | Definition | Context & Examples |\n|------|------------|-------------------|\n| **Warm Pool** | A collection of pre-initialized function instances ready for immediate use, maintained to reduce cold start latency for incoming requests. | Managed by the `WarmPoolManager`. Contains instances in `InstanceStateWarm` state, waiting for assignment. |\n| **Instance Reuse** | The practice of returning a container to the warm pool after execution completes (if healthy) for reuse by subsequent invocations, avoiding teardown/creation overhead. | Controlled by the `ReleaseInstance` method with a `healthy` boolean indicating whether the instance can be reused. |\n| **Predictive Warming** | Proactively creating warm instances based on traffic pattern analysis, historical data, or scheduled events, anticipating demand before it arrives. | The `PreWarm` method creates instances ahead of expected load. More advanced than reactive scaling. |\n| **Snapshot/Restore** | The technique of capturing a running container's state (memory, process tree, open files) to disk and later restoring it to running state much faster than starting from scratch. | Implemented with CRIU (Checkpoint/Restore In Userspace). Can achieve sub-100ms restores for prepared environments. |\n| **Just-In-Time (JIT) Compilation Caching** | Caching the results of runtime compilation (e.g., Python bytecode, JVM JIT optimizations) across invocations to reduce execution latency. | For Python: `.pyc` files cached in the container's filesystem. For Java: HotSpot JVM profile data persisted across warm starts. |\n| **Instance Cleanup** | The process of resetting an execution environment to a fresh state before reuse, removing any temporary files, resetting network connections, and clearing memory. | Implemented by the `RuntimeCleaner` interface. Ensures no data leaks between invocations on the same instance. |\n| **Provisioned Concurrency** | A configuration that keeps a minimum number of instances always warm, guaranteeing zero cold starts for those instances up to the provisioned level. | Useful for latency-sensitive workloads. Implemented as `MinWarmInstances` in the `PoolConfig`. |\n\n### Routing & Load Management\n\n| Term | Definition | Context & Examples |\n|------|------------|-------------------|\n| **Least-Connections** | A load balancing strategy that sends incoming requests to the instance with the fewest active connections/requests, promoting even distribution of load. | Used by the `Router.selectInstance` method. Helps balance load across instances with varying execution times. |\n| **Circuit Breaker** | A design pattern that prevents requests from being sent to unhealthy instances by temporarily \"opening the circuit\" after a threshold of failures is reached. | Implemented in `functionRoutingTable.circuitBreaker`. Stops routing to an instance that consistently fails, giving it time to recover. |\n| **Request Queue** | A bounded buffer that holds incoming requests when all available instances are busy, preventing immediate rejection during traffic spikes. | Implemented as a priority queue in `RequestQueue`. Configurable maximum size to prevent memory exhaustion. |\n| **Timeout Propagation** | The practice of passing deadline information from the client through all system layers to the function execution, ensuring consistent timeout handling across the stack. | The `InvocationRequest.Deadline` is set by the gateway and respected by the router, executor, and container manager. |\n| **Concurrency Limit** | The maximum number of simultaneous requests a function instance can handle, preventing over-subscription and resource contention. | Enforced per instance (`routedInstance.activeReqs`) and per function (`functionRoutingTable.concurrencyLimit`). |\n| **Sticky Routing** | Sending subsequent requests from the same client/session to the same function instance, useful for maintaining in-memory state or warming caches. | Optional feature using `InvocationRequest.PreferredInstanceID`. Implemented with a TTL to handle instance termination. |\n| **Load Shedding** | Intentionally rejecting requests (with 503 Service Unavailable) when the system is overloaded, protecting critical components from collapse under excessive load. | Implemented when the request queue is full or when system-wide resource thresholds are exceeded. |\n| **Backpressure** | A mechanism that signals upstream components to slow down when downstream components are overloaded, preventing cascading failures. | The request queue depth metrics can feed back to the gateway to adjust admission control. |\n\n### Scaling & Lifecycle\n\n| Term | Definition | Context & Examples |\n|------|------------|-------------------|\n| **Auto-Scaling** | The dynamic adjustment of function instances based on demand, automatically adding instances during load increases and removing them during decreases. | Implemented by the `Scaler` component, which evaluates metrics and makes `ScaleDecision`s. |\n| **Scale-to-Zero** | The capability to remove all running instances of a function after a period of inactivity (idle timeout), eliminating resource consumption when not in use. | Triggered by `Scaler` when `IdleTimeout` is reached. All instances transition through `InstanceStateDraining` to `InstanceStateTerminated`. |\n| **Target Concurrency** | The desired number of concurrent executions per instance used as a scaling target; scaling occurs to maintain actual concurrency near this target. | Set in `ScalingConfig.TargetConcurrency`. If actual concurrency per instance exceeds this, scale up; if below, scale down. |\n| **Scaling Thrashing** | Rapid oscillation between scale-up and scale-down actions caused by overly sensitive thresholds or insufficient stabilization periods. | Prevented by cooldown periods (`ScaleUpCooldown`, `ScaleDownCooldown`) and hysteresis (different up/down thresholds). |\n| **Cooldown Period** | A minimum time that must elapse between scaling actions of the same direction, preventing rapid successive adjustments and allowing metrics to stabilize. | Configurable per function in `ScalingConfig`. The `Scaler` tracks `lastScaleUpTime` and `lastScaleDownTime`. |\n| **Idle Timeout** | The duration an instance must be idle (no active requests) before being considered for termination during scale-down operations. | Different from TTL (absolute maximum lifetime). An instance may be terminated earlier due to scale-down even if not idle. |\n| **Hysteresis** | Using different thresholds for scale-up versus scale-down to create a \"dead band\" that prevents oscillation around a single threshold. | Example: scale up at 70% utilization, scale down at 30% utilization, preventing thrashing at 50% utilization. |\n| **Reactive Scaling** | Scaling based on current metrics (e.g., current concurrency, queue depth), responding to observed load changes. | Simpler to implement. The default approach in the `Scaler.EvaluateScaling` method. |\n| **Predictive Scaling** | Scaling based on predicted future demand using historical patterns, time series forecasting, or scheduled events. | More complex but can pre-warm instances before load arrives. Future extension using machine learning models. |\n\n### State Management & Events\n\n| Term | Definition | Context & Examples |\n|------|------------|-------------------|\n| **Lifecycle Event** | A discrete occurrence in the system that triggers state transitions, such as instance creation, request assignment, or timeout expiration. | Represented by `InstanceEvent` with `Type`, `Timestamp`, and related data. Published via `EventDispatcher`. |\n| **State Machine** | A component that manages state transitions with validation, ensuring an entity moves through predefined states according to business rules. | The `StateMachine` for `FunctionInstance` validates transitions using `validateTransition` and executes handlers for each state. |\n| **Flow Coordinator** | An orchestrator component that coordinates cross-component interactions during complex workflows like invocation handling with fallbacks. | The `FlowCoordinator` manages the end-to-end flow of a request, handling timeouts, retries, and error recovery. |\n| **Event Dispatcher** | A component that distributes events to subscribers using channels or callbacks, enabling loose coupling between components. | The `EventDispatcher` allows components like `Scaler`, `WarmPoolManager`, and metrics collectors to react to events. |\n| **Transition Validation** | The process of checking whether a state change is allowed according to defined rules before executing the transition. | The `StateMachine.validateTransition` method ensures illegal transitions (e.g., `Terminated` → `Active`) are rejected. |\n| **Drain Timeout** | The maximum time allowed for graceful shutdown of an instance, during which it completes in-flight requests but accepts no new ones. | When scaling down, instances transition to `InstanceStateDraining` and have until the drain timeout to finish. |\n| **Graceful Degradation** | The system's ability to provide reduced functionality when under stress or partial failure, rather than completely failing. | Example: When storage is unavailable, the system might accept invocations but disable function uploads, rather than rejecting all requests. |\n\n### Error Handling & Resilience\n\n| Term | Definition | Context & Examples |\n|------|------------|-------------------|\n| **Defense-in-Depth** | A layered approach to error handling and security with multiple fallbacks, so if one mechanism fails, others still provide protection. | Example: Functions run in containers (layer 1) with cgroup limits (layer 2) and seccomp filters (layer 3). |\n| **Error Propagation** | The pattern of passing error information through system components with appropriate context, enabling meaningful logging and recovery decisions. | `ClassifiedError` wraps raw errors with type, retryability, and context, flowing from executor to gateway. |\n| **Exponential Backoff** | A retry strategy where the delay between retries increases exponentially, reducing load on recovering systems and preventing retry storms. | Used when retrying failed invocations or container operations. Configurable with `BackoffBase` and `BackoffMax`. |\n| **Fail-Stop** | A design where components stop completely on failure (with clear error signals) rather than continuing in an undefined or corrupted state. | Preferable in isolation components: if a container cannot be securely created, fail completely rather than run with weakened isolation. |\n| **Cold Start Retry** | Specifically retrying an invocation that failed due to cold start timeout, giving a newly created instance more time to initialize. | Controlled by `SyncInvokerConfig.RetryOnColdStart`. The `handleColdStartRetry` method determines if retry is appropriate. |\n| **Recovery State Machine** | A specialized state machine that manages the recovery lifecycle of a failed instance, attempting cleanup, health checks, and potential restart. | Future extension: when an instance enters `InstanceStateError`, a recovery state machine could attempt automated repair. |\n\n### Testing & Observability\n\n| Term | Definition | Context & Examples |\n|------|------------|-------------------|\n| **Arrange-Act-Assert** | A unit test pattern with clear separation of test setup (Arrange), execution (Act), and verification (Assert), improving test readability. | Used throughout the test suite. Example: Arrange a mock container manager, Act by calling `CreateContainer`, Assert that container exists. |\n| **Property-Based Tests** | Tests that generate random inputs according to specified properties to discover edge cases, rather than testing specific predefined examples. | Useful for testing the router's load balancing algorithm with random request distributions and instance health states. |\n| **Golden Files** | Reference test output files stored alongside tests for comparison, ensuring output format stability across refactorings. | Used for testing serialization formats (e.g., `FunctionDefinition` JSON marshaling) and CLI command outputs. |\n| **Testcontainers** | A pattern for spinning up real container dependencies (like databases) in tests, providing more realistic integration testing. | Used in integration tests that require actual Docker containers rather than mocks. |\n| **Deterministic Time** | A controllable time source (like `FakeClock`) used in timing-sensitive tests, allowing precise control over time-based behavior. | Critical for testing timeout logic, TTL expiration, and scaling cooldowns without actually sleeping. |\n| **Distributed Tracing** | End-to-end tracking of requests across service boundaries using unique trace IDs and span IDs, enabling performance analysis in complex systems. | Implemented via OpenTelemetry with Jaeger. `TraceContextFromRequest` extracts and propagates trace context. |\n| **Trace Context** | A set of headers (trace ID, span ID, sampling flags) that propagate across services for distributed tracing, following the W3C Trace Context standard. | Added to `InvocationRequest` via `AddTraceContextToInvocationRequest` and passed through all components. |\n| **Observability** | The measure of how well internal states of a system can be inferred from its external outputs (logs, metrics, traces), beyond simple monitoring. | The runtime provides metrics (Prometheus), structured logs, and distributed traces for full observability. |\n\n### Advanced Concepts & Extensions\n\n| Term | Definition | Context & Examples |\n|------|------------|-------------------|\n| **Custom Domains** | Mapping user domain names (e.g., `api.example.com`) to specific functions with advanced routing rules, TLS termination, and custom middleware. | Future extension: adds a domain manager component that integrates with the gateway for host-based routing. |\n| **Function Composition** | Orchestrating multiple functions into workflows where the output of one function becomes the input to another, creating serverless applications. | Implemented via the `WorkflowEngine` interpreting `WorkflowDefinition` with steps, error handlers, and retry policies. |\n| **Workflow Engine** | A component that interprets workflow definitions and manages stateful execution of steps, handling retries, error branching, and parallel execution. | Manages `WorkflowState` persistence and coordinates function invocations as defined in `WorkflowStep` configurations. |\n| **GPU Support** | Allocating and exposing graphics processing units (or other accelerators) to functions for machine learning, video processing, or scientific computing. | Requires specialized container configuration (nvidia-docker), GPU-aware scheduling, and billing for accelerator time. |\n| **Specialized Hardware** | Accelerators like GPUs, FPGAs, or TPUs allocated to functions for compute-intensive workloads beyond general-purpose CPUs. | Future extension requiring hardware inventory management, driver isolation, and specialized scheduling algorithms. |\n| **Multi-Cloud Deployment** | Running the runtime across multiple cloud providers and/or on-premises data centers, with unified management and function portability. | Architecture designed with pluggable components (storage, container runtime) to support different infrastructure backends. |\n| **Edge Deployment** | Running function instances geographically close to end-users for reduced latency, with synchronization challenges for state and code distribution. | Requires lightweight worker nodes, efficient artifact distribution, and location-aware routing in the gateway. |\n\n---\n\n> **Key Insight:** Consistent terminology is crucial in distributed systems. This glossary not only defines terms but reveals the conceptual framework of the runtime—how isolation, speed, and efficiency trade-offs are managed through specific technologies and patterns. When implementing, ensure your team uses these exact terms to avoid confusion.\n\n### Common Acronyms\n\n| Acronym | Full Form | Context |\n|---------|-----------|---------|\n| **CAS** | Content-Addressable Storage | Used for artifact storage (Milestone 1) |\n| **CRIU** | Checkpoint/Restore In Userspace | Used for container snapshot/restore (Milestone 3) |\n| **OOM** | Out-Of-Memory | Error type when function exceeds memory limits |\n| **RPS** | Requests Per Second | Key scaling metric (Milestone 5) |\n| **TTL** | Time-To-Live | Maximum lifetime for warm instances |\n| **JIT** | Just-In-Time | Compilation caching optimization |\n| **JVM** | Java Virtual Machine | Runtime for Java functions |\n| **VM** | Virtual Machine | General virtualization technology |\n| **LSM** | Linux Security Module | AppArmor, SELinux security frameworks |\n| **API** | Application Programming Interface | How users interact with the system |\n| **HTTP** | Hypertext Transfer Protocol | Primary invocation protocol |\n| **JSON** | JavaScript Object Notation | Data serialization format |\n| **CLI** | Command Line Interface | Administrative tooling |\n| **UI** | User Interface | Web-based management console (future) |\n| **IPC** | Inter-Process Communication | Namespace type for container isolation |\n| **UTS** | UNIX Timesharing System | Namespace for hostname isolation |\n| **PID** | Process ID | Namespace for process tree isolation |\n"}