{"html":"<h1 id=\"url-shortener-microservices-engineering-design-document\">URL Shortener (Microservices) — Engineering Design Document</h1>\n<h2 id=\"system-purpose\">System Purpose</h2>\n<h2 id=\"a-production-grade-url-shortener-decomposed-into-four-independently-deployable-services-each-owning-its-bounded-context-and-data-store-the-design-prioritizes-correct-service-boundary-enforcement-and-async-event-flow-over-feature-breadth-making-the-architectural-decisions-the-primary-deliverable-not-the-product-functionality\">A production-grade URL shortener decomposed into four independently deployable services, each owning its bounded context and data store. The design prioritizes correct service boundary enforcement and async event flow over feature breadth — making the architectural decisions the primary deliverable, not the product functionality.</h2>\n<h2 id=\"service-map\">Service Map</h2>\n<table>\n<thead>\n<tr>\n<th>Service</th>\n<th>Port</th>\n<th>Responsibility</th>\n<th>DB</th>\n<th>Owns Events</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>api-gateway</td>\n<td>8080</td>\n<td>Routing, JWT validation, rate limiting, circuit breaker</td>\n<td>None (Redis for rate limits)</td>\n<td>None</td>\n</tr>\n<tr>\n<td>url-service</td>\n<td>8081</td>\n<td>Shorten, redirect, CRUD, outbox polling</td>\n<td>url_db (PostgreSQL) + Redis cache</td>\n<td>URLCreatedEvent, URLClickedEvent, URLDeletedEvent</td>\n</tr>\n<tr>\n<td>analytics-service</td>\n<td>8082</td>\n<td>Click ingestion, stats queries, milestone detection</td>\n<td>analytics_db (PostgreSQL)</td>\n<td>MilestoneReachedEvent</td>\n</tr>\n<tr>\n<td>user-service</td>\n<td>8083</td>\n<td>Registration, login, JWT issuance</td>\n<td>user_db (PostgreSQL)</td>\n<td>None</td>\n</tr>\n<tr>\n<td>notification-service</td>\n<td>8084</td>\n<td>Notification persistence, delivery logging</td>\n<td>notification_db (PostgreSQL)</td>\n<td>None</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"tech-stack\">Tech Stack</h2>\n<ul>\n<li><strong>Language:</strong> Go (net/http, pgxpool, crypto/rand)</li>\n<li><strong>Message broker:</strong> RabbitMQ (AMQP 0-9-1, topic exchange)</li>\n<li><strong>Databases:</strong> PostgreSQL 16 — one container per service</li>\n<li><strong>Cache / rate-limit store:</strong> Redis 7 (shared infrastructure, not a service DB)</li>\n<li><strong>Containerization:</strong> Docker Compose with healthcheck-gated dependency ordering</li>\n<li><strong>Auth:</strong> HS256 JWT; verified locally in each service, issued only by user-service</li>\n</ul>\n<hr>\n<h2 id=\"key-design-decisions\">Key Design Decisions</h2>\n<ul>\n<li><strong>Outbox pattern for event delivery:</strong> URL Service writes events to an <code>outbox</code> table in the same transaction as the URL mutation. A worker pool polls and publishes to RabbitMQ. This eliminates the dual-write failure window where a service could commit a URL row but fail to publish the corresponding event.</li>\n<li><strong>Async click analytics:</strong> URLClickedEvent is published asynchronously via the outbox rather than calling analytics-service synchronously on the redirect hot path. This decouples redirect latency from analytics availability entirely.</li>\n<li><strong>Redis as cache, not as a service database:</strong> All durable writes go to PostgreSQL first. Redis holds read copies with TTL for the redirect hot path and token-bucket counters for gateway rate limiting. Redis unavailability degrades gracefully — it never causes a write failure.</li>\n<li><strong>Stateless JWT verification:</strong> Every service verifies tokens locally using the shared secret. No per-request call to user-service. The gateway is the first verification point; downstream services verify independently as a defense layer.</li>\n<li><strong>Gateway enforces cross-cutting concerns only:</strong> JWT validation, rate limiting, circuit breaking, and correlation ID injection live in the gateway. Zero domain logic crosses into it — no URL ownership checks, no stats computation.</li>\n</ul>\n<hr>\n<h2 id=\"anti-patterns-explicitly-avoided\">Anti-Patterns Explicitly Avoided</h2>\n<table>\n<thead>\n<tr>\n<th>Anti-Pattern</th>\n<th>Mitigation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Shared Database</strong></td>\n<td>Four separate PostgreSQL containers; cross-service data flows via events or API calls only</td>\n</tr>\n<tr>\n<td><strong>Synchronous Call Chain</strong></td>\n<td>Gateway routes to exactly one downstream service; analytics reads from queue, never calls url-service</td>\n</tr>\n<tr>\n<td><strong>God Service</strong></td>\n<td>Each service maps to exactly one bounded context; auth, URL lifecycle, analytics, and notifications are split</td>\n</tr>\n<tr>\n<td><strong>Chatty Service</strong></td>\n<td>Analytics trusts event payloads; it does not call back to url-service to validate <code>short_code</code> on ingestion</td>\n</tr>\n</tbody></table>\n<hr>\n<h1 id=\"tdd\">TDD</h1>\n<p>Five independently deployable Go binaries communicating via HTTP/JSON (sync) and RabbitMQ (async), each with a private PostgreSQL schema. An API Gateway enforces cross-cutting concerns without business logic. The outbox pattern guarantees at-least-once event delivery. Redis serves dual roles: read-through cache in url-service and token-bucket rate-limit store in the gateway. Circuit breaker, correlation IDs, and structured JSON logging provide production-grade observability.</p>\n<!-- TDD_MOD_ID: url-shortener-m1 -->\n<h1 id=\"technical-design-specification\">Technical Design Specification</h1>\n<h2 id=\"module-foundation-repo-layout-shared-contracts-local-dev-stack\">Module: Foundation — Repo Layout, Shared Contracts, Local Dev Stack</h2>\n<h2 id=\"module-id-url-shortener-m1\"><strong>Module ID:</strong> <code>url-shortener-m1</code></h2>\n<h2 id=\"1-module-charter\">1. Module Charter</h2>\n<p>This module establishes every piece of structural infrastructure that subsequent milestones build upon: the monorepo directory layout, Go module declarations per service, shared domain event contracts, Docker Compose topology with full healthcheck wiring, and connection bootstrapping (PostgreSQL via pgxpool, Redis, RabbitMQ) in each service&#39;s <code>main.go</code>. It also declares the RabbitMQ exchange and queue topology that later milestones publish into and consume from.\nThis module does <strong>not</strong> implement any business logic, authentication, URL shortening, analytics ingestion, notification delivery, or message routing. No HTTP handler beyond <code>/health</code> is written. No SQL schema migrations are created (those belong to M2–M5). No JWT middleware, no outbox poller, no consumer goroutines.\n<strong>Upstream dependencies:</strong> None — this is the foundation layer.\n<strong>Downstream dependencies:</strong> Every subsequent milestone (M2–M5) imports <code>shared/events</code>, <code>shared/logger</code>, and relies on the Docker Compose topology defined here.\n<strong>Invariants that must always hold after this milestone:</strong></p>\n<ul>\n<li>Every service owns exactly one PostgreSQL container; no two services share a container or schema.</li>\n<li>Redis is reachable by url-service but is treated as optional: <code>redis.Client</code> initialization failure must not prevent startup.</li>\n<li>RabbitMQ exchange <code>url-shortener</code> (topic) exists before any service attempts to publish or consume; declaration is idempotent.</li>\n<li>Every service returns HTTP 200 on <code>GET /health</code> within 10ms once healthy.</li>\n<li><code>docker compose up</code> brings all containers to the healthy state within 60 seconds on commodity hardware.</li>\n</ul>\n<hr>\n<h2 id=\"2-file-structure\">2. File Structure</h2>\n<p>Create files in the numbered order below. Parent directories that do not yet exist must be created first.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-shortener/                          # repo root\n│\n├── 01  docker-compose.yml\n├── 02  .env.example\n├── 03  README.md\n│\n├── shared/\n│   ├── 04  events/\n│   │   └── 05  events.go              # DomainEvent interface + all event structs\n│   └── 06  logger/\n│       └── 07  logger.go             # Structured JSON logger (zerolog wrapper)\n│\n├── services/\n│   ├── url-service/\n│   │   ├── 08  go.mod\n│   │   ├── 09  go.sum                 # generated by `go mod tidy`\n│   │   ├── 10  main.go\n│   │   ├── 11  Dockerfile\n│   │   └── handler/\n│   │       └── 12  health.go\n│   │\n│   ├── analytics-service/\n│   │   ├── 13  go.mod\n│   │   ├── 14  go.sum\n│   │   ├── 15  main.go\n│   │   ├── 16  Dockerfile\n│   │   └── handler/\n│   │       └── 17  health.go\n│   │\n│   ├── user-service/\n│   │   ├── 18  go.mod\n│   │   ├── 19  go.sum\n│   │   ├── 20  main.go\n│   │   ├── 21  Dockerfile\n│   │   └── handler/\n│   │       └── 22  health.go\n│   │\n│   └── notification-service/\n│       ├── 23  go.mod\n│       ├── 24  go.sum\n│       ├── 25  main.go\n│       ├── 26  Dockerfile\n│       └── handler/\n│           └── 27  health.go\n│\n└── gateway/\n    ├── 28  go.mod\n    ├── 29  go.sum\n    ├── 30  main.go\n    ├── 31  Dockerfile\n    └── handler/\n        └── 32  health.go</code></pre></div>\n<h2 id=\"total-files-to-create-32-excluding-auto-generated-gosum-files\"><strong>Total files to create: 32</strong> (excluding auto-generated <code>go.sum</code> files).</h2>\n<h2 id=\"3-complete-data-model\">3. Complete Data Model</h2>\n<h3 id=\"31-domain-event-structs-sharedeventseventsgo\">3.1 Domain Event Structs (<code>shared/events/events.go</code>)</h3>\n<p>All domain events share a common interface and a set of concrete structs. Every struct is defined here regardless of which service produces or consumes it — this is the single source of truth for event schema.</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> events</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// DomainEvent is the interface satisfied by every event struct.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// EventType returns the routing key used on the RabbitMQ topic exchange.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// OccurredAt returns the wall-clock time the domain action happened.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> DomainEvent</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    GetEventType</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    GetOccurredAt</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// EventType constants — used as RabbitMQ routing keys.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Pattern: &#x3C;aggregate>.&#x3C;action> (dot-separated, lower-case).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventTypeURLCreated</span><span style=\"color:#F97583\">       =</span><span style=\"color:#9ECBFF\"> \"url.created\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventTypeURLClicked</span><span style=\"color:#F97583\">       =</span><span style=\"color:#9ECBFF\"> \"url.clicked\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventTypeURLDeleted</span><span style=\"color:#F97583\">       =</span><span style=\"color:#9ECBFF\"> \"url.deleted\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventTypeMilestoneReached</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"milestone.reached\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URLCreatedEvent is published by url-service when a short URL is created.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CorrelationID is propagated from the HTTP request's X-Correlation-ID header</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// so that async log traces can be stitched together.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLCreatedEvent</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventType     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"event_type\"`</span><span style=\"color:#6A737D\">      // always \"url.created\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OccurredAt    </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"occurred_at\"`</span><span style=\"color:#6A737D\">     // RFC3339Nano</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CorrelationID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"correlation_id\"`</span><span style=\"color:#6A737D\">  // UUID v4; propagated from HTTP header</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"short_code\"`</span><span style=\"color:#6A737D\">      // 7-char base62 code</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OriginalURL   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"original_url\"`</span><span style=\"color:#6A737D\">    // full destination URL</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"user_id\"`</span><span style=\"color:#6A737D\">         // UUID string; owner</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserEmail     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"user_email\"`</span><span style=\"color:#6A737D\">      // included so consumers need no callback</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt     </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"expires_at,omitempty\"`</span><span style=\"color:#6A737D\"> // nil = no expiry</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#B392F0\">URLCreatedEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetEventType</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">    { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> e.EventType }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#B392F0\">URLCreatedEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetOccurredAt</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> e.OccurredAt }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URLClickedEvent is published by url-service on every redirect (via outbox).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// IPHash is SHA-256(raw_ip + salt) — never the raw IP address.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLClickedEvent</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventType     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"event_type\"`</span><span style=\"color:#6A737D\">      // always \"url.clicked\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OccurredAt    </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"occurred_at\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CorrelationID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"correlation_id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventID       </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"event_id\"`</span><span style=\"color:#6A737D\">        // UUID v4; used for idempotency dedup</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"user_id\"`</span><span style=\"color:#6A737D\">         // owner of the short URL (not clicker)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IPHash        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"ip_hash\"`</span><span style=\"color:#6A737D\">         // SHA-256(ip+salt), hex encoded</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserAgent     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"user_agent\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Referer       </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"referer,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#B392F0\">URLClickedEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetEventType</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">    { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> e.EventType }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#B392F0\">URLClickedEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetOccurredAt</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> e.OccurredAt }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URLDeletedEvent is published by url-service when a URL is soft-deleted.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLDeletedEvent</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventType     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"event_type\"`</span><span style=\"color:#6A737D\">      // always \"url.deleted\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OccurredAt    </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"occurred_at\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CorrelationID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"correlation_id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"user_id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserEmail     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"user_email\"`</span><span style=\"color:#6A737D\">      // avoid cross-service lookup</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#B392F0\">URLDeletedEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetEventType</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">    { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> e.EventType }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#B392F0\">URLDeletedEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetOccurredAt</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> e.OccurredAt }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// MilestoneReachedEvent is published by analytics-service when a click</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// threshold (10, 100, 1000) is crossed.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> MilestoneReachedEvent</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventType     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"event_type\"`</span><span style=\"color:#6A737D\">      // always \"milestone.reached\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OccurredAt    </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"occurred_at\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CorrelationID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"correlation_id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"user_id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserEmail     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"user_email\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Milestone     </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">       `json:\"milestone\"`</span><span style=\"color:#6A737D\">       // 10 | 100 | 1000</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TotalClicks   </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">     `json:\"total_clicks\"`</span><span style=\"color:#6A737D\">    // current count at time of trigger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#B392F0\">MilestoneReachedEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetEventType</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">    { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> e.EventType }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">e </span><span style=\"color:#B392F0\">MilestoneReachedEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">GetOccurredAt</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> e.OccurredAt }</span></span></code></pre></div>\n<p><strong>Field rationale:</strong></p>\n<ul>\n<li><code>UserEmail</code> is embedded in every event because notification-service must send email without calling user-service. If this field is absent, notification-service would need a synchronous callback — the exact Chatty Service anti-pattern.</li>\n<li><code>CorrelationID</code> appears on every event so async log traces can be followed through the message broker.</li>\n<li><code>EventID</code> on <code>URLClickedEvent</code> is the deduplication key used by analytics-service (see M4).</li>\n<li><code>*time.Time</code> (pointer) for <code>ExpiresAt</code> allows <code>null</code> in JSON without a sentinel value.</li>\n</ul>\n<h3 id=\"32-health-response-schema\">3.2 Health Response Schema</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// HealthResponse is the JSON body returned by GET /health on every service.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> HealthResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status  </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"status\"`</span><span style=\"color:#6A737D\">   // always \"ok\" in this milestone</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Service </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"service\"`</span><span style=\"color:#6A737D\">  // service name: \"url-service\", \"analytics-service\", etc.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"33-logger-fields-structured-json\">3.3 Logger Fields (Structured JSON)</h3>\n<p>Every log line must contain these fields. Fields absent from the current scope should be empty strings, not omitted.</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// LogEntry documents the expected JSON shape of every log line.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Actual emission is via zerolog — this struct is documentation only.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> LogEntry</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Level         </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"level\"`</span><span style=\"color:#6A737D\">          // \"debug\"|\"info\"|\"warn\"|\"error\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Time          </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"time\"`</span><span style=\"color:#6A737D\">            // RFC3339Nano</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Service       </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"service\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CorrelationID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"correlation_id\"`</span><span style=\"color:#6A737D\">  // empty string if not yet available</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Method        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"method\"`</span><span style=\"color:#6A737D\">          // HTTP method; empty for non-request logs</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Path          </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"path\"`</span><span style=\"color:#6A737D\">            // HTTP path; empty for non-request logs</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status        </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">    `json:\"status\"`</span><span style=\"color:#6A737D\">          // HTTP status; 0 for non-request logs</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DurationMS    </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">  `json:\"duration_ms\"`</span><span style=\"color:#6A737D\">     // 0 for non-request logs</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Msg           </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"msg\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-1.svg\" alt=\"Monorepo Directory Tree\"></p>\n<hr>\n<h2 id=\"4-interface-contracts\">4. Interface Contracts</h2>\n<h3 id=\"41-sharedlogger-package\">4.1 <code>shared/logger</code> Package</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> logger</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">io</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/rs/zerolog</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// New returns a zerolog.Logger configured for structured JSON output.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// serviceName is embedded in every log line as the \"service\" field.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// w is the output writer; pass os.Stdout in production.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Call once at service startup; store in the service's dependency struct.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">serviceName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> io</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Writer</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span></code></pre></div>\n<p><strong>Behavior:</strong></p>\n<ul>\n<li>Sets <code>zerolog.TimeFieldFormat = zerolog.TimeFormatUnixMs</code> globally.</li>\n<li>Returns a logger with the <code>service</code> field pre-populated.</li>\n<li>The returned <code>zerolog.Logger</code> is value-safe to copy; pass it by value into handlers.</li>\n<li>No global logger variable is set. All callers receive the instance and pass it forward.</li>\n</ul>\n<h3 id=\"42-handlerhealthhandler\">4.2 <code>handler.HealthHandler</code></h3>\n<p>Each service has an identical health handler. Specify once; replicate across services.</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// NewHealthHandler returns an http.HandlerFunc that responds to GET /health.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// serviceName must be one of: \"url-service\", \"analytics-service\",</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// \"user-service\", \"notification-service\", \"gateway\".</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewHealthHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">serviceName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HandlerFunc</span></span></code></pre></div>\n<p><strong>Contract:</strong></p>\n<ul>\n<li>Method: <code>GET /health</code> (method not enforced in this milestone; any method returns 200).</li>\n<li>Response status: <code>200 OK</code>.</li>\n<li>Response <code>Content-Type</code>: <code>application/json</code>.</li>\n<li>Response body: <code>{&quot;status&quot;:&quot;ok&quot;,&quot;service&quot;:&quot;&lt;serviceName&gt;&quot;}</code>.</li>\n<li>Latency: must respond in &lt; 10ms (no DB ping, no external call — pure in-memory).</li>\n<li>The handler must not block. It must not acquire any lock that a slow DB connection could hold.\n<strong>Error cases:</strong> None — this handler has no external dependencies and cannot fail.</li>\n</ul>\n<h3 id=\"43-db-connection-bootstrap\">4.3 DB Connection Bootstrap</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// ConnectDB opens a pgxpool connection pool and verifies connectivity.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// dsn is the full PostgreSQL DSN, e.g.:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   \"postgres://user:pass@host:5432/dbname?sslmode=disable\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// If the pool cannot ping the DB within 15 seconds (with exponential backoff</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// starting at 500ms, doubling, cap 5s), the function returns a non-nil error.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Callers must call os.Exit(1) on error — DB unavailability is fatal.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> ConnectDB</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">dsn</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong>pgxpool configuration applied inside ConnectDB:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">config.MaxConns </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 10</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">config.MinConns </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 2</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">config.MaxConnLifetime </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 30</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Minute</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">config.MaxConnIdleTime </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 5</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Minute</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">config.HealthCheckPeriod </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Minute</span></span></code></pre></div>\n<p><strong>Retry logic (applied before returning an error):</strong></p>\n<ul>\n<li>Attempt 1: immediate.</li>\n<li>Attempt 2: wait 500ms.</li>\n<li>Attempt 3: wait 1s.</li>\n<li>Attempt 4: wait 2s.</li>\n<li>Attempt 5: wait 4s (cap).</li>\n<li>After attempt 5 fails: return <code>fmt.Errorf(&quot;connectDB: failed after 5 attempts: %w&quot;, lastErr)</code>.</li>\n<li>Each attempt calls <code>pool.Ping(ctx)</code>. A successful ping returns the pool immediately.\n<strong>Log on success:</strong> <code>log.Info().Str(&quot;dsn_host&quot;, extractHost(dsn)).Msg(&quot;connected to DB&quot;)</code>\n<em>(Strip credentials from DSN before logging — see § 6 Error Handling Matrix.)</em></li>\n</ul>\n<h3 id=\"44-redis-connection-bootstrap-url-service-only\">4.4 Redis Connection Bootstrap (url-service only)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// ConnectRedis initializes a redis.Client and attempts a PING.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// addr is \"host:port\", e.g. \"redis:6379\".</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns (client, nil) on success.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns (nil, err) if PING fails — but the CALLER must treat this as</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// a non-fatal warning and continue startup.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// The client is nil-safe in the cache layer: all cache helpers must check</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// for a nil client and return a cache-miss sentinel instead of panicking.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> ConnectRedis</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">addr</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong>Behavior:</strong></p>\n<ul>\n<li>Uses <code>redis.NewClient</code> with <code>DialTimeout: 3s</code>, <code>ReadTimeout: 1s</code>, <code>WriteTimeout: 1s</code>.</li>\n<li>Single PING attempt — no retry loop (Redis is optional; don&#39;t block startup).</li>\n<li>On failure: logs <code>log.Warn().Err(err).Msg(&quot;redis unavailable; cache disabled&quot;)</code>.</li>\n<li>Returns <code>nil, err</code> to signal disabled cache. Callers store the <code>*redis.Client</code> as-is; nil means &quot;cache is off.&quot;</li>\n</ul>\n<h3 id=\"45-rabbitmq-bootstrap\">4.5 RabbitMQ Bootstrap</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// ConnectRabbitMQ establishes an AMQP connection and channel, then declares</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// the topic exchange and all queues + bindings.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// url is the AMQP connection URL, e.g. \"amqp://guest:guest@rabbitmq:5672/\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// declareFunc is called once the channel is open; it receives the channel</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// and declares whichever exchanges/queues/bindings are appropriate for the</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// calling service (different services declare different queues).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns (conn, channel, nil) on success.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Retries with exponential backoff (same schedule as ConnectDB) for up to</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// 5 attempts. Returns error if all attempts fail — callers log a warning</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// and schedule a retry; RabbitMQ unavailability must NOT crash services.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> ConnectRabbitMQ</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    url</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    declareFunc</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ch</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">amqp091</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">amqp091</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Connection</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">amqp091</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong>Exchange declaration (performed by url-service&#39;s declareFunc):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">ExchangeDeclare</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"url-shortener\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// name</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"topic\"</span><span style=\"color:#E1E4E8\">,         </span><span style=\"color:#6A737D\">// kind</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    true</span><span style=\"color:#E1E4E8\">,            </span><span style=\"color:#6A737D\">// durable</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">,           </span><span style=\"color:#6A737D\">// auto-deleted</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">,           </span><span style=\"color:#6A737D\">// internal</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">,           </span><span style=\"color:#6A737D\">// no-wait</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    nil</span><span style=\"color:#E1E4E8\">,             </span><span style=\"color:#6A737D\">// args</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong>Queue + binding declaration (analytics-service&#39;s declareFunc):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Declare queue</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">q, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">QueueDeclare</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"analytics.clicks\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// name</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    true</span><span style=\"color:#E1E4E8\">,               </span><span style=\"color:#6A737D\">// durable</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">,              </span><span style=\"color:#6A737D\">// delete when unused</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">,              </span><span style=\"color:#6A737D\">// exclusive</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">,              </span><span style=\"color:#6A737D\">// no-wait</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    nil</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Bind to exchange with routing key pattern</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">QueueBind</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    q.Name,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"url.clicked\"</span><span style=\"color:#E1E4E8\">,   </span><span style=\"color:#6A737D\">// routing key</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"url-shortener\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// exchange</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong>Queue + binding declaration (notification-service&#39;s declareFunc):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">q, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">QueueDeclare</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"notifications.events\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Bind three routing keys</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> _, key </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"url.created\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"url.deleted\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"milestone.reached\"</span><span style=\"color:#E1E4E8\">} {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">QueueBind</span><span style=\"color:#E1E4E8\">(q.Name, key, </span><span style=\"color:#9ECBFF\">\"url-shortener\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>Why consumers declare their own queues:</strong> If only the producer declares the queue, messages published before the consumer starts are dropped. Each consumer declaring its own queue-binding means the queue exists as soon as the consumer starts, regardless of producer order.</p>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-2.svg\" alt=\"Docker Compose Container Topology\"></p>\n<hr>\n<h2 id=\"5-algorithm-specification\">5. Algorithm Specification</h2>\n<h3 id=\"51-service-startup-sequence\">5.1 Service Startup Sequence</h3>\n<p>Every service&#39;s <code>main.go</code> follows this exact procedure. Deviations (e.g., treating DB errors as warnings) are forbidden.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE StartService(serviceName, config):\n  1. Parse configuration from environment variables.\n     Abort (log.Fatal) if any required variable is missing.\n  2. Initialize logger:\n       log = logger.New(serviceName, os.Stdout)\n  3. Connect to PostgreSQL:\n       pool, err = ConnectDB(ctx, config.DatabaseDSN)\n       IF err != nil:\n         log.Fatal().Err(err).Msg(&quot;database connection failed&quot;)\n         os.Exit(1)                    // non-zero exit; Docker will not mark healthy\n       log.Info().Msg(&quot;connected to DB&quot;)\n  4. [url-service only] Connect to Redis:\n       redisClient, err = ConnectRedis(ctx, config.RedisAddr)\n       IF err != nil:\n         log.Warn().Err(err).Msg(&quot;redis unavailable; cache disabled&quot;)\n         redisClient = nil             // service continues without cache\n  5. Connect to RabbitMQ (all services):\n       conn, ch, err = ConnectRabbitMQ(ctx, config.RabbitMQURL, declareFuncForService)\n       IF err != nil:\n         log.Warn().Err(err).Msg(&quot;rabbitmq unavailable; will retry in background&quot;)\n         // Do NOT exit. Schedule a background goroutine to retry connection\n         // every 10s. In this milestone, no messages are published/consumed,\n         // so this is a non-fatal degradation.\n  6. Register routes:\n       mux = http.NewServeMux()\n       mux.HandleFunc(&quot;GET /health&quot;, handler.NewHealthHandler(serviceName, log))\n  7. Start HTTP server:\n       server = &amp;http.Server{\n           Addr:         &quot;:&quot; + config.Port,\n           Handler:      mux,\n           ReadTimeout:  5 * time.Second,\n           WriteTimeout: 10 * time.Second,\n           IdleTimeout:  120 * time.Second,\n       }\n       log.Info().Str(&quot;port&quot;, config.Port).Msg(&quot;service starting&quot;)\n       if err = server.ListenAndServe(); err != nil {\n           log.Fatal().Err(err).Msg(&quot;server exited&quot;)\n       }\nEND PROCEDURE</code></pre></div>\n<p><strong>Step 5 background retry goroutine</strong> (skeleton only — actual publishing is M3+):</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">go</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        time.</span><span style=\"color:#B392F0\">Sleep</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        conn, ch, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> ConnectRabbitMQ</span><span style=\"color:#E1E4E8\">(ctx, config.RabbitMQURL, declareFunc)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            log.</span><span style=\"color:#B392F0\">Warn</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Err</span><span style=\"color:#E1E4E8\">(err).</span><span style=\"color:#B392F0\">Msg</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"rabbitmq reconnect failed; will retry\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            continue</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Store conn and ch in service-level state.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // In M1, just log success.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Msg</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"rabbitmq reconnected\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}()</span></span></code></pre></div>\n<h3 id=\"52-gateway-startup-health-check-loop\">5.2 Gateway Startup Health-Check Loop</h3>\n<p>The gateway&#39;s <code>main.go</code> performs health-checks against all four downstream services during startup. It does NOT block startup on failure — it logs the degraded state and proceeds.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE GatewayStartupHealthCheck(downstreamURLs []string, log):\n  FOR each serviceURL in downstreamURLs:\n    resp, err = http.Get(serviceURL + &quot;/health&quot;)\n    IF err != nil OR resp.StatusCode != 200:\n      log.Warn().Str(&quot;service&quot;, serviceURL).Msg(&quot;downstream health check failed on startup&quot;)\n    ELSE:\n      log.Info().Str(&quot;service&quot;, serviceURL).Msg(&quot;downstream healthy&quot;)\n    close resp.Body\n  // Gateway starts regardless of downstream health.\n  // Circuit breaker (M5) will handle runtime failures.\nEND PROCEDURE</code></pre></div>\n<p>Downstream URLs are read from environment variables:</p>\n<ul>\n<li><code>URL_SERVICE_URL</code> → <code>http://url-service:8081</code></li>\n<li><code>ANALYTICS_SERVICE_URL</code> → <code>http://analytics-service:8082</code></li>\n<li><code>USER_SERVICE_URL</code> → <code>http://user-service:8083</code></li>\n<li><code>NOTIFICATION_SERVICE_URL</code> → <code>http://notification-service:8084</code></li>\n</ul>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-3.svg\" alt=\"RabbitMQ Exchange / Queue / Binding Topology\"></p>\n<hr>\n<h2 id=\"6-docker-compose-specification\">6. Docker Compose Specification</h2>\n<h3 id=\"61-container-inventory\">6.1 Container Inventory</h3>\n<table>\n<thead>\n<tr>\n<th>Container Name</th>\n<th>Image</th>\n<th>Internal Port</th>\n<th>Host Port</th>\n<th>Role</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>url-service</code></td>\n<td>built from <code>services/url-service/Dockerfile</code></td>\n<td>8081</td>\n<td>8081</td>\n<td>URL CRUD + redirects</td>\n</tr>\n<tr>\n<td><code>analytics-service</code></td>\n<td>built from <code>services/analytics-service/Dockerfile</code></td>\n<td>8082</td>\n<td>8082</td>\n<td>Click ingestion + stats</td>\n</tr>\n<tr>\n<td><code>user-service</code></td>\n<td>built from <code>services/user-service/Dockerfile</code></td>\n<td>8083</td>\n<td>8083</td>\n<td>Auth</td>\n</tr>\n<tr>\n<td><code>notification-service</code></td>\n<td>built from <code>services/notification-service/Dockerfile</code></td>\n<td>8084</td>\n<td>8084</td>\n<td>Alerts</td>\n</tr>\n<tr>\n<td><code>gateway</code></td>\n<td>built from <code>gateway/Dockerfile</code></td>\n<td>8080</td>\n<td>8080</td>\n<td>Single entry point</td>\n</tr>\n<tr>\n<td><code>url_db</code></td>\n<td><code>postgres:16-alpine</code></td>\n<td>5432</td>\n<td>5432</td>\n<td>url-service DB</td>\n</tr>\n<tr>\n<td><code>analytics_db</code></td>\n<td><code>postgres:16-alpine</code></td>\n<td>5432</td>\n<td>5433</td>\n<td>analytics-service DB</td>\n</tr>\n<tr>\n<td><code>user_db</code></td>\n<td><code>postgres:16-alpine</code></td>\n<td>5432</td>\n<td>5434</td>\n<td>user-service DB</td>\n</tr>\n<tr>\n<td><code>notification_db</code></td>\n<td><code>postgres:16-alpine</code></td>\n<td>5432</td>\n<td>5435</td>\n<td>notification-service DB</td>\n</tr>\n<tr>\n<td><code>rabbitmq</code></td>\n<td><code>rabbitmq:3.13-management-alpine</code></td>\n<td>5672 / 15672</td>\n<td>5672 / 15672</td>\n<td>Message broker</td>\n</tr>\n<tr>\n<td><code>redis</code></td>\n<td><code>redis:7-alpine</code></td>\n<td>6379</td>\n<td>6379</td>\n<td>Shared cache + rate limit store</td>\n</tr>\n<tr>\n<td><strong>Total: 11 containers.</strong></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"62-docker-composeyml-complete-annotated\">6.2 docker-compose.yml (complete, annotated)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">yaml</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># docker-compose.yml</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Run: docker compose up --build</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Tear down: docker compose down -v</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">url-shortener</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">x-postgres-base</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">postgres-base</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  image</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">postgres:16-alpine</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  restart</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">unless-stopped</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    POSTGRES_PASSWORD</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">secret</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">x-app-base</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">app-base</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  restart</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">unless-stopped</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    - </span><span style=\"color:#9ECBFF\">backend</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  backend</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    driver</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">bridge</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  url_db_data</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  analytics_db_data</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  user_db_data</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  notification_db_data</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  rabbitmq_data</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  redis_data</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">services</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  # ── Databases ──────────────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  url_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    &#x3C;&#x3C;</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">postgres-base</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    container_name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">url_db</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_DB</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">url_db</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_USER</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">url_user</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_PASSWORD</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">url_secret</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"5432:5432\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url_db_data:/var/lib/postgresql/data</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">backend</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"pg_isready -U url_user -d url_db\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  analytics_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    &#x3C;&#x3C;</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">postgres-base</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    container_name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">analytics_db</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_DB</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">analytics_db</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_USER</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">analytics_user</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_PASSWORD</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">analytics_secret</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"5433:5432\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">analytics_db_data:/var/lib/postgresql/data</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">backend</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"pg_isready -U analytics_user -d analytics_db\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  user_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    &#x3C;&#x3C;</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">postgres-base</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    container_name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">user_db</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_DB</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">user_db</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_USER</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">user_user</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_PASSWORD</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">user_secret</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"5434:5432\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">user_db_data:/var/lib/postgresql/data</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">backend</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"pg_isready -U user_user -d user_db\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  notification_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    &#x3C;&#x3C;</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">postgres-base</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    container_name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">notification_db</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_DB</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">notification_db</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_USER</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">notification_user</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_PASSWORD</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">notification_secret</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"5435:5432\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">notification_db_data:/var/lib/postgresql/data</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">backend</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"pg_isready -U notification_user -d notification_db\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  # ── Message Broker ──────────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  rabbitmq</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    image</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">rabbitmq:3.13-management-alpine</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    container_name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">rabbitmq</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"5672:5672\"</span><span style=\"color:#6A737D\">     # AMQP</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"15672:15672\"</span><span style=\"color:#6A737D\">   # Management UI (admin/admin)</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">rabbitmq_data:/var/lib/rabbitmq</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      RABBITMQ_DEFAULT_USER</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">admin</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      RABBITMQ_DEFAULT_PASS</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">admin</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">backend</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"rabbitmq-diagnostics\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"ping\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">30s</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  # ── Cache ───────────────────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  redis</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    image</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">redis:7-alpine</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    container_name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">redis</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"6379:6379\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">redis_data:/data</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">backend</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    command</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">redis-server --appendonly yes</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"redis-cli\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"ping\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">3s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  # ── Application Services ────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  url-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    &#x3C;&#x3C;</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">app-base</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    container_name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">url-service</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    build</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      context</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">./services/url-service</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      dockerfile</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Dockerfile</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"8081:8081\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8081\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      DATABASE_DSN</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"postgres://url_user:url_secret@url_db:5432/url_db?sslmode=disable\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      REDIS_ADDR</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"redis:6379\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      RABBITMQ_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"amqp://admin:admin@rabbitmq:5672/\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      SERVICE_NAME</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"url-service\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    depends_on</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      url_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      redis</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      rabbitmq</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"wget -qO- http://localhost:8081/health || exit 1\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">5</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">15s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  analytics-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    &#x3C;&#x3C;</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">app-base</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    container_name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">analytics-service</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    build</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      context</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">./services/analytics-service</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      dockerfile</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Dockerfile</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"8082:8082\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8082\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      DATABASE_DSN</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"postgres://analytics_user:analytics_secret@analytics_db:5432/analytics_db?sslmode=disable\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      RABBITMQ_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"amqp://admin:admin@rabbitmq:5672/\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      SERVICE_NAME</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"analytics-service\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    depends_on</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      analytics_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      rabbitmq</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"wget -qO- http://localhost:8082/health || exit 1\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">5</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">15s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  user-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    &#x3C;&#x3C;</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">app-base</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    container_name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">user-service</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    build</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      context</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">./services/user-service</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      dockerfile</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Dockerfile</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"8083:8083\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8083\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      DATABASE_DSN</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"postgres://user_user:user_secret@user_db:5432/user_db?sslmode=disable\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      RABBITMQ_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"amqp://admin:admin@rabbitmq:5672/\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      SERVICE_NAME</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"user-service\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    depends_on</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      user_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      rabbitmq</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"wget -qO- http://localhost:8083/health || exit 1\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">5</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">15s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  notification-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    &#x3C;&#x3C;</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">app-base</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    container_name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">notification-service</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    build</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      context</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">./services/notification-service</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      dockerfile</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Dockerfile</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"8084:8084\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8084\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      DATABASE_DSN</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"postgres://notification_user:notification_secret@notification_db:5432/notification_db?sslmode=disable\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      RABBITMQ_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"amqp://admin:admin@rabbitmq:5672/\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      SERVICE_NAME</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"notification-service\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    depends_on</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      notification_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      rabbitmq</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"wget -qO- http://localhost:8084/health || exit 1\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">5</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">15s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  gateway</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    &#x3C;&#x3C;</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">app-base</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    container_name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">gateway</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    build</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      context</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">./gateway</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      dockerfile</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Dockerfile</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"8080:8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      SERVICE_NAME</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"gateway\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      URL_SERVICE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"http://url-service:8081\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      ANALYTICS_SERVICE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"http://analytics-service:8082\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      USER_SERVICE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"http://user-service:8083\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      NOTIFICATION_SERVICE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"http://notification-service:8084\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      REDIS_ADDR</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"redis:6379\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    depends_on</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      url-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      analytics-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      user-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      notification-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"wget -qO- http://localhost:8080/health || exit 1\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">5</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">20s</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-4.svg\" alt=\"Domain Event Struct Memory Layout\"></p>\n<hr>\n<h2 id=\"7-go-module-declarations\">7. Go Module Declarations</h2>\n<p>Each service has its own <code>go.mod</code>. The module path prefix is <code>github.com/yourhandle/url-shortener</code>.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code># services/url-service/go.mod\nmodule github.com/yourhandle/url-shortener/url-service\ngo 1.23\nrequire (\n    github.com/jackc/pgx/v5 v5.6.0\n    github.com/redis/go-redis/v9 v9.5.1\n    github.com/rabbitmq/amqp091-go v1.10.0\n    github.com/rs/zerolog v1.33.0\n    github.com/yourhandle/url-shortener/shared v0.0.0\n)\nreplace github.com/yourhandle/url-shortener/shared =&gt; ../../shared</code></pre></div>\n<p>Identical <code>require</code> blocks (adjusting the replace path) for <code>analytics-service</code>, <code>user-service</code>, <code>notification-service</code>, and <code>gateway</code>. The <code>shared</code> module:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code># shared/go.mod\nmodule github.com/yourhandle/url-shortener/shared\ngo 1.23\nrequire (\n    github.com/rs/zerolog v1.33.0\n)</code></pre></div>\n<h2 id=\"important-use-replace-directives-in-each-service39s-gomod-to-reference-the-local-shared-module-this-avoids-publishing-to-a-registry-during-development-after-adding-the-replace-directive-run-go-mod-tidy-in-each-service-directory\"><strong>Important:</strong> Use <code>replace</code> directives in each service&#39;s <code>go.mod</code> to reference the local <code>shared</code> module. This avoids publishing to a registry during development. After adding the replace directive, run <code>go mod tidy</code> in each service directory.</h2>\n<h2 id=\"8-dockerfile-specification\">8. Dockerfile Specification</h2>\n<p>All five Dockerfiles are identical in structure. One canonical example:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">dockerfile</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># services/url-service/Dockerfile</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Stage 1: Build</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> golang:1.23-alpine </span><span style=\"color:#F97583\">AS</span><span style=\"color:#E1E4E8\"> builder</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Install wget for healthcheck probe (not in the final image — it uses wget from Alpine)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">RUN</span><span style=\"color:#E1E4E8\"> apk add --no-cache git</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WORKDIR</span><span style=\"color:#E1E4E8\"> /app</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Copy go.mod and go.sum first for layer caching</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COPY</span><span style=\"color:#E1E4E8\"> go.mod go.sum ./</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Copy shared module source (referenced via replace directive)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COPY</span><span style=\"color:#E1E4E8\"> ../../shared /shared</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">RUN</span><span style=\"color:#E1E4E8\"> go mod download</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COPY</span><span style=\"color:#E1E4E8\"> . .</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">RUN</span><span style=\"color:#E1E4E8\"> CGO_ENABLED=0 GOOS=linux go build -trimpath -o /bin/service ./...</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Stage 2: Runtime</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> alpine:3.20</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">RUN</span><span style=\"color:#E1E4E8\"> apk add --no-cache wget ca-certificates tzdata</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WORKDIR</span><span style=\"color:#E1E4E8\"> /app</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COPY</span><span style=\"color:#E1E4E8\"> --from=builder /bin/service /app/service</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">EXPOSE</span><span style=\"color:#E1E4E8\"> 8081</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">ENTRYPOINT</span><span style=\"color:#E1E4E8\"> [</span><span style=\"color:#9ECBFF\">\"/app/service\"</span><span style=\"color:#E1E4E8\">]</span></span></code></pre></div>\n<p><strong>Build context note:</strong> Because each service&#39;s Dockerfile needs access to the <code>shared</code> directory (one level up from the service root), the <code>docker-compose.yml</code> sets <code>context</code> to the service directory. Use a <code>.dockerignore</code> that excludes nothing needed, or structure the Dockerfile COPY to handle the parent reference. An alternative that avoids context issues:\nSet <code>context: .</code> (repo root) and <code>dockerfile: services/url-service/Dockerfile</code> in <code>docker-compose.yml</code>. Then COPY paths are relative to the repo root:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">dockerfile</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Alternate approach with context=. (repo root) in docker-compose</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COPY</span><span style=\"color:#E1E4E8\"> services/url-service/go.mod services/url-service/go.sum ./</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COPY</span><span style=\"color:#E1E4E8\"> shared/ /shared/</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COPY</span><span style=\"color:#E1E4E8\"> services/url-service/ .</span></span></code></pre></div>\n<p><strong>Choose one approach and apply consistently.</strong> The repo-root context approach is simpler for multi-module monorepos and is the recommended path.</p>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-5.svg\" alt=\"Service Startup Sequence (Happy Path)\"></p>\n<hr>\n<h2 id=\"9-environment-variable-reference\">9. Environment Variable Reference</h2>\n<table>\n<thead>\n<tr>\n<th>Variable</th>\n<th>Used By</th>\n<th>Required</th>\n<th>Default</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>PORT</code></td>\n<td>all</td>\n<td>yes</td>\n<td>—</td>\n<td>HTTP listen port</td>\n</tr>\n<tr>\n<td><code>SERVICE_NAME</code></td>\n<td>all</td>\n<td>yes</td>\n<td>—</td>\n<td>Embedded in logs</td>\n</tr>\n<tr>\n<td><code>DATABASE_DSN</code></td>\n<td>all app services</td>\n<td>yes</td>\n<td>—</td>\n<td>Full PostgreSQL DSN</td>\n</tr>\n<tr>\n<td><code>REDIS_ADDR</code></td>\n<td>url-service, gateway</td>\n<td>yes</td>\n<td>—</td>\n<td><code>host:port</code></td>\n</tr>\n<tr>\n<td><code>RABBITMQ_URL</code></td>\n<td>all app services</td>\n<td>yes</td>\n<td>—</td>\n<td>AMQP URL</td>\n</tr>\n<tr>\n<td><code>URL_SERVICE_URL</code></td>\n<td>gateway</td>\n<td>yes</td>\n<td>—</td>\n<td>Downstream base URL</td>\n</tr>\n<tr>\n<td><code>ANALYTICS_SERVICE_URL</code></td>\n<td>gateway</td>\n<td>yes</td>\n<td>—</td>\n<td>Downstream base URL</td>\n</tr>\n<tr>\n<td><code>USER_SERVICE_URL</code></td>\n<td>gateway</td>\n<td>yes</td>\n<td>—</td>\n<td>Downstream base URL</td>\n</tr>\n<tr>\n<td><code>NOTIFICATION_SERVICE_URL</code></td>\n<td>gateway</td>\n<td>yes</td>\n<td>—</td>\n<td>Downstream base URL</td>\n</tr>\n<tr>\n<td><code>JWT_SECRET</code></td>\n<td>user-service, all (M2+)</td>\n<td>no in M1</td>\n<td>—</td>\n<td>Added in M2</td>\n</tr>\n<tr>\n<td><strong>Parsing pattern</strong> (applied in each service&#39;s <code>main.go</code>):</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> mustGetEnv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">key</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    v </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(key)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> v </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        fmt.</span><span style=\"color:#B392F0\">Fprintf</span><span style=\"color:#E1E4E8\">(os.Stderr, </span><span style=\"color:#9ECBFF\">\"FATAL: required environment variable </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> is not set</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, key)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        os.</span><span style=\"color:#B392F0\">Exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> v</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h2 id=\"call-mustgetenv-for-every-required-variable-before-any-io-this-guarantees-a-clean-failure-message-rather-than-a-nil-pointer-panic-deep-in-a-library\">Call <code>mustGetEnv</code> for every required variable before any I/O. This guarantees a clean failure message rather than a nil-pointer panic deep in a library.</h2>\n<h2 id=\"10-error-handling-matrix\">10. Error Handling Matrix</h2>\n<table>\n<thead>\n<tr>\n<th>Error</th>\n<th>Detection Point</th>\n<th>Severity</th>\n<th>Recovery</th>\n<th>User-Visible Effect</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>DB_UNREACHABLE</code></td>\n<td><code>ConnectDB</code> after 5 retry attempts</td>\n<td><strong>Fatal</strong></td>\n<td><code>log.Fatal</code> + <code>os.Exit(1)</code></td>\n<td>Container exits; Docker healthcheck fails; depends_on prevents downstream startup</td>\n</tr>\n<tr>\n<td><code>REDIS_UNREACHABLE</code></td>\n<td><code>ConnectRedis</code> single PING attempt</td>\n<td>Warning</td>\n<td>Log warning, set client to nil, continue</td>\n<td>url-service starts without cache; all cache calls no-op</td>\n</tr>\n<tr>\n<td><code>RABBITMQ_UNREACHABLE</code></td>\n<td><code>ConnectRabbitMQ</code> after 5 retry attempts</td>\n<td>Warning</td>\n<td>Log warning, start background retry goroutine</td>\n<td>Service starts; exchange/queue not yet declared; no messages published/consumed until reconnect</td>\n</tr>\n<tr>\n<td><code>REQUIRED_ENV_MISSING</code></td>\n<td><code>mustGetEnv</code></td>\n<td>Fatal</td>\n<td><code>os.Exit(1)</code></td>\n<td>Container exits immediately with clear message</td>\n</tr>\n<tr>\n<td><code>DSN_CREDENTIALS_IN_LOG</code></td>\n<td><code>ConnectDB</code> logging</td>\n<td>N/A</td>\n<td>Strip credentials from DSN before logging</td>\n<td>Never log passwords</td>\n</tr>\n<tr>\n<td><code>HEALTHCHECK_DOWNSTREAM_FAIL</code></td>\n<td>Gateway startup loop</td>\n<td>Warning</td>\n<td>Log degraded state, continue</td>\n<td>Gateway starts; circuit breaker (M5) handles runtime failures</td>\n</tr>\n<tr>\n<td><code>PORT_BIND_FAIL</code></td>\n<td><code>server.ListenAndServe</code></td>\n<td>Fatal</td>\n<td><code>log.Fatal</code></td>\n<td>Container exits; Docker restart policy applies</td>\n</tr>\n<tr>\n<td><strong>DSN credential stripping:</strong></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// extractHost parses a DSN URL and returns only scheme+host+dbname for logging.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Input:  \"postgres://url_user:url_secret@url_db:5432/url_db?sslmode=disable\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Output: \"postgres://url_db:5432/url_db\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> extractHost</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">dsn</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    u, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> url.</span><span style=\"color:#B392F0\">Parse</span><span style=\"color:#E1E4E8\">(dsn)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#9ECBFF\"> \"&#x3C;unparseable DSN>\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    u.User </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#6A737D\"> // strip username and password</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    u.RawQuery </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#6A737D\"> // strip query params (may contain passwords)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> u.</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-6.svg\" alt=\"pgxpool Connection State Machine\"></p>\n<hr>\n<h2 id=\"11-rabbitmq-topology-specification\">11. RabbitMQ Topology Specification</h2>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-7.svg\" alt=\"Shared Domain Event Data Flow\"></p>\n<h3 id=\"exchange\">Exchange</h3>\n<table>\n<thead>\n<tr>\n<th>Property</th>\n<th>Value</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Name</td>\n<td><code>url-shortener</code></td>\n</tr>\n<tr>\n<td>Type</td>\n<td><code>topic</code></td>\n</tr>\n<tr>\n<td>Durable</td>\n<td><code>true</code></td>\n</tr>\n<tr>\n<td>Auto-delete</td>\n<td><code>false</code></td>\n</tr>\n<tr>\n<td>Internal</td>\n<td><code>false</code></td>\n</tr>\n</tbody></table>\n<h3 id=\"queues\">Queues</h3>\n<table>\n<thead>\n<tr>\n<th>Queue</th>\n<th>Durable</th>\n<th>Exclusive</th>\n<th>Auto-delete</th>\n<th>Declared by</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>analytics.clicks</code></td>\n<td>true</td>\n<td>false</td>\n<td>false</td>\n<td>analytics-service</td>\n</tr>\n<tr>\n<td><code>notifications.events</code></td>\n<td>true</td>\n<td>false</td>\n<td>false</td>\n<td>notification-service</td>\n</tr>\n</tbody></table>\n<h3 id=\"bindings\">Bindings</h3>\n<table>\n<thead>\n<tr>\n<th>Queue</th>\n<th>Exchange</th>\n<th>Routing Key</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>analytics.clicks</code></td>\n<td><code>url-shortener</code></td>\n<td><code>url.clicked</code></td>\n<td>Click events → analytics</td>\n</tr>\n<tr>\n<td><code>notifications.events</code></td>\n<td><code>url-shortener</code></td>\n<td><code>url.created</code></td>\n<td>New URL notification</td>\n</tr>\n<tr>\n<td><code>notifications.events</code></td>\n<td><code>url-shortener</code></td>\n<td><code>url.deleted</code></td>\n<td>Deleted URL notification</td>\n</tr>\n<tr>\n<td><code>notifications.events</code></td>\n<td><code>url-shortener</code></td>\n<td><code>milestone.reached</code></td>\n<td>Milestone notification</td>\n</tr>\n<tr>\n<td><strong>Idempotent declaration:</strong> AMQP <code>ExchangeDeclare</code> and <code>QueueDeclare</code> are idempotent if called with the same parameters. If a service restarts and redeclares, the broker accepts it silently. If parameters differ, the broker returns a channel-level error — ensure parameters are identical across all restart scenarios.</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td><strong>Startup order guarantee:</strong> <code>url-service</code> declares the exchange. <code>analytics-service</code> and <code>notification-service</code> declare their queues and bindings. Both consumers must succeed in <code>QueueBind</code> before the exchange exists — this is handled by the RabbitMQ <code>depends_on: rabbitmq: condition: service_healthy</code> in docker-compose. The exchange is declared when url-service starts (which also waits on rabbitmq healthy). However, to be fully safe, each consumer&#39;s <code>declareFunc</code> should also call <code>ExchangeDeclare</code> — AMQP declare is idempotent and this removes the startup ordering dependency between app services.</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"12-implementation-sequence-with-checkpoints\">12. Implementation Sequence with Checkpoints</h2>\n<h3 id=\"phase-1-monorepo-scaffold-gomod-051-hr\">Phase 1 — Monorepo Scaffold + go.mod (0.5–1 hr)</h3>\n<ol>\n<li>Create the directory tree from § 2.</li>\n<li>Write <code>go.mod</code> for <code>shared/</code> first.</li>\n<li>Write <code>go.mod</code> for each service with the <code>replace</code> directive.</li>\n<li>Create empty <code>main.go</code> stubs (<code>package main\\nfunc main() {}</code>) in each service.</li>\n<li>Run <code>go mod tidy</code> in <code>shared/</code>, then in each service directory.\n<strong>Checkpoint:</strong> <code>go build ./...</code> succeeds in every service directory with no errors. No business logic yet — just valid Go modules that compile.</li>\n</ol>\n<h3 id=\"phase-2-sharedevents-sharedlogger-051-hr\">Phase 2 — shared/events/ + shared/logger/ (0.5–1 hr)</h3>\n<ol>\n<li>Write <code>shared/events/events.go</code> (§ 3.1 — all four event structs + constants).</li>\n<li>Write <code>shared/logger/logger.go</code> (§ 4.1).</li>\n<li>Run <code>go test ./...</code> in <code>shared/</code> — no test files yet, but must compile clean.</li>\n<li>In each service, add <code>import _ &quot;github.com/yourhandle/url-shortener/shared/events&quot;</code> temporarily to verify the replace directive works.\n<strong>Checkpoint:</strong> <code>go build ./...</code> in every service compiles without error. <code>shared/events</code> types are importable.</li>\n</ol>\n<h3 id=\"phase-3-docker-composeyml-115-hr\">Phase 3 — docker-compose.yml (1–1.5 hr)</h3>\n<ol>\n<li>Write <code>docker-compose.yml</code> from § 6.2.</li>\n<li>Write <code>.env.example</code> documenting all variables from § 9.</li>\n<li>Write <code>Dockerfile</code> for each service (§ 8) — they are all identical except port numbers.</li>\n<li>Run <code>docker compose config</code> — must produce no YAML errors.</li>\n<li>Run <code>docker compose up rabbitmq redis url_db analytics_db user_db notification_db</code> (infra only).\n<strong>Checkpoint:</strong> All six infrastructure containers reach <code>healthy</code> state within 60 seconds. Verify with <code>docker compose ps</code> — every status column reads <code>healthy</code>. RabbitMQ management UI accessible at <code>http://localhost:15672</code> (admin/admin).</li>\n</ol>\n<h3 id=\"phase-4-db-redis-rabbitmq-bootstrapping-115-hr\">Phase 4 — DB + Redis + RabbitMQ Bootstrapping (1–1.5 hr)</h3>\n<ol>\n<li>Write <code>ConnectDB</code>, <code>ConnectRedis</code>, <code>ConnectRabbitMQ</code> in each service&#39;s <code>main.go</code> (or a shared <code>infra/</code> sub-package within each service).</li>\n<li>Write <code>mustGetEnv</code> and parse all required environment variables.</li>\n<li>Implement startup procedure from § 5.1 in each <code>main.go</code>.</li>\n<li>Implement service-specific <code>declareFunc</code> for each service (§ 4.5).</li>\n<li>Run <code>docker compose up --build</code> (all services).\n<strong>Checkpoint:</strong> <code>docker compose logs url-service | grep &quot;connected to DB&quot;</code> prints the success message. <code>docker compose logs url-service | grep &quot;connected to Redis cache&quot;</code> prints success. RabbitMQ management UI at <code>http://localhost:15672</code> → Exchanges tab shows <code>url-shortener</code> (topic, durable). Queues tab shows <code>analytics.clicks</code> and <code>notifications.events</code> with correct bindings.</li>\n</ol>\n<h3 id=\"phase-5-health-handlers-gateway-startup-check-051-hr\">Phase 5 — /health Handlers + Gateway Startup Check (0.5–1 hr)</h3>\n<ol>\n<li>Write <code>handler.NewHealthHandler</code> in each service&#39;s <code>handler/health.go</code>.</li>\n<li>Register the handler in each service&#39;s <code>main.go</code>.</li>\n<li>Write gateway&#39;s startup health-check loop (§ 5.2).</li>\n<li>Write README with setup commands.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8081/health</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> python3</span><span style=\"color:#79B8FF\"> -m</span><span style=\"color:#9ECBFF\"> json.tool</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"status\": \"ok\", \"service\": \"url-service\"}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8082/health</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"status\":\"ok\",\"service\":\"analytics-service\"}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8083/health</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"status\":\"ok\",\"service\":\"user-service\"}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8084/health</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"status\":\"ok\",\"service\":\"notification-service\"}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8080/health</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"status\":\"ok\",\"service\":\"gateway\"}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> ps</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># All 11 containers: Status = \"healthy\"</span></span></code></pre></div>\n<hr>\n<h2 id=\"13-test-specification\">13. Test Specification</h2>\n<h3 id=\"131-sharedevents-package-tests\">13.1 shared/events Package Tests</h3>\n<p><strong>File:</strong> <code>shared/events/events_test.go</code></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Test: JSON round-trip for each event struct</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Happy path: marshal URLClickedEvent → unmarshal → fields match</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Edge case: ExpiresAt = nil in URLCreatedEvent → JSON contains no \"expires_at\" key</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Edge case: OccurredAt preserves nanosecond precision through JSON round-trip</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify: GetEventType() returns the correct constant for each struct</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify: EventType constants match expected routing key strings exactly</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestEventJSONRoundTrip</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestNilExpiresAtOmittedFromJSON</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGetEventTypeReturnsCorrectConstant</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"132-connectdb-tests-integration-requires-docker\">13.2 ConnectDB Tests (integration, requires Docker)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Happy path: valid DSN → pool returned, pool.Ping() succeeds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Failure: invalid host → all 5 retries exhausted → error returned</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify: pool has MaxConns=10, MinConns=2 (inspect config after Connect)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify: error message contains \"failed after 5 attempts\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestConnectDB_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)          </span><span style=\"color:#6A737D\">// requires url_db running</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestConnectDB_UnreachableHost</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)     </span><span style=\"color:#6A737D\">// use port 9999 (guaranteed unreachable)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestConnectDB_PoolConfig</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"133-connectredis-tests\">13.3 ConnectRedis Tests</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Happy path: valid addr → client returned, err == nil</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Failure: unreachable addr → err != nil, returned client == nil</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify: function does NOT panic on PING failure</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestConnectRedis_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)        </span><span style=\"color:#6A737D\">// requires redis running</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestConnectRedis_Unreachable_ReturnsNilClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"134-health-handler-tests\">13.4 Health Handler Tests</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Happy path: GET /health → 200, body = {\"status\":\"ok\",\"service\":\"url-service\"}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Content-Type header = \"application/json\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Response time &#x3C; 10ms (use testing.B for benchmark)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Any HTTP method → 200 (handler is method-agnostic in M1)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestHealthHandler_Returns200</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestHealthHandler_JSONBody</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestHealthHandler_ContentType</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkHealthHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"135-extracthost-tests\">13.5 extractHost Tests</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Input: \"postgres://user:pass@url_db:5432/url_db?sslmode=disable\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Expected: \"postgres://url_db:5432/url_db\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Input: unparseable string → \"&#x3C;unparseable DSN>\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify: no user info in output</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify: no query params in output</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestExtractHost_StripsCreds</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestExtractHost_UnparseableDSN</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"136-end-to-end-smoke-test-shell-script\">13.6 End-to-End Smoke Test (shell script)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">#!/bin/bash</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># test/smoke_m1.sh — run after `docker compose up --build`</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">set</span><span style=\"color:#79B8FF\"> -euo</span><span style=\"color:#9ECBFF\"> pipefail</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">BASE_URLS</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"http://localhost:8081\"</span><span style=\"color:#9ECBFF\"> \"http://localhost:8082\"</span><span style=\"color:#9ECBFF\"> \"http://localhost:8083\"</span><span style=\"color:#9ECBFF\"> \"http://localhost:8084\"</span><span style=\"color:#9ECBFF\"> \"http://localhost:8080\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">NAMES</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#9ECBFF\"> \"analytics-service\"</span><span style=\"color:#9ECBFF\"> \"user-service\"</span><span style=\"color:#9ECBFF\"> \"notification-service\"</span><span style=\"color:#9ECBFF\"> \"gateway\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">in</span><span style=\"color:#9ECBFF\"> \"${</span><span style=\"color:#F97583\">!</span><span style=\"color:#E1E4E8\">BASE_URLS</span><span style=\"color:#9ECBFF\">[</span><span style=\"color:#F97583\">@</span><span style=\"color:#9ECBFF\">]}\"</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RESPONSE</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -sf</span><span style=\"color:#9ECBFF\"> \"${</span><span style=\"color:#E1E4E8\">BASE_URLS</span><span style=\"color:#9ECBFF\">[</span><span style=\"color:#E1E4E8\">$i</span><span style=\"color:#9ECBFF\">]}/health\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EXPECTED</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"{</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">status</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">ok</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">,</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">service</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">${</span><span style=\"color:#E1E4E8\">NAMES</span><span style=\"color:#9ECBFF\">[</span><span style=\"color:#E1E4E8\">$i</span><span style=\"color:#9ECBFF\">]}</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">}\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> [ </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">$RESPONSE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> !=</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$EXPECTED</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\"> ]; </span><span style=\"color:#F97583\">then</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        echo</span><span style=\"color:#9ECBFF\"> \"FAIL: ${</span><span style=\"color:#E1E4E8\">NAMES</span><span style=\"color:#9ECBFF\">[</span><span style=\"color:#E1E4E8\">$i</span><span style=\"color:#9ECBFF\">]} returned: </span><span style=\"color:#E1E4E8\">$RESPONSE</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        exit</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    fi</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    echo</span><span style=\"color:#9ECBFF\"> \"PASS: ${</span><span style=\"color:#E1E4E8\">NAMES</span><span style=\"color:#9ECBFF\">[</span><span style=\"color:#E1E4E8\">$i</span><span style=\"color:#9ECBFF\">]}\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">done</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"All health checks passed.\"</span></span></code></pre></div>\n<hr>\n<h2 id=\"14-performance-targets\">14. Performance Targets</h2>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Target</th>\n<th>Measurement Method</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>GET /health</code> response time</td>\n<td>&lt; 10ms p99</td>\n<td><code>wrk -t2 -c10 -d10s http://localhost:8081/health</code> → <code>Latency 99%</code></td>\n</tr>\n<tr>\n<td><code>docker compose up</code> to all-healthy</td>\n<td>&lt; 60s</td>\n<td><code>time docker compose up --wait</code> on commodity hardware (4 core, 8GB RAM)</td>\n</tr>\n<tr>\n<td><code>ConnectDB</code> retry exhaustion time</td>\n<td>&lt; 25s (5 attempts × up to 5s each)</td>\n<td>integration test with fake DSN + <code>testing.Timer</code></td>\n</tr>\n<tr>\n<td><code>go build ./...</code> in each service</td>\n<td>&lt; 30s</td>\n<td>cold build on CI; warm build &lt; 5s</td>\n</tr>\n<tr>\n<td>Container image size (each service)</td>\n<td>&lt; 20MB</td>\n<td><code>docker image ls</code> after build (Alpine multi-stage)</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"15-anti-pattern-guard-rail-checklist\">15. Anti-Pattern Guard Rail Checklist</h2>\n<p>Before completing this milestone, verify none of the following are present:</p>\n<ul>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>No shared PostgreSQL container.</strong> Run <code>docker compose config | grep POSTGRES_DB | sort | uniq -c</code> — expect 4 unique DB names across 4 separate containers.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>No <code>localhost</code> in any connection string inside Docker.</strong> All hostnames in environment variables use Docker service names (<code>url_db</code>, <code>redis</code>, <code>rabbitmq</code>, etc.).</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Redis is not used as a primary store.</strong> No <code>SET</code> or <code>HSET</code> to Redis in <code>main.go</code> — only the connection bootstrap PING.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>RabbitMQ queue declarations are in consumers, not only in url-service.</strong> <code>analytics-service/main.go</code> declares <code>analytics.clicks</code>; <code>notification-service/main.go</code> declares <code>notifications.events</code>.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong><code>depends_on</code> uses <code>condition: service_healthy</code> for all DB and broker dependencies.</strong> Plain <code>depends_on: [url_db]</code> without a condition does not wait for readiness.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>No hardcoded passwords in Go source.</strong> All credentials come from <code>mustGetEnv</code>.</li>\n</ul>\n<hr>\n<!-- END_TDD_MOD -->\n\n\n<!-- TDD_MOD_ID: url-shortener-m2 -->\n<h1 id=\"technical-design-specification\">Technical Design Specification</h1>\n<h2 id=\"module-user-service-registration-login-jwt-issuance\">Module: User Service — Registration, Login, JWT Issuance</h2>\n<h2 id=\"module-id-url-shortener-m2\"><strong>Module ID:</strong> <code>url-shortener-m2</code></h2>\n<h2 id=\"1-module-charter\">1. Module Charter</h2>\n<p>The User Service is the single authority for identity within the URL shortener system. It accepts user registrations, validates credentials, stores password hashes, and issues signed JWT access tokens. It exposes exactly three HTTP endpoints: <code>POST /register</code>, <code>POST /login</code>, and <code>GET /me</code>. It owns one PostgreSQL table (<code>users</code>) in its private database and communicates with no other service — ever.\nThis module does <strong>not</strong> implement password reset, OAuth, refresh tokens, email verification, session storage, role-based access control, or any form of inter-service communication. It does not call the URL Service, Analytics Service, or Notification Service. The gateway and all other services verify tokens locally using the shared <code>JWT_SECRET</code> — they never proxy a verification request to the User Service.\n<strong>Upstream dependencies:</strong> M1 foundation (Docker Compose stack, <code>shared/logger</code> package, PostgreSQL <code>user_db</code> container). The <code>user_db</code> database must be reachable before this service starts.\n<strong>Downstream dependencies:</strong> The <code>shared/middleware</code> JWT verification package produced in Phase 4 of this module is imported by url-service (M3), analytics-service (M4), notification-service (M5), and the gateway (M5). The <code>JWT_SECRET</code> environment variable must be identical across all services that verify tokens.\n<strong>Invariants that must always hold after this milestone:</strong></p>\n<ul>\n<li>No plaintext password ever persists to disk or appears in any log line.</li>\n<li>A failed login returns exactly the same response body and HTTP status regardless of whether the email exists or the password is wrong.</li>\n<li>Token verification never makes a network call — it is pure HMAC-SHA256 computation against the in-process secret.</li>\n<li>The <code>users.email</code> column has a <code>UNIQUE NOT NULL</code> constraint enforced at the database level, not only at the application level.</li>\n<li><code>GET /me</code> response time is bounded by HMAC computation only, not by database latency.</li>\n</ul>\n<hr>\n<h2 id=\"2-file-structure\">2. File Structure</h2>\n<p>Create files in the numbered order below. All paths are relative to the monorepo root.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-shortener/\n│\n├── services/user-service/\n│   ├── 01  migrations/\n│   │   └── 02  001_create_users.sql\n│   ├── 03  repository/\n│   │   ├── 04  user_repository.go       # UserRepository interface + pgx implementation\n│   │   └── 05  user_repository_test.go\n│   ├── 06  auth/\n│   │   ├── 07  password.go              # PasswordHasher: bcrypt Hash + Compare\n│   │   ├── 08  password_test.go\n│   │   ├── 09  jwt.go                   # JWTSigner + JWTVerifier implementations\n│   │   └── 10  jwt_test.go\n│   ├── 11  handler/\n│   │   ├── 12  register.go              # POST /register\n│   │   ├── 13  login.go                 # POST /login\n│   │   ├── 14  me.go                    # GET /me\n│   │   ├── 15  health.go               # GET /health (from M1, updated)\n│   │   └── 16  handler_test.go          # integration tests (register→login→/me)\n│   ├── 17  service/\n│   │   └── 18  user_service.go          # UserService: orchestrates repo + auth\n│   └── 19  main.go                      # wiring: env, DB, routes, server\n│\n└── shared/\n    └── 20  middleware/\n        ├── 21  jwt_middleware.go         # http.Handler wrapper: Bearer extraction + verify\n        └── 22  jwt_middleware_test.go</code></pre></div>\n<h2 id=\"total-new-files-22-gosum-files-are-auto-generated-and-excluded-from-the-count\"><strong>Total new files: 22</strong> (<code>go.sum</code> files are auto-generated and excluded from the count).</h2>\n<h2 id=\"3-complete-data-model\">3. Complete Data Model</h2>\n<h3 id=\"31-postgresql-schema-migrations001_create_userssql\">3.1 PostgreSQL Schema (<code>migrations/001_create_users.sql</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- migrations/001_create_users.sql</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">BEGIN</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> users (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    id           UUID        </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    email        </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#F97583\"> UNIQUE</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    password_hash </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    created_at   </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Index for login: find user by email quickly.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- UNIQUE already implies a B-tree index; this is explicit documentation.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- The UNIQUE constraint on email is enforced by the database, not application code.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> UNIQUE INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_users_email </span><span style=\"color:#F97583\">ON</span><span style=\"color:#E1E4E8\"> users(email);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COMMIT</span><span style=\"color:#E1E4E8\">;</span></span></code></pre></div>\n<p><strong>Field rationale:</strong></p>\n<ul>\n<li><code>id UUID</code>: UUIDs are non-enumerable. An integer PK would leak user count via <code>user_id=42</code>. <code>gen_random_uuid()</code> requires <code>pgcrypto</code> on PostgreSQL &lt; 14; on PostgreSQL 16 (as declared in docker-compose) it is a built-in function.</li>\n<li><code>email TEXT NOT NULL UNIQUE</code>: Application-level uniqueness checks are racey; the constraint is the true guard. <code>TEXT</code> is used over <code>VARCHAR(255)</code> because PostgreSQL stores both identically; <code>TEXT</code> removes an arbitrary limit.</li>\n<li><code>password_hash TEXT NOT NULL</code>: bcrypt output is always 60 characters of ASCII. <code>TEXT</code> is correct; never use <code>BYTEA</code> for bcrypt strings.</li>\n<li><code>created_at TIMESTAMPTZ NOT NULL DEFAULT now()</code>: <code>TIMESTAMPTZ</code> stores UTC internally and is unambiguous across timezone changes. Application never writes this field.</li>\n</ul>\n<h3 id=\"32-go-structs\">3.2 Go Structs</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/user_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> repository</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// User is the domain entity stored in the users table.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// It is the single source of truth for user identity within this service.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Password hashes are stored here; plaintext passwords never reach this struct.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> User</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID           </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // UUID v4, primary key</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email        </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // unique, lowercase-normalized before storage</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    PasswordHash </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // bcrypt output, cost=12; never logged</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt    </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // set by DB DEFAULT; application does not write this</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// UserRepository defines the persistence contract for the User entity.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Implementations must be safe for concurrent use.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> UserRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Create inserts a new user. Returns ErrDuplicateEmail if the email</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // already exists. All other DB errors are returned as-is for the</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // service layer to wrap.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Create</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">u</span><span style=\"color:#B392F0\"> User</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // FindByEmail retrieves a user by email address.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns ErrUserNotFound if no row matches.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    FindByEmail</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">email</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Sentinel errors returned by UserRepository.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Service layer maps these to HTTP status codes.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrDuplicateEmail </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"email already registered\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrUserNotFound   </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"user not found\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// auth/jwt.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> auth</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Claims is the set of fields embedded in a JWT payload.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Only these fields are read on verification; any extra fields are ignored.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Claims</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Sub   </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // user_id UUID string — \"subject\" per RFC 7519</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // user email; embedded to avoid /me needing a DB call</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Iat   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // issued at</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Exp   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // expiry; 24h after Iat</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Iss   </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // always \"url-shortener\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// jwtPayload is the raw JSON-mapped representation used for marshaling.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Claims is the clean domain struct; jwtPayload handles the Unix timestamp encoding.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> jwtPayload</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Sub   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"sub\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"email\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Iat   </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">  `json:\"iat\"`</span><span style=\"color:#6A737D\"> // Unix seconds</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Exp   </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">  `json:\"exp\"`</span><span style=\"color:#6A737D\"> // Unix seconds</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Iss   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"iss\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handler/register.go — request/response DTOs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> handler</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RegisterRequest is the JSON body accepted by POST /register.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RegisterRequest</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"email\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Password </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"password\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RegisterResponse is the JSON body returned on 201 Created.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Password hash is never included. User ID is always a UUID string.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RegisterResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"user_id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email  </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"email\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// LoginRequest is the JSON body accepted by POST /login.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> LoginRequest</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"email\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Password </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"password\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// LoginResponse is the JSON body returned on 200 OK after successful login.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> LoginResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Token     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"token\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"expires_at\"`</span><span style=\"color:#6A737D\"> // RFC3339 format</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// MeResponse is the JSON body returned by GET /me.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> MeResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"user_id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email  </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"email\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ErrorResponse is the JSON body for all error responses.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ErrorResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Error </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"error\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"33-jwt-payload-wire-format\">3.3 JWT Payload Wire Format</h3>\n<p>The JWT is a standard three-part HS256 token: <code>base64url(header).base64url(payload).base64url(signature)</code>.\n<strong>Header (fixed):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">json</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">{</span><span style=\"color:#79B8FF\">\"alg\"</span><span style=\"color:#E1E4E8\">:</span><span style=\"color:#9ECBFF\">\"HS256\"</span><span style=\"color:#E1E4E8\">,</span><span style=\"color:#79B8FF\">\"typ\"</span><span style=\"color:#E1E4E8\">:</span><span style=\"color:#9ECBFF\">\"JWT\"</span><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>Payload (per token):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">json</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  \"sub\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"550e8400-e29b-41d4-a716-446655440000\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  \"email\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"alice@example.com\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  \"iat\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">1740873600</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  \"exp\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">1740960000</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  \"iss\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"url-shortener\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>Field constraints:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Constraint</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>sub</code></td>\n<td>string</td>\n<td>UUID v4 format; must match <code>users.id</code></td>\n</tr>\n<tr>\n<td><code>email</code></td>\n<td>string</td>\n<td>Must match <code>users.email</code> at time of issuance</td>\n</tr>\n<tr>\n<td><code>iat</code></td>\n<td>number</td>\n<td>Unix seconds; UTC</td>\n</tr>\n<tr>\n<td><code>exp</code></td>\n<td>number</td>\n<td><code>iat + 86400</code> (24 hours exactly)</td>\n</tr>\n<tr>\n<td><code>iss</code></td>\n<td>string</td>\n<td>Literal <code>&quot;url-shortener&quot;</code> — reject tokens with any other issuer</td>\n</tr>\n<tr>\n<td><strong>Implementation note:</strong> Do NOT use a JWT library that pulls in JOSE complexity (e.g., <code>golang-jwt/jwt</code> is acceptable; <code>lestrrat-go/jwx</code> is overkill). The recommended library is <code>golang-jwt/jwt/v5</code> which handles HMAC signing, payload marshaling, and expiry checking natively.</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-8.svg\" alt=\"User Service Module Architecture\"></p>\n<hr>\n<h2 id=\"4-interface-contracts\">4. Interface Contracts</h2>\n<h3 id=\"41-userrepository-pgxuserrepository-implementation\">4.1 <code>UserRepository</code> — <code>pgxUserRepository</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// NewPgxUserRepository constructs a UserRepository backed by a pgxpool.Pool.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// pool must be non-nil and already connected.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewPgxUserRepository</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">UserRepository</span></span></code></pre></div>\n<p><strong><code>Create(ctx context.Context, u User) error</code></strong></p>\n<ul>\n<li>Executes: <code>INSERT INTO users (id, email, password_hash) VALUES ($1, $2, $3)</code></li>\n<li><code>u.ID</code> must be a pre-generated UUID v4 string (caller generates, not DB gen_random_uuid — we want the ID before the INSERT for event publishing in later milestones).</li>\n<li><code>u.CreatedAt</code> is ignored; the DB sets it via DEFAULT.</li>\n<li>On <code>pgconn.PgError</code> with <code>Code == &quot;23505&quot;</code> (unique violation): returns <code>ErrDuplicateEmail</code>.</li>\n<li>On any other error: returns <code>fmt.Errorf(&quot;userRepository.Create: %w&quot;, err)</code>.</li>\n<li><strong>Never</strong> returns nil without the row existing in the database.\n<strong><code>FindByEmail(ctx context.Context, email string) (User, error)</code></strong></li>\n<li>Executes: <code>SELECT id, email, password_hash, created_at FROM users WHERE email = $1</code></li>\n<li>On <code>pgx.ErrNoRows</code>: returns <code>User{}, ErrUserNotFound</code>.</li>\n<li>On any other error: returns <code>User{}, fmt.Errorf(&quot;userRepository.FindByEmail: %w&quot;, err)</code>.</li>\n<li>Returns the fully populated <code>User</code> struct on success.</li>\n</ul>\n<h3 id=\"42-passwordhasher\">4.2 <code>PasswordHasher</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// auth/password.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// PasswordHasher wraps bcrypt operations.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// All implementations must be stateless and safe for concurrent use.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> PasswordHasher</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hash returns a bcrypt hash of plaintext at cost=12.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // plaintext must be non-empty; returns error if bcrypt fails.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // The returned string is always 60 ASCII characters.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Hash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">plaintext</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Compare returns nil if hash matches plaintext.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns ErrPasswordMismatch if they do not match.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns a wrapped error for any other bcrypt failure.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // This function takes ~100ms at cost=12 — do not call in goroutines</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // holding locks.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Compare</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">hash</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">plaintext</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// bcryptHasher is the production implementation.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> bcryptHasher</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewPasswordHasher returns the production bcrypt implementation.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewPasswordHasher</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">PasswordHasher</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#B392F0\"> bcryptHasher</span><span style=\"color:#E1E4E8\">{} }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ErrPasswordMismatch is returned by Compare when credentials do not match.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// It is intentionally distinct from bcrypt internal errors.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> ErrPasswordMismatch </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"password mismatch\"</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong><code>Hash</code> implementation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">b </span><span style=\"color:#B392F0\">bcryptHasher</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Hash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">plaintext</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    hash, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> bcrypt.</span><span style=\"color:#B392F0\">GenerateFromPassword</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(plaintext), </span><span style=\"color:#79B8FF\">12</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"passwordHasher.Hash: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">(hash), </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong><code>Compare</code> implementation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">b </span><span style=\"color:#B392F0\">bcryptHasher</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Compare</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">hash</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">plaintext</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> bcrypt.</span><span style=\"color:#B392F0\">CompareHashAndPassword</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(hash), []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(plaintext))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">Is</span><span style=\"color:#E1E4E8\">(err, bcrypt.ErrMismatchedHashAndPassword) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> ErrPasswordMismatch</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"passwordHasher.Compare: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"43-jwtsigner-and-jwtverifier\">4.3 <code>JWTSigner</code> and <code>JWTVerifier</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// auth/jwt.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// JWTSigner issues signed tokens.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> JWTSigner</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Sign creates an HS256 JWT from the given Claims.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // The Iat and Exp fields on the input Claims are set by Sign (caller need not set them).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns the compact serialized token string on success.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Sign</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">claims</span><span style=\"color:#B392F0\"> Claims</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#FFAB70\">tokenString</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// JWTVerifier validates tokens.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> JWTVerifier</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Verify parses and validates a compact JWT string.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns parsed Claims on success.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns ErrTokenExpired if exp is in the past.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns ErrTokenInvalid for any other validation failure</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //   (bad signature, wrong issuer, malformed).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Verify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">tokenString</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">Claims</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Sentinel errors for token verification.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrTokenExpired </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"token expired\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrTokenInvalid </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"token invalid\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewJWTSigner returns a JWTSigner using HS256 with the given secret.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// secret must be the raw bytes of JWT_SECRET from the environment.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Panics if secret is empty — misconfigured secrets must fail at startup, not runtime.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewJWTSigner</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">secret</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">JWTSigner</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewJWTVerifier returns a JWTVerifier using HS256 with the given secret.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// secret must be the raw bytes of JWT_SECRET from the environment.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Panics if secret is empty.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewJWTVerifier</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">secret</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">JWTVerifier</span></span></code></pre></div>\n<p><strong><code>Sign</code> implementation detail:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">jwtSigner</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Sign</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">claims</span><span style=\"color:#B392F0\"> Claims</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    now </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">UTC</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    payload </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> jwt</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">MapClaims</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"sub\"</span><span style=\"color:#E1E4E8\">:   claims.Sub,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"email\"</span><span style=\"color:#E1E4E8\">: claims.Email,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"iat\"</span><span style=\"color:#E1E4E8\">:   now.</span><span style=\"color:#B392F0\">Unix</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"exp\"</span><span style=\"color:#E1E4E8\">:   now.</span><span style=\"color:#B392F0\">Add</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">24</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Hour).</span><span style=\"color:#B392F0\">Unix</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"iss\"</span><span style=\"color:#E1E4E8\">:   </span><span style=\"color:#9ECBFF\">\"url-shortener\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    token </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> jwt.</span><span style=\"color:#B392F0\">NewWithClaims</span><span style=\"color:#E1E4E8\">(jwt.SigningMethodHS256, payload)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    signed, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> token.</span><span style=\"color:#B392F0\">SignedString</span><span style=\"color:#E1E4E8\">(s.secret)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"jwtSigner.Sign: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> signed, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong><code>Verify</code> implementation detail:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">v </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">jwtVerifier</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Verify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">tokenString</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">Claims</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    token, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> jwt.</span><span style=\"color:#B392F0\">Parse</span><span style=\"color:#E1E4E8\">(tokenString, </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">jwt</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Token</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">interface</span><span style=\"color:#E1E4E8\">{}, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> _, ok </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> t.Method.(</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">jwt</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">SigningMethodHMAC</span><span style=\"color:#E1E4E8\">); </span><span style=\"color:#F97583\">!</span><span style=\"color:#E1E4E8\">ok {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"unexpected signing method: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, t.Header[</span><span style=\"color:#9ECBFF\">\"alg\"</span><span style=\"color:#E1E4E8\">])</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> v.secret, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Distinguish expiry from other errors.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        var</span><span style=\"color:#E1E4E8\"> ve </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">jwt</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ValidationError</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">As</span><span style=\"color:#E1E4E8\">(err, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">ve) </span><span style=\"color:#F97583\">&#x26;&#x26;</span><span style=\"color:#E1E4E8\"> ve.Errors</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">jwt.ValidationErrorExpired </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> Claims</span><span style=\"color:#E1E4E8\">{}, ErrTokenExpired</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> Claims</span><span style=\"color:#E1E4E8\">{}, ErrTokenInvalid</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mc, ok </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> token.Claims.(</span><span style=\"color:#B392F0\">jwt</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">MapClaims</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">ok </span><span style=\"color:#F97583\">||</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">token.Valid {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> Claims</span><span style=\"color:#E1E4E8\">{}, ErrTokenInvalid</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Validate issuer explicitly — reject tokens issued by other systems.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> iss, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> mc[</span><span style=\"color:#9ECBFF\">\"iss\"</span><span style=\"color:#E1E4E8\">].(</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">); iss </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"url-shortener\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> Claims</span><span style=\"color:#E1E4E8\">{}, ErrTokenInvalid</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#B392F0\"> Claims</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Sub:   mc[</span><span style=\"color:#9ECBFF\">\"sub\"</span><span style=\"color:#E1E4E8\">].(</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Email: mc[</span><span style=\"color:#9ECBFF\">\"email\"</span><span style=\"color:#E1E4E8\">].(</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Exp:   time.</span><span style=\"color:#B392F0\">Unix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">(mc[</span><span style=\"color:#9ECBFF\">\"exp\"</span><span style=\"color:#E1E4E8\">].(</span><span style=\"color:#F97583\">float64</span><span style=\"color:#E1E4E8\">)), </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">).</span><span style=\"color:#B392F0\">UTC</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Iat:   time.</span><span style=\"color:#B392F0\">Unix</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">(mc[</span><span style=\"color:#9ECBFF\">\"iat\"</span><span style=\"color:#E1E4E8\">].(</span><span style=\"color:#F97583\">float64</span><span style=\"color:#E1E4E8\">)), </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">).</span><span style=\"color:#B392F0\">UTC</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Iss:   </span><span style=\"color:#9ECBFF\">\"url-shortener\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>Note on <code>golang-jwt/jwt/v5</code>:</strong> In v5 the <code>ValidationError</code> API changed. Use <code>errors.Is(err, jwt.ErrTokenExpired)</code> instead of the bitmask approach shown above (which is v4). The implementation must match the version declared in <code>go.mod</code>. The spec shows the v4 pattern; adapt as needed after pinning the version.</p>\n<h3 id=\"44-userservice\">4.4 <code>UserService</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// service/user_service.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// UserService orchestrates the repository, password hasher, and JWT signer.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// It owns all business logic for the auth domain.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// It must not reference http.Request or http.ResponseWriter — that belongs to handlers.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> UserService</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    repo    </span><span style=\"color:#B392F0\">repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">UserRepository</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    hasher  </span><span style=\"color:#B392F0\">auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">PasswordHasher</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    signer  </span><span style=\"color:#B392F0\">auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">JWTSigner</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log     </span><span style=\"color:#B392F0\">zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewUserService</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    repo</span><span style=\"color:#B392F0\"> repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">UserRepository</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    hasher</span><span style=\"color:#B392F0\"> auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">PasswordHasher</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    signer</span><span style=\"color:#B392F0\"> auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">JWTSigner</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">UserService</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Register creates a new user. Returns the created User (with ID and CreatedAt populated).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Error types:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   - repository.ErrDuplicateEmail → caller maps to 409</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   - validation error (invalid email, short password) → caller maps to 400</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   - any other error → caller maps to 500</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">UserService</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Register</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">email</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">password</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Login verifies credentials and returns a signed JWT string and expiry time.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Error types:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   - auth.ErrPasswordMismatch or repository.ErrUserNotFound → caller maps to 401</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//     (same error, no distinction — prevents email enumeration)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   - any other error → caller maps to 500</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">UserService</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Login</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">email</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">password</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#FFAB70\">token</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">expiresAt</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong><code>Register</code> logic:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE Register(ctx, email, password):\n  1. Normalize email: strings.ToLower(strings.TrimSpace(email))\n  2. Validate email: use net/mail.ParseAddress(email) — returns error on invalid format\n  3. Validate password length: len(password) &lt; 8 → return ErrValidation(&quot;password must be at least 8 characters&quot;)\n  4. Hash password: hash, err = hasher.Hash(password)\n     IF err != nil → return wrapped error (→ 500)\n  5. Generate user ID: id = uuid.New().String() — use google/uuid package\n  6. Construct User{ID: id, Email: email, PasswordHash: hash}\n  7. repo.Create(ctx, user)\n     IF ErrDuplicateEmail → return as-is (→ 409)\n     IF other error → return wrapped (→ 500)\n  8. Return the constructed User (CreatedAt will be zero; that is acceptable — caller only needs ID and email)\nEND PROCEDURE</code></pre></div>\n<p><strong><code>Login</code> logic:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE Login(ctx, email, password):\n  1. Normalize email: strings.ToLower(strings.TrimSpace(email))\n  2. user, err = repo.FindByEmail(ctx, email)\n     IF ErrUserNotFound → return &quot;&quot;, time.Time{}, ErrAuthFailed\n     IF other error → return wrapped (→ 500)\n  3. err = hasher.Compare(user.PasswordHash, password)\n     IF ErrPasswordMismatch → return &quot;&quot;, time.Time{}, ErrAuthFailed\n     IF other error → return wrapped (→ 500)\n  4. claims = auth.Claims{Sub: user.ID, Email: user.Email}\n  5. tokenStr, err = signer.Sign(claims)\n     IF err → return wrapped (→ 500)\n  6. expiresAt = time.Now().UTC().Add(24 * time.Hour)\n  7. Return tokenStr, expiresAt, nil\nEND PROCEDURE\n// ErrAuthFailed is the single sentinel for both &quot;email not found&quot; and &quot;wrong password&quot;.\n// It must never distinguish between the two cases.\nvar ErrAuthFailed = errors.New(&quot;invalid credentials&quot;)</code></pre></div>\n<p><strong>Why one sentinel for both failures:</strong> Returning different errors for &quot;email not found&quot; vs &quot;wrong password&quot; would allow an attacker to enumerate registered emails by observing the response. <code>ErrAuthFailed</code> collapses both into an identical 401 response.</p>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-9.svg\" alt=\"users Table Memory / Schema Layout\"></p>\n<h3 id=\"45-sharedmiddleware-jwt-middleware\">4.5 <code>shared/middleware</code> — JWT Middleware</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// shared/middleware/jwt_middleware.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> middleware</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// contextKey is an unexported type for context keys to avoid collisions.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> contextKey</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> ClaimsContextKey</span><span style=\"color:#B392F0\"> contextKey</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"jwt_claims\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RequireAuth returns an http.Handler that:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  1. Extracts the Bearer token from the Authorization header.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  2. Verifies the token using verifier.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  3. Stores the parsed Claims in the request context under ClaimsContextKey.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  4. Calls next if verification succeeds.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  5. Returns 401 with {\"error\":\"unauthorized\"} if token is missing, malformed, expired, or invalid.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// This middleware is designed to be imported by any service that needs to</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// validate JWTs issued by user-service. The verifier must be constructed</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// with the same JWT_SECRET used by user-service.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> RequireAuth</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">verifier</span><span style=\"color:#B392F0\"> auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">JWTVerifier</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ClaimsFromContext retrieves the verified Claims from a request context.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns zero-value Claims and false if not present.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Handlers call this after RequireAuth has run.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> ClaimsFromContext</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Claims</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong><code>RequireAuth</code> implementation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> RequireAuth</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">verifier</span><span style=\"color:#B392F0\"> auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">JWTVerifier</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">next</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            authHeader </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> r.Header.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Authorization\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> authHeader </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">strings.</span><span style=\"color:#B392F0\">HasPrefix</span><span style=\"color:#E1E4E8\">(authHeader, </span><span style=\"color:#9ECBFF\">\"Bearer \"</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                writeJSON</span><span style=\"color:#E1E4E8\">(w, http.StatusUnauthorized, </span><span style=\"color:#B392F0\">ErrorResponse</span><span style=\"color:#E1E4E8\">{Error: </span><span style=\"color:#9ECBFF\">\"unauthorized\"</span><span style=\"color:#E1E4E8\">})</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            tokenStr </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> strings.</span><span style=\"color:#B392F0\">TrimPrefix</span><span style=\"color:#E1E4E8\">(authHeader, </span><span style=\"color:#9ECBFF\">\"Bearer \"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            claims, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> verifier.</span><span style=\"color:#B392F0\">Verify</span><span style=\"color:#E1E4E8\">(tokenStr)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // Do NOT distinguish between expired and invalid in the response.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // Log the specific reason for debugging; return generic 401 to client.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                log.</span><span style=\"color:#B392F0\">Warn</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Err</span><span style=\"color:#E1E4E8\">(err).</span><span style=\"color:#B392F0\">Str</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"path\"</span><span style=\"color:#E1E4E8\">, r.URL.Path).</span><span style=\"color:#B392F0\">Msg</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"jwt verification failed\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                writeJSON</span><span style=\"color:#E1E4E8\">(w, http.StatusUnauthorized, </span><span style=\"color:#B392F0\">ErrorResponse</span><span style=\"color:#E1E4E8\">{Error: </span><span style=\"color:#9ECBFF\">\"unauthorized\"</span><span style=\"color:#E1E4E8\">})</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            ctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithValue</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">(), ClaimsContextKey, claims)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            next.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(w, r.</span><span style=\"color:#B392F0\">WithContext</span><span style=\"color:#E1E4E8\">(ctx))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>Edge cases:</strong></p>\n<ul>\n<li><code>Authorization: Bearer </code> (trailing space, empty token) → <code>Verify</code> will fail → 401.</li>\n<li><code>Authorization: bearer TOKEN</code> (lowercase) → <code>HasPrefix(&quot;Bearer &quot;)</code> fails → 401. The spec requires exact case.</li>\n<li>Multiple <code>Authorization</code> headers → <code>r.Header.Get</code> returns only the first value per Go&#39;s <code>net/http</code> semantics → safe.</li>\n</ul>\n<hr>\n<h2 id=\"5-algorithm-specification\">5. Algorithm Specification</h2>\n<h3 id=\"51-input-validation\">5.1 Input Validation</h3>\n<p><strong>Email validation:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE ValidateEmail(email string) error:\n  trimmed = strings.TrimSpace(email)\n  IF len(trimmed) == 0 → return validation error &quot;email is required&quot;\n  _, err = mail.ParseAddress(trimmed)\n  IF err != nil → return validation error &quot;email format is invalid&quot;\n  return nil\n// Note: mail.ParseAddress accepts &quot;Name &lt;email&gt;&quot; format.\n// To reject display names, check that the returned address equals the trimmed input.\n// Implementation: addr, err := mail.ParseAddress(trimmed); if addr.Address != trimmed → error</code></pre></div>\n<p><strong>Password validation:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE ValidatePassword(password string) error:\n  IF len(password) &lt; 8 → return validation error &quot;password must be at least 8 characters&quot;\n  // No other complexity rules per spec. No maximum length check is needed because\n  // bcrypt truncates input at 72 bytes internally — document this behavior but\n  // do not reject longer passwords (bcrypt handles it silently).\n  return nil</code></pre></div>\n<p><strong>Why <code>net/mail.ParseAddress</code> and not regex:</strong> RFC 5322 email syntax is not regular. The standard library&#39;s parser correctly handles quoted local parts, international domains (after IDNA encoding), and other edge cases that naive regexes reject or wrongly accept.</p>\n<h3 id=\"52-post-register-handler-flow\">5.2 POST /register Handler Flow</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE HandleRegister(w http.ResponseWriter, r *http.Request):\n  1. Decode JSON body into RegisterRequest.\n     IF body is empty or malformed JSON → 400 {&quot;error&quot;:&quot;invalid request body&quot;}\n     Limit body size: http.MaxBytesReader(w, r.Body, 1024) to prevent oversized payloads.\n  2. Validate email and password (§ 5.1).\n     IF invalid → 400 {&quot;error&quot;:&quot;&lt;specific validation message&gt;&quot;}\n  3. Call userService.Register(r.Context(), req.Email, req.Password).\n     IF ErrDuplicateEmail → 409 {&quot;error&quot;:&quot;email already registered&quot;}\n     IF ErrValidation → 400 {&quot;error&quot;:&quot;&lt;message&gt;&quot;}\n     IF other error → log.Error, return 500 {&quot;error&quot;:&quot;internal server error&quot;}\n  4. On success → 201 {&quot;user_id&quot;:&quot;&lt;uuid&gt;&quot;,&quot;email&quot;:&quot;&lt;email&gt;&quot;}\nEND PROCEDURE</code></pre></div>\n<h3 id=\"53-post-login-handler-flow\">5.3 POST /login Handler Flow</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE HandleLogin(w http.ResponseWriter, r *http.Request):\n  1. Decode JSON body into LoginRequest.\n     IF malformed → 400 {&quot;error&quot;:&quot;invalid request body&quot;}\n  2. No validation of email format or password length here —\n     invalid credentials simply fail the auth check, returning 401.\n     (Omitting validation prevents leaking &quot;this email format doesn't even exist&quot; information.)\n  3. Call userService.Login(r.Context(), req.Email, req.Password).\n     IF ErrAuthFailed → 401 {&quot;error&quot;:&quot;invalid credentials&quot;}\n       -- identical response for wrong password AND unknown email --\n     IF other error → log.Error, return 500 {&quot;error&quot;:&quot;internal server error&quot;}\n  4. On success → 200 {&quot;token&quot;:&quot;&lt;jwt&gt;&quot;,&quot;expires_at&quot;:&quot;&lt;RFC3339&gt;&quot;}\n     expires_at formatted with time.RFC3339: &quot;2026-03-03T10:00:00Z&quot;\nEND PROCEDURE</code></pre></div>\n<h3 id=\"54-get-me-handler-flow\">5.4 GET /me Handler Flow</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE HandleMe(w http.ResponseWriter, r *http.Request):\n  -- This handler is mounted BEHIND RequireAuth middleware.\n  -- By the time this handler runs, the JWT is already verified.\n  1. claims, ok = middleware.ClaimsFromContext(r.Context())\n     IF !ok → 401 {&quot;error&quot;:&quot;unauthorized&quot;}\n     (Defensive check; RequireAuth should prevent this path.)\n  2. Return 200 {&quot;user_id&quot;: claims.Sub, &quot;email&quot;: claims.Email}\n     -- No DB call. All data comes from the verified token claims.\nEND PROCEDURE</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-10.svg\" alt=\"POST /register Data Flow\"></p>\n<h3 id=\"55-route-registration-in-maingo\">5.5 Route Registration in <code>main.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">mux </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">NewServeMux</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Public routes — no auth required</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST /register\"</span><span style=\"color:#E1E4E8\">, handler.</span><span style=\"color:#B392F0\">NewRegisterHandler</span><span style=\"color:#E1E4E8\">(userSvc, log))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST /login\"</span><span style=\"color:#E1E4E8\">,    handler.</span><span style=\"color:#B392F0\">NewLoginHandler</span><span style=\"color:#E1E4E8\">(userSvc, log))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /health\"</span><span style=\"color:#E1E4E8\">,    handler.</span><span style=\"color:#B392F0\">NewHealthHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"user-service\"</span><span style=\"color:#E1E4E8\">, log))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Protected routes — wrapped with RequireAuth middleware</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">verifier </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> auth.</span><span style=\"color:#B392F0\">NewJWTVerifier</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(jwtSecret))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">requireAuth </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> middleware.</span><span style=\"color:#B392F0\">RequireAuth</span><span style=\"color:#E1E4E8\">(verifier, log)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /me\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">requireAuth</span><span style=\"color:#E1E4E8\">(http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(handler.</span><span style=\"color:#B392F0\">NewMeHandler</span><span style=\"color:#E1E4E8\">(log))))</span></span></code></pre></div>\n<h2 id=\"go-122-routing-note-the-nethttp-mux-in-go-122-supports-method-prefixed-patterns-quotpost-registerquot-since-gomod-declares-go-123-this-is-available-do-not-use-httpservemux-workarounds-use-the-native-method-patterns\"><strong>Go 1.22+ routing note:</strong> The <code>net/http</code> mux in Go 1.22 supports method-prefixed patterns (<code>&quot;POST /register&quot;</code>). Since <code>go.mod</code> declares <code>go 1.23</code>, this is available. Do not use <code>http.ServeMux</code> workarounds; use the native method patterns.</h2>\n<h2 id=\"6-threat-model\">6. Threat Model</h2>\n<h3 id=\"61-attack-surface\">6.1 Attack Surface</h3>\n<table>\n<thead>\n<tr>\n<th>Attack</th>\n<th>Vector</th>\n<th>Mitigation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Password exfiltration</td>\n<td>DB breach</td>\n<td>bcrypt cost=12; hash is computationally infeasible to reverse</td>\n</tr>\n<tr>\n<td>Email enumeration via login</td>\n<td>Different 401 bodies for &quot;no user&quot; vs &quot;wrong password&quot;</td>\n<td><code>ErrAuthFailed</code> collapses both cases; same response body and same 401 status</td>\n</tr>\n<tr>\n<td>Email enumeration via timing</td>\n<td>bcrypt takes 100ms for valid email, 0ms for unknown</td>\n<td>Always run <code>hasher.Compare</code> even for unknown emails (see § 6.2)</td>\n</tr>\n<tr>\n<td>JWT secret exposure</td>\n<td>Hardcoded secret in source</td>\n<td><code>mustGetEnv(&quot;JWT_SECRET&quot;)</code> — no fallback, no default</td>\n</tr>\n<tr>\n<td>Token forgery</td>\n<td>Weak HMAC key</td>\n<td>Document minimum key entropy: JWT_SECRET must be ≥ 32 random bytes in <code>.env.example</code></td>\n</tr>\n<tr>\n<td>Algorithm confusion</td>\n<td>JWT header <code>alg:none</code> or RSA confusion</td>\n<td><code>Verify</code> checks <code>t.Method.(*jwt.SigningMethodHMAC)</code> — rejects any other algorithm</td>\n</tr>\n<tr>\n<td>Long password DoS</td>\n<td>bcrypt memory allocation for 10MB body</td>\n<td><code>http.MaxBytesReader(w, r.Body, 1024)</code> limits request body before any processing</td>\n</tr>\n<tr>\n<td>Concurrent registration race</td>\n<td>Two goroutines both pass the uniqueness check before DB insert</td>\n<td>Unique constraint on <code>users.email</code> enforced at DB level; application maps <code>23505</code> → 409</td>\n</tr>\n</tbody></table>\n<h3 id=\"62-timing-attack-mitigation-for-login\">6.2 Timing Attack Mitigation for Login</h3>\n<p>When an email does not exist, skip <code>hasher.Compare</code> is a timing leak: the attacker observes that responses for unknown emails return in ~0ms while valid emails take ~100ms.</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// In UserService.Login — always run a compare operation to equalize timing.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">user, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> s.repo.</span><span style=\"color:#B392F0\">FindByEmail</span><span style=\"color:#E1E4E8\">(ctx, email)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">Is</span><span style=\"color:#E1E4E8\">(err, repository.ErrUserNotFound) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Run a dummy compare to burn the same ~100ms as a real compare.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // The hash is a valid bcrypt string that will never match anything.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _ </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> s.hasher.</span><span style=\"color:#B392F0\">Compare</span><span style=\"color:#E1E4E8\">(dummyHash, password)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">{}, ErrAuthFailed</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Declare in user_service.go as a package-level constant.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Generated once with bcrypt.GenerateFromPassword([]byte(\"dummypassword\"), 12).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Never changes at runtime — it is not a security secret, just a timing dummy.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> dummyHash</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj6hsxq.bxi.\"</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-11.svg\" alt=\"POST /login Data Flow + Email Enumeration Prevention\"></p>\n<hr>\n<h2 id=\"7-error-handling-matrix\">7. Error Handling Matrix</h2>\n<table>\n<thead>\n<tr>\n<th>Error</th>\n<th>Detected By</th>\n<th>HTTP Status</th>\n<th>Response Body</th>\n<th>Logged?</th>\n<th>Notes</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>VALIDATION_ERROR</code> (email format)</td>\n<td><code>ValidateEmail</code> in <code>UserService.Register</code></td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;email format is invalid&quot;}</code></td>\n<td>No</td>\n<td>User mistake; not logged</td>\n</tr>\n<tr>\n<td><code>VALIDATION_ERROR</code> (password &lt; 8)</td>\n<td><code>ValidatePassword</code> in <code>UserService.Register</code></td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;password must be at least 8 characters&quot;}</code></td>\n<td>No</td>\n<td>User mistake; not logged</td>\n</tr>\n<tr>\n<td><code>VALIDATION_ERROR</code> (empty body)</td>\n<td>JSON decoder in handler</td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;invalid request body&quot;}</code></td>\n<td>No</td>\n<td></td>\n</tr>\n<tr>\n<td><code>VALIDATION_ERROR</code> (body &gt; 1024B)</td>\n<td><code>http.MaxBytesReader</code></td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;request body too large&quot;}</code></td>\n<td>No</td>\n<td></td>\n</tr>\n<tr>\n<td><code>DUPLICATE_EMAIL</code></td>\n<td><code>pgxUserRepository.Create</code> → <code>23505</code></td>\n<td>409</td>\n<td><code>{&quot;error&quot;:&quot;email already registered&quot;}</code></td>\n<td>No</td>\n<td>Expected race; not an error</td>\n</tr>\n<tr>\n<td><code>AUTH_FAILED</code> (unknown email)</td>\n<td><code>UserService.Login</code> after <code>ErrUserNotFound</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;invalid credentials&quot;}</code></td>\n<td>No</td>\n<td>Same body as wrong password</td>\n</tr>\n<tr>\n<td><code>AUTH_FAILED</code> (wrong password)</td>\n<td><code>UserService.Login</code> after <code>ErrPasswordMismatch</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;invalid credentials&quot;}</code></td>\n<td>No</td>\n<td>Same body as unknown email</td>\n</tr>\n<tr>\n<td><code>TOKEN_EXPIRED</code></td>\n<td><code>JWTVerifier.Verify</code> → <code>ErrTokenExpired</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>Warn</td>\n<td>Log path for debugging</td>\n</tr>\n<tr>\n<td><code>TOKEN_INVALID</code></td>\n<td><code>JWTVerifier.Verify</code> → <code>ErrTokenInvalid</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>Warn</td>\n<td>Potential attack; log it</td>\n</tr>\n<tr>\n<td><code>TOKEN_MISSING</code></td>\n<td><code>RequireAuth</code> → missing/malformed header</td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>No</td>\n<td>Unauthenticated request</td>\n</tr>\n<tr>\n<td><code>DB_ERROR</code> (unexpected)</td>\n<td>Any repo call</td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td><strong>Error</strong></td>\n<td>Log full error; never expose to client</td>\n</tr>\n<tr>\n<td><code>BCRYPT_ERROR</code> (unexpected)</td>\n<td><code>hasher.Hash</code> or <code>hasher.Compare</code></td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td><strong>Error</strong></td>\n<td>Should never occur with valid input</td>\n</tr>\n<tr>\n<td><code>JWT_SIGN_ERROR</code></td>\n<td><code>signer.Sign</code></td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td><strong>Error</strong></td>\n<td>Indicates misconfigured secret</td>\n</tr>\n<tr>\n<td><strong>500 response pattern</strong> (used consistently in all handlers):</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> writeInternalError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">msg</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Err</span><span style=\"color:#E1E4E8\">(err).</span><span style=\"color:#B392F0\">Msg</span><span style=\"color:#E1E4E8\">(msg)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    writeJSON</span><span style=\"color:#E1E4E8\">(w, http.StatusInternalServerError, </span><span style=\"color:#B392F0\">ErrorResponse</span><span style=\"color:#E1E4E8\">{Error: </span><span style=\"color:#9ECBFF\">\"internal server error\"</span><span style=\"color:#E1E4E8\">})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>Shared <code>writeJSON</code> helper:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// writeJSON encodes v as JSON and writes it to w with the given status code.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Sets Content-Type: application/json.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Panics are impossible: encoding a fixed struct to JSON cannot fail.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> writeJSON</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">status</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">v</span><span style=\"color:#B392F0\"> any</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">NewEncoder</span><span style=\"color:#E1E4E8\">(w).</span><span style=\"color:#B392F0\">Encode</span><span style=\"color:#E1E4E8\">(v) </span><span style=\"color:#6A737D\">// error intentionally ignored; nothing we can do after WriteHeader</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<hr>\n<h2 id=\"8-implementation-sequence-with-checkpoints\">8. Implementation Sequence with Checkpoints</h2>\n<h3 id=\"phase-1-users-table-migration-userrepository-115-hr\">Phase 1 — users table migration + UserRepository (1–1.5 hr)</h3>\n<ol>\n<li>Write <code>migrations/001_create_users.sql</code> (§ 3.1).</li>\n<li>Run the migration against <code>user_db</code>: <code>docker exec -i user_db psql -U user_user -d user_db &lt; services/user-service/migrations/001_create_users.sql</code></li>\n<li>Write <code>repository/user_repository.go</code>: define <code>User</code> struct, sentinel errors, <code>UserRepository</code> interface, <code>pgxUserRepository</code> struct, <code>NewPgxUserRepository</code>, <code>Create</code>, <code>FindByEmail</code>.</li>\n<li>Write <code>repository/user_repository_test.go</code>: integration tests (§ 9.2).</li>\n<li>Run <code>go test ./repository/... -v</code> with <code>user_db</code> running.\n<strong>Checkpoint:</strong> <code>go test ./repository/... -v</code> passes all tests. <code>TestCreate_DuplicateEmail</code> returns <code>ErrDuplicateEmail</code> (not a 500). <code>TestFindByEmail_NotFound</code> returns <code>ErrUserNotFound</code>. Run <code>docker exec user_db psql -U user_user -d user_db -c &quot;\\d users&quot;</code> — table and indexes visible.</li>\n</ol>\n<h3 id=\"phase-2-passwordhasher-jwtsignerjwtverifier-115-hr\">Phase 2 — PasswordHasher + JWTSigner/JWTVerifier (1–1.5 hr)</h3>\n<ol>\n<li>Add <code>golang.org/x/crypto</code> to <code>go.mod</code>: <code>go get golang.org/x/crypto</code>.</li>\n<li>Add <code>github.com/golang-jwt/jwt/v5</code>: <code>go get github.com/golang-jwt/jwt/v5</code>.</li>\n<li>Add <code>github.com/google/uuid</code>: <code>go get github.com/google/uuid</code>.</li>\n<li>Write <code>auth/password.go</code> (§ 4.2).</li>\n<li>Write <code>auth/password_test.go</code> (§ 9.3).</li>\n<li>Write <code>auth/jwt.go</code> (§ 4.3).</li>\n<li>Write <code>auth/jwt_test.go</code> (§ 9.4).</li>\n<li>Run <code>go test ./auth/...</code>.\n<strong>Checkpoint:</strong> <code>go test ./auth/... -v</code> passes all tests. <code>TestBcryptCost</code> verifies cost=12 is embedded in hash. <code>TestJWTRoundTrip</code> verifies Sign→Verify returns identical claims. <code>TestVerify_ExpiredToken</code> returns <code>ErrTokenExpired</code>. <code>TestVerify_TamperedSignature</code> returns <code>ErrTokenInvalid</code>. <code>TestVerify_WrongIssuer</code> returns <code>ErrTokenInvalid</code>.</li>\n</ol>\n<h3 id=\"phase-3-post-register-post-login-handlers-152-hr\">Phase 3 — POST /register + POST /login Handlers (1.5–2 hr)</h3>\n<ol>\n<li>Write <code>service/user_service.go</code>: <code>UserService</code> struct, <code>NewUserService</code>, <code>Register</code>, <code>Login</code>, dummy hash constant (§ 4.4, § 6.2).</li>\n<li>Write <code>handler/register.go</code>: <code>RegisterRequest</code>, <code>RegisterResponse</code>, <code>NewRegisterHandler</code> (§ 5.2).</li>\n<li>Write <code>handler/login.go</code>: <code>LoginRequest</code>, <code>LoginResponse</code>, <code>NewLoginHandler</code> (§ 5.3).</li>\n<li>Write the <code>writeJSON</code> and <code>writeInternalError</code> helpers (§ 7) — put them in <code>handler/helpers.go</code>.</li>\n<li>Wire together in <code>main.go</code>: connect DB, construct <code>pgxUserRepository</code>, <code>bcryptHasher</code>, <code>jwtSigner</code>, <code>UserService</code>, register routes.</li>\n<li>Run <code>docker compose up --build user-service</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Register</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8083/register</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> .</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"user_id\":\"&#x3C;uuid>\",\"email\":\"alice@example.com\"} with 201</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Duplicate</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8083/register</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"password123\"}'</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 409</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Login</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8083/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> .</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"token\":\"eyJ...\",\"expires_at\":\"2026-...\"}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Wrong password</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8083/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"wrongpassword\"}'</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 401</span></span></code></pre></div>\n<h3 id=\"phase-4-jwt-middleware-in-sharedmiddleware-115-hr\">Phase 4 — JWT Middleware in <code>shared/middleware/</code> (1–1.5 hr)</h3>\n<ol>\n<li>Create <code>shared/middleware/</code> directory.</li>\n<li>Add <code>github.com/golang-jwt/jwt/v5</code> to <code>shared/go.mod</code> (since middleware imports auth types).</li>\n<li>Write <code>shared/middleware/jwt_middleware.go</code> (§ 4.5).</li>\n<li>Write <code>shared/middleware/jwt_middleware_test.go</code> (§ 9.5).</li>\n<li>Run <code>go test ./...</code> from <code>shared/</code>.</li>\n<li>Update each service&#39;s <code>go.mod</code> to import <code>shared/middleware</code> via the existing replace directive.\n<strong>Checkpoint:</strong> <code>go test ./... -v</code> in <code>shared/</code> passes. <code>TestRequireAuth_MissingHeader</code> → 401. <code>TestRequireAuth_ValidToken</code> → calls next handler. <code>TestRequireAuth_ExpiredToken</code> → 401. <code>TestClaimsFromContext</code> → returns claims stored by middleware.\n<strong>Note on shared package design:</strong> The <code>shared/middleware</code> package must import <code>auth.JWTVerifier</code> and <code>auth.Claims</code>. These types are defined in each service&#39;s <code>auth/</code> package, which creates an import cycle if <code>shared/middleware</code> imports a specific service. Resolution: move <code>auth.JWTVerifier</code> and <code>auth.Claims</code> interface/struct definitions into <code>shared/auth/</code> so that both user-service and <code>shared/middleware</code> can import from a neutral location.\n<strong>Revised structure addition:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>shared/\n  auth/\n    types.go    # JWTVerifier interface, Claims struct, sentinel errors\n  middleware/\n    jwt_middleware.go</code></pre></div>\n<p>User-service&#39;s <code>auth/jwt.go</code> implements <code>shared/auth.JWTVerifier</code> interface. This eliminates the cycle.</p>\n<h3 id=\"phase-5-get-me-integration-test-115-hr\">Phase 5 — GET /me + Integration Test (1–1.5 hr)</h3>\n<ol>\n<li>Write <code>handler/me.go</code> (§ 5.4).</li>\n<li>Add the <code>/me</code> route behind <code>RequireAuth</code> middleware to <code>main.go</code>.</li>\n<li>Write <code>handler/handler_test.go</code>: full round-trip integration test (§ 9.6).</li>\n<li>Run the integration test against the live Docker stack.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Full round trip</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8083/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> .token</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8083/me</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> .</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"user_id\":\"&#x3C;uuid>\",\"email\":\"alice@example.com\"}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expired / invalid token</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#9ECBFF\"> http://localhost:8083/me</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer invalidtoken\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 401</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-12.svg\" alt=\"JWT Claims Memory Layout\"></p>\n<hr>\n<h2 id=\"9-test-specification\">9. Test Specification</h2>\n<h3 id=\"91-test-file-organization\">9.1 Test File Organization</h3>\n<p>All tests in this module follow the pattern of same-package unit tests for pure logic, and <code>_test</code> package (external) tests for integration against the live DB or HTTP server.</p>\n<h3 id=\"92-repositoryuser_repository_testgo\">9.2 <code>repository/user_repository_test.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Build tag: //go:build integration — run with: go test -tags integration ./repository/...</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Requires: user_db container running. Read DSN from TEST_DATABASE_DSN env var.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCreate_HappyPath: insert user → row exists in DB with correct fields</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCreate_DuplicateEmail: insert same email twice → second returns ErrDuplicateEmail</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCreate_UUIDPreserved: user.ID provided by caller is stored verbatim (not overwritten)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCreate_EmailNormalization: upper-case email in → lower-case stored</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   (if normalization is done in service; verify service layer, not repo)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestFindByEmail_HappyPath: insert user → FindByEmail returns same user</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestFindByEmail_NotFound: FindByEmail on unknown email → ErrUserNotFound</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestFindByEmail_CaseSensitivity: store \"alice@example.com\" → find \"ALICE@EXAMPLE.COM\" → not found</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   (repository is case-sensitive; normalization is service responsibility)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCreate_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCreate_DuplicateEmail</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCreate_UUIDPreserved</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestFindByEmail_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestFindByEmail_NotFound</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestFindByEmail_CaseSensitivity</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"93-authpassword_testgo\">9.3 <code>auth/password_test.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// TestHash_ProducesValidBcrypt: Hash(\"mypassword\") → string starts with \"$2a$12$\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestHash_DifferentSalts: Hash(\"same\") called twice → two different hashes</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCompare_HappyPath: Hash(p) → Compare(hash, p) returns nil</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCompare_WrongPassword: Compare(hash, \"wrong\") → ErrPasswordMismatch</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCompare_EmptyPassword: Hash(\"\") returns error (bcrypt rejects empty)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestBcryptCost: hash output contains \"$2a$12$\" (cost 12 confirmed)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// BenchmarkHash: bcrypt at cost=12 should take 80-200ms (document timing)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestHash_ProducesValidBcrypt</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestHash_DifferentSalts</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCompare_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCompare_WrongPassword</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestBcryptCost</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkHash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"94-authjwt_testgo\">9.4 <code>auth/jwt_test.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// TestSign_ReturnsThreeParts: token string contains exactly two \".\" chars</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestSign_PayloadFields: decode payload (no verify) → sub, email, iss, iat, exp present</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestSign_ExpiryIs24h: exp - iat == 86400 seconds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestVerify_HappyPath: Sign → Verify → claims match original</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestVerify_ExpiredToken: manually set exp to past → Verify returns ErrTokenExpired</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestVerify_TamperedSignature: alter one char in signature → ErrTokenInvalid</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestVerify_WrongAlgorithm: header alg=none → ErrTokenInvalid</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestVerify_WrongIssuer: sign with iss=\"other\" → ErrTokenInvalid</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestVerify_EmptySecret: NewJWTSigner(nil) → panics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestVerify_SubIsUUID: claims.Sub from verified token is parseable by uuid.Parse</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestSign_ReturnsThreeParts</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestSign_ExpiryIs24h</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestVerify_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestVerify_ExpiredToken</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestVerify_TamperedSignature</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestVerify_WrongIssuer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestVerify_EmptySecret</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// expects panic; use recover()</span></span></code></pre></div>\n<h3 id=\"95-sharedmiddlewarejwt_middleware_testgo\">9.5 <code>shared/middleware/jwt_middleware_test.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// All tests use httptest.NewRecorder and httptest.NewRequest.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// A real JWTVerifier (not a mock) is used to produce valid/invalid tokens.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRequireAuth_ValidToken: valid token → next called, claims in context</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRequireAuth_MissingHeader: no Authorization header → 401</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRequireAuth_MalformedHeader: \"Token abc\" (not Bearer) → 401</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRequireAuth_ExpiredToken: expired token → 401, next NOT called</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRequireAuth_InvalidSignature: tampered token → 401</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRequireAuth_EmptyBearerValue: \"Bearer \" (nothing after space) → 401</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestClaimsFromContext_Present: context with claims → returns claims, true</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestClaimsFromContext_Absent: empty context → returns zero Claims, false</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRequireAuth_ValidToken</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRequireAuth_MissingHeader</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRequireAuth_MalformedHeader</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRequireAuth_ExpiredToken</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRequireAuth_InvalidSignature</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestClaimsFromContext_Present</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestClaimsFromContext_Absent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"96-handlerhandler_testgo-integration-test\">9.6 <code>handler/handler_test.go</code> — Integration Test</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Build tag: //go:build integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Requires: user-service running on TEST_USER_SERVICE_URL (default: http://localhost:8083)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRegisterLoginMe_RoundTrip:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   1. POST /register → 201, capture user_id</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   2. POST /login → 200, capture token and expires_at</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   3. Verify expires_at is approximately 24h from now (within 60s tolerance)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   4. GET /me with token → 200, user_id and email match registration values</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   5. GET /me with no token → 401</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   6. GET /me with expired token → 401</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRegister_DuplicateEmail:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   1. POST /register (email A) → 201</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   2. POST /register (email A again) → 409, body contains \"email already registered\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRegister_InvalidEmail:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   POST /register with \"notanemail\" → 400</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRegister_ShortPassword:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   POST /register with 7-char password → 400</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestLogin_WrongPassword:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   POST /login with correct email, wrong password → 401</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Response body must equal 401 body for unknown email (same message)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestLogin_UnknownEmail:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   POST /login with unknown email → 401</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Response body must equal 401 body for wrong password (same message)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRegisterLoginMe_RoundTrip</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRegister_DuplicateEmail</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRegister_InvalidEmail</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRegister_ShortPassword</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestLogin_WrongPassword</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestLogin_UnknownEmail</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-13.svg\" alt=\"JWT Middleware State Machine (per request)\"></p>\n<hr>\n<h2 id=\"10-performance-targets\">10. Performance Targets</h2>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Target</th>\n<th>How to Measure</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>POST /register</code> p99</td>\n<td>&lt; 200ms</td>\n<td><code>wrk -t2 -c5 -d30s -s register.lua http://localhost:8083/register</code> — bcrypt dominates</td>\n</tr>\n<tr>\n<td><code>POST /login</code> (valid) p99</td>\n<td>&lt; 200ms</td>\n<td>Same <code>wrk</code> script with login payload</td>\n</tr>\n<tr>\n<td><code>POST /login</code> (unknown email) p99</td>\n<td>80–200ms</td>\n<td>Must NOT be near-zero — timing equalization required (§ 6.2)</td>\n</tr>\n<tr>\n<td><code>GET /me</code> p99</td>\n<td>&lt; 5ms</td>\n<td><code>wrk -t4 -c50 -d10s</code> with valid token — no DB access</td>\n</tr>\n<tr>\n<td>JWT <code>Verify</code> (HMAC-SHA256)</td>\n<td>&lt; 1ms</td>\n<td><code>go test -bench=BenchmarkVerify ./auth/...</code></td>\n</tr>\n<tr>\n<td>JWT <code>Sign</code></td>\n<td>&lt; 1ms</td>\n<td><code>go test -bench=BenchmarkSign ./auth/...</code></td>\n</tr>\n<tr>\n<td><code>bcrypt.Hash</code> (cost=12)</td>\n<td>80–150ms</td>\n<td><code>go test -bench=BenchmarkHash ./auth/...</code> on commodity hardware</td>\n</tr>\n<tr>\n<td><code>go build ./...</code></td>\n<td>&lt; 10s incremental</td>\n<td>CI warm build</td>\n</tr>\n<tr>\n<td><code>GET /health</code> p99</td>\n<td>&lt; 10ms</td>\n<td>(inherited from M1)</td>\n</tr>\n<tr>\n<td><strong>bcrypt cost=12 justification:</strong> At cost=12, a single hash takes ~100ms on a modern CPU. This bounds <code>/register</code> and <code>/login</code> to ~100–200ms total (DB query + bcrypt). This is acceptable for auth endpoints which are not on the hot redirect path. The hot path (<code>GET /:code</code> redirect) in url-service does not touch user-service at all.</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td><strong>Concurrency note:</strong> At cost=12, bcrypt saturates a CPU core for ~100ms. With default GOMAXPROCS, a sustained load of 10 concurrent login requests will queue behind each other. This is a deliberate security tradeoff, not a bug. The service is not designed to serve thousands of logins per second — it is designed to make brute-force attacks computationally expensive.</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"11-concurrency-specification\">11. Concurrency Specification</h2>\n<h3 id=\"111-handler-concurrency\">11.1 Handler Concurrency</h3>\n<p><code>net/http</code> launches each request in its own goroutine. The following invariants must hold:</p>\n<ul>\n<li><code>UserService</code> is stateless: no shared mutable fields. The <code>dummyHash</code> constant is read-only. Safe for concurrent use.</li>\n<li><code>pgxUserRepository</code> stores only a <code>*pgxpool.Pool</code> reference. <code>pgxpool</code> is safe for concurrent use — each <code>Acquire(ctx)</code> call gets an exclusive connection from the pool.</li>\n<li><code>bcryptHasher</code> is stateless. <code>bcrypt.GenerateFromPassword</code> and <code>bcrypt.CompareHashAndPassword</code> are goroutine-safe per <code>golang.org/x/crypto</code> documentation.</li>\n<li><code>jwtSigner</code> and <code>jwtVerifier</code> store only <code>[]byte</code> (the secret), which is immutable after construction. Safe for concurrent use.</li>\n<li>No global variables in the handler, service, or repository packages (only the <code>log</code> instance, which <code>zerolog.Logger</code> is value-safe by design).</li>\n</ul>\n<h3 id=\"112-blocking-operations\">11.2 Blocking Operations</h3>\n<p><code>bcrypt.CompareHashAndPassword</code> at cost=12 blocks its goroutine for ~100ms. This is acceptable because:</p>\n<ol>\n<li>Auth endpoints are not on the hot redirect path.</li>\n<li>Go&#39;s scheduler will context-switch other goroutines while this one blocks.</li>\n<li>The pgxpool connection is held for DB query time only (&lt; 5ms), not during bcrypt computation — acquire, query, release, then bcrypt.\n<strong>Connection acquisition pattern:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// In UserService.Login — release DB connection before bcrypt, not after.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">user, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> s.repo.</span><span style=\"color:#B392F0\">FindByEmail</span><span style=\"color:#E1E4E8\">(ctx, email) </span><span style=\"color:#6A737D\">// acquires + releases pool conn internally</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">...</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// DB connection is released here. bcrypt runs without holding any pool connection.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> s.hasher.</span><span style=\"color:#B392F0\">Compare</span><span style=\"color:#E1E4E8\">(user.PasswordHash, password)</span></span></code></pre></div>\n<hr>\n<h2 id=\"12-environment-variable-reference-for-this-module\">12. Environment Variable Reference for This Module</h2>\n<table>\n<thead>\n<tr>\n<th>Variable</th>\n<th>Required</th>\n<th>Example</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>JWT_SECRET</code></td>\n<td>Yes</td>\n<td><code>supersecretkey32bytesminimum!!!</code></td>\n<td>HMAC-SHA256 signing key. Must be ≥ 32 bytes. No default — service exits if unset.</td>\n</tr>\n<tr>\n<td><code>PORT</code></td>\n<td>Yes</td>\n<td><code>8083</code></td>\n<td>HTTP listen port (inherited from M1)</td>\n</tr>\n<tr>\n<td><code>DATABASE_DSN</code></td>\n<td>Yes</td>\n<td><code>postgres://user_user:user_secret@user_db:5432/user_db?sslmode=disable</code></td>\n<td>(inherited from M1)</td>\n</tr>\n<tr>\n<td><code>SERVICE_NAME</code></td>\n<td>Yes</td>\n<td><code>user-service</code></td>\n<td>Embedded in log lines (inherited from M1)</td>\n</tr>\n<tr>\n<td><strong><code>JWT_SECRET</code> startup validation</strong> (add to <code>main.go</code>):</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">jwtSecret </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> mustGetEnv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"JWT_SECRET\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(jwtSecret) </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 32</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Fatal</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Msg</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"JWT_SECRET must be at least 32 characters\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong><code>.env.example</code> addition:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>JWT_SECRET=change-me-to-at-least-32-random-bytes-in-production</code></pre></div>\n<h2 id=\"cross-service-secret-sharing-the-same-jwt_secret-value-must-be-set-in-the-environment-of-url-service-analytics-service-notification-service-and-the-gateway-they-use-it-only-to-construct-a-jwtverifier-never-a-jwtsigner-add-jwt_secret-to-each-service39s-docker-composeyml-environment-block-in-m3m5\"><strong>Cross-service secret sharing:</strong> The same <code>JWT_SECRET</code> value must be set in the environment of url-service, analytics-service, notification-service, and the gateway. They use it only to construct a <code>JWTVerifier</code> — never a <code>JWTSigner</code>. Add <code>JWT_SECRET</code> to each service&#39;s <code>docker-compose.yml</code> environment block in M3–M5.</h2>\n<!-- END_TDD_MOD -->\n\n\n<!-- TDD_MOD_ID: url-shortener-m3 -->\n<h1 id=\"technical-design-specification\">Technical Design Specification</h1>\n<h2 id=\"module-url-service-shorten-redirect-crud-domain-event-publishing\">Module: URL Service — Shorten, Redirect, CRUD + Domain Event Publishing</h2>\n<h2 id=\"module-id-url-shortener-m3\"><strong>Module ID:</strong> <code>url-shortener-m3</code></h2>\n<h2 id=\"1-module-charter\">1. Module Charter</h2>\n<p>The URL Service is the core business logic service of the URL shortener system. It accepts long URLs from authenticated users, generates collision-resistant 7-character base62 short codes, stores them in its private PostgreSQL database, serves 301 redirects via a Redis read-through cache, and publishes domain events (<code>URLCreatedEvent</code>, <code>URLClickedEvent</code>, <code>URLDeletedEvent</code>) to RabbitMQ using the outbox pattern to guarantee at-least-once delivery without coupling the write path to broker availability.\nThis module does <strong>not</strong> call the analytics-service, notification-service, or user-service at runtime. It does not share its PostgreSQL database with any other service. It does not verify user existence — the JWT <code>sub</code> claim is trusted as the owner identifier. It does not implement URL preview, custom domain mapping, QR code generation, link health checking, or bulk import. The outbox poller is the only component that touches RabbitMQ; HTTP handlers write only to PostgreSQL.\n<strong>Upstream dependencies:</strong> M1 foundation (Docker Compose stack, <code>shared/events</code>, <code>shared/logger</code>, Redis container, RabbitMQ container, <code>url_db</code> PostgreSQL container). M2 <code>shared/auth</code> package for <code>JWTVerifier</code> and <code>Claims</code>; <code>shared/middleware</code> for <code>RequireAuth</code>.\n<strong>Downstream dependencies:</strong> analytics-service (M4) and notification-service (M5) consume events published by the outbox poller. The gateway (M5) proxies all requests to this service. No service calls url-service synchronously except the gateway.\n<strong>Invariants that must always hold after this milestone:</strong></p>\n<ul>\n<li>Every URL creation and its corresponding <code>URLCreatedEvent</code> are written in a single PostgreSQL transaction — they either both commit or both roll back. No URL exists without an outbox row; no outbox row exists for a URL that was not created.</li>\n<li>The same atomic-transaction invariant holds for clicks: every redirect and its <code>URLClickedEvent</code> are written together. If the service crashes after the redirect response is sent but before the commit, the event is not published (acceptable: the redirect still happened; the loss of one click event is a known at-least-once tradeoff documented below).</li>\n<li>A Redis cache error never causes a redirect failure. The cache is always optional; PostgreSQL is the source of truth.</li>\n<li>Short codes are generated from <code>crypto/rand</code>; <code>math/rand</code> is never used in the code generation path.</li>\n<li>A user can only delete their own URLs. The JWT <code>sub</code> must match <code>urls.user_id</code>; mismatches return 403, not 404.</li>\n<li>Expired URLs return 410, not 404. Inactive URLs (soft-deleted) return 410, not 404. Only truly absent codes return 404.</li>\n</ul>\n<hr>\n<h2 id=\"2-file-structure\">2. File Structure</h2>\n<p>Create files in the numbered order below. All paths are relative to the monorepo root.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-shortener/\n│\n├── services/url-service/\n│   ├── migrations/\n│   │   ├── 01  001_create_urls.sql\n│   │   └── 02  002_create_outbox.sql\n│   ├── codegen/\n│   │   ├── 03  codegen.go               # Base62 alphabet, Generate(), collision retry\n│   │   └── 04  codegen_test.go\n│   ├── repository/\n│   │   ├── 05  url_repository.go        # URLRepository interface + pgx implementation\n│   │   ├── 06  url_repository_test.go\n│   │   ├── 07  outbox_repository.go     # OutboxRepository interface + pgx implementation\n│   │   └── 08  outbox_repository_test.go\n│   ├── cache/\n│   │   ├── 09  cache.go                 # CacheClient interface + Redis implementation\n│   │   └── 10  cache_test.go\n│   ├── amqp/\n│   │   ├── 11  publisher.go             # AMQPPublisher interface + amqp091 implementation\n│   │   └── 12  publisher_test.go\n│   ├── outbox/\n│   │   ├── 13  poller.go                # OutboxPoller: coordinator + 3 workers\n│   │   └── 14  poller_test.go\n│   ├── service/\n│   │   └── 15  url_service.go           # URLService: orchestrates repo, codegen, cache, outbox\n│   ├── handler/\n│   │   ├── 16  shorten.go              # POST /shorten\n│   │   ├── 17  redirect.go             # GET /:code\n│   │   ├── 18  list.go                 # GET /urls\n│   │   ├── 19  delete.go               # DELETE /urls/:code\n│   │   ├── 20  health.go               # GET /health (update from M1)\n│   │   ├── 21  helpers.go              # writeJSON, writeError, extractIP, hashIP\n│   │   └── 22  handler_test.go         # integration tests\n│   └── 23  main.go                     # wiring: env, DB, Redis, RabbitMQ, routes, outbox start</code></pre></div>\n<h2 id=\"total-new-files-23-excluding-auto-generated-gosum-changes\"><strong>Total new files: 23</strong> (excluding auto-generated <code>go.sum</code> changes).</h2>\n<h2 id=\"3-complete-data-model\">3. Complete Data Model</h2>\n<h3 id=\"31-postgresql-schema-migrations001_create_urlssql\">3.1 PostgreSQL Schema — <code>migrations/001_create_urls.sql</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- migrations/001_create_urls.sql</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">BEGIN</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> urls (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    id           UUID         </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    short_code   </span><span style=\"color:#F97583\">VARCHAR</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">)  </span><span style=\"color:#F97583\">NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    original_url </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">         NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    user_id      UUID         </span><span style=\"color:#F97583\">NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    created_at   </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\">  NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    expires_at   </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\">  NULL</span><span style=\"color:#E1E4E8\">,           </span><span style=\"color:#6A737D\">-- NULL means no expiry</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    is_active    </span><span style=\"color:#F97583\">BOOLEAN</span><span style=\"color:#F97583\">      NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> true</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Primary lookup: redirect hot path. Must be unique; drives cache key.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> UNIQUE INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_urls_short_code</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> urls(short_code);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Cursor pagination: user's URL list, newest first.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Composite index matches the WHERE user_id = $1 AND id &#x3C; $2 ORDER BY id DESC query.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_urls_user_id_created</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> urls(user_id, created_at </span><span style=\"color:#F97583\">DESC</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COMMIT</span><span style=\"color:#E1E4E8\">;</span></span></code></pre></div>\n<h3 id=\"32-postgresql-schema-migrations002_create_outboxsql\">3.2 PostgreSQL Schema — <code>migrations/002_create_outbox.sql</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- migrations/002_create_outbox.sql</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">BEGIN</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> outbox (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    id           UUID         </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    event_type   </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">         NOT NULL</span><span style=\"color:#E1E4E8\">,       </span><span style=\"color:#6A737D\">-- routing key, e.g. \"url.clicked\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    payload      JSONB        </span><span style=\"color:#F97583\">NOT NULL</span><span style=\"color:#E1E4E8\">,       </span><span style=\"color:#6A737D\">-- serialized event struct</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    created_at   </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\">  NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    published_at </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\">  NULL</span><span style=\"color:#6A737D\">            -- NULL = not yet published</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Poller query: unpublished rows, oldest first, bounded.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Partial index (WHERE published_at IS NULL) keeps the index small</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- as published rows accumulate.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_outbox_unpublished</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> outbox(created_at </span><span style=\"color:#F97583\">ASC</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    WHERE</span><span style=\"color:#E1E4E8\"> published_at </span><span style=\"color:#F97583\">IS</span><span style=\"color:#F97583\"> NULL</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COMMIT</span><span style=\"color:#E1E4E8\">;</span></span></code></pre></div>\n<p><strong>Field rationale:</strong></p>\n<ul>\n<li><code>outbox.payload JSONB</code>: The full event struct is serialized here. Workers read this column and publish it directly to RabbitMQ as the message body. No JOIN to <code>urls</code> is needed at publish time.</li>\n<li><code>outbox.published_at NULL</code>: The poller filters on <code>WHERE published_at IS NULL</code>. Marking a row published sets this to <code>now()</code>. Rows are never deleted — they form an audit trail.</li>\n<li><code>urls.is_active BOOLEAN NOT NULL DEFAULT true</code>: Soft delete. Hard deletes would leave broken cache entries and orphaned analytics rows. <code>is_active=false</code> + Redis DEL is the correct sequence.</li>\n<li><code>urls.expires_at TIMESTAMPTZ NULL</code>: Nullable means &quot;no expiry.&quot; A sentinel value (e.g., year 9999) would work but is less idiomatic in PostgreSQL.</li>\n</ul>\n<h3 id=\"33-go-structs\">3.3 Go Structs</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/url_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> repository</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URL is the domain entity stored in the urls table.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URL</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID          </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">     // UUID v4, primary key</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode   </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">     // 7-char base62; up to 10 chars for custom codes</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OriginalURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">     // full destination URL, validated before storage</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID      </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">     // UUID string; JWT sub claim of the creator</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\">  // set by DB DEFAULT</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt   </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // nil = no expiry</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IsActive    </span><span style=\"color:#F97583\">bool</span><span style=\"color:#6A737D\">       // false = soft-deleted</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URLSummary is the projection returned by ListByUser.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// It omits internal fields (ID is included as cursor value only).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLSummary</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID          </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">     // UUID; used as cursor value, not exposed in API response</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode   </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OriginalURL </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt   </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IsActive    </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Sentinel errors returned by URLRepository.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrURLNotFound    </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url not found\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrCodeConflict   </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"short code already exists\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrNotOwner       </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"caller does not own this url\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/outbox_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> repository</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// OutboxEntry is a row in the outbox table.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> OutboxEntry</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID          </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // UUID; primary key</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventType   </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // RabbitMQ routing key</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Payload     []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#6A737D\">    // JSON-encoded event struct</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    PublishedAt </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // nil = not yet published</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// cache/cache.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> cache</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CachedURL is the value stored in Redis for a given short_code key.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// It contains exactly enough information to serve a redirect without a DB query.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// The outbox event is NOT cached — it always goes to PostgreSQL.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> CachedURL</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OriginalURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">     `json:\"original_url\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt   </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"expires_at,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IsActive    </span><span style=\"color:#F97583\">bool</span><span style=\"color:#9ECBFF\">       `json:\"is_active\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RedisKey for a short code: \"url:{short_code}\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Example: \"url:aB3xY9z\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> RedisKey</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#9ECBFF\"> \"url:\"</span><span style=\"color:#F97583\"> +</span><span style=\"color:#E1E4E8\"> shortCode</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handler/shorten.go — Request/Response DTOs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> handler</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ShortenRequest is the JSON body accepted by POST /shorten.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ShortenRequest</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    URL        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"url\"`</span><span style=\"color:#6A737D\">                  // required; must have scheme + host</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CustomCode </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"custom_code,omitempty\"`</span><span style=\"color:#6A737D\"> // optional; 4-10 alphanumeric chars</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt  </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"expires_at,omitempty\"`</span><span style=\"color:#6A737D\">  // optional; RFC3339 string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ShortenResponse is the JSON body returned on 201 Created.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ShortenResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortURL    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"short_url\"`</span><span style=\"color:#6A737D\">    // e.g. \"http://localhost:8081/aB3xY9z\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OriginalURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"original_url\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt   </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"expires_at,omitempty\"`</span><span style=\"color:#6A737D\"> // RFC3339 or absent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URLListResponse is the JSON body returned by GET /urls.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLListResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    URLs       []</span><span style=\"color:#B392F0\">URLItem</span><span style=\"color:#9ECBFF\"> `json:\"urls\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    NextCursor </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">   `json:\"next_cursor,omitempty\"`</span><span style=\"color:#6A737D\"> // UUID string; absent if no more pages</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URLItem is a single URL entry in the list response.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLItem</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OriginalURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"original_url\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"created_at\"`</span><span style=\"color:#6A737D\">            // RFC3339</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt   </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"expires_at,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IsActive    </span><span style=\"color:#F97583\">bool</span><span style=\"color:#9ECBFF\">    `json:\"is_active\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-14.svg\" alt=\"URL Service Module Architecture\"></p>\n<hr>\n<h2 id=\"4-interface-contracts\">4. Interface Contracts</h2>\n<h3 id=\"41-urlrepository\">4.1 <code>URLRepository</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/url_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URLRepository defines persistence operations for URL entities.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// All implementations must be safe for concurrent use.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Implementations must NOT start or commit transactions; callers provide pgx.Tx</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// for operations that require atomicity.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Create inserts a new URL row. Executes within the provided transaction tx.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // tx must be non-nil — Create is always called inside a transaction that also</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // calls OutboxRepository.Insert. If short_code violates the unique constraint,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // returns ErrCodeConflict (pgconn code \"23505\"). Other DB errors are wrapped</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // with fmt.Errorf(\"urlRepository.Create: %w\", err).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Create</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">u</span><span style=\"color:#B392F0\"> URL</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // FindByCode retrieves a URL by short_code using the pool (not a transaction).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns ErrURLNotFound if no row matches.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // The returned URL contains all fields including is_active and expires_at.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    FindByCode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">URL</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ListByUser returns a page of URLs owned by userID.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // afterID is the cursor: if non-empty, returns rows with created_at strictly</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // less than the row identified by afterID. Rows are ordered by (created_at DESC, id DESC).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // limit is the maximum number of rows to return (caller passes pageSize + 1 to detect</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // whether a next page exists; caller slices the result before returning to the API client).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns an empty slice (not nil) if no rows match.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    ListByUser</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">userID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">afterID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">limit</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">URLSummary</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // SoftDelete sets is_active=false for the row identified by shortCode.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns ErrURLNotFound if no row exists.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns ErrNotOwner if the row's user_id does not match ownerID.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Executes within the provided transaction tx.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    SoftDelete</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">ownerID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>SQL queries for each method:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- Create</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">INSERT INTO</span><span style=\"color:#E1E4E8\"> urls (id, short_code, original_url, user_id, expires_at)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">VALUES</span><span style=\"color:#E1E4E8\"> ($</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, $</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, $</span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">, $</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">, $</span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- FindByCode</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SELECT</span><span style=\"color:#E1E4E8\"> id, short_code, original_url, user_id, created_at, expires_at, is_active</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> urls</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> short_code </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- ListByUser (with cursor)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SELECT</span><span style=\"color:#E1E4E8\"> id, short_code, original_url, created_at, expires_at, is_active</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> urls</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> user_id </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  AND</span><span style=\"color:#E1E4E8\"> ($</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">::uuid </span><span style=\"color:#F97583\">IS</span><span style=\"color:#F97583\"> NULL</span><span style=\"color:#F97583\"> OR</span><span style=\"color:#E1E4E8\"> (created_at, id) </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      SELECT</span><span style=\"color:#E1E4E8\"> created_at, id </span><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> urls </span><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> id </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">::uuid</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  ))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">ORDER BY</span><span style=\"color:#E1E4E8\"> created_at </span><span style=\"color:#F97583\">DESC</span><span style=\"color:#E1E4E8\">, id </span><span style=\"color:#F97583\">DESC</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">LIMIT</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">3</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- SoftDelete (with ownership check — single atomic UPDATE)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">UPDATE</span><span style=\"color:#E1E4E8\"> urls</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SET</span><span style=\"color:#E1E4E8\"> is_active </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> false</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> short_code </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  AND</span><span style=\"color:#E1E4E8\"> user_id </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">2</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">RETURNING id</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- If 0 rows affected: determine whether code exists to distinguish 404 vs 403:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">--   SELECT id, user_id FROM urls WHERE short_code = $1</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">--   No row → ErrURLNotFound; row with wrong user_id → ErrNotOwner</span></span></code></pre></div>\n<p><strong>Note on <code>ListByUser</code> cursor:</strong> Using <code>(created_at, id) &lt; (SELECT ...)</code> is a keyset/cursor approach. The subquery fetches the anchor row&#39;s <code>(created_at, id)</code> so the comparison is correct even if multiple rows share the same <code>created_at</code>. The index <code>idx_urls_user_id_created</code> covers <code>(user_id, created_at DESC)</code> which satisfies the <code>WHERE user_id = $1</code> filter and <code>ORDER BY created_at DESC</code>.</p>\n<h3 id=\"42-outboxrepository\">4.2 <code>OutboxRepository</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/outbox_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// OutboxRepository writes event rows to the outbox table and marks them published.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> OutboxRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert writes a new outbox row within the provided transaction tx.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // tx must be the same transaction as the URL write — atomicity is the contract.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // eventType is the RabbitMQ routing key (e.g., \"url.clicked\").</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // payload is the JSON-serialized event struct.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">eventType</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">payload</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // FetchUnpublished returns up to limit unpublished outbox rows, ordered by</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // created_at ASC (oldest first). Uses the pool (no transaction) because the</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // poller reads and marks-published in two separate steps.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns an empty slice (not nil) if no rows are pending.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    FetchUnpublished</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">limit</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">OutboxEntry</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // MarkPublished sets published_at = now() for the row identified by id.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Uses the pool (no transaction). Idempotent: if already published, no-op.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    MarkPublished</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">id</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>SQL queries:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- Insert (within caller's transaction)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">INSERT INTO</span><span style=\"color:#E1E4E8\"> outbox (id, event_type, payload, created_at)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">VALUES</span><span style=\"color:#E1E4E8\"> (gen_random_uuid(), $</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, $</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">now</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- FetchUnpublished</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SELECT</span><span style=\"color:#E1E4E8\"> id, event_type, payload, created_at</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> outbox</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> published_at </span><span style=\"color:#F97583\">IS</span><span style=\"color:#F97583\"> NULL</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">ORDER BY</span><span style=\"color:#E1E4E8\"> created_at </span><span style=\"color:#F97583\">ASC</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">LIMIT</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- MarkPublished</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">UPDATE</span><span style=\"color:#E1E4E8\"> outbox</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SET</span><span style=\"color:#E1E4E8\"> published_at </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> id </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span></span></code></pre></div>\n<h3 id=\"43-cacheclient\">4.3 <code>CacheClient</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// cache/cache.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CacheClient wraps Redis operations for URL caching.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// All methods must be nil-safe: if the underlying Redis client is nil</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// (set during startup when Redis was unavailable), every method returns</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// a cache-miss sentinel or no-op without panicking.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// All errors are logged internally; callers never receive Redis errors —</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// cache failures are transparent.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> CacheClient</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Get retrieves a CachedURL by short_code key (\"url:{code}\").</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns (entry, nil) on hit.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns (CachedURL{}, ErrCacheMiss) on miss or any Redis error.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Never returns any error other than ErrCacheMiss to the caller.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Get</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">CachedURL</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Set stores a CachedURL with the given TTL.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ttl must be > 0; if ttl &#x3C;= 0, Set is a no-op (never cache with no expiry).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Any Redis error is logged and silently swallowed.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">entry</span><span style=\"color:#B392F0\"> CachedURL</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">ttl</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Del removes the cache entry for shortCode.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Any Redis error is logged and silently swallowed.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // This is a best-effort operation; callers must not assume the key is gone.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Del</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ErrCacheMiss is the only error CacheClient.Get returns to callers.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> ErrCacheMiss </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"cache miss\"</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong>Implementation detail — nil safety:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> redisCacheClient</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span><span style=\"color:#6A737D\"> // may be nil if Redis was unavailable at startup</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log    </span><span style=\"color:#B392F0\">zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">c </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">redisCacheClient</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">CachedURL</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> c.client </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> CachedURL</span><span style=\"color:#E1E4E8\">{}, ErrCacheMiss</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    val, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> c.client.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(ctx, </span><span style=\"color:#B392F0\">RedisKey</span><span style=\"color:#E1E4E8\">(shortCode)).</span><span style=\"color:#B392F0\">Result</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">Is</span><span style=\"color:#E1E4E8\">(err, redis.Nil) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> CachedURL</span><span style=\"color:#E1E4E8\">{}, ErrCacheMiss</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        c.log.</span><span style=\"color:#B392F0\">Warn</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Err</span><span style=\"color:#E1E4E8\">(err).</span><span style=\"color:#B392F0\">Str</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"key\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">RedisKey</span><span style=\"color:#E1E4E8\">(shortCode)).</span><span style=\"color:#B392F0\">Msg</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"redis GET failed; cache miss\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> CachedURL</span><span style=\"color:#E1E4E8\">{}, ErrCacheMiss</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> entry </span><span style=\"color:#B392F0\">CachedURL</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(val), </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">entry); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        c.log.</span><span style=\"color:#B392F0\">Warn</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Err</span><span style=\"color:#E1E4E8\">(err).</span><span style=\"color:#B392F0\">Msg</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"redis value unmarshal failed; cache miss\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#B392F0\"> CachedURL</span><span style=\"color:#E1E4E8\">{}, ErrCacheMiss</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> entry, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"44-codegenerator\">4.4 <code>CodeGenerator</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// codegen/codegen.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CodeGenerator generates short codes.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> CodeGenerator</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Generate produces a 7-character base62 string from crypto/rand.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns an error only if the OS random source fails (extremely rare).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Collision detection is NOT performed here — that is the caller's</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // responsibility (URLService.createShortCode retry loop).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Generate</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewCodeGenerator returns the default 7-character base62 generator.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewCodeGenerator</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">CodeGenerator</span></span></code></pre></div>\n<h3 id=\"45-amqppublisher\">4.5 <code>AMQPPublisher</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// amqp/publisher.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// AMQPPublisher publishes messages to the RabbitMQ topic exchange.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> AMQPPublisher</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Publish sends body to the exchange \"url-shortener\" with the given routingKey.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // body must be a JSON-encoded event struct.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns an error if the AMQP channel is closed or the broker is unreachable.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Callers (outbox workers) handle errors by logging and leaving the outbox row</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // unpublished for the next poll cycle.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Publish</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">routingKey</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">body</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"46-urlservice\">4.6 <code>URLService</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// service/url_service.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URLService orchestrates URL creation, lookup, listing, deletion, and event emission.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// It owns no state beyond its dependencies. Safe for concurrent use.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLService</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool      </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    urlRepo   </span><span style=\"color:#B392F0\">repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URLRepository</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    outboxRepo </span><span style=\"color:#B392F0\">repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">OutboxRepository</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cache     </span><span style=\"color:#B392F0\">cache</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CacheClient</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    codegen   </span><span style=\"color:#B392F0\">codegen</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CodeGenerator</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    baseURL   </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // e.g. \"http://localhost:8081\" — prepended to short_code for short_url</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log       </span><span style=\"color:#B392F0\">zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewURLService</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    urlRepo</span><span style=\"color:#B392F0\"> repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URLRepository</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    outboxRepo</span><span style=\"color:#B392F0\"> repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">OutboxRepository</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    cache</span><span style=\"color:#B392F0\"> cache</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CacheClient</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    codegen</span><span style=\"color:#B392F0\"> codegen</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">CodeGenerator</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    baseURL</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLService</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Shorten creates a new short URL and writes a URLCreatedEvent to the outbox</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// in the same transaction. Returns the created URL entity.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Errors: ErrURLInvalid, ErrCodeConflict (exhausted retries → 503), DB errors.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLService</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Shorten</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    originalURL</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    customCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,       </span><span style=\"color:#6A737D\">// empty string = auto-generate</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    expiresAt</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    userID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    userEmail</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,        </span><span style=\"color:#6A737D\">// from JWT claims; embedded in URLCreatedEvent</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    correlationID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URL</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Redirect looks up a URL by short_code using the read-through cache.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Writes a URLClickedEvent to the outbox within a DB transaction on cache hit or miss.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns the original URL for redirect.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Errors: ErrURLNotFound, ErrURLExpired, ErrURLInactive.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLService</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Redirect</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    ipHash</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    userAgent</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    referer</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    correlationID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#FFAB70\">originalURL</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ListURLs returns a cursor-paginated list of URLs owned by userID.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// pageSize is capped at 100 internally regardless of caller input.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// afterCursor is the UUID of the last seen URL (empty = first page).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLService</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ListURLs</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    userID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    afterCursor</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    pageSize</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#FFAB70\">urls</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#B392F0\">repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URLSummary</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">nextCursor</span><span style=\"color:#F97583\"> *</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Delete soft-deletes a URL and publishes URLDeletedEvent via outbox.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Invalidates the Redis cache entry as a best-effort operation.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Errors: ErrURLNotFound, ErrNotOwner, DB errors.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLService</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Delete</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    userID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    userEmail</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    correlationID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span></code></pre></div>\n<p><strong>Sentinel errors for URLService:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrURLInvalid  </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url is invalid: must have scheme and host\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrURLExpired  </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url has expired\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrURLInactive </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url is inactive\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrExhausted   </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"short code generation exhausted: 5 collisions\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-15.svg\" alt=\"urls + outbox Table Schema and Index Layout\"></p>\n<hr>\n<h2 id=\"5-algorithm-specification\">5. Algorithm Specification</h2>\n<h3 id=\"51-base62-code-generation\">5.1 Base62 Code Generation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// codegen/codegen.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// base62Alphabet is the character set for short codes.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Chosen for URL-safety and case-sensitivity.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Length = 62. Index → character mapping is stable and must not change.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> base62Alphabet</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// codeLength is the fixed length of auto-generated short codes.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> codeLength</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> 7</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Generate produces a 7-character base62 string.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Algorithm:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   1. Allocate a byte slice of length 7.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   2. For each position i in [0, 7):</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//      a. Read 1 random byte from crypto/rand.Reader.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//      b. Map the byte to an alphabet index: idx = byte % 62.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//         NOTE: This introduces a tiny modulo bias (256 % 62 = 8, so indices</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//         0–7 are ~0.4% more likely). This bias is acceptable for URL shortening;</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//         it does not compromise security. For uniform distribution, use</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//         rejection sampling (discard bytes >= 248 and re-read), but this</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//         complexity is not warranted here.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//      c. code[i] = base62Alphabet[idx]</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   3. Return string(code), nil.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   4. If crypto/rand.Reader.Read fails, return \"\", fmt.Errorf(\"codegen.Generate: %w\", err).</span></span></code></pre></div>\n<p><strong>Implementation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">g </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">base62Generator</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Generate</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    buf </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">, codeLength)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    code </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">, codeLength)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> io.</span><span style=\"color:#B392F0\">ReadFull</span><span style=\"color:#E1E4E8\">(rand.Reader, buf); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"codegen.Generate: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i, b </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> buf {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        code[i] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> base62Alphabet[</span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\">(b)</span><span style=\"color:#F97583\">%</span><span style=\"color:#79B8FF\">62</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">(code), </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"52-short-code-selection-with-collision-retry\">5.2 Short Code Selection with Collision Retry</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE URLService.createShortCode(ctx, customCode string):\n  IF customCode != &quot;&quot;:\n    VALIDATE customCode: len ∈ [4, 10], all chars in base62Alphabet\n    IF invalid → return &quot;&quot;, ErrURLInvalid (caller maps to 400)\n    return customCode, nil  -- collision will be detected by DB unique constraint\n  FOR attempt := 1; attempt &lt;= 5; attempt++:\n    code, err = s.codegen.Generate()\n    IF err → return &quot;&quot;, fmt.Errorf(&quot;createShortCode: %w&quot;, err) (→ 500)\n    -- Optimistically attempt INSERT; let the DB unique constraint catch collisions.\n    -- We do NOT pre-check existence with a SELECT — that is a TOCTOU race.\n    -- The caller (Shorten) handles ErrCodeConflict by retrying this procedure.\n    return code, nil  -- caller retries the full transaction on ErrCodeConflict\n  -- This path is reached only if the caller has retried 5 times and all failed.\n  return &quot;&quot;, ErrExhausted  -- (→ 503)\nEND PROCEDURE</code></pre></div>\n<p><strong>Collision retry in <code>URLService.Shorten</code>:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> maxCollisionRetries</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> 5</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLService</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Shorten</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">...</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URL</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ... validation ...</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> attempt </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\">; attempt </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#E1E4E8\"> maxCollisionRetries; attempt</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        code, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> s.</span><span style=\"color:#B392F0\">selectCode</span><span style=\"color:#E1E4E8\">(ctx, customCode)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URL</span><span style=\"color:#E1E4E8\">{}, err</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        url, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> s.</span><span style=\"color:#B392F0\">createURLWithOutbox</span><span style=\"color:#E1E4E8\">(ctx, code, </span><span style=\"color:#F97583\">...</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">Is</span><span style=\"color:#E1E4E8\">(err, repository.ErrCodeConflict) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> customCode </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">                // Custom code conflict is not retryable — it's a user error.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                return</span><span style=\"color:#B392F0\"> repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URL</span><span style=\"color:#E1E4E8\">{}, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">: custom code already taken\"</span><span style=\"color:#E1E4E8\">, repository.ErrCodeConflict)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            s.log.</span><span style=\"color:#B392F0\">Debug</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Int</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"attempt\"</span><span style=\"color:#E1E4E8\">, attempt).</span><span style=\"color:#B392F0\">Str</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"code\"</span><span style=\"color:#E1E4E8\">, code).</span><span style=\"color:#B392F0\">Msg</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"short code collision; retrying\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            continue</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#B392F0\"> repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URL</span><span style=\"color:#E1E4E8\">{}, err</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> url, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#B392F0\"> repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URL</span><span style=\"color:#E1E4E8\">{}, ErrExhausted</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"53-atomic-url-outbox-write\">5.3 Atomic URL + Outbox Write</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE URLService.createURLWithOutbox(ctx, url URL, event URLCreatedEvent):\n  1. tx, err = pool.Begin(ctx)\n     IF err → return wrapped error (→ 500)\n  2. DEFER tx.Rollback(ctx)  -- no-op if Commit succeeds\n  3. err = urlRepo.Create(ctx, tx, url)\n     IF ErrCodeConflict → return ErrCodeConflict (caller retries)\n     IF other error → return wrapped error (rollback via defer)\n  4. payload, err = json.Marshal(event)\n     IF err → return wrapped error (rollback via defer)\n  5. err = outboxRepo.Insert(ctx, tx, event.EventType, payload)\n     IF err → return wrapped error (rollback via defer)\n  6. err = tx.Commit(ctx)\n     IF err → return fmt.Errorf(&quot;createURLWithOutbox: commit: %w&quot;, err)\n  7. return nil\nEND PROCEDURE</code></pre></div>\n<p><strong>Invariant enforced:</strong> Steps 3 and 5 execute within the same <code>pgx.Tx</code>. A crash between step 6 and the HTTP response causes the transaction to be rolled back by PostgreSQL (connection close triggers rollback). The URL does not exist; the outbox row does not exist; the client receives a connection reset — acceptable for a rare crash scenario.</p>\n<h3 id=\"54-redirect-with-read-through-cache\">5.4 Redirect with Read-Through Cache</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE URLService.Redirect(ctx, shortCode, ipHash, userAgent, referer, correlationID):\n  1. entry, err = cache.Get(ctx, shortCode)\n     IF err == nil (cache HIT):\n       IF !entry.IsActive → return &quot;&quot;, ErrURLInactive\n       IF entry.ExpiresAt != nil &amp;&amp; entry.ExpiresAt.Before(time.Now()) → return &quot;&quot;, ErrURLExpired\n       -- Record click event via outbox (must still go to DB)\n       err = s.recordClick(ctx, shortCode, ipHash, userAgent, referer, correlationID)\n       IF err → log.Warn (do NOT fail the redirect); continue\n       return entry.OriginalURL, nil\n  2. -- Cache miss or Redis error; fall through to DB\n     url, err = urlRepo.FindByCode(ctx, shortCode)\n     IF ErrURLNotFound → return &quot;&quot;, ErrURLNotFound\n     IF other error → return &quot;&quot;, wrapped error (→ 500)\n  3. IF !url.IsActive → return &quot;&quot;, ErrURLInactive\n     IF url.ExpiresAt != nil &amp;&amp; url.ExpiresAt.Before(time.Now()) → return &quot;&quot;, ErrURLExpired\n  4. -- Populate cache BEFORE recording click (faster response to next caller)\n     ttl = computeTTL(url.ExpiresAt)  -- see § 5.5\n     cache.Set(ctx, shortCode, CachedURL{\n         OriginalURL: url.OriginalURL,\n         ExpiresAt:   url.ExpiresAt,\n         IsActive:    url.IsActive,\n     }, ttl)\n  5. -- Record click event via outbox\n     err = s.recordClick(ctx, shortCode, ipHash, userAgent, referer, correlationID)\n     IF err → log.Warn (do NOT fail the redirect)\n  6. return url.OriginalURL, nil\nEND PROCEDURE</code></pre></div>\n<p><strong><code>recordClick</code> — atomic click + outbox:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLService</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">recordClick</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">ipHash</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">userAgent</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">referer</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">correlationID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    event </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URLClickedEvent</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        EventType:     events.EventTypeURLClicked,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        OccurredAt:    time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">UTC</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        CorrelationID: correlationID,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        EventID:       uuid.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ShortCode:     shortCode,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        IPHash:        ipHash,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        UserAgent:     userAgent,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Referer:       referer,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    payload, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(event)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"recordClick marshal: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    tx, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> s.pool.</span><span style=\"color:#B392F0\">Begin</span><span style=\"color:#E1E4E8\">(ctx)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"recordClick begin tx: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> tx.</span><span style=\"color:#B392F0\">Rollback</span><span style=\"color:#E1E4E8\">(ctx)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> s.outboxRepo.</span><span style=\"color:#B392F0\">Insert</span><span style=\"color:#E1E4E8\">(ctx, tx, event.EventType, payload); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"recordClick insert outbox: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> tx.</span><span style=\"color:#B392F0\">Commit</span><span style=\"color:#E1E4E8\">(ctx)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>Note on click atomicity:</strong> The click outbox row is written in its own transaction separate from the redirect response. If the service crashes after sending the HTTP 301 but before committing this transaction, the click is lost. This is an acknowledged at-least-once tradeoff: the redirect always succeeds; the click event may occasionally be lost. To achieve true at-least-once for clicks, one would buffer the click in a pre-response transaction that also locks the URL row — too expensive for the redirect hot path. The current design is correct for this system&#39;s requirements.</p>\n<h3 id=\"55-cache-ttl-computation\">5.5 Cache TTL Computation</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>FUNCTION computeTTL(expiresAt *time.Time) time.Duration:\n  maxTTL = 1 * time.Hour\n  IF expiresAt == nil:\n    return maxTTL\n  remaining = time.Until(*expiresAt)\n  IF remaining &lt;= 0:\n    -- URL is already expired; do not cache it.\n    -- Caller should have returned ErrURLExpired before reaching Set.\n    -- Defensive: return a very short TTL so stale data doesn't linger.\n    return 1 * time.Second\n  IF remaining &lt; maxTTL:\n    return remaining\n  return maxTTL</code></pre></div>\n<p><strong>Invariant:</strong> A Redis entry for a URL with <code>expires_at</code> set never outlives that expiry time. TTL = <code>min(expires_at - now(), 1h)</code>.</p>\n<h3 id=\"56-cursor-based-pagination-for-get-urls\">5.6 Cursor-Based Pagination for <code>GET /urls</code></h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE URLService.ListURLs(ctx, userID, afterCursor, pageSize):\n  pageSize = clamp(pageSize, 1, 100)  -- cap at 100; default 20\n  fetchLimit = pageSize + 1           -- fetch one extra to detect next page\n  rows, err = urlRepo.ListByUser(ctx, userID, afterCursor, fetchLimit)\n  IF err → return nil, nil, wrapped error\n  hasMore = len(rows) &gt; pageSize\n  IF hasMore:\n    rows = rows[:pageSize]            -- trim the sentinel extra row\n  var nextCursor *string\n  IF hasMore:\n    lastID = rows[len(rows)-1].ID\n    nextCursor = &amp;lastID             -- cursor is the UUID of the last returned row\n  return rows, nextCursor, nil\nEND PROCEDURE</code></pre></div>\n<p><strong>Why UUID cursor, not <code>created_at</code> cursor:</strong> <code>created_at</code> values can collide (two URLs created in the same microsecond). Using the UUID <code>id</code> as the keyset cursor — with the SQL subquery fetching that row&#39;s <code>(created_at, id)</code> — is both collision-safe and avoids transmitting timestamps in the cursor parameter.</p>\n<h3 id=\"57-outbox-worker-pool\">5.7 Outbox Worker Pool</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE StartOutboxPoller(ctx, pool, outboxRepo, publisher, log):\n  jobChan = make(chan OutboxEntry, 50)  -- buffered; coordinator fills, workers drain\n  -- Start 3 worker goroutines\n  FOR i := 0; i &lt; 3; i++:\n    go outboxWorker(ctx, jobChan, outboxRepo, publisher, log)\n  -- Coordinator goroutine (this goroutine IS the coordinator)\n  FOR:\n    SELECT:\n    CASE &lt;-ctx.Done():\n      close(jobChan)\n      return\n    CASE &lt;-time.After(2 * time.Second):\n      entries, err = outboxRepo.FetchUnpublished(ctx, 50)\n      IF err:\n        log.Warn().Err(err).Msg(&quot;outbox fetch failed&quot;)\n        continue\n      FOR each entry in entries:\n        SELECT:\n        CASE jobChan &lt;- entry:   -- send to worker\n        CASE &lt;-ctx.Done():\n          close(jobChan)\n          return\nEND PROCEDURE\nPROCEDURE outboxWorker(ctx, jobChan, outboxRepo, publisher, log):\n  FOR entry := range jobChan:\n    err = publisher.Publish(ctx, entry.EventType, entry.Payload)\n    IF err:\n      log.Warn().Err(err).Str(&quot;id&quot;, entry.ID).Msg(&quot;outbox publish failed; will retry next cycle&quot;)\n      -- Do NOT mark published. The coordinator will re-fetch this row next cycle.\n      continue\n    err = outboxRepo.MarkPublished(ctx, entry.ID)\n    IF err:\n      log.Error().Err(err).Str(&quot;id&quot;, entry.ID).Msg(&quot;outbox mark published failed; event may be re-published&quot;)\n      -- Event was published to RabbitMQ but the DB update failed.\n      -- On next poll, this row will be re-fetched and re-published.\n      -- This is the at-least-once guarantee: consumers must be idempotent (M4).\nEND PROCEDURE</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-16.svg\" alt=\"POST /shorten Atomic Transaction — Step-by-Step\"></p>\n<p><strong>Channel capacity rationale:</strong> A buffered channel of 50 matches <code>FetchUnpublished(ctx, 50)</code>. If 3 workers are slower than the coordinator (e.g., RabbitMQ is slow), the channel fills and the coordinator blocks on the <code>jobChan &lt;- entry</code> send. This provides natural backpressure: the coordinator does not enqueue faster than workers can drain.</p>\n<h3 id=\"58-amqppublisher-implementation\">5.8 AMQPPublisher Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// amqp/publisher.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> amqpPublisher</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ch  </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">amqp091</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu  </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Mutex</span><span style=\"color:#6A737D\"> // protects ch; channel is not goroutine-safe per amqp091 docs</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log </span><span style=\"color:#B392F0\">zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">p </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">amqpPublisher</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Publish</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">routingKey</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">body</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    p.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> p.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> p.ch.</span><span style=\"color:#B392F0\">PublishWithContext</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ctx,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"url-shortener\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// exchange</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        routingKey,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        false</span><span style=\"color:#E1E4E8\">,           </span><span style=\"color:#6A737D\">// mandatory: false — drop if no queue bound (don't block)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        false</span><span style=\"color:#E1E4E8\">,           </span><span style=\"color:#6A737D\">// immediate: false — deprecated in RabbitMQ 3+</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        amqp091</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Publishing</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            ContentType:  </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            DeliveryMode: amqp091.Persistent, </span><span style=\"color:#6A737D\">// survive broker restart</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            Body:         body,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong><code>amqp091.Channel</code> thread safety:</strong> The <code>amqp091</code> library&#39;s <code>Channel</code> is not safe for concurrent use. The <code>sync.Mutex</code> in <code>amqpPublisher</code> serializes concurrent <code>Publish</code> calls from the 3 worker goroutines. This is correct and intentional.</p>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-17.svg\" alt=\"Base62 Code Generation Algorithm\"></p>\n<hr>\n<h2 id=\"6-http-handler-specification\">6. HTTP Handler Specification</h2>\n<h3 id=\"61-post-shorten-handler\">6.1 <code>POST /shorten</code> Handler</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE HandleShorten(w, r):\n  -- Middleware: RequireAuth runs before this handler; claims are in context.\n  claims, ok = middleware.ClaimsFromContext(r.Context())\n  IF !ok → 401 (defensive; middleware should prevent this)\n  -- Parse body\n  http.MaxBytesReader(w, r.Body, 4096)\n  Decode JSON into ShortenRequest\n  IF decode error → 400 {&quot;error&quot;:&quot;invalid request body&quot;}\n  -- Validate original URL\n  IF req.URL == &quot;&quot; → 400 {&quot;error&quot;:&quot;url is required&quot;}\n  parsed, err = url.Parse(req.URL)\n  IF err != nil OR parsed.Scheme == &quot;&quot; OR parsed.Host == &quot;&quot; → 400 {&quot;error&quot;:&quot;url must include scheme and host&quot;}\n  IF parsed.Scheme not in [&quot;http&quot;,&quot;https&quot;] → 400 {&quot;error&quot;:&quot;url scheme must be http or https&quot;}\n  -- Parse optional expires_at\n  var expiresAt *time.Time\n  IF req.ExpiresAt != nil:\n    t, err = time.Parse(time.RFC3339, *req.ExpiresAt)\n    IF err → 400 {&quot;error&quot;:&quot;expires_at must be RFC3339 format&quot;}\n    IF t.Before(time.Now()) → 400 {&quot;error&quot;:&quot;expires_at must be in the future&quot;}\n    expiresAt = &amp;t\n  -- Extract correlation ID (set by gateway in M5; fallback for direct calls)\n  correlationID = r.Header.Get(&quot;X-Correlation-ID&quot;)\n  IF correlationID == &quot;&quot; → correlationID = uuid.New().String()\n  -- Call service\n  created, err = urlService.Shorten(\n      r.Context(), req.URL, req.CustomCode, expiresAt,\n      claims.Sub, claims.Email, correlationID,\n  )\n  IF errors.Is(err, ErrURLInvalid) → 400 {&quot;error&quot;: err.Error()}\n  IF errors.Is(err, repository.ErrCodeConflict) → 409 {&quot;error&quot;:&quot;short code already taken&quot;}\n  IF errors.Is(err, ErrExhausted) → 503 {&quot;error&quot;:&quot;could not generate unique code; try again&quot;}\n  IF err → 500 {&quot;error&quot;:&quot;internal server error&quot;} + log.Error\n  -- Build response\n  shortURL = baseURL + &quot;/&quot; + created.ShortCode\n  var expiresAtStr *string\n  IF created.ExpiresAt != nil → expiresAtStr = ptr(created.ExpiresAt.Format(time.RFC3339))\n  201 ShortenResponse{ShortCode, ShortURL, OriginalURL, ExpiresAt}\nEND PROCEDURE</code></pre></div>\n<h3 id=\"62-get-code-redirect-handler\">6.2 <code>GET /:code</code> Redirect Handler</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE HandleRedirect(w, r):\n  shortCode = r.PathValue(&quot;code&quot;)\n  IF shortCode == &quot;&quot; → 400 {&quot;error&quot;:&quot;short code is required&quot;}\n  -- Extract request metadata for click event\n  rawIP = extractClientIP(r)  -- see § 6.2.1\n  ipHash = hashIP(rawIP)      -- SHA-256(rawIP + CLICK_SALT env var), hex-encoded\n  userAgent = r.Header.Get(&quot;User-Agent&quot;)\n  referer = r.Header.Get(&quot;Referer&quot;)\n  correlationID = r.Header.Get(&quot;X-Correlation-ID&quot;)\n  IF correlationID == &quot;&quot; → correlationID = uuid.New().String()\n  originalURL, err = urlService.Redirect(\n      r.Context(), shortCode, ipHash, userAgent, referer, correlationID,\n  )\n  IF errors.Is(err, ErrURLNotFound) → 404 {&quot;error&quot;:&quot;not found&quot;}\n  IF errors.Is(err, ErrURLExpired) → 410 {&quot;error&quot;:&quot;this link has expired&quot;}\n  IF errors.Is(err, ErrURLInactive) → 410 {&quot;error&quot;:&quot;this link is no longer active&quot;}\n  IF err → 500 {&quot;error&quot;:&quot;internal server error&quot;} + log.Error\n  http.Redirect(w, r, originalURL, http.StatusMovedPermanently)  -- 301\nEND PROCEDURE</code></pre></div>\n<p><strong>§ 6.2.1 Client IP Extraction:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> extractClientIP</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Trust X-Forwarded-For only if set by a trusted proxy (the gateway).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // In local dev, no proxy; use RemoteAddr.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> xff </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> r.Header.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Forwarded-For\"</span><span style=\"color:#E1E4E8\">); xff </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // X-Forwarded-For can be \"client, proxy1, proxy2\"; take leftmost.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        parts </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> strings.</span><span style=\"color:#B392F0\">Split</span><span style=\"color:#E1E4E8\">(xff, </span><span style=\"color:#9ECBFF\">\",\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> strings.</span><span style=\"color:#B392F0\">TrimSpace</span><span style=\"color:#E1E4E8\">(parts[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">])</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    host, _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> net.</span><span style=\"color:#B392F0\">SplitHostPort</span><span style=\"color:#E1E4E8\">(r.RemoteAddr)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> r.RemoteAddr </span><span style=\"color:#6A737D\">// fallback: return as-is</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> host</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> hashIP</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">rawIP</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    salt </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"CLICK_SALT\"</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// if unset, uses empty salt — document in .env.example</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> sha256.</span><span style=\"color:#B392F0\">Sum256</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(rawIP </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> salt))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> hex.</span><span style=\"color:#B392F0\">EncodeToString</span><span style=\"color:#E1E4E8\">(h[:])</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>Why 301 and not 302:</strong> <code>301 Moved Permanently</code> allows browsers and CDNs to cache the redirect, reducing load on the service. If the URL is later deactivated, the Redis DEL and <code>is_active=false</code> handle server-side state, but cached 301s in client browsers will linger. This is an accepted tradeoff for redirect performance. If mutable redirect targets are a concern, use 302 — the spec mandates 301.</p>\n<h3 id=\"63-get-urls-list-handler\">6.3 <code>GET /urls</code> List Handler</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE HandleListURLs(w, r):\n  claims, ok = middleware.ClaimsFromContext(r.Context())\n  IF !ok → 401\n  afterCursor = r.URL.Query().Get(&quot;after&quot;)  -- UUID string or empty\n  pageSizeStr = r.URL.Query().Get(&quot;limit&quot;)\n  pageSize = 20  -- default\n  IF pageSizeStr != &quot;&quot;:\n    pageSize, err = strconv.Atoi(pageSizeStr)\n    IF err OR pageSize &lt; 1 → 400 {&quot;error&quot;:&quot;limit must be a positive integer&quot;}\n  urls, nextCursor, err = urlService.ListURLs(r.Context(), claims.Sub, afterCursor, pageSize)\n  IF err → 500 + log.Error\n  items = make([]URLItem, len(urls))\n  FOR i, u := range urls:\n    items[i] = URLItem{\n        ShortCode:   u.ShortCode,\n        OriginalURL: u.OriginalURL,\n        CreatedAt:   u.CreatedAt.Format(time.RFC3339),\n        IsActive:    u.IsActive,\n    }\n    IF u.ExpiresAt != nil → items[i].ExpiresAt = ptr(u.ExpiresAt.Format(time.RFC3339))\n  var nextCursorStr *string\n  IF nextCursor != nil → nextCursorStr = nextCursor\n  200 URLListResponse{URLs: items, NextCursor: nextCursorStr}\nEND PROCEDURE</code></pre></div>\n<h3 id=\"64-delete-urlscode-handler\">6.4 <code>DELETE /urls/:code</code> Handler</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE HandleDeleteURL(w, r):\n  claims, ok = middleware.ClaimsFromContext(r.Context())\n  IF !ok → 401\n  shortCode = r.PathValue(&quot;code&quot;)\n  IF shortCode == &quot;&quot; → 400\n  correlationID = r.Header.Get(&quot;X-Correlation-ID&quot;)\n  IF correlationID == &quot;&quot; → correlationID = uuid.New().String()\n  err = urlService.Delete(r.Context(), shortCode, claims.Sub, claims.Email, correlationID)\n  IF errors.Is(err, ErrURLNotFound) → 404 {&quot;error&quot;:&quot;not found&quot;}\n  IF errors.Is(err, ErrNotOwner) → 403 {&quot;error&quot;:&quot;forbidden&quot;}\n  IF err → 500 + log.Error\n  w.WriteHeader(http.StatusNoContent)  -- 204; no body\nEND PROCEDURE</code></pre></div>\n<p><strong><code>URLService.Delete</code> logic:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE URLService.Delete(ctx, shortCode, userID, userEmail, correlationID):\n  tx, err = pool.Begin(ctx)\n  IF err → return wrapped\n  DEFER tx.Rollback(ctx)\n  err = urlRepo.SoftDelete(ctx, tx, shortCode, userID)\n  IF ErrURLNotFound OR ErrNotOwner → return as-is (rollback via defer)\n  IF err → return wrapped\n  event = URLDeletedEvent{\n      EventType:     EventTypeURLDeleted,\n      OccurredAt:    time.Now().UTC(),\n      CorrelationID: correlationID,\n      ShortCode:     shortCode,\n      UserID:        userID,\n      UserEmail:     userEmail,\n  }\n  payload, _ = json.Marshal(event)  -- cannot fail for this struct\n  err = outboxRepo.Insert(ctx, tx, event.EventType, payload)\n  IF err → return wrapped (rollback via defer)\n  err = tx.Commit(ctx)\n  IF err → return wrapped\n  -- Cache invalidation: best-effort, after commit.\n  -- Do NOT do this inside the transaction — it is a different store.\n  cache.Del(ctx, shortCode)  // error swallowed inside CacheClient.Del\n  return nil\nEND PROCEDURE</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-18.svg\" alt=\"GET /:code Redirect — Read-Through Cache Data Flow\"></p>\n<hr>\n<h2 id=\"7-error-handling-matrix\">7. Error Handling Matrix</h2>\n<table>\n<thead>\n<tr>\n<th>Error</th>\n<th>Detected By</th>\n<th>HTTP Status</th>\n<th>Response Body</th>\n<th>Logged?</th>\n<th>Notes</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>URL_INVALID</code> (missing scheme/host)</td>\n<td><code>url.Parse</code> in handler</td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;url must include scheme and host&quot;}</code></td>\n<td>No</td>\n<td>Client mistake</td>\n</tr>\n<tr>\n<td><code>URL_INVALID</code> (non-http scheme)</td>\n<td>handler validation</td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;url scheme must be http or https&quot;}</code></td>\n<td>No</td>\n<td></td>\n</tr>\n<tr>\n<td><code>EXPIRES_AT_INVALID</code> (parse fail)</td>\n<td>handler</td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;expires_at must be RFC3339 format&quot;}</code></td>\n<td>No</td>\n<td></td>\n</tr>\n<tr>\n<td><code>EXPIRES_AT_IN_PAST</code></td>\n<td>handler</td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;expires_at must be in the future&quot;}</code></td>\n<td>No</td>\n<td></td>\n</tr>\n<tr>\n<td><code>CUSTOM_CODE_CONFLICT</code></td>\n<td><code>urlRepo.Create</code> → <code>23505</code> + custom code set</td>\n<td>409</td>\n<td><code>{&quot;error&quot;:&quot;short code already taken&quot;}</code></td>\n<td>No</td>\n<td>Expected</td>\n</tr>\n<tr>\n<td><code>CODE_EXHAUSTED</code></td>\n<td><code>URLService.Shorten</code> after 5 retries</td>\n<td>503</td>\n<td><code>{&quot;error&quot;:&quot;could not generate unique code; try again&quot;}</code></td>\n<td>Warn</td>\n<td>Indicates high collision rate</td>\n</tr>\n<tr>\n<td><code>CODE_NOT_FOUND</code></td>\n<td><code>urlRepo.FindByCode</code> → <code>ErrURLNotFound</code></td>\n<td>404</td>\n<td><code>{&quot;error&quot;:&quot;not found&quot;}</code></td>\n<td>No</td>\n<td>Normal</td>\n</tr>\n<tr>\n<td><code>URL_EXPIRED</code></td>\n<td><code>URLService.Redirect</code> expiry check</td>\n<td>410</td>\n<td><code>{&quot;error&quot;:&quot;this link has expired&quot;}</code></td>\n<td>No</td>\n<td></td>\n</tr>\n<tr>\n<td><code>URL_INACTIVE</code></td>\n<td><code>URLService.Redirect</code> active check</td>\n<td>410</td>\n<td><code>{&quot;error&quot;:&quot;this link is no longer active&quot;}</code></td>\n<td>No</td>\n<td></td>\n</tr>\n<tr>\n<td><code>OWNERSHIP_VIOLATION</code></td>\n<td><code>urlRepo.SoftDelete</code> → <code>ErrNotOwner</code></td>\n<td>403</td>\n<td><code>{&quot;error&quot;:&quot;forbidden&quot;}</code></td>\n<td>Warn</td>\n<td>Possible attack</td>\n</tr>\n<tr>\n<td><code>CACHE_ERROR</code> (Redis GET)</td>\n<td><code>redisCacheClient.Get</code></td>\n<td>—</td>\n<td>Transparent; returns <code>ErrCacheMiss</code></td>\n<td>Warn internally</td>\n<td>Never causes 5xx</td>\n</tr>\n<tr>\n<td><code>CACHE_ERROR</code> (Redis SET)</td>\n<td><code>redisCacheClient.Set</code></td>\n<td>—</td>\n<td>Swallowed</td>\n<td>Warn internally</td>\n<td></td>\n</tr>\n<tr>\n<td><code>CACHE_ERROR</code> (Redis DEL)</td>\n<td><code>redisCacheClient.Del</code></td>\n<td>—</td>\n<td>Swallowed</td>\n<td>Warn internally</td>\n<td>Best-effort</td>\n</tr>\n<tr>\n<td><code>OUTBOX_PUBLISH_FAIL</code></td>\n<td><code>amqpPublisher.Publish</code></td>\n<td>—</td>\n<td>No HTTP effect</td>\n<td>Warn in poller</td>\n<td>Row stays unpublished; retried</td>\n</tr>\n<tr>\n<td><code>OUTBOX_MARK_FAIL</code></td>\n<td><code>outboxRepo.MarkPublished</code></td>\n<td>—</td>\n<td>No HTTP effect</td>\n<td>Error in worker</td>\n<td>Row re-published next cycle; consumers must be idempotent</td>\n</tr>\n<tr>\n<td><code>DB_ERROR</code> (unexpected)</td>\n<td>any repo call</td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td><strong>Error</strong></td>\n<td>Never expose details</td>\n</tr>\n<tr>\n<td><code>JWT_MISSING</code></td>\n<td><code>RequireAuth</code> middleware</td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>No</td>\n<td></td>\n</tr>\n<tr>\n<td><code>JWT_INVALID</code></td>\n<td><code>RequireAuth</code> middleware</td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>Warn</td>\n<td></td>\n</tr>\n<tr>\n<td><code>REQUEST_BODY_TOO_LARGE</code></td>\n<td><code>http.MaxBytesReader</code></td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;request body too large&quot;}</code></td>\n<td>No</td>\n<td></td>\n</tr>\n<tr>\n<td><code>AMQP_CHANNEL_CLOSED</code></td>\n<td><code>amqpPublisher.Publish</code></td>\n<td>—</td>\n<td>No HTTP effect</td>\n<td>Warn</td>\n<td>Poller retries next cycle</td>\n</tr>\n<tr>\n<td><code>PORT_BIND_FAIL</code></td>\n<td><code>ListenAndServe</code></td>\n<td>—</td>\n<td>Container exits</td>\n<td>Fatal</td>\n<td></td>\n</tr>\n<tr>\n<td><strong>Consistent error response helper:</strong></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handler/helpers.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> writeError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">status</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">msg</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    writeJSON</span><span style=\"color:#E1E4E8\">(w, status, </span><span style=\"color:#B392F0\">ErrorResponse</span><span style=\"color:#E1E4E8\">{Error: msg})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> writeJSON</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">status</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">v</span><span style=\"color:#B392F0\"> any</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _ </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">NewEncoder</span><span style=\"color:#E1E4E8\">(w).</span><span style=\"color:#B392F0\">Encode</span><span style=\"color:#E1E4E8\">(v)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<hr>\n<h2 id=\"8-route-registration-in-maingo\">8. Route Registration in <code>main.go</code></h2>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/url-service/main.go (route wiring)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">verifier </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> auth.</span><span style=\"color:#B392F0\">NewJWTVerifier</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">mustGetEnv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"JWT_SECRET\"</span><span style=\"color:#E1E4E8\">)))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">requireAuth </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> middleware.</span><span style=\"color:#B392F0\">RequireAuth</span><span style=\"color:#E1E4E8\">(verifier, log)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">NewServeMux</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Public routes</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /health\"</span><span style=\"color:#E1E4E8\">,    handler.</span><span style=\"color:#B392F0\">NewHealthHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">, log))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /{code}\"</span><span style=\"color:#E1E4E8\">,    handler.</span><span style=\"color:#B392F0\">NewRedirectHandler</span><span style=\"color:#E1E4E8\">(urlSvc, log))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Protected routes</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST /shorten\"</span><span style=\"color:#E1E4E8\">,       </span><span style=\"color:#B392F0\">requireAuth</span><span style=\"color:#E1E4E8\">(http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(handler.</span><span style=\"color:#B392F0\">NewShortenHandler</span><span style=\"color:#E1E4E8\">(urlSvc, baseURL, log))))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /urls\"</span><span style=\"color:#E1E4E8\">,           </span><span style=\"color:#B392F0\">requireAuth</span><span style=\"color:#E1E4E8\">(http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(handler.</span><span style=\"color:#B392F0\">NewListURLsHandler</span><span style=\"color:#E1E4E8\">(urlSvc, log))))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DELETE /urls/{code}\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">requireAuth</span><span style=\"color:#E1E4E8\">(http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(handler.</span><span style=\"color:#B392F0\">NewDeleteURLHandler</span><span style=\"color:#E1E4E8\">(urlSvc, log))))</span></span></code></pre></div>\n<p><strong>Pattern ordering note:</strong> <code>GET /{code}</code> is a wildcard catch-all. In Go 1.22+ <code>net/http</code>, more specific patterns take priority. <code>GET /health</code> and <code>GET /urls</code> are more specific and will match first. <code>GET /{code}</code> will only match paths that do not match any more specific pattern. Register more specific patterns before the wildcard.</p>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-19.svg\" alt=\"Redis Cache Key Layout\"></p>\n<hr>\n<h2 id=\"9-concurrency-specification\">9. Concurrency Specification</h2>\n<h3 id=\"91-http-handler-goroutines\">9.1 HTTP Handler Goroutines</h3>\n<p>Each request runs in its own goroutine created by <code>net/http</code>. <code>URLService</code> is stateless (all state is in the PostgreSQL pool and Redis client, which are goroutine-safe). No shared mutable state exists in handlers or service layer. <code>pgxpool.Pool</code> is goroutine-safe per pgx documentation.</p>\n<h3 id=\"92-outbox-worker-pool\">9.2 Outbox Worker Pool</h3>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Goroutine Count</th>\n<th>Shared State</th>\n<th>Protection</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Coordinator</td>\n<td>1</td>\n<td><code>jobChan</code>, <code>outboxRepo</code></td>\n<td>Channel send is goroutine-safe; <code>outboxRepo</code> uses pool</td>\n</tr>\n<tr>\n<td>Workers</td>\n<td>3</td>\n<td><code>jobChan</code>, <code>outboxRepo</code>, <code>publisher</code></td>\n<td>Channel receive is goroutine-safe; <code>amqpPublisher</code> uses <code>sync.Mutex</code></td>\n</tr>\n<tr>\n<td><code>amqpPublisher</code></td>\n<td>—</td>\n<td><code>*amqp091.Channel</code></td>\n<td><code>sync.Mutex</code> serializes concurrent Publish calls</td>\n</tr>\n<tr>\n<td><strong>Goroutine lifecycle:</strong> All goroutines receive a <code>context.Context</code> derived from <code>context.WithCancel</code>. On <code>SIGTERM</code>, <code>main.go</code> calls the cancel function. The coordinator&#39;s <code>select</code> on <code>ctx.Done()</code> causes it to <code>close(jobChan)</code> and return. Workers drain the closed channel (range over closed channel yields remaining items, then exits). This provides a graceful drain: already-queued jobs are published before shutdown.</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// main.go shutdown sequence</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">ctx, cancel </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithCancel</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">defer</span><span style=\"color:#B392F0\"> cancel</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">sigCh </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">chan</span><span style=\"color:#B392F0\"> os</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Signal</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">signal.</span><span style=\"color:#B392F0\">Notify</span><span style=\"color:#E1E4E8\">(sigCh, syscall.SIGTERM, syscall.SIGINT)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">go</span><span style=\"color:#E1E4E8\"> poller.</span><span style=\"color:#B392F0\">Start</span><span style=\"color:#E1E4E8\">(ctx) </span><span style=\"color:#6A737D\">// starts coordinator + 3 workers</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">&#x3C;-</span><span style=\"color:#E1E4E8\">sigCh</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Msg</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"shutdown signal received\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">cancel</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#6A737D\">// signals coordinator and workers to stop</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Give workers up to 10s to drain the channel and finish in-flight publishes.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">shutdownCtx, shutdownCancel </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithTimeout</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">defer</span><span style=\"color:#B392F0\"> shutdownCancel</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">server.</span><span style=\"color:#B392F0\">Shutdown</span><span style=\"color:#E1E4E8\">(shutdownCtx)</span></span></code></pre></div>\n<h3 id=\"93-cache-aside-read-safety\">9.3 Cache-Aside Read Safety</h3>\n<p>Multiple concurrent redirect handlers may simultaneously experience a cache miss for the same short code. Each will independently query PostgreSQL and then call <code>cache.Set</code>. This is safe:</p>\n<ul>\n<li>PostgreSQL reads are non-mutating (SELECT); no locking needed.</li>\n<li>Concurrent <code>cache.Set</code> calls for the same key result in idempotent SET operations (last writer wins, which is acceptable — all writers have the same data from the DB).</li>\n<li>No &quot;thundering herd&quot; mitigation is implemented; at the scale of this project it is unnecessary.</li>\n</ul>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-20.svg\" alt=\"Outbox Worker Pool Architecture + Data Flow\"></p>\n<hr>\n<h2 id=\"10-implementation-sequence-with-checkpoints\">10. Implementation Sequence with Checkpoints</h2>\n<h3 id=\"phase-1-schema-migrations-indexes-115-hr\">Phase 1 — Schema Migrations + Indexes (1–1.5 hr)</h3>\n<ol>\n<li>Write <code>migrations/001_create_urls.sql</code> and <code>migrations/002_create_outbox.sql</code>.</li>\n<li>Apply migrations: <code>docker exec -i url_db psql -U url_user -d url_db &lt; services/url-service/migrations/001_create_urls.sql</code></li>\n<li>Apply: <code>docker exec -i url_db psql -U url_user -d url_db &lt; services/url-service/migrations/002_create_outbox.sql</code></li>\n<li>Verify schema: <code>docker exec url_db psql -U url_user -d url_db -c &quot;\\d urls&quot;</code> and <code>&quot;\\d outbox&quot;</code>.</li>\n<li>Verify indexes: <code>docker exec url_db psql -U url_user -d url_db -c &quot;\\di&quot;</code> — expect <code>idx_urls_short_code</code>, <code>idx_urls_user_id_created</code>, <code>idx_outbox_unpublished</code>.\n<strong>Checkpoint:</strong> Both tables exist with correct column types and NOT NULL constraints. Indexes are visible in <code>\\di</code>. <code>EXPLAIN SELECT * FROM urls WHERE short_code = &#39;abc&#39;</code> shows <code>Index Scan</code> on <code>idx_urls_short_code</code>.</li>\n</ol>\n<h3 id=\"phase-2-base62-code-generator-115-hr\">Phase 2 — Base62 Code Generator (1–1.5 hr)</h3>\n<ol>\n<li>Add <code>github.com/google/uuid v1.6.0</code> to <code>go.mod</code> (already needed in M2; verify it&#39;s present).</li>\n<li>Write <code>codegen/codegen.go</code> with <code>base62Alphabet</code>, <code>codeLength</code>, <code>base62Generator</code>, <code>Generate()</code>.</li>\n<li>Write <code>codegen/codegen_test.go</code> (§ 11 tests).</li>\n<li>Run <code>go test ./codegen/... -v -count=1</code>.\n<strong>Checkpoint:</strong> <code>TestGenerate_Length</code> passes (output is always 7 chars). <code>TestGenerate_Base62Alphabet</code> passes (all chars in <code>base62Alphabet</code>). <code>TestGenerate_Randomness</code> passes (1000 calls produce no duplicates with &gt;99.999% probability). <code>TestGenerate_NoCryptoMathRand</code> passes — verify source code import: <code>grep &quot;math/rand&quot; codegen/codegen.go</code> returns nothing.</li>\n</ol>\n<h3 id=\"phase-3-urlrepository-outboxrepository-152-hr\">Phase 3 — URLRepository + OutboxRepository (1.5–2 hr)</h3>\n<ol>\n<li>Write <code>repository/url_repository.go</code>: <code>URL</code>, <code>URLSummary</code>, sentinel errors, <code>URLRepository</code> interface, <code>pgxURLRepository</code>, all four methods.</li>\n<li>Write <code>repository/outbox_repository.go</code>: <code>OutboxEntry</code>, <code>OutboxRepository</code> interface, <code>pgxOutboxRepository</code>, three methods.</li>\n<li>Write <code>repository/url_repository_test.go</code> and <code>repository/outbox_repository_test.go</code>.</li>\n<li>Run <code>go test -tags integration ./repository/... -v</code>.\n<strong>Checkpoint:</strong> <code>TestCreate_HappyPath</code> inserts a URL and finds it by code. <code>TestCreate_CodeConflict</code> returns <code>ErrCodeConflict</code>. <code>TestSoftDelete_WrongOwner</code> returns <code>ErrNotOwner</code>. <code>TestListByUser_Cursor</code> returns second page when <code>afterID</code> is set. <code>EXPLAIN ANALYZE</code> on <code>ListByUser</code> SQL shows <code>Index Scan</code> on <code>idx_urls_user_id_created</code> (no sequential scan).</li>\n</ol>\n<h3 id=\"phase-4-redis-cacheclient-115-hr\">Phase 4 — Redis CacheClient (1–1.5 hr)</h3>\n<ol>\n<li>Write <code>cache/cache.go</code>: <code>CachedURL</code>, <code>RedisKey</code>, <code>CacheClient</code> interface, <code>redisCacheClient</code>, <code>Get</code>/<code>Set</code>/<code>Del</code>, nil-safety in every method.</li>\n<li>Write <code>cache/cache_test.go</code>.</li>\n<li>Run <code>go test ./cache/... -v</code> (unit tests use a mock or real Redis depending on tag).\n<strong>Checkpoint:</strong> <code>TestGet_CacheMiss_ReturnsErrCacheMiss</code> passes. <code>TestGet_NilClient_NoPanic</code> passes (nil <code>*redis.Client</code> returns <code>ErrCacheMiss</code>, no panic). <code>TestSet_TTLApplied</code> verifies the key has a TTL via <code>redis-cli TTL url:testcode</code>. <code>TestDel_KeyRemoved</code> verifies key is gone after <code>Del</code>. <code>TestComputeTTL_CappedAt1Hour</code> verifies <code>min(expires_at, 1h)</code> logic.</li>\n</ol>\n<h3 id=\"phase-5-post-shorten-delete-urlscode-handlers-152-hr\">Phase 5 — POST /shorten + DELETE /urls/:code Handlers (1.5–2 hr)</h3>\n<ol>\n<li>Write <code>service/url_service.go</code>: <code>URLService</code> struct, <code>NewURLService</code>, <code>Shorten</code>, <code>Delete</code> (stubs for <code>Redirect</code> and <code>ListURLs</code> — return <code>nil, ErrURLNotFound</code> temporarily).</li>\n<li>Write <code>handler/helpers.go</code>: <code>writeJSON</code>, <code>writeError</code>, <code>extractClientIP</code>, <code>hashIP</code>, <code>ptr</code> helper.</li>\n<li>Write <code>handler/shorten.go</code>: <code>NewShortenHandler</code>.</li>\n<li>Write <code>handler/delete.go</code>: <code>NewDeleteURLHandler</code>.</li>\n<li>Wire in <code>main.go</code>: construct all dependencies, register routes.</li>\n<li>Run <code>docker compose up --build url-service</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Register a user first (user-service must be running)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8083/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> .token</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Shorten</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8081/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://www.example.com/very/long/path\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> .</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"short_code\":\"&#x3C;7chars>\",\"short_url\":\"http://localhost:8081/&#x3C;code>\",\"original_url\":\"...\"}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Duplicate custom code</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8081/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://example.org\",\"custom_code\":\"&#x3C;same_code>\"}'</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 409</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Delete</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> DELETE</span><span style=\"color:#9ECBFF\"> http://localhost:8081/urls/</span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#9ECBFF\">cod</span><span style=\"color:#E1E4E8\">e</span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 204</span></span></code></pre></div>\n<h3 id=\"phase-6-get-code-redirect-152-hr\">Phase 6 — GET /:code Redirect (1.5–2 hr)</h3>\n<ol>\n<li>Implement <code>URLService.Redirect</code> in <code>service/url_service.go</code> (§ 5.4).</li>\n<li>Write <code>handler/redirect.go</code>: <code>NewRedirectHandler</code>.</li>\n<li>Register <code>GET /{code}</code> in <code>main.go</code>.</li>\n<li>Run <code>docker compose up --build url-service</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">CODE</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8081/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://www.google.com\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> .short_code</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Redirect (follow → expect google.com)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#9ECBFF\"> \"http://localhost:8081/</span><span style=\"color:#E1E4E8\">$CODE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> 2>&#x26;1</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#9ECBFF\"> \"&#x3C; HTTP\\|&#x3C; Location\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: HTTP/1.1 301, Location: https://www.google.com</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Cache hit (second request)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#9ECBFF\"> \"http://localhost:8081/</span><span style=\"color:#E1E4E8\">$CODE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> 2>&#x26;1</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#9ECBFF\"> \"&#x3C; HTTP\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Redis: redis-cli GET \"url:$CODE\" → returns JSON</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Non-existent code</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#9ECBFF\"> \"http://localhost:8081/ZZZZZZZ\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 404</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Run benchmark</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#79B8FF\"> -bench=BenchmarkRedirectCacheHit</span><span style=\"color:#79B8FF\"> -benchtime=10s</span><span style=\"color:#9ECBFF\"> ./handler/...</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Target: &#x3C; 5ms p99 at 100 concurrent (see § 9 for benchmark setup)</span></span></code></pre></div>\n<h3 id=\"phase-7-get-urls-cursor-pagination-115-hr\">Phase 7 — GET /urls Cursor Pagination (1–1.5 hr)</h3>\n<ol>\n<li>Implement <code>URLService.ListURLs</code> in <code>service/url_service.go</code> (§ 5.6).</li>\n<li>Write <code>handler/list.go</code>: <code>NewListURLsHandler</code>.</li>\n<li>Register <code>GET /urls</code> in <code>main.go</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Create 5 URLs</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> {</span><span style=\"color:#B392F0\">1..5}</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8081/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    -d</span><span style=\"color:#9ECBFF\"> \"{</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">url</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">https://example.com/</span><span style=\"color:#E1E4E8\">$i</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">}\"</span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> /dev/null</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">done</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># First page (limit=2)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">RESP</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> \"http://localhost:8081/urls?limit=2\"</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#E1E4E8\"> $RESP </span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> '.urls | length'</span><span style=\"color:#6A737D\">  # Expected: 2</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">CURSOR</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#79B8FF\">echo</span><span style=\"color:#E1E4E8\"> $RESP </span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> '.next_cursor'</span><span style=\"color:#E1E4E8\">)  </span><span style=\"color:#6A737D\"># non-null</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Second page</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> \"http://localhost:8081/urls?limit=2&#x26;after=</span><span style=\"color:#E1E4E8\">$CURSOR</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> '.urls | length'</span><span style=\"color:#6A737D\">  # Expected: 2</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify no seq scan</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#9ECBFF\"> url_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> url_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> url_db</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  \"EXPLAIN SELECT id, short_code FROM urls WHERE user_id = 'some-uuid' ORDER BY created_at DESC LIMIT 3;\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Must show \"Index Scan\" not \"Seq Scan\"</span></span></code></pre></div>\n<h3 id=\"phase-8-outbox-worker-pool-amqppublisher-225-hr\">Phase 8 — Outbox Worker Pool + AMQPPublisher (2–2.5 hr)</h3>\n<ol>\n<li>Write <code>amqp/publisher.go</code>: <code>AMQPPublisher</code> interface, <code>amqpPublisher</code> with <code>sync.Mutex</code>, <code>Publish</code>.</li>\n<li>Write <code>outbox/poller.go</code>: <code>OutboxPoller</code> struct, <code>Start(ctx context.Context)</code> (launches coordinator + 3 workers).</li>\n<li>Wire poller in <code>main.go</code>: construct <code>AMQPPublisher</code>, construct <code>OutboxPoller</code>, call <code>go poller.Start(ctx)</code>.</li>\n<li>Run <code>docker compose up --build url-service</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Create a URL (writes outbox row)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8081/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://www.rabbitmq-test.com\"}'</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Wait 3 seconds for poller cycle</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 3</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify outbox row is marked published</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#9ECBFF\"> url_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> url_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> url_db</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  \"SELECT event_type, published_at FROM outbox ORDER BY created_at DESC LIMIT 1;\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: published_at IS NOT NULL</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify message in RabbitMQ management UI:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># http://localhost:15672 → Queues → notifications.events → Get Messages</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Should see URLCreatedEvent payload</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Test RabbitMQ down: stop broker, create URL, verify service stays healthy</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> stop</span><span style=\"color:#9ECBFF\"> rabbitmq</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8081/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://resilience-test.com\"}'</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 201 (not 503)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> start</span><span style=\"color:#9ECBFF\"> rabbitmq</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 15</span><span style=\"color:#6A737D\">  # reconnect + poll cycle</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#9ECBFF\"> url_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> url_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> url_db</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  \"SELECT count(*) FROM outbox WHERE published_at IS NULL;\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 0</span></span></code></pre></div>\n<h3 id=\"phase-9-unit-tests-benchmarks-115-hr\">Phase 9 — Unit Tests + Benchmarks (1–1.5 hr)</h3>\n<ol>\n<li>Write all test files from § 11.</li>\n<li>Run <code>go test ./... -v -count=1</code>.</li>\n<li>Run benchmarks: <code>go test -bench=. -benchmem ./...</code>.\n<strong>Checkpoint:</strong> All tests pass. <code>BenchmarkRedirectCacheHit</code> shows p99 &lt; 5ms at 100 concurrent. <code>BenchmarkRedirectCacheMiss</code> shows p99 &lt; 20ms. <code>go vet ./...</code> clean. <code>go test -race ./...</code> clean (no race conditions).</li>\n</ol>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-21.svg\" alt=\"Outbox Poller State Machine\"></p>\n<hr>\n<h2 id=\"11-test-specification\">11. Test Specification</h2>\n<h3 id=\"111-codegencodegen_testgo\">11.1 <code>codegen/codegen_test.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// TestGenerate_Length: Generate() always returns exactly 7 characters.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Run 1000 times; assert len(code) == 7 for all.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGenerate_Length</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGenerate_Base62Alphabet: every character in generated code is in base62Alphabet.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Run 1000 times; assert each char exists in the alphabet string.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGenerate_Base62Alphabet</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGenerate_Randomness: 1000 consecutive calls produce no duplicates.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Failure probability: 62^7 = 3.5 trillion; collision among 1000 is negligible.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGenerate_Randomness</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGenerate_NotMathRand: verify crypto/rand is used.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Indirect test: seed math/rand with a fixed seed; if codes match the seeded sequence,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// math/rand is being used (fail). This is a code review check, not runtime check —</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// document in test comment that the import list must not contain \"math/rand\".</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGenerate_NoMathRandImport</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// parse AST or grep imports</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGenerate_CollisionRetryIn_URLService:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Inject a mock CodeGenerator that returns the same code for the first 4 calls,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// then a unique code on the 5th. Verify URLService.Shorten succeeds with 5th code.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShorten_CollisionRetry</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestShorten_CollisionExhausted:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Inject a mock CodeGenerator that always returns the same code (DB always rejects).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify URLService.Shorten returns ErrExhausted after 5 attempts.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShorten_CollisionExhausted</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// BenchmarkGenerate: measure throughput.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Expected: > 100,000 Generate() calls/sec (pure in-memory; should be fast).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkGenerate</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"112-repositoryurl_repository_testgo-integration\">11.2 <code>repository/url_repository_test.go</code> (integration)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Build tag: //go:build integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Requires: url_db running. DSN from TEST_DATABASE_DSN env var.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCreate_HappyPath: create URL → FindByCode returns same data.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCreate_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCreate_CodeConflict: create two URLs with same short_code → second returns ErrCodeConflict.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCreate_CodeConflict</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCreate_InTransaction_RollbackOnError:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Begin tx, Create URL, DON'T commit. In separate connection, FindByCode → ErrURLNotFound.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verifies that uncommitted tx is not visible.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCreate_InTransaction_RollbackOnError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestFindByCode_NotFound: ErrURLNotFound for unknown code.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestFindByCode_NotFound</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestSoftDelete_HappyPath: SoftDelete sets is_active=false; FindByCode returns is_active=false.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestSoftDelete_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestSoftDelete_WrongOwner: SoftDelete with wrong userID returns ErrNotOwner.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestSoftDelete_WrongOwner</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestSoftDelete_NotFound: SoftDelete on non-existent code returns ErrURLNotFound.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestSoftDelete_NotFound</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestListByUser_EmptyCursor: first page returns newest-first order.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestListByUser_EmptyCursor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestListByUser_WithCursor: second page starts after cursor row.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestListByUser_WithCursor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestListByUser_UsesIndex: EXPLAIN on the query must not contain \"Seq Scan\".</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Use pgx to execute EXPLAIN and assert output.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestListByUser_UsesIndex</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"113-repositoryoutbox_repository_testgo-integration\">11.3 <code>repository/outbox_repository_test.go</code> (integration)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// TestInsert_HappyPath: Insert outbox row in tx, commit, FetchUnpublished returns it.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestInsert_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestInsert_RollsBackWithCaller: Insert in tx, rollback → FetchUnpublished returns empty.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestInsert_RollsBackWithCaller</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestFetchUnpublished_Limit: Insert 60 rows, FetchUnpublished(50) returns exactly 50.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestFetchUnpublished_Limit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestMarkPublished_IdempotentOnDouble: call MarkPublished twice on same ID → no error.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestMarkPublished_IdempotentOnDouble</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestFetchUnpublished_ExcludesPublished: published rows not returned.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestFetchUnpublished_ExcludesPublished</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"114-cachecache_testgo\">11.4 <code>cache/cache_test.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Unit tests using a real Redis (TEST_REDIS_ADDR) or mock; nil-client tests are pure unit.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGet_NilClient_ReturnsMiss: nil *redis.Client → ErrCacheMiss, no panic.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGet_NilClient_ReturnsMiss</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestSet_NilClient_NoOp: nil *redis.Client → Set returns without panic.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestSet_NilClient_NoOp</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestDel_NilClient_NoOp: nil *redis.Client → Del returns without panic.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDel_NilClient_NoOp</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGet_Miss_ReturnsErrCacheMiss: key not in Redis → ErrCacheMiss.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGet_Miss_ReturnsErrCacheMiss</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestSetGet_RoundTrip: Set then Get returns same CachedURL.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestSetGet_RoundTrip</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestSet_TTLApplied: after Set, redis-cli TTL shows positive value ≤ requested TTL.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestSet_TTLApplied</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestDel_RemovesKey: Set then Del → Get returns ErrCacheMiss.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDel_RemovesKey</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestComputeTTL_NoExpiry: expiresAt=nil → returns 1h.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestComputeTTL_NoExpiry</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestComputeTTL_ExpiryWithin1h: expiresAt=30min from now → returns ~30min.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestComputeTTL_ExpiryWithin1h</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestComputeTTL_ExpiryBeyond1h: expiresAt=2h from now → returns 1h.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestComputeTTL_ExpiryBeyond1h</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestComputeTTL_AlreadyExpired: expiresAt=past → returns 1s (defensive).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestComputeTTL_AlreadyExpired</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"115-handlerhandler_testgo-integration-unit\">11.5 <code>handler/handler_test.go</code> (integration + unit)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Unit tests use httptest.NewRecorder + httptest.NewRequest.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Integration tests tag: //go:build integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestShorten_HappyPath: valid JWT + valid URL → 201, short_code is 7-char base62.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShorten_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestShorten_NoAuth: missing Authorization → 401.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShorten_NoAuth</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestShorten_InvalidURL_MissingScheme: \"example.com\" (no https://) → 400.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShorten_InvalidURL_MissingScheme</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestShorten_ExpiresAtPast: expires_at in past → 400.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShorten_ExpiresAtPast</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRedirect_CacheHit: set key in Redis, GET /:code → 301, Location matches.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedirect_CacheHit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRedirect_CacheMiss_DBFallback: no Redis key, URL in DB → 301, Redis populated.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedirect_CacheMiss_DBFallback</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRedirect_NotFound: unknown code → 404.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedirect_NotFound</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRedirect_Expired: expires_at in past → 410.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedirect_Expired</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRedirect_Inactive: is_active=false → 410.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedirect_Inactive</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestDelete_HappyPath: owner deletes URL → 204, Redis key gone.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDelete_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestDelete_WrongOwner: different JWT sub → 403.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDelete_WrongOwner</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestDelete_NotFound: non-existent code → 404.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDelete_NotFound</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestListURLs_Pagination: create 5, page by 2, verify cursor chain covers all 5.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestListURLs_Pagination</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// BenchmarkRedirectCacheHit: serve redirect from Redis cache at 100 concurrent.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Uses httptest.Server with a pre-seeded Redis entry.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Assert: p99 latency &#x3C; 5ms.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkRedirectCacheHit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// BenchmarkRedirectCacheMiss: serve redirect from PostgreSQL (Redis disabled).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Assert: p99 latency &#x3C; 20ms.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkRedirectCacheMiss</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong>Benchmark implementation sketch:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkRedirectCacheHit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Setup: real Redis with seeded URL entry, real DB with URL row.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Use httptest.NewServer with the handler under test.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    srv </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewServer</span><span style=\"color:#E1E4E8\">(handler.</span><span style=\"color:#B392F0\">NewRedirectHandler</span><span style=\"color:#E1E4E8\">(urlSvc, log))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> srv.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b.</span><span style=\"color:#B392F0\">ResetTimer</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b.</span><span style=\"color:#B392F0\">SetParallelism</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b.</span><span style=\"color:#B392F0\">RunParallel</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pb</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">PB</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        for</span><span style=\"color:#E1E4E8\"> pb.</span><span style=\"color:#B392F0\">Next</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            resp, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(srv.URL </span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\"> \"/\"</span><span style=\"color:#F97583\"> +</span><span style=\"color:#E1E4E8\"> seededCode)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { b.</span><span style=\"color:#B392F0\">Fatal</span><span style=\"color:#E1E4E8\">(err) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            resp.Body.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> resp.StatusCode </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> http.StatusMovedPermanently {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                b.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"unexpected status: </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, resp.StatusCode)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Use b.ReportMetric to record p99 if using a custom histogram.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-22.svg\" alt=\"Cursor-Based Pagination Algorithm for GET /urls\"></p>\n<hr>\n<h2 id=\"12-environment-variable-reference\">12. Environment Variable Reference</h2>\n<table>\n<thead>\n<tr>\n<th>Variable</th>\n<th>Required</th>\n<th>Example</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>PORT</code></td>\n<td>Yes</td>\n<td><code>8081</code></td>\n<td>HTTP listen port</td>\n</tr>\n<tr>\n<td><code>SERVICE_NAME</code></td>\n<td>Yes</td>\n<td><code>url-service</code></td>\n<td>Embedded in log lines</td>\n</tr>\n<tr>\n<td><code>DATABASE_DSN</code></td>\n<td>Yes</td>\n<td><code>postgres://url_user:url_secret@url_db:5432/url_db?sslmode=disable</code></td>\n<td>PostgreSQL connection</td>\n</tr>\n<tr>\n<td><code>REDIS_ADDR</code></td>\n<td>Yes</td>\n<td><code>redis:6379</code></td>\n<td>Redis address; unavailability is non-fatal</td>\n</tr>\n<tr>\n<td><code>RABBITMQ_URL</code></td>\n<td>Yes</td>\n<td><code>amqp://admin:admin@rabbitmq:5672/</code></td>\n<td>AMQP broker</td>\n</tr>\n<tr>\n<td><code>JWT_SECRET</code></td>\n<td>Yes</td>\n<td><code>change-me-32-bytes-minimum!!!!!!</code></td>\n<td>JWT verification (not signing — url-service never issues tokens)</td>\n</tr>\n<tr>\n<td><code>BASE_URL</code></td>\n<td>Yes</td>\n<td><code>http://localhost:8081</code></td>\n<td>Prepended to short_code in API response <code>short_url</code></td>\n</tr>\n<tr>\n<td><code>CLICK_SALT</code></td>\n<td>No</td>\n<td><code>random-salt-value</code></td>\n<td>Salt for IP hashing. Empty string if unset — document in <code>.env.example</code></td>\n</tr>\n<tr>\n<td><strong><code>BASE_URL</code> in production</strong> would be the public domain (e.g., <code>https://short.example.com</code>). In docker-compose it is the gateway&#39;s public URL. For this milestone, use the service&#39;s own URL; update to the gateway URL in M5.</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td><strong>Add to <code>docker-compose.yml</code></strong> for url-service:</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">yaml</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#85E89D\">environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  JWT_SECRET</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"change-me-to-at-least-32-random-bytes\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  BASE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"http://localhost:8081\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  CLICK_SALT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"replace-with-random-value\"</span></span></code></pre></div>\n<hr>\n<h2 id=\"13-performance-targets\">13. Performance Targets</h2>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Target</th>\n<th>How to Measure</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>GET /:code</code> cache hit p99</td>\n<td>&lt; 5ms</td>\n<td><code>go test -bench=BenchmarkRedirectCacheHit -benchtime=30s ./handler/...</code> at 100 parallel</td>\n</tr>\n<tr>\n<td><code>GET /:code</code> cache miss p99</td>\n<td>&lt; 20ms</td>\n<td><code>go test -bench=BenchmarkRedirectCacheMiss -benchtime=30s ./handler/...</code></td>\n</tr>\n<tr>\n<td><code>POST /shorten</code> p99</td>\n<td>&lt; 50ms</td>\n<td><code>wrk -t4 -c20 -d30s -s shorten.lua http://localhost:8081/shorten</code></td>\n</tr>\n<tr>\n<td>Outbox poll lag (write → publish)</td>\n<td>&lt; 4s</td>\n<td>Create URL, measure time until <code>published_at IS NOT NULL</code> in DB</td>\n</tr>\n<tr>\n<td><code>codegen.Generate()</code> throughput</td>\n<td>&gt; 100,000/sec</td>\n<td><code>go test -bench=BenchmarkGenerate ./codegen/...</code></td>\n</tr>\n<tr>\n<td><code>ListURLs</code> cursor query</td>\n<td>No seq scan</td>\n<td><code>EXPLAIN ANALYZE</code> on list query; assert <code>Index Scan</code> on <code>idx_urls_user_id_created</code></td>\n</tr>\n<tr>\n<td><code>GET /urls</code> p99 (20-item page)</td>\n<td>&lt; 15ms</td>\n<td><code>wrk -t2 -c10 -d10s</code> with valid JWT</td>\n</tr>\n<tr>\n<td>Container image size</td>\n<td>&lt; 20MB</td>\n<td><code>docker image ls url-service</code></td>\n</tr>\n<tr>\n<td><code>go build ./...</code> incremental</td>\n<td>&lt; 10s</td>\n<td>CI warm build</td>\n</tr>\n<tr>\n<td>Outbox worker pool drain on shutdown</td>\n<td>&lt; 10s</td>\n<td>Send SIGTERM; measure time until in-flight jobs complete</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"14-anti-pattern-guard-rail-checklist\">14. Anti-Pattern Guard Rail Checklist</h2>\n<p>Before completing this milestone, verify:</p>\n<ul>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>No synchronous call to analytics-service or notification-service.</strong> <code>grep -r &quot;analytics-service\\|notification-service&quot; services/url-service/</code> returns nothing except comments.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>No shared database.</strong> <code>services/url-service/</code> contains zero references to <code>analytics_db</code>, <code>user_db</code>, or <code>notification_db</code> connection strings.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong><code>math/rand</code> is not imported.</strong> <code>grep -r &#39;&quot;math/rand&quot;&#39; services/url-service/codegen/</code> returns nothing. Only <code>crypto/rand</code> is used.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>No dual-write (URL insert and outbox insert in separate transactions).</strong> The <code>createURLWithOutbox</code> function calls <code>pool.Begin</code> once and passes the same <code>pgx.Tx</code> to both <code>urlRepo.Create</code> and <code>outboxRepo.Insert</code>.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Redis error never causes 5xx.</strong> <code>CacheClient.Get</code> returns <code>ErrCacheMiss</code> (not a real error) for all Redis failures. Handlers treat <code>ErrCacheMiss</code> as a DB-fallback signal.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong><code>expires_at</code> TTL applied to Redis entries.</strong> <code>cache.Set</code> is never called with <code>ttl=0</code> or a negative duration. <code>computeTTL</code> returns at minimum <code>1 * time.Second</code>.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Cache invalidated on DELETE.</strong> <code>URLService.Delete</code> calls <code>cache.Del</code> after <code>tx.Commit</code>. Order is: commit → invalidate (never invalidate before commit; that would create a window where the DB has the old state and the cache is empty, causing a stale repopulation).</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Ownership check on DELETE.</strong> <code>urlRepo.SoftDelete</code> accepts <code>ownerID</code> and returns <code>ErrNotOwner</code> if mismatch. The handler maps this to 403.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Worker pool, not a single goroutine.</strong> <code>outbox/poller.go</code> starts exactly 3 worker goroutines. Verify with <code>grep &quot;go outboxWorker&quot; outbox/poller.go</code> → 3 calls in a loop.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>No outbox polling with <code>time.Sleep</code> in workers.</strong> Workers block on <code>range jobChan</code>. Only the coordinator uses <code>time.After(2s)</code>. Workers have no sleep/timer.</li>\n</ul>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-23.svg\" alt=\"DELETE /urls/:code Sequence — Ownership Check + Cache Invalidation\"></p>\n<hr>\n<!-- END_TDD_MOD -->\n\n\n<!-- TDD_MOD_ID: url-shortener-m4 -->\n<h1 id=\"technical-design-specification\">Technical Design Specification</h1>\n<h2 id=\"module-analytics-service-click-ingestion-stats-api\">Module: Analytics Service — Click Ingestion + Stats API</h2>\n<h2 id=\"module-id-url-shortener-m4\"><strong>Module ID:</strong> <code>url-shortener-m4</code></h2>\n<h2 id=\"1-module-charter\">1. Module Charter</h2>\n<p>The Analytics Service is a pure downstream consumer within the URL shortener system. It ingests <code>URLClickedEvent</code> messages from the RabbitMQ queue <code>analytics.clicks</code>, stores privacy-preserving click records in its private PostgreSQL database, detects click milestone thresholds (10, 100, 1000), and exposes a read-only HTTP stats API. It is the exclusive owner of the <code>analytics_db</code> PostgreSQL instance — no other service reads or writes to it.\nThis module does <strong>not</strong> call the URL Service to validate short codes. It does <strong>not</strong> call the User Service to resolve user identities. It does <strong>not</strong> share any database schema with any other service. It does <strong>not</strong> issue JWTs or perform authentication — the stats API (<code>GET /stats/:code</code>) is intentionally public with no auth requirement per the project spec. It does <strong>not</strong> implement fan-out reads, materialized views, or any form of caching for stats queries (indexed PostgreSQL queries are sufficient at this scale).\n<strong>Upstream dependencies:</strong> M1 foundation (Docker Compose stack, <code>shared/events</code>, <code>shared/logger</code>); RabbitMQ exchange <code>url-shortener</code> (topic) declared by url-service (M3). The <code>analytics.clicks</code> queue is declared and bound by this service&#39;s own startup code — the consumer is responsible for its own queue declaration. The <code>MilestoneReachedEvent</code> struct is defined in <code>shared/events</code> (M1).\n<strong>Downstream dependencies:</strong> notification-service (M5) consumes <code>MilestoneReachedEvent</code> published by this service. No other service depends on analytics-service at runtime.\n<strong>Invariants that must always hold after this milestone:</strong></p>\n<ul>\n<li>A <code>URLClickedEvent</code> with a given <code>EventID</code> is inserted into the <code>clicks</code> table at most once, regardless of how many times RabbitMQ delivers it. The <code>processed_events</code> deduplication table is the enforcement mechanism.</li>\n<li>Every click insertion, idempotency mark, and optional milestone insertion execute within a single PostgreSQL transaction. A crash between DB commit and RabbitMQ ACK causes re-delivery; the idempotency check makes re-processing a no-op.</li>\n<li>A poison message (malformed JSON, missing required fields) is always ACKed and never requeued. It is logged at <code>error</code> level. The consumer loop never panics.</li>\n<li><code>GET /health</code> returns 200 even when the RabbitMQ consumer is paused or the connection is down. Consumer health is degraded, not fatal.</li>\n<li>Raw IP addresses are never stored. The <code>ip_hash</code> field on <code>URLClickedEvent</code> (computed by url-service) is stored as-is — analytics-service never sees or stores plaintext IPs.</li>\n</ul>\n<hr>\n<h2 id=\"2-file-structure\">2. File Structure</h2>\n<p>Create files in the numbered order below. All paths are relative to the monorepo root.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-shortener/\n│\n└── services/analytics-service/\n    ├── migrations/\n    │   ├── 01  001_create_clicks.sql\n    │   ├── 02  002_create_milestones.sql\n    │   └── 03  003_create_processed_events.sql\n    ├── repository/\n    │   ├── 04  click_repository.go\n    │   ├── 05  click_repository_test.go\n    │   ├── 06  processed_event_repository.go\n    │   ├── 07  processed_event_repository_test.go\n    │   ├── 08  milestone_repository.go\n    │   └── 09  milestone_repository_test.go\n    ├── consumer/\n    │   ├── 10  consumer.go              # AMQPConsumer interface + amqp091 implementation\n    │   ├── 11  processor.go             # ClickProcessor: idempotency + insert + milestone\n    │   └── 12  processor_test.go\n    ├── milestone/\n    │   ├── 13  detector.go              # MilestoneDetector: threshold logic\n    │   └── 14  detector_test.go\n    ├── publisher/\n    │   ├── 15  publisher.go             # AMQPPublisher for MilestoneReachedEvent\n    │   └── 16  publisher_test.go\n    ├── handler/\n    │   ├── 17  stats.go                 # GET /stats/:code\n    │   ├── 18  timeline.go             # GET /stats/:code/timeline\n    │   ├── 19  health.go               # GET /health\n    │   ├── 20  helpers.go              # writeJSON, writeError\n    │   └── 21  handler_test.go\n    └── 22  main.go</code></pre></div>\n<h2 id=\"total-new-files-22-excluding-auto-generated-gosum-changes\"><strong>Total new files: 22</strong> (excluding auto-generated <code>go.sum</code> changes).</h2>\n<h2 id=\"3-complete-data-model\">3. Complete Data Model</h2>\n<h3 id=\"31-postgresql-schema-migrations001_create_clickssql\">3.1 PostgreSQL Schema — <code>migrations/001_create_clicks.sql</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- migrations/001_create_clicks.sql</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">BEGIN</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> clicks (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    id          UUID        </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    short_code  </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    clicked_at  </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ip_hash     </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#E1E4E8\">,    </span><span style=\"color:#6A737D\">-- SHA-256(ip+salt) from url-service; never raw IP</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    user_agent  </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#9ECBFF\"> ''</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    referer     </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NULL</span><span style=\"color:#6A737D\">        -- NULL = no Referer header present</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Primary analytics query: count/aggregate clicks for a short_code ordered by time.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Covers: total_clicks, clicks_last_24h, clicks_last_7d, timeline bucketing.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_clicks_short_code_time</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> clicks(short_code, clicked_at </span><span style=\"color:#F97583\">DESC</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Referer stats query: top referers for a short_code where referer is not null.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Partial index keeps size small (many clicks have NULL referer).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_clicks_referer</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> clicks(short_code, referer)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    WHERE</span><span style=\"color:#E1E4E8\"> referer </span><span style=\"color:#F97583\">IS NOT NULL</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COMMIT</span><span style=\"color:#E1E4E8\">;</span></span></code></pre></div>\n<p><strong>Field rationale:</strong></p>\n<ul>\n<li><code>short_code TEXT NOT NULL</code>: No FK to urls table — analytics-service owns no url data. Trusts the event payload. TEXT avoids the 10-char VARCHAR limit if future short codes change length.</li>\n<li><code>clicked_at TIMESTAMPTZ NOT NULL</code>: The timestamp of the original click as embedded in <code>URLClickedEvent.OccurredAt</code>, not <code>now()</code>. Using event time (not ingestion time) gives accurate time-series analytics regardless of consumer lag.</li>\n<li><code>ip_hash TEXT NOT NULL</code>: Already hashed by url-service. Analytics-service is never in possession of raw IPs. Storing the hash enables (future) per-IP deduplication without privacy violation.</li>\n<li><code>referer TEXT NULL</code>: Absent <code>Referer</code> header is stored as NULL, not empty string. This allows the partial index <code>WHERE referer IS NOT NULL</code> to exclude the majority of rows from the referer-stats index.</li>\n<li><code>user_agent TEXT NOT NULL DEFAULT &#39;&#39;</code>: Empty string when <code>User-Agent</code> header was absent. Default prevents NOT NULL violations on events from non-browser clients.</li>\n</ul>\n<h3 id=\"32-postgresql-schema-migrations002_create_milestonessql\">3.2 PostgreSQL Schema — <code>migrations/002_create_milestones.sql</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- migrations/002_create_milestones.sql</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">BEGIN</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> milestones (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    id           UUID        </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    short_code   </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    milestone    </span><span style=\"color:#F97583\">INT</span><span style=\"color:#F97583\">         NOT NULL</span><span style=\"color:#E1E4E8\">,       </span><span style=\"color:#6A737D\">-- 10 | 100 | 1000</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    triggered_at </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    UNIQUE</span><span style=\"color:#E1E4E8\"> (short_code, milestone)           </span><span style=\"color:#6A737D\">-- each threshold crossed at most once per code</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Query: \"what is the highest milestone already triggered for this code?\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_milestones_short_code</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> milestones(short_code, milestone </span><span style=\"color:#F97583\">DESC</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COMMIT</span><span style=\"color:#E1E4E8\">;</span></span></code></pre></div>\n<p><strong>Field rationale:</strong></p>\n<ul>\n<li><code>UNIQUE (short_code, milestone)</code>: Prevents duplicate milestone rows from concurrent processing or re-delivery. If two consumers race to detect the same milestone, the second <code>INSERT</code> fails on the unique constraint — the caller catches this and treats it as a no-op (milestone already recorded).</li>\n<li><code>milestone INT</code>: Stored as plain integer (10, 100, 1000) for query simplicity. Not stored as an enum because the set of thresholds may expand (10,000 etc.) without schema changes.</li>\n</ul>\n<h3 id=\"33-postgresql-schema-migrations003_create_processed_eventssql\">3.3 PostgreSQL Schema — <code>migrations/003_create_processed_events.sql</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- migrations/003_create_processed_events.sql</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">BEGIN</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> processed_events (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    event_id    UUID        </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#E1E4E8\">,    </span><span style=\"color:#6A737D\">-- = URLClickedEvent.EventID</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    processed_at </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- The PRIMARY KEY on event_id is itself the index used by IsProcessed SELECT.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- No additional index needed.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COMMIT</span><span style=\"color:#E1E4E8\">;</span></span></code></pre></div>\n<p><strong>Field rationale:</strong></p>\n<ul>\n<li><code>event_id UUID PRIMARY KEY</code>: The <code>EventID</code> from <code>URLClickedEvent</code> is the deduplication key. UUID PKs have B-tree index by default — <code>SELECT 1 FROM processed_events WHERE event_id = $1</code> uses an index scan in O(log n). No separate index is needed.</li>\n<li><code>processed_at TIMESTAMPTZ</code>: Audit field. Useful for debugging and for a future cleanup job that purges old dedup entries (not implemented in this milestone).</li>\n<li><strong>No FK to clicks.id</strong>: Intentional. The idempotency check is independent of the click row — if <code>MarkProcessed</code> succeeds but <code>Insert</code> fails, the event is marked processed but not inserted. This edge case is handled by inserting the click <em>before</em> marking processed within the same transaction (see § 5.2).</li>\n</ul>\n<h3 id=\"34-go-structs\">3.4 Go Structs</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/click_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> repository</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Click is a single recorded redirect event stored in the clicks table.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Fields map 1:1 to table columns; no derived fields.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Click</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID        </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // UUID v4; generated by DB DEFAULT</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // matches URLClickedEvent.ShortCode</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ClickedAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // from URLClickedEvent.OccurredAt (event time, not ingestion time)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IPHash    </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // from URLClickedEvent.IPHash; never the raw IP</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserAgent </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // from URLClickedEvent.UserAgent; empty string if absent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Referer   </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // from URLClickedEvent.Referer; empty string means NULL in DB</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RefererCount is a single row returned by TopReferers.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RefererCount</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Referer </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Count   </span><span style=\"color:#F97583\">int64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// PeriodCount is a single row returned by Timeline.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> PeriodCount</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Period </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // ISO 8601 formatted truncated timestamp; \"2026-03-02T14:00:00Z\" for hour, \"2026-03-02\" for day</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Clicks </span><span style=\"color:#F97583\">int64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/milestone_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> repository</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Milestone records a click count threshold crossing for a short_code.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Milestone</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID          </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode   </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Milestone   </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">       // 10 | 100 | 1000</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TriggeredAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/processed_event_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> repository</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ProcessedEvent is a deduplication record.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ProcessedEvent</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventID     </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // UUID string; matches URLClickedEvent.EventID</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ProcessedAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// consumer/processor.go — internal processing types</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ProcessResult describes the outcome of processing one AMQP delivery.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ProcessResult</span><span style=\"color:#F97583\"> int</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ProcessResultInserted</span><span style=\"color:#B392F0\">    ProcessResult</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> iota</span><span style=\"color:#6A737D\"> // new event; click row inserted</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ProcessResultDuplicate</span><span style=\"color:#6A737D\">                        // event_id already in processed_events; skipped</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ProcessResultPoisoned</span><span style=\"color:#6A737D\">                         // malformed message; ACKed, not inserted</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    ProcessResultError</span><span style=\"color:#6A737D\">                            // transient DB/infra error; NACKed with requeue</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handler/ — API response types</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// StatsResponse is the JSON body returned by GET /stats/:code.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> StatsResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode      </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">         `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TotalClicks    </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">          `json:\"total_clicks\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ClicksLast24h  </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">          `json:\"clicks_last_24h\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ClicksLast7d   </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">          `json:\"clicks_last_7d\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TopReferers    []</span><span style=\"color:#B392F0\">RefererItem</span><span style=\"color:#9ECBFF\">  `json:\"top_referers\"`</span><span style=\"color:#6A737D\">    // up to 5 entries; empty array if none</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RefererItem is a single entry in StatsResponse.TopReferers.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RefererItem</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Referer </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"referer\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Count   </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">  `json:\"count\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TimelineResponse is the JSON body returned by GET /stats/:code/timeline.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> TimelineResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">          `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Interval  </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">          `json:\"interval\"`</span><span style=\"color:#6A737D\"> // \"day\" | \"hour\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Points    []</span><span style=\"color:#B392F0\">TimelinePoint</span><span style=\"color:#9ECBFF\"> `json:\"points\"`</span><span style=\"color:#6A737D\">   // ordered oldest-first</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TimelinePoint is a single bucket in the timeline.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> TimelinePoint</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Period </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"period\"`</span><span style=\"color:#6A737D\"> // ISO 8601 string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Clicks </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">  `json:\"clicks\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ErrorResponse is the JSON body for all 4xx/5xx responses.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ErrorResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Error </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"error\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-24.svg\" alt=\"Analytics Service Module Architecture\"></p>\n<hr>\n<h2 id=\"4-interface-contracts\">4. Interface Contracts</h2>\n<h3 id=\"41-clickrepository\">4.1 <code>ClickRepository</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/click_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ClickRepository defines persistence operations for click records.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Implementations must be safe for concurrent use.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ClickRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert writes a new click row within the provided transaction tx.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // tx must be non-nil; Insert is always called inside the idempotency transaction.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // click.Referer == \"\" is stored as NULL (the implementation converts empty → NULL).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns a wrapped error on DB failure; no sentinel errors defined.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">click</span><span style=\"color:#B392F0\"> Click</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // CountByCode returns the total number of clicks for shortCode.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Uses the pool (no transaction); reads committed data.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns 0, nil if no rows exist (not an error).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    CountByCode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // CountSince returns the number of clicks for shortCode with</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // clicked_at >= since (inclusive). Uses idx_clicks_short_code_time.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns 0, nil if no rows match.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    CountSince</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">since</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TopReferers returns up to limit referers with their click counts,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ordered by count DESC, for the given shortCode.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Only rows where referer IS NOT NULL are considered.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns an empty slice (not nil) if no referer rows exist.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    TopReferers</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">limit</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">RefererCount</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Timeline returns aggregated click counts bucketed by interval.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // interval must be \"day\" or \"hour\" — callers validate before calling.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns rows ordered by period ASC (oldest first).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Uses PostgreSQL date_trunc(interval, clicked_at AT TIME ZONE 'UTC').</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns an empty slice (not nil) if no rows exist.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Timeline</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">interval</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">PeriodCount</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>SQL queries:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- Insert</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Note: empty string referer → NULL via pgx nullability handling (see implementation note below)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">INSERT INTO</span><span style=\"color:#E1E4E8\"> clicks (short_code, clicked_at, ip_hash, user_agent, referer)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">VALUES</span><span style=\"color:#E1E4E8\"> ($</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, $</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, $</span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">, $</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">, $</span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- CountByCode</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SELECT</span><span style=\"color:#79B8FF\"> COUNT</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> clicks </span><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> short_code </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- CountSince</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SELECT</span><span style=\"color:#79B8FF\"> COUNT</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> clicks</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> short_code </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#F97583\"> AND</span><span style=\"color:#E1E4E8\"> clicked_at </span><span style=\"color:#F97583\">>=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">2</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- TopReferers</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SELECT</span><span style=\"color:#E1E4E8\"> referer, </span><span style=\"color:#79B8FF\">COUNT</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">AS</span><span style=\"color:#E1E4E8\"> cnt</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> clicks</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> short_code </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  AND</span><span style=\"color:#E1E4E8\"> referer </span><span style=\"color:#F97583\">IS NOT NULL</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">GROUP BY</span><span style=\"color:#E1E4E8\"> referer</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">ORDER BY</span><span style=\"color:#E1E4E8\"> cnt </span><span style=\"color:#F97583\">DESC</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">LIMIT</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">2</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Timeline (interval validated to \"day\" or \"hour\" before interpolation)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- SAFE: interval is never raw user input in the SQL string; it is validated and</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- only one of two literals is ever used. Use a CASE or two separate queries.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SELECT</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    date_trunc($</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, clicked_at </span><span style=\"color:#F97583\">AT</span><span style=\"color:#F97583\"> TIME</span><span style=\"color:#F97583\"> ZONE</span><span style=\"color:#9ECBFF\"> 'UTC'</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">AS</span><span style=\"color:#F97583\"> period</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    COUNT</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">AS</span><span style=\"color:#E1E4E8\"> clicks</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> clicks</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> short_code </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">GROUP BY</span><span style=\"color:#F97583\"> period</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">ORDER BY</span><span style=\"color:#F97583\"> period</span><span style=\"color:#F97583\"> ASC</span></span></code></pre></div>\n<p><strong>Implementation note on NULL referer:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// pgx handles Go's typed nil via pgx.NullString or *string.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Use *string for the referer column: nil → NULL in DB.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> referer </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#E1E4E8\"> click.Referer </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    referer </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">click.Referer</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">_, err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> tx.</span><span style=\"color:#B392F0\">Exec</span><span style=\"color:#E1E4E8\">(ctx,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    `INSERT INTO clicks (short_code, clicked_at, ip_hash, user_agent, referer)</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">     VALUES ($1, $2, $3, $4, $5)`</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    click.ShortCode, click.ClickedAt, click.IPHash, click.UserAgent, referer,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong><code>Timeline</code> SQL safety note:</strong> <code>date_trunc</code> takes the interval as a string literal, not a column reference. Since interval is validated to exactly <code>&quot;day&quot;</code> or <code>&quot;hour&quot;</code> before reaching the repository, it is safe to interpolate directly into the query string (not as a <code>$N</code> parameter — PostgreSQL does not accept <code>date_trunc($2, ...)</code> where <code>$2</code> is a string bind parameter for the granularity argument in all driver versions). Implementation:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">r </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxClickRepository</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Timeline</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">interval</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">PeriodCount</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // interval is pre-validated to \"day\" | \"hour\" by the handler.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Safe string interpolation: only two possible values.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    q </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        SELECT date_trunc('</span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">', clicked_at AT TIME ZONE 'UTC') AS period, COUNT(*) AS clicks</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        FROM clicks</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        WHERE short_code = $1</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        GROUP BY period</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        ORDER BY period ASC`</span><span style=\"color:#E1E4E8\">, interval)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rows, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> r.pool.</span><span style=\"color:#B392F0\">Query</span><span style=\"color:#E1E4E8\">(ctx, q, shortCode)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ...scan rows into []PeriodCount...</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"42-processedeventrepository\">4.2 <code>ProcessedEventRepository</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/processed_event_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ProcessedEventRepository manages the deduplication table.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ProcessedEventRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // IsProcessed checks whether eventID is already in processed_events.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns true if found, false if not found.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns false on DB error (logged internally); the processor will</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // attempt the INSERT and rely on the UNIQUE constraint as a safety net.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // This is a read-only operation; uses the pool (no transaction).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    IsProcessed</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">eventID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // MarkProcessed inserts eventID into processed_events within tx.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // tx must be the same transaction as the Click INSERT — atomicity is the contract.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns error on DB failure; the constraint violation (duplicate) on</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // processed_events.event_id PRIMARY KEY is treated as a success (idempotent).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    MarkProcessed</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">eventID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>SQL queries:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- IsProcessed</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SELECT</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#F97583\"> FROM</span><span style=\"color:#E1E4E8\"> processed_events </span><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> event_id </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- MarkProcessed</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">INSERT INTO</span><span style=\"color:#E1E4E8\"> processed_events (event_id) </span><span style=\"color:#F97583\">VALUES</span><span style=\"color:#E1E4E8\"> ($</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">ON</span><span style=\"color:#E1E4E8\"> CONFLICT (event_id) DO NOTHING</span></span></code></pre></div>\n<p><strong>Why <code>ON CONFLICT DO NOTHING</code> on <code>MarkProcessed</code>:</strong> The outer idempotency check (<code>IsProcessed</code>) prevents most re-processing. However, between the <code>IsProcessed</code> read and the transaction commit, a concurrent consumer (future scenario) could process the same event. The <code>ON CONFLICT DO NOTHING</code> makes <code>MarkProcessed</code> idempotent at the DB level as a second guard. In the current single-consumer design this is defensive; it costs nothing.</p>\n<h3 id=\"43-milestonerepository\">4.3 <code>MilestoneRepository</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/milestone_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// MilestoneRepository manages milestone threshold records.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> MilestoneRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // GetLatestMilestone returns the highest milestone value already recorded</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // for shortCode. Returns 0, nil if no milestone row exists.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Uses the pool (no transaction); reads committed data.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    GetLatestMilestone</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // InsertMilestone records a new milestone crossing within tx.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // tx must be the same transaction as the click insert (§ 5.2).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // On UNIQUE constraint violation (short_code, milestone already recorded):</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // returns nil (treated as no-op — milestone was concurrently recorded).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // On any other DB error: returns wrapped error.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    InsertMilestone</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">milestone</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>SQL queries:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- GetLatestMilestone</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SELECT</span><span style=\"color:#79B8FF\"> COALESCE</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">MAX</span><span style=\"color:#E1E4E8\">(milestone), </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> milestones</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> short_code </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- InsertMilestone</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">INSERT INTO</span><span style=\"color:#E1E4E8\"> milestones (short_code, milestone)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">VALUES</span><span style=\"color:#E1E4E8\"> ($</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, $</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">ON</span><span style=\"color:#E1E4E8\"> CONFLICT (short_code, milestone) DO NOTHING</span></span></code></pre></div>\n<h3 id=\"44-amqpconsumer\">4.4 <code>AMQPConsumer</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// consumer/consumer.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// AMQPConsumer wraps the amqp091 channel consumption setup.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// It declares the queue and binding, then starts consuming.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> AMQPConsumer</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Deliveries returns the channel of incoming AMQP messages.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // The channel is closed when the AMQP connection drops.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Callers must re-initialize AMQPConsumer on channel close.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Deliveries</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">&#x3C;-chan</span><span style=\"color:#B392F0\"> amqp091</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Delivery</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Close cancels the consumer tag and closes the AMQP channel.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Called during graceful shutdown or before reconnect.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Close</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewAMQPConsumer constructs a consumer, declaring the queue and binding,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// and starts the AMQP Basic.Consume. Returns error if any AMQP operation fails.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// queueName: \"analytics.clicks\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// exchangeName: \"url-shortener\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// routingKey: \"url.clicked\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewAMQPConsumer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ch</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">amqp091</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#B392F0\">AMQPConsumer</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong>Consumer setup inside <code>NewAMQPConsumer</code>:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// 1. Declare exchange (idempotent — url-service already declared it)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">ExchangeDeclare</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url-shortener\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"topic\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// 2. Declare queue</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">q, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">QueueDeclare</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"analytics.clicks\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// 3. Bind queue to exchange</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">QueueBind</span><span style=\"color:#E1E4E8\">(q.Name, </span><span style=\"color:#9ECBFF\">\"url.clicked\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"url-shortener\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// 4. Set prefetch count: process one message at a time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">Qos</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">)  </span><span style=\"color:#6A737D\">// prefetchCount=1, prefetchSize=0, global=false</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// 5. Start consuming</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">deliveries, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">Consume</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    q.Name,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"analytics-consumer\"</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#6A737D\">// consumer tag</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">,                  </span><span style=\"color:#6A737D\">// autoAck=false — explicit ACK after processing</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">,                  </span><span style=\"color:#6A737D\">// exclusive=false</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">,                  </span><span style=\"color:#6A737D\">// noLocal=false</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">,                  </span><span style=\"color:#6A737D\">// noWait=false</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    nil</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong>Why <code>Qos(1, 0, false)</code> (prefetch=1):</strong> The consumer processes one message at a time to simplify idempotency logic. With <code>prefetch=1</code>, RabbitMQ delivers the next message only after the current one is ACKed or NACKed. This eliminates concurrent processing scenarios where two goroutines might race on <code>IsProcessed → INSERT</code>. A future optimization could increase prefetch and use a worker pool, but it would require distributed locking or serializable transactions for idempotency.</p>\n<h3 id=\"45-clickprocessor\">4.5 <code>ClickProcessor</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// consumer/processor.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ClickProcessor orchestrates the full processing of a single URLClickedEvent.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// It is called by the consumer goroutine for each delivery.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ClickProcessor</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    clickRepo     </span><span style=\"color:#B392F0\">repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ClickRepository</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    processedRepo </span><span style=\"color:#B392F0\">repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ProcessedEventRepository</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    milestoneRepo </span><span style=\"color:#B392F0\">repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">MilestoneRepository</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    detector      </span><span style=\"color:#B392F0\">milestone</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Detector</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publisher     </span><span style=\"color:#B392F0\">publisher</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">AMQPPublisher</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool          </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log           </span><span style=\"color:#B392F0\">zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewClickProcessor</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    clickRepo</span><span style=\"color:#B392F0\"> repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ClickRepository</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    processedRepo</span><span style=\"color:#B392F0\"> repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ProcessedEventRepository</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    milestoneRepo</span><span style=\"color:#B392F0\"> repository</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">MilestoneRepository</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    detector</span><span style=\"color:#B392F0\"> milestone</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Detector</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    pub</span><span style=\"color:#B392F0\"> publisher</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">AMQPPublisher</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">ClickProcessor</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Process handles a single AMQP delivery.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns ProcessResult indicating the outcome.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// The caller (consumer goroutine) uses the result to ACK or NACK.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Process never panics — all panics are recovered internally and logged.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">p </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">ClickProcessor</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Process</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">d</span><span style=\"color:#B392F0\"> amqp091</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Delivery</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ProcessResult</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-25.svg\" alt=\"clicks + milestones + processed_events Schema and Index Layout\"></p>\n<h3 id=\"46-milestonedetector\">4.6 <code>MilestoneDetector</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// milestone/detector.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Thresholds is the ordered list of click counts at which milestones are triggered.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Must be sorted ascending. Checked in order during detection.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> Thresholds </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">1000</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Detector determines which milestone (if any) was just crossed.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Detector</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Detect returns the milestone value crossed by newTotal, given that</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // the highest previously recorded milestone is latestMilestone.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns 0 if no new milestone was crossed.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Example: latestMilestone=10, newTotal=100 → returns 100.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Example: latestMilestone=100, newTotal=101 → returns 0 (100 already recorded).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Example: latestMilestone=0, newTotal=10 → returns 10.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Example: latestMilestone=0, newTotal=15 → returns 10 (lowest uncrossed threshold).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Detect</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">latestMilestone</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">newTotal</span><span style=\"color:#F97583\"> int64</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong><code>Detect</code> implementation:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">d </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">thresholdDetector</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Detect</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">latestMilestone</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">newTotal</span><span style=\"color:#F97583\"> int64</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, t </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> Thresholds {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> t </span><span style=\"color:#F97583\">></span><span style=\"color:#E1E4E8\"> latestMilestone </span><span style=\"color:#F97583\">&#x26;&#x26;</span><span style=\"color:#F97583\"> int64</span><span style=\"color:#E1E4E8\">(t) </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#E1E4E8\"> newTotal {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#E1E4E8\"> t </span><span style=\"color:#6A737D\">// return the LOWEST uncrossed threshold that newTotal has reached</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> 0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>Why return the lowest uncrossed threshold:</strong> If a code jumps from 0 to 150 clicks in a burst (e.g., due to consumer lag), <code>latestMilestone=0</code> and <code>newTotal=150</code>. The detector returns <code>10</code> (the first uncrossed threshold). After that milestone is recorded, <code>GetLatestMilestone</code> returns <code>10</code>, and the next call returns <code>100</code>. This ensures no threshold is skipped silently — each is recorded in sequence. In practice, with a running consumer this situation is rare.</p>\n<h3 id=\"47-amqppublisher-analytics-service-scoped\">4.7 <code>AMQPPublisher</code> (analytics-service scoped)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// publisher/publisher.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// AMQPPublisher publishes MilestoneReachedEvent to the RabbitMQ exchange.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Interface is identical in structure to url-service's publisher (§ 4.5 of M3),</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// but is independently defined in this package to avoid cross-service imports.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> AMQPPublisher</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Publish sends body to exchange \"url-shortener\" with routingKey \"milestone.reached\".</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns error if the AMQP channel is closed or broker unreachable.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Callers log the error and continue — milestone publish failure does NOT</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // roll back the DB transaction (milestone row is still saved).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Publish</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">routingKey</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">body</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewAMQPPublisher</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ch</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">amqp091</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">AMQPPublisher</span></span></code></pre></div>\n<hr>\n<h2 id=\"5-algorithm-specification\">5. Algorithm Specification</h2>\n<h3 id=\"51-consumer-goroutine-lifecycle\">5.1 Consumer Goroutine Lifecycle</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE RunConsumer(ctx context.Context, amqpURL string, processor *ClickProcessor, log):\n  FOR:\n    -- Attempt to connect and consume; reconnect on failure.\n    conn, ch, err = connectAMQP(ctx, amqpURL)  -- exponential backoff, same as M1 § 4.5\n    IF err:\n      log.Warn().Err(err).Msg(&quot;consumer amqp connect failed; retrying in 10s&quot;)\n      SELECT:\n      CASE &lt;-ctx.Done(): return\n      CASE &lt;-time.After(10 * time.Second): continue\n    consumer, err = NewAMQPConsumer(ch, log)\n    IF err:\n      log.Warn().Err(err).Msg(&quot;consumer setup failed; retrying&quot;)\n      ch.Close(); conn.Close()\n      continue\n    log.Info().Msg(&quot;amqp consumer started; waiting for messages&quot;)\n    -- Inner loop: process deliveries until channel closes.\n    FOR:\n      SELECT:\n      CASE &lt;-ctx.Done():\n        consumer.Close()\n        conn.Close()\n        return\n      CASE d, ok := &lt;-consumer.Deliveries():\n        IF !ok:\n          -- Channel closed (broker disconnect).\n          log.Warn().Msg(&quot;amqp delivery channel closed; reconnecting&quot;)\n          conn.Close()\n          BREAK inner loop → reconnect\n        -- Run processor in a supervised call (panic recovery inside Process).\n        result = processor.Process(ctx, d)\n        SWITCH result:\n        CASE ProcessResultInserted:\n          d.Ack(false)\n        CASE ProcessResultDuplicate:\n          d.Ack(false)      -- duplicate: safe to ACK, no DB side effect\n        CASE ProcessResultPoisoned:\n          d.Ack(false)      -- poison: ACK to remove from queue; logged as error\n        CASE ProcessResultError:\n          d.Nack(false, true) -- transient error: NACK with requeue=true\nEND PROCEDURE</code></pre></div>\n<p><strong>Supervisor wrapper in <code>main.go</code>:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">go</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            defer</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                if</span><span style=\"color:#E1E4E8\"> r </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> recover</span><span style=\"color:#E1E4E8\">(); r </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    log.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Interface</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"panic\"</span><span style=\"color:#E1E4E8\">, r).</span><span style=\"color:#B392F0\">Msg</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"consumer goroutine panicked; restarting\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }()</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            RunConsumer</span><span style=\"color:#E1E4E8\">(ctx, amqpURL, processor, log)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        select</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">ctx.</span><span style=\"color:#B392F0\">Done</span><span style=\"color:#E1E4E8\">():</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">time.</span><span style=\"color:#B392F0\">After</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">5</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second):</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Msg</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"restarting consumer goroutine\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}()</span></span></code></pre></div>\n<p>The outer <code>for</code> loop with <code>recover()</code> ensures the consumer goroutine is always running while the service is alive, even after a panic in the processor.</p>\n<h3 id=\"52-clickprocessorprocess-full-algorithm\">5.2 <code>ClickProcessor.Process</code> — Full Algorithm</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE ClickProcessor.Process(ctx, d amqp091.Delivery) ProcessResult:\n  -- Step 0: Panic recovery (defer at top of function)\n  DEFER recover() → log error, return ProcessResultError\n  -- Step 1: Parse event\n  var event events.URLClickedEvent\n  err = json.Unmarshal(d.Body, &amp;event)\n  IF err:\n    log.Error().Err(err).\n        Str(&quot;body&quot;, truncate(string(d.Body), 200)).\n        Msg(&quot;malformed URLClickedEvent; ACKing poison message&quot;)\n    return ProcessResultPoisoned\n  -- Step 2: Validate required fields\n  IF event.EventID == &quot;&quot; OR event.ShortCode == &quot;&quot;:\n    log.Error().\n        Str(&quot;event_id&quot;, event.EventID).\n        Str(&quot;short_code&quot;, event.ShortCode).\n        Msg(&quot;URLClickedEvent missing required fields; ACKing&quot;)\n    return ProcessResultPoisoned\n  -- Step 3: Set correlation ID on logger for this message\n  msgLog = log.With().\n      Str(&quot;correlation_id&quot;, event.CorrelationID).\n      Str(&quot;event_id&quot;, event.EventID).\n      Str(&quot;short_code&quot;, event.ShortCode).\n      Logger()\n  -- Step 4: Fast idempotency pre-check (outside transaction for performance)\n  already, err = processedRepo.IsProcessed(ctx, event.EventID)\n  IF err:\n    -- DB error on check: log, attempt processing anyway (DB constraint is the real guard)\n    msgLog.Warn().Err(err).Msg(&quot;idempotency pre-check DB error; proceeding with insert attempt&quot;)\n  IF already:\n    msgLog.Debug().Msg(&quot;duplicate event; skipping&quot;)\n    return ProcessResultDuplicate\n  -- Step 5: Begin transaction\n  tx, err = pool.Begin(ctx)\n  IF err:\n    msgLog.Error().Err(err).Msg(&quot;begin tx failed&quot;)\n    return ProcessResultError\n  DEFER tx.Rollback(ctx)  -- no-op if Commit succeeds\n  -- Step 6: Mark processed (inside transaction, before click insert)\n  -- Order: MarkProcessed FIRST, then Insert.\n  -- Rationale: if Insert fails after MarkProcessed, the tx rolls back — both\n  -- operations are undone. The event will be redelivered and reprocessed.\n  -- If we inserted first and marked second, a crash between them would leave\n  -- a click row with no idempotency record — the event is redelivered and\n  -- double-counted. Inserting the mark first is the safe order.\n  err = processedRepo.MarkProcessed(ctx, tx, event.EventID)\n  IF err:\n    msgLog.Error().Err(err).Msg(&quot;mark processed failed&quot;)\n    return ProcessResultError\n  -- Step 7: Build Click struct\n  click = repository.Click{\n      ShortCode: event.ShortCode,\n      ClickedAt: event.OccurredAt,    -- event time, not now()\n      IPHash:    event.IPHash,\n      UserAgent: event.UserAgent,\n      Referer:   event.Referer,       -- may be &quot;&quot; → stored as NULL\n  }\n  -- Step 8: Insert click\n  err = clickRepo.Insert(ctx, tx, click)\n  IF err:\n    msgLog.Error().Err(err).Msg(&quot;click insert failed&quot;)\n    return ProcessResultError\n  -- Step 9: Commit click + idempotency mark\n  err = tx.Commit(ctx)\n  IF err:\n    msgLog.Error().Err(err).Msg(&quot;commit failed&quot;)\n    return ProcessResultError\n  -- Step 10: Milestone detection (AFTER commit — reads committed data)\n  -- This runs outside the click transaction to avoid long-held locks.\n  p.detectAndRecordMilestone(ctx, event, msgLog)\n  -- Step 11: Return success\n  return ProcessResultInserted\nEND PROCEDURE</code></pre></div>\n<p><strong>Why milestone detection is outside the click transaction:</strong>\n<code>CountByCode</code> reads the total click count for the short_code. If this query runs inside the click transaction, it reads the uncommitted inserted row (own-transaction visibility in PostgreSQL). However, running milestone detection inside the transaction means:</p>\n<ol>\n<li>The transaction holds locks longer (milestone INSERT + possible publisher call).</li>\n<li>A milestone publish failure would roll back the click insert.\nThe spec (error category <code>MILESTONE_PUBLISH_FAIL</code>) explicitly states: &quot;log warning, do not fail the transaction (milestone row still saved).&quot; Therefore, milestone detection runs after the click transaction commits, with a fresh pool connection.</li>\n</ol>\n<h3 id=\"53-detectandrecordmilestone-milestone-detection-algorithm\">5.3 <code>detectAndRecordMilestone</code> — Milestone Detection Algorithm</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE detectAndRecordMilestone(ctx, event URLClickedEvent, log):\n  -- Step 1: Get current total click count (post-commit)\n  total, err = clickRepo.CountByCode(ctx, event.ShortCode)\n  IF err:\n    log.Error().Err(err).Msg(&quot;milestone: count query failed&quot;)\n    return  -- milestone detection skipped; not fatal\n  -- Step 2: Get highest recorded milestone for this code\n  latest, err = milestoneRepo.GetLatestMilestone(ctx, event.ShortCode)\n  IF err:\n    log.Error().Err(err).Msg(&quot;milestone: get latest failed&quot;)\n    return\n  -- Step 3: Detect if a threshold was crossed\n  crossed = detector.Detect(latest, total)\n  IF crossed == 0:\n    return  -- no milestone crossed\n  log.Info().\n      Str(&quot;short_code&quot;, event.ShortCode).\n      Int(&quot;milestone&quot;, crossed).\n      Int64(&quot;total&quot;, total).\n      Msg(&quot;milestone crossed&quot;)\n  -- Step 4: Record milestone in its own transaction\n  tx, err = pool.Begin(ctx)\n  IF err:\n    log.Error().Err(err).Msg(&quot;milestone: begin tx failed&quot;)\n    return\n  DEFER tx.Rollback(ctx)\n  err = milestoneRepo.InsertMilestone(ctx, tx, event.ShortCode, crossed)\n  IF err:\n    log.Error().Err(err).Msg(&quot;milestone: insert failed&quot;)\n    return  -- tx rollback via defer\n  err = tx.Commit(ctx)\n  IF err:\n    log.Error().Err(err).Msg(&quot;milestone: commit failed&quot;)\n    return\n  -- Step 5: Publish MilestoneReachedEvent\n  milestoneEvent = events.MilestoneReachedEvent{\n      EventType:     events.EventTypeMilestoneReached,\n      OccurredAt:    time.Now().UTC(),\n      CorrelationID: event.CorrelationID,\n      ShortCode:     event.ShortCode,\n      UserID:        event.UserID,\n      UserEmail:     event.UserEmail,  -- from URLClickedEvent (owner info)\n      Milestone:     crossed,\n      TotalClicks:   total,\n  }\n  payload, _ = json.Marshal(milestoneEvent)\n  err = publisher.Publish(ctx, events.EventTypeMilestoneReached, payload)\n  IF err:\n    -- Log warning; milestone row already committed → notification-service will\n    -- not be notified this cycle but the milestone is durably recorded.\n    log.Warn().Err(err).\n        Str(&quot;short_code&quot;, event.ShortCode).\n        Int(&quot;milestone&quot;, crossed).\n        Msg(&quot;milestone event publish failed; milestone saved but notification may be missed&quot;)\n    return\n  log.Info().Str(&quot;short_code&quot;, event.ShortCode).Int(&quot;milestone&quot;, crossed).\n      Msg(&quot;MilestoneReachedEvent published&quot;)\nEND PROCEDURE</code></pre></div>\n<p><strong>Milestone deduplication note:</strong> <code>milestones</code> has <code>UNIQUE (short_code, milestone)</code>. If the service crashes between Step 3 and Step 4 and the event is redelivered, <code>IsProcessed</code> returns true (the click was committed in Step 9 of <code>Process</code>), so the whole <code>Process</code> function returns <code>ProcessResultDuplicate</code> — milestone detection is not re-run. This is correct: the click count hasn&#39;t changed, so the milestone would be detected again. The <code>ON CONFLICT DO NOTHING</code> on <code>InsertMilestone</code> provides an additional safety net if the dedup table is somehow bypassed.</p>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-26.svg\" alt=\"URLClickedEvent Ingestion — Idempotent Consumer Algorithm\"></p>\n<h3 id=\"54-get-statscode-handler-algorithm\">5.4 <code>GET /stats/:code</code> Handler Algorithm</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE HandleStats(w http.ResponseWriter, r *http.Request):\n  shortCode = r.PathValue(&quot;code&quot;)\n  IF shortCode == &quot;&quot;:\n    writeError(w, 400, &quot;short code is required&quot;)\n    return\n  now = time.Now().UTC()\n  -- Run all four queries concurrently using errgroup.\n  -- All are read-only; no transaction needed.\n  var (\n      total   int64\n      last24h int64\n      last7d  int64\n      refs    []repository.RefererCount\n  )\n  g, gctx = errgroup.WithContext(r.Context())\n  g.Go(func() error {\n      var err error\n      total, err = clickRepo.CountByCode(gctx, shortCode)\n      return err\n  })\n  g.Go(func() error {\n      var err error\n      last24h, err = clickRepo.CountSince(gctx, shortCode, now.Add(-24*time.Hour))\n      return err\n  })\n  g.Go(func() error {\n      var err error\n      last7d, err = clickRepo.CountSince(gctx, shortCode, now.Add(-7*24*time.Hour))\n      return err\n  })\n  g.Go(func() error {\n      var err error\n      refs, err = clickRepo.TopReferers(gctx, shortCode, 5)\n      return err\n  })\n  IF err = g.Wait(); err != nil:\n    log.Error().Err(err).Str(&quot;short_code&quot;, shortCode).Msg(&quot;stats query failed&quot;)\n    writeError(w, 500, &quot;internal server error&quot;)\n    return\n  -- Build response (always 200 even if total=0; short_code may have no clicks yet)\n  items = make([]RefererItem, len(refs))\n  FOR i, r := range refs:\n    items[i] = RefererItem{Referer: r.Referer, Count: r.Count}\n  writeJSON(w, 200, StatsResponse{\n      ShortCode:     shortCode,\n      TotalClicks:   total,\n      ClicksLast24h: last24h,\n      ClicksLast7d:  last7d,\n      TopReferers:   items,  -- empty slice, never null\n  })\nEND PROCEDURE</code></pre></div>\n<p><strong>Concurrency note:</strong> Using <code>golang.org/x/sync/errgroup</code> to run the four queries concurrently reduces p99 latency from <code>4 × query_time</code> to approximately <code>1 × slowest_query_time</code>. All four queries are SELECT-only and use the shared pgxpool — each acquires its own connection. This is safe and the pool has <code>MaxConns=10</code> (M1), sufficient for 4 concurrent reads per request plus consumer activity.</p>\n<h3 id=\"55-get-statscodetimeline-handler-algorithm\">5.5 <code>GET /stats/:code/timeline</code> Handler Algorithm</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE HandleTimeline(w http.ResponseWriter, r *http.Request):\n  shortCode = r.PathValue(&quot;code&quot;)\n  IF shortCode == &quot;&quot;:\n    writeError(w, 400, &quot;short code is required&quot;)\n    return\n  interval = r.URL.Query().Get(&quot;interval&quot;)\n  IF interval == &quot;&quot;:\n    interval = &quot;day&quot;  -- default\n  IF interval != &quot;day&quot; AND interval != &quot;hour&quot;:\n    writeError(w, 400, &quot;interval must be 'day' or 'hour'&quot;)\n    return\n  points, err = clickRepo.Timeline(r.Context(), shortCode, interval)\n  IF err:\n    log.Error().Err(err).Str(&quot;short_code&quot;, shortCode).Msg(&quot;timeline query failed&quot;)\n    writeError(w, 500, &quot;internal server error&quot;)\n    return\n  -- Format period timestamps as ISO 8601 strings.\n  -- For interval=&quot;day&quot;: &quot;2026-03-02&quot; (date only).\n  -- For interval=&quot;hour&quot;: &quot;2026-03-02T14:00:00Z&quot; (full RFC3339).\n  formattedPoints = make([]TimelinePoint, len(points))\n  FOR i, p := range points:\n    formattedPoints[i] = TimelinePoint{\n        Period: formatPeriod(p.Period, interval),\n        Clicks: p.Clicks,\n    }\n  writeJSON(w, 200, TimelineResponse{\n      ShortCode: shortCode,\n      Interval:  interval,\n      Points:    formattedPoints,\n  })\nEND PROCEDURE\nFUNCTION formatPeriod(period string, interval string) string:\n  -- period is a UTC timestamp string returned by PostgreSQL date_trunc.\n  -- Parse as time.Time, then format based on interval.\n  t, _ = time.Parse(time.RFC3339, period)  -- pgx scans TIMESTAMPTZ as time.Time directly\n  IF interval == &quot;day&quot;:\n    return t.UTC().Format(&quot;2006-01-02&quot;)\n  return t.UTC().Format(time.RFC3339)</code></pre></div>\n<p><strong>Implementation note:</strong> pgx scans <code>TIMESTAMPTZ</code> columns directly into <code>time.Time</code>. The <code>PeriodCount.Period</code> field should be <code>time.Time</code> (not <code>string</code>) in the repository layer; the handler converts to the appropriate string format. Update the <code>PeriodCount</code> struct:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> PeriodCount</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Period </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // scanned directly from PostgreSQL TIMESTAMPTZ</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Clicks </span><span style=\"color:#F97583\">int64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p>The <code>TimelinePoint.Period</code> in the API response is a string (formatted by the handler).</p>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-27.svg\" alt=\"Consumer Goroutine State Machine\"></p>\n<hr>\n<h2 id=\"6-state-machine-consumer-goroutine\">6. State Machine: Consumer Goroutine</h2>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>States: DISCONNECTED → CONNECTING → CONSUMING → DISCONNECTED\n        CONSUMING → STOPPING (on ctx.Done)\n        STOPPING → (goroutine exits)\nTransitions:\n  DISCONNECTED →[connect attempt success]→ CONSUMING\n  DISCONNECTED →[connect attempt fail]→ DISCONNECTED (wait 10s, retry)\n  CONSUMING →[delivery channel closed]→ DISCONNECTED\n  CONSUMING →[ctx.Done]→ STOPPING\n  STOPPING →[consumer.Close + conn.Close]→ (exit)\nIllegal transitions (must never occur):\n  CONSUMING → CONSUMING (no nested consumer start)\n  STOPPING → CONNECTING (no reconnect after shutdown signal)</code></pre></div>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>States: CONSUMING → processing one message at a time\n  Per-message substates:\n    IDLE → PARSING → CHECKING_DUP → IN_TRANSACTION → COMMITTED → MILESTONE_DETECTION → IDLE</code></pre></div>\n<h2 id=\"the-qos1-0-false-prefetch1-enforces-that-the-broker-does-not-deliver-a-second-message-until-the-first-is-acked-or-nacked-making-the-per-message-substates-truly-sequential\">The <code>Qos(1, 0, false)</code> (prefetch=1) enforces that the broker does not deliver a second message until the first is ACKed or NACKed, making the per-message substates truly sequential.</h2>\n<h2 id=\"7-error-handling-matrix\">7. Error Handling Matrix</h2>\n<table>\n<thead>\n<tr>\n<th>Error</th>\n<th>Detected By</th>\n<th>Recovery</th>\n<th>ACK/NACK</th>\n<th>Logged?</th>\n<th>Notes</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>MALFORMED_JSON</code></td>\n<td><code>json.Unmarshal</code></td>\n<td>Log error, ACK</td>\n<td>ACK</td>\n<td>Error</td>\n<td>Poison message; requeue would loop forever</td>\n</tr>\n<tr>\n<td><code>MISSING_REQUIRED_FIELDS</code></td>\n<td>field check in <code>Process</code></td>\n<td>Log error, ACK</td>\n<td>ACK</td>\n<td>Error</td>\n<td>EventID or ShortCode empty</td>\n</tr>\n<tr>\n<td><code>DUPLICATE_EVENT</code></td>\n<td><code>processedRepo.IsProcessed</code> → true</td>\n<td>Log debug, ACK</td>\n<td>ACK</td>\n<td>Debug</td>\n<td>At-least-once guarantee; normal occurrence</td>\n</tr>\n<tr>\n<td><code>IDEMPOTENCY_CHECK_DB_ERROR</code></td>\n<td><code>IsProcessed</code> returns error</td>\n<td>Log warn, proceed to INSERT</td>\n<td>—</td>\n<td>Warn</td>\n<td>DB constraint is the real guard</td>\n</tr>\n<tr>\n<td><code>BEGIN_TX_FAIL</code></td>\n<td><code>pool.Begin</code></td>\n<td>Log error, NACK requeue</td>\n<td>NACK</td>\n<td>Error</td>\n<td>Transient; retried on redelivery</td>\n</tr>\n<tr>\n<td><code>MARK_PROCESSED_FAIL</code></td>\n<td><code>processedRepo.MarkProcessed</code></td>\n<td>Log error, rollback, NACK</td>\n<td>NACK</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td><code>CLICK_INSERT_FAIL</code></td>\n<td><code>clickRepo.Insert</code></td>\n<td>Log error, rollback, NACK</td>\n<td>NACK</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td><code>TX_COMMIT_FAIL</code></td>\n<td><code>tx.Commit</code></td>\n<td>Log error, NACK</td>\n<td>NACK</td>\n<td>Error</td>\n<td>Row not inserted; safe to retry</td>\n</tr>\n<tr>\n<td><code>MILESTONE_COUNT_FAIL</code></td>\n<td><code>clickRepo.CountByCode</code></td>\n<td>Log error, skip milestone, return</td>\n<td>ACK (click already committed)</td>\n<td>Error</td>\n<td>Click inserted; milestone detection skipped</td>\n</tr>\n<tr>\n<td><code>MILESTONE_INSERT_FAIL</code></td>\n<td><code>milestoneRepo.InsertMilestone</code></td>\n<td>Log error, skip publish, return</td>\n<td>ACK</td>\n<td>Error</td>\n<td>Click inserted; milestone not recorded this cycle</td>\n</tr>\n<tr>\n<td><code>MILESTONE_PUBLISH_FAIL</code></td>\n<td><code>publisher.Publish</code></td>\n<td>Log warn, return</td>\n<td>ACK</td>\n<td>Warn</td>\n<td>Milestone saved; notification may be missed</td>\n</tr>\n<tr>\n<td><code>CONSUMER_PANIC</code></td>\n<td><code>recover()</code> in supervisor</td>\n<td>Log error, restart goroutine after 5s</td>\n<td>N/A</td>\n<td>Error</td>\n<td>Panic in Process means delivery not ACKed; broker redelivers after consumer reconnects</td>\n</tr>\n<tr>\n<td><code>AMQP_DISCONNECTED</code></td>\n<td>Delivery channel closed</td>\n<td>Log warn, reconnect loop</td>\n<td>N/A</td>\n<td>Warn</td>\n<td>Consumer pauses; /health still 200</td>\n</tr>\n<tr>\n<td><code>STATS_QUERY_FAIL</code></td>\n<td><code>errgroup.Wait</code> error</td>\n<td>Log error, 500 response</td>\n<td>N/A</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td><code>TIMELINE_INVALID_INTERVAL</code></td>\n<td>handler validation</td>\n<td>400 response</td>\n<td>N/A</td>\n<td>No</td>\n<td>User input error</td>\n</tr>\n<tr>\n<td><code>DB_POOL_EXHAUSTED</code></td>\n<td>pgx <code>pool.Begin</code> or <code>pool.Query</code></td>\n<td>Same as <code>BEGIN_TX_FAIL</code></td>\n<td>NACK</td>\n<td>Error</td>\n<td>Indicates pool sizing issue</td>\n</tr>\n<tr>\n<td><strong>Dead-letter queue consideration:</strong> The spec does not require a DLQ in this milestone. Poison messages (malformed JSON) are ACKed to remove them from the queue. For production, a DLQ binding on <code>analytics.clicks</code> would capture nacked messages with <code>requeue=false</code>. Document in README as a future improvement.</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"8-concurrency-specification\">8. Concurrency Specification</h2>\n<h3 id=\"81-consumer-goroutine\">8.1 Consumer Goroutine</h3>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Goroutine Count</th>\n<th>Shared Mutable State</th>\n<th>Protection</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Consumer supervisor</td>\n<td>1</td>\n<td>None</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><code>RunConsumer</code></td>\n<td>1</td>\n<td><code>amqp091.Connection</code>, <code>amqp091.Channel</code></td>\n<td>Owned by single goroutine</td>\n</tr>\n<tr>\n<td><code>ClickProcessor.Process</code></td>\n<td>Called from 1 goroutine</td>\n<td><code>pgxpool.Pool</code> (goroutine-safe)</td>\n<td>Pool internal locking</td>\n</tr>\n<tr>\n<td><code>detectAndRecordMilestone</code></td>\n<td>Called from 1 goroutine</td>\n<td>Same pool</td>\n<td>Pool internal locking</td>\n</tr>\n<tr>\n<td><code>AMQPPublisher</code></td>\n<td>Called from 1 goroutine</td>\n<td><code>amqp091.Channel</code></td>\n<td>No concurrent access in single-consumer design</td>\n</tr>\n<tr>\n<td><strong>Note:</strong> Because the consumer is single-goroutine (enforced by prefetch=1 + sequential processing), <code>AMQPPublisher</code> in analytics-service does NOT need the <code>sync.Mutex</code> that url-service&#39;s publisher uses (where 3 worker goroutines share one channel). If the design ever moves to concurrent processing, the mutex must be added.</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"82-stats-api-handlers\">8.2 Stats API Handlers</h3>\n<p>Stats handlers run concurrently (one goroutine per request, via <code>net/http</code>). They are read-only; all state is in PostgreSQL. <code>pgxpool.Pool</code> is goroutine-safe. The <code>errgroup</code>-based concurrent queries within <code>HandleStats</code> are bounded to 4 goroutines per request — with <code>MaxConns=10</code>, up to 2 concurrent stat requests can run fully parallel before pool pressure begins.</p>\n<h3 id=\"83-consumer-vs-stats-api-isolation\">8.3 Consumer vs. Stats API Isolation</h3>\n<p>The consumer goroutine and HTTP handler goroutines share the <code>*pgxpool.Pool</code>. Pool slots are acquired dynamically. With <code>MinConns=2, MaxConns=10</code>:</p>\n<ul>\n<li>Consumer always needs at most 2 connections simultaneously (one for the main click tx, one for milestone detection).</li>\n<li>Stats API handler needs up to 4 connections (errgroup concurrent queries).</li>\n<li>Total peak: 6 connections; well within <code>MaxConns=10</code>.</li>\n</ul>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-28.svg\" alt=\"IP Privacy Hashing Data Flow\"></p>\n<hr>\n<h2 id=\"9-route-registration-in-maingo\">9. Route Registration in <code>main.go</code></h2>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/analytics-service/main.go (route wiring)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// No JWT auth on stats endpoints — stats are public per spec.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">NewServeMux</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /health\"</span><span style=\"color:#E1E4E8\">,                     handler.</span><span style=\"color:#B392F0\">NewHealthHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"analytics-service\"</span><span style=\"color:#E1E4E8\">, log))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /stats/{code}\"</span><span style=\"color:#E1E4E8\">,              handler.</span><span style=\"color:#B392F0\">NewStatsHandler</span><span style=\"color:#E1E4E8\">(clickRepo, log))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /stats/{code}/timeline\"</span><span style=\"color:#E1E4E8\">,     handler.</span><span style=\"color:#B392F0\">NewTimelineHandler</span><span style=\"color:#E1E4E8\">(clickRepo, log))</span></span></code></pre></div>\n<h2 id=\"pattern-disambiguation-get-statscodetimeline-is-more-specific-than-get-statscode-go-122-nethttp-routing-correctly-resolves-this-statsabctimeline-matches-the-timeline-handler-statsabc-matches-the-stats-handler-register-in-any-order-specificity-takes-precedence-no-analytics-prefix-the-gateway-m5-routes-get-apistatscode-httpanalytics-service8082statscode-the-service-itself-uses-stats-without-the-api-prefix-the-gateway-strips-the-path-prefix-before-forwarding-verify-the-gateway-routing-table-in-m5\"><strong>Pattern disambiguation:</strong> <code>GET /stats/{code}/timeline</code> is more specific than <code>GET /stats/{code}</code> — Go 1.22+ <code>net/http</code> routing correctly resolves this: <code>/stats/abc/timeline</code> matches the timeline handler, <code>/stats/abc</code> matches the stats handler. Register in any order; specificity takes precedence.\n<strong>No <code>/analytics/</code> prefix:</strong> The gateway (M5) routes <code>GET /api/stats/:code</code> → <code>http://analytics-service:8082/stats/:code</code>. The service itself uses <code>/stats/</code> without the <code>/api/</code> prefix — the gateway strips the path prefix before forwarding. Verify the gateway routing table in M5.</h2>\n<h2 id=\"10-implementation-sequence-with-checkpoints\">10. Implementation Sequence with Checkpoints</h2>\n<h3 id=\"phase-1-schema-migrations-indexes-115-hr\">Phase 1 — Schema Migrations + Indexes (1–1.5 hr)</h3>\n<ol>\n<li>Write <code>migrations/001_create_clicks.sql</code>, <code>002_create_milestones.sql</code>, <code>003_create_processed_events.sql</code>.</li>\n<li>Apply migrations:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">   docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#79B8FF\"> -i</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analytics_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">     &#x3C;</span><span style=\"color:#9ECBFF\"> services/analytics-service/migrations/001_create_clicks.sql</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#79B8FF\"> -i</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analytics_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">     &#x3C;</span><span style=\"color:#9ECBFF\"> services/analytics-service/migrations/002_create_milestones.sql</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#79B8FF\"> -i</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analytics_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">     &#x3C;</span><span style=\"color:#9ECBFF\"> services/analytics-service/migrations/003_create_processed_events.sql</span></span></code></pre></div>\n<ol start=\"3\">\n<li>Verify schema and indexes:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">   docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analytics_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"\\d clicks\"</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">   docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analytics_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"\\di\"</span></span></code></pre></div>\n<p><strong>Checkpoint:</strong> Three tables exist. <code>\\di</code> shows <code>idx_clicks_short_code_time</code>, <code>idx_clicks_referer</code> (partial), <code>idx_milestones_short_code</code>. <code>milestones</code> has unique constraint on <code>(short_code, milestone)</code>. <code>processed_events</code> has UUID primary key. Run:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">EXPLAIN </span><span style=\"color:#F97583\">SELECT</span><span style=\"color:#79B8FF\"> COUNT</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> clicks </span><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> short_code </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> 'abc'</span><span style=\"color:#F97583\"> AND</span><span style=\"color:#E1E4E8\"> clicked_at </span><span style=\"color:#F97583\">>=</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">-</span><span style=\"color:#E1E4E8\"> interval </span><span style=\"color:#9ECBFF\">'24h'</span><span style=\"color:#E1E4E8\">;</span></span></code></pre></div>\n<p>Must show <code>Index Scan</code> on <code>idx_clicks_short_code_time</code>, not <code>Seq Scan</code>.</p>\n<h3 id=\"phase-2-repository-layer-152-hr\">Phase 2 — Repository Layer (1.5–2 hr)</h3>\n<ol>\n<li>Add dependencies to <code>go.mod</code>: <code>go get github.com/jackc/pgx/v5 github.com/rs/zerolog golang.org/x/sync</code>.</li>\n<li>Write <code>repository/click_repository.go</code>: <code>Click</code>, <code>RefererCount</code>, <code>PeriodCount</code>, <code>ClickRepository</code> interface, <code>pgxClickRepository</code>, all five methods.</li>\n<li>Write <code>repository/processed_event_repository.go</code>: <code>ProcessedEvent</code>, <code>ProcessedEventRepository</code> interface, <code>pgxProcessedEventRepository</code>, <code>IsProcessed</code>, <code>MarkProcessed</code>.</li>\n<li>Write <code>repository/milestone_repository.go</code>: <code>Milestone</code>, <code>MilestoneRepository</code> interface, <code>pgxMilestoneRepository</code>, <code>GetLatestMilestone</code>, <code>InsertMilestone</code>.</li>\n<li>Write all three <code>_test.go</code> files with integration build tag.</li>\n<li>Run: <code>go test -tags integration ./repository/... -v</code>\n<strong>Checkpoint:</strong></li>\n</ol>\n<ul>\n<li><code>TestClickInsert_HappyPath</code>: inserts click, <code>CountByCode</code> returns 1.</li>\n<li><code>TestMarkProcessed_Idempotent</code>: <code>MarkProcessed</code> twice with same event_id → no error.</li>\n<li><code>TestIsProcessed_AfterMark</code>: <code>IsProcessed</code> returns true after <code>MarkProcessed</code> + commit.</li>\n<li><code>TestGetLatestMilestone_NoRows</code>: returns 0.</li>\n<li><code>TestInsertMilestone_Conflict</code>: second insert of same <code>(short_code, milestone)</code> → returns nil (ON CONFLICT DO NOTHING).</li>\n<li><code>TestTopReferers_NullsExcluded</code>: click with empty referer not returned in top referers.</li>\n<li><code>TestTimeline_DayBucket</code>: two clicks on same day return one period row.</li>\n</ul>\n<h3 id=\"phase-3-rabbitmq-consumer-idempotency-225-hr\">Phase 3 — RabbitMQ Consumer + Idempotency (2–2.5 hr)</h3>\n<ol>\n<li>Write <code>consumer/consumer.go</code>: <code>AMQPConsumer</code> interface, <code>amqp091Consumer</code> struct, <code>NewAMQPConsumer</code> (exchange declare, queue declare, bind, Qos, Consume).</li>\n<li>Write <code>consumer/processor.go</code>: <code>ClickProcessor</code> struct, <code>NewClickProcessor</code>, <code>Process</code> following § 5.2 exactly.</li>\n<li>Write <code>consumer/processor_test.go</code>: unit tests with mock repositories (§ 11.3).</li>\n<li>Write <code>main.go</code> startup: DB connect, construct repositories, construct processor, launch <code>RunConsumer</code> supervisor goroutine.</li>\n<li>Run <code>docker compose up --build analytics-service</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># From url-service (M3), shorten a URL with a valid JWT and make a redirect:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8083/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> .token</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">CODE</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8081/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://www.example.com\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> .short_code</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> \"http://localhost:8081/</span><span style=\"color:#E1E4E8\">$CODE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> -L</span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> /dev/null</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Wait for outbox poller (url-service) + consumer (analytics-service):</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 5</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify click was inserted:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analytics_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -c</span><span style=\"color:#9ECBFF\"> \"SELECT short_code, clicked_at FROM clicks ORDER BY clicked_at DESC LIMIT 1;\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify processed_events has the event:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analytics_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -c</span><span style=\"color:#9ECBFF\"> \"SELECT event_id, processed_at FROM processed_events ORDER BY processed_at DESC LIMIT 1;\"</span></span></code></pre></div>\n<h3 id=\"phase-4-milestone-detection-milestonereachedevent-publish-115-hr\">Phase 4 — Milestone Detection + MilestoneReachedEvent Publish (1–1.5 hr)</h3>\n<ol>\n<li>Write <code>milestone/detector.go</code>: <code>Thresholds</code>, <code>Detector</code> interface, <code>thresholdDetector</code>, <code>Detect</code>.</li>\n<li>Write <code>milestone/detector_test.go</code> (§ 11.4).</li>\n<li>Write <code>publisher/publisher.go</code>: <code>AMQPPublisher</code> interface, <code>amqp091Publisher</code>.</li>\n<li>Update <code>consumer/processor.go</code>: inject <code>Detector</code> and <code>AMQPPublisher</code>; implement <code>detectAndRecordMilestone</code> (§ 5.3).</li>\n<li>Run <code>go test ./milestone/... -v</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Generate 10 redirect events for the same short_code to cross the first milestone.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> {</span><span style=\"color:#B392F0\">1..10}</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">do</span><span style=\"color:#B392F0\"> curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> \"http://localhost:8081/</span><span style=\"color:#E1E4E8\">$CODE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> -L</span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">done</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 6</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify milestone row:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analytics_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -c</span><span style=\"color:#9ECBFF\"> \"SELECT short_code, milestone, triggered_at FROM milestones;\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 1 row with milestone=10</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify MilestoneReachedEvent in RabbitMQ management UI:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># http://localhost:15672 → Queues → notifications.events → Get Messages</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Should show event with event_type=\"milestone.reached\", milestone=10</span></span></code></pre></div>\n<h3 id=\"phase-5-stats-api-handlers-152-hr\">Phase 5 — Stats API Handlers (1.5–2 hr)</h3>\n<ol>\n<li>Write <code>handler/helpers.go</code>: <code>writeJSON</code>, <code>writeError</code>.</li>\n<li>Write <code>handler/stats.go</code>: <code>NewStatsHandler</code> with errgroup concurrent queries (§ 5.4).</li>\n<li>Write <code>handler/timeline.go</code>: <code>NewTimelineHandler</code> (§ 5.5).</li>\n<li>Write <code>handler/health.go</code>: <code>NewHealthHandler(&quot;analytics-service&quot;, log)</code>.</li>\n<li>Wire routes in <code>main.go</code>.</li>\n<li>Write <code>handler/handler_test.go</code> (§ 11.5).</li>\n<li>Run <code>docker compose up --build analytics-service</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> \"http://localhost:8082/stats/</span><span style=\"color:#E1E4E8\">$CODE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> .</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">#   \"short_code\": \"&#x3C;CODE>\",</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">#   \"total_clicks\": 10,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">#   \"clicks_last_24h\": 10,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">#   \"clicks_last_7d\": 10,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">#   \"top_referers\": []</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># }</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> \"http://localhost:8082/stats/</span><span style=\"color:#E1E4E8\">$CODE</span><span style=\"color:#9ECBFF\">/timeline?interval=hour\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> .</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"short_code\":\"...\", \"interval\":\"hour\", \"points\":[{\"period\":\"2026-...T...Z\",\"clicks\":10}]}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> \"http://localhost:8082/stats/</span><span style=\"color:#E1E4E8\">$CODE</span><span style=\"color:#9ECBFF\">/timeline?interval=invalid\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 400 {\"error\":\"interval must be 'day' or 'hour'\"}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> \"http://localhost:8082/health\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> .</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"status\":\"ok\",\"service\":\"analytics-service\"}</span></span></code></pre></div>\n<h3 id=\"phase-6-idempotency-test-051-hr\">Phase 6 — Idempotency Test (0.5–1 hr)</h3>\n<ol>\n<li>Write <code>consumer/processor_test.go</code> integration test for duplicate delivery (§ 11.3 <code>TestDuplicateEvent_ClickCount1</code>).</li>\n<li>Run with live stack: <code>go test -tags integration ./consumer/... -v -run TestDuplicateEvent</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Direct integration test (described in § 11.3):</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Deliver the same URLClickedEvent JSON twice to analytics.clicks queue.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># After both are processed, clicks table has exactly 1 row for that event_id.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#79B8FF\"> -tags</span><span style=\"color:#9ECBFF\"> integration</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#79B8FF\"> -run</span><span style=\"color:#9ECBFF\"> TestDuplicateEvent</span><span style=\"color:#9ECBFF\"> ./consumer/...</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: PASS</span></span></code></pre></div>\n<hr>\n<h2 id=\"11-test-specification\">11. Test Specification</h2>\n<h3 id=\"111-repositoryclick_repository_testgo-integration\">11.1 <code>repository/click_repository_test.go</code> (integration)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Build tag: //go:build integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Requires: analytics_db running. DSN from TEST_DATABASE_DSN env var.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestClickInsert_HappyPath: Insert click in tx, commit, CountByCode returns 1.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestClickInsert_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestClickInsert_NullReferer: Insert with empty referer → NULL in DB.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify: SELECT referer FROM clicks WHERE ... IS NULL.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestClickInsert_NullReferer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestClickInsert_NonNullReferer: Insert with non-empty referer → stored correctly.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestClickInsert_NonNullReferer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCountSince_24h: Insert 3 clicks: 2 within 24h, 1 older. CountSince(24h) returns 2.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCountSince_24h</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestTopReferers_TopFive: Insert clicks with 6 distinct referers.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TopReferers(code, 5) returns 5 entries, highest count first.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTopReferers_TopFive</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestTopReferers_NullsExcluded: Insert 3 clicks with null referer, 1 with referer.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TopReferers returns only 1 entry.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTopReferers_NullsExcluded</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestTimeline_DayInterval: Insert 3 clicks on same day, 2 on next day.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Timeline(code, \"day\") returns 2 period rows with correct counts.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTimeline_DayInterval</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestTimeline_HourInterval: Insert 2 clicks in hour 14, 1 in hour 15.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Timeline(code, \"hour\") returns 2 rows.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTimeline_HourInterval</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestTimeline_EmptyResult: Timeline for unknown code returns empty slice, not nil.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTimeline_EmptyResult</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCountByCode_NoRows: CountByCode for unknown code returns 0, nil (not error).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCountByCode_NoRows</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"112-repositoryprocessed_event_repository_testgo-integration\">11.2 <code>repository/processed_event_repository_test.go</code> (integration)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// TestIsProcessed_NotFound: unknown event_id returns false, nil.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestIsProcessed_NotFound</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestIsProcessed_AfterMark: MarkProcessed in tx, commit, IsProcessed returns true.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestIsProcessed_AfterMark</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestMarkProcessed_Idempotent: MarkProcessed called twice with same event_id.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Second call returns nil (ON CONFLICT DO NOTHING).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestMarkProcessed_Idempotent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestMarkProcessed_RollsBackWithTx: MarkProcessed in tx, rollback → IsProcessed returns false.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestMarkProcessed_RollsBackWithTx</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"113-consumerprocessor_testgo-unit-integration\">11.3 <code>consumer/processor_test.go</code> (unit + integration)</h3>\n<p><strong>Unit tests</strong> use mock implementations of <code>ClickRepository</code>, <code>ProcessedEventRepository</code>, <code>MilestoneRepository</code>, <code>Detector</code>, <code>AMQPPublisher</code>. Define interfaces in their respective packages so mocks implement them.</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Unit tests (no build tag; mock dependencies):</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_HappyPath: valid URLClickedEvent JSON → ProcessResultInserted returned.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Mock: IsProcessed=false, Insert=nil, MarkProcessed=nil, CountByCode=1, GetLatestMilestone=0, Detect=0.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_MalformedJSON: invalid JSON body → ProcessResultPoisoned.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify: no DB calls made.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_MalformedJSON</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_EmptyEventID: EventID=\"\" → ProcessResultPoisoned.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_EmptyEventID</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_DuplicateEvent: IsProcessed=true → ProcessResultDuplicate.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify: Insert NOT called.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_DuplicateEvent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_InsertFails: Insert returns error → ProcessResultError.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify: MarkProcessed not committed.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_InsertFails</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_MilestoneDetected: Detect returns 10 → InsertMilestone and Publish called.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_MilestoneDetected</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_MilestonePublishFails: Publish returns error → ProcessResultInserted (not error).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Click was committed; milestone saved; publish failure is non-fatal.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_MilestonePublishFails</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_PanicRecovery: mock ClickRepo.Insert panics → Process returns ProcessResultError.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Verify: no panic propagates to caller.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_PanicRecovery</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Integration test (//go:build integration):</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Requires full stack running: analytics_db, rabbitmq.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestDuplicateEvent_ClickCount1:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// 1. Construct a URLClickedEvent with a fixed EventID UUID.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// 2. Marshal to JSON.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// 3. Directly call processor.Process twice with identical amqp091.Delivery.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// 4. Assert: first call returns ProcessResultInserted.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// 5. Assert: second call returns ProcessResultDuplicate.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// 6. Assert: SELECT COUNT(*) FROM clicks WHERE ip_hash = event.IPHash → 1 (not 2).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// 7. Assert: SELECT COUNT(*) FROM processed_events WHERE event_id = eventID → 1.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDuplicateEvent_ClickCount1</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"114-milestonedetector_testgo\">11.4 <code>milestone/detector_test.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// TestDetect_NoThresholdCrossed: latestMilestone=0, newTotal=5 → returns 0.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDetect_NoThresholdCrossed</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestDetect_FirstThreshold: latestMilestone=0, newTotal=10 → returns 10.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDetect_FirstThreshold</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestDetect_FirstThresholdExceeded: latestMilestone=0, newTotal=15 → returns 10.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// (lowest uncrossed threshold, not the exact count)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDetect_FirstThresholdExceeded</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestDetect_AlreadyAtThreshold: latestMilestone=10, newTotal=10 → returns 0.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// (10 is already recorded)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDetect_AlreadyAtThreshold</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestDetect_SkipsToHigher: latestMilestone=10, newTotal=150 → returns 100.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDetect_SkipsToHigher</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestDetect_AllThresholdsCrossed: latestMilestone=0, newTotal=1500 → returns 10.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Only the lowest uncrossed is returned per call.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDetect_AllThresholdsCrossedReturnsLowest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestDetect_BeyondAllThresholds: latestMilestone=1000, newTotal=50000 → returns 0.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDetect_BeyondAllThresholds</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Table-driven test covering all threshold transitions:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDetect_AllTransitions</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// uses t.Run subtests</span></span></code></pre></div>\n<h3 id=\"115-handlerhandler_testgo\">11.5 <code>handler/handler_test.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// All tests use httptest.NewRecorder + httptest.NewRequest.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Mock ClickRepository injected via constructor.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestStats_HappyPath: mock returns total=42, last24h=5, last7d=20, refs=[].</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GET /stats/abc → 200, JSON fields match.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestStats_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestStats_WithReferers: mock TopReferers returns 3 entries.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Response top_referers has 3 items in count-DESC order.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestStats_WithReferers</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestStats_ZeroClicks: all counts return 0. Response is valid JSON with 0s, not null.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestStats_ZeroClicks</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestStats_DBError: mock CountByCode returns error → 500.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestStats_DBError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestStats_TopReferers_NeverNull: even with no referers, top_referers is [] not null.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestStats_TopReferers_NeverNull</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestTimeline_DayInterval: mock returns 3 period rows.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Response points formatted as \"2026-03-02\" strings.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTimeline_DayInterval</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestTimeline_HourInterval: mock returns 2 period rows.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Response points formatted as RFC3339 strings.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTimeline_HourInterval</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestTimeline_InvalidInterval: interval=\"week\" → 400.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTimeline_InvalidInterval</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestTimeline_MissingInterval: no ?interval param → defaults to \"day\", 200.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTimeline_MissingInterval</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestTimeline_EmptyPoints: mock returns empty slice → points:[] not null.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTimeline_EmptyPoints</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestHealth_Returns200: GET /health → 200 {\"status\":\"ok\",\"service\":\"analytics-service\"}.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestHealth_Returns200</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// BenchmarkStats: mock-backed, measure p99 of /stats/:code handler.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Target: &#x3C; 30ms with real DB; &#x3C; 1ms with mocks.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkStats</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// BenchmarkTimeline: mock-backed, measure p99 of /stats/:code/timeline handler.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkTimeline</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-29.svg\" alt=\"GET /stats/:code Query Plan and Data Flow\"></p>\n<hr>\n<h2 id=\"12-performance-targets\">12. Performance Targets</h2>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Target</th>\n<th>How to Measure</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Click ingestion lag (publish → DB insert)</td>\n<td>&lt; 500ms p99</td>\n<td>Timestamp <code>URLClickedEvent.OccurredAt</code> vs <code>clicks.clicked_at</code> insert time; measure with 100 sequential clicks</td>\n</tr>\n<tr>\n<td><code>GET /stats/:code</code> p99 (live DB)</td>\n<td>&lt; 30ms</td>\n<td><code>wrk -t4 -c20 -d30s http://localhost:8082/stats/&lt;code&gt;</code> with 1000+ click rows</td>\n</tr>\n<tr>\n<td><code>GET /stats/:code/timeline?interval=day</code> p99</td>\n<td>&lt; 50ms</td>\n<td><code>wrk -t2 -c10 -d30s</code> with 30 days of data</td>\n</tr>\n<tr>\n<td><code>IsProcessed</code> (indexed SELECT by UUID PK)</td>\n<td>&lt; 5ms</td>\n<td><code>go test -bench=BenchmarkIsProcessed ./repository/...</code></td>\n</tr>\n<tr>\n<td><code>CountByCode</code> (index scan)</td>\n<td>&lt; 10ms</td>\n<td><code>go test -bench=BenchmarkCountByCode ./repository/...</code> with 10,000 click rows</td>\n</tr>\n<tr>\n<td><code>Timeline</code> aggregation (1000 rows, day bucket)</td>\n<td>&lt; 20ms</td>\n<td><code>EXPLAIN ANALYZE</code> on timeline query; benchmark at scale</td>\n</tr>\n<tr>\n<td><code>GET /health</code> p99</td>\n<td>&lt; 10ms</td>\n<td>(inherited from M1)</td>\n</tr>\n<tr>\n<td><code>go test ./...</code> (unit, no DB)</td>\n<td>&lt; 10s</td>\n<td>CI warm build</td>\n</tr>\n<tr>\n<td><code>docker build</code> image size</td>\n<td>&lt; 20MB</td>\n<td><code>docker image ls analytics-service</code></td>\n</tr>\n<tr>\n<td>Milestone detection + publish end-to-end</td>\n<td>&lt; 2s from 10th click commit</td>\n<td>Observe <code>triggered_at</code> in milestones vs click timestamps</td>\n</tr>\n<tr>\n<td>Errgroup concurrency speedup for /stats</td>\n<td>4x vs sequential</td>\n<td>Benchmark with 10ms mock query delay × 4 queries</td>\n</tr>\n<tr>\n<td><strong>Index validation commands:</strong></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Confirm index scan on clicks_short_code_time for CountByCode</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analytics_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  \"EXPLAIN ANALYZE SELECT COUNT(*) FROM clicks WHERE short_code = 'abc' AND clicked_at >= now() - interval '24h';\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Must show: \"Index Scan using idx_clicks_short_code_time\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Confirm partial index for TopReferers</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analytics_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  \"EXPLAIN ANALYZE SELECT referer, COUNT(*) FROM clicks WHERE short_code='abc' AND referer IS NOT NULL GROUP BY referer ORDER BY 2 DESC LIMIT 5;\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Must show: \"Index Scan using idx_clicks_referer\"</span></span></code></pre></div>\n<hr>\n<h2 id=\"13-environment-variable-reference\">13. Environment Variable Reference</h2>\n<table>\n<thead>\n<tr>\n<th>Variable</th>\n<th>Required</th>\n<th>Example</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>PORT</code></td>\n<td>Yes</td>\n<td><code>8082</code></td>\n<td>HTTP listen port</td>\n</tr>\n<tr>\n<td><code>SERVICE_NAME</code></td>\n<td>Yes</td>\n<td><code>analytics-service</code></td>\n<td>Embedded in log lines</td>\n</tr>\n<tr>\n<td><code>DATABASE_DSN</code></td>\n<td>Yes</td>\n<td><code>postgres://analytics_user:analytics_secret@analytics_db:5432/analytics_db?sslmode=disable</code></td>\n<td>analytics_db connection</td>\n</tr>\n<tr>\n<td><code>RABBITMQ_URL</code></td>\n<td>Yes</td>\n<td><code>amqp://admin:admin@rabbitmq:5672/</code></td>\n<td>AMQP broker</td>\n</tr>\n<tr>\n<td><strong>No <code>JWT_SECRET</code></strong> for this milestone — stats endpoints are public. <code>JWT_SECRET</code> is added in M5 if the gateway requires it for proxied requests (gateway validates; analytics-service itself does not validate tokens per spec).</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td><strong>No <code>REDIS_ADDR</code></strong> — analytics-service has no cache. It does not share Redis with url-service or the gateway.</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"14-anti-pattern-guard-rail-checklist\">14. Anti-Pattern Guard Rail Checklist</h2>\n<p>Before completing this milestone, verify:</p>\n<ul>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>No cross-service DB access.</strong> <code>grep -r &quot;url_db\\|user_db\\|notification_db&quot; services/analytics-service/</code> returns nothing.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>No call to url-service on event ingestion.</strong> <code>grep -r &quot;url-service\\|8081&quot; services/analytics-service/</code> returns nothing except comments. Trust the event; do not validate <code>short_code</code> against the URL Service.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>No raw IP storage.</strong> <code>grep -r &quot;RemoteAddr\\|X-Forwarded-For\\|ip_address&quot; services/analytics-service/</code> returns nothing. Only <code>ip_hash</code> (pre-computed by url-service) is stored.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Idempotency implemented.</strong> <code>processed_events</code> table exists with UUID PK. <code>MarkProcessed</code> is called inside the same transaction as <code>Insert</code>. <code>IsProcessed</code> is checked before the transaction begins.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Poison message ACKed, not NACKed.</strong> <code>grep &quot;Ack&quot; services/analytics-service/consumer/</code> shows <code>ProcessResultPoisoned</code> maps to <code>Ack(false)</code>, not <code>Nack</code>.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong><code>/health</code> returns 200 when RabbitMQ is down.</strong> The health handler has no dependency on the AMQP connection. Consumer pauses; service stays up.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Milestone publish failure is non-fatal.</strong> <code>detectAndRecordMilestone</code> logs a warning and returns on publish error. The click transaction is already committed before milestone detection runs.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong><code>date_trunc</code> interval is validated before use.</strong> Handler validates <code>interval ∈ {&quot;day&quot;, &quot;hour&quot;}</code> before passing to <code>Timeline</code>. No raw user input in SQL.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong><code>top_referers</code> is never null in response.</strong> <code>StatsResponse.TopReferers</code> is initialized with <code>make([]RefererItem, 0)</code> when <code>refs</code> is empty — JSON encodes as <code>[]</code>, not <code>null</code>.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong><code>timeline.points</code> is never null in response.</strong> Same initialization pattern.</li>\n</ul>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-30.svg\" alt=\"Timeline date_trunc Bucketing Algorithm\"></p>\n<hr>\n<!-- END_TDD_MOD -->\n\n\n<!-- TDD_MOD_ID: url-shortener-m5 -->\n<h1 id=\"technical-design-specification\">Technical Design Specification</h1>\n<h2 id=\"module-notification-service-api-gateway-circuit-breaker\">Module: Notification Service + API Gateway + Circuit Breaker</h2>\n<h2 id=\"module-id-url-shortener-m5\"><strong>Module ID:</strong> <code>url-shortener-m5</code></h2>\n<h2 id=\"1-module-charter\">1. Module Charter</h2>\n<p>This module delivers the final two infrastructure components that complete the URL shortener system. The <strong>Notification Service</strong> is a pure event consumer: it subscribes to <code>url.created</code>, <code>url.deleted</code>, and <code>milestone.reached</code> events from the <code>notifications.events</code> RabbitMQ queue, persists a notification record per event, logs a mock email send, and exposes a JWT-protected <code>GET /notifications</code> endpoint for paginated retrieval. The <strong>API Gateway</strong> is the sole client-facing entry point: it validates JWTs locally (no user-service call per request), propagates <code>X-Correlation-ID</code>, enforces per-IP token-bucket rate limits via Redis, implements a three-state circuit breaker for the url-service proxy path, and routes all requests to the correct downstream service without containing any domain business logic. The <code>shared/logger</code> package is finalized here and retrofitted into all services with structured JSON fields including <code>correlation_id</code>.\nThis module does <strong>not</strong> implement email delivery (only log output), password reset, push notifications, WebSocket subscriptions, server-sent events, any form of aggregation or analytics within the gateway, load balancing across multiple replicas of a downstream service, OAuth, API keys, or mTLS. The gateway does not call user-service to verify tokens at request time — it uses the shared <code>JWT_SECRET</code> for local HMAC-SHA256 verification identically to every other service. The gateway does not inspect request bodies; it proxies them verbatim.\n<strong>Upstream dependencies:</strong> M1 (Docker Compose stack, <code>shared/events</code>, <code>shared/logger</code>, RabbitMQ, Redis), M2 (<code>shared/auth</code> JWTVerifier, <code>shared/middleware</code> RequireAuth), M3 (url-service on port 8081), M4 (analytics-service on port 8082). The <code>notifications.events</code> queue was declared in M1&#39;s startup but the consumer goroutine is first implemented here.\n<strong>Downstream dependencies:</strong> None. This is the terminal milestone. No subsequent service depends on notification-service or the gateway at the code level.\n<strong>Invariants that must always hold after this milestone:</strong></p>\n<ul>\n<li>The gateway is the only service with a port exposed to clients in production; all downstream services communicate only on the Docker internal <code>backend</code> network.</li>\n<li>A JWT that fails HMAC-SHA256 verification at the gateway never reaches any downstream service.</li>\n<li>The circuit breaker for url-service transitions through exactly three states (Closed → Open → HalfOpen → Closed); a retry loop without state is not a circuit breaker.</li>\n<li>Rate limit counters for <code>/api/shorten</code> and <code>/r/:code</code> are stored in Redis (shared across hypothetical replicas), never in process-local memory.</li>\n<li>If Redis is unavailable when a rate-limit check is attempted, the request is <strong>allowed</strong> (fail-open) and a warning is logged; no traffic is blocked due to a Redis outage.</li>\n<li>Every notification event consumed from RabbitMQ results in exactly one <code>notifications</code> row and one log line, regardless of how many times the event is delivered.</li>\n<li><code>GET /notifications</code> returns only notifications belonging to the authenticated user&#39;s <code>sub</code> claim; cross-user access is impossible.</li>\n</ul>\n<hr>\n<h2 id=\"2-file-structure\">2. File Structure</h2>\n<p>Create files in the numbered order below. All paths are relative to the monorepo root.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-shortener/\n│\n├── services/notification-service/\n│   ├── migrations/\n│   │   └── 01  001_create_notifications.sql\n│   ├── repository/\n│   │   ├── 02  notification_repository.go\n│   │   └── 03  notification_repository_test.go\n│   ├── consumer/\n│   │   ├── 04  consumer.go              # AMQPConsumer setup (reuse M4 pattern)\n│   │   ├── 05  processor.go             # NotificationProcessor: parse + insert + log\n│   │   └── 06  processor_test.go\n│   ├── handler/\n│   │   ├── 07  notifications.go         # GET /notifications (auth required)\n│   │   ├── 08  health.go\n│   │   ├── 09  helpers.go\n│   │   └── 10  handler_test.go\n│   └── 11  main.go\n│\n├── gateway/\n│   ├── circuitbreaker/\n│   │   ├── 12  circuitbreaker.go        # CircuitBreaker state machine\n│   │   └── 13  circuitbreaker_test.go\n│   ├── ratelimit/\n│   │   ├── 14  ratelimit.go             # RateLimiter: Redis INCR + EXPIRE\n│   │   └── 15  ratelimit_test.go\n│   ├── proxy/\n│   │   ├── 16  proxy.go                 # ReverseProxy wrapper\n│   │   └── 17  proxy_test.go\n│   ├── middleware/\n│   │   ├── 18  correlation.go           # X-Correlation-ID inject/propagate\n│   │   ├── 19  jwt.go                   # Gateway JWT middleware (wraps shared/middleware)\n│   │   ├── 20  logging.go              # Request/response structured logging middleware\n│   │   └── 21  middleware_test.go\n│   ├── handler/\n│   │   ├── 22  health.go\n│   │   └── 23  handler_test.go\n│   ├── router/\n│   │   ├── 24  router.go               # Route table + registration\n│   │   └── 25  router_test.go\n│   └── 26  main.go\n│\n└── shared/\n    └── logger/\n        └── 27  logger.go               # Finalized zerolog wrapper (update from M1 stub)</code></pre></div>\n<h2 id=\"total-new-files-27-excluding-auto-generated-gosum-changes-and-files-already-written-in-prior-milestones\"><strong>Total new files: 27</strong> (excluding auto-generated <code>go.sum</code> changes and files already written in prior milestones).</h2>\n<h2 id=\"3-complete-data-model\">3. Complete Data Model</h2>\n<h3 id=\"31-postgresql-schema-migrations001_create_notificationssql\">3.1 PostgreSQL Schema — <code>migrations/001_create_notifications.sql</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- migrations/001_create_notifications.sql</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">BEGIN</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> notifications (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    id           UUID        </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    user_id      UUID        </span><span style=\"color:#F97583\">NOT NULL</span><span style=\"color:#E1E4E8\">,          </span><span style=\"color:#6A737D\">-- JWT sub of the URL owner</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    event_type   </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#E1E4E8\">,          </span><span style=\"color:#6A737D\">-- \"url.created\" | \"url.deleted\" | \"milestone.reached\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    payload      JSONB       </span><span style=\"color:#F97583\">NOT NULL</span><span style=\"color:#E1E4E8\">,          </span><span style=\"color:#6A737D\">-- raw event struct for debugging / future use</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    status</span><span style=\"color:#F97583\">       TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#9ECBFF\"> 'sent'</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#6A737D\">-- 'pending' | 'sent' | 'failed'</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    created_at   </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    sent_at      </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NULL</span><span style=\"color:#6A737D\">               -- set when mock send completes (= created_at in M5)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Primary list query: user's notifications, newest first, cursor-paginated.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_notifications_user_id_created</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> notifications(user_id, created_at </span><span style=\"color:#F97583\">DESC</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Deduplication: each event_id is processed at most once.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Stores the RabbitMQ message's correlation_id + event_type as dedup key.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> processed_notifications (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    event_key    </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        PRIMARY KEY</span><span style=\"color:#E1E4E8\">,   </span><span style=\"color:#6A737D\">-- \"&#x3C;event_type>:&#x3C;correlation_id>\" composite key</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    processed_at </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COMMIT</span><span style=\"color:#E1E4E8\">;</span></span></code></pre></div>\n<p><strong>Field rationale:</strong></p>\n<ul>\n<li><code>user_id UUID NOT NULL</code>: Extracted from <code>URLCreatedEvent.UserID</code>, <code>URLDeletedEvent.UserID</code>, or <code>MilestoneReachedEvent.UserID</code>. This is what makes <code>GET /notifications</code> user-scoped. Stored as UUID even though the column type is UUID — validated during event parse.</li>\n<li><code>event_type TEXT NOT NULL</code>: Matches the RabbitMQ routing key. Stored verbatim for client filtering (future).</li>\n<li><code>payload JSONB NOT NULL</code>: Full event struct persisted for auditability and future re-processing. Not used in M5 API responses but present for operational debugging.</li>\n<li><code>status TEXT NOT NULL DEFAULT &#39;sent&#39;</code>: In M5, all notifications transition immediately from implicit <code>pending</code> to <code>sent</code> synchronously during processing. The column is present for forward-compatibility with async email queues.</li>\n<li><code>sent_at TIMESTAMPTZ NULL</code>: Set to <code>now()</code> when the mock send log line is emitted. Null if processing fails before the log line.</li>\n<li><code>processed_notifications.event_key TEXT PRIMARY KEY</code>: Composite string <code>&quot;&lt;event_type&gt;:&lt;correlation_id&gt;&quot;</code>. Using <code>correlation_id</code> as the dedup discriminator means the same logical notification from the same request is deduplicated. If two genuinely different events share the same <code>correlation_id</code> (pathological case), the second is dropped — acceptable given the low probability and the mock-only email implementation.</li>\n</ul>\n<h3 id=\"32-go-structs-notification-service\">3.2 Go Structs — Notification Service</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/notification_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> repository</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Notification is a single persisted notification record.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Notification</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID        </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // UUID v4, primary key; set by DB DEFAULT</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID    </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // UUID string; JWT sub of the URL owner</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventType </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // routing key: \"url.created\" | \"url.deleted\" | \"milestone.reached\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Payload   []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#6A737D\">    // raw JSON of the event struct</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status    </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // \"pending\" | \"sent\" | \"failed\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // set by DB DEFAULT</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    SentAt    </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // nil until mock send completes</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NotificationSummary is the projection returned by ListByUser.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Omits the raw payload from API responses.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> NotificationSummary</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID        </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // used as cursor value</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID    </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventType </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status    </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    SentAt    </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Sentinel errors</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrNotificationNotFound </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"notification not found\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handler/notifications.go — API response types</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> handler</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NotificationListResponse is the JSON body returned by GET /notifications.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> NotificationListResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Notifications []</span><span style=\"color:#B392F0\">NotificationItem</span><span style=\"color:#9ECBFF\"> `json:\"notifications\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    NextCursor    </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">            `json:\"next_cursor,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NotificationItem is a single entry in the list response.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> NotificationItem</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventType </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"event_type\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"status\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"created_at\"`</span><span style=\"color:#6A737D\"> // RFC3339</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    SentAt    </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"sent_at,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"33-go-structs-circuit-breaker\">3.3 Go Structs — Circuit Breaker</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// gateway/circuitbreaker/circuitbreaker.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> circuitbreaker</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync/atomic</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// State represents the circuit breaker's current operating mode.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> State</span><span style=\"color:#F97583\"> int32</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    StateClosed</span><span style=\"color:#B392F0\">   State</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> iota</span><span style=\"color:#6A737D\"> // Normal operation; requests flow through.</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    StateOpen</span><span style=\"color:#6A737D\">                  // Failure threshold exceeded; requests rejected immediately.</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    StateHalfOpen</span><span style=\"color:#6A737D\">              // Probe mode; one request allowed through to test recovery.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Config holds the circuit breaker's tuning parameters.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // FailureThreshold is the number of consecutive failures within Window</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // required to trip the circuit from Closed → Open.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    FailureThreshold </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Window is the observation period for counting failures.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Failures older than Window do not count toward the threshold.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Window </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // OpenDuration is how long the circuit stays Open before transitioning</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // to HalfOpen and allowing a single probe request.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OpenDuration </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// DefaultConfig returns the spec-required settings.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   FailureThreshold: 5 consecutive failures</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Window:          10 seconds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   OpenDuration:    30 seconds</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> DefaultConfig</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        FailureThreshold: </span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Window:           </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        OpenDuration:     </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CircuitBreaker implements the three-state pattern for a single downstream target.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// All exported methods are goroutine-safe.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> CircuitBreaker</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg            </span><span style=\"color:#B392F0\">Config</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu             </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Mutex</span><span style=\"color:#6A737D\">    // protects state, failureCount, lastFailureAt, openedAt</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    state          </span><span style=\"color:#B392F0\">State</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    failureCount   </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">           // consecutive failures in the current window</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    lastFailureAt  </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\">     // time of the most recent failure; used for window reset</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    openedAt       </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\">     // time the circuit transitioned to Open</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewCircuitBreaker constructs a CircuitBreaker in the Closed state.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">cfg</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CircuitBreaker</span></span></code></pre></div>\n<h3 id=\"34-go-structs-rate-limiter\">3.4 Go Structs — Rate Limiter</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// gateway/ratelimit/ratelimit.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> ratelimit</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/redis/go-redis/v9</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/rs/zerolog</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RateLimiter implements per-IP token-bucket rate limiting using Redis INCR + EXPIRE.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Each IP+route combination has an independent counter with a fixed window.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RateLimiter</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span><span style=\"color:#6A737D\">  // may be nil (fail-open on Redis unavailability)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log    </span><span style=\"color:#B392F0\">zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewRateLimiter constructs a RateLimiter.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// client may be nil — the RateLimiter fails open when client is nil.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewRateLimiter</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">client</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RateLimiter</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// AllowResult is the outcome of a rate limit check.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> AllowResult</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Allowed    </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RetryAfter </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // > 0 when Allowed=false; seconds to wait</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Remaining  </span><span style=\"color:#F97583\">int64</span><span style=\"color:#6A737D\">         // requests remaining in the current window (informational)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RouteLimit defines the rate limit policy for one route class.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RouteLimit</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Key    </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">        // route identifier; used as part of Redis key prefix</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Limit  </span><span style=\"color:#F97583\">int64</span><span style=\"color:#6A737D\">         // max requests per Window per IP</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Window </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // sliding-window duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Pre-defined route limits (from spec):</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    LimitShorten </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> RouteLimit</span><span style=\"color:#E1E4E8\">{Key: </span><span style=\"color:#9ECBFF\">\"shorten\"</span><span style=\"color:#E1E4E8\">, Limit: </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, Window: time.Minute}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    LimitRedirect </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> RouteLimit</span><span style=\"color:#E1E4E8\">{Key: </span><span style=\"color:#9ECBFF\">\"redirect\"</span><span style=\"color:#E1E4E8\">, Limit: </span><span style=\"color:#79B8FF\">300</span><span style=\"color:#E1E4E8\">, Window: time.Minute}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"35-go-structs-gateway-proxy\">3.5 Go Structs — Gateway Proxy</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// gateway/proxy/proxy.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> proxy</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http/httputil</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/url</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/rs/zerolog</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// DownstreamTarget represents a single upstream service the gateway routes to.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> DownstreamTarget</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Name    </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">   // service name for logging: \"url-service\", etc.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    BaseURL </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">url</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URL</span><span style=\"color:#6A737D\"> // parsed base URL; e.g. http://url-service:8081</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ReverseProxy wraps httputil.ReverseProxy with error handling and logging.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ReverseProxy</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    targets </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">httputil</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ReverseProxy</span><span style=\"color:#6A737D\"> // keyed by target.Name</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log     </span><span style=\"color:#B392F0\">zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // HTTP client shared across all proxies; controls timeouts.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client  </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ProxyConfig configures the reverse proxy behavior.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ProxyConfig</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DialTimeout           </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // default: 5s</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ResponseHeaderTimeout </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // default: 30s (spec: 30s timeout counts as failure)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MaxIdleConnsPerHost   </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">           // default: 10</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"36-structured-log-entry-finalized-schema\">3.6 Structured Log Entry (finalized schema)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// shared/logger/logger.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// LogFields documents the canonical set of structured fields on every log line.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// This is documentation only; actual emission uses zerolog's fluent API.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// All services MUST produce logs conforming to this schema.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> LogFields</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Level         </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"level\"`</span><span style=\"color:#6A737D\">           // \"debug\"|\"info\"|\"warn\"|\"error\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Time          </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">  `json:\"time\"`</span><span style=\"color:#6A737D\">             // Unix milliseconds (zerolog.TimeFormatUnixMs)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Service       </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"service\"`</span><span style=\"color:#6A737D\">          // injected at logger construction</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CorrelationID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"correlation_id\"`</span><span style=\"color:#6A737D\">   // from X-Correlation-ID; \"\" if not available</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Method        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"method\"`</span><span style=\"color:#6A737D\">           // HTTP method; \"\" for non-request logs</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Path          </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"path\"`</span><span style=\"color:#6A737D\">             // HTTP path; \"\" for non-request logs</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status        </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">    `json:\"status\"`</span><span style=\"color:#6A737D\">           // HTTP response status; 0 for non-request logs</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DurationMS    </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">  `json:\"duration_ms\"`</span><span style=\"color:#6A737D\">      // handler duration; 0 for non-request logs</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Msg           </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"msg\"`</span><span style=\"color:#6A737D\">              // human-readable message</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-31.svg\" alt=\"API Gateway Internal Module Architecture\"></p>\n<hr>\n<h2 id=\"4-interface-contracts\">4. Interface Contracts</h2>\n<h3 id=\"41-notificationrepository\">4.1 <code>NotificationRepository</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// repository/notification_repository.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NotificationRepository defines persistence for notification records.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// All implementations must be safe for concurrent use.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> NotificationRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert writes a new notification row and sets sent_at = now() atomically.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Uses the pool directly (no external transaction; the notification service</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // has no dual-write requirement — there is no outbox here).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns a wrapped error on DB failure.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">n</span><span style=\"color:#B392F0\"> Notification</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ListByUser returns a cursor-paginated list of notifications for userID,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ordered by created_at DESC (newest first).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // afterID: if non-empty, returns rows with (created_at, id) strictly less</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //          than the anchor row identified by afterID (same cursor logic as M3).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // limit: maximum rows to return; caller passes pageSize+1 to detect next page.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns empty slice (not nil) when no rows match.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    ListByUser</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">userID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">afterID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">limit</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">NotificationSummary</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // IsProcessed checks whether eventKey exists in processed_notifications.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns true if found, false on not-found or DB error (fail-open for idempotency).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    IsProcessed</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">eventKey</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // MarkProcessed inserts eventKey into processed_notifications.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ON CONFLICT DO NOTHING makes this idempotent.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Uses pool directly (same connection as Insert is not required — see § 5.2).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    MarkProcessed</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">eventKey</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<p><strong>SQL queries:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- Insert</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">INSERT INTO</span><span style=\"color:#E1E4E8\"> notifications (user_id, event_type, payload, </span><span style=\"color:#F97583\">status</span><span style=\"color:#E1E4E8\">, sent_at)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">VALUES</span><span style=\"color:#E1E4E8\"> ($</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, $</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, $</span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">'sent'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">now</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">RETURNING id, created_at</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- ListByUser (with cursor)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SELECT</span><span style=\"color:#E1E4E8\"> id, user_id, event_type, </span><span style=\"color:#F97583\">status</span><span style=\"color:#E1E4E8\">, created_at, sent_at</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> notifications</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> user_id </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  AND</span><span style=\"color:#E1E4E8\"> ($</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">::uuid </span><span style=\"color:#F97583\">IS</span><span style=\"color:#F97583\"> NULL</span><span style=\"color:#F97583\"> OR</span><span style=\"color:#E1E4E8\"> (created_at, id) </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      SELECT</span><span style=\"color:#E1E4E8\"> created_at, id </span><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> notifications </span><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> id </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">::uuid</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  ))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">ORDER BY</span><span style=\"color:#E1E4E8\"> created_at </span><span style=\"color:#F97583\">DESC</span><span style=\"color:#E1E4E8\">, id </span><span style=\"color:#F97583\">DESC</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">LIMIT</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">3</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- IsProcessed</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">SELECT</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#F97583\"> FROM</span><span style=\"color:#E1E4E8\"> processed_notifications </span><span style=\"color:#F97583\">WHERE</span><span style=\"color:#E1E4E8\"> event_key </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> $</span><span style=\"color:#79B8FF\">1</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- MarkProcessed</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">INSERT INTO</span><span style=\"color:#E1E4E8\"> processed_notifications (event_key) </span><span style=\"color:#F97583\">VALUES</span><span style=\"color:#E1E4E8\"> ($</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">ON</span><span style=\"color:#E1E4E8\"> CONFLICT (event_key) DO NOTHING</span></span></code></pre></div>\n<h3 id=\"42-circuitbreaker\">4.2 <code>CircuitBreaker</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// gateway/circuitbreaker/circuitbreaker.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Allow checks whether a request should be forwarded to the downstream service.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns (true, nil) in Closed or HalfOpen state (probe allowed).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns (false, ErrCircuitOpen) in Open state — caller must return 503.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns (false, ErrCircuitOpen) in HalfOpen state if a probe is already in-flight</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   (HalfOpen allows exactly ONE concurrent probe; subsequent calls are rejected).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// State transition rules (enforced inside Allow with mu held):</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Closed:   always returns true.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Open:     if time.Since(openedAt) >= cfg.OpenDuration → transition to HalfOpen.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//             Still in cooldown → return false.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   HalfOpen: if no probe in-flight → mark probe in-flight, return true.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//             Probe already in-flight → return false (treat as Open).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">cb </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CircuitBreaker</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Allow</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RecordSuccess notifies the circuit breaker that the last proxied request succeeded.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// State transition rules:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Closed:   reset failureCount to 0.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   HalfOpen: transition to Closed, clear probe in-flight flag, reset failureCount.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Open:     no-op (should not receive success in Open state; log warning).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">cb </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CircuitBreaker</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RecordSuccess</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RecordFailure notifies the circuit breaker that the last proxied request failed.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// A failure is defined as: HTTP 5xx response from downstream, or a timeout/connection error.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// State transition rules:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Closed:   increment failureCount; if failureCount >= cfg.FailureThreshold</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//             AND time.Since(lastFailureAt) &#x3C;= cfg.Window → trip to Open; record openedAt.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//             If time.Since(lastFailureAt) > cfg.Window → reset failureCount to 1 (new window).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   HalfOpen: probe failed → transition back to Open; record new openedAt; clear probe flag.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Open:     no-op (should not receive failure in Open state; log warning).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">cb </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CircuitBreaker</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RecordFailure</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// State returns the current state without acquiring the mutex (uses atomic read).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Callers use this for observability/logging only — do not make routing decisions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// based on this value; use Allow() for that (which holds the mutex).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">cb </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CircuitBreaker</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">State</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">State</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ErrCircuitOpen is returned by Allow when the circuit is in Open or HalfOpen-no-probe state.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> ErrCircuitOpen </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"circuit breaker open\"</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong>State machine invariants:</strong></p>\n<ul>\n<li><code>failureCount</code> is always 0 in <code>StateOpen</code> and <code>StateHalfOpen</code>.</li>\n<li><code>openedAt.IsZero()</code> is true only in <code>StateClosed</code>.</li>\n<li>The probe in-flight flag is a <code>bool</code> field <code>probeInFlight</code> protected by <code>mu</code>. It is set to <code>true</code> when <code>Allow()</code> transitions HalfOpen → allows probe, and cleared by <code>RecordSuccess()</code> or <code>RecordFailure()</code> from HalfOpen.</li>\n</ul>\n<h3 id=\"43-ratelimiter\">4.3 <code>RateLimiter</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// gateway/ratelimit/ratelimit.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Allow checks whether the request from ip should be permitted for the given route policy.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Redis key format: \"ratelimit:{route.Key}:{ip}\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Example: \"ratelimit:shorten:192.168.1.1\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Algorithm (atomic at Redis server level):</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   1. INCR \"ratelimit:{route.Key}:{ip}\" → current count</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   2. If current count == 1: EXPIRE key route.Window (sets TTL on first request in window)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   3. If current count > route.Limit: return AllowResult{Allowed: false, RetryAfter: TTL of key}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   4. Else: return AllowResult{Allowed: true, Remaining: route.Limit - current}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// If Redis client is nil or any Redis error occurs:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Log warning with error details.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Return AllowResult{Allowed: true} — fail-open; do NOT block traffic.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RetryAfter is obtained via TTL command after the INCR reveals the limit is exceeded.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TTL returns the remaining seconds; if TTL returns -1 (no expiry), use route.Window as fallback.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Parameters:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   ctx:   request context; used for Redis call timeout</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   ip:    client IP string extracted from X-Forwarded-For or RemoteAddr</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   route: RouteLimit policy for this endpoint</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns AllowResult. Never returns an error — all errors result in fail-open.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">rl </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RateLimiter</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Allow</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">ip</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">route</span><span style=\"color:#B392F0\"> RouteLimit</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">AllowResult</span></span></code></pre></div>\n<p><strong>Redis command sequence (INCR + conditional EXPIRE):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Implementation inside Allow:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">pipe </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> rl.client.</span><span style=\"color:#B392F0\">Pipeline</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">incrCmd </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> pipe.</span><span style=\"color:#B392F0\">Incr</span><span style=\"color:#E1E4E8\">(ctx, key)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Conditional EXPIRE only on first request avoids resetting TTL on every request.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Use a Lua script for atomic INCR+EXPIRE-if-new:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> luaIncrExpire</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> `</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">local current = redis.call('INCR', KEYS[1])</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">if current == 1 then</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    redis.call('EXPIRE', KEYS[1], ARGV[1])</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">end</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">return current</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">`</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Execute as a single atomic script — no pipeline needed:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">result, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> rl.client.</span><span style=\"color:#B392F0\">Eval</span><span style=\"color:#E1E4E8\">(ctx, luaIncrExpire, []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{key},</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    int</span><span style=\"color:#E1E4E8\">(route.Window.</span><span style=\"color:#B392F0\">Seconds</span><span style=\"color:#E1E4E8\">())).</span><span style=\"color:#B392F0\">Int64</span><span style=\"color:#E1E4E8\">()</span></span></code></pre></div>\n<p><strong>Why Lua script over pipeline:</strong> A pipeline of INCR + EXPIRE is not atomic — two concurrent requests could both INCR and both see <code>current == 1</code>, causing double EXPIRE. The Lua script executes atomically at the Redis server, making this race impossible.</p>\n<h3 id=\"44-reverseproxyforward\">4.4 <code>ReverseProxy.Forward</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// gateway/proxy/proxy.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Forward proxies the incoming request to the named target service.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// targetName must match a key in rp.targets (registered at construction).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Injects X-Correlation-ID into the forwarded request if not already present.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Sets X-Forwarded-For with the client IP.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// On success: streams the downstream response to w verbatim (headers + body).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// On target not found: writes 502 {\"error\":\"unknown upstream\"}.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// On proxy error (connection refused, timeout, circuit open):</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   The circuitBreaker parameter (passed at construction per-target) handles</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   RecordFailure() before this function returns; caller must not double-record.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Timeout: ResponseHeaderTimeout=30s is enforced by the underlying http.Client.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// A timeout error is treated as a downstream failure for circuit breaker purposes.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">rp </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">ReverseProxy</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Forward</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">targetName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<p><strong><code>httputil.ReverseProxy</code> error hook:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Set on the httputil.ReverseProxy at construction:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">proxy.ErrorHandler </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Err</span><span style=\"color:#E1E4E8\">(err).</span><span style=\"color:#B392F0\">Str</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"target\"</span><span style=\"color:#E1E4E8\">, targetName).</span><span style=\"color:#B392F0\">Msg</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"proxy error\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">RecordFailure</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    writeJSON</span><span style=\"color:#E1E4E8\">(w, http.StatusBadGateway, </span><span style=\"color:#B392F0\">ErrorResponse</span><span style=\"color:#E1E4E8\">{Error: </span><span style=\"color:#9ECBFF\">\"upstream error\"</span><span style=\"color:#E1E4E8\">})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ModifyResponse is used to intercept 5xx from downstream:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">proxy.ModifyResponse </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">resp</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Response</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> resp.StatusCode </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> 500</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        cb.</span><span style=\"color:#B392F0\">RecordFailure</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        cb.</span><span style=\"color:#B392F0\">RecordSuccess</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"45-correlation-middleware\">4.5 Correlation Middleware</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// gateway/middleware/correlation.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CorrelationMiddleware is an http.Handler wrapper that:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  1. Reads X-Correlation-ID from the incoming request header.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  2. If absent or empty, generates a new UUID v4.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  3. Sets X-Correlation-ID on the request before passing to next.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  4. Sets X-Correlation-ID on the response.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  5. Stores the correlation ID in the request context under correlationIDKey.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// All downstream forwarded requests carry this header.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// All log lines within the request's context use this ID.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> CorrelationMiddleware</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">next</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CorrelationIDFromContext retrieves the correlation ID stored by CorrelationMiddleware.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns empty string if not present (should not happen after middleware runs).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> CorrelationIDFromContext</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// contextKey type is unexported to prevent collisions.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> contextKey</span><span style=\"color:#F97583\"> string</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> correlationIDKey</span><span style=\"color:#B392F0\"> contextKey</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"correlation_id\"</span></span></code></pre></div>\n<h3 id=\"46-gateway-jwt-middleware\">4.6 Gateway JWT Middleware</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// gateway/middleware/jwt.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GatewayJWTMiddleware returns an http.Handler wrapper that:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  1. Reads Authorization: Bearer &#x3C;token> from the incoming request.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  2. Verifies the token using the shared JWTVerifier (local HMAC; no network call).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  3. On success: forwards the request to next, adding X-User-ID and X-User-Email</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//     headers with values from the verified claims (so downstream services can</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//     optionally trust these without re-verifying).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//  4. On failure: returns 401 {\"error\":\"unauthorized\"} immediately;</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//     the downstream service never receives the request.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Routes exempt from JWT validation: POST /api/auth/register, POST /api/auth/login.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// These are matched by path prefix \"/api/auth/\"; all other /api/* routes require JWT.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GET /r/:code does NOT require JWT (public redirect).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GET /health does NOT require JWT.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// verifier: a shared/auth.JWTVerifier constructed with JWT_SECRET from environment.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// log: structured logger with \"service\":\"gateway\" pre-set.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> GatewayJWTMiddleware</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">verifier</span><span style=\"color:#B392F0\"> sharedauth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">JWTVerifier</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span></span></code></pre></div>\n<h3 id=\"47-sharedloggernew\">4.7 <code>shared/logger.New</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// shared/logger/logger.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// New returns a zerolog.Logger configured for structured JSON output.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// serviceName is embedded in every log line as \"service\".</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// w is the output writer; pass os.Stdout in production.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Configuration applied:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   zerolog.TimeFieldFormat = zerolog.TimeFormatUnixMs</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Level: zerolog.InfoLevel (overridable via LOG_LEVEL env var: debug|info|warn|error)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   CallerSkipFrameCount: 2 (so Caller() reports the actual call site, not the logger wrapper)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// The returned Logger is value-safe to copy and store in structs.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// No global zerolog.GlobalLevel is set — each service sets its own level.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">serviceName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> io</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Writer</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// WithCorrelationID returns a child logger with correlation_id field added.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Call at the start of each HTTP request handler with the ID from context.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Usage: log := logger.WithCorrelationID(baseLog, correlationID)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> WithCorrelationID</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">correlationID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RequestLogger returns an http.Handler middleware that logs each request/response.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Emits one log line per request with all LogFields populated.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Extracts correlation_id from context (set by CorrelationMiddleware).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> RequestLogger</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-32.svg\" alt=\"Gateway Request Pipeline — Full Sequence\"></p>\n<hr>\n<h2 id=\"5-algorithm-specification\">5. Algorithm Specification</h2>\n<h3 id=\"51-notification-processor-full-algorithm\">5.1 Notification Processor — Full Algorithm</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE NotificationProcessor.Process(ctx, d amqp091.Delivery) ProcessResult:\n  -- Step 0: Panic recovery (defer at top)\n  DEFER recover() → log.Error, return ProcessResultError\n  -- Step 1: Determine event type from routing key or payload\n  routingKey = d.RoutingKey  -- &quot;url.created&quot; | &quot;url.deleted&quot; | &quot;milestone.reached&quot;\n  -- Step 2: Parse into the correct event struct based on routing key\n  SWITCH routingKey:\n  CASE &quot;url.created&quot;:\n    var event events.URLCreatedEvent\n    IF json.Unmarshal(d.Body, &amp;event) fails → log.Error, return ProcessResultPoisoned\n    userID = event.UserID\n    userEmail = event.UserEmail\n    correlationID = event.CorrelationID\n    message = fmt.Sprintf(&quot;New short URL created: %s → %s&quot;, event.ShortCode, event.OriginalURL)\n  CASE &quot;url.deleted&quot;:\n    var event events.URLDeletedEvent\n    IF json.Unmarshal(d.Body, &amp;event) fails → log.Error, return ProcessResultPoisoned\n    userID = event.UserID\n    userEmail = event.UserEmail\n    correlationID = event.CorrelationID\n    message = fmt.Sprintf(&quot;Short URL deleted: %s&quot;, event.ShortCode)\n  CASE &quot;milestone.reached&quot;:\n    var event events.MilestoneReachedEvent\n    IF json.Unmarshal(d.Body, &amp;event) fails → log.Error, return ProcessResultPoisoned\n    userID = event.UserID\n    userEmail = event.UserEmail\n    correlationID = event.CorrelationID\n    message = fmt.Sprintf(&quot;Milestone reached: %d clicks on %s&quot;, event.Milestone, event.ShortCode)\n  DEFAULT:\n    log.Warn().Str(&quot;routing_key&quot;, routingKey).Msg(&quot;unknown routing key; ACKing&quot;)\n    return ProcessResultPoisoned\n  -- Step 3: Validate required fields\n  IF userID == &quot;&quot; OR correlationID == &quot;&quot;:\n    log.Error().Str(&quot;routing_key&quot;, routingKey).Msg(&quot;missing user_id or correlation_id; ACKing&quot;)\n    return ProcessResultPoisoned\n  -- Step 4: Build dedup key\n  eventKey = routingKey + &quot;:&quot; + correlationID\n  -- Step 5: Idempotency pre-check\n  already, _ = repo.IsProcessed(ctx, eventKey)  -- errors treated as false (fail-open)\n  IF already:\n    log.Debug().Str(&quot;event_key&quot;, eventKey).Msg(&quot;duplicate notification; skipping&quot;)\n    return ProcessResultDuplicate\n  -- Step 6: Insert notification row\n  n = Notification{\n      UserID:    userID,\n      EventType: routingKey,\n      Payload:   d.Body,\n      Status:    &quot;sent&quot;,\n  }\n  IF repo.Insert(ctx, n) fails:\n    log.Error().Err(err).Msg(&quot;notification insert failed&quot;)\n    return ProcessResultError\n  -- Step 7: Mock send — log the notification\n  log.Info().\n      Str(&quot;correlation_id&quot;, correlationID).\n      Str(&quot;event_type&quot;, routingKey).\n      Str(&quot;user_email&quot;, userEmail).\n      Str(&quot;message&quot;, message).\n      Msg(&quot;would send email to user&quot;)\n  -- Step 8: Mark processed (after successful insert + log)\n  IF repo.MarkProcessed(ctx, eventKey) fails:\n    -- Insert succeeded; log error but don't fail the message.\n    -- On redelivery, Insert will create a second row (acceptable: dedup pre-check\n    -- returned false, so re-run will create a duplicate notification but not crash).\n    -- Accept this rare edge case; it requires a service crash between step 6 and step 8.\n    log.Error().Err(err).Str(&quot;event_key&quot;, eventKey).Msg(&quot;mark processed failed; duplicate possible on redeliver&quot;)\n  return ProcessResultInserted\nEND PROCEDURE</code></pre></div>\n<p><strong>Why MarkProcessed is NOT in the same transaction as Insert:</strong> The notification service has no dual-write requirement (no outbox, no RabbitMQ publish from within the notification handler). Using two sequential DB operations (Insert, then MarkProcessed) simplifies the code. The rare crash-between-operations case creates a duplicate notification row — acceptable given mock email delivery in M5.</p>\n<h3 id=\"52-circuit-breaker-state-machine-detailed-transitions\">5.2 Circuit Breaker State Machine — Detailed Transitions</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE CircuitBreaker.Allow() (bool, error):\n  cb.mu.Lock()\n  DEFER cb.mu.Unlock()\n  SWITCH cb.state:\n  CASE StateClosed:\n    return true, nil\n  CASE StateOpen:\n    IF time.Since(cb.openedAt) &gt;= cb.cfg.OpenDuration:\n      -- Cooldown elapsed; transition to HalfOpen for probe\n      cb.state = StateHalfOpen\n      cb.probeInFlight = true\n      cb.failureCount = 0\n      return true, nil   -- this request IS the probe\n    ELSE:\n      return false, ErrCircuitOpen\n  CASE StateHalfOpen:\n    IF cb.probeInFlight:\n      -- A probe is already in-flight; reject this request\n      return false, ErrCircuitOpen\n    ELSE:\n      -- Edge case: HalfOpen but no probe in-flight (should not happen; defensive)\n      cb.probeInFlight = true\n      return true, nil\n  END SWITCH\nEND PROCEDURE\nPROCEDURE CircuitBreaker.RecordSuccess():\n  cb.mu.Lock()\n  DEFER cb.mu.Unlock()\n  SWITCH cb.state:\n  CASE StateClosed:\n    cb.failureCount = 0    -- reset window counter\n  CASE StateHalfOpen:\n    -- Probe succeeded; circuit healed\n    cb.state = StateClosed\n    cb.probeInFlight = false\n    cb.failureCount = 0\n    cb.openedAt = time.Time{}   -- zero value signals Closed state\n  CASE StateOpen:\n    cb.log.Warn().Msg(&quot;circuit breaker: RecordSuccess called in Open state (unexpected)&quot;)\n  END SWITCH\nEND PROCEDURE\nPROCEDURE CircuitBreaker.RecordFailure():\n  cb.mu.Lock()\n  DEFER cb.mu.Unlock()\n  now = time.Now()\n  SWITCH cb.state:\n  CASE StateClosed:\n    -- Check if this failure is within the current window\n    IF cb.failureCount == 0 OR now.Sub(cb.lastFailureAt) &gt; cb.cfg.Window:\n      -- New window; start fresh\n      cb.failureCount = 1\n    ELSE:\n      cb.failureCount++\n    cb.lastFailureAt = now\n    IF cb.failureCount &gt;= cb.cfg.FailureThreshold:\n      -- Trip to Open\n      cb.state = StateOpen\n      cb.openedAt = now\n      cb.failureCount = 0\n      cb.log.Warn().\n          Int(&quot;threshold&quot;, cb.cfg.FailureThreshold).\n          Dur(&quot;window&quot;, cb.cfg.Window).\n          Msg(&quot;circuit breaker tripped to Open&quot;)\n  CASE StateHalfOpen:\n    -- Probe failed; return to Open with fresh openedAt\n    cb.state = StateOpen\n    cb.openedAt = now\n    cb.probeInFlight = false\n    cb.failureCount = 0\n    cb.log.Warn().Msg(&quot;circuit breaker half-open probe failed; returning to Open&quot;)\n  CASE StateOpen:\n    cb.log.Warn().Msg(&quot;circuit breaker: RecordFailure called in Open state (unexpected)&quot;)\n  END SWITCH\nEND PROCEDURE</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-33.svg\" alt=\"Circuit Breaker State Machine\"></p>\n<h3 id=\"53-gateway-request-routing-algorithm\">5.3 Gateway Request Routing Algorithm</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE GatewayRouter.ServeHTTP(w http.ResponseWriter, r *http.Request):\n  -- Middleware chain (applied in order, outermost first):\n  -- 1. CorrelationMiddleware — generate/propagate X-Correlation-ID\n  -- 2. RequestLogger — log all requests (applied after correlation to capture ID)\n  -- 3. GatewayJWTMiddleware — validate JWT for /api/* routes except /api/auth/*\n  -- 4. RateLimitMiddleware — apply per-IP limits based on route pattern\n  -- 5. Route-specific handler (proxy forward or error response)\n  path = r.URL.Path\n  -- Route matching (evaluated in specificity order):\n  MATCH path:\n  CASE &quot;GET /health&quot;:\n    → handler.NewHealthHandler(&quot;gateway&quot;, log)\n  CASE &quot;POST /api/auth/register&quot;:\n    → NO JWT required\n    → NO rate limit\n    → rp.Forward(&quot;user-service&quot;, w, r)\n  CASE &quot;POST /api/auth/login&quot;:\n    → NO JWT required\n    → NO rate limit\n    → rp.Forward(&quot;user-service&quot;, w, r)\n    -- Strip /api prefix: forward as POST /login to user-service\n  CASE &quot;GET /r/{code}&quot;:\n    → NO JWT required\n    → RateLimitMiddleware(LimitRedirect)\n    → circuitBreaker.Allow() check\n    → rp.Forward(&quot;url-service&quot;, w, r)\n    -- Forward as GET /{code}\n  CASE &quot;POST /api/shorten&quot;:\n    → JWT required\n    → RateLimitMiddleware(LimitShorten)\n    → circuitBreaker.Allow() check\n    → rp.Forward(&quot;url-service&quot;, w, r)\n    -- Forward as POST /shorten\n  CASE &quot;GET /api/urls&quot;:\n    → JWT required\n    → rp.Forward(&quot;url-service&quot;, w, r)\n    -- Forward as GET /urls\n  CASE &quot;DELETE /api/urls/{code}&quot;:\n    → JWT required\n    → rp.Forward(&quot;url-service&quot;, w, r)\n  CASE &quot;GET /api/stats/{code}&quot;:\n    → NO JWT required (public stats)\n    → rp.Forward(&quot;analytics-service&quot;, w, r)\n    -- Forward as GET /stats/{code}\n  CASE &quot;GET /api/stats/{code}/timeline&quot;:\n    → NO JWT required\n    → rp.Forward(&quot;analytics-service&quot;, w, r)\n  CASE &quot;GET /api/me&quot;:\n    → JWT required\n    → rp.Forward(&quot;user-service&quot;, w, r)\n    -- Forward as GET /me\n  CASE &quot;GET /api/notifications&quot;:\n    → JWT required\n    → rp.Forward(&quot;notification-service&quot;, w, r)\n    -- Forward as GET /notifications\n  DEFAULT:\n    → 404 {&quot;error&quot;:&quot;not found&quot;}\n  END MATCH\nEND PROCEDURE</code></pre></div>\n<p><strong>Path stripping:</strong> The gateway routes <code>/api/shorten</code> to url-service as <code>/shorten</code>. Use <code>httputil.ReverseProxy</code> with a custom <code>Director</code> that strips the <code>/api</code> prefix for all <code>/api/*</code> forwarding. The <code>/r/{code}</code> path strips <code>/r</code> and forwards as <code>/{code}</code>. The <code>/api/auth/*</code> paths strip <code>/api/auth</code> and forward as <code>/*</code> (e.g., <code>/register</code>, <code>/login</code>).</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Director function for url-service proxy:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">director </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">req</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.URL.Scheme </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> target.Scheme</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.URL.Host </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> target.Host</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Strip /api prefix</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.URL.Path </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> strings.</span><span style=\"color:#B392F0\">TrimPrefix</span><span style=\"color:#E1E4E8\">(req.URL.Path, </span><span style=\"color:#9ECBFF\">\"/api\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Preserve query string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.Header.</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Forwarded-For\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">extractClientIP</span><span style=\"color:#E1E4E8\">(req))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.Header.</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Correlation-ID\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">CorrelationIDFromContext</span><span style=\"color:#E1E4E8\">(req.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">()))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"54-rate-limit-middleware-integration\">5.4 Rate Limit Middleware Integration</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE RateLimitMiddleware(route RouteLimit, rl *RateLimiter) func(http.Handler) http.Handler:\n  RETURN func(next http.Handler) http.Handler:\n    RETURN http.HandlerFunc(func(w http.ResponseWriter, r *http.Request):\n      ip = extractClientIP(r)\n      result = rl.Allow(r.Context(), ip, route)\n      IF !result.Allowed:\n        retryAfterSecs = int(result.RetryAfter.Seconds())\n        IF retryAfterSecs &lt; 1: retryAfterSecs = 1\n        w.Header().Set(&quot;Retry-After&quot;, strconv.Itoa(retryAfterSecs))\n        w.Header().Set(&quot;X-RateLimit-Limit&quot;, strconv.FormatInt(route.Limit, 10))\n        w.Header().Set(&quot;X-RateLimit-Remaining&quot;, &quot;0&quot;)\n        writeJSON(w, http.StatusTooManyRequests, ErrorResponse{Error: &quot;rate limit exceeded&quot;})\n        return\n      next.ServeHTTP(w, r)\n    )\nEND PROCEDURE</code></pre></div>\n<h3 id=\"55-circuit-breaker-middleware-integration\">5.5 Circuit Breaker Middleware Integration</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE CircuitBreakerMiddleware(cb *CircuitBreaker) func(http.Handler) http.Handler:\n  RETURN func(next http.Handler) http.Handler:\n    RETURN http.HandlerFunc(func(w http.ResponseWriter, r *http.Request):\n      allowed, err = cb.Allow()\n      IF !allowed:\n        log.Warn().Str(&quot;path&quot;, r.URL.Path).Msg(&quot;circuit breaker open; rejecting request&quot;)\n        writeJSON(w, http.StatusServiceUnavailable,\n            ErrorResponse{Error: &quot;service unavailable&quot;})\n        return\n      -- Request is allowed (Closed state or HalfOpen probe)\n      -- RecordSuccess/RecordFailure is called inside ReverseProxy.ModifyResponse\n      -- and ReverseProxy.ErrorHandler — not here. This avoids double-recording.\n      next.ServeHTTP(w, r)\n    )\nEND PROCEDURE</code></pre></div>\n<p><strong>Sequence of middleware for url-service routes:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>CorrelationMiddleware\n  → RequestLogger\n    → GatewayJWTMiddleware (if /api/*)\n      → RateLimitMiddleware (if shorten or redirect)\n        → CircuitBreakerMiddleware (url-service routes only)\n          → ReverseProxy.Forward(&quot;url-service&quot;, ...)</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-34.svg\" alt=\"Circuit Breaker Struct Memory Layout\"></p>\n<h3 id=\"56-structured-logging-propagation-across-services\">5.6 Structured Logging Propagation Across Services</h3>\n<p>Every HTTP handler in every service must:</p>\n<ol>\n<li>Extract <code>X-Correlation-ID</code> from the request header at the start of the handler.</li>\n<li>Call <code>logger.WithCorrelationID(baseLog, correlationID)</code> to get a request-scoped logger.</li>\n<li>Use the request-scoped logger for all log calls within that handler&#39;s execution path.</li>\n<li>When making outbound HTTP calls (not applicable in M5 for services other than gateway), forward the <code>X-Correlation-ID</code> header.\n<strong>Request logger middleware (applied in all services, not just gateway):</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// shared/logger/logger.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> RequestLogger</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">log</span><span style=\"color:#B392F0\"> zerolog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">next</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            start </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            correlationID </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> r.Header.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Correlation-ID\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            reqLog </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> log.</span><span style=\"color:#B392F0\">With</span><span style=\"color:#E1E4E8\">().</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                Str</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"correlation_id\"</span><span style=\"color:#E1E4E8\">, correlationID).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                Str</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"method\"</span><span style=\"color:#E1E4E8\">, r.Method).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                Str</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"path\"</span><span style=\"color:#E1E4E8\">, r.URL.Path).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                Logger</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // Wrap ResponseWriter to capture status code</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            rw </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">responseWriter</span><span style=\"color:#E1E4E8\">{ResponseWriter: w, status: http.StatusOK}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            next.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(rw, r)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            reqLog.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">().</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                Int</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"status\"</span><span style=\"color:#E1E4E8\">, rw.status).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                Int64</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"duration_ms\"</span><span style=\"color:#E1E4E8\">, time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(start).</span><span style=\"color:#B392F0\">Milliseconds</span><span style=\"color:#E1E4E8\">()).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                Msg</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"request completed\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// responseWriter wraps http.ResponseWriter to capture the written status code.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> responseWriter</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    status </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">rw </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">responseWriter</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">code</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rw.status </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> code</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rw.ResponseWriter.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n<h3 id=\"57-get-notifications-handler-algorithm\">5.7 GET /notifications Handler Algorithm</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE HandleListNotifications(w http.ResponseWriter, r *http.Request):\n  claims, ok = middleware.ClaimsFromContext(r.Context())  -- from RequireAuth\n  IF !ok → 401 {&quot;error&quot;:&quot;unauthorized&quot;}\n  afterCursor = r.URL.Query().Get(&quot;after&quot;)\n  pageSizeStr = r.URL.Query().Get(&quot;limit&quot;)\n  pageSize = 20  -- default\n  IF pageSizeStr != &quot;&quot;:\n    pageSize, err = strconv.Atoi(pageSizeStr)\n    IF err OR pageSize &lt; 1 → 400 {&quot;error&quot;:&quot;limit must be a positive integer&quot;}\n  pageSize = clamp(pageSize, 1, 100)\n  rows, err = repo.ListByUser(r.Context(), claims.Sub, afterCursor, pageSize+1)\n  IF err → 500 + log.Error\n  hasMore = len(rows) &gt; pageSize\n  IF hasMore:\n    rows = rows[:pageSize]\n  var nextCursor *string\n  IF hasMore:\n    last = rows[len(rows)-1].ID\n    nextCursor = &amp;last\n  items = make([]NotificationItem, len(rows))\n  FOR i, n := range rows:\n    items[i] = NotificationItem{\n        ID:        n.ID,\n        EventType: n.EventType,\n        Status:    n.Status,\n        CreatedAt: n.CreatedAt.UTC().Format(time.RFC3339),\n    }\n    IF n.SentAt != nil:\n      s = n.SentAt.UTC().Format(time.RFC3339)\n      items[i].SentAt = &amp;s\n  writeJSON(w, 200, NotificationListResponse{\n      Notifications: items,\n      NextCursor:    nextCursor,\n  })\nEND PROCEDURE</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-35.svg\" alt=\"Token Bucket Rate Limiter — Redis INCR + EXPIRE Algorithm\"></p>\n<h3 id=\"58-gateway-startup-sequence\">5.8 Gateway Startup Sequence</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PROCEDURE GatewayMain():\n  1. Parse all env vars with mustGetEnv; abort on missing.\n  2. log = logger.New(&quot;gateway&quot;, os.Stdout)\n  3. redisClient, err = ConnectRedis(ctx, redisAddr)\n     IF err: log.Warn — rate limiter will fail-open\n  4. verifier = sharedauth.NewJWTVerifier([]byte(jwtSecret))\n  5. rateLimiter = ratelimit.NewRateLimiter(redisClient, log)\n  6. urlServiceCB = circuitbreaker.NewCircuitBreaker(circuitbreaker.DefaultConfig())\n  7. Construct ReverseProxy with targets:\n       &quot;url-service&quot;           → URL_SERVICE_URL\n       &quot;analytics-service&quot;     → ANALYTICS_SERVICE_URL\n       &quot;user-service&quot;          → USER_SERVICE_URL\n       &quot;notification-service&quot;  → NOTIFICATION_SERVICE_URL\n     Each target gets its own httputil.ReverseProxy instance.\n     url-service proxy gets urlServiceCB injected into ModifyResponse + ErrorHandler.\n     Other proxies have no circuit breaker in M5 (only url-service specified).\n  8. Perform startup health checks (§ 5.2 of M1 spec) — log warnings for unhealthy.\n  9. Build mux via router.New(...) — inject all dependencies.\n  10. Apply middleware stack:\n       handler = CorrelationMiddleware(\n           RequestLogger(log)(\n               mux\n           )\n       )\n      Note: JWT and rate limit middleware are applied per-route, not globally.\n  11. Start http.Server on PORT with:\n       ReadTimeout:  5s\n       WriteTimeout: 35s  -- 30s proxy timeout + 5s overhead\n       IdleTimeout:  120s\n  12. Block on server.ListenAndServe.\n  13. On SIGTERM: server.Shutdown(10s context).\nEND PROCEDURE</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-36.svg\" alt=\"Redis Key Namespace Layout (Dual Role)\"></p>\n<hr>\n<h2 id=\"6-state-machine-circuit-breaker\">6. State Machine: Circuit Breaker</h2>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>States: Closed → Open → HalfOpen → Closed\n        HalfOpen → Open (on probe failure)\nTransitions:\n  Closed  →[failureCount &gt;= threshold within window]→ Open\n  Open    →[openDuration elapsed, Allow() called]→ HalfOpen\n  HalfOpen→[RecordSuccess()]→ Closed\n  HalfOpen→[RecordFailure()]→ Open (new openedAt)\nIllegal transitions (must never occur):\n  Closed  → HalfOpen  (must pass through Open)\n  Open    → Closed    (must pass through HalfOpen probe)\n  HalfOpen→ HalfOpen  (no self-transition; probe resolves to Closed or Open)\n  Any state → any state without mutex held\nHalfOpen probe semantics:\n  - At most ONE request is allowed through as a probe.\n  - All other concurrent requests during HalfOpen → rejected (treated as Open).\n  - probeInFlight bool is the single-probe enforcement mechanism.\n  - probeInFlight is set true in Allow(), cleared in RecordSuccess() or RecordFailure().\nFailure counting semantics (Closed state):\n  - failureCount resets to 1 (not 0) when a failure arrives after Window elapsed.\n  - This models a sliding window: failures in the previous window don't count.\n  - Consecutive failures within Window accumulate; non-consecutive failures may not trip.\nObservability:\n  - State() method uses atomic int32 read for lock-free observability.\n  - State field is a State (int32); transitions write with mu held, read atomically.</code></pre></div>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Atomic state read (no mutex):</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">cb </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CircuitBreaker</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">State</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">State</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#B392F0\"> State</span><span style=\"color:#E1E4E8\">(atomic.</span><span style=\"color:#B392F0\">LoadInt32</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#F97583\">*int32</span><span style=\"color:#E1E4E8\">)(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">cb.state)))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// State transitions write the state field while holding mu:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// cb.state = StateOpen  (inside mu-protected block)</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-37.svg\" alt=\"X-Correlation-ID Propagation Across Sync and Async Boundaries\"></p>\n<hr>\n<h2 id=\"7-error-handling-matrix\">7. Error Handling Matrix</h2>\n<h3 id=\"notification-service\">Notification Service</h3>\n<table>\n<thead>\n<tr>\n<th>Error</th>\n<th>Detected By</th>\n<th>Recovery</th>\n<th>ACK/NACK</th>\n<th>Logged?</th>\n<th>Notes</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>MALFORMED_JSON</code></td>\n<td><code>json.Unmarshal</code></td>\n<td>Log error, ACK</td>\n<td>ACK</td>\n<td>Error</td>\n<td>Poison message</td>\n</tr>\n<tr>\n<td><code>UNKNOWN_ROUTING_KEY</code></td>\n<td>routing key switch</td>\n<td>Log warn, ACK</td>\n<td>ACK</td>\n<td>Warn</td>\n<td>Future-proof; unknown events dropped</td>\n</tr>\n<tr>\n<td><code>MISSING_USER_ID</code></td>\n<td>field validation</td>\n<td>Log error, ACK</td>\n<td>ACK</td>\n<td>Error</td>\n<td>Event schema violation</td>\n</tr>\n<tr>\n<td><code>DUPLICATE_EVENT</code></td>\n<td><code>IsProcessed</code> → true</td>\n<td>Log debug, ACK</td>\n<td>ACK</td>\n<td>Debug</td>\n<td>Normal at-least-once redelivery</td>\n</tr>\n<tr>\n<td><code>INSERT_FAIL</code></td>\n<td><code>repo.Insert</code></td>\n<td>Log error, NACK requeue</td>\n<td>NACK</td>\n<td>Error</td>\n<td>Transient DB error</td>\n</tr>\n<tr>\n<td><code>MARK_PROCESSED_FAIL</code></td>\n<td><code>repo.MarkProcessed</code></td>\n<td>Log error, ACK</td>\n<td>ACK</td>\n<td>Error</td>\n<td>Insert succeeded; rare redelivery possible</td>\n</tr>\n<tr>\n<td><code>CONSUMER_PANIC</code></td>\n<td><code>recover()</code> in supervisor</td>\n<td>Log error, restart after 5s</td>\n<td>N/A</td>\n<td>Error</td>\n<td>Delivery not ACKed; broker redelivers</td>\n</tr>\n<tr>\n<td><code>AMQP_DISCONNECTED</code></td>\n<td>Delivery channel closed</td>\n<td>Log warn, reconnect loop</td>\n<td>N/A</td>\n<td>Warn</td>\n<td><code>/health</code> still 200</td>\n</tr>\n<tr>\n<td><code>LIST_NOTIFICATIONS_DB_FAIL</code></td>\n<td><code>repo.ListByUser</code></td>\n<td>Log error, 500</td>\n<td>N/A</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td><code>JWT_MISSING</code></td>\n<td><code>RequireAuth</code> middleware</td>\n<td>401</td>\n<td>N/A</td>\n<td>No</td>\n<td></td>\n</tr>\n<tr>\n<td><code>JWT_INVALID</code></td>\n<td><code>RequireAuth</code> middleware</td>\n<td>401</td>\n<td>N/A</td>\n<td>Warn</td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"api-gateway\">API Gateway</h3>\n<table>\n<thead>\n<tr>\n<th>Error</th>\n<th>Detected By</th>\n<th>HTTP Status</th>\n<th>Response Body</th>\n<th>Logged?</th>\n<th>Notes</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>RATE_LIMIT_EXCEEDED</code></td>\n<td><code>RateLimiter.Allow</code> → false</td>\n<td>429</td>\n<td><code>{&quot;error&quot;:&quot;rate limit exceeded&quot;}</code></td>\n<td>No</td>\n<td><code>Retry-After</code> header set</td>\n</tr>\n<tr>\n<td><code>CIRCUIT_OPEN</code></td>\n<td><code>CircuitBreaker.Allow</code> → false</td>\n<td>503</td>\n<td><code>{&quot;error&quot;:&quot;service unavailable&quot;}</code></td>\n<td>Warn</td>\n<td>Only for url-service routes</td>\n</tr>\n<tr>\n<td><code>JWT_INVALID</code></td>\n<td><code>GatewayJWTMiddleware</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>Warn</td>\n<td>Request never forwarded</td>\n</tr>\n<tr>\n<td><code>JWT_MISSING</code></td>\n<td><code>GatewayJWTMiddleware</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>No</td>\n<td></td>\n</tr>\n<tr>\n<td><code>JWT_EXPIRED</code></td>\n<td><code>GatewayJWTMiddleware</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>No</td>\n<td>No expiry detail in response</td>\n</tr>\n<tr>\n<td><code>DOWNSTREAM_5XX</code></td>\n<td><code>ModifyResponse</code> status check</td>\n<td>Proxied as-is</td>\n<td>Downstream body</td>\n<td>Warn + RecordFailure</td>\n<td>Client sees the 5xx</td>\n</tr>\n<tr>\n<td><code>DOWNSTREAM_TIMEOUT</code></td>\n<td><code>ErrorHandler</code> + context deadline</td>\n<td>502</td>\n<td><code>{&quot;error&quot;:&quot;upstream error&quot;}</code></td>\n<td>Error + RecordFailure</td>\n<td>30s timeout</td>\n</tr>\n<tr>\n<td><code>DOWNSTREAM_CONN_REFUSED</code></td>\n<td><code>ErrorHandler</code></td>\n<td>502</td>\n<td><code>{&quot;error&quot;:&quot;upstream error&quot;}</code></td>\n<td>Error + RecordFailure</td>\n<td>Service down</td>\n</tr>\n<tr>\n<td><code>REDIS_DOWN_FOR_RATE_LIMIT</code></td>\n<td><code>RateLimiter</code> nil client or error</td>\n<td>200 (allowed)</td>\n<td>—</td>\n<td>Warn</td>\n<td>Fail-open: never block traffic</td>\n</tr>\n<tr>\n<td><code>UNKNOWN_ROUTE</code></td>\n<td>mux default</td>\n<td>404</td>\n<td><code>{&quot;error&quot;:&quot;not found&quot;}</code></td>\n<td>No</td>\n<td></td>\n</tr>\n<tr>\n<td><code>UPSTREAM_UNKNOWN</code></td>\n<td><code>ReverseProxy.Forward</code> no target</td>\n<td>502</td>\n<td><code>{&quot;error&quot;:&quot;unknown upstream&quot;}</code></td>\n<td>Error</td>\n<td>Programming error</td>\n</tr>\n<tr>\n<td><code>CORRELATION_ID_MISSING</code></td>\n<td><code>CorrelationMiddleware</code></td>\n<td>—</td>\n<td>—</td>\n<td>No</td>\n<td>Generated transparently</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"8-route-registration-in-gatewaymaingo\">8. Route Registration in <code>gateway/main.go</code></h2>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// gateway/main.go — full route table with middleware chains</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Build each route's middleware stack explicitly.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// net/http 1.22 method+path patterns used throughout.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">jwtMw </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> middleware.</span><span style=\"color:#B392F0\">GatewayJWTMiddleware</span><span style=\"color:#E1E4E8\">(verifier, log)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">rateLimitShorten  </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> middleware.</span><span style=\"color:#B392F0\">RateLimitMiddleware</span><span style=\"color:#E1E4E8\">(ratelimit.LimitShorten, rateLimiter, log)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">rateLimitRedirect </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> middleware.</span><span style=\"color:#B392F0\">RateLimitMiddleware</span><span style=\"color:#E1E4E8\">(ratelimit.LimitRedirect, rateLimiter, log)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">cbMw </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> middleware.</span><span style=\"color:#B392F0\">CircuitBreakerMiddleware</span><span style=\"color:#E1E4E8\">(urlServiceCB, log)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">NewServeMux</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Health — no auth, no rate limit</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /health\"</span><span style=\"color:#E1E4E8\">, handler.</span><span style=\"color:#B392F0\">NewHealthHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"gateway\"</span><span style=\"color:#E1E4E8\">, log))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Auth routes — no JWT, no rate limit, no circuit breaker</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST /api/auth/register\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    chain</span><span style=\"color:#E1E4E8\">(rp.</span><span style=\"color:#B392F0\">HandlerFor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"user-service\"</span><span style=\"color:#E1E4E8\">)))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST /api/auth/login\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    chain</span><span style=\"color:#E1E4E8\">(rp.</span><span style=\"color:#B392F0\">HandlerFor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"user-service\"</span><span style=\"color:#E1E4E8\">)))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Public redirect — rate limited, circuit broken</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /r/{code}\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    rateLimitRedirect</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">cbMw</span><span style=\"color:#E1E4E8\">(rp.</span><span style=\"color:#B392F0\">HandlerFor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">))))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URL service — JWT + rate limit (shorten) + circuit breaker</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST /api/shorten\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    jwtMw</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">rateLimitShorten</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">cbMw</span><span style=\"color:#E1E4E8\">(rp.</span><span style=\"color:#B392F0\">HandlerFor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">)))))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /api/urls\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    jwtMw</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">cbMw</span><span style=\"color:#E1E4E8\">(rp.</span><span style=\"color:#B392F0\">HandlerFor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">))))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DELETE /api/urls/{code}\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    jwtMw</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">cbMw</span><span style=\"color:#E1E4E8\">(rp.</span><span style=\"color:#B392F0\">HandlerFor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">))))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Analytics — public</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /api/stats/{code}\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rp.</span><span style=\"color:#B392F0\">HandlerFor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"analytics-service\"</span><span style=\"color:#E1E4E8\">))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /api/stats/{code}/timeline\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rp.</span><span style=\"color:#B392F0\">HandlerFor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"analytics-service\"</span><span style=\"color:#E1E4E8\">))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// User service — JWT</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /api/me\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    jwtMw</span><span style=\"color:#E1E4E8\">(rp.</span><span style=\"color:#B392F0\">HandlerFor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"user-service\"</span><span style=\"color:#E1E4E8\">)))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Notification service — JWT</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /api/notifications\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    jwtMw</span><span style=\"color:#E1E4E8\">(rp.</span><span style=\"color:#B392F0\">HandlerFor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"notification-service\"</span><span style=\"color:#E1E4E8\">)))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Global middleware (outermost)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">handler </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> middleware.</span><span style=\"color:#B392F0\">CorrelationMiddleware</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    logger.</span><span style=\"color:#B392F0\">RequestLogger</span><span style=\"color:#E1E4E8\">(log)(mux),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h2 id=\"rphandlerforname-string-httphandler-returns-a-pre-built-httphandler-that-calls-rpforwardname-w-r-for-the-named-downstream-target-this-enables-clean-composition-with-the-middleware-chain-diagramtdd-diag-38\"><strong><code>rp.HandlerFor(name string) http.Handler</code></strong> returns a pre-built <code>http.Handler</code> that calls <code>rp.Forward(name, w, r)</code> for the named downstream target. This enables clean composition with the middleware chain.\n{{DIAGRAM:tdd-diag-38}}</h2>\n<h2 id=\"9-concurrency-specification\">9. Concurrency Specification</h2>\n<h3 id=\"91-circuit-breaker\">9.1 Circuit Breaker</h3>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Access Pattern</th>\n<th>Protection</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>state</code></td>\n<td>Written under <code>mu</code>; read via <code>atomic.LoadInt32</code></td>\n<td><code>sync.Mutex</code> for writes; atomic for reads</td>\n</tr>\n<tr>\n<td><code>failureCount</code></td>\n<td>Read and written under <code>mu</code></td>\n<td><code>sync.Mutex</code></td>\n</tr>\n<tr>\n<td><code>lastFailureAt</code></td>\n<td>Read and written under <code>mu</code></td>\n<td><code>sync.Mutex</code></td>\n</tr>\n<tr>\n<td><code>openedAt</code></td>\n<td>Read and written under <code>mu</code></td>\n<td><code>sync.Mutex</code></td>\n</tr>\n<tr>\n<td><code>probeInFlight</code></td>\n<td>Read and written under <code>mu</code></td>\n<td><code>sync.Mutex</code></td>\n</tr>\n<tr>\n<td><strong>Lock ordering:</strong> There is only one mutex in <code>CircuitBreaker</code>. No lock ordering issue is possible.</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td><strong>Concurrent Allow + RecordFailure:</strong> <code>Allow()</code> acquires <code>mu</code>, reads state, potentially transitions, returns. <code>RecordFailure()</code> also acquires <code>mu</code>. If multiple goroutines call <code>Allow()</code> concurrently (one probe is allowed through, others rejected), <code>probeInFlight</code> prevents multiple probes. The mutex serializes all state access — no TOCTOU window.</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"92-rate-limiter\">9.2 Rate Limiter</h3>\n<p>The Lua script executes atomically on the Redis server. No local locking is required in the Go process. Concurrent requests from the same IP for the same route each independently call <code>Eval</code> on the Lua script — Redis serializes them server-side. The <code>*redis.Client</code> connection pool is goroutine-safe per <code>go-redis</code> documentation.</p>\n<h3 id=\"93-reverse-proxy\">9.3 Reverse Proxy</h3>\n<p><code>httputil.ReverseProxy</code> is goroutine-safe — each <code>ServeHTTP</code> call handles one request independently. The <code>Director</code>, <code>ModifyResponse</code>, and <code>ErrorHandler</code> functions are called within the goroutine serving that request. <code>RecordSuccess()</code> and <code>RecordFailure()</code> on the circuit breaker are called from these hooks and are protected by the circuit breaker&#39;s mutex.</p>\n<h3 id=\"94-notification-consumer\">9.4 Notification Consumer</h3>\n<p>Identical single-goroutine consumer pattern to analytics-service (M4 § 8.1). Prefetch=1 enforces sequential processing. No shared mutable state within the processor goroutine. <code>*pgxpool.Pool</code> is goroutine-safe.</p>\n<h3 id=\"95-gateway-http-server\">9.5 Gateway HTTP Server</h3>\n<p><code>net/http</code> launches one goroutine per request. All state that handlers read (circuit breaker, rate limiter, proxy targets, JWT verifier) is either:</p>\n<ul>\n<li>Immutable after construction (proxy targets, JWT verifier secret)</li>\n<li>Goroutine-safe via internal locking (circuit breaker mutex, Redis client)</li>\n<li>Goroutine-safe at Redis server level (rate limit counters)\nNo global mutable variables exist in the gateway codebase.\n{{DIAGRAM:tdd-diag-39}}</li>\n</ul>\n<hr>\n<h2 id=\"10-implementation-sequence-with-checkpoints\">10. Implementation Sequence with Checkpoints</h2>\n<h3 id=\"phase-1-notification-service-schema-consumer-api-225-hr\">Phase 1 — Notification Service: Schema + Consumer + API (2–2.5 hr)</h3>\n<ol>\n<li>Write <code>migrations/001_create_notifications.sql</code> (§ 3.1).</li>\n<li>Apply migration:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">   docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#79B8FF\"> -i</span><span style=\"color:#9ECBFF\"> notification_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> notification_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> notification_db</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">     &#x3C;</span><span style=\"color:#9ECBFF\"> services/notification-service/migrations/001_create_notifications.sql</span></span></code></pre></div>\n<ol start=\"3\">\n<li>Verify: <code>docker exec notification_db psql -U notification_user -d notification_db -c &quot;\\d notifications&quot;</code>.</li>\n<li>Write <code>repository/notification_repository.go</code>: <code>Notification</code>, <code>NotificationSummary</code>, <code>NotificationRepository</code> interface, <code>pgxNotificationRepository</code>, all four methods.</li>\n<li>Write <code>consumer/consumer.go</code>: <code>NewAMQPConsumer</code> — declare exchange (idempotent), declare <code>notifications.events</code> queue with three bindings (<code>url.created</code>, <code>url.deleted</code>, <code>milestone.reached</code>), set Qos(1).</li>\n<li>Write <code>consumer/processor.go</code>: <code>NotificationProcessor</code>, <code>Process</code> following § 5.1.</li>\n<li>Write <code>handler/notifications.go</code>: <code>HandleListNotifications</code> (§ 5.7) behind <code>RequireAuth</code>.</li>\n<li>Wire <code>main.go</code>: DB connect, repositories, processor, consumer supervisor goroutine, routes.</li>\n<li>Run <code>docker compose up --build notification-service</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Trigger a URLCreatedEvent via url-service:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8083/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> .token</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8081/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://notification-test.example.com\"}'</span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> /dev/null</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 5</span><span style=\"color:#6A737D\">  # outbox poller + notification consumer</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify notification row:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> exec</span><span style=\"color:#9ECBFF\"> notification_db</span><span style=\"color:#9ECBFF\"> psql</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> notification_user</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> notification_db</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -c</span><span style=\"color:#9ECBFF\"> \"SELECT event_type, status, sent_at FROM notifications ORDER BY created_at DESC LIMIT 1;\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: event_type=url.created, status=sent, sent_at IS NOT NULL</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Check logs for mock email:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> logs</span><span style=\"color:#9ECBFF\"> notification-service</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#9ECBFF\"> \"would send email\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: at least one \"would send email to user\" log line</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># List notifications via API:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8084/notifications</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> .</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"notifications\":[{\"id\":\"...\",\"event_type\":\"url.created\",\"status\":\"sent\",...}],\"next_cursor\":null}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Wrong user:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN2</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8083/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"bob@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> .token</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8084/notifications</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN2</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> '.notifications | length'</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 0 (bob has no notifications)</span></span></code></pre></div>\n<h3 id=\"phase-2-sharedlogger-finalize-structured-logger-115-hr\">Phase 2 — shared/logger: Finalize Structured Logger (1–1.5 hr)</h3>\n<ol>\n<li>Finalize <code>shared/logger/logger.go</code>: <code>New</code>, <code>WithCorrelationID</code>, <code>RequestLogger</code>, <code>responseWriter</code> (§ 4.7, § 5.6).</li>\n<li>Run <code>go test ./... -v</code> in <code>shared/</code>.</li>\n<li>Update all services&#39; <code>main.go</code> to use <code>logger.RequestLogger(log)</code> as a middleware around the mux.</li>\n<li>Verify structured output: <code>docker compose logs url-service 2&gt;&amp;1 | head -5 | python3 -m json.tool</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8081/health</span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> /dev/null</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> logs</span><span style=\"color:#9ECBFF\"> url-service</span><span style=\"color:#F97583\"> 2>&#x26;1</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> tail</span><span style=\"color:#79B8FF\"> -3</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> python3</span><span style=\"color:#79B8FF\"> -m</span><span style=\"color:#9ECBFF\"> json.tool</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected output contains fields: level, time, service, correlation_id, method, path, status, duration_ms, msg</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># correlation_id should be present (empty string or UUID if called via gateway)</span></span></code></pre></div>\n<h3 id=\"phase-3-gateway-routing-reverse-proxy-correlation-middleware-225-hr\">Phase 3 — Gateway: Routing + Reverse Proxy + Correlation Middleware (2–2.5 hr)</h3>\n<ol>\n<li>Add <code>github.com/google/uuid</code> to <code>gateway/go.mod</code>.</li>\n<li>Write <code>middleware/correlation.go</code>: <code>CorrelationMiddleware</code>, <code>CorrelationIDFromContext</code> (§ 4.5).</li>\n<li>Write <code>proxy/proxy.go</code>: <code>ReverseProxy</code>, <code>Forward</code>, <code>HandlerFor</code>, director with path stripping, <code>ModifyResponse</code>, <code>ErrorHandler</code> (§ 4.4).</li>\n<li>Write <code>router/router.go</code>: full route table from § 8 (stubs for JWT + rate limit — wire them as pass-through for now).</li>\n<li>Write <code>handler/health.go</code>: <code>NewHealthHandler(&quot;gateway&quot;, log)</code>.</li>\n<li>Write <code>gateway/main.go</code>: env parsing, startup health checks, server configuration.</li>\n<li>Run <code>docker compose up --build gateway</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Direct proxy test:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8080/health</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> .</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: {\"status\":\"ok\",\"service\":\"gateway\"}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Auth passthrough (no JWT enforcement yet):</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/auth/register</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"charlie@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#9ECBFF\"> .</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 201 {\"user_id\":\"...\",\"email\":\"charlie@example.com\"}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Correlation ID propagation:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#9ECBFF\"> http://localhost:8080/health</span><span style=\"color:#F97583\"> 2>&#x26;1</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#9ECBFF\"> \"X-Correlation-ID\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: response header X-Correlation-ID: &#x3C;uuid></span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Pass custom correlation ID:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"X-Correlation-ID: test-corr-id-001\"</span><span style=\"color:#9ECBFF\"> http://localhost:8080/health</span><span style=\"color:#F97583\"> 2>&#x26;1</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#9ECBFF\"> \"X-Correlation-ID\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: response header X-Correlation-ID: test-corr-id-001 (echoed back)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Gateway logs show correlation_id: \"test-corr-id-001\"</span></span></code></pre></div>\n<h3 id=\"phase-4-gateway-jwt-middleware-115-hr\">Phase 4 — Gateway: JWT Middleware (1–1.5 hr)</h3>\n<ol>\n<li>Write <code>middleware/jwt.go</code>: <code>GatewayJWTMiddleware</code> (§ 4.6).</li>\n<li>Wire JWT middleware into route table for all <code>/api/*</code> routes except <code>/api/auth/*</code>.</li>\n<li>Add <code>JWT_SECRET</code> to <code>gateway/</code> environment block in <code>docker-compose.yml</code>.</li>\n<li>Write <code>middleware/middleware_test.go</code>: JWT middleware tests (§ 11.3).</li>\n<li>Run <code>docker compose up --build gateway</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Protected route without JWT:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/urls</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer invalidtoken\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 401</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Auth route without JWT (should pass to user-service):</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/auth/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"wrongpass\"}'</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 401 (from user-service, not gateway JWT check)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Protected route with valid JWT:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/auth/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> .token</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/urls</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 200</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># X-User-ID header forwarded to downstream:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Check url-service logs after above request; should contain user_id from JWT claims</span></span></code></pre></div>\n<h3 id=\"phase-5-gateway-redis-rate-limiter-152-hr\">Phase 5 — Gateway: Redis Rate Limiter (1.5–2 hr)</h3>\n<ol>\n<li>Write <code>ratelimit/ratelimit.go</code>: <code>RateLimiter</code>, <code>Allow</code>, Lua script (§ 4.3).</li>\n<li>Write <code>ratelimit/ratelimit_test.go</code>: unit + integration tests (§ 11.4).</li>\n<li>Write <code>middleware/logging.go</code> (rate limit logging).</li>\n<li>Wire <code>RateLimitMiddleware</code> for <code>POST /api/shorten</code> (LimitShorten) and <code>GET /r/{code}</code> (LimitRedirect).</li>\n<li>Run <code>go test ./ratelimit/... -v</code>.</li>\n<li>Run <code>docker compose up --build gateway</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Rate limit test: POST /api/shorten 11 times from same IP</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/auth/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> .token</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> {</span><span style=\"color:#B392F0\">1..11}</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  STATUS</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    -d</span><span style=\"color:#9ECBFF\"> \"{</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">url</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">https://rate-limit-test.com/</span><span style=\"color:#E1E4E8\">$i</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">}\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span><span style=\"color:#9ECBFF\"> \"Request </span><span style=\"color:#E1E4E8\">$i</span><span style=\"color:#9ECBFF\">: </span><span style=\"color:#E1E4E8\">$STATUS</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">done</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: requests 1-10 return 201, request 11 returns 429</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify Retry-After header on 11th request:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\\n\"</span><span style=\"color:#79B8FF\"> -D</span><span style=\"color:#9ECBFF\"> -</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://rate-limit-test.com/12\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#79B8FF\"> -E</span><span style=\"color:#9ECBFF\"> \"429|Retry-After\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 429 + Retry-After: &#x3C;seconds></span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Redis down fail-open test:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> stop</span><span style=\"color:#9ECBFF\"> redis</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://redis-down-test.com\"}'</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 201 (not 503 — fail-open)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> start</span><span style=\"color:#9ECBFF\"> redis</span></span></code></pre></div>\n<h3 id=\"phase-6-gateway-circuit-breaker-152-hr\">Phase 6 — Gateway: Circuit Breaker (1.5–2 hr)</h3>\n<ol>\n<li>Write <code>circuitbreaker/circuitbreaker.go</code>: <code>CircuitBreaker</code>, <code>Allow</code>, <code>RecordSuccess</code>, <code>RecordFailure</code>, <code>State</code> (§ 4.2, § 5.2).</li>\n<li>Write <code>circuitbreaker/circuitbreaker_test.go</code> (§ 11.2).</li>\n<li>Wire <code>CircuitBreakerMiddleware</code> for url-service routes.</li>\n<li>Run <code>go test ./circuitbreaker/... -v</code>.</li>\n<li>Run <code>docker compose up --build gateway</code>.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Trip the circuit breaker by making url-service return 5xx:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Stop url-service to cause connection refused (counts as failure):</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> stop</span><span style=\"color:#9ECBFF\"> url-service</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># 5 requests should trip the breaker:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/auth/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> .token</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> {</span><span style=\"color:#B392F0\">1..5}</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code} \"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    http://localhost:8080/api/urls</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">done</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 502 502 502 502 502</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># 6th request should get circuit breaker response (503):</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/urls</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 503 {\"error\":\"service unavailable\"}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Restart url-service; wait 30s for circuit to probe:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> start</span><span style=\"color:#9ECBFF\"> url-service</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 31</span><span style=\"color:#6A737D\">  # OpenDuration = 30s</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  http://localhost:8080/api/urls</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: 200 (circuit closed after successful probe)</span></span></code></pre></div>\n<h3 id=\"phase-7-structured-logging-across-all-services-115-hr\">Phase 7 — Structured Logging Across All Services (1–1.5 hr)</h3>\n<ol>\n<li>Confirm <code>shared/logger.RequestLogger</code> is wired in all five services&#39; <code>main.go</code>.</li>\n<li>Add <code>WithCorrelationID</code> call in every handler that accesses request context.</li>\n<li>Verify <code>X-Correlation-ID</code> is forwarded by gateway&#39;s <code>Director</code> function to all downstream services.</li>\n<li>Check that async events carry <code>CorrelationID</code> through to notification and analytics consumers&#39; log output.\n<strong>Checkpoint:</strong></li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">CORR_ID</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"e2e-test-$(</span><span style=\"color:#B392F0\">date</span><span style=\"color:#9ECBFF\"> +%s)\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/auth/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"alice@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> jq</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> .token</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"X-Correlation-ID: </span><span style=\"color:#E1E4E8\">$CORR_ID</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://e2e-logging-test.com\"}'</span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> /dev/null</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 5</span><span style=\"color:#6A737D\">  # outbox + consumers</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Correlation ID must appear in all service logs:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> svc </span><span style=\"color:#F97583\">in</span><span style=\"color:#9ECBFF\"> gateway</span><span style=\"color:#9ECBFF\"> url-service</span><span style=\"color:#9ECBFF\"> analytics-service</span><span style=\"color:#9ECBFF\"> notification-service</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  COUNT</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> logs</span><span style=\"color:#E1E4E8\"> $svc </span><span style=\"color:#F97583\">2>&#x26;1</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$CORR_ID</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> wc</span><span style=\"color:#79B8FF\"> -l</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$svc</span><span style=\"color:#9ECBFF\">: </span><span style=\"color:#E1E4E8\">$COUNT</span><span style=\"color:#9ECBFF\"> log lines with correlation ID\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">done</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected: gateway >= 1, url-service >= 1, analytics-service >= 1, notification-service >= 1</span></span></code></pre></div>\n<h3 id=\"phase-8-end-to-end-integration-test-rate-limit-test-152-hr\">Phase 8 — End-to-End Integration Test + Rate Limit Test (1.5–2 hr)</h3>\n<ol>\n<li>Write <code>test/e2e_m5_test.go</code> (§ 11.6).</li>\n<li>Run full E2E test: <code>go test -tags integration -v -timeout 120s ./test/...</code>.\n<strong>Checkpoint:</strong> All E2E tests pass. <code>go vet ./...</code> clean across all services. <code>go test -race ./...</code> clean.</li>\n</ol>\n<hr>\n<h2 id=\"11-test-specification\">11. Test Specification</h2>\n<h3 id=\"111-repositorynotification_repository_testgo-integration\">11.1 <code>repository/notification_repository_test.go</code> (integration)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Build tag: //go:build integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Requires: notification_db running. DSN from TEST_DATABASE_DSN env var.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestInsert_HappyPath: Insert notification → query returns row with status=\"sent\", sent_at IS NOT NULL.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestInsert_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestInsert_PayloadPreserved: payload JSONB round-trips correctly.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestInsert_PayloadPreserved</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestListByUser_OnlyOwnerRows: insert notifications for two users; ListByUser(user1) returns only user1's.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestListByUser_OnlyOwnerRows</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestListByUser_Pagination: insert 5 notifications for same user; page by 2; cursor chain covers all 5.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestListByUser_Pagination</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestListByUser_EmptyCursor: first page returns newest first.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestListByUser_EmptyCursor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestIsProcessed_NotFound: unknown eventKey returns false, nil.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestIsProcessed_NotFound</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestMarkProcessed_Idempotent: two calls with same eventKey → no error.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestMarkProcessed_Idempotent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestIsProcessed_AfterMark: IsProcessed returns true after MarkProcessed.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestIsProcessed_AfterMark</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"112-circuitbreakercircuitbreaker_testgo\">11.2 <code>circuitbreaker/circuitbreaker_test.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// All tests are pure unit tests; no external dependencies.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestNewCircuitBreaker_InitialState: state is Closed; failureCount is 0.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestNewCircuitBreaker_InitialState</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestAllow_Closed_AlwaysReturnsTrue: 100 concurrent Allow() calls on Closed CB all return true.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestAllow_Closed_AlwaysReturnsTrue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestTrip_AfterThresholdFailures: 5 RecordFailure() within window → State() returns Open.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTrip_AfterThresholdFailures</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestAllow_Open_ReturnsError: after trip, Allow() returns (false, ErrCircuitOpen).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestAllow_Open_ReturnsError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestHalfOpen_AfterOpenDuration: after OpenDuration elapses, Allow() transitions to HalfOpen.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Use a Config with OpenDuration=100ms for fast tests.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestHalfOpen_AfterOpenDuration</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestHalfOpen_OnlyOneProbeAllowed: two concurrent Allow() in HalfOpen → one returns true, one false.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestHalfOpen_OnlyOneProbeAllowed</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestHalfOpen_ProbeSuccess_TransitionsClosed: RecordSuccess() in HalfOpen → State() returns Closed.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestHalfOpen_ProbeSuccess_TransitionsClosed</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestHalfOpen_ProbeFailure_TransitionsOpen: RecordFailure() in HalfOpen → State() returns Open.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestHalfOpen_ProbeFailure_TransitionsOpen</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestWindowReset: 3 failures, then gap > Window, then 5 more failures → trips on 5th (not 3rd).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestWindowReset</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestRecordSuccess_Closed_ResetsCount: 4 failures + 1 success + 4 failures → no trip (count reset).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRecordSuccess_Closed_ResetsCount</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestConcurrentAccessNoPanic: 100 goroutines concurrently call Allow/RecordSuccess/RecordFailure.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Run with go test -race. Expected: no panic, no data race.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestConcurrentAccessNoPanic</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestState_AtomicRead: goroutine-safe read via State() while another goroutine transitions.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestState_AtomicRead</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// BenchmarkAllow_Closed: &#x3C; 1µs per call.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkAllow_Closed</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// BenchmarkAllow_Open: &#x3C; 1µs per call (mu + time check only).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkAllow_Open</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"113-middlewaremiddleware_testgo\">11.3 <code>middleware/middleware_test.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// All tests use httptest.NewRecorder + httptest.NewRequest.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCorrelationMiddleware_GeneratesIDWhenAbsent: no X-Correlation-ID in request →</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// response header has UUID v4; context contains same ID.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCorrelationMiddleware_GeneratesIDWhenAbsent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCorrelationMiddleware_PropagatesExisting: X-Correlation-ID: \"abc\" →</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// response header echoes \"abc\"; context contains \"abc\".</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCorrelationMiddleware_PropagatesExisting</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCorrelationIDFromContext_Present: returns stored ID and true.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCorrelationIDFromContext_Present</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestCorrelationIDFromContext_Absent: returns \"\", false.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCorrelationIDFromContext_Absent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGatewayJWT_ValidToken_CallsNext: valid token → next handler called, 200.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGatewayJWT_ValidToken_CallsNext</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGatewayJWT_InvalidToken_Returns401: invalid token → 401, next NOT called.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGatewayJWT_InvalidToken_Returns401</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGatewayJWT_MissingHeader_Returns401: no Authorization header → 401.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGatewayJWT_MissingHeader_Returns401</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGatewayJWT_ExpiredToken_Returns401: expired token → 401.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGatewayJWT_ExpiredToken_Returns401</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGatewayJWT_AuthRouteExempt: POST /api/auth/register → next called without JWT.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGatewayJWT_AuthRouteExempt</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGatewayJWT_PublicRedirect_Exempt: GET /r/abc → next called without JWT.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGatewayJWT_PublicRedirect_Exempt</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestGatewayJWT_ForwardsUserHeaders: valid token → X-User-ID and X-User-Email set on forwarded request.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestGatewayJWT_ForwardsUserHeaders</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"114-ratelimitratelimit_testgo\">11.4 <code>ratelimit/ratelimit_test.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Unit tests use a nil Redis client to test fail-open behavior.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Integration tests use TEST_REDIS_ADDR env var; build tag: //go:build integration.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestAllow_NilClient_FailOpen: nil *redis.Client → AllowResult.Allowed = true.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestAllow_NilClient_FailOpen</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestAllow_RedisError_FailOpen: Redis returns error (use mock) → AllowResult.Allowed = true.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestAllow_RedisError_FailOpen</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestAllow_UnderLimit: calls 1..limit all return Allowed=true.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestAllow_UnderLimit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestAllow_ExactlyAtLimit: call number limit returns Allowed=true; call limit+1 returns false.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestAllow_ExactlyAtLimit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestAllow_RetryAfterPositive: when Allowed=false, RetryAfter > 0.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestAllow_RetryAfterPositive</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestAllow_DifferentIPs_Independent: IP A at limit, IP B still allowed.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestAllow_DifferentIPs_Independent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestAllow_DifferentRoutes_Independent: shorten at limit, redirect still allowed for same IP.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestAllow_DifferentRoutes_Independent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestAllow_WindowExpiry: fill window, wait for TTL to expire, fill again → all allowed.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Use RouteLimit with Window=2s for fast test.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestAllow_WindowExpiry</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestAllow_ConcurrentRequests_Atomic: 50 concurrent Allow() calls for same IP+route;</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// exactly limit allowed, rest rejected. Verify atomicity via Redis counter.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestAllow_ConcurrentRequests_Atomic</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// integration + race detector</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// BenchmarkAllow: measure Redis round-trip &#x3C; 3ms p99.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkAllow</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"115-consumerprocessor_testgo-notification-service\">11.5 <code>consumer/processor_test.go</code> (Notification Service)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Unit tests use mock NotificationRepository.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_URLCreated_HappyPath: URLCreatedEvent → ProcessResultInserted, Insert called.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_URLCreated_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_URLDeleted_HappyPath: URLDeletedEvent → ProcessResultInserted.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_URLDeleted_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_MilestoneReached_HappyPath: MilestoneReachedEvent → ProcessResultInserted.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_MilestoneReached_HappyPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_MalformedJSON: invalid JSON → ProcessResultPoisoned; Insert NOT called.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_MalformedJSON</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_UnknownRoutingKey: routing_key=\"unknown.event\" → ProcessResultPoisoned.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_UnknownRoutingKey</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_DuplicateEvent: IsProcessed returns true → ProcessResultDuplicate; Insert NOT called.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_DuplicateEvent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_InsertFail: Insert returns error → ProcessResultError.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_InsertFail</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_MockEmailLogLine: after Insert, log output contains \"would send email to user\".</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Capture zerolog output via bytes.Buffer writer.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_MockEmailLogLine</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestProcess_PanicRecovery: mock Insert panics → returns ProcessResultError; no propagated panic.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcess_PanicRecovery</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n<h3 id=\"116-end-to-end-integration-test-teste2e_m5_testgo\">11.6 End-to-End Integration Test (<code>test/e2e_m5_test.go</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Build tag: //go:build integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Requires: full docker compose stack running.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// BASE_URL env var: \"http://localhost:8080\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestE2E_FullFlow:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   1. POST /api/auth/register → 201 {user_id, email}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   2. POST /api/auth/login → 200 {token, expires_at}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   3. POST /api/shorten → 201 {short_code, short_url, ...}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   4. GET /r/{code} (no auth) → 301; follow redirect → external URL</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   5. Wait 5s for outbox + consumers</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   6. GET /api/stats/{code} (no auth) → 200 {total_clicks: 1, ...}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   7. GET /api/notifications (with token) → 200, contains url.created event</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   8. Verify X-Correlation-ID in response headers matches request header</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestE2E_FullFlow</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestE2E_RateLimitShorten:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Register/login user. POST /api/shorten 11 times from same IP.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Requests 1-10: 201. Request 11: 429 with Retry-After header.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Verify Retry-After is integer string, > 0.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestE2E_RateLimitShorten</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestE2E_CircuitBreaker:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   (Requires ability to stop url-service; skip in CI if not possible.)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Stop url-service. 5 requests → 502. 6th → 503 {\"error\":\"service unavailable\"}.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Start url-service, wait 31s. Request → 200 (circuit healed).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestE2E_CircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestE2E_JWTGatewayEnforcement:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   GET /api/urls without token → 401 from gateway (not 401 from url-service).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Verify response body is gateway's {\"error\":\"unauthorized\"} not url-service's.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Distinguish: gateway responds in &#x3C; 2ms (no proxy overhead); url-service in > 5ms.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestE2E_JWTGatewayEnforcement</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestE2E_CorrelationIDPropagation:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Send request with X-Correlation-ID: \"e2e-test-abc\".</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Verify response X-Correlation-ID: \"e2e-test-abc\".</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Check logs: gateway, url-service logs both contain \"e2e-test-abc\".</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestE2E_CorrelationIDPropagation</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestE2E_NotificationMilestone:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Generate 10 clicks on same short_code (via /r/{code}).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   Wait 10s.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   GET /api/notifications → contains milestone.reached event.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   GET /api/stats/{code} → total_clicks = 10.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestE2E_NotificationMilestone</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestE2E_PublicEndpoints_NoAuth:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   GET /r/{code} → 301 (no auth required, not 401).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   GET /api/stats/{code} → 200 (no auth required).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   GET /health → 200.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestE2E_PublicEndpoints_NoAuth</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-40.svg\" alt=\"End-to-End Request Trace — Full System Data Flow\"></p>\n<hr>\n<h2 id=\"12-environment-variable-reference\">12. Environment Variable Reference</h2>\n<h3 id=\"notification-service\">Notification Service</h3>\n<table>\n<thead>\n<tr>\n<th>Variable</th>\n<th>Required</th>\n<th>Example</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>PORT</code></td>\n<td>Yes</td>\n<td><code>8084</code></td>\n<td>HTTP listen port</td>\n</tr>\n<tr>\n<td><code>SERVICE_NAME</code></td>\n<td>Yes</td>\n<td><code>notification-service</code></td>\n<td>Embedded in log lines</td>\n</tr>\n<tr>\n<td><code>DATABASE_DSN</code></td>\n<td>Yes</td>\n<td><code>postgres://notification_user:notification_secret@notification_db:5432/notification_db?sslmode=disable</code></td>\n<td>notification_db connection</td>\n</tr>\n<tr>\n<td><code>RABBITMQ_URL</code></td>\n<td>Yes</td>\n<td><code>amqp://admin:admin@rabbitmq:5672/</code></td>\n<td>AMQP broker</td>\n</tr>\n<tr>\n<td><code>JWT_SECRET</code></td>\n<td>Yes</td>\n<td><code>change-me-to-at-least-32-random-bytes</code></td>\n<td>JWT verification for <code>GET /notifications</code></td>\n</tr>\n</tbody></table>\n<h3 id=\"api-gateway\">API Gateway</h3>\n<table>\n<thead>\n<tr>\n<th>Variable</th>\n<th>Required</th>\n<th>Example</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>PORT</code></td>\n<td>Yes</td>\n<td><code>8080</code></td>\n<td>HTTP listen port</td>\n</tr>\n<tr>\n<td><code>SERVICE_NAME</code></td>\n<td>Yes</td>\n<td><code>gateway</code></td>\n<td>Embedded in log lines</td>\n</tr>\n<tr>\n<td><code>JWT_SECRET</code></td>\n<td>Yes</td>\n<td><code>change-me-to-at-least-32-random-bytes</code></td>\n<td>JWT verification (same as all services)</td>\n</tr>\n<tr>\n<td><code>REDIS_ADDR</code></td>\n<td>Yes</td>\n<td><code>redis:6379</code></td>\n<td>Redis for rate limit counters; unavailability = fail-open</td>\n</tr>\n<tr>\n<td><code>URL_SERVICE_URL</code></td>\n<td>Yes</td>\n<td><code>http://url-service:8081</code></td>\n<td>Downstream target</td>\n</tr>\n<tr>\n<td><code>ANALYTICS_SERVICE_URL</code></td>\n<td>Yes</td>\n<td><code>http://analytics-service:8082</code></td>\n<td>Downstream target</td>\n</tr>\n<tr>\n<td><code>USER_SERVICE_URL</code></td>\n<td>Yes</td>\n<td><code>http://user-service:8083</code></td>\n<td>Downstream target</td>\n</tr>\n<tr>\n<td><code>NOTIFICATION_SERVICE_URL</code></td>\n<td>Yes</td>\n<td><code>http://notification-service:8084</code></td>\n<td>Downstream target</td>\n</tr>\n<tr>\n<td><code>LOG_LEVEL</code></td>\n<td>No</td>\n<td><code>info</code></td>\n<td><code>debug|info|warn|error</code>; default <code>info</code></td>\n</tr>\n<tr>\n<td><strong>Add to <code>docker-compose.yml</code></strong> for notification-service and gateway:</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">yaml</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># notification-service environment additions:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">JWT_SECRET</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"change-me-to-at-least-32-random-bytes\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># gateway environment additions:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">JWT_SECRET</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"change-me-to-at-least-32-random-bytes\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># (REDIS_ADDR already present from M1)</span></span></code></pre></div>\n<p><strong><code>JWT_SECRET</code> must be identical across all five services.</strong> Use a shared Docker Compose variable or <code>.env</code> file to prevent drift:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">yaml</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># docker-compose.yml (add at top level)</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">x-common-jwt</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">common-jwt</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  JWT_SECRET</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"${JWT_SECRET:-change-me-to-at-least-32-random-bytes}\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Apply in each service's environment:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  &#x3C;&#x3C;</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">common-jwt</span></span></code></pre></div>\n<hr>\n<h2 id=\"13-performance-targets\">13. Performance Targets</h2>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Target</th>\n<th>How to Measure</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Gateway proxy overhead (added latency)</td>\n<td>&lt; 2ms p99</td>\n<td>Compare <code>GET /r/{code}</code> via gateway (8080) vs direct url-service (8081); delta is proxy overhead</td>\n</tr>\n<tr>\n<td>Rate limit check (Redis INCR Lua)</td>\n<td>&lt; 3ms p99</td>\n<td><code>go test -bench=BenchmarkAllow ./ratelimit/...</code> with real Redis</td>\n</tr>\n<tr>\n<td>Circuit breaker <code>Allow()</code> state check</td>\n<td>&lt; 1µs</td>\n<td><code>go test -bench=BenchmarkAllow_Closed ./circuitbreaker/...</code></td>\n</tr>\n<tr>\n<td><code>GET /api/notifications</code> p99</td>\n<td>&lt; 20ms</td>\n<td><code>wrk -t2 -c10 -d30s</code> with valid JWT + 100 notification rows</td>\n</tr>\n<tr>\n<td>Correlation ID generation (<code>uuid.New()</code>)</td>\n<td>&lt; 1µs</td>\n<td><code>go test -bench=BenchmarkUUID ./middleware/...</code></td>\n</tr>\n<tr>\n<td>Gateway startup to all-healthy</td>\n<td>&lt; 90s total stack</td>\n<td><code>time docker compose up --wait</code></td>\n</tr>\n<tr>\n<td>Notification consumer lag (event → DB insert)</td>\n<td>&lt; 2s p99</td>\n<td>Measure <code>notifications.created_at</code> vs <code>URLCreatedEvent.OccurredAt</code> delta</td>\n</tr>\n<tr>\n<td><code>GET /health</code> on all services</td>\n<td>&lt; 10ms p99</td>\n<td><code>wrk -t2 -c10 -d10s http://localhost:8080/health</code></td>\n</tr>\n<tr>\n<td>Rate limit test (11 shorten requests)</td>\n<td>1-10: 201; 11: 429</td>\n<td>Scripted <code>curl</code> loop per Phase 8 checkpoint</td>\n</tr>\n<tr>\n<td>Circuit breaker trip (5 failures)</td>\n<td>&lt; 500ms elapsed</td>\n<td>Measure time from first failure to first 503 via gateway</td>\n</tr>\n<tr>\n<td>Circuit breaker half-open probe</td>\n<td>30s ± 1s</td>\n<td>Measure time from Open → first 200 after url-service restarts</td>\n</tr>\n<tr>\n<td>Gateway JWT verification</td>\n<td>&lt; 1ms (local HMAC)</td>\n<td>No DB call; bounded by CPU; benchmark HMAC-SHA256</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"14-anti-pattern-guard-rail-checklist\">14. Anti-Pattern Guard Rail Checklist</h2>\n<p>Before completing this milestone, verify:</p>\n<ul>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>No business logic in the gateway.</strong> <code>grep -r &quot;short_code\\|analytics\\|milestone\\|password&quot; gateway/</code> returns only forwarding/proxy code, never domain computation.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Circuit breaker has three states, not a retry loop.</strong> <code>grep -r &quot;time.Sleep\\|for.*retry&quot; gateway/circuitbreaker/</code> returns nothing. The state machine is <code>State</code> enum with mutex-protected transitions.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Notification service does not call user-service.</strong> <code>grep -r &quot;user-service\\|8083&quot; services/notification-service/</code> returns nothing except comments. <code>UserEmail</code> comes from the event payload.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Rate limit counters in Redis, not process memory.</strong> <code>grep -r &quot;sync.Map\\|var.*counter\\|atomic.Int&quot; gateway/ratelimit/</code> returns nothing. All counters are Redis keys.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Redis failure allows requests (fail-open).</strong> <code>grep -A5 &quot;redis.*err\\|nil.*client&quot; gateway/ratelimit/ratelimit.go</code> shows <code>return AllowResult{Allowed: true}</code> on error.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong><code>X-Correlation-ID</code> propagated to async events.</strong> <code>grep &quot;CorrelationID&quot; shared/events/events.go</code> shows the field on all event structs. <code>grep &quot;CorrelationID&quot; services/notification-service/consumer/processor.go</code> shows it is logged.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Gateway JWT middleware does not call user-service.</strong> <code>grep -r &quot;user-service\\|8083&quot; gateway/middleware/jwt.go</code> returns nothing. Only <code>sharedauth.NewJWTVerifier</code> and its <code>Verify</code> method are used.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Circuit breaker <code>probeInFlight</code> prevents concurrent probes.</strong> <code>grep &quot;probeInFlight&quot; gateway/circuitbreaker/circuitbreaker.go</code> shows it is set before returning <code>true</code> from HalfOpen and cleared in both <code>RecordSuccess</code> and <code>RecordFailure</code>.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>Downstream 5xx counts as circuit breaker failure.</strong> <code>grep &quot;RecordFailure\\|StatusCode &gt;= 500&quot; gateway/proxy/proxy.go</code> shows <code>ModifyResponse</code> calls <code>RecordFailure</code> for 5xx responses.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong><code>notifications</code> response never exposes raw payload.</strong> <code>NotificationItem</code> struct has no <code>payload</code> or <code>data</code> field — only <code>id</code>, <code>event_type</code>, <code>status</code>, <code>created_at</code>, <code>sent_at</code>.</li>\n<li><input disabled=\"\" type=\"checkbox\"> <strong>All log lines have <code>correlation_id</code> field.</strong> <code>docker compose logs url-service 2&gt;&amp;1 | python3 -c &quot;import sys,json; [json.loads(l) for l in sys.stdin if l.strip()]&quot;</code> — all lines parse as JSON with <code>correlation_id</code> key present.</li>\n</ul>\n<hr>\n<!-- END_TDD_MOD -->\n\n\n<h1 id=\"project-structure-url-shortener-microservices\">Project Structure: URL Shortener (Microservices)</h1>\n<h2 id=\"directory-tree\">Directory Tree</h2>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-shortener/                                    # repo root\n│\n├── docker-compose.yml                            # M1: full 11-container topology\n├── .env.example                                  # M1: all env vars documented\n├── README.md                                     # M1: setup commands\n│\n├── shared/                                       # imported by all services\n│   ├── go.mod                                    # M1: module github.com/.../shared\n│   ├── go.sum                                    # M1: auto-generated\n│   ├── events/\n│   │   └── events.go                             # M1: DomainEvent interface + 4 event structs\n│   ├── auth/\n│   │   └── types.go                              # M2: JWTVerifier interface, Claims struct, sentinel errors\n│   ├── middleware/\n│   │   ├── jwt_middleware.go                     # M2: RequireAuth http.Handler wrapper\n│   │   └── jwt_middleware_test.go                # M2: middleware unit tests\n│   └── logger/\n│       └── logger.go                             # M1 stub → M5 finalized: New, WithCorrelationID, RequestLogger\n│\n├── services/\n│   │\n│   ├── url-service/                              # M1 scaffold → M3 full implementation\n│   │   ├── go.mod                                # M1: module + replace shared\n│   │   ├── go.sum                                # M1: auto-generated\n│   │   ├── Dockerfile                            # M1: multi-stage Alpine build\n│   │   ├── main.go                               # M1 stub → M3: wiring env/DB/Redis/RabbitMQ/routes/outbox\n│   │   ├── migrations/\n│   │   │   ├── 001_create_urls.sql               # M3: urls table + indexes\n│   │   │   └── 002_create_outbox.sql             # M3: outbox table + partial index\n│   │   ├── codegen/\n│   │   │   ├── codegen.go                        # M3: base62 alphabet, Generate(), CodeGenerator interface\n│   │   │   └── codegen_test.go                   # M3: length/alphabet/randomness/no-math-rand tests\n│   │   ├── repository/\n│   │   │   ├── url_repository.go                 # M3: URL/URLSummary structs, URLRepository interface + pgx impl\n│   │   │   ├── url_repository_test.go            # M3: integration tests (conflict, cursor, ownership)\n│   │   │   ├── outbox_repository.go              # M3: OutboxEntry, OutboxRepository interface + pgx impl\n│   │   │   └── outbox_repository_test.go         # M3: insert/rollback/fetch/mark tests\n│   │   ├── cache/\n│   │   │   ├── cache.go                          # M3: CachedURL, CacheClient interface, nil-safe Redis impl\n│   │   │   └── cache_test.go                     # M3: nil-client/TTL/set-get/del tests\n│   │   ├── amqp/\n│   │   │   ├── publisher.go                      # M3: AMQPPublisher interface + amqp091 impl with sync.Mutex\n│   │   │   └── publisher_test.go                 # M3: publish tests\n│   │   ├── outbox/\n│   │   │   ├── poller.go                         # M3: OutboxPoller coordinator + 3 workers\n│   │   │   └── poller_test.go                    # M3: worker pool / drain tests\n│   │   ├── service/\n│   │   │   └── url_service.go                    # M3: URLService orchestrating repo/codegen/cache/outbox\n│   │   ├── auth/\n│   │   │   ├── password.go                       # M2 (used by url-service for JWT verify only): bcrypt impl\n│   │   │   ├── password_test.go                  # M2: hash/compare/cost tests\n│   │   │   ├── jwt.go                            # M2: JWTSigner + JWTVerifier implementations\n│   │   │   └── jwt_test.go                       # M2: sign/verify/expiry/tamper tests\n│   │   └── handler/\n│   │       ├── health.go                         # M1: GET /health\n│   │       ├── shorten.go                        # M3: POST /shorten\n│   │       ├── redirect.go                       # M3: GET /{code} 301 redirect\n│   │       ├── list.go                           # M3: GET /urls cursor pagination\n│   │       ├── delete.go                         # M3: DELETE /urls/{code}\n│   │       ├── helpers.go                        # M3: writeJSON, writeError, extractClientIP, hashIP, ptr\n│   │       └── handler_test.go                   # M3: unit + integration tests + benchmarks\n│   │\n│   ├── analytics-service/                        # M1 scaffold → M4 full implementation\n│   │   ├── go.mod                                # M1: module + replace shared\n│   │   ├── go.sum                                # M1: auto-generated\n│   │   ├── Dockerfile                            # M1: multi-stage Alpine build\n│   │   ├── main.go                               # M1 stub → M4: wiring DB/RabbitMQ/consumer/routes\n│   │   ├── migrations/\n│   │   │   ├── 001_create_clicks.sql             # M4: clicks table + two indexes (incl. partial)\n│   │   │   ├── 002_create_milestones.sql         # M4: milestones table + unique (short_code, milestone)\n│   │   │   └── 003_create_processed_events.sql   # M4: processed_events dedup table (UUID PK)\n│   │   ├── repository/\n│   │   │   ├── click_repository.go               # M4: Click/RefererCount/PeriodCount, ClickRepository + pgx impl\n│   │   │   ├── click_repository_test.go          # M4: insert/count/referer/timeline integration tests\n│   │   │   ├── processed_event_repository.go     # M4: ProcessedEvent, ProcessedEventRepository + pgx impl\n│   │   │   ├── processed_event_repository_test.go # M4: is-processed/mark/idempotent/rollback tests\n│   │   │   ├── milestone_repository.go           # M4: Milestone, MilestoneRepository + pgx impl\n│   │   │   └── milestone_repository_test.go      # M4: get-latest/insert/conflict tests\n│   │   ├── consumer/\n│   │   │   ├── consumer.go                       # M4: AMQPConsumer setup (exchange+queue+bind+Qos+Consume)\n│   │   │   ├── processor.go                      # M4: ClickProcessor with full idempotency algorithm\n│   │   │   └── processor_test.go                 # M4: unit (mock repos) + integration duplicate-event test\n│   │   ├── milestone/\n│   │   │   ├── detector.go                       # M4: Thresholds [10,100,1000], Detector interface + impl\n│   │   │   └── detector_test.go                  # M4: all threshold transition table-driven tests\n│   │   ├── publisher/\n│   │   │   ├── publisher.go                      # M4: AMQPPublisher for MilestoneReachedEvent\n│   │   │   └── publisher_test.go                 # M4: publish tests\n│   │   └── handler/\n│   │       ├── health.go                         # M1: GET /health\n│   │       ├── stats.go                          # M4: GET /stats/{code} with errgroup concurrent queries\n│   │       ├── timeline.go                       # M4: GET /stats/{code}/timeline\n│   │       ├── helpers.go                        # M4: writeJSON, writeError\n│   │       └── handler_test.go                   # M4: unit (mock repos) + benchmarks\n│   │\n│   ├── user-service/                             # M1 scaffold → M2 full implementation\n│   │   ├── go.mod                                # M1: module + replace shared\n│   │   ├── go.sum                                # M1: auto-generated\n│   │   ├── Dockerfile                            # M1: multi-stage Alpine build\n│   │   ├── main.go                               # M1 stub → M2: wiring DB/auth/routes/middleware\n│   │   ├── migrations/\n│   │   │   └── 001_create_users.sql              # M2: users table (UUID PK, UNIQUE email, bcrypt hash)\n│   │   ├── repository/\n│   │   │   ├── user_repository.go                # M2: User struct, UserRepository interface + pgx impl\n│   │   │   └── user_repository_test.go           # M2: create/duplicate/find/case-sensitivity tests\n│   │   ├── auth/\n│   │   │   ├── password.go                       # M2: PasswordHasher interface + bcryptHasher (cost=12)\n│   │   │   ├── password_test.go                  # M2: hash/compare/cost/benchmark tests\n│   │   │   ├── jwt.go                            # M2: JWTSigner + JWTVerifier (implements shared/auth.JWTVerifier)\n│   │   │   └── jwt_test.go                       # M2: sign/verify/expiry/issuer/tamper tests\n│   │   ├── service/\n│   │   │   └── user_service.go                   # M2: UserService (Register/Login + dummyHash timing equalization)\n│   │   └── handler/\n│   │       ├── health.go                         # M1: GET /health\n│   │       ├── register.go                       # M2: POST /register\n│   │       ├── login.go                          # M2: POST /login\n│   │       ├── me.go                             # M2: GET /me (behind RequireAuth)\n│   │       ├── helpers.go                        # M2: writeJSON, writeInternalError, ErrorResponse\n│   │       └── handler_test.go                   # M2: integration round-trip + edge case tests\n│   │\n│   └── notification-service/                     # M1 scaffold → M5 full implementation\n│       ├── go.mod                                # M1: module + replace shared\n│       ├── go.sum                                # M1: auto-generated\n│       ├── Dockerfile                            # M1: multi-stage Alpine build\n│       ├── main.go                               # M1 stub → M5: wiring DB/RabbitMQ/consumer/routes/JWT\n│       ├── migrations/\n│       │   └── 001_create_notifications.sql      # M5: notifications + processed_notifications tables\n│       ├── repository/\n│       │   ├── notification_repository.go        # M5: Notification/NotificationSummary, NotificationRepository + pgx impl\n│       │   └── notification_repository_test.go   # M5: insert/list/cursor/dedup integration tests\n│       ├── consumer/\n│       │   ├── consumer.go                       # M5: AMQPConsumer (3 bindings: url.created/deleted/milestone.reached)\n│       │   ├── processor.go                      # M5: NotificationProcessor with routing-key switch + mock email log\n│       │   └── processor_test.go                 # M5: unit tests for all event types + panic recovery\n│       └── handler/\n│           ├── health.go                         # M1: GET /health\n│           ├── notifications.go                  # M5: GET /notifications (JWT-protected, cursor-paginated)\n│           ├── helpers.go                        # M5: writeJSON, writeError\n│           └── handler_test.go                   # M5: list/pagination/ownership tests\n│\n├── gateway/                                      # M1 scaffold → M5 full implementation\n│   ├── go.mod                                    # M1: module + replace shared\n│   ├── go.sum                                    # M1: auto-generated\n│   ├── Dockerfile                                # M1: multi-stage Alpine build\n│   ├── main.go                                   # M1 stub → M5: full wiring env/Redis/CB/proxy/routes/server\n│   ├── circuitbreaker/\n│   │   ├── circuitbreaker.go                     # M5: CircuitBreaker 3-state machine (Closed/Open/HalfOpen)\n│   │   └── circuitbreaker_test.go                # M5: state transitions/concurrency/window-reset tests\n│   ├── ratelimit/\n│   │   ├── ratelimit.go                          # M5: RateLimiter — Redis Lua INCR+EXPIRE, fail-open\n│   │   └── ratelimit_test.go                     # M5: unit (nil client) + integration (window/atomic) tests\n│   ├── proxy/\n│   │   ├── proxy.go                              # M5: ReverseProxy wrapper with Director path-strip + CB hooks\n│   │   └── proxy_test.go                         # M5: forward/error-handling tests\n│   ├── middleware/\n│   │   ├── correlation.go                        # M5: CorrelationMiddleware — X-Correlation-ID inject/propagate\n│   │   ├── jwt.go                                # M5: GatewayJWTMiddleware — local HMAC verify, exempt routes\n│   │   ├── logging.go                            # M5: RequestLogger middleware (wraps shared/logger)\n│   │   └── middleware_test.go                    # M5: correlation/JWT/exempt-route tests\n│   ├── router/\n│   │   ├── router.go                             # M5: full route table (all 12 routes with middleware chains)\n│   │   └── router_test.go                        # M5: route matching + middleware wiring tests\n│   └── handler/\n│       ├── health.go                             # M1: GET /health\n│       └── handler_test.go                       # M5: health handler test\n│\n└── test/\n    ├── smoke_m1.sh                               # M1: shell smoke test for all 5 /health endpoints\n    └── e2e_m5_test.go                            # M5: full end-to-end integration tests (Go, build tag: integration)</code></pre></div>\n<hr>\n<h2 id=\"creation-order\">Creation Order</h2>\n<h3 id=\"1-monorepo-scaffold-3045-min\">1. Monorepo Scaffold (30–45 min)</h3>\n<p>Create all directories first, then stub files:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">mkdir</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#9ECBFF\"> shared/{events,auth,middleware,logger}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">mkdir</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#9ECBFF\"> services/{url-service,analytics-service,user-service,notification-service}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">mkdir</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#9ECBFF\"> services/url-service/{migrations,codegen,repository,cache,amqp,outbox,service,auth,handler}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">mkdir</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#9ECBFF\"> services/analytics-service/{migrations,repository,consumer,milestone,publisher,handler}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">mkdir</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#9ECBFF\"> services/user-service/{migrations,repository,auth,service,handler}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">mkdir</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#9ECBFF\"> services/notification-service/{migrations,repository,consumer,handler}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">mkdir</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#9ECBFF\"> gateway/{circuitbreaker,ratelimit,proxy,middleware,router,handler}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">mkdir</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#9ECBFF\"> test</span></span></code></pre></div>\n<ul>\n<li><code>shared/go.mod</code></li>\n<li><code>services/url-service/go.mod</code></li>\n<li><code>services/analytics-service/go.mod</code></li>\n<li><code>services/user-service/go.mod</code></li>\n<li><code>services/notification-service/go.mod</code></li>\n<li><code>gateway/go.mod</code></li>\n<li>Empty <code>main.go</code> stubs in each service and gateway</li>\n<li>Run <code>go mod tidy</code> in each directory</li>\n</ul>\n<h3 id=\"2-shared-foundation-m1-4560-min\">2. Shared Foundation — M1 (45–60 min)</h3>\n<ul>\n<li><code>shared/events/events.go</code> — all 4 event structs + constants + DomainEvent interface</li>\n<li><code>shared/logger/logger.go</code> — initial stub: <code>New()</code> only</li>\n<li><code>docker-compose.yml</code> — full 11-container topology</li>\n<li><code>.env.example</code> — all environment variables</li>\n<li><code>README.md</code></li>\n</ul>\n<h3 id=\"3-dockerfiles-m1-30-min\">3. Dockerfiles — M1 (30 min)</h3>\n<ul>\n<li><code>services/url-service/Dockerfile</code></li>\n<li><code>services/analytics-service/Dockerfile</code></li>\n<li><code>services/user-service/Dockerfile</code></li>\n<li><code>services/notification-service/Dockerfile</code></li>\n<li><code>gateway/Dockerfile</code></li>\n</ul>\n<h3 id=\"4-health-handlers-infra-bootstrap-m1-6090-min\">4. Health Handlers + Infra Bootstrap — M1 (60–90 min)</h3>\n<ul>\n<li><code>services/url-service/handler/health.go</code></li>\n<li><code>services/analytics-service/handler/health.go</code></li>\n<li><code>services/user-service/handler/health.go</code></li>\n<li><code>services/notification-service/handler/health.go</code></li>\n<li><code>gateway/handler/health.go</code></li>\n<li>Full <code>main.go</code> for each service: <code>ConnectDB</code>, <code>ConnectRedis</code> (url-service + gateway), <code>ConnectRabbitMQ</code>, <code>mustGetEnv</code>, startup sequence, <code>/health</code> route, RabbitMQ queue declarations</li>\n<li><code>test/smoke_m1.sh</code>\n<strong>Checkpoint:</strong> <code>docker compose up --build</code> → all 11 containers healthy. All <code>/health</code> endpoints return 200.</li>\n</ul>\n<h3 id=\"5-user-service-schema-repository-m2-6090-min\">5. User Service Schema + Repository — M2 (60–90 min)</h3>\n<ul>\n<li><code>services/user-service/migrations/001_create_users.sql</code></li>\n<li><code>services/user-service/repository/user_repository.go</code></li>\n<li><code>services/user-service/repository/user_repository_test.go</code></li>\n</ul>\n<h3 id=\"6-user-service-auth-layer-m2-6090-min\">6. User Service Auth Layer — M2 (60–90 min)</h3>\n<ul>\n<li><code>services/user-service/auth/password.go</code></li>\n<li><code>services/user-service/auth/password_test.go</code></li>\n<li><code>services/user-service/auth/jwt.go</code></li>\n<li><code>services/user-service/auth/jwt_test.go</code></li>\n</ul>\n<h3 id=\"7-shared-auth-types-m2-20-min\">7. Shared Auth Types — M2 (20 min)</h3>\n<ul>\n<li><code>shared/auth/types.go</code> — JWTVerifier interface, Claims struct, sentinel errors</li>\n</ul>\n<h3 id=\"8-user-service-business-logic-handlers-m2-90120-min\">8. User Service Business Logic + Handlers — M2 (90–120 min)</h3>\n<ul>\n<li><code>services/user-service/service/user_service.go</code></li>\n<li><code>services/user-service/handler/helpers.go</code></li>\n<li><code>services/user-service/handler/register.go</code></li>\n<li><code>services/user-service/handler/login.go</code></li>\n<li><code>services/user-service/handler/me.go</code></li>\n<li><code>services/user-service/handler/handler_test.go</code></li>\n<li>Update <code>services/user-service/main.go</code> with full M2 wiring</li>\n</ul>\n<h3 id=\"9-shared-jwt-middleware-m2-4560-min\">9. Shared JWT Middleware — M2 (45–60 min)</h3>\n<ul>\n<li><code>shared/middleware/jwt_middleware.go</code></li>\n<li><code>shared/middleware/jwt_middleware_test.go</code>\n<strong>Checkpoint:</strong> Register → Login → GET /me round-trip works. Duplicate email → 409. Wrong password → 401 (same body as unknown email).</li>\n</ul>\n<h3 id=\"10-url-service-schema-code-generator-m3-6090-min\">10. URL Service Schema + Code Generator — M3 (60–90 min)</h3>\n<ul>\n<li><code>services/url-service/migrations/001_create_urls.sql</code></li>\n<li><code>services/url-service/migrations/002_create_outbox.sql</code></li>\n<li><code>services/url-service/codegen/codegen.go</code></li>\n<li><code>services/url-service/codegen/codegen_test.go</code></li>\n</ul>\n<h3 id=\"11-url-service-repository-layer-m3-90120-min\">11. URL Service Repository Layer — M3 (90–120 min)</h3>\n<ul>\n<li><code>services/url-service/repository/url_repository.go</code></li>\n<li><code>services/url-service/repository/url_repository_test.go</code></li>\n<li><code>services/url-service/repository/outbox_repository.go</code></li>\n<li><code>services/url-service/repository/outbox_repository_test.go</code></li>\n</ul>\n<h3 id=\"12-url-service-cache-amqp-service-layer-m3-90120-min\">12. URL Service Cache + AMQP + Service Layer — M3 (90–120 min)</h3>\n<ul>\n<li><code>services/url-service/cache/cache.go</code></li>\n<li><code>services/url-service/cache/cache_test.go</code></li>\n<li><code>services/url-service/amqp/publisher.go</code></li>\n<li><code>services/url-service/amqp/publisher_test.go</code></li>\n<li><code>services/url-service/service/url_service.go</code></li>\n</ul>\n<h3 id=\"13-url-service-handlers-outbox-poller-m3-90120-min\">13. URL Service Handlers + Outbox Poller — M3 (90–120 min)</h3>\n<ul>\n<li><code>services/url-service/handler/helpers.go</code></li>\n<li><code>services/url-service/handler/shorten.go</code></li>\n<li><code>services/url-service/handler/redirect.go</code></li>\n<li><code>services/url-service/handler/list.go</code></li>\n<li><code>services/url-service/handler/delete.go</code></li>\n<li><code>services/url-service/handler/handler_test.go</code></li>\n<li><code>services/url-service/outbox/poller.go</code></li>\n<li><code>services/url-service/outbox/poller_test.go</code></li>\n<li>Update <code>services/url-service/main.go</code> with full M3 wiring\n<strong>Checkpoint:</strong> POST /shorten → 201. GET /:code → 301. DELETE /urls/:code → 204. Outbox poller marks rows published within 4s. RabbitMQ management shows <code>url-shortener</code> exchange.</li>\n</ul>\n<h3 id=\"14-analytics-service-schema-repository-m4-90120-min\">14. Analytics Service Schema + Repository — M4 (90–120 min)</h3>\n<ul>\n<li><code>services/analytics-service/migrations/001_create_clicks.sql</code></li>\n<li><code>services/analytics-service/migrations/002_create_milestones.sql</code></li>\n<li><code>services/analytics-service/migrations/003_create_processed_events.sql</code></li>\n<li><code>services/analytics-service/repository/click_repository.go</code></li>\n<li><code>services/analytics-service/repository/click_repository_test.go</code></li>\n<li><code>services/analytics-service/repository/processed_event_repository.go</code></li>\n<li><code>services/analytics-service/repository/processed_event_repository_test.go</code></li>\n<li><code>services/analytics-service/repository/milestone_repository.go</code></li>\n<li><code>services/analytics-service/repository/milestone_repository_test.go</code></li>\n</ul>\n<h3 id=\"15-analytics-service-consumer-milestone-detection-m4-90120-min\">15. Analytics Service Consumer + Milestone Detection — M4 (90–120 min)</h3>\n<ul>\n<li><code>services/analytics-service/consumer/consumer.go</code></li>\n<li><code>services/analytics-service/consumer/processor.go</code></li>\n<li><code>services/analytics-service/consumer/processor_test.go</code></li>\n<li><code>services/analytics-service/milestone/detector.go</code></li>\n<li><code>services/analytics-service/milestone/detector_test.go</code></li>\n<li><code>services/analytics-service/publisher/publisher.go</code></li>\n<li><code>services/analytics-service/publisher/publisher_test.go</code></li>\n</ul>\n<h3 id=\"16-analytics-service-handlers-m4-6090-min\">16. Analytics Service Handlers — M4 (60–90 min)</h3>\n<ul>\n<li><code>services/analytics-service/handler/helpers.go</code></li>\n<li><code>services/analytics-service/handler/stats.go</code></li>\n<li><code>services/analytics-service/handler/timeline.go</code></li>\n<li><code>services/analytics-service/handler/handler_test.go</code></li>\n<li>Update <code>services/analytics-service/main.go</code> with full M4 wiring\n<strong>Checkpoint:</strong> Make 10 redirects → GET /stats/:code shows total_clicks=10. Milestone row with milestone=10 in analytics_db. MilestoneReachedEvent visible in notifications.events queue.</li>\n</ul>\n<h3 id=\"17-notification-service-schema-repository-m5-6090-min\">17. Notification Service Schema + Repository — M5 (60–90 min)</h3>\n<ul>\n<li><code>services/notification-service/migrations/001_create_notifications.sql</code></li>\n<li><code>services/notification-service/repository/notification_repository.go</code></li>\n<li><code>services/notification-service/repository/notification_repository_test.go</code></li>\n</ul>\n<h3 id=\"18-notification-service-consumer-handlers-m5-90120-min\">18. Notification Service Consumer + Handlers — M5 (90–120 min)</h3>\n<ul>\n<li><code>services/notification-service/consumer/consumer.go</code></li>\n<li><code>services/notification-service/consumer/processor.go</code></li>\n<li><code>services/notification-service/consumer/processor_test.go</code></li>\n<li><code>services/notification-service/handler/helpers.go</code></li>\n<li><code>services/notification-service/handler/notifications.go</code></li>\n<li><code>services/notification-service/handler/handler_test.go</code></li>\n<li>Update <code>services/notification-service/main.go</code> with full M5 wiring</li>\n</ul>\n<h3 id=\"19-shared-logger-finalization-m5-4560-min\">19. Shared Logger Finalization — M5 (45–60 min)</h3>\n<ul>\n<li>Update <code>shared/logger/logger.go</code> — add <code>WithCorrelationID</code>, <code>RequestLogger</code>, <code>responseWriter</code></li>\n<li>Update all 5 services&#39; <code>main.go</code> to wrap mux with <code>logger.RequestLogger</code></li>\n</ul>\n<h3 id=\"20-gateway-middleware-m5-6090-min\">20. Gateway Middleware — M5 (60–90 min)</h3>\n<ul>\n<li><code>gateway/middleware/correlation.go</code></li>\n<li><code>gateway/middleware/jwt.go</code></li>\n<li><code>gateway/middleware/logging.go</code></li>\n<li><code>gateway/middleware/middleware_test.go</code></li>\n</ul>\n<h3 id=\"21-gateway-circuit-breaker-rate-limiter-m5-90120-min\">21. Gateway Circuit Breaker + Rate Limiter — M5 (90–120 min)</h3>\n<ul>\n<li><code>gateway/circuitbreaker/circuitbreaker.go</code></li>\n<li><code>gateway/circuitbreaker/circuitbreaker_test.go</code></li>\n<li><code>gateway/ratelimit/ratelimit.go</code></li>\n<li><code>gateway/ratelimit/ratelimit_test.go</code></li>\n</ul>\n<h3 id=\"22-gateway-proxy-router-main-m5-90120-min\">22. Gateway Proxy + Router + Main — M5 (90–120 min)</h3>\n<ul>\n<li><code>gateway/proxy/proxy.go</code></li>\n<li><code>gateway/proxy/proxy_test.go</code></li>\n<li><code>gateway/router/router.go</code></li>\n<li><code>gateway/router/router_test.go</code></li>\n<li>Update <code>gateway/main.go</code> with full M5 wiring</li>\n</ul>\n<h3 id=\"23-end-to-end-tests-m5-6090-min\">23. End-to-End Tests — M5 (60–90 min)</h3>\n<ul>\n<li><code>test/e2e_m5_test.go</code></li>\n<li>Run: <code>go test -tags integration -v -timeout 120s ./test/...</code>\n<strong>Checkpoint:</strong> All 11 containers healthy. Full E2E flow: register → login → shorten → redirect → stats → notification. Rate limit 429 on 11th shorten. Circuit breaker 503 after 5 url-service failures. Correlation ID in every log line.</li>\n</ul>\n<hr>\n<h2 id=\"file-count-summary\">File Count Summary</h2>\n<table>\n<thead>\n<tr>\n<th>Category</th>\n<th>Count</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>shared/</code> Go source files</td>\n<td>6</td>\n</tr>\n<tr>\n<td><code>url-service/</code> Go source files</td>\n<td>16</td>\n</tr>\n<tr>\n<td><code>analytics-service/</code> Go source files</td>\n<td>16</td>\n</tr>\n<tr>\n<td><code>user-service/</code> Go source files</td>\n<td>12</td>\n</tr>\n<tr>\n<td><code>notification-service/</code> Go source files</td>\n<td>10</td>\n</tr>\n<tr>\n<td><code>gateway/</code> Go source files</td>\n<td>15</td>\n</tr>\n<tr>\n<td>SQL migration files</td>\n<td>9</td>\n</tr>\n<tr>\n<td>Dockerfiles</td>\n<td>5</td>\n</tr>\n<tr>\n<td><code>go.mod</code> files</td>\n<td>6</td>\n</tr>\n<tr>\n<td>Shell/test scripts</td>\n<td>2</td>\n</tr>\n<tr>\n<td>Config/docs</td>\n<td>3</td>\n</tr>\n<tr>\n<td><strong>Total tracked files</strong></td>\n<td><strong>~100</strong></td>\n</tr>\n<tr>\n<td>Directories</td>\n<td>~45</td>\n</tr>\n<tr>\n<td>Estimated lines of code</td>\n<td>~8,000–10,000</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>Verification:</strong> Every file mentioned in M1–M5 TDD <code>File Structure</code> sections is represented. Creation order respects dependency direction: <code>shared/</code> before services, M1 infra before M2 auth before M3 URL before M4 analytics before M5 gateway+notifications. A learner can execute <code>mkdir -p</code> and <code>touch</code> from this tree without ambiguity.</p>\n</blockquote>\n","toc":[{"level":1,"text":"URL Shortener (Microservices) — Engineering Design Document","id":"url-shortener-microservices-engineering-design-document"},{"level":2,"text":"System Purpose","id":"system-purpose"},{"level":2,"text":"A production-grade URL shortener decomposed into four independently deployable services, each owning its bounded context and data store. The design prioritizes correct service boundary enforcement and async event flow over feature breadth — making the architectural decisions the primary deliverable, not the product functionality.","id":"a-production-grade-url-shortener-decomposed-into-four-independently-deployable-services-each-owning-its-bounded-context-and-data-store-the-design-prioritizes-correct-service-boundary-enforcement-and-async-event-flow-over-feature-breadth-making-the-architectural-decisions-the-primary-deliverable-not-the-product-functionality"},{"level":2,"text":"Service Map","id":"service-map"},{"level":2,"text":"Tech Stack","id":"tech-stack"},{"level":2,"text":"Key Design Decisions","id":"key-design-decisions"},{"level":2,"text":"Anti-Patterns Explicitly Avoided","id":"anti-patterns-explicitly-avoided"},{"level":1,"text":"TDD","id":"tdd"},{"level":1,"text":"Technical Design Specification","id":"technical-design-specification"},{"level":2,"text":"Module: Foundation — Repo Layout, Shared Contracts, Local Dev Stack","id":"module-foundation-repo-layout-shared-contracts-local-dev-stack"},{"level":2,"text":"Module ID: url-shortener-m1","id":"module-id-url-shortener-m1"},{"level":2,"text":"1. Module Charter","id":"1-module-charter"},{"level":2,"text":"2. File Structure","id":"2-file-structure"},{"level":2,"text":"Total files to create: 32 (excluding auto-generated go.sum files).","id":"total-files-to-create-32-excluding-auto-generated-gosum-files"},{"level":2,"text":"3. Complete Data Model","id":"3-complete-data-model"},{"level":3,"text":"3.1 Domain Event Structs (shared/events/events.go)","id":"31-domain-event-structs-sharedeventseventsgo"},{"level":3,"text":"3.2 Health Response Schema","id":"32-health-response-schema"},{"level":3,"text":"3.3 Logger Fields (Structured JSON)","id":"33-logger-fields-structured-json"},{"level":2,"text":"4. Interface Contracts","id":"4-interface-contracts"},{"level":3,"text":"4.1 shared/logger Package","id":"41-sharedlogger-package"},{"level":3,"text":"4.2 handler.HealthHandler","id":"42-handlerhealthhandler"},{"level":3,"text":"4.3 DB Connection Bootstrap","id":"43-db-connection-bootstrap"},{"level":3,"text":"4.4 Redis Connection Bootstrap (url-service only)","id":"44-redis-connection-bootstrap-url-service-only"},{"level":3,"text":"4.5 RabbitMQ Bootstrap","id":"45-rabbitmq-bootstrap"},{"level":2,"text":"5. Algorithm Specification","id":"5-algorithm-specification"},{"level":3,"text":"5.1 Service Startup Sequence","id":"51-service-startup-sequence"},{"level":3,"text":"5.2 Gateway Startup Health-Check Loop","id":"52-gateway-startup-health-check-loop"},{"level":2,"text":"6. Docker Compose Specification","id":"6-docker-compose-specification"},{"level":3,"text":"6.1 Container Inventory","id":"61-container-inventory"},{"level":3,"text":"6.2 docker-compose.yml (complete, annotated)","id":"62-docker-composeyml-complete-annotated"},{"level":2,"text":"7. Go Module Declarations","id":"7-go-module-declarations"},{"level":2,"text":"Important: Use replace directives in each service&#39;s go.mod to reference the local shared module. This avoids publishing to a registry during development. After adding the replace directive, run go mod tidy in each service directory.","id":"important-use-replace-directives-in-each-service39s-gomod-to-reference-the-local-shared-module-this-avoids-publishing-to-a-registry-during-development-after-adding-the-replace-directive-run-go-mod-tidy-in-each-service-directory"},{"level":2,"text":"8. Dockerfile Specification","id":"8-dockerfile-specification"},{"level":2,"text":"9. Environment Variable Reference","id":"9-environment-variable-reference"},{"level":2,"text":"Call mustGetEnv for every required variable before any I/O. This guarantees a clean failure message rather than a nil-pointer panic deep in a library.","id":"call-mustgetenv-for-every-required-variable-before-any-io-this-guarantees-a-clean-failure-message-rather-than-a-nil-pointer-panic-deep-in-a-library"},{"level":2,"text":"10. Error Handling Matrix","id":"10-error-handling-matrix"},{"level":2,"text":"11. RabbitMQ Topology Specification","id":"11-rabbitmq-topology-specification"},{"level":3,"text":"Exchange","id":"exchange"},{"level":3,"text":"Queues","id":"queues"},{"level":3,"text":"Bindings","id":"bindings"},{"level":2,"text":"12. Implementation Sequence with Checkpoints","id":"12-implementation-sequence-with-checkpoints"},{"level":3,"text":"Phase 1 — Monorepo Scaffold + go.mod (0.5–1 hr)","id":"phase-1-monorepo-scaffold-gomod-051-hr"},{"level":3,"text":"Phase 2 — shared/events/ + shared/logger/ (0.5–1 hr)","id":"phase-2-sharedevents-sharedlogger-051-hr"},{"level":3,"text":"Phase 3 — docker-compose.yml (1–1.5 hr)","id":"phase-3-docker-composeyml-115-hr"},{"level":3,"text":"Phase 4 — DB + Redis + RabbitMQ Bootstrapping (1–1.5 hr)","id":"phase-4-db-redis-rabbitmq-bootstrapping-115-hr"},{"level":3,"text":"Phase 5 — /health Handlers + Gateway Startup Check (0.5–1 hr)","id":"phase-5-health-handlers-gateway-startup-check-051-hr"},{"level":2,"text":"13. Test Specification","id":"13-test-specification"},{"level":3,"text":"13.1 shared/events Package Tests","id":"131-sharedevents-package-tests"},{"level":3,"text":"13.2 ConnectDB Tests (integration, requires Docker)","id":"132-connectdb-tests-integration-requires-docker"},{"level":3,"text":"13.3 ConnectRedis Tests","id":"133-connectredis-tests"},{"level":3,"text":"13.4 Health Handler Tests","id":"134-health-handler-tests"},{"level":3,"text":"13.5 extractHost Tests","id":"135-extracthost-tests"},{"level":3,"text":"13.6 End-to-End Smoke Test (shell script)","id":"136-end-to-end-smoke-test-shell-script"},{"level":2,"text":"14. Performance Targets","id":"14-performance-targets"},{"level":2,"text":"15. Anti-Pattern Guard Rail Checklist","id":"15-anti-pattern-guard-rail-checklist"},{"level":1,"text":"Technical Design Specification","id":"technical-design-specification"},{"level":2,"text":"Module: User Service — Registration, Login, JWT Issuance","id":"module-user-service-registration-login-jwt-issuance"},{"level":2,"text":"Module ID: url-shortener-m2","id":"module-id-url-shortener-m2"},{"level":2,"text":"1. Module Charter","id":"1-module-charter"},{"level":2,"text":"2. File Structure","id":"2-file-structure"},{"level":2,"text":"Total new files: 22 (go.sum files are auto-generated and excluded from the count).","id":"total-new-files-22-gosum-files-are-auto-generated-and-excluded-from-the-count"},{"level":2,"text":"3. Complete Data Model","id":"3-complete-data-model"},{"level":3,"text":"3.1 PostgreSQL Schema (migrations/001_create_users.sql)","id":"31-postgresql-schema-migrations001_create_userssql"},{"level":3,"text":"3.2 Go Structs","id":"32-go-structs"},{"level":3,"text":"3.3 JWT Payload Wire Format","id":"33-jwt-payload-wire-format"},{"level":2,"text":"4. Interface Contracts","id":"4-interface-contracts"},{"level":3,"text":"4.1 UserRepository — pgxUserRepository Implementation","id":"41-userrepository-pgxuserrepository-implementation"},{"level":3,"text":"4.2 PasswordHasher","id":"42-passwordhasher"},{"level":3,"text":"4.3 JWTSigner and JWTVerifier","id":"43-jwtsigner-and-jwtverifier"},{"level":3,"text":"4.4 UserService","id":"44-userservice"},{"level":3,"text":"4.5 shared/middleware — JWT Middleware","id":"45-sharedmiddleware-jwt-middleware"},{"level":2,"text":"5. Algorithm Specification","id":"5-algorithm-specification"},{"level":3,"text":"5.1 Input Validation","id":"51-input-validation"},{"level":3,"text":"5.2 POST /register Handler Flow","id":"52-post-register-handler-flow"},{"level":3,"text":"5.3 POST /login Handler Flow","id":"53-post-login-handler-flow"},{"level":3,"text":"5.4 GET /me Handler Flow","id":"54-get-me-handler-flow"},{"level":3,"text":"5.5 Route Registration in main.go","id":"55-route-registration-in-maingo"},{"level":2,"text":"Go 1.22+ routing note: The net/http mux in Go 1.22 supports method-prefixed patterns (&quot;POST /register&quot;). Since go.mod declares go 1.23, this is available. Do not use http.ServeMux workarounds; use the native method patterns.","id":"go-122-routing-note-the-nethttp-mux-in-go-122-supports-method-prefixed-patterns-quotpost-registerquot-since-gomod-declares-go-123-this-is-available-do-not-use-httpservemux-workarounds-use-the-native-method-patterns"},{"level":2,"text":"6. Threat Model","id":"6-threat-model"},{"level":3,"text":"6.1 Attack Surface","id":"61-attack-surface"},{"level":3,"text":"6.2 Timing Attack Mitigation for Login","id":"62-timing-attack-mitigation-for-login"},{"level":2,"text":"7. Error Handling Matrix","id":"7-error-handling-matrix"},{"level":2,"text":"8. Implementation Sequence with Checkpoints","id":"8-implementation-sequence-with-checkpoints"},{"level":3,"text":"Phase 1 — users table migration + UserRepository (1–1.5 hr)","id":"phase-1-users-table-migration-userrepository-115-hr"},{"level":3,"text":"Phase 2 — PasswordHasher + JWTSigner/JWTVerifier (1–1.5 hr)","id":"phase-2-passwordhasher-jwtsignerjwtverifier-115-hr"},{"level":3,"text":"Phase 3 — POST /register + POST /login Handlers (1.5–2 hr)","id":"phase-3-post-register-post-login-handlers-152-hr"},{"level":3,"text":"Phase 4 — JWT Middleware in shared/middleware/ (1–1.5 hr)","id":"phase-4-jwt-middleware-in-sharedmiddleware-115-hr"},{"level":3,"text":"Phase 5 — GET /me + Integration Test (1–1.5 hr)","id":"phase-5-get-me-integration-test-115-hr"},{"level":2,"text":"9. Test Specification","id":"9-test-specification"},{"level":3,"text":"9.1 Test File Organization","id":"91-test-file-organization"},{"level":3,"text":"9.2 repository/user_repository_test.go","id":"92-repositoryuser_repository_testgo"},{"level":3,"text":"9.3 auth/password_test.go","id":"93-authpassword_testgo"},{"level":3,"text":"9.4 auth/jwt_test.go","id":"94-authjwt_testgo"},{"level":3,"text":"9.5 shared/middleware/jwt_middleware_test.go","id":"95-sharedmiddlewarejwt_middleware_testgo"},{"level":3,"text":"9.6 handler/handler_test.go — Integration Test","id":"96-handlerhandler_testgo-integration-test"},{"level":2,"text":"10. Performance Targets","id":"10-performance-targets"},{"level":2,"text":"11. Concurrency Specification","id":"11-concurrency-specification"},{"level":3,"text":"11.1 Handler Concurrency","id":"111-handler-concurrency"},{"level":3,"text":"11.2 Blocking Operations","id":"112-blocking-operations"},{"level":2,"text":"12. Environment Variable Reference for This Module","id":"12-environment-variable-reference-for-this-module"},{"level":2,"text":"Cross-service secret sharing: The same JWT_SECRET value must be set in the environment of url-service, analytics-service, notification-service, and the gateway. They use it only to construct a JWTVerifier — never a JWTSigner. Add JWT_SECRET to each service&#39;s docker-compose.yml environment block in M3–M5.","id":"cross-service-secret-sharing-the-same-jwt_secret-value-must-be-set-in-the-environment-of-url-service-analytics-service-notification-service-and-the-gateway-they-use-it-only-to-construct-a-jwtverifier-never-a-jwtsigner-add-jwt_secret-to-each-service39s-docker-composeyml-environment-block-in-m3m5"},{"level":1,"text":"Technical Design Specification","id":"technical-design-specification"},{"level":2,"text":"Module: URL Service — Shorten, Redirect, CRUD + Domain Event Publishing","id":"module-url-service-shorten-redirect-crud-domain-event-publishing"},{"level":2,"text":"Module ID: url-shortener-m3","id":"module-id-url-shortener-m3"},{"level":2,"text":"1. Module Charter","id":"1-module-charter"},{"level":2,"text":"2. File Structure","id":"2-file-structure"},{"level":2,"text":"Total new files: 23 (excluding auto-generated go.sum changes).","id":"total-new-files-23-excluding-auto-generated-gosum-changes"},{"level":2,"text":"3. Complete Data Model","id":"3-complete-data-model"},{"level":3,"text":"3.1 PostgreSQL Schema — migrations/001_create_urls.sql","id":"31-postgresql-schema-migrations001_create_urlssql"},{"level":3,"text":"3.2 PostgreSQL Schema — migrations/002_create_outbox.sql","id":"32-postgresql-schema-migrations002_create_outboxsql"},{"level":3,"text":"3.3 Go Structs","id":"33-go-structs"},{"level":2,"text":"4. Interface Contracts","id":"4-interface-contracts"},{"level":3,"text":"4.1 URLRepository","id":"41-urlrepository"},{"level":3,"text":"4.2 OutboxRepository","id":"42-outboxrepository"},{"level":3,"text":"4.3 CacheClient","id":"43-cacheclient"},{"level":3,"text":"4.4 CodeGenerator","id":"44-codegenerator"},{"level":3,"text":"4.5 AMQPPublisher","id":"45-amqppublisher"},{"level":3,"text":"4.6 URLService","id":"46-urlservice"},{"level":2,"text":"5. Algorithm Specification","id":"5-algorithm-specification"},{"level":3,"text":"5.1 Base62 Code Generation","id":"51-base62-code-generation"},{"level":3,"text":"5.2 Short Code Selection with Collision Retry","id":"52-short-code-selection-with-collision-retry"},{"level":3,"text":"5.3 Atomic URL + Outbox Write","id":"53-atomic-url-outbox-write"},{"level":3,"text":"5.4 Redirect with Read-Through Cache","id":"54-redirect-with-read-through-cache"},{"level":3,"text":"5.5 Cache TTL Computation","id":"55-cache-ttl-computation"},{"level":3,"text":"5.6 Cursor-Based Pagination for GET /urls","id":"56-cursor-based-pagination-for-get-urls"},{"level":3,"text":"5.7 Outbox Worker Pool","id":"57-outbox-worker-pool"},{"level":3,"text":"5.8 AMQPPublisher Implementation","id":"58-amqppublisher-implementation"},{"level":2,"text":"6. HTTP Handler Specification","id":"6-http-handler-specification"},{"level":3,"text":"6.1 POST /shorten Handler","id":"61-post-shorten-handler"},{"level":3,"text":"6.2 GET /:code Redirect Handler","id":"62-get-code-redirect-handler"},{"level":3,"text":"6.3 GET /urls List Handler","id":"63-get-urls-list-handler"},{"level":3,"text":"6.4 DELETE /urls/:code Handler","id":"64-delete-urlscode-handler"},{"level":2,"text":"7. Error Handling Matrix","id":"7-error-handling-matrix"},{"level":2,"text":"8. Route Registration in main.go","id":"8-route-registration-in-maingo"},{"level":2,"text":"9. Concurrency Specification","id":"9-concurrency-specification"},{"level":3,"text":"9.1 HTTP Handler Goroutines","id":"91-http-handler-goroutines"},{"level":3,"text":"9.2 Outbox Worker Pool","id":"92-outbox-worker-pool"},{"level":3,"text":"9.3 Cache-Aside Read Safety","id":"93-cache-aside-read-safety"},{"level":2,"text":"10. Implementation Sequence with Checkpoints","id":"10-implementation-sequence-with-checkpoints"},{"level":3,"text":"Phase 1 — Schema Migrations + Indexes (1–1.5 hr)","id":"phase-1-schema-migrations-indexes-115-hr"},{"level":3,"text":"Phase 2 — Base62 Code Generator (1–1.5 hr)","id":"phase-2-base62-code-generator-115-hr"},{"level":3,"text":"Phase 3 — URLRepository + OutboxRepository (1.5–2 hr)","id":"phase-3-urlrepository-outboxrepository-152-hr"},{"level":3,"text":"Phase 4 — Redis CacheClient (1–1.5 hr)","id":"phase-4-redis-cacheclient-115-hr"},{"level":3,"text":"Phase 5 — POST /shorten + DELETE /urls/:code Handlers (1.5–2 hr)","id":"phase-5-post-shorten-delete-urlscode-handlers-152-hr"},{"level":3,"text":"Phase 6 — GET /:code Redirect (1.5–2 hr)","id":"phase-6-get-code-redirect-152-hr"},{"level":3,"text":"Phase 7 — GET /urls Cursor Pagination (1–1.5 hr)","id":"phase-7-get-urls-cursor-pagination-115-hr"},{"level":3,"text":"Phase 8 — Outbox Worker Pool + AMQPPublisher (2–2.5 hr)","id":"phase-8-outbox-worker-pool-amqppublisher-225-hr"},{"level":3,"text":"Phase 9 — Unit Tests + Benchmarks (1–1.5 hr)","id":"phase-9-unit-tests-benchmarks-115-hr"},{"level":2,"text":"11. Test Specification","id":"11-test-specification"},{"level":3,"text":"11.1 codegen/codegen_test.go","id":"111-codegencodegen_testgo"},{"level":3,"text":"11.2 repository/url_repository_test.go (integration)","id":"112-repositoryurl_repository_testgo-integration"},{"level":3,"text":"11.3 repository/outbox_repository_test.go (integration)","id":"113-repositoryoutbox_repository_testgo-integration"},{"level":3,"text":"11.4 cache/cache_test.go","id":"114-cachecache_testgo"},{"level":3,"text":"11.5 handler/handler_test.go (integration + unit)","id":"115-handlerhandler_testgo-integration-unit"},{"level":2,"text":"12. Environment Variable Reference","id":"12-environment-variable-reference"},{"level":2,"text":"13. Performance Targets","id":"13-performance-targets"},{"level":2,"text":"14. Anti-Pattern Guard Rail Checklist","id":"14-anti-pattern-guard-rail-checklist"},{"level":1,"text":"Technical Design Specification","id":"technical-design-specification"},{"level":2,"text":"Module: Analytics Service — Click Ingestion + Stats API","id":"module-analytics-service-click-ingestion-stats-api"},{"level":2,"text":"Module ID: url-shortener-m4","id":"module-id-url-shortener-m4"},{"level":2,"text":"1. Module Charter","id":"1-module-charter"},{"level":2,"text":"2. File Structure","id":"2-file-structure"},{"level":2,"text":"Total new files: 22 (excluding auto-generated go.sum changes).","id":"total-new-files-22-excluding-auto-generated-gosum-changes"},{"level":2,"text":"3. Complete Data Model","id":"3-complete-data-model"},{"level":3,"text":"3.1 PostgreSQL Schema — migrations/001_create_clicks.sql","id":"31-postgresql-schema-migrations001_create_clickssql"},{"level":3,"text":"3.2 PostgreSQL Schema — migrations/002_create_milestones.sql","id":"32-postgresql-schema-migrations002_create_milestonessql"},{"level":3,"text":"3.3 PostgreSQL Schema — migrations/003_create_processed_events.sql","id":"33-postgresql-schema-migrations003_create_processed_eventssql"},{"level":3,"text":"3.4 Go Structs","id":"34-go-structs"},{"level":2,"text":"4. Interface Contracts","id":"4-interface-contracts"},{"level":3,"text":"4.1 ClickRepository","id":"41-clickrepository"},{"level":3,"text":"4.2 ProcessedEventRepository","id":"42-processedeventrepository"},{"level":3,"text":"4.3 MilestoneRepository","id":"43-milestonerepository"},{"level":3,"text":"4.4 AMQPConsumer","id":"44-amqpconsumer"},{"level":3,"text":"4.5 ClickProcessor","id":"45-clickprocessor"},{"level":3,"text":"4.6 MilestoneDetector","id":"46-milestonedetector"},{"level":3,"text":"4.7 AMQPPublisher (analytics-service scoped)","id":"47-amqppublisher-analytics-service-scoped"},{"level":2,"text":"5. Algorithm Specification","id":"5-algorithm-specification"},{"level":3,"text":"5.1 Consumer Goroutine Lifecycle","id":"51-consumer-goroutine-lifecycle"},{"level":3,"text":"5.2 ClickProcessor.Process — Full Algorithm","id":"52-clickprocessorprocess-full-algorithm"},{"level":3,"text":"5.3 detectAndRecordMilestone — Milestone Detection Algorithm","id":"53-detectandrecordmilestone-milestone-detection-algorithm"},{"level":3,"text":"5.4 GET /stats/:code Handler Algorithm","id":"54-get-statscode-handler-algorithm"},{"level":3,"text":"5.5 GET /stats/:code/timeline Handler Algorithm","id":"55-get-statscodetimeline-handler-algorithm"},{"level":2,"text":"6. State Machine: Consumer Goroutine","id":"6-state-machine-consumer-goroutine"},{"level":2,"text":"The Qos(1, 0, false) (prefetch=1) enforces that the broker does not deliver a second message until the first is ACKed or NACKed, making the per-message substates truly sequential.","id":"the-qos1-0-false-prefetch1-enforces-that-the-broker-does-not-deliver-a-second-message-until-the-first-is-acked-or-nacked-making-the-per-message-substates-truly-sequential"},{"level":2,"text":"7. Error Handling Matrix","id":"7-error-handling-matrix"},{"level":2,"text":"8. Concurrency Specification","id":"8-concurrency-specification"},{"level":3,"text":"8.1 Consumer Goroutine","id":"81-consumer-goroutine"},{"level":3,"text":"8.2 Stats API Handlers","id":"82-stats-api-handlers"},{"level":3,"text":"8.3 Consumer vs. Stats API Isolation","id":"83-consumer-vs-stats-api-isolation"},{"level":2,"text":"9. Route Registration in main.go","id":"9-route-registration-in-maingo"},{"level":2,"text":"Pattern disambiguation: GET /stats/{code}/timeline is more specific than GET /stats/{code} — Go 1.22+ net/http routing correctly resolves this: /stats/abc/timeline matches the timeline handler, /stats/abc matches the stats handler. Register in any order; specificity takes precedence.\nNo /analytics/ prefix: The gateway (M5) routes GET /api/stats/:code → http://analytics-service:8082/stats/:code. The service itself uses /stats/ without the /api/ prefix — the gateway strips the path prefix before forwarding. Verify the gateway routing table in M5.","id":"pattern-disambiguation-get-statscodetimeline-is-more-specific-than-get-statscode-go-122-nethttp-routing-correctly-resolves-this-statsabctimeline-matches-the-timeline-handler-statsabc-matches-the-stats-handler-register-in-any-order-specificity-takes-precedence-no-analytics-prefix-the-gateway-m5-routes-get-apistatscode-httpanalytics-service8082statscode-the-service-itself-uses-stats-without-the-api-prefix-the-gateway-strips-the-path-prefix-before-forwarding-verify-the-gateway-routing-table-in-m5"},{"level":2,"text":"10. Implementation Sequence with Checkpoints","id":"10-implementation-sequence-with-checkpoints"},{"level":3,"text":"Phase 1 — Schema Migrations + Indexes (1–1.5 hr)","id":"phase-1-schema-migrations-indexes-115-hr"},{"level":3,"text":"Phase 2 — Repository Layer (1.5–2 hr)","id":"phase-2-repository-layer-152-hr"},{"level":3,"text":"Phase 3 — RabbitMQ Consumer + Idempotency (2–2.5 hr)","id":"phase-3-rabbitmq-consumer-idempotency-225-hr"},{"level":3,"text":"Phase 4 — Milestone Detection + MilestoneReachedEvent Publish (1–1.5 hr)","id":"phase-4-milestone-detection-milestonereachedevent-publish-115-hr"},{"level":3,"text":"Phase 5 — Stats API Handlers (1.5–2 hr)","id":"phase-5-stats-api-handlers-152-hr"},{"level":3,"text":"Phase 6 — Idempotency Test (0.5–1 hr)","id":"phase-6-idempotency-test-051-hr"},{"level":2,"text":"11. Test Specification","id":"11-test-specification"},{"level":3,"text":"11.1 repository/click_repository_test.go (integration)","id":"111-repositoryclick_repository_testgo-integration"},{"level":3,"text":"11.2 repository/processed_event_repository_test.go (integration)","id":"112-repositoryprocessed_event_repository_testgo-integration"},{"level":3,"text":"11.3 consumer/processor_test.go (unit + integration)","id":"113-consumerprocessor_testgo-unit-integration"},{"level":3,"text":"11.4 milestone/detector_test.go","id":"114-milestonedetector_testgo"},{"level":3,"text":"11.5 handler/handler_test.go","id":"115-handlerhandler_testgo"},{"level":2,"text":"12. Performance Targets","id":"12-performance-targets"},{"level":2,"text":"13. Environment Variable Reference","id":"13-environment-variable-reference"},{"level":2,"text":"14. Anti-Pattern Guard Rail Checklist","id":"14-anti-pattern-guard-rail-checklist"},{"level":1,"text":"Technical Design Specification","id":"technical-design-specification"},{"level":2,"text":"Module: Notification Service + API Gateway + Circuit Breaker","id":"module-notification-service-api-gateway-circuit-breaker"},{"level":2,"text":"Module ID: url-shortener-m5","id":"module-id-url-shortener-m5"},{"level":2,"text":"1. Module Charter","id":"1-module-charter"},{"level":2,"text":"2. File Structure","id":"2-file-structure"},{"level":2,"text":"Total new files: 27 (excluding auto-generated go.sum changes and files already written in prior milestones).","id":"total-new-files-27-excluding-auto-generated-gosum-changes-and-files-already-written-in-prior-milestones"},{"level":2,"text":"3. Complete Data Model","id":"3-complete-data-model"},{"level":3,"text":"3.1 PostgreSQL Schema — migrations/001_create_notifications.sql","id":"31-postgresql-schema-migrations001_create_notificationssql"},{"level":3,"text":"3.2 Go Structs — Notification Service","id":"32-go-structs-notification-service"},{"level":3,"text":"3.3 Go Structs — Circuit Breaker","id":"33-go-structs-circuit-breaker"},{"level":3,"text":"3.4 Go Structs — Rate Limiter","id":"34-go-structs-rate-limiter"},{"level":3,"text":"3.5 Go Structs — Gateway Proxy","id":"35-go-structs-gateway-proxy"},{"level":3,"text":"3.6 Structured Log Entry (finalized schema)","id":"36-structured-log-entry-finalized-schema"},{"level":2,"text":"4. Interface Contracts","id":"4-interface-contracts"},{"level":3,"text":"4.1 NotificationRepository","id":"41-notificationrepository"},{"level":3,"text":"4.2 CircuitBreaker","id":"42-circuitbreaker"},{"level":3,"text":"4.3 RateLimiter","id":"43-ratelimiter"},{"level":3,"text":"4.4 ReverseProxy.Forward","id":"44-reverseproxyforward"},{"level":3,"text":"4.5 Correlation Middleware","id":"45-correlation-middleware"},{"level":3,"text":"4.6 Gateway JWT Middleware","id":"46-gateway-jwt-middleware"},{"level":3,"text":"4.7 shared/logger.New","id":"47-sharedloggernew"},{"level":2,"text":"5. Algorithm Specification","id":"5-algorithm-specification"},{"level":3,"text":"5.1 Notification Processor — Full Algorithm","id":"51-notification-processor-full-algorithm"},{"level":3,"text":"5.2 Circuit Breaker State Machine — Detailed Transitions","id":"52-circuit-breaker-state-machine-detailed-transitions"},{"level":3,"text":"5.3 Gateway Request Routing Algorithm","id":"53-gateway-request-routing-algorithm"},{"level":3,"text":"5.4 Rate Limit Middleware Integration","id":"54-rate-limit-middleware-integration"},{"level":3,"text":"5.5 Circuit Breaker Middleware Integration","id":"55-circuit-breaker-middleware-integration"},{"level":3,"text":"5.6 Structured Logging Propagation Across Services","id":"56-structured-logging-propagation-across-services"},{"level":3,"text":"5.7 GET /notifications Handler Algorithm","id":"57-get-notifications-handler-algorithm"},{"level":3,"text":"5.8 Gateway Startup Sequence","id":"58-gateway-startup-sequence"},{"level":2,"text":"6. State Machine: Circuit Breaker","id":"6-state-machine-circuit-breaker"},{"level":2,"text":"7. Error Handling Matrix","id":"7-error-handling-matrix"},{"level":3,"text":"Notification Service","id":"notification-service"},{"level":3,"text":"API Gateway","id":"api-gateway"},{"level":2,"text":"8. Route Registration in gateway/main.go","id":"8-route-registration-in-gatewaymaingo"},{"level":2,"text":"rp.HandlerFor(name string) http.Handler returns a pre-built http.Handler that calls rp.Forward(name, w, r) for the named downstream target. This enables clean composition with the middleware chain.\n{{DIAGRAM:tdd-diag-38}}","id":"rphandlerforname-string-httphandler-returns-a-pre-built-httphandler-that-calls-rpforwardname-w-r-for-the-named-downstream-target-this-enables-clean-composition-with-the-middleware-chain-diagramtdd-diag-38"},{"level":2,"text":"9. Concurrency Specification","id":"9-concurrency-specification"},{"level":3,"text":"9.1 Circuit Breaker","id":"91-circuit-breaker"},{"level":3,"text":"9.2 Rate Limiter","id":"92-rate-limiter"},{"level":3,"text":"9.3 Reverse Proxy","id":"93-reverse-proxy"},{"level":3,"text":"9.4 Notification Consumer","id":"94-notification-consumer"},{"level":3,"text":"9.5 Gateway HTTP Server","id":"95-gateway-http-server"},{"level":2,"text":"10. Implementation Sequence with Checkpoints","id":"10-implementation-sequence-with-checkpoints"},{"level":3,"text":"Phase 1 — Notification Service: Schema + Consumer + API (2–2.5 hr)","id":"phase-1-notification-service-schema-consumer-api-225-hr"},{"level":3,"text":"Phase 2 — shared/logger: Finalize Structured Logger (1–1.5 hr)","id":"phase-2-sharedlogger-finalize-structured-logger-115-hr"},{"level":3,"text":"Phase 3 — Gateway: Routing + Reverse Proxy + Correlation Middleware (2–2.5 hr)","id":"phase-3-gateway-routing-reverse-proxy-correlation-middleware-225-hr"},{"level":3,"text":"Phase 4 — Gateway: JWT Middleware (1–1.5 hr)","id":"phase-4-gateway-jwt-middleware-115-hr"},{"level":3,"text":"Phase 5 — Gateway: Redis Rate Limiter (1.5–2 hr)","id":"phase-5-gateway-redis-rate-limiter-152-hr"},{"level":3,"text":"Phase 6 — Gateway: Circuit Breaker (1.5–2 hr)","id":"phase-6-gateway-circuit-breaker-152-hr"},{"level":3,"text":"Phase 7 — Structured Logging Across All Services (1–1.5 hr)","id":"phase-7-structured-logging-across-all-services-115-hr"},{"level":3,"text":"Phase 8 — End-to-End Integration Test + Rate Limit Test (1.5–2 hr)","id":"phase-8-end-to-end-integration-test-rate-limit-test-152-hr"},{"level":2,"text":"11. Test Specification","id":"11-test-specification"},{"level":3,"text":"11.1 repository/notification_repository_test.go (integration)","id":"111-repositorynotification_repository_testgo-integration"},{"level":3,"text":"11.2 circuitbreaker/circuitbreaker_test.go","id":"112-circuitbreakercircuitbreaker_testgo"},{"level":3,"text":"11.3 middleware/middleware_test.go","id":"113-middlewaremiddleware_testgo"},{"level":3,"text":"11.4 ratelimit/ratelimit_test.go","id":"114-ratelimitratelimit_testgo"},{"level":3,"text":"11.5 consumer/processor_test.go (Notification Service)","id":"115-consumerprocessor_testgo-notification-service"},{"level":3,"text":"11.6 End-to-End Integration Test (test/e2e_m5_test.go)","id":"116-end-to-end-integration-test-teste2e_m5_testgo"},{"level":2,"text":"12. Environment Variable Reference","id":"12-environment-variable-reference"},{"level":3,"text":"Notification Service","id":"notification-service"},{"level":3,"text":"API Gateway","id":"api-gateway"},{"level":2,"text":"13. Performance Targets","id":"13-performance-targets"},{"level":2,"text":"14. Anti-Pattern Guard Rail Checklist","id":"14-anti-pattern-guard-rail-checklist"},{"level":1,"text":"Project Structure: URL Shortener (Microservices)","id":"project-structure-url-shortener-microservices"},{"level":2,"text":"Directory Tree","id":"directory-tree"},{"level":2,"text":"Creation Order","id":"creation-order"},{"level":3,"text":"1. Monorepo Scaffold (30–45 min)","id":"1-monorepo-scaffold-3045-min"},{"level":3,"text":"2. Shared Foundation — M1 (45–60 min)","id":"2-shared-foundation-m1-4560-min"},{"level":3,"text":"3. Dockerfiles — M1 (30 min)","id":"3-dockerfiles-m1-30-min"},{"level":3,"text":"4. Health Handlers + Infra Bootstrap — M1 (60–90 min)","id":"4-health-handlers-infra-bootstrap-m1-6090-min"},{"level":3,"text":"5. User Service Schema + Repository — M2 (60–90 min)","id":"5-user-service-schema-repository-m2-6090-min"},{"level":3,"text":"6. User Service Auth Layer — M2 (60–90 min)","id":"6-user-service-auth-layer-m2-6090-min"},{"level":3,"text":"7. Shared Auth Types — M2 (20 min)","id":"7-shared-auth-types-m2-20-min"},{"level":3,"text":"8. User Service Business Logic + Handlers — M2 (90–120 min)","id":"8-user-service-business-logic-handlers-m2-90120-min"},{"level":3,"text":"9. Shared JWT Middleware — M2 (45–60 min)","id":"9-shared-jwt-middleware-m2-4560-min"},{"level":3,"text":"10. URL Service Schema + Code Generator — M3 (60–90 min)","id":"10-url-service-schema-code-generator-m3-6090-min"},{"level":3,"text":"11. URL Service Repository Layer — M3 (90–120 min)","id":"11-url-service-repository-layer-m3-90120-min"},{"level":3,"text":"12. URL Service Cache + AMQP + Service Layer — M3 (90–120 min)","id":"12-url-service-cache-amqp-service-layer-m3-90120-min"},{"level":3,"text":"13. URL Service Handlers + Outbox Poller — M3 (90–120 min)","id":"13-url-service-handlers-outbox-poller-m3-90120-min"},{"level":3,"text":"14. Analytics Service Schema + Repository — M4 (90–120 min)","id":"14-analytics-service-schema-repository-m4-90120-min"},{"level":3,"text":"15. Analytics Service Consumer + Milestone Detection — M4 (90–120 min)","id":"15-analytics-service-consumer-milestone-detection-m4-90120-min"},{"level":3,"text":"16. Analytics Service Handlers — M4 (60–90 min)","id":"16-analytics-service-handlers-m4-6090-min"},{"level":3,"text":"17. Notification Service Schema + Repository — M5 (60–90 min)","id":"17-notification-service-schema-repository-m5-6090-min"},{"level":3,"text":"18. Notification Service Consumer + Handlers — M5 (90–120 min)","id":"18-notification-service-consumer-handlers-m5-90120-min"},{"level":3,"text":"19. Shared Logger Finalization — M5 (45–60 min)","id":"19-shared-logger-finalization-m5-4560-min"},{"level":3,"text":"20. Gateway Middleware — M5 (60–90 min)","id":"20-gateway-middleware-m5-6090-min"},{"level":3,"text":"21. Gateway Circuit Breaker + Rate Limiter — M5 (90–120 min)","id":"21-gateway-circuit-breaker-rate-limiter-m5-90120-min"},{"level":3,"text":"22. Gateway Proxy + Router + Main — M5 (90–120 min)","id":"22-gateway-proxy-router-main-m5-90120-min"},{"level":3,"text":"23. End-to-End Tests — M5 (60–90 min)","id":"23-end-to-end-tests-m5-6090-min"},{"level":2,"text":"File Count Summary","id":"file-count-summary"}],"title":"URL Shortener (Microservices) — Engineering Design Document","markdown":"# URL Shortener (Microservices) — Engineering Design Document\n## System Purpose\nA production-grade URL shortener decomposed into four independently deployable services, each owning its bounded context and data store. The design prioritizes correct service boundary enforcement and async event flow over feature breadth — making the architectural decisions the primary deliverable, not the product functionality.\n---\n## Service Map\n| Service | Port | Responsibility | DB | Owns Events |\n|---|---|---|---|---|\n| api-gateway | 8080 | Routing, JWT validation, rate limiting, circuit breaker | None (Redis for rate limits) | None |\n| url-service | 8081 | Shorten, redirect, CRUD, outbox polling | url_db (PostgreSQL) + Redis cache | URLCreatedEvent, URLClickedEvent, URLDeletedEvent |\n| analytics-service | 8082 | Click ingestion, stats queries, milestone detection | analytics_db (PostgreSQL) | MilestoneReachedEvent |\n| user-service | 8083 | Registration, login, JWT issuance | user_db (PostgreSQL) | None |\n| notification-service | 8084 | Notification persistence, delivery logging | notification_db (PostgreSQL) | None |\n---\n## Tech Stack\n- **Language:** Go (net/http, pgxpool, crypto/rand)\n- **Message broker:** RabbitMQ (AMQP 0-9-1, topic exchange)\n- **Databases:** PostgreSQL 16 — one container per service\n- **Cache / rate-limit store:** Redis 7 (shared infrastructure, not a service DB)\n- **Containerization:** Docker Compose with healthcheck-gated dependency ordering\n- **Auth:** HS256 JWT; verified locally in each service, issued only by user-service\n---\n## Key Design Decisions\n- **Outbox pattern for event delivery:** URL Service writes events to an `outbox` table in the same transaction as the URL mutation. A worker pool polls and publishes to RabbitMQ. This eliminates the dual-write failure window where a service could commit a URL row but fail to publish the corresponding event.\n- **Async click analytics:** URLClickedEvent is published asynchronously via the outbox rather than calling analytics-service synchronously on the redirect hot path. This decouples redirect latency from analytics availability entirely.\n- **Redis as cache, not as a service database:** All durable writes go to PostgreSQL first. Redis holds read copies with TTL for the redirect hot path and token-bucket counters for gateway rate limiting. Redis unavailability degrades gracefully — it never causes a write failure.\n- **Stateless JWT verification:** Every service verifies tokens locally using the shared secret. No per-request call to user-service. The gateway is the first verification point; downstream services verify independently as a defense layer.\n- **Gateway enforces cross-cutting concerns only:** JWT validation, rate limiting, circuit breaking, and correlation ID injection live in the gateway. Zero domain logic crosses into it — no URL ownership checks, no stats computation.\n---\n## Anti-Patterns Explicitly Avoided\n| Anti-Pattern | Mitigation |\n|---|---|\n| **Shared Database** | Four separate PostgreSQL containers; cross-service data flows via events or API calls only |\n| **Synchronous Call Chain** | Gateway routes to exactly one downstream service; analytics reads from queue, never calls url-service |\n| **God Service** | Each service maps to exactly one bounded context; auth, URL lifecycle, analytics, and notifications are split |\n| **Chatty Service** | Analytics trusts event payloads; it does not call back to url-service to validate `short_code` on ingestion |\n\n---\n\n\n\n# TDD\n\nFive independently deployable Go binaries communicating via HTTP/JSON (sync) and RabbitMQ (async), each with a private PostgreSQL schema. An API Gateway enforces cross-cutting concerns without business logic. The outbox pattern guarantees at-least-once event delivery. Redis serves dual roles: read-through cache in url-service and token-bucket rate-limit store in the gateway. Circuit breaker, correlation IDs, and structured JSON logging provide production-grade observability.\n\n\n\n<!-- TDD_MOD_ID: url-shortener-m1 -->\n# Technical Design Specification\n## Module: Foundation — Repo Layout, Shared Contracts, Local Dev Stack\n**Module ID:** `url-shortener-m1`\n---\n## 1. Module Charter\nThis module establishes every piece of structural infrastructure that subsequent milestones build upon: the monorepo directory layout, Go module declarations per service, shared domain event contracts, Docker Compose topology with full healthcheck wiring, and connection bootstrapping (PostgreSQL via pgxpool, Redis, RabbitMQ) in each service's `main.go`. It also declares the RabbitMQ exchange and queue topology that later milestones publish into and consume from.\nThis module does **not** implement any business logic, authentication, URL shortening, analytics ingestion, notification delivery, or message routing. No HTTP handler beyond `/health` is written. No SQL schema migrations are created (those belong to M2–M5). No JWT middleware, no outbox poller, no consumer goroutines.\n**Upstream dependencies:** None — this is the foundation layer.\n**Downstream dependencies:** Every subsequent milestone (M2–M5) imports `shared/events`, `shared/logger`, and relies on the Docker Compose topology defined here.\n**Invariants that must always hold after this milestone:**\n- Every service owns exactly one PostgreSQL container; no two services share a container or schema.\n- Redis is reachable by url-service but is treated as optional: `redis.Client` initialization failure must not prevent startup.\n- RabbitMQ exchange `url-shortener` (topic) exists before any service attempts to publish or consume; declaration is idempotent.\n- Every service returns HTTP 200 on `GET /health` within 10ms once healthy.\n- `docker compose up` brings all containers to the healthy state within 60 seconds on commodity hardware.\n---\n## 2. File Structure\nCreate files in the numbered order below. Parent directories that do not yet exist must be created first.\n```\nurl-shortener/                          # repo root\n│\n├── 01  docker-compose.yml\n├── 02  .env.example\n├── 03  README.md\n│\n├── shared/\n│   ├── 04  events/\n│   │   └── 05  events.go              # DomainEvent interface + all event structs\n│   └── 06  logger/\n│       └── 07  logger.go             # Structured JSON logger (zerolog wrapper)\n│\n├── services/\n│   ├── url-service/\n│   │   ├── 08  go.mod\n│   │   ├── 09  go.sum                 # generated by `go mod tidy`\n│   │   ├── 10  main.go\n│   │   ├── 11  Dockerfile\n│   │   └── handler/\n│   │       └── 12  health.go\n│   │\n│   ├── analytics-service/\n│   │   ├── 13  go.mod\n│   │   ├── 14  go.sum\n│   │   ├── 15  main.go\n│   │   ├── 16  Dockerfile\n│   │   └── handler/\n│   │       └── 17  health.go\n│   │\n│   ├── user-service/\n│   │   ├── 18  go.mod\n│   │   ├── 19  go.sum\n│   │   ├── 20  main.go\n│   │   ├── 21  Dockerfile\n│   │   └── handler/\n│   │       └── 22  health.go\n│   │\n│   └── notification-service/\n│       ├── 23  go.mod\n│       ├── 24  go.sum\n│       ├── 25  main.go\n│       ├── 26  Dockerfile\n│       └── handler/\n│           └── 27  health.go\n│\n└── gateway/\n    ├── 28  go.mod\n    ├── 29  go.sum\n    ├── 30  main.go\n    ├── 31  Dockerfile\n    └── handler/\n        └── 32  health.go\n```\n**Total files to create: 32** (excluding auto-generated `go.sum` files).\n---\n## 3. Complete Data Model\n### 3.1 Domain Event Structs (`shared/events/events.go`)\nAll domain events share a common interface and a set of concrete structs. Every struct is defined here regardless of which service produces or consumes it — this is the single source of truth for event schema.\n```go\npackage events\nimport \"time\"\n// DomainEvent is the interface satisfied by every event struct.\n// EventType returns the routing key used on the RabbitMQ topic exchange.\n// OccurredAt returns the wall-clock time the domain action happened.\ntype DomainEvent interface {\n    GetEventType() string\n    GetOccurredAt() time.Time\n}\n// EventType constants — used as RabbitMQ routing keys.\n// Pattern: <aggregate>.<action> (dot-separated, lower-case).\nconst (\n    EventTypeURLCreated       = \"url.created\"\n    EventTypeURLClicked       = \"url.clicked\"\n    EventTypeURLDeleted       = \"url.deleted\"\n    EventTypeMilestoneReached = \"milestone.reached\"\n)\n// URLCreatedEvent is published by url-service when a short URL is created.\n// CorrelationID is propagated from the HTTP request's X-Correlation-ID header\n// so that async log traces can be stitched together.\ntype URLCreatedEvent struct {\n    EventType     string    `json:\"event_type\"`      // always \"url.created\"\n    OccurredAt    time.Time `json:\"occurred_at\"`     // RFC3339Nano\n    CorrelationID string    `json:\"correlation_id\"`  // UUID v4; propagated from HTTP header\n    ShortCode     string    `json:\"short_code\"`      // 7-char base62 code\n    OriginalURL   string    `json:\"original_url\"`    // full destination URL\n    UserID        string    `json:\"user_id\"`         // UUID string; owner\n    UserEmail     string    `json:\"user_email\"`      // included so consumers need no callback\n    ExpiresAt     *time.Time `json:\"expires_at,omitempty\"` // nil = no expiry\n}\nfunc (e URLCreatedEvent) GetEventType() string    { return e.EventType }\nfunc (e URLCreatedEvent) GetOccurredAt() time.Time { return e.OccurredAt }\n// URLClickedEvent is published by url-service on every redirect (via outbox).\n// IPHash is SHA-256(raw_ip + salt) — never the raw IP address.\ntype URLClickedEvent struct {\n    EventType     string    `json:\"event_type\"`      // always \"url.clicked\"\n    OccurredAt    time.Time `json:\"occurred_at\"`\n    CorrelationID string    `json:\"correlation_id\"`\n    EventID       string    `json:\"event_id\"`        // UUID v4; used for idempotency dedup\n    ShortCode     string    `json:\"short_code\"`\n    UserID        string    `json:\"user_id\"`         // owner of the short URL (not clicker)\n    IPHash        string    `json:\"ip_hash\"`         // SHA-256(ip+salt), hex encoded\n    UserAgent     string    `json:\"user_agent\"`\n    Referer       string    `json:\"referer,omitempty\"`\n}\nfunc (e URLClickedEvent) GetEventType() string    { return e.EventType }\nfunc (e URLClickedEvent) GetOccurredAt() time.Time { return e.OccurredAt }\n// URLDeletedEvent is published by url-service when a URL is soft-deleted.\ntype URLDeletedEvent struct {\n    EventType     string    `json:\"event_type\"`      // always \"url.deleted\"\n    OccurredAt    time.Time `json:\"occurred_at\"`\n    CorrelationID string    `json:\"correlation_id\"`\n    ShortCode     string    `json:\"short_code\"`\n    UserID        string    `json:\"user_id\"`\n    UserEmail     string    `json:\"user_email\"`      // avoid cross-service lookup\n}\nfunc (e URLDeletedEvent) GetEventType() string    { return e.EventType }\nfunc (e URLDeletedEvent) GetOccurredAt() time.Time { return e.OccurredAt }\n// MilestoneReachedEvent is published by analytics-service when a click\n// threshold (10, 100, 1000) is crossed.\ntype MilestoneReachedEvent struct {\n    EventType     string    `json:\"event_type\"`      // always \"milestone.reached\"\n    OccurredAt    time.Time `json:\"occurred_at\"`\n    CorrelationID string    `json:\"correlation_id\"`\n    ShortCode     string    `json:\"short_code\"`\n    UserID        string    `json:\"user_id\"`\n    UserEmail     string    `json:\"user_email\"`\n    Milestone     int       `json:\"milestone\"`       // 10 | 100 | 1000\n    TotalClicks   int64     `json:\"total_clicks\"`    // current count at time of trigger\n}\nfunc (e MilestoneReachedEvent) GetEventType() string    { return e.EventType }\nfunc (e MilestoneReachedEvent) GetOccurredAt() time.Time { return e.OccurredAt }\n```\n**Field rationale:**\n- `UserEmail` is embedded in every event because notification-service must send email without calling user-service. If this field is absent, notification-service would need a synchronous callback — the exact Chatty Service anti-pattern.\n- `CorrelationID` appears on every event so async log traces can be followed through the message broker.\n- `EventID` on `URLClickedEvent` is the deduplication key used by analytics-service (see M4).\n- `*time.Time` (pointer) for `ExpiresAt` allows `null` in JSON without a sentinel value.\n### 3.2 Health Response Schema\n```go\n// HealthResponse is the JSON body returned by GET /health on every service.\ntype HealthResponse struct {\n    Status  string `json:\"status\"`   // always \"ok\" in this milestone\n    Service string `json:\"service\"`  // service name: \"url-service\", \"analytics-service\", etc.\n}\n```\n### 3.3 Logger Fields (Structured JSON)\nEvery log line must contain these fields. Fields absent from the current scope should be empty strings, not omitted.\n```go\n// LogEntry documents the expected JSON shape of every log line.\n// Actual emission is via zerolog — this struct is documentation only.\ntype LogEntry struct {\n    Level         string `json:\"level\"`          // \"debug\"|\"info\"|\"warn\"|\"error\"\n    Time          string `json:\"time\"`            // RFC3339Nano\n    Service       string `json:\"service\"`\n    CorrelationID string `json:\"correlation_id\"`  // empty string if not yet available\n    Method        string `json:\"method\"`          // HTTP method; empty for non-request logs\n    Path          string `json:\"path\"`            // HTTP path; empty for non-request logs\n    Status        int    `json:\"status\"`          // HTTP status; 0 for non-request logs\n    DurationMS    int64  `json:\"duration_ms\"`     // 0 for non-request logs\n    Msg           string `json:\"msg\"`\n}\n```\n\n![Monorepo Directory Tree](./diagrams/tdd-diag-1.svg)\n\n---\n## 4. Interface Contracts\n### 4.1 `shared/logger` Package\n```go\npackage logger\nimport (\n    \"io\"\n    \"github.com/rs/zerolog\"\n)\n// New returns a zerolog.Logger configured for structured JSON output.\n// serviceName is embedded in every log line as the \"service\" field.\n// w is the output writer; pass os.Stdout in production.\n// Call once at service startup; store in the service's dependency struct.\nfunc New(serviceName string, w io.Writer) zerolog.Logger\n```\n**Behavior:**\n- Sets `zerolog.TimeFieldFormat = zerolog.TimeFormatUnixMs` globally.\n- Returns a logger with the `service` field pre-populated.\n- The returned `zerolog.Logger` is value-safe to copy; pass it by value into handlers.\n- No global logger variable is set. All callers receive the instance and pass it forward.\n### 4.2 `handler.HealthHandler`\nEach service has an identical health handler. Specify once; replicate across services.\n```go\n// NewHealthHandler returns an http.HandlerFunc that responds to GET /health.\n// serviceName must be one of: \"url-service\", \"analytics-service\",\n// \"user-service\", \"notification-service\", \"gateway\".\nfunc NewHealthHandler(serviceName string, log zerolog.Logger) http.HandlerFunc\n```\n**Contract:**\n- Method: `GET /health` (method not enforced in this milestone; any method returns 200).\n- Response status: `200 OK`.\n- Response `Content-Type`: `application/json`.\n- Response body: `{\"status\":\"ok\",\"service\":\"<serviceName>\"}`.\n- Latency: must respond in < 10ms (no DB ping, no external call — pure in-memory).\n- The handler must not block. It must not acquire any lock that a slow DB connection could hold.\n**Error cases:** None — this handler has no external dependencies and cannot fail.\n### 4.3 DB Connection Bootstrap\n```go\n// ConnectDB opens a pgxpool connection pool and verifies connectivity.\n// dsn is the full PostgreSQL DSN, e.g.:\n//   \"postgres://user:pass@host:5432/dbname?sslmode=disable\"\n// If the pool cannot ping the DB within 15 seconds (with exponential backoff\n// starting at 500ms, doubling, cap 5s), the function returns a non-nil error.\n// Callers must call os.Exit(1) on error — DB unavailability is fatal.\nfunc ConnectDB(ctx context.Context, dsn string) (*pgxpool.Pool, error)\n```\n**pgxpool configuration applied inside ConnectDB:**\n```go\nconfig.MaxConns = 10\nconfig.MinConns = 2\nconfig.MaxConnLifetime = 30 * time.Minute\nconfig.MaxConnIdleTime = 5 * time.Minute\nconfig.HealthCheckPeriod = 1 * time.Minute\n```\n**Retry logic (applied before returning an error):**\n- Attempt 1: immediate.\n- Attempt 2: wait 500ms.\n- Attempt 3: wait 1s.\n- Attempt 4: wait 2s.\n- Attempt 5: wait 4s (cap).\n- After attempt 5 fails: return `fmt.Errorf(\"connectDB: failed after 5 attempts: %w\", lastErr)`.\n- Each attempt calls `pool.Ping(ctx)`. A successful ping returns the pool immediately.\n**Log on success:** `log.Info().Str(\"dsn_host\", extractHost(dsn)).Msg(\"connected to DB\")`\n*(Strip credentials from DSN before logging — see § 6 Error Handling Matrix.)*\n### 4.4 Redis Connection Bootstrap (url-service only)\n```go\n// ConnectRedis initializes a redis.Client and attempts a PING.\n// addr is \"host:port\", e.g. \"redis:6379\".\n// Returns (client, nil) on success.\n// Returns (nil, err) if PING fails — but the CALLER must treat this as\n// a non-fatal warning and continue startup.\n// The client is nil-safe in the cache layer: all cache helpers must check\n// for a nil client and return a cache-miss sentinel instead of panicking.\nfunc ConnectRedis(ctx context.Context, addr string) (*redis.Client, error)\n```\n**Behavior:**\n- Uses `redis.NewClient` with `DialTimeout: 3s`, `ReadTimeout: 1s`, `WriteTimeout: 1s`.\n- Single PING attempt — no retry loop (Redis is optional; don't block startup).\n- On failure: logs `log.Warn().Err(err).Msg(\"redis unavailable; cache disabled\")`.\n- Returns `nil, err` to signal disabled cache. Callers store the `*redis.Client` as-is; nil means \"cache is off.\"\n### 4.5 RabbitMQ Bootstrap\n```go\n// ConnectRabbitMQ establishes an AMQP connection and channel, then declares\n// the topic exchange and all queues + bindings.\n// url is the AMQP connection URL, e.g. \"amqp://guest:guest@rabbitmq:5672/\"\n// declareFunc is called once the channel is open; it receives the channel\n// and declares whichever exchanges/queues/bindings are appropriate for the\n// calling service (different services declare different queues).\n// Returns (conn, channel, nil) on success.\n// Retries with exponential backoff (same schedule as ConnectDB) for up to\n// 5 attempts. Returns error if all attempts fail — callers log a warning\n// and schedule a retry; RabbitMQ unavailability must NOT crash services.\nfunc ConnectRabbitMQ(\n    ctx context.Context,\n    url string,\n    declareFunc func(ch *amqp091.Channel) error,\n) (*amqp091.Connection, *amqp091.Channel, error)\n```\n**Exchange declaration (performed by url-service's declareFunc):**\n```go\nerr = ch.ExchangeDeclare(\n    \"url-shortener\", // name\n    \"topic\",         // kind\n    true,            // durable\n    false,           // auto-deleted\n    false,           // internal\n    false,           // no-wait\n    nil,             // args\n)\n```\n**Queue + binding declaration (analytics-service's declareFunc):**\n```go\n// Declare queue\nq, err := ch.QueueDeclare(\n    \"analytics.clicks\", // name\n    true,               // durable\n    false,              // delete when unused\n    false,              // exclusive\n    false,              // no-wait\n    nil,\n)\n// Bind to exchange with routing key pattern\nerr = ch.QueueBind(\n    q.Name,\n    \"url.clicked\",   // routing key\n    \"url-shortener\", // exchange\n    false, nil,\n)\n```\n**Queue + binding declaration (notification-service's declareFunc):**\n```go\nq, err := ch.QueueDeclare(\"notifications.events\", true, false, false, false, nil)\n// Bind three routing keys\nfor _, key := range []string{\"url.created\", \"url.deleted\", \"milestone.reached\"} {\n    err = ch.QueueBind(q.Name, key, \"url-shortener\", false, nil)\n}\n```\n**Why consumers declare their own queues:** If only the producer declares the queue, messages published before the consumer starts are dropped. Each consumer declaring its own queue-binding means the queue exists as soon as the consumer starts, regardless of producer order.\n\n![Docker Compose Container Topology](./diagrams/tdd-diag-2.svg)\n\n---\n## 5. Algorithm Specification\n### 5.1 Service Startup Sequence\nEvery service's `main.go` follows this exact procedure. Deviations (e.g., treating DB errors as warnings) are forbidden.\n```\nPROCEDURE StartService(serviceName, config):\n  1. Parse configuration from environment variables.\n     Abort (log.Fatal) if any required variable is missing.\n  2. Initialize logger:\n       log = logger.New(serviceName, os.Stdout)\n  3. Connect to PostgreSQL:\n       pool, err = ConnectDB(ctx, config.DatabaseDSN)\n       IF err != nil:\n         log.Fatal().Err(err).Msg(\"database connection failed\")\n         os.Exit(1)                    // non-zero exit; Docker will not mark healthy\n       log.Info().Msg(\"connected to DB\")\n  4. [url-service only] Connect to Redis:\n       redisClient, err = ConnectRedis(ctx, config.RedisAddr)\n       IF err != nil:\n         log.Warn().Err(err).Msg(\"redis unavailable; cache disabled\")\n         redisClient = nil             // service continues without cache\n  5. Connect to RabbitMQ (all services):\n       conn, ch, err = ConnectRabbitMQ(ctx, config.RabbitMQURL, declareFuncForService)\n       IF err != nil:\n         log.Warn().Err(err).Msg(\"rabbitmq unavailable; will retry in background\")\n         // Do NOT exit. Schedule a background goroutine to retry connection\n         // every 10s. In this milestone, no messages are published/consumed,\n         // so this is a non-fatal degradation.\n  6. Register routes:\n       mux = http.NewServeMux()\n       mux.HandleFunc(\"GET /health\", handler.NewHealthHandler(serviceName, log))\n  7. Start HTTP server:\n       server = &http.Server{\n           Addr:         \":\" + config.Port,\n           Handler:      mux,\n           ReadTimeout:  5 * time.Second,\n           WriteTimeout: 10 * time.Second,\n           IdleTimeout:  120 * time.Second,\n       }\n       log.Info().Str(\"port\", config.Port).Msg(\"service starting\")\n       if err = server.ListenAndServe(); err != nil {\n           log.Fatal().Err(err).Msg(\"server exited\")\n       }\nEND PROCEDURE\n```\n**Step 5 background retry goroutine** (skeleton only — actual publishing is M3+):\n```go\ngo func() {\n    for {\n        time.Sleep(10 * time.Second)\n        conn, ch, err := ConnectRabbitMQ(ctx, config.RabbitMQURL, declareFunc)\n        if err != nil {\n            log.Warn().Err(err).Msg(\"rabbitmq reconnect failed; will retry\")\n            continue\n        }\n        // Store conn and ch in service-level state.\n        // In M1, just log success.\n        log.Info().Msg(\"rabbitmq reconnected\")\n        return\n    }\n}()\n```\n### 5.2 Gateway Startup Health-Check Loop\nThe gateway's `main.go` performs health-checks against all four downstream services during startup. It does NOT block startup on failure — it logs the degraded state and proceeds.\n```\nPROCEDURE GatewayStartupHealthCheck(downstreamURLs []string, log):\n  FOR each serviceURL in downstreamURLs:\n    resp, err = http.Get(serviceURL + \"/health\")\n    IF err != nil OR resp.StatusCode != 200:\n      log.Warn().Str(\"service\", serviceURL).Msg(\"downstream health check failed on startup\")\n    ELSE:\n      log.Info().Str(\"service\", serviceURL).Msg(\"downstream healthy\")\n    close resp.Body\n  // Gateway starts regardless of downstream health.\n  // Circuit breaker (M5) will handle runtime failures.\nEND PROCEDURE\n```\nDownstream URLs are read from environment variables:\n- `URL_SERVICE_URL` → `http://url-service:8081`\n- `ANALYTICS_SERVICE_URL` → `http://analytics-service:8082`\n- `USER_SERVICE_URL` → `http://user-service:8083`\n- `NOTIFICATION_SERVICE_URL` → `http://notification-service:8084`\n\n![RabbitMQ Exchange / Queue / Binding Topology](./diagrams/tdd-diag-3.svg)\n\n---\n## 6. Docker Compose Specification\n### 6.1 Container Inventory\n| Container Name | Image | Internal Port | Host Port | Role |\n|---|---|---|---|---|\n| `url-service` | built from `services/url-service/Dockerfile` | 8081 | 8081 | URL CRUD + redirects |\n| `analytics-service` | built from `services/analytics-service/Dockerfile` | 8082 | 8082 | Click ingestion + stats |\n| `user-service` | built from `services/user-service/Dockerfile` | 8083 | 8083 | Auth |\n| `notification-service` | built from `services/notification-service/Dockerfile` | 8084 | 8084 | Alerts |\n| `gateway` | built from `gateway/Dockerfile` | 8080 | 8080 | Single entry point |\n| `url_db` | `postgres:16-alpine` | 5432 | 5432 | url-service DB |\n| `analytics_db` | `postgres:16-alpine` | 5432 | 5433 | analytics-service DB |\n| `user_db` | `postgres:16-alpine` | 5432 | 5434 | user-service DB |\n| `notification_db` | `postgres:16-alpine` | 5432 | 5435 | notification-service DB |\n| `rabbitmq` | `rabbitmq:3.13-management-alpine` | 5672 / 15672 | 5672 / 15672 | Message broker |\n| `redis` | `redis:7-alpine` | 6379 | 6379 | Shared cache + rate limit store |\n**Total: 11 containers.**\n### 6.2 docker-compose.yml (complete, annotated)\n```yaml\n# docker-compose.yml\n# Run: docker compose up --build\n# Tear down: docker compose down -v\nname: url-shortener\nx-postgres-base: &postgres-base\n  image: postgres:16-alpine\n  restart: unless-stopped\n  environment:\n    POSTGRES_PASSWORD: secret\nx-app-base: &app-base\n  restart: unless-stopped\n  networks:\n    - backend\nnetworks:\n  backend:\n    driver: bridge\nvolumes:\n  url_db_data:\n  analytics_db_data:\n  user_db_data:\n  notification_db_data:\n  rabbitmq_data:\n  redis_data:\nservices:\n  # ── Databases ──────────────────────────────────────────────\n  url_db:\n    <<: *postgres-base\n    container_name: url_db\n    environment:\n      POSTGRES_DB: url_db\n      POSTGRES_USER: url_user\n      POSTGRES_PASSWORD: url_secret\n    ports:\n      - \"5432:5432\"\n    volumes:\n      - url_db_data:/var/lib/postgresql/data\n    networks:\n      - backend\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U url_user -d url_db\"]\n      interval: 5s\n      timeout: 5s\n      retries: 10\n      start_period: 10s\n  analytics_db:\n    <<: *postgres-base\n    container_name: analytics_db\n    environment:\n      POSTGRES_DB: analytics_db\n      POSTGRES_USER: analytics_user\n      POSTGRES_PASSWORD: analytics_secret\n    ports:\n      - \"5433:5432\"\n    volumes:\n      - analytics_db_data:/var/lib/postgresql/data\n    networks:\n      - backend\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U analytics_user -d analytics_db\"]\n      interval: 5s\n      timeout: 5s\n      retries: 10\n      start_period: 10s\n  user_db:\n    <<: *postgres-base\n    container_name: user_db\n    environment:\n      POSTGRES_DB: user_db\n      POSTGRES_USER: user_user\n      POSTGRES_PASSWORD: user_secret\n    ports:\n      - \"5434:5432\"\n    volumes:\n      - user_db_data:/var/lib/postgresql/data\n    networks:\n      - backend\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U user_user -d user_db\"]\n      interval: 5s\n      timeout: 5s\n      retries: 10\n      start_period: 10s\n  notification_db:\n    <<: *postgres-base\n    container_name: notification_db\n    environment:\n      POSTGRES_DB: notification_db\n      POSTGRES_USER: notification_user\n      POSTGRES_PASSWORD: notification_secret\n    ports:\n      - \"5435:5432\"\n    volumes:\n      - notification_db_data:/var/lib/postgresql/data\n    networks:\n      - backend\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U notification_user -d notification_db\"]\n      interval: 5s\n      timeout: 5s\n      retries: 10\n      start_period: 10s\n  # ── Message Broker ──────────────────────────────────────────\n  rabbitmq:\n    image: rabbitmq:3.13-management-alpine\n    container_name: rabbitmq\n    ports:\n      - \"5672:5672\"     # AMQP\n      - \"15672:15672\"   # Management UI (admin/admin)\n    volumes:\n      - rabbitmq_data:/var/lib/rabbitmq\n    environment:\n      RABBITMQ_DEFAULT_USER: admin\n      RABBITMQ_DEFAULT_PASS: admin\n    networks:\n      - backend\n    healthcheck:\n      test: [\"CMD\", \"rabbitmq-diagnostics\", \"ping\"]\n      interval: 10s\n      timeout: 10s\n      retries: 10\n      start_period: 30s\n  # ── Cache ───────────────────────────────────────────────────\n  redis:\n    image: redis:7-alpine\n    container_name: redis\n    ports:\n      - \"6379:6379\"\n    volumes:\n      - redis_data:/data\n    networks:\n      - backend\n    command: redis-server --appendonly yes\n    healthcheck:\n      test: [\"CMD\", \"redis-cli\", \"ping\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n      start_period: 5s\n  # ── Application Services ────────────────────────────────────\n  url-service:\n    <<: *app-base\n    container_name: url-service\n    build:\n      context: ./services/url-service\n      dockerfile: Dockerfile\n    ports:\n      - \"8081:8081\"\n    environment:\n      PORT: \"8081\"\n      DATABASE_DSN: \"postgres://url_user:url_secret@url_db:5432/url_db?sslmode=disable\"\n      REDIS_ADDR: \"redis:6379\"\n      RABBITMQ_URL: \"amqp://admin:admin@rabbitmq:5672/\"\n      SERVICE_NAME: \"url-service\"\n    depends_on:\n      url_db:\n        condition: service_healthy\n      redis:\n        condition: service_healthy\n      rabbitmq:\n        condition: service_healthy\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:8081/health || exit 1\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n      start_period: 15s\n  analytics-service:\n    <<: *app-base\n    container_name: analytics-service\n    build:\n      context: ./services/analytics-service\n      dockerfile: Dockerfile\n    ports:\n      - \"8082:8082\"\n    environment:\n      PORT: \"8082\"\n      DATABASE_DSN: \"postgres://analytics_user:analytics_secret@analytics_db:5432/analytics_db?sslmode=disable\"\n      RABBITMQ_URL: \"amqp://admin:admin@rabbitmq:5672/\"\n      SERVICE_NAME: \"analytics-service\"\n    depends_on:\n      analytics_db:\n        condition: service_healthy\n      rabbitmq:\n        condition: service_healthy\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:8082/health || exit 1\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n      start_period: 15s\n  user-service:\n    <<: *app-base\n    container_name: user-service\n    build:\n      context: ./services/user-service\n      dockerfile: Dockerfile\n    ports:\n      - \"8083:8083\"\n    environment:\n      PORT: \"8083\"\n      DATABASE_DSN: \"postgres://user_user:user_secret@user_db:5432/user_db?sslmode=disable\"\n      RABBITMQ_URL: \"amqp://admin:admin@rabbitmq:5672/\"\n      SERVICE_NAME: \"user-service\"\n    depends_on:\n      user_db:\n        condition: service_healthy\n      rabbitmq:\n        condition: service_healthy\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:8083/health || exit 1\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n      start_period: 15s\n  notification-service:\n    <<: *app-base\n    container_name: notification-service\n    build:\n      context: ./services/notification-service\n      dockerfile: Dockerfile\n    ports:\n      - \"8084:8084\"\n    environment:\n      PORT: \"8084\"\n      DATABASE_DSN: \"postgres://notification_user:notification_secret@notification_db:5432/notification_db?sslmode=disable\"\n      RABBITMQ_URL: \"amqp://admin:admin@rabbitmq:5672/\"\n      SERVICE_NAME: \"notification-service\"\n    depends_on:\n      notification_db:\n        condition: service_healthy\n      rabbitmq:\n        condition: service_healthy\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:8084/health || exit 1\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n      start_period: 15s\n  gateway:\n    <<: *app-base\n    container_name: gateway\n    build:\n      context: ./gateway\n      dockerfile: Dockerfile\n    ports:\n      - \"8080:8080\"\n    environment:\n      PORT: \"8080\"\n      SERVICE_NAME: \"gateway\"\n      URL_SERVICE_URL: \"http://url-service:8081\"\n      ANALYTICS_SERVICE_URL: \"http://analytics-service:8082\"\n      USER_SERVICE_URL: \"http://user-service:8083\"\n      NOTIFICATION_SERVICE_URL: \"http://notification-service:8084\"\n      REDIS_ADDR: \"redis:6379\"\n    depends_on:\n      url-service:\n        condition: service_healthy\n      analytics-service:\n        condition: service_healthy\n      user-service:\n        condition: service_healthy\n      notification-service:\n        condition: service_healthy\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:8080/health || exit 1\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n      start_period: 20s\n```\n\n![Domain Event Struct Memory Layout](./diagrams/tdd-diag-4.svg)\n\n---\n## 7. Go Module Declarations\nEach service has its own `go.mod`. The module path prefix is `github.com/yourhandle/url-shortener`.\n```\n# services/url-service/go.mod\nmodule github.com/yourhandle/url-shortener/url-service\ngo 1.23\nrequire (\n    github.com/jackc/pgx/v5 v5.6.0\n    github.com/redis/go-redis/v9 v9.5.1\n    github.com/rabbitmq/amqp091-go v1.10.0\n    github.com/rs/zerolog v1.33.0\n    github.com/yourhandle/url-shortener/shared v0.0.0\n)\nreplace github.com/yourhandle/url-shortener/shared => ../../shared\n```\nIdentical `require` blocks (adjusting the replace path) for `analytics-service`, `user-service`, `notification-service`, and `gateway`. The `shared` module:\n```\n# shared/go.mod\nmodule github.com/yourhandle/url-shortener/shared\ngo 1.23\nrequire (\n    github.com/rs/zerolog v1.33.0\n)\n```\n**Important:** Use `replace` directives in each service's `go.mod` to reference the local `shared` module. This avoids publishing to a registry during development. After adding the replace directive, run `go mod tidy` in each service directory.\n---\n## 8. Dockerfile Specification\nAll five Dockerfiles are identical in structure. One canonical example:\n```dockerfile\n# services/url-service/Dockerfile\n# Stage 1: Build\nFROM golang:1.23-alpine AS builder\n# Install wget for healthcheck probe (not in the final image — it uses wget from Alpine)\nRUN apk add --no-cache git\nWORKDIR /app\n# Copy go.mod and go.sum first for layer caching\nCOPY go.mod go.sum ./\n# Copy shared module source (referenced via replace directive)\nCOPY ../../shared /shared\nRUN go mod download\nCOPY . .\nRUN CGO_ENABLED=0 GOOS=linux go build -trimpath -o /bin/service ./...\n# Stage 2: Runtime\nFROM alpine:3.20\nRUN apk add --no-cache wget ca-certificates tzdata\nWORKDIR /app\nCOPY --from=builder /bin/service /app/service\nEXPOSE 8081\nENTRYPOINT [\"/app/service\"]\n```\n**Build context note:** Because each service's Dockerfile needs access to the `shared` directory (one level up from the service root), the `docker-compose.yml` sets `context` to the service directory. Use a `.dockerignore` that excludes nothing needed, or structure the Dockerfile COPY to handle the parent reference. An alternative that avoids context issues:\nSet `context: .` (repo root) and `dockerfile: services/url-service/Dockerfile` in `docker-compose.yml`. Then COPY paths are relative to the repo root:\n```dockerfile\n# Alternate approach with context=. (repo root) in docker-compose\nCOPY services/url-service/go.mod services/url-service/go.sum ./\nCOPY shared/ /shared/\nCOPY services/url-service/ .\n```\n**Choose one approach and apply consistently.** The repo-root context approach is simpler for multi-module monorepos and is the recommended path.\n\n![Service Startup Sequence (Happy Path)](./diagrams/tdd-diag-5.svg)\n\n---\n## 9. Environment Variable Reference\n| Variable | Used By | Required | Default | Description |\n|---|---|---|---|---|\n| `PORT` | all | yes | — | HTTP listen port |\n| `SERVICE_NAME` | all | yes | — | Embedded in logs |\n| `DATABASE_DSN` | all app services | yes | — | Full PostgreSQL DSN |\n| `REDIS_ADDR` | url-service, gateway | yes | — | `host:port` |\n| `RABBITMQ_URL` | all app services | yes | — | AMQP URL |\n| `URL_SERVICE_URL` | gateway | yes | — | Downstream base URL |\n| `ANALYTICS_SERVICE_URL` | gateway | yes | — | Downstream base URL |\n| `USER_SERVICE_URL` | gateway | yes | — | Downstream base URL |\n| `NOTIFICATION_SERVICE_URL` | gateway | yes | — | Downstream base URL |\n| `JWT_SECRET` | user-service, all (M2+) | no in M1 | — | Added in M2 |\n**Parsing pattern** (applied in each service's `main.go`):\n```go\nfunc mustGetEnv(key string) string {\n    v := os.Getenv(key)\n    if v == \"\" {\n        fmt.Fprintf(os.Stderr, \"FATAL: required environment variable %q is not set\\n\", key)\n        os.Exit(1)\n    }\n    return v\n}\n```\nCall `mustGetEnv` for every required variable before any I/O. This guarantees a clean failure message rather than a nil-pointer panic deep in a library.\n---\n## 10. Error Handling Matrix\n| Error | Detection Point | Severity | Recovery | User-Visible Effect |\n|---|---|---|---|---|\n| `DB_UNREACHABLE` | `ConnectDB` after 5 retry attempts | **Fatal** | `log.Fatal` + `os.Exit(1)` | Container exits; Docker healthcheck fails; depends_on prevents downstream startup |\n| `REDIS_UNREACHABLE` | `ConnectRedis` single PING attempt | Warning | Log warning, set client to nil, continue | url-service starts without cache; all cache calls no-op |\n| `RABBITMQ_UNREACHABLE` | `ConnectRabbitMQ` after 5 retry attempts | Warning | Log warning, start background retry goroutine | Service starts; exchange/queue not yet declared; no messages published/consumed until reconnect |\n| `REQUIRED_ENV_MISSING` | `mustGetEnv` | Fatal | `os.Exit(1)` | Container exits immediately with clear message |\n| `DSN_CREDENTIALS_IN_LOG` | `ConnectDB` logging | N/A | Strip credentials from DSN before logging | Never log passwords |\n| `HEALTHCHECK_DOWNSTREAM_FAIL` | Gateway startup loop | Warning | Log degraded state, continue | Gateway starts; circuit breaker (M5) handles runtime failures |\n| `PORT_BIND_FAIL` | `server.ListenAndServe` | Fatal | `log.Fatal` | Container exits; Docker restart policy applies |\n**DSN credential stripping:**\n```go\n// extractHost parses a DSN URL and returns only scheme+host+dbname for logging.\n// Input:  \"postgres://url_user:url_secret@url_db:5432/url_db?sslmode=disable\"\n// Output: \"postgres://url_db:5432/url_db\"\nfunc extractHost(dsn string) string {\n    u, err := url.Parse(dsn)\n    if err != nil {\n        return \"<unparseable DSN>\"\n    }\n    u.User = nil // strip username and password\n    u.RawQuery = \"\" // strip query params (may contain passwords)\n    return u.String()\n}\n```\n\n![pgxpool Connection State Machine](./diagrams/tdd-diag-6.svg)\n\n---\n## 11. RabbitMQ Topology Specification\n\n![Shared Domain Event Data Flow](./diagrams/tdd-diag-7.svg)\n\n### Exchange\n| Property | Value |\n|---|---|\n| Name | `url-shortener` |\n| Type | `topic` |\n| Durable | `true` |\n| Auto-delete | `false` |\n| Internal | `false` |\n### Queues\n| Queue | Durable | Exclusive | Auto-delete | Declared by |\n|---|---|---|---|---|\n| `analytics.clicks` | true | false | false | analytics-service |\n| `notifications.events` | true | false | false | notification-service |\n### Bindings\n| Queue | Exchange | Routing Key | Purpose |\n|---|---|---|---|\n| `analytics.clicks` | `url-shortener` | `url.clicked` | Click events → analytics |\n| `notifications.events` | `url-shortener` | `url.created` | New URL notification |\n| `notifications.events` | `url-shortener` | `url.deleted` | Deleted URL notification |\n| `notifications.events` | `url-shortener` | `milestone.reached` | Milestone notification |\n**Idempotent declaration:** AMQP `ExchangeDeclare` and `QueueDeclare` are idempotent if called with the same parameters. If a service restarts and redeclares, the broker accepts it silently. If parameters differ, the broker returns a channel-level error — ensure parameters are identical across all restart scenarios.\n**Startup order guarantee:** `url-service` declares the exchange. `analytics-service` and `notification-service` declare their queues and bindings. Both consumers must succeed in `QueueBind` before the exchange exists — this is handled by the RabbitMQ `depends_on: rabbitmq: condition: service_healthy` in docker-compose. The exchange is declared when url-service starts (which also waits on rabbitmq healthy). However, to be fully safe, each consumer's `declareFunc` should also call `ExchangeDeclare` — AMQP declare is idempotent and this removes the startup ordering dependency between app services.\n---\n## 12. Implementation Sequence with Checkpoints\n### Phase 1 — Monorepo Scaffold + go.mod (0.5–1 hr)\n1. Create the directory tree from § 2.\n2. Write `go.mod` for `shared/` first.\n3. Write `go.mod` for each service with the `replace` directive.\n4. Create empty `main.go` stubs (`package main\\nfunc main() {}`) in each service.\n5. Run `go mod tidy` in `shared/`, then in each service directory.\n**Checkpoint:** `go build ./...` succeeds in every service directory with no errors. No business logic yet — just valid Go modules that compile.\n### Phase 2 — shared/events/ + shared/logger/ (0.5–1 hr)\n1. Write `shared/events/events.go` (§ 3.1 — all four event structs + constants).\n2. Write `shared/logger/logger.go` (§ 4.1).\n3. Run `go test ./...` in `shared/` — no test files yet, but must compile clean.\n4. In each service, add `import _ \"github.com/yourhandle/url-shortener/shared/events\"` temporarily to verify the replace directive works.\n**Checkpoint:** `go build ./...` in every service compiles without error. `shared/events` types are importable.\n### Phase 3 — docker-compose.yml (1–1.5 hr)\n1. Write `docker-compose.yml` from § 6.2.\n2. Write `.env.example` documenting all variables from § 9.\n3. Write `Dockerfile` for each service (§ 8) — they are all identical except port numbers.\n4. Run `docker compose config` — must produce no YAML errors.\n5. Run `docker compose up rabbitmq redis url_db analytics_db user_db notification_db` (infra only).\n**Checkpoint:** All six infrastructure containers reach `healthy` state within 60 seconds. Verify with `docker compose ps` — every status column reads `healthy`. RabbitMQ management UI accessible at `http://localhost:15672` (admin/admin).\n### Phase 4 — DB + Redis + RabbitMQ Bootstrapping (1–1.5 hr)\n1. Write `ConnectDB`, `ConnectRedis`, `ConnectRabbitMQ` in each service's `main.go` (or a shared `infra/` sub-package within each service).\n2. Write `mustGetEnv` and parse all required environment variables.\n3. Implement startup procedure from § 5.1 in each `main.go`.\n4. Implement service-specific `declareFunc` for each service (§ 4.5).\n5. Run `docker compose up --build` (all services).\n**Checkpoint:** `docker compose logs url-service | grep \"connected to DB\"` prints the success message. `docker compose logs url-service | grep \"connected to Redis cache\"` prints success. RabbitMQ management UI at `http://localhost:15672` → Exchanges tab shows `url-shortener` (topic, durable). Queues tab shows `analytics.clicks` and `notifications.events` with correct bindings.\n### Phase 5 — /health Handlers + Gateway Startup Check (0.5–1 hr)\n1. Write `handler.NewHealthHandler` in each service's `handler/health.go`.\n2. Register the handler in each service's `main.go`.\n3. Write gateway's startup health-check loop (§ 5.2).\n4. Write README with setup commands.\n**Checkpoint:**\n```bash\ncurl -s http://localhost:8081/health | python3 -m json.tool\n# Expected: {\"status\": \"ok\", \"service\": \"url-service\"}\ncurl -s http://localhost:8082/health\n# Expected: {\"status\":\"ok\",\"service\":\"analytics-service\"}\ncurl -s http://localhost:8083/health\n# Expected: {\"status\":\"ok\",\"service\":\"user-service\"}\ncurl -s http://localhost:8084/health\n# Expected: {\"status\":\"ok\",\"service\":\"notification-service\"}\ncurl -s http://localhost:8080/health\n# Expected: {\"status\":\"ok\",\"service\":\"gateway\"}\ndocker compose ps\n# All 11 containers: Status = \"healthy\"\n```\n---\n## 13. Test Specification\n### 13.1 shared/events Package Tests\n**File:** `shared/events/events_test.go`\n```go\n// Test: JSON round-trip for each event struct\n// Happy path: marshal URLClickedEvent → unmarshal → fields match\n// Edge case: ExpiresAt = nil in URLCreatedEvent → JSON contains no \"expires_at\" key\n// Edge case: OccurredAt preserves nanosecond precision through JSON round-trip\n// Verify: GetEventType() returns the correct constant for each struct\n// Verify: EventType constants match expected routing key strings exactly\nfunc TestEventJSONRoundTrip(t *testing.T)\nfunc TestNilExpiresAtOmittedFromJSON(t *testing.T)\nfunc TestGetEventTypeReturnsCorrectConstant(t *testing.T)\n```\n### 13.2 ConnectDB Tests (integration, requires Docker)\n```go\n// Happy path: valid DSN → pool returned, pool.Ping() succeeds\n// Failure: invalid host → all 5 retries exhausted → error returned\n// Verify: pool has MaxConns=10, MinConns=2 (inspect config after Connect)\n// Verify: error message contains \"failed after 5 attempts\"\nfunc TestConnectDB_HappyPath(t *testing.T)          // requires url_db running\nfunc TestConnectDB_UnreachableHost(t *testing.T)     // use port 9999 (guaranteed unreachable)\nfunc TestConnectDB_PoolConfig(t *testing.T)\n```\n### 13.3 ConnectRedis Tests\n```go\n// Happy path: valid addr → client returned, err == nil\n// Failure: unreachable addr → err != nil, returned client == nil\n// Verify: function does NOT panic on PING failure\nfunc TestConnectRedis_HappyPath(t *testing.T)        // requires redis running\nfunc TestConnectRedis_Unreachable_ReturnsNilClient(t *testing.T)\n```\n### 13.4 Health Handler Tests\n```go\n// Happy path: GET /health → 200, body = {\"status\":\"ok\",\"service\":\"url-service\"}\n// Content-Type header = \"application/json\"\n// Response time < 10ms (use testing.B for benchmark)\n// Any HTTP method → 200 (handler is method-agnostic in M1)\nfunc TestHealthHandler_Returns200(t *testing.T)\nfunc TestHealthHandler_JSONBody(t *testing.T)\nfunc TestHealthHandler_ContentType(t *testing.T)\nfunc BenchmarkHealthHandler(b *testing.B)\n```\n### 13.5 extractHost Tests\n```go\n// Input: \"postgres://user:pass@url_db:5432/url_db?sslmode=disable\"\n// Expected: \"postgres://url_db:5432/url_db\"\n// Input: unparseable string → \"<unparseable DSN>\"\n// Verify: no user info in output\n// Verify: no query params in output\nfunc TestExtractHost_StripsCreds(t *testing.T)\nfunc TestExtractHost_UnparseableDSN(t *testing.T)\n```\n### 13.6 End-to-End Smoke Test (shell script)\n```bash\n#!/bin/bash\n# test/smoke_m1.sh — run after `docker compose up --build`\nset -euo pipefail\nBASE_URLS=(\"http://localhost:8081\" \"http://localhost:8082\" \"http://localhost:8083\" \"http://localhost:8084\" \"http://localhost:8080\")\nNAMES=(\"url-service\" \"analytics-service\" \"user-service\" \"notification-service\" \"gateway\")\nfor i in \"${!BASE_URLS[@]}\"; do\n    RESPONSE=$(curl -sf \"${BASE_URLS[$i]}/health\")\n    EXPECTED=\"{\\\"status\\\":\\\"ok\\\",\\\"service\\\":\\\"${NAMES[$i]}\\\"}\"\n    if [ \"$RESPONSE\" != \"$EXPECTED\" ]; then\n        echo \"FAIL: ${NAMES[$i]} returned: $RESPONSE\"\n        exit 1\n    fi\n    echo \"PASS: ${NAMES[$i]}\"\ndone\necho \"All health checks passed.\"\n```\n---\n## 14. Performance Targets\n| Operation | Target | Measurement Method |\n|---|---|---|\n| `GET /health` response time | < 10ms p99 | `wrk -t2 -c10 -d10s http://localhost:8081/health` → `Latency 99%` |\n| `docker compose up` to all-healthy | < 60s | `time docker compose up --wait` on commodity hardware (4 core, 8GB RAM) |\n| `ConnectDB` retry exhaustion time | < 25s (5 attempts × up to 5s each) | integration test with fake DSN + `testing.Timer` |\n| `go build ./...` in each service | < 30s | cold build on CI; warm build < 5s |\n| Container image size (each service) | < 20MB | `docker image ls` after build (Alpine multi-stage) |\n---\n## 15. Anti-Pattern Guard Rail Checklist\nBefore completing this milestone, verify none of the following are present:\n- [ ] **No shared PostgreSQL container.** Run `docker compose config | grep POSTGRES_DB | sort | uniq -c` — expect 4 unique DB names across 4 separate containers.\n- [ ] **No `localhost` in any connection string inside Docker.** All hostnames in environment variables use Docker service names (`url_db`, `redis`, `rabbitmq`, etc.).\n- [ ] **Redis is not used as a primary store.** No `SET` or `HSET` to Redis in `main.go` — only the connection bootstrap PING.\n- [ ] **RabbitMQ queue declarations are in consumers, not only in url-service.** `analytics-service/main.go` declares `analytics.clicks`; `notification-service/main.go` declares `notifications.events`.\n- [ ] **`depends_on` uses `condition: service_healthy` for all DB and broker dependencies.** Plain `depends_on: [url_db]` without a condition does not wait for readiness.\n- [ ] **No hardcoded passwords in Go source.** All credentials come from `mustGetEnv`.\n---\n<!-- END_TDD_MOD -->\n\n\n<!-- TDD_MOD_ID: url-shortener-m2 -->\n# Technical Design Specification\n## Module: User Service — Registration, Login, JWT Issuance\n**Module ID:** `url-shortener-m2`\n---\n## 1. Module Charter\nThe User Service is the single authority for identity within the URL shortener system. It accepts user registrations, validates credentials, stores password hashes, and issues signed JWT access tokens. It exposes exactly three HTTP endpoints: `POST /register`, `POST /login`, and `GET /me`. It owns one PostgreSQL table (`users`) in its private database and communicates with no other service — ever.\nThis module does **not** implement password reset, OAuth, refresh tokens, email verification, session storage, role-based access control, or any form of inter-service communication. It does not call the URL Service, Analytics Service, or Notification Service. The gateway and all other services verify tokens locally using the shared `JWT_SECRET` — they never proxy a verification request to the User Service.\n**Upstream dependencies:** M1 foundation (Docker Compose stack, `shared/logger` package, PostgreSQL `user_db` container). The `user_db` database must be reachable before this service starts.\n**Downstream dependencies:** The `shared/middleware` JWT verification package produced in Phase 4 of this module is imported by url-service (M3), analytics-service (M4), notification-service (M5), and the gateway (M5). The `JWT_SECRET` environment variable must be identical across all services that verify tokens.\n**Invariants that must always hold after this milestone:**\n- No plaintext password ever persists to disk or appears in any log line.\n- A failed login returns exactly the same response body and HTTP status regardless of whether the email exists or the password is wrong.\n- Token verification never makes a network call — it is pure HMAC-SHA256 computation against the in-process secret.\n- The `users.email` column has a `UNIQUE NOT NULL` constraint enforced at the database level, not only at the application level.\n- `GET /me` response time is bounded by HMAC computation only, not by database latency.\n---\n## 2. File Structure\nCreate files in the numbered order below. All paths are relative to the monorepo root.\n```\nurl-shortener/\n│\n├── services/user-service/\n│   ├── 01  migrations/\n│   │   └── 02  001_create_users.sql\n│   ├── 03  repository/\n│   │   ├── 04  user_repository.go       # UserRepository interface + pgx implementation\n│   │   └── 05  user_repository_test.go\n│   ├── 06  auth/\n│   │   ├── 07  password.go              # PasswordHasher: bcrypt Hash + Compare\n│   │   ├── 08  password_test.go\n│   │   ├── 09  jwt.go                   # JWTSigner + JWTVerifier implementations\n│   │   └── 10  jwt_test.go\n│   ├── 11  handler/\n│   │   ├── 12  register.go              # POST /register\n│   │   ├── 13  login.go                 # POST /login\n│   │   ├── 14  me.go                    # GET /me\n│   │   ├── 15  health.go               # GET /health (from M1, updated)\n│   │   └── 16  handler_test.go          # integration tests (register→login→/me)\n│   ├── 17  service/\n│   │   └── 18  user_service.go          # UserService: orchestrates repo + auth\n│   └── 19  main.go                      # wiring: env, DB, routes, server\n│\n└── shared/\n    └── 20  middleware/\n        ├── 21  jwt_middleware.go         # http.Handler wrapper: Bearer extraction + verify\n        └── 22  jwt_middleware_test.go\n```\n**Total new files: 22** (`go.sum` files are auto-generated and excluded from the count).\n---\n## 3. Complete Data Model\n### 3.1 PostgreSQL Schema (`migrations/001_create_users.sql`)\n```sql\n-- migrations/001_create_users.sql\nBEGIN;\nCREATE TABLE IF NOT EXISTS users (\n    id           UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n    email        TEXT        NOT NULL UNIQUE,\n    password_hash TEXT        NOT NULL,\n    created_at   TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n-- Index for login: find user by email quickly.\n-- UNIQUE already implies a B-tree index; this is explicit documentation.\n-- The UNIQUE constraint on email is enforced by the database, not application code.\nCREATE UNIQUE INDEX IF NOT EXISTS idx_users_email ON users(email);\nCOMMIT;\n```\n**Field rationale:**\n- `id UUID`: UUIDs are non-enumerable. An integer PK would leak user count via `user_id=42`. `gen_random_uuid()` requires `pgcrypto` on PostgreSQL < 14; on PostgreSQL 16 (as declared in docker-compose) it is a built-in function.\n- `email TEXT NOT NULL UNIQUE`: Application-level uniqueness checks are racey; the constraint is the true guard. `TEXT` is used over `VARCHAR(255)` because PostgreSQL stores both identically; `TEXT` removes an arbitrary limit.\n- `password_hash TEXT NOT NULL`: bcrypt output is always 60 characters of ASCII. `TEXT` is correct; never use `BYTEA` for bcrypt strings.\n- `created_at TIMESTAMPTZ NOT NULL DEFAULT now()`: `TIMESTAMPTZ` stores UTC internally and is unambiguous across timezone changes. Application never writes this field.\n### 3.2 Go Structs\n```go\n// repository/user_repository.go\npackage repository\nimport (\n    \"context\"\n    \"time\"\n)\n// User is the domain entity stored in the users table.\n// It is the single source of truth for user identity within this service.\n// Password hashes are stored here; plaintext passwords never reach this struct.\ntype User struct {\n    ID           string    // UUID v4, primary key\n    Email        string    // unique, lowercase-normalized before storage\n    PasswordHash string    // bcrypt output, cost=12; never logged\n    CreatedAt    time.Time // set by DB DEFAULT; application does not write this\n}\n// UserRepository defines the persistence contract for the User entity.\n// Implementations must be safe for concurrent use.\ntype UserRepository interface {\n    // Create inserts a new user. Returns ErrDuplicateEmail if the email\n    // already exists. All other DB errors are returned as-is for the\n    // service layer to wrap.\n    Create(ctx context.Context, u User) error\n    // FindByEmail retrieves a user by email address.\n    // Returns ErrUserNotFound if no row matches.\n    FindByEmail(ctx context.Context, email string) (User, error)\n}\n// Sentinel errors returned by UserRepository.\n// Service layer maps these to HTTP status codes.\nvar (\n    ErrDuplicateEmail = errors.New(\"email already registered\")\n    ErrUserNotFound   = errors.New(\"user not found\")\n)\n```\n```go\n// auth/jwt.go\npackage auth\nimport \"time\"\n// Claims is the set of fields embedded in a JWT payload.\n// Only these fields are read on verification; any extra fields are ignored.\ntype Claims struct {\n    Sub   string    // user_id UUID string — \"subject\" per RFC 7519\n    Email string    // user email; embedded to avoid /me needing a DB call\n    Iat   time.Time // issued at\n    Exp   time.Time // expiry; 24h after Iat\n    Iss   string    // always \"url-shortener\"\n}\n// jwtPayload is the raw JSON-mapped representation used for marshaling.\n// Claims is the clean domain struct; jwtPayload handles the Unix timestamp encoding.\ntype jwtPayload struct {\n    Sub   string `json:\"sub\"`\n    Email string `json:\"email\"`\n    Iat   int64  `json:\"iat\"` // Unix seconds\n    Exp   int64  `json:\"exp\"` // Unix seconds\n    Iss   string `json:\"iss\"`\n}\n```\n```go\n// handler/register.go — request/response DTOs\npackage handler\n// RegisterRequest is the JSON body accepted by POST /register.\ntype RegisterRequest struct {\n    Email    string `json:\"email\"`\n    Password string `json:\"password\"`\n}\n// RegisterResponse is the JSON body returned on 201 Created.\n// Password hash is never included. User ID is always a UUID string.\ntype RegisterResponse struct {\n    UserID string `json:\"user_id\"`\n    Email  string `json:\"email\"`\n}\n// LoginRequest is the JSON body accepted by POST /login.\ntype LoginRequest struct {\n    Email    string `json:\"email\"`\n    Password string `json:\"password\"`\n}\n// LoginResponse is the JSON body returned on 200 OK after successful login.\ntype LoginResponse struct {\n    Token     string `json:\"token\"`\n    ExpiresAt string `json:\"expires_at\"` // RFC3339 format\n}\n// MeResponse is the JSON body returned by GET /me.\ntype MeResponse struct {\n    UserID string `json:\"user_id\"`\n    Email  string `json:\"email\"`\n}\n// ErrorResponse is the JSON body for all error responses.\ntype ErrorResponse struct {\n    Error string `json:\"error\"`\n}\n```\n### 3.3 JWT Payload Wire Format\nThe JWT is a standard three-part HS256 token: `base64url(header).base64url(payload).base64url(signature)`.\n**Header (fixed):**\n```json\n{\"alg\":\"HS256\",\"typ\":\"JWT\"}\n```\n**Payload (per token):**\n```json\n{\n  \"sub\": \"550e8400-e29b-41d4-a716-446655440000\",\n  \"email\": \"alice@example.com\",\n  \"iat\": 1740873600,\n  \"exp\": 1740960000,\n  \"iss\": \"url-shortener\"\n}\n```\n**Field constraints:**\n| Field | Type | Constraint |\n|---|---|---|\n| `sub` | string | UUID v4 format; must match `users.id` |\n| `email` | string | Must match `users.email` at time of issuance |\n| `iat` | number | Unix seconds; UTC |\n| `exp` | number | `iat + 86400` (24 hours exactly) |\n| `iss` | string | Literal `\"url-shortener\"` — reject tokens with any other issuer |\n**Implementation note:** Do NOT use a JWT library that pulls in JOSE complexity (e.g., `golang-jwt/jwt` is acceptable; `lestrrat-go/jwx` is overkill). The recommended library is `golang-jwt/jwt/v5` which handles HMAC signing, payload marshaling, and expiry checking natively.\n\n![User Service Module Architecture](./diagrams/tdd-diag-8.svg)\n\n---\n## 4. Interface Contracts\n### 4.1 `UserRepository` — `pgxUserRepository` Implementation\n```go\n// NewPgxUserRepository constructs a UserRepository backed by a pgxpool.Pool.\n// pool must be non-nil and already connected.\nfunc NewPgxUserRepository(pool *pgxpool.Pool) UserRepository\n```\n**`Create(ctx context.Context, u User) error`**\n- Executes: `INSERT INTO users (id, email, password_hash) VALUES ($1, $2, $3)`\n- `u.ID` must be a pre-generated UUID v4 string (caller generates, not DB gen_random_uuid — we want the ID before the INSERT for event publishing in later milestones).\n- `u.CreatedAt` is ignored; the DB sets it via DEFAULT.\n- On `pgconn.PgError` with `Code == \"23505\"` (unique violation): returns `ErrDuplicateEmail`.\n- On any other error: returns `fmt.Errorf(\"userRepository.Create: %w\", err)`.\n- **Never** returns nil without the row existing in the database.\n**`FindByEmail(ctx context.Context, email string) (User, error)`**\n- Executes: `SELECT id, email, password_hash, created_at FROM users WHERE email = $1`\n- On `pgx.ErrNoRows`: returns `User{}, ErrUserNotFound`.\n- On any other error: returns `User{}, fmt.Errorf(\"userRepository.FindByEmail: %w\", err)`.\n- Returns the fully populated `User` struct on success.\n### 4.2 `PasswordHasher`\n```go\n// auth/password.go\n// PasswordHasher wraps bcrypt operations.\n// All implementations must be stateless and safe for concurrent use.\ntype PasswordHasher interface {\n    // Hash returns a bcrypt hash of plaintext at cost=12.\n    // plaintext must be non-empty; returns error if bcrypt fails.\n    // The returned string is always 60 ASCII characters.\n    Hash(plaintext string) (string, error)\n    // Compare returns nil if hash matches plaintext.\n    // Returns ErrPasswordMismatch if they do not match.\n    // Returns a wrapped error for any other bcrypt failure.\n    // This function takes ~100ms at cost=12 — do not call in goroutines\n    // holding locks.\n    Compare(hash, plaintext string) error\n}\n// bcryptHasher is the production implementation.\ntype bcryptHasher struct{}\n// NewPasswordHasher returns the production bcrypt implementation.\nfunc NewPasswordHasher() PasswordHasher { return bcryptHasher{} }\n// ErrPasswordMismatch is returned by Compare when credentials do not match.\n// It is intentionally distinct from bcrypt internal errors.\nvar ErrPasswordMismatch = errors.New(\"password mismatch\")\n```\n**`Hash` implementation:**\n```go\nfunc (b bcryptHasher) Hash(plaintext string) (string, error) {\n    hash, err := bcrypt.GenerateFromPassword([]byte(plaintext), 12)\n    if err != nil {\n        return \"\", fmt.Errorf(\"passwordHasher.Hash: %w\", err)\n    }\n    return string(hash), nil\n}\n```\n**`Compare` implementation:**\n```go\nfunc (b bcryptHasher) Compare(hash, plaintext string) error {\n    err := bcrypt.CompareHashAndPassword([]byte(hash), []byte(plaintext))\n    if errors.Is(err, bcrypt.ErrMismatchedHashAndPassword) {\n        return ErrPasswordMismatch\n    }\n    if err != nil {\n        return fmt.Errorf(\"passwordHasher.Compare: %w\", err)\n    }\n    return nil\n}\n```\n### 4.3 `JWTSigner` and `JWTVerifier`\n```go\n// auth/jwt.go\n// JWTSigner issues signed tokens.\ntype JWTSigner interface {\n    // Sign creates an HS256 JWT from the given Claims.\n    // The Iat and Exp fields on the input Claims are set by Sign (caller need not set them).\n    // Returns the compact serialized token string on success.\n    Sign(claims Claims) (tokenString string, err error)\n}\n// JWTVerifier validates tokens.\ntype JWTVerifier interface {\n    // Verify parses and validates a compact JWT string.\n    // Returns parsed Claims on success.\n    // Returns ErrTokenExpired if exp is in the past.\n    // Returns ErrTokenInvalid for any other validation failure\n    //   (bad signature, wrong issuer, malformed).\n    Verify(tokenString string) (Claims, error)\n}\n// Sentinel errors for token verification.\nvar (\n    ErrTokenExpired = errors.New(\"token expired\")\n    ErrTokenInvalid = errors.New(\"token invalid\")\n)\n// NewJWTSigner returns a JWTSigner using HS256 with the given secret.\n// secret must be the raw bytes of JWT_SECRET from the environment.\n// Panics if secret is empty — misconfigured secrets must fail at startup, not runtime.\nfunc NewJWTSigner(secret []byte) JWTSigner\n// NewJWTVerifier returns a JWTVerifier using HS256 with the given secret.\n// secret must be the raw bytes of JWT_SECRET from the environment.\n// Panics if secret is empty.\nfunc NewJWTVerifier(secret []byte) JWTVerifier\n```\n**`Sign` implementation detail:**\n```go\nfunc (s *jwtSigner) Sign(claims Claims) (string, error) {\n    now := time.Now().UTC()\n    payload := jwt.MapClaims{\n        \"sub\":   claims.Sub,\n        \"email\": claims.Email,\n        \"iat\":   now.Unix(),\n        \"exp\":   now.Add(24 * time.Hour).Unix(),\n        \"iss\":   \"url-shortener\",\n    }\n    token := jwt.NewWithClaims(jwt.SigningMethodHS256, payload)\n    signed, err := token.SignedString(s.secret)\n    if err != nil {\n        return \"\", fmt.Errorf(\"jwtSigner.Sign: %w\", err)\n    }\n    return signed, nil\n}\n```\n**`Verify` implementation detail:**\n```go\nfunc (v *jwtVerifier) Verify(tokenString string) (Claims, error) {\n    token, err := jwt.Parse(tokenString, func(t *jwt.Token) (interface{}, error) {\n        if _, ok := t.Method.(*jwt.SigningMethodHMAC); !ok {\n            return nil, fmt.Errorf(\"unexpected signing method: %v\", t.Header[\"alg\"])\n        }\n        return v.secret, nil\n    })\n    if err != nil {\n        // Distinguish expiry from other errors.\n        var ve *jwt.ValidationError\n        if errors.As(err, &ve) && ve.Errors&jwt.ValidationErrorExpired != 0 {\n            return Claims{}, ErrTokenExpired\n        }\n        return Claims{}, ErrTokenInvalid\n    }\n    mc, ok := token.Claims.(jwt.MapClaims)\n    if !ok || !token.Valid {\n        return Claims{}, ErrTokenInvalid\n    }\n    // Validate issuer explicitly — reject tokens issued by other systems.\n    if iss, _ := mc[\"iss\"].(string); iss != \"url-shortener\" {\n        return Claims{}, ErrTokenInvalid\n    }\n    return Claims{\n        Sub:   mc[\"sub\"].(string),\n        Email: mc[\"email\"].(string),\n        Exp:   time.Unix(int64(mc[\"exp\"].(float64)), 0).UTC(),\n        Iat:   time.Unix(int64(mc[\"iat\"].(float64)), 0).UTC(),\n        Iss:   \"url-shortener\",\n    }, nil\n}\n```\n**Note on `golang-jwt/jwt/v5`:** In v5 the `ValidationError` API changed. Use `errors.Is(err, jwt.ErrTokenExpired)` instead of the bitmask approach shown above (which is v4). The implementation must match the version declared in `go.mod`. The spec shows the v4 pattern; adapt as needed after pinning the version.\n### 4.4 `UserService`\n```go\n// service/user_service.go\n// UserService orchestrates the repository, password hasher, and JWT signer.\n// It owns all business logic for the auth domain.\n// It must not reference http.Request or http.ResponseWriter — that belongs to handlers.\ntype UserService struct {\n    repo    repository.UserRepository\n    hasher  auth.PasswordHasher\n    signer  auth.JWTSigner\n    log     zerolog.Logger\n}\nfunc NewUserService(\n    repo repository.UserRepository,\n    hasher auth.PasswordHasher,\n    signer auth.JWTSigner,\n    log zerolog.Logger,\n) *UserService\n// Register creates a new user. Returns the created User (with ID and CreatedAt populated).\n// Error types:\n//   - repository.ErrDuplicateEmail → caller maps to 409\n//   - validation error (invalid email, short password) → caller maps to 400\n//   - any other error → caller maps to 500\nfunc (s *UserService) Register(ctx context.Context, email, password string) (repository.User, error)\n// Login verifies credentials and returns a signed JWT string and expiry time.\n// Error types:\n//   - auth.ErrPasswordMismatch or repository.ErrUserNotFound → caller maps to 401\n//     (same error, no distinction — prevents email enumeration)\n//   - any other error → caller maps to 500\nfunc (s *UserService) Login(ctx context.Context, email, password string) (token string, expiresAt time.Time, err error)\n```\n**`Register` logic:**\n```\nPROCEDURE Register(ctx, email, password):\n  1. Normalize email: strings.ToLower(strings.TrimSpace(email))\n  2. Validate email: use net/mail.ParseAddress(email) — returns error on invalid format\n  3. Validate password length: len(password) < 8 → return ErrValidation(\"password must be at least 8 characters\")\n  4. Hash password: hash, err = hasher.Hash(password)\n     IF err != nil → return wrapped error (→ 500)\n  5. Generate user ID: id = uuid.New().String() — use google/uuid package\n  6. Construct User{ID: id, Email: email, PasswordHash: hash}\n  7. repo.Create(ctx, user)\n     IF ErrDuplicateEmail → return as-is (→ 409)\n     IF other error → return wrapped (→ 500)\n  8. Return the constructed User (CreatedAt will be zero; that is acceptable — caller only needs ID and email)\nEND PROCEDURE\n```\n**`Login` logic:**\n```\nPROCEDURE Login(ctx, email, password):\n  1. Normalize email: strings.ToLower(strings.TrimSpace(email))\n  2. user, err = repo.FindByEmail(ctx, email)\n     IF ErrUserNotFound → return \"\", time.Time{}, ErrAuthFailed\n     IF other error → return wrapped (→ 500)\n  3. err = hasher.Compare(user.PasswordHash, password)\n     IF ErrPasswordMismatch → return \"\", time.Time{}, ErrAuthFailed\n     IF other error → return wrapped (→ 500)\n  4. claims = auth.Claims{Sub: user.ID, Email: user.Email}\n  5. tokenStr, err = signer.Sign(claims)\n     IF err → return wrapped (→ 500)\n  6. expiresAt = time.Now().UTC().Add(24 * time.Hour)\n  7. Return tokenStr, expiresAt, nil\nEND PROCEDURE\n// ErrAuthFailed is the single sentinel for both \"email not found\" and \"wrong password\".\n// It must never distinguish between the two cases.\nvar ErrAuthFailed = errors.New(\"invalid credentials\")\n```\n**Why one sentinel for both failures:** Returning different errors for \"email not found\" vs \"wrong password\" would allow an attacker to enumerate registered emails by observing the response. `ErrAuthFailed` collapses both into an identical 401 response.\n\n![users Table Memory / Schema Layout](./diagrams/tdd-diag-9.svg)\n\n### 4.5 `shared/middleware` — JWT Middleware\n```go\n// shared/middleware/jwt_middleware.go\npackage middleware\n// contextKey is an unexported type for context keys to avoid collisions.\ntype contextKey string\nconst ClaimsContextKey contextKey = \"jwt_claims\"\n// RequireAuth returns an http.Handler that:\n//  1. Extracts the Bearer token from the Authorization header.\n//  2. Verifies the token using verifier.\n//  3. Stores the parsed Claims in the request context under ClaimsContextKey.\n//  4. Calls next if verification succeeds.\n//  5. Returns 401 with {\"error\":\"unauthorized\"} if token is missing, malformed, expired, or invalid.\n//\n// This middleware is designed to be imported by any service that needs to\n// validate JWTs issued by user-service. The verifier must be constructed\n// with the same JWT_SECRET used by user-service.\nfunc RequireAuth(verifier auth.JWTVerifier, log zerolog.Logger) func(http.Handler) http.Handler\n// ClaimsFromContext retrieves the verified Claims from a request context.\n// Returns zero-value Claims and false if not present.\n// Handlers call this after RequireAuth has run.\nfunc ClaimsFromContext(ctx context.Context) (auth.Claims, bool)\n```\n**`RequireAuth` implementation:**\n```go\nfunc RequireAuth(verifier auth.JWTVerifier, log zerolog.Logger) func(http.Handler) http.Handler {\n    return func(next http.Handler) http.Handler {\n        return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n            authHeader := r.Header.Get(\"Authorization\")\n            if authHeader == \"\" || !strings.HasPrefix(authHeader, \"Bearer \") {\n                writeJSON(w, http.StatusUnauthorized, ErrorResponse{Error: \"unauthorized\"})\n                return\n            }\n            tokenStr := strings.TrimPrefix(authHeader, \"Bearer \")\n            claims, err := verifier.Verify(tokenStr)\n            if err != nil {\n                // Do NOT distinguish between expired and invalid in the response.\n                // Log the specific reason for debugging; return generic 401 to client.\n                log.Warn().Err(err).Str(\"path\", r.URL.Path).Msg(\"jwt verification failed\")\n                writeJSON(w, http.StatusUnauthorized, ErrorResponse{Error: \"unauthorized\"})\n                return\n            }\n            ctx := context.WithValue(r.Context(), ClaimsContextKey, claims)\n            next.ServeHTTP(w, r.WithContext(ctx))\n        })\n    }\n}\n```\n**Edge cases:**\n- `Authorization: Bearer ` (trailing space, empty token) → `Verify` will fail → 401.\n- `Authorization: bearer TOKEN` (lowercase) → `HasPrefix(\"Bearer \")` fails → 401. The spec requires exact case.\n- Multiple `Authorization` headers → `r.Header.Get` returns only the first value per Go's `net/http` semantics → safe.\n---\n## 5. Algorithm Specification\n### 5.1 Input Validation\n**Email validation:**\n```\nPROCEDURE ValidateEmail(email string) error:\n  trimmed = strings.TrimSpace(email)\n  IF len(trimmed) == 0 → return validation error \"email is required\"\n  _, err = mail.ParseAddress(trimmed)\n  IF err != nil → return validation error \"email format is invalid\"\n  return nil\n// Note: mail.ParseAddress accepts \"Name <email>\" format.\n// To reject display names, check that the returned address equals the trimmed input.\n// Implementation: addr, err := mail.ParseAddress(trimmed); if addr.Address != trimmed → error\n```\n**Password validation:**\n```\nPROCEDURE ValidatePassword(password string) error:\n  IF len(password) < 8 → return validation error \"password must be at least 8 characters\"\n  // No other complexity rules per spec. No maximum length check is needed because\n  // bcrypt truncates input at 72 bytes internally — document this behavior but\n  // do not reject longer passwords (bcrypt handles it silently).\n  return nil\n```\n**Why `net/mail.ParseAddress` and not regex:** RFC 5322 email syntax is not regular. The standard library's parser correctly handles quoted local parts, international domains (after IDNA encoding), and other edge cases that naive regexes reject or wrongly accept.\n### 5.2 POST /register Handler Flow\n```\nPROCEDURE HandleRegister(w http.ResponseWriter, r *http.Request):\n  1. Decode JSON body into RegisterRequest.\n     IF body is empty or malformed JSON → 400 {\"error\":\"invalid request body\"}\n     Limit body size: http.MaxBytesReader(w, r.Body, 1024) to prevent oversized payloads.\n  2. Validate email and password (§ 5.1).\n     IF invalid → 400 {\"error\":\"<specific validation message>\"}\n  3. Call userService.Register(r.Context(), req.Email, req.Password).\n     IF ErrDuplicateEmail → 409 {\"error\":\"email already registered\"}\n     IF ErrValidation → 400 {\"error\":\"<message>\"}\n     IF other error → log.Error, return 500 {\"error\":\"internal server error\"}\n  4. On success → 201 {\"user_id\":\"<uuid>\",\"email\":\"<email>\"}\nEND PROCEDURE\n```\n### 5.3 POST /login Handler Flow\n```\nPROCEDURE HandleLogin(w http.ResponseWriter, r *http.Request):\n  1. Decode JSON body into LoginRequest.\n     IF malformed → 400 {\"error\":\"invalid request body\"}\n  2. No validation of email format or password length here —\n     invalid credentials simply fail the auth check, returning 401.\n     (Omitting validation prevents leaking \"this email format doesn't even exist\" information.)\n  3. Call userService.Login(r.Context(), req.Email, req.Password).\n     IF ErrAuthFailed → 401 {\"error\":\"invalid credentials\"}\n       -- identical response for wrong password AND unknown email --\n     IF other error → log.Error, return 500 {\"error\":\"internal server error\"}\n  4. On success → 200 {\"token\":\"<jwt>\",\"expires_at\":\"<RFC3339>\"}\n     expires_at formatted with time.RFC3339: \"2026-03-03T10:00:00Z\"\nEND PROCEDURE\n```\n### 5.4 GET /me Handler Flow\n```\nPROCEDURE HandleMe(w http.ResponseWriter, r *http.Request):\n  -- This handler is mounted BEHIND RequireAuth middleware.\n  -- By the time this handler runs, the JWT is already verified.\n  1. claims, ok = middleware.ClaimsFromContext(r.Context())\n     IF !ok → 401 {\"error\":\"unauthorized\"}\n     (Defensive check; RequireAuth should prevent this path.)\n  2. Return 200 {\"user_id\": claims.Sub, \"email\": claims.Email}\n     -- No DB call. All data comes from the verified token claims.\nEND PROCEDURE\n```\n\n![POST /register Data Flow](./diagrams/tdd-diag-10.svg)\n\n### 5.5 Route Registration in `main.go`\n```go\nmux := http.NewServeMux()\n// Public routes — no auth required\nmux.HandleFunc(\"POST /register\", handler.NewRegisterHandler(userSvc, log))\nmux.HandleFunc(\"POST /login\",    handler.NewLoginHandler(userSvc, log))\nmux.HandleFunc(\"GET /health\",    handler.NewHealthHandler(\"user-service\", log))\n// Protected routes — wrapped with RequireAuth middleware\nverifier := auth.NewJWTVerifier([]byte(jwtSecret))\nrequireAuth := middleware.RequireAuth(verifier, log)\nmux.Handle(\"GET /me\", requireAuth(http.HandlerFunc(handler.NewMeHandler(log))))\n```\n**Go 1.22+ routing note:** The `net/http` mux in Go 1.22 supports method-prefixed patterns (`\"POST /register\"`). Since `go.mod` declares `go 1.23`, this is available. Do not use `http.ServeMux` workarounds; use the native method patterns.\n---\n## 6. Threat Model\n### 6.1 Attack Surface\n| Attack | Vector | Mitigation |\n|---|---|---|\n| Password exfiltration | DB breach | bcrypt cost=12; hash is computationally infeasible to reverse |\n| Email enumeration via login | Different 401 bodies for \"no user\" vs \"wrong password\" | `ErrAuthFailed` collapses both cases; same response body and same 401 status |\n| Email enumeration via timing | bcrypt takes 100ms for valid email, 0ms for unknown | Always run `hasher.Compare` even for unknown emails (see § 6.2) |\n| JWT secret exposure | Hardcoded secret in source | `mustGetEnv(\"JWT_SECRET\")` — no fallback, no default |\n| Token forgery | Weak HMAC key | Document minimum key entropy: JWT_SECRET must be ≥ 32 random bytes in `.env.example` |\n| Algorithm confusion | JWT header `alg:none` or RSA confusion | `Verify` checks `t.Method.(*jwt.SigningMethodHMAC)` — rejects any other algorithm |\n| Long password DoS | bcrypt memory allocation for 10MB body | `http.MaxBytesReader(w, r.Body, 1024)` limits request body before any processing |\n| Concurrent registration race | Two goroutines both pass the uniqueness check before DB insert | Unique constraint on `users.email` enforced at DB level; application maps `23505` → 409 |\n### 6.2 Timing Attack Mitigation for Login\nWhen an email does not exist, skip `hasher.Compare` is a timing leak: the attacker observes that responses for unknown emails return in ~0ms while valid emails take ~100ms.\n```go\n// In UserService.Login — always run a compare operation to equalize timing.\nuser, err := s.repo.FindByEmail(ctx, email)\nif errors.Is(err, repository.ErrUserNotFound) {\n    // Run a dummy compare to burn the same ~100ms as a real compare.\n    // The hash is a valid bcrypt string that will never match anything.\n    _ = s.hasher.Compare(dummyHash, password)\n    return \"\", time.Time{}, ErrAuthFailed\n}\n```\n```go\n// Declare in user_service.go as a package-level constant.\n// Generated once with bcrypt.GenerateFromPassword([]byte(\"dummypassword\"), 12).\n// Never changes at runtime — it is not a security secret, just a timing dummy.\nconst dummyHash = \"$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj6hsxq.bxi.\"\n```\n\n![POST /login Data Flow + Email Enumeration Prevention](./diagrams/tdd-diag-11.svg)\n\n---\n## 7. Error Handling Matrix\n| Error | Detected By | HTTP Status | Response Body | Logged? | Notes |\n|---|---|---|---|---|---|\n| `VALIDATION_ERROR` (email format) | `ValidateEmail` in `UserService.Register` | 400 | `{\"error\":\"email format is invalid\"}` | No | User mistake; not logged |\n| `VALIDATION_ERROR` (password < 8) | `ValidatePassword` in `UserService.Register` | 400 | `{\"error\":\"password must be at least 8 characters\"}` | No | User mistake; not logged |\n| `VALIDATION_ERROR` (empty body) | JSON decoder in handler | 400 | `{\"error\":\"invalid request body\"}` | No | |\n| `VALIDATION_ERROR` (body > 1024B) | `http.MaxBytesReader` | 400 | `{\"error\":\"request body too large\"}` | No | |\n| `DUPLICATE_EMAIL` | `pgxUserRepository.Create` → `23505` | 409 | `{\"error\":\"email already registered\"}` | No | Expected race; not an error |\n| `AUTH_FAILED` (unknown email) | `UserService.Login` after `ErrUserNotFound` | 401 | `{\"error\":\"invalid credentials\"}` | No | Same body as wrong password |\n| `AUTH_FAILED` (wrong password) | `UserService.Login` after `ErrPasswordMismatch` | 401 | `{\"error\":\"invalid credentials\"}` | No | Same body as unknown email |\n| `TOKEN_EXPIRED` | `JWTVerifier.Verify` → `ErrTokenExpired` | 401 | `{\"error\":\"unauthorized\"}` | Warn | Log path for debugging |\n| `TOKEN_INVALID` | `JWTVerifier.Verify` → `ErrTokenInvalid` | 401 | `{\"error\":\"unauthorized\"}` | Warn | Potential attack; log it |\n| `TOKEN_MISSING` | `RequireAuth` → missing/malformed header | 401 | `{\"error\":\"unauthorized\"}` | No | Unauthenticated request |\n| `DB_ERROR` (unexpected) | Any repo call | 500 | `{\"error\":\"internal server error\"}` | **Error** | Log full error; never expose to client |\n| `BCRYPT_ERROR` (unexpected) | `hasher.Hash` or `hasher.Compare` | 500 | `{\"error\":\"internal server error\"}` | **Error** | Should never occur with valid input |\n| `JWT_SIGN_ERROR` | `signer.Sign` | 500 | `{\"error\":\"internal server error\"}` | **Error** | Indicates misconfigured secret |\n**500 response pattern** (used consistently in all handlers):\n```go\nfunc writeInternalError(w http.ResponseWriter, log zerolog.Logger, err error, msg string) {\n    log.Error().Err(err).Msg(msg)\n    writeJSON(w, http.StatusInternalServerError, ErrorResponse{Error: \"internal server error\"})\n}\n```\n**Shared `writeJSON` helper:**\n```go\n// writeJSON encodes v as JSON and writes it to w with the given status code.\n// Sets Content-Type: application/json.\n// Panics are impossible: encoding a fixed struct to JSON cannot fail.\nfunc writeJSON(w http.ResponseWriter, status int, v any) {\n    w.Header().Set(\"Content-Type\", \"application/json\")\n    w.WriteHeader(status)\n    json.NewEncoder(w).Encode(v) // error intentionally ignored; nothing we can do after WriteHeader\n}\n```\n---\n## 8. Implementation Sequence with Checkpoints\n### Phase 1 — users table migration + UserRepository (1–1.5 hr)\n1. Write `migrations/001_create_users.sql` (§ 3.1).\n2. Run the migration against `user_db`: `docker exec -i user_db psql -U user_user -d user_db < services/user-service/migrations/001_create_users.sql`\n3. Write `repository/user_repository.go`: define `User` struct, sentinel errors, `UserRepository` interface, `pgxUserRepository` struct, `NewPgxUserRepository`, `Create`, `FindByEmail`.\n4. Write `repository/user_repository_test.go`: integration tests (§ 9.2).\n5. Run `go test ./repository/... -v` with `user_db` running.\n**Checkpoint:** `go test ./repository/... -v` passes all tests. `TestCreate_DuplicateEmail` returns `ErrDuplicateEmail` (not a 500). `TestFindByEmail_NotFound` returns `ErrUserNotFound`. Run `docker exec user_db psql -U user_user -d user_db -c \"\\d users\"` — table and indexes visible.\n### Phase 2 — PasswordHasher + JWTSigner/JWTVerifier (1–1.5 hr)\n1. Add `golang.org/x/crypto` to `go.mod`: `go get golang.org/x/crypto`.\n2. Add `github.com/golang-jwt/jwt/v5`: `go get github.com/golang-jwt/jwt/v5`.\n3. Add `github.com/google/uuid`: `go get github.com/google/uuid`.\n4. Write `auth/password.go` (§ 4.2).\n5. Write `auth/password_test.go` (§ 9.3).\n6. Write `auth/jwt.go` (§ 4.3).\n7. Write `auth/jwt_test.go` (§ 9.4).\n8. Run `go test ./auth/...`.\n**Checkpoint:** `go test ./auth/... -v` passes all tests. `TestBcryptCost` verifies cost=12 is embedded in hash. `TestJWTRoundTrip` verifies Sign→Verify returns identical claims. `TestVerify_ExpiredToken` returns `ErrTokenExpired`. `TestVerify_TamperedSignature` returns `ErrTokenInvalid`. `TestVerify_WrongIssuer` returns `ErrTokenInvalid`.\n### Phase 3 — POST /register + POST /login Handlers (1.5–2 hr)\n1. Write `service/user_service.go`: `UserService` struct, `NewUserService`, `Register`, `Login`, dummy hash constant (§ 4.4, § 6.2).\n2. Write `handler/register.go`: `RegisterRequest`, `RegisterResponse`, `NewRegisterHandler` (§ 5.2).\n3. Write `handler/login.go`: `LoginRequest`, `LoginResponse`, `NewLoginHandler` (§ 5.3).\n4. Write the `writeJSON` and `writeInternalError` helpers (§ 7) — put them in `handler/helpers.go`.\n5. Wire together in `main.go`: connect DB, construct `pgxUserRepository`, `bcryptHasher`, `jwtSigner`, `UserService`, register routes.\n6. Run `docker compose up --build user-service`.\n**Checkpoint:**\n```bash\n# Register\ncurl -s -X POST http://localhost:8083/register \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"password123\"}' | jq .\n# Expected: {\"user_id\":\"<uuid>\",\"email\":\"alice@example.com\"} with 201\n# Duplicate\ncurl -s -o /dev/null -w \"%{http_code}\" -X POST http://localhost:8083/register \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"password123\"}'\n# Expected: 409\n# Login\ncurl -s -X POST http://localhost:8083/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"password123\"}' | jq .\n# Expected: {\"token\":\"eyJ...\",\"expires_at\":\"2026-...\"}\n# Wrong password\ncurl -s -o /dev/null -w \"%{http_code}\" -X POST http://localhost:8083/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"wrongpassword\"}'\n# Expected: 401\n```\n### Phase 4 — JWT Middleware in `shared/middleware/` (1–1.5 hr)\n1. Create `shared/middleware/` directory.\n2. Add `github.com/golang-jwt/jwt/v5` to `shared/go.mod` (since middleware imports auth types).\n3. Write `shared/middleware/jwt_middleware.go` (§ 4.5).\n4. Write `shared/middleware/jwt_middleware_test.go` (§ 9.5).\n5. Run `go test ./...` from `shared/`.\n6. Update each service's `go.mod` to import `shared/middleware` via the existing replace directive.\n**Checkpoint:** `go test ./... -v` in `shared/` passes. `TestRequireAuth_MissingHeader` → 401. `TestRequireAuth_ValidToken` → calls next handler. `TestRequireAuth_ExpiredToken` → 401. `TestClaimsFromContext` → returns claims stored by middleware.\n**Note on shared package design:** The `shared/middleware` package must import `auth.JWTVerifier` and `auth.Claims`. These types are defined in each service's `auth/` package, which creates an import cycle if `shared/middleware` imports a specific service. Resolution: move `auth.JWTVerifier` and `auth.Claims` interface/struct definitions into `shared/auth/` so that both user-service and `shared/middleware` can import from a neutral location.\n**Revised structure addition:**\n```\nshared/\n  auth/\n    types.go    # JWTVerifier interface, Claims struct, sentinel errors\n  middleware/\n    jwt_middleware.go\n```\nUser-service's `auth/jwt.go` implements `shared/auth.JWTVerifier` interface. This eliminates the cycle.\n### Phase 5 — GET /me + Integration Test (1–1.5 hr)\n1. Write `handler/me.go` (§ 5.4).\n2. Add the `/me` route behind `RequireAuth` middleware to `main.go`.\n3. Write `handler/handler_test.go`: full round-trip integration test (§ 9.6).\n4. Run the integration test against the live Docker stack.\n**Checkpoint:**\n```bash\n# Full round trip\nTOKEN=$(curl -s -X POST http://localhost:8083/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"password123\"}' | jq -r .token)\ncurl -s http://localhost:8083/me \\\n  -H \"Authorization: Bearer $TOKEN\" | jq .\n# Expected: {\"user_id\":\"<uuid>\",\"email\":\"alice@example.com\"}\n# Expired / invalid token\ncurl -s -o /dev/null -w \"%{http_code}\" http://localhost:8083/me \\\n  -H \"Authorization: Bearer invalidtoken\"\n# Expected: 401\n```\n\n![JWT Claims Memory Layout](./diagrams/tdd-diag-12.svg)\n\n---\n## 9. Test Specification\n### 9.1 Test File Organization\nAll tests in this module follow the pattern of same-package unit tests for pure logic, and `_test` package (external) tests for integration against the live DB or HTTP server.\n### 9.2 `repository/user_repository_test.go`\n```go\n// Build tag: //go:build integration — run with: go test -tags integration ./repository/...\n// Requires: user_db container running. Read DSN from TEST_DATABASE_DSN env var.\n// TestCreate_HappyPath: insert user → row exists in DB with correct fields\n// TestCreate_DuplicateEmail: insert same email twice → second returns ErrDuplicateEmail\n// TestCreate_UUIDPreserved: user.ID provided by caller is stored verbatim (not overwritten)\n// TestCreate_EmailNormalization: upper-case email in → lower-case stored\n//   (if normalization is done in service; verify service layer, not repo)\n// TestFindByEmail_HappyPath: insert user → FindByEmail returns same user\n// TestFindByEmail_NotFound: FindByEmail on unknown email → ErrUserNotFound\n// TestFindByEmail_CaseSensitivity: store \"alice@example.com\" → find \"ALICE@EXAMPLE.COM\" → not found\n//   (repository is case-sensitive; normalization is service responsibility)\nfunc TestCreate_HappyPath(t *testing.T)\nfunc TestCreate_DuplicateEmail(t *testing.T)\nfunc TestCreate_UUIDPreserved(t *testing.T)\nfunc TestFindByEmail_HappyPath(t *testing.T)\nfunc TestFindByEmail_NotFound(t *testing.T)\nfunc TestFindByEmail_CaseSensitivity(t *testing.T)\n```\n### 9.3 `auth/password_test.go`\n```go\n// TestHash_ProducesValidBcrypt: Hash(\"mypassword\") → string starts with \"$2a$12$\"\n// TestHash_DifferentSalts: Hash(\"same\") called twice → two different hashes\n// TestCompare_HappyPath: Hash(p) → Compare(hash, p) returns nil\n// TestCompare_WrongPassword: Compare(hash, \"wrong\") → ErrPasswordMismatch\n// TestCompare_EmptyPassword: Hash(\"\") returns error (bcrypt rejects empty)\n// TestBcryptCost: hash output contains \"$2a$12$\" (cost 12 confirmed)\n// BenchmarkHash: bcrypt at cost=12 should take 80-200ms (document timing)\nfunc TestHash_ProducesValidBcrypt(t *testing.T)\nfunc TestHash_DifferentSalts(t *testing.T)\nfunc TestCompare_HappyPath(t *testing.T)\nfunc TestCompare_WrongPassword(t *testing.T)\nfunc TestBcryptCost(t *testing.T)\nfunc BenchmarkHash(b *testing.B)\n```\n### 9.4 `auth/jwt_test.go`\n```go\n// TestSign_ReturnsThreeParts: token string contains exactly two \".\" chars\n// TestSign_PayloadFields: decode payload (no verify) → sub, email, iss, iat, exp present\n// TestSign_ExpiryIs24h: exp - iat == 86400 seconds\n// TestVerify_HappyPath: Sign → Verify → claims match original\n// TestVerify_ExpiredToken: manually set exp to past → Verify returns ErrTokenExpired\n// TestVerify_TamperedSignature: alter one char in signature → ErrTokenInvalid\n// TestVerify_WrongAlgorithm: header alg=none → ErrTokenInvalid\n// TestVerify_WrongIssuer: sign with iss=\"other\" → ErrTokenInvalid\n// TestVerify_EmptySecret: NewJWTSigner(nil) → panics\n// TestVerify_SubIsUUID: claims.Sub from verified token is parseable by uuid.Parse\nfunc TestSign_ReturnsThreeParts(t *testing.T)\nfunc TestSign_ExpiryIs24h(t *testing.T)\nfunc TestVerify_HappyPath(t *testing.T)\nfunc TestVerify_ExpiredToken(t *testing.T)\nfunc TestVerify_TamperedSignature(t *testing.T)\nfunc TestVerify_WrongIssuer(t *testing.T)\nfunc TestVerify_EmptySecret(t *testing.T) // expects panic; use recover()\n```\n### 9.5 `shared/middleware/jwt_middleware_test.go`\n```go\n// All tests use httptest.NewRecorder and httptest.NewRequest.\n// A real JWTVerifier (not a mock) is used to produce valid/invalid tokens.\n// TestRequireAuth_ValidToken: valid token → next called, claims in context\n// TestRequireAuth_MissingHeader: no Authorization header → 401\n// TestRequireAuth_MalformedHeader: \"Token abc\" (not Bearer) → 401\n// TestRequireAuth_ExpiredToken: expired token → 401, next NOT called\n// TestRequireAuth_InvalidSignature: tampered token → 401\n// TestRequireAuth_EmptyBearerValue: \"Bearer \" (nothing after space) → 401\n// TestClaimsFromContext_Present: context with claims → returns claims, true\n// TestClaimsFromContext_Absent: empty context → returns zero Claims, false\nfunc TestRequireAuth_ValidToken(t *testing.T)\nfunc TestRequireAuth_MissingHeader(t *testing.T)\nfunc TestRequireAuth_MalformedHeader(t *testing.T)\nfunc TestRequireAuth_ExpiredToken(t *testing.T)\nfunc TestRequireAuth_InvalidSignature(t *testing.T)\nfunc TestClaimsFromContext_Present(t *testing.T)\nfunc TestClaimsFromContext_Absent(t *testing.T)\n```\n### 9.6 `handler/handler_test.go` — Integration Test\n```go\n// Build tag: //go:build integration\n// Requires: user-service running on TEST_USER_SERVICE_URL (default: http://localhost:8083)\n// TestRegisterLoginMe_RoundTrip:\n//   1. POST /register → 201, capture user_id\n//   2. POST /login → 200, capture token and expires_at\n//   3. Verify expires_at is approximately 24h from now (within 60s tolerance)\n//   4. GET /me with token → 200, user_id and email match registration values\n//   5. GET /me with no token → 401\n//   6. GET /me with expired token → 401\n// TestRegister_DuplicateEmail:\n//   1. POST /register (email A) → 201\n//   2. POST /register (email A again) → 409, body contains \"email already registered\"\n// TestRegister_InvalidEmail:\n//   POST /register with \"notanemail\" → 400\n// TestRegister_ShortPassword:\n//   POST /register with 7-char password → 400\n// TestLogin_WrongPassword:\n//   POST /login with correct email, wrong password → 401\n//   Response body must equal 401 body for unknown email (same message)\n// TestLogin_UnknownEmail:\n//   POST /login with unknown email → 401\n//   Response body must equal 401 body for wrong password (same message)\nfunc TestRegisterLoginMe_RoundTrip(t *testing.T)\nfunc TestRegister_DuplicateEmail(t *testing.T)\nfunc TestRegister_InvalidEmail(t *testing.T)\nfunc TestRegister_ShortPassword(t *testing.T)\nfunc TestLogin_WrongPassword(t *testing.T)\nfunc TestLogin_UnknownEmail(t *testing.T)\n```\n\n![JWT Middleware State Machine (per request)](./diagrams/tdd-diag-13.svg)\n\n---\n## 10. Performance Targets\n| Operation | Target | How to Measure |\n|---|---|---|\n| `POST /register` p99 | < 200ms | `wrk -t2 -c5 -d30s -s register.lua http://localhost:8083/register` — bcrypt dominates |\n| `POST /login` (valid) p99 | < 200ms | Same `wrk` script with login payload |\n| `POST /login` (unknown email) p99 | 80–200ms | Must NOT be near-zero — timing equalization required (§ 6.2) |\n| `GET /me` p99 | < 5ms | `wrk -t4 -c50 -d10s` with valid token — no DB access |\n| JWT `Verify` (HMAC-SHA256) | < 1ms | `go test -bench=BenchmarkVerify ./auth/...` |\n| JWT `Sign` | < 1ms | `go test -bench=BenchmarkSign ./auth/...` |\n| `bcrypt.Hash` (cost=12) | 80–150ms | `go test -bench=BenchmarkHash ./auth/...` on commodity hardware |\n| `go build ./...` | < 10s incremental | CI warm build |\n| `GET /health` p99 | < 10ms | (inherited from M1) |\n**bcrypt cost=12 justification:** At cost=12, a single hash takes ~100ms on a modern CPU. This bounds `/register` and `/login` to ~100–200ms total (DB query + bcrypt). This is acceptable for auth endpoints which are not on the hot redirect path. The hot path (`GET /:code` redirect) in url-service does not touch user-service at all.\n**Concurrency note:** At cost=12, bcrypt saturates a CPU core for ~100ms. With default GOMAXPROCS, a sustained load of 10 concurrent login requests will queue behind each other. This is a deliberate security tradeoff, not a bug. The service is not designed to serve thousands of logins per second — it is designed to make brute-force attacks computationally expensive.\n---\n## 11. Concurrency Specification\n### 11.1 Handler Concurrency\n`net/http` launches each request in its own goroutine. The following invariants must hold:\n- `UserService` is stateless: no shared mutable fields. The `dummyHash` constant is read-only. Safe for concurrent use.\n- `pgxUserRepository` stores only a `*pgxpool.Pool` reference. `pgxpool` is safe for concurrent use — each `Acquire(ctx)` call gets an exclusive connection from the pool.\n- `bcryptHasher` is stateless. `bcrypt.GenerateFromPassword` and `bcrypt.CompareHashAndPassword` are goroutine-safe per `golang.org/x/crypto` documentation.\n- `jwtSigner` and `jwtVerifier` store only `[]byte` (the secret), which is immutable after construction. Safe for concurrent use.\n- No global variables in the handler, service, or repository packages (only the `log` instance, which `zerolog.Logger` is value-safe by design).\n### 11.2 Blocking Operations\n`bcrypt.CompareHashAndPassword` at cost=12 blocks its goroutine for ~100ms. This is acceptable because:\n1. Auth endpoints are not on the hot redirect path.\n2. Go's scheduler will context-switch other goroutines while this one blocks.\n3. The pgxpool connection is held for DB query time only (< 5ms), not during bcrypt computation — acquire, query, release, then bcrypt.\n**Connection acquisition pattern:**\n```go\n// In UserService.Login — release DB connection before bcrypt, not after.\nuser, err := s.repo.FindByEmail(ctx, email) // acquires + releases pool conn internally\nif err != nil { ... }\n// DB connection is released here. bcrypt runs without holding any pool connection.\nerr = s.hasher.Compare(user.PasswordHash, password)\n```\n---\n## 12. Environment Variable Reference for This Module\n| Variable | Required | Example | Description |\n|---|---|---|---|\n| `JWT_SECRET` | Yes | `supersecretkey32bytesminimum!!!` | HMAC-SHA256 signing key. Must be ≥ 32 bytes. No default — service exits if unset. |\n| `PORT` | Yes | `8083` | HTTP listen port (inherited from M1) |\n| `DATABASE_DSN` | Yes | `postgres://user_user:user_secret@user_db:5432/user_db?sslmode=disable` | (inherited from M1) |\n| `SERVICE_NAME` | Yes | `user-service` | Embedded in log lines (inherited from M1) |\n**`JWT_SECRET` startup validation** (add to `main.go`):\n```go\njwtSecret := mustGetEnv(\"JWT_SECRET\")\nif len(jwtSecret) < 32 {\n    log.Fatal().Msg(\"JWT_SECRET must be at least 32 characters\")\n    os.Exit(1)\n}\n```\n**`.env.example` addition:**\n```\nJWT_SECRET=change-me-to-at-least-32-random-bytes-in-production\n```\n**Cross-service secret sharing:** The same `JWT_SECRET` value must be set in the environment of url-service, analytics-service, notification-service, and the gateway. They use it only to construct a `JWTVerifier` — never a `JWTSigner`. Add `JWT_SECRET` to each service's `docker-compose.yml` environment block in M3–M5.\n---\n<!-- END_TDD_MOD -->\n\n\n<!-- TDD_MOD_ID: url-shortener-m3 -->\n# Technical Design Specification\n## Module: URL Service — Shorten, Redirect, CRUD + Domain Event Publishing\n**Module ID:** `url-shortener-m3`\n---\n## 1. Module Charter\nThe URL Service is the core business logic service of the URL shortener system. It accepts long URLs from authenticated users, generates collision-resistant 7-character base62 short codes, stores them in its private PostgreSQL database, serves 301 redirects via a Redis read-through cache, and publishes domain events (`URLCreatedEvent`, `URLClickedEvent`, `URLDeletedEvent`) to RabbitMQ using the outbox pattern to guarantee at-least-once delivery without coupling the write path to broker availability.\nThis module does **not** call the analytics-service, notification-service, or user-service at runtime. It does not share its PostgreSQL database with any other service. It does not verify user existence — the JWT `sub` claim is trusted as the owner identifier. It does not implement URL preview, custom domain mapping, QR code generation, link health checking, or bulk import. The outbox poller is the only component that touches RabbitMQ; HTTP handlers write only to PostgreSQL.\n**Upstream dependencies:** M1 foundation (Docker Compose stack, `shared/events`, `shared/logger`, Redis container, RabbitMQ container, `url_db` PostgreSQL container). M2 `shared/auth` package for `JWTVerifier` and `Claims`; `shared/middleware` for `RequireAuth`.\n**Downstream dependencies:** analytics-service (M4) and notification-service (M5) consume events published by the outbox poller. The gateway (M5) proxies all requests to this service. No service calls url-service synchronously except the gateway.\n**Invariants that must always hold after this milestone:**\n- Every URL creation and its corresponding `URLCreatedEvent` are written in a single PostgreSQL transaction — they either both commit or both roll back. No URL exists without an outbox row; no outbox row exists for a URL that was not created.\n- The same atomic-transaction invariant holds for clicks: every redirect and its `URLClickedEvent` are written together. If the service crashes after the redirect response is sent but before the commit, the event is not published (acceptable: the redirect still happened; the loss of one click event is a known at-least-once tradeoff documented below).\n- A Redis cache error never causes a redirect failure. The cache is always optional; PostgreSQL is the source of truth.\n- Short codes are generated from `crypto/rand`; `math/rand` is never used in the code generation path.\n- A user can only delete their own URLs. The JWT `sub` must match `urls.user_id`; mismatches return 403, not 404.\n- Expired URLs return 410, not 404. Inactive URLs (soft-deleted) return 410, not 404. Only truly absent codes return 404.\n---\n## 2. File Structure\nCreate files in the numbered order below. All paths are relative to the monorepo root.\n```\nurl-shortener/\n│\n├── services/url-service/\n│   ├── migrations/\n│   │   ├── 01  001_create_urls.sql\n│   │   └── 02  002_create_outbox.sql\n│   ├── codegen/\n│   │   ├── 03  codegen.go               # Base62 alphabet, Generate(), collision retry\n│   │   └── 04  codegen_test.go\n│   ├── repository/\n│   │   ├── 05  url_repository.go        # URLRepository interface + pgx implementation\n│   │   ├── 06  url_repository_test.go\n│   │   ├── 07  outbox_repository.go     # OutboxRepository interface + pgx implementation\n│   │   └── 08  outbox_repository_test.go\n│   ├── cache/\n│   │   ├── 09  cache.go                 # CacheClient interface + Redis implementation\n│   │   └── 10  cache_test.go\n│   ├── amqp/\n│   │   ├── 11  publisher.go             # AMQPPublisher interface + amqp091 implementation\n│   │   └── 12  publisher_test.go\n│   ├── outbox/\n│   │   ├── 13  poller.go                # OutboxPoller: coordinator + 3 workers\n│   │   └── 14  poller_test.go\n│   ├── service/\n│   │   └── 15  url_service.go           # URLService: orchestrates repo, codegen, cache, outbox\n│   ├── handler/\n│   │   ├── 16  shorten.go              # POST /shorten\n│   │   ├── 17  redirect.go             # GET /:code\n│   │   ├── 18  list.go                 # GET /urls\n│   │   ├── 19  delete.go               # DELETE /urls/:code\n│   │   ├── 20  health.go               # GET /health (update from M1)\n│   │   ├── 21  helpers.go              # writeJSON, writeError, extractIP, hashIP\n│   │   └── 22  handler_test.go         # integration tests\n│   └── 23  main.go                     # wiring: env, DB, Redis, RabbitMQ, routes, outbox start\n```\n**Total new files: 23** (excluding auto-generated `go.sum` changes).\n---\n## 3. Complete Data Model\n### 3.1 PostgreSQL Schema — `migrations/001_create_urls.sql`\n```sql\n-- migrations/001_create_urls.sql\nBEGIN;\nCREATE TABLE IF NOT EXISTS urls (\n    id           UUID         PRIMARY KEY DEFAULT gen_random_uuid(),\n    short_code   VARCHAR(10)  NOT NULL,\n    original_url TEXT         NOT NULL,\n    user_id      UUID         NOT NULL,\n    created_at   TIMESTAMPTZ  NOT NULL DEFAULT now(),\n    expires_at   TIMESTAMPTZ  NULL,           -- NULL means no expiry\n    is_active    BOOLEAN      NOT NULL DEFAULT true\n);\n-- Primary lookup: redirect hot path. Must be unique; drives cache key.\nCREATE UNIQUE INDEX IF NOT EXISTS idx_urls_short_code\n    ON urls(short_code);\n-- Cursor pagination: user's URL list, newest first.\n-- Composite index matches the WHERE user_id = $1 AND id < $2 ORDER BY id DESC query.\nCREATE INDEX IF NOT EXISTS idx_urls_user_id_created\n    ON urls(user_id, created_at DESC);\nCOMMIT;\n```\n### 3.2 PostgreSQL Schema — `migrations/002_create_outbox.sql`\n```sql\n-- migrations/002_create_outbox.sql\nBEGIN;\nCREATE TABLE IF NOT EXISTS outbox (\n    id           UUID         PRIMARY KEY DEFAULT gen_random_uuid(),\n    event_type   TEXT         NOT NULL,       -- routing key, e.g. \"url.clicked\"\n    payload      JSONB        NOT NULL,       -- serialized event struct\n    created_at   TIMESTAMPTZ  NOT NULL DEFAULT now(),\n    published_at TIMESTAMPTZ  NULL            -- NULL = not yet published\n);\n-- Poller query: unpublished rows, oldest first, bounded.\n-- Partial index (WHERE published_at IS NULL) keeps the index small\n-- as published rows accumulate.\nCREATE INDEX IF NOT EXISTS idx_outbox_unpublished\n    ON outbox(created_at ASC)\n    WHERE published_at IS NULL;\nCOMMIT;\n```\n**Field rationale:**\n- `outbox.payload JSONB`: The full event struct is serialized here. Workers read this column and publish it directly to RabbitMQ as the message body. No JOIN to `urls` is needed at publish time.\n- `outbox.published_at NULL`: The poller filters on `WHERE published_at IS NULL`. Marking a row published sets this to `now()`. Rows are never deleted — they form an audit trail.\n- `urls.is_active BOOLEAN NOT NULL DEFAULT true`: Soft delete. Hard deletes would leave broken cache entries and orphaned analytics rows. `is_active=false` + Redis DEL is the correct sequence.\n- `urls.expires_at TIMESTAMPTZ NULL`: Nullable means \"no expiry.\" A sentinel value (e.g., year 9999) would work but is less idiomatic in PostgreSQL.\n### 3.3 Go Structs\n```go\n// repository/url_repository.go\npackage repository\nimport \"time\"\n// URL is the domain entity stored in the urls table.\ntype URL struct {\n    ID          string     // UUID v4, primary key\n    ShortCode   string     // 7-char base62; up to 10 chars for custom codes\n    OriginalURL string     // full destination URL, validated before storage\n    UserID      string     // UUID string; JWT sub claim of the creator\n    CreatedAt   time.Time  // set by DB DEFAULT\n    ExpiresAt   *time.Time // nil = no expiry\n    IsActive    bool       // false = soft-deleted\n}\n// URLSummary is the projection returned by ListByUser.\n// It omits internal fields (ID is included as cursor value only).\ntype URLSummary struct {\n    ID          string     // UUID; used as cursor value, not exposed in API response\n    ShortCode   string\n    OriginalURL string\n    CreatedAt   time.Time\n    ExpiresAt   *time.Time\n    IsActive    bool\n}\n// Sentinel errors returned by URLRepository.\nvar (\n    ErrURLNotFound    = errors.New(\"url not found\")\n    ErrCodeConflict   = errors.New(\"short code already exists\")\n    ErrNotOwner       = errors.New(\"caller does not own this url\")\n)\n```\n```go\n// repository/outbox_repository.go\npackage repository\n// OutboxEntry is a row in the outbox table.\ntype OutboxEntry struct {\n    ID          string    // UUID; primary key\n    EventType   string    // RabbitMQ routing key\n    Payload     []byte    // JSON-encoded event struct\n    CreatedAt   time.Time\n    PublishedAt *time.Time // nil = not yet published\n}\n```\n```go\n// cache/cache.go\npackage cache\nimport \"time\"\n// CachedURL is the value stored in Redis for a given short_code key.\n// It contains exactly enough information to serve a redirect without a DB query.\n// The outbox event is NOT cached — it always goes to PostgreSQL.\ntype CachedURL struct {\n    OriginalURL string     `json:\"original_url\"`\n    ExpiresAt   *time.Time `json:\"expires_at,omitempty\"`\n    IsActive    bool       `json:\"is_active\"`\n}\n// RedisKey for a short code: \"url:{short_code}\"\n// Example: \"url:aB3xY9z\"\nfunc RedisKey(shortCode string) string {\n    return \"url:\" + shortCode\n}\n```\n```go\n// handler/shorten.go — Request/Response DTOs\npackage handler\nimport \"time\"\n// ShortenRequest is the JSON body accepted by POST /shorten.\ntype ShortenRequest struct {\n    URL        string  `json:\"url\"`                  // required; must have scheme + host\n    CustomCode string  `json:\"custom_code,omitempty\"` // optional; 4-10 alphanumeric chars\n    ExpiresAt  *string `json:\"expires_at,omitempty\"`  // optional; RFC3339 string\n}\n// ShortenResponse is the JSON body returned on 201 Created.\ntype ShortenResponse struct {\n    ShortCode   string  `json:\"short_code\"`\n    ShortURL    string  `json:\"short_url\"`    // e.g. \"http://localhost:8081/aB3xY9z\"\n    OriginalURL string  `json:\"original_url\"`\n    ExpiresAt   *string `json:\"expires_at,omitempty\"` // RFC3339 or absent\n}\n// URLListResponse is the JSON body returned by GET /urls.\ntype URLListResponse struct {\n    URLs       []URLItem `json:\"urls\"`\n    NextCursor *string   `json:\"next_cursor,omitempty\"` // UUID string; absent if no more pages\n}\n// URLItem is a single URL entry in the list response.\ntype URLItem struct {\n    ShortCode   string  `json:\"short_code\"`\n    OriginalURL string  `json:\"original_url\"`\n    CreatedAt   string  `json:\"created_at\"`            // RFC3339\n    ExpiresAt   *string `json:\"expires_at,omitempty\"`\n    IsActive    bool    `json:\"is_active\"`\n}\n```\n\n![URL Service Module Architecture](./diagrams/tdd-diag-14.svg)\n\n---\n## 4. Interface Contracts\n### 4.1 `URLRepository`\n```go\n// repository/url_repository.go\n// URLRepository defines persistence operations for URL entities.\n// All implementations must be safe for concurrent use.\n// Implementations must NOT start or commit transactions; callers provide pgx.Tx\n// for operations that require atomicity.\ntype URLRepository interface {\n    // Create inserts a new URL row. Executes within the provided transaction tx.\n    // tx must be non-nil — Create is always called inside a transaction that also\n    // calls OutboxRepository.Insert. If short_code violates the unique constraint,\n    // returns ErrCodeConflict (pgconn code \"23505\"). Other DB errors are wrapped\n    // with fmt.Errorf(\"urlRepository.Create: %w\", err).\n    Create(ctx context.Context, tx pgx.Tx, u URL) error\n    // FindByCode retrieves a URL by short_code using the pool (not a transaction).\n    // Returns ErrURLNotFound if no row matches.\n    // The returned URL contains all fields including is_active and expires_at.\n    FindByCode(ctx context.Context, shortCode string) (URL, error)\n    // ListByUser returns a page of URLs owned by userID.\n    // afterID is the cursor: if non-empty, returns rows with created_at strictly\n    // less than the row identified by afterID. Rows are ordered by (created_at DESC, id DESC).\n    // limit is the maximum number of rows to return (caller passes pageSize + 1 to detect\n    // whether a next page exists; caller slices the result before returning to the API client).\n    // Returns an empty slice (not nil) if no rows match.\n    ListByUser(ctx context.Context, userID string, afterID string, limit int) ([]URLSummary, error)\n    // SoftDelete sets is_active=false for the row identified by shortCode.\n    // Returns ErrURLNotFound if no row exists.\n    // Returns ErrNotOwner if the row's user_id does not match ownerID.\n    // Executes within the provided transaction tx.\n    SoftDelete(ctx context.Context, tx pgx.Tx, shortCode, ownerID string) error\n}\n```\n**SQL queries for each method:**\n```sql\n-- Create\nINSERT INTO urls (id, short_code, original_url, user_id, expires_at)\nVALUES ($1, $2, $3, $4, $5)\n-- FindByCode\nSELECT id, short_code, original_url, user_id, created_at, expires_at, is_active\nFROM urls\nWHERE short_code = $1\n-- ListByUser (with cursor)\nSELECT id, short_code, original_url, created_at, expires_at, is_active\nFROM urls\nWHERE user_id = $1\n  AND ($2::uuid IS NULL OR (created_at, id) < (\n      SELECT created_at, id FROM urls WHERE id = $2::uuid\n  ))\nORDER BY created_at DESC, id DESC\nLIMIT $3\n-- SoftDelete (with ownership check — single atomic UPDATE)\nUPDATE urls\nSET is_active = false\nWHERE short_code = $1\n  AND user_id = $2\nRETURNING id\n-- If 0 rows affected: determine whether code exists to distinguish 404 vs 403:\n--   SELECT id, user_id FROM urls WHERE short_code = $1\n--   No row → ErrURLNotFound; row with wrong user_id → ErrNotOwner\n```\n**Note on `ListByUser` cursor:** Using `(created_at, id) < (SELECT ...)` is a keyset/cursor approach. The subquery fetches the anchor row's `(created_at, id)` so the comparison is correct even if multiple rows share the same `created_at`. The index `idx_urls_user_id_created` covers `(user_id, created_at DESC)` which satisfies the `WHERE user_id = $1` filter and `ORDER BY created_at DESC`.\n### 4.2 `OutboxRepository`\n```go\n// repository/outbox_repository.go\n// OutboxRepository writes event rows to the outbox table and marks them published.\ntype OutboxRepository interface {\n    // Insert writes a new outbox row within the provided transaction tx.\n    // tx must be the same transaction as the URL write — atomicity is the contract.\n    // eventType is the RabbitMQ routing key (e.g., \"url.clicked\").\n    // payload is the JSON-serialized event struct.\n    Insert(ctx context.Context, tx pgx.Tx, eventType string, payload []byte) error\n    // FetchUnpublished returns up to limit unpublished outbox rows, ordered by\n    // created_at ASC (oldest first). Uses the pool (no transaction) because the\n    // poller reads and marks-published in two separate steps.\n    // Returns an empty slice (not nil) if no rows are pending.\n    FetchUnpublished(ctx context.Context, limit int) ([]OutboxEntry, error)\n    // MarkPublished sets published_at = now() for the row identified by id.\n    // Uses the pool (no transaction). Idempotent: if already published, no-op.\n    MarkPublished(ctx context.Context, id string) error\n}\n```\n**SQL queries:**\n```sql\n-- Insert (within caller's transaction)\nINSERT INTO outbox (id, event_type, payload, created_at)\nVALUES (gen_random_uuid(), $1, $2, now())\n-- FetchUnpublished\nSELECT id, event_type, payload, created_at\nFROM outbox\nWHERE published_at IS NULL\nORDER BY created_at ASC\nLIMIT $1\n-- MarkPublished\nUPDATE outbox\nSET published_at = now()\nWHERE id = $1\n```\n### 4.3 `CacheClient`\n```go\n// cache/cache.go\n// CacheClient wraps Redis operations for URL caching.\n// All methods must be nil-safe: if the underlying Redis client is nil\n// (set during startup when Redis was unavailable), every method returns\n// a cache-miss sentinel or no-op without panicking.\n// All errors are logged internally; callers never receive Redis errors —\n// cache failures are transparent.\ntype CacheClient interface {\n    // Get retrieves a CachedURL by short_code key (\"url:{code}\").\n    // Returns (entry, nil) on hit.\n    // Returns (CachedURL{}, ErrCacheMiss) on miss or any Redis error.\n    // Never returns any error other than ErrCacheMiss to the caller.\n    Get(ctx context.Context, shortCode string) (CachedURL, error)\n    // Set stores a CachedURL with the given TTL.\n    // ttl must be > 0; if ttl <= 0, Set is a no-op (never cache with no expiry).\n    // Any Redis error is logged and silently swallowed.\n    Set(ctx context.Context, shortCode string, entry CachedURL, ttl time.Duration)\n    // Del removes the cache entry for shortCode.\n    // Any Redis error is logged and silently swallowed.\n    // This is a best-effort operation; callers must not assume the key is gone.\n    Del(ctx context.Context, shortCode string)\n}\n// ErrCacheMiss is the only error CacheClient.Get returns to callers.\nvar ErrCacheMiss = errors.New(\"cache miss\")\n```\n**Implementation detail — nil safety:**\n```go\ntype redisCacheClient struct {\n    client *redis.Client // may be nil if Redis was unavailable at startup\n    log    zerolog.Logger\n}\nfunc (c *redisCacheClient) Get(ctx context.Context, shortCode string) (CachedURL, error) {\n    if c.client == nil {\n        return CachedURL{}, ErrCacheMiss\n    }\n    val, err := c.client.Get(ctx, RedisKey(shortCode)).Result()\n    if errors.Is(err, redis.Nil) {\n        return CachedURL{}, ErrCacheMiss\n    }\n    if err != nil {\n        c.log.Warn().Err(err).Str(\"key\", RedisKey(shortCode)).Msg(\"redis GET failed; cache miss\")\n        return CachedURL{}, ErrCacheMiss\n    }\n    var entry CachedURL\n    if err = json.Unmarshal([]byte(val), &entry); err != nil {\n        c.log.Warn().Err(err).Msg(\"redis value unmarshal failed; cache miss\")\n        return CachedURL{}, ErrCacheMiss\n    }\n    return entry, nil\n}\n```\n### 4.4 `CodeGenerator`\n```go\n// codegen/codegen.go\n// CodeGenerator generates short codes.\ntype CodeGenerator interface {\n    // Generate produces a 7-character base62 string from crypto/rand.\n    // Returns an error only if the OS random source fails (extremely rare).\n    // Collision detection is NOT performed here — that is the caller's\n    // responsibility (URLService.createShortCode retry loop).\n    Generate() (string, error)\n}\n// NewCodeGenerator returns the default 7-character base62 generator.\nfunc NewCodeGenerator() CodeGenerator\n```\n### 4.5 `AMQPPublisher`\n```go\n// amqp/publisher.go\n// AMQPPublisher publishes messages to the RabbitMQ topic exchange.\ntype AMQPPublisher interface {\n    // Publish sends body to the exchange \"url-shortener\" with the given routingKey.\n    // body must be a JSON-encoded event struct.\n    // Returns an error if the AMQP channel is closed or the broker is unreachable.\n    // Callers (outbox workers) handle errors by logging and leaving the outbox row\n    // unpublished for the next poll cycle.\n    Publish(ctx context.Context, routingKey string, body []byte) error\n}\n```\n### 4.6 `URLService`\n```go\n// service/url_service.go\n// URLService orchestrates URL creation, lookup, listing, deletion, and event emission.\n// It owns no state beyond its dependencies. Safe for concurrent use.\ntype URLService struct {\n    pool      *pgxpool.Pool\n    urlRepo   repository.URLRepository\n    outboxRepo repository.OutboxRepository\n    cache     cache.CacheClient\n    codegen   codegen.CodeGenerator\n    baseURL   string // e.g. \"http://localhost:8081\" — prepended to short_code for short_url\n    log       zerolog.Logger\n}\nfunc NewURLService(\n    pool *pgxpool.Pool,\n    urlRepo repository.URLRepository,\n    outboxRepo repository.OutboxRepository,\n    cache cache.CacheClient,\n    codegen codegen.CodeGenerator,\n    baseURL string,\n    log zerolog.Logger,\n) *URLService\n// Shorten creates a new short URL and writes a URLCreatedEvent to the outbox\n// in the same transaction. Returns the created URL entity.\n// Errors: ErrURLInvalid, ErrCodeConflict (exhausted retries → 503), DB errors.\nfunc (s *URLService) Shorten(\n    ctx context.Context,\n    originalURL string,\n    customCode string,       // empty string = auto-generate\n    expiresAt *time.Time,\n    userID string,\n    userEmail string,        // from JWT claims; embedded in URLCreatedEvent\n    correlationID string,\n) (repository.URL, error)\n// Redirect looks up a URL by short_code using the read-through cache.\n// Writes a URLClickedEvent to the outbox within a DB transaction on cache hit or miss.\n// Returns the original URL for redirect.\n// Errors: ErrURLNotFound, ErrURLExpired, ErrURLInactive.\nfunc (s *URLService) Redirect(\n    ctx context.Context,\n    shortCode string,\n    ipHash string,\n    userAgent string,\n    referer string,\n    correlationID string,\n) (originalURL string, err error)\n// ListURLs returns a cursor-paginated list of URLs owned by userID.\n// pageSize is capped at 100 internally regardless of caller input.\n// afterCursor is the UUID of the last seen URL (empty = first page).\nfunc (s *URLService) ListURLs(\n    ctx context.Context,\n    userID string,\n    afterCursor string,\n    pageSize int,\n) (urls []repository.URLSummary, nextCursor *string, err error)\n// Delete soft-deletes a URL and publishes URLDeletedEvent via outbox.\n// Invalidates the Redis cache entry as a best-effort operation.\n// Errors: ErrURLNotFound, ErrNotOwner, DB errors.\nfunc (s *URLService) Delete(\n    ctx context.Context,\n    shortCode string,\n    userID string,\n    userEmail string,\n    correlationID string,\n) error\n```\n**Sentinel errors for URLService:**\n```go\nvar (\n    ErrURLInvalid  = errors.New(\"url is invalid: must have scheme and host\")\n    ErrURLExpired  = errors.New(\"url has expired\")\n    ErrURLInactive = errors.New(\"url is inactive\")\n    ErrExhausted   = errors.New(\"short code generation exhausted: 5 collisions\")\n)\n```\n\n![urls + outbox Table Schema and Index Layout](./diagrams/tdd-diag-15.svg)\n\n---\n## 5. Algorithm Specification\n### 5.1 Base62 Code Generation\n```go\n// codegen/codegen.go\n// base62Alphabet is the character set for short codes.\n// Chosen for URL-safety and case-sensitivity.\n// Length = 62. Index → character mapping is stable and must not change.\nconst base62Alphabet = \"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\"\n// codeLength is the fixed length of auto-generated short codes.\nconst codeLength = 7\n// Generate produces a 7-character base62 string.\n// Algorithm:\n//   1. Allocate a byte slice of length 7.\n//   2. For each position i in [0, 7):\n//      a. Read 1 random byte from crypto/rand.Reader.\n//      b. Map the byte to an alphabet index: idx = byte % 62.\n//         NOTE: This introduces a tiny modulo bias (256 % 62 = 8, so indices\n//         0–7 are ~0.4% more likely). This bias is acceptable for URL shortening;\n//         it does not compromise security. For uniform distribution, use\n//         rejection sampling (discard bytes >= 248 and re-read), but this\n//         complexity is not warranted here.\n//      c. code[i] = base62Alphabet[idx]\n//   3. Return string(code), nil.\n//   4. If crypto/rand.Reader.Read fails, return \"\", fmt.Errorf(\"codegen.Generate: %w\", err).\n```\n**Implementation:**\n```go\nfunc (g *base62Generator) Generate() (string, error) {\n    buf := make([]byte, codeLength)\n    code := make([]byte, codeLength)\n    if _, err := io.ReadFull(rand.Reader, buf); err != nil {\n        return \"\", fmt.Errorf(\"codegen.Generate: %w\", err)\n    }\n    for i, b := range buf {\n        code[i] = base62Alphabet[int(b)%62]\n    }\n    return string(code), nil\n}\n```\n### 5.2 Short Code Selection with Collision Retry\n```\nPROCEDURE URLService.createShortCode(ctx, customCode string):\n  IF customCode != \"\":\n    VALIDATE customCode: len ∈ [4, 10], all chars in base62Alphabet\n    IF invalid → return \"\", ErrURLInvalid (caller maps to 400)\n    return customCode, nil  -- collision will be detected by DB unique constraint\n  FOR attempt := 1; attempt <= 5; attempt++:\n    code, err = s.codegen.Generate()\n    IF err → return \"\", fmt.Errorf(\"createShortCode: %w\", err) (→ 500)\n    -- Optimistically attempt INSERT; let the DB unique constraint catch collisions.\n    -- We do NOT pre-check existence with a SELECT — that is a TOCTOU race.\n    -- The caller (Shorten) handles ErrCodeConflict by retrying this procedure.\n    return code, nil  -- caller retries the full transaction on ErrCodeConflict\n  -- This path is reached only if the caller has retried 5 times and all failed.\n  return \"\", ErrExhausted  -- (→ 503)\nEND PROCEDURE\n```\n**Collision retry in `URLService.Shorten`:**\n```go\nconst maxCollisionRetries = 5\nfunc (s *URLService) Shorten(ctx context.Context, ...) (repository.URL, error) {\n    // ... validation ...\n    for attempt := 1; attempt <= maxCollisionRetries; attempt++ {\n        code, err := s.selectCode(ctx, customCode)\n        if err != nil {\n            return repository.URL{}, err\n        }\n        url, err := s.createURLWithOutbox(ctx, code, ...)\n        if errors.Is(err, repository.ErrCodeConflict) {\n            if customCode != \"\" {\n                // Custom code conflict is not retryable — it's a user error.\n                return repository.URL{}, fmt.Errorf(\"%w: custom code already taken\", repository.ErrCodeConflict)\n            }\n            s.log.Debug().Int(\"attempt\", attempt).Str(\"code\", code).Msg(\"short code collision; retrying\")\n            continue\n        }\n        if err != nil {\n            return repository.URL{}, err\n        }\n        return url, nil\n    }\n    return repository.URL{}, ErrExhausted\n}\n```\n### 5.3 Atomic URL + Outbox Write\n```\nPROCEDURE URLService.createURLWithOutbox(ctx, url URL, event URLCreatedEvent):\n  1. tx, err = pool.Begin(ctx)\n     IF err → return wrapped error (→ 500)\n  2. DEFER tx.Rollback(ctx)  -- no-op if Commit succeeds\n  3. err = urlRepo.Create(ctx, tx, url)\n     IF ErrCodeConflict → return ErrCodeConflict (caller retries)\n     IF other error → return wrapped error (rollback via defer)\n  4. payload, err = json.Marshal(event)\n     IF err → return wrapped error (rollback via defer)\n  5. err = outboxRepo.Insert(ctx, tx, event.EventType, payload)\n     IF err → return wrapped error (rollback via defer)\n  6. err = tx.Commit(ctx)\n     IF err → return fmt.Errorf(\"createURLWithOutbox: commit: %w\", err)\n  7. return nil\nEND PROCEDURE\n```\n**Invariant enforced:** Steps 3 and 5 execute within the same `pgx.Tx`. A crash between step 6 and the HTTP response causes the transaction to be rolled back by PostgreSQL (connection close triggers rollback). The URL does not exist; the outbox row does not exist; the client receives a connection reset — acceptable for a rare crash scenario.\n### 5.4 Redirect with Read-Through Cache\n```\nPROCEDURE URLService.Redirect(ctx, shortCode, ipHash, userAgent, referer, correlationID):\n  1. entry, err = cache.Get(ctx, shortCode)\n     IF err == nil (cache HIT):\n       IF !entry.IsActive → return \"\", ErrURLInactive\n       IF entry.ExpiresAt != nil && entry.ExpiresAt.Before(time.Now()) → return \"\", ErrURLExpired\n       -- Record click event via outbox (must still go to DB)\n       err = s.recordClick(ctx, shortCode, ipHash, userAgent, referer, correlationID)\n       IF err → log.Warn (do NOT fail the redirect); continue\n       return entry.OriginalURL, nil\n  2. -- Cache miss or Redis error; fall through to DB\n     url, err = urlRepo.FindByCode(ctx, shortCode)\n     IF ErrURLNotFound → return \"\", ErrURLNotFound\n     IF other error → return \"\", wrapped error (→ 500)\n  3. IF !url.IsActive → return \"\", ErrURLInactive\n     IF url.ExpiresAt != nil && url.ExpiresAt.Before(time.Now()) → return \"\", ErrURLExpired\n  4. -- Populate cache BEFORE recording click (faster response to next caller)\n     ttl = computeTTL(url.ExpiresAt)  -- see § 5.5\n     cache.Set(ctx, shortCode, CachedURL{\n         OriginalURL: url.OriginalURL,\n         ExpiresAt:   url.ExpiresAt,\n         IsActive:    url.IsActive,\n     }, ttl)\n  5. -- Record click event via outbox\n     err = s.recordClick(ctx, shortCode, ipHash, userAgent, referer, correlationID)\n     IF err → log.Warn (do NOT fail the redirect)\n  6. return url.OriginalURL, nil\nEND PROCEDURE\n```\n**`recordClick` — atomic click + outbox:**\n```go\nfunc (s *URLService) recordClick(ctx context.Context, shortCode, ipHash, userAgent, referer, correlationID string) error {\n    event := events.URLClickedEvent{\n        EventType:     events.EventTypeURLClicked,\n        OccurredAt:    time.Now().UTC(),\n        CorrelationID: correlationID,\n        EventID:       uuid.New().String(),\n        ShortCode:     shortCode,\n        IPHash:        ipHash,\n        UserAgent:     userAgent,\n        Referer:       referer,\n    }\n    payload, err := json.Marshal(event)\n    if err != nil {\n        return fmt.Errorf(\"recordClick marshal: %w\", err)\n    }\n    tx, err := s.pool.Begin(ctx)\n    if err != nil {\n        return fmt.Errorf(\"recordClick begin tx: %w\", err)\n    }\n    defer tx.Rollback(ctx)\n    if err = s.outboxRepo.Insert(ctx, tx, event.EventType, payload); err != nil {\n        return fmt.Errorf(\"recordClick insert outbox: %w\", err)\n    }\n    return tx.Commit(ctx)\n}\n```\n**Note on click atomicity:** The click outbox row is written in its own transaction separate from the redirect response. If the service crashes after sending the HTTP 301 but before committing this transaction, the click is lost. This is an acknowledged at-least-once tradeoff: the redirect always succeeds; the click event may occasionally be lost. To achieve true at-least-once for clicks, one would buffer the click in a pre-response transaction that also locks the URL row — too expensive for the redirect hot path. The current design is correct for this system's requirements.\n### 5.5 Cache TTL Computation\n```\nFUNCTION computeTTL(expiresAt *time.Time) time.Duration:\n  maxTTL = 1 * time.Hour\n  IF expiresAt == nil:\n    return maxTTL\n  remaining = time.Until(*expiresAt)\n  IF remaining <= 0:\n    -- URL is already expired; do not cache it.\n    -- Caller should have returned ErrURLExpired before reaching Set.\n    -- Defensive: return a very short TTL so stale data doesn't linger.\n    return 1 * time.Second\n  IF remaining < maxTTL:\n    return remaining\n  return maxTTL\n```\n**Invariant:** A Redis entry for a URL with `expires_at` set never outlives that expiry time. TTL = `min(expires_at - now(), 1h)`.\n### 5.6 Cursor-Based Pagination for `GET /urls`\n```\nPROCEDURE URLService.ListURLs(ctx, userID, afterCursor, pageSize):\n  pageSize = clamp(pageSize, 1, 100)  -- cap at 100; default 20\n  fetchLimit = pageSize + 1           -- fetch one extra to detect next page\n  rows, err = urlRepo.ListByUser(ctx, userID, afterCursor, fetchLimit)\n  IF err → return nil, nil, wrapped error\n  hasMore = len(rows) > pageSize\n  IF hasMore:\n    rows = rows[:pageSize]            -- trim the sentinel extra row\n  var nextCursor *string\n  IF hasMore:\n    lastID = rows[len(rows)-1].ID\n    nextCursor = &lastID             -- cursor is the UUID of the last returned row\n  return rows, nextCursor, nil\nEND PROCEDURE\n```\n**Why UUID cursor, not `created_at` cursor:** `created_at` values can collide (two URLs created in the same microsecond). Using the UUID `id` as the keyset cursor — with the SQL subquery fetching that row's `(created_at, id)` — is both collision-safe and avoids transmitting timestamps in the cursor parameter.\n### 5.7 Outbox Worker Pool\n```\nPROCEDURE StartOutboxPoller(ctx, pool, outboxRepo, publisher, log):\n  jobChan = make(chan OutboxEntry, 50)  -- buffered; coordinator fills, workers drain\n  -- Start 3 worker goroutines\n  FOR i := 0; i < 3; i++:\n    go outboxWorker(ctx, jobChan, outboxRepo, publisher, log)\n  -- Coordinator goroutine (this goroutine IS the coordinator)\n  FOR:\n    SELECT:\n    CASE <-ctx.Done():\n      close(jobChan)\n      return\n    CASE <-time.After(2 * time.Second):\n      entries, err = outboxRepo.FetchUnpublished(ctx, 50)\n      IF err:\n        log.Warn().Err(err).Msg(\"outbox fetch failed\")\n        continue\n      FOR each entry in entries:\n        SELECT:\n        CASE jobChan <- entry:   -- send to worker\n        CASE <-ctx.Done():\n          close(jobChan)\n          return\nEND PROCEDURE\nPROCEDURE outboxWorker(ctx, jobChan, outboxRepo, publisher, log):\n  FOR entry := range jobChan:\n    err = publisher.Publish(ctx, entry.EventType, entry.Payload)\n    IF err:\n      log.Warn().Err(err).Str(\"id\", entry.ID).Msg(\"outbox publish failed; will retry next cycle\")\n      -- Do NOT mark published. The coordinator will re-fetch this row next cycle.\n      continue\n    err = outboxRepo.MarkPublished(ctx, entry.ID)\n    IF err:\n      log.Error().Err(err).Str(\"id\", entry.ID).Msg(\"outbox mark published failed; event may be re-published\")\n      -- Event was published to RabbitMQ but the DB update failed.\n      -- On next poll, this row will be re-fetched and re-published.\n      -- This is the at-least-once guarantee: consumers must be idempotent (M4).\nEND PROCEDURE\n```\n\n![POST /shorten Atomic Transaction — Step-by-Step](./diagrams/tdd-diag-16.svg)\n\n**Channel capacity rationale:** A buffered channel of 50 matches `FetchUnpublished(ctx, 50)`. If 3 workers are slower than the coordinator (e.g., RabbitMQ is slow), the channel fills and the coordinator blocks on the `jobChan <- entry` send. This provides natural backpressure: the coordinator does not enqueue faster than workers can drain.\n### 5.8 AMQPPublisher Implementation\n```go\n// amqp/publisher.go\ntype amqpPublisher struct {\n    ch  *amqp091.Channel\n    mu  sync.Mutex // protects ch; channel is not goroutine-safe per amqp091 docs\n    log zerolog.Logger\n}\nfunc (p *amqpPublisher) Publish(ctx context.Context, routingKey string, body []byte) error {\n    p.mu.Lock()\n    defer p.mu.Unlock()\n    return p.ch.PublishWithContext(\n        ctx,\n        \"url-shortener\", // exchange\n        routingKey,\n        false,           // mandatory: false — drop if no queue bound (don't block)\n        false,           // immediate: false — deprecated in RabbitMQ 3+\n        amqp091.Publishing{\n            ContentType:  \"application/json\",\n            DeliveryMode: amqp091.Persistent, // survive broker restart\n            Body:         body,\n        },\n    )\n}\n```\n**`amqp091.Channel` thread safety:** The `amqp091` library's `Channel` is not safe for concurrent use. The `sync.Mutex` in `amqpPublisher` serializes concurrent `Publish` calls from the 3 worker goroutines. This is correct and intentional.\n\n![Base62 Code Generation Algorithm](./diagrams/tdd-diag-17.svg)\n\n---\n## 6. HTTP Handler Specification\n### 6.1 `POST /shorten` Handler\n```\nPROCEDURE HandleShorten(w, r):\n  -- Middleware: RequireAuth runs before this handler; claims are in context.\n  claims, ok = middleware.ClaimsFromContext(r.Context())\n  IF !ok → 401 (defensive; middleware should prevent this)\n  -- Parse body\n  http.MaxBytesReader(w, r.Body, 4096)\n  Decode JSON into ShortenRequest\n  IF decode error → 400 {\"error\":\"invalid request body\"}\n  -- Validate original URL\n  IF req.URL == \"\" → 400 {\"error\":\"url is required\"}\n  parsed, err = url.Parse(req.URL)\n  IF err != nil OR parsed.Scheme == \"\" OR parsed.Host == \"\" → 400 {\"error\":\"url must include scheme and host\"}\n  IF parsed.Scheme not in [\"http\",\"https\"] → 400 {\"error\":\"url scheme must be http or https\"}\n  -- Parse optional expires_at\n  var expiresAt *time.Time\n  IF req.ExpiresAt != nil:\n    t, err = time.Parse(time.RFC3339, *req.ExpiresAt)\n    IF err → 400 {\"error\":\"expires_at must be RFC3339 format\"}\n    IF t.Before(time.Now()) → 400 {\"error\":\"expires_at must be in the future\"}\n    expiresAt = &t\n  -- Extract correlation ID (set by gateway in M5; fallback for direct calls)\n  correlationID = r.Header.Get(\"X-Correlation-ID\")\n  IF correlationID == \"\" → correlationID = uuid.New().String()\n  -- Call service\n  created, err = urlService.Shorten(\n      r.Context(), req.URL, req.CustomCode, expiresAt,\n      claims.Sub, claims.Email, correlationID,\n  )\n  IF errors.Is(err, ErrURLInvalid) → 400 {\"error\": err.Error()}\n  IF errors.Is(err, repository.ErrCodeConflict) → 409 {\"error\":\"short code already taken\"}\n  IF errors.Is(err, ErrExhausted) → 503 {\"error\":\"could not generate unique code; try again\"}\n  IF err → 500 {\"error\":\"internal server error\"} + log.Error\n  -- Build response\n  shortURL = baseURL + \"/\" + created.ShortCode\n  var expiresAtStr *string\n  IF created.ExpiresAt != nil → expiresAtStr = ptr(created.ExpiresAt.Format(time.RFC3339))\n  201 ShortenResponse{ShortCode, ShortURL, OriginalURL, ExpiresAt}\nEND PROCEDURE\n```\n### 6.2 `GET /:code` Redirect Handler\n```\nPROCEDURE HandleRedirect(w, r):\n  shortCode = r.PathValue(\"code\")\n  IF shortCode == \"\" → 400 {\"error\":\"short code is required\"}\n  -- Extract request metadata for click event\n  rawIP = extractClientIP(r)  -- see § 6.2.1\n  ipHash = hashIP(rawIP)      -- SHA-256(rawIP + CLICK_SALT env var), hex-encoded\n  userAgent = r.Header.Get(\"User-Agent\")\n  referer = r.Header.Get(\"Referer\")\n  correlationID = r.Header.Get(\"X-Correlation-ID\")\n  IF correlationID == \"\" → correlationID = uuid.New().String()\n  originalURL, err = urlService.Redirect(\n      r.Context(), shortCode, ipHash, userAgent, referer, correlationID,\n  )\n  IF errors.Is(err, ErrURLNotFound) → 404 {\"error\":\"not found\"}\n  IF errors.Is(err, ErrURLExpired) → 410 {\"error\":\"this link has expired\"}\n  IF errors.Is(err, ErrURLInactive) → 410 {\"error\":\"this link is no longer active\"}\n  IF err → 500 {\"error\":\"internal server error\"} + log.Error\n  http.Redirect(w, r, originalURL, http.StatusMovedPermanently)  -- 301\nEND PROCEDURE\n```\n**§ 6.2.1 Client IP Extraction:**\n```go\nfunc extractClientIP(r *http.Request) string {\n    // Trust X-Forwarded-For only if set by a trusted proxy (the gateway).\n    // In local dev, no proxy; use RemoteAddr.\n    if xff := r.Header.Get(\"X-Forwarded-For\"); xff != \"\" {\n        // X-Forwarded-For can be \"client, proxy1, proxy2\"; take leftmost.\n        parts := strings.Split(xff, \",\")\n        return strings.TrimSpace(parts[0])\n    }\n    host, _, err := net.SplitHostPort(r.RemoteAddr)\n    if err != nil {\n        return r.RemoteAddr // fallback: return as-is\n    }\n    return host\n}\nfunc hashIP(rawIP string) string {\n    salt := os.Getenv(\"CLICK_SALT\") // if unset, uses empty salt — document in .env.example\n    h := sha256.Sum256([]byte(rawIP + salt))\n    return hex.EncodeToString(h[:])\n}\n```\n**Why 301 and not 302:** `301 Moved Permanently` allows browsers and CDNs to cache the redirect, reducing load on the service. If the URL is later deactivated, the Redis DEL and `is_active=false` handle server-side state, but cached 301s in client browsers will linger. This is an accepted tradeoff for redirect performance. If mutable redirect targets are a concern, use 302 — the spec mandates 301.\n### 6.3 `GET /urls` List Handler\n```\nPROCEDURE HandleListURLs(w, r):\n  claims, ok = middleware.ClaimsFromContext(r.Context())\n  IF !ok → 401\n  afterCursor = r.URL.Query().Get(\"after\")  -- UUID string or empty\n  pageSizeStr = r.URL.Query().Get(\"limit\")\n  pageSize = 20  -- default\n  IF pageSizeStr != \"\":\n    pageSize, err = strconv.Atoi(pageSizeStr)\n    IF err OR pageSize < 1 → 400 {\"error\":\"limit must be a positive integer\"}\n  urls, nextCursor, err = urlService.ListURLs(r.Context(), claims.Sub, afterCursor, pageSize)\n  IF err → 500 + log.Error\n  items = make([]URLItem, len(urls))\n  FOR i, u := range urls:\n    items[i] = URLItem{\n        ShortCode:   u.ShortCode,\n        OriginalURL: u.OriginalURL,\n        CreatedAt:   u.CreatedAt.Format(time.RFC3339),\n        IsActive:    u.IsActive,\n    }\n    IF u.ExpiresAt != nil → items[i].ExpiresAt = ptr(u.ExpiresAt.Format(time.RFC3339))\n  var nextCursorStr *string\n  IF nextCursor != nil → nextCursorStr = nextCursor\n  200 URLListResponse{URLs: items, NextCursor: nextCursorStr}\nEND PROCEDURE\n```\n### 6.4 `DELETE /urls/:code` Handler\n```\nPROCEDURE HandleDeleteURL(w, r):\n  claims, ok = middleware.ClaimsFromContext(r.Context())\n  IF !ok → 401\n  shortCode = r.PathValue(\"code\")\n  IF shortCode == \"\" → 400\n  correlationID = r.Header.Get(\"X-Correlation-ID\")\n  IF correlationID == \"\" → correlationID = uuid.New().String()\n  err = urlService.Delete(r.Context(), shortCode, claims.Sub, claims.Email, correlationID)\n  IF errors.Is(err, ErrURLNotFound) → 404 {\"error\":\"not found\"}\n  IF errors.Is(err, ErrNotOwner) → 403 {\"error\":\"forbidden\"}\n  IF err → 500 + log.Error\n  w.WriteHeader(http.StatusNoContent)  -- 204; no body\nEND PROCEDURE\n```\n**`URLService.Delete` logic:**\n```\nPROCEDURE URLService.Delete(ctx, shortCode, userID, userEmail, correlationID):\n  tx, err = pool.Begin(ctx)\n  IF err → return wrapped\n  DEFER tx.Rollback(ctx)\n  err = urlRepo.SoftDelete(ctx, tx, shortCode, userID)\n  IF ErrURLNotFound OR ErrNotOwner → return as-is (rollback via defer)\n  IF err → return wrapped\n  event = URLDeletedEvent{\n      EventType:     EventTypeURLDeleted,\n      OccurredAt:    time.Now().UTC(),\n      CorrelationID: correlationID,\n      ShortCode:     shortCode,\n      UserID:        userID,\n      UserEmail:     userEmail,\n  }\n  payload, _ = json.Marshal(event)  -- cannot fail for this struct\n  err = outboxRepo.Insert(ctx, tx, event.EventType, payload)\n  IF err → return wrapped (rollback via defer)\n  err = tx.Commit(ctx)\n  IF err → return wrapped\n  -- Cache invalidation: best-effort, after commit.\n  -- Do NOT do this inside the transaction — it is a different store.\n  cache.Del(ctx, shortCode)  // error swallowed inside CacheClient.Del\n  return nil\nEND PROCEDURE\n```\n\n![GET /:code Redirect — Read-Through Cache Data Flow](./diagrams/tdd-diag-18.svg)\n\n---\n## 7. Error Handling Matrix\n| Error | Detected By | HTTP Status | Response Body | Logged? | Notes |\n|---|---|---|---|---|---|\n| `URL_INVALID` (missing scheme/host) | `url.Parse` in handler | 400 | `{\"error\":\"url must include scheme and host\"}` | No | Client mistake |\n| `URL_INVALID` (non-http scheme) | handler validation | 400 | `{\"error\":\"url scheme must be http or https\"}` | No | |\n| `EXPIRES_AT_INVALID` (parse fail) | handler | 400 | `{\"error\":\"expires_at must be RFC3339 format\"}` | No | |\n| `EXPIRES_AT_IN_PAST` | handler | 400 | `{\"error\":\"expires_at must be in the future\"}` | No | |\n| `CUSTOM_CODE_CONFLICT` | `urlRepo.Create` → `23505` + custom code set | 409 | `{\"error\":\"short code already taken\"}` | No | Expected |\n| `CODE_EXHAUSTED` | `URLService.Shorten` after 5 retries | 503 | `{\"error\":\"could not generate unique code; try again\"}` | Warn | Indicates high collision rate |\n| `CODE_NOT_FOUND` | `urlRepo.FindByCode` → `ErrURLNotFound` | 404 | `{\"error\":\"not found\"}` | No | Normal |\n| `URL_EXPIRED` | `URLService.Redirect` expiry check | 410 | `{\"error\":\"this link has expired\"}` | No | |\n| `URL_INACTIVE` | `URLService.Redirect` active check | 410 | `{\"error\":\"this link is no longer active\"}` | No | |\n| `OWNERSHIP_VIOLATION` | `urlRepo.SoftDelete` → `ErrNotOwner` | 403 | `{\"error\":\"forbidden\"}` | Warn | Possible attack |\n| `CACHE_ERROR` (Redis GET) | `redisCacheClient.Get` | — | Transparent; returns `ErrCacheMiss` | Warn internally | Never causes 5xx |\n| `CACHE_ERROR` (Redis SET) | `redisCacheClient.Set` | — | Swallowed | Warn internally | |\n| `CACHE_ERROR` (Redis DEL) | `redisCacheClient.Del` | — | Swallowed | Warn internally | Best-effort |\n| `OUTBOX_PUBLISH_FAIL` | `amqpPublisher.Publish` | — | No HTTP effect | Warn in poller | Row stays unpublished; retried |\n| `OUTBOX_MARK_FAIL` | `outboxRepo.MarkPublished` | — | No HTTP effect | Error in worker | Row re-published next cycle; consumers must be idempotent |\n| `DB_ERROR` (unexpected) | any repo call | 500 | `{\"error\":\"internal server error\"}` | **Error** | Never expose details |\n| `JWT_MISSING` | `RequireAuth` middleware | 401 | `{\"error\":\"unauthorized\"}` | No | |\n| `JWT_INVALID` | `RequireAuth` middleware | 401 | `{\"error\":\"unauthorized\"}` | Warn | |\n| `REQUEST_BODY_TOO_LARGE` | `http.MaxBytesReader` | 400 | `{\"error\":\"request body too large\"}` | No | |\n| `AMQP_CHANNEL_CLOSED` | `amqpPublisher.Publish` | — | No HTTP effect | Warn | Poller retries next cycle |\n| `PORT_BIND_FAIL` | `ListenAndServe` | — | Container exits | Fatal | |\n**Consistent error response helper:**\n```go\n// handler/helpers.go\nfunc writeError(w http.ResponseWriter, status int, msg string) {\n    writeJSON(w, status, ErrorResponse{Error: msg})\n}\nfunc writeJSON(w http.ResponseWriter, status int, v any) {\n    w.Header().Set(\"Content-Type\", \"application/json\")\n    w.WriteHeader(status)\n    _ = json.NewEncoder(w).Encode(v)\n}\n```\n---\n## 8. Route Registration in `main.go`\n```go\n// services/url-service/main.go (route wiring)\nverifier := auth.NewJWTVerifier([]byte(mustGetEnv(\"JWT_SECRET\")))\nrequireAuth := middleware.RequireAuth(verifier, log)\nmux := http.NewServeMux()\n// Public routes\nmux.HandleFunc(\"GET /health\",    handler.NewHealthHandler(\"url-service\", log))\nmux.HandleFunc(\"GET /{code}\",    handler.NewRedirectHandler(urlSvc, log))\n// Protected routes\nmux.Handle(\"POST /shorten\",       requireAuth(http.HandlerFunc(handler.NewShortenHandler(urlSvc, baseURL, log))))\nmux.Handle(\"GET /urls\",           requireAuth(http.HandlerFunc(handler.NewListURLsHandler(urlSvc, log))))\nmux.Handle(\"DELETE /urls/{code}\", requireAuth(http.HandlerFunc(handler.NewDeleteURLHandler(urlSvc, log))))\n```\n**Pattern ordering note:** `GET /{code}` is a wildcard catch-all. In Go 1.22+ `net/http`, more specific patterns take priority. `GET /health` and `GET /urls` are more specific and will match first. `GET /{code}` will only match paths that do not match any more specific pattern. Register more specific patterns before the wildcard.\n\n![Redis Cache Key Layout](./diagrams/tdd-diag-19.svg)\n\n---\n## 9. Concurrency Specification\n### 9.1 HTTP Handler Goroutines\nEach request runs in its own goroutine created by `net/http`. `URLService` is stateless (all state is in the PostgreSQL pool and Redis client, which are goroutine-safe). No shared mutable state exists in handlers or service layer. `pgxpool.Pool` is goroutine-safe per pgx documentation.\n### 9.2 Outbox Worker Pool\n| Component | Goroutine Count | Shared State | Protection |\n|---|---|---|---|\n| Coordinator | 1 | `jobChan`, `outboxRepo` | Channel send is goroutine-safe; `outboxRepo` uses pool |\n| Workers | 3 | `jobChan`, `outboxRepo`, `publisher` | Channel receive is goroutine-safe; `amqpPublisher` uses `sync.Mutex` |\n| `amqpPublisher` | — | `*amqp091.Channel` | `sync.Mutex` serializes concurrent Publish calls |\n**Goroutine lifecycle:** All goroutines receive a `context.Context` derived from `context.WithCancel`. On `SIGTERM`, `main.go` calls the cancel function. The coordinator's `select` on `ctx.Done()` causes it to `close(jobChan)` and return. Workers drain the closed channel (range over closed channel yields remaining items, then exits). This provides a graceful drain: already-queued jobs are published before shutdown.\n```go\n// main.go shutdown sequence\nctx, cancel := context.WithCancel(context.Background())\ndefer cancel()\nsigCh := make(chan os.Signal, 1)\nsignal.Notify(sigCh, syscall.SIGTERM, syscall.SIGINT)\ngo poller.Start(ctx) // starts coordinator + 3 workers\n<-sigCh\nlog.Info().Msg(\"shutdown signal received\")\ncancel() // signals coordinator and workers to stop\n// Give workers up to 10s to drain the channel and finish in-flight publishes.\nshutdownCtx, shutdownCancel := context.WithTimeout(context.Background(), 10*time.Second)\ndefer shutdownCancel()\nserver.Shutdown(shutdownCtx)\n```\n### 9.3 Cache-Aside Read Safety\nMultiple concurrent redirect handlers may simultaneously experience a cache miss for the same short code. Each will independently query PostgreSQL and then call `cache.Set`. This is safe:\n- PostgreSQL reads are non-mutating (SELECT); no locking needed.\n- Concurrent `cache.Set` calls for the same key result in idempotent SET operations (last writer wins, which is acceptable — all writers have the same data from the DB).\n- No \"thundering herd\" mitigation is implemented; at the scale of this project it is unnecessary.\n\n![Outbox Worker Pool Architecture + Data Flow](./diagrams/tdd-diag-20.svg)\n\n---\n## 10. Implementation Sequence with Checkpoints\n### Phase 1 — Schema Migrations + Indexes (1–1.5 hr)\n1. Write `migrations/001_create_urls.sql` and `migrations/002_create_outbox.sql`.\n2. Apply migrations: `docker exec -i url_db psql -U url_user -d url_db < services/url-service/migrations/001_create_urls.sql`\n3. Apply: `docker exec -i url_db psql -U url_user -d url_db < services/url-service/migrations/002_create_outbox.sql`\n4. Verify schema: `docker exec url_db psql -U url_user -d url_db -c \"\\d urls\"` and `\"\\d outbox\"`.\n5. Verify indexes: `docker exec url_db psql -U url_user -d url_db -c \"\\di\"` — expect `idx_urls_short_code`, `idx_urls_user_id_created`, `idx_outbox_unpublished`.\n**Checkpoint:** Both tables exist with correct column types and NOT NULL constraints. Indexes are visible in `\\di`. `EXPLAIN SELECT * FROM urls WHERE short_code = 'abc'` shows `Index Scan` on `idx_urls_short_code`.\n### Phase 2 — Base62 Code Generator (1–1.5 hr)\n1. Add `github.com/google/uuid v1.6.0` to `go.mod` (already needed in M2; verify it's present).\n2. Write `codegen/codegen.go` with `base62Alphabet`, `codeLength`, `base62Generator`, `Generate()`.\n3. Write `codegen/codegen_test.go` (§ 11 tests).\n4. Run `go test ./codegen/... -v -count=1`.\n**Checkpoint:** `TestGenerate_Length` passes (output is always 7 chars). `TestGenerate_Base62Alphabet` passes (all chars in `base62Alphabet`). `TestGenerate_Randomness` passes (1000 calls produce no duplicates with >99.999% probability). `TestGenerate_NoCryptoMathRand` passes — verify source code import: `grep \"math/rand\" codegen/codegen.go` returns nothing.\n### Phase 3 — URLRepository + OutboxRepository (1.5–2 hr)\n1. Write `repository/url_repository.go`: `URL`, `URLSummary`, sentinel errors, `URLRepository` interface, `pgxURLRepository`, all four methods.\n2. Write `repository/outbox_repository.go`: `OutboxEntry`, `OutboxRepository` interface, `pgxOutboxRepository`, three methods.\n3. Write `repository/url_repository_test.go` and `repository/outbox_repository_test.go`.\n4. Run `go test -tags integration ./repository/... -v`.\n**Checkpoint:** `TestCreate_HappyPath` inserts a URL and finds it by code. `TestCreate_CodeConflict` returns `ErrCodeConflict`. `TestSoftDelete_WrongOwner` returns `ErrNotOwner`. `TestListByUser_Cursor` returns second page when `afterID` is set. `EXPLAIN ANALYZE` on `ListByUser` SQL shows `Index Scan` on `idx_urls_user_id_created` (no sequential scan).\n### Phase 4 — Redis CacheClient (1–1.5 hr)\n1. Write `cache/cache.go`: `CachedURL`, `RedisKey`, `CacheClient` interface, `redisCacheClient`, `Get`/`Set`/`Del`, nil-safety in every method.\n2. Write `cache/cache_test.go`.\n3. Run `go test ./cache/... -v` (unit tests use a mock or real Redis depending on tag).\n**Checkpoint:** `TestGet_CacheMiss_ReturnsErrCacheMiss` passes. `TestGet_NilClient_NoPanic` passes (nil `*redis.Client` returns `ErrCacheMiss`, no panic). `TestSet_TTLApplied` verifies the key has a TTL via `redis-cli TTL url:testcode`. `TestDel_KeyRemoved` verifies key is gone after `Del`. `TestComputeTTL_CappedAt1Hour` verifies `min(expires_at, 1h)` logic.\n### Phase 5 — POST /shorten + DELETE /urls/:code Handlers (1.5–2 hr)\n1. Write `service/url_service.go`: `URLService` struct, `NewURLService`, `Shorten`, `Delete` (stubs for `Redirect` and `ListURLs` — return `nil, ErrURLNotFound` temporarily).\n2. Write `handler/helpers.go`: `writeJSON`, `writeError`, `extractClientIP`, `hashIP`, `ptr` helper.\n3. Write `handler/shorten.go`: `NewShortenHandler`.\n4. Write `handler/delete.go`: `NewDeleteURLHandler`.\n5. Wire in `main.go`: construct all dependencies, register routes.\n6. Run `docker compose up --build url-service`.\n**Checkpoint:**\n```bash\n# Register a user first (user-service must be running)\nTOKEN=$(curl -s -X POST http://localhost:8083/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"password123\"}' | jq -r .token)\n# Shorten\ncurl -s -X POST http://localhost:8081/shorten \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer $TOKEN\" \\\n  -d '{\"url\":\"https://www.example.com/very/long/path\"}' | jq .\n# Expected: {\"short_code\":\"<7chars>\",\"short_url\":\"http://localhost:8081/<code>\",\"original_url\":\"...\"}\n# Duplicate custom code\ncurl -s -o /dev/null -w \"%{http_code}\" -X POST http://localhost:8081/shorten \\\n  -H \"Authorization: Bearer $TOKEN\" -H \"Content-Type: application/json\" \\\n  -d '{\"url\":\"https://example.org\",\"custom_code\":\"<same_code>\"}'\n# Expected: 409\n# Delete\ncurl -s -o /dev/null -w \"%{http_code}\" -X DELETE http://localhost:8081/urls/<code> \\\n  -H \"Authorization: Bearer $TOKEN\"\n# Expected: 204\n```\n### Phase 6 — GET /:code Redirect (1.5–2 hr)\n1. Implement `URLService.Redirect` in `service/url_service.go` (§ 5.4).\n2. Write `handler/redirect.go`: `NewRedirectHandler`.\n3. Register `GET /{code}` in `main.go`.\n4. Run `docker compose up --build url-service`.\n**Checkpoint:**\n```bash\nCODE=$(curl -s -X POST http://localhost:8081/shorten \\\n  -H \"Authorization: Bearer $TOKEN\" -H \"Content-Type: application/json\" \\\n  -d '{\"url\":\"https://www.google.com\"}' | jq -r .short_code)\n# Redirect (follow → expect google.com)\ncurl -v \"http://localhost:8081/$CODE\" 2>&1 | grep \"< HTTP\\|< Location\"\n# Expected: HTTP/1.1 301, Location: https://www.google.com\n# Cache hit (second request)\ncurl -v \"http://localhost:8081/$CODE\" 2>&1 | grep \"< HTTP\"\n# Redis: redis-cli GET \"url:$CODE\" → returns JSON\n# Non-existent code\ncurl -s -o /dev/null -w \"%{http_code}\" \"http://localhost:8081/ZZZZZZZ\"\n# Expected: 404\n# Run benchmark\ngo test -bench=BenchmarkRedirectCacheHit -benchtime=10s ./handler/...\n# Target: < 5ms p99 at 100 concurrent (see § 9 for benchmark setup)\n```\n### Phase 7 — GET /urls Cursor Pagination (1–1.5 hr)\n1. Implement `URLService.ListURLs` in `service/url_service.go` (§ 5.6).\n2. Write `handler/list.go`: `NewListURLsHandler`.\n3. Register `GET /urls` in `main.go`.\n**Checkpoint:**\n```bash\n# Create 5 URLs\nfor i in {1..5}; do\n  curl -s -X POST http://localhost:8081/shorten \\\n    -H \"Authorization: Bearer $TOKEN\" -H \"Content-Type: application/json\" \\\n    -d \"{\\\"url\\\":\\\"https://example.com/$i\\\"}\" > /dev/null\ndone\n# First page (limit=2)\nRESP=$(curl -s \"http://localhost:8081/urls?limit=2\" -H \"Authorization: Bearer $TOKEN\")\necho $RESP | jq '.urls | length'  # Expected: 2\nCURSOR=$(echo $RESP | jq -r '.next_cursor')  # non-null\n# Second page\ncurl -s \"http://localhost:8081/urls?limit=2&after=$CURSOR\" \\\n  -H \"Authorization: Bearer $TOKEN\" | jq '.urls | length'  # Expected: 2\n# Verify no seq scan\ndocker exec url_db psql -U url_user -d url_db -c \\\n  \"EXPLAIN SELECT id, short_code FROM urls WHERE user_id = 'some-uuid' ORDER BY created_at DESC LIMIT 3;\"\n# Must show \"Index Scan\" not \"Seq Scan\"\n```\n### Phase 8 — Outbox Worker Pool + AMQPPublisher (2–2.5 hr)\n1. Write `amqp/publisher.go`: `AMQPPublisher` interface, `amqpPublisher` with `sync.Mutex`, `Publish`.\n2. Write `outbox/poller.go`: `OutboxPoller` struct, `Start(ctx context.Context)` (launches coordinator + 3 workers).\n3. Wire poller in `main.go`: construct `AMQPPublisher`, construct `OutboxPoller`, call `go poller.Start(ctx)`.\n4. Run `docker compose up --build url-service`.\n**Checkpoint:**\n```bash\n# Create a URL (writes outbox row)\ncurl -s -X POST http://localhost:8081/shorten \\\n  -H \"Authorization: Bearer $TOKEN\" -H \"Content-Type: application/json\" \\\n  -d '{\"url\":\"https://www.rabbitmq-test.com\"}'\n# Wait 3 seconds for poller cycle\nsleep 3\n# Verify outbox row is marked published\ndocker exec url_db psql -U url_user -d url_db -c \\\n  \"SELECT event_type, published_at FROM outbox ORDER BY created_at DESC LIMIT 1;\"\n# Expected: published_at IS NOT NULL\n# Verify message in RabbitMQ management UI:\n# http://localhost:15672 → Queues → notifications.events → Get Messages\n# Should see URLCreatedEvent payload\n# Test RabbitMQ down: stop broker, create URL, verify service stays healthy\ndocker compose stop rabbitmq\ncurl -s -o /dev/null -w \"%{http_code}\" -X POST http://localhost:8081/shorten \\\n  -H \"Authorization: Bearer $TOKEN\" -H \"Content-Type: application/json\" \\\n  -d '{\"url\":\"https://resilience-test.com\"}'\n# Expected: 201 (not 503)\ndocker compose start rabbitmq\nsleep 15  # reconnect + poll cycle\ndocker exec url_db psql -U url_user -d url_db -c \\\n  \"SELECT count(*) FROM outbox WHERE published_at IS NULL;\"\n# Expected: 0\n```\n### Phase 9 — Unit Tests + Benchmarks (1–1.5 hr)\n1. Write all test files from § 11.\n2. Run `go test ./... -v -count=1`.\n3. Run benchmarks: `go test -bench=. -benchmem ./...`.\n**Checkpoint:** All tests pass. `BenchmarkRedirectCacheHit` shows p99 < 5ms at 100 concurrent. `BenchmarkRedirectCacheMiss` shows p99 < 20ms. `go vet ./...` clean. `go test -race ./...` clean (no race conditions).\n\n![Outbox Poller State Machine](./diagrams/tdd-diag-21.svg)\n\n---\n## 11. Test Specification\n### 11.1 `codegen/codegen_test.go`\n```go\n// TestGenerate_Length: Generate() always returns exactly 7 characters.\n// Run 1000 times; assert len(code) == 7 for all.\nfunc TestGenerate_Length(t *testing.T)\n// TestGenerate_Base62Alphabet: every character in generated code is in base62Alphabet.\n// Run 1000 times; assert each char exists in the alphabet string.\nfunc TestGenerate_Base62Alphabet(t *testing.T)\n// TestGenerate_Randomness: 1000 consecutive calls produce no duplicates.\n// Failure probability: 62^7 = 3.5 trillion; collision among 1000 is negligible.\nfunc TestGenerate_Randomness(t *testing.T)\n// TestGenerate_NotMathRand: verify crypto/rand is used.\n// Indirect test: seed math/rand with a fixed seed; if codes match the seeded sequence,\n// math/rand is being used (fail). This is a code review check, not runtime check —\n// document in test comment that the import list must not contain \"math/rand\".\nfunc TestGenerate_NoMathRandImport(t *testing.T) // parse AST or grep imports\n// TestGenerate_CollisionRetryIn_URLService:\n// Inject a mock CodeGenerator that returns the same code for the first 4 calls,\n// then a unique code on the 5th. Verify URLService.Shorten succeeds with 5th code.\nfunc TestShorten_CollisionRetry(t *testing.T)\n// TestShorten_CollisionExhausted:\n// Inject a mock CodeGenerator that always returns the same code (DB always rejects).\n// Verify URLService.Shorten returns ErrExhausted after 5 attempts.\nfunc TestShorten_CollisionExhausted(t *testing.T)\n// BenchmarkGenerate: measure throughput.\n// Expected: > 100,000 Generate() calls/sec (pure in-memory; should be fast).\nfunc BenchmarkGenerate(b *testing.B)\n```\n### 11.2 `repository/url_repository_test.go` (integration)\n```go\n// Build tag: //go:build integration\n// Requires: url_db running. DSN from TEST_DATABASE_DSN env var.\n// TestCreate_HappyPath: create URL → FindByCode returns same data.\nfunc TestCreate_HappyPath(t *testing.T)\n// TestCreate_CodeConflict: create two URLs with same short_code → second returns ErrCodeConflict.\nfunc TestCreate_CodeConflict(t *testing.T)\n// TestCreate_InTransaction_RollbackOnError:\n// Begin tx, Create URL, DON'T commit. In separate connection, FindByCode → ErrURLNotFound.\n// Verifies that uncommitted tx is not visible.\nfunc TestCreate_InTransaction_RollbackOnError(t *testing.T)\n// TestFindByCode_NotFound: ErrURLNotFound for unknown code.\nfunc TestFindByCode_NotFound(t *testing.T)\n// TestSoftDelete_HappyPath: SoftDelete sets is_active=false; FindByCode returns is_active=false.\nfunc TestSoftDelete_HappyPath(t *testing.T)\n// TestSoftDelete_WrongOwner: SoftDelete with wrong userID returns ErrNotOwner.\nfunc TestSoftDelete_WrongOwner(t *testing.T)\n// TestSoftDelete_NotFound: SoftDelete on non-existent code returns ErrURLNotFound.\nfunc TestSoftDelete_NotFound(t *testing.T)\n// TestListByUser_EmptyCursor: first page returns newest-first order.\nfunc TestListByUser_EmptyCursor(t *testing.T)\n// TestListByUser_WithCursor: second page starts after cursor row.\nfunc TestListByUser_WithCursor(t *testing.T)\n// TestListByUser_UsesIndex: EXPLAIN on the query must not contain \"Seq Scan\".\n// Use pgx to execute EXPLAIN and assert output.\nfunc TestListByUser_UsesIndex(t *testing.T)\n```\n### 11.3 `repository/outbox_repository_test.go` (integration)\n```go\n// TestInsert_HappyPath: Insert outbox row in tx, commit, FetchUnpublished returns it.\nfunc TestInsert_HappyPath(t *testing.T)\n// TestInsert_RollsBackWithCaller: Insert in tx, rollback → FetchUnpublished returns empty.\nfunc TestInsert_RollsBackWithCaller(t *testing.T)\n// TestFetchUnpublished_Limit: Insert 60 rows, FetchUnpublished(50) returns exactly 50.\nfunc TestFetchUnpublished_Limit(t *testing.T)\n// TestMarkPublished_IdempotentOnDouble: call MarkPublished twice on same ID → no error.\nfunc TestMarkPublished_IdempotentOnDouble(t *testing.T)\n// TestFetchUnpublished_ExcludesPublished: published rows not returned.\nfunc TestFetchUnpublished_ExcludesPublished(t *testing.T)\n```\n### 11.4 `cache/cache_test.go`\n```go\n// Unit tests using a real Redis (TEST_REDIS_ADDR) or mock; nil-client tests are pure unit.\n// TestGet_NilClient_ReturnsMiss: nil *redis.Client → ErrCacheMiss, no panic.\nfunc TestGet_NilClient_ReturnsMiss(t *testing.T)\n// TestSet_NilClient_NoOp: nil *redis.Client → Set returns without panic.\nfunc TestSet_NilClient_NoOp(t *testing.T)\n// TestDel_NilClient_NoOp: nil *redis.Client → Del returns without panic.\nfunc TestDel_NilClient_NoOp(t *testing.T)\n// TestGet_Miss_ReturnsErrCacheMiss: key not in Redis → ErrCacheMiss.\nfunc TestGet_Miss_ReturnsErrCacheMiss(t *testing.T)\n// TestSetGet_RoundTrip: Set then Get returns same CachedURL.\nfunc TestSetGet_RoundTrip(t *testing.T)\n// TestSet_TTLApplied: after Set, redis-cli TTL shows positive value ≤ requested TTL.\nfunc TestSet_TTLApplied(t *testing.T)\n// TestDel_RemovesKey: Set then Del → Get returns ErrCacheMiss.\nfunc TestDel_RemovesKey(t *testing.T)\n// TestComputeTTL_NoExpiry: expiresAt=nil → returns 1h.\nfunc TestComputeTTL_NoExpiry(t *testing.T)\n// TestComputeTTL_ExpiryWithin1h: expiresAt=30min from now → returns ~30min.\nfunc TestComputeTTL_ExpiryWithin1h(t *testing.T)\n// TestComputeTTL_ExpiryBeyond1h: expiresAt=2h from now → returns 1h.\nfunc TestComputeTTL_ExpiryBeyond1h(t *testing.T)\n// TestComputeTTL_AlreadyExpired: expiresAt=past → returns 1s (defensive).\nfunc TestComputeTTL_AlreadyExpired(t *testing.T)\n```\n### 11.5 `handler/handler_test.go` (integration + unit)\n```go\n// Unit tests use httptest.NewRecorder + httptest.NewRequest.\n// Integration tests tag: //go:build integration\n// TestShorten_HappyPath: valid JWT + valid URL → 201, short_code is 7-char base62.\nfunc TestShorten_HappyPath(t *testing.T)\n// TestShorten_NoAuth: missing Authorization → 401.\nfunc TestShorten_NoAuth(t *testing.T)\n// TestShorten_InvalidURL_MissingScheme: \"example.com\" (no https://) → 400.\nfunc TestShorten_InvalidURL_MissingScheme(t *testing.T)\n// TestShorten_ExpiresAtPast: expires_at in past → 400.\nfunc TestShorten_ExpiresAtPast(t *testing.T)\n// TestRedirect_CacheHit: set key in Redis, GET /:code → 301, Location matches.\nfunc TestRedirect_CacheHit(t *testing.T)\n// TestRedirect_CacheMiss_DBFallback: no Redis key, URL in DB → 301, Redis populated.\nfunc TestRedirect_CacheMiss_DBFallback(t *testing.T)\n// TestRedirect_NotFound: unknown code → 404.\nfunc TestRedirect_NotFound(t *testing.T)\n// TestRedirect_Expired: expires_at in past → 410.\nfunc TestRedirect_Expired(t *testing.T)\n// TestRedirect_Inactive: is_active=false → 410.\nfunc TestRedirect_Inactive(t *testing.T)\n// TestDelete_HappyPath: owner deletes URL → 204, Redis key gone.\nfunc TestDelete_HappyPath(t *testing.T)\n// TestDelete_WrongOwner: different JWT sub → 403.\nfunc TestDelete_WrongOwner(t *testing.T)\n// TestDelete_NotFound: non-existent code → 404.\nfunc TestDelete_NotFound(t *testing.T)\n// TestListURLs_Pagination: create 5, page by 2, verify cursor chain covers all 5.\nfunc TestListURLs_Pagination(t *testing.T)\n// BenchmarkRedirectCacheHit: serve redirect from Redis cache at 100 concurrent.\n// Uses httptest.Server with a pre-seeded Redis entry.\n// Assert: p99 latency < 5ms.\nfunc BenchmarkRedirectCacheHit(b *testing.B)\n// BenchmarkRedirectCacheMiss: serve redirect from PostgreSQL (Redis disabled).\n// Assert: p99 latency < 20ms.\nfunc BenchmarkRedirectCacheMiss(b *testing.B)\n```\n**Benchmark implementation sketch:**\n```go\nfunc BenchmarkRedirectCacheHit(b *testing.B) {\n    // Setup: real Redis with seeded URL entry, real DB with URL row.\n    // Use httptest.NewServer with the handler under test.\n    srv := httptest.NewServer(handler.NewRedirectHandler(urlSvc, log))\n    defer srv.Close()\n    b.ResetTimer()\n    b.SetParallelism(100)\n    b.RunParallel(func(pb *testing.PB) {\n        for pb.Next() {\n            resp, err := http.Get(srv.URL + \"/\" + seededCode)\n            if err != nil { b.Fatal(err) }\n            resp.Body.Close()\n            if resp.StatusCode != http.StatusMovedPermanently {\n                b.Fatalf(\"unexpected status: %d\", resp.StatusCode)\n            }\n        }\n    })\n    // Use b.ReportMetric to record p99 if using a custom histogram.\n}\n```\n\n![Cursor-Based Pagination Algorithm for GET /urls](./diagrams/tdd-diag-22.svg)\n\n---\n## 12. Environment Variable Reference\n| Variable | Required | Example | Description |\n|---|---|---|---|\n| `PORT` | Yes | `8081` | HTTP listen port |\n| `SERVICE_NAME` | Yes | `url-service` | Embedded in log lines |\n| `DATABASE_DSN` | Yes | `postgres://url_user:url_secret@url_db:5432/url_db?sslmode=disable` | PostgreSQL connection |\n| `REDIS_ADDR` | Yes | `redis:6379` | Redis address; unavailability is non-fatal |\n| `RABBITMQ_URL` | Yes | `amqp://admin:admin@rabbitmq:5672/` | AMQP broker |\n| `JWT_SECRET` | Yes | `change-me-32-bytes-minimum!!!!!!` | JWT verification (not signing — url-service never issues tokens) |\n| `BASE_URL` | Yes | `http://localhost:8081` | Prepended to short_code in API response `short_url` |\n| `CLICK_SALT` | No | `random-salt-value` | Salt for IP hashing. Empty string if unset — document in `.env.example` |\n**`BASE_URL` in production** would be the public domain (e.g., `https://short.example.com`). In docker-compose it is the gateway's public URL. For this milestone, use the service's own URL; update to the gateway URL in M5.\n**Add to `docker-compose.yml`** for url-service:\n```yaml\nenvironment:\n  JWT_SECRET: \"change-me-to-at-least-32-random-bytes\"\n  BASE_URL: \"http://localhost:8081\"\n  CLICK_SALT: \"replace-with-random-value\"\n```\n---\n## 13. Performance Targets\n| Operation | Target | How to Measure |\n|---|---|---|\n| `GET /:code` cache hit p99 | < 5ms | `go test -bench=BenchmarkRedirectCacheHit -benchtime=30s ./handler/...` at 100 parallel |\n| `GET /:code` cache miss p99 | < 20ms | `go test -bench=BenchmarkRedirectCacheMiss -benchtime=30s ./handler/...` |\n| `POST /shorten` p99 | < 50ms | `wrk -t4 -c20 -d30s -s shorten.lua http://localhost:8081/shorten` |\n| Outbox poll lag (write → publish) | < 4s | Create URL, measure time until `published_at IS NOT NULL` in DB |\n| `codegen.Generate()` throughput | > 100,000/sec | `go test -bench=BenchmarkGenerate ./codegen/...` |\n| `ListURLs` cursor query | No seq scan | `EXPLAIN ANALYZE` on list query; assert `Index Scan` on `idx_urls_user_id_created` |\n| `GET /urls` p99 (20-item page) | < 15ms | `wrk -t2 -c10 -d10s` with valid JWT |\n| Container image size | < 20MB | `docker image ls url-service` |\n| `go build ./...` incremental | < 10s | CI warm build |\n| Outbox worker pool drain on shutdown | < 10s | Send SIGTERM; measure time until in-flight jobs complete |\n---\n## 14. Anti-Pattern Guard Rail Checklist\nBefore completing this milestone, verify:\n- [ ] **No synchronous call to analytics-service or notification-service.** `grep -r \"analytics-service\\|notification-service\" services/url-service/` returns nothing except comments.\n- [ ] **No shared database.** `services/url-service/` contains zero references to `analytics_db`, `user_db`, or `notification_db` connection strings.\n- [ ] **`math/rand` is not imported.** `grep -r '\"math/rand\"' services/url-service/codegen/` returns nothing. Only `crypto/rand` is used.\n- [ ] **No dual-write (URL insert and outbox insert in separate transactions).** The `createURLWithOutbox` function calls `pool.Begin` once and passes the same `pgx.Tx` to both `urlRepo.Create` and `outboxRepo.Insert`.\n- [ ] **Redis error never causes 5xx.** `CacheClient.Get` returns `ErrCacheMiss` (not a real error) for all Redis failures. Handlers treat `ErrCacheMiss` as a DB-fallback signal.\n- [ ] **`expires_at` TTL applied to Redis entries.** `cache.Set` is never called with `ttl=0` or a negative duration. `computeTTL` returns at minimum `1 * time.Second`.\n- [ ] **Cache invalidated on DELETE.** `URLService.Delete` calls `cache.Del` after `tx.Commit`. Order is: commit → invalidate (never invalidate before commit; that would create a window where the DB has the old state and the cache is empty, causing a stale repopulation).\n- [ ] **Ownership check on DELETE.** `urlRepo.SoftDelete` accepts `ownerID` and returns `ErrNotOwner` if mismatch. The handler maps this to 403.\n- [ ] **Worker pool, not a single goroutine.** `outbox/poller.go` starts exactly 3 worker goroutines. Verify with `grep \"go outboxWorker\" outbox/poller.go` → 3 calls in a loop.\n- [ ] **No outbox polling with `time.Sleep` in workers.** Workers block on `range jobChan`. Only the coordinator uses `time.After(2s)`. Workers have no sleep/timer.\n\n![DELETE /urls/:code Sequence — Ownership Check + Cache Invalidation](./diagrams/tdd-diag-23.svg)\n\n---\n<!-- END_TDD_MOD -->\n\n\n<!-- TDD_MOD_ID: url-shortener-m4 -->\n# Technical Design Specification\n## Module: Analytics Service — Click Ingestion + Stats API\n**Module ID:** `url-shortener-m4`\n---\n## 1. Module Charter\nThe Analytics Service is a pure downstream consumer within the URL shortener system. It ingests `URLClickedEvent` messages from the RabbitMQ queue `analytics.clicks`, stores privacy-preserving click records in its private PostgreSQL database, detects click milestone thresholds (10, 100, 1000), and exposes a read-only HTTP stats API. It is the exclusive owner of the `analytics_db` PostgreSQL instance — no other service reads or writes to it.\nThis module does **not** call the URL Service to validate short codes. It does **not** call the User Service to resolve user identities. It does **not** share any database schema with any other service. It does **not** issue JWTs or perform authentication — the stats API (`GET /stats/:code`) is intentionally public with no auth requirement per the project spec. It does **not** implement fan-out reads, materialized views, or any form of caching for stats queries (indexed PostgreSQL queries are sufficient at this scale).\n**Upstream dependencies:** M1 foundation (Docker Compose stack, `shared/events`, `shared/logger`); RabbitMQ exchange `url-shortener` (topic) declared by url-service (M3). The `analytics.clicks` queue is declared and bound by this service's own startup code — the consumer is responsible for its own queue declaration. The `MilestoneReachedEvent` struct is defined in `shared/events` (M1).\n**Downstream dependencies:** notification-service (M5) consumes `MilestoneReachedEvent` published by this service. No other service depends on analytics-service at runtime.\n**Invariants that must always hold after this milestone:**\n- A `URLClickedEvent` with a given `EventID` is inserted into the `clicks` table at most once, regardless of how many times RabbitMQ delivers it. The `processed_events` deduplication table is the enforcement mechanism.\n- Every click insertion, idempotency mark, and optional milestone insertion execute within a single PostgreSQL transaction. A crash between DB commit and RabbitMQ ACK causes re-delivery; the idempotency check makes re-processing a no-op.\n- A poison message (malformed JSON, missing required fields) is always ACKed and never requeued. It is logged at `error` level. The consumer loop never panics.\n- `GET /health` returns 200 even when the RabbitMQ consumer is paused or the connection is down. Consumer health is degraded, not fatal.\n- Raw IP addresses are never stored. The `ip_hash` field on `URLClickedEvent` (computed by url-service) is stored as-is — analytics-service never sees or stores plaintext IPs.\n---\n## 2. File Structure\nCreate files in the numbered order below. All paths are relative to the monorepo root.\n```\nurl-shortener/\n│\n└── services/analytics-service/\n    ├── migrations/\n    │   ├── 01  001_create_clicks.sql\n    │   ├── 02  002_create_milestones.sql\n    │   └── 03  003_create_processed_events.sql\n    ├── repository/\n    │   ├── 04  click_repository.go\n    │   ├── 05  click_repository_test.go\n    │   ├── 06  processed_event_repository.go\n    │   ├── 07  processed_event_repository_test.go\n    │   ├── 08  milestone_repository.go\n    │   └── 09  milestone_repository_test.go\n    ├── consumer/\n    │   ├── 10  consumer.go              # AMQPConsumer interface + amqp091 implementation\n    │   ├── 11  processor.go             # ClickProcessor: idempotency + insert + milestone\n    │   └── 12  processor_test.go\n    ├── milestone/\n    │   ├── 13  detector.go              # MilestoneDetector: threshold logic\n    │   └── 14  detector_test.go\n    ├── publisher/\n    │   ├── 15  publisher.go             # AMQPPublisher for MilestoneReachedEvent\n    │   └── 16  publisher_test.go\n    ├── handler/\n    │   ├── 17  stats.go                 # GET /stats/:code\n    │   ├── 18  timeline.go             # GET /stats/:code/timeline\n    │   ├── 19  health.go               # GET /health\n    │   ├── 20  helpers.go              # writeJSON, writeError\n    │   └── 21  handler_test.go\n    └── 22  main.go\n```\n**Total new files: 22** (excluding auto-generated `go.sum` changes).\n---\n## 3. Complete Data Model\n### 3.1 PostgreSQL Schema — `migrations/001_create_clicks.sql`\n```sql\n-- migrations/001_create_clicks.sql\nBEGIN;\nCREATE TABLE IF NOT EXISTS clicks (\n    id          UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n    short_code  TEXT        NOT NULL,\n    clicked_at  TIMESTAMPTZ NOT NULL,\n    ip_hash     TEXT        NOT NULL,    -- SHA-256(ip+salt) from url-service; never raw IP\n    user_agent  TEXT        NOT NULL DEFAULT '',\n    referer     TEXT        NULL        -- NULL = no Referer header present\n);\n-- Primary analytics query: count/aggregate clicks for a short_code ordered by time.\n-- Covers: total_clicks, clicks_last_24h, clicks_last_7d, timeline bucketing.\nCREATE INDEX IF NOT EXISTS idx_clicks_short_code_time\n    ON clicks(short_code, clicked_at DESC);\n-- Referer stats query: top referers for a short_code where referer is not null.\n-- Partial index keeps size small (many clicks have NULL referer).\nCREATE INDEX IF NOT EXISTS idx_clicks_referer\n    ON clicks(short_code, referer)\n    WHERE referer IS NOT NULL;\nCOMMIT;\n```\n**Field rationale:**\n- `short_code TEXT NOT NULL`: No FK to urls table — analytics-service owns no url data. Trusts the event payload. TEXT avoids the 10-char VARCHAR limit if future short codes change length.\n- `clicked_at TIMESTAMPTZ NOT NULL`: The timestamp of the original click as embedded in `URLClickedEvent.OccurredAt`, not `now()`. Using event time (not ingestion time) gives accurate time-series analytics regardless of consumer lag.\n- `ip_hash TEXT NOT NULL`: Already hashed by url-service. Analytics-service is never in possession of raw IPs. Storing the hash enables (future) per-IP deduplication without privacy violation.\n- `referer TEXT NULL`: Absent `Referer` header is stored as NULL, not empty string. This allows the partial index `WHERE referer IS NOT NULL` to exclude the majority of rows from the referer-stats index.\n- `user_agent TEXT NOT NULL DEFAULT ''`: Empty string when `User-Agent` header was absent. Default prevents NOT NULL violations on events from non-browser clients.\n### 3.2 PostgreSQL Schema — `migrations/002_create_milestones.sql`\n```sql\n-- migrations/002_create_milestones.sql\nBEGIN;\nCREATE TABLE IF NOT EXISTS milestones (\n    id           UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n    short_code   TEXT        NOT NULL,\n    milestone    INT         NOT NULL,       -- 10 | 100 | 1000\n    triggered_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n    UNIQUE (short_code, milestone)           -- each threshold crossed at most once per code\n);\n-- Query: \"what is the highest milestone already triggered for this code?\"\nCREATE INDEX IF NOT EXISTS idx_milestones_short_code\n    ON milestones(short_code, milestone DESC);\nCOMMIT;\n```\n**Field rationale:**\n- `UNIQUE (short_code, milestone)`: Prevents duplicate milestone rows from concurrent processing or re-delivery. If two consumers race to detect the same milestone, the second `INSERT` fails on the unique constraint — the caller catches this and treats it as a no-op (milestone already recorded).\n- `milestone INT`: Stored as plain integer (10, 100, 1000) for query simplicity. Not stored as an enum because the set of thresholds may expand (10,000 etc.) without schema changes.\n### 3.3 PostgreSQL Schema — `migrations/003_create_processed_events.sql`\n```sql\n-- migrations/003_create_processed_events.sql\nBEGIN;\nCREATE TABLE IF NOT EXISTS processed_events (\n    event_id    UUID        PRIMARY KEY,    -- = URLClickedEvent.EventID\n    processed_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n-- The PRIMARY KEY on event_id is itself the index used by IsProcessed SELECT.\n-- No additional index needed.\nCOMMIT;\n```\n**Field rationale:**\n- `event_id UUID PRIMARY KEY`: The `EventID` from `URLClickedEvent` is the deduplication key. UUID PKs have B-tree index by default — `SELECT 1 FROM processed_events WHERE event_id = $1` uses an index scan in O(log n). No separate index is needed.\n- `processed_at TIMESTAMPTZ`: Audit field. Useful for debugging and for a future cleanup job that purges old dedup entries (not implemented in this milestone).\n- **No FK to clicks.id**: Intentional. The idempotency check is independent of the click row — if `MarkProcessed` succeeds but `Insert` fails, the event is marked processed but not inserted. This edge case is handled by inserting the click *before* marking processed within the same transaction (see § 5.2).\n### 3.4 Go Structs\n```go\n// repository/click_repository.go\npackage repository\nimport \"time\"\n// Click is a single recorded redirect event stored in the clicks table.\n// Fields map 1:1 to table columns; no derived fields.\ntype Click struct {\n    ID        string    // UUID v4; generated by DB DEFAULT\n    ShortCode string    // matches URLClickedEvent.ShortCode\n    ClickedAt time.Time // from URLClickedEvent.OccurredAt (event time, not ingestion time)\n    IPHash    string    // from URLClickedEvent.IPHash; never the raw IP\n    UserAgent string    // from URLClickedEvent.UserAgent; empty string if absent\n    Referer   string    // from URLClickedEvent.Referer; empty string means NULL in DB\n}\n// RefererCount is a single row returned by TopReferers.\ntype RefererCount struct {\n    Referer string\n    Count   int64\n}\n// PeriodCount is a single row returned by Timeline.\ntype PeriodCount struct {\n    Period string // ISO 8601 formatted truncated timestamp; \"2026-03-02T14:00:00Z\" for hour, \"2026-03-02\" for day\n    Clicks int64\n}\n```\n```go\n// repository/milestone_repository.go\npackage repository\nimport \"time\"\n// Milestone records a click count threshold crossing for a short_code.\ntype Milestone struct {\n    ID          string\n    ShortCode   string\n    Milestone   int       // 10 | 100 | 1000\n    TriggeredAt time.Time\n}\n```\n```go\n// repository/processed_event_repository.go\npackage repository\nimport \"time\"\n// ProcessedEvent is a deduplication record.\ntype ProcessedEvent struct {\n    EventID     string    // UUID string; matches URLClickedEvent.EventID\n    ProcessedAt time.Time\n}\n```\n```go\n// consumer/processor.go — internal processing types\n// ProcessResult describes the outcome of processing one AMQP delivery.\ntype ProcessResult int\nconst (\n    ProcessResultInserted    ProcessResult = iota // new event; click row inserted\n    ProcessResultDuplicate                        // event_id already in processed_events; skipped\n    ProcessResultPoisoned                         // malformed message; ACKed, not inserted\n    ProcessResultError                            // transient DB/infra error; NACKed with requeue\n)\n```\n```go\n// handler/ — API response types\n// StatsResponse is the JSON body returned by GET /stats/:code.\ntype StatsResponse struct {\n    ShortCode      string         `json:\"short_code\"`\n    TotalClicks    int64          `json:\"total_clicks\"`\n    ClicksLast24h  int64          `json:\"clicks_last_24h\"`\n    ClicksLast7d   int64          `json:\"clicks_last_7d\"`\n    TopReferers    []RefererItem  `json:\"top_referers\"`    // up to 5 entries; empty array if none\n}\n// RefererItem is a single entry in StatsResponse.TopReferers.\ntype RefererItem struct {\n    Referer string `json:\"referer\"`\n    Count   int64  `json:\"count\"`\n}\n// TimelineResponse is the JSON body returned by GET /stats/:code/timeline.\ntype TimelineResponse struct {\n    ShortCode string          `json:\"short_code\"`\n    Interval  string          `json:\"interval\"` // \"day\" | \"hour\"\n    Points    []TimelinePoint `json:\"points\"`   // ordered oldest-first\n}\n// TimelinePoint is a single bucket in the timeline.\ntype TimelinePoint struct {\n    Period string `json:\"period\"` // ISO 8601 string\n    Clicks int64  `json:\"clicks\"`\n}\n// ErrorResponse is the JSON body for all 4xx/5xx responses.\ntype ErrorResponse struct {\n    Error string `json:\"error\"`\n}\n```\n\n![Analytics Service Module Architecture](./diagrams/tdd-diag-24.svg)\n\n---\n## 4. Interface Contracts\n### 4.1 `ClickRepository`\n```go\n// repository/click_repository.go\n// ClickRepository defines persistence operations for click records.\n// Implementations must be safe for concurrent use.\ntype ClickRepository interface {\n    // Insert writes a new click row within the provided transaction tx.\n    // tx must be non-nil; Insert is always called inside the idempotency transaction.\n    // click.Referer == \"\" is stored as NULL (the implementation converts empty → NULL).\n    // Returns a wrapped error on DB failure; no sentinel errors defined.\n    Insert(ctx context.Context, tx pgx.Tx, click Click) error\n    // CountByCode returns the total number of clicks for shortCode.\n    // Uses the pool (no transaction); reads committed data.\n    // Returns 0, nil if no rows exist (not an error).\n    CountByCode(ctx context.Context, shortCode string) (int64, error)\n    // CountSince returns the number of clicks for shortCode with\n    // clicked_at >= since (inclusive). Uses idx_clicks_short_code_time.\n    // Returns 0, nil if no rows match.\n    CountSince(ctx context.Context, shortCode string, since time.Time) (int64, error)\n    // TopReferers returns up to limit referers with their click counts,\n    // ordered by count DESC, for the given shortCode.\n    // Only rows where referer IS NOT NULL are considered.\n    // Returns an empty slice (not nil) if no referer rows exist.\n    TopReferers(ctx context.Context, shortCode string, limit int) ([]RefererCount, error)\n    // Timeline returns aggregated click counts bucketed by interval.\n    // interval must be \"day\" or \"hour\" — callers validate before calling.\n    // Returns rows ordered by period ASC (oldest first).\n    // Uses PostgreSQL date_trunc(interval, clicked_at AT TIME ZONE 'UTC').\n    // Returns an empty slice (not nil) if no rows exist.\n    Timeline(ctx context.Context, shortCode string, interval string) ([]PeriodCount, error)\n}\n```\n**SQL queries:**\n```sql\n-- Insert\n-- Note: empty string referer → NULL via pgx nullability handling (see implementation note below)\nINSERT INTO clicks (short_code, clicked_at, ip_hash, user_agent, referer)\nVALUES ($1, $2, $3, $4, $5)\n-- CountByCode\nSELECT COUNT(*) FROM clicks WHERE short_code = $1\n-- CountSince\nSELECT COUNT(*) FROM clicks\nWHERE short_code = $1 AND clicked_at >= $2\n-- TopReferers\nSELECT referer, COUNT(*) AS cnt\nFROM clicks\nWHERE short_code = $1\n  AND referer IS NOT NULL\nGROUP BY referer\nORDER BY cnt DESC\nLIMIT $2\n-- Timeline (interval validated to \"day\" or \"hour\" before interpolation)\n-- SAFE: interval is never raw user input in the SQL string; it is validated and\n-- only one of two literals is ever used. Use a CASE or two separate queries.\nSELECT\n    date_trunc($2, clicked_at AT TIME ZONE 'UTC') AS period,\n    COUNT(*) AS clicks\nFROM clicks\nWHERE short_code = $1\nGROUP BY period\nORDER BY period ASC\n```\n**Implementation note on NULL referer:**\n```go\n// pgx handles Go's typed nil via pgx.NullString or *string.\n// Use *string for the referer column: nil → NULL in DB.\nvar referer *string\nif click.Referer != \"\" {\n    referer = &click.Referer\n}\n_, err = tx.Exec(ctx,\n    `INSERT INTO clicks (short_code, clicked_at, ip_hash, user_agent, referer)\n     VALUES ($1, $2, $3, $4, $5)`,\n    click.ShortCode, click.ClickedAt, click.IPHash, click.UserAgent, referer,\n)\n```\n**`Timeline` SQL safety note:** `date_trunc` takes the interval as a string literal, not a column reference. Since interval is validated to exactly `\"day\"` or `\"hour\"` before reaching the repository, it is safe to interpolate directly into the query string (not as a `$N` parameter — PostgreSQL does not accept `date_trunc($2, ...)` where `$2` is a string bind parameter for the granularity argument in all driver versions). Implementation:\n```go\nfunc (r *pgxClickRepository) Timeline(ctx context.Context, shortCode string, interval string) ([]PeriodCount, error) {\n    // interval is pre-validated to \"day\" | \"hour\" by the handler.\n    // Safe string interpolation: only two possible values.\n    q := fmt.Sprintf(`\n        SELECT date_trunc('%s', clicked_at AT TIME ZONE 'UTC') AS period, COUNT(*) AS clicks\n        FROM clicks\n        WHERE short_code = $1\n        GROUP BY period\n        ORDER BY period ASC`, interval)\n    rows, err := r.pool.Query(ctx, q, shortCode)\n    // ...scan rows into []PeriodCount...\n}\n```\n### 4.2 `ProcessedEventRepository`\n```go\n// repository/processed_event_repository.go\n// ProcessedEventRepository manages the deduplication table.\ntype ProcessedEventRepository interface {\n    // IsProcessed checks whether eventID is already in processed_events.\n    // Returns true if found, false if not found.\n    // Returns false on DB error (logged internally); the processor will\n    // attempt the INSERT and rely on the UNIQUE constraint as a safety net.\n    // This is a read-only operation; uses the pool (no transaction).\n    IsProcessed(ctx context.Context, eventID string) (bool, error)\n    // MarkProcessed inserts eventID into processed_events within tx.\n    // tx must be the same transaction as the Click INSERT — atomicity is the contract.\n    // Returns error on DB failure; the constraint violation (duplicate) on\n    // processed_events.event_id PRIMARY KEY is treated as a success (idempotent).\n    MarkProcessed(ctx context.Context, tx pgx.Tx, eventID string) error\n}\n```\n**SQL queries:**\n```sql\n-- IsProcessed\nSELECT 1 FROM processed_events WHERE event_id = $1\n-- MarkProcessed\nINSERT INTO processed_events (event_id) VALUES ($1)\nON CONFLICT (event_id) DO NOTHING\n```\n**Why `ON CONFLICT DO NOTHING` on `MarkProcessed`:** The outer idempotency check (`IsProcessed`) prevents most re-processing. However, between the `IsProcessed` read and the transaction commit, a concurrent consumer (future scenario) could process the same event. The `ON CONFLICT DO NOTHING` makes `MarkProcessed` idempotent at the DB level as a second guard. In the current single-consumer design this is defensive; it costs nothing.\n### 4.3 `MilestoneRepository`\n```go\n// repository/milestone_repository.go\n// MilestoneRepository manages milestone threshold records.\ntype MilestoneRepository interface {\n    // GetLatestMilestone returns the highest milestone value already recorded\n    // for shortCode. Returns 0, nil if no milestone row exists.\n    // Uses the pool (no transaction); reads committed data.\n    GetLatestMilestone(ctx context.Context, shortCode string) (int, error)\n    // InsertMilestone records a new milestone crossing within tx.\n    // tx must be the same transaction as the click insert (§ 5.2).\n    // On UNIQUE constraint violation (short_code, milestone already recorded):\n    // returns nil (treated as no-op — milestone was concurrently recorded).\n    // On any other DB error: returns wrapped error.\n    InsertMilestone(ctx context.Context, tx pgx.Tx, shortCode string, milestone int) error\n}\n```\n**SQL queries:**\n```sql\n-- GetLatestMilestone\nSELECT COALESCE(MAX(milestone), 0)\nFROM milestones\nWHERE short_code = $1\n-- InsertMilestone\nINSERT INTO milestones (short_code, milestone)\nVALUES ($1, $2)\nON CONFLICT (short_code, milestone) DO NOTHING\n```\n### 4.4 `AMQPConsumer`\n```go\n// consumer/consumer.go\n// AMQPConsumer wraps the amqp091 channel consumption setup.\n// It declares the queue and binding, then starts consuming.\ntype AMQPConsumer interface {\n    // Deliveries returns the channel of incoming AMQP messages.\n    // The channel is closed when the AMQP connection drops.\n    // Callers must re-initialize AMQPConsumer on channel close.\n    Deliveries() <-chan amqp091.Delivery\n    // Close cancels the consumer tag and closes the AMQP channel.\n    // Called during graceful shutdown or before reconnect.\n    Close() error\n}\n// NewAMQPConsumer constructs a consumer, declaring the queue and binding,\n// and starts the AMQP Basic.Consume. Returns error if any AMQP operation fails.\n// queueName: \"analytics.clicks\"\n// exchangeName: \"url-shortener\"\n// routingKey: \"url.clicked\"\nfunc NewAMQPConsumer(ch *amqp091.Channel, log zerolog.Logger) (AMQPConsumer, error)\n```\n**Consumer setup inside `NewAMQPConsumer`:**\n```go\n// 1. Declare exchange (idempotent — url-service already declared it)\nerr = ch.ExchangeDeclare(\"url-shortener\", \"topic\", true, false, false, false, nil)\n// 2. Declare queue\nq, err := ch.QueueDeclare(\"analytics.clicks\", true, false, false, false, nil)\n// 3. Bind queue to exchange\nerr = ch.QueueBind(q.Name, \"url.clicked\", \"url-shortener\", false, nil)\n// 4. Set prefetch count: process one message at a time\nerr = ch.Qos(1, 0, false)  // prefetchCount=1, prefetchSize=0, global=false\n// 5. Start consuming\ndeliveries, err := ch.Consume(\n    q.Name,\n    \"analytics-consumer\",  // consumer tag\n    false,                  // autoAck=false — explicit ACK after processing\n    false,                  // exclusive=false\n    false,                  // noLocal=false\n    false,                  // noWait=false\n    nil,\n)\n```\n**Why `Qos(1, 0, false)` (prefetch=1):** The consumer processes one message at a time to simplify idempotency logic. With `prefetch=1`, RabbitMQ delivers the next message only after the current one is ACKed or NACKed. This eliminates concurrent processing scenarios where two goroutines might race on `IsProcessed → INSERT`. A future optimization could increase prefetch and use a worker pool, but it would require distributed locking or serializable transactions for idempotency.\n### 4.5 `ClickProcessor`\n```go\n// consumer/processor.go\n// ClickProcessor orchestrates the full processing of a single URLClickedEvent.\n// It is called by the consumer goroutine for each delivery.\ntype ClickProcessor struct {\n    clickRepo     repository.ClickRepository\n    processedRepo repository.ProcessedEventRepository\n    milestoneRepo repository.MilestoneRepository\n    detector      milestone.Detector\n    publisher     publisher.AMQPPublisher\n    pool          *pgxpool.Pool\n    log           zerolog.Logger\n}\nfunc NewClickProcessor(\n    pool *pgxpool.Pool,\n    clickRepo repository.ClickRepository,\n    processedRepo repository.ProcessedEventRepository,\n    milestoneRepo repository.MilestoneRepository,\n    detector milestone.Detector,\n    pub publisher.AMQPPublisher,\n    log zerolog.Logger,\n) *ClickProcessor\n// Process handles a single AMQP delivery.\n// Returns ProcessResult indicating the outcome.\n// The caller (consumer goroutine) uses the result to ACK or NACK.\n// Process never panics — all panics are recovered internally and logged.\nfunc (p *ClickProcessor) Process(ctx context.Context, d amqp091.Delivery) ProcessResult\n```\n\n![clicks + milestones + processed_events Schema and Index Layout](./diagrams/tdd-diag-25.svg)\n\n### 4.6 `MilestoneDetector`\n```go\n// milestone/detector.go\n// Thresholds is the ordered list of click counts at which milestones are triggered.\n// Must be sorted ascending. Checked in order during detection.\nvar Thresholds = []int{10, 100, 1000}\n// Detector determines which milestone (if any) was just crossed.\ntype Detector interface {\n    // Detect returns the milestone value crossed by newTotal, given that\n    // the highest previously recorded milestone is latestMilestone.\n    // Returns 0 if no new milestone was crossed.\n    // Example: latestMilestone=10, newTotal=100 → returns 100.\n    // Example: latestMilestone=100, newTotal=101 → returns 0 (100 already recorded).\n    // Example: latestMilestone=0, newTotal=10 → returns 10.\n    // Example: latestMilestone=0, newTotal=15 → returns 10 (lowest uncrossed threshold).\n    Detect(latestMilestone int, newTotal int64) int\n}\n```\n**`Detect` implementation:**\n```go\nfunc (d *thresholdDetector) Detect(latestMilestone int, newTotal int64) int {\n    for _, t := range Thresholds {\n        if t > latestMilestone && int64(t) <= newTotal {\n            return t // return the LOWEST uncrossed threshold that newTotal has reached\n        }\n    }\n    return 0\n}\n```\n**Why return the lowest uncrossed threshold:** If a code jumps from 0 to 150 clicks in a burst (e.g., due to consumer lag), `latestMilestone=0` and `newTotal=150`. The detector returns `10` (the first uncrossed threshold). After that milestone is recorded, `GetLatestMilestone` returns `10`, and the next call returns `100`. This ensures no threshold is skipped silently — each is recorded in sequence. In practice, with a running consumer this situation is rare.\n### 4.7 `AMQPPublisher` (analytics-service scoped)\n```go\n// publisher/publisher.go\n// AMQPPublisher publishes MilestoneReachedEvent to the RabbitMQ exchange.\n// Interface is identical in structure to url-service's publisher (§ 4.5 of M3),\n// but is independently defined in this package to avoid cross-service imports.\ntype AMQPPublisher interface {\n    // Publish sends body to exchange \"url-shortener\" with routingKey \"milestone.reached\".\n    // Returns error if the AMQP channel is closed or broker unreachable.\n    // Callers log the error and continue — milestone publish failure does NOT\n    // roll back the DB transaction (milestone row is still saved).\n    Publish(ctx context.Context, routingKey string, body []byte) error\n}\nfunc NewAMQPPublisher(ch *amqp091.Channel, log zerolog.Logger) AMQPPublisher\n```\n---\n## 5. Algorithm Specification\n### 5.1 Consumer Goroutine Lifecycle\n```\nPROCEDURE RunConsumer(ctx context.Context, amqpURL string, processor *ClickProcessor, log):\n  FOR:\n    -- Attempt to connect and consume; reconnect on failure.\n    conn, ch, err = connectAMQP(ctx, amqpURL)  -- exponential backoff, same as M1 § 4.5\n    IF err:\n      log.Warn().Err(err).Msg(\"consumer amqp connect failed; retrying in 10s\")\n      SELECT:\n      CASE <-ctx.Done(): return\n      CASE <-time.After(10 * time.Second): continue\n    consumer, err = NewAMQPConsumer(ch, log)\n    IF err:\n      log.Warn().Err(err).Msg(\"consumer setup failed; retrying\")\n      ch.Close(); conn.Close()\n      continue\n    log.Info().Msg(\"amqp consumer started; waiting for messages\")\n    -- Inner loop: process deliveries until channel closes.\n    FOR:\n      SELECT:\n      CASE <-ctx.Done():\n        consumer.Close()\n        conn.Close()\n        return\n      CASE d, ok := <-consumer.Deliveries():\n        IF !ok:\n          -- Channel closed (broker disconnect).\n          log.Warn().Msg(\"amqp delivery channel closed; reconnecting\")\n          conn.Close()\n          BREAK inner loop → reconnect\n        -- Run processor in a supervised call (panic recovery inside Process).\n        result = processor.Process(ctx, d)\n        SWITCH result:\n        CASE ProcessResultInserted:\n          d.Ack(false)\n        CASE ProcessResultDuplicate:\n          d.Ack(false)      -- duplicate: safe to ACK, no DB side effect\n        CASE ProcessResultPoisoned:\n          d.Ack(false)      -- poison: ACK to remove from queue; logged as error\n        CASE ProcessResultError:\n          d.Nack(false, true) -- transient error: NACK with requeue=true\nEND PROCEDURE\n```\n**Supervisor wrapper in `main.go`:**\n```go\ngo func() {\n    for {\n        func() {\n            defer func() {\n                if r := recover(); r != nil {\n                    log.Error().Interface(\"panic\", r).Msg(\"consumer goroutine panicked; restarting\")\n                }\n            }()\n            RunConsumer(ctx, amqpURL, processor, log)\n        }()\n        select {\n        case <-ctx.Done():\n            return\n        case <-time.After(5 * time.Second):\n            log.Info().Msg(\"restarting consumer goroutine\")\n        }\n    }\n}()\n```\nThe outer `for` loop with `recover()` ensures the consumer goroutine is always running while the service is alive, even after a panic in the processor.\n### 5.2 `ClickProcessor.Process` — Full Algorithm\n```\nPROCEDURE ClickProcessor.Process(ctx, d amqp091.Delivery) ProcessResult:\n  -- Step 0: Panic recovery (defer at top of function)\n  DEFER recover() → log error, return ProcessResultError\n  -- Step 1: Parse event\n  var event events.URLClickedEvent\n  err = json.Unmarshal(d.Body, &event)\n  IF err:\n    log.Error().Err(err).\n        Str(\"body\", truncate(string(d.Body), 200)).\n        Msg(\"malformed URLClickedEvent; ACKing poison message\")\n    return ProcessResultPoisoned\n  -- Step 2: Validate required fields\n  IF event.EventID == \"\" OR event.ShortCode == \"\":\n    log.Error().\n        Str(\"event_id\", event.EventID).\n        Str(\"short_code\", event.ShortCode).\n        Msg(\"URLClickedEvent missing required fields; ACKing\")\n    return ProcessResultPoisoned\n  -- Step 3: Set correlation ID on logger for this message\n  msgLog = log.With().\n      Str(\"correlation_id\", event.CorrelationID).\n      Str(\"event_id\", event.EventID).\n      Str(\"short_code\", event.ShortCode).\n      Logger()\n  -- Step 4: Fast idempotency pre-check (outside transaction for performance)\n  already, err = processedRepo.IsProcessed(ctx, event.EventID)\n  IF err:\n    -- DB error on check: log, attempt processing anyway (DB constraint is the real guard)\n    msgLog.Warn().Err(err).Msg(\"idempotency pre-check DB error; proceeding with insert attempt\")\n  IF already:\n    msgLog.Debug().Msg(\"duplicate event; skipping\")\n    return ProcessResultDuplicate\n  -- Step 5: Begin transaction\n  tx, err = pool.Begin(ctx)\n  IF err:\n    msgLog.Error().Err(err).Msg(\"begin tx failed\")\n    return ProcessResultError\n  DEFER tx.Rollback(ctx)  -- no-op if Commit succeeds\n  -- Step 6: Mark processed (inside transaction, before click insert)\n  -- Order: MarkProcessed FIRST, then Insert.\n  -- Rationale: if Insert fails after MarkProcessed, the tx rolls back — both\n  -- operations are undone. The event will be redelivered and reprocessed.\n  -- If we inserted first and marked second, a crash between them would leave\n  -- a click row with no idempotency record — the event is redelivered and\n  -- double-counted. Inserting the mark first is the safe order.\n  err = processedRepo.MarkProcessed(ctx, tx, event.EventID)\n  IF err:\n    msgLog.Error().Err(err).Msg(\"mark processed failed\")\n    return ProcessResultError\n  -- Step 7: Build Click struct\n  click = repository.Click{\n      ShortCode: event.ShortCode,\n      ClickedAt: event.OccurredAt,    -- event time, not now()\n      IPHash:    event.IPHash,\n      UserAgent: event.UserAgent,\n      Referer:   event.Referer,       -- may be \"\" → stored as NULL\n  }\n  -- Step 8: Insert click\n  err = clickRepo.Insert(ctx, tx, click)\n  IF err:\n    msgLog.Error().Err(err).Msg(\"click insert failed\")\n    return ProcessResultError\n  -- Step 9: Commit click + idempotency mark\n  err = tx.Commit(ctx)\n  IF err:\n    msgLog.Error().Err(err).Msg(\"commit failed\")\n    return ProcessResultError\n  -- Step 10: Milestone detection (AFTER commit — reads committed data)\n  -- This runs outside the click transaction to avoid long-held locks.\n  p.detectAndRecordMilestone(ctx, event, msgLog)\n  -- Step 11: Return success\n  return ProcessResultInserted\nEND PROCEDURE\n```\n**Why milestone detection is outside the click transaction:**\n`CountByCode` reads the total click count for the short_code. If this query runs inside the click transaction, it reads the uncommitted inserted row (own-transaction visibility in PostgreSQL). However, running milestone detection inside the transaction means:\n1. The transaction holds locks longer (milestone INSERT + possible publisher call).\n2. A milestone publish failure would roll back the click insert.\nThe spec (error category `MILESTONE_PUBLISH_FAIL`) explicitly states: \"log warning, do not fail the transaction (milestone row still saved).\" Therefore, milestone detection runs after the click transaction commits, with a fresh pool connection.\n### 5.3 `detectAndRecordMilestone` — Milestone Detection Algorithm\n```\nPROCEDURE detectAndRecordMilestone(ctx, event URLClickedEvent, log):\n  -- Step 1: Get current total click count (post-commit)\n  total, err = clickRepo.CountByCode(ctx, event.ShortCode)\n  IF err:\n    log.Error().Err(err).Msg(\"milestone: count query failed\")\n    return  -- milestone detection skipped; not fatal\n  -- Step 2: Get highest recorded milestone for this code\n  latest, err = milestoneRepo.GetLatestMilestone(ctx, event.ShortCode)\n  IF err:\n    log.Error().Err(err).Msg(\"milestone: get latest failed\")\n    return\n  -- Step 3: Detect if a threshold was crossed\n  crossed = detector.Detect(latest, total)\n  IF crossed == 0:\n    return  -- no milestone crossed\n  log.Info().\n      Str(\"short_code\", event.ShortCode).\n      Int(\"milestone\", crossed).\n      Int64(\"total\", total).\n      Msg(\"milestone crossed\")\n  -- Step 4: Record milestone in its own transaction\n  tx, err = pool.Begin(ctx)\n  IF err:\n    log.Error().Err(err).Msg(\"milestone: begin tx failed\")\n    return\n  DEFER tx.Rollback(ctx)\n  err = milestoneRepo.InsertMilestone(ctx, tx, event.ShortCode, crossed)\n  IF err:\n    log.Error().Err(err).Msg(\"milestone: insert failed\")\n    return  -- tx rollback via defer\n  err = tx.Commit(ctx)\n  IF err:\n    log.Error().Err(err).Msg(\"milestone: commit failed\")\n    return\n  -- Step 5: Publish MilestoneReachedEvent\n  milestoneEvent = events.MilestoneReachedEvent{\n      EventType:     events.EventTypeMilestoneReached,\n      OccurredAt:    time.Now().UTC(),\n      CorrelationID: event.CorrelationID,\n      ShortCode:     event.ShortCode,\n      UserID:        event.UserID,\n      UserEmail:     event.UserEmail,  -- from URLClickedEvent (owner info)\n      Milestone:     crossed,\n      TotalClicks:   total,\n  }\n  payload, _ = json.Marshal(milestoneEvent)\n  err = publisher.Publish(ctx, events.EventTypeMilestoneReached, payload)\n  IF err:\n    -- Log warning; milestone row already committed → notification-service will\n    -- not be notified this cycle but the milestone is durably recorded.\n    log.Warn().Err(err).\n        Str(\"short_code\", event.ShortCode).\n        Int(\"milestone\", crossed).\n        Msg(\"milestone event publish failed; milestone saved but notification may be missed\")\n    return\n  log.Info().Str(\"short_code\", event.ShortCode).Int(\"milestone\", crossed).\n      Msg(\"MilestoneReachedEvent published\")\nEND PROCEDURE\n```\n**Milestone deduplication note:** `milestones` has `UNIQUE (short_code, milestone)`. If the service crashes between Step 3 and Step 4 and the event is redelivered, `IsProcessed` returns true (the click was committed in Step 9 of `Process`), so the whole `Process` function returns `ProcessResultDuplicate` — milestone detection is not re-run. This is correct: the click count hasn't changed, so the milestone would be detected again. The `ON CONFLICT DO NOTHING` on `InsertMilestone` provides an additional safety net if the dedup table is somehow bypassed.\n\n![URLClickedEvent Ingestion — Idempotent Consumer Algorithm](./diagrams/tdd-diag-26.svg)\n\n### 5.4 `GET /stats/:code` Handler Algorithm\n```\nPROCEDURE HandleStats(w http.ResponseWriter, r *http.Request):\n  shortCode = r.PathValue(\"code\")\n  IF shortCode == \"\":\n    writeError(w, 400, \"short code is required\")\n    return\n  now = time.Now().UTC()\n  -- Run all four queries concurrently using errgroup.\n  -- All are read-only; no transaction needed.\n  var (\n      total   int64\n      last24h int64\n      last7d  int64\n      refs    []repository.RefererCount\n  )\n  g, gctx = errgroup.WithContext(r.Context())\n  g.Go(func() error {\n      var err error\n      total, err = clickRepo.CountByCode(gctx, shortCode)\n      return err\n  })\n  g.Go(func() error {\n      var err error\n      last24h, err = clickRepo.CountSince(gctx, shortCode, now.Add(-24*time.Hour))\n      return err\n  })\n  g.Go(func() error {\n      var err error\n      last7d, err = clickRepo.CountSince(gctx, shortCode, now.Add(-7*24*time.Hour))\n      return err\n  })\n  g.Go(func() error {\n      var err error\n      refs, err = clickRepo.TopReferers(gctx, shortCode, 5)\n      return err\n  })\n  IF err = g.Wait(); err != nil:\n    log.Error().Err(err).Str(\"short_code\", shortCode).Msg(\"stats query failed\")\n    writeError(w, 500, \"internal server error\")\n    return\n  -- Build response (always 200 even if total=0; short_code may have no clicks yet)\n  items = make([]RefererItem, len(refs))\n  FOR i, r := range refs:\n    items[i] = RefererItem{Referer: r.Referer, Count: r.Count}\n  writeJSON(w, 200, StatsResponse{\n      ShortCode:     shortCode,\n      TotalClicks:   total,\n      ClicksLast24h: last24h,\n      ClicksLast7d:  last7d,\n      TopReferers:   items,  -- empty slice, never null\n  })\nEND PROCEDURE\n```\n**Concurrency note:** Using `golang.org/x/sync/errgroup` to run the four queries concurrently reduces p99 latency from `4 × query_time` to approximately `1 × slowest_query_time`. All four queries are SELECT-only and use the shared pgxpool — each acquires its own connection. This is safe and the pool has `MaxConns=10` (M1), sufficient for 4 concurrent reads per request plus consumer activity.\n### 5.5 `GET /stats/:code/timeline` Handler Algorithm\n```\nPROCEDURE HandleTimeline(w http.ResponseWriter, r *http.Request):\n  shortCode = r.PathValue(\"code\")\n  IF shortCode == \"\":\n    writeError(w, 400, \"short code is required\")\n    return\n  interval = r.URL.Query().Get(\"interval\")\n  IF interval == \"\":\n    interval = \"day\"  -- default\n  IF interval != \"day\" AND interval != \"hour\":\n    writeError(w, 400, \"interval must be 'day' or 'hour'\")\n    return\n  points, err = clickRepo.Timeline(r.Context(), shortCode, interval)\n  IF err:\n    log.Error().Err(err).Str(\"short_code\", shortCode).Msg(\"timeline query failed\")\n    writeError(w, 500, \"internal server error\")\n    return\n  -- Format period timestamps as ISO 8601 strings.\n  -- For interval=\"day\": \"2026-03-02\" (date only).\n  -- For interval=\"hour\": \"2026-03-02T14:00:00Z\" (full RFC3339).\n  formattedPoints = make([]TimelinePoint, len(points))\n  FOR i, p := range points:\n    formattedPoints[i] = TimelinePoint{\n        Period: formatPeriod(p.Period, interval),\n        Clicks: p.Clicks,\n    }\n  writeJSON(w, 200, TimelineResponse{\n      ShortCode: shortCode,\n      Interval:  interval,\n      Points:    formattedPoints,\n  })\nEND PROCEDURE\nFUNCTION formatPeriod(period string, interval string) string:\n  -- period is a UTC timestamp string returned by PostgreSQL date_trunc.\n  -- Parse as time.Time, then format based on interval.\n  t, _ = time.Parse(time.RFC3339, period)  -- pgx scans TIMESTAMPTZ as time.Time directly\n  IF interval == \"day\":\n    return t.UTC().Format(\"2006-01-02\")\n  return t.UTC().Format(time.RFC3339)\n```\n**Implementation note:** pgx scans `TIMESTAMPTZ` columns directly into `time.Time`. The `PeriodCount.Period` field should be `time.Time` (not `string`) in the repository layer; the handler converts to the appropriate string format. Update the `PeriodCount` struct:\n```go\ntype PeriodCount struct {\n    Period time.Time // scanned directly from PostgreSQL TIMESTAMPTZ\n    Clicks int64\n}\n```\nThe `TimelinePoint.Period` in the API response is a string (formatted by the handler).\n\n![Consumer Goroutine State Machine](./diagrams/tdd-diag-27.svg)\n\n---\n## 6. State Machine: Consumer Goroutine\n```\nStates: DISCONNECTED → CONNECTING → CONSUMING → DISCONNECTED\n        CONSUMING → STOPPING (on ctx.Done)\n        STOPPING → (goroutine exits)\nTransitions:\n  DISCONNECTED →[connect attempt success]→ CONSUMING\n  DISCONNECTED →[connect attempt fail]→ DISCONNECTED (wait 10s, retry)\n  CONSUMING →[delivery channel closed]→ DISCONNECTED\n  CONSUMING →[ctx.Done]→ STOPPING\n  STOPPING →[consumer.Close + conn.Close]→ (exit)\nIllegal transitions (must never occur):\n  CONSUMING → CONSUMING (no nested consumer start)\n  STOPPING → CONNECTING (no reconnect after shutdown signal)\n```\n```\nStates: CONSUMING → processing one message at a time\n  Per-message substates:\n    IDLE → PARSING → CHECKING_DUP → IN_TRANSACTION → COMMITTED → MILESTONE_DETECTION → IDLE\n```\nThe `Qos(1, 0, false)` (prefetch=1) enforces that the broker does not deliver a second message until the first is ACKed or NACKed, making the per-message substates truly sequential.\n---\n## 7. Error Handling Matrix\n| Error | Detected By | Recovery | ACK/NACK | Logged? | Notes |\n|---|---|---|---|---|---|\n| `MALFORMED_JSON` | `json.Unmarshal` | Log error, ACK | ACK | Error | Poison message; requeue would loop forever |\n| `MISSING_REQUIRED_FIELDS` | field check in `Process` | Log error, ACK | ACK | Error | EventID or ShortCode empty |\n| `DUPLICATE_EVENT` | `processedRepo.IsProcessed` → true | Log debug, ACK | ACK | Debug | At-least-once guarantee; normal occurrence |\n| `IDEMPOTENCY_CHECK_DB_ERROR` | `IsProcessed` returns error | Log warn, proceed to INSERT | — | Warn | DB constraint is the real guard |\n| `BEGIN_TX_FAIL` | `pool.Begin` | Log error, NACK requeue | NACK | Error | Transient; retried on redelivery |\n| `MARK_PROCESSED_FAIL` | `processedRepo.MarkProcessed` | Log error, rollback, NACK | NACK | Error | |\n| `CLICK_INSERT_FAIL` | `clickRepo.Insert` | Log error, rollback, NACK | NACK | Error | |\n| `TX_COMMIT_FAIL` | `tx.Commit` | Log error, NACK | NACK | Error | Row not inserted; safe to retry |\n| `MILESTONE_COUNT_FAIL` | `clickRepo.CountByCode` | Log error, skip milestone, return | ACK (click already committed) | Error | Click inserted; milestone detection skipped |\n| `MILESTONE_INSERT_FAIL` | `milestoneRepo.InsertMilestone` | Log error, skip publish, return | ACK | Error | Click inserted; milestone not recorded this cycle |\n| `MILESTONE_PUBLISH_FAIL` | `publisher.Publish` | Log warn, return | ACK | Warn | Milestone saved; notification may be missed |\n| `CONSUMER_PANIC` | `recover()` in supervisor | Log error, restart goroutine after 5s | N/A | Error | Panic in Process means delivery not ACKed; broker redelivers after consumer reconnects |\n| `AMQP_DISCONNECTED` | Delivery channel closed | Log warn, reconnect loop | N/A | Warn | Consumer pauses; /health still 200 |\n| `STATS_QUERY_FAIL` | `errgroup.Wait` error | Log error, 500 response | N/A | Error | |\n| `TIMELINE_INVALID_INTERVAL` | handler validation | 400 response | N/A | No | User input error |\n| `DB_POOL_EXHAUSTED` | pgx `pool.Begin` or `pool.Query` | Same as `BEGIN_TX_FAIL` | NACK | Error | Indicates pool sizing issue |\n**Dead-letter queue consideration:** The spec does not require a DLQ in this milestone. Poison messages (malformed JSON) are ACKed to remove them from the queue. For production, a DLQ binding on `analytics.clicks` would capture nacked messages with `requeue=false`. Document in README as a future improvement.\n---\n## 8. Concurrency Specification\n### 8.1 Consumer Goroutine\n| Component | Goroutine Count | Shared Mutable State | Protection |\n|---|---|---|---|\n| Consumer supervisor | 1 | None | N/A |\n| `RunConsumer` | 1 | `amqp091.Connection`, `amqp091.Channel` | Owned by single goroutine |\n| `ClickProcessor.Process` | Called from 1 goroutine | `pgxpool.Pool` (goroutine-safe) | Pool internal locking |\n| `detectAndRecordMilestone` | Called from 1 goroutine | Same pool | Pool internal locking |\n| `AMQPPublisher` | Called from 1 goroutine | `amqp091.Channel` | No concurrent access in single-consumer design |\n**Note:** Because the consumer is single-goroutine (enforced by prefetch=1 + sequential processing), `AMQPPublisher` in analytics-service does NOT need the `sync.Mutex` that url-service's publisher uses (where 3 worker goroutines share one channel). If the design ever moves to concurrent processing, the mutex must be added.\n### 8.2 Stats API Handlers\nStats handlers run concurrently (one goroutine per request, via `net/http`). They are read-only; all state is in PostgreSQL. `pgxpool.Pool` is goroutine-safe. The `errgroup`-based concurrent queries within `HandleStats` are bounded to 4 goroutines per request — with `MaxConns=10`, up to 2 concurrent stat requests can run fully parallel before pool pressure begins.\n### 8.3 Consumer vs. Stats API Isolation\nThe consumer goroutine and HTTP handler goroutines share the `*pgxpool.Pool`. Pool slots are acquired dynamically. With `MinConns=2, MaxConns=10`:\n- Consumer always needs at most 2 connections simultaneously (one for the main click tx, one for milestone detection).\n- Stats API handler needs up to 4 connections (errgroup concurrent queries).\n- Total peak: 6 connections; well within `MaxConns=10`.\n\n![IP Privacy Hashing Data Flow](./diagrams/tdd-diag-28.svg)\n\n---\n## 9. Route Registration in `main.go`\n```go\n// services/analytics-service/main.go (route wiring)\n// No JWT auth on stats endpoints — stats are public per spec.\nmux := http.NewServeMux()\nmux.HandleFunc(\"GET /health\",                     handler.NewHealthHandler(\"analytics-service\", log))\nmux.HandleFunc(\"GET /stats/{code}\",              handler.NewStatsHandler(clickRepo, log))\nmux.HandleFunc(\"GET /stats/{code}/timeline\",     handler.NewTimelineHandler(clickRepo, log))\n```\n**Pattern disambiguation:** `GET /stats/{code}/timeline` is more specific than `GET /stats/{code}` — Go 1.22+ `net/http` routing correctly resolves this: `/stats/abc/timeline` matches the timeline handler, `/stats/abc` matches the stats handler. Register in any order; specificity takes precedence.\n**No `/analytics/` prefix:** The gateway (M5) routes `GET /api/stats/:code` → `http://analytics-service:8082/stats/:code`. The service itself uses `/stats/` without the `/api/` prefix — the gateway strips the path prefix before forwarding. Verify the gateway routing table in M5.\n---\n## 10. Implementation Sequence with Checkpoints\n### Phase 1 — Schema Migrations + Indexes (1–1.5 hr)\n1. Write `migrations/001_create_clicks.sql`, `002_create_milestones.sql`, `003_create_processed_events.sql`.\n2. Apply migrations:\n   ```bash\n   docker exec -i analytics_db psql -U analytics_user -d analytics_db \\\n     < services/analytics-service/migrations/001_create_clicks.sql\n   docker exec -i analytics_db psql -U analytics_user -d analytics_db \\\n     < services/analytics-service/migrations/002_create_milestones.sql\n   docker exec -i analytics_db psql -U analytics_user -d analytics_db \\\n     < services/analytics-service/migrations/003_create_processed_events.sql\n   ```\n3. Verify schema and indexes:\n   ```bash\n   docker exec analytics_db psql -U analytics_user -d analytics_db -c \"\\d clicks\"\n   docker exec analytics_db psql -U analytics_user -d analytics_db -c \"\\di\"\n   ```\n**Checkpoint:** Three tables exist. `\\di` shows `idx_clicks_short_code_time`, `idx_clicks_referer` (partial), `idx_milestones_short_code`. `milestones` has unique constraint on `(short_code, milestone)`. `processed_events` has UUID primary key. Run:\n```sql\nEXPLAIN SELECT COUNT(*) FROM clicks WHERE short_code = 'abc' AND clicked_at >= now() - interval '24h';\n```\nMust show `Index Scan` on `idx_clicks_short_code_time`, not `Seq Scan`.\n### Phase 2 — Repository Layer (1.5–2 hr)\n1. Add dependencies to `go.mod`: `go get github.com/jackc/pgx/v5 github.com/rs/zerolog golang.org/x/sync`.\n2. Write `repository/click_repository.go`: `Click`, `RefererCount`, `PeriodCount`, `ClickRepository` interface, `pgxClickRepository`, all five methods.\n3. Write `repository/processed_event_repository.go`: `ProcessedEvent`, `ProcessedEventRepository` interface, `pgxProcessedEventRepository`, `IsProcessed`, `MarkProcessed`.\n4. Write `repository/milestone_repository.go`: `Milestone`, `MilestoneRepository` interface, `pgxMilestoneRepository`, `GetLatestMilestone`, `InsertMilestone`.\n5. Write all three `_test.go` files with integration build tag.\n6. Run: `go test -tags integration ./repository/... -v`\n**Checkpoint:**\n- `TestClickInsert_HappyPath`: inserts click, `CountByCode` returns 1.\n- `TestMarkProcessed_Idempotent`: `MarkProcessed` twice with same event_id → no error.\n- `TestIsProcessed_AfterMark`: `IsProcessed` returns true after `MarkProcessed` + commit.\n- `TestGetLatestMilestone_NoRows`: returns 0.\n- `TestInsertMilestone_Conflict`: second insert of same `(short_code, milestone)` → returns nil (ON CONFLICT DO NOTHING).\n- `TestTopReferers_NullsExcluded`: click with empty referer not returned in top referers.\n- `TestTimeline_DayBucket`: two clicks on same day return one period row.\n### Phase 3 — RabbitMQ Consumer + Idempotency (2–2.5 hr)\n1. Write `consumer/consumer.go`: `AMQPConsumer` interface, `amqp091Consumer` struct, `NewAMQPConsumer` (exchange declare, queue declare, bind, Qos, Consume).\n2. Write `consumer/processor.go`: `ClickProcessor` struct, `NewClickProcessor`, `Process` following § 5.2 exactly.\n3. Write `consumer/processor_test.go`: unit tests with mock repositories (§ 11.3).\n4. Write `main.go` startup: DB connect, construct repositories, construct processor, launch `RunConsumer` supervisor goroutine.\n5. Run `docker compose up --build analytics-service`.\n**Checkpoint:**\n```bash\n# From url-service (M3), shorten a URL with a valid JWT and make a redirect:\nTOKEN=$(curl -s -X POST http://localhost:8083/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"password123\"}' | jq -r .token)\nCODE=$(curl -s -X POST http://localhost:8081/shorten \\\n  -H \"Authorization: Bearer $TOKEN\" -H \"Content-Type: application/json\" \\\n  -d '{\"url\":\"https://www.example.com\"}' | jq -r .short_code)\ncurl -s \"http://localhost:8081/$CODE\" -L > /dev/null\n# Wait for outbox poller (url-service) + consumer (analytics-service):\nsleep 5\n# Verify click was inserted:\ndocker exec analytics_db psql -U analytics_user -d analytics_db \\\n  -c \"SELECT short_code, clicked_at FROM clicks ORDER BY clicked_at DESC LIMIT 1;\"\n# Verify processed_events has the event:\ndocker exec analytics_db psql -U analytics_user -d analytics_db \\\n  -c \"SELECT event_id, processed_at FROM processed_events ORDER BY processed_at DESC LIMIT 1;\"\n```\n### Phase 4 — Milestone Detection + MilestoneReachedEvent Publish (1–1.5 hr)\n1. Write `milestone/detector.go`: `Thresholds`, `Detector` interface, `thresholdDetector`, `Detect`.\n2. Write `milestone/detector_test.go` (§ 11.4).\n3. Write `publisher/publisher.go`: `AMQPPublisher` interface, `amqp091Publisher`.\n4. Update `consumer/processor.go`: inject `Detector` and `AMQPPublisher`; implement `detectAndRecordMilestone` (§ 5.3).\n5. Run `go test ./milestone/... -v`.\n**Checkpoint:**\n```bash\n# Generate 10 redirect events for the same short_code to cross the first milestone.\nfor i in {1..10}; do curl -s \"http://localhost:8081/$CODE\" -L > /dev/null; done\nsleep 6\n# Verify milestone row:\ndocker exec analytics_db psql -U analytics_user -d analytics_db \\\n  -c \"SELECT short_code, milestone, triggered_at FROM milestones;\"\n# Expected: 1 row with milestone=10\n# Verify MilestoneReachedEvent in RabbitMQ management UI:\n# http://localhost:15672 → Queues → notifications.events → Get Messages\n# Should show event with event_type=\"milestone.reached\", milestone=10\n```\n### Phase 5 — Stats API Handlers (1.5–2 hr)\n1. Write `handler/helpers.go`: `writeJSON`, `writeError`.\n2. Write `handler/stats.go`: `NewStatsHandler` with errgroup concurrent queries (§ 5.4).\n3. Write `handler/timeline.go`: `NewTimelineHandler` (§ 5.5).\n4. Write `handler/health.go`: `NewHealthHandler(\"analytics-service\", log)`.\n5. Wire routes in `main.go`.\n6. Write `handler/handler_test.go` (§ 11.5).\n7. Run `docker compose up --build analytics-service`.\n**Checkpoint:**\n```bash\ncurl -s \"http://localhost:8082/stats/$CODE\" | jq .\n# Expected:\n# {\n#   \"short_code\": \"<CODE>\",\n#   \"total_clicks\": 10,\n#   \"clicks_last_24h\": 10,\n#   \"clicks_last_7d\": 10,\n#   \"top_referers\": []\n# }\ncurl -s \"http://localhost:8082/stats/$CODE/timeline?interval=hour\" | jq .\n# Expected: {\"short_code\":\"...\", \"interval\":\"hour\", \"points\":[{\"period\":\"2026-...T...Z\",\"clicks\":10}]}\ncurl -s \"http://localhost:8082/stats/$CODE/timeline?interval=invalid\"\n# Expected: 400 {\"error\":\"interval must be 'day' or 'hour'\"}\ncurl -s \"http://localhost:8082/health\" | jq .\n# Expected: {\"status\":\"ok\",\"service\":\"analytics-service\"}\n```\n### Phase 6 — Idempotency Test (0.5–1 hr)\n1. Write `consumer/processor_test.go` integration test for duplicate delivery (§ 11.3 `TestDuplicateEvent_ClickCount1`).\n2. Run with live stack: `go test -tags integration ./consumer/... -v -run TestDuplicateEvent`.\n**Checkpoint:**\n```bash\n# Direct integration test (described in § 11.3):\n# Deliver the same URLClickedEvent JSON twice to analytics.clicks queue.\n# After both are processed, clicks table has exactly 1 row for that event_id.\ngo test -tags integration -v -run TestDuplicateEvent ./consumer/...\n# Expected: PASS\n```\n---\n## 11. Test Specification\n### 11.1 `repository/click_repository_test.go` (integration)\n```go\n// Build tag: //go:build integration\n// Requires: analytics_db running. DSN from TEST_DATABASE_DSN env var.\n// TestClickInsert_HappyPath: Insert click in tx, commit, CountByCode returns 1.\nfunc TestClickInsert_HappyPath(t *testing.T)\n// TestClickInsert_NullReferer: Insert with empty referer → NULL in DB.\n// Verify: SELECT referer FROM clicks WHERE ... IS NULL.\nfunc TestClickInsert_NullReferer(t *testing.T)\n// TestClickInsert_NonNullReferer: Insert with non-empty referer → stored correctly.\nfunc TestClickInsert_NonNullReferer(t *testing.T)\n// TestCountSince_24h: Insert 3 clicks: 2 within 24h, 1 older. CountSince(24h) returns 2.\nfunc TestCountSince_24h(t *testing.T)\n// TestTopReferers_TopFive: Insert clicks with 6 distinct referers.\n// TopReferers(code, 5) returns 5 entries, highest count first.\nfunc TestTopReferers_TopFive(t *testing.T)\n// TestTopReferers_NullsExcluded: Insert 3 clicks with null referer, 1 with referer.\n// TopReferers returns only 1 entry.\nfunc TestTopReferers_NullsExcluded(t *testing.T)\n// TestTimeline_DayInterval: Insert 3 clicks on same day, 2 on next day.\n// Timeline(code, \"day\") returns 2 period rows with correct counts.\nfunc TestTimeline_DayInterval(t *testing.T)\n// TestTimeline_HourInterval: Insert 2 clicks in hour 14, 1 in hour 15.\n// Timeline(code, \"hour\") returns 2 rows.\nfunc TestTimeline_HourInterval(t *testing.T)\n// TestTimeline_EmptyResult: Timeline for unknown code returns empty slice, not nil.\nfunc TestTimeline_EmptyResult(t *testing.T)\n// TestCountByCode_NoRows: CountByCode for unknown code returns 0, nil (not error).\nfunc TestCountByCode_NoRows(t *testing.T)\n```\n### 11.2 `repository/processed_event_repository_test.go` (integration)\n```go\n// TestIsProcessed_NotFound: unknown event_id returns false, nil.\nfunc TestIsProcessed_NotFound(t *testing.T)\n// TestIsProcessed_AfterMark: MarkProcessed in tx, commit, IsProcessed returns true.\nfunc TestIsProcessed_AfterMark(t *testing.T)\n// TestMarkProcessed_Idempotent: MarkProcessed called twice with same event_id.\n// Second call returns nil (ON CONFLICT DO NOTHING).\nfunc TestMarkProcessed_Idempotent(t *testing.T)\n// TestMarkProcessed_RollsBackWithTx: MarkProcessed in tx, rollback → IsProcessed returns false.\nfunc TestMarkProcessed_RollsBackWithTx(t *testing.T)\n```\n### 11.3 `consumer/processor_test.go` (unit + integration)\n**Unit tests** use mock implementations of `ClickRepository`, `ProcessedEventRepository`, `MilestoneRepository`, `Detector`, `AMQPPublisher`. Define interfaces in their respective packages so mocks implement them.\n```go\n// Unit tests (no build tag; mock dependencies):\n// TestProcess_HappyPath: valid URLClickedEvent JSON → ProcessResultInserted returned.\n// Mock: IsProcessed=false, Insert=nil, MarkProcessed=nil, CountByCode=1, GetLatestMilestone=0, Detect=0.\nfunc TestProcess_HappyPath(t *testing.T)\n// TestProcess_MalformedJSON: invalid JSON body → ProcessResultPoisoned.\n// Verify: no DB calls made.\nfunc TestProcess_MalformedJSON(t *testing.T)\n// TestProcess_EmptyEventID: EventID=\"\" → ProcessResultPoisoned.\nfunc TestProcess_EmptyEventID(t *testing.T)\n// TestProcess_DuplicateEvent: IsProcessed=true → ProcessResultDuplicate.\n// Verify: Insert NOT called.\nfunc TestProcess_DuplicateEvent(t *testing.T)\n// TestProcess_InsertFails: Insert returns error → ProcessResultError.\n// Verify: MarkProcessed not committed.\nfunc TestProcess_InsertFails(t *testing.T)\n// TestProcess_MilestoneDetected: Detect returns 10 → InsertMilestone and Publish called.\nfunc TestProcess_MilestoneDetected(t *testing.T)\n// TestProcess_MilestonePublishFails: Publish returns error → ProcessResultInserted (not error).\n// Click was committed; milestone saved; publish failure is non-fatal.\nfunc TestProcess_MilestonePublishFails(t *testing.T)\n// TestProcess_PanicRecovery: mock ClickRepo.Insert panics → Process returns ProcessResultError.\n// Verify: no panic propagates to caller.\nfunc TestProcess_PanicRecovery(t *testing.T)\n```\n```go\n// Integration test (//go:build integration):\n// Requires full stack running: analytics_db, rabbitmq.\n// TestDuplicateEvent_ClickCount1:\n// 1. Construct a URLClickedEvent with a fixed EventID UUID.\n// 2. Marshal to JSON.\n// 3. Directly call processor.Process twice with identical amqp091.Delivery.\n// 4. Assert: first call returns ProcessResultInserted.\n// 5. Assert: second call returns ProcessResultDuplicate.\n// 6. Assert: SELECT COUNT(*) FROM clicks WHERE ip_hash = event.IPHash → 1 (not 2).\n// 7. Assert: SELECT COUNT(*) FROM processed_events WHERE event_id = eventID → 1.\nfunc TestDuplicateEvent_ClickCount1(t *testing.T)\n```\n### 11.4 `milestone/detector_test.go`\n```go\n// TestDetect_NoThresholdCrossed: latestMilestone=0, newTotal=5 → returns 0.\nfunc TestDetect_NoThresholdCrossed(t *testing.T)\n// TestDetect_FirstThreshold: latestMilestone=0, newTotal=10 → returns 10.\nfunc TestDetect_FirstThreshold(t *testing.T)\n// TestDetect_FirstThresholdExceeded: latestMilestone=0, newTotal=15 → returns 10.\n// (lowest uncrossed threshold, not the exact count)\nfunc TestDetect_FirstThresholdExceeded(t *testing.T)\n// TestDetect_AlreadyAtThreshold: latestMilestone=10, newTotal=10 → returns 0.\n// (10 is already recorded)\nfunc TestDetect_AlreadyAtThreshold(t *testing.T)\n// TestDetect_SkipsToHigher: latestMilestone=10, newTotal=150 → returns 100.\nfunc TestDetect_SkipsToHigher(t *testing.T)\n// TestDetect_AllThresholdsCrossed: latestMilestone=0, newTotal=1500 → returns 10.\n// Only the lowest uncrossed is returned per call.\nfunc TestDetect_AllThresholdsCrossedReturnsLowest(t *testing.T)\n// TestDetect_BeyondAllThresholds: latestMilestone=1000, newTotal=50000 → returns 0.\nfunc TestDetect_BeyondAllThresholds(t *testing.T)\n// Table-driven test covering all threshold transitions:\nfunc TestDetect_AllTransitions(t *testing.T) // uses t.Run subtests\n```\n### 11.5 `handler/handler_test.go`\n```go\n// All tests use httptest.NewRecorder + httptest.NewRequest.\n// Mock ClickRepository injected via constructor.\n// TestStats_HappyPath: mock returns total=42, last24h=5, last7d=20, refs=[].\n// GET /stats/abc → 200, JSON fields match.\nfunc TestStats_HappyPath(t *testing.T)\n// TestStats_WithReferers: mock TopReferers returns 3 entries.\n// Response top_referers has 3 items in count-DESC order.\nfunc TestStats_WithReferers(t *testing.T)\n// TestStats_ZeroClicks: all counts return 0. Response is valid JSON with 0s, not null.\nfunc TestStats_ZeroClicks(t *testing.T)\n// TestStats_DBError: mock CountByCode returns error → 500.\nfunc TestStats_DBError(t *testing.T)\n// TestStats_TopReferers_NeverNull: even with no referers, top_referers is [] not null.\nfunc TestStats_TopReferers_NeverNull(t *testing.T)\n// TestTimeline_DayInterval: mock returns 3 period rows.\n// Response points formatted as \"2026-03-02\" strings.\nfunc TestTimeline_DayInterval(t *testing.T)\n// TestTimeline_HourInterval: mock returns 2 period rows.\n// Response points formatted as RFC3339 strings.\nfunc TestTimeline_HourInterval(t *testing.T)\n// TestTimeline_InvalidInterval: interval=\"week\" → 400.\nfunc TestTimeline_InvalidInterval(t *testing.T)\n// TestTimeline_MissingInterval: no ?interval param → defaults to \"day\", 200.\nfunc TestTimeline_MissingInterval(t *testing.T)\n// TestTimeline_EmptyPoints: mock returns empty slice → points:[] not null.\nfunc TestTimeline_EmptyPoints(t *testing.T)\n// TestHealth_Returns200: GET /health → 200 {\"status\":\"ok\",\"service\":\"analytics-service\"}.\nfunc TestHealth_Returns200(t *testing.T)\n// BenchmarkStats: mock-backed, measure p99 of /stats/:code handler.\n// Target: < 30ms with real DB; < 1ms with mocks.\nfunc BenchmarkStats(b *testing.B)\n// BenchmarkTimeline: mock-backed, measure p99 of /stats/:code/timeline handler.\nfunc BenchmarkTimeline(b *testing.B)\n```\n\n![GET /stats/:code Query Plan and Data Flow](./diagrams/tdd-diag-29.svg)\n\n---\n## 12. Performance Targets\n| Operation | Target | How to Measure |\n|---|---|---|\n| Click ingestion lag (publish → DB insert) | < 500ms p99 | Timestamp `URLClickedEvent.OccurredAt` vs `clicks.clicked_at` insert time; measure with 100 sequential clicks |\n| `GET /stats/:code` p99 (live DB) | < 30ms | `wrk -t4 -c20 -d30s http://localhost:8082/stats/<code>` with 1000+ click rows |\n| `GET /stats/:code/timeline?interval=day` p99 | < 50ms | `wrk -t2 -c10 -d30s` with 30 days of data |\n| `IsProcessed` (indexed SELECT by UUID PK) | < 5ms | `go test -bench=BenchmarkIsProcessed ./repository/...` |\n| `CountByCode` (index scan) | < 10ms | `go test -bench=BenchmarkCountByCode ./repository/...` with 10,000 click rows |\n| `Timeline` aggregation (1000 rows, day bucket) | < 20ms | `EXPLAIN ANALYZE` on timeline query; benchmark at scale |\n| `GET /health` p99 | < 10ms | (inherited from M1) |\n| `go test ./...` (unit, no DB) | < 10s | CI warm build |\n| `docker build` image size | < 20MB | `docker image ls analytics-service` |\n| Milestone detection + publish end-to-end | < 2s from 10th click commit | Observe `triggered_at` in milestones vs click timestamps |\n| Errgroup concurrency speedup for /stats | 4x vs sequential | Benchmark with 10ms mock query delay × 4 queries |\n**Index validation commands:**\n```bash\n# Confirm index scan on clicks_short_code_time for CountByCode\ndocker exec analytics_db psql -U analytics_user -d analytics_db -c \\\n  \"EXPLAIN ANALYZE SELECT COUNT(*) FROM clicks WHERE short_code = 'abc' AND clicked_at >= now() - interval '24h';\"\n# Must show: \"Index Scan using idx_clicks_short_code_time\"\n# Confirm partial index for TopReferers\ndocker exec analytics_db psql -U analytics_user -d analytics_db -c \\\n  \"EXPLAIN ANALYZE SELECT referer, COUNT(*) FROM clicks WHERE short_code='abc' AND referer IS NOT NULL GROUP BY referer ORDER BY 2 DESC LIMIT 5;\"\n# Must show: \"Index Scan using idx_clicks_referer\"\n```\n---\n## 13. Environment Variable Reference\n| Variable | Required | Example | Description |\n|---|---|---|---|\n| `PORT` | Yes | `8082` | HTTP listen port |\n| `SERVICE_NAME` | Yes | `analytics-service` | Embedded in log lines |\n| `DATABASE_DSN` | Yes | `postgres://analytics_user:analytics_secret@analytics_db:5432/analytics_db?sslmode=disable` | analytics_db connection |\n| `RABBITMQ_URL` | Yes | `amqp://admin:admin@rabbitmq:5672/` | AMQP broker |\n**No `JWT_SECRET`** for this milestone — stats endpoints are public. `JWT_SECRET` is added in M5 if the gateway requires it for proxied requests (gateway validates; analytics-service itself does not validate tokens per spec).\n**No `REDIS_ADDR`** — analytics-service has no cache. It does not share Redis with url-service or the gateway.\n---\n## 14. Anti-Pattern Guard Rail Checklist\nBefore completing this milestone, verify:\n- [ ] **No cross-service DB access.** `grep -r \"url_db\\|user_db\\|notification_db\" services/analytics-service/` returns nothing.\n- [ ] **No call to url-service on event ingestion.** `grep -r \"url-service\\|8081\" services/analytics-service/` returns nothing except comments. Trust the event; do not validate `short_code` against the URL Service.\n- [ ] **No raw IP storage.** `grep -r \"RemoteAddr\\|X-Forwarded-For\\|ip_address\" services/analytics-service/` returns nothing. Only `ip_hash` (pre-computed by url-service) is stored.\n- [ ] **Idempotency implemented.** `processed_events` table exists with UUID PK. `MarkProcessed` is called inside the same transaction as `Insert`. `IsProcessed` is checked before the transaction begins.\n- [ ] **Poison message ACKed, not NACKed.** `grep \"Ack\" services/analytics-service/consumer/` shows `ProcessResultPoisoned` maps to `Ack(false)`, not `Nack`.\n- [ ] **`/health` returns 200 when RabbitMQ is down.** The health handler has no dependency on the AMQP connection. Consumer pauses; service stays up.\n- [ ] **Milestone publish failure is non-fatal.** `detectAndRecordMilestone` logs a warning and returns on publish error. The click transaction is already committed before milestone detection runs.\n- [ ] **`date_trunc` interval is validated before use.** Handler validates `interval ∈ {\"day\", \"hour\"}` before passing to `Timeline`. No raw user input in SQL.\n- [ ] **`top_referers` is never null in response.** `StatsResponse.TopReferers` is initialized with `make([]RefererItem, 0)` when `refs` is empty — JSON encodes as `[]`, not `null`.\n- [ ] **`timeline.points` is never null in response.** Same initialization pattern.\n\n![Timeline date_trunc Bucketing Algorithm](./diagrams/tdd-diag-30.svg)\n\n---\n<!-- END_TDD_MOD -->\n\n\n<!-- TDD_MOD_ID: url-shortener-m5 -->\n# Technical Design Specification\n## Module: Notification Service + API Gateway + Circuit Breaker\n**Module ID:** `url-shortener-m5`\n---\n## 1. Module Charter\nThis module delivers the final two infrastructure components that complete the URL shortener system. The **Notification Service** is a pure event consumer: it subscribes to `url.created`, `url.deleted`, and `milestone.reached` events from the `notifications.events` RabbitMQ queue, persists a notification record per event, logs a mock email send, and exposes a JWT-protected `GET /notifications` endpoint for paginated retrieval. The **API Gateway** is the sole client-facing entry point: it validates JWTs locally (no user-service call per request), propagates `X-Correlation-ID`, enforces per-IP token-bucket rate limits via Redis, implements a three-state circuit breaker for the url-service proxy path, and routes all requests to the correct downstream service without containing any domain business logic. The `shared/logger` package is finalized here and retrofitted into all services with structured JSON fields including `correlation_id`.\nThis module does **not** implement email delivery (only log output), password reset, push notifications, WebSocket subscriptions, server-sent events, any form of aggregation or analytics within the gateway, load balancing across multiple replicas of a downstream service, OAuth, API keys, or mTLS. The gateway does not call user-service to verify tokens at request time — it uses the shared `JWT_SECRET` for local HMAC-SHA256 verification identically to every other service. The gateway does not inspect request bodies; it proxies them verbatim.\n**Upstream dependencies:** M1 (Docker Compose stack, `shared/events`, `shared/logger`, RabbitMQ, Redis), M2 (`shared/auth` JWTVerifier, `shared/middleware` RequireAuth), M3 (url-service on port 8081), M4 (analytics-service on port 8082). The `notifications.events` queue was declared in M1's startup but the consumer goroutine is first implemented here.\n**Downstream dependencies:** None. This is the terminal milestone. No subsequent service depends on notification-service or the gateway at the code level.\n**Invariants that must always hold after this milestone:**\n- The gateway is the only service with a port exposed to clients in production; all downstream services communicate only on the Docker internal `backend` network.\n- A JWT that fails HMAC-SHA256 verification at the gateway never reaches any downstream service.\n- The circuit breaker for url-service transitions through exactly three states (Closed → Open → HalfOpen → Closed); a retry loop without state is not a circuit breaker.\n- Rate limit counters for `/api/shorten` and `/r/:code` are stored in Redis (shared across hypothetical replicas), never in process-local memory.\n- If Redis is unavailable when a rate-limit check is attempted, the request is **allowed** (fail-open) and a warning is logged; no traffic is blocked due to a Redis outage.\n- Every notification event consumed from RabbitMQ results in exactly one `notifications` row and one log line, regardless of how many times the event is delivered.\n- `GET /notifications` returns only notifications belonging to the authenticated user's `sub` claim; cross-user access is impossible.\n---\n## 2. File Structure\nCreate files in the numbered order below. All paths are relative to the monorepo root.\n```\nurl-shortener/\n│\n├── services/notification-service/\n│   ├── migrations/\n│   │   └── 01  001_create_notifications.sql\n│   ├── repository/\n│   │   ├── 02  notification_repository.go\n│   │   └── 03  notification_repository_test.go\n│   ├── consumer/\n│   │   ├── 04  consumer.go              # AMQPConsumer setup (reuse M4 pattern)\n│   │   ├── 05  processor.go             # NotificationProcessor: parse + insert + log\n│   │   └── 06  processor_test.go\n│   ├── handler/\n│   │   ├── 07  notifications.go         # GET /notifications (auth required)\n│   │   ├── 08  health.go\n│   │   ├── 09  helpers.go\n│   │   └── 10  handler_test.go\n│   └── 11  main.go\n│\n├── gateway/\n│   ├── circuitbreaker/\n│   │   ├── 12  circuitbreaker.go        # CircuitBreaker state machine\n│   │   └── 13  circuitbreaker_test.go\n│   ├── ratelimit/\n│   │   ├── 14  ratelimit.go             # RateLimiter: Redis INCR + EXPIRE\n│   │   └── 15  ratelimit_test.go\n│   ├── proxy/\n│   │   ├── 16  proxy.go                 # ReverseProxy wrapper\n│   │   └── 17  proxy_test.go\n│   ├── middleware/\n│   │   ├── 18  correlation.go           # X-Correlation-ID inject/propagate\n│   │   ├── 19  jwt.go                   # Gateway JWT middleware (wraps shared/middleware)\n│   │   ├── 20  logging.go              # Request/response structured logging middleware\n│   │   └── 21  middleware_test.go\n│   ├── handler/\n│   │   ├── 22  health.go\n│   │   └── 23  handler_test.go\n│   ├── router/\n│   │   ├── 24  router.go               # Route table + registration\n│   │   └── 25  router_test.go\n│   └── 26  main.go\n│\n└── shared/\n    └── logger/\n        └── 27  logger.go               # Finalized zerolog wrapper (update from M1 stub)\n```\n**Total new files: 27** (excluding auto-generated `go.sum` changes and files already written in prior milestones).\n---\n## 3. Complete Data Model\n### 3.1 PostgreSQL Schema — `migrations/001_create_notifications.sql`\n```sql\n-- migrations/001_create_notifications.sql\nBEGIN;\nCREATE TABLE IF NOT EXISTS notifications (\n    id           UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id      UUID        NOT NULL,          -- JWT sub of the URL owner\n    event_type   TEXT        NOT NULL,          -- \"url.created\" | \"url.deleted\" | \"milestone.reached\"\n    payload      JSONB       NOT NULL,          -- raw event struct for debugging / future use\n    status       TEXT        NOT NULL DEFAULT 'sent',  -- 'pending' | 'sent' | 'failed'\n    created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),\n    sent_at      TIMESTAMPTZ NULL               -- set when mock send completes (= created_at in M5)\n);\n-- Primary list query: user's notifications, newest first, cursor-paginated.\nCREATE INDEX IF NOT EXISTS idx_notifications_user_id_created\n    ON notifications(user_id, created_at DESC);\n-- Deduplication: each event_id is processed at most once.\n-- Stores the RabbitMQ message's correlation_id + event_type as dedup key.\nCREATE TABLE IF NOT EXISTS processed_notifications (\n    event_key    TEXT        PRIMARY KEY,   -- \"<event_type>:<correlation_id>\" composite key\n    processed_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\nCOMMIT;\n```\n**Field rationale:**\n- `user_id UUID NOT NULL`: Extracted from `URLCreatedEvent.UserID`, `URLDeletedEvent.UserID`, or `MilestoneReachedEvent.UserID`. This is what makes `GET /notifications` user-scoped. Stored as UUID even though the column type is UUID — validated during event parse.\n- `event_type TEXT NOT NULL`: Matches the RabbitMQ routing key. Stored verbatim for client filtering (future).\n- `payload JSONB NOT NULL`: Full event struct persisted for auditability and future re-processing. Not used in M5 API responses but present for operational debugging.\n- `status TEXT NOT NULL DEFAULT 'sent'`: In M5, all notifications transition immediately from implicit `pending` to `sent` synchronously during processing. The column is present for forward-compatibility with async email queues.\n- `sent_at TIMESTAMPTZ NULL`: Set to `now()` when the mock send log line is emitted. Null if processing fails before the log line.\n- `processed_notifications.event_key TEXT PRIMARY KEY`: Composite string `\"<event_type>:<correlation_id>\"`. Using `correlation_id` as the dedup discriminator means the same logical notification from the same request is deduplicated. If two genuinely different events share the same `correlation_id` (pathological case), the second is dropped — acceptable given the low probability and the mock-only email implementation.\n### 3.2 Go Structs — Notification Service\n```go\n// repository/notification_repository.go\npackage repository\nimport \"time\"\n// Notification is a single persisted notification record.\ntype Notification struct {\n    ID        string    // UUID v4, primary key; set by DB DEFAULT\n    UserID    string    // UUID string; JWT sub of the URL owner\n    EventType string    // routing key: \"url.created\" | \"url.deleted\" | \"milestone.reached\"\n    Payload   []byte    // raw JSON of the event struct\n    Status    string    // \"pending\" | \"sent\" | \"failed\"\n    CreatedAt time.Time // set by DB DEFAULT\n    SentAt    *time.Time // nil until mock send completes\n}\n// NotificationSummary is the projection returned by ListByUser.\n// Omits the raw payload from API responses.\ntype NotificationSummary struct {\n    ID        string    // used as cursor value\n    UserID    string\n    EventType string\n    Status    string\n    CreatedAt time.Time\n    SentAt    *time.Time\n}\n// Sentinel errors\nvar (\n    ErrNotificationNotFound = errors.New(\"notification not found\")\n)\n```\n```go\n// handler/notifications.go — API response types\npackage handler\n// NotificationListResponse is the JSON body returned by GET /notifications.\ntype NotificationListResponse struct {\n    Notifications []NotificationItem `json:\"notifications\"`\n    NextCursor    *string            `json:\"next_cursor,omitempty\"`\n}\n// NotificationItem is a single entry in the list response.\ntype NotificationItem struct {\n    ID        string  `json:\"id\"`\n    EventType string  `json:\"event_type\"`\n    Status    string  `json:\"status\"`\n    CreatedAt string  `json:\"created_at\"` // RFC3339\n    SentAt    *string `json:\"sent_at,omitempty\"`\n}\n```\n### 3.3 Go Structs — Circuit Breaker\n```go\n// gateway/circuitbreaker/circuitbreaker.go\npackage circuitbreaker\nimport (\n    \"sync\"\n    \"sync/atomic\"\n    \"time\"\n)\n// State represents the circuit breaker's current operating mode.\ntype State int32\nconst (\n    StateClosed   State = iota // Normal operation; requests flow through.\n    StateOpen                  // Failure threshold exceeded; requests rejected immediately.\n    StateHalfOpen              // Probe mode; one request allowed through to test recovery.\n)\n// Config holds the circuit breaker's tuning parameters.\ntype Config struct {\n    // FailureThreshold is the number of consecutive failures within Window\n    // required to trip the circuit from Closed → Open.\n    FailureThreshold int\n    // Window is the observation period for counting failures.\n    // Failures older than Window do not count toward the threshold.\n    Window time.Duration\n    // OpenDuration is how long the circuit stays Open before transitioning\n    // to HalfOpen and allowing a single probe request.\n    OpenDuration time.Duration\n}\n// DefaultConfig returns the spec-required settings.\n//   FailureThreshold: 5 consecutive failures\n//   Window:          10 seconds\n//   OpenDuration:    30 seconds\nfunc DefaultConfig() Config {\n    return Config{\n        FailureThreshold: 5,\n        Window:           10 * time.Second,\n        OpenDuration:     30 * time.Second,\n    }\n}\n// CircuitBreaker implements the three-state pattern for a single downstream target.\n// All exported methods are goroutine-safe.\ntype CircuitBreaker struct {\n    cfg            Config\n    mu             sync.Mutex    // protects state, failureCount, lastFailureAt, openedAt\n    state          State\n    failureCount   int           // consecutive failures in the current window\n    lastFailureAt  time.Time     // time of the most recent failure; used for window reset\n    openedAt       time.Time     // time the circuit transitioned to Open\n}\n// NewCircuitBreaker constructs a CircuitBreaker in the Closed state.\nfunc NewCircuitBreaker(cfg Config) *CircuitBreaker\n```\n### 3.4 Go Structs — Rate Limiter\n```go\n// gateway/ratelimit/ratelimit.go\npackage ratelimit\nimport (\n    \"context\"\n    \"time\"\n    \"github.com/redis/go-redis/v9\"\n    \"github.com/rs/zerolog\"\n)\n// RateLimiter implements per-IP token-bucket rate limiting using Redis INCR + EXPIRE.\n// Each IP+route combination has an independent counter with a fixed window.\ntype RateLimiter struct {\n    client *redis.Client  // may be nil (fail-open on Redis unavailability)\n    log    zerolog.Logger\n}\n// NewRateLimiter constructs a RateLimiter.\n// client may be nil — the RateLimiter fails open when client is nil.\nfunc NewRateLimiter(client *redis.Client, log zerolog.Logger) *RateLimiter\n// AllowResult is the outcome of a rate limit check.\ntype AllowResult struct {\n    Allowed    bool\n    RetryAfter time.Duration // > 0 when Allowed=false; seconds to wait\n    Remaining  int64         // requests remaining in the current window (informational)\n}\n// RouteLimit defines the rate limit policy for one route class.\ntype RouteLimit struct {\n    Key    string        // route identifier; used as part of Redis key prefix\n    Limit  int64         // max requests per Window per IP\n    Window time.Duration // sliding-window duration\n}\n// Pre-defined route limits (from spec):\nvar (\n    LimitShorten = RouteLimit{Key: \"shorten\", Limit: 10, Window: time.Minute}\n    LimitRedirect = RouteLimit{Key: \"redirect\", Limit: 300, Window: time.Minute}\n)\n```\n### 3.5 Go Structs — Gateway Proxy\n```go\n// gateway/proxy/proxy.go\npackage proxy\nimport (\n    \"net/http\"\n    \"net/http/httputil\"\n    \"net/url\"\n    \"time\"\n    \"github.com/rs/zerolog\"\n)\n// DownstreamTarget represents a single upstream service the gateway routes to.\ntype DownstreamTarget struct {\n    Name    string   // service name for logging: \"url-service\", etc.\n    BaseURL *url.URL // parsed base URL; e.g. http://url-service:8081\n}\n// ReverseProxy wraps httputil.ReverseProxy with error handling and logging.\ntype ReverseProxy struct {\n    targets map[string]*httputil.ReverseProxy // keyed by target.Name\n    log     zerolog.Logger\n    // HTTP client shared across all proxies; controls timeouts.\n    client  *http.Client\n}\n// ProxyConfig configures the reverse proxy behavior.\ntype ProxyConfig struct {\n    DialTimeout           time.Duration // default: 5s\n    ResponseHeaderTimeout time.Duration // default: 30s (spec: 30s timeout counts as failure)\n    MaxIdleConnsPerHost   int           // default: 10\n}\n```\n### 3.6 Structured Log Entry (finalized schema)\n```go\n// shared/logger/logger.go\n// LogFields documents the canonical set of structured fields on every log line.\n// This is documentation only; actual emission uses zerolog's fluent API.\n// All services MUST produce logs conforming to this schema.\ntype LogFields struct {\n    Level         string `json:\"level\"`           // \"debug\"|\"info\"|\"warn\"|\"error\"\n    Time          int64  `json:\"time\"`             // Unix milliseconds (zerolog.TimeFormatUnixMs)\n    Service       string `json:\"service\"`          // injected at logger construction\n    CorrelationID string `json:\"correlation_id\"`   // from X-Correlation-ID; \"\" if not available\n    Method        string `json:\"method\"`           // HTTP method; \"\" for non-request logs\n    Path          string `json:\"path\"`             // HTTP path; \"\" for non-request logs\n    Status        int    `json:\"status\"`           // HTTP response status; 0 for non-request logs\n    DurationMS    int64  `json:\"duration_ms\"`      // handler duration; 0 for non-request logs\n    Msg           string `json:\"msg\"`              // human-readable message\n}\n```\n\n![API Gateway Internal Module Architecture](./diagrams/tdd-diag-31.svg)\n\n---\n## 4. Interface Contracts\n### 4.1 `NotificationRepository`\n```go\n// repository/notification_repository.go\n// NotificationRepository defines persistence for notification records.\n// All implementations must be safe for concurrent use.\ntype NotificationRepository interface {\n    // Insert writes a new notification row and sets sent_at = now() atomically.\n    // Uses the pool directly (no external transaction; the notification service\n    // has no dual-write requirement — there is no outbox here).\n    // Returns a wrapped error on DB failure.\n    Insert(ctx context.Context, n Notification) error\n    // ListByUser returns a cursor-paginated list of notifications for userID,\n    // ordered by created_at DESC (newest first).\n    // afterID: if non-empty, returns rows with (created_at, id) strictly less\n    //          than the anchor row identified by afterID (same cursor logic as M3).\n    // limit: maximum rows to return; caller passes pageSize+1 to detect next page.\n    // Returns empty slice (not nil) when no rows match.\n    ListByUser(ctx context.Context, userID string, afterID string, limit int) ([]NotificationSummary, error)\n    // IsProcessed checks whether eventKey exists in processed_notifications.\n    // Returns true if found, false on not-found or DB error (fail-open for idempotency).\n    IsProcessed(ctx context.Context, eventKey string) (bool, error)\n    // MarkProcessed inserts eventKey into processed_notifications.\n    // ON CONFLICT DO NOTHING makes this idempotent.\n    // Uses pool directly (same connection as Insert is not required — see § 5.2).\n    MarkProcessed(ctx context.Context, eventKey string) error\n}\n```\n**SQL queries:**\n```sql\n-- Insert\nINSERT INTO notifications (user_id, event_type, payload, status, sent_at)\nVALUES ($1, $2, $3, 'sent', now())\nRETURNING id, created_at\n-- ListByUser (with cursor)\nSELECT id, user_id, event_type, status, created_at, sent_at\nFROM notifications\nWHERE user_id = $1\n  AND ($2::uuid IS NULL OR (created_at, id) < (\n      SELECT created_at, id FROM notifications WHERE id = $2::uuid\n  ))\nORDER BY created_at DESC, id DESC\nLIMIT $3\n-- IsProcessed\nSELECT 1 FROM processed_notifications WHERE event_key = $1\n-- MarkProcessed\nINSERT INTO processed_notifications (event_key) VALUES ($1)\nON CONFLICT (event_key) DO NOTHING\n```\n### 4.2 `CircuitBreaker`\n```go\n// gateway/circuitbreaker/circuitbreaker.go\n// Allow checks whether a request should be forwarded to the downstream service.\n// Returns (true, nil) in Closed or HalfOpen state (probe allowed).\n// Returns (false, ErrCircuitOpen) in Open state — caller must return 503.\n// Returns (false, ErrCircuitOpen) in HalfOpen state if a probe is already in-flight\n//   (HalfOpen allows exactly ONE concurrent probe; subsequent calls are rejected).\n//\n// State transition rules (enforced inside Allow with mu held):\n//   Closed:   always returns true.\n//   Open:     if time.Since(openedAt) >= cfg.OpenDuration → transition to HalfOpen.\n//             Still in cooldown → return false.\n//   HalfOpen: if no probe in-flight → mark probe in-flight, return true.\n//             Probe already in-flight → return false (treat as Open).\nfunc (cb *CircuitBreaker) Allow() (bool, error)\n// RecordSuccess notifies the circuit breaker that the last proxied request succeeded.\n// State transition rules:\n//   Closed:   reset failureCount to 0.\n//   HalfOpen: transition to Closed, clear probe in-flight flag, reset failureCount.\n//   Open:     no-op (should not receive success in Open state; log warning).\nfunc (cb *CircuitBreaker) RecordSuccess()\n// RecordFailure notifies the circuit breaker that the last proxied request failed.\n// A failure is defined as: HTTP 5xx response from downstream, or a timeout/connection error.\n// State transition rules:\n//   Closed:   increment failureCount; if failureCount >= cfg.FailureThreshold\n//             AND time.Since(lastFailureAt) <= cfg.Window → trip to Open; record openedAt.\n//             If time.Since(lastFailureAt) > cfg.Window → reset failureCount to 1 (new window).\n//   HalfOpen: probe failed → transition back to Open; record new openedAt; clear probe flag.\n//   Open:     no-op (should not receive failure in Open state; log warning).\nfunc (cb *CircuitBreaker) RecordFailure()\n// State returns the current state without acquiring the mutex (uses atomic read).\n// Callers use this for observability/logging only — do not make routing decisions\n// based on this value; use Allow() for that (which holds the mutex).\nfunc (cb *CircuitBreaker) State() State\n// ErrCircuitOpen is returned by Allow when the circuit is in Open or HalfOpen-no-probe state.\nvar ErrCircuitOpen = errors.New(\"circuit breaker open\")\n```\n**State machine invariants:**\n- `failureCount` is always 0 in `StateOpen` and `StateHalfOpen`.\n- `openedAt.IsZero()` is true only in `StateClosed`.\n- The probe in-flight flag is a `bool` field `probeInFlight` protected by `mu`. It is set to `true` when `Allow()` transitions HalfOpen → allows probe, and cleared by `RecordSuccess()` or `RecordFailure()` from HalfOpen.\n### 4.3 `RateLimiter`\n```go\n// gateway/ratelimit/ratelimit.go\n// Allow checks whether the request from ip should be permitted for the given route policy.\n// Redis key format: \"ratelimit:{route.Key}:{ip}\"\n// Example: \"ratelimit:shorten:192.168.1.1\"\n//\n// Algorithm (atomic at Redis server level):\n//   1. INCR \"ratelimit:{route.Key}:{ip}\" → current count\n//   2. If current count == 1: EXPIRE key route.Window (sets TTL on first request in window)\n//   3. If current count > route.Limit: return AllowResult{Allowed: false, RetryAfter: TTL of key}\n//   4. Else: return AllowResult{Allowed: true, Remaining: route.Limit - current}\n//\n// If Redis client is nil or any Redis error occurs:\n//   Log warning with error details.\n//   Return AllowResult{Allowed: true} — fail-open; do NOT block traffic.\n//\n// RetryAfter is obtained via TTL command after the INCR reveals the limit is exceeded.\n// TTL returns the remaining seconds; if TTL returns -1 (no expiry), use route.Window as fallback.\n//\n// Parameters:\n//   ctx:   request context; used for Redis call timeout\n//   ip:    client IP string extracted from X-Forwarded-For or RemoteAddr\n//   route: RouteLimit policy for this endpoint\n//\n// Returns AllowResult. Never returns an error — all errors result in fail-open.\nfunc (rl *RateLimiter) Allow(ctx context.Context, ip string, route RouteLimit) AllowResult\n```\n**Redis command sequence (INCR + conditional EXPIRE):**\n```go\n// Implementation inside Allow:\npipe := rl.client.Pipeline()\nincrCmd := pipe.Incr(ctx, key)\n// Conditional EXPIRE only on first request avoids resetting TTL on every request.\n// Use a Lua script for atomic INCR+EXPIRE-if-new:\nconst luaIncrExpire = `\nlocal current = redis.call('INCR', KEYS[1])\nif current == 1 then\n    redis.call('EXPIRE', KEYS[1], ARGV[1])\nend\nreturn current\n`\n// Execute as a single atomic script — no pipeline needed:\nresult, err := rl.client.Eval(ctx, luaIncrExpire, []string{key},\n    int(route.Window.Seconds())).Int64()\n```\n**Why Lua script over pipeline:** A pipeline of INCR + EXPIRE is not atomic — two concurrent requests could both INCR and both see `current == 1`, causing double EXPIRE. The Lua script executes atomically at the Redis server, making this race impossible.\n### 4.4 `ReverseProxy.Forward`\n```go\n// gateway/proxy/proxy.go\n// Forward proxies the incoming request to the named target service.\n// targetName must match a key in rp.targets (registered at construction).\n// Injects X-Correlation-ID into the forwarded request if not already present.\n// Sets X-Forwarded-For with the client IP.\n//\n// On success: streams the downstream response to w verbatim (headers + body).\n// On target not found: writes 502 {\"error\":\"unknown upstream\"}.\n// On proxy error (connection refused, timeout, circuit open):\n//   The circuitBreaker parameter (passed at construction per-target) handles\n//   RecordFailure() before this function returns; caller must not double-record.\n//\n// Timeout: ResponseHeaderTimeout=30s is enforced by the underlying http.Client.\n// A timeout error is treated as a downstream failure for circuit breaker purposes.\nfunc (rp *ReverseProxy) Forward(targetName string, w http.ResponseWriter, r *http.Request)\n```\n**`httputil.ReverseProxy` error hook:**\n```go\n// Set on the httputil.ReverseProxy at construction:\nproxy.ErrorHandler = func(w http.ResponseWriter, r *http.Request, err error) {\n    log.Error().Err(err).Str(\"target\", targetName).Msg(\"proxy error\")\n    cb.RecordFailure()\n    writeJSON(w, http.StatusBadGateway, ErrorResponse{Error: \"upstream error\"})\n}\n// ModifyResponse is used to intercept 5xx from downstream:\nproxy.ModifyResponse = func(resp *http.Response) error {\n    if resp.StatusCode >= 500 {\n        cb.RecordFailure()\n    } else {\n        cb.RecordSuccess()\n    }\n    return nil\n}\n```\n### 4.5 Correlation Middleware\n```go\n// gateway/middleware/correlation.go\n// CorrelationMiddleware is an http.Handler wrapper that:\n//  1. Reads X-Correlation-ID from the incoming request header.\n//  2. If absent or empty, generates a new UUID v4.\n//  3. Sets X-Correlation-ID on the request before passing to next.\n//  4. Sets X-Correlation-ID on the response.\n//  5. Stores the correlation ID in the request context under correlationIDKey.\n//\n// All downstream forwarded requests carry this header.\n// All log lines within the request's context use this ID.\nfunc CorrelationMiddleware(next http.Handler) http.Handler\n// CorrelationIDFromContext retrieves the correlation ID stored by CorrelationMiddleware.\n// Returns empty string if not present (should not happen after middleware runs).\nfunc CorrelationIDFromContext(ctx context.Context) string\n// contextKey type is unexported to prevent collisions.\ntype contextKey string\nconst correlationIDKey contextKey = \"correlation_id\"\n```\n### 4.6 Gateway JWT Middleware\n```go\n// gateway/middleware/jwt.go\n// GatewayJWTMiddleware returns an http.Handler wrapper that:\n//  1. Reads Authorization: Bearer <token> from the incoming request.\n//  2. Verifies the token using the shared JWTVerifier (local HMAC; no network call).\n//  3. On success: forwards the request to next, adding X-User-ID and X-User-Email\n//     headers with values from the verified claims (so downstream services can\n//     optionally trust these without re-verifying).\n//  4. On failure: returns 401 {\"error\":\"unauthorized\"} immediately;\n//     the downstream service never receives the request.\n//\n// Routes exempt from JWT validation: POST /api/auth/register, POST /api/auth/login.\n// These are matched by path prefix \"/api/auth/\"; all other /api/* routes require JWT.\n// GET /r/:code does NOT require JWT (public redirect).\n// GET /health does NOT require JWT.\n//\n// verifier: a shared/auth.JWTVerifier constructed with JWT_SECRET from environment.\n// log: structured logger with \"service\":\"gateway\" pre-set.\nfunc GatewayJWTMiddleware(verifier sharedauth.JWTVerifier, log zerolog.Logger) func(http.Handler) http.Handler\n```\n### 4.7 `shared/logger.New`\n```go\n// shared/logger/logger.go\n// New returns a zerolog.Logger configured for structured JSON output.\n// serviceName is embedded in every log line as \"service\".\n// w is the output writer; pass os.Stdout in production.\n//\n// Configuration applied:\n//   zerolog.TimeFieldFormat = zerolog.TimeFormatUnixMs\n//   Level: zerolog.InfoLevel (overridable via LOG_LEVEL env var: debug|info|warn|error)\n//   CallerSkipFrameCount: 2 (so Caller() reports the actual call site, not the logger wrapper)\n//\n// The returned Logger is value-safe to copy and store in structs.\n// No global zerolog.GlobalLevel is set — each service sets its own level.\nfunc New(serviceName string, w io.Writer) zerolog.Logger\n// WithCorrelationID returns a child logger with correlation_id field added.\n// Call at the start of each HTTP request handler with the ID from context.\n// Usage: log := logger.WithCorrelationID(baseLog, correlationID)\nfunc WithCorrelationID(log zerolog.Logger, correlationID string) zerolog.Logger\n// RequestLogger returns an http.Handler middleware that logs each request/response.\n// Emits one log line per request with all LogFields populated.\n// Extracts correlation_id from context (set by CorrelationMiddleware).\nfunc RequestLogger(log zerolog.Logger) func(http.Handler) http.Handler\n```\n\n![Gateway Request Pipeline — Full Sequence](./diagrams/tdd-diag-32.svg)\n\n---\n## 5. Algorithm Specification\n### 5.1 Notification Processor — Full Algorithm\n```\nPROCEDURE NotificationProcessor.Process(ctx, d amqp091.Delivery) ProcessResult:\n  -- Step 0: Panic recovery (defer at top)\n  DEFER recover() → log.Error, return ProcessResultError\n  -- Step 1: Determine event type from routing key or payload\n  routingKey = d.RoutingKey  -- \"url.created\" | \"url.deleted\" | \"milestone.reached\"\n  -- Step 2: Parse into the correct event struct based on routing key\n  SWITCH routingKey:\n  CASE \"url.created\":\n    var event events.URLCreatedEvent\n    IF json.Unmarshal(d.Body, &event) fails → log.Error, return ProcessResultPoisoned\n    userID = event.UserID\n    userEmail = event.UserEmail\n    correlationID = event.CorrelationID\n    message = fmt.Sprintf(\"New short URL created: %s → %s\", event.ShortCode, event.OriginalURL)\n  CASE \"url.deleted\":\n    var event events.URLDeletedEvent\n    IF json.Unmarshal(d.Body, &event) fails → log.Error, return ProcessResultPoisoned\n    userID = event.UserID\n    userEmail = event.UserEmail\n    correlationID = event.CorrelationID\n    message = fmt.Sprintf(\"Short URL deleted: %s\", event.ShortCode)\n  CASE \"milestone.reached\":\n    var event events.MilestoneReachedEvent\n    IF json.Unmarshal(d.Body, &event) fails → log.Error, return ProcessResultPoisoned\n    userID = event.UserID\n    userEmail = event.UserEmail\n    correlationID = event.CorrelationID\n    message = fmt.Sprintf(\"Milestone reached: %d clicks on %s\", event.Milestone, event.ShortCode)\n  DEFAULT:\n    log.Warn().Str(\"routing_key\", routingKey).Msg(\"unknown routing key; ACKing\")\n    return ProcessResultPoisoned\n  -- Step 3: Validate required fields\n  IF userID == \"\" OR correlationID == \"\":\n    log.Error().Str(\"routing_key\", routingKey).Msg(\"missing user_id or correlation_id; ACKing\")\n    return ProcessResultPoisoned\n  -- Step 4: Build dedup key\n  eventKey = routingKey + \":\" + correlationID\n  -- Step 5: Idempotency pre-check\n  already, _ = repo.IsProcessed(ctx, eventKey)  -- errors treated as false (fail-open)\n  IF already:\n    log.Debug().Str(\"event_key\", eventKey).Msg(\"duplicate notification; skipping\")\n    return ProcessResultDuplicate\n  -- Step 6: Insert notification row\n  n = Notification{\n      UserID:    userID,\n      EventType: routingKey,\n      Payload:   d.Body,\n      Status:    \"sent\",\n  }\n  IF repo.Insert(ctx, n) fails:\n    log.Error().Err(err).Msg(\"notification insert failed\")\n    return ProcessResultError\n  -- Step 7: Mock send — log the notification\n  log.Info().\n      Str(\"correlation_id\", correlationID).\n      Str(\"event_type\", routingKey).\n      Str(\"user_email\", userEmail).\n      Str(\"message\", message).\n      Msg(\"would send email to user\")\n  -- Step 8: Mark processed (after successful insert + log)\n  IF repo.MarkProcessed(ctx, eventKey) fails:\n    -- Insert succeeded; log error but don't fail the message.\n    -- On redelivery, Insert will create a second row (acceptable: dedup pre-check\n    -- returned false, so re-run will create a duplicate notification but not crash).\n    -- Accept this rare edge case; it requires a service crash between step 6 and step 8.\n    log.Error().Err(err).Str(\"event_key\", eventKey).Msg(\"mark processed failed; duplicate possible on redeliver\")\n  return ProcessResultInserted\nEND PROCEDURE\n```\n**Why MarkProcessed is NOT in the same transaction as Insert:** The notification service has no dual-write requirement (no outbox, no RabbitMQ publish from within the notification handler). Using two sequential DB operations (Insert, then MarkProcessed) simplifies the code. The rare crash-between-operations case creates a duplicate notification row — acceptable given mock email delivery in M5.\n### 5.2 Circuit Breaker State Machine — Detailed Transitions\n```\nPROCEDURE CircuitBreaker.Allow() (bool, error):\n  cb.mu.Lock()\n  DEFER cb.mu.Unlock()\n  SWITCH cb.state:\n  CASE StateClosed:\n    return true, nil\n  CASE StateOpen:\n    IF time.Since(cb.openedAt) >= cb.cfg.OpenDuration:\n      -- Cooldown elapsed; transition to HalfOpen for probe\n      cb.state = StateHalfOpen\n      cb.probeInFlight = true\n      cb.failureCount = 0\n      return true, nil   -- this request IS the probe\n    ELSE:\n      return false, ErrCircuitOpen\n  CASE StateHalfOpen:\n    IF cb.probeInFlight:\n      -- A probe is already in-flight; reject this request\n      return false, ErrCircuitOpen\n    ELSE:\n      -- Edge case: HalfOpen but no probe in-flight (should not happen; defensive)\n      cb.probeInFlight = true\n      return true, nil\n  END SWITCH\nEND PROCEDURE\nPROCEDURE CircuitBreaker.RecordSuccess():\n  cb.mu.Lock()\n  DEFER cb.mu.Unlock()\n  SWITCH cb.state:\n  CASE StateClosed:\n    cb.failureCount = 0    -- reset window counter\n  CASE StateHalfOpen:\n    -- Probe succeeded; circuit healed\n    cb.state = StateClosed\n    cb.probeInFlight = false\n    cb.failureCount = 0\n    cb.openedAt = time.Time{}   -- zero value signals Closed state\n  CASE StateOpen:\n    cb.log.Warn().Msg(\"circuit breaker: RecordSuccess called in Open state (unexpected)\")\n  END SWITCH\nEND PROCEDURE\nPROCEDURE CircuitBreaker.RecordFailure():\n  cb.mu.Lock()\n  DEFER cb.mu.Unlock()\n  now = time.Now()\n  SWITCH cb.state:\n  CASE StateClosed:\n    -- Check if this failure is within the current window\n    IF cb.failureCount == 0 OR now.Sub(cb.lastFailureAt) > cb.cfg.Window:\n      -- New window; start fresh\n      cb.failureCount = 1\n    ELSE:\n      cb.failureCount++\n    cb.lastFailureAt = now\n    IF cb.failureCount >= cb.cfg.FailureThreshold:\n      -- Trip to Open\n      cb.state = StateOpen\n      cb.openedAt = now\n      cb.failureCount = 0\n      cb.log.Warn().\n          Int(\"threshold\", cb.cfg.FailureThreshold).\n          Dur(\"window\", cb.cfg.Window).\n          Msg(\"circuit breaker tripped to Open\")\n  CASE StateHalfOpen:\n    -- Probe failed; return to Open with fresh openedAt\n    cb.state = StateOpen\n    cb.openedAt = now\n    cb.probeInFlight = false\n    cb.failureCount = 0\n    cb.log.Warn().Msg(\"circuit breaker half-open probe failed; returning to Open\")\n  CASE StateOpen:\n    cb.log.Warn().Msg(\"circuit breaker: RecordFailure called in Open state (unexpected)\")\n  END SWITCH\nEND PROCEDURE\n```\n\n![Circuit Breaker State Machine](./diagrams/tdd-diag-33.svg)\n\n### 5.3 Gateway Request Routing Algorithm\n```\nPROCEDURE GatewayRouter.ServeHTTP(w http.ResponseWriter, r *http.Request):\n  -- Middleware chain (applied in order, outermost first):\n  -- 1. CorrelationMiddleware — generate/propagate X-Correlation-ID\n  -- 2. RequestLogger — log all requests (applied after correlation to capture ID)\n  -- 3. GatewayJWTMiddleware — validate JWT for /api/* routes except /api/auth/*\n  -- 4. RateLimitMiddleware — apply per-IP limits based on route pattern\n  -- 5. Route-specific handler (proxy forward or error response)\n  path = r.URL.Path\n  -- Route matching (evaluated in specificity order):\n  MATCH path:\n  CASE \"GET /health\":\n    → handler.NewHealthHandler(\"gateway\", log)\n  CASE \"POST /api/auth/register\":\n    → NO JWT required\n    → NO rate limit\n    → rp.Forward(\"user-service\", w, r)\n  CASE \"POST /api/auth/login\":\n    → NO JWT required\n    → NO rate limit\n    → rp.Forward(\"user-service\", w, r)\n    -- Strip /api prefix: forward as POST /login to user-service\n  CASE \"GET /r/{code}\":\n    → NO JWT required\n    → RateLimitMiddleware(LimitRedirect)\n    → circuitBreaker.Allow() check\n    → rp.Forward(\"url-service\", w, r)\n    -- Forward as GET /{code}\n  CASE \"POST /api/shorten\":\n    → JWT required\n    → RateLimitMiddleware(LimitShorten)\n    → circuitBreaker.Allow() check\n    → rp.Forward(\"url-service\", w, r)\n    -- Forward as POST /shorten\n  CASE \"GET /api/urls\":\n    → JWT required\n    → rp.Forward(\"url-service\", w, r)\n    -- Forward as GET /urls\n  CASE \"DELETE /api/urls/{code}\":\n    → JWT required\n    → rp.Forward(\"url-service\", w, r)\n  CASE \"GET /api/stats/{code}\":\n    → NO JWT required (public stats)\n    → rp.Forward(\"analytics-service\", w, r)\n    -- Forward as GET /stats/{code}\n  CASE \"GET /api/stats/{code}/timeline\":\n    → NO JWT required\n    → rp.Forward(\"analytics-service\", w, r)\n  CASE \"GET /api/me\":\n    → JWT required\n    → rp.Forward(\"user-service\", w, r)\n    -- Forward as GET /me\n  CASE \"GET /api/notifications\":\n    → JWT required\n    → rp.Forward(\"notification-service\", w, r)\n    -- Forward as GET /notifications\n  DEFAULT:\n    → 404 {\"error\":\"not found\"}\n  END MATCH\nEND PROCEDURE\n```\n**Path stripping:** The gateway routes `/api/shorten` to url-service as `/shorten`. Use `httputil.ReverseProxy` with a custom `Director` that strips the `/api` prefix for all `/api/*` forwarding. The `/r/{code}` path strips `/r` and forwards as `/{code}`. The `/api/auth/*` paths strip `/api/auth` and forward as `/*` (e.g., `/register`, `/login`).\n```go\n// Director function for url-service proxy:\ndirector := func(req *http.Request) {\n    req.URL.Scheme = target.Scheme\n    req.URL.Host = target.Host\n    // Strip /api prefix\n    req.URL.Path = strings.TrimPrefix(req.URL.Path, \"/api\")\n    // Preserve query string\n    req.Header.Set(\"X-Forwarded-For\", extractClientIP(req))\n    req.Header.Set(\"X-Correlation-ID\", CorrelationIDFromContext(req.Context()))\n}\n```\n### 5.4 Rate Limit Middleware Integration\n```\nPROCEDURE RateLimitMiddleware(route RouteLimit, rl *RateLimiter) func(http.Handler) http.Handler:\n  RETURN func(next http.Handler) http.Handler:\n    RETURN http.HandlerFunc(func(w http.ResponseWriter, r *http.Request):\n      ip = extractClientIP(r)\n      result = rl.Allow(r.Context(), ip, route)\n      IF !result.Allowed:\n        retryAfterSecs = int(result.RetryAfter.Seconds())\n        IF retryAfterSecs < 1: retryAfterSecs = 1\n        w.Header().Set(\"Retry-After\", strconv.Itoa(retryAfterSecs))\n        w.Header().Set(\"X-RateLimit-Limit\", strconv.FormatInt(route.Limit, 10))\n        w.Header().Set(\"X-RateLimit-Remaining\", \"0\")\n        writeJSON(w, http.StatusTooManyRequests, ErrorResponse{Error: \"rate limit exceeded\"})\n        return\n      next.ServeHTTP(w, r)\n    )\nEND PROCEDURE\n```\n### 5.5 Circuit Breaker Middleware Integration\n```\nPROCEDURE CircuitBreakerMiddleware(cb *CircuitBreaker) func(http.Handler) http.Handler:\n  RETURN func(next http.Handler) http.Handler:\n    RETURN http.HandlerFunc(func(w http.ResponseWriter, r *http.Request):\n      allowed, err = cb.Allow()\n      IF !allowed:\n        log.Warn().Str(\"path\", r.URL.Path).Msg(\"circuit breaker open; rejecting request\")\n        writeJSON(w, http.StatusServiceUnavailable,\n            ErrorResponse{Error: \"service unavailable\"})\n        return\n      -- Request is allowed (Closed state or HalfOpen probe)\n      -- RecordSuccess/RecordFailure is called inside ReverseProxy.ModifyResponse\n      -- and ReverseProxy.ErrorHandler — not here. This avoids double-recording.\n      next.ServeHTTP(w, r)\n    )\nEND PROCEDURE\n```\n**Sequence of middleware for url-service routes:**\n```\nCorrelationMiddleware\n  → RequestLogger\n    → GatewayJWTMiddleware (if /api/*)\n      → RateLimitMiddleware (if shorten or redirect)\n        → CircuitBreakerMiddleware (url-service routes only)\n          → ReverseProxy.Forward(\"url-service\", ...)\n```\n\n![Circuit Breaker Struct Memory Layout](./diagrams/tdd-diag-34.svg)\n\n### 5.6 Structured Logging Propagation Across Services\nEvery HTTP handler in every service must:\n1. Extract `X-Correlation-ID` from the request header at the start of the handler.\n2. Call `logger.WithCorrelationID(baseLog, correlationID)` to get a request-scoped logger.\n3. Use the request-scoped logger for all log calls within that handler's execution path.\n4. When making outbound HTTP calls (not applicable in M5 for services other than gateway), forward the `X-Correlation-ID` header.\n**Request logger middleware (applied in all services, not just gateway):**\n```go\n// shared/logger/logger.go\nfunc RequestLogger(log zerolog.Logger) func(http.Handler) http.Handler {\n    return func(next http.Handler) http.Handler {\n        return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n            start := time.Now()\n            correlationID := r.Header.Get(\"X-Correlation-ID\")\n            reqLog := log.With().\n                Str(\"correlation_id\", correlationID).\n                Str(\"method\", r.Method).\n                Str(\"path\", r.URL.Path).\n                Logger()\n            // Wrap ResponseWriter to capture status code\n            rw := &responseWriter{ResponseWriter: w, status: http.StatusOK}\n            next.ServeHTTP(rw, r)\n            reqLog.Info().\n                Int(\"status\", rw.status).\n                Int64(\"duration_ms\", time.Since(start).Milliseconds()).\n                Msg(\"request completed\")\n        })\n    }\n}\n// responseWriter wraps http.ResponseWriter to capture the written status code.\ntype responseWriter struct {\n    http.ResponseWriter\n    status int\n}\nfunc (rw *responseWriter) WriteHeader(code int) {\n    rw.status = code\n    rw.ResponseWriter.WriteHeader(code)\n}\n```\n### 5.7 GET /notifications Handler Algorithm\n```\nPROCEDURE HandleListNotifications(w http.ResponseWriter, r *http.Request):\n  claims, ok = middleware.ClaimsFromContext(r.Context())  -- from RequireAuth\n  IF !ok → 401 {\"error\":\"unauthorized\"}\n  afterCursor = r.URL.Query().Get(\"after\")\n  pageSizeStr = r.URL.Query().Get(\"limit\")\n  pageSize = 20  -- default\n  IF pageSizeStr != \"\":\n    pageSize, err = strconv.Atoi(pageSizeStr)\n    IF err OR pageSize < 1 → 400 {\"error\":\"limit must be a positive integer\"}\n  pageSize = clamp(pageSize, 1, 100)\n  rows, err = repo.ListByUser(r.Context(), claims.Sub, afterCursor, pageSize+1)\n  IF err → 500 + log.Error\n  hasMore = len(rows) > pageSize\n  IF hasMore:\n    rows = rows[:pageSize]\n  var nextCursor *string\n  IF hasMore:\n    last = rows[len(rows)-1].ID\n    nextCursor = &last\n  items = make([]NotificationItem, len(rows))\n  FOR i, n := range rows:\n    items[i] = NotificationItem{\n        ID:        n.ID,\n        EventType: n.EventType,\n        Status:    n.Status,\n        CreatedAt: n.CreatedAt.UTC().Format(time.RFC3339),\n    }\n    IF n.SentAt != nil:\n      s = n.SentAt.UTC().Format(time.RFC3339)\n      items[i].SentAt = &s\n  writeJSON(w, 200, NotificationListResponse{\n      Notifications: items,\n      NextCursor:    nextCursor,\n  })\nEND PROCEDURE\n```\n\n![Token Bucket Rate Limiter — Redis INCR + EXPIRE Algorithm](./diagrams/tdd-diag-35.svg)\n\n### 5.8 Gateway Startup Sequence\n```\nPROCEDURE GatewayMain():\n  1. Parse all env vars with mustGetEnv; abort on missing.\n  2. log = logger.New(\"gateway\", os.Stdout)\n  3. redisClient, err = ConnectRedis(ctx, redisAddr)\n     IF err: log.Warn — rate limiter will fail-open\n  4. verifier = sharedauth.NewJWTVerifier([]byte(jwtSecret))\n  5. rateLimiter = ratelimit.NewRateLimiter(redisClient, log)\n  6. urlServiceCB = circuitbreaker.NewCircuitBreaker(circuitbreaker.DefaultConfig())\n  7. Construct ReverseProxy with targets:\n       \"url-service\"           → URL_SERVICE_URL\n       \"analytics-service\"     → ANALYTICS_SERVICE_URL\n       \"user-service\"          → USER_SERVICE_URL\n       \"notification-service\"  → NOTIFICATION_SERVICE_URL\n     Each target gets its own httputil.ReverseProxy instance.\n     url-service proxy gets urlServiceCB injected into ModifyResponse + ErrorHandler.\n     Other proxies have no circuit breaker in M5 (only url-service specified).\n  8. Perform startup health checks (§ 5.2 of M1 spec) — log warnings for unhealthy.\n  9. Build mux via router.New(...) — inject all dependencies.\n  10. Apply middleware stack:\n       handler = CorrelationMiddleware(\n           RequestLogger(log)(\n               mux\n           )\n       )\n      Note: JWT and rate limit middleware are applied per-route, not globally.\n  11. Start http.Server on PORT with:\n       ReadTimeout:  5s\n       WriteTimeout: 35s  -- 30s proxy timeout + 5s overhead\n       IdleTimeout:  120s\n  12. Block on server.ListenAndServe.\n  13. On SIGTERM: server.Shutdown(10s context).\nEND PROCEDURE\n```\n\n![Redis Key Namespace Layout (Dual Role)](./diagrams/tdd-diag-36.svg)\n\n---\n## 6. State Machine: Circuit Breaker\n```\nStates: Closed → Open → HalfOpen → Closed\n        HalfOpen → Open (on probe failure)\nTransitions:\n  Closed  →[failureCount >= threshold within window]→ Open\n  Open    →[openDuration elapsed, Allow() called]→ HalfOpen\n  HalfOpen→[RecordSuccess()]→ Closed\n  HalfOpen→[RecordFailure()]→ Open (new openedAt)\nIllegal transitions (must never occur):\n  Closed  → HalfOpen  (must pass through Open)\n  Open    → Closed    (must pass through HalfOpen probe)\n  HalfOpen→ HalfOpen  (no self-transition; probe resolves to Closed or Open)\n  Any state → any state without mutex held\nHalfOpen probe semantics:\n  - At most ONE request is allowed through as a probe.\n  - All other concurrent requests during HalfOpen → rejected (treated as Open).\n  - probeInFlight bool is the single-probe enforcement mechanism.\n  - probeInFlight is set true in Allow(), cleared in RecordSuccess() or RecordFailure().\nFailure counting semantics (Closed state):\n  - failureCount resets to 1 (not 0) when a failure arrives after Window elapsed.\n  - This models a sliding window: failures in the previous window don't count.\n  - Consecutive failures within Window accumulate; non-consecutive failures may not trip.\nObservability:\n  - State() method uses atomic int32 read for lock-free observability.\n  - State field is a State (int32); transitions write with mu held, read atomically.\n```\n```go\n// Atomic state read (no mutex):\nfunc (cb *CircuitBreaker) State() State {\n    return State(atomic.LoadInt32((*int32)(&cb.state)))\n}\n// State transitions write the state field while holding mu:\n// cb.state = StateOpen  (inside mu-protected block)\n```\n\n![X-Correlation-ID Propagation Across Sync and Async Boundaries](./diagrams/tdd-diag-37.svg)\n\n---\n## 7. Error Handling Matrix\n### Notification Service\n| Error | Detected By | Recovery | ACK/NACK | Logged? | Notes |\n|---|---|---|---|---|---|\n| `MALFORMED_JSON` | `json.Unmarshal` | Log error, ACK | ACK | Error | Poison message |\n| `UNKNOWN_ROUTING_KEY` | routing key switch | Log warn, ACK | ACK | Warn | Future-proof; unknown events dropped |\n| `MISSING_USER_ID` | field validation | Log error, ACK | ACK | Error | Event schema violation |\n| `DUPLICATE_EVENT` | `IsProcessed` → true | Log debug, ACK | ACK | Debug | Normal at-least-once redelivery |\n| `INSERT_FAIL` | `repo.Insert` | Log error, NACK requeue | NACK | Error | Transient DB error |\n| `MARK_PROCESSED_FAIL` | `repo.MarkProcessed` | Log error, ACK | ACK | Error | Insert succeeded; rare redelivery possible |\n| `CONSUMER_PANIC` | `recover()` in supervisor | Log error, restart after 5s | N/A | Error | Delivery not ACKed; broker redelivers |\n| `AMQP_DISCONNECTED` | Delivery channel closed | Log warn, reconnect loop | N/A | Warn | `/health` still 200 |\n| `LIST_NOTIFICATIONS_DB_FAIL` | `repo.ListByUser` | Log error, 500 | N/A | Error | |\n| `JWT_MISSING` | `RequireAuth` middleware | 401 | N/A | No | |\n| `JWT_INVALID` | `RequireAuth` middleware | 401 | N/A | Warn | |\n### API Gateway\n| Error | Detected By | HTTP Status | Response Body | Logged? | Notes |\n|---|---|---|---|---|---|\n| `RATE_LIMIT_EXCEEDED` | `RateLimiter.Allow` → false | 429 | `{\"error\":\"rate limit exceeded\"}` | No | `Retry-After` header set |\n| `CIRCUIT_OPEN` | `CircuitBreaker.Allow` → false | 503 | `{\"error\":\"service unavailable\"}` | Warn | Only for url-service routes |\n| `JWT_INVALID` | `GatewayJWTMiddleware` | 401 | `{\"error\":\"unauthorized\"}` | Warn | Request never forwarded |\n| `JWT_MISSING` | `GatewayJWTMiddleware` | 401 | `{\"error\":\"unauthorized\"}` | No | |\n| `JWT_EXPIRED` | `GatewayJWTMiddleware` | 401 | `{\"error\":\"unauthorized\"}` | No | No expiry detail in response |\n| `DOWNSTREAM_5XX` | `ModifyResponse` status check | Proxied as-is | Downstream body | Warn + RecordFailure | Client sees the 5xx |\n| `DOWNSTREAM_TIMEOUT` | `ErrorHandler` + context deadline | 502 | `{\"error\":\"upstream error\"}` | Error + RecordFailure | 30s timeout |\n| `DOWNSTREAM_CONN_REFUSED` | `ErrorHandler` | 502 | `{\"error\":\"upstream error\"}` | Error + RecordFailure | Service down |\n| `REDIS_DOWN_FOR_RATE_LIMIT` | `RateLimiter` nil client or error | 200 (allowed) | — | Warn | Fail-open: never block traffic |\n| `UNKNOWN_ROUTE` | mux default | 404 | `{\"error\":\"not found\"}` | No | |\n| `UPSTREAM_UNKNOWN` | `ReverseProxy.Forward` no target | 502 | `{\"error\":\"unknown upstream\"}` | Error | Programming error |\n| `CORRELATION_ID_MISSING` | `CorrelationMiddleware` | — | — | No | Generated transparently |\n---\n## 8. Route Registration in `gateway/main.go`\n```go\n// gateway/main.go — full route table with middleware chains\n// Build each route's middleware stack explicitly.\n// net/http 1.22 method+path patterns used throughout.\njwtMw := middleware.GatewayJWTMiddleware(verifier, log)\nrateLimitShorten  := middleware.RateLimitMiddleware(ratelimit.LimitShorten, rateLimiter, log)\nrateLimitRedirect := middleware.RateLimitMiddleware(ratelimit.LimitRedirect, rateLimiter, log)\ncbMw := middleware.CircuitBreakerMiddleware(urlServiceCB, log)\nmux := http.NewServeMux()\n// Health — no auth, no rate limit\nmux.HandleFunc(\"GET /health\", handler.NewHealthHandler(\"gateway\", log))\n// Auth routes — no JWT, no rate limit, no circuit breaker\nmux.HandleFunc(\"POST /api/auth/register\",\n    chain(rp.HandlerFor(\"user-service\")))\nmux.HandleFunc(\"POST /api/auth/login\",\n    chain(rp.HandlerFor(\"user-service\")))\n// Public redirect — rate limited, circuit broken\nmux.Handle(\"GET /r/{code}\",\n    rateLimitRedirect(cbMw(rp.HandlerFor(\"url-service\"))))\n// URL service — JWT + rate limit (shorten) + circuit breaker\nmux.Handle(\"POST /api/shorten\",\n    jwtMw(rateLimitShorten(cbMw(rp.HandlerFor(\"url-service\")))))\nmux.Handle(\"GET /api/urls\",\n    jwtMw(cbMw(rp.HandlerFor(\"url-service\"))))\nmux.Handle(\"DELETE /api/urls/{code}\",\n    jwtMw(cbMw(rp.HandlerFor(\"url-service\"))))\n// Analytics — public\nmux.Handle(\"GET /api/stats/{code}\",\n    rp.HandlerFor(\"analytics-service\"))\nmux.Handle(\"GET /api/stats/{code}/timeline\",\n    rp.HandlerFor(\"analytics-service\"))\n// User service — JWT\nmux.Handle(\"GET /api/me\",\n    jwtMw(rp.HandlerFor(\"user-service\")))\n// Notification service — JWT\nmux.Handle(\"GET /api/notifications\",\n    jwtMw(rp.HandlerFor(\"notification-service\")))\n// Global middleware (outermost)\nhandler := middleware.CorrelationMiddleware(\n    logger.RequestLogger(log)(mux),\n)\n```\n**`rp.HandlerFor(name string) http.Handler`** returns a pre-built `http.Handler` that calls `rp.Forward(name, w, r)` for the named downstream target. This enables clean composition with the middleware chain.\n{{DIAGRAM:tdd-diag-38}}\n---\n## 9. Concurrency Specification\n### 9.1 Circuit Breaker\n| Field | Access Pattern | Protection |\n|---|---|---|\n| `state` | Written under `mu`; read via `atomic.LoadInt32` | `sync.Mutex` for writes; atomic for reads |\n| `failureCount` | Read and written under `mu` | `sync.Mutex` |\n| `lastFailureAt` | Read and written under `mu` | `sync.Mutex` |\n| `openedAt` | Read and written under `mu` | `sync.Mutex` |\n| `probeInFlight` | Read and written under `mu` | `sync.Mutex` |\n**Lock ordering:** There is only one mutex in `CircuitBreaker`. No lock ordering issue is possible.\n**Concurrent Allow + RecordFailure:** `Allow()` acquires `mu`, reads state, potentially transitions, returns. `RecordFailure()` also acquires `mu`. If multiple goroutines call `Allow()` concurrently (one probe is allowed through, others rejected), `probeInFlight` prevents multiple probes. The mutex serializes all state access — no TOCTOU window.\n### 9.2 Rate Limiter\nThe Lua script executes atomically on the Redis server. No local locking is required in the Go process. Concurrent requests from the same IP for the same route each independently call `Eval` on the Lua script — Redis serializes them server-side. The `*redis.Client` connection pool is goroutine-safe per `go-redis` documentation.\n### 9.3 Reverse Proxy\n`httputil.ReverseProxy` is goroutine-safe — each `ServeHTTP` call handles one request independently. The `Director`, `ModifyResponse`, and `ErrorHandler` functions are called within the goroutine serving that request. `RecordSuccess()` and `RecordFailure()` on the circuit breaker are called from these hooks and are protected by the circuit breaker's mutex.\n### 9.4 Notification Consumer\nIdentical single-goroutine consumer pattern to analytics-service (M4 § 8.1). Prefetch=1 enforces sequential processing. No shared mutable state within the processor goroutine. `*pgxpool.Pool` is goroutine-safe.\n### 9.5 Gateway HTTP Server\n`net/http` launches one goroutine per request. All state that handlers read (circuit breaker, rate limiter, proxy targets, JWT verifier) is either:\n- Immutable after construction (proxy targets, JWT verifier secret)\n- Goroutine-safe via internal locking (circuit breaker mutex, Redis client)\n- Goroutine-safe at Redis server level (rate limit counters)\nNo global mutable variables exist in the gateway codebase.\n{{DIAGRAM:tdd-diag-39}}\n---\n## 10. Implementation Sequence with Checkpoints\n### Phase 1 — Notification Service: Schema + Consumer + API (2–2.5 hr)\n1. Write `migrations/001_create_notifications.sql` (§ 3.1).\n2. Apply migration:\n   ```bash\n   docker exec -i notification_db psql -U notification_user -d notification_db \\\n     < services/notification-service/migrations/001_create_notifications.sql\n   ```\n3. Verify: `docker exec notification_db psql -U notification_user -d notification_db -c \"\\d notifications\"`.\n4. Write `repository/notification_repository.go`: `Notification`, `NotificationSummary`, `NotificationRepository` interface, `pgxNotificationRepository`, all four methods.\n5. Write `consumer/consumer.go`: `NewAMQPConsumer` — declare exchange (idempotent), declare `notifications.events` queue with three bindings (`url.created`, `url.deleted`, `milestone.reached`), set Qos(1).\n6. Write `consumer/processor.go`: `NotificationProcessor`, `Process` following § 5.1.\n7. Write `handler/notifications.go`: `HandleListNotifications` (§ 5.7) behind `RequireAuth`.\n8. Wire `main.go`: DB connect, repositories, processor, consumer supervisor goroutine, routes.\n9. Run `docker compose up --build notification-service`.\n**Checkpoint:**\n```bash\n# Trigger a URLCreatedEvent via url-service:\nTOKEN=$(curl -s -X POST http://localhost:8083/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"password123\"}' | jq -r .token)\ncurl -s -X POST http://localhost:8081/shorten \\\n  -H \"Authorization: Bearer $TOKEN\" -H \"Content-Type: application/json\" \\\n  -d '{\"url\":\"https://notification-test.example.com\"}' > /dev/null\nsleep 5  # outbox poller + notification consumer\n# Verify notification row:\ndocker exec notification_db psql -U notification_user -d notification_db \\\n  -c \"SELECT event_type, status, sent_at FROM notifications ORDER BY created_at DESC LIMIT 1;\"\n# Expected: event_type=url.created, status=sent, sent_at IS NOT NULL\n# Check logs for mock email:\ndocker compose logs notification-service | grep \"would send email\"\n# Expected: at least one \"would send email to user\" log line\n# List notifications via API:\ncurl -s http://localhost:8084/notifications \\\n  -H \"Authorization: Bearer $TOKEN\" | jq .\n# Expected: {\"notifications\":[{\"id\":\"...\",\"event_type\":\"url.created\",\"status\":\"sent\",...}],\"next_cursor\":null}\n# Wrong user:\nTOKEN2=$(curl -s -X POST http://localhost:8083/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"bob@example.com\",\"password\":\"password123\"}' | jq -r .token)\ncurl -s http://localhost:8084/notifications \\\n  -H \"Authorization: Bearer $TOKEN2\" | jq '.notifications | length'\n# Expected: 0 (bob has no notifications)\n```\n### Phase 2 — shared/logger: Finalize Structured Logger (1–1.5 hr)\n1. Finalize `shared/logger/logger.go`: `New`, `WithCorrelationID`, `RequestLogger`, `responseWriter` (§ 4.7, § 5.6).\n2. Run `go test ./... -v` in `shared/`.\n3. Update all services' `main.go` to use `logger.RequestLogger(log)` as a middleware around the mux.\n4. Verify structured output: `docker compose logs url-service 2>&1 | head -5 | python3 -m json.tool`.\n**Checkpoint:**\n```bash\ncurl -s http://localhost:8081/health > /dev/null\ndocker compose logs url-service 2>&1 | tail -3 | python3 -m json.tool\n# Expected output contains fields: level, time, service, correlation_id, method, path, status, duration_ms, msg\n# correlation_id should be present (empty string or UUID if called via gateway)\n```\n### Phase 3 — Gateway: Routing + Reverse Proxy + Correlation Middleware (2–2.5 hr)\n1. Add `github.com/google/uuid` to `gateway/go.mod`.\n2. Write `middleware/correlation.go`: `CorrelationMiddleware`, `CorrelationIDFromContext` (§ 4.5).\n3. Write `proxy/proxy.go`: `ReverseProxy`, `Forward`, `HandlerFor`, director with path stripping, `ModifyResponse`, `ErrorHandler` (§ 4.4).\n4. Write `router/router.go`: full route table from § 8 (stubs for JWT + rate limit — wire them as pass-through for now).\n5. Write `handler/health.go`: `NewHealthHandler(\"gateway\", log)`.\n6. Write `gateway/main.go`: env parsing, startup health checks, server configuration.\n7. Run `docker compose up --build gateway`.\n**Checkpoint:**\n```bash\n# Direct proxy test:\ncurl -s http://localhost:8080/health | jq .\n# Expected: {\"status\":\"ok\",\"service\":\"gateway\"}\n# Auth passthrough (no JWT enforcement yet):\ncurl -s -X POST http://localhost:8080/api/auth/register \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"charlie@example.com\",\"password\":\"password123\"}' | jq .\n# Expected: 201 {\"user_id\":\"...\",\"email\":\"charlie@example.com\"}\n# Correlation ID propagation:\ncurl -v http://localhost:8080/health 2>&1 | grep \"X-Correlation-ID\"\n# Expected: response header X-Correlation-ID: <uuid>\n# Pass custom correlation ID:\ncurl -v -H \"X-Correlation-ID: test-corr-id-001\" http://localhost:8080/health 2>&1 \\\n  | grep \"X-Correlation-ID\"\n# Expected: response header X-Correlation-ID: test-corr-id-001 (echoed back)\n# Gateway logs show correlation_id: \"test-corr-id-001\"\n```\n### Phase 4 — Gateway: JWT Middleware (1–1.5 hr)\n1. Write `middleware/jwt.go`: `GatewayJWTMiddleware` (§ 4.6).\n2. Wire JWT middleware into route table for all `/api/*` routes except `/api/auth/*`.\n3. Add `JWT_SECRET` to `gateway/` environment block in `docker-compose.yml`.\n4. Write `middleware/middleware_test.go`: JWT middleware tests (§ 11.3).\n5. Run `docker compose up --build gateway`.\n**Checkpoint:**\n```bash\n# Protected route without JWT:\ncurl -s -o /dev/null -w \"%{http_code}\" http://localhost:8080/api/urls \\\n  -H \"Authorization: Bearer invalidtoken\"\n# Expected: 401\n# Auth route without JWT (should pass to user-service):\ncurl -s -o /dev/null -w \"%{http_code}\" -X POST http://localhost:8080/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"wrongpass\"}'\n# Expected: 401 (from user-service, not gateway JWT check)\n# Protected route with valid JWT:\nTOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"password123\"}' | jq -r .token)\ncurl -s -o /dev/null -w \"%{http_code}\" http://localhost:8080/api/urls \\\n  -H \"Authorization: Bearer $TOKEN\"\n# Expected: 200\n# X-User-ID header forwarded to downstream:\n# Check url-service logs after above request; should contain user_id from JWT claims\n```\n### Phase 5 — Gateway: Redis Rate Limiter (1.5–2 hr)\n1. Write `ratelimit/ratelimit.go`: `RateLimiter`, `Allow`, Lua script (§ 4.3).\n2. Write `ratelimit/ratelimit_test.go`: unit + integration tests (§ 11.4).\n3. Write `middleware/logging.go` (rate limit logging).\n4. Wire `RateLimitMiddleware` for `POST /api/shorten` (LimitShorten) and `GET /r/{code}` (LimitRedirect).\n5. Run `go test ./ratelimit/... -v`.\n6. Run `docker compose up --build gateway`.\n**Checkpoint:**\n```bash\n# Rate limit test: POST /api/shorten 11 times from same IP\nTOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"password123\"}' | jq -r .token)\nfor i in {1..11}; do\n  STATUS=$(curl -s -o /dev/null -w \"%{http_code}\" \\\n    -X POST http://localhost:8080/api/shorten \\\n    -H \"Authorization: Bearer $TOKEN\" \\\n    -H \"Content-Type: application/json\" \\\n    -d \"{\\\"url\\\":\\\"https://rate-limit-test.com/$i\\\"}\")\n  echo \"Request $i: $STATUS\"\ndone\n# Expected: requests 1-10 return 201, request 11 returns 429\n# Verify Retry-After header on 11th request:\ncurl -s -o /dev/null -w \"%{http_code}\\n\" -D - \\\n  -X POST http://localhost:8080/api/shorten \\\n  -H \"Authorization: Bearer $TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"url\":\"https://rate-limit-test.com/12\"}' | grep -E \"429|Retry-After\"\n# Expected: 429 + Retry-After: <seconds>\n# Redis down fail-open test:\ndocker compose stop redis\ncurl -s -o /dev/null -w \"%{http_code}\" \\\n  -X POST http://localhost:8080/api/shorten \\\n  -H \"Authorization: Bearer $TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"url\":\"https://redis-down-test.com\"}'\n# Expected: 201 (not 503 — fail-open)\ndocker compose start redis\n```\n### Phase 6 — Gateway: Circuit Breaker (1.5–2 hr)\n1. Write `circuitbreaker/circuitbreaker.go`: `CircuitBreaker`, `Allow`, `RecordSuccess`, `RecordFailure`, `State` (§ 4.2, § 5.2).\n2. Write `circuitbreaker/circuitbreaker_test.go` (§ 11.2).\n3. Wire `CircuitBreakerMiddleware` for url-service routes.\n4. Run `go test ./circuitbreaker/... -v`.\n5. Run `docker compose up --build gateway`.\n**Checkpoint:**\n```bash\n# Trip the circuit breaker by making url-service return 5xx:\n# Stop url-service to cause connection refused (counts as failure):\ndocker compose stop url-service\n# 5 requests should trip the breaker:\nTOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"password123\"}' | jq -r .token)\nfor i in {1..5}; do\n  curl -s -o /dev/null -w \"%{http_code} \" \\\n    http://localhost:8080/api/urls -H \"Authorization: Bearer $TOKEN\"\ndone\n# Expected: 502 502 502 502 502\n# 6th request should get circuit breaker response (503):\nsleep 1\ncurl -s http://localhost:8080/api/urls -H \"Authorization: Bearer $TOKEN\"\n# Expected: 503 {\"error\":\"service unavailable\"}\n# Restart url-service; wait 30s for circuit to probe:\ndocker compose start url-service\nsleep 31  # OpenDuration = 30s\ncurl -s -o /dev/null -w \"%{http_code}\" \\\n  http://localhost:8080/api/urls -H \"Authorization: Bearer $TOKEN\"\n# Expected: 200 (circuit closed after successful probe)\n```\n### Phase 7 — Structured Logging Across All Services (1–1.5 hr)\n1. Confirm `shared/logger.RequestLogger` is wired in all five services' `main.go`.\n2. Add `WithCorrelationID` call in every handler that accesses request context.\n3. Verify `X-Correlation-ID` is forwarded by gateway's `Director` function to all downstream services.\n4. Check that async events carry `CorrelationID` through to notification and analytics consumers' log output.\n**Checkpoint:**\n```bash\nCORR_ID=\"e2e-test-$(date +%s)\"\nTOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"alice@example.com\",\"password\":\"password123\"}' | jq -r .token)\ncurl -s -X POST http://localhost:8080/api/shorten \\\n  -H \"Authorization: Bearer $TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"X-Correlation-ID: $CORR_ID\" \\\n  -d '{\"url\":\"https://e2e-logging-test.com\"}' > /dev/null\nsleep 5  # outbox + consumers\n# Correlation ID must appear in all service logs:\nfor svc in gateway url-service analytics-service notification-service; do\n  COUNT=$(docker compose logs $svc 2>&1 | grep \"$CORR_ID\" | wc -l)\n  echo \"$svc: $COUNT log lines with correlation ID\"\ndone\n# Expected: gateway >= 1, url-service >= 1, analytics-service >= 1, notification-service >= 1\n```\n### Phase 8 — End-to-End Integration Test + Rate Limit Test (1.5–2 hr)\n1. Write `test/e2e_m5_test.go` (§ 11.6).\n2. Run full E2E test: `go test -tags integration -v -timeout 120s ./test/...`.\n**Checkpoint:** All E2E tests pass. `go vet ./...` clean across all services. `go test -race ./...` clean.\n---\n## 11. Test Specification\n### 11.1 `repository/notification_repository_test.go` (integration)\n```go\n// Build tag: //go:build integration\n// Requires: notification_db running. DSN from TEST_DATABASE_DSN env var.\n// TestInsert_HappyPath: Insert notification → query returns row with status=\"sent\", sent_at IS NOT NULL.\nfunc TestInsert_HappyPath(t *testing.T)\n// TestInsert_PayloadPreserved: payload JSONB round-trips correctly.\nfunc TestInsert_PayloadPreserved(t *testing.T)\n// TestListByUser_OnlyOwnerRows: insert notifications for two users; ListByUser(user1) returns only user1's.\nfunc TestListByUser_OnlyOwnerRows(t *testing.T)\n// TestListByUser_Pagination: insert 5 notifications for same user; page by 2; cursor chain covers all 5.\nfunc TestListByUser_Pagination(t *testing.T)\n// TestListByUser_EmptyCursor: first page returns newest first.\nfunc TestListByUser_EmptyCursor(t *testing.T)\n// TestIsProcessed_NotFound: unknown eventKey returns false, nil.\nfunc TestIsProcessed_NotFound(t *testing.T)\n// TestMarkProcessed_Idempotent: two calls with same eventKey → no error.\nfunc TestMarkProcessed_Idempotent(t *testing.T)\n// TestIsProcessed_AfterMark: IsProcessed returns true after MarkProcessed.\nfunc TestIsProcessed_AfterMark(t *testing.T)\n```\n### 11.2 `circuitbreaker/circuitbreaker_test.go`\n```go\n// All tests are pure unit tests; no external dependencies.\n// TestNewCircuitBreaker_InitialState: state is Closed; failureCount is 0.\nfunc TestNewCircuitBreaker_InitialState(t *testing.T)\n// TestAllow_Closed_AlwaysReturnsTrue: 100 concurrent Allow() calls on Closed CB all return true.\nfunc TestAllow_Closed_AlwaysReturnsTrue(t *testing.T)\n// TestTrip_AfterThresholdFailures: 5 RecordFailure() within window → State() returns Open.\nfunc TestTrip_AfterThresholdFailures(t *testing.T)\n// TestAllow_Open_ReturnsError: after trip, Allow() returns (false, ErrCircuitOpen).\nfunc TestAllow_Open_ReturnsError(t *testing.T)\n// TestHalfOpen_AfterOpenDuration: after OpenDuration elapses, Allow() transitions to HalfOpen.\n// Use a Config with OpenDuration=100ms for fast tests.\nfunc TestHalfOpen_AfterOpenDuration(t *testing.T)\n// TestHalfOpen_OnlyOneProbeAllowed: two concurrent Allow() in HalfOpen → one returns true, one false.\nfunc TestHalfOpen_OnlyOneProbeAllowed(t *testing.T)\n// TestHalfOpen_ProbeSuccess_TransitionsClosed: RecordSuccess() in HalfOpen → State() returns Closed.\nfunc TestHalfOpen_ProbeSuccess_TransitionsClosed(t *testing.T)\n// TestHalfOpen_ProbeFailure_TransitionsOpen: RecordFailure() in HalfOpen → State() returns Open.\nfunc TestHalfOpen_ProbeFailure_TransitionsOpen(t *testing.T)\n// TestWindowReset: 3 failures, then gap > Window, then 5 more failures → trips on 5th (not 3rd).\nfunc TestWindowReset(t *testing.T)\n// TestRecordSuccess_Closed_ResetsCount: 4 failures + 1 success + 4 failures → no trip (count reset).\nfunc TestRecordSuccess_Closed_ResetsCount(t *testing.T)\n// TestConcurrentAccessNoPanic: 100 goroutines concurrently call Allow/RecordSuccess/RecordFailure.\n// Run with go test -race. Expected: no panic, no data race.\nfunc TestConcurrentAccessNoPanic(t *testing.T)\n// TestState_AtomicRead: goroutine-safe read via State() while another goroutine transitions.\nfunc TestState_AtomicRead(t *testing.T)\n// BenchmarkAllow_Closed: < 1µs per call.\nfunc BenchmarkAllow_Closed(b *testing.B)\n// BenchmarkAllow_Open: < 1µs per call (mu + time check only).\nfunc BenchmarkAllow_Open(b *testing.B)\n```\n### 11.3 `middleware/middleware_test.go`\n```go\n// All tests use httptest.NewRecorder + httptest.NewRequest.\n// TestCorrelationMiddleware_GeneratesIDWhenAbsent: no X-Correlation-ID in request →\n// response header has UUID v4; context contains same ID.\nfunc TestCorrelationMiddleware_GeneratesIDWhenAbsent(t *testing.T)\n// TestCorrelationMiddleware_PropagatesExisting: X-Correlation-ID: \"abc\" →\n// response header echoes \"abc\"; context contains \"abc\".\nfunc TestCorrelationMiddleware_PropagatesExisting(t *testing.T)\n// TestCorrelationIDFromContext_Present: returns stored ID and true.\nfunc TestCorrelationIDFromContext_Present(t *testing.T)\n// TestCorrelationIDFromContext_Absent: returns \"\", false.\nfunc TestCorrelationIDFromContext_Absent(t *testing.T)\n// TestGatewayJWT_ValidToken_CallsNext: valid token → next handler called, 200.\nfunc TestGatewayJWT_ValidToken_CallsNext(t *testing.T)\n// TestGatewayJWT_InvalidToken_Returns401: invalid token → 401, next NOT called.\nfunc TestGatewayJWT_InvalidToken_Returns401(t *testing.T)\n// TestGatewayJWT_MissingHeader_Returns401: no Authorization header → 401.\nfunc TestGatewayJWT_MissingHeader_Returns401(t *testing.T)\n// TestGatewayJWT_ExpiredToken_Returns401: expired token → 401.\nfunc TestGatewayJWT_ExpiredToken_Returns401(t *testing.T)\n// TestGatewayJWT_AuthRouteExempt: POST /api/auth/register → next called without JWT.\nfunc TestGatewayJWT_AuthRouteExempt(t *testing.T)\n// TestGatewayJWT_PublicRedirect_Exempt: GET /r/abc → next called without JWT.\nfunc TestGatewayJWT_PublicRedirect_Exempt(t *testing.T)\n// TestGatewayJWT_ForwardsUserHeaders: valid token → X-User-ID and X-User-Email set on forwarded request.\nfunc TestGatewayJWT_ForwardsUserHeaders(t *testing.T)\n```\n### 11.4 `ratelimit/ratelimit_test.go`\n```go\n// Unit tests use a nil Redis client to test fail-open behavior.\n// Integration tests use TEST_REDIS_ADDR env var; build tag: //go:build integration.\n// TestAllow_NilClient_FailOpen: nil *redis.Client → AllowResult.Allowed = true.\nfunc TestAllow_NilClient_FailOpen(t *testing.T)\n// TestAllow_RedisError_FailOpen: Redis returns error (use mock) → AllowResult.Allowed = true.\nfunc TestAllow_RedisError_FailOpen(t *testing.T)\n// TestAllow_UnderLimit: calls 1..limit all return Allowed=true.\nfunc TestAllow_UnderLimit(t *testing.T) // integration\n// TestAllow_ExactlyAtLimit: call number limit returns Allowed=true; call limit+1 returns false.\nfunc TestAllow_ExactlyAtLimit(t *testing.T) // integration\n// TestAllow_RetryAfterPositive: when Allowed=false, RetryAfter > 0.\nfunc TestAllow_RetryAfterPositive(t *testing.T) // integration\n// TestAllow_DifferentIPs_Independent: IP A at limit, IP B still allowed.\nfunc TestAllow_DifferentIPs_Independent(t *testing.T) // integration\n// TestAllow_DifferentRoutes_Independent: shorten at limit, redirect still allowed for same IP.\nfunc TestAllow_DifferentRoutes_Independent(t *testing.T) // integration\n// TestAllow_WindowExpiry: fill window, wait for TTL to expire, fill again → all allowed.\n// Use RouteLimit with Window=2s for fast test.\nfunc TestAllow_WindowExpiry(t *testing.T) // integration\n// TestAllow_ConcurrentRequests_Atomic: 50 concurrent Allow() calls for same IP+route;\n// exactly limit allowed, rest rejected. Verify atomicity via Redis counter.\nfunc TestAllow_ConcurrentRequests_Atomic(t *testing.T) // integration + race detector\n// BenchmarkAllow: measure Redis round-trip < 3ms p99.\nfunc BenchmarkAllow(b *testing.B)\n```\n### 11.5 `consumer/processor_test.go` (Notification Service)\n```go\n// Unit tests use mock NotificationRepository.\n// TestProcess_URLCreated_HappyPath: URLCreatedEvent → ProcessResultInserted, Insert called.\nfunc TestProcess_URLCreated_HappyPath(t *testing.T)\n// TestProcess_URLDeleted_HappyPath: URLDeletedEvent → ProcessResultInserted.\nfunc TestProcess_URLDeleted_HappyPath(t *testing.T)\n// TestProcess_MilestoneReached_HappyPath: MilestoneReachedEvent → ProcessResultInserted.\nfunc TestProcess_MilestoneReached_HappyPath(t *testing.T)\n// TestProcess_MalformedJSON: invalid JSON → ProcessResultPoisoned; Insert NOT called.\nfunc TestProcess_MalformedJSON(t *testing.T)\n// TestProcess_UnknownRoutingKey: routing_key=\"unknown.event\" → ProcessResultPoisoned.\nfunc TestProcess_UnknownRoutingKey(t *testing.T)\n// TestProcess_DuplicateEvent: IsProcessed returns true → ProcessResultDuplicate; Insert NOT called.\nfunc TestProcess_DuplicateEvent(t *testing.T)\n// TestProcess_InsertFail: Insert returns error → ProcessResultError.\nfunc TestProcess_InsertFail(t *testing.T)\n// TestProcess_MockEmailLogLine: after Insert, log output contains \"would send email to user\".\n// Capture zerolog output via bytes.Buffer writer.\nfunc TestProcess_MockEmailLogLine(t *testing.T)\n// TestProcess_PanicRecovery: mock Insert panics → returns ProcessResultError; no propagated panic.\nfunc TestProcess_PanicRecovery(t *testing.T)\n```\n### 11.6 End-to-End Integration Test (`test/e2e_m5_test.go`)\n```go\n// Build tag: //go:build integration\n// Requires: full docker compose stack running.\n// BASE_URL env var: \"http://localhost:8080\"\n// TestE2E_FullFlow:\n//   1. POST /api/auth/register → 201 {user_id, email}\n//   2. POST /api/auth/login → 200 {token, expires_at}\n//   3. POST /api/shorten → 201 {short_code, short_url, ...}\n//   4. GET /r/{code} (no auth) → 301; follow redirect → external URL\n//   5. Wait 5s for outbox + consumers\n//   6. GET /api/stats/{code} (no auth) → 200 {total_clicks: 1, ...}\n//   7. GET /api/notifications (with token) → 200, contains url.created event\n//   8. Verify X-Correlation-ID in response headers matches request header\nfunc TestE2E_FullFlow(t *testing.T)\n// TestE2E_RateLimitShorten:\n//   Register/login user. POST /api/shorten 11 times from same IP.\n//   Requests 1-10: 201. Request 11: 429 with Retry-After header.\n//   Verify Retry-After is integer string, > 0.\nfunc TestE2E_RateLimitShorten(t *testing.T)\n// TestE2E_CircuitBreaker:\n//   (Requires ability to stop url-service; skip in CI if not possible.)\n//   Stop url-service. 5 requests → 502. 6th → 503 {\"error\":\"service unavailable\"}.\n//   Start url-service, wait 31s. Request → 200 (circuit healed).\nfunc TestE2E_CircuitBreaker(t *testing.T)\n// TestE2E_JWTGatewayEnforcement:\n//   GET /api/urls without token → 401 from gateway (not 401 from url-service).\n//   Verify response body is gateway's {\"error\":\"unauthorized\"} not url-service's.\n//   Distinguish: gateway responds in < 2ms (no proxy overhead); url-service in > 5ms.\nfunc TestE2E_JWTGatewayEnforcement(t *testing.T)\n// TestE2E_CorrelationIDPropagation:\n//   Send request with X-Correlation-ID: \"e2e-test-abc\".\n//   Verify response X-Correlation-ID: \"e2e-test-abc\".\n//   Check logs: gateway, url-service logs both contain \"e2e-test-abc\".\nfunc TestE2E_CorrelationIDPropagation(t *testing.T)\n// TestE2E_NotificationMilestone:\n//   Generate 10 clicks on same short_code (via /r/{code}).\n//   Wait 10s.\n//   GET /api/notifications → contains milestone.reached event.\n//   GET /api/stats/{code} → total_clicks = 10.\nfunc TestE2E_NotificationMilestone(t *testing.T)\n// TestE2E_PublicEndpoints_NoAuth:\n//   GET /r/{code} → 301 (no auth required, not 401).\n//   GET /api/stats/{code} → 200 (no auth required).\n//   GET /health → 200.\nfunc TestE2E_PublicEndpoints_NoAuth(t *testing.T)\n```\n\n![End-to-End Request Trace — Full System Data Flow](./diagrams/tdd-diag-40.svg)\n\n---\n## 12. Environment Variable Reference\n### Notification Service\n| Variable | Required | Example | Description |\n|---|---|---|---|\n| `PORT` | Yes | `8084` | HTTP listen port |\n| `SERVICE_NAME` | Yes | `notification-service` | Embedded in log lines |\n| `DATABASE_DSN` | Yes | `postgres://notification_user:notification_secret@notification_db:5432/notification_db?sslmode=disable` | notification_db connection |\n| `RABBITMQ_URL` | Yes | `amqp://admin:admin@rabbitmq:5672/` | AMQP broker |\n| `JWT_SECRET` | Yes | `change-me-to-at-least-32-random-bytes` | JWT verification for `GET /notifications` |\n### API Gateway\n| Variable | Required | Example | Description |\n|---|---|---|---|\n| `PORT` | Yes | `8080` | HTTP listen port |\n| `SERVICE_NAME` | Yes | `gateway` | Embedded in log lines |\n| `JWT_SECRET` | Yes | `change-me-to-at-least-32-random-bytes` | JWT verification (same as all services) |\n| `REDIS_ADDR` | Yes | `redis:6379` | Redis for rate limit counters; unavailability = fail-open |\n| `URL_SERVICE_URL` | Yes | `http://url-service:8081` | Downstream target |\n| `ANALYTICS_SERVICE_URL` | Yes | `http://analytics-service:8082` | Downstream target |\n| `USER_SERVICE_URL` | Yes | `http://user-service:8083` | Downstream target |\n| `NOTIFICATION_SERVICE_URL` | Yes | `http://notification-service:8084` | Downstream target |\n| `LOG_LEVEL` | No | `info` | `debug\\|info\\|warn\\|error`; default `info` |\n**Add to `docker-compose.yml`** for notification-service and gateway:\n```yaml\n# notification-service environment additions:\nJWT_SECRET: \"change-me-to-at-least-32-random-bytes\"\n# gateway environment additions:\nJWT_SECRET: \"change-me-to-at-least-32-random-bytes\"\n# (REDIS_ADDR already present from M1)\n```\n**`JWT_SECRET` must be identical across all five services.** Use a shared Docker Compose variable or `.env` file to prevent drift:\n```yaml\n# docker-compose.yml (add at top level)\nx-common-jwt: &common-jwt\n  JWT_SECRET: \"${JWT_SECRET:-change-me-to-at-least-32-random-bytes}\"\n# Apply in each service's environment:\nenvironment:\n  <<: *common-jwt\n```\n---\n## 13. Performance Targets\n| Operation | Target | How to Measure |\n|---|---|---|\n| Gateway proxy overhead (added latency) | < 2ms p99 | Compare `GET /r/{code}` via gateway (8080) vs direct url-service (8081); delta is proxy overhead |\n| Rate limit check (Redis INCR Lua) | < 3ms p99 | `go test -bench=BenchmarkAllow ./ratelimit/...` with real Redis |\n| Circuit breaker `Allow()` state check | < 1µs | `go test -bench=BenchmarkAllow_Closed ./circuitbreaker/...` |\n| `GET /api/notifications` p99 | < 20ms | `wrk -t2 -c10 -d30s` with valid JWT + 100 notification rows |\n| Correlation ID generation (`uuid.New()`) | < 1µs | `go test -bench=BenchmarkUUID ./middleware/...` |\n| Gateway startup to all-healthy | < 90s total stack | `time docker compose up --wait` |\n| Notification consumer lag (event → DB insert) | < 2s p99 | Measure `notifications.created_at` vs `URLCreatedEvent.OccurredAt` delta |\n| `GET /health` on all services | < 10ms p99 | `wrk -t2 -c10 -d10s http://localhost:8080/health` |\n| Rate limit test (11 shorten requests) | 1-10: 201; 11: 429 | Scripted `curl` loop per Phase 8 checkpoint |\n| Circuit breaker trip (5 failures) | < 500ms elapsed | Measure time from first failure to first 503 via gateway |\n| Circuit breaker half-open probe | 30s ± 1s | Measure time from Open → first 200 after url-service restarts |\n| Gateway JWT verification | < 1ms (local HMAC) | No DB call; bounded by CPU; benchmark HMAC-SHA256 |\n---\n## 14. Anti-Pattern Guard Rail Checklist\nBefore completing this milestone, verify:\n- [ ] **No business logic in the gateway.** `grep -r \"short_code\\|analytics\\|milestone\\|password\" gateway/` returns only forwarding/proxy code, never domain computation.\n- [ ] **Circuit breaker has three states, not a retry loop.** `grep -r \"time.Sleep\\|for.*retry\" gateway/circuitbreaker/` returns nothing. The state machine is `State` enum with mutex-protected transitions.\n- [ ] **Notification service does not call user-service.** `grep -r \"user-service\\|8083\" services/notification-service/` returns nothing except comments. `UserEmail` comes from the event payload.\n- [ ] **Rate limit counters in Redis, not process memory.** `grep -r \"sync.Map\\|var.*counter\\|atomic.Int\" gateway/ratelimit/` returns nothing. All counters are Redis keys.\n- [ ] **Redis failure allows requests (fail-open).** `grep -A5 \"redis.*err\\|nil.*client\" gateway/ratelimit/ratelimit.go` shows `return AllowResult{Allowed: true}` on error.\n- [ ] **`X-Correlation-ID` propagated to async events.** `grep \"CorrelationID\" shared/events/events.go` shows the field on all event structs. `grep \"CorrelationID\" services/notification-service/consumer/processor.go` shows it is logged.\n- [ ] **Gateway JWT middleware does not call user-service.** `grep -r \"user-service\\|8083\" gateway/middleware/jwt.go` returns nothing. Only `sharedauth.NewJWTVerifier` and its `Verify` method are used.\n- [ ] **Circuit breaker `probeInFlight` prevents concurrent probes.** `grep \"probeInFlight\" gateway/circuitbreaker/circuitbreaker.go` shows it is set before returning `true` from HalfOpen and cleared in both `RecordSuccess` and `RecordFailure`.\n- [ ] **Downstream 5xx counts as circuit breaker failure.** `grep \"RecordFailure\\|StatusCode >= 500\" gateway/proxy/proxy.go` shows `ModifyResponse` calls `RecordFailure` for 5xx responses.\n- [ ] **`notifications` response never exposes raw payload.** `NotificationItem` struct has no `payload` or `data` field — only `id`, `event_type`, `status`, `created_at`, `sent_at`.\n- [ ] **All log lines have `correlation_id` field.** `docker compose logs url-service 2>&1 | python3 -c \"import sys,json; [json.loads(l) for l in sys.stdin if l.strip()]\"` — all lines parse as JSON with `correlation_id` key present.\n---\n<!-- END_TDD_MOD -->\n\n\n# Project Structure: URL Shortener (Microservices)\n## Directory Tree\n```\nurl-shortener/                                    # repo root\n│\n├── docker-compose.yml                            # M1: full 11-container topology\n├── .env.example                                  # M1: all env vars documented\n├── README.md                                     # M1: setup commands\n│\n├── shared/                                       # imported by all services\n│   ├── go.mod                                    # M1: module github.com/.../shared\n│   ├── go.sum                                    # M1: auto-generated\n│   ├── events/\n│   │   └── events.go                             # M1: DomainEvent interface + 4 event structs\n│   ├── auth/\n│   │   └── types.go                              # M2: JWTVerifier interface, Claims struct, sentinel errors\n│   ├── middleware/\n│   │   ├── jwt_middleware.go                     # M2: RequireAuth http.Handler wrapper\n│   │   └── jwt_middleware_test.go                # M2: middleware unit tests\n│   └── logger/\n│       └── logger.go                             # M1 stub → M5 finalized: New, WithCorrelationID, RequestLogger\n│\n├── services/\n│   │\n│   ├── url-service/                              # M1 scaffold → M3 full implementation\n│   │   ├── go.mod                                # M1: module + replace shared\n│   │   ├── go.sum                                # M1: auto-generated\n│   │   ├── Dockerfile                            # M1: multi-stage Alpine build\n│   │   ├── main.go                               # M1 stub → M3: wiring env/DB/Redis/RabbitMQ/routes/outbox\n│   │   ├── migrations/\n│   │   │   ├── 001_create_urls.sql               # M3: urls table + indexes\n│   │   │   └── 002_create_outbox.sql             # M3: outbox table + partial index\n│   │   ├── codegen/\n│   │   │   ├── codegen.go                        # M3: base62 alphabet, Generate(), CodeGenerator interface\n│   │   │   └── codegen_test.go                   # M3: length/alphabet/randomness/no-math-rand tests\n│   │   ├── repository/\n│   │   │   ├── url_repository.go                 # M3: URL/URLSummary structs, URLRepository interface + pgx impl\n│   │   │   ├── url_repository_test.go            # M3: integration tests (conflict, cursor, ownership)\n│   │   │   ├── outbox_repository.go              # M3: OutboxEntry, OutboxRepository interface + pgx impl\n│   │   │   └── outbox_repository_test.go         # M3: insert/rollback/fetch/mark tests\n│   │   ├── cache/\n│   │   │   ├── cache.go                          # M3: CachedURL, CacheClient interface, nil-safe Redis impl\n│   │   │   └── cache_test.go                     # M3: nil-client/TTL/set-get/del tests\n│   │   ├── amqp/\n│   │   │   ├── publisher.go                      # M3: AMQPPublisher interface + amqp091 impl with sync.Mutex\n│   │   │   └── publisher_test.go                 # M3: publish tests\n│   │   ├── outbox/\n│   │   │   ├── poller.go                         # M3: OutboxPoller coordinator + 3 workers\n│   │   │   └── poller_test.go                    # M3: worker pool / drain tests\n│   │   ├── service/\n│   │   │   └── url_service.go                    # M3: URLService orchestrating repo/codegen/cache/outbox\n│   │   ├── auth/\n│   │   │   ├── password.go                       # M2 (used by url-service for JWT verify only): bcrypt impl\n│   │   │   ├── password_test.go                  # M2: hash/compare/cost tests\n│   │   │   ├── jwt.go                            # M2: JWTSigner + JWTVerifier implementations\n│   │   │   └── jwt_test.go                       # M2: sign/verify/expiry/tamper tests\n│   │   └── handler/\n│   │       ├── health.go                         # M1: GET /health\n│   │       ├── shorten.go                        # M3: POST /shorten\n│   │       ├── redirect.go                       # M3: GET /{code} 301 redirect\n│   │       ├── list.go                           # M3: GET /urls cursor pagination\n│   │       ├── delete.go                         # M3: DELETE /urls/{code}\n│   │       ├── helpers.go                        # M3: writeJSON, writeError, extractClientIP, hashIP, ptr\n│   │       └── handler_test.go                   # M3: unit + integration tests + benchmarks\n│   │\n│   ├── analytics-service/                        # M1 scaffold → M4 full implementation\n│   │   ├── go.mod                                # M1: module + replace shared\n│   │   ├── go.sum                                # M1: auto-generated\n│   │   ├── Dockerfile                            # M1: multi-stage Alpine build\n│   │   ├── main.go                               # M1 stub → M4: wiring DB/RabbitMQ/consumer/routes\n│   │   ├── migrations/\n│   │   │   ├── 001_create_clicks.sql             # M4: clicks table + two indexes (incl. partial)\n│   │   │   ├── 002_create_milestones.sql         # M4: milestones table + unique (short_code, milestone)\n│   │   │   └── 003_create_processed_events.sql   # M4: processed_events dedup table (UUID PK)\n│   │   ├── repository/\n│   │   │   ├── click_repository.go               # M4: Click/RefererCount/PeriodCount, ClickRepository + pgx impl\n│   │   │   ├── click_repository_test.go          # M4: insert/count/referer/timeline integration tests\n│   │   │   ├── processed_event_repository.go     # M4: ProcessedEvent, ProcessedEventRepository + pgx impl\n│   │   │   ├── processed_event_repository_test.go # M4: is-processed/mark/idempotent/rollback tests\n│   │   │   ├── milestone_repository.go           # M4: Milestone, MilestoneRepository + pgx impl\n│   │   │   └── milestone_repository_test.go      # M4: get-latest/insert/conflict tests\n│   │   ├── consumer/\n│   │   │   ├── consumer.go                       # M4: AMQPConsumer setup (exchange+queue+bind+Qos+Consume)\n│   │   │   ├── processor.go                      # M4: ClickProcessor with full idempotency algorithm\n│   │   │   └── processor_test.go                 # M4: unit (mock repos) + integration duplicate-event test\n│   │   ├── milestone/\n│   │   │   ├── detector.go                       # M4: Thresholds [10,100,1000], Detector interface + impl\n│   │   │   └── detector_test.go                  # M4: all threshold transition table-driven tests\n│   │   ├── publisher/\n│   │   │   ├── publisher.go                      # M4: AMQPPublisher for MilestoneReachedEvent\n│   │   │   └── publisher_test.go                 # M4: publish tests\n│   │   └── handler/\n│   │       ├── health.go                         # M1: GET /health\n│   │       ├── stats.go                          # M4: GET /stats/{code} with errgroup concurrent queries\n│   │       ├── timeline.go                       # M4: GET /stats/{code}/timeline\n│   │       ├── helpers.go                        # M4: writeJSON, writeError\n│   │       └── handler_test.go                   # M4: unit (mock repos) + benchmarks\n│   │\n│   ├── user-service/                             # M1 scaffold → M2 full implementation\n│   │   ├── go.mod                                # M1: module + replace shared\n│   │   ├── go.sum                                # M1: auto-generated\n│   │   ├── Dockerfile                            # M1: multi-stage Alpine build\n│   │   ├── main.go                               # M1 stub → M2: wiring DB/auth/routes/middleware\n│   │   ├── migrations/\n│   │   │   └── 001_create_users.sql              # M2: users table (UUID PK, UNIQUE email, bcrypt hash)\n│   │   ├── repository/\n│   │   │   ├── user_repository.go                # M2: User struct, UserRepository interface + pgx impl\n│   │   │   └── user_repository_test.go           # M2: create/duplicate/find/case-sensitivity tests\n│   │   ├── auth/\n│   │   │   ├── password.go                       # M2: PasswordHasher interface + bcryptHasher (cost=12)\n│   │   │   ├── password_test.go                  # M2: hash/compare/cost/benchmark tests\n│   │   │   ├── jwt.go                            # M2: JWTSigner + JWTVerifier (implements shared/auth.JWTVerifier)\n│   │   │   └── jwt_test.go                       # M2: sign/verify/expiry/issuer/tamper tests\n│   │   ├── service/\n│   │   │   └── user_service.go                   # M2: UserService (Register/Login + dummyHash timing equalization)\n│   │   └── handler/\n│   │       ├── health.go                         # M1: GET /health\n│   │       ├── register.go                       # M2: POST /register\n│   │       ├── login.go                          # M2: POST /login\n│   │       ├── me.go                             # M2: GET /me (behind RequireAuth)\n│   │       ├── helpers.go                        # M2: writeJSON, writeInternalError, ErrorResponse\n│   │       └── handler_test.go                   # M2: integration round-trip + edge case tests\n│   │\n│   └── notification-service/                     # M1 scaffold → M5 full implementation\n│       ├── go.mod                                # M1: module + replace shared\n│       ├── go.sum                                # M1: auto-generated\n│       ├── Dockerfile                            # M1: multi-stage Alpine build\n│       ├── main.go                               # M1 stub → M5: wiring DB/RabbitMQ/consumer/routes/JWT\n│       ├── migrations/\n│       │   └── 001_create_notifications.sql      # M5: notifications + processed_notifications tables\n│       ├── repository/\n│       │   ├── notification_repository.go        # M5: Notification/NotificationSummary, NotificationRepository + pgx impl\n│       │   └── notification_repository_test.go   # M5: insert/list/cursor/dedup integration tests\n│       ├── consumer/\n│       │   ├── consumer.go                       # M5: AMQPConsumer (3 bindings: url.created/deleted/milestone.reached)\n│       │   ├── processor.go                      # M5: NotificationProcessor with routing-key switch + mock email log\n│       │   └── processor_test.go                 # M5: unit tests for all event types + panic recovery\n│       └── handler/\n│           ├── health.go                         # M1: GET /health\n│           ├── notifications.go                  # M5: GET /notifications (JWT-protected, cursor-paginated)\n│           ├── helpers.go                        # M5: writeJSON, writeError\n│           └── handler_test.go                   # M5: list/pagination/ownership tests\n│\n├── gateway/                                      # M1 scaffold → M5 full implementation\n│   ├── go.mod                                    # M1: module + replace shared\n│   ├── go.sum                                    # M1: auto-generated\n│   ├── Dockerfile                                # M1: multi-stage Alpine build\n│   ├── main.go                                   # M1 stub → M5: full wiring env/Redis/CB/proxy/routes/server\n│   ├── circuitbreaker/\n│   │   ├── circuitbreaker.go                     # M5: CircuitBreaker 3-state machine (Closed/Open/HalfOpen)\n│   │   └── circuitbreaker_test.go                # M5: state transitions/concurrency/window-reset tests\n│   ├── ratelimit/\n│   │   ├── ratelimit.go                          # M5: RateLimiter — Redis Lua INCR+EXPIRE, fail-open\n│   │   └── ratelimit_test.go                     # M5: unit (nil client) + integration (window/atomic) tests\n│   ├── proxy/\n│   │   ├── proxy.go                              # M5: ReverseProxy wrapper with Director path-strip + CB hooks\n│   │   └── proxy_test.go                         # M5: forward/error-handling tests\n│   ├── middleware/\n│   │   ├── correlation.go                        # M5: CorrelationMiddleware — X-Correlation-ID inject/propagate\n│   │   ├── jwt.go                                # M5: GatewayJWTMiddleware — local HMAC verify, exempt routes\n│   │   ├── logging.go                            # M5: RequestLogger middleware (wraps shared/logger)\n│   │   └── middleware_test.go                    # M5: correlation/JWT/exempt-route tests\n│   ├── router/\n│   │   ├── router.go                             # M5: full route table (all 12 routes with middleware chains)\n│   │   └── router_test.go                        # M5: route matching + middleware wiring tests\n│   └── handler/\n│       ├── health.go                             # M1: GET /health\n│       └── handler_test.go                       # M5: health handler test\n│\n└── test/\n    ├── smoke_m1.sh                               # M1: shell smoke test for all 5 /health endpoints\n    └── e2e_m5_test.go                            # M5: full end-to-end integration tests (Go, build tag: integration)\n```\n---\n## Creation Order\n### 1. Monorepo Scaffold (30–45 min)\nCreate all directories first, then stub files:\n```bash\nmkdir -p shared/{events,auth,middleware,logger}\nmkdir -p services/{url-service,analytics-service,user-service,notification-service}\nmkdir -p services/url-service/{migrations,codegen,repository,cache,amqp,outbox,service,auth,handler}\nmkdir -p services/analytics-service/{migrations,repository,consumer,milestone,publisher,handler}\nmkdir -p services/user-service/{migrations,repository,auth,service,handler}\nmkdir -p services/notification-service/{migrations,repository,consumer,handler}\nmkdir -p gateway/{circuitbreaker,ratelimit,proxy,middleware,router,handler}\nmkdir -p test\n```\n- `shared/go.mod`\n- `services/url-service/go.mod`\n- `services/analytics-service/go.mod`\n- `services/user-service/go.mod`\n- `services/notification-service/go.mod`\n- `gateway/go.mod`\n- Empty `main.go` stubs in each service and gateway\n- Run `go mod tidy` in each directory\n### 2. Shared Foundation — M1 (45–60 min)\n- `shared/events/events.go` — all 4 event structs + constants + DomainEvent interface\n- `shared/logger/logger.go` — initial stub: `New()` only\n- `docker-compose.yml` — full 11-container topology\n- `.env.example` — all environment variables\n- `README.md`\n### 3. Dockerfiles — M1 (30 min)\n- `services/url-service/Dockerfile`\n- `services/analytics-service/Dockerfile`\n- `services/user-service/Dockerfile`\n- `services/notification-service/Dockerfile`\n- `gateway/Dockerfile`\n### 4. Health Handlers + Infra Bootstrap — M1 (60–90 min)\n- `services/url-service/handler/health.go`\n- `services/analytics-service/handler/health.go`\n- `services/user-service/handler/health.go`\n- `services/notification-service/handler/health.go`\n- `gateway/handler/health.go`\n- Full `main.go` for each service: `ConnectDB`, `ConnectRedis` (url-service + gateway), `ConnectRabbitMQ`, `mustGetEnv`, startup sequence, `/health` route, RabbitMQ queue declarations\n- `test/smoke_m1.sh`\n**Checkpoint:** `docker compose up --build` → all 11 containers healthy. All `/health` endpoints return 200.\n### 5. User Service Schema + Repository — M2 (60–90 min)\n- `services/user-service/migrations/001_create_users.sql`\n- `services/user-service/repository/user_repository.go`\n- `services/user-service/repository/user_repository_test.go`\n### 6. User Service Auth Layer — M2 (60–90 min)\n- `services/user-service/auth/password.go`\n- `services/user-service/auth/password_test.go`\n- `services/user-service/auth/jwt.go`\n- `services/user-service/auth/jwt_test.go`\n### 7. Shared Auth Types — M2 (20 min)\n- `shared/auth/types.go` — JWTVerifier interface, Claims struct, sentinel errors\n### 8. User Service Business Logic + Handlers — M2 (90–120 min)\n- `services/user-service/service/user_service.go`\n- `services/user-service/handler/helpers.go`\n- `services/user-service/handler/register.go`\n- `services/user-service/handler/login.go`\n- `services/user-service/handler/me.go`\n- `services/user-service/handler/handler_test.go`\n- Update `services/user-service/main.go` with full M2 wiring\n### 9. Shared JWT Middleware — M2 (45–60 min)\n- `shared/middleware/jwt_middleware.go`\n- `shared/middleware/jwt_middleware_test.go`\n**Checkpoint:** Register → Login → GET /me round-trip works. Duplicate email → 409. Wrong password → 401 (same body as unknown email).\n### 10. URL Service Schema + Code Generator — M3 (60–90 min)\n- `services/url-service/migrations/001_create_urls.sql`\n- `services/url-service/migrations/002_create_outbox.sql`\n- `services/url-service/codegen/codegen.go`\n- `services/url-service/codegen/codegen_test.go`\n### 11. URL Service Repository Layer — M3 (90–120 min)\n- `services/url-service/repository/url_repository.go`\n- `services/url-service/repository/url_repository_test.go`\n- `services/url-service/repository/outbox_repository.go`\n- `services/url-service/repository/outbox_repository_test.go`\n### 12. URL Service Cache + AMQP + Service Layer — M3 (90–120 min)\n- `services/url-service/cache/cache.go`\n- `services/url-service/cache/cache_test.go`\n- `services/url-service/amqp/publisher.go`\n- `services/url-service/amqp/publisher_test.go`\n- `services/url-service/service/url_service.go`\n### 13. URL Service Handlers + Outbox Poller — M3 (90–120 min)\n- `services/url-service/handler/helpers.go`\n- `services/url-service/handler/shorten.go`\n- `services/url-service/handler/redirect.go`\n- `services/url-service/handler/list.go`\n- `services/url-service/handler/delete.go`\n- `services/url-service/handler/handler_test.go`\n- `services/url-service/outbox/poller.go`\n- `services/url-service/outbox/poller_test.go`\n- Update `services/url-service/main.go` with full M3 wiring\n**Checkpoint:** POST /shorten → 201. GET /:code → 301. DELETE /urls/:code → 204. Outbox poller marks rows published within 4s. RabbitMQ management shows `url-shortener` exchange.\n### 14. Analytics Service Schema + Repository — M4 (90–120 min)\n- `services/analytics-service/migrations/001_create_clicks.sql`\n- `services/analytics-service/migrations/002_create_milestones.sql`\n- `services/analytics-service/migrations/003_create_processed_events.sql`\n- `services/analytics-service/repository/click_repository.go`\n- `services/analytics-service/repository/click_repository_test.go`\n- `services/analytics-service/repository/processed_event_repository.go`\n- `services/analytics-service/repository/processed_event_repository_test.go`\n- `services/analytics-service/repository/milestone_repository.go`\n- `services/analytics-service/repository/milestone_repository_test.go`\n### 15. Analytics Service Consumer + Milestone Detection — M4 (90–120 min)\n- `services/analytics-service/consumer/consumer.go`\n- `services/analytics-service/consumer/processor.go`\n- `services/analytics-service/consumer/processor_test.go`\n- `services/analytics-service/milestone/detector.go`\n- `services/analytics-service/milestone/detector_test.go`\n- `services/analytics-service/publisher/publisher.go`\n- `services/analytics-service/publisher/publisher_test.go`\n### 16. Analytics Service Handlers — M4 (60–90 min)\n- `services/analytics-service/handler/helpers.go`\n- `services/analytics-service/handler/stats.go`\n- `services/analytics-service/handler/timeline.go`\n- `services/analytics-service/handler/handler_test.go`\n- Update `services/analytics-service/main.go` with full M4 wiring\n**Checkpoint:** Make 10 redirects → GET /stats/:code shows total_clicks=10. Milestone row with milestone=10 in analytics_db. MilestoneReachedEvent visible in notifications.events queue.\n### 17. Notification Service Schema + Repository — M5 (60–90 min)\n- `services/notification-service/migrations/001_create_notifications.sql`\n- `services/notification-service/repository/notification_repository.go`\n- `services/notification-service/repository/notification_repository_test.go`\n### 18. Notification Service Consumer + Handlers — M5 (90–120 min)\n- `services/notification-service/consumer/consumer.go`\n- `services/notification-service/consumer/processor.go`\n- `services/notification-service/consumer/processor_test.go`\n- `services/notification-service/handler/helpers.go`\n- `services/notification-service/handler/notifications.go`\n- `services/notification-service/handler/handler_test.go`\n- Update `services/notification-service/main.go` with full M5 wiring\n### 19. Shared Logger Finalization — M5 (45–60 min)\n- Update `shared/logger/logger.go` — add `WithCorrelationID`, `RequestLogger`, `responseWriter`\n- Update all 5 services' `main.go` to wrap mux with `logger.RequestLogger`\n### 20. Gateway Middleware — M5 (60–90 min)\n- `gateway/middleware/correlation.go`\n- `gateway/middleware/jwt.go`\n- `gateway/middleware/logging.go`\n- `gateway/middleware/middleware_test.go`\n### 21. Gateway Circuit Breaker + Rate Limiter — M5 (90–120 min)\n- `gateway/circuitbreaker/circuitbreaker.go`\n- `gateway/circuitbreaker/circuitbreaker_test.go`\n- `gateway/ratelimit/ratelimit.go`\n- `gateway/ratelimit/ratelimit_test.go`\n### 22. Gateway Proxy + Router + Main — M5 (90–120 min)\n- `gateway/proxy/proxy.go`\n- `gateway/proxy/proxy_test.go`\n- `gateway/router/router.go`\n- `gateway/router/router_test.go`\n- Update `gateway/main.go` with full M5 wiring\n### 23. End-to-End Tests — M5 (60–90 min)\n- `test/e2e_m5_test.go`\n- Run: `go test -tags integration -v -timeout 120s ./test/...`\n**Checkpoint:** All 11 containers healthy. Full E2E flow: register → login → shorten → redirect → stats → notification. Rate limit 429 on 11th shorten. Circuit breaker 503 after 5 url-service failures. Correlation ID in every log line.\n---\n## File Count Summary\n| Category | Count |\n|---|---|\n| `shared/` Go source files | 6 |\n| `url-service/` Go source files | 16 |\n| `analytics-service/` Go source files | 16 |\n| `user-service/` Go source files | 12 |\n| `notification-service/` Go source files | 10 |\n| `gateway/` Go source files | 15 |\n| SQL migration files | 9 |\n| Dockerfiles | 5 |\n| `go.mod` files | 6 |\n| Shell/test scripts | 2 |\n| Config/docs | 3 |\n| **Total tracked files** | **~100** |\n| Directories | ~45 |\n| Estimated lines of code | ~8,000–10,000 |\n> **Verification:** Every file mentioned in M1–M5 TDD `File Structure` sections is represented. Creation order respects dependency direction: `shared/` before services, M1 infra before M2 auth before M3 URL before M4 analytics before M5 gateway+notifications. A learner can execute `mkdir -p` and `touch` from this tree without ambiguity."}